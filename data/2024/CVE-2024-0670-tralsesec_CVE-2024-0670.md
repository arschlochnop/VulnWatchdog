## CVE-2024-0670 - CheckMK Windows Agent 本地权限提升 (Local Privilege Escalation)

**漏洞编号:** CVE-2024-0670

**漏洞类型:** 本地权限提升 (Local Privilege Escalation)

**影响应用:** CheckMK Windows Agent

**危害等级:** 高 (High)

**CVSS评分:** 8.8

**影响版本:** CheckMK Windows Agent (未指定具体版本范围，但漏洞存在于其MSI安装机制)

**利用条件:** 需要本地低权限用户账户；PowerShell执行策略允许脚本执行；具备向C:\Windows\Temp\目录写入文件的权限；已安装CheckMK Windows Agent。

**POC 可用性:** 9

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 15%

## 详情

CVE-2024-0670是一个存在于CheckMK Agent中的本地权限提升漏洞，被评定为高危（CVSS 8.8）。该漏洞的根本原因在于MSI修复过程中对可预测命令文件的无控制搜索路径。具体来说，当CheckMK Agent的MSI安装包进行修复时，它会在`C:\Windows\Temp`目录下以可预测的文件名（如`msiexec.exe`可能尝试执行的辅助脚本）执行文件，并且这些执行是以`NT AUTHORITY\SYSTEM`的最高权限进行的。一个低权限的本地用户可以利用此漏洞，预先在`C:\Windows\Temp`目录中放置精心构造的恶意Payload，等待MSI修复过程触发执行。

提供的PowerShell PoC（`exploit.ps1`）充分利用了这一机制。其核心逻辑包括：
1.  **枚举MSI包：** 脚本首先识别系统上已安装的CheckMK Agent MSI包，为后续触发修复操作做准备。
2.  **Payload注入：** 攻击者通过配置`$LHOST`和`$LPORT`以及Payload路径`$NcPath`（通常为`nc.exe`）来指定反向Shell的连接信息。脚本会在`C:\Windows\Temp`目录中创建一系列带有可预测文件名（如`Rtfm<PID>.tmp`等，PoC中提到根据PID范围进行文件播种）的Payload文件，这些文件实际上是反向Shell的调用脚本，例如一个批处理文件，用于启动`nc.exe`并连接到攻击者监听器。
3.  **触发MSI修复：** 脚本随后通过特定的命令触发CheckMK Agent的MSI修复过程。在修复过程中，系统会以SYSTEM权限尝试执行`C:\Windows\Temp`目录下与预设文件名匹配的Payload。
4.  **权限提升：** 一旦Payload被执行，攻击者在监听主机上将获得一个`NT AUTHORITY\SYSTEM`权限的反向Shell。
该PoC代码结构清晰，提供完整的配置说明和使用指南。它被标记为“独立PowerShell概念验证”，并且是基于[elsevar11](https://github.com/elsevar11)的公开PoC的“衍生分析”，重用了核心概念并提供了更精简的利用逻辑。根据描述，这是一个功能完整的本地权限提升工具，能够成功获得SYSTEM权限，因此其有效性非常高。

**利用步骤：**
1.  **环境准备：** 确保目标Windows机器上安装了CheckMK Windows Agent。攻击者需拥有目标机器上的一个低权限本地用户账户，并具备向`C:\Windows\Temp\`目录写入文件的权限。目标机器的PowerShell执行策略需允许脚本执行（`Bypass`或`RemoteSigned`）。准备Payload，例如将`nc.exe`放置在可访问的路径，并在`exploit.ps1`中配置`$NcPath`。
2.  **启动监听器：** 在攻击者主机上，使用Netcat启动一个监听器，等待目标机器的反向连接。例如：`nc -lvnp <PORT>`。
3.  **执行PoC：** 从目标机器的低权限账户下，通过PowerShell执行`exploit.ps1`脚本。命令示例：`powershell.exe -NoProfile -ExecutionPolicy Bypass -File .\exploit.ps1`。
4.  **获得SYSTEM Shell：** 如果利用成功，攻击者的监听器将收到一个来自目标机器的`NT AUTHORITY\SYSTEM`权限的反向Shell连接。

**投毒风险分析：**
对该PoC代码的投毒风险评估为低（约15%）。分析依据如下：
1.  **代码透明性与可读性：** `exploit.ps1`是一个PowerShell脚本，其内容是纯文本且结构清晰，未见任何混淆技术。这意味着安全研究人员或具备Powershell知识的用户可以轻松阅读、理解其内部逻辑和行为。其核心功能是本地权限提升，不包含复杂的加密、外部库调用（除了预期的`nc.exe`或类似工具）或难以追踪的机制。
2.  **明确的用途与来源：** `README.md`清晰地说明了该PoC的用途是演示CVE-2024-0670的本地权限提升，并明确指出它是基于另一公开PoC的衍生版本，提供了原始参考链接。这种透明的归因有助于建立信任并便于溯源。
3.  **无恶意捆绑或外部通信：** PoC代码本身不包含除实现漏洞利用逻辑和配置的反向Shell通信之外的任何恶意捆绑软件、广告软件、勒索软件或其他不必要的恶意功能。它不主动连接未知C2服务器、下载额外组件或执行未经用户明确配置的操作。Payload (`nc.exe`) 是用户自行提供的，且其行为是明确的反向Shell连接，而非隐蔽的数据窃取或破坏。
4.  **合规声明：** `README.md`中明确包含“Legal Notice”，声明此代码仅用于教育、防御性工程和授权测试。这表明了作者的意图是出于安全研究和防御目的。
5.  **潜在风险点：** 尽管代码本身风险低，但任何PoC都存在被恶意滥用的风险。恶意行为者可以修改PoC，将反向Shell Payload替换为其他恶意负载（如键盘记录器、持久化后门等），并将其用于非法活动。然而，这种风险属于利用漏洞的风险，而非PoC代码本身“投毒”的风险。PoC并未引入额外的、未经说明的攻击面。

综上所述，该PoC代码本身具有高度透明性、明确的用途和可溯源性，未发现代码混淆、可疑的外部请求或隐藏的恶意行为。因此，其作为分析工具或研究材料的投毒风险极低。

**项目地址:** https://github.com/elsevar11/CVE-2024-0670-CheckMK-Agent-Local-Privilege-Escalation-Exploit

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2024-0670
