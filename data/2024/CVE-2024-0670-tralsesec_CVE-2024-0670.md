## CVE-2024-0670 - CheckMK Agent (Windows版本) 本地权限提升 (Local Privilege Escalation)

**漏洞编号:** CVE-2024-0670

**漏洞类型:** 本地权限提升 (Local Privilege Escalation)

**影响应用:** CheckMK Agent (Windows版本)

**危害等级:** 高 (High)

**CVSS评分:** CVSS 8.8

**影响版本:** 未明确指定版本，但影响所有安装CheckMK Windows Agent的系统。

**利用条件:** 需要低权限本地用户账户；目标系统需安装CheckMK Windows Agent；PowerShell执行策略需允许脚本执行；低权限用户需具有向 `C:\Windows\Temp\` 目录写入文件的权限。

**POC 可用性:** 9/10

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 10%

## 详情

CVE-2024-0670是一个存在于CheckMK Windows Agent中的本地权限提升漏洞。该漏洞的根本原因在于MSI修复过程中存在非受控的搜索路径，且攻击者可以控制在该路径下创建的文件。具体而言，在CheckMK Agent的MSI修复机制被触发时，安装程序会以NT AUTHORITY\SYSTEM权限在 `C:\Windows\Temp\` 目录中执行具有可预测文件名的文件。一个低权限的本地用户可以通过预先在该目录中植入恶意载荷（例如反向shell可执行文件），然后在MSI修复时诱使系统以高权限执行这些载荷，从而将权限提升至NT AUTHORITY\SYSTEM。

**POC有效性分析：**
该PowerShell POC (`exploit.ps1`)是针对CVE-2024-0670的一个独立实现，基于elsevar11的公开PoC进行了简化和优化。该PoC的有效性很高，它清晰地概述了漏洞原理、利用条件和详细的操作步骤。脚本通过自动化枚举MSI包、在可预测位置（`C:\Windows\Temp\`）创建带有攻击者控制内容的命名管道（`nc.exe`或其他自定义载荷），并最终通过触发MSI修复过程来执行这些载荷，从而实现权限提升。PoC的README文档详细说明了所需环境、配置参数（如攻击者IP、端口、载荷路径）和使用方法。从技术实现上看，这种利用Windows Installer服务执行路径劫持的漏洞利用方式是成熟且可靠的。只要目标系统满足所有前提条件，该PoC理论上能够稳定地获得SYSTEM权限的反向shell。

**利用步骤：**
1.  **环境准备：** 确保目标Windows机器上已安装CheckMK Windows Agent。攻击者需要一个具有低权限的本地用户账户，并且该账户必须能够向 `C:\Windows\Temp\` 目录写入文件。PowerShell的执行策略需要设置为允许脚本执行（例如，通过 `Set-ExecutionPolicy Bypass`）。
2.  **攻击者主机设置：** 在攻击者控制的Linux或Windows主机上，启动一个Netcat监听器，用于接收反向shell连接。命令示例：`nc -lvnp <端口>`。
3.  **PoC配置：** 下载 `exploit.ps1` 脚本，并根据需要修改其中的配置参数：`$LHOST`（攻击者IP地址）、`$LPORT`（监听端口），以及 `$NcPath`（反向shell载荷的路径，例如 `nc.exe` 的完整路径）。脚本还包含 `$MinPID` 和 `$MaxPID` 参数用于文件播种，以应对不同的进程ID范围。
4.  **执行PoC：** 从目标机器上的低权限账户，通过PowerShell执行 `exploit.ps1` 脚本。命令示例：`powershell.exe -NoProfile -ExecutionPolicy Bypass -File .\exploit.ps1`。
5.  **权限提升：** 脚本将自动识别CheckMK MSI安装包，并在 `C:\Windows\Temp` 目录中创建具有可预测文件名的恶意载荷文件。随后，它会触发CheckMK Agent的MSI修复过程。在此过程中，Windows Installer服务将以 `NT AUTHORITY\SYSTEM` 权限尝试执行这些预先植入的载荷。
6.  **获取SYSTEM Shell：** 成功利用后，攻击者在第一步设置的监听器将接收到一个来自目标系统的 `NT AUTHORITY\SYSTEM` 权限的反向shell。

**投毒风险分析：**
该PoC代码的投毒风险评估为低（10%）。其主要原因如下：首先，项目 `README.md` 文件明确声明了代码的用途：“仅用于教育、防御性工程和授权测试”，这表明其设计初衷是用于合法的安全研究和验证，而非隐藏恶意功能。其次，作为PowerShell脚本，其代码是可读的，并且没有明显的代码混淆或加密。代码逻辑集中于识别漏洞、创建特定文件并触发MSI修复以执行自定义载荷，这与常见的LPE PoC行为模式一致。脚本中明确暴露了 `$LHOST`、`$LPORT` 和 `$NcPath` 等配置参数，要求用户主动提供攻击者IP、端口和恶意载荷路径，这意味着用户对载荷的内容和连接目标有完全的控制权。没有迹象表明该PoC会连接到除用户指定之外的外部未知服务器，或者在目标系统上安装持久性后门（超出获取临时反向shell的范畴）。虽然任何可用于攻击的代码都可能被滥用，但就PoC本身而言，它没有表现出超出其声明目的的隐蔽恶意行为，因此其作为安全研究工具的“投毒”风险较低。用户仍需确保在受控环境中进行测试，并仔细检查任何外部提供的载荷（如 `nc.exe`）的安全性。

**项目地址:** https://github.com/elsevar11/CVE-2024-0670-CheckMK-Agent-Local-Privilege-Escalation-Exploit

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2024-0670
