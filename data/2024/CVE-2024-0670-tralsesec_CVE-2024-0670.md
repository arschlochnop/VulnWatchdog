## CVE-2024-0670 - CheckMK Windows Agent Local Privilege Escalation

**漏洞编号:** CVE-2024-0670

**漏洞类型:** Local Privilege Escalation

**影响应用:** CheckMK Windows Agent

**危害等级:** High

**CVSS评分:** 8.8

**影响版本:** 所有受CVE-2024-0670影响的CheckMK Windows Agent版本

**利用条件:** 需要低权限本地用户账户、可写入C:\Windows\Temp\目录的权限以及允许脚本执行的PowerShell执行策略。

**POC 可用性:** 9

**POC 类型:** 完整利用

**攻击复杂度:** 中

**投毒风险:** 10%

## 详情

CVE-2024-0670是一个在CheckMK Agent中发现的本地权限提升（Local Privilege Escalation, LPE）漏洞，影响Windows平台。该漏洞被评为高危，CVSS评分8.8，允许一个低权限的本地用户将权限提升至NT AUTHORITY\SYSTEM，从而获得系统级的完全控制。其根本原因在于CheckMK Agent的MSI修复过程中存在一个不受控制的搜索路径。在MSI修复期间，安装程序会在`C:\Windows\Temp`等可被低权限用户写入的目录中，以系统权限执行具有可预测名称的文件。攻击者可以预先在这些目录中植入受控的恶意payload，当MSI修复过程被触发时，这些payload便会以SYSTEM权限执行。这种类型的漏洞对于攻击者在初步渗透后扩大立足点至关重要，因为它可以使攻击者从受限的用户环境迅速升级到完全控制的管理员或系统账户。利用此漏洞，攻击者可以绕过现有的权限限制，执行任意系统命令，并完全控制受感染的系统，对组织的数据机密性、完整性和可用性构成严重威胁。

**POC有效性分析**
提供的PowerShell PoC（`exploit.ps1`）是CVE-2024-0670的一个独立且功能完善的本地权限提升利用示例。该PoC明确指出它是对elsevar11公开PoC的“衍生分析”，并重用了其核心概念，同时提供了简化的利用逻辑。这种溯源性增强了其作为有效工具进行防御性安全研究和测试的可靠性。PoC的有效性体现在以下几个方面：首先，它精准地利用了CheckMK Windows Agent在执行MSI修复时的“不受控制的搜索路径”问题。Windows MSI安装程序在修复或配置组件时，会按照特定的目录搜索可执行文件，如果其中包含低权限用户可写入的目录（如`C:\Windows\Temp`），并且被执行的文件名是可预测的，那么攻击者就可以利用这一机制。该PoC正是通过在`C:\Windows\Temp`中预先创建具有特定、可预测文件名的恶意脚本或可执行文件，并在适当的时机触发MSI修复过程。其次，该PoC旨在通过配置攻击者的IP地址（`$LHOST`）、端口（`$LPORT`）和可选的payload路径（`$NcPath`，例如`nc.exe`），来建立一个反向Shell。这意味着该PoC不仅仅是一个概念验证，而是一个完整的利用工具，能够实际获取SYSTEM权限的反向连接，从而验证漏洞的存在和可利用性。清晰的配置参数和详细的用法说明使得该PoC易于部署和测试，极大地降低了复现漏洞的技术门槛。其PowerShell实现也确保了在Windows环境下的原生兼容性和高效性。

**利用步骤**
利用CVE-2024-0670的PoC进行本地权限提升通常遵循以下步骤：
1.  **环境准备**：
    *   **受害者机器**：需要一台安装了CheckMK Windows Agent的Windows机器。攻击者必须已拥有该机器的低权限本地用户账户。
    *   **攻击者机器**：准备一个监听器，例如使用Netcat：`nc -lvnp <PORT>`，其中`<PORT>`是PoC中配置的监听端口。
    *   **权限与写入能力**：受害者机器上的低权限用户账户必须能够向`C:\Windows\Temp\`目录写入文件。PowerShell的执行策略也需要允许脚本执行，通常通过`-ExecutionPolicy Bypass`参数绕过。
2.  **PoC配置**：在执行PoC脚本`exploit.ps1`之前，需要根据实际环境修改以下参数：
    *   `$LHOST`：攻击者的IP地址，用于接收反向Shell连接。
    *   `$LPORT`：攻击者监听器的端口号。
    *   `$NcPath`：可选参数，指定用于反向Shell的payload路径，例如`nc.exe`的路径。
    *   `$MinPID` 和 `$MaxPID`：用于文件预植入时预测的进程ID范围，通常使用默认值即可。
3.  **执行PoC**：在受害者机器上，以低权限用户身份打开PowerShell命令行界面，导航到`exploit.ps1`文件所在的目录，然后执行以下命令：
    `powershell.exe -NoProfile -ExecutionPolicy Bypass -File .\exploit.ps1`
    `-NoProfile`参数确保PowerShell不加载用户配置文件，`-ExecutionPolicy Bypass`绕过脚本执行限制。
4.  **反向Shell获取**：PoC脚本执行后，它将枚举MSI包，在`C:\Windows\Temp`目录中预置恶意payload，并触发CheckMK Agent的MSI修复过程。一旦MSI修复程序以SYSTEM权限执行了预置的payload，攻击者机器上的监听器将接收到一个来自受害者机器的SYSTEM权限的反向Shell，从而完成权限提升。

**投毒风险分析**
对该CVE-2024-0670的PoC代码进行投毒风险评估，结果为低风险（10%）。判断依据主要基于以下几点：首先，**代码的透明度与归属**。该PoC明确指出是基于elsevar11的公开PoC的“衍生分析”，并提供了原始PoC的GitHub链接。这种清晰的溯源和归属信息极大地增加了代码的可信度。在一个合法的安全研究项目中，透明地引用来源是标准实践，也意味着代码的意图是公开和可验证的。README文件还包含MIT许可协议，进一步强调了其开放和无恶意目的的特性。其次，**代码行为的预期性**。根据README的描述和PoC的配置参数（`$LHOST`, `$LPORT`, `$NcPath`），其核心功能是实现本地权限提升并建立反向Shell。这是一种标准且预期内的漏洞利用方式，旨在证明漏洞的存在和影响，而非偷偷植入额外恶意代码。反向Shell是PoC验证成功的基础，不应被误判为投毒行为。第三，**缺乏恶意混淆或隐藏行为**。README中未提及代码存在混淆、加密或使用非常规技术来隐藏其真实目的。PowerShell脚本通常是可读性较强的，若存在恶意行为，通常会通过不寻常的网络请求、文件操作或未经解释的代码段来体现。然而，该PoC的描述并未暗示这些特征。它专注于利用已知的系统机制（MSI修复、文件搜索路径）来实现权限提升。第四，**法律声明**。PoC的README明确包含“法律声明”，指出代码仅用于“教育、防御性工程和授权测试”。这进一步强化了其非恶意用途的立场。虽然攻击者可能会滥用任何公开的PoC，但PoC本身的设计意图是用于合法目的，而非作为一个被投毒的恶意载荷。综上所述，尽管任何公开的漏洞利用代码都有可能被恶意行为者滥用，但就此PoC代码本身而言，其透明的来源、明确的利用目的、缺乏隐藏恶意行为的迹象以及明确的合法用途声明，使其被评估为低投毒风险。组织在利用此类PoC进行测试时，应严格遵循授权范围，并确保在受控环境中进行。

**项目地址:** https://github.com/elsevar11/CVE-2024-0670-CheckMK-Agent-Local-Privilege-Escalation-Exploit

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2024-0670
