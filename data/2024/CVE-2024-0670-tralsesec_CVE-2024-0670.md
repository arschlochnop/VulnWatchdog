## CVE-2024-0670 - CheckMK Windows Agent 本地权限提升 (Local Privilege Escalation)

**漏洞编号:** CVE-2024-0670

**漏洞类型:** 本地权限提升 (Local Privilege Escalation)

**影响应用:** CheckMK Windows Agent

**危害等级:** 高危 (High)

**CVSS评分:** 8.8

**影响版本:** 所有安装了CheckMK Windows Agent的版本 (具体版本范围未明确，但漏洞影响已安装代理的系统)

**利用条件:** 需要对目标系统拥有低权限的本地用户账户；需要PowerShell允许脚本执行；需要对C:\Windows\Temp\目录拥有写入权限。

**POC 可用性:** 9/10

**POC 类型:** 完整利用 (Full Exploit)

**攻击复杂度:** 中

**投毒风险:** 10%

## 详情

### POC有效性分析
该Proof of Concept (PoC) 针对CVE-2024-0670，这是一个存在于CheckMK Windows Agent中的本地权限提升 (LPE) 漏洞。此漏洞被评为高危，CVSS评分为8.8，允许低权限的本地用户将权限提升至`NT AUTHORITY\SYSTEM`，从而完全控制受影响的Windows系统。漏洞的根本原因在于Microsoft Installer (MSI) 修复过程中存在的非受控搜索路径（Uncontrolled Search Path）问题。具体而言，当针对CheckMK Agent启动MSI修复操作时，安装程序会以高权限（通常是`SYSTEM`）尝试从`C:\Windows\Temp`目录执行特定文件，而这些文件的名称是可预测的，这就为攻击者预先放置恶意负载提供了机会。

该PoC是一个独立的PowerShell脚本，名为`exploit.ps1`，它是基于`elsevar11`发布的现有公开漏洞利用代码的衍生分析版本，并提供了更精简的漏洞利用逻辑。该脚本通过以下核心步骤实现了漏洞利用：
1.  **MSI包识别：** 脚本首先枚举并识别目标系统上已安装的CheckMK Windows Agent对应的MSI包。这是成功利用漏洞的关键一步，因为它确保了后续对正确MSI修复功能的调用。
2.  **可预测的Payload注入：** 此LPE漏洞的关键点在于低权限用户对`C:\Windows\Temp`目录拥有写入权限。PoC利用此权限，在该目录中创建多个带有可预测文件名的恶意Payload文件。这些文件名模式是MSI安装程序在修复阶段会查询的，并且通常包含进程ID (PID)。PoC允许配置一个PID范围（`$MinPID`，`$MaxPID`）来最大化成功匹配临时文件名的概率。每个预置文件都包含攻击者的恶意负载，通常是一个用于建立反向shell（例如，使用`nc.exe`）的命令，连接回攻击者控制的监听器。通过这种预置方式，当安装程序搜索并执行这些临时文件时，它会在不知情的情况下执行攻击者的代码。
3.  **触发MSI修复：** 最后，脚本以编程方式触发已识别的CheckMK Agent包的MSI修复操作。当修复过程开始时，安装程序在`NT AUTHORITY\SYSTEM`上下文下运行，会尝试定位并执行其所需的临时文件。当它在`C:\Windows\Temp`中找到与预期文件名匹配的攻击者预置文件时，便会以`SYSTEM`权限执行其中包含的Payload。一旦执行成功，攻击者将获得目标机器上的高权限shell。

该PoC功能强大且文档详尽。`README.md`清晰地列出了所有必要条件，包括目标系统上安装的CheckMK Windows Agent、低权限本地用户账户、允许脚本执行的PowerShell环境以及对`C:\Windows\Temp`目录的写入权限。此外，该脚本易于配置，用户可以指定`$LHOST`（攻击者IP）、`$LPORT`（攻击者端口）和`$NcPath`（反向shell Payload的`nc.exe`路径）等参数。清晰的使用说明和健壮的设计使其获得了9/10的高质量评分，被认为是一个完整且可部署的漏洞利用工具。此机制与常见的Windows权限提升模式一致，即受信任的进程从用户可写且可预测的位置执行代码，突显了安全文件处理和搜索路径配置的重要性。

### 漏洞利用步骤
1.  **准备攻击者监听器：** 在您的攻击机器上，启动一个网络监听器，例如使用Netcat：`nc -lvnp <ATTACKER_PORT>`。该监听器将等待来自被攻击目标的反向shell连接。
2.  **传输PoC：** 将`exploit.ps1` PowerShell脚本传输到目标Windows机器上。应将其放置在低权限用户具有写入和执行权限的目录中。
3.  **配置PoC：** 用文本编辑器打开`exploit.ps1`脚本，并调整脚本开头的配置变量：
    *   `$LHOST`：设置为您的攻击机器的IP地址。
    *   `$LPORT`：设置为您的Netcat监听器上配置的端口号。
    *   `$NcPath`：（可选）如果您计划使用`nc.exe`进行反向shell且它不在系统的PATH中，请指定`nc.exe`在目标机器上的完整路径。
    *   `$MinPID`和`$MaxPID`：这些值定义了PID猜测的范围；通常可以保留默认值，除非特定环境条件需要调整。
4.  **执行PoC：** 在目标机器上的低权限命令提示符或PowerShell会话中，使用Bypass执行策略运行脚本：
    `powershell.exe -NoProfile -ExecutionPolicy Bypass -File .\exploit.ps1`
5.  **接收Shell：** 如果漏洞利用成功，Payload（例如`nc.exe`）将在MSI修复过程中以`NT AUTHORITY\SYSTEM`权限执行，一个SYSTEM级别的反向shell将连接回攻击机器上的Netcat监听器。

### 投毒风险分析
对CVE-2024-0670的PoC进行全面分析后，我们认为其供应链投毒风险极低，估计约为10%。这一评估基于对PoC结构、内容和明确意图的几项关键观察。

首先，`README.md`中明确声明“此代码仅用于教育、防御性工程和授权测试”是至关重要的指标。它确立了一个透明的目的，表明该代码旨在演示漏洞，而非暗中损害运行它的用户系统。尽管此类免责声明并非万无一失，但它们有助于在研究人员社区中建立信任。

其次，该PoC以单个、未编译的PowerShell脚本（`exploit.ps1`）的形式提供，这使得其完全透明且可审计。不存在复杂的构建链、从未知来源拉取的外部依赖项或可能隐藏恶意代码的编译二进制文件。安全研究人员可以轻松审查`exploit.ps1`脚本的全部内容，以了解其操作。根据描述，该脚本主要与本地文件系统交互（在`C:\Windows\Temp`中创建文件）、枚举本地MSI包，并执行标准Windows命令来触发MSI修复。这些行为与所描述的漏洞和利用机制完全一致，不暗示任何隐藏的、无关的功能。

关键在于，必须区分PoC本身是否被投毒，以及PoC旨在传递的“利用Payload”（例如反向shell）。尽管漏洞利用的最终目标是获得SYSTEM权限并可能建立反向shell（这本质上是对目标机器的恶意行为），但该PoC并未嵌入其自身的隐藏恶意Payload以损害研究人员的机器。相反，它要求用户明确配置`$LHOST`、`$LPORT`和`$NcPath`以用于其选择的Payload（如`nc.exe`）。这意味着研究人员控制着被执行的“恶意”组件，而不是PoC作者预先打包的、不受信任的Payload。此外，该PoC的描述中没有出现常见的供应链投毒迹象，例如代码混淆、与未知命令和控制 (C2) 服务器的意外网络连接、从第三方域名下载额外脚本或可执行文件的尝试，或使用`eval`等动态代码执行机制从不受信任的输入。该脚本的行为似乎仅限于本地系统，并在演示权限提升的参数范围内。因此，尽管任何安全研究工具都应谨慎处理并在隔离、受控的环境中运行，但此特定PoC在通过恶意隐藏代码意外损害研究人员的开发或测试环境方面风险极低。主要的“风险”是漏洞利用本身的预期功能——在目标上获得提升的权限，这正是授权测试的目的。

**项目地址:** https://github.com/elsevar11/CVE-2024-0670-CheckMK-Agent-Local-Privilege-Escalation-Exploit

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2024-0670
