## CVE-2024-0670 - CheckMK Agent Local Privilege Escalation

**漏洞编号:** CVE-2024-0670

**漏洞类型:** Local Privilege Escalation

**影响应用:** CheckMK Agent

**危害等级:** High

**CVSS评分:** 8.8

**影响版本:** CheckMK Windows Agent (unpatched versions)

**利用条件:** 需要本地低权限用户、安装CheckMK Windows Agent、PowerShell允许脚本执行、可写入C:\Windows\Temp\

**POC 可用性:** 9

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 10%

## 详情

### POC有效性分析

该概念验证 (PoC) 为 CVE-2024-0670 提供了一个高度有效且详细记录的实现，这是一个影响 Windows 操作系统上 CheckMK Agent 的严重本地权限提升漏洞。该漏洞的 CVSS 评分为 8.8，被归类为“高”严重性，允许具有现有低权限本地用户访问权限的攻击者将其权限提升至 NT AUTHORITY\SYSTEM。对于寻求建立深度持久性、执行任意命令或完全控制受感染系统的攻击者来说，这是一项关键能力。

该 PoC 利用的基本缺陷在于 CheckMK Agent 的 MSI (Microsoft Installer) 修复过程。在修复操作期间，安装程序旨在以 SYSTEM 权限执行某些文件。关键是，PoC 识别并利用了此过程中不受控制的搜索路径，特别针对 C:\Windows\Temp 目录。未授权的攻击者可以在此临时目录中预先放置具有可预测文件名的可执行有效载荷。当合法的 MSI 修复过程随后被触发时，它会尝试查找并执行这些可预测命名的文件。由于不受控制的搜索路径和修复过程的提升上下文，安装程序会无意中执行攻击者控制的恶意有效载荷，从而使其获得 NT AUTHORITY\SYSTEM 权限。

`exploit.ps1` 脚本是用 PowerShell 编写的，这使其非常适合 Windows 环境，并且鉴于 PowerShell 的原生存在和强大的系统交互能力，具有高度的适应性。`README.md` 明确指出此实现是 `elsevar11` 现有公共 PoC 的“派生分析”。这表明一个改进过程，其中核心利用概念已被采纳并可能已得到改进，以提高清晰度、可靠性或易用性。此类派生作品通常受益于社区反馈和先前的测试，从而提高其整体有效性和稳定性。

PoC 随附的文档非常全面，这极大地提高了其质量和可用性。`README.md` 清楚地概述了漏洞摘要、存储库的具体内容（包括 `exploit.ps1`、`README.md` 和 `LICENSE`）以及成功利用所需的所有先决条件。这些要求包括安装了 CheckMK Windows Agent 的 Windows 机器、对低权限本地用户帐户的访问、配置为允许脚本执行的 PowerShell（通常可以绕过或为常见默认设置），以及写入 C:\Windows\Temp\ 目录的能力。

此外，文档还提供了 `exploit.ps1` 的精确配置说明，详细说明了 `$LHOST`（攻击者的 IP 地址）、`$LPORT`（攻击者用于反向 shell 侦听器的侦听端口）、`$NcPath`（攻击者选择的有效载荷（例如 `nc.exe`）的本地路径）以及 `$MinPID`/`$MaxPID`（可能用于通过预测潜在进程 ID 来优化文件播种过程的参数）等参数。清晰、分步的使用指南，包括如何设置攻击者端侦听器 (`nc -lvnp <PORT>`) 以及如何在受害者机器上执行 PoC (`powershell.exe -NoProfile -ExecutionPolicy Bypass -File .\exploit.ps1`)，确保即使具有中等技术专业知识的用户也能重现该漏洞。明确承诺“如果利用成功，SYSTEM shell 将回传到您的侦听器”提供了明确的成功指标。

利用标准 Windows 功能（特别是合法的 MSI 修复过程、用于临时文件的 C:\Windows\Temp 目录以及用于脚本执行的 PowerShell）强调了此漏洞在各种易受攻击的 CheckMK Agent 安装中的实用性和广泛适用性。因此，此 PoC 是安全专业人员进行授权渗透测试、漏洞研究或开发防御性对策以保护系统免受此特定威胁的宝贵资产。其完整性和可靠性使其在 PoC 质量方面达到 9/10。

### 利用步骤

1.  **环境准备**: 确保目标 Windows 机器已安装 CheckMK Windows Agent。攻击者必须对该机器上的低权限本地用户帐户拥有访问权限。此外，验证 PowerShell 的执行策略允许脚本执行（例如，Bypass），并且低权限用户对 `C:\Windows\Temp\` 目录具有写入权限。
2.  **PoC 及 Payload 部署**: 将存储库中的 `exploit.ps1` 脚本下载到受害者机器。同时，获取一个合适的有效载荷可执行文件，例如 `nc.exe` (Windows 版 Netcat)，并将其放置在受害者机器上的已知位置。
3.  **PoC 配置**: 在文本编辑器中打开 `exploit.ps1`。修改以下参数：
    *   `$LHOST`: 将其设置为攻击机器的 IP 地址，您将在该机器上侦听反向 shell。
    *   `$LPORT`: 将其设置为攻击机器上侦听器将使用的端口号。
    *   `$NcPath`: 将其更新为您的有效载荷（例如，`nc.exe`）在受害者机器上的完整路径。
    *   （可选）如果更喜欢特定的 PID 范围用于文件播种，则调整 `$MinPID` 和 `$MaxPID`，尽管默认值通常就足够了。
4.  **设置监听器**: 在您的攻击主机上，打开终端或命令提示符，并使用配置的端口启动 Netcat 侦听器：`nc -lvnp <PORT>`。
5.  **执行 PoC**: 在受害者机器上，从低权限用户的上下文（例如，标准命令提示符或 PowerShell 窗口）导航到 `exploit.ps1` 所在的目录。使用 PowerShell 执行脚本：`powershell.exe -NoProfile -ExecutionPolicy Bypass -File .\exploit.ps1`。
6.  **验证提权**: 观察攻击主机的 Netcat 侦听器。如果利用成功，将建立一个表示 NT AUTHORITY\SYSTEM shell 的新连接，从而授予攻击者在受害者系统上的提升权限。

### 投毒风险分析

该 PoC (CVE-2024-0670) 的投毒风险评估为低，约为 10%。此评估主要基于所提供 `README.md` 文档的透明性以及道德安全研究 PoC 中常见的代码设计模式。

首先，存储库明确说明了代码的预期用途：“教育、防御性工程和授权测试”。此声明建立了明确的道德界限，并向用户告知 PoC 开发的合法目的。尽管任何来自外部来源的代码都应谨慎对待，但此明确声明降低了从合法来源获取时 PoC 本身内部存在*有意隐藏恶意功能*的可能性。

PoC 以 PowerShell 脚本 (`exploit.ps1`) 的形式提供，这是 Windows 上常见且通常可审计的脚本语言。提供的 `README.md` 详细说明了脚本的功能、其可配置参数（例如 `$LHOST`、`$LPORT`、`$NcPath`）以及底层利用机制。没有明显的混淆迹象，而混淆是恶意行为者用来在看似合法的工具中隐藏其真实意图的常见策略。这种混淆会立即提高投毒风险。

至关重要的是，PoC 的设计将实际的“恶意”有效载荷交给了用户。`$NcPath` 参数要求攻击者提供自己的可执行文件，例如 `nc.exe` (Netcat)，该文件将以提升的权限执行。这意味着 PoC 本身主要是用于权限提升的机制，而不是次要的、未公开的恶意有效载荷的载体。任何后续的未经授权的操作，例如建立持久性、窃取数据或部署勒索软件，都将源自用户选择和提供的有效载荷，而不是秘密嵌入在 `exploit.ps1` 中。

此外，PoC 在其执行过程中似乎没有包含从不受信任或未知互联网源动态下载其他外部脚本或二进制文件的功能。这种行为将是潜在投毒的重要指标，因为它允许攻击者在发布后更改 PoC 的功能。同样，没有记录或明显的、与预期的反向 shell 连接回攻击者指定侦听器无关的可疑网络请求。

尽管已发布的 PoC 被其作者有意投毒的风险较低，但用户必须承认执行*任何*不受信任的代码都存在固有风险这一普遍安全原则。用户可能会无意中从非官方或受损来源下载此 PoC 的*修改版本*，其中已注入恶意代码。因此，强烈建议用户在执行 PoC 之前，尤其是在关键测试环境中，仔细检查 `exploit.ps1` 源代码，以确保其与记录的功能一致，并且不包含任何意外或恶意的隐藏例程。然而，仅根据所提供的信息和 `README.md` 以及所描述的 `exploit.ps1` 的透明性，当从受信任来源获取时，此特定 PoC 的直接投毒风险是最小的。

**项目地址:** https://github.com/elsevar11/CVE-2024-0670-CheckMK-Agent-Local-Privilege-Escalation-Exploit

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2024-0670
