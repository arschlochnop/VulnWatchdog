## CVE-2024-0670 - Tribe29 / CheckMK Windows Agent 本地权限提升 (LPE)

**漏洞编号:** CVE-2024-0670

**漏洞类型:** 本地权限提升 (LPE)

**影响应用:** Tribe29 / CheckMK Windows Agent

**危害等级:** 高危

**CVSS评分:** CVSS 8.8

**影响版本:** 所有安装了CheckMK Windows Agent的Windows系统版本（具体补丁版本未明确，应及时更新至最新安全版本）

**利用条件:** 需要低权限本地用户账户；PowerShell执行策略允许脚本运行；具备对C:\Windows\Temp\目录的写入权限。

**POC 可用性:** 9

**POC 类型:** 完整利用

**攻击复杂度:** 中

**投毒风险:** 10%

## 详情

POC有效性分析：
该POC针对CVE-2024-0670，一个存在于CheckMK Agent中的本地权限提升漏洞。该漏洞的根源在于MSI修复过程中存在不受控的搜索路径，且攻击者可以控制相关文件。当MSI修复过程执行时，安装程序会在`C:\Windows\Temp`目录下以可预测的文件名执行文件。攻击者作为一个低权限本地用户，可以预先在`C:\Windows\Temp`目录中植入恶意payload，这些payload随后将以NT AUTHORITY\SYSTEM的特权被执行，从而实现权限提升。
所提供的`exploit.ps1`是一个PowerShell实现的POC，它自动化了这一利用过程。脚本通过枚举MSI包、播种可预测的文件名并调用MSI修复来触发漏洞。`README.md`文件详细说明了PoC的用法、配置参数（如攻击者IP、端口、payload路径等）和具体要求，表明这是一个设计良好、功能完整的利用工具。此PoC是基于现有公开PoC的衍生分析，旨在提供更简洁的利用逻辑。鉴于其清晰的文档和明确的利用步骤，该PoC被认为是有效且可操作的，能够成功将低权限用户提升至SYSTEM权限。

利用步骤：
1.  确保目标Windows机器上已安装CheckMK Windows Agent。
2.  攻击者在其控制的攻击主机上启动一个监听器，例如使用Netcat：`nc -lvnp <端口>`。
3.  在目标Windows机器上，攻击者需要以一个低权限本地用户身份登录，并确保该用户对`C:\Windows\Temp\`目录有写入权限，且PowerShell的执行策略允许运行脚本（例如通过`Set-ExecutionPolicy Bypass`）。
4.  将`exploit.ps1`和必要的payload（如`nc.exe`）上传至目标机器。
5.  从低权限账户运行`exploit.ps1`脚本：`powershell.exe -NoProfile -ExecutionPolicy Bypass -File .\exploit.ps1`。
6.  脚本将触发CheckMK Agent的MSI修复过程，并执行预先植入在`C:\Windows\Temp\`中的payload。如果利用成功，一个具有SYSTEM权限的反向Shell将连接回攻击者的监听器。

投毒风险分析：
该PoC的代码和文档清晰，明确指出了其目的是进行“教育、防御性工程和授权测试”。PoC的核心功能是实现本地权限提升并建立反向Shell，这是此类漏洞利用的预期行为，不应被误判为“投毒”。
1.  代码清晰度：PoC的`README.md`详细描述了利用原理、配置和使用方法，没有明显的代码混淆。
2.  依赖项：PoC主要依赖于PowerShell以及可选的`nc.exe`作为payload，这些都是标准工具，且其使用方式在文档中得到了明确说明。
3.  外部连接：PoC会尝试连接到攻击者指定的IP和端口以建立反向Shell。这是其作为漏洞利用工具的正常功能，而非恶意投毒行为。
4.  隐藏功能：从目前的描述来看，没有证据表明该PoC包含除权限提升和Shell回连之外的隐藏恶意功能、广告软件或挖矿程序等。它不加载外部未知脚本，也不包含可疑的`eval`语句或难以理解的代码块。

综上所述，该PoC的投毒风险被评定为低。用户在运行前应仔细审查脚本内容，但其本身的设计和披露目的表明其并非恶意投毒。主要风险在于滥用此PoC进行未经授权的攻击。

**项目地址:** https://github.com/elsevar11/CVE-2024-0670-CheckMK-Agent-Local-Privilege-Escalation-Exploit

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2024-0670
