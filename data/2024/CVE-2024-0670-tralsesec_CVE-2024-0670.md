## CVE-2024-0670 - CheckMK Agent Local Privilege Escalation

**漏洞编号:** CVE-2024-0670

**漏洞类型:** Local Privilege Escalation

**影响应用:** CheckMK Agent

**危害等级:** High

**CVSS评分:** 8.8

**影响版本:** 特定版本的CheckMK Windows Agent (详细版本范围未在提供数据中明确)

**利用条件:** 需要本地低权限用户访问，且拥有对C:\Windows\Temp\目录的写入权限；目标系统需安装CheckMK Windows Agent并允许PowerShell脚本执行。

**POC 可用性:** 9

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 10%

## 详情

POC有效性分析:

针对CVE-2024-0670的PoC代码，其目标是CheckMK Windows Agent中的本地权限提升（LPE）漏洞。该漏洞被评为高危（CVSS 8.8），其根源在于MSI修复过程中存在一个不受控制的搜索路径。具体来说，当CheckMK Agent的MSI安装程序执行修复操作时，它会在`C:\Windows\Temp`目录中以可预测的文件名执行文件。一个低权限的本地用户可以利用此漏洞，预先在该临时目录中植入精心构造的恶意Payload。当MSI修复过程以特权用户（通常是`NT AUTHORITY\SYSTEM`）身份运行时，这些预先植入的Payload将被高权限执行，从而导致攻击者获得系统级权限。

该PoC以PowerShell脚本（`exploit.ps1`）的形式实现，并被描述为“独立的PowerShell概念验证”以及现有公开PoC的“衍生分析”，旨在提供“简化的利用逻辑”。这表明它是一个经过深入研究和优化的实现。`README.md`文件清晰地列出了利用该漏洞的前提条件：目标系统需安装CheckMK Windows Agent，攻击者需拥有一个无特权的本地用户账户，PowerShell需允许脚本执行（或通过绕过策略），并且该账户需具备对`C:\Windows\Temp\`目录的写入权限。这些条件对于典型的LPE漏洞而言是合理且常见的。PoC的配置部分提供了可调整的参数，包括攻击者IP（`$LHOST`）、攻击者端口（`$LPORT`）、Payload路径（`$NcPath`，例如`nc.exe`）以及用于文件播种的`$MinPID`和`$MaxPID`。这种高度的可配置性表明该PoC具有良好的灵活性和鲁棒性。`README.md`明确指出，如果利用成功，将“将SYSTEM shell回连到您的监听器”，这证实了PoC的目标和预期结果，即实现完整的权限提升。基于详尽的文档和对其功能的清晰描述，该PoC似乎高度有效且能完全实现其预期目的。其衍生性质也暗示核心漏洞和利用方法已得到验证，该PoC在此基础上进行了改进。

利用步骤:

1.  **环境准备**: 确保目标Windows机器已安装CheckMK Windows Agent。攻击者需要一个具有本地低权限的用户账户来执行PoC，并确保该账户拥有对 `C:\Windows\Temp\` 目录的写入权限。此外，目标系统上的PowerShell执行策略需允许脚本运行，或者在执行PoC时绕过该策略。
2.  **攻击主机设置**: 在攻击者控制的主机上，启动一个监听器以接收反向shell。常用的工具是Netcat。例如，使用命令 `nc -lvnp <PORT>` 启动监听，其中 `<PORT>` 是攻击者选择的端口。
3.  **配置PoC脚本**: 下载PoC脚本 (`exploit.ps1`) 到目标机器。根据攻击环境，修改脚本中的配置参数，包括：
    *   `$LHOST`: 攻击者的IP地址。
    *   `$LPORT`: 攻击者监听器的端口。
    *   `$NcPath`: 用于反向shell的有效载荷路径（例如，如果使用Netcat，则指定 `nc.exe` 的路径）。PoC的README中提到 `MinPID` 和 `MaxPID` 用于文件播种，这表明脚本会尝试在 `C:\Windows\Temp\` 中创建一系列文件名可预测的载荷文件。
4.  **执行PoC**: 以低权限用户身份在目标机器上执行修改后的PoC脚本。命令示例如下：
    `powershell.exe -NoProfile -ExecutionPolicy Bypass -File .\exploit.ps1`
    `-ExecutionPolicy Bypass` 参数用于绕过PowerShell的执行策略，允许脚本运行。
5.  **接收反向Shell**: 如果利用成功，PoC将触发CheckMK Agent的MSI修复过程。在此过程中，PoC预置在 `C:\Windows\Temp\` 中的恶意载荷将以 `NT AUTHORITY\SYSTEM` 权限执行，并通过之前配置的IP地址和端口回连到攻击者的监听器，从而提供一个SYSTEM权限的反向Shell。

投毒风险分析:

针对CVE-2024-0670的PoC代码投毒风险评估为**低**，具体为10%。主要基于以下几点考量：

首先，该PoC的`README.md`文件对其目的、功能、使用方法和预期结果进行了清晰而详细的描述。它明确指出这是一个用于获取`NT AUTHORITY\SYSTEM`权限的本地提权工具，并且会生成一个反向Shell回连到攻击者指定的IP和端口。这种高度的透明度极大地降低了代码中隐藏恶意行为的可能性。用户在阅读`README.md`后，能够充分理解脚本将执行的操作，包括尝试建立到指定IP和端口的反向连接。

其次，PoC的`README.md`中包含了明确且可配置的参数，例如`$LHOST`（攻击者IP）、`$LPORT`（攻击者端口）和`$NcPath`（Payload路径）。这些参数是典型反向Shell攻击的必需配置，表明其行为是可控且可预期的。用户可以检查这些参数，以确保它们指向预期的攻击者IP/端口或合法的Payload，而不是预设的恶意目标。

第三，`README.md`中提及此PoC是基于[elsevar11](https://github.com/elsevar11)的公开PoC的“衍生分析”，并旨在提供“简化的利用逻辑”。这种基于现有、已公开验证的PoC进行改进的做法，通常意味着代码逻辑会相对稳定和可靠，不易引入额外的、未经说明的恶意功能。如果原PoC是可靠的，那么一个旨在“简化”其逻辑的衍生版本，在没有明确说明的情况下，引入复杂隐藏恶意行为的可能性较低。

第四，PoC的“Legal Notice”明确声明此代码仅用于“教育、防御性工程和授权测试”。虽然法律声明并不能完全排除投毒可能性，但它反映了作者的意图和代码的预期用途，有助于建立一定的信任基础。

尽管如此，任何从第三方来源（包括GitHub等公共平台）获取的代码都存在潜在风险。在极端情况下，PoC的作者或恶意第三方可能在PoC代码中植入后门、信息窃取模块或其他恶意功能，即使`README.md`描述再详尽。例如，除了回连到攻击者外，PowerShell脚本也可能在后台静默执行其他恶意操作，如下载额外的恶意软件、修改系统配置或收集敏感信息。由于`exploit.ps1`的具体内容未在输入中提供，无法进行细致的代码审计。因此，在部署任何从GitHub或其他公共平台下载的PoC时，即使表面上看起来干净，也强烈建议进行严格的代码审计，尤其关注外部网络请求、文件系统操作和进程创建行为，以确保其仅执行声明的功能且不包含任何隐藏的恶意载荷或额外副作用。对于本PoC，由于其意图是明确的提权并回连，其本身作为“攻击工具”的功能不应被误判为“投毒代码”。真正的投毒风险在于PoC作者是否在实现预期功能的同时，悄悄加入了额外的、未经用户授权的恶意行为。从目前提供的信息来看，这种额外恶意行为的可能性较低。

**项目地址:** https://github.com/elsevar11/CVE-2024-0670-CheckMK-Agent-Local-Privilege-Exploit

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2024-0670
