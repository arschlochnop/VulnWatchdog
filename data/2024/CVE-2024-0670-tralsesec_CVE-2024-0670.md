## CVE-2024-0670 - CheckMK Agent 本地权限提升 (LPE)

**漏洞编号:** CVE-2024-0670

**漏洞类型:** 本地权限提升 (LPE)

**影响应用:** CheckMK Agent

**危害等级:** 高危

**CVSS评分:** 8.8

**影响版本:** 未知 (安装CheckMK Windows Agent的系统)

**利用条件:** 需要低权限本地用户账户，目标系统安装CheckMK Windows Agent，PowerShell执行策略允许脚本运行，且具备C:\Windows\Temp\目录写入权限。

**POC 可用性:** 9/10

**POC 类型:** 完整利用

**攻击复杂度:** 中

**投毒风险:** 10%

## 详情

CVE-2024-0670是CheckMK Agent的本地权限提升漏洞 (CVSS 8.8, 高危)。低权限本地用户可利用MSI修复机制中可预测的文件执行路径，将恶意载荷预置于`C:\Windows\Temp\`，并以`NT AUTHORITY\SYSTEM`权限执行，从而实现权限提升。漏洞根源在于MSI安装程序在修复时，会以高权限调用该临时目录下的特定文件。

本PoC是一个独立的PowerShell脚本(`exploit.ps1`)，基于现有公开PoC衍生。它通过枚举MSI包，在`C:\Windows\Temp\`放置用户自定义载荷（如`nc.exe`），然后触发MSI修复。成功利用后，攻击者可获得`SYSTEM`权限Shell。PoC文档清晰，配置参数透明，有效性高，适用于安全测试和复现。

**利用步骤:**
1.  目标系统需安装CheckMK Windows Agent。
2.  获取低权限本地访问。
3.  确保PowerShell执行策略允许，且可写入`C:\Windows\Temp\`。
4.  配置`exploit.ps1`中攻击机IP ($LHOST)、端口 ($LPORT) 和载荷路径 ($NcPath)。
5.  攻击机启动Netcat监听：`nc -lvnp <PORT>`。
6.  目标机低权限运行PoC：`powershell.exe -NoProfile -ExecutionPolicy Bypass -File .\exploit.ps1`。
7.  攻击机收到`SYSTEM`权限的Shell。

**投毒风险分析:**
该PoC为PowerShell脚本，旨在合法演示CheckMK Agent权限提升。其逻辑清晰，通过操作Windows Installer修复机制，利用用户提供的外部二进制载荷（如Netcat）进行高权限执行。脚本代码无明显混淆、加密或可疑外部调用。它明确要求用户提供载荷，并附有法律声明，指定用于教育和授权测试。代码本身不含除实现权限提升外的额外恶意功能。因此，PoC被恶意投毒的风险为低（0-29%）。用户应自行验证所用外部载荷的安全性。

**项目地址:** https://github.com/elsevar11/CVE-2024-0670-CheckMK-Agent-Local-Privilege-Escalation-Exploit

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2024-0670
