## CVE-2024-0670 - CheckMK Agent 本地权限提升 (LPE)

**漏洞编号:** CVE-2024-0670

**漏洞类型:** 本地权限提升 (LPE)

**影响应用:** CheckMK Agent

**危害等级:** 高危

**CVSS评分:** 8.8

**影响版本:** CheckMK Windows Agent (未打补丁版本)

**利用条件:** 需要低权限本地用户账户访问，对C:\Windows\Temp\目录有写入权限，PowerShell执行策略允许脚本运行（PoC包含绕过）

**POC 可用性:** 9

**POC 类型:** 完整利用

**攻击复杂度:** 中

**投毒风险:** 10%

## 详情

本PoC（`exploit.ps1`）针对CVE-2024-0670，CheckMK Agent在Windows系统中的一个本地权限提升漏洞。该漏洞源于MSI修复过程中存在不受控制的搜索路径。攻击者可利用这一缺陷，在`C:\Windows\Temp`目录中预先植入特定文件，当MSI修复过程被触发时，这些文件将以`NT AUTHORITY\SYSTEM`的最高权限执行。此PoC是基于现有公开PoC的衍生分析，通过精简利用逻辑，旨在提供一个更易于理解和复现的攻击载荷。PoC的运行环境要求包括已安装CheckMK Windows Agent的机器、低权限本地用户账户、允许PowerShell脚本执行的环境（PoC包含执行策略绕过机制），以及对`C:\Windows\Temp`目录的写入权限。该PoC利用外部`nc.exe`工具建立反向shell，从而实现SYSTEM权限的获取。其详尽的配置说明（如`$LHOST`、`$LPORT`、`$NcPath`等）及清晰的操作步骤，均表明此PoC在实际环境中具有高度的可用性和有效性。

**利用步骤：**
1. 攻击者在其攻击主机上启动Netcat监听器，命令示例：`nc -lvnp <PORT>`。
2. 确保目标Windows机器已安装CheckMK Agent，并且攻击者已获取一个低权限的本地用户账户。
3. 攻击者需将`nc.exe`放置在目标机器上，并相应配置PoC脚本中的`$NcPath`参数。
4. 在目标机器上，以低权限用户身份执行PoC脚本：`powershell.exe -NoProfile -ExecutionPolicy Bypass -File .\exploit.ps1`。
5. PoC将利用MSI修复过程的特性，将包含Netcat反向shell指令的恶意文件写入`C:\Windows\Temp`。
6. 一旦MSI修复过程被触发，预置的恶意文件将自动以`NT AUTHORITY\SYSTEM`权限执行。
7. 成功执行后，攻击者在监听主机上即可接收到来自目标机器的SYSTEM权限反向shell。

**投毒风险分析：**
本PoC的投毒风险评估为**低（10%）**。分析如下：
1.  **代码透明性**：PoC代码为PowerShell脚本，通常易于阅读和审计。`README.md`文件清晰地阐述了其“教育、防御性工程和授权测试”用途，详细描述了漏洞原理、利用方式和预期结果。代码本身无明显混淆、加密或其他隐藏恶意行为的迹象。
2.  **依赖项管理**：PoC利用外部`nc.exe`建立反向shell，这在合法的渗透测试场景中是常见且标准的做法。`nc.exe`的路径需用户明确配置（`$NcPath`），确保用户对其所用工具拥有知情权和控制权。PoC代码不包含未经用户授权的外部资源下载或执行逻辑。
3.  **行为符合性**：PoC的核心功能是利用CheckMK Agent的漏洞实现本地权限提升，并最终通过反向shell获取SYSTEM权限。这一行为完全符合PoC文档中声明的漏洞利用目标，而非偷偷执行如挖矿、数据窃取、僵尸网络注册等与漏洞利用无关的恶意活动。尽管反向shell具有攻击性，但它属于漏洞利用的预期产物。综合来看，该PoC因其代码逻辑清晰、依赖项明确且行为高度透明，被“投毒”的风险较低。但建议在受控环境中进行测试，并对所有第三方依赖项进行安全审查。

**项目地址:** https://github.com/elsevar11/CVE-2024-0670-CheckMK-Agent-Local-Privilege-Escalation-Exploit

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2024-0670
