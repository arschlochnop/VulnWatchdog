## CVE-2024-0670 - CheckMK Windows Agent 本地权限提升 (Local Privilege Escalation)

**漏洞编号:** CVE-2024-0670

**漏洞类型:** 本地权限提升 (Local Privilege Escalation)

**影响应用:** CheckMK Windows Agent

**危害等级:** 高

**CVSS评分:** 8.8

**影响版本:** 未明确指定具体的受影响版本范围，但影响所有安装了存在此漏洞的CheckMK Windows Agent的版本。

**利用条件:** 需要具有本地未授权用户账户，目标系统安装CheckMK Windows Agent，PowerShell执行策略允许脚本运行，并能写入 `C:\Windows\Temp\` 目录。

**POC 可用性:** 9

**POC 类型:** 完整利用 (Full Exploit)

**攻击复杂度:** 低

**投毒风险:** 10%

## 详情

CVE-2024-0670是一个存在于CheckMK Windows Agent中的本地权限提升漏洞。本次分析的PoC是一个独立的PowerShell脚本实现，其核心逻辑源自elsevar11公开的PoC，旨在通过精简代码提供更清晰的利用流程。该漏洞的根本原因是CheckMK Agent的MSI修复机制中存在一个未受控的搜索路径。当MSI修复过程被触发时，安装程序会以`NT AUTHORITY\SYSTEM`的最高权限在`C:\Windows\Temp`目录下执行具有可预测名称的文件。攻击者可以利用这一特性，作为低权限的本地用户，预先在`C:\Windows\Temp`目录中放置恶意Payload，并命名为安装程序期望的、可预测的名称。当受害系统上的CheckMK Agent触发MSI修复时，这些恶意的Payload就会被SYSTEM权限执行，从而实现权限提升。PoC的`README.md`文件提供了详尽的说明，包括如何配置攻击者的IP地址和端口、如何启动Netcat监听器，以及如何执行PowerShell脚本以获得一个SYSTEM权限的反向Shell。这种基于已知操作系统机制（MSI修复）的利用方式，以及清晰的文档和直接的攻击步骤，表明该PoC具有很高的有效性和可靠性。它绕过了现代操作系统的许多防御措施，因为它利用的是软件自身的安装和维护逻辑中的缺陷，使得普通用户可以获取系统级的控制权。

利用此CVE-2024-0670漏洞需要遵循以下步骤：
1.  **环境检查与准备:** 攻击者需确保目标Windows机器上已安装了CheckMK Windows Agent。此外，攻击者必须已获得目标系统的低权限本地用户账户访问权限，并且该账户的PowerShell执行策略允许运行本地脚本，同时具备对`C:\Windows\Temp\`目录的写入权限。
2.  **配置Payload:** 下载或准备好PoC脚本`exploit.ps1`。编辑此脚本，根据实际的攻击环境调整关键参数。具体来说，需要将`$LHOST`变量设置为攻击者的控制机器IP地址，将`$LPORT`变量设置为监听端口。如果需要使用特定的payload可执行文件（例如`nc.exe`），则需要将`$NcPath`变量指向该文件的完整路径。
3.  **启动攻击者监听器:** 在攻击者控制机器上，使用网络工具（如Netcat）启动一个监听器，等待来自受害系统的反向Shell连接。例如，可以使用命令`nc -lvnp <PORT>`，其中`<PORT>`应替换为`exploit.ps1`中配置的`$LPORT`。
4.  **执行PoC脚本:** 从目标系统的低权限用户账户中，打开PowerShell终端，并导航到`exploit.ps1`脚本所在的目录。然后执行以下命令来运行PoC脚本：`powershell.exe -NoProfile -ExecutionPolicy Bypass -File .\exploit.ps1`。`-NoProfile`参数确保脚本不会加载用户的PowerShell配置文件，`-ExecutionPolicy Bypass`参数则临时绕过当前的执行策略，允许脚本运行。
5.  **权限提升成功:** 脚本执行后，将利用CheckMK Agent的MSI修复机制，在`C:\Windows\Temp\`中创建并植入恶意Payload。随后，MSI修复过程将以`NT AUTHORITY\SYSTEM`的最高权限执行该Payload。如果一切顺利，攻击者在监听器上将收到一个具有SYSTEM权限的反向Shell连接，从而完成本地权限提升。

基于对所提供的PoC代码及其相关文档的分析，本PoC的投毒风险被评估为较低，风险等级为10%。主要的风险评估依据如下：
首先，PoC的`README.md`文件清晰地阐明了其目的——用于教育、防御性工程和授权测试，并且明确指出了其是基于另一个公开PoC的衍生实现。这种透明度是评估代码信任度的重要指标。
其次，代码本身是一个PowerShell脚本（`exploit.ps1`），PowerShell脚本通常是纯文本格式，易于安全研究人员进行代码审计和分析。这意味着恶意代码（如果存在）将难以通过混淆手段隐藏。在本次审查中，未发现明显的混淆技术或加密逻辑。
第三，PoC的配置参数（`$LHOST`, `$LPORT`, `$NcPath`）明确了脚本的外部通信目标和所使用的Payload。例如，`$NcPath`明确指示用户需要提供一个如`nc.exe`之类的网络工具作为Payload。这种明确的配置方式要求用户主动提供或指定外部组件，而非PoC自身偷偷下载或捆绑恶意软件。攻击者需要手动配置这些参数，表明了对操作的完全控制和知情。
最后，在代码中未发现任何迹象表明其会未经用户授权访问敏感文件、持久化后门、或尝试与未知/可疑的C2服务器进行通信（除了用户明确配置的`$LHOST`和`$LPORT`）。PoC的核心功能集中在利用MSI修复机制进行权限提升，并提供反向Shell作为结果。
综上所述，虽然任何执行外部代码都存在固有风险，但此PoC通过其透明性、易审计性以及明确的预期行为，将投毒风险降至较低水平。用户在部署和使用前，仍应自行审查`exploit.ps1`脚本内容，确保其完全符合预期，并仅在授权的环境中进行操作。

**项目地址:** https://github.com/elsevar11/CVE-2024-0670-CheckMK-Agent-Local-Privilege-Escalation-Exploit

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2024-0670
