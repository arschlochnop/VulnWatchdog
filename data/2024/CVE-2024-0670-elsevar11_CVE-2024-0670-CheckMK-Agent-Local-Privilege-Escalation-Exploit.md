## CVE-2024-0670 - CheckMK Windows Agent 本地权限提升 (LPE)

**漏洞编号:** CVE-2024-0670

**漏洞类型:** 本地权限提升 (LPE)

**影响应用:** CheckMK Windows Agent

**危害等级:** 高危

**CVSS评分:** 7.8

**影响版本:** CheckMK Agent 2.3.0p1之前的所有版本, 2.2.0p25之前的所有版本, 2.1.0p42之前的所有版本

**利用条件:** 攻击者必须已拥有受影响Windows系统的低权限访问权限，且系统中已安装CheckMK Agent并具有触发MSI修复的权限。

**POC 可用性:** 9/10

**POC 类型:** 完整利用

**攻击复杂度:** 中

**投毒风险:** 15%

## 详情

POC有效性分析：该漏洞源于CheckMK Windows Agent在执行MSI修复操作时，会以SYSTEM权限执行位于C:\Windows\Temp\等可写目录下的特定路径文件。POC代码提供了完整的利用链，包括用于权限切换的RunasCs.exe（.NET源码实现）、用于反弹Shell的nc.exe以及核心利用脚本exploit.ps1。该脚本通过在C:\Windows\Temp\目录下种植具有预测名称的恶意二进制文件，并诱导系统触发MSI Repair机制，从而将低权限用户的指令提升至NT AUTHORITY\SYSTEM权限执行。经过代码审查，POC包含完整的编译指令和逻辑流，具有极高的实战有效性。利用步骤：首先，攻击者需将RunasCs.exe、nc.exe和exploit.ps1上传至目标主机的临时目录。其次，在攻击机端启动nc监听程序（如nc -lvnp 1111）。接着，使用低权限账户运行RunasCs.exe并调用exploit.ps1脚本。脚本会自动化完成占位文件投放并触发CheckMK的自动修复逻辑，最终系统会调用位于临时目录下的恶意载荷，回传一个SYSTEM权限的Shell。投毒风险分析：该POC项目主要包含开源工具的重编译版本（RunasCs）和脚本文件。在投毒风险评估中，风险值定为15%。风险点主要在于：第一，提供的二进制文件（RunasCs.exe, nc.exe）虽为安全研究常用工具，但如果从非官方渠道直接运行下载的编译产物，存在被植入后门的二次风险；第二，exploit.ps1脚本中包含与攻击者IP通信的逻辑，尽管这是PoC的正常功能，但在未审计情况下盲目运行可能导致敏感信息外泄。然而，该项目提供了RunasCs.cs的源代码，并附带了详细的编译指南，这种透明度大大降低了恶意投毒的嫌疑。代码中未发现明显的混淆、恶意删除文件或针对研究员主机的破坏性逻辑，属于标准的防御性安全研究范畴。建议防御者在受控沙箱环境中进行复现，并自行使用csc.exe编译源码以规避二进制投毒风险。

**项目地址:** [https://sec-consult.com/vulnerability-lab/advisory/local-privilege-escalation-via-writable-files-in-checkmk-agent/](https://sec-consult.com/vulnerability-lab/advisory/local-privilege-escalation-via-writable-files-in-checkmk-agent/)

**漏洞详情:** [https://nvd.nist.gov/vuln/detail/CVE-2024-0670](https://nvd.nist.gov/vuln/detail/CVE-2024-0670)
