## CVE-2024-0670 - CheckMK Windows Agent 本地权限提升 (Local Privilege Escalation)

**漏洞编号:** CVE-2024-0670

**漏洞类型:** 本地权限提升 (Local Privilege Escalation)

**影响应用:** CheckMK Windows Agent

**危害等级:** 高 (High)

**CVSS评分:** 未知

**影响版本:** 未知 (但已知受影响版本在发生MSI修复时存在可写临时文件问题)

**利用条件:** 需要低权限用户认证；目标系统安装CheckMK Windows Agent；目标系统启用PowerShell；目标系统具备下载外部文件的能力；MSI修复机制可被触发。

**POC 可用性:** 9

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 5%

## 详情

CVE-2024-0670是一个影响CheckMK Windows Agent的本地权限提升漏洞。该漏洞的核心在于CheckMK在执行MSI修复操作时，会从`C:\Windows\Temp\`等可写临时目录中执行文件。如果一个低权限用户能够在该目录中放置名称可预测的恶意文件，并在合适时机触发MSI修复，则可以利用SYSTEM权限执行这些文件。

该POC提供了一个完整且高质量的利用方案，包含`exploit.ps1` PowerShell脚本、`RunasCs.exe`（及其源代码`RunasCs.cs`）以及`nc.exe`（Netcat）。`exploit.ps1`是主要的攻击逻辑，它被设计用于在MSI修复过程中，通过植入预期的可执行文件来劫持执行流。`RunasCs.exe`则被用于在目标系统上以低权限用户的身份，通过命令行执行`exploit.ps1`。

POC的有效性体现在以下几个方面：
1.  **完整性**: 提供了所有必需的攻击组件，包括自定义的执行工具和标准网络工具。
2.  **详细文档**: `README.md`文件清晰地阐述了漏洞原理、利用前置条件、搭建攻击环境的步骤（如启动HTTP服务器和Netcat监听器）、下载工具到目标机器的命令，以及最终执行攻击的命令。
3.  **源代码透明**: `RunasCs.cs`的提供增加了POC的审计性和可信度，允许用户验证其行为是否如预期。
4.  **实际效果**: 根据描述，成功利用后能反弹一个SYSTEM权限的逆向shell，这直接证明了本地权限提升的成功。

该POC的利用流程经过精心设计，遵循了权限提升漏洞的常见模式，即利用系统服务的特权执行特性。通过控制临时文件目录并触发特权进程对这些文件的执行，攻击者能够将低权限提升至系统最高权限。因此，该POC被认为是高度有效的，能够可靠地复现并利用CVE-2024-0670漏洞。

**利用步骤：**
1.  **准备攻击者机器**:
    *   在攻击者的控制机器上，启动一个简易HTTP服务器（如Python的`http.server`）来托管`RunasCs.exe`、`nc.exe`和`exploit.ps1`这三个攻击文件。
    *   同时，在攻击者机器上启动一个Netcat监听器（例如`nc -lvnp 1111`），用于接收来自目标系统的反向Shell。
2.  **文件传输到目标机器**:
    *   在已获得低权限访问的目标Windows机器上，利用`Invoke-WebRequest`等命令将攻击者机器上托管的`RunasCs.exe`、`nc.exe`和`exploit.ps1`下载到`C:\Windows\Temp\`目录。
3.  **执行漏洞利用**:
    *   在目标机器上，作为低权限用户，执行以下PowerShell命令：`.\RunasCs.exe username "password" "powershell.exe -NoProfile -ExecutionPolicy Bypass -File C:\Windows\Temp\exploit.ps1"`。这里的`username`和`password`是当前低权限用户的凭据。
4.  **获得SYSTEM Shell**:
    *   `exploit.ps1`脚本执行后，将利用CheckMK Agent的MSI修复机制的特性。当MSI修复过程被触发时，CheckMK Agent会以SYSTEM权限执行在`C:\Windows\Temp\`目录中发现的特定文件。`exploit.ps1`会确保`nc.exe`被SYSTEM权限执行，并连接回攻击者机器的Netcat监听器，从而提供一个SYSTEM权限的反向Shell。

**投毒风险分析：**
针对此POC的投毒风险评估为低风险（5%），主要基于以下几点：
1.  **代码透明性**: 核心利用脚本`exploit.ps1`和辅助执行程序`RunasCs.cs`的源代码均已提供。这种透明度允许安全研究人员和防御者彻底审查代码，以识别任何潜在的恶意或非预期行为。当前的代码分析未发现任何试图进行数据窃取、部署额外恶意软件、建立持久后门或执行其他无关恶意活动的迹象。其功能严格限定在触发漏洞并获取权限提升。
2.  **标准工具依赖**: 该POC依赖于`nc.exe`（Netcat），这是一个广为人知的网络调试和数据传输工具，在渗透测试中经常使用。其行为是可预测和受控的，且作为独立组件，其本身并不包含恶意逻辑。
3.  **行为集中**: POC的代码行为专注于实现本地权限提升。没有证据表明它会主动连接到未知的外部服务器、下载额外的混淆代码、执行未经授权的文件加密，或者进行其他与权限提升目的无关的系统破坏。
4.  **明确的免责声明**: 仓库中包含明确的法律免责声明，指出该项目仅用于教育和授权渗透测试目的，且作者不对滥用负责。虽然免责声明本身不能完全消除风险，但它表明了作者的意图并非分发恶意软件，而是提供一个研究工具。
5.  **无混淆代码**: 在提供的代码中，没有发现使用代码混淆技术来隐藏其真实意图。代码逻辑清晰，易于理解和分析。

总而言之，该POC是一个典型的、专注于单一漏洞利用的防御性研究工具。它通过合法且可审查的方式演示了CheckMK Agent的本地权限提升漏洞。因此，若在受控环境中进行分析和使用，其作为‘投毒’或携带额外恶意载荷的风险极低。用户仍应始终在隔离环境中运行任何外部来源的POC，并仔细审查其代码，以确保符合预期行为。

**项目地址:** 未提供

**漏洞详情:** https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2024-0670
