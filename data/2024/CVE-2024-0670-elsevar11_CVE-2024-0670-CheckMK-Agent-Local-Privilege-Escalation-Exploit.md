## CVE-2024-0670 - CheckMK Windows Agent Local Privilege Escalation (LPE)

**漏洞编号:** CVE-2024-0670

**漏洞类型:** Local Privilege Escalation (LPE)

**影响应用:** CheckMK Windows Agent

**危害等级:** High

**CVSS评分:** None

**影响版本:** Not specified in provided data

**利用条件:** 低权限Windows用户权限，已安装CheckMK Windows Agent，PowerShell已启用，能够访问攻击者控制的HTTP服务器。

**POC 可用性:** 9/10

**POC 类型:** 完整利用

**攻击复杂度:** 中

**投毒风险:** 5%

## 详情

POC有效性分析：
本POC代码针对CVE-2024-0670，这是一个存在于CheckMK Windows Agent中的本地权限提升漏洞。该漏洞的核心在于CheckMK Agent的MSI修复机制会在`C:\Windows\Temp\`目录下以NT AUTHORITY\SYSTEM权限执行文件。攻击者可以利用这一点，通过放置具有可预测名称的恶意payload到此临时目录，并触发MSI修复过程，从而以SYSTEM权限执行任意代码。

提供的POC是功能完整的，包含以下关键组件：
1.  `RunasCs.exe`：一个自定义的`runas`替代品，用C#编写（提供了`RunasCs.cs`源代码），用于方便地以指定用户凭据执行命令，尤其是在PowerShell脚本需要特定用户上下文时。
2.  `nc.exe`：Netcat工具的Windows版本，用于在成功利用漏洞后建立反向shell。
3.  `exploit.ps1`：核心的PowerShell利用脚本，负责在目标系统上放置payload并触发MSI修复机制。

`README.md`文件提供了清晰的逐步操作指南，包括如何设置攻击者端的HTTP服务器、将工具下载到目标系统、以及如何执行利用脚本。这种全面的文档和自包含的工具集使得POC具有高度的可用性和复现性。通过执行`exploit.ps1`，脚本会利用MSI修复过程，将`nc.exe`作为payload以SYSTEM权限执行，最终在攻击者机器上获取一个SYSTEM权限的反向shell。这充分证明了漏洞的有效性以及权限提升的成功。

利用步骤：
1.  **攻击者环境准备**：
    *   在攻击者机器上，启动一个简单的HTTP服务器（例如，使用Python的`http.server`模块），监听在一个指定端口（如8000），用于托管POC所需的文件 (`RunasCs.exe`, `nc.exe`, `exploit.ps1`)。
    *   同时，在攻击者机器上启动Netcat监听器（例如，`nc -lvnp 1111`），等待接收来自目标系统的反向shell连接。
2.  **目标系统操作（低权限用户）**：
    *   确保目标Windows系统上已安装CheckMK Windows Agent，且PowerShell处于可用状态。
    *   使用PowerShell的`Invoke-WebRequest`命令，从攻击者架设的HTTP服务器下载 `RunasCs.exe`、`nc.exe` 和 `exploit.ps1` 文件到目标系统的`C:\Windows\Temp\`目录。
    *   以当前低权限用户的身份，通过执行下载的`RunasCs.exe`来运行`exploit.ps1`脚本。命令格式大致为：`.\RunasCs.exe username "password" "powershell.exe -NoProfile -ExecutionPolicy Bypass -File C:\Windows\Temp\exploit.ps1"`。
3.  **权限提升**：
    *   `exploit.ps1`脚本将利用CheckMK Agent的MSI修复机制。它会通过在`C:\Windows\Temp\`目录中放置一个配置好的恶意payload（例如`nc.exe`，使其连接回攻击者监听器），并触发CheckMK Agent的MSI修复过程。
    *   由于MSI修复过程是以`NT AUTHORITY\SYSTEM`的最高权限执行`C:\Windows\Temp\`中的文件，因此攻击者放置的`nc.exe`将以SYSTEM权限被执行，并尝试连接回攻击者的Netcat监听器。
4.  **获取SYSTEM shell**：
    *   一旦`nc.exe`成功执行并连接，攻击者将在其Netcat监听器上接收到一个具有`NT AUTHORITY\SYSTEM`权限的反向shell，从而实现本地权限提升。

投毒风险分析：
本POC的投毒风险评估为低（5%）。这一评估基于以下几个关键因素：

1.  **代码透明度**：POC包含了`exploit.ps1`脚本的完整代码以及用于生成`RunasCs.exe`的`RunasCs.cs` C#源代码。这意味着安全研究人员可以对所有关键组件进行详细审查，确认其功能与声明相符，不存在隐藏的恶意行为或额外的攻击载荷。
2.  **功能明确性**：POC中包含的`nc.exe`是业界公认的渗透测试工具，用于建立反向shell，这完全符合本地权限提升后获取控制权的目的。`RunasCs.exe`虽然是自定义工具，但其作用（以明文密码执行`runas`）在利用场景下是明确的，且源代码公开可查。这些工具是漏洞利用链的组成部分，而非额外的、旨在感染POC使用者系统的“投毒”代码。
3.  **无混淆或未声明的外部依赖**：代码未检测到明显的混淆技术。除了`nc.exe`（作为利用的工具）之外，没有发现未声明的、来自不可信源的外部脚本或二进制文件调用。所有文件都是为了实现CVE-2024-0670的权限提升目标而存在的。
4.  **明确的免责声明**：`README.md`中明确指出此项目仅用于教育和授权渗透测试目的，警告用户不得用于非法活动，并声明作者不对滥用负责。这表明了其作为防御性安全研究工具的合法意图。

综上所述，虽然POC的最终目的是在目标系统上执行恶意（从目标角度看）操作以证明漏洞，但其自身并未包含针对POC使用者电脑的恶意代码、后门或其他未经授权的功能。因此，在使用此POC进行漏洞复现或安全研究时，主要风险在于误用或在非授权环境中执行，而不是POC代码本身具有“投毒”风险。

**项目地址:** None

**漏洞详情:** https://sec-consult.com/vulnerability-lab/advisory/local-privilege-escalation-via-writable-files-in-checkmk-agent/
