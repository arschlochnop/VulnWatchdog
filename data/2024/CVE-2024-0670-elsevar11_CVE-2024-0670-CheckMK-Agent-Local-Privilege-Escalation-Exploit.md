## CVE-2024-0670 - CheckMK Windows Agent 本地权限提升 (Local Privilege Escalation - LPE)

**漏洞编号:** CVE-2024-0670

**漏洞类型:** 本地权限提升 (Local Privilege Escalation - LPE)

**影响应用:** CheckMK Windows Agent

**危害等级:** 高危 (High)

**CVSS评分:** CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H

**影响版本:** 未知

**利用条件:** 需要低权限Windows用户、PowerShell启用、已安装CheckMK Windows Agent、能够下载文件（用于引入PoC工具）

**POC 可用性:** 9

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 10%

## 详情

此PoC针对CVE-2024-0670，一个存在于CheckMK Windows Agent中的本地权限提升漏洞。通过分析Readme.md文件及其提供的详细信息，以及随附的RunasCs.cs源代码，可以评估该PoC的有效性非常高。漏洞的核心在于CheckMK在执行MSI修复过程中，会从C:\Windows\Temp\目录下执行文件。由于该目录通常对低权限用户可写，攻击者可以预先在此处放置具有特定可预测名称的恶意payload，并在触发MSI修复时以NT AUTHORITY\SYSTEM权限执行这些payload。PoC的exploit.ps1脚本（虽未直接提供，但其功能在Readme.md中详细描述）正是利用了这一机制。它负责在目标目录中“播种”多个payload文件名，并触发MSI修复过程。RunasCs.cs编译成的RunasCs.exe工具作为一个runas的替代品，方便地允许低权限用户在执行exploit.ps1时指定凭据。PoC还整合了nc.exe (Netcat) 作为反向shell工具，这是渗透测试中获取远程代码执行（RCE）后控制的标准方法。整个利用链设计合理，步骤清晰，且使用的技术和工具均为业界常见且成熟的，表明其具备较高的成功率和可靠性。文档中详尽的“Requirements”和“Running the Exploit”部分进一步证明了其可用性和完整性，使得具有一定渗透测试经验的用户可以轻松复现该漏洞并验证其影响。

**利用步骤**
1.  **攻击者环境搭建**:
    *   **HTTP 服务器**: 在攻击者机器上，使用Python启动一个简易HTTP服务器（如 `python3 -m http.server 8000`），将PoC所需的工具文件（`RunasCs.exe`, `nc.exe`, `exploit.ps1`）托管起来，以便目标机器下载。确保HTTP服务器的IP地址和端口可从目标机器访问。
    *   **Netcat 监听器**: 启动一个Netcat监听器（例如 `nc -lvnp 1111`），等待来自目标机器的反向shell连接。监听端口（此处为 `1111`）需与 `exploit.ps1` 中配置的反向shell端口一致。
2.  **目标系统操作**:
    *   **权限与软件要求**: 目标Windows机器上需安装CheckMK Windows Agent，并且攻击者已获取一个低权限的用户会话。此外，目标机器的PowerShell需启用，并允许执行脚本及下载文件（通常默认情况下满足）。
    *   **下载PoC工具**: 在目标机器的低权限会话中，利用PowerShell的 `Invoke-WebRequest` 命令，将攻击者HTTP服务器上的 `RunasCs.exe`, `nc.exe`, 和 `exploit.ps1` 下载到 `C:\Windows\Temp\` 目录下。这一步是利用链的关键前置条件，因为 `C:\Windows\Temp\` 是可写且在MSI修复时会被SYSTEM权限执行的目录。
    *   **执行利用脚本**: 随后，低权限用户通过 `RunasCs.exe` 或直接通过PowerShell执行 `C:\Windows\Temp\exploit.ps1` 脚本。该脚本会自动化地执行以下操作：在 `C:\Windows\Temp\` 中创建具有可预测名称的payload文件；触发CheckMK Windows Agent的MSI修复过程，此修复过程会在 `NT AUTHORITY\SYSTEM` 上下文下执行；由于MSI修复机制会查找并执行 `C:\Windows\Temp\` 中特定名称的文件，此时攻击者预置的 `nc.exe` 将以SYSTEM权限被执行。
    *   **获取反向Shell**: `nc.exe` 在SYSTEM权限下执行后，将建立一个反向shell连接回攻击者的Netcat监听器。攻击者即可通过该shell获得目标机器的 `NT AUTHORITY\SYSTEM` 权限。

**投毒风险分析**
此PoC代码的投毒风险被评估为**低（Poisoning Risk: 10%）**。这一评估基于对所提供材料的深入审查，包括 `Readme.md` 文件及其对 `exploit.ps1` 脚本功能的描述，以及 `RunasCs.cs` 完整的C#源代码。

首先，**代码透明度高**是降低投毒风险的关键因素。`RunasCs.cs` 提供了完整的源代码，这允许安全研究员对其内部逻辑进行全面而详细的审计。该代码的核心功能是利用Windows API `CreateProcessWithLogonW` 来以特定用户身份启动进程，并特别增加了对明文密码的支持，这虽然在常规应用中不被推荐，但对于快速、便捷地执行PoC测试而言是合理的考量。代码结构清晰，没有使用任何明显的混淆技术或加密手段来隐藏其真实意图。

其次，**无外部可疑依赖或行为**。`Readme.md` 中描述的 `exploit.ps1` 脚本以及实际提供的 `RunasCs.exe` 和 `nc.exe` 文件都与漏洞利用的目标明确一致。`nc.exe` 是行业标准的反向shell工具，其功能广为人知，且在渗透测试中是获取shell的常用手段。`exploit.ps1` 的描述表明其主要任务是协调payload的放置和MSI修复的触发，这些均属于漏洞利用链的正常组成部分。整个PoC没有表现出从非预期外部源（例如未知或可疑的CDN、Pastebin链接等）下载或执行额外代码的行为。除了攻击者为接收反向shell而配置的 `ATTACKER_IP` 外，代码中没有发现硬编码的恶意C2服务器地址或其他可疑网络通信尝试。

第三，**目的声明明确且合法**。PoC的 `Readme.md` 文件明确指出其目的是用于“教育和授权渗透测试”（"for educational and authorized penetration testing only"），并附有法律免责声明（"Do not use it for illegal purposes. The author is not responsible for misuse."）。这种透明的声明有助于用户理解其用途，并加强了其作为安全研究工具的合法性。反向shell的获取是 `CVE-2024-0670` 漏洞成功利用后，证明权限提升的直接且预期的结果，并非PoC作者在代码中植入的额外恶意“后门”或隐藏功能。

综上所述，此PoC的投毒风险极低。它是一个专注于复现和验证特定本地权限提升漏洞的专业工具。在受控环境中进行测试和验证时，只要用户仔细审查其文档和可访问的源代码，并对其网络行为进行监控，即可有效规避潜在的意外风险。风险的百分比设定为10%是考虑到任何非官方的第三方PoC，无论代码多么清晰，总是存在理论上的极小概率被篡改或包含潜在未发现的恶意逻辑，但就当前分析而言，其恶意性倾向非常低。

**项目地址:** N/A

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2024-0670
