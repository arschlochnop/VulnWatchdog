## CVE-2024-0670 - CheckMK Agent 本地权限提升 (Local Privilege Escalation)

**漏洞编号:** CVE-2024-0670

**漏洞类型:** 本地权限提升 (Local Privilege Escalation)

**影响应用:** CheckMK Agent

**危害等级:** 高 (High)

**CVSS评分:** N/A

**影响版本:** 未知，影响Windows系统上的CheckMK Agent

**利用条件:** 需要本地访问权限

**POC 可用性:** 10/10

**POC 类型:** 完整利用

**攻击复杂度:** 中

**投毒风险:** 10%

## 详情

POC有效性分析：
该POC是一个基于PowerShell脚本（CVE-2024-0670.ps1）的完整利用工具，旨在演示针对CheckMK Agent的CVE-2024-0670本地权限提升漏洞。脚本设计精良，功能完备，能够有效地触发并利用此漏洞。其核心机制在于滥用Windows MSI修复过程在C:\Windows\Temp目录中处理临时文件的方式。
脚本首先执行一系列环境检查，包括验证当前用户对C:\Windows\Temp目录的读写权限。如果这些基本权限不满足，脚本将立即报错并退出，这体现了其在实际利用前的严谨性。
随后，脚本通过查询Windows注册表（HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Installer\UserData\S-1-5-18\Products\*\InstallProperties）来精确地定位系统中已安装的CheckMK Agent MSI安装包的路径。这是确保漏洞能够成功利用的关键一步，因为它依赖于特定产品的MSI修复机制。
漏洞利用的核心逻辑在于其对C:\Windows\Temp目录的操纵。脚本会生成大量命名模式为cmk_all_<PID>_<Counter>.cmd的临时CMD文件。这些文件中被注入了攻击者预定义的任意命令，默认情况下是一个无害的"whoami > C:\Windows\Temp\whoami.txt"命令，用于验证权限提升效果。
在文件创建和内容写入完成后，脚本会立即将这些生成的CMD文件设置为只读属性。这一步至关重要，它模拟了攻击者在目标系统上预先放置恶意只读文件的场景。
最后，脚本通过调用msiexec.exe并带上/fa参数来触发CheckMK Agent MSI安装包的强制修复（"修复所有文件"）。根据CVE-2024-0670的原理，当MSI修复过程尝试在C:\Windows\Temp目录中覆盖这些已存在的只读临时文件时，由于无法写入，文件覆盖操作会失败。然而，在某些Windows版本和配置下，即便文件覆盖失败，MSI进程仍会尝试以SYSTEM权限执行这些已存在的只读临时文件。这正是漏洞被成功利用的瞬间，攻击者预设的命令将以最高权限（SYSTEM）执行，从而实现本地权限的提升。
脚本的参数化设计，特别是$Cmd参数，允许用户自定义执行的命令，极大地增强了其灵活性和实际利用价值。通过检查C:\Windows\Temp\whoami.txt等输出文件，可以直观地验证命令执行是否成功以及所获得的权限级别。

利用步骤：
1.  **环境准备**：确保目标Windows系统上已安装CheckMK Agent，并且当前用户拥有对C:\Windows\Temp目录的本地读写权限（通常标准用户默认具备）。
2.  **获取PoC**：将CVE-2024-0670.ps1脚本上传至目标系统可访问的任一位置。
3.  **执行默认载荷**：打开PowerShell终端，导航至脚本所在目录，执行`.\CVE-2024-0670.ps1`。此命令将尝试以SYSTEM权限执行`whoami > C:\Windows\Temp\whoami.txt`。执行完成后，检查C:\Windows\Temp\whoami.txt文件内容，如果显示`nt authority\system`，则表示权限提升成功。
4.  **执行自定义载荷**：为了执行更具攻击性的命令，可以通过`$Cmd`参数传递自定义PowerShell命令或Windows命令行指令。例如，创建新的管理员用户：`.\CVE-2024-0670.ps1 -Cmd "net user EvilAdmin P@ssw0rd! /add && net localgroup administrators EvilAdmin /add"`。执行后，可以通过`net localgroup administrators`命令验证新用户是否已加入管理员组。
5.  **观察与验证**：脚本在执行过程中会输出进度信息。在最终命令执行后，务必检查预期的输出文件或系统状态（如新用户、服务状态、日志等）以确认攻击效果。

投毒风险分析：
该PowerShell PoC脚本（CVE-2024-0670.ps1）的投毒风险评估为低，具体评分为10%。这一评估基于以下几个关键因素：
首先，**代码的透明度和可读性极高**。脚本采用标准的PowerShell语法编写，结构清晰，逻辑直接，未发现任何形式的代码混淆或加密。所有操作，从文件权限检查、注册表查询、文件创建、属性设置到最终的msiexec.exe调用，都清晰地展示在代码中，使得安全研究人员和分析人员能够轻松审计和理解其行为，有效降低了隐藏恶意功能的可能性。
其次，**脚本不包含任何外部依赖或网络通信**。它不会尝试从互联网下载额外的代码、库文件或恶意载荷，也不会向外部服务器发送数据。所有的漏洞利用逻辑和资源都包含在单个.ps1文件中，大大减少了引入第三方恶意代码的风险，并简化了安全审查流程。
最重要的是，**攻击载荷是完全可控且默认无害的**。脚本的核心功能是通过`$Cmd`参数执行任意命令。默认情况下，`$Cmd`参数被设置为`"whoami > C:\Windows\Temp\whoami.txt"`，这是一个标准的系统命令，用于查询当前用户的身份并将结果输出到临时文件，对系统本身不造成任何破坏或副作用。这意味着脚本本身作为权限提升的“机制”，而不是预置的“恶意载荷”。用户或攻击者必须明确地修改`$Cmd`参数才能执行具有破坏性或恶意目的的命令。
此外，`README.md`文件中明确指出，该项目**仅用于教育目的和防御性安全研究**，进一步强调了其非恶意设计的初衷。这一声明与代码的实际行为相符，即它是一个用于概念验证和安全测试的工具，而非用于实际攻击。
尽管PoC脚本本身无毒，但在实际应用中，仍需警惕恶意行为者可能滥用此工具。攻击者可能会获取此PoC，然后将其中的`$Cmd`参数替换为恶意载荷，例如，用于安装持久性后门、窃取敏感数据、部署勒索软件或加入僵尸网络。因此，在使用此类PoC进行安全测试时，务必确保操作环境的隔离和载荷的安全性，以避免意外地造成系统损害或安全事件。对于组织而言，持续监控对`C:\Windows\Temp`目录的可疑文件写入和MSI修复操作是至关重要的防御措施。

**项目地址:** https://github.com/trickest/cve/tree/main/2024/CVE-2024-0670

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2024-0670
