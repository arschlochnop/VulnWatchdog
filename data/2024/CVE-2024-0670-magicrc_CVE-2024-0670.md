## CVE-2024-0670 - CheckMK Agent 本地权限提升 (Local Privilege Escalation)

**漏洞编号:** CVE-2024-0670

**漏洞类型:** 本地权限提升 (Local Privilege Escalation)

**影响应用:** CheckMK Agent

**危害等级:** 高危 (High)

**CVSS评分:** 

**影响版本:** Windows系统上的CheckMK Agent，具体受影响版本范围未在提供信息中明确。

**利用条件:** 需要本地访问权限 (Local Access Required)

**POC 可用性:** 9

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 10%

## 详情

POC有效性分析:
该PoC利用脚本`CVE-2024-0670.ps1`是一个用PowerShell编写的完整利用程序，旨在利用CheckMK Agent在Windows系统上的本地权限提升漏洞（CVE-2024-0670）。脚本首先检查当前用户对`C:\Windows\Temp`目录的读写权限，这是利用的关键前提。接着，它通过查询Windows注册表（`HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Installer\UserData\S-1-5-18\Products\*\InstallProperties`）来定位系统上安装的CheckMK MSI安装包的路径。一旦找到安装包，脚本会在一个循环中大量创建`.cmd`文件（数量由`MinPID`、`MaxPID`和`MaxCounter`参数控制）到`C:\Windows\Temp`目录。这些`.cmd`文件的内容默认为`whoami > C:\Windows\Temp\whoami.txt`，但可以通过`Cmd`参数自定义。创建后，脚本会将这些`.cmd`文件设置为只读属性。最后，脚本通过执行`msiexec.exe /fa "$Installer"`命令来触发CheckMK MSI安装包的修复过程。根据漏洞原理，当CheckMK Agent在修复过程中尝试在`C:\Windows\Temp`目录中创建或覆盖临时文件时，如果遇到已被设置为只读的同名文件，它将无法覆盖，但会错误地执行已存在的只读文件，并且是以`SYSTEM`权限执行。该PoC脚本的逻辑清晰，步骤完整，涵盖了漏洞利用的关键环节，具有高度的有效性和可靠性。

利用步骤:
1.  **获取本地访问权限:** 攻击者需要首先在目标Windows系统上获得一个低权限的本地用户会话。
2.  **传输PoC脚本:** 将`CVE-2024-0670.ps1`脚本传输到目标系统上的任何可执行目录，例如用户的文档目录或`C:\Temp`。
3.  **执行PoC脚本:** 打开PowerShell控制台，导航到脚本所在目录，并执行该脚本。
    *   默认执行：`.\CVE-2024-0670.ps1` (这将执行`whoami`并将结果写入`C:\Windows\Temp\whoami.txt`)
    *   自定义命令：攻击者可以通过`Cmd`参数指定任何希望以`SYSTEM`权限执行的命令，例如：`.\CVE-2024-0670.ps1 -Cmd "net user eviluser Passw0rd123! /add && net localgroup administrators eviluser /add"`。这将创建一个名为`eviluser`的用户并将其添加到本地管理员组中。
4.  **验证利用结果:** 脚本执行完成后，系统将触发CheckMK MSI的修复过程，导致预先放置的恶意`.cmd`文件以`SYSTEM`权限执行。攻击者可以检查自定义命令的执行结果，例如查看新创建的用户、修改的文件或反弹shell的连接状态。

投毒风险分析:
对`CVE-2024-0670.ps1`脚本的分析表明，其投毒风险极低。该脚本采用标准的PowerShell语法编写，代码结构清晰，易于阅读和理解。脚本的每一行操作都直接对应于漏洞利用的公开描述，包括检查文件系统权限、查询注册表以定位安装程序、创建和修改文件属性、以及调用`msiexec.exe`触发漏洞。
具体来说：
*   **代码透明度高:** 脚本中没有发现任何代码混淆技术（如Base64编码、反射加载等），也没有使用`Invoke-Expression` (IEX) 或 `eval` 等可能隐藏恶意行为的函数。
*   **无外部可疑通信:** 脚本不包含任何向外部IP地址或域名发起网络请求的代码，不存在下载额外恶意载荷的风险。
*   **依赖标准库/功能:** 脚本仅依赖Windows系统内置的PowerShell功能、文件系统操作和注册表查询，不引入任何第三方可疑组件。
*   **攻击载荷可控:** 脚本执行的实际恶意命令（例如添加用户、执行shell等）完全由用户通过`Cmd`参数提供。脚本本身是一个框架，负责设置利用条件和触发器，而不是包含固定的恶意载荷。
因此，该PoC脚本本身被设计为一个纯粹的漏洞验证和利用工具，其行为与公开披露的漏洞原理完全一致。使用者在执行前应仔细检查`Cmd`参数中提供的命令，确保其仅执行预期操作。在不修改脚本或其参数的情况下，该PoC不会引入额外的恶意软件或执行超出其权限提升目的的行为。鉴于代码的清晰性和可审计性，将其视为一个低投毒风险的合法安全研究工具。

**项目地址:** 

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2024-0670
