## CVE-2024-0670 - CheckMK Agent 本地权限提升 (Local Privilege Escalation)

**漏洞编号:** CVE-2024-0670

**漏洞类型:** 本地权限提升 (Local Privilege Escalation)

**影响应用:** CheckMK Agent

**危害等级:** 高 (High)

**CVSS评分:** Not available in provided data

**影响版本:** Checkmk Agent for Windows version 2.2.0p22 及以下, 2.1.0p39 及以下, 2.0.0p36 及以下

**利用条件:** 需要本地访问权限；目标系统需安装CheckMK Agent；攻击者需对C:\Windows\Temp目录有写入权限。

**POC 可用性:** 9/10

**POC 类型:** 完整利用 (Full exploit)

**攻击复杂度:** 中 (Medium)

**投毒风险:** 10%

## 详情

POC有效性分析：
此POC脚本（CVE-2024-0670.ps1）旨在利用CheckMK Agent在Windows系统上的一个本地权限提升漏洞。该漏洞的核心在于CheckMK Agent在执行安装或重装操作时，处理`C:\Windows\Temp`目录下临时文件的方式存在缺陷。具体而言，当Agent尝试在该目录创建一个临时文件，但同名文件已存在且被设置为只读时，Agent将无法覆盖该文件，却仍会尝试以SYSTEM权限执行这个预先存在的只读文件，从而导致权限提升。

该PowerShell脚本精心地实现了这一利用链：
1.  **环境检查**：脚本首先验证对`C:\Windows\Temp`目录的读写权限，确保攻击者能够在此目录中创建和操作文件，这是成功利用的前提条件。
2.  **定位CheckMK安装器**：通过查询Windows注册表（`HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Installer\UserData\S-1-5-18\Products\*\InstallProperties`），脚本找到CheckMK MSI安装程序的本地路径。这一步骤至关重要，因为重新安装MSI是触发漏洞的关键机制。
3.  **预置恶意`.cmd`文件**：这是漏洞利用中最关键的一步。脚本会遍历一系列可能的进程ID和计数器，在`C:\Windows\Temp`目录中创建大量命名模式为`cmk_all_PID_Counter.cmd`的`.cmd`文件。每个文件都写入一个由用户定义的命令（默认是`whoami > C:\Windows\Temp\whoami.txt`），然后将文件属性设置为只读。这种批量创建的策略大大增加了CheckMK Agent在生成其自身临时文件时，匹配到这些恶意只读文件的概率。
4.  **触发漏洞**：最后，脚本通过执行`msiexec.exe`并带上`/fa`参数（强制重新安装所有文件）以及之前找到的CheckMK MSI安装程序路径来触发漏洞。`msiexec.exe`的执行会促使CheckMK Agent进行安装例程，在此过程中，Agent将尝试创建临时文件。当它试图创建的临时文件与预置的只读恶意`.cmd`文件名称匹配时，便会因无法覆盖而执行该只读文件，最终以SYSTEM权限运行预设命令。

该POC代码设计严谨、逻辑清晰，能够有效且可靠地演示CVE-2024-0670漏洞，成功将任意命令提升至SYSTEM权限执行，并通过`whoami.txt`文件验证执行结果，证明了其高度的有效性。

利用步骤：
1.  确保目标Windows系统已安装受影响版本的CheckMK Agent。
2.  获取此POC脚本`CVE-2024-0670.ps1`。
3.  以具有本地账户权限的用户身份登录到目标系统（该用户需对`C:\Windows\Temp`目录拥有写入权限）。
4.  打开PowerShell终端，导航到脚本文件所在的目录。
5.  直接执行脚本，默认将运行`whoami > C:\Windows\Temp\whoami.txt`：`.\CVE-2024-0670.ps1`。
6.  若需执行自定义命令，可使用`-Cmd`参数，例如：`.\CVE-2024-0670.ps1 -Cmd "net user evil_admin Password123 /add && net localgroup administrators evil_admin /add"`。
7.  脚本执行完成后，检查`C:\Windows\Temp\whoami.txt`（或根据自定义命令的输出）以验证命令是否已成功以SYSTEM权限执行。

投毒风险分析：
此POC代码的投毒风险评估为**低**（10%）。评估基于以下关键因素：
1.  **代码透明度与可读性**：脚本使用PowerShell编写，代码结构清晰，易于理解，未发现任何形式的代码混淆、加密或复杂嵌套，使得安全研究人员可以轻松地审计其所有功能和行为。
2.  **无外部依赖和网络活动**：脚本完全在本地环境中运行，不涉及从外部URL下载任何组件、执行远程脚本或向外部服务器发送数据。这种自包含的特性显著降低了通过引入第三方恶意内容进行投毒的可能性。
3.  **默认载荷的安全性**：脚本默认执行的命令是`whoami > C:\Windows\Temp\whoami.txt`。这是一个完全无害的命令，其唯一目的是验证漏洞是否成功利用并输出当前的执行用户，不会对系统造成任何破坏或引入恶意功能。
4.  **参数化设计**：脚本允许通过`-Cmd`参数自定义要执行的命令。虽然这使得攻击者可以注入恶意载荷，但此功能本身是提权漏洞POC的常见设计，旨在展示其任意代码执行的能力。这种灵活性是漏洞证明的关键组成部分，而非POC代码自带恶意属性。恶意利用的风险源于漏洞本身的性质，而非POC代码的固有恶意。
5.  **标准库使用**：脚本主要依赖于Windows操作系统内置的PowerShell环境和.NET框架提供的标准功能，没有引入任何可能包含未知风险或恶意行为的非标准第三方库。

综上所述，该POC代码本身不包含任何恶意载荷、后门或旨在损害目标系统的行为。其设计宗旨纯粹是用于合法的漏洞验证和安全研究。因此，对于组织而言，在受控的沙箱环境中严格审查后，将其用于内部安全测试的风险极低。然而，任何涉及权限提升的POC，一旦被恶意攻击者篡改，都可能被植入真正的恶意载荷（如勒索软件、窃密木马或后门），从而对目标系统构成严重威胁。因此，始终强调在下载和执行任何第三方POC代码时，必须进行彻底的安全审查，并仅在隔离的安全环境中操作。

**项目地址:** Not available in provided data

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2024-0670
