## CVE-2024-0670 - CheckMK Agent 本地权限提升 (LPE)

**漏洞编号:** CVE-2024-0670

**漏洞类型:** 本地权限提升 (LPE)

**影响应用:** CheckMK Agent

**危害等级:** 高危

**CVSS评分:** CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H (7.8 High)

**影响版本:** Checkmk Agent for Windows prior to 2.2.0p22, 2.1.0p41, 2.0.0p40

**利用条件:** 需要本地访问，攻击者需具备低权限用户身份

**POC 可用性:** 9

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 0%

## 详情

CVE-2024-0670是一个影响Windows系统上Checkmk Agent的本地权限提升（LPE）漏洞。该漏洞的根本原因在于Checkmk Agent在执行安装或修复操作时，会在`C:\Windows\Temp`目录下创建和执行临时文件。攻击者可以利用这一行为，通过在`C:\Windows\Temp`目录中预先放置具有只读属性的恶意`.cmd`或`.bat`文件，并使其文件名与Checkmk Agent预期创建的临时文件名匹配。当Checkmk Agent尝试创建或覆盖这些临时文件时，由于文件已被设置为只读，覆盖操作会失败。然而，Agent程序并未正确处理这一失败情况，而是会继续尝试执行已经存在的只读文件。由于Checkmk Agent通常以`SYSTEM`权限运行其安装或修复过程，因此攻击者可以利用此漏洞执行任意代码，从而将权限从低权限用户提升到`SYSTEM`级别，实现完全的系统控制。SEC Consult的漏洞通报对此有详细说明，并将其定级为高危漏洞。受影响的Checkmk Agent版本包括Windows版2.2.0p22之前、2.1.0p41之前以及2.0.0p40之前的版本。

提供的PoC是一个用PowerShell编写的脚本（`CVE-2024-0670.ps1`），其旨在利用CVE-2024-0670漏洞。该脚本的有效性非常高，它完整地实现了利用该漏洞的关键步骤。
首先，脚本会检查当前用户对`C:\Windows\Temp`目录的读写权限，确保利用环境满足基本条件。
其次，脚本通过查询Windows注册表（`HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Installer\UserData\S-1-5-18\Products\*\InstallProperties`）来定位Checkmk Agent的MSI安装程序路径。这是成功触发漏洞的关键一步，因为它需要对特定的Checkmk安装实例进行操作。
接着，脚本的核心部分是预创建大量的`.cmd`文件在`C:\Windows\Temp`目录下。为了增加触发的概率，脚本会针对`MinPID`到`MaxPID`的范围以及`MaxCounter`的循环生成多个潜在的文件名（格式如`cmk_all_$($i)_$($c).cmd`）。每个生成的`.cmd`文件都包含一个由`$Cmd`参数指定的命令，默认情况下是`whoami > C:\Windows\Temp\whoami.txt`。这些文件在创建后立即被设置为只读属性，模拟了攻击者预先放置恶意文件并保护其不被覆盖的情景。
最后，脚本通过执行`msiexec.exe /fa "$Installer"`命令来触发Checkmk Agent的修复（`fa`参数表示强制重新安装所有文件）或安装过程。此操作将导致Checkmk Agent尝试重新创建或检查其临时文件，进而触发对预置的只读恶意`.cmd`文件的执行。由于`msiexec.exe`在执行此类操作时通常以`SYSTEM`权限运行，因此`$Cmd`中指定的命令也将以`SYSTEM`权限执行。
脚本的参数化设计（如`MinPID`, `MaxPID`, `MaxCounter`, `Cmd`）使其具有良好的灵活性和可配置性，可以根据实际情况调整以优化利用效果或执行不同的Payload。综合来看，该PoC是一个功能完整、可直接用于复现和验证漏洞的有效工具。

利用步骤:
1.  **获取PoC脚本**: 下载`CVE-2024-0670.ps1`脚本到目标Windows系统上，通常可以通过网络传输或物理访问。
2.  **准备执行环境**: 确保当前用户对`C:\Windows\Temp`目录具有读写权限（通常标准用户默认具有）。
3.  **执行PoC脚本**: 以一个低权限用户身份运行PowerShell，并执行该脚本。例如：
    ```powershell
    .\CVE-2024-0670.ps1 -Cmd "net user attacker Password123! /add && net localgroup Administrators attacker /add"
    ```
    上述命令将尝试添加一个名为`attacker`的用户并将其加入`Administrators`组。
4.  **等待触发**: 脚本会创建大量只读`.cmd`文件，然后启动`msiexec.exe`触发Checkmk Agent的修复过程。此过程可能需要一些时间完成。
5.  **验证结果**: 修复过程完成后，检查`C:\Windows\Temp`目录下是否存在由`$Cmd`参数指定的命令创建的输出文件（例如，如果使用默认的`whoami`，则检查`C:\Windows\Temp\whoami.txt`）。或者验证是否成功添加了管理员用户。`whoami.txt`中应显示`nt authority\system`，表明命令已以`SYSTEM`权限执行。

该PoC脚本的投毒风险评估为**低（0%）**。
首先，脚本代码清晰可读，采用标准的PowerShell语法，没有任何混淆技术。攻击者可以很容易地审查代码，理解其功能和执行逻辑。
其次，脚本的行为是透明的。它明确地在`C:\Windows\Temp`目录中创建文件，并通过`Start-Process "msiexec.exe"`调用`msiexec`，这些操作都是公开且可被监控的。脚本没有尝试隐藏其创建的文件或执行的进程。
第三，脚本未包含任何外部依赖、下载器或与未知C2服务器通信的代码。所有操作均在本地执行，仅利用了Windows系统自身的功能。
第四，`$Cmd`参数使得PoC的“恶意”行为是显式可控的。默认的`whoami > C:\Windows\Temp\whoami.txt`是一个典型的、无害的验证Payload，用于演示权限提升是否成功。如果攻击者需要执行真正的恶意代码，他们必须明确地修改`$Cmd`参数或传递自定义命令。
最后，脚本中没有使用`eval`、反射或其他动态代码执行技术，进一步降低了代码中隐藏恶意逻辑的可能性。
综上所述，该PoC完全符合防御性安全研究的目的，其代码的透明度和行为的可预测性使得它几乎没有被滥用或隐藏恶意行为的风险。

**项目地址:** https://github.com/vulnwatchdog/CVE-2024-0670

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2024-0670
