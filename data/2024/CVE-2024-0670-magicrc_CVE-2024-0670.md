## CVE-2024-0670 - CheckMK Agent 权限提升

**漏洞编号:** CVE-2024-0670

**漏洞类型:** 权限提升

**影响应用:** CheckMK Agent

**危害等级:** 高危

**CVSS评分:** 

**影响版本:** 未指定

**利用条件:** 需要本地访问，低权限用户可利用

**POC 可用性:** 9

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 10%

## 详情

CVE-2024-0670是一个影响Windows系统上CheckMK Agent的本地权限提升漏洞。该漏洞的根本原因在于CheckMK Agent在执行MSI修复或重安装过程中，会在C:\Windows\Temp目录中创建临时文件并尝试执行。如果攻击者能够预先在该目录中创建一个与代理预期临时文件名相同的只读文件，代理将无法覆盖该文件，但仍会以SYSTEM权限执行已存在的只读文件，从而导致权限提升。

**POC有效性分析：**
提供的PowerShell脚本`CVE-2024-0670.ps1`是一个高度有效且功能完整的概念验证（PoC）代码，旨在利用上述漏洞。脚本首先进行了一些必要的环境检查，例如验证对`C:\Windows\Temp`目录的读写权限，这体现了其健壮性。接着，它会通过查询注册表项`HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Installer\UserData\S-1-5-18\Products\*\InstallProperties`来动态定位系统中已安装的CheckMK Agent MSI包路径，确保了利用的通用性。核心利用逻辑在于脚本会在`C:\Windows\Temp`目录下创建大量具有特定命名模式（`cmk_all_PID_COUNTER.cmd`）的只读批处理文件。这些批处理文件默认包含`whoami > C:\Windows\Temp\whoami.txt`命令，攻击者也可以通过`Cmd`参数自定义。创建完成后，脚本会通过`Start-Process "msiexec.exe" -ArgumentList "/fa `"$Installer`""`命令强制触发CheckMK Agent的修复或重安装过程。在此过程中，CheckMK Agent尝试生成并执行临时文件时，将因无法覆盖预置的只读文件而转而执行这些已由攻击者控制的批处理文件，且执行上下文为`SYSTEM`权限。这种“占位并触发”的机制有效绕过了文件写入保护，实现了权限提升。脚本通过创建大量文件，增加了成功触发的可能性，尤其是在面对动态生成文件名的情况。因此，该PoC能够可靠地演示并实现CVE-2024-0670的权限提升。

**利用步骤：**
1. 确保目标Windows系统上已安装受影响版本的CheckMK Agent。
2. 获取`CVE-2024-0670.ps1` PowerShell脚本。
3. 以任意具有本地交互权限的低权限用户身份登录到目标系统。
4. 执行PowerShell脚本，例如：`powershell.exe -ExecutionPolicy Bypass -File CVE-2024-0670.ps1`。
5. 脚本将首先检查`C:\Windows\Temp`目录的权限，然后查找CheckMK Agent的MSI安装包路径。
6. 接着，脚本会在`C:\Windows\Temp`目录下创建多个只读的`.cmd`文件，其中包含默认的`whoami > C:\Windows\Temp\whoami.txt`命令（或攻击者通过`Cmd`参数指定的命令）。
7. 脚本随后调用`msiexec.exe`命令，强制执行CheckMK Agent的修复流程，从而触发漏洞。
8. CheckMK Agent在修复过程中会尝试执行临时文件，但由于攻击者预置的只读文件存在，代理将转而以`SYSTEM`权限执行这些恶意批处理文件。
9. 攻击者可以通过检查`C:\Windows\Temp\whoami.txt`文件的内容，确认`whoami`命令是否成功以`SYSTEM`用户身份执行，从而验证权限提升是否成功。

**投毒风险分析：**
对`CVE-2024-0670.ps1`代码进行全面分析后，可以评估其投毒风险为低，具体百分比为10%。该PowerShell脚本的代码结构清晰，未经混淆，所有操作均一目了然。脚本的核心逻辑包括：检查文件系统权限、查询本地注册表、在指定临时目录（`C:\Windows\Temp`）创建文件以及调用标准的系统程序（`msiexec.exe`）。这些行为均与漏洞利用的原理高度一致，并未发现任何超出预期的恶意行为。脚本中没有包含下载外部恶意Payload的代码，也没有使用`eval`、`Invoke-Expression`等可能导致动态加载和执行未经审查代码的功能。默认的攻击载荷`whoami > C:\Windows\Temp\whoami.txt`是一个典型的权限验证命令，用于证明漏洞的有效性，本身并不具有破坏性或恶意性。虽然攻击者可以将`Cmd`参数修改为任意恶意命令，但这是攻击者利用合法PoC的行为，而非PoC本身包含投毒逻辑。此外，随PoC提供的`README.md`文件明确声明该项目旨在用于教育和研究目的，进一步降低了其作为投毒工具的可能性。综上所述，此PoC代码自身是清洁的，主要用于安全研究和验证，其投毒风险非常低。

**项目地址:** 

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2024-0670
