## CVE-2024-0670 - CheckMK Agent on Windows systems 本地权限提升 (Local Privilege Escalation)

**漏洞编号:** CVE-2024-0670

**漏洞类型:** 本地权限提升 (Local Privilege Escalation)

**影响应用:** CheckMK Agent on Windows systems

**危害等级:** 高 (SYSTEM权限提升)

**CVSS评分:** 未在输入数据中提供，但通常对于可导致SYSTEM权限的本地权限提升漏洞，CVSS评分会较高。

**影响版本:** 未在输入数据中明确提供

**利用条件:** 需要本地文件系统访问权限，漏洞利用本身不需要认证，但执行PoC需要本地用户权限。

**POC 可用性:** 9/10

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 5%

## 详情

该PoC针对CVE-2024-0670漏洞，该漏洞影响Windows系统上的CheckMK Agent。根据PoC的描述，漏洞的核心在于CheckMK Agent在创建和执行临时文件时，没有正确处理文件覆盖和权限问题。具体而言，当代理尝试在`C:\Windows\Temp`目录中创建临时文件（通常是为了执行某些维护或更新操作）时，如果该目录中已存在一个同名的文件，并且该文件被设置为只读属性，Agent将无法覆盖它。然而，关键的缺陷在于，尽管文件创建或覆盖操作失败，Agent仍然会以`SYSTEM`权限执行这个已经存在的、被恶意预置的只读文件。这种机制使得普通权限的攻击者能够通过精心构造和预置恶意`.cmd`文件，利用CheckMK Agent的信任级别，将自身权限提升至`SYSTEM`。

提供的PowerShell脚本`CVE-2024-0670.ps1`清晰、完整且高度有效地实现了这一攻击逻辑。脚本首先通过`Get-ChildItem "C:\Windows\Temp"`和尝试写入测试文件`access_test.tmp`来验证当前用户对`C:\Windows\Temp`目录的读写权限，这是利用此漏洞的先决条件。如果权限不足，脚本会立即报错并退出，体现了其在实际利用前的严谨性。

接下来，脚本通过查询Windows注册表路径`HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Installer\UserData\S-1-5-18\Products\*\InstallProperties`来识别并获取CheckMK Agent的MSI安装程序路径。攻击者需要知道或能够定位到目标系统上的CheckMK安装程序，这是触发漏洞的关键一步。一旦找到安装程序路径，脚本会输出提示信息，确认已定位到目标。

利用阶段的核心步骤如下：
1.  **大规模预置恶意文件**：脚本设计了一个巧妙的“文件爆炸”策略。它会迭代生成大量的`.cmd`文件，并将它们放置在`C:\Windows\Temp`目录下。这些文件的命名遵循`cmk_all_$($i)_$($c).cmd`的模式，其中`$i`代表一个进程ID范围（由`$MinPID`到`$MaxPID`控制），`$c`代表一个计数器（由`$MaxCounter`控制）。这种命名模式是为了模拟和覆盖CheckMK Agent在不同执行上下文和尝试中可能生成的临时文件名。默认情况下，如果`MinPID=1000, MaxPID=10000, MaxCounter=1`，脚本将生成高达`(1+1) * (10000-1000) = 18000`个独特的`.cmd`文件。每个文件都包含预定义的命令，默认为`whoami > C:\Windows\Temp\whoami.txt`，用于在利用成功后将当前执行用户的身份写入临时文件，作为权限提升的证据。
2.  **强制设置只读属性**：在每个`.cmd`文件被写入`C:\Windows\Temp`目录后，脚本会立即使用`Set-ItemProperty -Path $filePath -Name IsReadOnly -Value $true`命令将其属性设置为只读。这一步是整个利用过程中最关键的环节。它确保当CheckMK Agent在后续操作中尝试创建同名临时文件时，会因为这些预置文件已存在且为只读而无法成功覆盖它们。
3.  **触发漏洞执行**：完成文件预置后，脚本通过`Start-Process "msiexec.exe" -ArgumentList "/fa \"$Installer\"" -Wait`命令启动`msiexec.exe`进程。参数`/fa`指示Windows Installer执行强制性的重新安装操作（即“修复”操作），检查并替换所有损坏或缺失的文件。在CheckMK Agent的修复过程中，它会尝试在`C:\Windows\Temp`目录下创建和执行一些临时脚本来完成其任务。由于之前已经预置了大量同名的只读恶意`.cmd`文件，当Agent尝试创建这些临时文件时，将触发文件写入失败的条件。然而，由于漏洞的存在，Agent在这种失败情况下不会停止，而是会错误地以其自身的`SYSTEM`权限执行这些预置的、已包含攻击者命令的`.cmd`文件。
4.  **结果验证**：利用成功后，默认的`whoami`命令将在`C:\Windows\Temp\whoami.txt`文件中留下`nt authority\system`的输出，从而验证权限已成功提升至`SYSTEM`。

该PoC代码结构良好，逻辑严谨，并通过多种策略（如文件命名空间覆盖、只读属性设置）确保了其在实际环境中的高成功率。它不仅演示了漏洞的存在，还提供了一个完整的、可复现的攻击链，对于安全研究人员和系统管理员理解和防御此漏洞具有极高的价值。


对提供的PoC代码`CVE-2024-0670.ps1`进行投毒风险评估，结果显示其风险等级非常低（评估为5%）。

1.  **代码清晰度与可读性**：该PoC代码以PowerShell脚本形式提供，其编写风格清晰、易于理解。代码中所有变量命名都具有描述性，逻辑流直接且可预测。整个脚本没有使用任何形式的代码混淆技术，例如Base64编码、变异字符串、动态加载、或反射调用等，这使得安全分析人员无需进行复杂的逆向工程即可全面审查其功能。这种高度的透明性是评估低投毒风险的关键因素。
2.  **外部依赖与网络通信**：PoC代码的执行完全独立于外部网络或第三方服务。它不包含任何网络请求（如HTTP/HTTPS连接、DNS查询），不尝试从远程服务器下载任何额外组件或payload。所有操作都严格限制在本地文件系统和Windows注册表范围内，并且只调用操作系统内置的`msiexec.exe`进程。这种零外部依赖的特性极大地降低了恶意代码被悄悄注入或升级的风险，因为它无法通过网络动态获取恶意内容。
3.  **恶意行为与默认payload**：PoC的核心功能是演示权限提升，其默认预设的攻击payload是`whoami > C:\Windows\Temp\whoami.txt`。这是一个标准且无害的命令，其唯一目的是将当前执行上下文的用户身份写入一个临时文件，以此来验证漏洞利用是否成功以及所获得的权限级别。脚本中没有发现任何超出此目的的额外恶意功能，例如：数据窃取（如搜集敏感文件、凭证）、建立持久性后门、启动勒索软件加密流程、或者与命令与控制（C2）服务器进行通信。尽管攻击者可以通过修改`$Cmd`参数来插入任意恶意命令，但PoC本身提供的默认配置是完全安全的，仅用于功能验证。
4.  **标准库与函数使用**：PoC主要利用了PowerShell语言内置的标准功能和API。例如，文件系统操作（`Get-ChildItem`, `Out-File`, `Remove-Item`, `Test-Path`, `Set-ItemProperty`）和进程管理（`Start-Process`）都是PowerShell的合法且常用功能。代码中没有滥用任何不常见、已被标记为不安全或可能被滥用的低级API，进一步表明其设计意图是合法的漏洞演示，而非隐藏恶意行为。
5.  **目的明确性与免责声明**：PoC附带的`README.md`文件明确指出该项目旨在用于教育和安全研究目的，并包含明确的免责声明。代码行为与文档描述的目的高度一致，未发现任何与声明不符的隐藏功能。

综上所述，该PoC代码表现出高度的透明度、自包含性，且其默认行为是无害的。它是一个合法、专业且易于审计的安全研究工具，专注于演示特定漏洞的利用过程，不包含任何形式的额外恶意投毒行为。因此，在受控环境下对该PoC进行分析和测试，其自身的投毒风险极低。然而，任何PoC都可能被恶意分子篡改以包含恶意内容，因此在任何实际应用或测试之前，进行彻底的代码审查始终是最佳实践。

**项目地址:** 未在输入数据中提供

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2024-0670
