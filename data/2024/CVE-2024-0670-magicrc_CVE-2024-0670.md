## CVE-2024-0670 - CheckMK Agent (Windows) 权限提升 (Local Privilege Escalation)

**漏洞编号:** CVE-2024-0670

**漏洞类型:** 权限提升 (Local Privilege Escalation)

**影响应用:** CheckMK Agent (Windows)

**危害等级:** 高危 (High)

**CVSS评分:** N/A

**影响版本:** 未知 (Unknown)

**利用条件:** 需要本地访问权限 (Local Access Required)

**POC 可用性:** 9/10

**POC 类型:** 完整利用 (Full Exploit)

**攻击复杂度:** 低 (Low)

**投毒风险:** 10%

## 详情

该PoC脚本 `CVE-2024-0670.ps1` 为Checkmk Agent在Windows系统上的本地权限提升漏洞CVE-2024-0670提供了一个完整且功能性的利用示例。脚本的有效性基于其对漏洞核心机制的精确模拟和利用。

**POC有效性分析:**
脚本首先执行重要的环境检查，包括验证当前用户对 `C:\Windows\Temp` 目录的读写权限，并通过查询注册表 (`HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Installer\UserData\S-1-5-18\Products\*\InstallProperties`) 查找已安装的Checkmk MSI包路径。任一检查失败，脚本将报错并退出，保证了PoC的健壮性。
漏洞利用的核心在于Checkmk Agent在执行特定操作（特别是MSI修复过程）时处理临时文件的方式。该Agent会尝试在 `C:\Windows\Temp` 目录创建并写入临时文件。脚本正是利用这一行为模式，在Agent尝试创建文件之前，预先在该目录中创建了大量文件名具有特定模式（`cmk_all_PID_COUNTER.cmd`）的命令脚本文件。每个预创建的 `.cmd` 文件都包含攻击者预设的命令，默认是 `whoami > C:\Windows\Temp\whoami.txt`，用于验证提权效果。
为确保这些预设的恶意文件不会被Checkmk Agent正常覆盖，脚本在创建这些 `.cmd` 文件后，会立即将其文件属性设置为只读。当脚本随后通过 `Start-Process "msiexec.exe" -ArgumentList "/fa `"$Installer`""` 命令强制触发Checkmk MSI包的修复操作时，Checkmk Agent开始其正常的修复流程，并在此过程中尝试创建临时文件。由于攻击者已在 `C:\Windows\Temp` 目录中预先放置了大量只读的 `.cmd` 文件，并且这些文件的命名模式与Checkmk Agent尝试创建的临时文件高度相似，Agent在尝试创建文件时会遇到只读障碍，从而无法成功写入。然而，漏洞的关键在于，尽管写入失败，Checkmk Agent却仍然以 `SYSTEM` 权限执行了这些只读的、由攻击者预设的 `.cmd` 文件。
脚本通过参数 `$MinPID`, `$MaxPID`, `$MaxCounter` 来控制预创建文件的数量和命名范围，极大地增加了与Checkmk Agent临时文件命名匹配成功的概率，从而确保漏洞的稳定触发。整个过程被自动化，用户只需执行脚本即可。通过执行 `whoami` 命令并将结果写入临时文件，PoC清晰地展示了攻击者可以从较低权限提升到 `SYSTEM` 权限。脚本的逻辑严谨，自动化程度高，充分验证了CVE-2024-0670的利用可行性。

**利用步骤:**
利用此PoC进行CVE-2024-0670的权限提升攻击，通常遵循以下步骤：
1. **目标确认:** 确保目标Windows系统已安装Checkmk Agent。
2. **PoC获取:** 将 `CVE-2024-0670.ps1` 脚本下载或传输到目标系统上。攻击者通常会以某种方式（例如通过钓鱼、Web漏洞或已有的初始访问权限）将脚本放置到目标机器上。
3. **权限检查:** 脚本在执行之初会自动检查当前用户是否对 `C:\Windows\Temp` 目录具有必要的读写权限。标准用户通常拥有此权限，使得漏洞在典型环境下具有较高可利用性。
4. **执行脚本:** 以当前低权限用户身份打开PowerShell控制台，导航至脚本所在目录，并执行该PoC脚本。
5. **命令定制 (可选):** 攻击者可以通过 `Cmd` 参数自定义想要以 `SYSTEM` 权限执行的任意Windows命令。例如，可以执行 `.\CVE-2024-0670.ps1 -Cmd "net user EvilUser EvilPass! /add && net localgroup Administrators EvilUser /add"` 来创建一个新的管理员账户。默认命令是 `whoami > C:\Windows\Temp\whoami.txt`，用于安全地验证提权成功。
6. **自动文件部署与触发:** 脚本会自动化执行以下关键操作：定位Checkmk Agent的MSI安装程序路径；在 `C:\Windows\Temp` 目录下创建大量内含攻击者指定命令的只读 `.cmd` 文件；使用 `msiexec.exe /fa "Path\To\CheckmkAgent.msi"` 命令触发Checkmk Agent的MSI修复机制。
7. **验证提权:** 脚本执行完毕后，检查 `C:\Windows\Temp` 目录。如果使用的是默认的 `whoami` 命令，应存在 `whoami.txt` 文件，其内容应显示为 `nt authority\system`，这表明命令以 `SYSTEM` 权限成功执行。如果使用了自定义命令，则验证该命令的效果。此利用过程相对直接，自动化程度高，主要利用了Windows操作系统本身的服务和文件系统特性，以及Checkmk Agent的特定行为模式。

**投毒风险分析:**
对于安全研究人员或防御团队而言，在使用此 `CVE-2024-0670.ps1` PoC脚本时，其自身的投毒风险被评估为**低**，具体为10%。这个评估主要基于对代码透明度、行为模式和外部依赖性的全面分析。
**代码透明度与可读性:** 该PoC脚本采用PowerShell编写，代码结构清晰、逻辑明确，没有使用任何形式的代码混淆或加密技术。这使得安全分析人员能够轻松阅读、理解脚本的每一步操作，从而完全掌握其功能。所有文件操作、注册表查询和进程启动都通过标准的PowerShell cmdlet完成。这种高度的透明性是评估低投毒风险的关键因素。
**默认行为的无害性:** 脚本在没有指定 `$Cmd` 参数时的默认行为是执行 `whoami > C:\Windows\Temp\whoami.txt`。这是一个标准的、无害的Windows命令，其唯一目的是将当前用户身份写入一个临时文件，以便验证权限提升是否成功。这个默认 payload 的选择表明了PoC作者旨在提供一个安全的测试工具。
**缺乏外部依赖和网络通信:** 脚本在执行过程中不依赖任何外部资源、库文件或远程服务器。它不尝试进行任何网络通信，所有操作都在本地系统上完成。这种自我包含的特性大大降低了通过PoC引入外部恶意组件的风险。
**用户可控的风险:** 脚本中唯一可能引入风险的点是 `$Cmd` 参数，它允许用户自定义要以 `SYSTEM` 权限执行的命令。如果使用者在此处输入了恶意、破坏性或具有持久化能力的命令，那么可能会对系统造成损害。然而，这并非PoC代码本身的恶意性，而是由于用户对参数的不当使用。因此，在使用PoC进行测试时，强烈建议仔细审查所有自定义命令，并在受控的、隔离的环境中进行测试，以避免意外的副作用。
**文件系统影响:** 脚本会在 `C:\Windows\Temp` 目录下创建大量的 `.cmd` 文件。这些文件是利用机制的一部分，用于在漏洞触发时被Checkmk Agent执行。它们本身不具备持续性的恶意载荷功能，除非 `$Cmd` 参数中包含了恶意且具有持久化能力的命令。测试完成后，这些临时文件可以被安全地删除。
**总结:** 综合来看，此PoC脚本作为一种防御性安全研究工具，其代码质量高、透明度强，并且默认行为无害，因此其投毒风险极低。主要的风险源于用户对 `$Cmd` 参数的误用，而非PoC代码本身内嵌的恶意功能。在遵循最佳实践（例如代码审查、隔离环境测试和理解自定义命令的含义）的前提下，该PoC可以安全地用于验证CVE-2024-0670漏洞。

**项目地址:** N/A

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2024-0670
