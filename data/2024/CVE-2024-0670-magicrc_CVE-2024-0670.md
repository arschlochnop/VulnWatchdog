## CVE-2024-0670 - CheckMK Agent 本地提权 (Local Privilege Escalation)

**漏洞编号:** CVE-2024-0670

**漏洞类型:** 本地提权 (Local Privilege Escalation)

**影响应用:** CheckMK Agent

**危害等级:** 高危

**CVSS评分:** 未提供

**影响版本:** 未提供

**利用条件:** 需要本地访问权限，目标系统需安装CheckMK Agent

**POC 可用性:** 9

**POC 类型:** 完整利用

**攻击复杂度:** 中

**投毒风险:** 10%

## 详情

CVE-2024-0670 是 CheckMK Agent 在 Windows 系统上存在的本地提权漏洞。该漏洞的根源在于 CheckMK Agent 在执行特定操作（例如 MSI 修复或重新配置）时，会在 C:\Windows\Temp 目录下创建并尝试执行临时文件。然而，如果攻击者能够预先在该目录下放置一个名称与 CheckMK Agent 预期临时文件名相同且设置为只读属性的恶意文件，CheckMK Agent 将无法覆盖该文件，但仍会以其自身权限（通常为 SYSTEM 权限）执行已存在的恶意文件。

**POC有效性分析**
提供的 PowerShell PoC (`CVE-2024-0670.ps1`) 精心设计，以自动化方式利用此漏洞。脚本首先验证当前用户对 `C:\Windows\Temp` 目录的读写权限，这是利用漏洞的前提条件。接着，它会查询 Windows 注册表，寻找 CheckMK Agent MSI 安装程序的路径。如果未能找到，脚本将终止。一旦找到安装程序，PoC 脚本的核心逻辑便开始执行：它会遍历一个预定义的 PID 范围（`$MinPID` 到 `$MaxPID`）和一个计数器范围（`$MaxCounter`），在 `C:\Windows\Temp` 目录下创建大量命名格式为 `cmk_all_PID_COUNTER.cmd` 的只读 `.cmd` 文件。每个 `.cmd` 文件都包含攻击者指定的命令（默认为 `whoami > C:\Windows\Temp\whoami.txt`）。之所以生成如此多的文件，是为了增加与 CheckMK Agent 随机或顺序生成临时文件名冲突的概率。最后，脚本通过 `msiexec.exe` 命令触发 CheckMK Agent 的修复流程 (`/fa "$Installer"`)。当 CheckMK Agent 启动并尝试创建并执行临时文件时，它将与攻击者预置的只读文件发生冲突，进而执行攻击者在 `.cmd` 文件中嵌入的命令，由于 CheckMK Agent 通常以 SYSTEM 权限运行，这将导致命令以 SYSTEM 权限执行，成功实现本地提权。脚本逻辑严谨，步骤清晰，符合漏洞原理，因此被认为是有效且可复现的完整利用 PoC。

**利用步骤**
1.  **环境准备**：确保目标 Windows 系统已安装 CheckMK Agent。攻击者需要对目标系统拥有本地登录或执行代码的权限。
2.  **获取 PoC**：从可靠来源获取 `CVE-2024-0670.ps1` 脚本。
3.  **自定义命令 (可选)**：根据需要，修改脚本中的 `$Cmd` 参数。默认命令 `whoami > C:\Windows\Temp\whoami.txt` 仅用于验证，实际攻击中可替换为任何恶意命令，例如创建新的管理员用户、执行反向 Shell 等。
4.  **执行 PoC**：在目标系统上以本地用户权限运行 PowerShell 脚本。例如：`.\CVE-2024-0670.ps1` 或者指定自定义命令：`.\CVE-2024-0670.ps1 -Cmd "net user eviluser evilpass /add && net localgroup administrators eviluser /add"
5.  **等待执行**：脚本将自动执行一系列操作：检查权限、查找 CheckMK MSI 安装包、在 `C:\Windows\Temp` 目录下创建数百甚至数千个只读 `.cmd` 文件，然后触发 `msiexec.exe` 命令来修复 CheckMK Agent。
6.  **验证提权**：一旦 CheckMK Agent 尝试创建临时文件并执行冲突的恶意 `.cmd` 文件，攻击者预设的命令就会以 `SYSTEM` 权限运行。如果使用默认 `whoami` 命令，可以在 `C:\Windows\Temp\whoami.txt` 文件中查看到 `nt authority\system` 的输出。如果执行了更复杂的恶意命令，攻击者可以根据命令的预期效果进行验证（例如，检查新的管理员账户是否创建成功）。

**投毒风险分析**
对提供的 `CVE-2024-0670.ps1` PoC 代码进行分析，评估其作为威胁情报或防御性研究工具时的潜在投毒风险。

*   **代码清晰度与可读性**：该 PoC 脚本使用 PowerShell 语言编写，代码结构清晰，逻辑流程直观，变量和函数命名符合常规，没有发现明显的混淆、加密或压缩代码的行为。关键操作如文件创建、注册表查询和进程启动都明确可见。这使得安全分析人员能够相对容易地审查其功能，降低了隐蔽恶意行为的可能性。
*   **外部依赖性**：脚本在其执行过程中不依赖任何外部网络资源，例如从远程服务器下载额外代码或文件。所有操作均在本地文件系统和注册表范围内进行，避免了从不可信源引入恶意内容或暴露敏感信息的风险。
*   **敏感函数使用**：脚本主要使用了 PowerShell 标准的文件系统操作命令 (`Get-ChildItem`, `Out-File`, `Remove-Item`, `Test-Path`, `Set-ItemProperty`)、注册表查询命令 (`Get-ItemProperty`) 以及进程启动命令 (`Start-Process`)。这些都是 PowerShell 环境中的常见和合法操作。脚本中没有发现滥用 `Invoke-Expression` 或 `eval` 等高风险动态执行函数的情况，也没有发现与命令和控制 (C2) 服务器通信、数据窃取或持久化机制相关的代码。
*   **默认行为的安全性**：脚本的默认 `Cmd` 参数设置为 `whoami > C:\Windows\Temp\whoami.txt`。这是一个标准的系统命令，用于验证当前执行用户，并将结果写入临时文件，对系统本身无害。这表明该 PoC 的设计初衷是用于验证漏洞的存在性，而非立即造成破坏或进行恶意活动。虽然攻击者可以修改此参数以执行任意恶意命令，但这种恶意行为属于漏洞利用的结果，而非 PoC 代码本身的投毒。
*   **结论**：综合以上分析，`CVE-2024-0670.ps1` PoC 代码的投毒风险被评估为**低**（10%）。代码透明，无外部依赖，无恶意混淆，默认行为安全。然而，任何 PoC 代码都应在受控的沙箱环境中进行测试，并且在实际使用前，必须由专业的安全人员对代码进行彻底审查，特别是如果需要修改其参数以执行自定义命令时，务必确保自定义命令的安全性。

**项目地址:** 未提供

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2024-0670
