## CVE-2024-0670 - CheckMK Agent (Windows) 本地权限提升 (LPE)

**漏洞编号:** CVE-2024-0670

**漏洞类型:** 本地权限提升 (LPE)

**影响应用:** CheckMK Agent (Windows)

**危害等级:** 高危：攻击者可通过预先放置恶意文件，并利用CheckMK Agent的漏洞，以SYSTEM权限执行任意代码，实现本地权限提升。

**CVSS评分:** 

**影响版本:** 未明确指定，请参考官方安全公告。

**利用条件:** 需要本地访问权限，且目标系统已安装CheckMK Agent。攻击者需要能在`C:\Windows\Temp`目录下创建文件。

**POC 可用性:** 9/10

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 10%

## 详情

该PoC针对CheckMK Agent在Windows系统上的本地权限提升漏洞CVE-2024-0670。漏洞核心在于CheckMK Agent在执行MSI安装程序修复操作时，会在`C:\Windows\Temp`目录下尝试创建并执行临时文件。攻击者可以利用这一行为，预先在该目录下创建与预期临时文件同名的恶意`.cmd`文件，并将其设置为只读属性。当CheckMK Agent尝试写入同名文件时，由于文件只读而无法覆盖，但其后续的执行逻辑并不会检查写入是否成功，从而仍然会尝试执行该已存在的恶意文件。由于MSI修复过程通常以`SYSTEM`权限运行，因此预置的恶意文件也将以`SYSTEM`权限被执行，从而实现本地权限提升。

PoC脚本`CVE-2024-0670.ps1`是一个功能完整的PowerShell脚本。它首先进行环境检查，确保对`C:\Windows\Temp`目录具有读写权限。接着，它通过查询Windows注册表定位已安装的CheckMK Agent MSI安装包路径。随后，脚本会根据预设的PID范围和计数器，在`C:\Windows\Temp`目录下批量创建数百甚至数千个名称类似于`cmk_all_PID_COUNTER.cmd`的恶意`.cmd`文件，并将用户指定的命令（默认为`whoami > C:\Windows\Temp\whoami.txt`）写入这些文件，最后将这些文件设置为只读。最后一步，脚本调用`msiexec.exe`以`/fa`参数（修复模式）启动CheckMK Agent的安装程序。在此修复过程中，CheckMK Agent将触发漏洞，执行预置的恶意`.cmd`文件，从而以`SYSTEM`权限运行 `$Cmd` 中的命令。

从代码逻辑来看，该PoC完全符合漏洞描述，并且实现细节清晰。它巧妙地利用了文件权限和程序执行流程的信任，在没有代码注入的情况下实现了权限提升。脚本的参数化设计也使得攻击者可以灵活替换执行的命令。因此，该PoC具有高度的有效性和复现性。

**利用步骤**:
1. 确保目标Windows系统已安装CheckMK Agent，并且攻击者已获得本地普通用户权限。
2. 将`CVE-2024-0670.ps1`脚本上传到目标系统。
3. 以普通用户身份执行PowerShell脚本，例如：`powershell.exe -ExecutionPolicy Bypass -File CVE-2024-0670.ps1`。
4. 可以通过修改`-Cmd`参数来执行自定义命令，例如：`powershell.exe -ExecutionPolicy Bypass -File CVE-2024-0670.ps1 -Cmd "net user attacker Password123! /add && net localgroup administrators attacker /add"` 以创建新的管理员用户。
5. 脚本执行后，如果利用成功，`-Cmd`参数指定的命令将以`SYSTEM`权限运行。在默认情况下，你会在`C:\Windows\Temp\whoami.txt`中看到`nt authority\system`的输出。

**投毒风险分析**:
该PoC脚本的投毒风险评估为低（10%）。主要原因如下：
*   **代码清晰可读**: 整个PowerShell脚本代码结构清晰，逻辑简单，没有经过混淆处理。每个步骤的目的都非常明确，易于安全研究人员审计。
*   **无外部依赖**: 脚本不依赖任何外部库、DLL或网络资源。所有操作都在本地完成，降低了引入第三方恶意代码的风险。
*   **可控的恶意载荷**: 脚本的核心“恶意”行为是执行`$Cmd`参数指定的命令。这个命令是完全由用户控制的，默认为一个无害的`whoami`命令。研究人员可以在测试前轻松审查或修改此命令，以确保其安全性。PoC的目的不是为了包含恶意载荷，而是演示漏洞的利用方式。
*   **标准库函数**: 脚本主要使用了标准的PowerShell cmdlet（如`Get-ChildItem`, `Out-File`, `Remove-Item`, `Get-ItemProperty`, `Where-Object`, `Select-Object`, `Test-Path`, `Set-ItemProperty`, `Start-Process`）和.NET方法（如`[System.IO.File]::WriteAllText`），这些都是Windows操作系统内置且被广泛使用的功能，本身不包含恶意成分。
*   **无隐藏行为**: 脚本没有执行任何未在代码中明确表示的隐藏操作，例如数据窃取、C2通信或持久化机制。
因此，只要使用者仔细审查`$Cmd`参数及其可能被修改后的内容，并确认脚本本身没有被篡改，就可以安全地用于防御性安全研究、漏洞复现和安全测试。脚本本身不含恶意代码，其风险在于其利用漏洞的能力，而非其代码本身附带的隐蔽恶意行为。

**项目地址:** https://github.com/vulnwatchdog/CVE-2024-0670

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2024-0670
