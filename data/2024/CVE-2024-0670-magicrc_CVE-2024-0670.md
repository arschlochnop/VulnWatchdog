## CVE-2024-0670 - CheckMK Agent (Windows) 本地权限提升 (LPE)

**漏洞编号:** CVE-2024-0670

**漏洞类型:** 本地权限提升 (LPE)

**影响应用:** CheckMK Agent (Windows)

**危害等级:** 高危 (High)

**CVSS评分:** 7.8 (CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H)

**影响版本:** Checkmk 2.1.0 (含) 及以上版本，Windows 代理程序

**利用条件:** 需要本地低权限账户访问权限，且目标系统安装了受影响的 CheckMK Agent。

**POC 可用性:** 9/10

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 5%

## 详情

POC有效性分析：该POC脚本（CVE-2024-0670.ps1）针对CheckMK Agent在Windows环境下处理临时文件时的逻辑漏洞进行了深度实现。漏洞核心在于CheckMK Agent在执行任务时，会在C:\Windows\Temp目录下创建并执行以特定模式命名的.cmd临时文件。由于该目录对普通用户具有写权限，攻击者可以预先创建大量符合命名模式的文件（如cmk_all_*.cmd），并通过PowerShell的Set-ItemProperty将其属性设为‘只读’。当CheckMK安装程序或代理程序尝试写入同名文件时，由于NTFS文件权限限制导致写入失败，但程序逻辑中存在缺陷，未能正确处理写入异常或未校验文件完整性，导致系统仍然以SYSTEM权限执行了攻击者预置的只读恶意脚本。POC代码展示了极高的有效性：它首先验证了临时目录的读写权限，接着通过注册表HKEY_LOCAL_MACHINE路径自动定位CheckMK的MSI安装包路径。随后，它通过嵌套循环生成了大量带有PID和计数标识的占位文件，以覆盖所有可能的随机文件名组合。最后，利用msiexec.exe触发修复模式（/fa），强制代理程序逻辑介入，从而触发文件执行。此利用链条完整且自动化程度高，在未修复的环境下复现率极高。利用步骤：1. 攻击者获取Windows系统的普通用户Shell；2. 运行PowerShell脚本，指定待执行的命令（默认whoami并输出至txt）；3. 脚本自动检测CheckMK安装包位置并生成数千个只读.cmd文件到临时目录；4. 脚本调用msiexec触发CheckMK逻辑；5. 系统以SYSTEM权限执行预置脚本，完成提权。投毒风险分析：经过对提供的PowerShell源代码进行逐行安全审计，未发现明显的恶意混淆、加密Payload或外部C2连接行为。脚本的主要逻辑集中在本地文件系统操作（New-Item, Set-ItemProperty）和本地注册表查询。投毒风险极低，仅为5%左右。脚本中定义的$Cmd变量默认为本地信息收集命令（whoami > C:\Windows\Temp\whoami.txt），这是典型的安全研究用途。唯一需要警惕的是脚本会向系统临时目录写入大量（数千个）小文件，这可能导致磁盘I/O短时间上升，但在防御性研究场景下属于正常消耗。代码中使用的[System.IO.File]::WriteAllText和ASCII编码处理方式透明清晰，无后门植入迹象。该POC属于高质量、纯净的漏洞验证脚本，适合威胁情报团队用于建立EDR检测规则（如监控C:\Windows\Temp下的只读.cmd文件生成及SYSTEM权限进程调用）。

**项目地址:** [https://nvd.nist.gov/vuln/detail/CVE-2024-0670](https://nvd.nist.gov/vuln/detail/CVE-2024-0670)

**漏洞详情:** [https://nvd.nist.gov/vuln/detail/CVE-2024-0670](https://nvd.nist.gov/vuln/detail/CVE-2024-0670)
