## CVE-2024-45496 - OpenShift Container Platform 命令注入/远程代码执行(RCE)

**漏洞编号:** CVE-2024-45496

**漏洞类型:** 命令注入/远程代码执行(RCE)

**影响应用:** OpenShift Container Platform

**危害等级:** 严重 (Critical)

**CVSS评分:** 9.9

**影响版本:** 未知 (未明确指定)

**利用条件:** 需要开发者级别访问权限、能够创建Kubernetes Secret和BuildConfig。

**POC 可用性:** 9/10

**POC 类型:** 完整利用

**攻击复杂度:** 中

**投毒风险:** 0%

## 详情

CVE-2024-45496被确认为OpenShift Container Platform中的一个严重安全漏洞，CVSS评分为9.9，表明其影响程度极高。此漏洞允许具有开发者级别访问权限的攻击者，通过精心构造的`.gitconfig`文件，在OpenShift的构建过程中注入恶意代码，从而在工作节点上实现任意命令执行。该缺陷源于OpenShift容器平台构建过程中特权升级的误用。在构建初始化步骤中，`git-clone`容器以特权安全上下文运行。这种特权执行结合攻击者注入恶意Git配置的能力，使得攻击者能够直接在底层宿主机系统上执行任意命令，将开发者的构建权限升级为对集群工作节点的远程代码执行能力。

**POC有效性分析与利用步骤:**
所提供的POC代码是一个完整且高度有效的利用方案，它清晰地演示了如何触发和利用CVE-2024-45496。该POC的文档非常详尽，提供了分步的指令和必要的代码片段，使得漏洞复现和理解其工作原理变得直观且易于实施。其利用过程可总结为以下步骤：

1.  **准备阶段：克隆POC仓库。** 攻击者首先克隆包含必要文件的GitHub仓库。该仓库中包含一个 `Dockerfile` 和一个 `.gitattributes` 文件。关键在于 `.gitattributes` 文件，它将 `Dockerfile` 映射到一个名为 "dockerfile" 的自定义 Git 过滤器。这个映射是触发漏洞的关键机制。

2.  **构造恶意Git配置：** 攻击者创建一个恶意 `.gitconfig` 文件。此文件包含一个 `[filter "dockerfile"]` 部分，并在其中定义了 `smudge` 命令。`smudge` 命令是Git在检出（checkout）文件时执行的脚本。在此POC中，`smudge` 命令承载了实际的恶意载荷。当Git处理被 `.gitattributes` 标记为 "dockerfile" 类型的文件（即 `Dockerfile`）时，这个 `smudge` 命令就会被执行。

3.  **恶意载荷的执行：** `smudge` 命令中的载荷是利用漏洞的核心。它执行以下一系列操作以实现对宿主机的持久化访问和远程代码执行：
    *   **挂载宿主机文件系统：** 载荷首先尝试将宿主机的磁盘分区（例如 `/dev/vda4`）挂载到构建容器内的某个路径（例如 `/mnt/h`）。这赋予了容器对宿主机文件系统的读写能力，是后续操作的基础。
    *   **生成SSH密钥对：** 在容器内生成一个新的SSH Ed25519 密钥对，包括一个公钥和一个私钥。
    *   **注入公钥：** 将生成的公钥追加到宿主机上某个特权用户（例如 `core` 用户）的 `~/.ssh/authorized_keys` 文件中。通过挂载的 `/mnt/h` 路径，可以访问到宿主机的实际文件系统路径（例如 `/mnt/h/ostree/deploy/fedora-coreos/var/home/core/.ssh/authorized_keys`）。这一步为攻击者建立了持久的SSH后门访问。
    *   **提取私钥：** 更巧妙的是，载荷将生成的SSH私钥的每一行都嵌入到正在被检出的 `Dockerfile` 内容中，格式为 `RUN echo '<private_key_line>'`。这意味着在后续的镜像构建过程中，私钥内容将作为构建日志的一部分输出。

4.  **创建Kubernetes Secret：** 攻击者将恶意 `.gitconfig` 文件作为Kubernetes Secret（例如 `malicious-secret`）创建到OpenShift集群中。

5.  **定义恶意BuildConfig：** 攻击者创建一个 `BuildConfig` YAML文件。该 `BuildConfig` 定义了一个使用Docker策略的构建，指向攻击者控制的Git仓库，并且关键之处在于，它通过 `sourceSecret` 字段引用了之前创建的 `malicious-secret`。这个 `sourceSecret` 会将恶意的 `.gitconfig` 文件注入到 `git-clone` 容器中，使其在Git克隆操作期间生效。

6.  **启动构建并提取私钥：** 当攻击者应用这个 `BuildConfig` 并启动构建（例如使用 `oc start-build malicious-buildconfig --follow` 命令）时，以下关键事件将发生：
    *   `git-clone` 容器在特权安全上下文下运行，开始克隆Git仓库。
    *   Git在检出文件时读取 `.gitattributes`，发现 `Dockerfile` 需要经过 "dockerfile" 过滤器处理。
    *   Git执行恶意 `.gitconfig` 中定义的 `smudge` 命令。
    *   `smudge` 命令在特权容器内成功执行，挂载宿主机，注入SSH公钥，并修改 `Dockerfile` 内容以包含私钥。
    *   由于攻击者正在跟随构建日志，他们可以直接从日志输出中提取完整的SSH私钥。

7.  **结果：** 一旦获得SSH私钥，攻击者便可以通过SSH登录到受影响的OpenShift worker节点，获得根级别 shell 访问权限，从而实现彻底的远程代码执行和权限提升。整个利用过程清晰、自动化程度高，并且利用了OpenShift构建机制中的关键特权点，使得POC非常具有说服力。

**投毒风险分析:**
在评估此CVE的POC代码时，我们必须区分POC本身旨在演示的漏洞利用行为与POC代码中可能存在的额外、恶意或隐藏的投毒行为。就CVE-2024-45496的POC而言，其投毒风险被评估为**0% (低风险)**。

主要原因在于该POC的透明度和目的性明确。POC的核心“恶意”部分——即通过`smudge`过滤器注入SSH公钥并提取私钥——是漏洞利用的*直接结果*，而非POC代码中隐藏的额外恶意功能。`readme.md`文件详细解释了其工作原理、恶意载荷内容以及预期结果，使得任何安全研究人员都能清晰地理解代码的意图。

具体来说：
*   **代码透明性：** POC中提供的`Dockerfile`非常简单，仅用于演示输出。`config.txt`也只是一个简单的命令示例，并未参与核心漏洞利用。真正的攻击载荷以明文形式显示在`.gitconfig`示例中，并且在`readme.md`中逐行解释。没有代码混淆、加密或尝试隐藏其功能。
*   **无额外恶意组件：** POC不包含任何指向外部、未知或可疑域名的网络请求。它不下载额外的二进制文件或脚本，也不尝试在目标系统上安装非预期的持久化机制（除了其利用行为本身旨在实现的SSH后门）。
*   **专注于漏洞演示：** POC的整个结构和内容都紧密围绕CVE-2024-45496的漏洞利用机制展开。它没有包含任何与演示漏洞无关的、旨在窃取数据、安装勒索软件或其他恶意行为的代码。
*   **可审核性：** 鉴于POC的简洁性和清晰的文档，其所有操作都易于被安全研究人员审核和验证。这意味着研究人员可以放心地分析代码，而无需担心代码中存在额外的、旨在感染研究人员系统的恶意功能。

综上所述，虽然POC演示了高度危险的漏洞利用行为（远程代码执行和权限提升），但其自身的实现方式是“干净”且无害的，旨在教育和演示，而非对研究人员或其环境造成额外威胁。因此，将此POC代码本身视为存在投毒风险是不准确的。

**项目地址:** https://github.com/pwnc4t/cve-2024-45496.git

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2024-45496
