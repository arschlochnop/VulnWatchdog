## CVE-2019-11043 - PHP-FPM RCE

**漏洞编号:** CVE-2019-11043

**漏洞类型:** RCE

**影响应用:** PHP-FPM

**危害等级:** Critical

**CVSS评分:** 9.8

**影响版本:** PHP 7.1.x below 7.1.33, 7.2.x below 7.2.24 and 7.3.x below 7.3.11

**利用条件:** Nginx + PHP-FPM配置，开启fastcgi_split_path_info，且PATH_INFO为空

**POC 可用性:** 7/10

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 10%

## 详情

CVE-2019-11043是一个存在于PHP-FPM中的远程代码执行（RCE）漏洞。当Nginx与PHP-FPM结合使用，并且配置中包含`fastcgi_split_path_info`指令时，如果PATH_INFO为空，则可能触发该漏洞。此漏洞源于Nginx在处理包含`%0a`（换行符）的请求时，会导致`PATH_INFO`变量为空。PHP-FPM在处理空的`PATH_INFO`时存在缺陷，攻击者可以通过构造特定的请求来利用这个缺陷，从而在服务器上执行任意代码。

**POC有效性分析：**
提供的POC代码（`phuip-fpizdam`）利用了FastCGI协议的内部优化，该优化只在PHP7中存在，因此该POC在PHP7环境下有效。该POC通过发送特制的HTTP请求来触发漏洞。请求中包含特定的`%0a`字符，导致`PATH_INFO`为空，进而触发PHP-FPM中的缺陷。成功利用后，攻击者可以在服务器上执行任意命令。
根据POC的README描述，复现此漏洞需要搭建一个包含Nginx和PHP-FPM的环境。Nginx的配置需要包含易受攻击的`fastcgi_split_path_info`指令。PHP-FPM的版本需要在受影响的范围内 (PHP 7.1.x below 7.1.33, 7.2.x below 7.2.24 and 7.3.x below 7.3.11)。
README中给出了详细的配置步骤，包括PHP的安装、配置和Nginx的配置。此外，还需要安装Go语言环境来编译和运行POC代码。成功编译和运行POC后，可以通过向目标服务器发送HTTP请求来验证漏洞是否存在。如果漏洞存在，POC将能够执行指定的命令。
文档提到配置环境验证失败，但是代码的逻辑和公开信息表明该POC是有效的，给7分。

**利用步骤：**
1. 搭建存在漏洞的Nginx + PHP-FPM环境（PHP版本在受影响范围内）。
2. 确保Nginx配置包含`fastcgi_split_path_info`指令。
3. 安装Go语言环境。
4. 下载并编译POC代码（`phuip-fpizdam`）。
5. 运行POC，指定目标服务器的URL，例如：`./phuip-fpizdam http://website.com/index.php?a=command`。
6. POC将发送特制的HTTP请求来触发漏洞，并在服务器上执行指定的命令。

**投毒风险分析：**
该POC主要通过发送特制的HTTP请求来利用漏洞，其核心是构造特定的请求，利用了`fastcgi_split_path_info`指令处理换行符的缺陷以及PHP-FPM对空`PATH_INFO`的处理缺陷。直接的POC代码本身主要用于漏洞验证和利用，不包含恶意代码。主要的风险点在于，如果攻击者修改了POC代码，在利用漏洞执行命令时，可以植入恶意代码或后门。

由于POC代码主要依赖于标准库，且逻辑较为清晰，因此直接投毒的风险较低。然而，攻击者可能会在利用漏洞执行命令时，注入恶意代码。例如，攻击者可以使用POC执行`wget`或`curl`命令，从外部服务器下载并执行恶意脚本。此外，攻击者还可能使用POC来修改服务器上的配置文件，例如`.htaccess`文件，从而实现持久化控制。

考虑到以上风险，该漏洞的投毒风险评定为10%。尽管POC本身不包含恶意代码，但攻击者可以利用该漏洞执行任意命令，从而植入恶意代码或进行其他恶意活动。

**项目地址:** https://github.com/neex/phuip-fpizdam

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2019-11043
