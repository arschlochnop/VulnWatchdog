## CVE-2019-11043 - PHP-FPM Remote Code Execution (RCE)

**漏洞编号:** CVE-2019-11043

**漏洞类型:** Remote Code Execution (RCE)

**影响应用:** PHP-FPM

**危害等级:** Critical

**CVSS评分:** 9.8

**影响版本:** PHP versions 7.1.x below 7.1.33, 7.2.x below 7.2.24 and 7.3.x below 7.3.11

**利用条件:** Requires specific Nginx configurations and network access to the PHP-FPM service.

**POC 可用性:** 8/10

**POC 类型:** Complete exploit

**攻击复杂度:** Low

**投毒风险:** 10%

## 详情

CVE-2019-11043 is a critical remote code execution vulnerability affecting PHP-FPM when used with certain Nginx configurations. The vulnerability stems from an incorrect handling of newline characters (%0a) in the request URI, leading to buffer overflows in the FPM module. This allows attackers to inject and execute arbitrary code on the server. The provided Python POC, CVE-2019-11043-POC.py, effectively demonstrates the vulnerability. It works by sending a series of HTTP requests with crafted URIs containing newline characters and long query strings. The script iterates through different lengths of the 'K' parameter, attempting to trigger a 502 Bad Gateway error, which indicates successful exploitation. The core of the exploit lies in the interaction between Nginx and PHP-FPM. When Nginx is configured to pass requests to PHP-FPM, it uses the FastCGI protocol. The vulnerability arises because of how PHP-FPM handles the request URI when newline characters are present. A misconfiguration allows the newline characters to be passed through, leading to an incorrect calculation of buffer sizes. This leads to FPM writing past allocated buffers into the space reserved for FCGI protocol data. Successful exploitation allows attackers to execute arbitrary code with the privileges of the PHP-FPM process, potentially compromising the entire system. The provided POC automates the process of identifying vulnerable servers by repeatedly sending specially crafted requests and observing the response codes. If a 502 error is triggered, the script confirms the presence of the vulnerability. To successfully use the POC, the target URL must include a .php file, for example, http://192.168.1.37:8080/index.php. The script sends requests with varying lengths of the 'K' parameter in the query string to overflow the buffer. If successful, the server responds with a 502 error.

The投毒风险分析：The provided POC is relatively benign, primarily designed to test for the presence of the vulnerability. The Python script primarily utilizes standard libraries like `requests` and `sys`. The script sends HTTP requests with potentially long query strings to trigger a 502 error. While the intent is to trigger a buffer overflow, the script itself does not attempt to upload malicious files, execute arbitrary commands directly, or modify system configurations. The risk of the POC being maliciously modified to include harmful code is relatively low. However, it is essential to ensure the integrity of the downloaded script. The .ini file provides a method for executing the Python script using Ladon, which may have its own inherent risks, but the Python code itself has no malicious behavior. The script only uses standard libraries and focuses on triggering a server-side error. Furthermore, the source code is relatively clear and lacks obfuscation, reducing the risk of hidden malicious functionality. Therefore, the poisoning risk is estimated to be low.

**项目地址:** https://github.com/k8gege/CVE-2019-11043

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2019-11043
