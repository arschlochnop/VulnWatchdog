## CVE-2019-11043 - PHP-FPM RCE

**漏洞编号:** CVE-2019-11043

**漏洞类型:** RCE

**影响应用:** PHP-FPM

**危害等级:** Critical

**CVSS评分:** 9.8

**影响版本:** PHP 7.1.x < 7.1.33, 7.2.x < 7.2.24, 7.3.x < 7.3.11

**利用条件:** Specific FPM configurations are vulnerable. Requires network access to the vulnerable server.

**POC 可用性:** 7/10

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 10%

## 详情

CVE-2019-11043 漏洞存在于 PHP 7.1.x 低于 7.1.33 版本、7.2.x 低于 7.2.24 版本和 7.3.x 低于 7.3.11 版本的特定 FPM 配置中。该漏洞允许攻击者通过操纵请求，使 FPM 模块将数据写入超出已分配缓冲区的空间，从而覆盖为 FCGI 协议数据保留的空间，进而实现远程代码执行。该漏洞的产生是由于 FPM 在处理畸形请求时，对请求头的长度验证不充分，导致缓冲区溢出。

POC 代码分析:
POC 代码是一个 Python 脚本，它首先通过发送带有不同长度 'Q' 字符的 GET 请求来查找潜在的易受攻击的长度。脚本检查 HTTP 状态码是否大于或等于 500，如果是，则将该长度添加到 `vuln_lengths` 列表中。然后，脚本创建一个包含几个潜在漏洞长度的列表 `vuln_list`。对于 `vuln_list` 中的每个长度，脚本进入一个 while 循环，该循环会递增 header_length 并发送两个 GET 请求：一个带有 'P' 字符，另一个带有 'C' 字符。这两个请求都尝试设置 `session.auto_start` PHP 配置指令。脚本检查响应头中是否存在 `Set-Cookie` 和 `PHPSESSID`，如果存在，则它会打印一个 curl 命令，该命令可用于利用该漏洞。

利用步骤:
1. 确定目标服务器上运行的 PHP 版本以及 FPM 配置。
2. 运行 POC 脚本来识别易受攻击的 URL 长度。该脚本会尝试不同的长度，直到找到一个导致服务器返回 500 错误的长度为止。
3. 使用脚本生成的 curl 命令来利用该漏洞。该命令将发送一个特制的 GET 请求，该请求将覆盖 FPM 模块中的内存，并允许攻击者执行任意代码。

POC 有效性分析：
POC 代码相对有效，因为它能够自动检测易受攻击的长度并生成可用于利用该漏洞的 curl 命令。但是，该 POC 依赖于特定的 FPM 配置才能成功利用该漏洞。此外，该 POC 可能会导致目标服务器崩溃。

投毒风险分析:
该 POC 脚本主要使用 `requests` 库，没有明显的恶意行为。它旨在发现和利用漏洞，而不是进行恶意活动。该脚本的目的是验证漏洞是否存在，并提供利用该漏洞的方法，并为安全研究人员和系统管理员提供修复漏洞的机会。尽管该脚本本身不包含恶意代码，但如果攻击者使用它来攻击未打补丁的系统，则可能造成损害。该漏洞允许远程代码执行，因此攻击者可以安装恶意软件、窃取数据或破坏系统。由于利用需要特定的 FPM 配置，且代码本身相对清晰，因此投毒风险较低，约为10%。

**项目地址:** https://github.com/vulhub/vulhub/blob/master/php/CVE-2019-11043/README.md

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2019-11043
