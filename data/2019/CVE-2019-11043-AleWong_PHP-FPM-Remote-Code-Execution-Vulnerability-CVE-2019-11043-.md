## CVE-2019-11043 - PHP-FPM RCE

**漏洞编号:** CVE-2019-11043

**漏洞类型:** RCE

**影响应用:** PHP-FPM

**危害等级:** Critical

**CVSS评分:** 9.8

**影响版本:** PHP 7.1.x < 7.1.33, 7.2.x < 7.2.24 and 7.3.x < 7.3.11

**利用条件:** Nginx + PHP-FPM, specific configuration required, network access

**POC 可用性:** 9/10

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 10%

## 详情

CVE-2019-11043是PHP-FPM的一个远程代码执行漏洞，当Nginx作为反向代理服务器，并将请求转发给PHP-FPM时，如果Nginx的配置不当（例如使用了错误的fastcgi_split_path_info），攻击者可以通过构造特殊的请求，利用PHP-FPM处理PATH_INFO时的缺陷，实现在服务器上执行任意代码。具体来说，Nginx上fastcgi split path info 在处理带有%0a的请求时,会因为遇到换行符\n导致PATH INFO为空。而php-fpm在处理PATH INFO为空的情况下，存在逻辑缺陷。攻击者通过精心的构造和利用，可以导致远程代码执行。

POC有效性分析：
提供的POC代码是一个Python脚本，用于检测目标服务器是否存在CVE-2019-11043漏洞。该脚本首先检查目标服务器是否运行PHP和Nginx，然后通过发送带有特殊构造的URL的HTTP请求，来触发该漏洞。如果服务器返回502错误，则表示该服务器可能存在漏洞。该POC通过循环改变URL中的'Q'的数量，并发送请求，如果返回502，则输出可能存在漏洞的QSL（Query String Length）。

利用步骤：
1. 确定目标服务器的URL。
2. 运行POC脚本，指定目标URL作为参数。
3. 观察脚本的输出，如果脚本报告找到了可能存在漏洞的QSL，则表示目标服务器可能存在CVE-2019-11043漏洞。
4. 利用phuip-fpizdam工具或类似的利用工具，使用找到的QSL来执行任意代码。

更详细的步骤如下：
a) 确认目标使用了存在漏洞的Nginx + PHP-FPM配置，通常是使用了类似`fastcgi_split_path_info`的配置，并且没有正确处理PATH_INFO。
b) 使用POC脚本或`phuip-fpizdam`工具，发送精心构造的HTTP请求。请求包含`%0a`（换行符）以及特定长度的查询字符串，目的是触发PHP-FPM的缓冲区溢出。
c) 如果漏洞存在，PHP-FPM进程可能会崩溃，或者允许攻击者覆盖某些内存区域。
d) 攻击者可以进一步利用此漏洞，通过覆盖内存中的特定值，来执行任意代码。这通常需要对PHP-FPM的内部机制有深入的了解。

投毒风险分析：
该POC代码主要用于漏洞检测，其本身不包含恶意代码或后门，因此投毒风险较低。但是，如果攻击者修改了该POC代码，使其在检测漏洞的同时，还在目标服务器上执行恶意代码，那么投毒风险就会大大增加。例如，攻击者可以在POC代码中添加代码，用于上传恶意文件、修改系统配置、或窃取敏感数据。此外，如果攻击者将该POC代码与其他恶意软件捆绑在一起，那么用户在运行该POC代码时，也会面临被感染的风险。此POC使用requests标准库，代码逻辑清晰，风险较低。该POC唯一的可疑之处在于User-Agent，D-Pisos，Ebut的Header设置，存在一定的探测痕迹，但总体投毒风险较低，评估为10%。

**项目地址:** https://github.com/AleWong/CVE-2019-11043

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2019-11043
