## CVE-2019-11043 - PHP-FPM Remote Code Execution (RCE)

**漏洞编号:** CVE-2019-11043

**漏洞类型:** Remote Code Execution (RCE)

**影响应用:** PHP-FPM

**危害等级:** Critical

**CVSS评分:** 9.8

**影响版本:** PHP versions 7.1.x below 7.1.33, 7.2.x below 7.2.24 and 7.3.x below 7.3.11

**利用条件:** Requires specific FPM setup configuration. Network access to the vulnerable PHP-FPM instance.

**POC 可用性:** 9/10

**POC 类型:** Complete exploit

**攻击复杂度:** Low

**投毒风险:** 10%

## 详情

CVE-2019-11043 is a remote code execution vulnerability affecting PHP-FPM. It stems from a buffer overflow in certain configurations where the FPM module writes past allocated buffers into the space reserved for FCGI protocol data. This allows an attacker to execute arbitrary code on the server. 

The provided Proof-of-Concept (POC) code consists of a Dockerfile, a Readme, Nginx configuration, a PHP file, and a shell script. The Dockerfile sets up a vulnerable PHP-FPM environment using PHP version 7.3.9 and Nginx version 1.16.1. The Readme provides instructions on how to run the Docker image and exploit the vulnerability. It references an external exploit available at `https://github.com/neex/phuip-fpizdam`. The Nginx configuration defines a server block that listens on port 80 and forwards PHP requests to the PHP-FPM server running on 127.0.0.1:9000. The PHP file simply outputs the number 1. The shell script starts the PHP-FPM server and Nginx.

To validate the POC, the provided steps in the Readme should be followed. First, the Docker image is run, exposing port 8080. Then, the `phuip-fpizdam` exploit is built. Finally, the exploit is executed against the running application, which should result in successful remote code execution. The Readme demonstrates successful command execution by using `curl` to execute the `which which` command on the server. The exploit works by manipulating the query string to cause a buffer overflow in PHP-FPM, allowing the attacker to inject and execute arbitrary code.

The vulnerability can be triggered by crafting a specific URL with a long query string which causes the buffer overflow in PHP-FPM. The `fastcgi_split_path_info` directive in the Nginx configuration plays a crucial role in triggering the vulnerability. The exploit leverages the way PHP-FPM processes the PATH_INFO variable.

The provided POC is of high quality, as it includes a complete working exploit, clear instructions, and all necessary files to reproduce the vulnerability.

**投毒风险分析:**

虽然提供的docker image和POC本身是为了演示漏洞利用，但是仍然存在一定的投毒风险。Dockerfile 中直接使用 `apt update && apt install -y libargon2-0 libedit-dev libcurl4-openssl-dev` 可能会引入未知的软件包依赖风险。 Starter.sh 启动php-fpm 和 nginx服务，可能被替换成恶意程序。由于该POC 主要目的是为了复现漏洞，代码本身可读性较强，且主要依赖github.com/neex/phuip-fpizdam 这个已知的漏洞利用工具，直接恶意投毒的可能性较低。 考虑到利用该漏洞可以执行任意代码，攻击者可能会在成功利用后植入后门或恶意软件，所以需要防范被利用后进行进一步的恶意行为。 总体来说，投毒风险较低，约为10%。

**项目地址:** https://github.com/neex/phuip-fpizdam

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2019-11043
