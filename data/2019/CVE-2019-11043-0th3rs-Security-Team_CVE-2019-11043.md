## CVE-2019-11043 - PHP-FPM 远程代码执行

**漏洞编号:** CVE-2019-11043

**漏洞类型:** 远程代码执行

**影响应用:** PHP-FPM

**危害等级:** 严重

**CVSS评分:** 9.8

**影响版本:** 7.1.x below 7.1.33, 7.2.x below 7.2.24 and 7.3.x below 7.3.11

**利用条件:** 需要特定的FPM配置，允许通过精心构造的请求导致缓冲区溢出。

**POC 可用性:** 9/10

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 10%

## 详情

CVE-2019-11043是一个存在于PHP-FPM中的远程代码执行漏洞。具体来说，在PHP 7.1.x低于7.1.33、7.2.x低于7.2.24和7.3.x低于7.3.11版本中，当FPM配置不当时，攻击者可以通过发送特制的请求，导致FPM模块将数据写入超出分配的缓冲区，覆盖FCGI协议数据，最终实现远程代码执行。该漏洞的根源在于PHP-FPM在处理PATH_INFO时，由于计算错误导致缓冲区溢出。攻击者可以通过操纵请求中的PATH_INFO长度来触发此漏洞。该POC代码通过精心构造HTTP请求中的query长度和Header头字段长度来爆破并利用该漏洞，进而控制服务器。首先，脚本判断目标是否存在漏洞，然后判断目标php worker进程数实现健壮性，最后全worker进程污染。利用过程如下：首先发送一个包含特定PHP配置选项的HTTP请求，这些选项旨在修改PHP的运行时行为，如开启`session.auto_start`，设置错误报告级别和日志记录等。接下来，通过发送大量的’Q’字符作为查询字符串的一部分，以及调整HTTP头部`D-Gisos`的长度，来触发缓冲区溢出。成功利用该漏洞后，攻击者可以在目标服务器上执行任意代码。这个POC的有效性很高，因为它能够在特定条件下稳定地触发漏洞并执行代码，在测试环境中，该POC能够可靠地实现远程代码执行。利用步骤：1. 确保目标系统运行着受影响的PHP-FPM版本，并且配置符合漏洞利用的要求。2. 运行POC脚本，并提供目标URL作为参数。3. 脚本会自动检测目标是否存在漏洞，并尝试利用该漏洞。4. 如果利用成功，攻击者就可以在目标服务器上执行任意代码。投毒风险分析：该POC的投毒风险较低，因为它主要依赖于PHP的内置功能和配置选项，没有包含任何恶意代码或外部脚本。唯一潜在的风险是，如果攻击者在利用该漏洞后植入恶意后门程序，那么系统就会受到威胁。由于该POC没有混淆代码，且未使用eval等高危函数，仅仅依赖于标准库和网络请求，因此判定投毒风险为10%。

**项目地址:** https://github.com/0th3rs/CVE-2019-11043

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2019-11043
