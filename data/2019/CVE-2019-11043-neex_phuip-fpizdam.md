## CVE-2019-11043 - PHP-FPM RCE

**漏洞编号:** CVE-2019-11043

**漏洞类型:** RCE

**影响应用:** PHP-FPM

**危害等级:** Critical

**CVSS评分:** 9.8

**影响版本:** PHP 7.1.x < 7.1.33, 7.2.x < 7.2.24, 7.3.x < 7.3.11

**利用条件:** Nginx + PHP-FPM配置，需要特定的nginx配置，允许空PATH_INFO

**POC 可用性:** 9/10

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 10%

## 详情

CVE-2019-11043 漏洞是 PHP-FPM 中的一个远程代码执行（RCE）漏洞。该漏洞存在于 PHP 7.1.x 版本低于 7.1.33、7.2.x 版本低于 7.2.24 和 7.3.x 版本低于 7.3.11 中。当 PHP-FPM 以特定的配置运行时，攻击者可以利用此漏洞覆盖 FPM 模块分配的缓冲区，从而在服务器上执行任意代码。该漏洞的产生原因是 PHP-FPM 在处理 PATH_INFO 时存在缺陷，攻击者可以通过构造特殊的请求，使 FPM 模块将数据写入到为 FCGI 协议数据保留的空间之外。如果 Nginx 和 PHP-FPM 配合使用，并且 Nginx 的配置允许将请求转发到 PHP-FPM 而不进行适当的验证，那么攻击者就可以通过发送特制的 HTTP 请求来触发此漏洞。利用该漏洞需要满足以下条件：1. Web 服务器运行的是 Nginx + PHP-FPM。2. Nginx 的配置中存在类似于 `location ~ [^/]\.php(/|$)` 的配置，并且将匹配的请求转发到 PHP-FPM。3. Nginx 的配置中必须存在 `fastcgi_param PATH_INFO $fastcgi_path_info;` 这样的语句，用于设置 PATH_INFO 变量。同时，SCRIPT_FILENAME 也必须使用 `fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;` 进行设置。4. 必须有一种方法可以将 PATH_INFO 设置为空值。该漏洞的利用方式是尝试使用换行符来破坏 `fastcgi_split_path_info` 指令中的正则表达式。5. Nginx 的配置中不能存在文件存在性检查，例如 `try_files $uri =404` 或 `if (-f $uri)`。如果 Nginx 在将请求转发到 FastCGI 之前就丢弃了对不存在脚本的请求，那么攻击者的请求将无法到达 PHP-FPM。6. 此漏洞仅适用于 PHP 7+，但该漏洞本身存在于早期版本中。 

POC有效性分析：该POC（PHuiP-FPizdaM）是一个针对 CVE-2019-11043 漏洞的完整利用程序。它使用 Go 语言编写，可以快速方便地测试目标是否存在漏洞。该 POC 已经过验证，可以在满足上述利用条件的系统上成功执行。POC 的作者提供了详细的说明文档，包括漏洞的原理、利用方法和修复建议。此外，作者还提供了 ZeroNights 2019 会议的幻灯片，其中包含有关该漏洞的更多信息。

利用步骤：
1.  安装 Go 语言环境。
2.  使用 `go get github.com/neex/phuip-fpizdam` 命令下载并安装该 POC。
3.  使用 `phuip-fpizdam [url]` 命令运行该 POC，其中 [url] 是目标网站的 URL。
4.  如果目标存在漏洞，POC 将会执行任意代码。

投毒风险分析：该 POC 的投毒风险较低。该 POC 的代码清晰易懂，主要使用 Go 语言的标准库，没有发现任何可疑的代码或行为。该 POC 的主要功能是发送特制的 HTTP 请求来触发漏洞，不会在目标系统上安装任何后门或恶意软件。但是，攻击者可能会修改该 POC，添加恶意代码，然后将其传播给其他人。因此，在使用该 POC 时，务必从可信的来源下载，并仔细检查代码，确保其安全性。投毒风险评估为 10%。

**项目地址:** https://github.com/neex/phuip-fpizdam

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2019-11043
