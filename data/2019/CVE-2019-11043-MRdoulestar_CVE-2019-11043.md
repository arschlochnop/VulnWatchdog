## CVE-2019-11043 - PHP-FPM 远程代码执行

**漏洞编号:** CVE-2019-11043

**漏洞类型:** 远程代码执行

**影响应用:** PHP-FPM

**危害等级:** 严重

**CVSS评分:** 9.8

**影响版本:** 7.1.x < 7.1.33, 7.2.x < 7.2.24, 7.3.x < 7.3.11

**利用条件:** 需要特定的Nginx + PHP-FPM配置，攻击者需要能够发送特制的HTTP请求。

**POC 可用性:** 9/10

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 10%

## 详情

CVE-2019-11043是一个存在于PHP-FPM中的远程代码执行漏洞。此漏洞允许攻击者在特定的Nginx + PHP-FPM配置中执行任意代码。漏洞的根本原因是PHP-FPM在处理畸形的请求时，由于计算错误导致缓冲区溢出。具体来说，当`fastcgi_split_path_info`指令被不正确地配置时，攻击者可以通过构造包含大量'\n'字符的请求，使得PHP-FPM错误地解析PATH_INFO，并触发缓冲区溢出。

POC有效性分析：提供的Python脚本（cve_2019_11043.py）旨在利用此漏洞。脚本通过发送包含特定头部和查询字符串的HTTP请求，来触发缓冲区溢出。脚本首先尝试判断目标是否存在漏洞（judgeTarget函数），它通过发送带有不同长度'Q'字符的请求来探测。如果目标返回包含'Set-Cookie'头的响应，则表明目标可能存在漏洞。然后，脚本尝试确定目标PHP worker进程的数量，并通过修改PHP配置来污染所有worker进程。

利用步骤：
1.  配置Nginx以使用fastcgi_pass将PHP请求传递给PHP-FPM。
2.  确保Nginx配置中存在`fastcgi_split_path_info`指令。
3.  运行提供的Python脚本，并指定目标URL，例如：`python cve_2019_11043.py -u http://xxxx/index.php`。
4.  脚本将自动发送特制的HTTP请求，触发漏洞。
5.  成功利用后，攻击者可以在目标服务器上执行任意代码。

投毒风险分析：
此POC的投毒风险较低。脚本本身主要使用标准的Python库，例如`requests`和`http.client`。脚本的行为相对清晰，主要目的是发送HTTP请求和修改PHP配置。脚本中使用的`extension=$_GET[a]`可能被视为潜在的风险点，因为它允许通过GET参数指定要加载的PHP扩展，这可以被滥用来加载恶意扩展。但是，此POC的目的是为了利用漏洞，而不是植入后门或执行其他恶意操作。而且代码可读性很高，并没有进行任何混淆处理，因此总体的投毒风险较低，评估为10%。

**项目地址:** https://github.com/0th3rs/CVE-2019-11043

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2019-11043
