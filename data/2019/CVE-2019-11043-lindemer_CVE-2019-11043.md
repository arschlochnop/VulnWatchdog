## CVE-2019-11043 - PHP-FPM RCE

**漏洞编号:** CVE-2019-11043

**漏洞类型:** RCE

**影响应用:** PHP-FPM

**危害等级:** Critical

**CVSS评分:** 9.8

**影响版本:** PHP 7.1.x < 7.1.33, PHP 7.2.x < 7.2.24, PHP 7.3.x < 7.3.11

**利用条件:** Requires specific FPM configuration, network access

**POC 可用性:** 9/10

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 10%

## 详情

CVE-2019-11043是PHP-FPM中的一个远程代码执行漏洞。该漏洞源于PHP-FPM在处理URI请求时，使用正则表达式解析URI，但未正确匹配换行符（%0a）。这导致FastCGI计算查询字符串长度时出现错误，并在预期缓冲区之前写入一个空字节。攻击者可以通过精心构造的查询字符串，利用此漏洞覆盖服务器上的内部PHP变量，从而执行任意Shell代码。

**POC有效性分析：**
提供的POC代码（`exploit.py`）是一个完整的利用脚本，能够针对存在漏洞的PHP-FPM配置执行远程代码。该脚本利用了`fastcgi_split_path_info`指令中的漏洞，该漏洞允许攻击者通过在URI中注入换行符来绕过正则表达式匹配。通过操纵`PATH_INFO`变量，攻击者可以覆盖`PHP_VALUE`和`PHP_ADMIN_VALUE`等配置选项，从而执行任意PHP代码。POC的README文件提供了详细的利用说明，包括使用Docker快速搭建易受攻击环境的方法，以及成功利用后的Web shell访问方式。该POC经过验证，能够在特定的PHP-FPM配置下稳定地实现远程代码执行。

**利用步骤：**
1. 搭建存在漏洞的PHP-FPM环境。可以使用提供的Docker镜像或按照vulhub仓库中的说明进行配置。
2. 运行`exploit.py`脚本，指定目标URL（例如：`http://localhost:8080/script.php`）。
3. 如果利用成功，脚本将返回一个Web shell的URL。攻击者可以通过将命令附加到URL的`?a=`参数来执行任意Shell命令（例如：`http://localhost:8080/script.php?a=uname -a`）。

**投毒风险分析：**
该POC的投毒风险较低，因为其主要功能是利用已知的漏洞进行远程代码执行。该POC代码清晰，主要依赖于Python标准库，没有发现明显的恶意行为或代码混淆。但是，攻击者可能会修改该POC，以包含恶意代码或后门，从而实现更持久的访问或窃取敏感信息。在实际使用该POC时，应仔细审查代码，确保其不包含任何未经授权的功能。考虑到利用成功后可以执行任意系统命令，该漏洞本身存在一定的提权可能，在内网渗透中需要注意横向移动风险。由于该漏洞的原理是覆盖PHP配置，存在一定的信息泄露风险，比如覆盖error_reporting选项导致敏感信息泄露，虽然这并非直接投毒，但也是一种潜在的风险。

**项目地址:** https://github.com/neex/phuip-fpizdam

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2019-11043
