## CVE-2019-11043 - PHP-FPM RCE

**漏洞编号:** CVE-2019-11043

**漏洞类型:** RCE

**影响应用:** PHP-FPM

**危害等级:** Critical

**CVSS评分:** 9.8

**影响版本:** PHP 7.1.x < 7.1.33, 7.2.x < 7.2.24, 7.3.x < 7.3.11

**利用条件:** Specific FPM setup configurations are vulnerable. Requires network access to the FPM service.

**POC 可用性:** 9/10

**POC 类型:** Complete Exploitation

**攻击复杂度:** Low

**投毒风险:** 10%

## 详情

CVE-2019-11043 is a critical remote code execution (RCE) vulnerability affecting PHP-FPM (FastCGI Process Manager) in specific configurations. The vulnerability arises from an off-by-one error in the `fpm_header_buffer_append` function, which can lead to memory corruption and potentially arbitrary code execution. Specifically, when PHP-FPM is configured to pass requests to a backend PHP interpreter, a carefully crafted request can cause PHP-FPM to write beyond the allocated buffer size for FCGI protocol data. This overflow can overwrite critical data structures, allowing an attacker to execute arbitrary code on the server.

The provided POC code demonstrates the vulnerability by setting up a vulnerable PHP-FPM environment using Docker. The `Dockerfile` builds an Ubuntu 18.04 image, installs PHP from source with FPM enabled, configures Nginx to forward requests to PHP-FPM, and includes a basic PHP script for testing. The `docker-compose.yml` file defines a service that exposes ports 8080 for web access and 55555 for remote debugging with GDB. The `entrypoint.sh` script starts Nginx and PHP-FPM, attaches a GDB server to the PHP-FPM process for debugging, and tails the Nginx logs.

To successfully exploit this vulnerability, an attacker needs to craft a malicious HTTP request that triggers the buffer overflow in PHP-FPM. This typically involves manipulating the request URI or other parameters to cause the `fpm_header_buffer_append` function to write beyond the allocated buffer. The attacker can then use this memory corruption to overwrite critical data structures and ultimately execute arbitrary code on the server. The provided POC simplifies the setup of the vulnerable environment, but the actual exploitation requires a deeper understanding of the PHP-FPM internals and memory layout.

**Exploitation Steps:**

1.  Build the Docker image using the provided `Dockerfile` and `docker-compose.yml`.
2.  Start the Docker container using `docker-compose up`.
3.  Send a specially crafted HTTP request to the server on port 8080. The request should be designed to trigger the buffer overflow in the `fpm_header_buffer_append` function.
4.  Use a debugger such as GDB to attach to the PHP-FPM process and observe the memory corruption.
5.  Craft a payload that overwrites critical data structures with malicious code.
6.  Trigger the execution of the malicious code.

**投毒风险分析:**

While the provided POC code focuses on demonstrating the vulnerability and setting up a debugging environment, the risk of code poisoning is relatively low. The `Dockerfile` uses standard Ubuntu packages and builds PHP from source, without introducing any known malicious code. The other files, such as `php-fpm.conf`, `nginx.server.conf`, and `script.php`, contain configuration settings and a simple PHP script, which are unlikely to be used for malicious purposes.

However, there is a minor risk associated with the `entrypoint.sh` script, which copies the `php-fpm` binary to a shared directory. An attacker could potentially replace this binary with a modified version containing malicious code. Although, the primary purpose is for debugging and the risk is not high.

Overall, the poisoning risk is estimated to be 10% due to the minimal changes made to the system and the lack of any suspicious code or behavior. The POC's focus is on facilitating vulnerability research and debugging, rather than deploying malicious payloads.

**项目地址:** https://github.com/vulhub/vulhub/tree/master/php/CVE-2019-11043

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2019-11043
