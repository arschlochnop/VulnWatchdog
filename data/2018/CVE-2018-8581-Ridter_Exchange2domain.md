## CVE-2018-8581 - Microsoft Exchange Server 权限提升 (Elevation of Privilege)

**漏洞编号:** CVE-2018-8581

**漏洞类型:** 权限提升 (Elevation of Privilege)

**影响应用:** Microsoft Exchange Server

**危害等级:** 重要 (Important)

**CVSS评分:** CVSS:3.0/AV:N/AC:L/PR:N/UI:R/S:U/C:H/I:H/A:H (8.8)

**影响版本:** Microsoft Exchange Server 2010/2013/2016/2019

**利用条件:** 需要拥有一个有效的 Exchange 邮箱账号凭据；Exchange 服务器需能访问攻击者的监听服务器；未安装 2018 年 12 月以后的安全补丁。

**POC 可用性:** 9/10

**POC 类型:** 完整利用

**攻击复杂度:** 中

**投毒风险:** 15%

## 详情

CVE-2018-8581 是 Microsoft Exchange Server 中的一个严重的权限提升漏洞。该漏洞源于 Exchange 服务（具体为 Exchange Web Services, EWS）在处理推送通知订阅时，允许以 SYSTEM 权限发起 NTLM 认证请求。攻击者可以通过一个普通的邮箱账户凭据，向 EWS 发送恶意的 Subscribe 请求。在该请求中，攻击者指定一个由自己控制的监听服务器 URL。Exchange 服务器收到请求后，会尝试使用自身的机密信息（机器账户）向该 URL 发起 NTLM 认证。攻击者随后可以使用 ntlmrelayx 等工具捕捉该认证信息，并将其重放到域控制器或其他关键服务（如 LDAP），从而获取域管理员权限或接管整个域控环境。此漏洞的 POC 有效性极高，代码中通过 SOAP 封装构造了精确的 PushSubscriptionRequest，并配合了 Impacket 库实现 NTLM 中继。利用步骤如下：1. 攻击者在内网或可访问网络中启动 NTLM 重放工具，目标指向域控。2. 使用提供的 Python 脚本，填入已获取的普通用户账号密码。3. 脚本通过 EWS 接口向 Exchange 服务器发送订阅请求，强制 Exchange 回连攻击者。4. 攻击者接收到 Exchange 机器账户的 NTLM 挑战并重放至域控。5. 成功执行提权操作。\n\n在投毒风险方面，经分析该 POC 逻辑清晰，主要依赖成熟的开源安全库 Impacket 及其组件（如 smbrelay, secretsdump）。代码中包含明显的 banner 信息（EXCHANGE2DOMAIN）和标准的参数解析逻辑。脚本的主要风险点在于其对敏感信息的处理。虽然目前分析的代码段未见明显的混淆或恶意的外部 C2 回连，但由于其涉及到域凭据抓取（SecretsDump）和复杂的 NTLM 重放逻辑，非法开发者极易在 `comm` 或 `config` 模块中嵌入后门。特别是导入的自定义模块 `comm.ntlmrelayx` 如果不是直接引用自官方项目，则存在极高的供应链投毒风险。此外，此类工具常被用于内网渗透，攻击者可能在代码中植入自动上传敏感凭据到第三方服务器的逻辑。目前提供的代码片段中，逻辑相对透明，使用了标准的多线程和 Socket 处理，未发现恶意混淆，因此投毒风险判定为低到中等程度（15%），建议在使用前务必检查 `comm` 文件夹下的所有依赖库源码。

**项目地址:** [https://github.com/RedTeams/Exchange2domain](https://www.google.com/search?q=https://github.com/RedTeams/Exchange2domain)

**漏洞详情:** [https://nvd.nist.gov/vuln/detail/CVE-2018-8581](https://nvd.nist.gov/vuln/detail/CVE-2018-8581)
