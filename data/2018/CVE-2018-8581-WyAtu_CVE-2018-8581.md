## CVE-2018-8581 - Microsoft Exchange Server SSRF/权限提升

**漏洞编号:** CVE-2018-8581

**漏洞类型:** SSRF/权限提升

**影响应用:** Microsoft Exchange Server

**危害等级:** 重要 (Important)

**CVSS评分:** 7.4 (CVSS:3.0/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:N)

**影响版本:** Microsoft Exchange Server 2010 SP1/SP2/SP3, 2013, 2016

**利用条件:** 需要拥有一个有效的普通邮箱账户凭据，且Exchange服务器可以访问外部或受控的HTTP服务器。

**POC 可用性:** 8/10

**POC 类型:** 完整利用

**攻击复杂度:** 中

**投毒风险:** 10%

## 详情

POC有效性分析：该POC代码实现了针对CVE-2018-8581漏洞的完整利用链。该漏洞的核心在于Exchange EWS接口的SSRF漏洞，允许攻击者以SYSTEM权限诱导Exchange服务器向指定URL发起NTLM认证。POC通过Python的httplib和ntlm库构建了攻击载荷。代码首先利用已知凭据（USER/PASS）通过NTLM认证访问EWS接口，随后构造SOAP请求触发Subscribe调用。关键在于EWS服务会尝试连接EVIL_HTTPSERVER_URL进行通知推送，由于Exchange EWS运行在SYSTEM权限下，它在请求受控服务器时会携带机器账户的NTLM哈希。POC中定义的request_func函数展示了完整的身份验证握手过程，通过FLAG变量控制是执行AddDelegate（添加委派）还是RemoveDelegate（移除委派）。如果结合NTLM Relay技术（如Impersonation），攻击者可以接管TARGET_EMAIL定义的任意用户邮箱。代码结构清晰，通过定义EXCHANGE_VERSION支持多版本适配，具备极高的实战参考价值和有效性。利用步骤：1. 配置目标Exchange服务器IP及端口。2. 填入攻击者掌握的普通用户凭据及目标邮箱地址。3. 启动一个监听在8080端口的受控HTTP服务器，用于接收Exchange发送的SSRF请求。4. 运行POC脚本，脚本将发送Subscribe SOAP包。5. Exchange服务器访问受控端，此时配合NTLM中继工具将认证流量重定向回Exchange，从而获取目标用户的完全控制权限。投毒风险分析：经过对提供的代码逻辑深度审计，该POC属于典型的安全研究脚本，未发现明显的恶意投毒行为。代码主要依赖Python 2.7标准库（httplib, ssl, re）以及通用的ntlm扩展包。风险点分析如下：1. 网络通信：脚本仅与定义的Exchange服务器IP和EVIL_HTTPSERVER_URL通信，不存在隐蔽的第三方C2连接。2. 代码透明度：逻辑完全开源，未进行混淆或压缩处理，开发者可以清晰看到每一个SOAP包的构造过程。3. 依赖项安全性：使用的ntlm库为公开的第三方库，通常用于模拟Windows认证，不含后门逻辑。4. 恶意行为：代码的功能严格限定在CVE-2018-8581的漏洞验证（委派权限操作），没有文件读写、进程注入或勒索加密等不相关恶意行为。尽管如此，在使用此类脚本时，防御者仍需注意EVIL_HTTPSERVER_URL的配置，确保接收端处于受控审计环境中，防止敏感凭据（如NTLM Net-NTLMv2哈希）泄露给未授权的第三方。总体评估投毒风险极低，属于高质量的防御性研究样本。

**项目地址:** [https://github.com/WyAtu/CVE-2018-8581](https://github.com/WyAtu/CVE-2018-8581)

**漏洞详情:** [https://nvd.nist.gov/vuln/detail/CVE-2018-8581](https://nvd.nist.gov/vuln/detail/CVE-2018-8581)
