## CVE-2025-54424 - 1Panel 证书验证绕过导致的远程命令执行 (RCE)

**漏洞编号:** CVE-2025-54424

**漏洞类型:** 证书验证绕过导致的远程命令执行 (RCE)

**影响应用:** 1Panel

**危害等级:** 高危

**CVSS评分:** N/A

**影响版本:** 1Panel ≤ v2.0.5

**利用条件:** 需要网络访问目标Agent服务，无需预认证（可绕过TLS客户端证书验证）

**POC 可用性:** 9

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 10%

## 详情

CVE-2025-54424是一个影响1Panel开源Linux服务器运维管理面板的远程命令执行（RCE）漏洞。该漏洞主要存在于1Panel v2版本引入的Core-Agent架构中，其核心问题在于Agent端的TLS客户端证书验证机制存在缺陷。具体来说，受影响的1Panel Agent在与主节点通过HTTPS进行通信时，其TLS认证策略配置为`tls.RequireAnyClientCert`。这意味着Agent仅要求客户端提供任何有效的证书，但并不会对其可信性（例如是否由受信任的CA颁发）进行验证。攻击者可以利用这一缺陷，通过生成并使用一个自签名的客户端证书（Common Name通常为"panel_client"），成功绕过Agent的身份验证机制。一旦认证被绕过，攻击者便能通过WebSocket接口与Agent建立通信，并发送特定的命令（如`agent:exec_command`），从而在目标服务器上执行任意系统命令，最终导致远程代码执行。此漏洞的威胁等级被评估为高危，因为它可以允许未经授权的攻击者完全控制受感染的服务器，进行包括反弹Shell、数据窃取、植入挖矿程序或破坏系统等恶意活动。受影响的版本主要为1Panel ≤ v2.0.5。

**POC有效性分析 (POC Effectiveness Analysis):**
提供的Python POC代码（`CVE-2025-54424.py`）是一个功能完整且高度有效的漏洞检测与利用工具。该POC设计精良，能够可靠地复现并利用CVE-2025-54424漏洞。
1.  **动态证书生成**: POC的核心功能之一是能够动态生成自签名的TLS客户端证书和私钥。它使用`cryptography`库生成RSA密钥对，并构建一个Common Name (CN) 为“panel_client”的X.509证书。这一步骤精确模拟了攻击者绕过`tls.RequireAnyClientCert`验证所需的条件，因为Agent只检查证书是否存在且CN是否符合预期，而不验证其签名链。生成的证书和私钥被临时存储在文件中，确保了利用过程的灵活性和自动化。
2.  **两阶段检测与利用**: POC首先执行一个HTTP GET请求到目标Agent的`/api/v2/dashboard/base/os`路径。这个请求携带着伪造的客户端证书进行认证。如果Agent返回200 OK响应，则初步确认目标可能存在漏洞且Agent服务正常运行。在预检成功后，POC会建立一个安全的WebSocket连接（WSS）到Agent，同样使用伪造的客户端证书。一旦连接成功，POC可以发送一系列合法的Agent管理命令，例如`agent:get_os_info`或`agent:get_system_info`，验证连接和认证的有效性。最关键的是，POC包含一个`exploit_rce`函数，该函数能够构造并发送`agent:exec_command`消息，将攻击者指定的任意系统命令传递给Agent执行。命令执行的结果会通过WebSocket返回，实现了远程代码执行的完整闭环。
3.  **高级功能**: POC支持通过命令行参数指定目标主机、并发线程数、HTTP/S代理等，提高了其在不同环境下的适用性和操作便利性。它还通过线程锁机制确保多线程输出的整洁性，展现了良好的工程实践。因此，该POC不仅是一个概念验证，更是一个完整的利用工具，其代码逻辑清晰、实现健壮，能够自动化完成证书生成、漏洞检测和远程命令执行的全过程。

**利用步骤 (Exploitation Steps):**
利用CVE-2025-54424漏洞的攻击过程相对直接，以下是典型的利用步骤：
1.  **目标识别**: 攻击者首先需要识别运行1Panel Agent服务的潜在目标，通常Agent监听在一个特定的端口（例如6800）。
2.  **伪造客户端证书**: 攻击者使用工具（如本POC中的功能）动态生成一个自签名的TLS客户端证书和对应的私钥。该证书的Common Name (CN) 必须设置为“panel_client”。
3.  **绕过TLS验证**: 攻击者将生成的伪造证书和私钥用于后续与1Panel Agent建立TLS通信。由于Agent的配置缺陷，它不会对证书的颁发机构或有效性进行深度验证，只要证书格式正确且CN匹配，就会接受连接。
4.  **建立WebSocket连接**: 攻击者通过伪造的证书成功与Agent建立一个安全的WebSocket（WSS）连接。这个连接是后续命令传输的通道。
5.  **发送远程命令执行请求**: 通过已建立的WebSocket连接，攻击者构造一个JSON格式的消息，其中包含`agent:exec_command`指令以及要执行的任意系统命令。例如，发送一个类似`{"command": "agent:exec_command", "params": {"command": "id", "session_id": "...", "id": "..."}}`的请求。
6.  **接收命令输出**: Agent执行命令后，会将命令的输出结果通过相同的WebSocket连接返回给攻击者。
7.  **实现完全控制**: 攻击者可以重复步骤5和6，发送一系列命令，从而完全控制目标服务器。

**投毒风险分析 (Poisoning Risk Analysis):**
对提供的`CVE-2025-54424.py` POC代码进行全面分析后，我们评估其投毒风险为**低（约10%）**。以下是详细的分析：
1.  **代码透明度与可读性**: POC代码采用Python编写，结构清晰，变量命名规范，并且包含适当的注释，使得代码逻辑易于理解。没有发现任何代码混淆、加密或难以解析的模块，这大大降低了隐藏恶意行为的可能性。
2.  **依赖与库使用**: 该POC仅依赖于标准的Python库和常用的第三方安全工具库，例如`requests`用于HTTP通信，`websocket-client`用于WebSocket通信，以及`cryptography`用于证书生成。这些都是在安全研究和开发中广泛使用的合法库。代码中没有引入任何不常见的、可疑的或来自未知来源的外部脚本或二进制文件。
3.  **网络行为**: POC的网络通信行为是可预测和可解释的。它会向指定的目标主机发起HTTPS GET请求和WSS连接，这些操作完全符合验证和利用TLS证书验证绕过漏洞的逻辑。POC支持配置代理，这是安全测试工具的常见功能，不构成恶意行为。没有迹象表明POC会连接到其他未经授权的远程服务器（例如C2服务器），或者尝试在后台下载并执行额外的payload。
4.  **文件系统操作**: POC使用`tempfile.NamedTemporaryFile`来临时创建自签名证书和私钥文件。这些文件是实现证书绕过所必需的，并且是临时性的。尽管截断的POC代码片段中未明确显示文件删除逻辑，但`tempfile`模块通常会确保临时文件在不再需要时被清理。这些文件的创建目的是为了漏洞利用，并非植入持久化后门或恶意数据。
5.  **命令执行**: POC的核心功能是远程命令执行。然而，其`exploit_rce`函数中的命令参数完全由用户通过命令行或代码逻辑提供。POC本身不会在目标服务器上硬编码或自动执行任何恶意命令（例如，不会自动安装挖矿程序、启动反弹Shell或进行数据删除）。它仅仅提供了一个执行任意命令的接口。这意味着潜在的恶意行为并非来源于POC代码本身，而是源于攻击者/测试者通过该POC选择执行的命令。
6.  **无恶意荷载**: 经检查，POC代码中没有发现任何嵌入式的恶意荷载，如挖矿脚本、勒索软件代码、后门程序或信息窃取逻辑。其功能严格限于检测和利用已知的证书验证绕过和RCE漏洞。
综上所述，该POC代码是作为合法的安全研究工具而编写的，其目的在于帮助安全研究人员或防御团队理解和防范此漏洞。其代码的透明度、对标准库的依赖以及缺乏任何可疑的外部通信或硬编码恶意行为，均表明其投毒风险非常低。用户在使用时，主要风险在于其选择执行的命令本身可能带来的后果，而不是POC代码本身的恶意性。

**项目地址:** https://github.com/gmh5225/CVE-2025-54424

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2025-54424
