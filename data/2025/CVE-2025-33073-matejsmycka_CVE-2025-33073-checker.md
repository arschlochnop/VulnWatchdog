## CVE-2025-33073 - Microsoft Windows Active Directory NTLM中继/域渗透漏洞

**漏洞编号:** CVE-2025-33073

**漏洞类型:** NTLM中继/域渗透漏洞

**影响应用:** Microsoft Windows Active Directory

**危害等级:** 高危/临界 (Critical)

**CVSS评分:** 高危 (危害极高，推测CVSS 9.8以上)

**影响版本:** 未知，影响Windows AD域

**利用条件:** 需要有效的域用户认证凭据；目标Windows AD域控制器需禁用SMB签名；可能依赖未受保护的Active Directory证书服务 (AD CS) 进行NTLM中继。

**POC 可用性:** 8

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 10%

## 详情

POC脚本`CVE-2025-33073-checker.sh`是一个功能较为完善的漏洞验证工具，旨在检测目标Windows Active Directory域控制器是否存在CVE-2025-33073漏洞。该漏洞被搜索结果描述为近十年来最具破坏力的Windows域渗透漏洞之一，其核心机制很可能涉及NTLM中继攻击，类似于PetitPotam。脚本通过命令行参数接收域用户凭据（用户名、密码）、目标域以及包含目标IP地址的文件。

**POC有效性分析:**
脚本的执行流程如下：首先，它解析并验证所有必需的命令行参数，确保提供了有效的认证信息和目标IP文件。对于IP文件中的每一个目标IP，脚本会调用外部工具`crackmapexec`来尝试进行SMB连接并获取目标系统的安全配置信息。`crackmapexec`是一个常用的SMB/AD渗透测试工具。脚本特别关注`crackmapexec`的输出，检查其中是否包含"signing:False"，以确认目标系统的SMB签名是否被禁用。同时，它还会验证`crackmapexec`报告的域是否与输入域匹配，并确认登录是否成功，避免因认证失败而误判。
如果SMB签名被禁用且认证成功，脚本会进一步尝试触发NTLM中继攻击。在执行PetitPotam攻击之前，脚本会使用`sudo nc -lvnp 445`命令在本地启动一个Netcat监听器，用于模拟一个恶意的SMB服务器，等待接收被强制认证的NTLM流量。由于监听445端口通常需要特权，因此使用了`sudo`。随后，脚本调用另一个外部Python工具`PetitPotam.py`（该工具需提前部署在环境中）。`PetitPotam.py`被用来向目标域控制器发起特定的请求，强制其向一个指定的地址（在此POC中为`localhost:445`，即本地的Netcat监听器）发起NTLM认证。脚本会检查`PetitPotam.py`的输出，确认是否包含"Attack worked!"，以判断PetitPotam攻击是否成功触发。PetitPotam攻击成功后，脚本会等待一段时间（最长5秒），检查Netcat监听器是否接收到任何数据。如果Netcat的输出文件（一个临时文件）包含数据，则表明目标系统确实受到了NTLM强制认证，并向本地监听器发送了NTLM哈希或挑战-响应信息，从而确认目标存在CVE-2025-33073漏洞。脚本利用`trap cleanup_nc EXIT`确保在脚本退出时，无论是正常退出还是异常中断，都会终止Netcat进程并删除临时文件，体现了良好的实践。总的来说，该POC脚本通过集成现有工具并编排攻击流程，能够有效地模拟CVE-2025-33073的利用链，从SMB签名检查到NTLM中继的触发和验证，具有较高的有效性。其可靠性依赖于所调用的`crackmapexec`和`PetitPotam.py`工具的正确安装和功能。

**利用步骤:**
1.  **环境准备**：确保攻击机上已安装并配置好必要的工具，包括`crackmapexec`、`PetitPotam.py`脚本以及`netcat`。攻击机需要具有网络连接到目标Windows AD域控制器。
2.  **获取认证凭据**：攻击者需要拥有一个有效的域用户账户的用户名和密码。即使是普通域用户权限也可能足以触发该漏洞。
3.  **创建目标列表**：准备一个文本文件（例如`ips.txt`），每行包含一个目标Windows AD域控制器的IP地址。
4.  **执行POC脚本**：在攻击机上以管理员权限（因为需要监听445端口）运行POC脚本：`sudo ./CVE-2025-33073-checker.sh -u <username> -p <password> -d <domain_name> -i /path/to/ips.txt`。请将`<username>`替换为域用户名，`<password>`替换为域用户密码，`<domain_name>`替换为目标Active Directory域的NetBIOS名称或FQDN。
5.  **分析结果**：脚本将逐一检查目标IP。如果某个目标被判定为“VULNERABLE TO CVE-2025-33073”，则表示该域控制器存在漏洞。
6.  **后续利用**：一旦验证漏洞，攻击者可将Netcat监听地址替换为攻击者控制的恶意SMB服务器或AD CS（Active Directory Certificate Services）服务器，通过中继受害者的NTLM认证请求，获取其NTHash或Kerberos票据，从而实现权限提升或域内横向移动，最终可能导致域完全沦陷。

**投毒风险分析:**
针对此POC脚本的投毒风险评估为**低**，具体百分比为**10%**。主要理由如下：
1.  **代码透明且清晰**：该POC脚本是一个Bash Shell脚本，代码逻辑直观，易于审查和理解。脚本没有使用任何代码混淆技术、加密或复杂嵌套，使得恶意行为难以隐藏。安全研究人员可以轻松地逐行检查其功能。
2.  **依赖标准且知名工具**：脚本的核心功能依赖于`crackmapexec`、`PetitPotam.py`和`netcat`这些在渗透测试和漏洞研究领域广泛使用的开源工具。这些工具本身如果从其官方或受信任的GitHub仓库等来源获取，通常是经过社区验证的，不含恶意代码。
3.  **缺乏自我传播或持久化机制**：脚本设计为一次性执行的漏洞检测工具，不包含任何自我复制、感染其他系统、建立持久化后门或修改系统配置的代码。其执行完毕后，除了Netcat监听可能留下的临时文件（脚本已包含清理机制）外，不会在系统上留下任何痕迹。
4.  **无网络外联恶意行为**：脚本的全部网络活动都是围绕漏洞验证进行的，包括通过`crackmapexec`和`PetitPotam.py`与目标系统通信，以及在本地启动`netcat`监听器接收受害者强制发起的认证请求。没有发现向未知或可疑外部服务器发送数据、下载恶意Payload或进行C2（命令与控制）通信的行为。
5.  **临时文件处理安全**：脚本使用`mktemp`命令创建临时文件来存储Netcat的输出，并在脚本退出时通过`trap`机制确保这些临时文件被删除，这是一种安全处理临时文件的好方法，避免了残留敏感信息或被恶意利用的风险。
6.  **权限合理性**：脚本在启动`netcat`监听445端口时使用了`sudo`。这是因为在Linux系统中，监听1024以下的端口需要root权限。这并非恶意提升权限，而是其功能实现所需的合法操作。
尽管投毒风险较低，但仍需注意以下潜在风险点：外部工具的来源必须是可信的。如果攻击者将这些外部依赖替换为恶意版本，那么即使POC脚本本身无害，整个利用过程也会变得危险。建议从官方GitHub仓库或其他权威渠道下载这些依赖。

**项目地址:** https://github.com/obscura-cert/CVE-2025-33073

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2025-33073
