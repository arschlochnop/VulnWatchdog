## CVE-2025-8088 - WinRAR 目录遍历/路径遍历

**漏洞编号:** CVE-2025-8088

**漏洞类型:** 目录遍历/路径遍历

**影响应用:** WinRAR

**危害等级:** 高危

**CVSS评分:** 高危

**影响版本:** 具体版本范围未明确，但涉及WinRAR的Windows版RAR、UnRAR、便携式UnRAR源代码及UnRAR.dll

**利用条件:** 需要用户解压恶意构造的RAR文件，无需认证

**POC 可用性:** 9

**POC 类型:** 完整利用

**攻击复杂度:** 中

**投毒风险:** 10%

## 详情

该Python脚本（`Cve_2025_8088.py`）是一个针对WinRAR目录遍历漏洞（CVE-2025-8088）的完整概念验证（POC）和利用工具。脚本的核心功能在于生成一个特制的RAR压缩包，利用Windows NTFS备用数据流（ADS）特性和路径遍历技巧，将任意指定的文件（payload）释放到受害者系统上的预设位置，特别是Windows的“启动”文件夹（`ProgramData\Microsoft\Windows\Start Menu\Programs\Startup`）。一旦payload文件被成功释放到此目录，它将在受害者下次启动系统或登录时自动执行，从而实现任意代码执行（RCE）。

脚本首先通过`_find_winrar()`方法尝试在常见的安装路径（如`C:\Program Files\WinRAR\rar.exe`和`C:\Program Files (x86)\WinRAR\rar.exe`）定位WinRAR的可执行文件`rar.exe`。这是利用WinRAR漏洞的基础，因为它依赖于系统上已安装的WinRAR工具来生成原始的、合法的RAR结构。如果`rar.exe`未找到，脚本将无法继续。

在`_crear_exploit_ads()`方法中，脚本展示了其主要攻击逻辑。它首先确定payload的目标目录为“启动”文件夹，这是一个高度敏感的位置，因为其中的内容会在用户登录后自动执行。脚本的关键步骤包括：
1.  **RAR文件创建**: 通过`subprocess`模块调用找到的`rar.exe`，将一个“诱饵”文件（`decoy.txt`）和一个占位符文件（`filler.txt`）打包成一个临时的`.base.rar`文件。这个基础文件包含了WinRAR的标准文件结构。
2.  **ADS路径构造**: 在创建RAR文件之前，脚本会创建一个`payload_name:decoy.txt`的文件名结构，利用Windows的备用数据流特性。在NTFS文件系统中，ADS允许一个文件关联多个数据流，这可以被用来隐藏数据或在路径遍历中增加复杂性。
3.  **RAR头修改**: 这是漏洞利用的关键环节。脚本读取`.base.rar`的二进制内容，然后通过`_modificar_header()`方法修改RAR文件头。具体来说，它会寻找文件头中描述文件名的部分，将其替换为恶意构造的路径，例如`..\..\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup\payload_name`。这种替换绕过了WinRAR在解压时对路径的合法性检查，使得文件可以被释放到任意指定位置。
4.  **恶意Payload嵌入**: 在修改后的RAR文件中，脚本将原始的payload文件内容替换掉之前占位符文件`filler.txt`的内容。这样，当RAR文件被解压时，攻击者的真实payload文件就伴随着恶意路径被释放。
5.  **最终RAR生成**: 将修改后的RAR内容写入到最终的输出文件中。

该POC代码结构良好，功能完整，逻辑清晰，实现了WinRAR目录遍历漏洞从生成恶意压缩包到实现任意代码执行的完整链条。它通过直接操作RAR文件二进制结构来达到目的，展示了对漏洞原理的深刻理解。经分析，该POC具有高度的有效性，可以直接用于复现漏洞。

**利用步骤**:
要成功利用此POC，攻击者需要执行以下步骤：
1.  **环境准备**: 确保攻击者机器上安装了Python 3环境以及一个受影响版本的WinRAR（因为POC会调用`rar.exe`来构造基础RAR文件）。
2.  **准备Payload**: 攻击者需要准备一个恶意的可执行文件（例如`.exe`、`.bat`、`.vbs`脚本等）作为payload，该文件将在受害者系统上执行。例如，可以创建一个名为`malicious.exe`的文件。
3.  **运行POC脚本**: 攻击者需要执行提供的Python脚本，并传入payload文件路径和期望的输出恶意RAR文件路径。虽然POC代码片段没有显示完整的命令行参数解析，但其`_crear_archivo_malicioso`方法签名暗示了这些输入。假设有命令行接口，命令可能如下：
    `python Cve_2025_8088.py --payload /path/to/your/malicious.exe --output malicious_archive.rar`
    其中，`/path/to/your/malicious.exe`是攻击者准备的payload文件的路径，`malicious_archive.rar`是生成的恶意RAR文件的名称。
4.  **社会工程学攻击**: 生成的`malicious_archive.rar`文件需要被传递给目标受害者。这通常通过钓鱼邮件、恶意下载链接或其他社会工程学手段完成。攻击者会诱骗受害者下载并解压这个RAR文件。
5.  **受害者解压**: 受害者在自己的计算机（安装有受影响版本WinRAR）上解压这个`malicious_archive.rar`。由于WinRAR的目录遍历漏洞，脚本中恶意构造的路径将绕过安全检查。
6.  **Payload执行**: 攻击者的`malicious.exe`（或其他payload）文件将不会被解压到用户指定的目标文件夹，而是被释放到系统预设的启动文件夹（`C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup`）。
7.  **持久化与RCE**: 当受害者下次启动计算机或登录Windows系统时，位于“启动”文件夹中的`malicious.exe`将自动执行，从而赋予攻击者在受害者系统上的任意代码执行能力，实现持久化控制。

**投毒风险分析**:
对提供的`Cve_2025_8088.py` POC代码进行投毒风险评估，结论为**低风险**，投毒风险百分比约为**10%**。具体分析如下：

1.  **代码清晰度与可读性**: 脚本代码结构清晰，使用了类和方法进行模块化，变量和函数命名虽然是西班牙语（如`_ruta_rar`, `_crear_archivo_malicioso`, `_crear_exploit_ads`, `_modificar_header`），但其功能意图明确，没有使用混淆技术。这使得代码容易被安全研究人员审查和理解，从而降低了隐藏恶意行为的可能性。没有发现加密字符串、复杂的自修改代码或不必要的间接调用。

2.  **外部依赖与网络行为**: 脚本主要依赖于Python的标准库（`os`, `pathlib`, `subprocess`, `struct`, `zlib`），这些都是Python生态系统中广泛使用且经过严格审查的模块。最主要的外部依赖是本地安装的WinRAR程序（`rar.exe`），POC通过`subprocess`调用它来完成RAR文件的创建和修改。脚本代码中未发现任何涉及外部网络请求（如HTTP/HTTPS连接到未知IP或域名）的行为，也未发现下载并执行外部脚本或二进制文件的代码。这意味着它不会从不可信的源获取或更新恶意组件。

3.  **可疑的文件系统或系统调用**: 脚本的核心功能是生成一个包含目录遍历漏洞的RAR文件，这涉及到对文件系统进行写入操作（创建临时文件、生成最终RAR文件）。它会尝试在系统路径中查找`rar.exe`，并利用`subprocess`执行它。这些操作都是为了实现漏洞复现的正常步骤。脚本的目标是将用户提供的payload文件（其内容由攻击者控制）释放到目标系统的启动目录。脚本本身并未在执行时偷偷地修改系统配置、安装后门程序、修改注册表或进行任何超出生成恶意RAR文件范围的其他恶意行为。

4.  **恶意负载的性质**: 脚本本身不是恶意负载，它是一个生成恶意负载（RAR文件）的工具。真正的“恶意”在于用户提供的payload文件以及生成的RAR文件中嵌入的恶意路径。POC脚本本身的目的就是生成这种恶意结构以验证漏洞，因此不能将生成带有后门功能的RAR文件本身视为POC代码的投毒。

5.  **潜在的投毒方式**: 尽管当前代码干净，但任何公开的POC都存在被恶意行为者修改后重新发布的风险。例如，攻击者可以在POC中植入额外的代码，使其在生成恶意RAR的同时，也对运行POC的机器进行感染；或者在`_modificar_header`或`_crear_exploit_ads`等关键函数中，添加上传敏感信息、下载C2指令或建立持久化后门的代码。因此，建议所有使用公开POC的研究人员，务必在隔离环境中运行，并仔细审查代码，特别是检查`subprocess`调用、文件操作以及任何潜在的网络通信，以确保其安全。

综上所述，该POC代码本身表现出良好的透明度和合规性，专注于漏洞利用的实现，并未包含额外的恶意功能，因此投毒风险较低。

**项目地址:** 

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2025-8088
