## CVE-2025-6018 - Linux系统 (涉及PAM/Polkit, libblockdev, udisks2) 本地提权 (Local Privilege Escalation)

**漏洞编号:** CVE-2025-6018

**漏洞类型:** 本地提权 (Local Privilege Escalation)

**影响应用:** Linux系统 (涉及PAM/Polkit, libblockdev, udisks2)

**危害等级:** 高危 (Critical)

**CVSS评分:** 未知

**影响版本:** 大多数Linux发行版 (不影响默认Ubuntu安装，需udisks2和libblockdev安装)

**利用条件:** 需要目标机器上的用户账户(SSH访问)，并安装有`udisks2`和`libblockdev`。攻击者可利用远程SSH会话绕过本地密码要求，进而触发本地提权。涉及到 race condition 利用。

**POC 可用性:** 9

**POC 类型:** 完整利用

**攻击复杂度:** 中

**投毒风险:** 10%

## 详情

对CVE-2025-6018和CVE-2025-6019组合利用的PoC代码进行了深入分析。该PoC提供了一个功能完整且有效性极高的利用链，旨在帮助攻击者在受影响的Linux系统上获取root权限。CVE-2025-6018是一个PAM/Polkit活动会话绕过漏洞，它允许远程SSH会话被错误地标记为“Active=yes”，从而使系统相信远程用户实际处于控制台状态，绕过对硬件管理工具（如`udisks2`）的密码要求。与此紧密相关的是CVE-2025-6019，这是一个`libblockdev`库中的SUID挂载缺陷，该库在执行维护操作（如调整大小或修复）时，未能正确地对临时挂载的文件系统应用`nosuid`安全标志。

**POC有效性分析：**
该PoC的有效性体现在其精心设计的“杀伤链”上：首先，攻击者在本地机器上创建一个包含SUID root shell的恶意XFS镜像（`exploit.img`）。接着，利用CVE-2025-6018的特性，通过被错误标记为“Active=yes”的SSH会话，使用`udisks2`工具以循环设备（loop device）的形式在目标系统上挂载恶意镜像。随后，通过D-Bus接口触发文件系统调整操作。在`libblockdev`库处理调整大小操作的短暂瞬间，它会在挂载镜像时**不**应用`nosuid`标志（CVE-2025-6019），从而使SUID位保持有效。最后，一个竞争条件捕获器被设计用来立即执行挂载后的SUID二进制文件，从而获取root shell。整个利用流程逻辑清晰，环环相扣，充分展示了对这两个漏洞深层机制的理解。PoC提供了`setup_image.sh`用于本地机器准备，以及`exploit.sh`用于目标机器上的实际利用。即使自动化的竞争条件利用失败，它也提供了手动触发的选项，增加了其成功的概率。从技术角度看，这个PoC是一个高质量的、能够有效实现本地提权的功能性工具。它充分利用了Linux系统上常见的PAM、Polkit、udisks2和libblockdev组件之间的交互缺陷，对理解和防御此类复合型漏洞具有重要价值。

**利用步骤：**
1.  **准备阶段 (攻击者机器)**：在本地Kali或Parrot机器上运行`sudo ./setup_image.sh`脚本，生成包含SUID root shell的`exploit.img`文件。
2.  **上传恶意镜像**：将生成的`exploit.img`上传到目标Linux机器的`/tmp/`目录。可以通过Python HTTP服务器配合`wget`，或使用`scp`命令完成。
3.  **获取PoC脚本**：将`exploit.sh`脚本上传到目标机器，或直接在目标机器上克隆PoC仓库。
4.  **执行权限**：为`exploit.sh`脚本添加执行权限：`chmod +x exploit.sh`。
5.  **执行利用**：运行脚本`./exploit.sh`。如果成功，将直接获得一个root shell (`#`)。
6.  **手动触发 (可选)**：如果自动脚本失败，可以打开两个终端，一个运行“捕获器”脚本（`while true; do VULN_PATH=$(mount | grep "loop0" | grep -v "run/media" | awk '{print $3}'); if [ -n "$VULN_PATH" ]; then $VULN_PATH/rootbash -p; break; fi; done`），另一个运行“触发器”命令（`gdbus call --system --dest org.freedesktop.UDisks2 --object-path /org/freedesktop/UDisks2/block_devices/loop0 --method org.freedesktop.UDisks2.BlockDevice.Resize`...）。

**投毒风险分析：**
对该PoC代码的投毒风险评估显示，其风险等级较低，约为10%。主要原因在于代码的透明度和其利用机制的清晰性。
首先，该PoC的核心组件是两个shell脚本：`setup_image.sh`和`exploit.sh`。Shell脚本通常易于阅读和审计，除非经过刻意的高度混淆。在此PoC中，代码并未表现出任何混淆的迹象，使用的都是标准的Linux命令（如`sudo`, `mkfs.xfs`, `dd`, `mount`, `chmod`, `gcc`, `wget`, `scp`, `gdbus`等）。这些命令是系统管理和渗透测试中常见的工具，它们的用途明确，没有隐含的恶意功能。
其次，PoC的目的是为了实现本地提权，这意味着它会生成一个包含SUID root shell的恶意文件（`exploit.img`）。这个文件是攻击的“载荷”，并非PoC脚本本身被“投毒”。脚本的任务是创建这个载荷，并利用漏洞来执行它。将利用成功的“后门”视为PoC本身的投毒，是不符合防御性安全研究的定义的。该PoC的`README.md`明确指出其用途是“教育目的和授权测试”，并强调“请勿在未经授权的系统上使用”，这表明作者的意图是合法的安全研究，而非传播恶意软件。
在代码中没有发现对外部可疑URL的非必要请求，也没有使用`eval`等高风险函数进行动态代码执行。`wget`和`scp`用于上传文件，但目标IP由用户指定。生成的SUID shell代码是PoC功能的核心部分，不是注入的恶意代码。
潜在的低风险点可能在于，如果`setup_image.sh`或`exploit.sh`在未来被第三方修改或托管在不可信的源上，则存在被恶意注入代码的风险。然而，就目前提供的PoC内容而言，没有直接证据表明存在此类风险。在实际使用前，防御者应始终对任何下载的PoC代码进行彻底审计，以验证其内容的完整性和安全性，确保没有被篡改或添加未经授权的功能。但就当前审查的PoC内容而言，其设计和实现符合安全研究工具的规范，投毒风险较低。

**项目地址:** https://github.com/guinea-offensive-security/CVE-2025-6019

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2025-6018
