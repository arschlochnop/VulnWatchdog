## CVE-2025-59287 - Microsoft Windows Server Update Services (WSUS) 不安全反序列化远程代码执行 (RCE)

**漏洞编号:** CVE-2025-59287

**漏洞类型:** 不安全反序列化远程代码执行 (RCE)

**影响应用:** Microsoft Windows Server Update Services (WSUS)

**危害等级:** 高危

**CVSS评分:** CVSS 9.8

**影响版本:** Windows Server 2025, Windows Server 2022, Windows Server 2019, Windows Server 2012 (可能包含2012 R2, 2016) 及更高版本

**利用条件:** 无需身份验证的远程访问；需要获取WSUS的解密密钥

**POC 可用性:** 6

**POC 类型:** 概念验证

**攻击复杂度:** 低

**投毒风险:** 10%

## 详情

CVE-2025-59287是Microsoft Windows Server Update Services (WSUS)中存在的一个高危远程代码执行（RCE）漏洞。此漏洞源于WSUS在处理AuthorizationCookie对象时存在不安全的反序列化缺陷。未经身份验证的远程攻击者可以向WSUS的GetCookie()端点发送特制的请求，触发不安全的.NET BinaryFormatter反序列化机制，从而在目标服务器上以SYSTEM权限执行任意代码。该漏洞被评为CVSS 9.8分（满分10分），表明其影响极其严重，且攻击者无需任何身份凭证即可利用。威胁情报指出，此漏洞正被积极利用，攻击者常用于获取初始访问权限。

**受影响产品与版本**：该漏洞影响多个Windows Server版本，包括Windows Server 2025、Windows Server 2022、Windows Server 2019，以及低至Windows Server 2012的更早版本。

**利用条件**：虽然攻击本身是无需认证的远程代码执行，但研究发现，成功的利用需要攻击者预先获取目标WSUS服务器的AES解密密钥。一旦密钥被获取，攻击者便可构造恶意序列化载荷，并使用该密钥进行加密，然后发送至WSUS服务触发。

**POC有效性分析**：
所提供的POC代码`cve-2025-59287-encrypt.py`是一个Python脚本，其核心功能是实现对恶意.NET序列化载荷的AES-128-CBC加密。这个加密过程是利用CVE-2025-59287的关键一环，因为它模拟了WSUS在解密和反序列化AuthorizationCookie时的预期行为。脚本中包含了生成16字节非零salt的函数`get_non_zero_bytes`，并使用固定的全零16字节IV (`b'\x00' * 16`)进行加密，这些细节均与漏洞利用的特定要求相符。脚本接收一个Base64编码的字符串（代表恶意.NET序列化对象，例如通过YsoSerial.Net生成的gadget chain），并使用提供的AES密钥对其进行加密。

尽管该POC有效实现了载荷加密的关键步骤，但其`README.md`明确指出：“此EXP需要首先获取WSUS的密钥。此密钥需要通过其他攻击方法获取。”这意味着该POC并非一个完整的端到端漏洞利用工具，而是攻击链中的一个重要组成部分。它展示了如何正确加密恶意载荷，但未提供密钥获取机制。脚本中硬编码的`hex_key`（“877C14E433638145AD21BD0C17393071”）很可能是一个示例密钥。因此，要完整利用此漏洞，攻击者需要结合其他技术来获取目标WSUS服务器的实际解密密钥。基于此，该POC被评为6/10分，因为它功能完整，但依赖于一个外部先决条件。

**利用步骤（概念性）**：
1.  **获取WSUS解密密钥**：攻击者首先需要通过其他手段（例如信息泄露、其他漏洞利用等）获取目标WSUS服务器用于加密AuthorizationCookie的AES解密密钥。
2.  **生成恶意.NET载荷**：使用类似YsoSerial.Net的工具，构造一个恶意.NET序列化对象载荷。该载荷通常会利用特定的gadget chain，在反序列化时执行攻击者指定的命令。
3.  **加密载荷**：将生成的恶意.NET载荷进行Base64编码，并作为输入传递给`cve-2025-59287-encrypt.py`脚本。同时提供在步骤1中获取的WSUS解密密钥。脚本将按照WSUS预期的加密方式（AES-128-CBC，固定IV，生成非零salt）对载荷进行加密。
4.  **发送恶意AuthorizationCookie**：将加密后的载荷封装在一个AuthorizationCookie中，并通过HTTP请求发送到目标WSUS服务器的`GetCookie()`端点。
5.  **远程代码执行**：WSUS服务器接收到请求后，尝试解密并反序列化AuthorizationCookie的内容。由于其对.NET BinaryFormatter的使用存在安全缺陷且未进行充分的类型验证，服务器最终会执行攻击者注入的恶意代码，通常以SYSTEM权限运行，从而实现完全控制。根据报告，攻击者可能随后使用如PowerCat之类的工具获取系统shell。

**投毒风险分析**：
所提供的POC代码`cve-2025-59287-encrypt.py`的投毒风险评估为低（10%）。该脚本代码清晰、结构明确，其唯一目的是执行AES加密操作，以便为WSUS漏洞利用准备载荷。它不包含任何可疑行为或恶意功能。

**低风险的原因包括**：
1.  **代码透明**：脚本逻辑清晰，易于阅读和理解。没有使用任何代码混淆技术来隐藏其真实目的。
2.  **标准库依赖**：它仅依赖于Python的标准库（`base64`、`os`）以及`PyCryptodome`库（通过`Crypto.Cipher.AES`），这是一个广泛用于安全加密操作的第三方库。没有导入或使用任何非标准、来源不明或可能带有恶意功能的外部库。
3.  **无外部网络请求**：脚本本身不进行任何出站网络请求（例如下载文件、连接C2服务器），这意味着它不会主动从外部获取或发送数据，消除了这一常见的投毒途径。
4.  **无动态代码执行**：代码中没有使用如`eval()`或`exec()`等可能导致任意代码执行的函数，从而避免了通过输入数据引入恶意行为的风险。
5.  **目的明确**：脚本的核心功能是加密一个预定义的Base64字符串（`zfc`），该字符串代表了恶意载荷。脚本本身并非恶意载荷的生成者，而是其加密工具。因此，恶意性在于用户提供的`zfc`内容，而非加密脚本本身。用户在运行此POC时，可以清晰地审查其源代码，确认其仅执行载荷加密，而不附带任何额外的恶意操作。

综上所述，该POC是一个用于辅助漏洞利用的加密工具，其自身代码不包含任何恶意或可疑行为，对运行它的环境构成的投毒风险极低。

**项目地址:** N/A

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2025-59287
