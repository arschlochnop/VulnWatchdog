## CVE-2025-33073 - Windows Active Directory域服务, Windows SMB (包括Windows Server 2008 R2 for x64-based Systems Service Pack 1及后续版本，当SMB签名未强制启用时) NTLM反射绕过/DNS投毒/权限提升

**漏洞编号:** CVE-2025-33073

**漏洞类型:** NTLM反射绕过/DNS投毒/权限提升

**影响应用:** Windows Active Directory域服务, Windows SMB (包括Windows Server 2008 R2 for x64-based Systems Service Pack 1及后续版本，当SMB签名未强制启用时)

**危害等级:** 高危

**CVSS评分:** Not specified, but likely High (9.x)

**影响版本:** Windows Server 2008 R2 for x64-based Systems Service Pack 1 及其他SMB签名未强制启用的Windows版本

**利用条件:** 需要认证 (普通域用户权限), 需要网络访问, 目标SMB签名未强制执行, 攻击者需能添加恶意DNS记录

**POC 可用性:** 9/10

**POC 类型:** 完整利用

**攻击复杂度:** 中

**投毒风险:** 10%

## 详情

该PoC代码为“Obscura$ DNS Relay Injector + NTLM Coercion Tool”，旨在演示CVE-2025-33073漏洞的完整利用链。此漏洞是一个影响Windows Active Directory域服务的权限提升漏洞，核心在于通过DNS投毒和NTLM认证反射机制，允许具有普通域用户权限的攻击者在未强制执行SMB签名的域环境中，远程获取目标主机（非域控）的SYSTEM权限，进而可能导致全域沦陷。

**POC有效性分析:**
该PoC是一个精心设计的Python脚本，它成功地将多个已知的安全攻击技术串联起来，以实现CVE-2025-33073所描述的攻击效果。脚本通过调用`samba-tool`工具，首先实现恶意的DNS A记录注入，将攻击者控制的主机名解析到攻击者的IP地址，这是实施DNS投毒的关键一步。随后，PoC启动了广受认可的`impacket-ntlmrelayx`监听器，这是一个功能强大的NTLM中继工具，用于捕获和中继受害机器的认证请求。最后，PoC利用`rpcping`工具，通过Windows Print Spooler服务（MS-RPRN协议）的已知特性，强制目标Windows主机向之前注入的恶意DNS记录所指向的攻击者IP发起NTLM认证。这种组合攻击方式，利用了Windows认证机制中的深层次问题以及对SMB签名的默认不启用状态，在技术上完全符合对CVE-2025-33073的公开描述和分析。PoC的模块化设计和对成熟工具的集成，使其成为一个高度有效且可信的概念验证，能够清晰地展示漏洞的利用原理和潜在危害。

**利用步骤:**
1.  **环境准备:** 攻击者需准备一台Linux机器，确保已安装Python环境及所需的第三方库。同时，必须安装`samba-tool`（用于DNS操作）、`impacket`工具集（特别是`ntlmrelayx`模块，用于NTLM中继）以及`rpcping`（用于强制认证触发）。攻击机需要与目标域控制器和潜在受害主机（非域控）保持网络连通性。
2.  **恶意DNS记录注入:** 攻击者首先利用PoC脚本调用`samba-tool dns add`命令。此步骤要求攻击者拥有在域DNS服务器上添加或修改DNS记录的权限（根据CVE描述，普通域用户在某些配置下可实现），以注入一个恶意的A记录，将一个伪造的主机名（例如`spoofedhost.yourdomain.com`）解析到攻击者的IP地址。
3.  **验证DNS传播:** PoC会持续尝试通过`socket.gethostbyname_ex`解析该伪造的主机名，以确认恶意DNS记录已在域内DNS缓存中生效并传播开来，这是后续攻击成功的先决条件。
4.  **启动NTLM Relay监听器:** 一旦DNS记录传播成功，攻击者机器上的PoC会启动`impacket-ntlmrelayx`，进入监听状态，等待来自受害主机的NTLM认证请求。
5.  **强制目标认证 (Coercion):** PoC随后利用`rpcping`工具，向目标Windows主机的Print Spooler服务（通常是`\\pipe\\spoolss`命名管道）发起RPC请求。通过指定`spoofed_host`参数，强制目标主机尝试向攻击者伪造的主机名（实际指向攻击者IP）发起NTLM认证。
6.  **NTLM中继与权限提升:** 当目标主机进行认证时，其NTLM哈希或挑战-响应认证过程会被攻击者机器上的`ntlmrelayx`捕获并中继到预设的攻击目标（例如，在本地创建SYSTEM会话，或中继到域控制器进行认证，从而实现权限提升，例如在受害主机上以SYSTEM权限执行任意命令）。

**投毒风险分析:**
该PoC代码的投毒风险被评估为极低（10%）。这一判断基于对代码的详尽分析和其所使用的技术栈的理解。
首先，从代码本身来看，其结构清晰、逻辑简单直观。PoC的Python脚本没有使用任何形式的代码混淆技术，所有函数调用和参数传递都一目了然。攻击者所关注的核心功能，如DNS记录注入、NTLM监听启动和RPC强制认证触发，都通过调用外部的、业界公认的合法安全工具来实现，包括`samba-tool`、`impacket-ntlmrelayx`和`rpcping`。这些工具是渗透测试和漏洞研究领域的标准组件，它们本身的设计目的并非恶意，而是提供协议交互和安全分析功能。
其次，代码中没有发现任何可疑的网络行为迹象。例如，它不会尝试连接未知或不相关的外部IP地址、下载或执行远程脚本、或者与非预期的数据源进行通信。所有的网络交互都局限于攻击者、域控制器和目标受害主机之间，并且这些交互是攻击利用链的固有部分。
再次，脚本中不包含任何自我复制、持久化、数据窃取（除了漏洞利用过程中可能捕获的NTLM哈希用于中继）、勒索或破坏性功能。它是一个纯粹的功能性验证工具，专注于演示漏洞的利用路径。
最后，代码中也未发现使用`eval()`、动态加载库等可能被滥用的高风险函数。其对`subprocess.run`和`subprocess.Popen`的调用也是为了执行上述安全工具，其命令行参数都是硬编码或通过命令行参数清晰传递，没有动态构造恶意命令的迹象。
综上所述，虽然该PoC演示的是一个具有高危害性的漏洞利用，但PoC代码本身是“干净”的，不包含任何恶意投毒行为。其设计的初衷是帮助安全研究人员和防御者理解漏洞机制、进行测试和构建防御措施，而非作为恶意载荷的一部分。用户在使用时应主要关注其对目标系统的潜在影响，而非PoC代码自身的恶意性。

**项目地址:** N/A

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2025-33073
