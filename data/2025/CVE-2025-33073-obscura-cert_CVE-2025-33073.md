## CVE-2025-33073 - Windows Active Directory 认证绕过/权限提升/NTLM中继

**漏洞编号:** CVE-2025-33073

**漏洞类型:** 认证绕过/权限提升/NTLM中继

**影响应用:** Windows Active Directory

**危害等级:** 危急

**CVSS评分:** 

**影响版本:** 所有受影响的Windows Active Directory版本

**利用条件:** 需要具有DNS管理权限的凭证进行初始DNS注入（如POC所示），或通过其他方式实现DNS劫持；需要网络访问权限；需受害者被强制认证。

**POC 可用性:** 9

**POC 类型:** 完整利用

**攻击复杂度:** 中

**投毒风险:** 0%

## 详情

该POC演示了一个复杂的、多阶段的攻击，目标是Windows Active Directory环境，利用了一系列已知的弱点。其核心功能包括三个主要组成部分：DNS记录注入、NTLM中继和基于RPC的认证强制。此POC的有效性在于它能够将这些技术组合成一个无缝的攻击路径。

**POC有效性分析:**
该Python脚本通过调用已有的、受信任的安全工具来实现其目标。`impacket-ntlmrelayx`是一个被广泛认可的、强大的NTLM中继攻击工具，能够拦截并中继认证请求。`samba-tool`用于DNS记录注入，虽然需要管理员权限，但在Samba/AD环境中是合法的DNS操作方法，证明了具备足够初始访问权限的攻击者可以修改DNS记录这一概念。最后，`rpcping`被用于触发MS-RPRN（打印系统远程协议）强制认证，这是一个已知的漏洞（概念上类似于PetitPotam或PrintNightmare），它强制域控制器或其他Windows主机向攻击者控制的端点进行认证。通过结合这些组件，POC建立了一个可信的威胁模型：攻击者首先操作DNS以重定向认证尝试，然后触发受害者机器（如域控制器）向攻击者进行认证，最后将这些凭据中继到敏感服务，从而可能实现完全的域控制。脚本结构模块化，清晰，展示了对这些攻击原语的高度技术理解。它成功地将理论攻击链转化为一个实用的、尽管依赖于凭据的利用。`subprocess.run`调用直接且可预测，使得代码易于审计并理解其确切行为。错误处理基本但足以满足概念验证的需求。

**利用步骤:**
1.  **环境设置:** 攻击者必须具备一个Linux环境，并安装`impacket`（特别是`impacket-ntlmrelayx`）、`samba-tool`和`rpcping`，并确保它们在系统PATH中可访问。`main.py`脚本应该可用。
2.  **预利用访问:** 对于POC（如代码所示）而言，关键的先决条件是拥有目标DNS服务器（通常是域控制器）的管理员级别凭据。这允许`samba-tool`注入恶意DNS `A`记录。或者，如果`CVE-2025-33073`漏洞允许未经认证的DNS注入，或者DNS可以通过其他方式被污染，则此步骤的要求可能会改变，但POC本身需要这些凭据。
3.  **执行DNS注入:** 运行`main.py`脚本，并提供`--dns-ip`、`--dc-fqdn`、`--spoofed-name`和`--attacker-ip`参数。脚本将使用`samba-tool`和提供的管理员凭据添加一条`A`记录，将选定的`spoofed-name`映射到目标域内的攻击者IP地址。例如，`python main.py --attacker-ip 192.168.1.100 --dns-ip 192.168.1.10 --dc-fqdn mydomain.local --spoofed-name evilserver`。
4.  **DNS传播验证:** 脚本包含一个循环，用于验证新注入的DNS记录是否已传播并解析到攻击者的IP。这确保随后的NTLM强制认证会将受害者引导到攻击者的监听器。
5.  **启动NTLM中继监听器:** 在后台，脚本通过`subprocess.Popen`调用启动`impacket-ntlmrelayx.py`。此监听器使用`-t <target>`参数配置（可能指向另一个敏感服务或DC进行中继），并带有`--no-smb-server`标志。此监听器等待来自被强制认证的受害者的NTLM认证尝试。
6.  **触发认证强制:** 脚本随后执行`rpcping`连接到`victim_ip`（通常是域控制器）上的`\\pipe\\spoolss`命名管道。通过指定`spoofed_host`（DNS注入步骤中的`spoofed-name.dc-fqdn`），受害者机器被诱骗尝试向此伪造主机进行认证，该主机解析到攻击者的NTLM中继监听器。这种强制认证技术利用了MS-RPRN协议的行为。
7.  **中继与捕获:** 受害者的NTLM认证尝试被攻击者机器上的`impacket-ntlmrelayx`拦截。`ntlmrelayx`工具随后将这些凭据中继到指定的目标，可能执行添加用户、转储哈希或获得shell访问等操作，具体取决于中继的服务和目标。这完成了完整的利用链，使攻击者可能获得Active Directory域内的高权限。

**投毒风险分析:**
提供的CVE-2025-33073的POC代码，位于`obscura-cert/CVE-2025-33073`仓库中，投毒风险极低，评级为0%。此评估基于对其源代码、依赖项和操作方法的全面分析。

首先，代码是用Python编写的，这是一种被广泛理解且易于审计的语言。没有使用混淆、加密或其他技术来隐藏其真实功能。所有操作，包括参数解析、函数定义和系统调用，都以透明的方式呈现。这种清晰性使得任何安全研究员或分析师都可以逐行审查代码，并确认其确切行为。

其次，POC的核心功能完全依赖于通过`subprocess.run`和`subprocess.Popen`调用已有的、开源的安全工具和标准操作系统实用程序。这些外部工具包括：
*   `samba-tool`: 一个用于管理Samba和Active Directory域的合法实用程序，此处用于DNS记录操作。
*   `impacket-ntlmrelayx`: Impacket工具包的一个组件，Impacket是公认的、受信任的Python类集合，用于以编程方式访问网络协议，广泛用于渗透测试和红队活动。其NTLM中继功能是一种标准技术。
*   `rpcping`: 一个合法的Windows实用程序（或其Linux对应实现），用于测试RPC连接。在此处，它用于通过MS-RPRN协议触发认证强制，这是一个已知的攻击向量。

依赖这些外部的、声誉良好的工具意味着`main.py`脚本本身主要充当协调器。它不包含任何自定义构建的、潜在恶意的payload或未经安全社区广泛审查的exploit代码。因此，此POC的风险主要源于其演示的攻击技术的**滥用**，而不是POC脚本本身内嵌的任何恶意代码。

此外，`README.md`明确声明了免责条款：“仅用于授权的安全测试和教育用途。严禁未经授权的使用。作者不对滥用行为负责。”这一声明强调了该工具创建背后的防御性和道德意图。没有任何迹象表明它试图回连、从未知服务器下载额外阶段、安装持久性后门，或执行任何与其描述的演示NTLM中继攻击链目的无关的行为。

输入参数明确定义，与目标环境的交互仅限于标准网络协议和管理接口。除了NTLM中继本身固有的权限提升（这是正在演示的漏洞）之外，没有出现意外的网络请求、超出临时进程创建范围的文件系统修改或任何其他非预期行为。

总之，`obscura-cert/CVE-2025-33073` POC是一个干净、文档齐全、透明的安全研究工具。其极低的投毒风险使其适合在授权环境中进行合法的防御性安全研究、威胁情报分析和受控测试，无需担心嵌入恶意payload。

**项目地址:** https://github.com/obscura-cert/CVE-2025-33073

**漏洞详情:** 
