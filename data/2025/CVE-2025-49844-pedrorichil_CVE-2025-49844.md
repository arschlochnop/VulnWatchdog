## CVE-2025-49844 - Redis Use-After-Free (UAF) leading to Remote Code Execution (RCE)

**漏洞编号:** CVE-2025-49844

**漏洞类型:** Use-After-Free (UAF) leading to Remote Code Execution (RCE)

**影响应用:** Redis

**危害等级:** Critical

**CVSS评分:** 10.0

**影响版本:** All Redis versions before 8.2.2, 8.0.4, 7.4.6, 7.2.11 (e.g., 8.2.1 and below, 7.2.0 is vulnerable)

**利用条件:** Requires authentication (low privilege user) and network access to execute specially crafted Lua scripts.

**POC 可用性:** 9/10

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 5%

## 详情

CVE-2025-49844，也被称为“RediShell”，是Redis Lua脚本引擎中发现的一个严重的使用后释放（Use-After-Free, UAF）漏洞。Redis作为一个广泛使用的开源内存键值数据库，支持通过Lua脚本执行复杂的操作。该漏洞的根源在于Redis的Lua引擎在处理内存时存在缺陷，特别是与TString变量相关的操作。根据已有的分析，当一个TString变量未被正确地写入Lua栈时，垃圾回收器（GC）在触发时，由于栈上缺乏对该变量的强引用，可能导致该TString变量被过早地回收。随后，诸如luaX_setinput等函数试图访问这块已被释放的内存时，便会触发UAF条件。

拥有低权限或以上认证的攻击者，只要具备执行Lua脚本的能力，就可以精心构造恶意Lua脚本来利用这一UAF漏洞。通过对已释放内存的巧妙操纵，攻击者可以实现任意内存读写，最终将漏洞升级为在Redis服务器宿主系统上的远程代码执行（RCE）。由于Redis实例经常存储敏感数据，并且在许多应用程序架构中扮演着核心角色，因此该漏洞的危害等级被评定为严重，CVSS评分高达10.0。一旦成功利用，攻击者将完全控制受感染的Redis实例，并可能进一步控制底层服务器系统。

**POC有效性分析及利用步骤：**

所提供的概念验证（POC）代码是一个结构清晰、高度有效的测试环境，用于复现和理解CVE-2025-49844。该POC包含一个`Dockerfile`和一个`README.md`文件，旨在创建一个受控的、易于复现的实验环境。

`Dockerfile`负责构建一个基于`redis:7.2.0`的易受攻击Redis实例，该版本已被明确列为受影响的版本。为了便于漏洞利用，`Dockerfile`特意将Redis配置为不安全的模式，例如设置`protected-mode no`并绑定到`0.0.0.0`，从而确保Redis服务器可以从主机访问且默认无需密码。这种透明且明确的配置，最大程度地降低了在测试过程中环境安全状态的歧义。

`README.md`提供了全面的设置和运行指南，详细列出了先决条件（Docker、Docker Compose以及Python的`redis`和`colorama`库），并提供了使用`docker-compose up -d`启动易受攻击Redis实例的分步命令。之后，它指导用户验证Redis服务并执行攻击。利用的核心是通过`exploit_poc.py`脚本（未完全提供，但功能描述详尽）完成的。该脚本支持多种模式，包括`check`（验证漏洞）、`basic`（触发基本UAF）、`sandbox`（测试沙箱逃逸）、`advanced`（进行更复杂的内存破坏）和`all`（运行所有测试）。这种模块化设计表明这是一个强大而全面的利用框架，能够演示攻击链的不同阶段，从漏洞检测到完全的RCE。描述中提及的“Successful Test (Vulnerable Version)”输出进一步证实了POC在确认漏洞方面的有效性。

**利用步骤：**
1.  **安装先决条件**：确保系统上已安装Docker、Docker Compose，以及带有`redis`和`colorama`库的Python环境。
2.  **设置环境**：导航至包含`Dockerfile`和`README.md`的目录。
3.  **启动易受攻击的Redis**：执行`docker-compose up -d`命令以构建并启动Redis 7.2.0实例。这将创建一个运行有为漏洞利用而特意配置的不安全Redis服务的容器。
4.  **等待初始化**：等待几秒钟，确保Docker容器内的Redis服务器完全启动。`README`中建议的`sleep 5`命令提供了参考。
5.  **验证Redis状态（可选）**：可以使用`docker-compose ps`命令确认Redis容器是否正在运行。
6.  **执行漏洞利用**：运行`exploit_poc.py`脚本。如需全面测试，可使用`python3 exploit_poc.py -H localhost -p 6380 -m all`。如果Redis实例需要认证（尽管提供的Dockerfile未设置`requirepass`），可使用`-a "password"`选项。
7.  **监控日志**：在漏洞利用过程中，可以使用`docker-compose logs -f`命令观察Redis服务器的活动日志。
8.  **清理环境**：测试完成后，使用`docker-compose down`停止实验室环境，或者使用`docker-compose down -v`彻底移除所有相关数据。

**投毒风险分析：**

基于提供的`Dockerfile`和`README.md`文件，该特定POC的投毒风险非常低。作者精心设计此实验环境，旨在用于合法的防御性安全研究和教育目的。

`Dockerfile`明确用于构建一个易受攻击的Redis实例。其中进行的修改（如`protected-mode no`和`bind 0.0.0.0`）仅是为了将目标Redis服务器配置为可被利用的状态，而并非向用户的主机系统注入恶意代码。`Dockerfile`内部的注释，如“WARNING: This is intentionally insecure for lab testing only!”（警告：这仅为实验室测试故意设置为不安全），清晰地表明了其目的。

`README.md`通过多处显著的警告进一步强调了这一点：“This is for educational purposes only!”（这仅用于教育目的！）、“Only use on systems you own or have explicit permission to test”（仅在您拥有或获得明确许可的系统上使用）、“Never expose to the internet”（切勿暴露在互联网上）以及“Never use in production environments”（切勿用于生产环境）。这些警告对于指导用户负责任地使用POC、防止意外的自我伤害或暴露至关重要。

目前没有证据表明POC文件中存在混淆代码、可疑的外部网络请求或包含非标准、不受信任的依赖项。`exploit_poc.py`（虽未提供完整代码）被描述为“针对Redis的利用程序”，这意味着其恶意行为（如远程代码执行）是针对**目标Redis服务器**，而非运行`exploit_poc.py`脚本的用户系统。所列出的Python依赖（`redis`、`colorama`）都是标准且经过充分验证的库。因此，用户在按照提供的说明下载并运行**此特定POC**时，因POC代码本身而被“投毒”的风险极低。主要的风险将来源于用户无视警告，将故意设置为易受攻击的Redis实例暴露于不受信任的网络中，使其成为外部攻击者的目标，或者在生产系统上运行它，从而影响关键操作。然而，这属于误用风险，而非POC内在的恶意性。基于这些原因，投毒风险评估为非常低，约为5%。

**项目地址:** https://github.com/Yuri08loveElaina/CVE-2025-49844

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2025-49844
