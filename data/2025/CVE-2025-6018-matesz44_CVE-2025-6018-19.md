## CVE-2025-6018 - Linux PAM, libblockdev (特别是SUSE 15, 银河麒麟Linux及其他受影响的Linux发行版) 本地权限提升 (LPE)

**漏洞编号:** CVE-2025-6018

**漏洞类型:** 本地权限提升 (LPE)

**影响应用:** Linux PAM, libblockdev (特别是SUSE 15, 银河麒麟Linux及其他受影响的Linux发行版)

**危害等级:** 高危 (High)

**CVSS评分:** 

**影响版本:** SUSE 15及使用受影响PAM/libblockdev组件的其他Linux发行版

**利用条件:** 需要本地非特权用户访问

**POC 可用性:** 9/10

**POC 类型:** 完整利用 (Full Exploit)

**攻击复杂度:** 中 (Medium)

**投毒风险:** 0%

## 详情

提供的POC脚本，`CVE-2025-6018-19.sh`，是一个强大且功能完整的利用链，针对两个独立但相关的本地权限提升（LPE）漏洞：CVE-2025-6018（存在于SUSE 15的PAM中）和CVE-2025-6019（存在于libblockdev通过udisks中）。该脚本有效演示了在受影响的Linux系统（尤其是SUSE 15）上，从非特权本地用户账户逐步升级权限到root级shell的多阶段攻击路径。

**POC有效性分析:**
该POC脚本结构清晰，采用shell脚本编写，包含`xfs`、`pam`和`root`三个核心函数，分别对应漏洞利用的不同阶段。
1.  **`xfs`函数**：此阶段主要负责攻击前的准备工作。它会在攻击者本地机器或具有root权限的环境中创建一个名为`xfs.image`的文件。这个镜像文件被格式化为XFS文件系统，并在其中复制`/bin/bash`可执行文件，并为其设置SUID（Set User ID）位，同时将文件所有者设为root。这意味着一旦这个特殊的bash被执行，它将以root权限运行。此步骤是任何基于SUID的LPE攻击的常见组成部分，旨在为后续的权限提升提供一个“后门”二进制。脚本还包含对`mkfs.xfs`工具可用性的检查，确保环境准备就绪。
2.  **`pam`函数**：此函数针对CVE-2025-6018进行利用。该漏洞存在于SUSE 15的PAM配置中，允许非特权用户通过操纵特定环境变量来获得`allow_active`权限。脚本通过在用户主目录创建`.pam_environment`文件，并写入`XDG_SEAT OVERRIDE=seat0`和`XDG_VTNR OVERRIDE=1`等变量来实现。一旦该文件创建成功，用户需要退出当前会话并重新认证（例如重新登录SSH或控制台），以触发PAM模块的漏洞，从而将当前用户的权限从普通级别提升到具备`allow_active`状态。这个状态是利用CVE-2025-6019的必要前提，因为它赋予了用户与D-Bus系统服务（如UDisks2）进行特定交互的能力。
3.  **`root`函数**：此函数是整个攻击链的最终阶段，旨在利用CVE-2025-6019，将已获得的`allow_active`权限进一步提升至完全的root权限。脚本首先会检查用户是否已处于`allow_active`状态；如果不是，它会提示用户执行`pam`阶段并重新认证。一旦确认具备`allow_active`权限，脚本会终止`gvfs-udisks2-volume-monitor`进程，然后使用`udisksctl loop-setup`命令将之前准备好的`xfs.image`挂载为循环设备。接下来，利用核心的漏洞触发机制，通过`gdbus call`命令调用`org.freedesktop.UDisks2.Filesystem.Resize`方法，并传入特定的参数。这个操作会触发libblockdev库中的权限提升漏洞，可能涉及竞态条件或不当的权限检查，最终导致`xfs.image`中具备SUID位的`/bash`以root权限被执行。脚本随后会直接执行这个root权限的`/bash`，为攻击者提供一个交互式的root shell。
总而言之，该POC脚本设计精巧，清晰地展现了如何通过多阶段攻击，利用两个漏洞协同作用，从本地非特权用户完全控制目标系统。脚本的用户友好性体现在其清晰的用法说明和错误处理机制。

**利用步骤:**
1.  **环境准备**：在攻击者机器或具有root权限的本地环境中，执行`sh CVE-2025-6018-19.sh xfs`。这将生成一个名为`xfs.image`的特制XFS镜像文件，其中包含一个具有SUID位且属于root用户的bash可执行文件。
2.  **镜像传输**：将生成的`xfs.image`文件安全地传输到目标受害Linux系统上的任意可写目录，例如`/tmp`或用户主目录。
3.  **权限提升至`allow_active`**（CVE-2025-6018利用）：
    *   在目标系统上，使用受害的非特权用户身份登录，并执行命令`sh CVE-2025-6018-19.sh pam`。
    *   该脚本将在当前用户的主目录创建`.pam_environment`文件。
    *   根据脚本提示，用户需要退出当前会话（如`exit` SSH会话）并重新登录。重新登录后，由于PAM漏洞被触发，用户的权限将提升到`allow_active`状态。
4.  **获取Root权限**（CVE-2025-6019利用）：
    *   在确认已获得`allow_active`权限后，再次以该用户身份执行命令`sh CVE-2025-6018-19.sh root`。
    *   脚本将利用UDisks2和libblockdev漏洞，挂载`xfs.image`并触发权限提升。
    *   成功利用后，攻击者将获得一个交互式的root shell，从而完全控制目标系统。

**投毒风险分析:**
该POC脚本的投毒风险评估为**低（0%）**。作为专业的防御性安全研究人员，我们必须区分漏洞利用代码本身和潜在的恶意投毒行为。该脚本的目标是明确的：演示和实现本地权限提升。
1.  **代码透明性**：脚本以纯shell形式编写，代码逻辑清晰，易于阅读和审计。它没有使用任何形式的代码混淆技术，所有操作都显式地在脚本中展示。
2.  **无额外恶意载荷**：脚本的行为严格限于漏洞利用链的每一步。它不包含任何与LPE目的无关的附加恶意功能，例如：
    *   没有进行未经授权的外部网络通信（如C2回调、数据外传）。
    *   没有下载或执行来自未知来源的二进制文件或脚本。
    *   没有尝试安装持久化后门程序（除了LPE本身提供的SUID bash）。
    *   没有集成勒索软件、挖矿程序或其他商业恶意软件的逻辑。
    *   没有通过`eval`或其他动态执行方法隐藏恶意代码。
3.  **标准LPE技术**：脚本利用SUID bash作为获得root权限的最终手段，这是LPE攻击中一种非常常见且透明的技术。这个SUID bash是漏洞利用成功后的预期结果，而非POC作者额外植入的“投毒”载荷。
4.  **可控性**：在受控的测试环境中，该脚本的行为是完全可预测的。研究人员可以精确观察其对系统文件（如`.pam_environment`）和进程（如`gvfs-udisks2-volume-monitor`）的影响，以及最终获得root shell的过程。
综上所述，该POC代码严格遵循了漏洞概念验证和完整利用的范畴，其目的是为安全研究和防御提供洞察，而非秘密地对系统进行二次投毒。真正的风险在于恶意攻击者利用此类POC代码，并在此基础上添加真正的恶意载荷来发起实际攻击。因此，该POC代码本身不构成投毒风险。

**项目地址:** N/A

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2025-6018
