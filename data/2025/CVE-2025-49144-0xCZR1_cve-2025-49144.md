## CVE-2025-49144 - Notepad++ 权限提升 (Privilege Escalation)，远程代码执行 (Remote Code Execution)

**漏洞编号:** CVE-2025-49144

**漏洞类型:** 权限提升 (Privilege Escalation)，远程代码执行 (Remote Code Execution)

**影响应用:** Notepad++

**危害等级:** 高危

**CVSS评分:** CVSS:3.1/AV:L/AC:L/PR:N/UI:R/S:U/C:H/I:H/A:H

**影响版本:** v8.8.1 安装程序

**利用条件:** 需要用户交互，本地文件放置，攻击者需要诱骗用户运行恶意目录下的安装程序。

**POC 可用性:** 9/10

**POC 类型:** 完整利用

**攻击复杂度:** 中

**投毒风险:** 10%

## 详情

该漏洞（CVE-2025-49144）存在于Notepad++ v8.8.1版本的安装程序中，其核心问题是安装程序在尝试执行`regsvr32`命令时，未能正确引用其路径或使用绝对路径进行调用。根据POC代码的分析，安装程序在寻找`regsvr32.exe`时，会优先在其当前工作目录（即安装程序所在的目录）中进行查找。这一行为允许攻击者利用“未引用路径搜索顺序劫持”（Unquoted Path Search Order Hijacking）或“DLL劫持”类似机制，将一个恶意可执行文件命名为`regsvr32.exe`并放置在与Notepad++安装程序相同的目录下。当合法用户运行Notepad++安装程序时，该恶意`regsvr32.exe`将会在安装程序的上下文下被执行，由于安装程序通常以SYSTEM权限运行，这导致了本地权限提升至SYSTEM，并实现了任意代码执行（RCE）。

**POC有效性分析：**
提供的POC代码充分且有效地验证了该漏洞的存在及其可利用性。POC由三个主要部分组成：
1.  **C# Payload (`PoC.cs`)：** 这是一个简单的C#程序，其功能是在`C:\Windows\Temp\`目录下创建一个名为`NOTEPAD_VULNERABIL.txt`的文本文件，并在其中写入特定字符串，以证明代码已被成功执行。这是一个无害但直观的测试用例。
2.  **Shellcode生成：** C# Payload通过`donut`工具被转换为Shellcode，这是将托管代码转换为非托管可执行二进制数据的常用技术，以便在内存中直接执行。
3.  **C Loader (`main.c`)：** 这是一个标准的C语言程序，负责将之前生成的Shellcode加载到内存中，并利用`VirtualAlloc`、`RtlMoveMemory`和`VirtualProtect`等Windows API函数分配可执行内存、将Shellcode复制进去，并最终通过`CreateThread`创建新线程来执行Shellcode。这个C程序随后被编译为`regsvr32.exe`。
整个POC的流程逻辑严谨，技术实现可靠。当这个恶意的`regsvr32.exe`与Notepad++ v8.8.1安装程序置于同一目录并运行安装程序时，可以预期我们的恶意`regsvr32.exe`会被调用并以SYSTEM权限执行，从而成功在`C:\Windows\Temp\`目录下创建文件。这证明了攻击者可以通过此漏洞在受害者系统上以最高权限执行任意代码，对系统的机密性、完整性和可用性造成严重影响。POC的完整性（提供源代码、解释编译和利用过程）使其具有高度的参考价值和可重现性。

**利用步骤：**
1.  **准备恶意Payload：** 攻击者首先需要创建一个恶意Payload。POC中展示的是一个写入文本文件的C#程序，但在实际攻击中，这可以替换为任意恶意代码，例如建立反向Shell、植入木马、擦除数据等。
2.  **生成Shellcode：** 使用`donut`或其他类似工具将Payload（例如编译后的C#程序集）转换为Shellcode，以便在内存中执行。
3.  **编写和编译Loader：** 攻击者需要编写一个简单的C或C++程序（如POC中的`main.c`），该程序能够加载并执行上述生成的Shellcode。然后，将此Loader程序编译为一个名为`regsvr32.exe`的可执行文件。
4.  **放置恶意文件：** 获取受漏洞影响的Notepad++ v8.8.1安装程序。将合法安装程序和恶意`regsvr32.exe`文件放置在同一个目录下。
5.  **社会工程学或诱骗：** 攻击者需要通过社会工程学手段（如钓鱼邮件、恶意网站下载、USB投放等）诱骗受害者下载并执行此目录下的Notepad++安装程序。
6.  **漏洞触发与权限提升：** 当受害者运行Notepad++安装程序时，安装程序在尝试调用`regsvr32.exe`时，由于未引用路径的问题，会优先在其当前工作目录中找到并执行攻击者放置的恶意`regsvr32.exe`。此时，恶意代码将以SYSTEM权限运行，完成攻击者的预定操作。

**投毒风险分析：**
鉴于这是合法防御性安全研究，对提供的POC代码进行投毒风险评估至关重要。
*   **代码清晰度与透明度：** 提供的POC代码（C# Payload和C Loader）非常清晰和简洁，没有明显的代码混淆、加密或复杂嵌套结构。所有代码逻辑都易于理解，其意图是为了证明漏洞的可利用性，即写入一个无害的文本文件。
*   **外部依赖与请求：** POC代码中没有发现任何对外部网络资源（如下载恶意负载、C2服务器通信）的请求，也没有使用非标准库或不常见的系统调用。其行为完全局限于本地文件系统操作和内存执行。
*   **恶意行为模式：** POC的核心功能是创建并写入一个文本文件。这是一种低风险行为，旨在证明权限提升和代码执行能力，而非执行实际的恶意操作。在整个代码中，没有检测到任何诸如启动后门、删除关键文件、窃取数据或进行其他恶意系统修改的指令。
*   **供应链风险：** POC通过提供完整的代码片段，降低了使用者从未知源获取或编译潜在恶意代码的风险。研究人员可以自行审查、编译和验证。没有迹象表明POC依赖于外部编译服务或包含预编译的、来源不明的二进制文件。
*   **总结：** 综合来看，该POC代码的投毒风险评估为**低风险 (0-29%)**。其设计目的是为了安全地验证Notepad++安装程序中的权限提升漏洞，并以最小的副作用证明其有效性。对于防御性安全研究人员而言，直接使用此POC进行测试是相对安全的。然而，在实际环境中，研究人员应始终警惕任何可能被修改或封装了额外恶意功能的POC，并对所有来源不明的代码进行彻底的安全审计。

**项目地址:** N/A

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2025-49144
