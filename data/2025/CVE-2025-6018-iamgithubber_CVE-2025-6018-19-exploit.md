## CVE-2025-6018 - Linux (PAM, udisks), 针对openSUSE Leap 15 / SLES 15发行版 本地权限提升 (LPE)

**漏洞编号:** CVE-2025-6018

**漏洞类型:** 本地权限提升 (LPE)

**影响应用:** Linux (PAM, udisks), 针对openSUSE Leap 15 / SLES 15发行版

**危害等级:** 高危

**CVSS评分:** 8.8

**影响版本:** 几乎所有主流Linux发行版（Ubuntu、Debian、Fedora、openSUSE等），特别是openSUSE Leap 15 / SLES 15

**利用条件:** 需要本地普通用户权限，通过SSH/TTY会话可利用

**POC 可用性:** 9/10

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 10%

## 详情

CVE-2025-6018和CVE-2025-6019是Qualys威胁研究小组披露的一对高危本地权限提升漏洞，它们可以组合成一个强大的漏洞利用链，允许本地普通用户提升权限到root。这个漏洞链对几乎所有主流Linux发行版，包括Ubuntu、Debian、Fedora和openSUSE，都构成了威胁。

**CVE-2025-6018**：此漏洞主要与PAM (Pluggable Authentication Modules) 的配置缺陷有关，特别是在openSUSE Leap 15和SLES 15版本中。问题根源在于PAM规则错误地检查了XDG_SEAT和XDG_SESSION_CLASS等环境变量，导致系统误将任何SSH或TTY会话视为“本地控制台”会话。这种误判绕过了Polkit策略的限制，使得远程登录的非特权用户能够执行通常仅限于本地控制台用户的特权操作。

**CVE-2025-6019**：此漏洞存在于udisks守护进程中。udisks负责处理磁盘挂载和管理，在挂载文件系统时会调用libblockdev库。该漏洞允许一个具有活跃会话的非特权用户（通过CVE-2025-6018的利用可以获得此条件）来挂载特制的XFS或BTRFS文件系统镜像。攻击者可以在这些特制镜像中嵌入SUID root二进制文件。当系统在udisks的上下文中挂载此类镜像时，后续执行其中的SUID二进制文件便可实现权限提升。

**POC有效性分析**：
所提供的POC代码由两个Bash脚本组成：`attacker.sh`和`victem.sh`，它们清晰地展示了如何利用这两个漏洞实现本地权限提升。`attacker.sh`负责攻击者的设置：它首先创建一个简单的C语言SUID root shell程序，将其编译并设置SUID位。接着，它使用`dd`和`mkfs.xfs`命令创建一个XFS文件系统镜像，并将编译好的`rootshell`拷贝到该镜像中。最后，它启动一个Python HTTP服务器来托管这个恶意镜像。`victem.sh`则模拟了受害者端本地普通用户的操作：它通过设置`XDG_SEAT`、`XDG_SESSION_ID`和`XDG_VTNR`环境变量来欺骗Polkit，使其将当前会话识别为“活跃的本地控制台会话”，从而绕过CVE-2025-6018的限制。接着，它从攻击者的HTTP服务器下载恶意`exploit.img`，并利用`udisksctl loop-setup`和`udisksctl mount`命令在`udisks`守护进程的帮助下挂载该镜像（利用CVE-2025-6019）。一旦镜像被成功挂载，`victem.sh`便会执行镜像中包含的`rootshell`二进制文件，从而获取root权限。整个流程自动化、逻辑清晰，高度还原了漏洞利用链，因此该POC被评估为高度有效且可直接复现。

**利用步骤**：
1.  **攻击者准备 (`attacker.sh`)**：
    *   生成`rootshell.c`（一个简单的C程序，用于`setuid(0)`、`setgid(0)`并执行`/bin/bash`）。
    *   使用`gcc`编译`rootshell.c`为`rootshell`，并设置SUID权限（`chmod +s rootshell`）。
    *   使用`dd`命令创建`exploit.img`文件，并使用`mkfs.xfs`将其格式化为XFS文件系统。
    *   将`exploit.img`挂载到临时目录，把`rootshell`拷贝进去，然后卸载。
    *   启动Python HTTP服务器（`python3 -m http.server 8000`）来托管`exploit.img`。
2.  **受害者端利用 (`victem.sh`)**：
    *   在受害系统上，普通用户通过设置`XDG_SEAT`、`XDG_SESSION_ID`和`XDG_VTNR`环境变量来伪造Polkit会话，绕过PAM权限检查（CVE-2025-6018）。
    *   使用`curl`从攻击者IP地址的HTTP服务器下载`exploit.img`。
    *   使用`udisksctl loop-setup`命令设置一个循环设备来关联`exploit.img`。
    *   利用`udisksctl mount`命令挂载该循环设备，由于Polkit会话伪造，该操作被允许执行（CVE-2025-6019）。
    *   找到挂载点，并执行挂载镜像中的`rootshell`二进制文件，成功提升至root权限。

**投毒风险分析**：
对提供的POC代码进行详细分析后，可以判定其投毒风险为较低（10%）。这种评估是基于以下几个关键因素：

首先，**代码的透明度极高**。两个POC脚本（`attacker.sh`和`victem.sh`）均以纯粹的Bash编写，且包含了清晰的注释，使得任何具备基本Shell脚本知识的人都能够轻松阅读并理解其功能。特别是，攻击者端生成的`rootshell.c`的C语言源代码也直接嵌入在脚本中，其功能（`setuid(0); setgid(0); execl("/bin/bash", "sh", NULL);`）一目了然，即创建一个标准的root权限Shell。这种完全公开、无混淆的代码结构极大地降低了隐藏恶意行为的可能性。没有使用编码、加密或复杂的间接调用来模糊其真实意图。

其次，**依赖性明确且常见**。POC所依赖的工具和命令都是主流Linux发行版中常见的标准系统工具，例如`gcc`（编译器）、`dd`（数据拷贝）、`mkfs.xfs`（XFS文件系统创建）、`sudo`（权限管理）、`mount`/`umount`（文件系统挂载）、`python3 -m http.server`（内置HTTP服务器）、`curl`（数据传输）、`loginctl`（会话管理）、`udisksctl`（udisks管理）、`losetup`（循环设备管理）、`awk`/`grep`（文本处理）。这些工具的用途广为人知，且在POC中的调用方式符合其正常功能，没有滥用其特性来执行意外操作。没有引入未知或可疑的第三方库或二进制文件，从而避免了通过外部组件引入漏洞或恶意代码的风险。

第三，**缺乏额外的恶意负载或持久化机制**。POC的核心目标是演示权限提升，并通过提供一个root Shell来完成这一目标。除了这个预期结果（即一个具有root权限的Shell），代码中没有发现任何尝试进行数据窃取、建立持久性后门（除SUID Shell本身，这是漏洞利用的直接结果而非附加恶意行为）、修改非预期系统文件、连接到未知C2（命令与控制）服务器或执行其他侧面攻击行为的代码。`attacker.sh`仅搭建一个本地HTTP服务来分发恶意镜像，`victem.sh`也仅专注于下载、挂载和执行镜像中的SUID程序。整个过程不涉及复杂的网络通信或隐蔽的数据传输。

最后，**核心的“恶意”部分是可控的**。虽然`exploit.img`中包含的`rootshell`是一个具有恶意意图（获取root权限）的payload，但这个payload本身是由`attacker.sh`在本地透明生成的，而不是从外部未知来源获取的。这意味着研究人员可以完全审查这个payload的源代码和行为，确保它不包含超越获取root权限之外的任何恶意功能。这与那些从远程不可信源下载并执行预编译二进制文件或模糊脚本的POC有本质区别，后者往往伴随着更高的投毒风险。

综上所述，由于POC代码的高度透明性、对常见系统工具的合理使用、缺乏额外恶意负载以及对核心payload的可控性，可以认为其作为漏洞研究和验证的工具，被恶意投毒的风险极低。

**项目地址:** N/A

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2025-6018
