## CVE-2025-32463 - Sudo 本地提权 (Local Privilege Escalation)

**漏洞编号:** CVE-2025-32463

**漏洞类型:** 本地提权 (Local Privilege Escalation)

**影响应用:** Sudo

**危害等级:** Critical

**CVSS评分:** 9.3

**影响版本:** Sudo versions 1.8.8 to 1.9.17 (inclusive), specifically 1.9.14 to 1.9.17, fixed in 1.9.17p1

**利用条件:** 本地用户访问，不要求预先具备sudo权限，利用了sudo的--chroot选项功能。

**POC 可用性:** 10/10

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 10%

## 详情

该漏洞被识别为CVE-2025-32463，是Linux系统中`sudo`工具的一个关键本地提权（LPE）缺陷。该漏洞的CVSSv3评分为9.3，表明其影响严重。它允许非特权本地用户通过利用`sudo`处理`--chroot`选项的方式中的缺陷，结合Name Service Switch (NSS) 机制来获取root权限。该漏洞在Sudo v1.9.14（2023年6月）中引入，影响1.8.8至1.9.17（含）版本，并在1.9.17p1版本中修复。根本原因在于`sudo`的命令匹配和处理代码，特别是`plugins/sudoers/sudoers.c`文件，当涉及`--chroot`选项时未能正确处理相关情况。本质上，`sudo`可以被欺骗性地从用户控制的chroot环境中加载一个恶意的`nsswitch.conf`文件，然后该文件指示`sudo`加载一个恶意的NSS库。这个由攻击者精心制作的恶意库将以root权限执行代码，从而为非特权用户提供一个root shell。此漏洞对系统安全构成严重威胁，允许本地攻击者完全控制受影响的系统。

**POC有效性分析**:
提供的概念验证（POC）代码`exploit.py`非常有效，展示了CVE-2025-32463的完整工作漏洞利用。该Python脚本结构良好，并自动化了整个利用过程。它在`/tmp`中动态创建一个临时目录，作为攻击者控制的chroot环境。在这个临时目录中，它为漏洞利用构建了必要的组件：
1. 一个名为`woot1337.c`的C源代码文件，包含恶意payload。该payload使用`__attribute__((constructor))`确保`woot()`在库加载时执行。`woot()`函数将实际和有效的用户/组ID设置为root (0,0)，然后执行`/bin/bash`以生成一个root shell。
2. 目录结构`woot/etc/`和`libnss_/`。
3. 一个精心制作的`nsswitch.conf`文件，放置在`woot/etc/nsswitch.conf`。此文件配置为将NSS查找（特别是针对`passwd`）导向一个不存在的条目，当`sudo`在chroot内解析时，它将尝试从当前工作目录加载`libnss_/woot1337.so.2`，该目录指向攻击者控制的`libnss_`目录。
4. 它使用`gcc`将`woot1337.c`编译成共享库`libnss_/woot1337.so.2`。`-Wl,-init,woot`标志确保`woot`构造函数在加载时被调用。
最后，脚本执行带有关键参数的`sudo`命令：`sudo -R woot woot`。`-R` (chroot) 选项将`sudo`指向攻击者控制的`woot`目录。当`sudo`在此chroot内初始化时，它会读取恶意的`nsswitch.conf`，加载攻击者的`libnss_woot1337.so.2`，并且构造函数立即授予root权限，从而导致一个root shell。该脚本可靠且直接地实现了权限提升，无需用户除执行外的任何交互。

**利用步骤**:
1. **准备**: 确保目标系统上已安装`gcc`以编译C payload。目标系统必须具有易受攻击的`sudo`版本（1.8.8至1.9.17，特别是1.9.14至1.9.17，且在1.9.17p1之前）。
2. **下载POC**: 本地非特权用户下载`exploit.py`脚本和相关的`README.md`（尽管`README.md`并非执行所必需）。
3. **执行脚本**: 用户从其本地帐户执行Python脚本：`python3 exploit.py`。
4. **漏洞利用**: 
    * 脚本创建一个临时目录（例如，`/tmp/sudowoot.stage.XXXXXX`）。
    * 它在临时目录中生成`woot1337.c`（用于root shell的C payload）和`woot/etc/nsswitch.conf`（用于加载恶意库的NSS配置）。
    * 它使用`gcc`将`woot1337.c`编译成`libnss_/woot1337.so.2`。
    * 然后它执行`sudo -R woot woot`。`sudo`进入chroot环境`woot`（该环境位于临时目录中）。
    * 在此chroot内，`sudo`处理`nsswitch.conf`，该文件指向恶意的`libnss_/woot1337.so.2`。
    * 恶意库被加载，其构造函数`woot()`被调用，从而提升至root权限。
    * 生成一个具有root权限的新`/bin/bash`进程。
5. **清理**: 脚本在漏洞利用成功（或失败）后尝试清理临时目录。
成功执行后，非特权用户将被放入root shell中，从而实现完整的本地权限提升。

**投毒风险分析**:
提供的POC代码（`exploit.py`）对安全研究人员来说投毒风险非常低。该脚本用Python编写，仅使用标准且知名的模块（`os`、`subprocess`、`shutil`、`tempfile`）。这些模块对于系统交互、文件操作和进程管理至关重要，并且它们在此上下文中的使用对于演示漏洞利用是合法的。
嵌入在Python脚本中的C代码片段（`woot1337.c`）是权限提升的核心payload。它明确使用`setreuid(0,0)`和`setregid(0,0)`来获取root权限，然后执行`/bin/bash`。此C代码是成功利用的预期结果（一个root shell），而不是旨在损害研究人员系统的隐藏恶意组件。它不执行任何秘密操作，例如建立反向shell、下载外部payload或修改临时chroot环境之外的系统文件。脚本不进行任何网络请求，也不尝试从不受信任的来源下载或执行外部二进制文件或脚本。所有操作都是本地的，并限制在临时目录中，并在结束时清理。没有代码混淆或使用可疑的`eval()`函数，这些函数可能隐藏恶意意图。鉴于代码的清晰度和简洁性，其对标准库的依赖，以及没有任何外部通信或秘密系统修改的迹象，投毒风险被评估为非常低，估计为10%。研究人员可以在受控测试环境中放心地分析和执行此POC，而无需担心它是一个供应链攻击或包含针对他们的后门。

**项目地址:** https://github.com/kh4sh3i/CVE-2025-32463

**漏洞详情:** https://ubuntu.com/security/CVE-2025-32463
