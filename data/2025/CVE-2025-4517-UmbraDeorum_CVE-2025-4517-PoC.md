## CVE-2025-4517 - Python tarfile 模块 路径穿越 (Path Traversal)

**漏洞编号:** CVE-2025-4517

**漏洞类型:** 路径穿越 (Path Traversal)

**影响应用:** Python tarfile 模块

**危害等级:** 高危 (Critical)，允许任意文件系统写入，可导致权限提升、远程代码执行或拒绝服务。

**CVSS评分:** N/A (NVD暂未分析，但根据漏洞性质判断为高危)

**影响版本:** Python 3.12.0–3.12.10, 3.13.0–3.13.3. 已在 3.12.11 / 3.13.4+ 版本中修复。

**利用条件:** 应用程序使用tarfile模块以filter="data"或filter="tar"参数提取不受信任的tar归档。

**POC 可用性:** 9/10

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 10%

## 详情

POC有效性分析: tarfile_poc.py脚本是一个针对CVE-2025-4517的强大且文档齐全的Proof of Concept，它演示了Python tarfile模块中一个关键的路径穿越漏洞。该漏洞的核心在于data和tar提取过滤器在处理过长路径时的路径验证机制缺陷。具体来说，os.path.realpath()被用于确保符号链接目标停留在提取目录内，然而，如脚本的根本原因分析所述，os.path.realpath()存在一个静默溢出问题：一旦累计路径长度超过PATH_MAX（Linux上通常为4096字节，macOS上为1024字节），它就会停止解析符号链接。这个行为可以被恶意利用。该POC通过构建一个深度嵌套的目录结构，并结合战略性符号链接快捷方式来实现这一点。每个短的符号链接都指向一个长的目录名，有意创建一个超出PATH_MAX限制的真实扩展路径。一旦达到此限制，一个精心构造的、包含"../"组件的后续符号链接就可以逃逸出预期的提取边界，而不会触发已失效的realpath()验证。最后，创建一个“逃逸”符号链接，指向通过这个溢出链到达文件系统上的任意目录，从而使攻击者能够将任意文件写入到指定提取目录之外的位置。该脚本支持生成带有用户指定目标路径和内容的恶意归档文件，证实了其直接可利用性。它明确声明是基于Google Security Research的Caleb Brown的原始PoC，这大大增加了其技术准确性和可信度。尽管带有警告，但包含一个本地演示模式（--extract）进一步验证了其功能完整性。

利用步骤: 要利用CVE-2025-4517并使用此PoC，攻击者将遵循以下步骤：
1. 识别目标：主要要求是识别一个处理不受信任的.tar归档的Python应用程序。此应用程序必须使用tarfile.TarFile.extractall()或tarfile.TarFile.extract()方法，并带有filter="data"或filter="tar"参数。至关重要的是，该应用程序必须运行在已知受影响的Python版本上：3.12.0到3.12.10，或3.13.0到3.13.3。
2. 制作恶意归档：攻击者使用提供的poc.py脚本生成一个特制的.tar归档。该脚本允许精确控制有效载荷：
   - --target参数用于指定受害者文件系统上应发生任意文件写入的绝对路径（例如，/etc/sudoers、/root/.ssh/authorized_keys、/var/www/html/backdoor.php）。
   - --content参数允许将任意字符串内容直接嵌入到将要写入的文件中（例如，"username ALL=(ALL:ALL) ALL"用于sudoers）。
   - 或者，--content-file参数可用于从本地文件读取有效载荷内容，为复杂载荷提供更大的灵活性。
   - -o参数指定恶意tar归档的输出文件名（例如，evil.tar）。
   - 示例命令：python3 poc.py --target /etc/sudoers --content "attacker ALL=(ALL) NOPASSWD: ALL" -o backdoor.tar。
3. 传递和触发：然后需要将生成的恶意tar归档（在示例中为backdoor.tar）传递给易受攻击的应用程序。这可以通过多种方式实现，例如：
   - 电子邮件附件。
   - 将恶意文件上传到Web应用程序。
   - 供应链攻击，其中合法的软件包包含恶意tar。
   - 任何由目标应用程序处理不受信任的.tar文件的场景。
一旦应用程序使用易受攻击的tarfile模块和过滤器处理并提取此归档，嵌入的漏洞将触发。
4. 任意文件写入执行：在提取过程中，backdoor.tar文件中的特制符号链接将绕过os.path.realpath()中的PATH_MAX溢出。因此，攻击者控制的内容将被写入到在归档生成期间指定的--target路径，完全超出预期和安全的提取目录。这可能导致权限提升（例如，通过修改/etc/sudoers）、远程代码执行（例如，通过将web shell写入Web根目录）或拒绝服务，具体取决于所选的目标文件和内容。

投毒风险分析: 所提供的poc.py代码展现出较低的投毒风险（估计为10%）。该脚本结构清晰，注释良好，并包含对漏洞、根本原因和攻击链的全面解释。它明确声明其目的是作为CVE-2025-4517的Proof of Concept，并且基于Google Security Research的原始PoC，这表明其来源可靠。所有导入都来自标准的Python库（tarfile、os、io、sys、argparse、platform）。代码中没有混淆部分、调用外部可疑URL、意外的网络通信或尝试安装后门的行为。本地演示用法（python3 poc.py --extract）包含一个严厉的警告：“请勿在您的家用机器上使用此工具”，这进一步证实了作者的道德使用意图。该代码直接在本地构建恶意tar文件，不执行任何远程交互或隐蔽操作。输出的tar文件确实包含精心制作的有效载荷，但脚本本身是干净的。因此，此特定PoC代码除了预期的漏洞演示之外，包含恶意或“投毒”元素的风险极低。

**项目地址:** https://github.com/vulnwatchdog/CVE-2025-4517-PoC

**漏洞详情:** https://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2025-4517
