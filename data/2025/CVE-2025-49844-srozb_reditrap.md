## CVE-2025-49844 - Redis 远程代码执行 (RCE), Use-After-Free (UAF)

**漏洞编号:** CVE-2025-49844

**漏洞类型:** 远程代码执行 (RCE), Use-After-Free (UAF)

**影响应用:** Redis

**危害等级:** 严重 (Critical)

**CVSS评分:** 10.0

**影响版本:** 所有支持Lua脚本的Redis版本，包括6.x、7.x和8.x分支，具体受影响版本低于各自的修复版本（例如：Redis < 6.2.20, Redis 7.2.x < 7.2.4, Redis 7.4.x < 7.4.6, Redis 7.8.x < 7.8.6, Redis 7.22.x < 7.22.2 等）

**利用条件:** 需要认证（低权限），通过构造恶意Lua脚本利用

**POC 可用性:** 9/10

**POC 类型:** 概念验证 (检测工具)

**攻击复杂度:** 低

**投毒风险:** 0%

## 详情

CVE-2025-49844，被Wiz研究团队命名为“RediShell”，是Redis数据库中发现的一处极其严重的远程代码执行（RCE）漏洞，CVSS评分高达10.0。该漏洞源于Redis的Lua脚本执行模块中一个存在约13年的Use-After-Free（释放后重用）缺陷。攻击者一旦通过认证（即使是低权限用户），即可利用此漏洞执行任意代码，导致Redis服务器完全失陷。此漏洞利用了Redis在处理Lua chunk name时，未能正确将其锚定在栈上，导致垃圾回收周期可能在C代码仍使用该指针时回收其字符串。

**POC有效性分析：**
提供的代码是一个名为“RediTrap”的Redis蜜罐（Honeypot），而非直接的漏洞利用POC。它的设计目的是为了检测针对CVE-2025-49844（RediShell）的早期攻击尝试。RediTrap通过模拟一个未打补丁的Redis节点，监听标准Redis端口（6379），并对传入的Redis命令（尤其是`EVAL`、`EVALSHA`、`SCRIPT LOAD`等Lua脚本执行命令）进行日志记录。它会解析这些命令，提取Lua脚本的SHA-1摘要、长度等信息，并根据预设的启发式规则标记可疑活动。在检测到潜在的恶意Lua脚本时，蜜罐会返回安全的错误响应，而不是执行脚本，从而防止攻击载荷实际执行，同时捕获攻击者的行为模式。该蜜罐代码结构清晰，基于Python标准库构建，部署方便，对于威胁情报团队监控和理解CVE-2025-49844的攻击手法具有很高的实用价值和有效性。它并非用于验证漏洞的存在或实现攻击，而是作为防御性工具来捕获和分析攻击。

**利用步骤（针对CVE-2025-49844漏洞）：**
1.  **认证绕过/获取凭据：** 攻击者首先需要获取对目标Redis服务器的认证权限。CVE信息指出，即使是低权限用户也能利用此漏洞。如果Redis未配置认证或认证凭据泄露，则此步骤简化。
2.  **构造恶意Lua脚本：** 攻击者需要精心构造一个恶意的Lua脚本，该脚本能够触发Redis Lua引擎中的Use-After-Free漏洞。这通常涉及特定的内存操作或资源管理不当，以在Lua chunk name被垃圾回收后，C代码仍然尝试访问其指针的情况。
3.  **发送恶意脚本：** 攻击者通过标准Redis客户端或工具，使用`EVAL`、`EVALSHA`或`SCRIPT LOAD`等命令将构造好的恶意Lua脚本发送到目标Redis服务器。
4.  **触发漏洞与RCE：** 当Redis服务器执行该恶意Lua脚本时，利用UAF漏洞，可以覆盖关键内存区域或劫持程序执行流，最终导致在Redis服务器的上下文中执行任意代码。
5.  **实现服务器失陷：** 成功利用后，攻击者可以在受感染的Redis服务器上执行任意系统命令，完全控制服务器。

**投毒风险分析：**
提供的POC代码是“RediTrap”蜜罐的Python实现和Docker打包配置。经过对代码的详细审查，可以得出以下结论：
1.  **代码清晰度与可读性：** `reditrap.py` 文件采用标准的Python编程语言编写，代码结构清晰，注释合理，易于理解其功能逻辑。`Dockerfile` 也遵循最佳实践，构建了一个最小化的Alpine Linux基础镜像。
2.  **功能意图：** `README.md` 文件明确指出，RediTrap是一个“Redis Honeypot”，旨在“spot early attempts to exploit CVE-2025-49844”。代码逻辑完全符合其防御性目的，即模拟Redis并记录可疑活动，而非执行恶意操作。例如，它会对潜在的恶意Lua脚本返回错误而不是实际执行它们。
3.  **依赖性分析：** Python脚本主要依赖于Python标准库（如 `asyncio`, `logging`, `hashlib`, `json` 等），没有发现引入任何外部的可疑或非标准第三方库。`Dockerfile` 也只基于官方的 `python:3.12-alpine` 镜像，没有引入额外的、不透明的外部资源。
4.  **恶意行为检测：** 代码中没有发现任何恶意载荷、后门、远程控制（C2）通信、数据窃取或系统破坏的迹象。它不包含混淆代码，也不执行任何可疑的系统命令或网络请求。
5.  **结论：** 鉴于上述分析，该代码是一个合法且目的明确的防御性安全研究工具，用于检测和分析针对CVE-2025-49844的攻击。因此，此POC代码的投毒风险评估为**0%**，属于极低风险范畴。用户可以安全地部署和研究此代码。

**项目地址:** N/A

**漏洞详情:** https://redis.io/blog/security-advisory-cve-2025-49844/
