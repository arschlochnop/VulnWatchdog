## CVE-2018-20225 - pip 依赖混淆

**漏洞编号:** CVE-2018-20225

**漏洞类型:** 依赖混淆

**影响应用:** pip

**危害等级:** 中

**CVSS评分:** N/A

**影响版本:** 所有版本

**利用条件:** 需要使用--extra-index-url选项，且目标包不存在于公共索引中

**POC 可用性:** 9/10

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 10%

## 详情

CVE-2018-20225 描述了在使用 pip 安装 Python 包时，由于依赖解析的缺陷可能导致的依赖混淆漏洞。当使用 `--extra-index-url` 选项指定额外的包索引源时，pip 可能会从非官方源安装恶意包，如果该包的版本号高于官方源中的包（或者官方源中不存在该包）。该漏洞的利用条件是目标包不存在于公共索引中，攻击者可以在私有索引中放置一个具有更高版本号的恶意包，诱导用户安装。攻击者可以通过控制私有索引中的包内容，从而在用户环境中执行任意代码。

POC 有效性分析：
提供的 POC 代码演示了如何利用此漏洞。`build.sh` 脚本创建了两个虚拟环境，分别用于构建安全包和恶意包。`safe_package` 目录包含一个安全的包，其版本为 0.0.1。`malicious_package` 目录包含一个恶意的包，其版本为 1.0.0。恶意包的 `__init__.py` 文件包含 `print('oops, this is the malicious package')` 语句，用于在安装时打印一条消息，表明恶意代码已执行。构建脚本使用 `python -m build --wheel` 命令将这两个包构建成 wheel 文件。

利用步骤：
1.  攻击者搭建一个恶意的 Python 包索引服务器，并将恶意包 `example_package_cve_2018_20225` (版本 1.0.0) 上传到该服务器。
2.  用户在使用 pip 安装 `example_package_cve_2018_20225` 包时，通过 `--extra-index-url` 选项指定攻击者的恶意索引服务器。
3.  由于恶意包的版本号高于公共索引中的包（或公共索引中不存在该包），pip 将从恶意索引服务器安装恶意包。
4.  安装恶意包时，其中的 `__init__.py` 文件会被执行，从而在用户环境中执行任意代码。

投毒风险分析：
此 POC 的投毒风险较低，因为恶意代码非常简单，仅包含一条打印语句。然而，在实际攻击中，攻击者可能会将恶意代码隐藏在看似无害的包中，例如，通过添加后门、收集敏感信息或执行任意系统命令。攻击者还可以使用代码混淆技术来隐藏恶意代码，增加检测难度。此外，如果恶意包依赖于其他恶意包，则可能形成一个供应链攻击，影响更多用户。此处的投毒风险评分为10%，因为代码清晰，没有混淆或可疑行为，只包含一个简单的打印语句，方便演示漏洞。


**项目地址:** https://nvd.nist.gov/vuln/detail/cve-2018-20225

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2018-20225
