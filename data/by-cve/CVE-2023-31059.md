## CVE-2023-31059 - Repetier-Server Path Traversal / Local File Inclusion (LFI)

**漏洞编号:** CVE-2023-31059

**漏洞类型:** Path Traversal / Local File Inclusion (LFI)

**影响应用:** Repetier-Server

**危害等级:** Critical

**CVSS评分:** 9.8 Critical - AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:N

**影响版本:** ≤ 1.4.10

**利用条件:** Unauthenticated, Network accessible

**POC 可用性:** 9

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 0%

## 详情

此漏洞（CVE-2023-31059）影响Repetier-Server 1.4.10及以下版本，是一个未经身份验证的远程路径遍历和本地文件包含（LFI）漏洞。问题的核心在于`connectionLost.php`端点对文件名或路径参数处理不当，未能充分清理输入，尤其是在处理Windows风格的反斜杠编码（`..%5c`）时存在缺陷。这使得未经授权的攻击者能够通过精心构造的HTTP GET请求，在无需任何身份验证的情况下，遍历服务器的文件系统并读取任意文件。

**POC有效性分析：**
提供的概念验证（PoC）代码（`CVE-2023-31059.py`）是一个功能完整的Python脚本，它通过利用`requests`库来构造和发送恶意HTTP GET请求。脚本成功模拟了攻击流程：向目标Repetier-Server的`/base/connectionLost.php`端点发送请求，并在`file`参数中嵌入`..%5c`序列，以实现目录遍历。例如，它能成功读取如`Windows\win.ini`这样的系统文件。PoC详细列出了高价值的攻击目标，包括`ProgramData\Repetier-Server\database\user.sql`（可能包含用户凭据）、`ProgramData\Repetier-Server\config.xml`（服务器配置）以及`Windows\System32\drivers\etc\hosts`。脚本设计精良，允许用户指定目标文件路径和遍历深度，增强了其适用性。根据PoC作者的说明，该漏洞已在“Windows 10 / Windows Server 2019 (Repetier-Server默认安装)”环境下进行过测试，证实了其在常见部署环境中的有效性。此漏洞的CVSS评分为9.8（严重），表明其影响极其严重，未经身份验证的攻击者能够远程泄露敏感信息，对系统的机密性构成高风险。PoC的详细文档和明确的用法示例使其成为评估和复现此漏洞的有效工具。

**利用步骤：**
利用CVE-2023-31059漏洞读取Repetier-Server上的任意文件相对直接，且无需认证。攻击者需要访问受影响的Repetier-Server实例的网络端口（默认为3344）。以下是使用提供的PoC脚本进行利用的步骤：
1.  **环境准备:** 确保您的攻击机器上安装了Python 3环境，并安装了`requests`库。可以通过运行`pip install requests`来安装。
2.  **获取PoC脚本:** 复制或下载名为`CVE-2023-31059.py`的Python脚本。
3.  **漏洞检测（测试模式）:** 运行以下命令来测试目标服务器是否存在漏洞：
    ```bash
    python3 CVE-2023-31059.py http://<target-ip>:3344/ --test
    ```
    `<target-ip>`应替换为Repetier-Server的IP地址或域名。脚本将尝试读取默认的测试文件（例如`win.ini`），并根据响应判断漏洞是否存在。
4.  **读取特定文件:** 如果测试成功，您可以使用`--file`参数指定要读取的任意文件路径。由于漏洞利用的是Windows路径遍历特性，文件路径应使用Windows风格的`\`，并在PoC内部会自动转换为`%5c`编码。例如，要读取Repetier-Server的用户数据库文件`user.sql`：
    ```bash
    python3 CVE-2023-31059.py http://<target-ip>:3344/ --file "ProgramData\\Repetier-Server\\database\\user.sql" --depth 20
    ```
    `--depth 20`参数用于指定路径遍历的深度，以确保能够跳出当前目录并访问到系统根目录下的文件。根据实际文件路径和Web服务器的根目录位置，可能需要调整此深度。攻击者可以根据需要替换文件路径，例如`Windows\win.ini`或`ProgramData\Repetier-Server\config.xml`。
5.  **分析结果:** 脚本执行后，如果成功利用，会将读取到的文件内容打印到标准输出。攻击者可以分析这些内容以获取敏感信息，如数据库凭据、服务器配置、系统信息等。

**投毒风险分析：**
针对提供的CVE-2023-31059 PoC代码的投毒风险评估为**低风险（0%）**。分析基于以下几个方面：
*   **代码透明度与可读性:** PoC脚本`CVE-2023-31059.py`的代码结构清晰，注释详细，易于理解其功能。它主要围绕构建HTTP GET请求、处理命令行参数以及解析HTTP响应展开，没有发现任何混淆或加密代码。
*   **依赖库检查:** 脚本仅依赖标准的Python `requests`库。这是一个广泛使用且受信任的HTTP客户端库，其本身不包含恶意功能。PoC没有引入其他可疑的第三方库或外部模块，降低了通过依赖链引入恶意代码的风险。
*   **网络行为分析:** 脚本的网络行为严格限定在针对目标Repetier-Server发起HTTP GET请求，以实现文件读取。未观察到脚本尝试连接到其他未知IP地址、下载额外文件、执行端口扫描或进行任何与文件读取功能无关的异常网络活动。所有的请求都明确指向用户指定的Repetier-Server URL。
*   **文件系统操作:** 脚本的主要目的是读取目标服务器上的文件，它本身没有在运行PoC的本地机器上执行任何写入、删除、修改文件的操作。这意味着它不会对本地文件系统造成意外的破坏或数据泄露。
*   **系统命令执行:** PoC没有在本地机器上使用`subprocess`、`os.system()`或`eval()`等函数来执行任意系统命令，从而消除了通过PoC代码本身导致本地机器被后门控制的风险。所有的操作都在HTTP协议层面完成，针对的是远程目标服务器。
*   **代码逻辑审查:** 仔细检查核心逻辑，发现其完全符合利用描述中的路径遍历攻击方式。它通过URL编码的`..%5c`序列来构造恶意路径，并利用`requests.get()`方法发送请求。这些都是利用路径遍历漏洞的标准且合法的方法。
*   **免责声明:** `README.md`和PoC脚本的头部都明确包含了免责声明，指出此PoC仅用于教育和授权的安全测试目的。虽然免责声明不能完全保证代码无害，但它体现了作者的初衷，也符合良性安全研究的范畴。
综上所述，该PoC代码在功能上专注于验证和利用CVE-2023-31059漏洞，其实现方式透明、依赖安全，且没有表现出任何额外的恶意行为。因此，其作为防御性安全研究工具的投毒风险极低。

**项目地址:** https://github.com/mbanyamer

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2023-31059
