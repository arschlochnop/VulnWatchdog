## CVE-2023-37679 - Nextgen Mirth Connect 远程代码执行 (RCE)

**漏洞编号:** CVE-2023-37679

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Nextgen Mirth Connect

**危害等级:** 严重 (Critical)

**CVSS评分:** CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H (9.8 Critical)

**影响版本:** 版本 4.4.0 及更早版本

**利用条件:** 无需认证，需要网络访问

**POC 可用性:** 9

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 10%

## 详情

对提供的Python POC脚本（CVE-2023-37679.py）的分析表明，它是一个针对Nextgen Healthcare Mirth Connect的预认证远程代码执行（RCE）漏洞的有效利用工具。该漏洞（CVE-2023-37679，与CVE-2023-43208密切相关）源于Mirth Connect处理XML负载时的不安全反序列化问题。Mirth Connect是一款广泛应用于医疗领域的开源跨平台接口引擎，负责数据互操作性与交换。

**POC有效性分析:**
该漏洞的核心在于Mirth Connect的API端点（特别是`/api/users`）允许在没有充分验证的情况下反序列化任意XML负载。攻击者利用此机制，通过精心构造的恶意XML负载，利用`org.apache.commons.lang3.event.EventUtils$EventBindingInvocationHandler`类来调用任意目标对象的方法。在这个POC中，目标对象是一个`java.lang.ProcessBuilder`实例。通过设置`ProcessBuilder`的`command`属性并调用其`start`方法，攻击者可以在Mirth Connect服务运行的底层操作系统上执行任意命令。POC脚本展现出高度的功能性和灵活性，采用标准的`requests`库进行HTTP POST请求，确保了在各种环境下的可靠性和兼容性。它具备动态负载生成能力，能够根据目标操作系统（Windows或类Unix系统）自动适配，分别预置`cmd.exe /c`或`bash -c`，从而增强了漏洞利用的鲁棒性。脚本中使用的HTTP头`X-Requested-With: OpenAPI`旨在模拟合法的API请求，可能有助于绕过一些基本的WAF或安全措施。脚本通过检查HTTP响应状态码来判断是否成功执行。尽管`500 Internal Server Error`通常指示服务器已尝试处理恶意输入并可能执行了命令，但此脚本不会直接返回命令的输出。因此，若要实现完整的交互式控制或获取命令输出，攻击者通常会将此RCE与反向Shell负载或带外数据渗漏机制（如DNS渗漏）结合使用。POC的整体设计简洁、模块化且有效，符合远程漏洞利用的常见实践，直接利用反序列化缺陷，使其成为评估漏洞的强大工具。

**利用步骤:**
为了利用此漏洞，攻击者需要执行以下步骤：
1.  **目标识别与访问**: 首先，攻击者需要识别网络中运行Nextgen Mirth Connect服务的实例。由于这是一个预认证漏洞，攻击者仅需网络访问目标服务器的Mirth Connect管理端口（通常为8080或8443），无需任何凭据即可尝试利用。
2.  **环境准备**: 确保攻击机器上安装了Python 3环境以及`requests`库。如果尚未安装，可以通过运行`pip install requests`命令来安装。
3.  **脚本执行**: 使用提供的Python POC脚本。该脚本通过命令行参数接受目标URL、要执行的命令以及目标平台（`unix`或`win`）。
    *   例如，若要在目标Unix系统上执行`id`命令以获取当前用户ID，攻击者可以运行：`python CVE-2023-37679.py -u http://[target_mirth_connect_ip]:8080 -c "id" -p unix`
    *   若要在目标Windows系统上执行`whoami`命令以获取当前用户名称，攻击者可以运行：`python CVE-2023-37679.py -u http://[target_mirth_connect_ip]:8080 -c "whoami" -p win`
4.  **命令执行验证**: 脚本执行后，它会向目标Mirth Connect服务器的`/api/users`端点发送一个精心构造的XML POST请求。如果服务器返回HTTP状态码`500`（Internal Server Error），脚本将打印“The target appears to have executed the payload.”，这通常表明漏洞已成功触发，并尝试执行了指定的命令。
5.  **结果获取与后续操作**: 由于此特定POC脚本不会直接返回命令的输出，攻击者需要通过其他方式（例如，将命令输出重定向到攻击者控制的Web服务器，或通过反弹shell技术建立与目标系统的持续连接）来获取命令执行结果或进一步控制系统。成功RCE后，攻击者可以植入持久化后门、提升权限、在内网中横向移动或窃取敏感数据，从而对受影响组织造成严重损害。

**投毒风险分析:**
对提供的POC代码进行深入分析后，其投毒风险评估为**低**，具体百分比为10%。这一评估基于以下几个关键因素：
1.  **代码透明度与可读性**: POC脚本以纯Python编写，代码结构清晰，逻辑简洁明了。所有函数和变量的命名都具有描述性，没有使用任何形式的代码混淆技术。这使得安全研究人员和防御者能够轻松审查每一行代码，理解其确切功能，并验证其不包含任何隐蔽的恶意行为。这种高度的透明性是降低投毒风险的首要条件。
2.  **外部依赖的安全性**: 脚本仅依赖于Python的标准库 (`argparse`, `requests`, `urllib3`)。`argparse`用于解析命令行参数，`requests`用于发送HTTP请求，`urllib3`用于处理URL请求，并被用来禁用SSL警告（`urllib3.disable_warnings`）。这些库都是Python社区中广泛使用、维护良好且经过严格审计的。脚本没有引入任何非标准、来源不明或可能包含恶意代码的第三方依赖，也未从外部URL下载或执行任何二进制文件或脚本。
3.  **核心功能与恶意载荷**: 脚本的核心功能是构造一个XML数据包，通过HTTP POST请求发送到目标Mirth Connect服务器的`/api/users`接口。这个XML载荷被设计为利用Mirth Connect的XML反序列化漏洞来触发`java.lang.ProcessBuilder`的命令执行功能。这种行为是标准的漏洞利用手法，旨在验证漏洞的存在和可利用性，而非向执行POC的本地机器植入恶意软件。脚本中的命令执行逻辑是针对远程目标系统的，且由用户通过`--command`参数显式提供，因此不会在本地攻击机上执行未经授权的命令。
4.  **网络通信分析**: 除了与用户指定的目标Mirth Connect服务器进行HTTP(S)通信外，脚本没有发起任何其他形式的额外网络连接。没有发现任何迹象表明脚本尝试连接到命令与控制 (C2) 服务器、泄露本地敏感数据、下载次级恶意载荷或进行其他未经授权的网络活动。禁用`urllib3`的警告是渗透测试工具中的常见做法，用于避免在测试非严格验证的TLS/SSL证书时出现错误，并非恶意行为。
5.  **总结与建议**: 总体而言，该POC脚本被认为是一个专注于实现其声明功能的、合法的漏洞利用工具。它旨在协助安全专业人员评估其Nextgen Mirth Connect部署的安全性。虽然其代码清晰且不含明显恶意内容，但执行任何具有远程代码执行能力的脚本始终存在固有的风险。建议用户在严格受控的测试环境中运行此类工具，确保理解脚本的全部功能，并在执行前仔细检查源代码，以避免任何意外或不希望发生的操作。对于生产环境，应立即修补Mirth Connect到安全版本（4.4.1及更高版本），以彻底消除此漏洞风险。

**项目地址:** 

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2023-37679
