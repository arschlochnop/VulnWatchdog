## CVE-2020-0796 - Microsoft Windows Server Message Block 3.1.1 (SMBv3) protocol 远程代码执行 (RCE), 本地提权 (LPE), 整数溢出

**漏洞编号:** CVE-2020-0796

**漏洞类型:** 远程代码执行 (RCE), 本地提权 (LPE), 整数溢出

**影响应用:** Microsoft Windows Server Message Block 3.1.1 (SMBv3) protocol

**危害等级:** 关键 (Critical)

**CVSS评分:** 10.0 (CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:C/C:H/I:H/A:H)

**影响版本:** Microsoft Windows 10 versions 1903 and 1909; Windows Server versions 1903 and 1909. Other Windows versions supporting SMBv3.1.1 may also be affected.

**利用条件:** 远程, 无需认证, 网络可达

**POC 可用性:** 7

**POC 类型:** 概念验证 (Proof of Concept) / 检测脚本

**攻击复杂度:** 低

**投毒风险:** 5%

## 详情

CVE-2020-0796，又称SMBGhost或EternalDarkness，是一个影响Microsoft服务器消息块3.1.1（SMBv3）协议的关键远程代码执行（RCE）和本地提权（LPE）漏洞。该漏洞的根本原因是SMBv3协议在处理特制的压缩数据包时存在整数溢出缺陷。这个整数溢出可以被精心利用，实现任意内存读写操作。此漏洞的深远影响在于，未经身份验证的远程攻击者可以利用它在易受攻击的SMB服务器或客户端机器上以系统级权限执行任意代码。该漏洞因其严重性以及相对容易被利用的特点而受到广泛关注，常导致受影响系统立即被攻陷或发生拒绝服务（例如蓝屏死机，BSOD）。漏洞的披露过程颇为混乱，最初信息由微软发布后又迅速撤回，随后才发布了完整的安全通告（ADV200005）。

**POC有效性分析**：
提供的POC是一个Nmap脚本引擎（NSE）脚本，文件名为`cve-2020-0796.nse`。其核心功能在于**检测**目标系统是否存在CVE-2020-0796漏洞，而非直接提供完整的RCE利用。该脚本是对标准`smb-protocols` Nmap脚本的修改版本，专门增加了针对CVE-2020-0796的检查逻辑。它基于`ollypwn/SMBGhost`项目的研究，通过执行“数据包检查”来识别漏洞。具体来说，脚本会构造并发送一个恶意的SMBv3压缩数据包，旨在触发目标系统上的整数溢出缺陷。随后，脚本会分析目标服务器的响应，以确定其是否易受攻击。一个脆弱的系统可能会因为处理恶意数据包而崩溃（表现为BSOD），或者返回特定的错误代码，这些迹象都可以被Nmap脚本捕获并识别为漏洞存在的证据。脚本的输出示例清晰地表明了其检测能力，例如`State: VULNERABLE (Exploitable)`。值得注意的是，该脚本的功能局限于漏洞检测；它本身不包含任何完整的RCE有效载荷或用于获取Shell的功能。然而，成功的检测对于攻击者来说至关重要，因为它确认了目标系统可以被更高级的攻击工具所利用。除了CVE-2020-0796的检测，该脚本还兼顾了SMBv1协议的安全性检查，如果发现SMBv1启用，也会将其标记为不安全，体现了其在SMB安全审计方面的辅助价值。

**利用步骤**：
攻击者利用CVE-2020-0796的典型流程如下：
1.  **目标发现与扫描**: 攻击者首先使用Nmap等网络扫描工具，结合专门的NSE脚本（如本POC中的`cve-2020-0796.nse`），对目标网络中的主机进行扫描，识别开放445端口（或139端口）并运行SMBv3.1.1协议的潜在目标。此步骤旨在确认目标系统是否对CVE-2020-0796漏洞易受攻击。
2.  **构造恶意数据包**: 针对已确认的脆弱系统，攻击者需要精心构造一个恶意的SMBv3压缩数据包。该数据包被设计为在协议处理时触发整数溢出漏洞，为后续的内存操作创造条件。
3.  **远程代码执行 (RCE)**: 一旦恶意数据包被脆弱的SMB服务器处理，整数溢出将被触发，允许攻击者获得对系统内存的任意读写能力。通过巧妙地利用这种能力，攻击者可以覆盖关键的内存区域，注入并执行任意代码。由于该漏洞无需身份验证即可远程利用，攻击者可以完全控制受感染的系统，通常以`SYSTEM`权限执行命令。自漏洞披露后，已有许多公开的RCE利用代码被开发和共享，能够实现这一目标。
4.  **本地提权 (LPE)**: 除了远程代码执行，CVE-2020-0796也可以被本地低权限用户利用，以将权限提升至`SYSTEM`级别。这种本地提权通常针对SMB客户端组件，通过诱导SMB客户端处理恶意数据或与恶意SMB服务器交互来触发漏洞，从而在本地提升权限。

**投毒风险分析**：
对提供的`cve-2020-0796.nse`脚本进行详细审查后，评估其投毒风险为**低**（5%）。
该脚本使用Lua语言编写，这是Nmap脚本引擎的标准开发语言，并且它仅依赖于Nmap自身提供的标准库，例如`smb`、`stdnse`、`nmap`和`vulns`等。这些库都是Nmap生态系统中经过广泛测试和信任的组件，用于执行SMB协议交互和漏洞报告。
脚本的核心逻辑是直接实现SMB协议的协商和针对特定漏洞的数据包检查。在代码中，没有发现任何可疑的行为模式，例如加载外部的、非标准的模块或依赖项、向非SMB服务的外部地址发起网络请求、或者使用任何形式的代码混淆技术。脚本的目标明确地声明为漏洞检测和验证，其行为与此声明完全一致。
代码中没有包含`eval()`或其他动态代码执行函数，也没有使用晦涩难懂的数据结构或非常规编程实践来隐藏潜在的恶意行为。所有SMB协议交互都是基于已知的漏洞研究和标准规范进行的。因此，该脚本被判定为一个合法且无害的安全研究工具，其目的是帮助用户检测系统是否存在CVE-2020-0796漏洞，而非进行恶意活动。

**项目地址:** Not explicitly provided in the input; inferred to be an Nmap scripts repository.

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2020-0796
