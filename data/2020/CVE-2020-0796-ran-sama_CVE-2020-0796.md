## CVE-2020-0796 - Microsoft Windows SMBv3协议 远程代码执行 (RCE), 拒绝服务 (DoS)

**漏洞编号:** CVE-2020-0796

**漏洞类型:** 远程代码执行 (RCE), 拒绝服务 (DoS)

**影响应用:** Microsoft Windows SMBv3协议

**危害等级:** Critical

**CVSS评分:** CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H

**影响版本:** Microsoft Windows 10 versions 1903, 1909; Windows Server versions 1903, 1909

**利用条件:** 无需认证, 网络访问 (目标主机TCP 445端口可达)

**POC 可用性:** 8/10

**POC 类型:** 概念验证 (DoS)

**攻击复杂度:** 低

**投毒风险:** 0%

## 详情

CVE-2020-0796，也被称为“SMBGhost”或“EternalDarkness”，是Microsoft SMBv3协议中存在的一个关键漏洞。该漏洞源于`srv2.sys`驱动程序在处理经过压缩的数据时，未正确处理恶意压缩数据包中的长度字段，导致整数溢出。此溢出最终可能导致堆缓冲区溢出，攻击者可以通过向目标SMB服务器发送特制的压缩数据包来触发此漏洞。成功利用此漏洞可能导致远程代码执行（RCE），即攻击者可以在目标系统上以系统权限执行任意代码。即使无法实现RCE，该漏洞也常被用于触发拒绝服务（DoS）攻击，导致目标系统蓝屏死机（BSOD）。该漏洞影响了Windows 10版本1903和1909，以及Windows Server版本1903和1909，且无需认证即可通过网络访问利用。

**POC有效性分析:**
本分析基于提供的`poc-and-scan.py`脚本。该脚本是一个简洁而有效的概念验证（PoC）工具，用于检测和利用CVE-2020-0796漏洞。它用Python 3编写，仅依赖标准库，因此具有高度的可移植性和易于理解性。脚本提供两种模式：纯扫描模式和扫描加崩溃模式。在扫描模式下，脚本会首先通过发送SMB协商请求来探测目标主机的SMBv3版本和所支持的压缩算法（如LZNT1、LZ77等）。CVE-2020-0796尤其与SMB v3.1.1协议中的LZNT1压缩算法相关联。如果目标系统支持SMB v3.1.1并检测到LZNT1压缩，脚本会认为目标可能易受攻击。在扫描加崩溃模式下，除了扫描，脚本还会根据用户请求发送一个特制的、畸形的SMB压缩数据包。这个数据包被精心构造，以利用`srv2.sys`驱动程序中存在的整数溢出漏洞。当目标系统尝试解压这个恶意数据包时，将触发缓冲区溢出，导致系统崩溃（通常表现为蓝屏死机，即DoS攻击）。脚本中包含一个值得称赞的安全防护机制，即只允许在私有IP地址范围（10.x.x.x, 127.x.x.x, 172.16-31.x.x, 192.168.x.x）内执行，从而避免了意外或恶意地在公共网络上滥用此PoC。虽然此PoC主要展示了拒绝服务的效果，但它成功地证明了漏洞的存在性和利用方式，对于防御性安全研究具有很高的价值。其代码结构清晰，逻辑简单，易于审计，并且能准确触发目标系统的已知缺陷。

**利用步骤:**
1.  **环境准备**：确保攻击机上安装了Python 3环境。受害者机器应是受影响的Microsoft Windows系统（例如Windows 10版本1903/1909或Windows Server版本1903/1909），并且其SMBv3服务（TCP 445端口）可从攻击机访问。
2.  **获取PoC**：将提供的`poc-and-scan.py`脚本保存到本地文件系统。
3.  **执行扫描模式**：打开命令行终端，导航到脚本所在目录，执行命令 `python3 poc-and-scan.py <目标IP地址> N`。其中`<目标IP地址>`是受害者机器的IP地址。脚本将尝试连接目标445端口，协商SMB协议，并报告目标SMBv3版本及压缩算法（例如“SMB v311 with LZNT1 detected.”），表明目标可能易受攻击。
4.  **执行扫描+崩溃模式**：如果希望触发拒绝服务，执行命令 `python3 poc-and-scan.py <目标IP地址> Y`。脚本将首先进行扫描，如果检测到SMB v3.1.1 LZNT1压缩，则会发送恶意数据包。
5.  **观察结果**：在执行崩溃模式后，观察目标系统。成功利用将导致目标系统立即崩溃，出现蓝屏。脚本将输出“Sending malformed packet per user request!”。
6.  **安全提示**：请务必遵守脚本的私有IP地址限制，仅在授权的测试环境中使用此PoC。

**投毒风险分析:**
该PoC代码的投毒风险评估为极低，具体为0%。经过详细审查，该脚本没有表现出任何恶意或可疑行为。以下是详细的分析：
1.  **代码透明度高**：`poc-and-scan.py`脚本采用纯Python编写，逻辑结构简单、清晰，易于阅读和理解。所有核心功能（如socket通信、数据包构造）都直接在代码中实现，没有使用任何混淆技术。这使得安全研究人员能够轻松审计代码，确保其行为与预期一致。
2.  **无外部依赖项**：该脚本仅依赖Python标准库（`sys`, `socket`, `struct`），不引入任何第三方模块或外部二进制文件。这意味着它不会从不可信的源下载或执行任何额外的代码，从而消除了通过引入恶意库进行供应链攻击的风险。
3.  **静态恶意载荷**：脚本中用于触发漏洞的恶意数据包（`SMB_negotiation`和`SMB_crash`变量）是硬编码的十六进制字符串。这些字符串直接代表了SMB协议帧和畸形的压缩数据。它们是静态的，不会动态生成或从外部获取，因此不会包含可执行的Shellcode或其他恶意指令。该PoC的目的是触发拒绝服务，而非执行RCE。
4.  **负责任的安全措施**：代码中显式包含了IP地址范围检查，限制脚本只能在私有IP地址上运行。这种设计体现了作者负责任的态度，旨在防止PoC被误用或滥用于攻击公共网络资产，进一步降低了无意中造成损害的风险。
5.  **行为可预测性**：通过对代码的分析，可以确认脚本的所有操作都围绕着SMB协议的交互和漏洞触发展开。它不会执行文件系统操作、不访问敏感系统资源、不建立后门连接、不进行数据窃取或数据修改。其唯一目的就是验证CVE-2020-0796的存在并触发拒绝服务。
综上所述，该PoC代码是一个纯粹的漏洞验证工具，其设计和实现都遵循了防御性安全研究的最佳实践。它不包含任何恶意功能，因此投毒风险为0%。

**项目地址:** Not applicable from provided input

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2020-0796
