## CVE-2020-0796 - Microsoft Windows Server Message Block 3.1.1 (SMBv3) RCE

**漏洞编号:** CVE-2020-0796

**漏洞类型:** RCE

**影响应用:** Microsoft Windows Server Message Block 3.1.1 (SMBv3)

**危害等级:** CRITICAL

**CVSS评分:** 10.0

**影响版本:** Windows 10 Version 1903/1909 (x86, x64, ARM64), Windows Server Version 1903/1909 (Server Core)

**利用条件:** 未经身份验证的远程网络访问，目标开启SMBv3服务且未修补漏洞

**POC 可用性:** 8/10

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 15%

## 详情

POC有效性分析：该漏洞被称为SMBGhost，存在于SMBv3协议的Srv2.sys驱动程序中。漏洞根源在于处理经过LZNT1压缩的消息请求时，系统未能正确校验客户端提供的压缩缓冲区大小字段。当攻击者构造一个特制的压缩请求包时，解压函数会触发整数溢出，导致后续的内存分配不足，进而引发缓冲区溢出。分析提供的POC代码可见，它包含两个主要模块：scanner.py用于探测目标是否开启SMBv3且受漏洞影响，其原理是发送带有压缩标识的SMB协商包并观察响应；exploit.py则实现了复杂的内核内存布局控制。利用步骤如下：首先，脚本尝试通过低位存根（low stub）定位PML4页表基址；其次，利用漏洞导致的内存写入权限，修改HAL（硬件抽象层）堆中的HalpInterruptController指针。接着，POC将内核Shellcode写入到预定的内存地址（如KUSER_SHARED_DATA区域），并清除其NX位以获得执行权限。最后，通过触发硬件中断使内核执行流重定向到攻击者控制的Shellcode，从而实现系统级权限的远程代码执行。该POC在Windows 10 1903/1909版本上表现稳定，能够实现从蓝屏（DoS）到内核提权的完整利用。投毒风险分析：该POC代码结构清晰，使用了Python的标准库（socket, struct, argparse）以及专门用于SMB处理的辅助模块（lznt1, smb_win）。代码逻辑直接指向漏洞利用的核心点，如内存页表修改和内核Shellcode注入。经过对KERNEL_SHELLCODE字节流的初步反汇编分析，其指令序列主要用于修复内核上下文并注入典型的反弹Shell或创建系统进程，属于安全研究中标准的Payload。代码中未发现明显的Base64混淆、外部非法域名的HTTP下载请求或删除本地关键系统文件的恶意逻辑。然而，由于该漏洞属于‘蠕虫级’高危漏洞，此类POC常被黑客修改。当前代码虽然相对纯净，但用户在使用前仍需注意配套的smb_win或lznt1库是否来自可信源。在威胁情报视角下，此类代码的投毒风险主要集中在配套的二进制组件或混淆后的Shellcode中，当前文本形式的代码风险较低，建议在隔离环境测试。

**项目地址:** [https://github.com/chompie1337/SMBGhost_RCE_PoC](https://github.com/chompie1337/SMBGhost_RCE_PoC)

**漏洞详情:** [https://nvd.nist.gov/vuln/detail/CVE-2020-0796](https://nvd.nist.gov/vuln/detail/CVE-2020-0796)
