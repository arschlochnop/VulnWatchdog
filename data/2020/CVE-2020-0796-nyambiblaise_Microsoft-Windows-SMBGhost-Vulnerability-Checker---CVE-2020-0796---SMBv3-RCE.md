## CVE-2020-0796 - Microsoft Windows 10 / Windows Server (SMBv3) RCE/整型溢出

**漏洞编号:** CVE-2020-0796

**漏洞类型:** RCE/整型溢出

**影响应用:** Microsoft Windows 10 / Windows Server (SMBv3)

**危害等级:** CRITICAL

**CVSS评分:** 10.0

**影响版本:** Windows 10 Version 1903, 1909; Windows Server Version 1903, 1909

**利用条件:** 目标系统开启了SMBv3服务，且启用了压缩功能；无需身份验证，可通过网络访问445端口

**POC 可用性:** 8/10

**POC 类型:** 概念验证/扫描器

**攻击复杂度:** 低

**投毒风险:** 5%

## 详情

POC有效性分析：本分析针对提供的Python脚本`smbb_checker.py`。该脚本是一个针对CVE-2020-0796（SMBGhost）的漏洞扫描工具，旨在通过主动探测确认目标是否存在该漏洞。其核心逻辑在于构造一个特定的SMBv3 Negotiate协议数据包。根据SMBv3协议规范，该数据包包含了特定的Dialect（3.1.1）以及压缩能力扩展（Compression Capability）。漏洞产生的根本原因是Windows SMBv3客户端/服务器在处理这种恶意构造的压缩数据包时，由于`srv2.sys`驱动程序在解压缓冲区大小时存在整型溢出，导致堆溢出。此POC脚本通过发送该协商请求，并检查响应中的Dialect和响应字节偏移来判断目标是否受影响。如果目标返回了预期的压缩支持响应，则表明其驱动程序版本存在该逻辑缺陷。此脚本执行效率高，使用`netaddr`库支持子网扫描，逻辑上非常可靠，能够准确区分已修补和未修补的系统。在利用步骤上，该POC仅停留在探测阶段：1. 建立TCP 445端口连接；2. 发送包含SMB2_COMPRESSION_CAPABILITIES的协商包；3. 解析响应包中的偏移位，比对特征字节（如0x1103代表SMB 3.1.1版本）。投毒风险分析：该POC代码表现出极高的透明度和安全性。代码仅使用了Python标准库（socket, struct, sys）以及常见的第三方网络库（netaddr）。其核心Payload `pkt` 是标准的十六进制字节流，经过静态分析，该流仅包含SMB协商头部，不存在任何反弹Shell、文件删除、进程注入或加密混淆等恶意行为。脚本的逻辑是线性的，没有任何试图连接到非目标IP以外的外部C2服务器的动作。README文档准确描述了其功能和原始来源（指向知名的安全研究员ly4k的GitHub仓库），这进一步降低了投毒的可能性。在威胁情报视角下，此类代码被视为合法的防御性安全工具，用于企业内部自查，不存在恶意代码植入或后门行为，投毒风险评级为极低。唯一的风险点在于用户需确保从可信源安装`netaddr`库，但脚本本身是纯净的。

**项目地址:** [https://github.com/ly4k/SMBGhost](https://github.com/ly4k/SMBGhost)

**漏洞详情:** [https://nvd.nist.gov/vuln/detail/CVE-2020-0796](https://nvd.nist.gov/vuln/detail/CVE-2020-0796)
