## CVE-2026-21858 - n8n 远程代码执行 (RCE), 任意文件读取 (AFR), Content-Type混淆, 表达式注入

**漏洞编号:** CVE-2026-21858

**漏洞类型:** 远程代码执行 (RCE), 任意文件读取 (AFR), Content-Type混淆, 表达式注入

**影响应用:** n8n

**危害等级:** 最高严重性

**CVSS评分:** 10.0

**影响版本:** <= 1.65.0

**利用条件:** 未经身份认证，需要公开的表单或Webhook端点，且表单节点配置了文件上传功能

**POC 可用性:** 9

**POC 类型:** 完整利用

**攻击复杂度:** 中

**投毒风险:** 10%

## 详情

本分析聚焦于CVE-2026-21858，代号“Ni8mare”，一个影响开源低代码工作流自动化工具n8n的、未经身份验证的严重远程代码执行（RCE）漏洞。虽然CVE-2026-21858主要描述为由于Content-Type混淆导致的任意文件读取（AFR）漏洞，但提供的概念验证（POC）通过将其与CVE-2025-68613（一个导致沙箱绕过和RCE的表达式注入漏洞）结合，展示了一个完整的RCE攻击链。这个完整的链条允许未经身份验证的攻击者完全控制受影响的n8n实例。

**POC有效性分析:**
所提供的POC通过一个详细的`README.md`文件描述了一个完整的、未经身份验证的远程代码执行攻击链。该链条涉及两个关键漏洞：CVE-2026-21858（任意文件读取）和CVE-2025-68613（沙箱绕过和代码执行）。`README.md`明确指出这是一个“完全自动化的Python脚本”，并提供了一个`Dockerfile`来快速搭建易受攻击的n8n环境（`n8n@1.65.0`），该版本已确认受CVE-2026-21858影响。POC的利用方法与原始研究不同，但声称能在默认安装上实现RCE，前提是存在特定工作流配置（例如，带有文件上传功能的公开表单）。此外，`LeakIX`搜索结果的存在进一步证实了该漏洞在现实世界中的暴露情况。这些因素共同表明，该POC是高度有效且经过良好文档化的，能够可靠地复现和验证所述的漏洞链。

**利用步骤:**
1.  **环境准备**: 攻击者首先需要确定目标n8n实例暴露了公开的Webhook或表单端点，并且该表单节点配置了文件上传功能。
2.  **任意文件读取 (CVE-2026-21858)**: 攻击者利用n8n表单节点在处理HTTP请求时未能正确验证`Content-Type`头部的问题。通过构造恶意的JSON请求，攻击者可以利用类型混淆覆盖`req.body.files`对象，从而操纵文件路径参数，实现未经身份验证的任意文件读取。
    *   具体而言，攻击者会首先读取`/proc/self/environ`文件以获取n8n应用程序的`HOME`目录路径。
    *   然后，利用`HOME`目录信息，读取`$HOME/.n8n/config`文件，从中提取关键的`encryptionKey`。
    *   接着，读取`$HOME/.n8n/database.sqlite`数据库文件，以获取存储在其中的管理员凭证（例如用户名和哈希密码）。
3.  **伪造管理员令牌**: 收集到`encryptionKey`和管理员凭证后，攻击者可以使用这些信息来计算和伪造一个有效的管理员JSON Web Token (JWT)。
4.  **沙箱绕过与远程代码执行 (CVE-2025-68613)**: 获得伪造的管理员JWT后，攻击者可以利用n8n平台中的“表达式注入”漏洞（CVE-2025-68613）。通过注入恶意表达式，攻击者可以绕过n8n的沙箱限制，在底层操作系统上执行任意命令，从而实现对整个n8n实例的完全控制。
5.  **自动化攻击**: `README.md`指出，整个多阶段攻击链已通过一个“完全自动化的Python脚本”实现，这意味着攻击者无需手动执行每个复杂步骤，大大降低了攻击的门槛和所需的技术技能。

**投毒风险分析:**
基于提供的`Dockerfile`和`README.md`文件，该POC的投毒风险被评估为低（10%）。
*   **Dockerfile分析**: `Dockerfile`内容清晰且标准，其主要功能是构建一个包含特定版本n8n（`@1.65.0`）的Docker镜像以用于漏洞复现。它不包含任何可疑的外部脚本拉取、恶意命令注入、混淆代码或任何可能导致系统后门或数据泄露的指令。所使用的`node:20-slim`基础镜像也是常见的官方镜像。
*   **README.md分析**: `README.md`文件是漏洞的详细说明文档，内容完全专注于技术分析、漏洞原理、攻击链描述和POC使用指南。没有发现任何指向恶意网站、下载恶意Payload或包含投毒代码的提示。它提供了POC的GitHub仓库链接，通常这类公开的安全研究项目会保持代码透明性。
*   **POC性质**: 该POC被明确定义为用于安全研究和漏洞验证。其目的是演示n8n的RCE能力，而非作为恶意工具进行传播。即便攻击链中的RCE步骤能够执行任意代码，这部分“后门代码”是POC为了证明漏洞而生成的攻击载荷，并非POC工具本身带有的恶意投毒代码。
因此，根据现有信息，该POC本身不构成直接的投毒威胁，其主要风险在于攻击者可能利用其公开的细节和方法来开发实际的恶意攻击工具。

**项目地址:** https://github.com/Chocapikk/CVE-2026-21858

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2026-21858
