## CVE-2026-21858 - n8n (工作流自动化平台) 远程代码执行 (RCE)

**漏洞编号:** CVE-2026-21858

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** n8n (工作流自动化平台)

**危害等级:** Critical

**CVSS评分:** 10.0 (Maximum)

**影响版本:** 1.65.0 至 1.121.0 (不含1.121.0)

**利用条件:** 无需认证，无需用户交互，网络可达

**POC 可用性:** 9/10

**POC 类型:** 概念验证

**攻击复杂度:** 低

**投毒风险:** 0%

## 详情

CVE-2026-21858，代号“Ni8mare”，是n8n工作流自动化平台中一个关键的、未经身份验证的远程代码执行漏洞。该漏洞源于表单式工作流处理中存在的Content-Type混淆问题，允许攻击者绕过安全检查，实现任意文件读取、身份验证绕过以及最终完全控制服务器。

**POC有效性分析**
本次分析中提供的POC代码是一个Nuclei检测模板（`CVE-2026-21858.yaml`），其设计目的是有效识别运行受CVE-2026-21858影响的n8n实例。该模板在检测方面表现出高度的有效性和可靠性。它通过向n8n应用程序的常见入口点（如`/signin`、`/login`和根路径`/`）发送标准的HTTP GET请求来工作。一旦收到成功的HTTP 200 OK响应，模板将解析HTML正文，查找特定的元标签：`<meta name="n8n:config:sentry" content="([A-Za-z0-9+/=]+)">`。这个元标签通常包含n8n的base64编码配置详细信息，其中包括其版本号。Nuclei模板成功提取此base64字符串，对其进行解码，然后应用正则表达式（`.*n8n@([0-9]+\\.[0-9]+\\.[0-9]+).*`）以精确捕获安装的n8n版本号。检测的最后一步也是最关键的一步是使用DSL（领域特定语言）进行版本比较：`compare_versions(version, "< 1.121.0")`。此逻辑准确检查提取的n8n版本是否早于`1.121.0`，这与公开披露的受影响版本范围`1.65.0`到`1.121.0`（不含1.121.0）完全吻合。这种方法是被动且非侵入性的，利用了公开可用的信息，因此最大程度地减少了对目标系统的潜在影响，同时提供了其漏洞状态的明确答案。尽管此特定POC仅用于检测，但其识别易受攻击版本的准确性间接验证了底层RCE漏洞的存在和特性。此外，外部安全情报（例如CSDN搜索结果中提及的来自GitHub存储库的`exploit.py`）证实了利用此漏洞进行任意文件读取等操作的完整利用POC已公开可用，从而确认了此缺陷的严重实际影响不仅仅是检测。

**利用步骤**
CVE-2026-21858，代号“Ni8mare”，是n8n中一个关键的未经身份验证的远程代码执行漏洞。其根本原因在于n8n表单式工作流处理机制中存在的Content-Type混淆漏洞。此缺陷允许攻击者通过操纵发送到n8n Webhook端点的HTTP请求中的`Content-Type`头来绕过关键的安全检查。通常，n8n对某些操作期望特定的内容类型，但混淆允许以非预期的方式处理格式错误的请求。
一般利用步骤包括：
1.  **侦察和目标识别**：攻击者首先使用Shodan（如POC元数据中所示：`shodan-query: http.favicon.hash:-831756631`）或通过扫描常见的n8n路径来识别可公开访问的n8n实例。所提供的Nuclei检测POC可以有效地确认识别出的实例是否运行易受攻击的版本（1.65.0至< 1.121.0）。
2.  **构造恶意请求**：攻击的核心是精心构造针对n8n实例公共Webhook端点的HTTP POST请求。此请求必须包含经过特殊操纵的`Content-Type`头（例如，使用多部分表单数据类型，但嵌入一个不同的、恶意的有效负载，然后解析器会错误地解释它）。
3.  **有效负载注入**：在构造的请求正文中，攻击者嵌入一个恶意有效负载。此有效负载可以根据Content-Type混淆的确切性质设计用于各种目的：
    *   **任意文件读取**：如一些公开的利用POC（例如`exploit.py --read /etc/passwd`）所示，该漏洞可用于从服务器的文件系统中读取敏感文件，例如`/etc/passwd`、`/etc/shadow`、数据库配置文件或n8n的内部配置文件。这可能导致信息泄露并有助于进一步利用。
    *   **任意文件写入**：更严重的后果是文件写入，它使攻击者能够上传Web Shell、修改现有应用程序代码或覆盖关键系统文件。通过将恶意代码注入到随后由n8n应用程序或Web服务器执行的文件中，可以实现完全的远程代码执行。例如，将恶意JavaScript文件或服务器端脚本写入Web可访问的目录。
    *   **身份验证绕过**：该漏洞还可能允许操纵会话令牌或直接访问受保护资源，从而导致身份验证绕过和未经授权的管理员访问。
4.  **远程代码执行（RCE）**：一旦实现任意文件写入或直接代码执行，攻击者就可以以n8n应用程序的权限在底层操作系统上执行任意命令。这使攻击者能够完全控制受损服务器，允许他们安装后门、窃取数据、枢纽到其他内部系统，甚至部署加密货币矿工。
无需身份验证和无需用户交互的特性使得此漏洞极其强大，允许通过网络快速广泛地危害易受攻击的n8n实例。

**投毒风险分析**
对于本次分析中提供的`CVE-2026-21858.yaml`文件，其投毒风险评估为**低（0%）**。该POC代码是一个Nuclei检测模板，其内容清晰、结构标准，完全符合Nuclei的语法规范。它不包含任何可疑的混淆代码、外部脚本引用、恶意IP地址、未知域名请求或任何试图进行后门植入、数据窃取、挖矿等恶意行为的指令。其唯一目的是安全、被动地检测目标系统是否运行受影响的n8n版本，并且其检测机制基于公开可用的元数据提取和版本比对，不会对目标系统造成任何损害。

然而，这并不意味着与此漏洞相关的其他公开POC或利用工具是安全的。由于CVE-2026-21858是一个“关键级”且“无需认证”的RCE漏洞，其利用价值极高，一旦漏洞信息公开，威胁行为者必然会积极开发和分发其利用工具。在此背景下，供应链投毒的风险显著增加，因为攻击者很可能会创建并分发伪装成合法POC的恶意代码。这些恶意POC可能以Python脚本、Go二进制文件或其他形式出现，其内部可能包含隐藏的后门、挖矿程序、信息窃取模块，或者在利用漏洞的同时对用户系统进行二次感染。例如，一个看似用于实现RCE的`exploit.py`脚本，可能在执行漏洞利用的同时，悄悄地在后台下载并执行一个持久化后门或与C2服务器建立连接。

因此，组织应采取以下防御措施以降低投毒风险：
1.  **严格审查所有第三方代码**：在部署任何从非官方或不可信来源获取的POC或利用工具之前，必须对其进行彻底的安全审查，包括代码审计、行为分析和静态/动态扫描。
2.  **沙箱环境执行**：所有可疑或未经审查的POC代码都应在隔离的沙箱环境中执行，以防止其对真实环境造成损害。
3.  **网络流量监控**：在执行POC时，应监控其网络流量，检查是否存在与未知IP通信、异常DNS请求或其他可疑的网络行为。
4.  **文件完整性校验**：对于官方提供的补丁或工具，应核对其哈希值或数字签名，确保文件的完整性和真实性。
5.  **警惕快速发布的新POC**：对于漏洞披露后迅速出现的POC，尤其是在缺乏权威安全机构验证的情况下，应保持高度怀疑。

总之，尽管本次提供的检测POC是安全的，但组织在处理高危漏洞的利用工具时，必须时刻警惕并采取严格的安全措施，以防范潜在的投毒攻击。

**项目地址:** https://github.com/Chocapikk/CVE-2026-21858.git

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2026-21858
