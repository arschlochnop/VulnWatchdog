## CVE-2026-21858 - n8n 未授权远程代码执行 (RCE), 任意文件读取, Token伪造, 沙箱绕过

**漏洞编号:** CVE-2026-21858

**漏洞类型:** 未授权远程代码执行 (RCE), 任意文件读取, Token伪造, 沙箱绕过

**影响应用:** n8n

**危害等级:** 超危漏洞

**CVSS评分:** 10.0

**影响版本:** n8n 1.120.4 及早期版本

**利用条件:** 无需认证, 网络可达, 公开的表单节点

**POC 可用性:** 10

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 5%

## 详情

POC有效性分析:
此POC旨在利用自动化平台n8n中的一个被称为“Ni8mare”的超危漏洞（CVE-2026-21858），该漏洞允许未经身份验证的远程攻击者完全控制受影响的n8n实例。POC由三部分组成：一个`dockerfile`用于构建脆弱环境，一个`README.md`提供详细的设置和利用指南，以及一个`poc.py`脚本负责实际的漏洞利用。

`dockerfile`通过安装`n8n@1.120.4`版本，精准地复现了受影响的环境，确保了漏洞的可利用性。这种环境设置方式极大地简化了测试和复现过程，使得研究人员和安全团队能够迅速搭建测试靶机。

`poc.py`脚本是核心利用工具，它实现了从任意文件读取到远程代码执行（RCE）的完整攻击链。根据搜索结果和POC代码分析，该漏洞链通常包括以下关键步骤：
1. URL解析与初始化：脚本首先解析用户提供的n8n表单触发URL，提取目标主机和表单路径。
2. 任意文件读取（Arbitrary File Read）：利用Content-Type混淆漏洞，攻击者可以通过构造特殊的Webhook请求或表单节点输入，绕过n8n的文件访问限制，读取服务器上的敏感文件。POC中`get_actual_data`函数正是为了实现这一点，它通过伪造文件上传请求中的`filepath`参数，读取目标文件（如`~/.n8n/config`或`/etc/passwd`）。
3. Token伪造（Token Forge）：通过读取敏感配置文件，攻击者可能获取到用于签发JWT的密钥或相关凭证。`poc.py`中的`get_jwt_token`函数展示了如何通过这些信息伪造有效的认证Token，从而提升权限或模拟合法用户。
4. 沙箱绕过（Sandbox Bypass）：n8n在执行工作流时通常会采用沙箱机制来限制潜在的恶意操作。该漏洞通过结合其他技巧（如执行任意文件），能够成功绕过这些限制。`sandbox_bypass`函数虽然在POC中未直接显示其具体实现细节，但其存在表明了攻击链的完整性，通常涉及利用n8n内部的一些特性或外部库的已知漏洞。
5. 远程代码执行（RCE）：一旦沙箱被绕过，攻击者便能通过执行任意系统命令，完全控制目标n8n服务器。`execute_rce`函数负责将构造好的命令注入到n8n的工作流或某个可执行点，并通过回调机制或输出捕获，将命令执行结果返回给攻击者。

POC脚本的有效性体现在其高度自动化和模块化设计。它能够处理复杂的攻击流程，并且包含了错误处理和动态URL调整（如`waiting_url`的动态替换），以适应不同n8n部署环境。整个利用过程无需认证，并且易于复现，使得其质量评分达到了最高级别。

利用步骤:
1. 环境搭建:
   * 使用提供的`dockerfile`构建n8n脆弱版本（`1.120.4`）的Docker镜像：`docker build -t n8n-vuln:1.120.4 .`
   * 运行Docker容器：`run.bat` (Windows) 或 `docker run -p 5678:5678 n8n-vuln:1.120.4` (Linux/macOS)。
2. n8n配置:
   * 访问n8n管理界面，登录。
   * 创建一个新的工作流（Workflow）。
   * 将`workflow.txt`中提供的工作流内容粘贴到新创建的工作流中。
   * 激活该工作流。
3. 攻击准备:
   * 在攻击者机器上，安装Python依赖：`pip3 install -r requirements.txt`。
4. 执行攻击:
   * 运行`poc.py`脚本：`python3 poc.py`。
   * 根据提示，复制并粘贴之前激活的工作流生成的“Form Trigger URL”。
   * 脚本将自动执行漏洞利用链，最终获取远程代码执行权限，并允许攻击者在目标服务器上执行任意系统命令。

投毒风险分析:
对提供的POC代码 (`dockerfile` 和 `poc.py`) 进行的详细审查显示，其投毒风险极低，评估为5%。

`dockerfile`用于构建n8n 1.120.4版本的环境，其内容清晰透明。它安装了基本的Ubuntu包、Node.js，并全局安装了特定版本的n8n。所有命令都是标准且可预期的，没有发现任何尝试下载或执行外部恶意脚本、添加非官方存储库、修改系统核心组件或进行其他可疑操作的行为。其目的明确，仅为构建一个用于安全测试的脆弱环境。

`poc.py`脚本是核心的漏洞利用代码，其结构和逻辑也相当清晰。脚本使用了Python的标准库（如`requests`, `json`, `time`, `hashlib`, `jwt`, `re`, `base64`, `urllib.parse`）。这些库在网络请求、数据解析和安全领域是常用且合法的。脚本中的所有HTTP请求都是针对目标n8n服务器的，旨在利用其已知漏洞，而非针对运行POC的本地机器。文件读取、Token伪造和命令执行的逻辑都是为了演示如何从客户端层面与n8n服务器交互并执行恶意操作。

未发现以下高风险行为：
* 代码混淆或加密: 脚本代码可读性强，没有经过混淆处理，所有功能一目了然。
* 非预期外部连接: 除了针对目标n8n服务器的请求外，没有发现脚本尝试连接其他可疑的C2服务器、下载额外组件或执行未经授权的外部网络通信。
* 后门或植入: 脚本没有包含任何在运行POC的机器上创建后门、持久化机制或植入恶意软件的代码。
* 数据窃取: 脚本的核心功能是漏洞利用，而非窃取本地敏感数据或凭证。
* 使用`eval()`或其他动态执行代码的风险: 尽管`eval()`在某些场景下可能带来风险，但在此POC中，任何动态代码执行都发生在目标n8n服务器上，是漏洞利用的一部分，而非在本地攻击者机器上执行恶意代码。

综上所述，该POC代码是一个典型的、专业的漏洞研究与验证工具。它旨在协助安全研究人员和防御团队理解和复现CVE-2026-21858漏洞，以便更好地评估风险并部署防御措施。因此，在使用该POC进行合法的安全研究和测试时，其对执行环境自身的投毒风险可以忽略不计。

**项目地址:** 

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2026-21858
