## CVE-2026-21858 - n8n 远程代码执行 (RCE), Content-Type混淆, 任意文件读取, 表达式注入

**漏洞编号:** CVE-2026-21858

**漏洞类型:** 远程代码执行 (RCE), Content-Type混淆, 任意文件读取, 表达式注入

**影响应用:** n8n

**危害等级:** 超高危

**CVSS评分:** 10.0

**影响版本:** < 1.121.0

**利用条件:** 未经身份验证；目标n8n实例需配置有以下条件：版本低于1.121.0，且存在一个包含文件上传字段的Form Trigger节点，一个返回二进制数据的Respond to Webhook节点，以及一个可公开访问的表单端点。

**POC 可用性:** 9

**POC 类型:** 完整利用

**攻击复杂度:** 中

**投毒风险:** 0

## 详情

n8n是一款流行的开源低代码工作流自动化工具，广泛应用于企业集成和自动化场景。CVE-2026-21858（代号“Ni8mare”）是n8n平台中发现的一个严重安全漏洞，允许未经身份验证的远程攻击者完全控制受影响的n8n实例。该漏洞已被分配最高的CVSS评分10.0，凸显其极高的潜在危害。漏洞的核心源于n8n的表单（Form）节点在处理HTTP请求时，未能正确验证`Content-Type`头部。这一缺陷导致攻击者可以通过精心构造的类型混淆技术，覆盖`req.body.files`对象，从而操纵文件路径参数，最终实现任意文件读取。

**攻击链分析**
该POC代码揭示了一个完整的攻击链，将CVE-2026-21858与另一个漏洞CVE-2025-68613（表达式注入漏洞）结合起来，以实现远程代码执行。攻击过程分为以下几个主要步骤：
1.  **任意文件读取 (CVE-2026-21858)**：利用`Content-Type`混淆漏洞，攻击者可以读取目标n8n服务器上的敏感文件，例如`/home/node/.n8n/config`和`database.sqlite`。这些文件通常包含n8n实例的配置信息、加密密钥以及用户的敏感数据，包括管理员凭证。
2.  **提取凭证与密钥**：从读取到的配置文件和SQLite数据库中，攻击者可以提取出用于加密敏感数据（如API令牌、OAuth凭证）的密钥，以及管理员用户的身份认证凭证。
3.  **伪造管理员JWT令牌**：利用提取到的加密密钥和管理员凭证，攻击者可以伪造一个有效的管理员JWT（JSON Web Token）。这个伪造的令牌使得攻击者能够以管理员权限访问n8n的内部API。
4.  **表达式注入与RCE (CVE-2025-68613)**：获得管理员权限后，攻击者可以利用CVE-2025-68613（一个表达式注入漏洞）来绕过n8n的沙箱机制。通过在工作流表达式中注入恶意代码，攻击者可以调用Node.js的`child_process.execSync()`函数，在底层操作系统上执行任意系统命令，最终实现远程代码执行（RCE）。

**POC有效性分析**
提供的`exploit.py`脚本是一个功能完备、高度可用的Python利用工具，它成功实现了上述从任意文件读取到远程代码执行的全攻击链。脚本结构清晰，代码注释良好，易于理解和审计。它利用`requests`库进行HTTP交互，`jwt`库用于令牌的伪造，`sqlite3`用于处理数据库文件，以及`pwn`库提供友好的日志输出。该POC支持多种操作模式，包括直接执行系统命令（`--cmd`参数）、读取指定文件（`--read`参数），甚至可以启动一个交互式shell，极大地简化了利用过程。这种全面的功能、简洁的命令行接口以及对多步骤攻击链的完美自动化，表明了其高可用性和可靠性。此外，POC中明确提到了所依赖的两个CVE，并提供了原始研究报告和另一个POC的链接，进一步增强了其可信度。基于其完整的攻击链实现、命令行接口、清晰的代码结构和验证能力，该POC的质量评分为9/10，被认为是一个高度有效的利用工具。

**投毒风险分析**
对`exploit.py`源代码进行了深入细致的审查，未发现任何恶意代码、可疑行为或混淆迹象，因此评估其投毒风险为0%。
1.  **外部依赖项审查**：脚本主要依赖于Python的标准库（如`argparse`, `hashlib`, `json`, `secrets`, `string`, `sqlite3`, `tempfile`, `base64`）以及少量广受信任的第三方库（`requests`, `jwt`, `pwn`）。这些库在网络安全和开发领域被广泛使用，且在脚本中均以其预期的合法功能被调用，用于实现漏洞利用的核心逻辑，而非引入任何恶意功能或后门。
2.  **代码透明度与混淆检测**：脚本代码结构清晰，逻辑流程透明，没有任何混淆、加密或打包痕迹。所有的函数和变量命名都直观明了，遵循Python的编程规范，使得代码意图一目了然。这表明开发者旨在提供一个可审计、可验证的漏洞利用工具，而非隐藏恶意行为。
3.  **网络通信行为**：脚本中的所有HTTP请求均明确指向用户指定的目标n8n实例（`self.base_url`），用于执行漏洞利用所需的探测、数据读取和命令执行。没有发现任何未经授权的外部网络通信、数据泄露尝试或与未知第三方服务器的连接。所有的网络活动都直接服务于漏洞利用的目的。
4.  **文件系统操作**：脚本会在执行过程中创建临时文件（如用于存储从目标服务器读取的`database.sqlite`），这是为了处理和分析敏感数据所必需的步骤。这些文件操作是漏洞利用逻辑的组成部分，且通常在使用后可以被系统自动清理或用户手动清理，不涉及恶意的文件写入、篡改系统关键文件或安装持久性后门。
5.  **动态代码执行**：脚本中的`RCE_PAYLOAD`字符串确实包含一个利用Node.js `child_process.execSync`函数进行动态命令执行的部分。然而，这并非POC脚本本身在本地环境执行恶意Python代码，而是构造一个在目标n8n服务器上被解释和执行的表达式。这是RCE漏洞利用的直接体现，是针对目标系统的攻击行为，而非POC代码自带的投毒行为。

综上所述，该POC代码是一个专注于漏洞利用的良性安全研究工具，其设计、实现和行为均符合合法安全研究实践。因此，该POC代码的投毒风险可以评估为0%，用户可以相对安全地在受控环境中进行测试和验证。

**项目地址:** https://github.com/Chocapikk/CVE-2026-21858

**漏洞详情:** https://avd.aliyun.com/detail?id=AVD-2026-21858
