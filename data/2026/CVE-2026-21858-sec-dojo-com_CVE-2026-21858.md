## CVE-2026-21858 - n8n 任意文件读取 / JWT伪造 / 表达式注入 / 远程代码执行

**漏洞编号:** CVE-2026-21858

**漏洞类型:** 任意文件读取 / JWT伪造 / 表达式注入 / 远程代码执行

**影响应用:** n8n

**危害等级:** 严重

**CVSS评分:** 10.0

**影响版本:** < 1.121.0

**利用条件:** 无需认证；目标n8n实例需存在一个带有文件上传字段的Form Trigger节点、一个返回二进制数据的Respond to Webhook节点，以及一个公开可访问的表单端点。

**POC 可用性:** 9/10

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 0%

## 详情

CVE-2026-21858是一个存在于n8n工作流自动化平台中的严重漏洞链，最终可导致未经身份验证的远程代码执行（RCE）。该漏洞链的CVSS评分为10.0，影响n8n版本低于1.121.0。它结合了CVE-2026-21858（Content-Type混淆导致的任意文件读取）和CVE-2025-68613（表达式注入导致的RCE）两个漏洞。

**POC有效性分析**
所提供的POC代码是一个用Python 3编写的完整利用脚本（`exploit.py`），实现了从任意文件读取到远程代码执行的整个攻击链。该脚本结构清晰，使用了`requests`库进行HTTP通信，`jwt`库进行JWT令牌操作，`sqlite3`库处理数据库文件，以及`pwn`库进行友好的日志输出。POC通过构造特定的`multipart/form-data`请求，利用Content-Type混淆漏洞（CVE-2026-21858）成功读取目标n8n实例上的敏感文件，如`.n8n/config`和`database.sqlite`，这些文件通常包含加密密钥、管理员邮箱和密码哈希。获取这些凭证后，脚本会伪造一个有效的管理员JWT令牌。随后，利用伪造的令牌，通过表达式注入漏洞（CVE-2025-68613）绕过沙箱，最终在目标服务器上执行任意系统命令。POC提供了多种利用模式，包括直接执行命令、读取任意文件以及启动交互式Shell，功能完整且易于使用，表明其具有很高的有效性和实用性。代码逻辑严谨，没有明显的错误或缺陷，是一个高质量的漏洞利用工具。

**利用步骤**
1.  **环境侦察**：攻击者首先需要识别运行n8n服务的目标，并确认其版本低于1.121.0。同时，目标N8N实例必须满足特定的工作流配置：存在一个带有文件上传字段的Form Trigger节点、一个配置为返回二进制数据的Respond to Webhook节点，以及一个公开可访问的表单端点。
2.  **任意文件读取 (CVE-2026-21858)**：攻击者使用POC脚本向目标n8n的表单端点发送一个精心构造的Webhook请求。该请求利用Content-Type混淆漏洞，诱使n8n服务读取指定路径下的任意文件，例如`/home/node/.n8n/config`（获取加密密钥）和`database.sqlite`（获取管理员邮箱和密码哈希）。
3.  **凭证提取与JWT伪造**：POC脚本解析从步骤2读取的配置文件和SQLite数据库，提取出n8n的加密密钥以及管理员的邮箱和密码哈希。利用这些信息，脚本通过本地计算和签名，伪造一个有效的管理员JSON Web Token（JWT），从而获取管理员权限。
4.  **表达式注入与RCE (CVE-2025-68613)**：获得管理员JWT后，POC脚本将其用于后续请求的认证。接着，脚本利用n8n的表达式注入漏洞（CVE-2025-68613），在请求中嵌入恶意的JavaScript表达式。这些表达式通过访问Node.js的`child_process`模块，如`require("child_process").execSync("CMD")`，从而绕过沙箱限制，在目标n8n实例上执行任意操作系统命令。
5.  **命令执行/文件读取/交互式Shell**：POC脚本提供灵活的利用方式：
    *   `python3 exploit.py http://target:5678 /form/test --cmd "id"`：执行指定的系统命令并返回结果。
    *   `python3 exploit.py http://target:5678 /form/test --read /etc/passwd`：读取目标服务器上的任意文件内容。
    *   `python3 exploit.py http://target:5678 /form/test`：启动一个交互式Shell，允许攻击者对目标系统进行持续控制和进一步操作。

**投毒风险分析**
对提供的POC代码（`exploit.py`）进行深入分析后，评估其投毒风险为**低 (0%)**。以下是详细的风险分析：
*   **代码透明度与可读性**：POC代码是纯Python脚本，未进行任何形式的代码混淆或加密处理。所有的函数、变量和逻辑都清晰可见，易于安全研究人员审计和理解。代码中包含的注释也进一步增强了其可读性。
*   **恶意行为检测**：经过对代码的逐行审查，未发现任何旨在执行额外恶意行为的逻辑。代码的核心功能完全围绕着漏洞的利用链展开，即：文件读取、凭证伪造、命令执行和提供交互式Shell。这些行为本身是漏洞利用的组成部分，而非额外的恶意负载。没有迹象表明代码会进行加密货币挖矿、DDoS攻击、数据窃取（除了获取必要的配置和数据库信息）、植入后门、传播恶意软件或执行其他与漏洞利用无关的非法活动。
*   **外部依赖与网络行为**：POC代码主要依赖标准的Python库（如`argparse`、`json`、`secrets`、`sqlite3`、`base64`）以及常用的第三方安全库`requests`和`pyjwt`。此外，它使用了`pwn`库用于美化终端输出，这是一个在CTF和安全研究中广泛使用的工具。代码中没有引入任何可疑的外部链接、动态下载脚本、未经验证的第三方组件或与未知C2服务器通信的指令。所有的网络请求都指向明确的目标n8n实例，没有检测到任何向攻击者控制的服务器外发数据或进行网络扫描的行为。
*   **资源消耗**：该POC脚本在运行时，仅消耗执行漏洞利用所需的正常CPU和内存资源，没有发现任何导致目标系统或自身系统资源异常消耗的机制。
*   **结论**：综合以上分析，该POC代码是纯粹用于验证和利用CVE-2026-21858及CVE-2025-68613漏洞的工具。其设计目标明确，代码透明，行为可预测且受限。因此，此POC的投毒风险极低，安全研究人员可以放心地进行分析、复现和利用，以评估其n8n部署的安全性，而无需担心潜在的恶意副作用。



**项目地址:** https://github.com/Chocapikk/CVE-2026-21858

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2026-21858
