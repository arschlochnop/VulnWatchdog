## CVE-2026-21858 - n8n 远程代码执行 (RCE), 任意文件读取, 权限绕过, 沙箱绕过

**漏洞编号:** CVE-2026-21858

**漏洞类型:** 远程代码执行 (RCE), 任意文件读取, 权限绕过, 沙箱绕过

**影响应用:** n8n

**危害等级:** 危急/Critical

**CVSS评分:** 10.0

**影响版本:** n8n < 1.121.0

**利用条件:** 未经身份验证的远程访问, 目标需存在包含文件上传字段的Form Trigger节点、响应二进制数据的Webhook节点以及公开可访问的表单端点

**POC 可用性:** 10/10

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 5%

## 详情

POC有效性分析:
提供的POC代码 `exploit.py` 及其配套的 `README.md` 文件，详细展示了一个针对n8n自动化平台的完整、高危的远程代码执行（RCE）攻击链。此漏洞链（代号“Ni8mare”）结合了CVE-2026-21858和CVE-2025-68613，允许未经身份验证的远程攻击者完全控制受影响的n8n实例，CVSS评分高达10.0。该漏洞影响n8n 1.121.0版本之前的实例。

攻击链分四步进行：
1.  **CVE-2026-21858 - Content-Type混淆导致的任意文件读取**: 这是攻击链的起点。n8n的表单节点在处理带有特定 `Content-Type` 头部（如 `multipart/form-data`）的请求时，未能正确验证用户提供的文件名，导致攻击者可以构造恶意请求，将服务器上的任意文件路径作为文件上传请求的一部分，从而读取文件内容。POC利用此漏洞读取 `/home/node/.n8n/config` 和 `database.sqlite` 等敏感文件，这些文件通常包含n8n的加密密钥和管理员凭据。`exploit.py` 中的 `_lfi_payload` 方法负责构造此类恶意请求。
2.  **提取加密密钥和管理员凭据**: 在成功读取配置文件和数据库文件后，POC会解析这些文件，从中提取n8n实例的加密密钥（通常用于加密敏感数据）以及任何可用的管理员账户凭据，例如哈希密码或API令牌。`_get_config_and_creds` 方法专门用于此目的。
3.  **伪造管理员JWT令牌**: 利用上一步骤中提取到的加密密钥和凭据信息，POC能够伪造一个有效的JSON Web Token (JWT)。此伪造的JWT使攻击者可以冒充管理员身份，绕过正常的认证机制，从而获得对n8n实例的最高权限。
4.  **CVE-2025-68613 - 表达式注入导致的沙箱绕过和RCE**: 获得管理员权限后，攻击者可以利用n8n中存在的表达式注入漏洞。n8n允许在工作流节点中使用动态表达式，这些表达式在Node.js环境中执行。POC通过注入恶意表达式 `={{ (function() { var require = this.process.mainModule.require; var execSync = require("child_process").execSync; return execSync("CMD").toString(); })() }}`，调用Node.js的 `child_process.execSync` 函数，从而在n8n运行的服务器上执行任意操作系统命令，实现了彻底的远程代码执行。

`exploit.py` 脚本将以上所有复杂步骤封装在一个用户友好的命令行工具中，支持执行命令、读取文件和提供交互式shell等功能。脚本在执行前会明确要求目标n8n实例满足特定条件：必须有一个活动的、包含文件上传字段的“Form Trigger”节点和响应二进制数据的“Respond to Webhook”节点，且其表单端点必须是公开可访问的。这些条件对于初始的文件读取漏洞利用至关重要。该POC的有效性已得到多个安全通告和复现文章的证实。

利用步骤:
使用该POC进行利用的步骤非常直接，`exploit.py`脚本提供了三种主要模式：
1.  **执行命令 (RCE)**:
    ```bash
    python3 exploit.py http://target:5678 /form/test --cmd "id"
    ```
    此命令将连接到目标n8n实例（例如 `http://target:5678`），通过指定的表单路径（例如 `/form/test`）触发漏洞链，并执行 `id` 命令。输出结果将返回给攻击者。攻击者可以替换 `"id"` 为任何其他系统命令，以在目标服务器上执行任意操作。
2.  **读取文件**:
    ```bash
    python3 exploit.py http://target:5678 /form/test --read /etc/passwd
    ```
    此命令利用漏洞链中的任意文件读取部分，尝试读取目标服务器上的指定文件（例如 `/etc/passwd`）。这对于获取敏感信息（如用户列表、配置文件、SSH密钥等）非常有用。
3.  **交互式Shell**:
    ```bash
    python3 exploit.py http://target:5678 /form/test
    ```
    在不指定 `--cmd` 或 `--read` 参数的情况下运行脚本，将尝试建立一个交互式shell。这允许攻击者在目标系统上执行一系列命令，就像直接登录到服务器一样，从而实现更深入的渗透和控制。

在执行任何上述命令之前，攻击者需要确保目标n8n实例满足以下先决条件：存在一个活动的、公开可访问的工作流；该工作流中包含一个配置了文件上传字段的“Form Trigger”节点；该工作流中包含一个配置为返回二进制数据的“Respond to Webhook”节点；相应的表单端点必须是公开可访问的。这些条件确保了初始的Content-Type混淆漏洞可以被触发，从而开启整个攻击链。

投毒风险分析:
对提供的POC代码 `exploit.py` 的详细分析表明，其投毒风险极低，评估为5%。这一评估是基于以下几个关键因素：

首先，代码的透明度和可读性极高。`exploit.py` 是一个纯Python脚本，没有使用任何形式的代码混淆技术。其结构清晰，功能模块化，例如通过 `Ni8mare` 类封装了所有攻击逻辑和API交互。开发者可以轻松地阅读和理解代码的每一行，从而识别任何潜在的恶意行为。

其次，脚本完全依赖标准Python库和少数知名的第三方库，如 `requests` (用于HTTP请求)、`jwt` (用于JWT操作) 和 `pwn` (可能用于美化输出或shell交互)。这些库都是在安全社区和开发领域广泛使用且经过审查的工具。代码中没有发现任何尝试加载或执行来自未知或可疑外部源的额外代码、二进制文件或脚本的行为。所有的核心逻辑都在本地脚本中实现，没有外部C2（命令与控制）服务器的通信尝试（除了与目标n8n实例的正常漏洞利用通信）。

第三，该POC的主要目的是演示和执行针对n8n实例的漏洞利用。其核心功能是实现文件读取、凭据提取、JWT伪造和远程代码执行。这些操作都是为了攻击目标系统，而非攻击运行POC的本地机器。代码中明确定义的RCE payload (`RCE_PAYLOAD`) 字符串是用于注入到目标n8n环境中的，而不是在本地执行。

最后，脚本没有包含任何自我保护机制来阻止分析，也没有在代码中嵌入任何明显的后门、数据窃取功能、本地系统破坏或对运行环境进行不必要修改的行为。所有文件操作（如使用 `tempfile`）都是为了临时处理漏洞利用过程中产生的中间数据，并在完成后进行清理。

综上所述，虽然该POC能够实现对目标系统的完全控制，但其自身的代码设计、依赖项和行为模式都符合合法安全研究工具的规范，不包含额外的、针对运行者的恶意功能。因此，运行此POC的风险仅在于其攻击目标的能力，而非其自身带来的投毒威胁。用户在使用此类工具时，仍然应在受控环境中进行，并对目标系统有明确的授权。

**项目地址:** https://github.com/Chocapikk/CVE-2026-21858

**漏洞详情:** https://www.cyera.com/research-labs/ni8mare-unauthenticated-remote-code-execution-in-n8n-cve-2026-21858
