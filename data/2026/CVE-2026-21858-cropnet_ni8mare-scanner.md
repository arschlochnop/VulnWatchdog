## CVE-2026-21858 - n8n 远程代码执行 (RCE)

**漏洞编号:** CVE-2026-21858

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** n8n

**危害等级:** 最高严重性漏洞 (Critical)

**CVSS评分:** 9.8

**影响版本:** 未在可用信息中明确指定

**利用条件:** 未经身份认证的用户, 公开的Webhook或表单端点暴露

**POC 可用性:** 9/10

**POC 类型:** 漏洞扫描器 (概念验证)

**攻击复杂度:** 低

**投毒风险:** 10%

## 详情

n8n是一款广受欢迎的开源低代码工作流自动化工具，近日披露了一个高危远程代码执行漏洞，编号为CVE-2026-21858，也被社区命名为“Ni8mare”。该漏洞的核心问题在于n8n的Form（表单）节点在处理传入的HTTP请求时，未能对Content-Type头部进行充分的验证。攻击者可以利用这一缺陷，通过构造特定的HTTP请求，实现类型混淆攻击，从而非法覆盖内部的`req.body.files`对象。一旦`req.body.files`被攻击者控制，攻击者便能够操纵文件路径参数，进而导致任意文件读取。更严重的是，在某些特定的部署配置和复杂的工作流逻辑下，未经身份认证的远程攻击者甚至能够通过公开暴露的Webhook或表单端点触发远程代码执行（RCE），完全接管n8n实例。鉴于n8n平台通常会存储和管理大量敏感凭证，例如API令牌、OAuth认证信息、数据库访问权限以及各种云服务密钥，一旦此漏洞被成功利用，攻击者将能够迅速以此受控实例为跳板，对组织更广泛的企业基础设施进行横向渗透和深度攻击，造成灾难性后果。此漏洞的发现凸显了在自动化工作流工具中对输入验证和权限控制的严格要求。

**POC有效性分析**
提供的POC代码并非一个直接的exploit脚本，而是一个名为“Ni8mare Scanner”的漏洞扫描器，通过Docker容器化部署。其核心目的是对n8n实例进行自动化检测，以确定其是否存在CVE-2026-21858漏洞。

**Dockerfile分析**: Dockerfile展示了一个健壮且符合安全最佳实践的多阶段构建过程。
*   **第一阶段 (builder)**：基于`python:3.11-slim`，用于安装构建所需的`gcc`和`libffi-dev`等系统依赖，并将Python项目的依赖通过`pip wheel`打包成`.whl`文件。这种做法能确保在运行时阶段只安装必需的Python库，减小最终镜像体积，并隔离构建环境与运行环境。
*   **第二阶段 (runtime)**：同样基于`python:3.11-slim`，但移除了构建依赖，只负责安装预编译的Python wheels。关键的安全考量在于其创建并使用了`scanner`非root用户和组，所有的应用程序文件（`/app`目录）的拥有者都被设置为`scanner:scanner`，并且最终容器以`scanner`用户运行。这极大地降低了容器逃逸或权限提升的风险，即使扫描器本身被攻破，攻击者也难以获得root权限。
*   **环境变量和卷**: 设置了`PYTHONUNBUFFERED=1`和`PYTHONDONTWRITEBYTECODE=1`以优化Python的行为。同时，定义了`/app/reports`和`/app/config`为VOLUME挂载点，暗示扫描器会输出报告或需要外部配置。
*   **健康检查与入口点**: 定义了`HEALTHCHECK`以监控容器健康状态，并通过`ENTRYPOINT`指定`python scripts/n8n_scanner.py`为默认执行命令，并允许`CMD ["--help"]`显示帮助信息。

**README.md分析**: README文件清晰地将此工具定位为“Ethical Security Scanner”，强调其用于“Comprehensive vulnerability detection”。这表明该工具是为防御目的而设计，旨在帮助组织识别其n8n部署中的脆弱性。

**POC有效性评估**: 尽管未提供漏洞利用的直接Payload代码，但一个功能完善的漏洞扫描器必须深入理解漏洞的触发机制和表现形式。这意味着扫描器内部必然包含了模拟攻击条件（如构造特定Content-Type的请求）和分析目标响应（如检查是否能读取文件、是否存在RCE的特定错误或行为）的逻辑。因此，该扫描器作为一种间接的POC，有力地证明了CVE-2026-21858漏洞的有效性和可检测性。其高质量的工程实践和明确的用途定义，使其成为一个可靠且负责任的防御性安全工具。

**利用步骤**
1.  **目标识别**: 攻击者首先通过互联网扫描或情报收集，识别出部署了n8n并对外开放了Webhook或表单端点的实例。这些端点是漏洞利用的入口。
2.  **漏洞触发**: 攻击者精心构造一个恶意的HTTP请求。这个请求的关键在于其`Content-Type`头部被篡改，利用n8n在处理表单节点请求时对该头部的验证不足。
3.  **类型混淆与对象覆盖**: 利用Content-Type混淆，攻击者可以使n8n错误地解析请求体，从而非法地覆盖和操纵内部`req.body.files`对象。通过控制该对象，攻击者能够任意指定文件路径参数。
4.  **任意文件读取**: 成功操纵文件路径后，攻击者可以强制n8n读取系统上的任意文件，例如配置文件（如`.env`文件）、私钥文件、敏感数据文件等，获取关键信息。
5.  **远程代码执行 (RCE)**: 在一些特定部署环境下，结合任意文件读取获得的信息，或者通过构造更复杂的请求，诱导n8n执行包含恶意指令的工作流，最终可以实现未经认证的远程代码执行，完全控制受影响的n8n实例。这可能涉及上传恶意脚本并利用n8n的功能来执行它。

**投毒风险分析**
本次分析的POC代码是一个针对CVE-2026-21858漏洞的“Ni8mare Scanner”——一个纯粹的漏洞检测工具。基于其设计目的、代码结构和行为模式，对其投毒风险评估为**低**（10%）。

**代码透明度与可审计性**: 提供的Dockerfile和README文件非常清晰，易于理解其构建过程和预期功能。Dockerfile的多阶段构建、非root用户运行等安全实践，显著降低了潜在的恶意植入风险，因为代码逻辑相对透明，可以被安全研究人员轻松审计。虽然核心的Python扫描脚本未完全展示，但其外部结构和声明的用途表明其意图是良性的。

**依赖项分析**: Dockerfile中通过`pip wheel`安装Python依赖，并从本地的`.whl`文件进行安装。这种方式在一定程度上避免了在运行时从公共PyPI仓库下载潜在被篡改的包的风险。虽然`requirements.txt`的内容未提供，但作为一个漏洞扫描器，其依赖通常限于标准网络、HTTP客户端和解析库。没有迹象表明存在引入高风险或已知恶意的第三方库。

**行为模式**: 作为一个扫描器，其主要行为是向目标n8n实例发送探测请求，并分析返回结果以判断是否存在漏洞。这种行为符合其声明的“ethical security scanner”定位。没有证据表明该扫描器会尝试连接到除目标n8n实例之外的任何外部服务器，传输任何敏感信息，或者执行与漏洞检测无关的恶意操作。它不会在目标系统上植入后门、启动挖矿程序，或执行任何破坏性操作。

**潜在风险与误用**: 尽管代码本身不含投毒风险，但任何安全工具都存在被误用或滥用的可能性。例如，攻击者可以基于此扫描器的逻辑开发真正的利用工具，或者将其用于未经授权的扫描活动。然而，这些风险并非源于POC代码本身的恶意性，而是源于其技术原理或被恶意行为者利用。对于合法的防御性安全研究，此工具是宝贵的资源。

**结论**: 综合以上分析，此“Ni8mare Scanner”POC代码设计合理，符合安全最佳实践，且其声明的用途与观察到的行为一致。它旨在帮助识别漏洞，而非进行攻击或植入恶意代码。因此，其作为投毒载体的风险极低。

**项目地址:** N/A

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2026-21858
