## CVE-2026-21858 - n8n 任意文件读取 (Arbitrary File Read), 表达式注入 (Expression Injection), 沙箱绕过 (Sandbox Bypass), 远程代码执行 (Remote Code Execution)

**漏洞编号:** CVE-2026-21858

**漏洞类型:** 任意文件读取 (Arbitrary File Read), 表达式注入 (Expression Injection), 沙箱绕过 (Sandbox Bypass), 远程代码执行 (Remote Code Execution)

**影响应用:** n8n

**危害等级:** Critical (严重)

**CVSS评分:** 10.0

**影响版本:** n8n <= 1.65.0 (对于CVE-2026-21858，即任意文件读取), n8n >= 0.211.0 且 < 1.120.4 (对于CVE-2025-68613，即表达式注入/RCE)。此漏洞链在版本 1.121.0 (AFR) 和 1.120.4+ (RCE) 中得到修复。

**利用条件:** 无需认证 (Unauthenticated), 需要特定的工作流配置 (例如，n8n实例上存在一个带有文件上传功能的表单，且工作流中包含一个`Respond`节点)。

**POC 可用性:** 9/10

**POC 类型:** 完整利用 (Full Exploit)

**攻击复杂度:** 中 (Medium)

**投毒风险:** 0%

## 详情

该漏洞链涉及n8n自动化平台中的两个关键CVE：CVE-2026-21858（任意文件读取）和CVE-2025-68613（表达式注入导致沙箱绕过和远程代码执行）。攻击者可利用这一组合漏洞，在未经认证的情况下获取对n8n实例的完整控制权。

**POC有效性分析**:
该POC的有效性非常高，体现在以下几个方面：
首先，**环境可重现性强**。提供的`Dockerfile`能够清晰、准确地构建一个指定版本的n8n实例（`n8n@1.65.0`）。该版本在`README.md`中明确被标记为存在CVE-2026-21858（任意文件读取）漏洞。这种容器化的部署方式极大地简化了漏洞环境的搭建过程，确保了研究人员或安全测试人员能够轻松地复现漏洞场景。
其次，**漏洞链描述详尽**。`README.md`不仅揭示了CVE-2026-21858这一单一漏洞，更重要的是，它披露了一个完整的未经认证的远程代码执行（RCE）攻击链，结合了CVE-2026-21858（任意文件读取）和CVE-2025-68613（表达式注入导致沙箱绕过和RCE）。这种“全链”攻击的详细说明，包括利用AFR读取敏感配置和数据库文件、伪造管理员JWT令牌、以及通过表达式注入实现RCE的每一步骤，为理解漏洞的深度和广度提供了全面的视角。
再者，**利用方式对比清晰**。`README.md`将此POC与Cyera Labs的原始研究进行了对比，突出了本POC在RCE方法上的优势——它不依赖于默认禁用的“Execute Command”节点，而是利用“Expression Injection”，使得漏洞在默认安装的n8n实例上（只要存在带有文件上传的表单并连接了`Respond`节点）更具实际可利用性。这种比较对于评估漏洞的实际威胁和攻击面至关重要。
最后，**工具支持明确**。文档直接引用了一个GitHub仓库(`https://github.com/Chocapikk/CVE-2026-21858`)，并指出其中包含一个“Fully automated Python script”，用于执行从AFR到RCE的完整攻击链。尽管实际的Python脚本未在此次输入中提供，但这种明确的指引和自动化工具的存在，进一步证明了该POC的成熟度和有效性，使其不仅停留在概念层面，而是具备了实际的攻击能力。POC还指出了检测方式，通过LeakIX可查看暴露的n8n实例，这表明漏洞已经得到了一定程度的关注和识别。

**利用步骤**:
此漏洞利用过程是一个精心构造的完整攻击链，旨在从未经认证的状态获取n8n实例的远程代码执行权限。
1.  **准备阶段**: 攻击者首先需要确定目标n8n实例是处于易受攻击的版本范围之内（例如，通过 `Dockerfile` 设置的`n8n@1.65.0`）。更关键的是，目标n8n实例上必须配置有一个**带有文件上传功能的表单，并且该表单的工作流中包含一个`Respond`节点**。这是实现RCE的必要前提条件。
2.  **任意文件读取 (CVE-2026-21858)**: 作为攻击的第一步，攻击者利用n8n中存在的`Content-Type`混淆漏洞（CVE-2026-21858），通过发送特制的HTTP请求，绕过认证机制，实现任意文件读取。攻击目标依次是：读取进程环境变量`/proc/self/environ`以定位`HOME`目录，接着读取`$HOME/.n8n/config`获取`encryptionKey`，并读取`$HOME/.n8n/database.sqlite`获取管理员凭据。
3.  **管理员令牌伪造**: 获得`encryptionKey`和数据库中的管理员凭据后，攻击者能够推导出n8n用于生成和验证JWT（JSON Web Token）的密钥。利用这个密钥，攻击者可以伪造一个具有最高权限的管理员JWT令牌。这个伪造的令牌将允许攻击者以管理员身份访问n8n的内部API和工作流配置，为后续的RCE攻击铺平道路。
4.  **沙箱绕过与远程代码执行 (CVE-2025-68613)**: 获得管理员权限后，攻击者可以创建一个或修改一个现有的n8n工作流。在带有文件上传的表单和`Respond`节点的工作流中，攻击者可以注入恶意的表达式。n8n的表达式引擎存在漏洞（CVE-2025-68613），允许攻击者绕过其沙箱保护机制。通过注入精心构造的表达式，攻击者可以执行任意的系统命令，从而完全控制底层的操作系统。例如，攻击者可以利用此方式执行如`id`、`whoami`等命令来确认RCE，甚至部署持久化后门。
5.  **自动化利用**: 整个攻击链通常通过自动化脚本实现。`README.md`中提及的Python脚本（例如在`Chocapikk/CVE-2026-21858`项目中）能够自动执行文件读取、令牌伪造和命令执行等所有步骤，从而显著降低了攻击的门槛和复杂性。

**投毒风险分析**:
对于本次防御性安全研究任务所提供的输入数据，即`Dockerfile`和`README.md`，其直接的投毒风险评估为**低 (0%)**。
具体分析如下：
1.  **Dockerfile内容分析**: `Dockerfile`文件包含构建n8n漏洞环境所需的基础指令。其内容是标准的、可审计的Docker命令，例如从`node:20-slim`镜像构建，通过`npm`全局安装指定版本的`n8n@1.65.0`，并暴露端口、定义启动命令。这些指令均符合软件安装和运行的常规实践，不包含任何恶意代码、加密混淆脚本、可疑的外部资源下载链接，或者任何可能植入后门或执行未授权操作的指令。因此，从`Dockerfile`本身看，没有发现任何投毒风险。
2.  **README.md内容分析**: `README.md`文件是一个纯文本的漏洞描述文档。它详尽地说明了CVE漏洞的背景、影响、攻击链、利用方法、以及与其它研究的对比。尽管其中提及了GitHub上一个包含自动化利用脚本的外部项目 (`Chocapikk/CVE-2026-21858`)，但`README.md`本身仅是信息性的说明，不包含任何可执行代码。它既不会主动下载任何文件，也不会执行任何系统命令。其目的是为了研究和理解漏洞，而非主动传播恶意软件。因此，仅阅读或使用`README.md`本身不会带来投毒风险。
3.  **外部POC脚本的潜在风险警示**: 值得注意的是，虽然提供的输入数据是安全的，但`README.md`中明确指出的外部POC利用脚本（`Chocapikk/CVE-2026-21858`项目中的Python脚本）**理论上可能存在潜在的投毒风险**。任何从第三方来源下载并执行的POC脚本，都应被视为潜在风险点。在实际操作中，安全研究人员或渗透测试人员在执行此类外部脚本之前，**必须**进行严格的安全审计，包括但不限于：代码审查、行为分析、依赖检查以及混淆检查。本次分析严格遵循了仅对提供输入数据进行评估的原则，因此判定当前输入的投毒风险为低。但在实际工作中，对POC来源的信任和验证是至关重要的环节。

**项目地址:** https://github.com/Chocapikk/CVE-2026-21858

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2026-21858
