## CVE-2026-21858 - n8n 远程代码执行 (RCE), 通过Content-Type混淆导致的任意文件读取和沙箱绕过

**漏洞编号:** CVE-2026-21858

**漏洞类型:** 远程代码执行 (RCE), 通过Content-Type混淆导致的任意文件读取和沙箱绕过

**影响应用:** n8n

**危害等级:** 严重

**CVSS评分:** 10.0

**影响版本:** 主要影响n8n 0.211.0 至 1.65.0 版本 (CVE-2026-21858 影响 <= 1.65.0, CVE-2025-68613 影响 >= 0.211.0). 已在 1.121.0 (AFR) 和 1.120.4+ (RCE) 版本中修复.

**利用条件:** 无需认证, 需要网络访问, 需目标存在带文件上传功能的表单节点等特定工作流配置

**POC 可用性:** 9/10

**POC 类型:** 完整利用

**攻击复杂度:** 中

**投毒风险:** 10%

## 详情

CVE-2026-21858（代号“Ni8mare”）是n8n工作流自动化平台中发现的一个极其严重的远程代码执行（RCE）漏洞，其CVSS评分高达10.0，表明其对系统安全构成最高级别的威胁。该漏洞链允许未经身份验证的远程攻击者完全控制受影响的n8n实例。

漏洞的核心在于n8n表单（Form）节点在处理请求时，未能正确验证`Content-Type`头部。攻击者利用这一缺陷，通过类型混淆（Type Confusion）覆盖`req.body.files`对象，从而操纵文件路径参数。这导致了CVE-2026-21858所描述的未授权任意文件读取（Arbitrary File Read, AFR）漏洞。攻击者可利用AFR漏洞读取敏感配置文件和数据库，如`/proc/self/environ`、`$HOME/.n8n/config`和`$HOME/.n8n/database.sqlite`，从而获取加密密钥（`encryptionKey`）和管理员凭证。

获得这些关键信息后，攻击者可以进一步伪造管理员JWT令牌。紧接着，攻击者利用了另一个漏洞CVE-2025-68613，通过表达式注入（Expression Injection）绕过n8n的沙箱机制。这个沙箱绕过是实现最终远程代码执行的关键一步。完整的攻击链为：未授权任意文件读取 -> 管理员令牌伪造 -> 沙箱绕过 -> 远程代码执行。此漏洞利用无需身份认证，且可以被完全自动化。

**POC有效性分析：**
本分析基于由“Chocapikk”提供的POC代码（`https://github.com/Chocapikk/CVE-2026-21858`），其自述为“Full Chain”漏洞利用，涵盖了CVE-2026-21858和CVE-2025-68613。该POC提供了一个`Dockerfile`，用于快速构建一个运行`n8n@1.65.0`的易受攻击环境，这直接验证了其对特定版本兼容性。`README.md`文件清晰地描述了完整的攻击链，包括从任意文件读取到令牌伪造，再到沙箱绕过，最终实现RCE的每一个步骤。

该POC的最大特点是其自动化程度高，是一个“Fully automated Python script”，这大大降低了攻击门槛。与Cyera实验室的原始研究相比，这个POC采取了不同的RCE方法，通过“Expression Injection”而非“Execute Command”节点，并且声称这种方法在默认安装上也能工作（只要存在带文件上传功能的表单节点）。尽管POC文档明确指出“NOT a universal exploit”且“requires specific workflow config”（即需要任何带有文件上传功能的表单），但其在满足这些前提条件下的有效性非常高，能够实现完整的非授权RCE。POC的结构化文档和用于环境搭建的Dockerfile进一步增强了其可用性和可靠性，使其被评为高质量的POC。

**利用步骤：**
1.  **查找敏感信息：** 攻击者首先利用CVE-2026-21858的任意文件读取能力，读取`/proc/self/environ`以定位n8n实例的`HOME`目录。
2.  **获取加密密钥：** 接着读取`$HOME/.n8n/config`文件，从中提取用于加密的`encryptionKey`。
3.  **获取管理员凭证：** 读取`$HOME/.n8n/database.sqlite`数据库文件，以获取n8n的管理员用户凭证。
4.  **伪造管理员JWT：** 利用获取到的`encryptionKey`推导出JWT的密钥，进而伪造一个有效的管理员JWT令牌。
5.  **沙箱绕过与RCE：** 使用伪造的管理员令牌，攻击者通过CVE-2025-68613的表达式注入漏洞，绕过n8n的沙箱限制，执行任意系统命令，最终实现远程代码执行。

**投毒风险分析：**
根据对提供的POC代码（`Dockerfile`和`README.md`）和相关描述的分析，该POC的投毒风险评估为低（10%）。`Dockerfile`旨在创建一个标准的、易受攻击的n8n环境，不包含任何额外的恶意软件或可疑配置。`README.md`详细阐述了漏洞的原理、攻击链和利用方式，其目的是为了安全研究和漏洞验证，而非恶意传播。代码中未发现混淆、隐秘的外部调用、或非预期行为的迹象。整个项目结构清晰，旨在合法地演示漏洞的利用。因此，在本次分析中，未发现任何可能导致系统被“投毒”的风险因素。使用者若自行下载执行POC代码，需要确保代码来源的可靠性，避免运行经过篡改的恶意版本。

**项目地址:** https://github.com/Chocapikk/CVE-2026-21858

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2026-21858
