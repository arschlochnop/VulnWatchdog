## CVE-2022-1471 - SnakeYaml 库 (版本 <= 1.33)；同时影响集成易受攻击的SnakeYaml版本的应用程序，例如 AWS DynamoDB Local (在其 jar 和 Docker 发行版的 1.21 和 2.0 版本中) 远程代码执行 (RCE)

**漏洞编号:** CVE-2022-1471

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** SnakeYaml 库 (版本 <= 1.33)；同时影响集成易受攻击的SnakeYaml版本的应用程序，例如 AWS DynamoDB Local (在其 jar 和 Docker 发行版的 1.21 和 2.0 版本中)

**危害等级:** 关键 (CVSS v3: 9.8)

**CVSS评分:** 9.8

**影响版本:** SnakeYaml 库版本 1.x (例如 1.33 及更早版本)

**利用条件:** 需要应用程序处理攻击者提供的恶意YAML内容，通常涉及网络访问

**POC 可用性:** 9/10

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 5%

## 详情

CVE-2022-1471 是一个影响 SnakeYaml 库的反序列化漏洞。具体而言，SnakeYaml 的 `Constructor()` 类在默认配置下，在反序列化期间不对可以实例化的类型进行严格限制。这意味着，如果一个应用程序使用受影响的 SnakeYaml 版本来反序列化由攻击者控制的 YAML 内容，攻击者可以构造恶意 YAML 负载，利用 Java 的反序列化小工具链（如 `javax.script.ScriptEngineManager` 结合 `java.net.URLClassLoader`），从而导致任意代码在目标系统上远程执行。该漏洞的风险等级很高，因为它允许攻击者完全控制受感染的系统。

**POC 有效性分析：**
所提供的 POC 代码具有高度的有效性，并清晰地演示了 SnakeYaml 1.33 版本中的漏洞。它包含一个 `exploit.java` 文件，该文件精心构造了一个恶意 YAML 字符串，旨在实例化 `javax.script.ScriptEngineManager`，进而通过 `java.net.URLClassLoader` 指向一个攻击者可控的 HTTP 服务器（例如 `http://localhost:8080`）。当易受攻击的应用程序反序列化此恶意 YAML 时，`URLClassLoader` 将尝试从远程服务器加载类文件。这一过程成功完成，并通过 Python HTTP 服务器日志中记录的 GET 请求得到验证，从而证明了成功的远程代码执行（或至少是攻击者控制的出站连接）。POC 的 `README.md` 文件提供了详细、准确的步骤，包括使用 Maven 构建项目、启动 Python HTTP 服务器以及运行利用程序。此外，POC 还包含了一个 `Poc.java` 文件和相关说明，用于演示 SnakeYaml 2.0 版本如何通过使用 `TagInspector` 阻止全局标签来有效缓解此攻击，进一步增强了 POC 的实用性和教育价值。

**利用步骤：**
1.  **环境准备**：确保系统安装了 Java Development Kit (JDK 18 或更高版本，根据 `pom.xml` 配置)、Maven 和 Python 3。
2.  **获取 POC**：克隆或下载提供的 POC 仓库到本地。
3.  **构建项目**：进入 POC 项目的根目录，执行 `mvn clean install` 命令，使用 Maven 构建 Java 项目并解析依赖项。默认情况下，`pom.xml` 配置的是 SnakeYaml 1.33 版本，即易受攻击的版本。
4.  **启动 HTTP 服务器**：在一个单独的终端窗口中，启动一个简单的 Python HTTP 服务器：`python3 -m http.server 8080`。此服务器将用于托管恶意负载，受害机器将尝试从这里获取它。
5.  **运行利用程序**：执行 `exploit.java`。该 Java 程序将创建一个易受攻击的 `Yaml` 实例（使用 `new Yaml(new Constructor(Test.class, options))`），然后反序列化预先构造的恶意 YAML 字符串。恶意 YAML 字符串指示反序列化器实例化 `javax.script.ScriptEngineManager`，并通过 `URLClassLoader` 尝试从 `http://localhost:8080` 服务器加载类。
6.  **观察攻击结果**：在运行 Python HTTP 服务器的终端中，观察是否有 HTTP GET 请求的记录。如果看到请求，则表明易受攻击的应用程序已成功处理恶意 YAML 并尝试加载远程资源，这标志着远程代码执行或任意出站连接的成功。
7.  **验证修复（可选）**：要演示修复措施，修改 `pom.xml` 文件以使用 SnakeYaml 2.0 版本，然后重新构建项目。运行 `Poc.java`（该文件使用 `TagInspector` 阻止全局标签）。此时，应观察到没有 HTTP GET 请求发生，确认了修复措施的有效性。

**投毒风险分析：**
本 POC 代码的投毒风险极低，估测为 5%。其代码结构清晰、逻辑透明，并直接实现了已公开的 SnakeYaml 反序列化漏洞，不包含任何混淆、隐藏的恶意组件或可疑行为。POC 明确使用了标准的 Java 库（如 `javax.script.ScriptEngineManager` 和 `java.net.URLClassLoader`），来演示从 `http://localhost:8080` 获取资源，这是在受控环境中演示远程代码执行的常见且合法的技术。代码中没有发现针对未知第三方域名的可疑网络请求、没有编码的 payload、也没有任何植入后门或进行系统修改的 shell 命令，因此不构成“供应链攻击”或“投毒”风险。其唯一目的是用于验证漏洞的存在及其修复方案。用户在克隆和运行此 POC 时，所有网络交互都将指向其本地启动的 HTTP 服务器，且过程完全可观察和控制。因此，尽管该漏洞本身可能导致严重的攻击，但用于演示目的的 POC 代码是安全的，并专为合法的防御性安全研究而设计。

**项目地址:** https://github.com/1fabunicorn/SnakeYAML-CVE-2022-1471-POC

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2022-1471
