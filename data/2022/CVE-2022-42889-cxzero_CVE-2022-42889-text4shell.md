## CVE-2022-42889 - Apache Commons Text RCE

**漏洞编号:** CVE-2022-42889

**漏洞类型:** RCE

**影响应用:** Apache Commons Text

**危害等级:** CRITICAL

**CVSS评分:** 9.8

**影响版本:** 1.5 to 1.9

**利用条件:** 应用程序使用了受影响版本的Apache Commons Text库，并调用了StringSubstitutor解析来自不受信任来源的输入，且运行环境允许执行特定的lookup（如script, dns, url）。

**POC 可用性:** 9/10

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 10%

## 详情

POC有效性分析：该漏洞被称为Text4Shell，其核心原因在于Apache Commons Text库的StringSubstitutor类在默认配置下启用了多种插值器（Interpolators），其中包括具有执行任意脚本能力的'script'插值器。分析提供的POC代码和README文档可以确认，该POC是高度有效的。它通过构建特定的Payload格式如'${script:javascript:...}'来触发漏洞。由于早期JDK版本（如JDK 15之前）内置了Nashorn JavaScript引擎，攻击者可以直接通过该引擎调用Java Runtime执行系统命令。在较新的JDK中，虽然Nashorn被移除，但如果环境中存在JEXL等第三方脚本依赖，依然可以实现远程代码执行。POC中提供了基于Docker的复现环境（包含JDK 11, 19及Spring Boot应用），通过Maven构建并在8080端口运行，能够直观地演示通过HTTP请求发送Payload并获取反弹Shell或执行命令的过程。利用步骤：1. 识别目标应用是否使用了Apache Commons Text库（1.5-1.9版本）。2. 寻找将用户输入传递给StringSubstitutor.replace()或replaceIn()方法的切入点。3. 构造Payload，例如针对JDK 11使用'${script:javascript:java.lang.Runtime.getRuntime().exec('command')}'。4. 通过HTTP GET或POST请求发送包含Payload的数据包。5. 观察目标服务器是否执行了预期的命令（如DNS外带、创建文件或反弹连接）。投毒风险分析：该POC代码库主要由标准的Dockerfile、Maven配置文件（pom.xml）和README说明组成，逻辑清晰，结构符合典型的Java项目。在POC代码中未发现明显的混淆行为、恶意下载外部脚本或窃取主机敏感信息的指令。主要的风险点在于构建阶段：Dockerfile执行了'apt update'并安装了常用网络工具，但这属于正常测试环境搭建范畴。在分析的Github项目链接中，其目的旨在进行安全研究和漏洞演示，代码透明度高。虽然对于CVE-2022-42889这类高危漏洞，社区中可能会出现伪装成POC的勒索软件或信息窃取程序，但本例中的代码库属于公开维护且具备完整构建逻辑的合规项目，投毒风险较低（约10%）。这种风险主要来自于用户在未审计的情况下直接运行不受信任的第三方镜像或脚本的通用风险。防御人员在复现时应在隔离的沙箱或容器环境中操作，并重点监控构建过程中的网络连接。

**项目地址:** [https://github.com/cryxnet/CVE-2022-42889-RCE](https://github.com/cryxnet/CVE-2022-42889-RCE)

**漏洞详情:** [https://nvd.nist.gov/vuln/detail/CVE-2022-42889](https://nvd.nist.gov/vuln/detail/CVE-2022-42889)
