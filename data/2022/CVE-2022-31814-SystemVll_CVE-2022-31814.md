## CVE-2022-31814 - pfSense pfBlockerNG 插件 RCE (远程命令执行)

**漏洞编号:** CVE-2022-31814

**漏洞类型:** RCE (远程命令执行)

**影响应用:** pfSense pfBlockerNG 插件

**危害等级:** CRITICAL

**CVSS评分:** 9.8

**影响版本:** pfBlockerNG <= 2.1.4_26

**利用条件:** 目标系统安装并启用了 pfBlockerNG 插件，且攻击者可以访问其 web 服务端口（通常为 80 或 443）。

**POC 可用性:** 9/10

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 5%

## 详情

【POC有效性分析】该漏洞源于 pfSense 的 pfBlockerNG 插件在处理 HTTP Host 头时存在过滤不严的问题，导致攻击者可以通过精心构造的 Host 头注入 PHP 代码。提供的 Python POC 代码具有极高的实战价值。其逻辑清晰：首先通过访问 '/pfblockerng/www/index.php' 探测插件是否存在；随后在 HTTP Header 的 'Host' 字段中嵌入一段 Base64 编码的 PHP Payload。这段 Payload 利用了 PHP 的文件操作函数，在 web 根目录下创建一个名为 'system_advanced_control.php' 的一句话木马。POC 的巧妙之处在于它利用了 shell 的管道操作和 php 的命令行接口（php -m base64 -d | php）来规避某些基础的字符过滤。验证阶段，它通过 GET 请求调用上传的 shell 并执行 'id' 命令，若返回内容包含 'uid=0(root)'，则证明提权成功并获取了最高权限。此脚本实现了从探测、上传、验证到清理的全流程自动化，是一套非常成熟的攻击脚本。利用步骤：1. 确认目标 pfSense 暴露在公网或内网可达。2. 准备包含目标 URL 的文本文件。3. 执行 Python 脚本，通过 -c 参数指定需要执行的系统命令。4. 脚本将自动完成攻击并反馈执行结果。

【投毒风险分析】经过对提供的 Python 源代码进行详细审计，该 POC 表现出极低的投毒风险。代码主要依赖 Python 标准库（如 sys, time, threading, argparse, urllib.parse）以及广泛使用的第三方库 'requests'。脚本逻辑完全公开透明，没有任何经过模糊处理（Obfuscation）的十六进制代码或 Base64 加密的恶意 Python 负载。在利用载荷方面，代码中虽包含 Base64 编码，但其解码内容仅为生成一个后门 PHP 文件以验证 RCE 权限，属于典型的安全研究验证行为，而非针对攻击者本机的恶意后门。脚本不包含任何向第三方 C2 服务器发送数据的代码，也不存在删除本地系统文件、窃取环境变量或注入恶意动态链接库的行为。唯一需要注意的是，用户在使用此类针对网络基础设施的 POC 时，应确保在合法合规的测试环境内运行，避免因脚本的自动化扫描功能误伤未授权资产。总体而言，该代码结构规范，符合安全研究员共享研究成果的典型特征。

**项目地址:** [https://github.com/SystemVll/CVE-2022-31814](https://github.com/SystemVll/CVE-2022-31814)

**漏洞详情:** [https://nvd.nist.gov/vuln/detail/CVE-2022-31814](https://nvd.nist.gov/vuln/detail/CVE-2022-31814)
