## CVE-2022-26134 - Atlassian Confluence OGNL注入

**漏洞编号:** CVE-2022-26134

**漏洞类型:** OGNL注入

**影响应用:** Atlassian Confluence

**危害等级:** 高危

**CVSS评分:** 9.8

**影响版本:** 所有受影响版本在2022年6月3日之前

**利用条件:** 无需身份验证，网络可访问

**POC 可用性:** 9/10

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 10%

## 详情

CVE-2022-26134 是 Atlassian Confluence Server 和 Data Center 中的一个 OGNL 注入漏洞。由于 Confluence 未能正确处理用户提供的输入，未经身份验证的攻击者可以通过发送特制的 HTTP 请求来执行任意代码。漏洞的根本原因是`com.opensymphony.webwork`库在处理OGNL表达式时存在缺陷，允许攻击者构造恶意OGNL表达式并将其作为请求的一部分发送到Confluence服务器。当服务器解析并执行这些表达式时，攻击者可以控制服务器的操作系统，从而导致完全的系统泄露。

POC有效性分析:
提供的main.py脚本通过构造恶意的OGNL表达式实现远程命令执行。首先，脚本使用`get_version`函数尝试获取 Confluence 的版本信息，这有助于确认目标是否为易受攻击的版本。然后，`run_command`函数构造包含恶意 OGNL 表达式的 HTTP 请求，该表达式使用 `org.apache.commons.io.IOUtils` 类和 Java 的 `Runtime` 类来执行指定的命令。脚本将命令的输出放在名为 `X-Cmd-Response` 的 HTTP 标头中返回，绕过了直接在响应正文中显示输出的限制。如果服务器成功执行命令并返回包含输出的标头，则该漏洞被成功利用。提供的POC代码质量较高，可以完整利用该漏洞。该脚本能够检测Confluence版本,并执行任意命令，返回结果。此外, 脚本还包含创建反向shell后门的功能, 极具威胁性。

利用步骤:
1. 运行POC脚本 `python main.py <目标IP>`。
2. 脚本尝试自动检测 Confluence 服务器版本。
3. 脚本提示用户输入要执行的命令。
4. 用户输入命令后，脚本构造包含恶意 OGNL 表达式的 HTTP 请求并将其发送到目标服务器。
5. 服务器执行命令，并将结果放在 `X-Cmd-Response` 标头中返回。
6. 脚本从响应标头中提取命令输出并将其显示给用户。
7. 用户可以选择输入 `backdoor` 命令，脚本将在目标服务器上创建一个反向 shell 连接到攻击者的机器。

投毒风险分析:
该POC的投毒风险较低。主要风险在于脚本中包含从网络接口获取IP地址的部分，这可能会在某些环境中导致问题，或者被攻击者修改以指向恶意服务器。脚本使用标准 Python 库（如 `requests`、`urllib.parse` 和 `netifaces`），不包含任何混淆代码或可疑行为。反向shell功能本身并不构成投毒，而是漏洞利用的一部分。此外，该脚本不包含任何自动下载或执行外部脚本的功能，从而降低了潜在的投毒风险。总体而言，该POC代码清晰易懂，风险较低，但使用者应始终注意验证其来源和目的。

**项目地址:** https://github.com/topics/cve-2022-26134

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2022-26134
