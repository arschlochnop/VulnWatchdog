## CVE-2022-29464 - WSO2 API Manager, WSO2 Identity Server, WSO2 Analytics, WSO2 Enterprise Integrator RCE (远程代码执行)

**漏洞编号:** CVE-2022-29464

**漏洞类型:** RCE (远程代码执行)

**影响应用:** WSO2 API Manager, WSO2 Identity Server, WSO2 Analytics, WSO2 Enterprise Integrator

**危害等级:** CRITICAL

**CVSS评分:** 9.8 (CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H)

**影响版本:** WSO2 API Manager 2.2.0及以上, WSO2 Identity Server 5.2.0及以上, WSO2 Identity Server Analytics 5.4.0, 5.4.1, 5.5.0, 5.6.0, WSO2 Identity Server as Key Manager 5.3.0及以上, WSO2 Enterprise Integrator 6.2.0及以上

**利用条件:** 无需认证，可通过互联网直接访问 /fileupload 接口

**POC 可用性:** 9/10

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 5%

## 详情

关于POC有效性分析：该POC代码展现了极高的实战有效性。其利用逻辑直接针对WSO2产品的 /fileupload/toolsAny 接口漏洞，该接口由于缺乏身份验证和路径过滤，允许攻击者通过目录穿越（Directory Traversal）将恶意JSP文件上传到Web服务器的可访问目录中。POC代码中使用了 '../../../../repository/deployment/server/webapps/authenticationendpoint/megas.jsp' 作为上传路径，这是一种非常精准的利用方式，因为它将Shell放置在了标准的WSO2身份验证端点目录下，保证了上传后文件可以被解析执行。代码结构完整，包含多线程（multiprocessing）扫描能力、自动化的Shell上传流程以及上传成功后的自动验证步骤（get_shell函数通过执行id命令并匹配uid结果来确认权限）。由于漏洞本身是由于底层文件上传逻辑缺陷导致的，此POC在未打补丁的受影响版本上具有极高的成功率。利用步骤：首先，攻击者准备包含目标URL的列表文件；其次，运行exploit.py脚本，脚本会构造一个包含JSP WebShell的Multipart表单请求；然后，脚本通过POST请求将文件发送至 /fileupload/toolsAny 接口，利用目录穿越将megas.jsp写入服务器；最后，脚本尝试访问上传后的JSP路径并带入cmd=id参数，若返回系统用户信息则表示攻击成功。关于投毒风险分析：该POC项目的投毒风险较低，约为5%。从提供的Python源码分析，其依赖库均为Python标准库（sys, multiprocessing, re）或常见的第三方安全研究库（requests, urllib3），未发现任何经过混淆（Obfuscation）的二进制负载或加密的shellcode。脚本的行为逻辑清晰，所有的网络请求均指向用户指定的目标URL，没有发现任何向第三方受控服务器（C2）发送敏感信息（如本地环境变量、SSH密钥、浏览器Cookie等）的回连行为。虽然脚本中包含了JSP后门代码，但那是攻击目标系统的Payload，而非针对攻击者本人的恶意代码。JSP Payload本身采用明文编写，易于审计，主要功能为执行系统命令并回显，符合安全研究工具的典型特征。唯一的潜在风险在于从非官方渠道下载此类脚本时可能存在的篡改风险，但就目前分析的代码样本而言，其安全性和透明度较高，未见恶意后门注入。

**项目地址:** [https://github.com/hakivvi/CVE-2022-29464](https://github.com/hakivvi/CVE-2022-29464)

**漏洞详情:** [https://nvd.nist.gov/vuln/detail/CVE-2022-29464](https://nvd.nist.gov/vuln/detail/CVE-2022-29464)
