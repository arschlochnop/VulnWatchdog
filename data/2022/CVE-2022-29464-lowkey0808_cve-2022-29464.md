## CVE-2022-29464 - WSO2 API Manager, WSO2 Identity Server, WSO2 Analytics, WSO2 Micro Integrator 远程代码执行 (RCE) / 任意文件上传

**漏洞编号:** CVE-2022-29464

**漏洞类型:** 远程代码执行 (RCE) / 任意文件上传

**影响应用:** WSO2 API Manager, WSO2 Identity Server, WSO2 Analytics, WSO2 Micro Integrator

**危害等级:** CRITICAL

**CVSS评分:** 9.8 (CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H)

**影响版本:** WSO2 API Manager 2.2.0及以上至4.0.0; WSO2 Identity Server 5.2.0及以上至5.11.0; WSO2 IS as Key Manager 5.3.0及以上至5.10.0; WSO2 Enterprise Integrator 6.2.0及以上至6.6.0

**利用条件:** 无需身份验证，能够通过网络访问受影响产品的 /fileupload 接口端点。

**POC 可用性:** 9/10

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 5%

## 详情

【POC有效性分析】该漏洞是由于WSO2产品中负责处理文件上传的端点缺乏有效的路径遍历检查和权限校验所导致的。分析提供的Python脚本可以看到，该POC针对目标系统的 `/fileupload/toolsAny` 接口发送 POST 请求。其核心利用逻辑在于：通过多部分表单数据（multipart/form-data）上传文件时，将文件名构造为包含目录穿越字符（如 `../../../../repository/deployment/server/webapps/`）的路径。该路径直接指向了WSO2部署Web应用的根目录。POC默认内置了一个简单的Java JSP Webshell（xloq变量定义的内容），利用 `Runtime.getRuntime().exec()` 执行系统命令。一旦服务器接收到请求并根据构造的恶意路径将文件写入到可解析的Web目录中，攻击者便可通过访问 `/authenticationendpoint/shell.jsp` 并附带 `cmd` 参数来远程执行任意系统指令。该脚本实现了从漏洞验证、Webshell上传到交互式命令执行的完整链路，且利用了Python的 `requests` 库处理复杂的HTTP交互，具备极高的实战有效性和自动化利用潜力。脚本中的路径穿越深度（4层向上跳转）符合WSO2标准安装目录结构，能够精准覆盖大多数默认安装场景。【利用步骤】1. 确定目标WSO2服务器的URL。2. 脚本构造包含目录穿越路径的文件名及JSP恶意代码。3. 向目标 `/fileupload/toolsAny` 发送POST请求上传文件。4. 若服务器返回200状态码，脚本通过GET请求访问上传成功的Shell地址并获取回显。5. 进入交互循环，用户输入命令，脚本解析返回结果。【投毒风险分析】在防御性研究视角下，该POC代码逻辑清晰、透明，未发现明显的投毒行为。脚本依赖于标准的Python第三方库如 `requests`、`pyfiglet` 和 `argparse`，未引入可疑的外部二进制文件或远程恶意服务器连接。脚本中虽然存在被注释掉的全局SOCKS代理设置（socks.set_default_proxy），但这通常是开发者为了方便在特定网络环境下进行调试而留下的痕迹，而非攻击特征。POC中包含的JSP代码块是标准的Webshell演示代码，其目的是为了证明漏洞的可利用性，属于漏洞验证的必要部分，不应被视为针对研究人员的投毒。代码未进行任何混淆处理，所有逻辑均可审计，风险极低。唯一需要注意的风险点是用户在本地运行该脚本时，如果直接使用 `-s` 参数指定本地敏感文件上传，可能会导致本地信息泄露给目标服务器，但这属于用户操作范畴而非脚本本身的恶意投毒逻辑。整体而言，该POC是一个高质量的、用于安全评估的防御性工具，投毒风险处于极低水平。

**项目地址:** [https://github.com/hakivvi/CVE-2022-29464](https://github.com/hakivvi/CVE-2022-29464)

**漏洞详情:** [https://nvd.nist.gov/vuln/detail/cve-2022-29464](https://nvd.nist.gov/vuln/detail/cve-2022-29464)
