## CVE-2022-31814 - pfSense pfBlockerNG 命令注入/RCE

**漏洞编号:** CVE-2022-31814

**漏洞类型:** 命令注入/RCE

**影响应用:** pfSense pfBlockerNG

**危害等级:** CRITICAL

**CVSS评分:** 9.8

**影响版本:** <= 2.1.4_26

**利用条件:** 无需认证，可通过网络直接访问受影响的pfBlockerNG组件

**POC 可用性:** 9/10

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 10%

## 详情

【POC有效性分析】该POC针对pfSense的pfBlockerNG插件中的命令注入漏洞。漏洞核心在于/pfblockerng/www/index.php在处理HTTP Host头部时未进行充分的过滤，直接将其传递给了exec()或类似的系统执行函数。该POC通过构造恶意的Host头部，利用shell元字符（如单引号、分号）注入自定义代码。POC代码显示其采用了多阶段利用：首先，它检测目标路径是否存在；其次，利用Host头注入一段Base64编码的PHP代码，该代码通过管道传递给python3.11解码并由php执行，其目的是在Web目录下写入一个名为system_advanced_control.php的Webshell文件。最后，POC通过向新生成的Webshell发送带有'c'参数的GET请求来验证是否获得了root权限。该POC逻辑清晰，使用了标准的requests库，具有极高的实战化程度。测试环境显示在pfSense 2.6.0上有效，具备直接导致系统完全受控的风险。【利用步骤】1. 使用python3运行脚本并指定目标URL。2. 脚本首先访问/pfblockerng/www/index.php确认插件是否存在。3. 发送构造的恶意HTTP GET请求，Host头包含注入负载：' *; echo '[BASE64_PAYLOAD]'|python3.11 -m base64 -d | php; '。4. 负载执行后在/usr/local/www/目录下生成持久化Webshell。5. 脚本访问新生成的Webshell并执行'id'命令验证权限。6. 验证成功后，攻击者可进入交互式shell模式执行任意OS命令。【投毒风险分析】经过对代码逻辑的深度审计，该POC属于高度可信的安全研究代码，投毒风险极低（约10%）。代码中使用的Base64编码字符串：'PD8kYT1mb3BlbigiL3Vzci9sb2NhbC93d3cvc3lzdGVtX2FkdmFuY2VkX2NvbnRyb2wucGhwIiwidyIpIG9yIGRpZSgpOyR0PSc8P3BocCBwcmludChwYXNzdGhydSggJF9HRVRbImMiXSkpOz8+Jztmd3JpdGUoJGEsJHQpO2ZjbG9zZSggJGEpOz8+' 解码后为标准的PHP Webshell写入脚本，其行为与漏洞利用目的完全一致，未发现隐藏的恶意第三方外联请求、本地文件窃取或自我复制逻辑。代码结构整洁，参数处理使用argparse，没有进行任何混淆处理。低风险评分主要考虑到任何公开POC在分发过程中可能被二次打包添加恶意后门的通用风险，但就当前代码本身而言，不存在针对研究员主机的攻击行为。

**项目地址:** [https://github.com/pfsense/FreeBSD-ports/pull/1169](https://github.com/pfsense/FreeBSD-ports/pull/1169)

**漏洞详情:** [https://nvd.nist.gov/vuln/detail/CVE-2022-31814](https://nvd.nist.gov/vuln/detail/CVE-2022-31814)
