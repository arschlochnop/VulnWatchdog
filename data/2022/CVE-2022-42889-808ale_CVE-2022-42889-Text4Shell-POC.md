## CVE-2022-42889 - Apache Commons Text 远程代码执行 (RCE)

**漏洞编号:** CVE-2022-42889

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Apache Commons Text

**危害等级:** CRITICAL

**CVSS评分:** 9.8 (CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H)

**影响版本:** 1.5 至 1.9

**利用条件:** 应用程序使用了受影响版本的Apache Commons Text库，并调用了StringSubstitutor等插值处理函数，且插值内容包含未经清洗的用户受控输入。

**POC 可用性:** 8/10

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 15%

## 详情

【POC有效性分析】该CVE-2022-42889（Text4Shell）的POC代码逻辑清晰且具有高度的可操作性。该漏洞源于Apache Commons Text库中的变量插值（Variable Interpolation）机制。默认情况下，插值器能够处理多种前缀，其中“script”、“dns”和“url”前缀存在严重安全风险。分析提供的Python脚本可知，该POC通过构造特定的payload字符串（如 `${script:javascript:...}`）并将其嵌入到目标URL的查询参数中。当后端应用调用 `StringLookupFactory.INSTANCE.interpolatorStringLookup().lookup()` 或 `StringSubstitutor.replace()` 且未对输入进行过滤时，插值器会识别出前缀并执行相应的动作。对于RCE模式，POC利用Nashorn脚本引擎执行JavaScript代码，从而实现系统命令调用；对于SSRF模式，利用“url”前缀触发远程资源请求。经评估，该脚本能有效自动化测试此类漏洞。但在Java 15及更高版本中，由于Nashorn引擎被移除，'script'前缀将失效，限制了RCE的成功率，但SSRF依然有效。整体来看，POC结构严谨，参数化设计使其在不同环境下的兼容性较强，是典型的功能性利用工具。【利用步骤】1. 环境准备：确认目标应用使用Apache Commons Text 1.5-1.9版本。2. 确定注入点：寻找接受URL参数并进行字符串插值处理的接口。3. 执行RCE：使用命令 `python text4shell.py -u [URL] -c [COMMAND] -m rce`，脚本将自动进行URL编码并发送请求。4. 执行SSRF：使用命令 `python text4shell.py -u [URL] -s [REMOTE_URL] -m ssrf` 以验证带外请求。5. 观察响应：通过脚本输出的HTTP状态码和返回包体判断漏洞是否存在。【投毒风险分析】针对该POC项目的投毒风险评估为低（15%）。代码分析显示，脚本主要依赖Python标准库（argparse, urllib, requests），没有引入复杂的第三方依赖或执行经过混淆的二进制负载。代码逻辑完全透明，主要功能集中在构造符合Text4Shell语法的字符串。风险点在于：第一，该脚本作为扫描工具，如果被恶意修改，可能在本地执行探测的同时向攻击者控制的服务器（C2）回传目标资产信息；第二，在GitHub等公开平台上，类似的高星级漏洞仓库常被攻击者利用，通过在辅助安装脚本或依赖项中植入后门。但就目前提供的代码片段而言，未发现明显的恶意混淆、eval劫持或非预期的网络外发行为。防御者在使用时应坚持在隔离的沙箱环境运行，并检查脚本是否包含非目标域名的异常API调用。总体投毒风险处于安全研究工具的正常范畴内，主要风险来源于用户对工具来源的信任度，而非代码本身的恶意构造。

**项目地址:** [https://github.com/cryxnet/CVE-2022-42889-RCE](https://github.com/cryxnet/CVE-2022-42889-RCE)

**漏洞详情:** [https://nvd.nist.gov/vuln/detail/CVE-2022-42889](https://nvd.nist.gov/vuln/detail/CVE-2022-42889)
