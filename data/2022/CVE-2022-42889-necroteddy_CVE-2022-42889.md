## CVE-2022-42889 - Apache Commons Text 远程代码执行 (RCE)

**漏洞编号:** CVE-2022-42889

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Apache Commons Text

**危害等级:** CRITICAL

**CVSS评分:** 9.8 (CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H)

**影响版本:** 1.5 through 1.9

**利用条件:** 应用程序使用了受影响版本的 Apache Commons Text 库，并且通过 StringSubstitutor 类处理了不可信的用户输入，且未禁用受影响的查找器（如 script, dns, url）。

**POC 可用性:** 8/10

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 15%

## 详情

【POC有效性分析】该提供的POC代码是针对CVE-2022-42889（被称为Text4Shell）的一个典型验证环境。该漏洞源于Apache Commons Text库中的StringSubstitutor类在执行字符串插值时，默认开启了一些具有危险潜力的查找器（Lookup），特别是'script'、'dns'和'url'。POC中的README明确指出，通过构造如'${script:javascript:...}'格式的字符串，攻击者可以利用内置的Nashorn JavaScript引擎执行任意Java代码。提供的内容包含了一个Dockerfile、Maven构建配置以及使用说明，构成了一个完整的基于Web的漏洞演示环境。分析显示，该POC在逻辑上是高度有效的，因为它直接引用了官方JavaDocs中描述的插值行为，并给出了具体利用Payload示例（如touch /tmp/blop）。虽然Rapid7指出其影响范围可能不如Log4Shell广泛（因为需要特定代码路径触发），但对于符合条件的受攻击面，此POC展示的自动化利用门槛极低，仅需发送一个包含特定插值语法的HTTP参数即可实现RCE。此外，POC中提到的dns和url前缀也可用于带外数据（OOB）攻击，增强了漏洞在封闭网络环境下的探测能力。【利用步骤】1. 使用Maven将Java项目打包成jar文件。2. 使用Dockerfile构建Docker镜像。3. 运行镜像并将容器的8081端口映射到宿主机。4. 通过浏览器或curl访问目标URL，并在受影响的输入点（如查询参数）注入恶意Payload，例如：${script:javascript:java.lang.Runtime.getRuntime().exec('id')}。5. 观察容器内部命令执行结果或通过OOB平台接收DNS/HTTP请求。【投毒风险分析】在对此存储库进行深度静态扫描和逻辑评估后，其投毒风险处于低水平（约15%）。主要的风险点在于：首先，存储库中包含一个名为'mask_cnn.ipynb'的Jupyter Notebook文件，其内容涉及深度学习模型（torchvision），这与CVE-2022-42889的Java环境严重不符。此类无关代码的加入有时是攻击者隐藏恶意Python脚本的手段（如在模型加载时触发反弹Shell），但在本例中更像是一个无关文件的错误打包。其次，项目建议用户从Docker Hub拉取预构建镜像'korteke/text4shell'，这是典型的风险点，因为预构建镜像的层中可能包含未公开的恶意后门。然而，项目本身提供的Dockerfile内容非常透明，仅使用了标准的openjdk基础镜像，没有混淆代码，也没有发现异常的网络外联。POC中演示的'touch /tmp/blop'是合法的安全验证行为，不应视为恶意。综合来看，代码逻辑清晰，主要风险来自于第三方镜像和无关的Notebook文件，防御者在研究时应坚持自行构建镜像而非拉取不明来源的预制品。

**项目地址:** [https://github.com/necroteddy/CVE-2022-42889](https://github.com/necroteddy/CVE-2022-42889)

**漏洞详情:** [https://nvd.nist.gov/vuln/detail/CVE-2022-42889](https://nvd.nist.gov/vuln/detail/CVE-2022-42889)
