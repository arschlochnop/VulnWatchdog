## CVE-2022-42889 - Apache Commons Text 远程代码执行 (RCE)

**漏洞编号:** CVE-2022-42889

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Apache Commons Text

**危害等级:** CRITICAL

**CVSS评分:** 9.8

**影响版本:** 1.5 - 1.9

**利用条件:** 应用程序使用了受影响版本的 Apache Commons Text 库，并且通过 StringSubstitutor 类处理了攻击者可控的恶意字符串输入。

**POC 可用性:** 7/10

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 45%

## 详情

POC有效性分析：该漏洞被称为 'Text4Shell'，源于 Apache Commons Text 的 StringSubstitutor 差值器对象在处理特定前缀（如 script、dns、url）时，未能对输入进行严格校验。提供的 POC 代码展示了通过 Python 脚本自动化探测和利用的过程。脚本首先从外部 Gist 链接下载 payload 列表，然后利用 gau 工具探测目标域名的 URL，并使用 qsreplace 将这些 payload 植入参数中，最后通过 ffuf 进行模糊测试。这种利用方式在技术上是可行的，因为它针对的是典型的 Web 参数注入场景。POC 中提到的 '${script:javascript:...}' 语法是 Apache Commons Text 默认支持的脚本执行引擎（如 Nashorn），只要目标环境下存在该引擎且输入未经过滤，即可实现 RCE。利用步骤：1. 识别目标应用是否使用 Apache Commons Text。2. 构建包含恶意插值的字符串，例如使用 script:javascript 执行系统命令，或使用 dns/url 进行带外（OOB）测试。3. 将构造好的 payload 提交至应用的可控输入点（如 URL 参数、Header 或 POST 表单）。4. 观察目标是否触发了 DNS 请求或命令执行结果。投毒风险分析：该 POC 存在中等程度的投毒风险，主要体现在以下几个方面：首先，脚本在运行初期通过 os.system("wget ...") 从第三方 Gist 地址下载外部 payloads.txt 文件，这种远程动态下载行为是典型的供应链风险点，下载的内容可能在未经审计的情况下被恶意替换为后门。其次，脚本依赖于多个外部工具（如 gau, qsreplace, ffuf），如果这些工具是通过非官方渠道获取的，也可能引入风险。虽然目前的 Python 逻辑主要用于漏洞扫描，但其 '下载并执行' 的模式极易被攻击者修改为下载恶意二进制文件。代码中直接调用 os.system 执行外部命令，缺乏输入过滤，若攻击者能控制被读取的 payload 文件内容，可能导致研究员自身的本地机器遭受注入攻击。因此，在使用此类自动化脚本前，必须严格检查远程资源的来源可靠性及脚本对本地系统调用的安全性。

**项目地址:** [https://github.com/kljunowsky/CVE-2022-42889-text4shell](https://github.com/kljunowsky/CVE-2022-42889-text4shell)

**漏洞详情:** [https://nvd.nist.gov/vuln/detail/cve-2022-42889](https://nvd.nist.gov/vuln/detail/cve-2022-42889)
