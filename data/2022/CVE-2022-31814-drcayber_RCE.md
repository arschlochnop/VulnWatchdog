## CVE-2022-31814 - pfSense pfBlockerNG 远程命令执行 (RCE) / 命令注入

**漏洞编号:** CVE-2022-31814

**漏洞类型:** 远程命令执行 (RCE) / 命令注入

**影响应用:** pfSense pfBlockerNG

**危害等级:** CRITICAL

**CVSS评分:** 9.8 (CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H)

**影响版本:** 2.1.4_26 及更早版本

**利用条件:** 无需身份验证，通过网络访问受影响的 pfBlockerNG web 接口即可利用。

**POC 可用性:** 9/10

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 15%

## 详情

POC有效性分析：该POC脚本针对pfSense的pfBlockerNG扩展插件中的特定漏洞。分析代码可知，漏洞根源在于`/pfblockerng/www/index.php`在处理HTTP请求头（尤其是Host头）时，未对shell元字符进行充分过滤，导致攻击者可以通过注入精心构造的Payload实现任意命令执行。POC首先通过向`/pfblockerng/www/index.php`发送带有Base64编码payload的Host头，利用PHP执行环境将Webshell写入磁盘。其Payload采用Base64编码后通过管道传递给`php`执行，这种方式可以有效绕过简单的WAF检测。写入的Webshell名为`system_advanced_control.php`，位于Web根目录下，随后脚本通过向该文件传递`c`参数来执行系统命令。利用步骤如下：1. 攻击者运行Python脚本并提供目标URL。2. 脚本检查`/pfblockerng/www/index.php`是否存在以确认插件安装情况。3. 发送构造的恶意HTTP请求，Host头包含注入命令，将PHP小马写入服务器。4. 脚本通过访问生成的Webshell并执行`id`命令验证是否获得root权限。5. 进入交互式Shell模式，允许用户输入任意指令。6. 退出时自动执行`rm`命令清理上传的脚本以隐藏踪迹。此POC逻辑清晰，利用过程高度自动化，是一个功能完整的利用工具。投毒风险分析：该脚本的投毒风险被评为较低（15%）。代码主要依赖Python标准库如`requests`、`argparse`和`urllib`。核心逻辑透明，Payload部分虽然经过Base64编码，但解码后可见其功能仅为在服务器上创建并写入一个名为`system_advanced_control.php`的简单PHP `passthru`执行接口，这是典型的渗透测试验证行为。脚本中包含的清理逻辑（delete_shell）也表明开发者更倾向于提供一个干净的测试环境而非持久性后门。尽管如此，脚本中使用了`requests.packages.urllib3.disable_warnings`来忽略证书验证，这在安全脚本中很常见，但仍需注意执行环境。没有发现任何混淆代码、外部未知站点的回传请求或恶意下载器行为。该POC主要风险在于其本身强大的破坏力，若未经授权在生产环境运行，可能导致系统被完全控制（Root权限），但脚本本身作为工具是相对纯净的。用户在使用时应在隔离环境进行，并仔细检查Base64字符串的内容以确保安全。

**项目地址:** [https://github.com/drcayber/CVE-2022-31814](https://www.google.com/search?q=https://github.com/drcayber/CVE-2022-31814)

**漏洞详情:** [https://nvd.nist.gov/vuln/detail/CVE-2022-31814](https://nvd.nist.gov/vuln/detail/CVE-2022-31814)
