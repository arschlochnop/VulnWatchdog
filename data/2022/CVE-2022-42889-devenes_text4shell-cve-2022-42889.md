## CVE-2022-42889 - Apache Commons Text RCE (远程代码执行)

**漏洞编号:** CVE-2022-42889

**漏洞类型:** RCE (远程代码执行)

**影响应用:** Apache Commons Text

**危害等级:** CRITICAL

**CVSS评分:** 9.8 (CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H)

**影响版本:** 1.5 - 1.9

**利用条件:** 应用程序使用了受影响版本的Apache Commons Text库，并且将未经处理的用户输入传递给 StringLookupFactory 的变量替换方法（如 replace()）。

**POC 可用性:** 9/10

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 15%

## 详情

POC有效性分析：该POC（Text4Shell）针对Apache Commons Text中的CVE-2022-42889漏洞提供了极其完整的实验环境。它通过Dockerfile构建了一个基于Maven和OpenJDK的自动化编译运行环境，将受影响的库集成到一个简单的Spring Boot/Java Web应用中。POC的核心在于演示了StringSubstitutor类在处理特定前缀（如script、dns、url）时的不安全插值行为。代码中明确展示了如何利用`${script:javascript:...}`语法调用Nashorn引擎执行Java运行时命令。经过分析，该POC逻辑清晰，包含完整的构建脚本、预编译的JAR运行指令以及详细的cURL攻击测试案例。它成功模拟了生产环境中常见的输入点漏洞，验证了攻击者只需发送一个精心构造的GET请求即可在服务器上执行任意代码（如创建文件）。这种漏洞利用方式稳定且不需要复杂的身份验证，证明了漏洞的高危性。利用步骤如下：1. 使用提供的Dockerfile构建镜像，或直接从Docker Hub拉取预建镜像。2. 启动容器并将8080端口映射至宿主机。3. 构造包含恶意Payload的URL，Payload通常使用URL编码处理`${script:javascript:java.lang.Runtime.getRuntime().exec('...')}`。4. 使用cURL发送GET请求至/text4shell/attack?search=接口。5. 通过docker exec进入容器内部，检查/tmp目录下是否存在攻击指令生成的文件（如foo）以验证RCE是否成功。投毒风险分析：该POC项目属于开源防御性研究，代码结构透明，投毒风险处于低水平（约15%）。主要风险点集中在Readme中引导用户执行的`docker pull devenes/text4shell:v1.0`命令。由于Docker镜像层具有黑盒属性，普通用户难以直接审计镜像内部是否植入过时组件或后门。然而，项目同时提供了源代码和Dockerfile，建议安全研究员优先选择本地构建镜像以规避潜在的镜像投毒风险。代码本身不包含混淆、未授权的外联请求或恶意删除指令。POC中使用的`touch /tmp/foo`属于典型的无害验证行为，不应被视为恶意投毒。项目依赖项使用了标准的Maven中央仓库，构建过程符合常规Java开发流程。为了确保绝对安全，组织在测试此类POC时应在隔离的沙箱环境或私有云中运行，并监控容器的网络外联行为，防止由于Dockerfile中的基础镜像（如alpine）被劫持而导致的供应链攻击。总体而言，该POC是一个高质量的教学和防御演示工具，其主要风险来自于第三方镜像托管平台而非代码本身。

**项目地址:** [https://github.com/devenes/text4shell-cve-2022-42889](https://github.com/devenes/text4shell-cve-2022-42889)

**漏洞详情:** [https://nvd.nist.gov/vuln/detail/cve-2022-42889](https://nvd.nist.gov/vuln/detail/cve-2022-42889)
