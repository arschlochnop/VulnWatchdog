## CVE-2022-1471 - SnakeYaml 反序列化远程代码执行 (RCE)

**漏洞编号:** CVE-2022-1471

**漏洞类型:** 反序列化远程代码执行 (RCE)

**影响应用:** SnakeYaml

**危害等级:** 关键

**CVSS评分:** CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H

**影响版本:** SnakeYaml versions <= 1.33

**利用条件:** 无需认证，可通过网络远程访问，攻击复杂度低，无需用户交互

**POC 可用性:** 9

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 10%

## 详情

CVE-2022-1471 漏洞影响 SnakeYaml 库的 Constructor() 类，其核心问题在于在反序列化过程中未对可实例化的类型进行严格限制。这意味着，如果应用程序使用受影响的 SnakeYaml 版本来反序列化攻击者提供的 YAML 内容，攻击者可以构造恶意 YAML 负载，从而在目标系统上实现任意代码执行。这是一个典型的 Java 反序列化漏洞，攻击者通过控制对象图的创建过程，最终能够触发特定方法或执行系统命令。该漏洞的 CVSS v3.0 评分为 9.8（关键），表明其具备极高的危害性和易受利用性。其攻击向量为“网络”（AV:N），攻击复杂度为“低”（AC:L），无需任何权限（PR:N），且无需用户交互（UI:N），这使得攻击者可以无需认证、通过网络远程发起攻击，极大地增加了其威胁程度。

受影响的产品主要是 SnakeYaml 库本身，具体为版本 1.33 及更早版本。任何在其应用程序中集成并使用这些脆弱版本 SnakeYaml 的产品都将面临风险。例如，AWS 已确认 DynamoDB Local 的 1.21 和 2.0 版本中包含了受此漏洞影响的 SnakeYaml 库。此外，`openLooKeng/hetu-core` 项目的 1.33.0 版本也被明确指出受此漏洞影响。因此，广泛使用 SnakeYaml 的 Java 生态系统中的应用程序都需要对其依赖进行审查和更新。

提供的 POC（概念验证）代码质量高且有效，能够清晰地演示 SnakeYaml 远程代码执行漏洞。该 POC 包含一个完整的 Maven 项目，其 `pom.xml` 文件明确依赖于 SnakeYaml 1.33 版本。此外，它还提供了一个 Dockerfile，以便于环境搭建和漏洞复现，以及一个详细的 `README.md` 指南。`README.md` 文件不仅概述了构建应用程序（本地 Maven 或 Docker）、运行易受攻击应用程序的步骤，还指导用户如何与应用程序的序列化/反序列化端点进行交互，并最终实现漏洞利用。利用机制的核心是向目标应用的特定端点发送一个带有精心构造的 YAML 负载的 `POST` 请求。这个 YAML 负载被设计成在反序列化时，促使易受攻击的 SnakeYaml 实例加载并执行一个 Java 对象，该对象会触发一个网络请求（例如 HTTP GET 请求）到攻击者控制的服务器。POC 明确指导用户使用 `python3 -m http.server` 启动一个本地 HTTP 监听器来接收此回调请求，从而验证任意代码（本例中为网络回调）已在目标系统上成功执行。README 中包含的屏幕截图进一步提升了 POC 的清晰度，证实了在从正常序列化/反序列化到成功利用的每个阶段的预期行为。此 POC 对于验证漏洞和理解其技术细节非常有效。

漏洞利用步骤如下：
1.  **设置攻击者监听器**：在攻击者的机器上，启动一个简单的 HTTP 服务器以监听传入连接，例如运行命令 `python3 -m http.server 8000`。
2.  **构建易受攻击的应用程序**：通过在项目目录下运行 `mvn clean compile assembly:single` 命令来构建 POC 应用程序，或者使用 `docker build -t snakeyaml .` 命令构建 Docker 镜像。
3.  **运行易受攻击的应用程序**：执行构建好的应用程序。如果使用 Docker，运行 `docker run --rm -p8080:8080 snakeyaml`。如果直接运行 JAR 包，执行 `java -jar target/snakeyaml-1.0-SNAPSHOT-jar-with-dependencies.jar`。这将启动一个 Web 服务，通常在 8080 端口，并暴露序列化/反序列化端点。
4.  **制作恶意 YAML 负载**：准备一个旨在触发远程代码执行的 YAML 负载。POC 的 `README.md` 暗示了一个负载，它将导致易受攻击的服务器向攻击者的监听器发起一个出站 HTTP 请求。常见的技术包括使用 Java gadget 链（例如通过其他 gadget 调用 `URLClassLoader` 或 `ProcessBuilder`），这些链可以在反序列化过程中被调用。对于简单的回调，可以使用 URL 对象来触发连接。
5.  **发送漏洞利用请求**：向易受攻击应用程序的反序列化端点（例如 `/readYAML`）发送一个 `POST` 请求，请求体中包含恶意 YAML 负载。
6.  **验证漏洞利用**：观察攻击者端的 HTTP 服务器（在步骤 1 中启动）。成功的漏洞利用将导致从易受攻击的服务器接收到 HTTP GET 请求，从而确认精心制作的 YAML 成功触发了代码执行（或作为 RCE 代理的网络回调）。

该 POC 的投毒风险极低，估计约为 10%。这一评估基于对所提供代码和文档的全面审查。`Dockerfile` 使用来自可靠仓库的受信任基础镜像（`maven` 和 `gcr.io/distroless/java:11`），这些都是业界常用的官方镜像。`pom.xml` 文件明确列出了标准且知名的依赖项，如 `junit`、`slf4j-simple`、`snakeyaml` 和 `spark-core`，这些都是 Java 开发中常见的库，未显示任何立即被篡改或恶意的迹象。至关重要的是，POC 代码本身是纯粹为演示目的而设计的；它明确指导用户设置一个“攻击者控制”的 HTTP 服务器（`python3 -m http.server`）来“接收”回调请求，而不是在 POC 内部嵌入任何会连接到未知或不受信任的第三方服务器的恶意逻辑。在 POC 的代码库中，没有发现任何混淆的代码、异常的网络请求，或者尝试下载或执行外部不受信任脚本的行为。整个流程是透明的，专注于说明漏洞的机制。之所以给出 10% 的低风险百分比，主要是考虑到执行任何安全研究代码时都需要保持普遍的谨慎态度，因为即使是无害的代码，如果被修改或在不安全的环境中运行，也可能导致意想不到的后果。然而，就其当前状态而言，这个 POC 是一个合法且安全的工具，供防御性安全研究人员理解和复现 CVE-2022-1471，而无需担心 POC 本身会造成危害。

**项目地址:** N/A

**漏洞详情:** https://www.cve.org/CVERecord?id=CVE-2022-1471
