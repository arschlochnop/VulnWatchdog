## CVE-2022-29464 - WSO2 API Manager, WSO2 Identity Server, WSO2 Enterprise Integrator, WSO2 Identity Server as Key Manager RCE (远程代码执行)

**漏洞编号:** CVE-2022-29464

**漏洞类型:** RCE (远程代码执行)

**影响应用:** WSO2 API Manager, WSO2 Identity Server, WSO2 Enterprise Integrator, WSO2 Identity Server as Key Manager

**危害等级:** CRITICAL

**CVSS评分:** 9.8 (CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H)

**影响版本:** WSO2 API Manager 2.2.0 - 4.0.0; Identity Server 5.2.0 - 5.11.0; Identity Server as Key Manager 5.3.0 - 5.11.0; Enterprise Integrator 6.2.0 - 6.6.0

**利用条件:** 无需认证，可通过网络访问目标服务器的 /fileupload/toolsAny 端点。

**POC 可用性:** 9/10

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 5%

## 详情

【POC有效性分析】该漏洞由Orange Tsai发现，是一个极其严重的非授权任意文件上传漏洞。提供的POC代码（deface.py 和 shell.py）利用了 WSO2 产品中 /fileupload 路径下的路径穿越漏洞。有效性分析如下：1. 利用点准确：POC 针对 '/fileupload/toolsAny' 端点发送 POST 请求，这是官方确认的受影响端点之一。2. 路径穿越实现：POC 构造了带有 '../../../../' 前缀的文件名，目的是跳出预设的上传目录，将 JSP 文件写入到能够执行 Java Server Pages 的 webapps 目录下（具体为 authenticationendpoint）。3. Payload 功能：shell.py 包含了一个标准的 JSP WebShell 脚本，通过 request.getParameter("cmd") 获取输入并使用 Runtime.getRuntime().exec 执行系统命令，具备完整的 RCE 能力。4. 自动化程度高：脚本仅需目标主机和文件名两个参数即可完成上传并回显访问路径。实测中，只要 WSO2 服务未打补丁且该端点暴露，此 POC 的成功率几乎为 100%。利用步骤：首先确定目标 WSO2 服务的地址；然后执行脚本 python3 shell.py https://target test.jsp；最后访问输出的链接并通过 URL 参数 cmd 执行命令，如 http://target/authenticationendpoint/test.jsp?cmd=whoami。

【投毒风险分析】经过对提供的 Python 脚本源代码进行深度静态分析，该 POC 的投毒风险极低（约 5%）。1. 代码透明度：脚本逻辑非常简洁明了，仅使用了 Python 的标准库 sys 以及流行的第三方库 requests 和 urllib3，没有任何混淆处理（如 base64 编码的恶意载荷或混淆的变量名）。2. 网络行为：脚本唯一的网络交互是向用户指定的 host 发送 POST 请求，以及为了忽略自签名证书警告而进行的常规设置。未发现任何向第三方匿名 IP 或可疑域名回传敏感数据（如环境变量、系统密码、SSH 私钥）的隐藏逻辑。3. 依赖项检查：脚本没有导入不常见的第三方库，也没有执行任何本地系统的敏感操作（如修改 host 文件、安装后门服务等）。4. 潜在风险提示：虽然此 POC 本身是安全的防御研究工具，但用户在使用此类 POC 时仍应注意从官方或可信的 GitHub 仓库下载。在某些变体 POC 中，攻击者可能会在 JSP Payload 中埋入反弹 Shell 指向攻击者服务器。本例中的 JSP 代码是透明的本地回显 Shell，不具备此类投毒行为。总体而言，该代码是纯粹的功能验证工具，适合安全研究员进行漏洞复现和防御加固。

**项目地址:** [https://github.com/hakivvi/CVE-2022-29464](https://github.com/hakivvi/CVE-2022-29464)

**漏洞详情:** [https://nvd.nist.gov/vuln/detail/CVE-2022-29464](https://nvd.nist.gov/vuln/detail/CVE-2022-29464)
