## CVE-2022-42889 - Apache Commons Text 远程代码执行 (RCE)

**漏洞编号:** CVE-2022-42889

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Apache Commons Text

**危害等级:** CRITICAL

**CVSS评分:** 9.8 (CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H)

**影响版本:** 1.5 至 1.9

**利用条件:** 应用程序使用了受影响版本的 Apache Commons Text 库，并且通过 StringSubstitutor 类处理了受攻击者控制的不可信输入，且未对 lookup 实例进行安全限制。

**POC 可用性:** 9/10

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 5%

## 详情

【POC有效性分析】该POC（Text4Shell-POC）是一个基于Docker容器化的完整验证环境，其有效性极高。它模拟了一个生产级别的微服务场景：使用 Spring Boot 2.1.1 框架构建 Web 服务，并在 pom.xml 中引入了存在漏洞的 Apache Commons Text 依赖。核心漏洞点在于 StringLookupFactory 类中默认启用的脚本引擎查找器（script lookup）。POC通过一个简单的控制层（Controller）接收名为 'search' 的 URL 参数，并直接将其传递给 StringSubstitutor 进行解析。通过传入特定的 payload 如 '${script:javascript:...}'，攻击者可以利用 Nashorn 脚本引擎执行任意 Java 代码。本 POC 提供的 payload 使用了 java.lang.Runtime.getRuntime().exec() 方法在系统 /tmp 目录下创建文件，这是一个经典的 RCE 验证手段。整个项目结构完整，包含 Dockerfile、Maven 配置及详尽的 README，不仅证明了漏洞的存在，还降低了复现门槛，对安全研究人员评估环境影响非常有价值。经过代码审计，该 POC 逻辑清晰，直接展示了从输入点到触发点的完整调用链，实测可稳定触发。【利用步骤】1. 环境准备：确保本地安装了 Maven 和 Docker 环境。2. 编译打包：在项目根目录执行 'mvn clean install'，通过 pom.xml 下载依赖并生成包含漏洞库的 fat jar。3. 构建镜像：执行 'docker build --tag=text4shell .'，根据 Dockerfile 基于 openjdk:8-jre-alpine 构建镜像。4. 启动容器：运行 'docker run -p 80:8080 text4shell' 将容器 8080 端口映射至宿主机 80 端口。5. 发射载荷：构造 HTTP GET 请求访问 'http://localhost/text4shell/attack?search=' 并在 search 参数中填入经过 URL 编码的 payload。6. 结果验证：进入容器 'docker exec -it <id> bash' 查看 '/tmp' 目录，若存在 'foo' 文件则证明利用成功。【投毒风险分析】本 POC 仓库的投毒风险极低。首先，其代码逻辑透明且符合标准 Java 开发规范，pom.xml 中引用的均是官方公共仓库的依赖（虽然包含有漏洞的库，但这是实验所需）。Dockerfile 基于官方 Alpine 镜像，未发现通过 curl 或 wget 下载执行外部不明脚本的行为。关键的 README 示例代码展示的是无害的 'touch /tmp/foo' 命令，而非反弹 Shell 或敏感信息窃取指令。尽管如此，从防御性研究角度看，仍需关注两个潜在点：第一，在运行 'mvn clean install' 时，Maven 会从配置的中央仓库下载大量依赖，需确保本地 settings.xml 未被指向恶意私服。第二，虽然当前 payload 是安全的，但在复杂的自动化安全工具链中，如果直接引用外部未经审计的 POC，攻击者可能将脚本执行部分替换为静默下载木马的指令。由于本 POC 主要是本地构建和运行，且代码量小、易于审计，未发现混淆代码或异常网络外连行为，综合评估投毒风险处于低位，但在导入生产网的安全实验室前，仍建议在隔离的沙箱中完成构建。

**项目地址:** [https://github.com/karthikuj/cve-2022-42889-text4shell-poc](https://www.google.com/search?q=https://github.com/karthikuj/cve-2022-42889-text4shell-poc)

**漏洞详情:** [https://nvd.nist.gov/vuln/detail/CVE-2022-42889](https://nvd.nist.gov/vuln/detail/CVE-2022-42889)
