## CVE-2021-3129 - Laravel (Ignition组件) RCE

**漏洞编号:** CVE-2021-3129

**漏洞类型:** RCE

**影响应用:** Laravel (Ignition组件)

**危害等级:** CRITICAL

**CVSS评分:** 9.8

**影响版本:** Laravel <= 8.4.2, Ignition < 2.5.2

**利用条件:** Laravel开启Debug模式，且使用了受影响版本的Ignition组件。

**POC 可用性:** 9/10

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 15%

## 详情

POC有效性分析：该漏洞存在于Laravel框架默认集成的Ignition错误页面组件中。当Debug模式开启时，Ignition通过其自带的‘解决方案（Solutions）’机制，允许开发者点击按钮来修复某些常见错误。其中，MakeViewVariableOptionalSolution类在处理viewFile参数时，未对用户输入进行严格过滤。POC通过利用php://filter伪协议对本地日志文件（laravel.log）进行多次编码转换（如convert.iconv和quoted-printable-encode），从而将日志中的受控垃圾字符清除并构造成一个合法的Phar（PHP Archive）反序列化载荷。利用步骤如下：1. 首先通过多次发送特定请求来清除当前的laravel.log文件内容。2. 发送包含精心构造的Base64编码Phar Payload的请求，由于Ignition会将错误参数记录到日志中，该Payload被写入到laravel.log。3. 再次使用php://filter进行二次解码，将日志内容还原为二进制Phar格式。4. 最后，通过phar://协议访问该日志文件，触发反序列化。根据POC代码分析，该脚本实现了完整的自动化流程，包括log清理、payload注入和最终触发，通过集成‘哥斯拉（Godzilla）’Webshell进行后续控制。该POC具有极高的实用价值和稳定性，在开启Debug模式的Laravel环境中几乎可以实现一键Getshell。投毒风险分析：经过对提供的Python代码进行静态分析，发现该脚本主要依赖于requests和json库，并未发现混淆后的恶意Payload或外部隐蔽通信。POC中涉及的‘viewFile’参数内的十六进制长字符串经过还原后，确认为用于触发反序列化漏洞的Phar文件结构，其目的是在目标服务器上植入Webshell。虽然该操作在受害者服务器上具有破坏性，但它是该漏洞利用脚本的预期功能。脚本中未见窃取执行者本地凭据、扫描执行者内网或连接到攻击者控制的C2服务器的逻辑。代码逻辑相对透明，主要逻辑集中在利用PHP伪协议处理目标日志。虽然使用了代理配置（127.0.0.1:8080），但这通常是出于调试目的。整体来看，该脚本本身对执行者的风险较低，属于常规的安全研究工具，投毒风险评估为15%左右，主要预防执行者在使用过程中误操作导致目标环境不可逆的日志损毁。

**项目地址:** [https://github.com/ambionics/laravel-exploits](https://github.com/ambionics/laravel-exploits) (参考源)

**漏洞详情:** [https://nvd.nist.gov/vuln/detail/CVE-2021-3129](https://nvd.nist.gov/vuln/detail/CVE-2021-3129)
