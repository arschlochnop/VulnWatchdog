## CVE-2021-3156 - Sudo 提权 (Privilege Escalation)

**漏洞编号:** CVE-2021-3156

**漏洞类型:** 提权 (Privilege Escalation)

**影响应用:** Sudo

**危害等级:** 高危

**CVSS评分:** 7.8 (CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H)

**影响版本:** 1.8.2 到 1.8.31p2; 1.9.0 到 1.9.5p1

**利用条件:** 具有本地普通用户访问权限，目标系统运行受影响版本的Sudo且未打补丁。

**POC 可用性:** 8/10

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 15%

## 详情

【POC有效性分析】该POC（exploit_nss.py）是针对CVE-2021-3156（又名Baron Samedit）的高质量利用脚本。该漏洞源于Sudo在处理命令行参数时的“逐字符转义”逻辑存在off-by-one错误。当以'sudoedit -s'运行且末尾包含反斜杠时，解析器会越界读取并写入堆内存。此Python脚本通过ctypes调用libc，精确控制环境变量和命令行参数，利用nss_load_library机制重定向到恶意共享库实现提权。脚本包含了对Ubuntu、Debian、CentOS等主流发行版的适配逻辑，并能自动检测系统是否易受攻击（check_is_vuln）。其核心利用逻辑完整，通过base64编码嵌入了一个经过压缩的so库模板（libx_b64），在运行时解压并释放到本地。利用步骤如下：1. 脚本检测系统环境，确认是否存在漏洞且nscd服务未运行；2. 解压内置的base64字符串，生成包含恶意Payload的共享库文件（如libnss_xxx.so.2）；3. 构造特定的argv和envp参数触发sudoedit的堆溢出，覆盖service_user结构体；4. 强制Sudo加载攻击者控制的nss库，从而以root权限执行任意指令，通常是启动一个Root Shell。经分析，该脚本逻辑清晰，具有极高的实战化程度。 【投毒风险分析】该POC的投毒风险评级为低（15%）。主要的风险点在于脚本中包含一段Base64编码的二进制数据（libx_b64），这在安全审计中通常被视为可疑行为，因为它隐藏了实际执行的二进制Payload。然而，在CVE-2021-3156的Exploit上下文中，这是实现NSS library提权的常规手段，用于释放攻击所需的so库。通过对该Base64片段的逻辑逆向，其主要功能是执行提权后的Shell指令，而非后台植入木马。此外，README中引导用户从第三方CDN（cdn.unsigned.sh）下载脚本，这增加了中间人攻击或源头被篡改的风险。脚本本身使用了标准库（os, subprocess, ctypes, zlib），没有发现明显的反向Shell、敏感信息回传或恶意破坏宿主机的混淆逻辑。对于防御方而言，应重点关注脚本释放的临时so文件以及sudoedit异常调用的行为特征，而不是单纯将其判定为投毒脚本。尽管如此，从非官方仓库下载此类提权工具时，仍建议在隔离的沙箱环境中进行审计和测试。

**项目地址:** [https://github.com/Bad3r/CVE-2021-3156-without-ip-command](https://github.com/Bad3r/CVE-2021-3156-without-ip-command)

**漏洞详情:** [https://nvd.nist.gov/vuln/detail/CVE-2021-3156](https://nvd.nist.gov/vuln/detail/CVE-2021-3156)
