## CVE-2021-4034 - Polkit (pkexec) 本地权限提升 (LPE)

**漏洞编号:** CVE-2021-4034

**漏洞类型:** 本地权限提升 (LPE)

**影响应用:** Polkit (pkexec)

**危害等级:** 高危

**CVSS评分:** 7.8 (CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H)

**影响版本:** 所有主流 Linux 发行版中包含 polkit 的版本（自 2009 年引入以来）

**利用条件:** 攻击者必须拥有目标系统的本地普通用户账户访问权限。

**POC 可用性:** 10/10

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 15%

## 详情

POC有效性分析：该漏洞被称为“PwnKit”，利用了 polkit 中 pkexec 程序的内存越界写入漏洞。当 argc 为 0 时，pkexec 会错误地处理环境变量。通过 POC 代码分析，`cve-2021-4034.c` 构造了一个空的参数列表并精心设计了环境变量数组，其中包含 `GCONV_PATH` 相关的特殊路径。`pwnkit.c` 被编译为共享库 `pwnkit.so`。当 pkexec 执行时，它会触发 glibc 的 `gconv` 转换机制，由于环境变量被篡改，pkexec 会加载并执行攻击者提供的恶意共享库。在该 POC 中，`gconv_init` 函数被触发，调用 `setuid(0)` 和 `setgid(0)` 将进程权限提升为 root，随后通过 `execve` 启动一个 root shell。此 POC 逻辑闭环，直接利用了 Linux 系统底层的环境变量处理缺陷，不需要任何特殊的复杂环境，具有极高的实战有效性和稳定性。利用步骤：1. 将 `pwnkit.c`、`cve-2021-4034.c` 和 `Makefile` 上传至目标服务器；2. 运行 `make` 命令编译代码，生成 `pwnkit.so` 插件和 `cve-2021-4034` 触发器；3. 运行编译出的 `cve-2021-4034` 可执行文件；4. 程序将触发 pkexec 漏洞并弹出具有 root 权限的终端。投毒风险分析：该提供的 POC 代码具有一定的投毒风险，主要体现在其外连脚本 `cve-2021-4034.sh` 中。该脚本使用 `curl` 和 `wget` 尝试从远程 URL (`raw.githubusercontent.com/berdav/CVE-2021-4034/main/`) 下载额外的源代码。这种行为在不安全的网络环境中存在“中间人攻击”或“供应链污染”的风险。如果远程仓库被篡改，攻击者可以替换其中的 `pwnkit.c` 或 `Makefile` 以包含静默后门（例如反弹 shell 或凭据窃取脚本）。此外，`Makefile` 中包含自动化执行逻辑，如果用户在未审查代码的情况下直接执行 `make` 或 `.sh` 脚本，可能会在获取 root 权限的同时，也被植入隐藏的恶意逻辑。然而，核心 C 代码（`pwnkit.c` 和 `cve-2021-4034.c`）逻辑清晰、透明，未发现混淆或明显的恶意后门。综合评估，该 POC 属于高质量安全研究代码，投毒风险处于低至中等水平（15%），风险主要来自于自动化下载脚本的可信度，建议安全研究人员在离线环境中使用已下载并人工审计过的源码。

**项目地址:** [https://github.com/berdav/CVE-2021-4034](https://github.com/berdav/CVE-2021-4034)

**漏洞详情:** [https://nvd.nist.gov/vuln/detail/CVE-2021-4034](https://nvd.nist.gov/vuln/detail/CVE-2021-4034)
