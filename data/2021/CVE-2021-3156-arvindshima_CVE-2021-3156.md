## CVE-2021-3156 - Sudo 堆缓冲区溢出 (Heap-based Buffer Overflow)

**漏洞编号:** CVE-2021-3156

**漏洞类型:** 堆缓冲区溢出 (Heap-based Buffer Overflow)

**影响应用:** Sudo

**危害等级:** 高危 (High)

**CVSS评分:** 7.8 (CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H)

**影响版本:** 1.8.2 到 1.8.31p2; 1.9.0 到 1.9.5p1

**利用条件:** 具有本地普通用户访问权限，系统安装有受影响版本的Sudo

**POC 可用性:** 9/10

**POC 类型:** 完整利用

**攻击复杂度:** 中

**投毒风险:** 5%

## 详情

POC有效性分析：该漏洞被称为“Baron Samedit”，是Sudo在处理命令行参数时的逻辑缺陷导致的。当以shell模式运行sudoedit（通过-s或-i参数）时，Sudo会转义反斜杠。然而，如果命令行参数以单个反斜杠结尾，解析逻辑会错误地跳过空字符并继续读取后续内存，导致堆溢出。提供的POC代码非常完整且具有高度的可执行性。Dockerfile构建了一个受影响的Ubuntu 20.04环境，并安装了特定版本1.8.31-1ubuntu1的Sudo。exploit.c利用了堆风水（Heap Feng-Shui）技术，通过LC_MESSAGES等环境变量精确布局内存，使得溢出的缓冲区能够覆盖到关键的service_user结构体。通过将该结构体中的库路径覆盖为攻击者可控的libnss_x/x.so.2，当Sudo后续调用NSS（Name Service Switch）时，会加载并执行攻击者编译的恶意共享对象，从而获取root权限。由于POC包含了完整的编译指令（Makefile）和环境模拟（Dockerfile），其验证逻辑闭环，成功率极高。利用步骤：1. 在受影响系统上准备编译环境，或使用提供的Dockerfile构建容器。2. 编写shellcode.c，将其编译为共享对象文件（如x.so.2），并放置在特定目录下。3. 编译exploit.c生成二进制执行文件。4. 运行exploit。程序会设置包含恶意末尾反斜杠的argv数组，并精心构造环境变量envp来布置堆空间。5. 程序执行sudoedit，触发溢出覆盖NSS配置，随后Sudo加载x.so.2，由于该库是以root权限加载的，攻击者即可在so的初始化函数中执行任意代码（如/bin/bash）实现提权。投毒风险分析：该POC代码表现出极高的透明度和专业性，属于典型的安全研究产物。代码中使用了标准的C库函数如execve、strcat、memset等，没有发现任何混淆、加密或尝试隐藏恶意意图的行为。Makefile和Dockerfile清晰地定义了构建流程，所有操作均在本地工作目录下进行，未发现尝试向外部服务器发起未经授权的连接。shellcode.c（虽在截断部分未完全显示，但从Makefile推断）通常仅包含提权逻辑。代码注释明确引用了Qualys的研究报告，展现了良好的溯源性。虽然该代码具备强大的提权能力，但其设计初衷是用于漏洞验证和安全评估，而非后门植入。该POC唯一的潜在风险在于其高度的易用性，可能被低技术水平的攻击者（Script Kiddies）直接利用，但在威胁情报防御视角下，其作为工具的安全性是可控的。分析未发现任何针对研究人员本机的侧向攻击载荷，投毒风险评估为极低。

**项目地址:** [https://blog.qualys.com/vulnerabilities-research/2021/01/26/cve-2021-3156-heap-based-buffer-overflow-in-sudo-baron-samedit](https://blog.qualys.com/vulnerabilities-research/2021/01/26/cve-2021-3156-heap-based-buffer-overflow-in-sudo-baron-samedit)

**漏洞详情:** [https://nvd.nist.gov/vuln/detail/CVE-2021-3156](https://nvd.nist.gov/vuln/detail/CVE-2021-3156)
