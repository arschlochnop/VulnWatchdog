## CVE-2021-3156 - Sudo 堆缓冲区溢出 (Heap-based Buffer Overflow)

**漏洞编号:** CVE-2021-3156

**漏洞类型:** 堆缓冲区溢出 (Heap-based Buffer Overflow)

**影响应用:** Sudo

**危害等级:** 高危 (High)

**CVSS评分:** 7.8 (CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H)

**影响版本:** Sudo 1.8.2 到 1.8.31p2; 1.9.0 到 1.9.5p1

**利用条件:** 本地普通用户访问权限，无需目标账户密码，无需在sudoers文件中配置权限

**POC 可用性:** 4/10

**POC 类型:** 概念验证

**攻击复杂度:** 低

**投毒风险:** 5%

## 详情

POC有效性分析：本漏洞被称为'Baron Samedit'，其根源在于Sudo处理命令行参数时的逻辑缺陷。当用户以shell模式（-s或-i参数）运行sudoedit时，Sudo会将命令行参数中的反斜杠进行转义。然而，由于代码中存在‘off-by-one’错误，如果参数以单个反斜杠结尾，解析器会越过缓冲区边界读取并写入后续内存，导致堆溢出。输入的POC代码通过perl生成大量字符并结合特定结尾的反斜杠，旨在触发malloc()内存管理器的异常。该POC属于检测型代码，能有效验证目标系统是否存在内存破坏特征（如出现'malloc(): corrupted top size'或'Aborted'），但不具备自动完成权限提升的功能。真正的RCE或提权利用需要通过复杂的堆布局操作来覆盖特定结构体（如nss_groups），对环境依赖性较强。利用步骤：首先，用户需在本地终端执行版本检查指令，确认Sudo版本处于受影响区间。其次，执行提供的检测命令：sudoedit -s '\' `perl -e 'print "A" x 65536'`。如果系统返回内存崩溃错误信息，则代表溢出成功触发，系统处于易受攻击状态。如果系统提示“-s and -i are mutually exclusive”或类似拒绝执行的信息，则表明已应用补丁。投毒风险分析：该POC代码主要由标准系统命令（sudoedit）和Perl单行脚本组成，代码结构透明且易于审计。由于其主要功能是产生内存溢出导致程序崩溃（Crash），而非下载远程执行脚本或修改系统关键文件，因此直接投毒风险极低。分析显示，代码中未发现混淆、base64编码的可疑载荷或未经授权的网络连接尝试。其行为符合典型的防御性扫描逻辑，旨在验证漏洞存在性而非实施恶意控制。然而，防御者仍需注意，在生产环境中运行此类POC可能会导致sudo服务进程崩溃产生Core Dump，在极少数情况下可能影响系统稳定性。建议在隔离的沙箱或开发测试环境中进行验证，以避免对业务连续性造成干扰。

**项目地址:** [https://github.com/qualys/CVE-2021-3156](https://www.google.com/search?q=https://github.com/qualys/CVE-2021-3156)

**漏洞详情:** [https://nvd.nist.gov/vuln/detail/CVE-2021-3156](https://nvd.nist.gov/vuln/detail/CVE-2021-3156)
