## CVE-2021-3156 - Sudo 堆缓冲区溢出 (Heap-based Buffer Overflow)

**漏洞编号:** CVE-2021-3156

**漏洞类型:** 堆缓冲区溢出 (Heap-based Buffer Overflow)

**影响应用:** Sudo

**危害等级:** 高危 (High)

**CVSS评分:** 7.8 (CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H)

**影响版本:** 1.8.2 至 1.8.31p2; 1.9.0 至 1.9.5p1

**利用条件:** 本地用户权限，无需认证，无需在sudoers列表中

**POC 可用性:** 9/10

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 15%

## 详情

POC有效性分析：本漏洞被称为'Baron Samedit'，是Sudo工具中一个极其严重且存在时间超过10年的漏洞。该漏洞源于Sudo在处理命令行参数时的off-by-one错误。当以shell模式执行sudoedit（如使用-s或-i参数）且参数以单个反斜杠结尾时，parse_args()函数会在未正确转义的情况下进行内存拷贝，导致堆缓冲区溢出。Qualys提供的研究文档非常详尽，明确指出了代码中571-617行的逻辑缺陷。该POC证明了攻击者即使没有任何sudo权限（甚至不在sudoers文件中），也可以绕过身份验证并直接获得root权限。利用步骤如下：1. 调用sudoedit并附加特定参数，如使用'-s'标志启用shell模式。2. 构造一个以单个反斜杠 '\' 结尾的恶意字符串作为命令行参数。3. 触发Sudo内部的parse_args函数，该函数会错误地跳过空终止符，并将后续内存数据视为输入进行处理，从而覆盖堆上的数据结构。4. 通过精心构造溢出数据覆盖特定的结构（如service_user结构），重定向函数指针或加载恶意共享库，最终实现本地提权。经过实测，该漏洞在Ubuntu 20.04、Debian 10和Fedora 33等主流发行版上具有极高的成功率。 投毒风险分析：该漏洞由于影响范围极广且利用相对简单，是威胁情报监测的重点。由于POC涉及到内存地址的精准覆盖，不同发行版、不同版本的libc和Sudo二进制文件的堆布局存在差异，因此针对特定目标的POC往往需要针对性的偏移量调整。在网络上流传的大多数针对CVE-2021-3156的利用脚本中，存在投毒风险的主要是那些声称'一键全自动利用'的二进制预编译程序或高度混淆的Python/Shell脚本。攻击者可能在脚本中潜伏反弹shell代码，在执行提权尝试的同时将受害者的敏感信息（如/etc/shadow）外发。但在本次分析的Qualys公开文档中，代码逻辑清晰，属于典型的白帽研究报告，未发现恶意混淆或后门植入。防御建议应聚焦于及时升级Sudo至1.9.5p2或更高版本，或通过配置systemtap等临时方案拦截相关系统调用。

**项目地址:** [https://www.qualys.com/2021/01/26/cve-2021-3156/baron-samedit-heap-based-overflow-sudo.txt](https://www.qualys.com/2021/01/26/cve-2021-3156/baron-samedit-heap-based-overflow-sudo.txt)

**漏洞详情:** [https://nvd.nist.gov/vuln/detail/CVE-2021-3156](https://nvd.nist.gov/vuln/detail/CVE-2021-3156)
