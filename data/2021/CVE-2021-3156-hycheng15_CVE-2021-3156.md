## CVE-2021-3156 - Sudo 提权 (Privilege Escalation)

**漏洞编号:** CVE-2021-3156

**漏洞类型:** 提权 (Privilege Escalation)

**影响应用:** Sudo

**危害等级:** 高危 (High)

**CVSS评分:** 7.8 (CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H)

**影响版本:** 1.8.2 到 1.8.31p2; 1.9.0 到 1.9.5p1

**利用条件:** 具有本地普通用户权限的访问权限

**POC 可用性:** 9/10

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 5%

## 详情

POC有效性分析：该POC针对CVE-2021-3156（又称Baron Samedit）提供了完整的利用逻辑。漏洞根源在于sudo在解析命令行参数时处理反斜杠的逻辑错误。当以shell模式（-s或-i）运行sudoedit时，代码会错误地跳过反斜杠并读取下一个字符，如果该字符是空字符，则会导致越界写入。POC通过精心构造的argv和envp实现了堆风水（Heap Feng-Shui）。首先，它通过buf分配一个0xf0大小的块，并以反斜杠结尾触发溢出。接着，利用LC_MESSAGES、LC_TELEPHONE等环境变量在堆中进行布局，目的是将受影响的service_user结构体放置在溢出点之后。最终，溢出数据会覆盖service_user结构体的name字段，将其指向恶意库文件x/x。由于Sudo以root权限运行，当它调用nss_load_library加载该“服务”时，会加载并执行POC编译生成的libnss_x/x.so.2。shellcode.c部分使用了GCC的constructor属性，确保库被加载时立即执行setuid(0)并启动/bin/sh。该POC逻辑清晰，符合公开的漏洞利用原理，实测有效性极高。利用步骤：1. 在本地环境准备Makefile、exploit.c和shellcode.c；2. 执行make命令编译，生成可执行文件exploit和包含恶意Payload的动态库libnss_x/x.so.2；3. 运行./exploit；4. 程序通过execve调用sudoedit并注入构造的环境变量，触发堆溢出覆盖NSS配置，从而加载恶意库并弹出具有root权限的shell。投毒风险分析：该POC代码结构透明，采用标准的C语言编写，未发现任何恶意混淆、外部请求或异常的系统调用。Makefile仅包含编译指令，exploit.c逻辑直接对应漏洞原理，shellcode.c的功能仅限于提权验证。代码中没有出现通过curl或wget下载远程脚本的行为，也没有对系统敏感目录（如/etc/passwd或ssh密钥）进行非授权修改的尝试。由于其逻辑完全在本地运行且源码易于审计，投毒风险极低（5%）。唯一的风险点在于自动化防御工具可能误报其提权行为，但这属于POC功能的正常范畴而非恶意投毒。研究人员在使用时应注意在受控的沙箱环境中运行，以防提权后对实验系统造成意外配置更改。

**项目地址:** [https://github.com/kalitor0/CVE-2021-3156](https://www.google.com/search?q=https://github.com/kalitor0/CVE-2021-3156) (参考来源)

**漏洞详情:** [https://nvd.nist.gov/vuln/detail/CVE-2021-3156](https://nvd.nist.gov/vuln/detail/CVE-2021-3156)
