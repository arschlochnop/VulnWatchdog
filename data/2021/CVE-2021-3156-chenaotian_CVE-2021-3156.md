## CVE-2021-3156 - Sudo 堆缓冲区溢出 (Heap-based Buffer Overflow)

**漏洞编号:** CVE-2021-3156

**漏洞类型:** 堆缓冲区溢出 (Heap-based Buffer Overflow)

**影响应用:** Sudo

**危害等级:** 高危 (High)

**CVSS评分:** 7.8 (CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H)

**影响版本:** 1.8.2 到 1.8.31p2; 1.9.0 到 1.9.5p1

**利用条件:** 本地普通用户权限，sudo以SUID权限运行且支持sudoedit

**POC 可用性:** 9/10

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 15%

## 详情

POC有效性分析：该漏洞被称为“Baron Samedit”，是Sudo程序中一个严重的提权漏洞。漏洞根源在于Sudo对命令行参数中反斜杠（\）处理不当。当以‘sudoedit -s’模式运行时，程序会调用parse_args函数处理参数，如果参数以单个反斜杠结尾，后续的set_cmnd函数在拼接字符串时会发生off-by-one错误，导致跳过空字符并继续读取内存，最终触发堆溢出。POC代码通过精心构造的环境变量和溢出数据来覆盖glibc的堆管理结构（如service_user结构体），从而在执行过程中劫持控制流。经分析，所提供的POC包含完整的源码、调试环境（Docker）和编译后的二进制文件，能实现从普通用户到root的稳定提权。利用步骤：1. 进入提供的Docker容器环境；2. 切换至低权限用户test；3. 编译exp.c源码生成可执行文件；4. 执行./exp，程序将构造恶意的argv和envp参数触发sudoedit溢出；5. 溢出成功后，程序会通过覆盖目标结构体获取root shell，用户可通过whoami验证权限提升。投毒风险分析：该POC项目属于开源安全研究性质，其代码逻辑清晰，主要由C语言编写，依赖标准的系统库。代码中未发现明显的恶意混淆、外部非法反弹Shell脚本或针对研究者本机的破坏性指令。然而，由于该项目提供了预编译的二进制文件（exp），且在README中引导用户直接运行，这构成了一定的低度风险。攻击者可能在编译好的二进制文件中植入恶意负载，而源码中却保持洁净。此外，提供的Docker镜像托管在第三方个人仓库（chenaotian/cve-2021-3156），虽然极大方便了环境搭建，但镜像层可能包含后门程序。防御性研究员在分析时应优先审计源码并自行编译，避免直接在宿主机运行未经审计的二进制文件，以防范潜在的供应链投毒风险。总体而言，该POC投毒风险较低，主要风险点在于第三方容器镜像和预编译文件。

**项目地址:** [https://hub.docker.com/r/chenaotian/cve-2021-3156](https://hub.docker.com/r/chenaotian/cve-2021-3156)

**漏洞详情:** [https://nvd.nist.gov/vuln/detail/CVE-2021-3156](https://nvd.nist.gov/vuln/detail/CVE-2021-3156)
