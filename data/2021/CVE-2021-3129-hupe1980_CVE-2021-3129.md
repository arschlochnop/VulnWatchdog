## CVE-2021-3129 - Laravel (Ignition组件) RCE (远程代码执行)

**漏洞编号:** CVE-2021-3129

**漏洞类型:** RCE (远程代码执行)

**影响应用:** Laravel (Ignition组件)

**危害等级:** 严重 (Critical)

**CVSS评分:** 9.8

**影响版本:** Ignition <= 2.5.1 (常见于 Laravel <= 8.4.2)

**利用条件:** 系统开启 Debug 模式且安装了 Ignition 组件 (2.5.2版本以下)

**POC 可用性:** 9/10

**POC 类型:** 完整利用

**攻击复杂度:** 中

**投毒风险:** 15%

## 详情

POC有效性分析：该漏洞存在于Laravel框架默认的错误处理组件Ignition中。当网站开启Debug模式时，Ignition允许用户通过`/_ignition/execute-solution`接口执行预定义的'Solutions'。漏洞的核心在于`MakeViewVariableOptionalSolution`类，它在处理`viewFile`参数时未对输入路径进行有效校验，导致攻击者可以利用PHP的`file_get_contents()`和`file_put_contents()`函数。通过结合PHP伪协议（如`php://filter`）和日志文件写入机制，攻击者可以将恶意代码注入到Laravel的日志文件（laravel.log）中。随后，利用PHP的反序列化特性，配合特定的过滤器将日志内容转换为合法的Phar文件格式。最后，通过`phar://`协议触发反序列化攻击链，实现任意代码执行。本POC（exploit.py）完整实现了这一逻辑：首先尝试清空日志，接着通过发送构造的字符序列写入Phar payload，通过多次过滤器叠加绕过编码限制，最后触发Payload执行系统命令（如whoami）。该POC结构完整，利用链逻辑严密，在符合环境要求的测试中成功率极高。利用步骤：1. 确认目标开启了Debug模式且存在`/_ignition/execute-solution`路由。2. 使用`phpggc`工具生成针对目标依赖环境（如Monolog/RCE1）的Phar序列化载荷。3. 运行exploit脚本，脚本会通过POST请求分批次向`laravel.log`写入经过编码的Payload。4. 脚本通过`php://filter`中的多种转换过滤器对日志进行重写，使其在内存中还原为合法的Phar二进制流。5. 脚本调用`phar://`路径访问日志文件，触发反序列化并执行命令。投毒风险分析：该脚本主要基于标准的`requests`库和逻辑处理。分析其代码结构，其行为模式完全符合CVE-2021-3129的公开利用方案，未发现隐藏的远程恶意下载、反弹Shell至第三方服务器或窃取本地凭证的混淆代码。脚本开头显式声明了Payload的生成方式和用途，透明度较高。Payload部分（phar变量）经过Base64解码后，其内容为典型的Monolog利用链调用`system('whoami')`，这属于合法的安全验证范畴。然而，由于脚本具备高度的自动化和破坏性（如频繁写入和重写日志），在未授权环境下使用具有极高的法律风险。同时，虽然此特定脚本较为安全，但防御者应警惕其他来源中可能存在的‘改进版’，尤其是那些经过混淆、需要额外下载依赖包或在执行成功后偷偷将目标权限发送到匿名外部API的变种。对于此类高风险POC，建议在严格隔离的沙箱环境运行，并重点监控Python进程的非预期网络外联行为。

**项目地址:** [https://github.com/ambionics/phpggc](https://github.com/ambionics/phpggc)

**漏洞详情:** [https://nvd.nist.gov/vuln/detail/CVE-2021-3129](https://nvd.nist.gov/vuln/detail/CVE-2021-3129)
