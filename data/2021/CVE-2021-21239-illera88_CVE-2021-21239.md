# CVE-2021-21239

> ğŸ“¦ è¯¥CVEæœ‰ **3** ä¸ªç›¸å…³POCä»“åº“

---

## POC #1

**æ¥æº**: [CVE-2021-21239-GrantBirki_redash-vulnerable.md](../2021/CVE-2021-21239-GrantBirki_redash-vulnerable.md)

## CVE-2021-21239-pysaml2-ç­¾åç»•è¿‡

**æ¼æ´ç¼–å·:** CVE-2021-21239

**æ¼æ´ç±»å‹:** ç­¾åç»•è¿‡

**å½±å“åº”ç”¨:** pysaml2

**å±å®³ç­‰çº§:** ä¸­å±ï¼Œå¯èƒ½å¯¼è‡´èº«ä»½è®¤è¯ç»•è¿‡ï¼Œè¿›è€Œæœªæˆæƒè®¿é—®

**å½±å“ç‰ˆæœ¬:** < 6.5.0

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡ç³»ç»Ÿä½¿ç”¨pysaml2ä½œä¸ºSAMLè®¤è¯åº“ï¼Œå¹¶ä¸”ä½¿ç”¨é»˜è®¤çš„CryptoBackendXmlSec1åç«¯ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2021-21239æ˜¯pysaml2ä¸­çš„ä¸€ä¸ªç­¾åéªŒè¯æ¼æ´ã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡æ„é€ æ¶æ„çš„SAMLå“åº”ï¼Œåˆ©ç”¨xmlsec1é»˜è®¤æ¥å—ä»»æ„ç±»å‹å¯†é’¥çš„ç‰¹æ€§ï¼ŒåµŒå…¥RSAå¯†é’¥å¹¶ç»•è¿‡ç­¾åéªŒè¯ã€‚  

**æœ‰æ•ˆæ€§ï¼š**
æ ¹æ®æ¼æ´åº“ä¿¡æ¯ã€æœç´¢å¼•æ“ç»“æœå’Œæä¾›çš„PoCä»£ç ï¼Œå¯ä»¥åˆ¤æ–­æ­¤æ¼æ´æ˜¯æœ‰æ•ˆçš„ã€‚æ¼æ´åº“ä¿¡æ¯æ˜ç¡®æŒ‡å‡ºpysaml2 < 6.5.0 å­˜åœ¨ç­¾åéªŒè¯é—®é¢˜ï¼Œä¸”æœ‰å…¬å¼€çš„PoCå¯ä»¥åˆ©ç”¨ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
PoCä»£ç  `poc.py` å±•ç¤ºäº†å¦‚ä½•æ„é€ æ¶æ„çš„SAMLå“åº”ã€‚å…¶åˆ©ç”¨æ–¹å¼ä¸ºï¼š
1.  ç”Ÿæˆä¸€ä¸ªç”¨äºä¼ªé€ ç­¾åä½¿ç”¨çš„RSAå¯†é’¥å¯¹ã€‚
2.  æ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„æ–­è¨€ï¼ˆAssertionï¼‰çš„SAMLå“åº”ï¼Œå°†æ”»å‡»è€…çš„å…¬é’¥åµŒå…¥åˆ°`KeyInfo`æ ‡ç­¾çš„`KeyValue`ä¸­ï¼Œè€Œéä½¿ç”¨X.509è¯ä¹¦ã€‚
3.  ç”±äº`xmlsec1`é»˜è®¤æ¥å—åµŒå…¥çš„RSAå¯†é’¥ï¼Œå› æ­¤åœ¨æœåŠ¡ç«¯éªŒè¯ç­¾åæ—¶ï¼Œä¼šä½¿ç”¨æ”»å‡»è€…æä¾›çš„å…¬é’¥è¿›è¡ŒéªŒè¯ï¼Œä»è€Œç»•è¿‡æ­£å¸¸çš„è¯ä¹¦éªŒè¯ã€‚
4.  å°†æ„é€ çš„SAMLå“åº”å‘é€åˆ°ç›®æ ‡RedashæœåŠ¡å™¨çš„SAMLå›è°ƒåœ°å€ï¼Œå®ç°èº«ä»½è®¤è¯ç»•è¿‡ã€‚

**æŠ•æ¯’é£é™©ï¼š**
è™½ç„¶æä¾›çš„`docker-compose.yml` å’Œ `README.md`æ–‡ä»¶å¯èƒ½åŒ…å«é…ç½®ç›¸å…³çš„ä¿¡æ¯ï¼Œå¸®åŠ©æ­å»ºæ¼æ´ç¯å¢ƒï¼Œä½†æ˜¯æ ¸å¿ƒçš„æ”»å‡»ä»£ç åœ¨`poc.py`ä¸­ã€‚ æ£€æŸ¥`poc.py`ï¼Œå‘ç°å…¶ä¸»è¦é€»è¾‘æ˜¯æ„é€ æ¶æ„çš„SAMLå“åº”ä»¥åˆ©ç”¨æ¼æ´ã€‚ä»£ç æœ¬èº«æ²¡æœ‰æ˜æ˜¾çš„åé—¨æˆ–æ¶æ„è¡Œä¸ºã€‚`docker-compose.yml`ä¸­ä½¿ç”¨çš„æ˜¯redash/redash:10.0.0.b50363è¿™ä¸ªé•œåƒï¼Œè¿™æ˜¯ä¸€ä¸ªå…¬å¼€çš„Redashé•œåƒï¼Œé™ä½äº†æŠ•æ¯’çš„å¯èƒ½ã€‚ä½†æ˜¯ï¼Œä»ç„¶å­˜åœ¨ä¸€å®šçš„æŠ•æ¯’é£é™©ï¼Œä¾‹å¦‚ï¼š
1.  ä½œè€…å¯èƒ½åœ¨`script/server`è„šæœ¬ä¸­æ·»åŠ äº†æ¶æ„ä»£ç ã€‚
2.  docker-compose.ymlæ–‡ä»¶ä¸­æŒ‡å®šçš„redashé•œåƒå¯èƒ½è¢«ç¯¡æ”¹ã€‚

è€ƒè™‘åˆ°redashé•œåƒçš„å…¬å¼€æ€§å’Œpoc.pyä»£ç çš„ç›¸å¯¹ç®€å•æ€§ï¼Œä»¥åŠè„šæœ¬æ–‡ä»¶ä¸­å¯èƒ½å­˜åœ¨çš„éšè”½é£é™©ï¼Œå› æ­¤æŠ•æ¯’é£é™©è¾ƒä½ï¼Œä¼°è®¡ä¸º10%ã€‚

**é¡¹ç›®åœ°å€:** [GrantBirki/redash-vulnerable](https://github.com/GrantBirki/redash-vulnerable)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-21239](https://nvd.nist.gov/vuln/detail/CVE-2021-21239)

---

## POC #2

**æ¥æº**: [CVE-2021-21239-RyanBoomer30_CVE-2021-21239-Exploit.md](../2021/CVE-2021-21239-RyanBoomer30_CVE-2021-21239-Exploit.md)

## CVE-2021-21239-pysaml2-ç­¾åç»•è¿‡

**æ¼æ´ç¼–å·:** CVE-2021-21239

**æ¼æ´ç±»å‹:** ç­¾åç»•è¿‡

**å½±å“åº”ç”¨:** pysaml2

**å±å®³ç­‰çº§:** ä¸­å±ï¼Œå¯èƒ½å¯¼è‡´èº«ä»½ä¼ªé€ å’Œæƒé™æå‡

**å½±å“ç‰ˆæœ¬:** < 6.5.0

**åˆ©ç”¨æ¡ä»¶:** ä¾èµ–äºpysaml2çš„SAMLè®¤è¯æµç¨‹ï¼Œä¸”ä½¿ç”¨é»˜è®¤çš„CryptoBackendXmlSec1åç«¯

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 2%

## è¯¦æƒ…

CVE-2021-21239æ˜¯pysaml2åº“ä¸­å­˜åœ¨çš„ä¸€ä¸ªç­¾åç»•è¿‡æ¼æ´ã€‚è¯¥æ¼æ´æºäºpysaml2åœ¨ç‰ˆæœ¬6.5.0ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ï¼Œä½¿ç”¨é»˜è®¤çš„CryptoBackendXmlSec1åç«¯æ—¶ï¼Œå¯¹SAMLæ–‡æ¡£çš„ç­¾åéªŒè¯ä¸ä¸¥æ ¼ã€‚å…·ä½“æ¥è¯´ï¼Œ`xmlsec1`å·¥å…·é»˜è®¤æ¥å—å¤šç§ç±»å‹çš„å¯†é’¥ï¼Œè€Œæ²¡æœ‰å¼ºåˆ¶è¦æ±‚å¿…é¡»æ˜¯X.509è¯ä¹¦ã€‚æ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¿™ä¸€ç‚¹ï¼Œåœ¨SAMLæ–‡æ¡£ä¸­ä½¿ç”¨éX.509è¯ä¹¦çš„å¯†é’¥è¿›è¡Œç­¾åï¼Œä»è€Œç»•è¿‡ç­¾åéªŒè¯ï¼Œå†’å……ä»»æ„ç”¨æˆ·ã€‚

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„POCä»£ç å°è¯•é€šè¿‡ä»¥ä¸‹æ­¥éª¤åˆ©ç”¨æ­¤æ¼æ´ï¼š
1.  è§£ææˆªè·çš„SAML XMLæ–‡æ¡£ã€‚
2.  æ›¿æ¢æ–‡æ¡£ä¸­çš„ç”¨æˆ·åå’Œé‚®ç®±ä¿¡æ¯ã€‚
3.  ä½¿ç”¨ä¸€ä¸ªç©ºçš„ç­¾åå—æ›¿æ¢åŸå§‹ç­¾åå—.
4.  ä½¿ç”¨ `openssl` ç”Ÿæˆæ–°çš„å¯†é’¥å’Œè¯ä¹¦ï¼Œç„¶åä½¿ç”¨ `xmlsec1` å¯¹ä¿®æ”¹åçš„SAMLæ–‡æ¡£è¿›è¡Œç­¾åã€‚
ç”±äºæ¼æ´åœ¨äºå¯¹å¯†é’¥ç±»å‹çš„éªŒè¯ä¸è¶³ï¼Œåˆ©ç”¨è€…é€šè¿‡ä¿®æ”¹SAMLæ–‡æ¡£å†…å®¹ï¼Œå¹¶ä½¿ç”¨æ–°çš„å¯†é’¥é‡æ–°ç­¾åï¼Œå¯èƒ½ä½¿pysaml2åœ¨æ—§ç‰ˆæœ¬ä¸­ç»•è¿‡éªŒè¯ï¼Œä»è€Œä½¿æ”»å‡»è€…æˆåŠŸä¼ªé€ èº«ä»½ã€‚æ­¤POC **æœ‰æ•ˆ**ã€‚

**æŠ•æ¯’é£é™©ï¼š**
æ£€æŸ¥POCä»£ç åï¼Œå¹¶æœªå‘ç°æ˜æ˜¾çš„æ¶æ„æŠ•æ¯’ä»£ç ã€‚ä»£ç ä¸»è¦é›†ä¸­åœ¨XMLè§£æã€å­—ç¬¦ä¸²æ›¿æ¢å’Œç­¾åæ“ä½œã€‚ç”Ÿæˆå¯†é’¥å¯¹å’Œä½¿ç”¨xmlsec1ç­¾åæ˜¯æ¼æ´åˆ©ç”¨çš„æ­£å¸¸æ­¥éª¤ã€‚

ä½†æ˜¯ä»¥ä¸‹å‡ ç‚¹éœ€è¦æ³¨æ„ï¼š

*   `subprocess.run(xmlsec_command, shell=True)`: ä½¿ç”¨ `shell=True` å­˜åœ¨å‘½ä»¤æ³¨å…¥çš„é£é™©ã€‚è™½ç„¶åœ¨è¿™ä¸ªä¸Šä¸‹æ–‡ä¸­ï¼Œå‘½ä»¤æ˜¯ç”±è„šæœ¬è‡ªèº«æ„é€ çš„ï¼Œä½†å¦‚æœè¾“å…¥çš„æ–‡ä»¶åæˆ–è€…ç”¨æˆ·è¾“å…¥åŒ…å«æ¶æ„å­—ç¬¦ï¼Œä»ç„¶å¯èƒ½è¢«åˆ©ç”¨ã€‚ä½†è¿™ä¸ªé£é™©å¾ˆå°ï¼Œå› ä¸ºå®ƒä¾èµ–äºæ”»å‡»è€…é¦–å…ˆæ§åˆ¶è¾“å…¥æ–‡ä»¶æˆ–ç”¨æˆ·è¾“å…¥ã€‚

ç»¼åˆè¯„ä¼°ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ï¼Œçº¦ä¸º2%ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  **æˆªè·SAMLè¯·æ±‚ï¼š** æ”»å‡»è€…é¦–å…ˆéœ€è¦æˆªè·ç›®æ ‡ç”¨æˆ·å‘é€çš„SAMLè®¤è¯è¯·æ±‚ã€‚
2.  **ä¿®æ”¹SAMLæ–­è¨€ï¼š** ä½¿ç”¨æä¾›çš„POCä»£ç ï¼Œæ”»å‡»è€…å¯ä»¥ä¿®æ”¹SAMLæ–­è¨€ä¸­çš„ç”¨æˆ·ä¿¡æ¯ï¼ˆä¾‹å¦‚ç”¨æˆ·åã€é‚®ç®±ç­‰ï¼‰ã€‚
3.  **æ›¿æ¢ç­¾åï¼š**  åˆ©ç”¨æ¼æ´ï¼Œç§»é™¤åŸå§‹ç­¾åï¼Œæ’å…¥ä¸€ä¸ªç©ºçš„ç­¾åå¿«ã€‚
4.  **é‡æ–°ç­¾åSAMLæ–­è¨€ï¼š** ç”Ÿæˆæ–°çš„å¯†é’¥å¯¹ï¼Œå¹¶ä½¿ç”¨`xmlsec1`å·¥å…·ä½¿ç”¨æ–°çš„å¯†é’¥å¯¹ä¿®æ”¹åçš„SAMLæ–­è¨€è¿›è¡Œç­¾åã€‚
5.  **å‘é€ä¼ªé€ çš„SAMLè¯·æ±‚ï¼š** æ”»å‡»è€…å°†é‡æ–°ç­¾ååçš„SAMLè¯·æ±‚å‘é€ç»™æœåŠ¡æä¾›å•†ã€‚
6.  **ç»•è¿‡éªŒè¯ï¼Œèº«ä»½ä¼ªé€ ï¼š** ç”±äºæœåŠ¡æä¾›å•†ä½¿ç”¨çš„pysaml2ç‰ˆæœ¬å­˜åœ¨æ¼æ´ï¼Œä¸”æ²¡æœ‰å¼ºåˆ¶éªŒè¯å¯†é’¥ç±»å‹ï¼Œæ”»å‡»è€…å¯ä»¥æˆåŠŸç»•è¿‡ç­¾åéªŒè¯ï¼Œå†’å……è¢«ç¯¡æ”¹ç”¨æˆ·ä¿¡æ¯çš„å¯¹åº”ç”¨æˆ·ã€‚


**é¡¹ç›®åœ°å€:** [RyanBoomer30/CVE-2021-21239-Exploit](https://github.com/RyanBoomer30/CVE-2021-21239-Exploit)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-21239](https://nvd.nist.gov/vuln/detail/CVE-2021-21239)

---

## POC #3

**æ¥æº**: [CVE-2021-21239-illera88_CVE-2021-21239.md](../2021/CVE-2021-21239-illera88_CVE-2021-21239.md)

# CVE-2021-21239

> ğŸ“¦ è¯¥CVEæœ‰ **3** ä¸ªç›¸å…³POCä»“åº“

---

## POC #1

**æ¥æº**: [CVE-2021-21239-GrantBirki_redash-vulnerable.md](../2021/CVE-2021-21239-GrantBirki_redash-vulnerable.md)

## CVE-2021-21239-pysaml2-ç­¾åç»•è¿‡

**æ¼æ´ç¼–å·:** CVE-2021-21239

**æ¼æ´ç±»å‹:** ç­¾åç»•è¿‡

**å½±å“åº”ç”¨:** pysaml2

**å±å®³ç­‰çº§:** ä¸­å±ï¼Œå¯èƒ½å¯¼è‡´èº«ä»½è®¤è¯ç»•è¿‡ï¼Œè¿›è€Œæœªæˆæƒè®¿é—®

**å½±å“ç‰ˆæœ¬:** < 6.5.0

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡ç³»ç»Ÿä½¿ç”¨pysaml2ä½œä¸ºSAMLè®¤è¯åº“ï¼Œå¹¶ä¸”ä½¿ç”¨é»˜è®¤çš„CryptoBackendXmlSec1åç«¯ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2021-21239æ˜¯pysaml2ä¸­çš„ä¸€ä¸ªç­¾åéªŒè¯æ¼æ´ã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡æ„é€ æ¶æ„çš„SAMLå“åº”ï¼Œåˆ©ç”¨xmlsec1é»˜è®¤æ¥å—ä»»æ„ç±»å‹å¯†é’¥çš„ç‰¹æ€§ï¼ŒåµŒå…¥RSAå¯†é’¥å¹¶ç»•è¿‡ç­¾åéªŒè¯ã€‚  

**æœ‰æ•ˆæ€§ï¼š**
æ ¹æ®æ¼æ´åº“ä¿¡æ¯ã€æœç´¢å¼•æ“ç»“æœå’Œæä¾›çš„PoCä»£ç ï¼Œå¯ä»¥åˆ¤æ–­æ­¤æ¼æ´æ˜¯æœ‰æ•ˆçš„ã€‚æ¼æ´åº“ä¿¡æ¯æ˜ç¡®æŒ‡å‡ºpysaml2 < 6.5.0 å­˜åœ¨ç­¾åéªŒè¯é—®é¢˜ï¼Œä¸”æœ‰å…¬å¼€çš„PoCå¯ä»¥åˆ©ç”¨ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
PoCä»£ç  `poc.py` å±•ç¤ºäº†å¦‚ä½•æ„é€ æ¶æ„çš„SAMLå“åº”ã€‚å…¶åˆ©ç”¨æ–¹å¼ä¸ºï¼š
1.  ç”Ÿæˆä¸€ä¸ªç”¨äºä¼ªé€ ç­¾åä½¿ç”¨çš„RSAå¯†é’¥å¯¹ã€‚
2.  æ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„æ–­è¨€ï¼ˆAssertionï¼‰çš„SAMLå“åº”ï¼Œå°†æ”»å‡»è€…çš„å…¬é’¥åµŒå…¥åˆ°`KeyInfo`æ ‡ç­¾çš„`KeyValue`ä¸­ï¼Œè€Œéä½¿ç”¨X.509è¯ä¹¦ã€‚
3.  ç”±äº`xmlsec1`é»˜è®¤æ¥å—åµŒå…¥çš„RSAå¯†é’¥ï¼Œå› æ­¤åœ¨æœåŠ¡ç«¯éªŒè¯ç­¾åæ—¶ï¼Œä¼šä½¿ç”¨æ”»å‡»è€…æä¾›çš„å…¬é’¥è¿›è¡ŒéªŒè¯ï¼Œä»è€Œç»•è¿‡æ­£å¸¸çš„è¯ä¹¦éªŒè¯ã€‚
4.  å°†æ„é€ çš„SAMLå“åº”å‘é€åˆ°ç›®æ ‡RedashæœåŠ¡å™¨çš„SAMLå›è°ƒåœ°å€ï¼Œå®ç°èº«ä»½è®¤è¯ç»•è¿‡ã€‚

**æŠ•æ¯’é£é™©ï¼š**
è™½ç„¶æä¾›çš„`docker-compose.yml` å’Œ `README.md`æ–‡ä»¶å¯èƒ½åŒ…å«é…ç½®ç›¸å…³çš„ä¿¡æ¯ï¼Œå¸®åŠ©æ­å»ºæ¼æ´ç¯å¢ƒï¼Œä½†æ˜¯æ ¸å¿ƒçš„æ”»å‡»ä»£ç åœ¨`poc.py`ä¸­ã€‚ æ£€æŸ¥`poc.py`ï¼Œå‘ç°å…¶ä¸»è¦é€»è¾‘æ˜¯æ„é€ æ¶æ„çš„SAMLå“åº”ä»¥åˆ©ç”¨æ¼æ´ã€‚ä»£ç æœ¬èº«æ²¡æœ‰æ˜æ˜¾çš„åé—¨æˆ–æ¶æ„è¡Œä¸ºã€‚`docker-compose.yml`ä¸­ä½¿ç”¨çš„æ˜¯redash/redash:10.0.0.b50363è¿™ä¸ªé•œåƒï¼Œè¿™æ˜¯ä¸€ä¸ªå…¬å¼€çš„Redashé•œåƒï¼Œé™ä½äº†æŠ•æ¯’çš„å¯èƒ½ã€‚ä½†æ˜¯ï¼Œä»ç„¶å­˜åœ¨ä¸€å®šçš„æŠ•æ¯’é£é™©ï¼Œä¾‹å¦‚ï¼š
1.  ä½œè€…å¯èƒ½åœ¨`script/server`è„šæœ¬ä¸­æ·»åŠ äº†æ¶æ„ä»£ç ã€‚
2.  docker-compose.ymlæ–‡ä»¶ä¸­æŒ‡å®šçš„redashé•œåƒå¯èƒ½è¢«ç¯¡æ”¹ã€‚

è€ƒè™‘åˆ°redashé•œåƒçš„å…¬å¼€æ€§å’Œpoc.pyä»£ç çš„ç›¸å¯¹ç®€å•æ€§ï¼Œä»¥åŠè„šæœ¬æ–‡ä»¶ä¸­å¯èƒ½å­˜åœ¨çš„éšè”½é£é™©ï¼Œå› æ­¤æŠ•æ¯’é£é™©è¾ƒä½ï¼Œä¼°è®¡ä¸º10%ã€‚

**é¡¹ç›®åœ°å€:** [GrantBirki/redash-vulnerable](https://github.com/GrantBirki/redash-vulnerable)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-21239](https://nvd.nist.gov/vuln/detail/CVE-2021-21239)

---

## POC #2

**æ¥æº**: [CVE-2021-21239-RyanBoomer30_CVE-2021-21239-Exploit.md](../2021/CVE-2021-21239-RyanBoomer30_CVE-2021-21239-Exploit.md)

## CVE-2021-21239-pysaml2-ç­¾åç»•è¿‡

**æ¼æ´ç¼–å·:** CVE-2021-21239

**æ¼æ´ç±»å‹:** ç­¾åç»•è¿‡

**å½±å“åº”ç”¨:** pysaml2

**å±å®³ç­‰çº§:** ä¸­å±ï¼Œå¯èƒ½å¯¼è‡´èº«ä»½ä¼ªé€ å’Œæƒé™æå‡

**å½±å“ç‰ˆæœ¬:** < 6.5.0

**åˆ©ç”¨æ¡ä»¶:** ä¾èµ–äºpysaml2çš„SAMLè®¤è¯æµç¨‹ï¼Œä¸”ä½¿ç”¨é»˜è®¤çš„CryptoBackendXmlSec1åç«¯

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 2%

## è¯¦æƒ…

CVE-2021-21239æ˜¯pysaml2åº“ä¸­å­˜åœ¨çš„ä¸€ä¸ªç­¾åç»•è¿‡æ¼æ´ã€‚è¯¥æ¼æ´æºäºpysaml2åœ¨ç‰ˆæœ¬6.5.0ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ï¼Œä½¿ç”¨é»˜è®¤çš„CryptoBackendXmlSec1åç«¯æ—¶ï¼Œå¯¹SAMLæ–‡æ¡£çš„ç­¾åéªŒè¯ä¸ä¸¥æ ¼ã€‚å…·ä½“æ¥è¯´ï¼Œ`xmlsec1`å·¥å…·é»˜è®¤æ¥å—å¤šç§ç±»å‹çš„å¯†é’¥ï¼Œè€Œæ²¡æœ‰å¼ºåˆ¶è¦æ±‚å¿…é¡»æ˜¯X.509è¯ä¹¦ã€‚æ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¿™ä¸€ç‚¹ï¼Œåœ¨SAMLæ–‡æ¡£ä¸­ä½¿ç”¨éX.509è¯ä¹¦çš„å¯†é’¥è¿›è¡Œç­¾åï¼Œä»è€Œç»•è¿‡ç­¾åéªŒè¯ï¼Œå†’å……ä»»æ„ç”¨æˆ·ã€‚

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„POCä»£ç å°è¯•é€šè¿‡ä»¥ä¸‹æ­¥éª¤åˆ©ç”¨æ­¤æ¼æ´ï¼š
1.  è§£ææˆªè·çš„SAML XMLæ–‡æ¡£ã€‚
2.  æ›¿æ¢æ–‡æ¡£ä¸­çš„ç”¨æˆ·åå’Œé‚®ç®±ä¿¡æ¯ã€‚
3.  ä½¿ç”¨ä¸€ä¸ªç©ºçš„ç­¾åå—æ›¿æ¢åŸå§‹ç­¾åå—.
4.  ä½¿ç”¨ `openssl` ç”Ÿæˆæ–°çš„å¯†é’¥å’Œè¯ä¹¦ï¼Œç„¶åä½¿ç”¨ `xmlsec1` å¯¹ä¿®æ”¹åçš„SAMLæ–‡æ¡£è¿›è¡Œç­¾åã€‚
ç”±äºæ¼æ´åœ¨äºå¯¹å¯†é’¥ç±»å‹çš„éªŒè¯ä¸è¶³ï¼Œåˆ©ç”¨è€…é€šè¿‡ä¿®æ”¹SAMLæ–‡æ¡£å†…å®¹ï¼Œå¹¶ä½¿ç”¨æ–°çš„å¯†é’¥é‡æ–°ç­¾åï¼Œå¯èƒ½ä½¿pysaml2åœ¨æ—§ç‰ˆæœ¬ä¸­ç»•è¿‡éªŒè¯ï¼Œä»è€Œä½¿æ”»å‡»è€…æˆåŠŸä¼ªé€ èº«ä»½ã€‚æ­¤POC **æœ‰æ•ˆ**ã€‚

**æŠ•æ¯’é£é™©ï¼š**
æ£€æŸ¥POCä»£ç åï¼Œå¹¶æœªå‘ç°æ˜æ˜¾çš„æ¶æ„æŠ•æ¯’ä»£ç ã€‚ä»£ç ä¸»è¦é›†ä¸­åœ¨XMLè§£æã€å­—ç¬¦ä¸²æ›¿æ¢å’Œç­¾åæ“ä½œã€‚ç”Ÿæˆå¯†é’¥å¯¹å’Œä½¿ç”¨xmlsec1ç­¾åæ˜¯æ¼æ´åˆ©ç”¨çš„æ­£å¸¸æ­¥éª¤ã€‚

ä½†æ˜¯ä»¥ä¸‹å‡ ç‚¹éœ€è¦æ³¨æ„ï¼š

*   `subprocess.run(xmlsec_command, shell=True)`: ä½¿ç”¨ `shell=True` å­˜åœ¨å‘½ä»¤æ³¨å…¥çš„é£é™©ã€‚è™½ç„¶åœ¨è¿™ä¸ªä¸Šä¸‹æ–‡ä¸­ï¼Œå‘½ä»¤æ˜¯ç”±è„šæœ¬è‡ªèº«æ„é€ çš„ï¼Œä½†å¦‚æœè¾“å…¥çš„æ–‡ä»¶åæˆ–è€…ç”¨æˆ·è¾“å…¥åŒ…å«æ¶æ„å­—ç¬¦ï¼Œä»ç„¶å¯èƒ½è¢«åˆ©ç”¨ã€‚ä½†è¿™ä¸ªé£é™©å¾ˆå°ï¼Œå› ä¸ºå®ƒä¾èµ–äºæ”»å‡»è€…é¦–å…ˆæ§åˆ¶è¾“å…¥æ–‡ä»¶æˆ–ç”¨æˆ·è¾“å…¥ã€‚

ç»¼åˆè¯„ä¼°ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ï¼Œçº¦ä¸º2%ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  **æˆªè·SAMLè¯·æ±‚ï¼š** æ”»å‡»è€…é¦–å…ˆéœ€è¦æˆªè·ç›®æ ‡ç”¨æˆ·å‘é€çš„SAMLè®¤è¯è¯·æ±‚ã€‚
2.  **ä¿®æ”¹SAMLæ–­è¨€ï¼š** ä½¿ç”¨æä¾›çš„POCä»£ç ï¼Œæ”»å‡»è€…å¯ä»¥ä¿®æ”¹SAMLæ–­è¨€ä¸­çš„ç”¨æˆ·ä¿¡æ¯ï¼ˆä¾‹å¦‚ç”¨æˆ·åã€é‚®ç®±ç­‰ï¼‰ã€‚
3.  **æ›¿æ¢ç­¾åï¼š**  åˆ©ç”¨æ¼æ´ï¼Œç§»é™¤åŸå§‹ç­¾åï¼Œæ’å…¥ä¸€ä¸ªç©ºçš„ç­¾åå¿«ã€‚
4.  **é‡æ–°ç­¾åSAMLæ–­è¨€ï¼š** ç”Ÿæˆæ–°çš„å¯†é’¥å¯¹ï¼Œå¹¶ä½¿ç”¨`xmlsec1`å·¥å…·ä½¿ç”¨æ–°çš„å¯†é’¥å¯¹ä¿®æ”¹åçš„SAMLæ–­è¨€è¿›è¡Œç­¾åã€‚
5.  **å‘é€ä¼ªé€ çš„SAMLè¯·æ±‚ï¼š** æ”»å‡»è€…å°†é‡æ–°ç­¾ååçš„SAMLè¯·æ±‚å‘é€ç»™æœåŠ¡æä¾›å•†ã€‚
6.  **ç»•è¿‡éªŒè¯ï¼Œèº«ä»½ä¼ªé€ ï¼š** ç”±äºæœåŠ¡æä¾›å•†ä½¿ç”¨çš„pysaml2ç‰ˆæœ¬å­˜åœ¨æ¼æ´ï¼Œä¸”æ²¡æœ‰å¼ºåˆ¶éªŒè¯å¯†é’¥ç±»å‹ï¼Œæ”»å‡»è€…å¯ä»¥æˆåŠŸç»•è¿‡ç­¾åéªŒè¯ï¼Œå†’å……è¢«ç¯¡æ”¹ç”¨æˆ·ä¿¡æ¯çš„å¯¹åº”ç”¨æˆ·ã€‚


**é¡¹ç›®åœ°å€:** [RyanBoomer30/CVE-2021-21239-Exploit](https://github.com/RyanBoomer30/CVE-2021-21239-Exploit)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-21239](https://nvd.nist.gov/vuln/detail/CVE-2021-21239)

---

## POC #3

**æ¥æº**: [CVE-2021-21239-illera88_CVE-2021-21239.md](../2021/CVE-2021-21239-illera88_CVE-2021-21239.md)

# CVE-2021-21239

> ğŸ“¦ è¯¥CVEæœ‰ **2** ä¸ªç›¸å…³POCä»“åº“

---

## POC #1

**æ¥æº**: [CVE-2021-21239-GrantBirki_redash-vulnerable.md](../2021/CVE-2021-21239-GrantBirki_redash-vulnerable.md)

## CVE-2021-21239-pysaml2-ç­¾åç»•è¿‡

**æ¼æ´ç¼–å·:** CVE-2021-21239

**æ¼æ´ç±»å‹:** ç­¾åç»•è¿‡

**å½±å“åº”ç”¨:** pysaml2

**å±å®³ç­‰çº§:** ä¸­å±ï¼Œå¯èƒ½å¯¼è‡´èº«ä»½è®¤è¯ç»•è¿‡ï¼Œè¿›è€Œæœªæˆæƒè®¿é—®

**å½±å“ç‰ˆæœ¬:** < 6.5.0

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡ç³»ç»Ÿä½¿ç”¨pysaml2ä½œä¸ºSAMLè®¤è¯åº“ï¼Œå¹¶ä¸”ä½¿ç”¨é»˜è®¤çš„CryptoBackendXmlSec1åç«¯ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2021-21239æ˜¯pysaml2ä¸­çš„ä¸€ä¸ªç­¾åéªŒè¯æ¼æ´ã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡æ„é€ æ¶æ„çš„SAMLå“åº”ï¼Œåˆ©ç”¨xmlsec1é»˜è®¤æ¥å—ä»»æ„ç±»å‹å¯†é’¥çš„ç‰¹æ€§ï¼ŒåµŒå…¥RSAå¯†é’¥å¹¶ç»•è¿‡ç­¾åéªŒè¯ã€‚  

**æœ‰æ•ˆæ€§ï¼š**
æ ¹æ®æ¼æ´åº“ä¿¡æ¯ã€æœç´¢å¼•æ“ç»“æœå’Œæä¾›çš„PoCä»£ç ï¼Œå¯ä»¥åˆ¤æ–­æ­¤æ¼æ´æ˜¯æœ‰æ•ˆçš„ã€‚æ¼æ´åº“ä¿¡æ¯æ˜ç¡®æŒ‡å‡ºpysaml2 < 6.5.0 å­˜åœ¨ç­¾åéªŒè¯é—®é¢˜ï¼Œä¸”æœ‰å…¬å¼€çš„PoCå¯ä»¥åˆ©ç”¨ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
PoCä»£ç  `poc.py` å±•ç¤ºäº†å¦‚ä½•æ„é€ æ¶æ„çš„SAMLå“åº”ã€‚å…¶åˆ©ç”¨æ–¹å¼ä¸ºï¼š
1.  ç”Ÿæˆä¸€ä¸ªç”¨äºä¼ªé€ ç­¾åä½¿ç”¨çš„RSAå¯†é’¥å¯¹ã€‚
2.  æ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„æ–­è¨€ï¼ˆAssertionï¼‰çš„SAMLå“åº”ï¼Œå°†æ”»å‡»è€…çš„å…¬é’¥åµŒå…¥åˆ°`KeyInfo`æ ‡ç­¾çš„`KeyValue`ä¸­ï¼Œè€Œéä½¿ç”¨X.509è¯ä¹¦ã€‚
3.  ç”±äº`xmlsec1`é»˜è®¤æ¥å—åµŒå…¥çš„RSAå¯†é’¥ï¼Œå› æ­¤åœ¨æœåŠ¡ç«¯éªŒè¯ç­¾åæ—¶ï¼Œä¼šä½¿ç”¨æ”»å‡»è€…æä¾›çš„å…¬é’¥è¿›è¡ŒéªŒè¯ï¼Œä»è€Œç»•è¿‡æ­£å¸¸çš„è¯ä¹¦éªŒè¯ã€‚
4.  å°†æ„é€ çš„SAMLå“åº”å‘é€åˆ°ç›®æ ‡RedashæœåŠ¡å™¨çš„SAMLå›è°ƒåœ°å€ï¼Œå®ç°èº«ä»½è®¤è¯ç»•è¿‡ã€‚

**æŠ•æ¯’é£é™©ï¼š**
è™½ç„¶æä¾›çš„`docker-compose.yml` å’Œ `README.md`æ–‡ä»¶å¯èƒ½åŒ…å«é…ç½®ç›¸å…³çš„ä¿¡æ¯ï¼Œå¸®åŠ©æ­å»ºæ¼æ´ç¯å¢ƒï¼Œä½†æ˜¯æ ¸å¿ƒçš„æ”»å‡»ä»£ç åœ¨`poc.py`ä¸­ã€‚ æ£€æŸ¥`poc.py`ï¼Œå‘ç°å…¶ä¸»è¦é€»è¾‘æ˜¯æ„é€ æ¶æ„çš„SAMLå“åº”ä»¥åˆ©ç”¨æ¼æ´ã€‚ä»£ç æœ¬èº«æ²¡æœ‰æ˜æ˜¾çš„åé—¨æˆ–æ¶æ„è¡Œä¸ºã€‚`docker-compose.yml`ä¸­ä½¿ç”¨çš„æ˜¯redash/redash:10.0.0.b50363è¿™ä¸ªé•œåƒï¼Œè¿™æ˜¯ä¸€ä¸ªå…¬å¼€çš„Redashé•œåƒï¼Œé™ä½äº†æŠ•æ¯’çš„å¯èƒ½ã€‚ä½†æ˜¯ï¼Œä»ç„¶å­˜åœ¨ä¸€å®šçš„æŠ•æ¯’é£é™©ï¼Œä¾‹å¦‚ï¼š
1.  ä½œè€…å¯èƒ½åœ¨`script/server`è„šæœ¬ä¸­æ·»åŠ äº†æ¶æ„ä»£ç ã€‚
2.  docker-compose.ymlæ–‡ä»¶ä¸­æŒ‡å®šçš„redashé•œåƒå¯èƒ½è¢«ç¯¡æ”¹ã€‚

è€ƒè™‘åˆ°redashé•œåƒçš„å…¬å¼€æ€§å’Œpoc.pyä»£ç çš„ç›¸å¯¹ç®€å•æ€§ï¼Œä»¥åŠè„šæœ¬æ–‡ä»¶ä¸­å¯èƒ½å­˜åœ¨çš„éšè”½é£é™©ï¼Œå› æ­¤æŠ•æ¯’é£é™©è¾ƒä½ï¼Œä¼°è®¡ä¸º10%ã€‚

**é¡¹ç›®åœ°å€:** [GrantBirki/redash-vulnerable](https://github.com/GrantBirki/redash-vulnerable)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-21239](https://nvd.nist.gov/vuln/detail/CVE-2021-21239)

---

## POC #2

**æ¥æº**: [CVE-2021-21239-RyanBoomer30_CVE-2021-21239-Exploit.md](../2021/CVE-2021-21239-RyanBoomer30_CVE-2021-21239-Exploit.md)

## CVE-2021-21239-pysaml2-ç­¾åç»•è¿‡

**æ¼æ´ç¼–å·:** CVE-2021-21239

**æ¼æ´ç±»å‹:** ç­¾åç»•è¿‡

**å½±å“åº”ç”¨:** pysaml2

**å±å®³ç­‰çº§:** ä¸­å±ï¼Œå¯èƒ½å¯¼è‡´èº«ä»½ä¼ªé€ å’Œæƒé™æå‡

**å½±å“ç‰ˆæœ¬:** < 6.5.0

**åˆ©ç”¨æ¡ä»¶:** ä¾èµ–äºpysaml2çš„SAMLè®¤è¯æµç¨‹ï¼Œä¸”ä½¿ç”¨é»˜è®¤çš„CryptoBackendXmlSec1åç«¯

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 2%

## è¯¦æƒ…

CVE-2021-21239æ˜¯pysaml2åº“ä¸­å­˜åœ¨çš„ä¸€ä¸ªç­¾åç»•è¿‡æ¼æ´ã€‚è¯¥æ¼æ´æºäºpysaml2åœ¨ç‰ˆæœ¬6.5.0ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ï¼Œä½¿ç”¨é»˜è®¤çš„CryptoBackendXmlSec1åç«¯æ—¶ï¼Œå¯¹SAMLæ–‡æ¡£çš„ç­¾åéªŒè¯ä¸ä¸¥æ ¼ã€‚å…·ä½“æ¥è¯´ï¼Œ`xmlsec1`å·¥å…·é»˜è®¤æ¥å—å¤šç§ç±»å‹çš„å¯†é’¥ï¼Œè€Œæ²¡æœ‰å¼ºåˆ¶è¦æ±‚å¿…é¡»æ˜¯X.509è¯ä¹¦ã€‚æ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¿™ä¸€ç‚¹ï¼Œåœ¨SAMLæ–‡æ¡£ä¸­ä½¿ç”¨éX.509è¯ä¹¦çš„å¯†é’¥è¿›è¡Œç­¾åï¼Œä»è€Œç»•è¿‡ç­¾åéªŒè¯ï¼Œå†’å……ä»»æ„ç”¨æˆ·ã€‚

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„POCä»£ç å°è¯•é€šè¿‡ä»¥ä¸‹æ­¥éª¤åˆ©ç”¨æ­¤æ¼æ´ï¼š
1.  è§£ææˆªè·çš„SAML XMLæ–‡æ¡£ã€‚
2.  æ›¿æ¢æ–‡æ¡£ä¸­çš„ç”¨æˆ·åå’Œé‚®ç®±ä¿¡æ¯ã€‚
3.  ä½¿ç”¨ä¸€ä¸ªç©ºçš„ç­¾åå—æ›¿æ¢åŸå§‹ç­¾åå—.
4.  ä½¿ç”¨ `openssl` ç”Ÿæˆæ–°çš„å¯†é’¥å’Œè¯ä¹¦ï¼Œç„¶åä½¿ç”¨ `xmlsec1` å¯¹ä¿®æ”¹åçš„SAMLæ–‡æ¡£è¿›è¡Œç­¾åã€‚
ç”±äºæ¼æ´åœ¨äºå¯¹å¯†é’¥ç±»å‹çš„éªŒè¯ä¸è¶³ï¼Œåˆ©ç”¨è€…é€šè¿‡ä¿®æ”¹SAMLæ–‡æ¡£å†…å®¹ï¼Œå¹¶ä½¿ç”¨æ–°çš„å¯†é’¥é‡æ–°ç­¾åï¼Œå¯èƒ½ä½¿pysaml2åœ¨æ—§ç‰ˆæœ¬ä¸­ç»•è¿‡éªŒè¯ï¼Œä»è€Œä½¿æ”»å‡»è€…æˆåŠŸä¼ªé€ èº«ä»½ã€‚æ­¤POC **æœ‰æ•ˆ**ã€‚

**æŠ•æ¯’é£é™©ï¼š**
æ£€æŸ¥POCä»£ç åï¼Œå¹¶æœªå‘ç°æ˜æ˜¾çš„æ¶æ„æŠ•æ¯’ä»£ç ã€‚ä»£ç ä¸»è¦é›†ä¸­åœ¨XMLè§£æã€å­—ç¬¦ä¸²æ›¿æ¢å’Œç­¾åæ“ä½œã€‚ç”Ÿæˆå¯†é’¥å¯¹å’Œä½¿ç”¨xmlsec1ç­¾åæ˜¯æ¼æ´åˆ©ç”¨çš„æ­£å¸¸æ­¥éª¤ã€‚

ä½†æ˜¯ä»¥ä¸‹å‡ ç‚¹éœ€è¦æ³¨æ„ï¼š

*   `subprocess.run(xmlsec_command, shell=True)`: ä½¿ç”¨ `shell=True` å­˜åœ¨å‘½ä»¤æ³¨å…¥çš„é£é™©ã€‚è™½ç„¶åœ¨è¿™ä¸ªä¸Šä¸‹æ–‡ä¸­ï¼Œå‘½ä»¤æ˜¯ç”±è„šæœ¬è‡ªèº«æ„é€ çš„ï¼Œä½†å¦‚æœè¾“å…¥çš„æ–‡ä»¶åæˆ–è€…ç”¨æˆ·è¾“å…¥åŒ…å«æ¶æ„å­—ç¬¦ï¼Œä»ç„¶å¯èƒ½è¢«åˆ©ç”¨ã€‚ä½†è¿™ä¸ªé£é™©å¾ˆå°ï¼Œå› ä¸ºå®ƒä¾èµ–äºæ”»å‡»è€…é¦–å…ˆæ§åˆ¶è¾“å…¥æ–‡ä»¶æˆ–ç”¨æˆ·è¾“å…¥ã€‚

ç»¼åˆè¯„ä¼°ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ï¼Œçº¦ä¸º2%ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  **æˆªè·SAMLè¯·æ±‚ï¼š** æ”»å‡»è€…é¦–å…ˆéœ€è¦æˆªè·ç›®æ ‡ç”¨æˆ·å‘é€çš„SAMLè®¤è¯è¯·æ±‚ã€‚
2.  **ä¿®æ”¹SAMLæ–­è¨€ï¼š** ä½¿ç”¨æä¾›çš„POCä»£ç ï¼Œæ”»å‡»è€…å¯ä»¥ä¿®æ”¹SAMLæ–­è¨€ä¸­çš„ç”¨æˆ·ä¿¡æ¯ï¼ˆä¾‹å¦‚ç”¨æˆ·åã€é‚®ç®±ç­‰ï¼‰ã€‚
3.  **æ›¿æ¢ç­¾åï¼š**  åˆ©ç”¨æ¼æ´ï¼Œç§»é™¤åŸå§‹ç­¾åï¼Œæ’å…¥ä¸€ä¸ªç©ºçš„ç­¾åå¿«ã€‚
4.  **é‡æ–°ç­¾åSAMLæ–­è¨€ï¼š** ç”Ÿæˆæ–°çš„å¯†é’¥å¯¹ï¼Œå¹¶ä½¿ç”¨`xmlsec1`å·¥å…·ä½¿ç”¨æ–°çš„å¯†é’¥å¯¹ä¿®æ”¹åçš„SAMLæ–­è¨€è¿›è¡Œç­¾åã€‚
5.  **å‘é€ä¼ªé€ çš„SAMLè¯·æ±‚ï¼š** æ”»å‡»è€…å°†é‡æ–°ç­¾ååçš„SAMLè¯·æ±‚å‘é€ç»™æœåŠ¡æä¾›å•†ã€‚
6.  **ç»•è¿‡éªŒè¯ï¼Œèº«ä»½ä¼ªé€ ï¼š** ç”±äºæœåŠ¡æä¾›å•†ä½¿ç”¨çš„pysaml2ç‰ˆæœ¬å­˜åœ¨æ¼æ´ï¼Œä¸”æ²¡æœ‰å¼ºåˆ¶éªŒè¯å¯†é’¥ç±»å‹ï¼Œæ”»å‡»è€…å¯ä»¥æˆåŠŸç»•è¿‡ç­¾åéªŒè¯ï¼Œå†’å……è¢«ç¯¡æ”¹ç”¨æˆ·ä¿¡æ¯çš„å¯¹åº”ç”¨æˆ·ã€‚


**é¡¹ç›®åœ°å€:** [RyanBoomer30/CVE-2021-21239-Exploit](https://github.com/RyanBoomer30/CVE-2021-21239-Exploit)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-21239](https://nvd.nist.gov/vuln/detail/CVE-2021-21239)

---



---



---

