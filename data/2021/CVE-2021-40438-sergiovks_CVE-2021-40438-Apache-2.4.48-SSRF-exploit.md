## CVE-2021-40438 - Apache HTTP Server SSRF

**漏洞编号:** CVE-2021-40438

**漏洞类型:** SSRF

**影响应用:** Apache HTTP Server

**危害等级:** 高危

**CVSS评分:** 9.8

**影响版本:** 2.4.48 及更早版本

**利用条件:** 需要网络访问

**POC 可用性:** 8/10

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 10%

## 详情

CVE-2021-40438 是 Apache HTTP Server 中的一个服务器端请求伪造 (SSRF) 漏洞。通过构造特殊的 URI 路径，攻击者可以欺骗 mod_proxy 模块将请求转发到远程用户选择的源服务器。此漏洞影响 Apache HTTP Server 2.4.48 及更早版本。

POC 有效性分析：
提供的 POC 代码是一个 Python 脚本，旨在利用 CVE-2021-40438 漏洞。该脚本接收目标 URL 和 webhook URL 作为参数。它构造一个包含 "unix:" 前缀的特殊 URL，该前缀后跟一系列 "A" 字符，试图利用 mod_proxy 的行为。脚本发送一个 HTTP 请求到目标 URL，并将构造的 URL 作为查询参数。如果目标服务器受到攻击影响，它将尝试连接到由 "unix:" URL 指定的 UNIX 域套接字。在这种情况下，由于 "A" 字符序列很长，不太可能对应于有效的套接字，服务器通常会返回错误。但是，关键在于 mod_proxy 尝试连接到攻击者控制的地址，从而可能允许进行 SSRF 攻击。

利用步骤：
1. 准备：需要一台运行易受攻击的 Apache HTTP Server 版本的服务器。
2. 构造 Payload：使用提供的 Python 脚本或手动构造包含 "unix:" 前缀的恶意 URL。
3. 发送请求：向目标服务器发送包含恶意 URL 的 HTTP 请求。
4. 验证：监视目标服务器的行为。如果服务器尝试连接到恶意 URL 指定的地址，则表示漏洞利用成功。
5. 进一步利用（如果可能）：如果可以控制目标服务器连接到的地址，则可以利用此漏洞来读取内部资源、执行任意命令或执行其他恶意操作。例如，element.security的文章中提到可以利用该漏洞与Check Point的安全网关上的unix socket进行交互，从而进行RCE攻击。

投毒风险分析：
该 POC 代码的投毒风险较低。因为它主要依赖于标准 Python 库（requests 和 argparse），并且没有包含任何明显的恶意行为。该脚本的功能是发送 HTTP 请求，这对于漏洞利用来说是正常的。虽然脚本接受 webhook URL 作为参数，但这仅仅是为了演示目的，并没有强制要求。代码本身没有包含混淆或任何试图隐藏其行为的迹象。然而，攻击者可以修改该脚本，使其包含恶意代码，例如：
*   在目标服务器上执行任意命令。
*   从目标服务器窃取敏感数据。
*   使用目标服务器作为僵尸网络的一部分。
因此，虽然原始 POC 代码的风险较低，但必须注意，修改后的版本可能构成重大威胁。Webhook本身具有风险，如果webhook地址被替换成恶意地址，可能会导致信息泄露。
考虑到这些因素，将投毒风险评估为 10%。

**项目地址:** https://github.com/projectdiscovery/nuclei-templates/blob/main/http/cves/2021/cve-2021-40438.yaml

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2021-40438
