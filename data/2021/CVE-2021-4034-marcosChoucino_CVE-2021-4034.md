## CVE-2021-4034 - polkit (pkexec) 本地权限提升 (LPE)

**漏洞编号:** CVE-2021-4034

**漏洞类型:** 本地权限提升 (LPE)

**影响应用:** polkit (pkexec)

**危害等级:** 高危 (High)

**CVSS评分:** 7.8 (CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H)

**影响版本:** 所有主流 Linux 发行版中的 polkit 版本 (2009年至今)

**利用条件:** 攻击者必须拥有目标系统的本地用户访问权限，且系统中安装并配置了 setuid 权限的 pkexec 工具。

**POC 可用性:** 7/10

**POC 类型:** 概念验证

**攻击复杂度:** 低

**投毒风险:** 15%

## 详情

【POC有效性分析】该漏洞被称为‘PwnKit’，源于 polkit 的 pkexec 工具在处理命令行参数（argc）时的逻辑缺陷。正常情况下，argc 至少为1（即程序名本身），但当攻击者通过 execve() 调用 pkexec 并将参数数组设为空（NULL）时，argc 会变为0。在 pkexec 的源码逻辑中，程序会尝试访问 argv[1]，此时由于 argc 为0，这实际上发生了越界访问，读取到了紧随 argv 数组之后的 envp 环境变量数组。通过精心构造环境变量，攻击者可以诱导 pkexec 加载不受信任的共享库，从而以 root 身份执行任意代码。本 POC 包含两个主要部分：ataque.c 用于模拟这种空的 argv 调用并设置恶意的环境变量（如 GCONV_PATH 和 CHARSET）；vulner.c 模拟了受影响程序的逻辑流。POC 展示了如何利用环境变量覆盖来劫持 g_printerr() 的错误处理流程，进而执行恶意模块。虽然此 POC 是为了演示漏洞原理编写的简化版，但它准确捕捉了内存越界读取转变为代码执行的核心机制。在实际环境中，只需将目标执行文件指向系统真实的 /usr/bin/pkexec 即可实现提权。该 POC 结构清晰，能够有效证明漏洞的存在性及利用可行性。【利用步骤】1. 在目标 Linux 系统上编译提供的 C 代码。2. 创建必要的目录结构（如 config 文件夹）。3. 准备恶意的 gconv 配置文件和对应的共享库。4. 运行 ataque.out，该程序会设置包含恶意 GCONV_PATH 的环境变量。5. 触发越界访问后，pkexec 会因不合法的 CHARSET 配置调用图标转换函数，进而加载攻击者控制的 evil 模块，最终获得 root Shell。【投毒风险分析】该 POC 项目包含多个源文件和配置说明，主要目的是为了安全研究和防御测试，并未发现明显的恶意混淆或后门植入迹象。风险主要集中在以下几点：首先，虽然 ataque.c 本身代码透明，但如果攻击者将其中引用的 'vulner.out' 替换为真实的系统路径并将其封装在自动化脚本中，则具有直接的破坏性。其次，GCONV_PATH 的利用机制涉及到操作系统底层库的搜索路径，如果用户不慎在生产环境运行未经审核的二进制文件，可能导致系统库被劫持。然而，从代码逻辑看，所有的操作（如环境变量设置、文件写入）均限定在当前工作目录或临时目录中，未发现向外部 C2 服务器发送心跳或窃取本地凭证（如 /etc/shadow）的行为。代码风格符合典型的安全研究 Demo 规范，变量命名直观。综合评估，该项目属于低风险类别，但在使用时仍建议在隔离的沙箱环境（如 Docker 或虚拟机）中进行编译运行，以防止对宿主机系统环境造成不可逆的配置干扰或意外提权。

**项目地址:** [https://github.com/vulnwatchdog/cve-2021-4034](https://www.google.com/search?q=https://github.com/vulnwatchdog/cve-2021-4034)

**漏洞详情:** [https://nvd.nist.gov/vuln/detail/CVE-2021-4034](https://nvd.nist.gov/vuln/detail/CVE-2021-4034)
