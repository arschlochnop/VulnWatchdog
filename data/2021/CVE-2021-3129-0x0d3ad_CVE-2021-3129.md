## CVE-2021-3129 - Laravel (Ignition组件) 远程代码执行 (RCE)

**漏洞编号:** CVE-2021-3129

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Laravel (Ignition组件)

**危害等级:** 严重 (Critical)

**CVSS评分:** 9.8

**影响版本:** Laravel <= 8.4.2, Ignition < 2.5.2

**利用条件:** 系统开启Debug模式（APP_DEBUG=true），且安装了Facace\Ignition组件

**POC 可用性:** 9/10

**POC 类型:** 完整利用

**攻击复杂度:** 中

**投毒风险:** 15%

## 详情

POC有效性分析：该POC针对Laravel框架在开启Debug模式下，其默认错误处理引擎Ignition存在的安全缺陷。漏洞根源在于Ignition的MakeViewVariableOptionalSolution类在处理'修复建议'时，对viewFile参数缺乏充分过滤，导致攻击者可以调用file_get_contents()和file_put_contents()。POC通过四个核心阶段实现利用：1. 清理日志文件（通过php://filter/read=consumed清空laravel.log）；2. 对齐并植入Base64编码的Phar载荷（利用PHP filter构造特定字符填充日志）；3. 转换日志文件格式（通过多次filter转换，将杂乱的日志内容解码为合法的Phar文件二进制流）；4. 触发反序列化（利用phar://协议读取伪造的日志文件，配合phpggc生成的Laravel反序列化链执行命令）。代码逻辑清晰，调用了requests库进行自动化HTTP请求，并配合subprocess调用外部phpggc工具生成载荷，具有极高的实战有效性和复现成功率。利用步骤：首先确定目标URL并确认处于Debug模式；其次，使用phpggc生成针对Laravel框架版本（如laravel/rce12）的Phar序列化载荷；然后执行脚本，脚本会自动尝试清空目标服务器的laravel.log；接着脚本将载荷以quoted-printable编码形式分批写入日志；之后通过PHP过滤器将日志文件转换为标准的Phar格式；最后通过phar://协议触发文件包含，实现RCE。投毒风险分析：经过对提供的Python脚本源代码审计，该代码主要表现为功能性的漏洞利用工具，未发现明显的恶意行为或隐藏后门。代码中使用了标准的urllib3、requests和base64等库。风险点主要集中在以下两个方面：第一，脚本依赖外部的'./phpggc'工具，如果用户在不安全的来源下载了配套的phpggc，可能存在供应链风险；第二，脚本中包含了subprocess.check_output调用，虽然目前硬编码为调用php命令，但若被恶意修改为执行系统Shell命令，则会对运行此脚本的安全研究员造成威胁。当前代码段中未见Base64加密的恶意Payload或反向连接的可疑IP地址，整体代码结构透明，属于开源社区常见的利用脚本，投毒风险处于低水平（15%），主要风险源于操作者的环境控制和外部工具依赖。

**项目地址:** [https://github.com/facade/ignition](https://github.com/facade/ignition)

**漏洞详情:** [https://nvd.nist.gov/vuln/detail/CVE-2021-3129](https://nvd.nist.gov/vuln/detail/CVE-2021-3129)
