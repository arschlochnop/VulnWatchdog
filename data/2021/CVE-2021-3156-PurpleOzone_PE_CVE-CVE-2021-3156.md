## CVE-2021-3156 - Sudo 堆缓冲区溢出 (Heap-based Buffer Overflow)

**漏洞编号:** CVE-2021-3156

**漏洞类型:** 堆缓冲区溢出 (Heap-based Buffer Overflow)

**影响应用:** Sudo

**危害等级:** 高危

**CVSS评分:** 7.8 (CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H)

**影响版本:** 1.8.2 到 1.8.31p2; 1.9.0 到 1.9.5p1

**利用条件:** 攻击者必须拥有目标系统的本地用户访问权限，无需特殊权限或认证。

**POC 可用性:** 8/10

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 15%

## 详情

POC有效性分析：该漏洞被称为“Baron Samedit”，是Sudo程序在处理命令行参数解析时存在的一个off-by-one错误。当用户以“sudoedit -s”模式运行且参数以反斜杠结尾时，Sudo会错误地跳过空字符并继续读取后续内存，导致堆溢出。此POC针对Ubuntu 20.04等主流发行版进行了适配，通过Makefile自动化编译两个关键组件：一个是触发溢出的主程序（exploit），另一个是恶意共享库（libnss_X/X.so.2）。利用该溢出可以覆盖内存中的结构体，诱导Sudo加载攻击者控制的动态库，从而执行任意代码。从代码结构看，该POC不仅实现了root shell的获取，还集成了自动化的后渗透脚本。其有效性较高，因为它利用了Sudo处理参数时的逻辑缺陷，这种缺陷在未补丁的旧版本系统上具有极高的确定性。利用步骤：1. 在受影响的系统中克隆该存储库或下载源文件。2. 运行‘make’命令，这会调用gcc编译bufferof.c并生成名为exploit的可执行文件，同时生成libnss_X目录下的恶意so库。3. 执行‘./exploit’。4. 程序触发溢出后，会自动通过Sudo加载编译好的恶意库，从而获取root权限。5. 获取权限后，POC中包含的脚本会自动尝试搜集id_rsa私钥并创建一个带有SUID权限的后门shell（privshell）。投毒风险分析：该POC虽然包含了一些自动化的后渗透行为（如搜集SSH私钥），但在防御性研究语境下，这些行为通常被视为展示漏洞威力的“PayLoad”，而非针对安全研究员的恶意投毒。代码本身清晰，主要由标准C语言编写，Makefile逻辑透明，没有发现混淆代码或隐藏的远程下载恶意二进制文件的行为。虽然README中提到了wget加载方式，但这属于攻击场景模拟，而非对研究员环境的污染。主要的风险点在于：该POC会自动修改系统权限（如创建SUID shell），如果在生产环境中测试，可能会留下持久化的提权后门。此外，其后渗透脚本会将敏感的私钥导出到本地文本，需注意数据泄露风险。整体评估，该POC属于高质量的安全研究代码，投毒风险处于低水平（15%），属于正常的漏洞利用演示范畴，但研究人员应在隔离的沙箱环境运行，避免SUID后门长期存在于测试机中。

**项目地址:** [https://github.com/PurpleOzone/PE_CVE-CVE-2021-3156](https://github.com/PurpleOzone/PE_CVE-CVE-2021-3156)

**漏洞详情:** [https://nvd.nist.gov/vuln/detail/CVE-2021-3156](https://nvd.nist.gov/vuln/detail/CVE-2021-3156)
