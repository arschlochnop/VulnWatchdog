## CVE-2021-3129 - Laravel (Ignition 组件) RCE

**漏洞编号:** CVE-2021-3129

**漏洞类型:** RCE

**影响应用:** Laravel (Ignition 组件)

**危害等级:** 高危

**CVSS评分:** CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H (9.8)

**影响版本:** Laravel < 8.4.2, Ignition < 2.5.2

**利用条件:** Laravel 开启 Debug 模式，并安装了 Ignition 2.5.2 以下版本

**POC 可用性:** 8/10

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 15%

## 详情

POC有效性分析：该漏洞存在于Laravel框架默认集成的错误页处理组件Ignition（版本2.5.2之前）。当Laravel应用开启Debug模式时，Ignition提供了一个记录解决方案的API接口。该接口中的'execute-solution'功能存在不安全的文件处理逻辑，特别是在处理'MakeViewVariableOptionalSolution'时，允许对日志文件进行写入。攻击者可以通过'file_get_contents'和'file_put_contents'配合php://filter流对Laravel的日志文件（storage/logs/laravel.log）进行清空、写入构造好的Phar反序列化Payload。最后通过'phar://'协议触发反序列化，实现远程代码执行。提供的POC代码包含了完整的利用链，利用了phpggc生成的Laravel RCE链，通过多次请求完成日志清除、Payload写入及Phar触发。利用步骤：1. 发起请求清空laravel.log文件；2. 使用php://filter过滤器配合Base64编码将Phar Payload分段写入日志；3. 使用'convert.quoted-printable-decode'等过滤器清理非Payload字符；4. 发起指向该日志文件的phar://请求触发反序列化，从而执行系统命令（如id, whoami, ls等）。 投毒风险分析：经过对提供的exp.py和Dockerfile进行分析，该POC代码属于标准的安全研究脚本，其目的是为了复现和修复漏洞。代码中使用了常见的requests和urllib3库，逻辑清晰，主要动作是向目标服务器发送特定的HTTP POST请求。虽然涉及到底层phpggc链的构造，但其命令执行部分通常硬编码为'id'或'whoami'，用于证明漏洞存在。风险点主要在于：第一，脚本依赖外部工具phpggc生成Payload，如果用户下载的phpggc来源不明，存在被植入后门的风险。第二，POC脚本中存在一些经过Base64或Quoted-printable编码的长字符串，这在自动化检测中可能被标记为混淆。第三，Dockerfile中配置了Aliyun镜像源，虽然提高了国内下载速度，但也存在对特定镜像源的依赖。整体来看，该POC没有发现针对研究者本机的恶意代码执行（如窃取环境变量、反弹Shell到攻击者服务器等行为），投毒风险较低，主要风险点在于其依赖项的安全性。建议在使用此类POC时，在隔离的沙箱环境运行，并审计其生成的Payload的具体内容，防止在未授权的情况下造成生产环境的损坏。

**项目地址:** [https://github.com/facade/ignition](https://github.com/facade/ignition)

**漏洞详情:** [https://nvd.nist.gov/vuln/detail/CVE-2021-3129](https://nvd.nist.gov/vuln/detail/CVE-2021-3129)
