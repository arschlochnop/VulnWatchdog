## CVE-2021-3156 - Sudo (类Unix系统通用工具) 堆缓冲区溢出 (Heap-based Buffer Overflow)

**漏洞编号:** CVE-2021-3156

**漏洞类型:** 堆缓冲区溢出 (Heap-based Buffer Overflow)

**影响应用:** Sudo (类Unix系统通用工具)

**危害等级:** 高危 (High)

**CVSS评分:** 7.8 (CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H)

**影响版本:** 1.8.2 到 1.8.31p2; 1.9.0 到 1.9.5p1

**利用条件:** 具有本地普通用户权限的访问权限

**POC 可用性:** 8/10

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 15%

## 详情

POC有效性分析：该漏洞被称为“Baron Samedit”，是Sudo在处理命令行参数时存在的off-by-one错误。提供的POC脚本通过利用sudo的-R（chroot）选项和NSS（Name Service Switch）机制实现提权。脚本首先创建一个伪造的运行环境，生成一个带有构造函数的C语言源文件（woot1337.c），该构造函数在加载时会自动调用setreuid(0,0)并执行shell。随后，脚本将该代码编译为共享库（libnss_/woot1337.so.2），并配置一个虚假的nsswitch.conf文件指向该库。当执行sudo -R时，系统会尝试加载该恶意库，从而触发提权。经过分析，该POC逻辑清晰，符合CVE-2021-3156的利用原理，在未打补丁的Ubuntu、Debian等主流发行版上具有极高的成功率。利用步骤如下：1. 创建临时工作目录并进入。2. 编写注入提权代码的C语言载荷。3. 构建虚假的NSS配置文件环境。4. 使用gcc将载荷编译为共享对象文件。5. 调用带有-R参数的sudo命令强制触发受影响的代码路径，加载恶意库。6. 获取root权限。该POC代码编写规范，包含必要的错误检查和环境清理逻辑，是一份高质量的防御性研究样本。投毒风险分析：该POC脚本本身投毒风险较低，主要表现为代码透明度高，且未发现明显的恶意混淆或外部网络请求。脚本中虽然包含了创建root shell的行为，但这属于POC功能的组成部分，旨在验证漏洞的可利用性。主要的潜在风险在于脚本使用了mktemp创建临时目录并下载/编译代码，如果该脚本被分发到非隔离的生产环境，可能会因编译环境（gcc）的缺失或权限限制导致失败。此外，虽然脚本包含清理逻辑（rm -rf），但在利用失败的情况下可能导致敏感路径残留。在防御研究中，应重点关注脚本是否被篡改加入了curl或wget等向外传输机器信息的指令。目前提供的代码版本中，所有操作均在本地完成，且载荷内容（woot1337.c）完全公开可查，不具备隐蔽投毒特征。为了确保安全，建议在隔离的沙箱环境中使用非特权用户运行此类测试脚本，并监控编译产物的行为轨迹。综上所述，该POC是合法的安全研究工具，风险可控，但需注意防范在不安全渠道获取的修改版本。

**项目地址:** [https://nvd.nist.gov/vuln/detail/CVE-2021-3156](https://nvd.nist.gov/vuln/detail/CVE-2021-3156)

**漏洞详情:** [https://nvd.nist.gov/vuln/detail/CVE-2021-3156](https://nvd.nist.gov/vuln/detail/CVE-2021-3156)
