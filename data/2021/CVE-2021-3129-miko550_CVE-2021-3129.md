## CVE-2021-3129 - Laravel (Ignition组件) RCE

**漏洞编号:** CVE-2021-3129

**漏洞类型:** RCE

**影响应用:** Laravel (Ignition组件)

**危害等级:** CRITICAL

**CVSS评分:** 9.8

**影响版本:** Laravel <= 8.4.2, Ignition < 2.5.2

**利用条件:** 开启Debug模式 (APP_DEBUG=true)

**POC 可用性:** 8/10

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 15%

## 详情

POC有效性分析：该漏洞存在于Laravel框架默认使用的Ignition错误页组件中。由于Ignition在处理解决方案（Solutions）时，对‘MakeViewVariableOptionalSolution’类的参数处理不当，允许攻击者通过‘viewFile’参数操作本地日志文件。该POC通过利用PHP的‘php://filter’协议，将Laravel运行日志（laravel.log）转换为一个合法的Phar文件。具体而言，POC利用了多个转换过滤器（如convert.iconv.*、convert.base64-decode等）对日志内容进行多次编码和清除，最终将攻击者控制的Base64 payload精准写入日志文件中。随后，POC触发‘phar://’协议进行反序列化，导致远程代码执行。从代码结构看，该POC包含了完整的攻击链：指纹识别、日志清理、Payload生成（依赖PHPGGC）、日志转码注入以及最终的反序列化触发。代码逻辑清晰，利用了成熟的自动化过滤器构造技术，在Debug模式开启的环境下具有极高的成功率，是一份质量较高的利用脚本。

利用步骤：1. 环境检测：首先访问目标站点，检查是否开启了Debug模式并确定是否为Laravel环境。2. 清理日志：通过发送特制的JSON POST请求给‘_ignition/execute-solution’接口，利用过滤器清空‘../storage/logs/laravel.log’中的干扰内容。3. 构造Payload：使用PHPGGC生成针对Monolog链的序列化Payload。4. 注入Payload：将Payload经过Base64编码和Quoted-printable编码后发送，利用iconv编码转换漏洞将Payload以二进制形式写入日志。5. 反序列化执行：通过调用‘phar://’协议访问该日志文件，触发PHP反序列化，从而执行系统命令。

投毒风险分析：该POC虽然属于功能强大的攻击脚本，但其核心逻辑透明，主要使用了Python的requests标准库，并未发现明显的混淆、隐藏的第二阶段下载器或后门。代码中包含‘git clone’操作，用于自动下载合法的‘phpggc’工具，这属于常见的自动化利用配置，不视为恶意投毒行为。其主要风险在于：1. 自动化程度高，易被初级攻击者（Script Kiddies）滥用进行大规模扫描。2. 脚本在本地创建并删除临时文件（payload.txt），若在受控环境运行，需注意其文件系统操作权限。3. 脚本虽然在头部引用了外部项目链接，但代码本身并未发现将本地敏感信息回传至第三方服务器的逻辑。整体评估，该脚本作为安全研究工具是相对安全的，属于低投毒风险范围，但仍建议在隔离的沙箱环境中使用，以防因外部依赖（如PHPGGC）被劫持而引入风险。

**项目地址:** [https://github.com/SNCKER/CVE-2021-3129](https://github.com/SNCKER/CVE-2021-3129)

**漏洞详情:** [https://nvd.nist.gov/vuln/detail/CVE-2021-3129](https://nvd.nist.gov/vuln/detail/CVE-2021-3129)
