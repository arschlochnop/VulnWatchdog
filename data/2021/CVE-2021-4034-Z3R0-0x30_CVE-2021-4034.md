## CVE-2021-4034 - Polkit (pkexec) 本地提权 (LPE)

**漏洞编号:** CVE-2021-4034

**漏洞类型:** 本地提权 (LPE)

**影响应用:** Polkit (pkexec)

**危害等级:** 高危 (High)

**CVSS评分:** 7.8 (CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H)

**影响版本:** 所有包含 pkexec 的 Polkit 版本（2009年至今，直至2022年补丁发布前）

**利用条件:** 拥有系统的本地低权限用户访问权限，目标系统安装有受影响的 polkit 软件包。

**POC 可用性:** 9/10

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 5%

## 详情

【POC有效性分析】该POC针对的是著名的‘PwnKit’漏洞（CVE-2021-4034）。分析其代码逻辑，该利用程序展示了极高的有效性与可靠性。其核心原理利用了pkexec在处理命令行参数（argc）为0时的逻辑缺陷。在pkexec的代码中，如果主函数的argc为0，它仍会尝试读取argv[0]，这导致它实际上读取到了envp（环境变量指针数组）的第一个元素。通过精心构造环境变量，攻击者可以将恶意路径注入到GCONV_PATH变量中。该POC具体步骤如下：首先，它创建了一个名为zero.c的C源文件，并定义了gconv_init函数，该函数在被加载时会调用execve("/bin/bash", ...)，由于pkexec本身具有setuid root权限，这个新生成的bash shell将拥有root特权。接着，POC通过gcc将其编译为共享库zero.so，并伪造了一个gconv-modules配置文件，强制系统将特定的编码转换请求指向该共享库。最后，通过一个名为zero_exploit.c的引导程序，利用execve调用pkexec并故意清空参数列表，同时设置包含伪造路径的环境变量，从而触发pkexec加载并执行攻击者定义的zero.so。此POC逻辑清晰，直接利用了glibc的gconv转码机制，不依赖于复杂的内核内存布局偏移，因此在不同的Linux发行版（如Ubuntu, Debian, CentOS, Fedora）上具有极高的成功率。代码实现简洁，没有冗余的无效指令，是研究该漏洞防御机制的极佳参考。 【投毒风险分析】在对此提供的脚本（Z3R0_polkitLPE.sh）及配套C代码进行深度审计后，评估其投毒风险极低，约为5%。首先，该POC的获取方式是通过标准的GitHub克隆流程（虽然链接为示例），代码中没有包含任何二进制预编译文件，所有的Payload（zero.c, zero_exploit.c）均以明文形式在脚本中展示，并由本地gcc实时编译，这极大地降低了隐藏恶意后门的可能。其次，代码逻辑中没有发现任何网络外连请求、敏感信息读取（如/etc/shadow）后上传的行为，也没有混淆代码（Obfuscation）或使用eval、base64解码执行等典型投毒手段。脚本中包含的‘setuid(0); setgid(0); execve("/bin/bash", ...);’代码段，虽然具有高风险操作，但这正是本地提权漏洞PoC验证其‘获取Root权限’核心功能的必要组成部分，属于预期的安全研究行为，而非恶意第三方投毒。唯一潜在的微小风险在于脚本中使用了‘sudo apt update’等命令，在受限的生产环境中可能导致非预期的包更新，但这属于操作层面的管理风险，而非代码本身的投毒恶意。建议在隔离的沙箱环境或虚拟机中进行复现，以确保对主系统的零干扰。

**项目地址:** [https://github.com/Z3R0-0x30/CVE-2021-4034.git](https://github.com/Z3R0-0x30/CVE-2021-4034.git)

**漏洞详情:** [https://nvd.nist.gov/vuln/detail/CVE-2021-4034](https://nvd.nist.gov/vuln/detail/CVE-2021-4034)
