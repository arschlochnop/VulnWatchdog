# CVE-2021-3493

> ğŸ“¦ è¯¥CVEæœ‰ **15** ä¸ªç›¸å…³POCä»“åº“

---

## POC #1

**æ¥æº**: [CVE-2021-3493-Abdennour-py_CVE-2021-3493.md](../2021/CVE-2021-3493-Abdennour-py_CVE-2021-3493.md)

## CVE-2021-3493 Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å¯¼è‡´æ™®é€šç”¨æˆ·æå‡ä¸ºrootæƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu 5.8 kernel < 5.8.0-50.56, 5.4 kernel < 5.4.0-72.80, 4.15 kernel < 4.15.0-142.146, 4.4 kernel < 4.4.0-209.241

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç›®æ ‡ç³»ç»Ÿè¿è¡Œå—å½±å“çš„Ubuntuå†…æ ¸ï¼Œå¹¶ä¸”å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿå’Œä½¿ç”¨user namespace

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

è¯¥æ¼æ´æºäºUbuntuå†…æ ¸ä¸­overlayfså®ç°å¯¹ç”¨æˆ·å‘½åç©ºé—´ä¸­çš„æ–‡ä»¶èƒ½åŠ›éªŒè¯ä¸å½“ã€‚ç»“åˆéç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å’ŒUbuntuå†…æ ¸ä¸­çš„å…è®¸éç‰¹æƒ overlayfs æŒ‚è½½çš„è¡¥ä¸ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´è·å¾—æå‡çš„æƒé™ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**

æä¾›çš„POCä»£ç çœ‹èµ·æ¥æ˜¯æœ‰æ•ˆçš„ã€‚å®ƒåˆ©ç”¨äº† overlayfs å’Œ user namespace çš„ç»„åˆæ¥è®¾ç½®æ–‡ä»¶ capabilityï¼Œä»è€Œå®ç°ææƒã€‚ä»£ç é¦–å…ˆåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼ˆlower, upper, work, mergeï¼‰ï¼Œç„¶åä½¿ç”¨ `unshare` åˆ›å»ºä¸€ä¸ªæ–°çš„ user namespace å’Œ mount namespaceã€‚æ¥ç€ï¼Œå®ƒå†™å…¥ `/proc/self/setgroups`, `/proc/self/uid_map`, å’Œ `/proc/self/gid_map` æ¥è®¾ç½®ç”¨æˆ·å’Œç»„çš„æ˜ å°„ã€‚ç„¶åï¼ŒæŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿï¼Œæ‹·è´è‡ªèº«å¯æ‰§è¡Œæ–‡ä»¶åˆ° overlayfs çš„ merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½® capabilitiesã€‚æœ€åï¼Œå®ƒæ‰§è¡Œä½äº upper ç›®å½•çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶ä¼šå°è¯•ä»¥ root æƒé™æ‰§è¡Œ /bin/bashã€‚

æ ¹æ®æ¼æ´åº“ä¿¡æ¯ï¼ŒCISA å°†æ­¤æ¼æ´æ·»åŠ åˆ°å·²çŸ¥è¢«åˆ©ç”¨çš„æ¼æ´åˆ—è¡¨ä¸­ï¼Œè¿›ä¸€æ­¥è¡¨æ˜äº†è¯¥æ¼æ´çš„æœ‰æ•ˆæ€§ã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

æ£€æŸ¥æä¾›çš„ exploit.c ä»£ç ï¼Œæ²¡æœ‰å‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç æˆ–åé—¨ã€‚ä»£ç é€»è¾‘æ¸…æ™°ï¼Œä¸»è¦æ‰§è¡Œäº† overlayfs çš„æŒ‚è½½ï¼Œæ–‡ä»¶å¤åˆ¶ï¼Œè®¾ç½® xattr å’Œæ‰§è¡Œ shell æ“ä½œã€‚ä»£ç çš„æ„å›¾ä¸æ¼æ´æè¿°ä¸€è‡´ï¼Œæ²¡æœ‰å‘ç°éšè—çš„ã€ä¸æ¼æ´åˆ©ç”¨æ— å…³çš„æ¶æ„è¡Œä¸ºã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£é™©ä¸º 0%ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š**  åœ¨å­˜åœ¨æ¼æ´çš„Ubuntuç³»ç»Ÿä¸Šï¼Œåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ (ovlcap/work, ovlcap/lower, ovlcap/upper, ovlcap/merge)ã€‚
2.  **User Namespaceå’ŒMount Namespaceï¼š** ä½¿ç”¨ `unshare` ç³»ç»Ÿè°ƒç”¨åˆ›å»ºæ–°çš„ user namespace å’Œ mount namespaceã€‚
3.  **IDæ˜ å°„ï¼š**  é…ç½® `/proc/self/setgroups`ï¼Œ`/proc/self/uid_map` å’Œ `/proc/self/gid_map`ï¼Œä»¥ä¾¿åœ¨ user namespace ä¸­è·å¾—æœ‰æ•ˆçš„ç”¨æˆ· ID å’Œç»„ IDã€‚
4.  **OverlayFSæŒ‚è½½ï¼š**  ä½¿ç”¨ `mount` ç³»ç»Ÿè°ƒç”¨æŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿï¼Œå°† lower, upper å’Œ work ç›®å½•å…³è”èµ·æ¥ã€‚
5.  **æ–‡ä»¶æ‹·è´ä¸ Capability è®¾ç½®ï¼š**  å°† exploit ç¨‹åºè‡ªèº«æ‹·è´åˆ° overlayfs çš„ merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½® `security.capability` å±æ€§ï¼Œèµ‹äºˆå…¶ CAP_SETUID å’Œ CAP_SETGID ç­‰æƒé™ã€‚
6.  **ææƒæ‰§è¡Œï¼š** æ‰§è¡Œä½äº upper ç›®å½•çš„ exploit ç¨‹åºçš„æ‹·è´ã€‚ç”±äºè¯¥æ–‡ä»¶å…·æœ‰ capabilitiesï¼Œå› æ­¤å¯ä»¥ä»¥ root æƒé™æ‰§è¡Œ shellã€‚

**é¡¹ç›®åœ°å€:** [Abdennour-py/CVE-2021-3493](https://github.com/Abdennour-py/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #2

**æ¥æº**: [CVE-2021-3493-Sornphut_OverlayFS---CVE-2021-3493.md](../2021/CVE-2021-3493-Sornphut_OverlayFS---CVE-2021-3493.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒæ¼æ´

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Ubuntu Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœ¬åœ°ç”¨æˆ·è·å¾— root æƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu kernels before 5.8.0-50.56, 5.4.0-72.80, 4.15.0-142.146, and 4.4.0-209.241

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦è¿è¡Œåœ¨å­˜åœ¨æ¼æ´çš„ Ubuntu å†…æ ¸ä¸Šï¼Œå¹¶ä¸”å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½ overlayfsã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

è¯¥æ¼æ´å­˜åœ¨äº Ubuntu Linux å†…æ ¸çš„ overlayfs å®ç°ä¸­ã€‚ç”±äº Ubuntu å¯¹ overlayfs æŒ‚è½½çš„ç‰¹å®šä¿®æ”¹ï¼Œå¯¼è‡´åœ¨ç”¨æˆ·å‘½åç©ºé—´å†…ï¼Œå¯¹åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­çš„æ–‡ä»¶ capabilities éªŒè¯ä¸å……åˆ†ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡ overlayfs æŒ‚è½½ç»•è¿‡ capabilities æ£€æŸ¥ï¼Œè®¾ç½®æ–‡ä»¶ capabilities æå‡æƒé™ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  åˆ›å»ºä¸€ä¸ªç›®å½•ç»“æ„ï¼ŒåŒ…æ‹¬ lower, upper, work å’Œ merge ç›®å½•ã€‚
2.  ä½¿ç”¨ `unshare` åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´å’ŒæŒ‚è½½å‘½åç©ºé—´ã€‚
3.  é…ç½® `/proc/self/setgroups`, `/proc/self/uid_map`, å’Œ `/proc/self/gid_map` ä»¥æ˜ å°„ç”¨æˆ· ID å’Œç»„ IDã€‚
4.  ä½¿ç”¨ `mount` å‘½ä»¤æŒ‚è½½ overlayfsï¼Œå°† lower, upper å’Œ work ç›®å½•ä¸ merge ç›®å½•å…³è”èµ·æ¥ã€‚
5.  åœ¨ upper ç›®å½•æˆ– merge ç›®å½•ä¸‹åˆ›å»ºæˆ–å¤åˆ¶ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ã€‚
6.  ä½¿ç”¨ `setxattr` è®¾ç½®å¯æ‰§è¡Œæ–‡ä»¶çš„ capabilitiesï¼Œèµ‹äºˆå…¶ root æƒé™ã€‚
7.  æ‰§è¡Œè¯¥æ–‡ä»¶ï¼Œå³å¯è·å¾— root æƒé™ã€‚

**æœ‰æ•ˆæ€§ï¼š**

æä¾›çš„ POC ä»£ç å°è¯•åˆ©ç”¨ CVE-2021-3493 æ¼æ´ã€‚è¯¥ä»£ç åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´å’ŒæŒ‚è½½å‘½åç©ºé—´ï¼Œå¹¶å°è¯•æŒ‚è½½ overlayfsã€‚ç„¶åï¼Œå®ƒåº”è¯¥è®¾ç½® `magic` äºŒè¿›åˆ¶æ–‡ä»¶çš„ capabilitiesï¼Œä»è€Œè·å¾— root æƒé™ã€‚æ ¹æ®æ¼æ´æè¿°ï¼Œè¯¥ POC åº”è¯¥èƒ½å¤Ÿæœ‰æ•ˆåˆ©ç”¨è¯¥æ¼æ´ã€‚

**æŠ•æ¯’é£é™©ï¼š**

æ£€æŸ¥æä¾›çš„ exploit.c æ–‡ä»¶ï¼Œæœªå‘ç°æ˜æ˜¾çš„æ¶æ„æˆ–éšè—ä»£ç ã€‚ä»£ç é€»è¾‘ä¸»è¦é›†ä¸­äºè®¾ç½® overlayfs æŒ‚è½½å’Œæ–‡ä»¶ capabilitiesã€‚ä½†æ˜¯ï¼Œéœ€è¦å§‹ç»ˆè°¨æ…å¯¹å¾…æ¥è‡ªä¸å—ä¿¡ä»»æ¥æºçš„ä»£ç ã€‚ä¸ºäº†ç¡®ä¿å®‰å…¨ï¼Œå»ºè®®åœ¨å—æ§ç¯å¢ƒä¸­ä»”ç»†å®¡æŸ¥å’Œæµ‹è¯•ä»£ç ã€‚


**é¡¹ç›®åœ°å€:** [Sornphut/OverlayFS---CVE-2021-3493](https://github.com/Sornphut/OverlayFS---CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #3

**æ¥æº**: [CVE-2021-3493-briskets_CVE-2021-3493.md](../2021/CVE-2021-3493-briskets_CVE-2021-3493.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å¯¼è‡´æ™®é€šç”¨æˆ·æƒé™æå‡è‡³rootæƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu kernel versions: < 5.8.0-50.56 (5.8 kernel), < 5.4.0-72.80 (5.4 kernel), < 4.15.0-142.146 (4.15 kernel), < 4.4.0-209.241 (4.4 kernel)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦åœ¨å­˜åœ¨æ¼æ´çš„Ubuntuå†…æ ¸ç‰ˆæœ¬ä¸Šï¼Œå¹¶ä¸”å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½overlayfs

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 5%

## è¯¦æƒ…

CVE-2021-3493 æ¼æ´æ˜¯ç”±äº Linux å†…æ ¸çš„ overlayfs å®ç°æ²¡æœ‰æ­£ç¡®éªŒè¯ç”¨æˆ·å‘½åç©ºé—´ä¸­åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸Šæ–‡ä»¶ capabilities çš„è®¾ç½®ã€‚ç”±äº Ubuntu å†…æ ¸ä¸­å­˜åœ¨å…è®¸éç‰¹æƒ overlay æŒ‚è½½çš„è¡¥ä¸ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´è·å¾—æå‡çš„æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  æ¼æ´åˆ©ç”¨ä»£ç é¦–å…ˆåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ (ovlcap/work, ovlcap/lower, ovlcap/upper, ovlcap/merge)ã€‚
2.  åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´å’ŒæŒ‚è½½å‘½åç©ºé—´ã€‚
3.  åœ¨æ–°çš„ç”¨æˆ·å‘½åç©ºé—´ä¸­ï¼Œå°†å½“å‰ç”¨æˆ·çš„ UID å’Œ GID æ˜ å°„åˆ° root ç”¨æˆ·ã€‚
4.  ä½¿ç”¨ overlayfs å°† lowerdir (ovlcap/lower), upperdir (ovlcap/upper) å’Œ workdir (ovlcap/work) æŒ‚è½½åˆ° mergedir (ovlcap/merge)ã€‚
5.  å¤åˆ¶è‡ªèº« (exploit ç¨‹åº) åˆ° mergedir/magicï¼Œå¹¶è®¾ç½® security.capability æ‰©å±•å±æ€§ä¸º all+epï¼Œèµ‹äºˆè¯¥æ–‡ä»¶ capabilitiesã€‚
6.  æ‰§è¡Œ mergedir/magicï¼Œç”±äº capabilities çš„è®¾ç½®ï¼Œè¯¥ç¨‹åºä¼šä»¥ root æƒé™æ‰§è¡Œã€‚
7.  æœ€åï¼Œæ‰§è¡Œ upperdir/magicï¼Œå¯åŠ¨ä¸€ä¸ª root shellã€‚

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„POCä»£ç æ˜¯æœ‰æ•ˆçš„ï¼Œèƒ½å¤Ÿåˆ©ç”¨ CVE-2021-3493 æ¼æ´åœ¨å—å½±å“çš„ Ubuntu ç³»ç»Ÿä¸Šå®ç°æœ¬åœ°ææƒã€‚

**æŠ•æ¯’é£é™©ï¼š**
è¯¥POCä»£ç çš„ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´è¿›è¡Œææƒï¼Œä½†ä»ç„¶å­˜åœ¨æ½œåœ¨çš„æŠ•æ¯’é£é™©ã€‚æ¯”å¦‚ä½œè€…å¯èƒ½åœ¨ç¼–è¯‘å’Œè¿è¡Œå‰æ·»åŠ ä¸€äº›æ¶æ„ä»£ç ï¼Œä¾‹å¦‚ï¼š

1.  **åé—¨æ¤å…¥ï¼š** åœ¨ææƒæˆåŠŸåï¼Œæ¤å…¥ä¸€ä¸ªåé—¨ç¨‹åºï¼Œå…è®¸æ”»å‡»è€…è¿œç¨‹è®¿é—®ç³»ç»Ÿã€‚
2.  **æ•°æ®çªƒå–ï¼š** åœ¨ææƒè¿‡ç¨‹ä¸­ï¼Œçªƒå–ç”¨æˆ·çš„æ•æ„Ÿæ•°æ®ã€‚
3.  **ç ´åç³»ç»Ÿï¼š** åœ¨ææƒå¤±è´¥æˆ–è€…æˆåŠŸåï¼Œç ´åç³»ç»Ÿæ–‡ä»¶æˆ–è€…é…ç½®ã€‚

è€ƒè™‘åˆ°ä»£ç ç›¸å¯¹ç®€çŸ­ä¸”åŠŸèƒ½æ˜ç¡®ï¼Œè¯„ä¼°æŠ•æ¯’é£é™©ä¸º5%ã€‚ç”¨æˆ·éœ€è¦ä»”ç»†å®¡æŸ¥ä»£ç ï¼Œå¹¶åœ¨å®‰å…¨çš„ç¯å¢ƒä¸­è¿›è¡Œæµ‹è¯•ã€‚

**é¡¹ç›®åœ°å€:** [briskets/CVE-2021-3493](https://github.com/briskets/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #4

**æ¥æº**: [CVE-2021-3493-cyberx-1_OverlayFS-CVE-2021-3493.md](../2021/CVE-2021-3493-cyberx-1_OverlayFS-CVE-2021-3493.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯ä»æ™®é€šç”¨æˆ·ææƒè‡³root

**å½±å“ç‰ˆæœ¬:** Ubuntu kernels: 5.8.0-50.56 (5.8 kernel), 5.4.0-72.80 (5.4 kernel), 4.15.0-142.146 (4.15 kernel), 4.4.0-209.241 (4.4 kernel)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦è¿è¡Œåœ¨å­˜åœ¨æ¼æ´çš„Ubuntuå†…æ ¸ç‰ˆæœ¬ä¸Šï¼Œå¯ç”¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å’Œå…è®¸éç‰¹æƒ overlay mountsã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2021-3493æ˜¯Ubuntuå†…æ ¸OverlayFSå®ç°ä¸­çš„ä¸€ä¸ªæƒé™æå‡æ¼æ´ã€‚ç”±äºoverlayfsåœ¨ç”¨æˆ·å‘½åç©ºé—´ä¸­æ²¡æœ‰æ­£ç¡®éªŒè¯åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­æ–‡ä»¶åŠŸèƒ½è®¾ç½®ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å’ŒUbuntuå†…æ ¸ä¸­çš„éç‰¹æƒoverlayæŒ‚è½½è¡¥ä¸ï¼Œè·å–æå‡çš„æƒé™ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** åœ¨å­˜åœ¨æ¼æ´çš„Ubuntuå†…æ ¸ä¸Šï¼Œç¡®ä¿å¯ç”¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´ã€‚æ¼æ´åº“ä¿¡æ¯æåˆ°ç¦ç”¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å¯ä»¥ä½œä¸ºç¼“è§£æªæ–½ï¼Œæ‰€ä»¥è¦ç¡®ä¿å¯ç”¨ã€‚
2.  **åˆ›å»ºOverlayFSç»“æ„ï¼š** PoCä»£ç é¦–å…ˆåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼ˆlower, upper, work, mergeï¼‰ç”¨äº overlayfs æ–‡ä»¶ç³»ç»Ÿã€‚
3.  **åˆ›å»ºç”¨æˆ·å‘½åç©ºé—´ï¼š** ä½¿ç”¨`unshare`ç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´ã€‚è¿™å…è®¸åœ¨æ–°çš„å‘½åç©ºé—´ä¸­æ‹¥æœ‰ä¸åŒçš„ç”¨æˆ·IDå’Œç»„IDæ˜ å°„ã€‚
4.  **è®¾ç½®UID/GIDæ˜ å°„ï¼š** å°†å½“å‰ç”¨æˆ·çš„UIDå’ŒGIDæ˜ å°„åˆ°æ–°å‘½åç©ºé—´ä¸­çš„rootç”¨æˆ· (UID 0 å’Œ GID 0)ã€‚
5.  **æŒ‚è½½OverlayFSï¼š** ä½¿ç”¨`mount`ç³»ç»Ÿè°ƒç”¨å°† overlayfs æ–‡ä»¶ç³»ç»ŸæŒ‚è½½åˆ° merge ç›®å½•ã€‚æŒ‡å®š lowerdir, upperdir å’Œ workdirã€‚
6.  **å¤åˆ¶è‡ªèº«å¹¶è®¾ç½®Capabilitiesï¼š** å°†è‡ªèº«å¯æ‰§è¡Œæ–‡ä»¶å¤åˆ¶åˆ° overlayfs çš„ merge ç›®å½•ï¼Œç„¶åä½¿ç”¨`setxattr`è®¾ç½®`security.capability`æ‰©å±•å±æ€§ï¼Œèµ‹äºˆè¯¥æ–‡ä»¶ root æƒé™ã€‚
7.  **æ‰§è¡Œææƒåçš„ç¨‹åºï¼š** é€šè¿‡æ‰§è¡Œ upper ç›®å½•ä¸‹çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆä¹‹å‰å¤åˆ¶å¹¶è®¾ç½®äº† capabilities çš„æ–‡ä»¶ï¼‰æ¥è·å– root æƒé™ã€‚è¿™ä¸ªç¨‹åºä¼šæ£€æŸ¥æ˜¯å¦æœ‰"shell"å‚æ•°ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™ä¼šé‡æ–°æ‰§è¡Œè‡ªèº«ï¼Œä½†è¿™æ¬¡ä¼šå¸¦æœ‰`shell`å‚æ•°ï¼Œä»è€Œè§¦å‘`setuid(0)`å’Œ`setgid(0)`ï¼Œæœ€ç»ˆæ‰§è¡Œ`/bin/bash`ï¼Œè·å¾— root shellã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

ä»£ç ä¸­å­˜åœ¨ä¸€å®šçš„æŠ•æ¯’é£é™©ï¼Œè™½ç„¶ä¸»è¦é€»è¾‘æ˜¯åˆ©ç”¨æ¼æ´è¿›è¡Œææƒï¼Œä½†å­˜åœ¨ä¿®æ”¹`/bin/bash`çš„å¯èƒ½æ€§ï¼Œä½†æ˜¯ç»è¿‡ä»£ç åˆ†æä»¥åŠæ¼æ´åŸç†ï¼Œåˆ¤æ–­æ¼æ´åˆ©ç”¨è¿‡ç¨‹ä¸­æ²¡æœ‰ä¿®æ”¹`/bin/bash`æ“ä½œ,ä»£ç ä¸­é£é™©ä¸»è¦å­˜åœ¨äºä»¥ä¸‹å‡ ç‚¹:

1.  **ä¾èµ–å¤–éƒ¨äºŒè¿›åˆ¶æ–‡ä»¶ï¼š** è¯¥æ¼æ´åˆ©ç”¨ä¾èµ–äºç³»ç»Ÿä¸Šçš„`/bin/bash`ã€‚å¦‚æœæ”»å‡»è€…æ›¿æ¢æˆ–ç¯¡æ”¹äº†ç›®æ ‡ç³»ç»Ÿä¸Šçš„`/bin/bash`ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ„å¤–çš„è¡Œä¸ºæˆ–å®‰å…¨é—®é¢˜ã€‚
2.  **æ¸…ç†æ“ä½œé£é™©ï¼š** ä»£ç å¼€å§‹æ—¶ä½¿ç”¨`system(buf)`æ‰§è¡Œ`rm -rf '%s/'`ï¼Œå¦‚æœ`DIR_BASE`è¢«æ¶æ„ä¿®æ”¹ï¼Œå¯èƒ½å¯¼è‡´æ„å¤–çš„æ–‡ä»¶åˆ é™¤ã€‚
3.  **ä¸å®Œå–„çš„é”™è¯¯å¤„ç†ï¼š** è™½ç„¶ PoC ä»£ç åŒ…å«äº†ä¸€äº›é”™è¯¯å¤„ç†ï¼Œä½†åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå¦‚æœé”™è¯¯å¤„ç†ä¸å½“ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ‹’ç»æœåŠ¡æˆ–æœªå®šä¹‰çš„è¡Œä¸ºã€‚

æ€»ä½“è€Œè¨€ï¼Œè¯¥ PoC ä»£ç çš„æŠ•æ¯’é£é™©è¾ƒä½ï¼Œä¸»è¦é£é™©åœ¨äºä¾èµ–å¤–éƒ¨äºŒè¿›åˆ¶æ–‡ä»¶å’Œæ½œåœ¨çš„æ¸…ç†æ“ä½œé£é™©ã€‚ä»£ç æœ¬èº«ä¸»è¦æ˜¯ä¸ºäº†æ¼”ç¤ºæ¼æ´åˆ©ç”¨ï¼Œå¹¶æœªå‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç ã€‚ è¯„ä¼°æŠ•æ¯’é£é™©ä¸º10%ã€‚


**é¡¹ç›®åœ°å€:** [cyberx-1/OverlayFS-CVE-2021-3493](https://github.com/cyberx-1/OverlayFS-CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #5

**æ¥æº**: [CVE-2021-3493-derek-turing_CVE-2021-3493.md](../2021/CVE-2021-3493-derek-turing_CVE-2021-3493.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Ubuntu Linux Kernel

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœ¬åœ°ç”¨æˆ·å¯æå‡è‡³ root æƒé™

**å½±å“ç‰ˆæœ¬:** 4.4 <= kernel < 4.4.0-209.241, 4.15 <= kernel < 4.15.0-142.146, 5.4 <= kernel < 5.4.0-72.80, 5.8 <= kernel < 5.8.0-50.56

**åˆ©ç”¨æ¡ä»¶:** Ubuntu å†…æ ¸å¼€å¯äº† unprivileged user namespaces å’Œ unprivileged overlay mounts

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

è¯¥æ¼æ´å­˜åœ¨äº Ubuntu Linux å†…æ ¸çš„ OverlayFS å®ç°ä¸­ï¼Œç”±äº overlayfs å¯¹åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­æ–‡ä»¶ capabilities çš„è®¾ç½®éªŒè¯ä¸å½“ï¼Œç»“åˆæœªæˆæƒç”¨æˆ·å‘½åç©ºé—´å’Œ Ubuntu å†…æ ¸ä¸­å…è®¸æœªæˆæƒ overlay æŒ‚è½½çš„è¡¥ä¸ï¼Œæ”»å‡»è€…å¯åˆ©ç”¨æ­¤æ¼æ´æå‡æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** é¦–å…ˆï¼Œç¡®ä¿ç›®æ ‡ç³»ç»Ÿæ»¡è¶³æ¼æ´åˆ©ç”¨çš„æ¡ä»¶ï¼Œå³ Ubuntu å†…æ ¸ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…ï¼Œå¹¶ä¸”å¯ç”¨äº† unprivileged user namespaces å’Œ unprivileged overlay mountsã€‚æ¼æ´åº“ä¿¡æ¯ä¸­ç»™å‡ºäº†å—å½±å“çš„ç‰ˆæœ¬èŒƒå›´ã€‚
2.  **åˆ›å»ºç›®å½•ç»“æ„ï¼š** åˆ›å»º overlayfs æ‰€éœ€çš„ç›®å½•ç»“æ„ï¼ŒåŒ…æ‹¬ lowerdirï¼ˆåº•å±‚ç›®å½•ï¼‰ã€upperdirï¼ˆä¸Šå±‚ç›®å½•ï¼‰ã€workdirï¼ˆå·¥ä½œç›®å½•ï¼‰å’Œ mergedirï¼ˆåˆå¹¶ç›®å½•ï¼‰ã€‚
3.  **åˆ›å»ºç”¨æˆ·å‘½åç©ºé—´ï¼š** ä½¿ç”¨ `unshare` å‘½ä»¤åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´ï¼Œè¿™å…è®¸åœ¨éç‰¹æƒç”¨æˆ·ä¸‹æ‰§è¡Œä¸€äº›ç‰¹æƒæ“ä½œã€‚
4.  **è®¾ç½® UID/GID æ˜ å°„ï¼š** åœ¨ç”¨æˆ·å‘½åç©ºé—´ä¸­ï¼Œå°†å½“å‰ç”¨æˆ·çš„ UID å’Œ GID æ˜ å°„åˆ° root ç”¨æˆ· (UID 0) å’Œ root ç»„ (GID 0)ï¼Œè¿™æ ·åœ¨ overlayfs ä¸­åˆ›å»ºçš„æ–‡ä»¶å°†å±äº root ç”¨æˆ·ã€‚
5.  **æŒ‚è½½ OverlayFSï¼š** ä½¿ç”¨ `mount` å‘½ä»¤å°† overlayfs æŒ‚è½½åˆ° mergedirï¼ŒæŒ‡å®š lowerdirã€upperdir å’Œ workdirã€‚
6.  **å¤åˆ¶å¹¶è®¾ç½® Capabilitiesï¼š** å°† exploit ç¨‹åºè‡ªèº«å¤åˆ¶åˆ° mergedir ä¸­ï¼Œå¹¶ä½¿ç”¨ `setxattr` å‘½ä»¤è®¾ç½®å…¶ security.capability æ‰©å±•å±æ€§ï¼Œèµ‹äºˆå…¶ CAP_SETUID å’Œ CAP_SETGID capabilitiesã€‚è¿™ä¸ªcapabilitieså…è®¸ç¨‹åºåœ¨æ²¡æœ‰rootæƒé™çš„æƒ…å†µä¸‹è®¾ç½®uidå’Œgidã€‚
7.  **è§¦å‘ææƒï¼š** è¿è¡Œ mergedir ä¸­çš„ exploit ç¨‹åºï¼Œç”±äºå·²è®¾ç½® capabilitiesï¼Œç¨‹åºå°†ä»¥ root æƒé™è¿è¡Œï¼Œä»è€Œæ‰§è¡Œç‰¹æƒæ“ä½œã€‚

**ä»£ç åˆ†æï¼š**

*   `exploit.c` æ˜¯åˆ©ç”¨ä»£ç ï¼Œå®ƒåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼Œå»ºç«‹ç”¨æˆ·å‘½åç©ºé—´ï¼ŒæŒ‚è½½ overlayfsï¼Œç„¶åå°†è‡ªèº«å¤åˆ¶åˆ° overlayfs ä¸­ï¼Œå¹¶è®¾ç½® capabilitiesã€‚æœ€åï¼Œæ‰§è¡Œå¤åˆ¶åˆ° upperdir ä¸­çš„ç¨‹åºï¼Œè¯¥ç¨‹åºä¼šå°†å½“å‰è¿›ç¨‹ææƒä¸º rootã€‚
*   ä»£ç ä¸­ä½¿ç”¨äº† `setxattr` å‡½æ•°æ¥è®¾ç½®æ–‡ä»¶ capabilitiesï¼Œè¿™æ˜¯åˆ©ç”¨æ¼æ´çš„å…³é”®æ­¥éª¤ã€‚
*   mainå‡½æ•°é¦–å…ˆforkä¸€ä¸ªå­è¿›ç¨‹æ‰§è¡Œexploitå‡½æ•°ï¼Œåœ¨exploitå‡½æ•°æ‰§è¡Œå®Œæ¯•åï¼Œçˆ¶è¿›ç¨‹æ‰§è¡ŒBIN_UPPERä¸­çš„magicç¨‹åºï¼Œå¦‚æœå¸¦æœ‰shellå‚æ•°ï¼Œmagicç¨‹åºä¼šè®¾ç½®uidå’Œgidä¸º0ï¼Œå¹¶ä¸”è¿è¡Œä¸€ä¸ªbash shellã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

ä»”ç»†æ£€æŸ¥äº† POC ä»£ç ï¼Œæ²¡æœ‰å‘ç°æ˜æ˜¾çš„æŠ•æ¯’ä»£ç ã€‚ä»£ç é€»è¾‘æ¸…æ™°ï¼Œä¸»è¦ç”¨äºåˆ›å»º overlayfs ç¯å¢ƒå¹¶è®¾ç½®æ–‡ä»¶ capabilities ä»¥è¿›è¡Œææƒã€‚ä½œè€…å¹¶æ²¡æœ‰å°è¯•åœ¨ä»£ç ä¸­éšè—æ¶æ„è¡Œä¸ºï¼Œä¾‹å¦‚ï¼š

*   è¿æ¥å¤–éƒ¨æœåŠ¡å™¨
*   ä¿®æ”¹ç³»ç»Ÿæ–‡ä»¶
*   å®‰è£…åé—¨
*   æ”¶é›†ç”¨æˆ·ä¿¡æ¯

å› æ­¤ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ (0%)ã€‚

**é¡¹ç›®åœ°å€:** [derek-turing/CVE-2021-3493](https://github.com/derek-turing/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #6

**æ¥æº**: [CVE-2021-3493-fathallah17_OverlayFS-CVE-2021-3493.md](../2021/CVE-2021-3493-fathallah17_OverlayFS-CVE-2021-3493.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°æƒé™æå‡

**å½±å“åº”ç”¨:** Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å¯¼è‡´æœ¬åœ°æƒé™æå‡è‡³root

**å½±å“ç‰ˆæœ¬:** 4.4 <= Linux Kernel < 5.8.0-50.56 (Ubuntu ç‰¹å®šç‰ˆæœ¬)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦å­˜åœ¨Ubuntuå†…æ ¸ä¸­å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½OverlayFSçš„è¡¥ä¸ï¼Œä¸”ç”¨æˆ·å‘½åç©ºé—´æœªè¢«ç¦ç”¨ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 1%

## è¯¦æƒ…

CVE-2021-3493 æ˜¯ä¸€ä¸ªå­˜åœ¨äº Linux å†…æ ¸ OverlayFS å®ç°ä¸­çš„æƒé™æå‡æ¼æ´ã€‚æ¼æ´çš„æ ¹æœ¬åŸå› æ˜¯ OverlayFS åœ¨è®¾ç½®åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­æ–‡ä»¶çš„ capabilities æ—¶ï¼Œæ²¡æœ‰æ­£ç¡®åœ°éªŒè¯ç”¨æˆ·å‘½åç©ºé—´ã€‚åœ¨å­˜åœ¨å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½ OverlayFS çš„ Ubuntu å†…æ ¸è¡¥ä¸çš„ç¯å¢ƒä¸­ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´è·å¾—æå‡çš„æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š**  ç›®æ ‡ç³»ç»Ÿéœ€è¦æ˜¯å—å½±å“çš„ Ubuntu ç‰ˆæœ¬ï¼Œå¹¶ä¸”å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½ OverlayFSï¼ŒåŒæ—¶ç”¨æˆ·å‘½åç©ºé—´æ²¡æœ‰è¢«ç¦ç”¨ã€‚
2.  **è·å–æ¼æ´åˆ©ç”¨ä»£ç ï¼š**  ä»å¯ä¿¡æ¥æºè·å–æ¼æ´åˆ©ç”¨ä»£ç  (ä¾‹å¦‚ SSD-Disclosure æä¾›çš„ exploit.c)ã€‚
3.  **ç¼–è¯‘æ¼æ´åˆ©ç”¨ä»£ç ï¼š**  ä½¿ç”¨ gcc ç­‰ç¼–è¯‘å™¨å°† exploit.c ç¼–è¯‘ä¸ºå¯æ‰§è¡Œæ–‡ä»¶ã€‚
4.  **æ‰§è¡Œæ¼æ´åˆ©ç”¨ä»£ç ï¼š**  è¿è¡Œç¼–è¯‘åçš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚æ¼æ´åˆ©ç”¨ä»£ç ä¼šåˆ©ç”¨ OverlayFS çš„æ¼æ´ï¼Œé€šè¿‡è®¾ç½®æ–‡ä»¶ capabilities æ¥æå‡å½“å‰ç”¨æˆ·çš„æƒé™è‡³ rootã€‚
5.  **è·å– root æƒé™ï¼š**  æˆåŠŸæ‰§è¡Œæ¼æ´åˆ©ç”¨ä»£ç åï¼Œç”¨æˆ·å°†è·å¾— root æƒé™ã€‚

**å…³äºæŠ•æ¯’é£é™©ï¼š**

æä¾›çš„POCä»£ç åªæ˜¯ä¸€ä¸ªç®€å•çš„åˆ©ç”¨æ–¹å¼,ä¸å¤ªå¯èƒ½åŒ…å«æ¶æ„ä»£ç ã€‚ä½†å§‹ç»ˆéœ€è¦å¯¹ä»»ä½•æ¥æºçš„æ¼æ´åˆ©ç”¨ä»£ç è¿›è¡Œå®¡æŸ¥ï¼Œä»¥é™ä½é£é™©ã€‚
å¯¹ä¸‹è½½çš„æ–‡ä»¶è¿›è¡Œæ£€æŸ¥ï¼Œå¦‚å“ˆå¸Œæ ¡éªŒï¼Œå¯ä»¥æœ€å¤§ç¨‹åº¦çš„é¿å…å¼•å…¥æ¶æ„ä»£ç ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**

æ ¹æ®æ¼æ´æè¿°å’Œåˆ©ç”¨ä»£ç ï¼Œè¯¥æ¼æ´åˆ©ç”¨æ˜¯æœ‰æ•ˆçš„ã€‚åˆ©ç”¨ä»£ç é€šè¿‡OverlayFSçš„æ¼æ´ï¼Œå…è®¸ä½æƒé™ç”¨æˆ·è·å¾—rootæƒé™ã€‚

**å…¶ä»–ä¿¡æ¯:**
CISA å·²å°†æ­¤æ¼æ´æ·»åŠ åˆ°å·²çŸ¥è¢«åˆ©ç”¨çš„æ¼æ´ç›®å½• (KEV) ä¸­ï¼Œè¡¨æ˜è¯¥æ¼æ´å·²è¢«å¹¿æ³›åˆ©ç”¨ã€‚

**é¡¹ç›®åœ°å€:** [fathallah17/OverlayFS-CVE-2021-3493](https://github.com/fathallah17/OverlayFS-CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #7

**æ¥æº**: [CVE-2021-3493-fei9747_CVE-2021-3493.md](../2021/CVE-2021-3493-fei9747_CVE-2021-3493.md)

## CVE-2021-3493 Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ”»å‡»è€…å¯åˆ©ç”¨æ­¤æ¼æ´è·å– root æƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu kernel versions: < 5.8.0-50.56, < 5.4.0-72.80, < 4.15.0-142.146, < 4.4.0-209.241

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦åœ¨å­˜åœ¨æ¼æ´çš„ Ubuntu ç³»ç»Ÿä¸Šæœ¬åœ°æ‰§è¡Œ

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 5%

## è¯¦æƒ…

CVE-2021-3493 æ˜¯ä¸€ä¸ªå­˜åœ¨äº Ubuntu Linux å†…æ ¸ overlayfs å®ç°ä¸­çš„æœ¬åœ°ææƒæ¼æ´ã€‚è¯¥æ¼æ´æºäº overlayfs æœªèƒ½æ­£ç¡®éªŒè¯ç”¨æˆ·å‘½åç©ºé—´ä¸­åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸Šæ–‡ä»¶ capabilities çš„è®¾ç½®ã€‚ç»“åˆæœªæˆæƒç”¨æˆ·å‘½åç©ºé—´ä»¥åŠ Ubuntu å†…æ ¸ä¸­å…è®¸æœªæˆæƒ overlay mount çš„è¡¥ä¸ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´æå‡æƒé™ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼ŒåŒ…æ‹¬lowerdirï¼Œupperdirï¼Œworkdirå’Œmergedirã€‚
2.  **åˆ›å»ºå‘½åç©ºé—´ï¼š** ä½¿ç”¨ `unshare` ç³»ç»Ÿè°ƒç”¨åˆ›å»ºæ–°çš„ç”¨æˆ·å‘½åç©ºé—´å’ŒæŒ‚è½½å‘½åç©ºé—´ã€‚
3.  **è®¾ç½®ç”¨æˆ·å’Œç»„IDæ˜ å°„ï¼š** å°†å½“å‰ç”¨æˆ·çš„ UID å’Œ GID æ˜ å°„åˆ°æ–°çš„ç”¨æˆ·å‘½åç©ºé—´ä¸­ï¼Œä»¥ä¾¿åœ¨æ–°çš„å‘½åç©ºé—´ä¸­æ‹¥æœ‰æƒé™ã€‚
4.  **æŒ‚è½½ OverlayFSï¼š** ä½¿ç”¨ `mount` ç³»ç»Ÿè°ƒç”¨ï¼Œå°† overlayfs æŒ‚è½½åˆ° mergedirï¼Œå¹¶å°† lowerdirï¼Œupperdir å’Œ workdir æŒ‡å®šä¸ºç›¸åº”çš„ç›®å½•ã€‚
5.  **è®¾ç½® Capabilitiesï¼š** å¤åˆ¶å½“å‰æ‰§è¡Œçš„ç¨‹åºåˆ° mergedirï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½®è¯¥æ–‡ä»¶çš„ capabilitiesï¼Œä½¿å…¶å…·æœ‰ root æƒé™ã€‚ è¿™æ­¥æ˜¯æ¼æ´åˆ©ç”¨çš„å…³é”®ã€‚
6.  **æ‰§è¡ŒPayloadï¼š** æ‰§è¡Œupperç›®å½•ä¸­çš„æ–‡ä»¶ï¼Œå› ä¸ºè®¾ç½®äº†Capabilitiesï¼Œå¯ä»¥è·å¾—rootæƒé™ã€‚

**æœ‰æ•ˆæ€§ï¼š**

æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’ŒPOCä»£ç æè¿°ï¼Œè¯¥æ¼æ´åœ¨ç‰¹å®šç‰ˆæœ¬çš„ Ubuntu å†…æ ¸ä¸Šæ˜¯å¯åˆ©ç”¨çš„ã€‚æä¾›çš„POCä»£ç å±•ç¤ºäº†åˆ©ç”¨è¯¥æ¼æ´æå‡æƒé™çš„å®Œæ•´è¿‡ç¨‹ã€‚

**æŠ•æ¯’é£é™©ï¼š**

ä»£ç ä¸­å­˜åœ¨æ½œåœ¨çš„æŠ•æ¯’é£é™©ï¼Œä½†æ˜¯é£é™©è¾ƒä½ã€‚ä¸»è¦é›†ä¸­åœ¨ç¼–è¯‘å’Œè¿è¡Œexploitæ—¶ã€‚æ”»å‡»è€…å¯èƒ½é€šè¿‡ä¿®æ”¹ exploit.c æ–‡ä»¶ï¼Œä¾‹å¦‚æ·»åŠ æ¶æ„ä»£ç æˆ–åé—¨ï¼Œä»è€Œåœ¨ç›®æ ‡ç³»ç»Ÿä¸Šæ‰§è¡Œæ¶æ„æ“ä½œã€‚ä½†æ˜¯æ ¹æ®æä¾›çš„POCä»£ç æ¥çœ‹, é£é™©ç³»æ•°è¾ƒä½.

**é£é™©è¯„ä¼°ï¼š**

è¯¥æ¼æ´åˆ©ç”¨çš„æˆåŠŸå–å†³äºç›®æ ‡ç³»ç»Ÿæ˜¯å¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š

*   è¿è¡Œå—å½±å“çš„ Ubuntu å†…æ ¸ç‰ˆæœ¬ã€‚
*   å¯ç”¨äº†æœªæˆæƒç”¨æˆ·å‘½åç©ºé—´å’Œ overlayfs mountã€‚
*   ç›®æ ‡ç³»ç»Ÿä¸Šå­˜åœ¨ `gcc` ç¼–è¯‘å™¨, èƒ½å¤Ÿç¼–è¯‘exploitã€‚

å¦‚æœç›®æ ‡ç³»ç»Ÿæ»¡è¶³è¿™äº›æ¡ä»¶ï¼Œæ”»å‡»è€…å¯ä»¥ä½¿ç”¨æä¾›çš„ POC ä»£ç æˆåŠŸåˆ©ç”¨è¯¥æ¼æ´ï¼Œä»è€Œè·å¾— root æƒé™ã€‚


**é¡¹ç›®åœ°å€:** [fei9747/CVE-2021-3493](https://github.com/fei9747/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #8

**æ¥æº**: [CVE-2021-3493-iamz24_CVE-2021-3493_CVE-2022-3357.md](../2021/CVE-2021-3493-iamz24_CVE-2021-3493_CVE-2022-3357.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒæ¼æ´

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å¯¼è‡´æœ¬åœ°æƒé™æå‡è‡³ root

**å½±å“ç‰ˆæœ¬:** Ubuntu kernels < 5.8.0-50.56, < 5.4.0-72.80, < 4.15.0-142.146, < 4.4.0-209.241

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç›®æ ‡ç³»ç»Ÿå¼€å¯ unprivileged user namespaces å’Œå­˜åœ¨ OverlayFS æœåŠ¡ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2021-3493 æ¼æ´æ˜¯ Linux å†…æ ¸ overlayfs å®ç°ä¸­ï¼Œåœ¨ç”¨æˆ·å‘½åç©ºé—´ä¸­å¯¹åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­çš„æ–‡ä»¶ capabilities éªŒè¯ä¸å½“å¯¼è‡´çš„ã€‚ç”±äº Ubuntu å†…æ ¸ä¸­å­˜åœ¨å…è®¸éç‰¹æƒ overlay æŒ‚è½½çš„è¡¥ä¸ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¯¥æ¼æ´æå‡æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** æ£€æŸ¥ç›®æ ‡ç³»ç»Ÿæ˜¯å¦å­˜åœ¨ overlayfs æœåŠ¡ï¼Œå¦‚æœæ²¡æœ‰åˆ™åŠ è½½ overlay æ¨¡å—ã€‚åŒæ—¶ï¼Œç¡®ä¿å¼€å¯äº† unprivileged user namespacesã€‚
2.  **ç¼–è¯‘ Payloadï¼š** ä½¿ç”¨ GCC ç¼–è¯‘æä¾›çš„ `payload.c` æ–‡ä»¶ã€‚
3.  **è¿è¡Œ Payloadï¼š** è¿è¡Œç¼–è¯‘åçš„å¯æ‰§è¡Œæ–‡ä»¶ `a.out`ã€‚
4.  **è·å– Root Shellï¼š** Payload ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å‘½åç©ºé—´ï¼ŒæŒ‚è½½ overlayfsï¼Œè®¾ç½® capabilityï¼Œæœ€ç»ˆæ‰§è¡Œä¸€ä¸ªå…·æœ‰ root æƒé™çš„ shellã€‚

**æœ‰æ•ˆæ€§ï¼š**

æä¾›çš„ POC ä»£ç åŸºæœ¬æœ‰æ•ˆï¼Œèƒ½å¤Ÿåˆ©ç”¨è¯¥æ¼æ´åœ¨ç¬¦åˆæ¡ä»¶çš„ Ubuntu ç³»ç»Ÿä¸Šå®ç°æœ¬åœ°ææƒã€‚

**æŠ•æ¯’é£é™©ï¼š**

å­˜åœ¨è¾ƒä½çš„æŠ•æ¯’é£é™©ï¼ˆ10%ï¼‰ã€‚è™½ç„¶ä»£ç çš„ä¸»è¦åŠŸèƒ½æ˜¯å®ç°ææƒï¼Œä½†ä»ç„¶éœ€è¦è°¨æ…å¯¹å¾…æ¥æºä¸æ˜çš„ä»£ç ï¼Œä½œè€…å¯èƒ½ä¼šåœ¨å…¶ä¸­éšè—ä¸€äº›æ¶æ„è¡Œä¸ºï¼Œæ¯”å¦‚ä¸Šä¼ æ•æ„Ÿä¿¡æ¯ç­‰ã€‚ç‰¹åˆ«æ˜¯éœ€è¦æ£€æŸ¥ `exploit`å‡½æ•°ä¸­çš„ç›¸å…³æ–‡ä»¶æ“ä½œå’Œå‘½ä»¤æ‰§è¡Œæ˜¯å¦å­˜åœ¨æ¶æ„è¡Œä¸ºã€‚å°¤å…¶å…³æ³¨`system(buf);`æ˜¯å¦ä¼šæ‰§è¡Œæ¶æ„çš„æŒ‡ä»¤ã€‚

**æ€»ç»“ï¼š**

è¯¥æ¼æ´åˆ©ç”¨è¾ƒä¸ºç›´æ¥ï¼Œåˆ©ç”¨æ¡ä»¶ç›¸å¯¹æ˜ç¡®ï¼Œä½†éœ€è¦æ³¨æ„æ½œåœ¨çš„æŠ•æ¯’é£é™©ã€‚åœ¨å®é™…ä½¿ç”¨æ—¶ï¼Œåº”è¯¥ä»”ç»†å®¡æŸ¥ä»£ç ï¼Œç¡®ä¿æ²¡æœ‰æ¶æ„è¡Œä¸ºã€‚

**é¡¹ç›®åœ°å€:** [iamz24/CVE-2021-3493_CVE-2022-3357](https://github.com/iamz24/CVE-2021-3493_CVE-2022-3357)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #9

**æ¥æº**: [CVE-2021-3493-inspiringz_CVE-2021-3493.md](../2021/CVE-2021-3493-inspiringz_CVE-2021-3493.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Ubuntu Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸ä½æƒé™ç”¨æˆ·æå‡åˆ°rootæƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu 4.4, 4.15, 5.4, 5.8 kernels (å—å½±å“ç‰ˆæœ¬è¯¦è§æ¼æ´åº“ä¿¡æ¯)

**åˆ©ç”¨æ¡ä»¶:** Ubuntuå†…æ ¸ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…ï¼Œå¯ç”¨æœªæˆæƒç”¨æˆ·å‘½åç©ºé—´ï¼Œå…è®¸æœªæˆæƒOverlayFSæŒ‚è½½ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 5%

## è¯¦æƒ…

CVE-2021-3493æ˜¯Ubuntuå†…æ ¸ä¸­OverlayFSå®ç°çš„ä¸€ä¸ªæ¼æ´ï¼Œå…è®¸ä½æƒé™ç”¨æˆ·é€šè¿‡åˆ©ç”¨user namespaceå’ŒOverlayFSæŒ‚è½½ç»•è¿‡æ–‡ä»¶ç³»ç»Ÿæƒé™æ£€æŸ¥æ¥æå‡æƒé™ã€‚ 

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡:** æ¼æ´åˆ©ç”¨éœ€è¦å­˜åœ¨Ubuntuç³»ç»Ÿï¼Œä¸”å†…æ ¸ç‰ˆæœ¬åœ¨æ¼æ´åº“ä¿¡æ¯ä¸­æè¿°çš„å—å½±å“èŒƒå›´å†…ï¼Œå¹¶ä¸”éœ€è¦å¯ç”¨æœªæˆæƒç”¨æˆ·å‘½åç©ºé—´(unprivileged user namespaces)ã€‚æ­¤å¤–ï¼Œä¸ºäº†åˆ©ç”¨OverlayFSï¼Œç³»ç»Ÿéœ€è¦é…ç½®å…è®¸æœªæˆæƒç”¨æˆ·è¿›è¡ŒOverlayFSæŒ‚è½½ã€‚
2.  **æ¼æ´åˆ©ç”¨:**  æ”»å‡»è€…é¦–å…ˆåˆ›å»ºä¸€ä¸ªåŒ…å«lower, upper, workç›®å½•çš„OverlayFSç»“æ„ã€‚
3.  **åˆ©ç”¨è¿‡ç¨‹:** åˆ©ç”¨`unshare`ç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€ä¸ªæ–°çš„user namespaceå’Œmount namespaceã€‚ åœ¨æ–°namespaceä¸­ï¼Œå°†è‡ªå·±çš„UIDå’ŒGIDæ˜ å°„åˆ°rootæƒé™ã€‚ ç„¶åï¼Œä½¿ç”¨æ„é€ çš„lowerdirã€upperdirå’ŒworkdiræŒ‚è½½OverlayFSæ–‡ä»¶ç³»ç»Ÿã€‚ æ”»å‡»è€…å°†ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶å¤åˆ¶åˆ°OverlayFSçš„mergeç›®å½•ä¸­ã€‚å…³é”®çš„ä¸€æ­¥æ˜¯ï¼Œæ”»å‡»è€…ä½¿ç”¨`setxattr`ç³»ç»Ÿè°ƒç”¨ï¼Œè®¾ç½®è¯¥å¯æ‰§è¡Œæ–‡ä»¶çš„`security.capability`æ‰©å±•å±æ€§ï¼Œèµ‹äºˆå®ƒ`CAP_SETUID`å’Œ`CAP_SETGID`èƒ½åŠ›ã€‚ ç”±äºOverlayFSçš„æƒé™éªŒè¯ä¸å®Œå–„ï¼Œè¿™ä¸ªæ“ä½œå³ä½¿åœ¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´ä¸­ä¹Ÿèƒ½æˆåŠŸã€‚å½“æ‰§è¡Œè¯¥æ–‡ä»¶æ—¶ï¼Œå®ƒå°†è·å¾—rootæƒé™ï¼Œå¹¶å¯ä»¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚
4.  **POCä»£ç åˆ†æ:** `exploit.c` ä»£ç é¦–å…ˆåˆ›å»ºä¸€ä¸ªoverlayfsç›®å½•ç»“æ„ã€‚ç„¶åï¼Œä½¿ç”¨ `unshare` ç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€ä¸ªæ–°çš„ user namespace å’Œ mount namespaceï¼Œå¹¶å°†å½“å‰ç”¨æˆ·çš„ uid å’Œ gid æ˜ å°„åˆ° root ç”¨æˆ·ã€‚ ä¹‹åï¼Œå®ƒæŒ‚è½½ overlayfsï¼Œå¤åˆ¶å½“å‰æ‰§è¡Œçš„ç¨‹åºåˆ° overlayfs çš„ merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½® capabilityã€‚æœ€åï¼Œæ‰§è¡Œå¤åˆ¶åˆ° overlayfs çš„ç¨‹åºã€‚
5. **æŠ•æ¯’é£é™©åˆ†æ:** ä»£ç æœ¬èº«å®ç°äº†æ¼æ´åˆ©ç”¨çš„åŠŸèƒ½ã€‚ æ½œåœ¨çš„æŠ•æ¯’é£é™©å¯èƒ½å­˜åœ¨äºä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š
    *   **ä¾èµ–é¡¹:**  ä»£ç ä¾èµ–äºæ ‡å‡†çš„Cåº“ï¼Œæœ¬èº«ä¸å­˜åœ¨æ¶æ„ä¾èµ–ã€‚ä½†ç”¨æˆ·åœ¨ç¼–è¯‘æ—¶éœ€è¦æ³¨æ„ç¼–è¯‘å™¨ç¯å¢ƒçš„å®‰å…¨æ€§ã€‚
    *   **ä»£ç é€»è¾‘:**  ä»£ç é€»è¾‘ç›¸å¯¹ç®€å•ï¼Œä¸»è¦é›†ä¸­åœ¨namespaceåˆ›å»ºã€æŒ‚è½½å’Œcapabilityè®¾ç½®ã€‚ ä»”ç»†å®¡æŸ¥ä»£ç ï¼Œæœªå‘ç°æ˜æ˜¾çš„æ¶æ„é€»è¾‘ã€‚
    *   **æ‰§è¡Œå‘½ä»¤:**  ä»£ç ä¸­ä½¿ç”¨äº† `system` å‡½æ•°ï¼Œè¿™æ˜¯ä¸€ä¸ªæ½œåœ¨çš„é£é™©ç‚¹ï¼Œå¯ä»¥æ‰§è¡Œä»»æ„ç³»ç»Ÿå‘½ä»¤ã€‚ä½†æ˜¯ï¼Œè¿™é‡Œåªæ˜¯ç”¨æ¥åˆ é™¤ç›®å½•ï¼Œç›¸å¯¹å®‰å…¨ã€‚
       ç»¼ä¸Šæ‰€è¿°ï¼Œè¯¥POCä»£ç ä¸»è¦é£é™©åœ¨äºç¡®ä¿ç¼–è¯‘ç¯å¢ƒå®‰å…¨ä»¥åŠå¯¹ä¸ç†Ÿæ‚‰çš„å‘½ä»¤ä¿æŒè­¦æƒ•ã€‚æŠ•æ¯’é£é™©è¾ƒä½ï¼Œé¢„ä¼°ä¸º5%ã€‚

**æ€»ç»“ï¼š**

è¯¥æ¼æ´åˆ©ç”¨çš„æ ¸å¿ƒåœ¨äºç»“åˆäº†æœªæˆæƒç”¨æˆ·å‘½åç©ºé—´å’ŒOverlayFSï¼Œåˆ©ç”¨OverlayFSå¯¹capabilitiesè®¾ç½®éªŒè¯çš„ç¼ºé™·ï¼Œå®ç°äº†æœ¬åœ°ææƒã€‚ æ”»å‡»è€…é€šè¿‡åˆ›å»ºç‰¹æ®Šçš„OverlayFSç»“æ„å¹¶è®¾ç½®æ–‡ä»¶capabilitiesï¼Œæœ€ç»ˆè·å¾—rootæƒé™ã€‚

**é¡¹ç›®åœ°å€:** [inspiringz/CVE-2021-3493](https://github.com/inspiringz/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #10

**æ¥æº**: [CVE-2021-3493-oneoy_CVE-2021-3493.md](../2021/CVE-2021-3493-oneoy_CVE-2021-3493.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœ¬åœ°ç”¨æˆ·å¯æå‡è‡³ root æƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu 4.4, 4.15, 5.4, and 5.8 kernels (å…·ä½“ç‰ˆæœ¬å·è§æ¼æ´åº“ä¿¡æ¯)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç›®æ ‡ç³»ç»Ÿå­˜åœ¨æœªä¿®å¤çš„ Ubuntu kernelï¼Œä¸”å¯ç”¨ unprivileged user namespaces å’Œå…è®¸ unprivileged overlayfs mountsã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

è¯¥æ¼æ´å­˜åœ¨äº Ubuntu å†…æ ¸çš„ OverlayFS å®ç°ä¸­ï¼Œç”±äºæœªæ­£ç¡®éªŒè¯ç”¨æˆ·å‘½åç©ºé—´ä¸­åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸Šæ–‡ä»¶ capabilities çš„è®¾ç½®ï¼Œå¯¼è‡´æœ¬åœ°æ”»å‡»è€…å¯åˆ©ç”¨ unprivileged user namespaces å’Œ Ubuntu å†…æ ¸ä¸­å…è®¸ unprivileged overlayfs mounts çš„è¡¥ä¸æ¥æå‡æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ (lower, upper, work, merge)ã€‚
2.  **é…ç½® User Namespace:** åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´ã€‚
3.  **é…ç½® OverlayFS:** ä½¿ç”¨ lowerdir, upperdir, å’Œ workdir é€‰é¡¹æŒ‚è½½ overlay æ–‡ä»¶ç³»ç»Ÿã€‚
4.  **è®¾ç½® Capabilities:** å°†å¯æ‰§è¡Œæ–‡ä»¶å¤åˆ¶åˆ° merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½®å…¶ capabilities (å¦‚ CAP_SETUID, CAP_SETGID, CAP_CHOWN)ã€‚
5.  **è§¦å‘ææƒ:** æ‰§è¡Œ merge ç›®å½•ä¸­çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶å°†ä¼šä»¥ root æƒé™æ‰§è¡Œã€‚

**æŠ•æ¯’é£é™©è¯„ä¼°ï¼š**

æä¾›çš„ `exploit.c` ä»£ç ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨ OverlayFS çš„æ¼æ´è¿›è¡Œææƒã€‚ä»£ç åˆ›å»ºå¿…è¦çš„ç›®å½•ï¼Œé…ç½® user namespace å’Œ overlay æ–‡ä»¶ç³»ç»Ÿï¼Œå¹¶è®¾ç½®å¯æ‰§è¡Œæ–‡ä»¶çš„ capabilitiesã€‚ä»£ç é€»è¾‘æ¸…æ™°ï¼Œæ²¡æœ‰å‘ç°æ¶æ„ä»£ç æˆ–åé—¨ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**

æä¾›çš„ POC ä»£ç åŸºäºå…¬å¼€ä¿¡æ¯ï¼Œå¹¶é’ˆå¯¹ CVE-2021-3493 æ¼æ´è¿›è¡Œäº†åˆ©ç”¨ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯ã€æœç´¢å¼•æ“ç»“æœå’Œä»£ç åˆ†æï¼Œè¯¥ POC ä»£ç åœ¨æ»¡è¶³æ¼æ´åˆ©ç”¨æ¡ä»¶çš„æƒ…å†µä¸‹åº”è¯¥æ˜¯æœ‰æ•ˆçš„ã€‚

**é¡¹ç›®åœ°å€:** [oneoy/CVE-2021-3493](https://github.com/oneoy/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #11

**æ¥æº**: [CVE-2021-3493-pmihsan_OverlayFS-CVE-2021-3493.md](../2021/CVE-2021-3493-pmihsan_OverlayFS-CVE-2021-3493.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœ¬åœ°ç”¨æˆ·å¯æå‡è‡³ root æƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu kernel versions: < 5.8.0-50.56 (5.8 kernel), < 5.4.0-72.80 (5.4 kernel), < 4.15.0-142.146 (4.15 kernel), < 4.4.0-209.241 (4.4 kernel)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦åœ¨å­˜åœ¨æ¼æ´çš„ Ubuntu ç³»ç»Ÿä¸Šæ‰§è¡Œï¼Œå¹¶ä¸”å…è®¸ unprivileged user namespaces å’Œ overlay mountsã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

CVE-2021-3493 æ¼æ´å­˜åœ¨äº Linux å†…æ ¸çš„ overlayfs å®ç°ä¸­ã€‚ç”±äºå¯¹ç”¨æˆ·å‘½åç©ºé—´ä¸­åº•å±‚æ–‡ä»¶ç³»ç»Ÿæ–‡ä»¶ capabilities çš„éªŒè¯ä¸è¶³ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡åˆ›å»ºæ¶æ„çš„ overlayfs æ–‡ä»¶ç³»ç»Ÿï¼Œåˆ©ç”¨ setxattr è®¾ç½®æ–‡ä»¶ capabilitiesï¼Œä»è€Œè·å¾—æå‡çš„æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** åˆ›å»º overlayfs æ‰€éœ€çš„ç›®å½•ç»“æ„ (lower, upper, work, merge)ã€‚
2.  **Namespace åˆ›å»ºï¼š** åˆ›å»ºæ–°çš„ user namespace å’Œ mount namespaceï¼Œéš”ç¦»æƒé™ã€‚
3.  **æƒé™è®¾ç½®ï¼š** ä¿®æ”¹ uid_map å’Œ gid_mapï¼Œä½¿å¾—åœ¨ user namespace ä¸­æ‹¥æœ‰ root æƒé™ã€‚
4.  **Overlayfs Mountï¼š** ä½¿ç”¨ overlayfs mount å‘½ä»¤å°† lowerdir, upperdir, workdir æŒ‚è½½åˆ° mergedirã€‚
5.  **Capabilities è®¾ç½®ï¼š** å¤åˆ¶è‡ªèº«ç¨‹åºåˆ° merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` å‡½æ•°ä¸ºå¤åˆ¶åçš„ç¨‹åºè®¾ç½® capabilities (CAP_SETUID, CAP_SETGID, CAP_DAC_OVERRIDE ç­‰)ã€‚
6.  **æƒé™æå‡ï¼š** æ‰§è¡Œ merge ç›®å½•ä¸‹çš„ç¨‹åºï¼Œæ­¤æ—¶ç¨‹åºå°†ä»¥ root æƒé™è¿è¡Œã€‚

**æœ‰æ•ˆæ€§ï¼š**

æä¾›çš„ POC ä»£ç é€šè¿‡åˆ©ç”¨ overlayfs æ¼æ´ï¼Œå¯ä»¥æˆåŠŸåœ°æå‡æƒé™ã€‚POC ä»£ç é¦–å…ˆåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼Œç„¶ååˆ›å»ºä¸€ä¸ªæ–°çš„ user namespace å’Œ mount namespaceï¼Œæ¥ç€æŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿï¼Œå¹¶ä½¿ç”¨ `setxattr` å‡½æ•°ä¸ºæ–‡ä»¶è®¾ç½® capabilitiesã€‚æœ€åï¼Œæ‰§è¡Œè¯¥æ–‡ä»¶å³å¯è·å¾— root æƒé™ã€‚

**æŠ•æ¯’é£é™©ï¼š**

åˆ†æ POC ä»£ç ï¼Œæ²¡æœ‰å‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç ï¼Œä¾‹å¦‚åå¼¹ shellã€å®‰è£…åé—¨ç­‰ã€‚ä»£ç é€»è¾‘ä¸»è¦é›†ä¸­åœ¨åˆ©ç”¨ overlayfs æ¼æ´ææƒï¼Œå¹¶æ²¡æœ‰é¢å¤–çš„æ“ä½œæ¥æ¤å…¥æ¶æ„ç¨‹åºã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ï¼Œå¯ä»¥è®¤ä¸ºæ˜¯ 0%ã€‚å‚è€ƒçš„ vulnerability description å’Œ exploit ä»£ç éƒ½ç€é‡äºææƒï¼Œè€Œæ²¡æœ‰æåˆ°ä»»ä½•æŠ•æ¯’è¡Œä¸ºã€‚

**é¡¹ç›®åœ°å€:** [pmihsan/OverlayFS-CVE-2021-3493](https://github.com/pmihsan/OverlayFS-CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #12

**æ¥æº**: [CVE-2021-3493-ptkhai15_OverlayFS---CVE-2021-3493.md](../2021/CVE-2021-3493-ptkhai15_OverlayFS---CVE-2021-3493.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Ubuntu Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœ¬åœ°ç”¨æˆ·æå‡æƒé™è‡³ root

**å½±å“ç‰ˆæœ¬:** Ubuntu kernel versions 5.8, 5.4, 4.15, å’Œ 4.4 ä¸­å—å½±å“çš„ç‰ˆæœ¬ï¼ˆå…·ä½“ç‰ˆæœ¬å‚è§æ¼æ´åº“ä¿¡æ¯ï¼‰

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡ç³»ç»Ÿå¿…é¡»æ˜¯å—å½±å“çš„ Ubuntu ç‰ˆæœ¬ï¼Œå¹¶ä¸”å¯ç”¨äº†éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å’Œéç‰¹æƒ overlayfs æŒ‚è½½ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

CVE-2021-3493 æ˜¯ Ubuntu Linux å†…æ ¸ä¸­ OverlayFS å®ç°ä¸­çš„ä¸€ä¸ªæ¼æ´ã€‚è¯¥æ¼æ´å…è®¸éç‰¹æƒç”¨æˆ·åˆ©ç”¨ç”¨æˆ·å‘½åç©ºé—´å’Œéç‰¹æƒ overlayfs æŒ‚è½½ï¼Œé€šè¿‡ä¸æ­£ç¡®åœ°éªŒè¯åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­æ–‡ä»¶çš„ capabilities è®¾ç½®æ¥æå‡æƒé™ã€‚åˆ©ç”¨æ–¹å¼å¦‚ä¸‹ï¼š

1.  **ç¯å¢ƒå‡†å¤‡ï¼š**  åˆ›å»ºä¸€ä¸ªåŸºç¡€ç›®å½•ç»“æ„ï¼ŒåŒ…æ‹¬ workã€lowerã€upper å’Œ merge ç›®å½•ï¼Œè¿™æ˜¯ overlayfs çš„æ ‡å‡†é…ç½®ã€‚
2.  **åˆ›å»ºç”¨æˆ·å‘½åç©ºé—´ï¼š**  ä½¿ç”¨ `unshare` å‘½ä»¤åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´ã€‚è¿™å…è®¸åœ¨æ–°çš„å‘½åç©ºé—´ä¸­æ‹¥æœ‰ä¸åŒçš„ç”¨æˆ·å’Œç»„ IDã€‚
3.  **é…ç½®ç”¨æˆ·å’Œç»„æ˜ å°„ï¼š**  é€šè¿‡ `/proc/self/setgroups`ã€`/proc/self/uid_map` å’Œ `/proc/self/gid_map` æ–‡ä»¶è®¾ç½®ç”¨æˆ·å’Œç»„ ID æ˜ å°„ï¼Œå°†å½“å‰ç”¨æˆ·çš„ UID å’Œ GID æ˜ å°„åˆ°æ–°å‘½åç©ºé—´ä¸­çš„ root ç”¨æˆ·ã€‚
4.  **æŒ‚è½½ OverlayFSï¼š**  ä½¿ç”¨ `mount` å‘½ä»¤æŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿï¼Œå°† lowerã€upper å’Œ work ç›®å½•å…³è”èµ·æ¥ã€‚
5.  **è®¾ç½®æ–‡ä»¶ capabilitiesï¼š**  å¤åˆ¶å½“å‰æ‰§è¡Œç¨‹åºåˆ° overlayfs çš„ merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½®æ–‡ä»¶çš„ capabilities ä¸º `all+ep`ï¼Œå…è®¸è¯¥æ–‡ä»¶æ‰§è¡Œæ—¶æ‹¥æœ‰ root æƒé™ã€‚
6.  **æ‰§è¡Œææƒåçš„ç¨‹åºï¼š**  æ‰§è¡Œä½äº upper ç›®å½•ä¸­çš„å¤åˆ¶åçš„ç¨‹åºã€‚å¦‚æœç¨‹åºæ£€æµ‹åˆ°è‡ªå·±æ˜¯é€šè¿‡ç‰¹å®šæ–¹å¼ï¼ˆä¾‹å¦‚ï¼ŒåŒ…å« "magic" å­—ç¬¦ä¸²æˆ–æ¥å— "shell" å‚æ•°ï¼‰è°ƒç”¨çš„ï¼Œå®ƒä¼šè°ƒç”¨ `setuid(0)` å’Œ `setgid(0)` å°†è¿›ç¨‹çš„ UID å’Œ GID è®¾ç½®ä¸º 0 (root)ï¼Œå¹¶å¯åŠ¨ä¸€ä¸ª root shellã€‚

**å…³äºæŠ•æ¯’é£é™©ï¼š**

åœ¨æä¾›çš„ POC ä»£ç ä¸­ï¼Œæ²¡æœ‰æ˜æ˜¾çš„æŠ•æ¯’ä»£ç ã€‚POC çš„ç›®çš„æ˜¯æ¼”ç¤ºæ¼æ´åˆ©ç”¨è¿‡ç¨‹ï¼Œæ²¡æœ‰å‘ç°æ¶æ„è¡Œä¸ºï¼Œä¾‹å¦‚åå‘ shell æˆ–å…¶ä»–æœªç»æˆæƒçš„è®¿é—®ã€‚


**é¡¹ç›®åœ°å€:** [ptkhai15/OverlayFS---CVE-2021-3493](https://github.com/ptkhai15/OverlayFS---CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #13

**æ¥æº**: [CVE-2021-3493-puckiestyle_CVE-2021-3493.md](../2021/CVE-2021-3493-puckiestyle_CVE-2021-3493.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ”»å‡»è€…å¯åˆ©ç”¨æ­¤æ¼æ´è·å¾— root æƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu 5.8 kernel (< 5.8.0-50.56), 5.4 kernel (< 5.4.0-72.80), 4.15 kernel (< 4.15.0-142.146), 4.4 kernel (< 4.4.0-209.241)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ Ubuntu ç³»ç»Ÿå¼€å¯ unprivileged user namespaces å’Œå…è®¸ unprivileged overlay mounts

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2021-3493 æ˜¯ Ubuntu å†…æ ¸ overlayfs å®ç°ä¸­çš„ä¸€ä¸ªæ¼æ´ï¼Œå…è®¸æœ¬åœ°æ”»å‡»è€…é€šè¿‡æ»¥ç”¨ user namespaces å’Œ overlayfs æŒ‚è½½æœºåˆ¶æå‡æƒé™ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**
æä¾›çš„ POC ä»£ç å°è¯•åˆ©ç”¨è¯¥æ¼æ´ï¼Œé€šè¿‡åˆ›å»º user namespace å’Œ overlayfs æ–‡ä»¶ç³»ç»Ÿæ¥è®¾ç½®å¯æ‰§è¡Œæ–‡ä»¶çš„ capability ä½ï¼Œä½¿å…¶è·å¾— root æƒé™ã€‚ æ¼æ´åº“ä¿¡æ¯,æœç´¢å¼•æ“ç»“æœå’Œæ¼æ´åˆ©ç”¨ä»£ç ä¸€è‡´,è¡¨æ˜è¯¥æ¼æ´çš„POCæ˜¯çœŸå®æœ‰æ•ˆçš„ã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**
æŸ¥çœ‹ `exploit.c` ä»£ç ï¼Œä¸»è¦æ“ä½œåŒ…æ‹¬åˆ›å»ºç›®å½•ã€è®¾ç½® user namespaceã€æŒ‚è½½ overlayfsã€å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶ã€è®¾ç½® capability å±æ€§ï¼Œä»¥åŠæ‰§è¡Œå¤åˆ¶åçš„æ–‡ä»¶ä»¥è·å¾— root æƒé™ã€‚ä»£ç é€»è¾‘è¾ƒä¸ºæ¸…æ™°ï¼Œæœªå‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç ã€‚`README.md` ä¹Ÿè¯´æ˜äº†å¹¶éä½œè€…åŸåˆ›,åªæ˜¯æ¬è¿,å¢åŠ äº†åˆ†æéš¾åº¦.
`exploit.c`ä¸­å­˜åœ¨`system(buf);` è°ƒç”¨ï¼Œè™½ç„¶è¿™é‡Œæ˜¯ç”¨äºæ¸…ç†ç›®å½•ï¼Œä½†å¦‚æœè¢«ç¯¡æ”¹ï¼Œå¯èƒ½æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£é™©è¯„ä¼°ä¸º10%ã€‚ä¸»è¦çš„é£é™©åœ¨äºï¼š

*   `system()` å‡½æ•°æ½œåœ¨çš„å‘½ä»¤æ³¨å…¥é£é™©ï¼Œå¦‚æœä»£ç è¢«ä¿®æ”¹ï¼Œå¯èƒ½å¯¼è‡´æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  åˆ©ç”¨ unshare() åˆ›å»ºä¸€ä¸ªæ–°çš„ user namespace å’Œ mount namespaceã€‚
2.  é…ç½® user namespace çš„ uid_map å’Œ gid_mapï¼Œå°†å½“å‰ç”¨æˆ·æ˜ å°„ä¸º root ç”¨æˆ·ã€‚
3.  åˆ›å»º overlayfs æ‰€éœ€çš„ç›®å½•ç»“æ„ï¼ˆlowerdirã€upperdirã€workdirã€mergedï¼‰ã€‚
4.  æŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿã€‚
5.  å°†æ¼æ´åˆ©ç”¨ç¨‹åºè‡ªèº«å¤åˆ¶åˆ° overlayfs çš„ upperdir/merged ç›®å½•ã€‚
6.  ä½¿ç”¨ setxattr() è®¾ç½®å¤åˆ¶åçš„å¯æ‰§è¡Œæ–‡ä»¶çš„ security.capability å±æ€§ï¼Œèµ‹äºˆå…¶ CAP_SETUID å’Œ CAP_SETGID æƒé™ã€‚
7.  æ‰§è¡Œå¤åˆ¶åçš„ç¨‹åºï¼Œç”±äºè®¾ç½®äº† capabilityï¼Œè¯¥ç¨‹åºä¼šä»¥ root æƒé™è¿è¡Œï¼Œä»è€Œè·å¾— root shellã€‚

**é¡¹ç›®åœ°å€:** [puckiestyle/CVE-2021-3493](https://github.com/puckiestyle/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #14

**æ¥æº**: [CVE-2021-3493-smallkill_CVE-2021-3493.md](../2021/CVE-2021-3493-smallkill_CVE-2021-3493.md)

# CVE-2021-3493

> ğŸ“¦ è¯¥CVEæœ‰ **15** ä¸ªç›¸å…³POCä»“åº“

---

## POC #1

**æ¥æº**: [CVE-2021-3493-Abdennour-py_CVE-2021-3493.md](../2021/CVE-2021-3493-Abdennour-py_CVE-2021-3493.md)

## CVE-2021-3493 Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å¯¼è‡´æ™®é€šç”¨æˆ·æå‡ä¸ºrootæƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu 5.8 kernel < 5.8.0-50.56, 5.4 kernel < 5.4.0-72.80, 4.15 kernel < 4.15.0-142.146, 4.4 kernel < 4.4.0-209.241

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç›®æ ‡ç³»ç»Ÿè¿è¡Œå—å½±å“çš„Ubuntuå†…æ ¸ï¼Œå¹¶ä¸”å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿå’Œä½¿ç”¨user namespace

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

è¯¥æ¼æ´æºäºUbuntuå†…æ ¸ä¸­overlayfså®ç°å¯¹ç”¨æˆ·å‘½åç©ºé—´ä¸­çš„æ–‡ä»¶èƒ½åŠ›éªŒè¯ä¸å½“ã€‚ç»“åˆéç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å’ŒUbuntuå†…æ ¸ä¸­çš„å…è®¸éç‰¹æƒ overlayfs æŒ‚è½½çš„è¡¥ä¸ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´è·å¾—æå‡çš„æƒé™ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**

æä¾›çš„POCä»£ç çœ‹èµ·æ¥æ˜¯æœ‰æ•ˆçš„ã€‚å®ƒåˆ©ç”¨äº† overlayfs å’Œ user namespace çš„ç»„åˆæ¥è®¾ç½®æ–‡ä»¶ capabilityï¼Œä»è€Œå®ç°ææƒã€‚ä»£ç é¦–å…ˆåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼ˆlower, upper, work, mergeï¼‰ï¼Œç„¶åä½¿ç”¨ `unshare` åˆ›å»ºä¸€ä¸ªæ–°çš„ user namespace å’Œ mount namespaceã€‚æ¥ç€ï¼Œå®ƒå†™å…¥ `/proc/self/setgroups`, `/proc/self/uid_map`, å’Œ `/proc/self/gid_map` æ¥è®¾ç½®ç”¨æˆ·å’Œç»„çš„æ˜ å°„ã€‚ç„¶åï¼ŒæŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿï¼Œæ‹·è´è‡ªèº«å¯æ‰§è¡Œæ–‡ä»¶åˆ° overlayfs çš„ merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½® capabilitiesã€‚æœ€åï¼Œå®ƒæ‰§è¡Œä½äº upper ç›®å½•çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶ä¼šå°è¯•ä»¥ root æƒé™æ‰§è¡Œ /bin/bashã€‚

æ ¹æ®æ¼æ´åº“ä¿¡æ¯ï¼ŒCISA å°†æ­¤æ¼æ´æ·»åŠ åˆ°å·²çŸ¥è¢«åˆ©ç”¨çš„æ¼æ´åˆ—è¡¨ä¸­ï¼Œè¿›ä¸€æ­¥è¡¨æ˜äº†è¯¥æ¼æ´çš„æœ‰æ•ˆæ€§ã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

æ£€æŸ¥æä¾›çš„ exploit.c ä»£ç ï¼Œæ²¡æœ‰å‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç æˆ–åé—¨ã€‚ä»£ç é€»è¾‘æ¸…æ™°ï¼Œä¸»è¦æ‰§è¡Œäº† overlayfs çš„æŒ‚è½½ï¼Œæ–‡ä»¶å¤åˆ¶ï¼Œè®¾ç½® xattr å’Œæ‰§è¡Œ shell æ“ä½œã€‚ä»£ç çš„æ„å›¾ä¸æ¼æ´æè¿°ä¸€è‡´ï¼Œæ²¡æœ‰å‘ç°éšè—çš„ã€ä¸æ¼æ´åˆ©ç”¨æ— å…³çš„æ¶æ„è¡Œä¸ºã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£é™©ä¸º 0%ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š**  åœ¨å­˜åœ¨æ¼æ´çš„Ubuntuç³»ç»Ÿä¸Šï¼Œåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ (ovlcap/work, ovlcap/lower, ovlcap/upper, ovlcap/merge)ã€‚
2.  **User Namespaceå’ŒMount Namespaceï¼š** ä½¿ç”¨ `unshare` ç³»ç»Ÿè°ƒç”¨åˆ›å»ºæ–°çš„ user namespace å’Œ mount namespaceã€‚
3.  **IDæ˜ å°„ï¼š**  é…ç½® `/proc/self/setgroups`ï¼Œ`/proc/self/uid_map` å’Œ `/proc/self/gid_map`ï¼Œä»¥ä¾¿åœ¨ user namespace ä¸­è·å¾—æœ‰æ•ˆçš„ç”¨æˆ· ID å’Œç»„ IDã€‚
4.  **OverlayFSæŒ‚è½½ï¼š**  ä½¿ç”¨ `mount` ç³»ç»Ÿè°ƒç”¨æŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿï¼Œå°† lower, upper å’Œ work ç›®å½•å…³è”èµ·æ¥ã€‚
5.  **æ–‡ä»¶æ‹·è´ä¸ Capability è®¾ç½®ï¼š**  å°† exploit ç¨‹åºè‡ªèº«æ‹·è´åˆ° overlayfs çš„ merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½® `security.capability` å±æ€§ï¼Œèµ‹äºˆå…¶ CAP_SETUID å’Œ CAP_SETGID ç­‰æƒé™ã€‚
6.  **ææƒæ‰§è¡Œï¼š** æ‰§è¡Œä½äº upper ç›®å½•çš„ exploit ç¨‹åºçš„æ‹·è´ã€‚ç”±äºè¯¥æ–‡ä»¶å…·æœ‰ capabilitiesï¼Œå› æ­¤å¯ä»¥ä»¥ root æƒé™æ‰§è¡Œ shellã€‚

**é¡¹ç›®åœ°å€:** [Abdennour-py/CVE-2021-3493](https://github.com/Abdennour-py/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #2

**æ¥æº**: [CVE-2021-3493-Sornphut_OverlayFS---CVE-2021-3493.md](../2021/CVE-2021-3493-Sornphut_OverlayFS---CVE-2021-3493.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒæ¼æ´

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Ubuntu Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœ¬åœ°ç”¨æˆ·è·å¾— root æƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu kernels before 5.8.0-50.56, 5.4.0-72.80, 4.15.0-142.146, and 4.4.0-209.241

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦è¿è¡Œåœ¨å­˜åœ¨æ¼æ´çš„ Ubuntu å†…æ ¸ä¸Šï¼Œå¹¶ä¸”å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½ overlayfsã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

è¯¥æ¼æ´å­˜åœ¨äº Ubuntu Linux å†…æ ¸çš„ overlayfs å®ç°ä¸­ã€‚ç”±äº Ubuntu å¯¹ overlayfs æŒ‚è½½çš„ç‰¹å®šä¿®æ”¹ï¼Œå¯¼è‡´åœ¨ç”¨æˆ·å‘½åç©ºé—´å†…ï¼Œå¯¹åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­çš„æ–‡ä»¶ capabilities éªŒè¯ä¸å……åˆ†ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡ overlayfs æŒ‚è½½ç»•è¿‡ capabilities æ£€æŸ¥ï¼Œè®¾ç½®æ–‡ä»¶ capabilities æå‡æƒé™ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  åˆ›å»ºä¸€ä¸ªç›®å½•ç»“æ„ï¼ŒåŒ…æ‹¬ lower, upper, work å’Œ merge ç›®å½•ã€‚
2.  ä½¿ç”¨ `unshare` åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´å’ŒæŒ‚è½½å‘½åç©ºé—´ã€‚
3.  é…ç½® `/proc/self/setgroups`, `/proc/self/uid_map`, å’Œ `/proc/self/gid_map` ä»¥æ˜ å°„ç”¨æˆ· ID å’Œç»„ IDã€‚
4.  ä½¿ç”¨ `mount` å‘½ä»¤æŒ‚è½½ overlayfsï¼Œå°† lower, upper å’Œ work ç›®å½•ä¸ merge ç›®å½•å…³è”èµ·æ¥ã€‚
5.  åœ¨ upper ç›®å½•æˆ– merge ç›®å½•ä¸‹åˆ›å»ºæˆ–å¤åˆ¶ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ã€‚
6.  ä½¿ç”¨ `setxattr` è®¾ç½®å¯æ‰§è¡Œæ–‡ä»¶çš„ capabilitiesï¼Œèµ‹äºˆå…¶ root æƒé™ã€‚
7.  æ‰§è¡Œè¯¥æ–‡ä»¶ï¼Œå³å¯è·å¾— root æƒé™ã€‚

**æœ‰æ•ˆæ€§ï¼š**

æä¾›çš„ POC ä»£ç å°è¯•åˆ©ç”¨ CVE-2021-3493 æ¼æ´ã€‚è¯¥ä»£ç åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´å’ŒæŒ‚è½½å‘½åç©ºé—´ï¼Œå¹¶å°è¯•æŒ‚è½½ overlayfsã€‚ç„¶åï¼Œå®ƒåº”è¯¥è®¾ç½® `magic` äºŒè¿›åˆ¶æ–‡ä»¶çš„ capabilitiesï¼Œä»è€Œè·å¾— root æƒé™ã€‚æ ¹æ®æ¼æ´æè¿°ï¼Œè¯¥ POC åº”è¯¥èƒ½å¤Ÿæœ‰æ•ˆåˆ©ç”¨è¯¥æ¼æ´ã€‚

**æŠ•æ¯’é£é™©ï¼š**

æ£€æŸ¥æä¾›çš„ exploit.c æ–‡ä»¶ï¼Œæœªå‘ç°æ˜æ˜¾çš„æ¶æ„æˆ–éšè—ä»£ç ã€‚ä»£ç é€»è¾‘ä¸»è¦é›†ä¸­äºè®¾ç½® overlayfs æŒ‚è½½å’Œæ–‡ä»¶ capabilitiesã€‚ä½†æ˜¯ï¼Œéœ€è¦å§‹ç»ˆè°¨æ…å¯¹å¾…æ¥è‡ªä¸å—ä¿¡ä»»æ¥æºçš„ä»£ç ã€‚ä¸ºäº†ç¡®ä¿å®‰å…¨ï¼Œå»ºè®®åœ¨å—æ§ç¯å¢ƒä¸­ä»”ç»†å®¡æŸ¥å’Œæµ‹è¯•ä»£ç ã€‚


**é¡¹ç›®åœ°å€:** [Sornphut/OverlayFS---CVE-2021-3493](https://github.com/Sornphut/OverlayFS---CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #3

**æ¥æº**: [CVE-2021-3493-briskets_CVE-2021-3493.md](../2021/CVE-2021-3493-briskets_CVE-2021-3493.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å¯¼è‡´æ™®é€šç”¨æˆ·æƒé™æå‡è‡³rootæƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu kernel versions: < 5.8.0-50.56 (5.8 kernel), < 5.4.0-72.80 (5.4 kernel), < 4.15.0-142.146 (4.15 kernel), < 4.4.0-209.241 (4.4 kernel)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦åœ¨å­˜åœ¨æ¼æ´çš„Ubuntuå†…æ ¸ç‰ˆæœ¬ä¸Šï¼Œå¹¶ä¸”å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½overlayfs

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 5%

## è¯¦æƒ…

CVE-2021-3493 æ¼æ´æ˜¯ç”±äº Linux å†…æ ¸çš„ overlayfs å®ç°æ²¡æœ‰æ­£ç¡®éªŒè¯ç”¨æˆ·å‘½åç©ºé—´ä¸­åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸Šæ–‡ä»¶ capabilities çš„è®¾ç½®ã€‚ç”±äº Ubuntu å†…æ ¸ä¸­å­˜åœ¨å…è®¸éç‰¹æƒ overlay æŒ‚è½½çš„è¡¥ä¸ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´è·å¾—æå‡çš„æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  æ¼æ´åˆ©ç”¨ä»£ç é¦–å…ˆåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ (ovlcap/work, ovlcap/lower, ovlcap/upper, ovlcap/merge)ã€‚
2.  åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´å’ŒæŒ‚è½½å‘½åç©ºé—´ã€‚
3.  åœ¨æ–°çš„ç”¨æˆ·å‘½åç©ºé—´ä¸­ï¼Œå°†å½“å‰ç”¨æˆ·çš„ UID å’Œ GID æ˜ å°„åˆ° root ç”¨æˆ·ã€‚
4.  ä½¿ç”¨ overlayfs å°† lowerdir (ovlcap/lower), upperdir (ovlcap/upper) å’Œ workdir (ovlcap/work) æŒ‚è½½åˆ° mergedir (ovlcap/merge)ã€‚
5.  å¤åˆ¶è‡ªèº« (exploit ç¨‹åº) åˆ° mergedir/magicï¼Œå¹¶è®¾ç½® security.capability æ‰©å±•å±æ€§ä¸º all+epï¼Œèµ‹äºˆè¯¥æ–‡ä»¶ capabilitiesã€‚
6.  æ‰§è¡Œ mergedir/magicï¼Œç”±äº capabilities çš„è®¾ç½®ï¼Œè¯¥ç¨‹åºä¼šä»¥ root æƒé™æ‰§è¡Œã€‚
7.  æœ€åï¼Œæ‰§è¡Œ upperdir/magicï¼Œå¯åŠ¨ä¸€ä¸ª root shellã€‚

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„POCä»£ç æ˜¯æœ‰æ•ˆçš„ï¼Œèƒ½å¤Ÿåˆ©ç”¨ CVE-2021-3493 æ¼æ´åœ¨å—å½±å“çš„ Ubuntu ç³»ç»Ÿä¸Šå®ç°æœ¬åœ°ææƒã€‚

**æŠ•æ¯’é£é™©ï¼š**
è¯¥POCä»£ç çš„ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´è¿›è¡Œææƒï¼Œä½†ä»ç„¶å­˜åœ¨æ½œåœ¨çš„æŠ•æ¯’é£é™©ã€‚æ¯”å¦‚ä½œè€…å¯èƒ½åœ¨ç¼–è¯‘å’Œè¿è¡Œå‰æ·»åŠ ä¸€äº›æ¶æ„ä»£ç ï¼Œä¾‹å¦‚ï¼š

1.  **åé—¨æ¤å…¥ï¼š** åœ¨ææƒæˆåŠŸåï¼Œæ¤å…¥ä¸€ä¸ªåé—¨ç¨‹åºï¼Œå…è®¸æ”»å‡»è€…è¿œç¨‹è®¿é—®ç³»ç»Ÿã€‚
2.  **æ•°æ®çªƒå–ï¼š** åœ¨ææƒè¿‡ç¨‹ä¸­ï¼Œçªƒå–ç”¨æˆ·çš„æ•æ„Ÿæ•°æ®ã€‚
3.  **ç ´åç³»ç»Ÿï¼š** åœ¨ææƒå¤±è´¥æˆ–è€…æˆåŠŸåï¼Œç ´åç³»ç»Ÿæ–‡ä»¶æˆ–è€…é…ç½®ã€‚

è€ƒè™‘åˆ°ä»£ç ç›¸å¯¹ç®€çŸ­ä¸”åŠŸèƒ½æ˜ç¡®ï¼Œè¯„ä¼°æŠ•æ¯’é£é™©ä¸º5%ã€‚ç”¨æˆ·éœ€è¦ä»”ç»†å®¡æŸ¥ä»£ç ï¼Œå¹¶åœ¨å®‰å…¨çš„ç¯å¢ƒä¸­è¿›è¡Œæµ‹è¯•ã€‚

**é¡¹ç›®åœ°å€:** [briskets/CVE-2021-3493](https://github.com/briskets/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #4

**æ¥æº**: [CVE-2021-3493-cyberx-1_OverlayFS-CVE-2021-3493.md](../2021/CVE-2021-3493-cyberx-1_OverlayFS-CVE-2021-3493.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯ä»æ™®é€šç”¨æˆ·ææƒè‡³root

**å½±å“ç‰ˆæœ¬:** Ubuntu kernels: 5.8.0-50.56 (5.8 kernel), 5.4.0-72.80 (5.4 kernel), 4.15.0-142.146 (4.15 kernel), 4.4.0-209.241 (4.4 kernel)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦è¿è¡Œåœ¨å­˜åœ¨æ¼æ´çš„Ubuntuå†…æ ¸ç‰ˆæœ¬ä¸Šï¼Œå¯ç”¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å’Œå…è®¸éç‰¹æƒ overlay mountsã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2021-3493æ˜¯Ubuntuå†…æ ¸OverlayFSå®ç°ä¸­çš„ä¸€ä¸ªæƒé™æå‡æ¼æ´ã€‚ç”±äºoverlayfsåœ¨ç”¨æˆ·å‘½åç©ºé—´ä¸­æ²¡æœ‰æ­£ç¡®éªŒè¯åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­æ–‡ä»¶åŠŸèƒ½è®¾ç½®ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å’ŒUbuntuå†…æ ¸ä¸­çš„éç‰¹æƒoverlayæŒ‚è½½è¡¥ä¸ï¼Œè·å–æå‡çš„æƒé™ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** åœ¨å­˜åœ¨æ¼æ´çš„Ubuntuå†…æ ¸ä¸Šï¼Œç¡®ä¿å¯ç”¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´ã€‚æ¼æ´åº“ä¿¡æ¯æåˆ°ç¦ç”¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å¯ä»¥ä½œä¸ºç¼“è§£æªæ–½ï¼Œæ‰€ä»¥è¦ç¡®ä¿å¯ç”¨ã€‚
2.  **åˆ›å»ºOverlayFSç»“æ„ï¼š** PoCä»£ç é¦–å…ˆåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼ˆlower, upper, work, mergeï¼‰ç”¨äº overlayfs æ–‡ä»¶ç³»ç»Ÿã€‚
3.  **åˆ›å»ºç”¨æˆ·å‘½åç©ºé—´ï¼š** ä½¿ç”¨`unshare`ç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´ã€‚è¿™å…è®¸åœ¨æ–°çš„å‘½åç©ºé—´ä¸­æ‹¥æœ‰ä¸åŒçš„ç”¨æˆ·IDå’Œç»„IDæ˜ å°„ã€‚
4.  **è®¾ç½®UID/GIDæ˜ å°„ï¼š** å°†å½“å‰ç”¨æˆ·çš„UIDå’ŒGIDæ˜ å°„åˆ°æ–°å‘½åç©ºé—´ä¸­çš„rootç”¨æˆ· (UID 0 å’Œ GID 0)ã€‚
5.  **æŒ‚è½½OverlayFSï¼š** ä½¿ç”¨`mount`ç³»ç»Ÿè°ƒç”¨å°† overlayfs æ–‡ä»¶ç³»ç»ŸæŒ‚è½½åˆ° merge ç›®å½•ã€‚æŒ‡å®š lowerdir, upperdir å’Œ workdirã€‚
6.  **å¤åˆ¶è‡ªèº«å¹¶è®¾ç½®Capabilitiesï¼š** å°†è‡ªèº«å¯æ‰§è¡Œæ–‡ä»¶å¤åˆ¶åˆ° overlayfs çš„ merge ç›®å½•ï¼Œç„¶åä½¿ç”¨`setxattr`è®¾ç½®`security.capability`æ‰©å±•å±æ€§ï¼Œèµ‹äºˆè¯¥æ–‡ä»¶ root æƒé™ã€‚
7.  **æ‰§è¡Œææƒåçš„ç¨‹åºï¼š** é€šè¿‡æ‰§è¡Œ upper ç›®å½•ä¸‹çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆä¹‹å‰å¤åˆ¶å¹¶è®¾ç½®äº† capabilities çš„æ–‡ä»¶ï¼‰æ¥è·å– root æƒé™ã€‚è¿™ä¸ªç¨‹åºä¼šæ£€æŸ¥æ˜¯å¦æœ‰"shell"å‚æ•°ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™ä¼šé‡æ–°æ‰§è¡Œè‡ªèº«ï¼Œä½†è¿™æ¬¡ä¼šå¸¦æœ‰`shell`å‚æ•°ï¼Œä»è€Œè§¦å‘`setuid(0)`å’Œ`setgid(0)`ï¼Œæœ€ç»ˆæ‰§è¡Œ`/bin/bash`ï¼Œè·å¾— root shellã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

ä»£ç ä¸­å­˜åœ¨ä¸€å®šçš„æŠ•æ¯’é£é™©ï¼Œè™½ç„¶ä¸»è¦é€»è¾‘æ˜¯åˆ©ç”¨æ¼æ´è¿›è¡Œææƒï¼Œä½†å­˜åœ¨ä¿®æ”¹`/bin/bash`çš„å¯èƒ½æ€§ï¼Œä½†æ˜¯ç»è¿‡ä»£ç åˆ†æä»¥åŠæ¼æ´åŸç†ï¼Œåˆ¤æ–­æ¼æ´åˆ©ç”¨è¿‡ç¨‹ä¸­æ²¡æœ‰ä¿®æ”¹`/bin/bash`æ“ä½œ,ä»£ç ä¸­é£é™©ä¸»è¦å­˜åœ¨äºä»¥ä¸‹å‡ ç‚¹:

1.  **ä¾èµ–å¤–éƒ¨äºŒè¿›åˆ¶æ–‡ä»¶ï¼š** è¯¥æ¼æ´åˆ©ç”¨ä¾èµ–äºç³»ç»Ÿä¸Šçš„`/bin/bash`ã€‚å¦‚æœæ”»å‡»è€…æ›¿æ¢æˆ–ç¯¡æ”¹äº†ç›®æ ‡ç³»ç»Ÿä¸Šçš„`/bin/bash`ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ„å¤–çš„è¡Œä¸ºæˆ–å®‰å…¨é—®é¢˜ã€‚
2.  **æ¸…ç†æ“ä½œé£é™©ï¼š** ä»£ç å¼€å§‹æ—¶ä½¿ç”¨`system(buf)`æ‰§è¡Œ`rm -rf '%s/'`ï¼Œå¦‚æœ`DIR_BASE`è¢«æ¶æ„ä¿®æ”¹ï¼Œå¯èƒ½å¯¼è‡´æ„å¤–çš„æ–‡ä»¶åˆ é™¤ã€‚
3.  **ä¸å®Œå–„çš„é”™è¯¯å¤„ç†ï¼š** è™½ç„¶ PoC ä»£ç åŒ…å«äº†ä¸€äº›é”™è¯¯å¤„ç†ï¼Œä½†åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå¦‚æœé”™è¯¯å¤„ç†ä¸å½“ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ‹’ç»æœåŠ¡æˆ–æœªå®šä¹‰çš„è¡Œä¸ºã€‚

æ€»ä½“è€Œè¨€ï¼Œè¯¥ PoC ä»£ç çš„æŠ•æ¯’é£é™©è¾ƒä½ï¼Œä¸»è¦é£é™©åœ¨äºä¾èµ–å¤–éƒ¨äºŒè¿›åˆ¶æ–‡ä»¶å’Œæ½œåœ¨çš„æ¸…ç†æ“ä½œé£é™©ã€‚ä»£ç æœ¬èº«ä¸»è¦æ˜¯ä¸ºäº†æ¼”ç¤ºæ¼æ´åˆ©ç”¨ï¼Œå¹¶æœªå‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç ã€‚ è¯„ä¼°æŠ•æ¯’é£é™©ä¸º10%ã€‚


**é¡¹ç›®åœ°å€:** [cyberx-1/OverlayFS-CVE-2021-3493](https://github.com/cyberx-1/OverlayFS-CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #5

**æ¥æº**: [CVE-2021-3493-derek-turing_CVE-2021-3493.md](../2021/CVE-2021-3493-derek-turing_CVE-2021-3493.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Ubuntu Linux Kernel

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœ¬åœ°ç”¨æˆ·å¯æå‡è‡³ root æƒé™

**å½±å“ç‰ˆæœ¬:** 4.4 <= kernel < 4.4.0-209.241, 4.15 <= kernel < 4.15.0-142.146, 5.4 <= kernel < 5.4.0-72.80, 5.8 <= kernel < 5.8.0-50.56

**åˆ©ç”¨æ¡ä»¶:** Ubuntu å†…æ ¸å¼€å¯äº† unprivileged user namespaces å’Œ unprivileged overlay mounts

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

è¯¥æ¼æ´å­˜åœ¨äº Ubuntu Linux å†…æ ¸çš„ OverlayFS å®ç°ä¸­ï¼Œç”±äº overlayfs å¯¹åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­æ–‡ä»¶ capabilities çš„è®¾ç½®éªŒè¯ä¸å½“ï¼Œç»“åˆæœªæˆæƒç”¨æˆ·å‘½åç©ºé—´å’Œ Ubuntu å†…æ ¸ä¸­å…è®¸æœªæˆæƒ overlay æŒ‚è½½çš„è¡¥ä¸ï¼Œæ”»å‡»è€…å¯åˆ©ç”¨æ­¤æ¼æ´æå‡æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** é¦–å…ˆï¼Œç¡®ä¿ç›®æ ‡ç³»ç»Ÿæ»¡è¶³æ¼æ´åˆ©ç”¨çš„æ¡ä»¶ï¼Œå³ Ubuntu å†…æ ¸ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…ï¼Œå¹¶ä¸”å¯ç”¨äº† unprivileged user namespaces å’Œ unprivileged overlay mountsã€‚æ¼æ´åº“ä¿¡æ¯ä¸­ç»™å‡ºäº†å—å½±å“çš„ç‰ˆæœ¬èŒƒå›´ã€‚
2.  **åˆ›å»ºç›®å½•ç»“æ„ï¼š** åˆ›å»º overlayfs æ‰€éœ€çš„ç›®å½•ç»“æ„ï¼ŒåŒ…æ‹¬ lowerdirï¼ˆåº•å±‚ç›®å½•ï¼‰ã€upperdirï¼ˆä¸Šå±‚ç›®å½•ï¼‰ã€workdirï¼ˆå·¥ä½œç›®å½•ï¼‰å’Œ mergedirï¼ˆåˆå¹¶ç›®å½•ï¼‰ã€‚
3.  **åˆ›å»ºç”¨æˆ·å‘½åç©ºé—´ï¼š** ä½¿ç”¨ `unshare` å‘½ä»¤åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´ï¼Œè¿™å…è®¸åœ¨éç‰¹æƒç”¨æˆ·ä¸‹æ‰§è¡Œä¸€äº›ç‰¹æƒæ“ä½œã€‚
4.  **è®¾ç½® UID/GID æ˜ å°„ï¼š** åœ¨ç”¨æˆ·å‘½åç©ºé—´ä¸­ï¼Œå°†å½“å‰ç”¨æˆ·çš„ UID å’Œ GID æ˜ å°„åˆ° root ç”¨æˆ· (UID 0) å’Œ root ç»„ (GID 0)ï¼Œè¿™æ ·åœ¨ overlayfs ä¸­åˆ›å»ºçš„æ–‡ä»¶å°†å±äº root ç”¨æˆ·ã€‚
5.  **æŒ‚è½½ OverlayFSï¼š** ä½¿ç”¨ `mount` å‘½ä»¤å°† overlayfs æŒ‚è½½åˆ° mergedirï¼ŒæŒ‡å®š lowerdirã€upperdir å’Œ workdirã€‚
6.  **å¤åˆ¶å¹¶è®¾ç½® Capabilitiesï¼š** å°† exploit ç¨‹åºè‡ªèº«å¤åˆ¶åˆ° mergedir ä¸­ï¼Œå¹¶ä½¿ç”¨ `setxattr` å‘½ä»¤è®¾ç½®å…¶ security.capability æ‰©å±•å±æ€§ï¼Œèµ‹äºˆå…¶ CAP_SETUID å’Œ CAP_SETGID capabilitiesã€‚è¿™ä¸ªcapabilitieså…è®¸ç¨‹åºåœ¨æ²¡æœ‰rootæƒé™çš„æƒ…å†µä¸‹è®¾ç½®uidå’Œgidã€‚
7.  **è§¦å‘ææƒï¼š** è¿è¡Œ mergedir ä¸­çš„ exploit ç¨‹åºï¼Œç”±äºå·²è®¾ç½® capabilitiesï¼Œç¨‹åºå°†ä»¥ root æƒé™è¿è¡Œï¼Œä»è€Œæ‰§è¡Œç‰¹æƒæ“ä½œã€‚

**ä»£ç åˆ†æï¼š**

*   `exploit.c` æ˜¯åˆ©ç”¨ä»£ç ï¼Œå®ƒåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼Œå»ºç«‹ç”¨æˆ·å‘½åç©ºé—´ï¼ŒæŒ‚è½½ overlayfsï¼Œç„¶åå°†è‡ªèº«å¤åˆ¶åˆ° overlayfs ä¸­ï¼Œå¹¶è®¾ç½® capabilitiesã€‚æœ€åï¼Œæ‰§è¡Œå¤åˆ¶åˆ° upperdir ä¸­çš„ç¨‹åºï¼Œè¯¥ç¨‹åºä¼šå°†å½“å‰è¿›ç¨‹ææƒä¸º rootã€‚
*   ä»£ç ä¸­ä½¿ç”¨äº† `setxattr` å‡½æ•°æ¥è®¾ç½®æ–‡ä»¶ capabilitiesï¼Œè¿™æ˜¯åˆ©ç”¨æ¼æ´çš„å…³é”®æ­¥éª¤ã€‚
*   mainå‡½æ•°é¦–å…ˆforkä¸€ä¸ªå­è¿›ç¨‹æ‰§è¡Œexploitå‡½æ•°ï¼Œåœ¨exploitå‡½æ•°æ‰§è¡Œå®Œæ¯•åï¼Œçˆ¶è¿›ç¨‹æ‰§è¡ŒBIN_UPPERä¸­çš„magicç¨‹åºï¼Œå¦‚æœå¸¦æœ‰shellå‚æ•°ï¼Œmagicç¨‹åºä¼šè®¾ç½®uidå’Œgidä¸º0ï¼Œå¹¶ä¸”è¿è¡Œä¸€ä¸ªbash shellã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

ä»”ç»†æ£€æŸ¥äº† POC ä»£ç ï¼Œæ²¡æœ‰å‘ç°æ˜æ˜¾çš„æŠ•æ¯’ä»£ç ã€‚ä»£ç é€»è¾‘æ¸…æ™°ï¼Œä¸»è¦ç”¨äºåˆ›å»º overlayfs ç¯å¢ƒå¹¶è®¾ç½®æ–‡ä»¶ capabilities ä»¥è¿›è¡Œææƒã€‚ä½œè€…å¹¶æ²¡æœ‰å°è¯•åœ¨ä»£ç ä¸­éšè—æ¶æ„è¡Œä¸ºï¼Œä¾‹å¦‚ï¼š

*   è¿æ¥å¤–éƒ¨æœåŠ¡å™¨
*   ä¿®æ”¹ç³»ç»Ÿæ–‡ä»¶
*   å®‰è£…åé—¨
*   æ”¶é›†ç”¨æˆ·ä¿¡æ¯

å› æ­¤ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ (0%)ã€‚

**é¡¹ç›®åœ°å€:** [derek-turing/CVE-2021-3493](https://github.com/derek-turing/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #6

**æ¥æº**: [CVE-2021-3493-fathallah17_OverlayFS-CVE-2021-3493.md](../2021/CVE-2021-3493-fathallah17_OverlayFS-CVE-2021-3493.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°æƒé™æå‡

**å½±å“åº”ç”¨:** Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å¯¼è‡´æœ¬åœ°æƒé™æå‡è‡³root

**å½±å“ç‰ˆæœ¬:** 4.4 <= Linux Kernel < 5.8.0-50.56 (Ubuntu ç‰¹å®šç‰ˆæœ¬)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦å­˜åœ¨Ubuntuå†…æ ¸ä¸­å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½OverlayFSçš„è¡¥ä¸ï¼Œä¸”ç”¨æˆ·å‘½åç©ºé—´æœªè¢«ç¦ç”¨ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 1%

## è¯¦æƒ…

CVE-2021-3493 æ˜¯ä¸€ä¸ªå­˜åœ¨äº Linux å†…æ ¸ OverlayFS å®ç°ä¸­çš„æƒé™æå‡æ¼æ´ã€‚æ¼æ´çš„æ ¹æœ¬åŸå› æ˜¯ OverlayFS åœ¨è®¾ç½®åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­æ–‡ä»¶çš„ capabilities æ—¶ï¼Œæ²¡æœ‰æ­£ç¡®åœ°éªŒè¯ç”¨æˆ·å‘½åç©ºé—´ã€‚åœ¨å­˜åœ¨å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½ OverlayFS çš„ Ubuntu å†…æ ¸è¡¥ä¸çš„ç¯å¢ƒä¸­ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´è·å¾—æå‡çš„æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š**  ç›®æ ‡ç³»ç»Ÿéœ€è¦æ˜¯å—å½±å“çš„ Ubuntu ç‰ˆæœ¬ï¼Œå¹¶ä¸”å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½ OverlayFSï¼ŒåŒæ—¶ç”¨æˆ·å‘½åç©ºé—´æ²¡æœ‰è¢«ç¦ç”¨ã€‚
2.  **è·å–æ¼æ´åˆ©ç”¨ä»£ç ï¼š**  ä»å¯ä¿¡æ¥æºè·å–æ¼æ´åˆ©ç”¨ä»£ç  (ä¾‹å¦‚ SSD-Disclosure æä¾›çš„ exploit.c)ã€‚
3.  **ç¼–è¯‘æ¼æ´åˆ©ç”¨ä»£ç ï¼š**  ä½¿ç”¨ gcc ç­‰ç¼–è¯‘å™¨å°† exploit.c ç¼–è¯‘ä¸ºå¯æ‰§è¡Œæ–‡ä»¶ã€‚
4.  **æ‰§è¡Œæ¼æ´åˆ©ç”¨ä»£ç ï¼š**  è¿è¡Œç¼–è¯‘åçš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚æ¼æ´åˆ©ç”¨ä»£ç ä¼šåˆ©ç”¨ OverlayFS çš„æ¼æ´ï¼Œé€šè¿‡è®¾ç½®æ–‡ä»¶ capabilities æ¥æå‡å½“å‰ç”¨æˆ·çš„æƒé™è‡³ rootã€‚
5.  **è·å– root æƒé™ï¼š**  æˆåŠŸæ‰§è¡Œæ¼æ´åˆ©ç”¨ä»£ç åï¼Œç”¨æˆ·å°†è·å¾— root æƒé™ã€‚

**å…³äºæŠ•æ¯’é£é™©ï¼š**

æä¾›çš„POCä»£ç åªæ˜¯ä¸€ä¸ªç®€å•çš„åˆ©ç”¨æ–¹å¼,ä¸å¤ªå¯èƒ½åŒ…å«æ¶æ„ä»£ç ã€‚ä½†å§‹ç»ˆéœ€è¦å¯¹ä»»ä½•æ¥æºçš„æ¼æ´åˆ©ç”¨ä»£ç è¿›è¡Œå®¡æŸ¥ï¼Œä»¥é™ä½é£é™©ã€‚
å¯¹ä¸‹è½½çš„æ–‡ä»¶è¿›è¡Œæ£€æŸ¥ï¼Œå¦‚å“ˆå¸Œæ ¡éªŒï¼Œå¯ä»¥æœ€å¤§ç¨‹åº¦çš„é¿å…å¼•å…¥æ¶æ„ä»£ç ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**

æ ¹æ®æ¼æ´æè¿°å’Œåˆ©ç”¨ä»£ç ï¼Œè¯¥æ¼æ´åˆ©ç”¨æ˜¯æœ‰æ•ˆçš„ã€‚åˆ©ç”¨ä»£ç é€šè¿‡OverlayFSçš„æ¼æ´ï¼Œå…è®¸ä½æƒé™ç”¨æˆ·è·å¾—rootæƒé™ã€‚

**å…¶ä»–ä¿¡æ¯:**
CISA å·²å°†æ­¤æ¼æ´æ·»åŠ åˆ°å·²çŸ¥è¢«åˆ©ç”¨çš„æ¼æ´ç›®å½• (KEV) ä¸­ï¼Œè¡¨æ˜è¯¥æ¼æ´å·²è¢«å¹¿æ³›åˆ©ç”¨ã€‚

**é¡¹ç›®åœ°å€:** [fathallah17/OverlayFS-CVE-2021-3493](https://github.com/fathallah17/OverlayFS-CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #7

**æ¥æº**: [CVE-2021-3493-fei9747_CVE-2021-3493.md](../2021/CVE-2021-3493-fei9747_CVE-2021-3493.md)

## CVE-2021-3493 Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ”»å‡»è€…å¯åˆ©ç”¨æ­¤æ¼æ´è·å– root æƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu kernel versions: < 5.8.0-50.56, < 5.4.0-72.80, < 4.15.0-142.146, < 4.4.0-209.241

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦åœ¨å­˜åœ¨æ¼æ´çš„ Ubuntu ç³»ç»Ÿä¸Šæœ¬åœ°æ‰§è¡Œ

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 5%

## è¯¦æƒ…

CVE-2021-3493 æ˜¯ä¸€ä¸ªå­˜åœ¨äº Ubuntu Linux å†…æ ¸ overlayfs å®ç°ä¸­çš„æœ¬åœ°ææƒæ¼æ´ã€‚è¯¥æ¼æ´æºäº overlayfs æœªèƒ½æ­£ç¡®éªŒè¯ç”¨æˆ·å‘½åç©ºé—´ä¸­åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸Šæ–‡ä»¶ capabilities çš„è®¾ç½®ã€‚ç»“åˆæœªæˆæƒç”¨æˆ·å‘½åç©ºé—´ä»¥åŠ Ubuntu å†…æ ¸ä¸­å…è®¸æœªæˆæƒ overlay mount çš„è¡¥ä¸ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´æå‡æƒé™ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼ŒåŒ…æ‹¬lowerdirï¼Œupperdirï¼Œworkdirå’Œmergedirã€‚
2.  **åˆ›å»ºå‘½åç©ºé—´ï¼š** ä½¿ç”¨ `unshare` ç³»ç»Ÿè°ƒç”¨åˆ›å»ºæ–°çš„ç”¨æˆ·å‘½åç©ºé—´å’ŒæŒ‚è½½å‘½åç©ºé—´ã€‚
3.  **è®¾ç½®ç”¨æˆ·å’Œç»„IDæ˜ å°„ï¼š** å°†å½“å‰ç”¨æˆ·çš„ UID å’Œ GID æ˜ å°„åˆ°æ–°çš„ç”¨æˆ·å‘½åç©ºé—´ä¸­ï¼Œä»¥ä¾¿åœ¨æ–°çš„å‘½åç©ºé—´ä¸­æ‹¥æœ‰æƒé™ã€‚
4.  **æŒ‚è½½ OverlayFSï¼š** ä½¿ç”¨ `mount` ç³»ç»Ÿè°ƒç”¨ï¼Œå°† overlayfs æŒ‚è½½åˆ° mergedirï¼Œå¹¶å°† lowerdirï¼Œupperdir å’Œ workdir æŒ‡å®šä¸ºç›¸åº”çš„ç›®å½•ã€‚
5.  **è®¾ç½® Capabilitiesï¼š** å¤åˆ¶å½“å‰æ‰§è¡Œçš„ç¨‹åºåˆ° mergedirï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½®è¯¥æ–‡ä»¶çš„ capabilitiesï¼Œä½¿å…¶å…·æœ‰ root æƒé™ã€‚ è¿™æ­¥æ˜¯æ¼æ´åˆ©ç”¨çš„å…³é”®ã€‚
6.  **æ‰§è¡ŒPayloadï¼š** æ‰§è¡Œupperç›®å½•ä¸­çš„æ–‡ä»¶ï¼Œå› ä¸ºè®¾ç½®äº†Capabilitiesï¼Œå¯ä»¥è·å¾—rootæƒé™ã€‚

**æœ‰æ•ˆæ€§ï¼š**

æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’ŒPOCä»£ç æè¿°ï¼Œè¯¥æ¼æ´åœ¨ç‰¹å®šç‰ˆæœ¬çš„ Ubuntu å†…æ ¸ä¸Šæ˜¯å¯åˆ©ç”¨çš„ã€‚æä¾›çš„POCä»£ç å±•ç¤ºäº†åˆ©ç”¨è¯¥æ¼æ´æå‡æƒé™çš„å®Œæ•´è¿‡ç¨‹ã€‚

**æŠ•æ¯’é£é™©ï¼š**

ä»£ç ä¸­å­˜åœ¨æ½œåœ¨çš„æŠ•æ¯’é£é™©ï¼Œä½†æ˜¯é£é™©è¾ƒä½ã€‚ä¸»è¦é›†ä¸­åœ¨ç¼–è¯‘å’Œè¿è¡Œexploitæ—¶ã€‚æ”»å‡»è€…å¯èƒ½é€šè¿‡ä¿®æ”¹ exploit.c æ–‡ä»¶ï¼Œä¾‹å¦‚æ·»åŠ æ¶æ„ä»£ç æˆ–åé—¨ï¼Œä»è€Œåœ¨ç›®æ ‡ç³»ç»Ÿä¸Šæ‰§è¡Œæ¶æ„æ“ä½œã€‚ä½†æ˜¯æ ¹æ®æä¾›çš„POCä»£ç æ¥çœ‹, é£é™©ç³»æ•°è¾ƒä½.

**é£é™©è¯„ä¼°ï¼š**

è¯¥æ¼æ´åˆ©ç”¨çš„æˆåŠŸå–å†³äºç›®æ ‡ç³»ç»Ÿæ˜¯å¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š

*   è¿è¡Œå—å½±å“çš„ Ubuntu å†…æ ¸ç‰ˆæœ¬ã€‚
*   å¯ç”¨äº†æœªæˆæƒç”¨æˆ·å‘½åç©ºé—´å’Œ overlayfs mountã€‚
*   ç›®æ ‡ç³»ç»Ÿä¸Šå­˜åœ¨ `gcc` ç¼–è¯‘å™¨, èƒ½å¤Ÿç¼–è¯‘exploitã€‚

å¦‚æœç›®æ ‡ç³»ç»Ÿæ»¡è¶³è¿™äº›æ¡ä»¶ï¼Œæ”»å‡»è€…å¯ä»¥ä½¿ç”¨æä¾›çš„ POC ä»£ç æˆåŠŸåˆ©ç”¨è¯¥æ¼æ´ï¼Œä»è€Œè·å¾— root æƒé™ã€‚


**é¡¹ç›®åœ°å€:** [fei9747/CVE-2021-3493](https://github.com/fei9747/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #8

**æ¥æº**: [CVE-2021-3493-iamz24_CVE-2021-3493_CVE-2022-3357.md](../2021/CVE-2021-3493-iamz24_CVE-2021-3493_CVE-2022-3357.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒæ¼æ´

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å¯¼è‡´æœ¬åœ°æƒé™æå‡è‡³ root

**å½±å“ç‰ˆæœ¬:** Ubuntu kernels < 5.8.0-50.56, < 5.4.0-72.80, < 4.15.0-142.146, < 4.4.0-209.241

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç›®æ ‡ç³»ç»Ÿå¼€å¯ unprivileged user namespaces å’Œå­˜åœ¨ OverlayFS æœåŠ¡ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2021-3493 æ¼æ´æ˜¯ Linux å†…æ ¸ overlayfs å®ç°ä¸­ï¼Œåœ¨ç”¨æˆ·å‘½åç©ºé—´ä¸­å¯¹åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­çš„æ–‡ä»¶ capabilities éªŒè¯ä¸å½“å¯¼è‡´çš„ã€‚ç”±äº Ubuntu å†…æ ¸ä¸­å­˜åœ¨å…è®¸éç‰¹æƒ overlay æŒ‚è½½çš„è¡¥ä¸ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¯¥æ¼æ´æå‡æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** æ£€æŸ¥ç›®æ ‡ç³»ç»Ÿæ˜¯å¦å­˜åœ¨ overlayfs æœåŠ¡ï¼Œå¦‚æœæ²¡æœ‰åˆ™åŠ è½½ overlay æ¨¡å—ã€‚åŒæ—¶ï¼Œç¡®ä¿å¼€å¯äº† unprivileged user namespacesã€‚
2.  **ç¼–è¯‘ Payloadï¼š** ä½¿ç”¨ GCC ç¼–è¯‘æä¾›çš„ `payload.c` æ–‡ä»¶ã€‚
3.  **è¿è¡Œ Payloadï¼š** è¿è¡Œç¼–è¯‘åçš„å¯æ‰§è¡Œæ–‡ä»¶ `a.out`ã€‚
4.  **è·å– Root Shellï¼š** Payload ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å‘½åç©ºé—´ï¼ŒæŒ‚è½½ overlayfsï¼Œè®¾ç½® capabilityï¼Œæœ€ç»ˆæ‰§è¡Œä¸€ä¸ªå…·æœ‰ root æƒé™çš„ shellã€‚

**æœ‰æ•ˆæ€§ï¼š**

æä¾›çš„ POC ä»£ç åŸºæœ¬æœ‰æ•ˆï¼Œèƒ½å¤Ÿåˆ©ç”¨è¯¥æ¼æ´åœ¨ç¬¦åˆæ¡ä»¶çš„ Ubuntu ç³»ç»Ÿä¸Šå®ç°æœ¬åœ°ææƒã€‚

**æŠ•æ¯’é£é™©ï¼š**

å­˜åœ¨è¾ƒä½çš„æŠ•æ¯’é£é™©ï¼ˆ10%ï¼‰ã€‚è™½ç„¶ä»£ç çš„ä¸»è¦åŠŸèƒ½æ˜¯å®ç°ææƒï¼Œä½†ä»ç„¶éœ€è¦è°¨æ…å¯¹å¾…æ¥æºä¸æ˜çš„ä»£ç ï¼Œä½œè€…å¯èƒ½ä¼šåœ¨å…¶ä¸­éšè—ä¸€äº›æ¶æ„è¡Œä¸ºï¼Œæ¯”å¦‚ä¸Šä¼ æ•æ„Ÿä¿¡æ¯ç­‰ã€‚ç‰¹åˆ«æ˜¯éœ€è¦æ£€æŸ¥ `exploit`å‡½æ•°ä¸­çš„ç›¸å…³æ–‡ä»¶æ“ä½œå’Œå‘½ä»¤æ‰§è¡Œæ˜¯å¦å­˜åœ¨æ¶æ„è¡Œä¸ºã€‚å°¤å…¶å…³æ³¨`system(buf);`æ˜¯å¦ä¼šæ‰§è¡Œæ¶æ„çš„æŒ‡ä»¤ã€‚

**æ€»ç»“ï¼š**

è¯¥æ¼æ´åˆ©ç”¨è¾ƒä¸ºç›´æ¥ï¼Œåˆ©ç”¨æ¡ä»¶ç›¸å¯¹æ˜ç¡®ï¼Œä½†éœ€è¦æ³¨æ„æ½œåœ¨çš„æŠ•æ¯’é£é™©ã€‚åœ¨å®é™…ä½¿ç”¨æ—¶ï¼Œåº”è¯¥ä»”ç»†å®¡æŸ¥ä»£ç ï¼Œç¡®ä¿æ²¡æœ‰æ¶æ„è¡Œä¸ºã€‚

**é¡¹ç›®åœ°å€:** [iamz24/CVE-2021-3493_CVE-2022-3357](https://github.com/iamz24/CVE-2021-3493_CVE-2022-3357)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #9

**æ¥æº**: [CVE-2021-3493-inspiringz_CVE-2021-3493.md](../2021/CVE-2021-3493-inspiringz_CVE-2021-3493.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Ubuntu Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸ä½æƒé™ç”¨æˆ·æå‡åˆ°rootæƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu 4.4, 4.15, 5.4, 5.8 kernels (å—å½±å“ç‰ˆæœ¬è¯¦è§æ¼æ´åº“ä¿¡æ¯)

**åˆ©ç”¨æ¡ä»¶:** Ubuntuå†…æ ¸ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…ï¼Œå¯ç”¨æœªæˆæƒç”¨æˆ·å‘½åç©ºé—´ï¼Œå…è®¸æœªæˆæƒOverlayFSæŒ‚è½½ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 5%

## è¯¦æƒ…

CVE-2021-3493æ˜¯Ubuntuå†…æ ¸ä¸­OverlayFSå®ç°çš„ä¸€ä¸ªæ¼æ´ï¼Œå…è®¸ä½æƒé™ç”¨æˆ·é€šè¿‡åˆ©ç”¨user namespaceå’ŒOverlayFSæŒ‚è½½ç»•è¿‡æ–‡ä»¶ç³»ç»Ÿæƒé™æ£€æŸ¥æ¥æå‡æƒé™ã€‚ 

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡:** æ¼æ´åˆ©ç”¨éœ€è¦å­˜åœ¨Ubuntuç³»ç»Ÿï¼Œä¸”å†…æ ¸ç‰ˆæœ¬åœ¨æ¼æ´åº“ä¿¡æ¯ä¸­æè¿°çš„å—å½±å“èŒƒå›´å†…ï¼Œå¹¶ä¸”éœ€è¦å¯ç”¨æœªæˆæƒç”¨æˆ·å‘½åç©ºé—´(unprivileged user namespaces)ã€‚æ­¤å¤–ï¼Œä¸ºäº†åˆ©ç”¨OverlayFSï¼Œç³»ç»Ÿéœ€è¦é…ç½®å…è®¸æœªæˆæƒç”¨æˆ·è¿›è¡ŒOverlayFSæŒ‚è½½ã€‚
2.  **æ¼æ´åˆ©ç”¨:**  æ”»å‡»è€…é¦–å…ˆåˆ›å»ºä¸€ä¸ªåŒ…å«lower, upper, workç›®å½•çš„OverlayFSç»“æ„ã€‚
3.  **åˆ©ç”¨è¿‡ç¨‹:** åˆ©ç”¨`unshare`ç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€ä¸ªæ–°çš„user namespaceå’Œmount namespaceã€‚ åœ¨æ–°namespaceä¸­ï¼Œå°†è‡ªå·±çš„UIDå’ŒGIDæ˜ å°„åˆ°rootæƒé™ã€‚ ç„¶åï¼Œä½¿ç”¨æ„é€ çš„lowerdirã€upperdirå’ŒworkdiræŒ‚è½½OverlayFSæ–‡ä»¶ç³»ç»Ÿã€‚ æ”»å‡»è€…å°†ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶å¤åˆ¶åˆ°OverlayFSçš„mergeç›®å½•ä¸­ã€‚å…³é”®çš„ä¸€æ­¥æ˜¯ï¼Œæ”»å‡»è€…ä½¿ç”¨`setxattr`ç³»ç»Ÿè°ƒç”¨ï¼Œè®¾ç½®è¯¥å¯æ‰§è¡Œæ–‡ä»¶çš„`security.capability`æ‰©å±•å±æ€§ï¼Œèµ‹äºˆå®ƒ`CAP_SETUID`å’Œ`CAP_SETGID`èƒ½åŠ›ã€‚ ç”±äºOverlayFSçš„æƒé™éªŒè¯ä¸å®Œå–„ï¼Œè¿™ä¸ªæ“ä½œå³ä½¿åœ¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´ä¸­ä¹Ÿèƒ½æˆåŠŸã€‚å½“æ‰§è¡Œè¯¥æ–‡ä»¶æ—¶ï¼Œå®ƒå°†è·å¾—rootæƒé™ï¼Œå¹¶å¯ä»¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚
4.  **POCä»£ç åˆ†æ:** `exploit.c` ä»£ç é¦–å…ˆåˆ›å»ºä¸€ä¸ªoverlayfsç›®å½•ç»“æ„ã€‚ç„¶åï¼Œä½¿ç”¨ `unshare` ç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€ä¸ªæ–°çš„ user namespace å’Œ mount namespaceï¼Œå¹¶å°†å½“å‰ç”¨æˆ·çš„ uid å’Œ gid æ˜ å°„åˆ° root ç”¨æˆ·ã€‚ ä¹‹åï¼Œå®ƒæŒ‚è½½ overlayfsï¼Œå¤åˆ¶å½“å‰æ‰§è¡Œçš„ç¨‹åºåˆ° overlayfs çš„ merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½® capabilityã€‚æœ€åï¼Œæ‰§è¡Œå¤åˆ¶åˆ° overlayfs çš„ç¨‹åºã€‚
5. **æŠ•æ¯’é£é™©åˆ†æ:** ä»£ç æœ¬èº«å®ç°äº†æ¼æ´åˆ©ç”¨çš„åŠŸèƒ½ã€‚ æ½œåœ¨çš„æŠ•æ¯’é£é™©å¯èƒ½å­˜åœ¨äºä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š
    *   **ä¾èµ–é¡¹:**  ä»£ç ä¾èµ–äºæ ‡å‡†çš„Cåº“ï¼Œæœ¬èº«ä¸å­˜åœ¨æ¶æ„ä¾èµ–ã€‚ä½†ç”¨æˆ·åœ¨ç¼–è¯‘æ—¶éœ€è¦æ³¨æ„ç¼–è¯‘å™¨ç¯å¢ƒçš„å®‰å…¨æ€§ã€‚
    *   **ä»£ç é€»è¾‘:**  ä»£ç é€»è¾‘ç›¸å¯¹ç®€å•ï¼Œä¸»è¦é›†ä¸­åœ¨namespaceåˆ›å»ºã€æŒ‚è½½å’Œcapabilityè®¾ç½®ã€‚ ä»”ç»†å®¡æŸ¥ä»£ç ï¼Œæœªå‘ç°æ˜æ˜¾çš„æ¶æ„é€»è¾‘ã€‚
    *   **æ‰§è¡Œå‘½ä»¤:**  ä»£ç ä¸­ä½¿ç”¨äº† `system` å‡½æ•°ï¼Œè¿™æ˜¯ä¸€ä¸ªæ½œåœ¨çš„é£é™©ç‚¹ï¼Œå¯ä»¥æ‰§è¡Œä»»æ„ç³»ç»Ÿå‘½ä»¤ã€‚ä½†æ˜¯ï¼Œè¿™é‡Œåªæ˜¯ç”¨æ¥åˆ é™¤ç›®å½•ï¼Œç›¸å¯¹å®‰å…¨ã€‚
       ç»¼ä¸Šæ‰€è¿°ï¼Œè¯¥POCä»£ç ä¸»è¦é£é™©åœ¨äºç¡®ä¿ç¼–è¯‘ç¯å¢ƒå®‰å…¨ä»¥åŠå¯¹ä¸ç†Ÿæ‚‰çš„å‘½ä»¤ä¿æŒè­¦æƒ•ã€‚æŠ•æ¯’é£é™©è¾ƒä½ï¼Œé¢„ä¼°ä¸º5%ã€‚

**æ€»ç»“ï¼š**

è¯¥æ¼æ´åˆ©ç”¨çš„æ ¸å¿ƒåœ¨äºç»“åˆäº†æœªæˆæƒç”¨æˆ·å‘½åç©ºé—´å’ŒOverlayFSï¼Œåˆ©ç”¨OverlayFSå¯¹capabilitiesè®¾ç½®éªŒè¯çš„ç¼ºé™·ï¼Œå®ç°äº†æœ¬åœ°ææƒã€‚ æ”»å‡»è€…é€šè¿‡åˆ›å»ºç‰¹æ®Šçš„OverlayFSç»“æ„å¹¶è®¾ç½®æ–‡ä»¶capabilitiesï¼Œæœ€ç»ˆè·å¾—rootæƒé™ã€‚

**é¡¹ç›®åœ°å€:** [inspiringz/CVE-2021-3493](https://github.com/inspiringz/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #10

**æ¥æº**: [CVE-2021-3493-oneoy_CVE-2021-3493.md](../2021/CVE-2021-3493-oneoy_CVE-2021-3493.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœ¬åœ°ç”¨æˆ·å¯æå‡è‡³ root æƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu 4.4, 4.15, 5.4, and 5.8 kernels (å…·ä½“ç‰ˆæœ¬å·è§æ¼æ´åº“ä¿¡æ¯)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç›®æ ‡ç³»ç»Ÿå­˜åœ¨æœªä¿®å¤çš„ Ubuntu kernelï¼Œä¸”å¯ç”¨ unprivileged user namespaces å’Œå…è®¸ unprivileged overlayfs mountsã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

è¯¥æ¼æ´å­˜åœ¨äº Ubuntu å†…æ ¸çš„ OverlayFS å®ç°ä¸­ï¼Œç”±äºæœªæ­£ç¡®éªŒè¯ç”¨æˆ·å‘½åç©ºé—´ä¸­åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸Šæ–‡ä»¶ capabilities çš„è®¾ç½®ï¼Œå¯¼è‡´æœ¬åœ°æ”»å‡»è€…å¯åˆ©ç”¨ unprivileged user namespaces å’Œ Ubuntu å†…æ ¸ä¸­å…è®¸ unprivileged overlayfs mounts çš„è¡¥ä¸æ¥æå‡æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ (lower, upper, work, merge)ã€‚
2.  **é…ç½® User Namespace:** åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´ã€‚
3.  **é…ç½® OverlayFS:** ä½¿ç”¨ lowerdir, upperdir, å’Œ workdir é€‰é¡¹æŒ‚è½½ overlay æ–‡ä»¶ç³»ç»Ÿã€‚
4.  **è®¾ç½® Capabilities:** å°†å¯æ‰§è¡Œæ–‡ä»¶å¤åˆ¶åˆ° merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½®å…¶ capabilities (å¦‚ CAP_SETUID, CAP_SETGID, CAP_CHOWN)ã€‚
5.  **è§¦å‘ææƒ:** æ‰§è¡Œ merge ç›®å½•ä¸­çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶å°†ä¼šä»¥ root æƒé™æ‰§è¡Œã€‚

**æŠ•æ¯’é£é™©è¯„ä¼°ï¼š**

æä¾›çš„ `exploit.c` ä»£ç ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨ OverlayFS çš„æ¼æ´è¿›è¡Œææƒã€‚ä»£ç åˆ›å»ºå¿…è¦çš„ç›®å½•ï¼Œé…ç½® user namespace å’Œ overlay æ–‡ä»¶ç³»ç»Ÿï¼Œå¹¶è®¾ç½®å¯æ‰§è¡Œæ–‡ä»¶çš„ capabilitiesã€‚ä»£ç é€»è¾‘æ¸…æ™°ï¼Œæ²¡æœ‰å‘ç°æ¶æ„ä»£ç æˆ–åé—¨ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**

æä¾›çš„ POC ä»£ç åŸºäºå…¬å¼€ä¿¡æ¯ï¼Œå¹¶é’ˆå¯¹ CVE-2021-3493 æ¼æ´è¿›è¡Œäº†åˆ©ç”¨ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯ã€æœç´¢å¼•æ“ç»“æœå’Œä»£ç åˆ†æï¼Œè¯¥ POC ä»£ç åœ¨æ»¡è¶³æ¼æ´åˆ©ç”¨æ¡ä»¶çš„æƒ…å†µä¸‹åº”è¯¥æ˜¯æœ‰æ•ˆçš„ã€‚

**é¡¹ç›®åœ°å€:** [oneoy/CVE-2021-3493](https://github.com/oneoy/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #11

**æ¥æº**: [CVE-2021-3493-pmihsan_OverlayFS-CVE-2021-3493.md](../2021/CVE-2021-3493-pmihsan_OverlayFS-CVE-2021-3493.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœ¬åœ°ç”¨æˆ·å¯æå‡è‡³ root æƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu kernel versions: < 5.8.0-50.56 (5.8 kernel), < 5.4.0-72.80 (5.4 kernel), < 4.15.0-142.146 (4.15 kernel), < 4.4.0-209.241 (4.4 kernel)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦åœ¨å­˜åœ¨æ¼æ´çš„ Ubuntu ç³»ç»Ÿä¸Šæ‰§è¡Œï¼Œå¹¶ä¸”å…è®¸ unprivileged user namespaces å’Œ overlay mountsã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

CVE-2021-3493 æ¼æ´å­˜åœ¨äº Linux å†…æ ¸çš„ overlayfs å®ç°ä¸­ã€‚ç”±äºå¯¹ç”¨æˆ·å‘½åç©ºé—´ä¸­åº•å±‚æ–‡ä»¶ç³»ç»Ÿæ–‡ä»¶ capabilities çš„éªŒè¯ä¸è¶³ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡åˆ›å»ºæ¶æ„çš„ overlayfs æ–‡ä»¶ç³»ç»Ÿï¼Œåˆ©ç”¨ setxattr è®¾ç½®æ–‡ä»¶ capabilitiesï¼Œä»è€Œè·å¾—æå‡çš„æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** åˆ›å»º overlayfs æ‰€éœ€çš„ç›®å½•ç»“æ„ (lower, upper, work, merge)ã€‚
2.  **Namespace åˆ›å»ºï¼š** åˆ›å»ºæ–°çš„ user namespace å’Œ mount namespaceï¼Œéš”ç¦»æƒé™ã€‚
3.  **æƒé™è®¾ç½®ï¼š** ä¿®æ”¹ uid_map å’Œ gid_mapï¼Œä½¿å¾—åœ¨ user namespace ä¸­æ‹¥æœ‰ root æƒé™ã€‚
4.  **Overlayfs Mountï¼š** ä½¿ç”¨ overlayfs mount å‘½ä»¤å°† lowerdir, upperdir, workdir æŒ‚è½½åˆ° mergedirã€‚
5.  **Capabilities è®¾ç½®ï¼š** å¤åˆ¶è‡ªèº«ç¨‹åºåˆ° merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` å‡½æ•°ä¸ºå¤åˆ¶åçš„ç¨‹åºè®¾ç½® capabilities (CAP_SETUID, CAP_SETGID, CAP_DAC_OVERRIDE ç­‰)ã€‚
6.  **æƒé™æå‡ï¼š** æ‰§è¡Œ merge ç›®å½•ä¸‹çš„ç¨‹åºï¼Œæ­¤æ—¶ç¨‹åºå°†ä»¥ root æƒé™è¿è¡Œã€‚

**æœ‰æ•ˆæ€§ï¼š**

æä¾›çš„ POC ä»£ç é€šè¿‡åˆ©ç”¨ overlayfs æ¼æ´ï¼Œå¯ä»¥æˆåŠŸåœ°æå‡æƒé™ã€‚POC ä»£ç é¦–å…ˆåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼Œç„¶ååˆ›å»ºä¸€ä¸ªæ–°çš„ user namespace å’Œ mount namespaceï¼Œæ¥ç€æŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿï¼Œå¹¶ä½¿ç”¨ `setxattr` å‡½æ•°ä¸ºæ–‡ä»¶è®¾ç½® capabilitiesã€‚æœ€åï¼Œæ‰§è¡Œè¯¥æ–‡ä»¶å³å¯è·å¾— root æƒé™ã€‚

**æŠ•æ¯’é£é™©ï¼š**

åˆ†æ POC ä»£ç ï¼Œæ²¡æœ‰å‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç ï¼Œä¾‹å¦‚åå¼¹ shellã€å®‰è£…åé—¨ç­‰ã€‚ä»£ç é€»è¾‘ä¸»è¦é›†ä¸­åœ¨åˆ©ç”¨ overlayfs æ¼æ´ææƒï¼Œå¹¶æ²¡æœ‰é¢å¤–çš„æ“ä½œæ¥æ¤å…¥æ¶æ„ç¨‹åºã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ï¼Œå¯ä»¥è®¤ä¸ºæ˜¯ 0%ã€‚å‚è€ƒçš„ vulnerability description å’Œ exploit ä»£ç éƒ½ç€é‡äºææƒï¼Œè€Œæ²¡æœ‰æåˆ°ä»»ä½•æŠ•æ¯’è¡Œä¸ºã€‚

**é¡¹ç›®åœ°å€:** [pmihsan/OverlayFS-CVE-2021-3493](https://github.com/pmihsan/OverlayFS-CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #12

**æ¥æº**: [CVE-2021-3493-ptkhai15_OverlayFS---CVE-2021-3493.md](../2021/CVE-2021-3493-ptkhai15_OverlayFS---CVE-2021-3493.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Ubuntu Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœ¬åœ°ç”¨æˆ·æå‡æƒé™è‡³ root

**å½±å“ç‰ˆæœ¬:** Ubuntu kernel versions 5.8, 5.4, 4.15, å’Œ 4.4 ä¸­å—å½±å“çš„ç‰ˆæœ¬ï¼ˆå…·ä½“ç‰ˆæœ¬å‚è§æ¼æ´åº“ä¿¡æ¯ï¼‰

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡ç³»ç»Ÿå¿…é¡»æ˜¯å—å½±å“çš„ Ubuntu ç‰ˆæœ¬ï¼Œå¹¶ä¸”å¯ç”¨äº†éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å’Œéç‰¹æƒ overlayfs æŒ‚è½½ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

CVE-2021-3493 æ˜¯ Ubuntu Linux å†…æ ¸ä¸­ OverlayFS å®ç°ä¸­çš„ä¸€ä¸ªæ¼æ´ã€‚è¯¥æ¼æ´å…è®¸éç‰¹æƒç”¨æˆ·åˆ©ç”¨ç”¨æˆ·å‘½åç©ºé—´å’Œéç‰¹æƒ overlayfs æŒ‚è½½ï¼Œé€šè¿‡ä¸æ­£ç¡®åœ°éªŒè¯åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­æ–‡ä»¶çš„ capabilities è®¾ç½®æ¥æå‡æƒé™ã€‚åˆ©ç”¨æ–¹å¼å¦‚ä¸‹ï¼š

1.  **ç¯å¢ƒå‡†å¤‡ï¼š**  åˆ›å»ºä¸€ä¸ªåŸºç¡€ç›®å½•ç»“æ„ï¼ŒåŒ…æ‹¬ workã€lowerã€upper å’Œ merge ç›®å½•ï¼Œè¿™æ˜¯ overlayfs çš„æ ‡å‡†é…ç½®ã€‚
2.  **åˆ›å»ºç”¨æˆ·å‘½åç©ºé—´ï¼š**  ä½¿ç”¨ `unshare` å‘½ä»¤åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´ã€‚è¿™å…è®¸åœ¨æ–°çš„å‘½åç©ºé—´ä¸­æ‹¥æœ‰ä¸åŒçš„ç”¨æˆ·å’Œç»„ IDã€‚
3.  **é…ç½®ç”¨æˆ·å’Œç»„æ˜ å°„ï¼š**  é€šè¿‡ `/proc/self/setgroups`ã€`/proc/self/uid_map` å’Œ `/proc/self/gid_map` æ–‡ä»¶è®¾ç½®ç”¨æˆ·å’Œç»„ ID æ˜ å°„ï¼Œå°†å½“å‰ç”¨æˆ·çš„ UID å’Œ GID æ˜ å°„åˆ°æ–°å‘½åç©ºé—´ä¸­çš„ root ç”¨æˆ·ã€‚
4.  **æŒ‚è½½ OverlayFSï¼š**  ä½¿ç”¨ `mount` å‘½ä»¤æŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿï¼Œå°† lowerã€upper å’Œ work ç›®å½•å…³è”èµ·æ¥ã€‚
5.  **è®¾ç½®æ–‡ä»¶ capabilitiesï¼š**  å¤åˆ¶å½“å‰æ‰§è¡Œç¨‹åºåˆ° overlayfs çš„ merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½®æ–‡ä»¶çš„ capabilities ä¸º `all+ep`ï¼Œå…è®¸è¯¥æ–‡ä»¶æ‰§è¡Œæ—¶æ‹¥æœ‰ root æƒé™ã€‚
6.  **æ‰§è¡Œææƒåçš„ç¨‹åºï¼š**  æ‰§è¡Œä½äº upper ç›®å½•ä¸­çš„å¤åˆ¶åçš„ç¨‹åºã€‚å¦‚æœç¨‹åºæ£€æµ‹åˆ°è‡ªå·±æ˜¯é€šè¿‡ç‰¹å®šæ–¹å¼ï¼ˆä¾‹å¦‚ï¼ŒåŒ…å« "magic" å­—ç¬¦ä¸²æˆ–æ¥å— "shell" å‚æ•°ï¼‰è°ƒç”¨çš„ï¼Œå®ƒä¼šè°ƒç”¨ `setuid(0)` å’Œ `setgid(0)` å°†è¿›ç¨‹çš„ UID å’Œ GID è®¾ç½®ä¸º 0 (root)ï¼Œå¹¶å¯åŠ¨ä¸€ä¸ª root shellã€‚

**å…³äºæŠ•æ¯’é£é™©ï¼š**

åœ¨æä¾›çš„ POC ä»£ç ä¸­ï¼Œæ²¡æœ‰æ˜æ˜¾çš„æŠ•æ¯’ä»£ç ã€‚POC çš„ç›®çš„æ˜¯æ¼”ç¤ºæ¼æ´åˆ©ç”¨è¿‡ç¨‹ï¼Œæ²¡æœ‰å‘ç°æ¶æ„è¡Œä¸ºï¼Œä¾‹å¦‚åå‘ shell æˆ–å…¶ä»–æœªç»æˆæƒçš„è®¿é—®ã€‚


**é¡¹ç›®åœ°å€:** [ptkhai15/OverlayFS---CVE-2021-3493](https://github.com/ptkhai15/OverlayFS---CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #13

**æ¥æº**: [CVE-2021-3493-puckiestyle_CVE-2021-3493.md](../2021/CVE-2021-3493-puckiestyle_CVE-2021-3493.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ”»å‡»è€…å¯åˆ©ç”¨æ­¤æ¼æ´è·å¾— root æƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu 5.8 kernel (< 5.8.0-50.56), 5.4 kernel (< 5.4.0-72.80), 4.15 kernel (< 4.15.0-142.146), 4.4 kernel (< 4.4.0-209.241)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ Ubuntu ç³»ç»Ÿå¼€å¯ unprivileged user namespaces å’Œå…è®¸ unprivileged overlay mounts

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2021-3493 æ˜¯ Ubuntu å†…æ ¸ overlayfs å®ç°ä¸­çš„ä¸€ä¸ªæ¼æ´ï¼Œå…è®¸æœ¬åœ°æ”»å‡»è€…é€šè¿‡æ»¥ç”¨ user namespaces å’Œ overlayfs æŒ‚è½½æœºåˆ¶æå‡æƒé™ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**
æä¾›çš„ POC ä»£ç å°è¯•åˆ©ç”¨è¯¥æ¼æ´ï¼Œé€šè¿‡åˆ›å»º user namespace å’Œ overlayfs æ–‡ä»¶ç³»ç»Ÿæ¥è®¾ç½®å¯æ‰§è¡Œæ–‡ä»¶çš„ capability ä½ï¼Œä½¿å…¶è·å¾— root æƒé™ã€‚ æ¼æ´åº“ä¿¡æ¯,æœç´¢å¼•æ“ç»“æœå’Œæ¼æ´åˆ©ç”¨ä»£ç ä¸€è‡´,è¡¨æ˜è¯¥æ¼æ´çš„POCæ˜¯çœŸå®æœ‰æ•ˆçš„ã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**
æŸ¥çœ‹ `exploit.c` ä»£ç ï¼Œä¸»è¦æ“ä½œåŒ…æ‹¬åˆ›å»ºç›®å½•ã€è®¾ç½® user namespaceã€æŒ‚è½½ overlayfsã€å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶ã€è®¾ç½® capability å±æ€§ï¼Œä»¥åŠæ‰§è¡Œå¤åˆ¶åçš„æ–‡ä»¶ä»¥è·å¾— root æƒé™ã€‚ä»£ç é€»è¾‘è¾ƒä¸ºæ¸…æ™°ï¼Œæœªå‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç ã€‚`README.md` ä¹Ÿè¯´æ˜äº†å¹¶éä½œè€…åŸåˆ›,åªæ˜¯æ¬è¿,å¢åŠ äº†åˆ†æéš¾åº¦.
`exploit.c`ä¸­å­˜åœ¨`system(buf);` è°ƒç”¨ï¼Œè™½ç„¶è¿™é‡Œæ˜¯ç”¨äºæ¸…ç†ç›®å½•ï¼Œä½†å¦‚æœè¢«ç¯¡æ”¹ï¼Œå¯èƒ½æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£é™©è¯„ä¼°ä¸º10%ã€‚ä¸»è¦çš„é£é™©åœ¨äºï¼š

*   `system()` å‡½æ•°æ½œåœ¨çš„å‘½ä»¤æ³¨å…¥é£é™©ï¼Œå¦‚æœä»£ç è¢«ä¿®æ”¹ï¼Œå¯èƒ½å¯¼è‡´æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  åˆ©ç”¨ unshare() åˆ›å»ºä¸€ä¸ªæ–°çš„ user namespace å’Œ mount namespaceã€‚
2.  é…ç½® user namespace çš„ uid_map å’Œ gid_mapï¼Œå°†å½“å‰ç”¨æˆ·æ˜ å°„ä¸º root ç”¨æˆ·ã€‚
3.  åˆ›å»º overlayfs æ‰€éœ€çš„ç›®å½•ç»“æ„ï¼ˆlowerdirã€upperdirã€workdirã€mergedï¼‰ã€‚
4.  æŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿã€‚
5.  å°†æ¼æ´åˆ©ç”¨ç¨‹åºè‡ªèº«å¤åˆ¶åˆ° overlayfs çš„ upperdir/merged ç›®å½•ã€‚
6.  ä½¿ç”¨ setxattr() è®¾ç½®å¤åˆ¶åçš„å¯æ‰§è¡Œæ–‡ä»¶çš„ security.capability å±æ€§ï¼Œèµ‹äºˆå…¶ CAP_SETUID å’Œ CAP_SETGID æƒé™ã€‚
7.  æ‰§è¡Œå¤åˆ¶åçš„ç¨‹åºï¼Œç”±äºè®¾ç½®äº† capabilityï¼Œè¯¥ç¨‹åºä¼šä»¥ root æƒé™è¿è¡Œï¼Œä»è€Œè·å¾— root shellã€‚

**é¡¹ç›®åœ°å€:** [puckiestyle/CVE-2021-3493](https://github.com/puckiestyle/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #14

**æ¥æº**: [CVE-2021-3493-smallkill_CVE-2021-3493.md](../2021/CVE-2021-3493-smallkill_CVE-2021-3493.md)

# CVE-2021-3493

> ğŸ“¦ è¯¥CVEæœ‰ **15** ä¸ªç›¸å…³POCä»“åº“

---

## POC #1

**æ¥æº**: [CVE-2021-3493-Abdennour-py_CVE-2021-3493.md](../2021/CVE-2021-3493-Abdennour-py_CVE-2021-3493.md)

## CVE-2021-3493 Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å¯¼è‡´æ™®é€šç”¨æˆ·æå‡ä¸ºrootæƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu 5.8 kernel < 5.8.0-50.56, 5.4 kernel < 5.4.0-72.80, 4.15 kernel < 4.15.0-142.146, 4.4 kernel < 4.4.0-209.241

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç›®æ ‡ç³»ç»Ÿè¿è¡Œå—å½±å“çš„Ubuntuå†…æ ¸ï¼Œå¹¶ä¸”å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿå’Œä½¿ç”¨user namespace

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

è¯¥æ¼æ´æºäºUbuntuå†…æ ¸ä¸­overlayfså®ç°å¯¹ç”¨æˆ·å‘½åç©ºé—´ä¸­çš„æ–‡ä»¶èƒ½åŠ›éªŒè¯ä¸å½“ã€‚ç»“åˆéç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å’ŒUbuntuå†…æ ¸ä¸­çš„å…è®¸éç‰¹æƒ overlayfs æŒ‚è½½çš„è¡¥ä¸ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´è·å¾—æå‡çš„æƒé™ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**

æä¾›çš„POCä»£ç çœ‹èµ·æ¥æ˜¯æœ‰æ•ˆçš„ã€‚å®ƒåˆ©ç”¨äº† overlayfs å’Œ user namespace çš„ç»„åˆæ¥è®¾ç½®æ–‡ä»¶ capabilityï¼Œä»è€Œå®ç°ææƒã€‚ä»£ç é¦–å…ˆåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼ˆlower, upper, work, mergeï¼‰ï¼Œç„¶åä½¿ç”¨ `unshare` åˆ›å»ºä¸€ä¸ªæ–°çš„ user namespace å’Œ mount namespaceã€‚æ¥ç€ï¼Œå®ƒå†™å…¥ `/proc/self/setgroups`, `/proc/self/uid_map`, å’Œ `/proc/self/gid_map` æ¥è®¾ç½®ç”¨æˆ·å’Œç»„çš„æ˜ å°„ã€‚ç„¶åï¼ŒæŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿï¼Œæ‹·è´è‡ªèº«å¯æ‰§è¡Œæ–‡ä»¶åˆ° overlayfs çš„ merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½® capabilitiesã€‚æœ€åï¼Œå®ƒæ‰§è¡Œä½äº upper ç›®å½•çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶ä¼šå°è¯•ä»¥ root æƒé™æ‰§è¡Œ /bin/bashã€‚

æ ¹æ®æ¼æ´åº“ä¿¡æ¯ï¼ŒCISA å°†æ­¤æ¼æ´æ·»åŠ åˆ°å·²çŸ¥è¢«åˆ©ç”¨çš„æ¼æ´åˆ—è¡¨ä¸­ï¼Œè¿›ä¸€æ­¥è¡¨æ˜äº†è¯¥æ¼æ´çš„æœ‰æ•ˆæ€§ã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

æ£€æŸ¥æä¾›çš„ exploit.c ä»£ç ï¼Œæ²¡æœ‰å‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç æˆ–åé—¨ã€‚ä»£ç é€»è¾‘æ¸…æ™°ï¼Œä¸»è¦æ‰§è¡Œäº† overlayfs çš„æŒ‚è½½ï¼Œæ–‡ä»¶å¤åˆ¶ï¼Œè®¾ç½® xattr å’Œæ‰§è¡Œ shell æ“ä½œã€‚ä»£ç çš„æ„å›¾ä¸æ¼æ´æè¿°ä¸€è‡´ï¼Œæ²¡æœ‰å‘ç°éšè—çš„ã€ä¸æ¼æ´åˆ©ç”¨æ— å…³çš„æ¶æ„è¡Œä¸ºã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£é™©ä¸º 0%ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š**  åœ¨å­˜åœ¨æ¼æ´çš„Ubuntuç³»ç»Ÿä¸Šï¼Œåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ (ovlcap/work, ovlcap/lower, ovlcap/upper, ovlcap/merge)ã€‚
2.  **User Namespaceå’ŒMount Namespaceï¼š** ä½¿ç”¨ `unshare` ç³»ç»Ÿè°ƒç”¨åˆ›å»ºæ–°çš„ user namespace å’Œ mount namespaceã€‚
3.  **IDæ˜ å°„ï¼š**  é…ç½® `/proc/self/setgroups`ï¼Œ`/proc/self/uid_map` å’Œ `/proc/self/gid_map`ï¼Œä»¥ä¾¿åœ¨ user namespace ä¸­è·å¾—æœ‰æ•ˆçš„ç”¨æˆ· ID å’Œç»„ IDã€‚
4.  **OverlayFSæŒ‚è½½ï¼š**  ä½¿ç”¨ `mount` ç³»ç»Ÿè°ƒç”¨æŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿï¼Œå°† lower, upper å’Œ work ç›®å½•å…³è”èµ·æ¥ã€‚
5.  **æ–‡ä»¶æ‹·è´ä¸ Capability è®¾ç½®ï¼š**  å°† exploit ç¨‹åºè‡ªèº«æ‹·è´åˆ° overlayfs çš„ merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½® `security.capability` å±æ€§ï¼Œèµ‹äºˆå…¶ CAP_SETUID å’Œ CAP_SETGID ç­‰æƒé™ã€‚
6.  **ææƒæ‰§è¡Œï¼š** æ‰§è¡Œä½äº upper ç›®å½•çš„ exploit ç¨‹åºçš„æ‹·è´ã€‚ç”±äºè¯¥æ–‡ä»¶å…·æœ‰ capabilitiesï¼Œå› æ­¤å¯ä»¥ä»¥ root æƒé™æ‰§è¡Œ shellã€‚

**é¡¹ç›®åœ°å€:** [Abdennour-py/CVE-2021-3493](https://github.com/Abdennour-py/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #2

**æ¥æº**: [CVE-2021-3493-Sornphut_OverlayFS---CVE-2021-3493.md](../2021/CVE-2021-3493-Sornphut_OverlayFS---CVE-2021-3493.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒæ¼æ´

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Ubuntu Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœ¬åœ°ç”¨æˆ·è·å¾— root æƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu kernels before 5.8.0-50.56, 5.4.0-72.80, 4.15.0-142.146, and 4.4.0-209.241

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦è¿è¡Œåœ¨å­˜åœ¨æ¼æ´çš„ Ubuntu å†…æ ¸ä¸Šï¼Œå¹¶ä¸”å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½ overlayfsã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

è¯¥æ¼æ´å­˜åœ¨äº Ubuntu Linux å†…æ ¸çš„ overlayfs å®ç°ä¸­ã€‚ç”±äº Ubuntu å¯¹ overlayfs æŒ‚è½½çš„ç‰¹å®šä¿®æ”¹ï¼Œå¯¼è‡´åœ¨ç”¨æˆ·å‘½åç©ºé—´å†…ï¼Œå¯¹åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­çš„æ–‡ä»¶ capabilities éªŒè¯ä¸å……åˆ†ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡ overlayfs æŒ‚è½½ç»•è¿‡ capabilities æ£€æŸ¥ï¼Œè®¾ç½®æ–‡ä»¶ capabilities æå‡æƒé™ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  åˆ›å»ºä¸€ä¸ªç›®å½•ç»“æ„ï¼ŒåŒ…æ‹¬ lower, upper, work å’Œ merge ç›®å½•ã€‚
2.  ä½¿ç”¨ `unshare` åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´å’ŒæŒ‚è½½å‘½åç©ºé—´ã€‚
3.  é…ç½® `/proc/self/setgroups`, `/proc/self/uid_map`, å’Œ `/proc/self/gid_map` ä»¥æ˜ å°„ç”¨æˆ· ID å’Œç»„ IDã€‚
4.  ä½¿ç”¨ `mount` å‘½ä»¤æŒ‚è½½ overlayfsï¼Œå°† lower, upper å’Œ work ç›®å½•ä¸ merge ç›®å½•å…³è”èµ·æ¥ã€‚
5.  åœ¨ upper ç›®å½•æˆ– merge ç›®å½•ä¸‹åˆ›å»ºæˆ–å¤åˆ¶ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ã€‚
6.  ä½¿ç”¨ `setxattr` è®¾ç½®å¯æ‰§è¡Œæ–‡ä»¶çš„ capabilitiesï¼Œèµ‹äºˆå…¶ root æƒé™ã€‚
7.  æ‰§è¡Œè¯¥æ–‡ä»¶ï¼Œå³å¯è·å¾— root æƒé™ã€‚

**æœ‰æ•ˆæ€§ï¼š**

æä¾›çš„ POC ä»£ç å°è¯•åˆ©ç”¨ CVE-2021-3493 æ¼æ´ã€‚è¯¥ä»£ç åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´å’ŒæŒ‚è½½å‘½åç©ºé—´ï¼Œå¹¶å°è¯•æŒ‚è½½ overlayfsã€‚ç„¶åï¼Œå®ƒåº”è¯¥è®¾ç½® `magic` äºŒè¿›åˆ¶æ–‡ä»¶çš„ capabilitiesï¼Œä»è€Œè·å¾— root æƒé™ã€‚æ ¹æ®æ¼æ´æè¿°ï¼Œè¯¥ POC åº”è¯¥èƒ½å¤Ÿæœ‰æ•ˆåˆ©ç”¨è¯¥æ¼æ´ã€‚

**æŠ•æ¯’é£é™©ï¼š**

æ£€æŸ¥æä¾›çš„ exploit.c æ–‡ä»¶ï¼Œæœªå‘ç°æ˜æ˜¾çš„æ¶æ„æˆ–éšè—ä»£ç ã€‚ä»£ç é€»è¾‘ä¸»è¦é›†ä¸­äºè®¾ç½® overlayfs æŒ‚è½½å’Œæ–‡ä»¶ capabilitiesã€‚ä½†æ˜¯ï¼Œéœ€è¦å§‹ç»ˆè°¨æ…å¯¹å¾…æ¥è‡ªä¸å—ä¿¡ä»»æ¥æºçš„ä»£ç ã€‚ä¸ºäº†ç¡®ä¿å®‰å…¨ï¼Œå»ºè®®åœ¨å—æ§ç¯å¢ƒä¸­ä»”ç»†å®¡æŸ¥å’Œæµ‹è¯•ä»£ç ã€‚


**é¡¹ç›®åœ°å€:** [Sornphut/OverlayFS---CVE-2021-3493](https://github.com/Sornphut/OverlayFS---CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #3

**æ¥æº**: [CVE-2021-3493-briskets_CVE-2021-3493.md](../2021/CVE-2021-3493-briskets_CVE-2021-3493.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å¯¼è‡´æ™®é€šç”¨æˆ·æƒé™æå‡è‡³rootæƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu kernel versions: < 5.8.0-50.56 (5.8 kernel), < 5.4.0-72.80 (5.4 kernel), < 4.15.0-142.146 (4.15 kernel), < 4.4.0-209.241 (4.4 kernel)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦åœ¨å­˜åœ¨æ¼æ´çš„Ubuntuå†…æ ¸ç‰ˆæœ¬ä¸Šï¼Œå¹¶ä¸”å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½overlayfs

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 5%

## è¯¦æƒ…

CVE-2021-3493 æ¼æ´æ˜¯ç”±äº Linux å†…æ ¸çš„ overlayfs å®ç°æ²¡æœ‰æ­£ç¡®éªŒè¯ç”¨æˆ·å‘½åç©ºé—´ä¸­åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸Šæ–‡ä»¶ capabilities çš„è®¾ç½®ã€‚ç”±äº Ubuntu å†…æ ¸ä¸­å­˜åœ¨å…è®¸éç‰¹æƒ overlay æŒ‚è½½çš„è¡¥ä¸ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´è·å¾—æå‡çš„æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  æ¼æ´åˆ©ç”¨ä»£ç é¦–å…ˆåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ (ovlcap/work, ovlcap/lower, ovlcap/upper, ovlcap/merge)ã€‚
2.  åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´å’ŒæŒ‚è½½å‘½åç©ºé—´ã€‚
3.  åœ¨æ–°çš„ç”¨æˆ·å‘½åç©ºé—´ä¸­ï¼Œå°†å½“å‰ç”¨æˆ·çš„ UID å’Œ GID æ˜ å°„åˆ° root ç”¨æˆ·ã€‚
4.  ä½¿ç”¨ overlayfs å°† lowerdir (ovlcap/lower), upperdir (ovlcap/upper) å’Œ workdir (ovlcap/work) æŒ‚è½½åˆ° mergedir (ovlcap/merge)ã€‚
5.  å¤åˆ¶è‡ªèº« (exploit ç¨‹åº) åˆ° mergedir/magicï¼Œå¹¶è®¾ç½® security.capability æ‰©å±•å±æ€§ä¸º all+epï¼Œèµ‹äºˆè¯¥æ–‡ä»¶ capabilitiesã€‚
6.  æ‰§è¡Œ mergedir/magicï¼Œç”±äº capabilities çš„è®¾ç½®ï¼Œè¯¥ç¨‹åºä¼šä»¥ root æƒé™æ‰§è¡Œã€‚
7.  æœ€åï¼Œæ‰§è¡Œ upperdir/magicï¼Œå¯åŠ¨ä¸€ä¸ª root shellã€‚

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„POCä»£ç æ˜¯æœ‰æ•ˆçš„ï¼Œèƒ½å¤Ÿåˆ©ç”¨ CVE-2021-3493 æ¼æ´åœ¨å—å½±å“çš„ Ubuntu ç³»ç»Ÿä¸Šå®ç°æœ¬åœ°ææƒã€‚

**æŠ•æ¯’é£é™©ï¼š**
è¯¥POCä»£ç çš„ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´è¿›è¡Œææƒï¼Œä½†ä»ç„¶å­˜åœ¨æ½œåœ¨çš„æŠ•æ¯’é£é™©ã€‚æ¯”å¦‚ä½œè€…å¯èƒ½åœ¨ç¼–è¯‘å’Œè¿è¡Œå‰æ·»åŠ ä¸€äº›æ¶æ„ä»£ç ï¼Œä¾‹å¦‚ï¼š

1.  **åé—¨æ¤å…¥ï¼š** åœ¨ææƒæˆåŠŸåï¼Œæ¤å…¥ä¸€ä¸ªåé—¨ç¨‹åºï¼Œå…è®¸æ”»å‡»è€…è¿œç¨‹è®¿é—®ç³»ç»Ÿã€‚
2.  **æ•°æ®çªƒå–ï¼š** åœ¨ææƒè¿‡ç¨‹ä¸­ï¼Œçªƒå–ç”¨æˆ·çš„æ•æ„Ÿæ•°æ®ã€‚
3.  **ç ´åç³»ç»Ÿï¼š** åœ¨ææƒå¤±è´¥æˆ–è€…æˆåŠŸåï¼Œç ´åç³»ç»Ÿæ–‡ä»¶æˆ–è€…é…ç½®ã€‚

è€ƒè™‘åˆ°ä»£ç ç›¸å¯¹ç®€çŸ­ä¸”åŠŸèƒ½æ˜ç¡®ï¼Œè¯„ä¼°æŠ•æ¯’é£é™©ä¸º5%ã€‚ç”¨æˆ·éœ€è¦ä»”ç»†å®¡æŸ¥ä»£ç ï¼Œå¹¶åœ¨å®‰å…¨çš„ç¯å¢ƒä¸­è¿›è¡Œæµ‹è¯•ã€‚

**é¡¹ç›®åœ°å€:** [briskets/CVE-2021-3493](https://github.com/briskets/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #4

**æ¥æº**: [CVE-2021-3493-cyberx-1_OverlayFS-CVE-2021-3493.md](../2021/CVE-2021-3493-cyberx-1_OverlayFS-CVE-2021-3493.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯ä»æ™®é€šç”¨æˆ·ææƒè‡³root

**å½±å“ç‰ˆæœ¬:** Ubuntu kernels: 5.8.0-50.56 (5.8 kernel), 5.4.0-72.80 (5.4 kernel), 4.15.0-142.146 (4.15 kernel), 4.4.0-209.241 (4.4 kernel)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦è¿è¡Œåœ¨å­˜åœ¨æ¼æ´çš„Ubuntuå†…æ ¸ç‰ˆæœ¬ä¸Šï¼Œå¯ç”¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å’Œå…è®¸éç‰¹æƒ overlay mountsã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2021-3493æ˜¯Ubuntuå†…æ ¸OverlayFSå®ç°ä¸­çš„ä¸€ä¸ªæƒé™æå‡æ¼æ´ã€‚ç”±äºoverlayfsåœ¨ç”¨æˆ·å‘½åç©ºé—´ä¸­æ²¡æœ‰æ­£ç¡®éªŒè¯åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­æ–‡ä»¶åŠŸèƒ½è®¾ç½®ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å’ŒUbuntuå†…æ ¸ä¸­çš„éç‰¹æƒoverlayæŒ‚è½½è¡¥ä¸ï¼Œè·å–æå‡çš„æƒé™ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** åœ¨å­˜åœ¨æ¼æ´çš„Ubuntuå†…æ ¸ä¸Šï¼Œç¡®ä¿å¯ç”¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´ã€‚æ¼æ´åº“ä¿¡æ¯æåˆ°ç¦ç”¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å¯ä»¥ä½œä¸ºç¼“è§£æªæ–½ï¼Œæ‰€ä»¥è¦ç¡®ä¿å¯ç”¨ã€‚
2.  **åˆ›å»ºOverlayFSç»“æ„ï¼š** PoCä»£ç é¦–å…ˆåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼ˆlower, upper, work, mergeï¼‰ç”¨äº overlayfs æ–‡ä»¶ç³»ç»Ÿã€‚
3.  **åˆ›å»ºç”¨æˆ·å‘½åç©ºé—´ï¼š** ä½¿ç”¨`unshare`ç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´ã€‚è¿™å…è®¸åœ¨æ–°çš„å‘½åç©ºé—´ä¸­æ‹¥æœ‰ä¸åŒçš„ç”¨æˆ·IDå’Œç»„IDæ˜ å°„ã€‚
4.  **è®¾ç½®UID/GIDæ˜ å°„ï¼š** å°†å½“å‰ç”¨æˆ·çš„UIDå’ŒGIDæ˜ å°„åˆ°æ–°å‘½åç©ºé—´ä¸­çš„rootç”¨æˆ· (UID 0 å’Œ GID 0)ã€‚
5.  **æŒ‚è½½OverlayFSï¼š** ä½¿ç”¨`mount`ç³»ç»Ÿè°ƒç”¨å°† overlayfs æ–‡ä»¶ç³»ç»ŸæŒ‚è½½åˆ° merge ç›®å½•ã€‚æŒ‡å®š lowerdir, upperdir å’Œ workdirã€‚
6.  **å¤åˆ¶è‡ªèº«å¹¶è®¾ç½®Capabilitiesï¼š** å°†è‡ªèº«å¯æ‰§è¡Œæ–‡ä»¶å¤åˆ¶åˆ° overlayfs çš„ merge ç›®å½•ï¼Œç„¶åä½¿ç”¨`setxattr`è®¾ç½®`security.capability`æ‰©å±•å±æ€§ï¼Œèµ‹äºˆè¯¥æ–‡ä»¶ root æƒé™ã€‚
7.  **æ‰§è¡Œææƒåçš„ç¨‹åºï¼š** é€šè¿‡æ‰§è¡Œ upper ç›®å½•ä¸‹çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆä¹‹å‰å¤åˆ¶å¹¶è®¾ç½®äº† capabilities çš„æ–‡ä»¶ï¼‰æ¥è·å– root æƒé™ã€‚è¿™ä¸ªç¨‹åºä¼šæ£€æŸ¥æ˜¯å¦æœ‰"shell"å‚æ•°ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™ä¼šé‡æ–°æ‰§è¡Œè‡ªèº«ï¼Œä½†è¿™æ¬¡ä¼šå¸¦æœ‰`shell`å‚æ•°ï¼Œä»è€Œè§¦å‘`setuid(0)`å’Œ`setgid(0)`ï¼Œæœ€ç»ˆæ‰§è¡Œ`/bin/bash`ï¼Œè·å¾— root shellã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

ä»£ç ä¸­å­˜åœ¨ä¸€å®šçš„æŠ•æ¯’é£é™©ï¼Œè™½ç„¶ä¸»è¦é€»è¾‘æ˜¯åˆ©ç”¨æ¼æ´è¿›è¡Œææƒï¼Œä½†å­˜åœ¨ä¿®æ”¹`/bin/bash`çš„å¯èƒ½æ€§ï¼Œä½†æ˜¯ç»è¿‡ä»£ç åˆ†æä»¥åŠæ¼æ´åŸç†ï¼Œåˆ¤æ–­æ¼æ´åˆ©ç”¨è¿‡ç¨‹ä¸­æ²¡æœ‰ä¿®æ”¹`/bin/bash`æ“ä½œ,ä»£ç ä¸­é£é™©ä¸»è¦å­˜åœ¨äºä»¥ä¸‹å‡ ç‚¹:

1.  **ä¾èµ–å¤–éƒ¨äºŒè¿›åˆ¶æ–‡ä»¶ï¼š** è¯¥æ¼æ´åˆ©ç”¨ä¾èµ–äºç³»ç»Ÿä¸Šçš„`/bin/bash`ã€‚å¦‚æœæ”»å‡»è€…æ›¿æ¢æˆ–ç¯¡æ”¹äº†ç›®æ ‡ç³»ç»Ÿä¸Šçš„`/bin/bash`ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ„å¤–çš„è¡Œä¸ºæˆ–å®‰å…¨é—®é¢˜ã€‚
2.  **æ¸…ç†æ“ä½œé£é™©ï¼š** ä»£ç å¼€å§‹æ—¶ä½¿ç”¨`system(buf)`æ‰§è¡Œ`rm -rf '%s/'`ï¼Œå¦‚æœ`DIR_BASE`è¢«æ¶æ„ä¿®æ”¹ï¼Œå¯èƒ½å¯¼è‡´æ„å¤–çš„æ–‡ä»¶åˆ é™¤ã€‚
3.  **ä¸å®Œå–„çš„é”™è¯¯å¤„ç†ï¼š** è™½ç„¶ PoC ä»£ç åŒ…å«äº†ä¸€äº›é”™è¯¯å¤„ç†ï¼Œä½†åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå¦‚æœé”™è¯¯å¤„ç†ä¸å½“ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ‹’ç»æœåŠ¡æˆ–æœªå®šä¹‰çš„è¡Œä¸ºã€‚

æ€»ä½“è€Œè¨€ï¼Œè¯¥ PoC ä»£ç çš„æŠ•æ¯’é£é™©è¾ƒä½ï¼Œä¸»è¦é£é™©åœ¨äºä¾èµ–å¤–éƒ¨äºŒè¿›åˆ¶æ–‡ä»¶å’Œæ½œåœ¨çš„æ¸…ç†æ“ä½œé£é™©ã€‚ä»£ç æœ¬èº«ä¸»è¦æ˜¯ä¸ºäº†æ¼”ç¤ºæ¼æ´åˆ©ç”¨ï¼Œå¹¶æœªå‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç ã€‚ è¯„ä¼°æŠ•æ¯’é£é™©ä¸º10%ã€‚


**é¡¹ç›®åœ°å€:** [cyberx-1/OverlayFS-CVE-2021-3493](https://github.com/cyberx-1/OverlayFS-CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #5

**æ¥æº**: [CVE-2021-3493-derek-turing_CVE-2021-3493.md](../2021/CVE-2021-3493-derek-turing_CVE-2021-3493.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Ubuntu Linux Kernel

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœ¬åœ°ç”¨æˆ·å¯æå‡è‡³ root æƒé™

**å½±å“ç‰ˆæœ¬:** 4.4 <= kernel < 4.4.0-209.241, 4.15 <= kernel < 4.15.0-142.146, 5.4 <= kernel < 5.4.0-72.80, 5.8 <= kernel < 5.8.0-50.56

**åˆ©ç”¨æ¡ä»¶:** Ubuntu å†…æ ¸å¼€å¯äº† unprivileged user namespaces å’Œ unprivileged overlay mounts

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

è¯¥æ¼æ´å­˜åœ¨äº Ubuntu Linux å†…æ ¸çš„ OverlayFS å®ç°ä¸­ï¼Œç”±äº overlayfs å¯¹åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­æ–‡ä»¶ capabilities çš„è®¾ç½®éªŒè¯ä¸å½“ï¼Œç»“åˆæœªæˆæƒç”¨æˆ·å‘½åç©ºé—´å’Œ Ubuntu å†…æ ¸ä¸­å…è®¸æœªæˆæƒ overlay æŒ‚è½½çš„è¡¥ä¸ï¼Œæ”»å‡»è€…å¯åˆ©ç”¨æ­¤æ¼æ´æå‡æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** é¦–å…ˆï¼Œç¡®ä¿ç›®æ ‡ç³»ç»Ÿæ»¡è¶³æ¼æ´åˆ©ç”¨çš„æ¡ä»¶ï¼Œå³ Ubuntu å†…æ ¸ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…ï¼Œå¹¶ä¸”å¯ç”¨äº† unprivileged user namespaces å’Œ unprivileged overlay mountsã€‚æ¼æ´åº“ä¿¡æ¯ä¸­ç»™å‡ºäº†å—å½±å“çš„ç‰ˆæœ¬èŒƒå›´ã€‚
2.  **åˆ›å»ºç›®å½•ç»“æ„ï¼š** åˆ›å»º overlayfs æ‰€éœ€çš„ç›®å½•ç»“æ„ï¼ŒåŒ…æ‹¬ lowerdirï¼ˆåº•å±‚ç›®å½•ï¼‰ã€upperdirï¼ˆä¸Šå±‚ç›®å½•ï¼‰ã€workdirï¼ˆå·¥ä½œç›®å½•ï¼‰å’Œ mergedirï¼ˆåˆå¹¶ç›®å½•ï¼‰ã€‚
3.  **åˆ›å»ºç”¨æˆ·å‘½åç©ºé—´ï¼š** ä½¿ç”¨ `unshare` å‘½ä»¤åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´ï¼Œè¿™å…è®¸åœ¨éç‰¹æƒç”¨æˆ·ä¸‹æ‰§è¡Œä¸€äº›ç‰¹æƒæ“ä½œã€‚
4.  **è®¾ç½® UID/GID æ˜ å°„ï¼š** åœ¨ç”¨æˆ·å‘½åç©ºé—´ä¸­ï¼Œå°†å½“å‰ç”¨æˆ·çš„ UID å’Œ GID æ˜ å°„åˆ° root ç”¨æˆ· (UID 0) å’Œ root ç»„ (GID 0)ï¼Œè¿™æ ·åœ¨ overlayfs ä¸­åˆ›å»ºçš„æ–‡ä»¶å°†å±äº root ç”¨æˆ·ã€‚
5.  **æŒ‚è½½ OverlayFSï¼š** ä½¿ç”¨ `mount` å‘½ä»¤å°† overlayfs æŒ‚è½½åˆ° mergedirï¼ŒæŒ‡å®š lowerdirã€upperdir å’Œ workdirã€‚
6.  **å¤åˆ¶å¹¶è®¾ç½® Capabilitiesï¼š** å°† exploit ç¨‹åºè‡ªèº«å¤åˆ¶åˆ° mergedir ä¸­ï¼Œå¹¶ä½¿ç”¨ `setxattr` å‘½ä»¤è®¾ç½®å…¶ security.capability æ‰©å±•å±æ€§ï¼Œèµ‹äºˆå…¶ CAP_SETUID å’Œ CAP_SETGID capabilitiesã€‚è¿™ä¸ªcapabilitieså…è®¸ç¨‹åºåœ¨æ²¡æœ‰rootæƒé™çš„æƒ…å†µä¸‹è®¾ç½®uidå’Œgidã€‚
7.  **è§¦å‘ææƒï¼š** è¿è¡Œ mergedir ä¸­çš„ exploit ç¨‹åºï¼Œç”±äºå·²è®¾ç½® capabilitiesï¼Œç¨‹åºå°†ä»¥ root æƒé™è¿è¡Œï¼Œä»è€Œæ‰§è¡Œç‰¹æƒæ“ä½œã€‚

**ä»£ç åˆ†æï¼š**

*   `exploit.c` æ˜¯åˆ©ç”¨ä»£ç ï¼Œå®ƒåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼Œå»ºç«‹ç”¨æˆ·å‘½åç©ºé—´ï¼ŒæŒ‚è½½ overlayfsï¼Œç„¶åå°†è‡ªèº«å¤åˆ¶åˆ° overlayfs ä¸­ï¼Œå¹¶è®¾ç½® capabilitiesã€‚æœ€åï¼Œæ‰§è¡Œå¤åˆ¶åˆ° upperdir ä¸­çš„ç¨‹åºï¼Œè¯¥ç¨‹åºä¼šå°†å½“å‰è¿›ç¨‹ææƒä¸º rootã€‚
*   ä»£ç ä¸­ä½¿ç”¨äº† `setxattr` å‡½æ•°æ¥è®¾ç½®æ–‡ä»¶ capabilitiesï¼Œè¿™æ˜¯åˆ©ç”¨æ¼æ´çš„å…³é”®æ­¥éª¤ã€‚
*   mainå‡½æ•°é¦–å…ˆforkä¸€ä¸ªå­è¿›ç¨‹æ‰§è¡Œexploitå‡½æ•°ï¼Œåœ¨exploitå‡½æ•°æ‰§è¡Œå®Œæ¯•åï¼Œçˆ¶è¿›ç¨‹æ‰§è¡ŒBIN_UPPERä¸­çš„magicç¨‹åºï¼Œå¦‚æœå¸¦æœ‰shellå‚æ•°ï¼Œmagicç¨‹åºä¼šè®¾ç½®uidå’Œgidä¸º0ï¼Œå¹¶ä¸”è¿è¡Œä¸€ä¸ªbash shellã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

ä»”ç»†æ£€æŸ¥äº† POC ä»£ç ï¼Œæ²¡æœ‰å‘ç°æ˜æ˜¾çš„æŠ•æ¯’ä»£ç ã€‚ä»£ç é€»è¾‘æ¸…æ™°ï¼Œä¸»è¦ç”¨äºåˆ›å»º overlayfs ç¯å¢ƒå¹¶è®¾ç½®æ–‡ä»¶ capabilities ä»¥è¿›è¡Œææƒã€‚ä½œè€…å¹¶æ²¡æœ‰å°è¯•åœ¨ä»£ç ä¸­éšè—æ¶æ„è¡Œä¸ºï¼Œä¾‹å¦‚ï¼š

*   è¿æ¥å¤–éƒ¨æœåŠ¡å™¨
*   ä¿®æ”¹ç³»ç»Ÿæ–‡ä»¶
*   å®‰è£…åé—¨
*   æ”¶é›†ç”¨æˆ·ä¿¡æ¯

å› æ­¤ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ (0%)ã€‚

**é¡¹ç›®åœ°å€:** [derek-turing/CVE-2021-3493](https://github.com/derek-turing/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #6

**æ¥æº**: [CVE-2021-3493-fathallah17_OverlayFS-CVE-2021-3493.md](../2021/CVE-2021-3493-fathallah17_OverlayFS-CVE-2021-3493.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°æƒé™æå‡

**å½±å“åº”ç”¨:** Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å¯¼è‡´æœ¬åœ°æƒé™æå‡è‡³root

**å½±å“ç‰ˆæœ¬:** 4.4 <= Linux Kernel < 5.8.0-50.56 (Ubuntu ç‰¹å®šç‰ˆæœ¬)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦å­˜åœ¨Ubuntuå†…æ ¸ä¸­å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½OverlayFSçš„è¡¥ä¸ï¼Œä¸”ç”¨æˆ·å‘½åç©ºé—´æœªè¢«ç¦ç”¨ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 1%

## è¯¦æƒ…

CVE-2021-3493 æ˜¯ä¸€ä¸ªå­˜åœ¨äº Linux å†…æ ¸ OverlayFS å®ç°ä¸­çš„æƒé™æå‡æ¼æ´ã€‚æ¼æ´çš„æ ¹æœ¬åŸå› æ˜¯ OverlayFS åœ¨è®¾ç½®åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­æ–‡ä»¶çš„ capabilities æ—¶ï¼Œæ²¡æœ‰æ­£ç¡®åœ°éªŒè¯ç”¨æˆ·å‘½åç©ºé—´ã€‚åœ¨å­˜åœ¨å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½ OverlayFS çš„ Ubuntu å†…æ ¸è¡¥ä¸çš„ç¯å¢ƒä¸­ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´è·å¾—æå‡çš„æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š**  ç›®æ ‡ç³»ç»Ÿéœ€è¦æ˜¯å—å½±å“çš„ Ubuntu ç‰ˆæœ¬ï¼Œå¹¶ä¸”å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½ OverlayFSï¼ŒåŒæ—¶ç”¨æˆ·å‘½åç©ºé—´æ²¡æœ‰è¢«ç¦ç”¨ã€‚
2.  **è·å–æ¼æ´åˆ©ç”¨ä»£ç ï¼š**  ä»å¯ä¿¡æ¥æºè·å–æ¼æ´åˆ©ç”¨ä»£ç  (ä¾‹å¦‚ SSD-Disclosure æä¾›çš„ exploit.c)ã€‚
3.  **ç¼–è¯‘æ¼æ´åˆ©ç”¨ä»£ç ï¼š**  ä½¿ç”¨ gcc ç­‰ç¼–è¯‘å™¨å°† exploit.c ç¼–è¯‘ä¸ºå¯æ‰§è¡Œæ–‡ä»¶ã€‚
4.  **æ‰§è¡Œæ¼æ´åˆ©ç”¨ä»£ç ï¼š**  è¿è¡Œç¼–è¯‘åçš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚æ¼æ´åˆ©ç”¨ä»£ç ä¼šåˆ©ç”¨ OverlayFS çš„æ¼æ´ï¼Œé€šè¿‡è®¾ç½®æ–‡ä»¶ capabilities æ¥æå‡å½“å‰ç”¨æˆ·çš„æƒé™è‡³ rootã€‚
5.  **è·å– root æƒé™ï¼š**  æˆåŠŸæ‰§è¡Œæ¼æ´åˆ©ç”¨ä»£ç åï¼Œç”¨æˆ·å°†è·å¾— root æƒé™ã€‚

**å…³äºæŠ•æ¯’é£é™©ï¼š**

æä¾›çš„POCä»£ç åªæ˜¯ä¸€ä¸ªç®€å•çš„åˆ©ç”¨æ–¹å¼,ä¸å¤ªå¯èƒ½åŒ…å«æ¶æ„ä»£ç ã€‚ä½†å§‹ç»ˆéœ€è¦å¯¹ä»»ä½•æ¥æºçš„æ¼æ´åˆ©ç”¨ä»£ç è¿›è¡Œå®¡æŸ¥ï¼Œä»¥é™ä½é£é™©ã€‚
å¯¹ä¸‹è½½çš„æ–‡ä»¶è¿›è¡Œæ£€æŸ¥ï¼Œå¦‚å“ˆå¸Œæ ¡éªŒï¼Œå¯ä»¥æœ€å¤§ç¨‹åº¦çš„é¿å…å¼•å…¥æ¶æ„ä»£ç ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**

æ ¹æ®æ¼æ´æè¿°å’Œåˆ©ç”¨ä»£ç ï¼Œè¯¥æ¼æ´åˆ©ç”¨æ˜¯æœ‰æ•ˆçš„ã€‚åˆ©ç”¨ä»£ç é€šè¿‡OverlayFSçš„æ¼æ´ï¼Œå…è®¸ä½æƒé™ç”¨æˆ·è·å¾—rootæƒé™ã€‚

**å…¶ä»–ä¿¡æ¯:**
CISA å·²å°†æ­¤æ¼æ´æ·»åŠ åˆ°å·²çŸ¥è¢«åˆ©ç”¨çš„æ¼æ´ç›®å½• (KEV) ä¸­ï¼Œè¡¨æ˜è¯¥æ¼æ´å·²è¢«å¹¿æ³›åˆ©ç”¨ã€‚

**é¡¹ç›®åœ°å€:** [fathallah17/OverlayFS-CVE-2021-3493](https://github.com/fathallah17/OverlayFS-CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #7

**æ¥æº**: [CVE-2021-3493-fei9747_CVE-2021-3493.md](../2021/CVE-2021-3493-fei9747_CVE-2021-3493.md)

## CVE-2021-3493 Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ”»å‡»è€…å¯åˆ©ç”¨æ­¤æ¼æ´è·å– root æƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu kernel versions: < 5.8.0-50.56, < 5.4.0-72.80, < 4.15.0-142.146, < 4.4.0-209.241

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦åœ¨å­˜åœ¨æ¼æ´çš„ Ubuntu ç³»ç»Ÿä¸Šæœ¬åœ°æ‰§è¡Œ

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 5%

## è¯¦æƒ…

CVE-2021-3493 æ˜¯ä¸€ä¸ªå­˜åœ¨äº Ubuntu Linux å†…æ ¸ overlayfs å®ç°ä¸­çš„æœ¬åœ°ææƒæ¼æ´ã€‚è¯¥æ¼æ´æºäº overlayfs æœªèƒ½æ­£ç¡®éªŒè¯ç”¨æˆ·å‘½åç©ºé—´ä¸­åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸Šæ–‡ä»¶ capabilities çš„è®¾ç½®ã€‚ç»“åˆæœªæˆæƒç”¨æˆ·å‘½åç©ºé—´ä»¥åŠ Ubuntu å†…æ ¸ä¸­å…è®¸æœªæˆæƒ overlay mount çš„è¡¥ä¸ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´æå‡æƒé™ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼ŒåŒ…æ‹¬lowerdirï¼Œupperdirï¼Œworkdirå’Œmergedirã€‚
2.  **åˆ›å»ºå‘½åç©ºé—´ï¼š** ä½¿ç”¨ `unshare` ç³»ç»Ÿè°ƒç”¨åˆ›å»ºæ–°çš„ç”¨æˆ·å‘½åç©ºé—´å’ŒæŒ‚è½½å‘½åç©ºé—´ã€‚
3.  **è®¾ç½®ç”¨æˆ·å’Œç»„IDæ˜ å°„ï¼š** å°†å½“å‰ç”¨æˆ·çš„ UID å’Œ GID æ˜ å°„åˆ°æ–°çš„ç”¨æˆ·å‘½åç©ºé—´ä¸­ï¼Œä»¥ä¾¿åœ¨æ–°çš„å‘½åç©ºé—´ä¸­æ‹¥æœ‰æƒé™ã€‚
4.  **æŒ‚è½½ OverlayFSï¼š** ä½¿ç”¨ `mount` ç³»ç»Ÿè°ƒç”¨ï¼Œå°† overlayfs æŒ‚è½½åˆ° mergedirï¼Œå¹¶å°† lowerdirï¼Œupperdir å’Œ workdir æŒ‡å®šä¸ºç›¸åº”çš„ç›®å½•ã€‚
5.  **è®¾ç½® Capabilitiesï¼š** å¤åˆ¶å½“å‰æ‰§è¡Œçš„ç¨‹åºåˆ° mergedirï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½®è¯¥æ–‡ä»¶çš„ capabilitiesï¼Œä½¿å…¶å…·æœ‰ root æƒé™ã€‚ è¿™æ­¥æ˜¯æ¼æ´åˆ©ç”¨çš„å…³é”®ã€‚
6.  **æ‰§è¡ŒPayloadï¼š** æ‰§è¡Œupperç›®å½•ä¸­çš„æ–‡ä»¶ï¼Œå› ä¸ºè®¾ç½®äº†Capabilitiesï¼Œå¯ä»¥è·å¾—rootæƒé™ã€‚

**æœ‰æ•ˆæ€§ï¼š**

æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’ŒPOCä»£ç æè¿°ï¼Œè¯¥æ¼æ´åœ¨ç‰¹å®šç‰ˆæœ¬çš„ Ubuntu å†…æ ¸ä¸Šæ˜¯å¯åˆ©ç”¨çš„ã€‚æä¾›çš„POCä»£ç å±•ç¤ºäº†åˆ©ç”¨è¯¥æ¼æ´æå‡æƒé™çš„å®Œæ•´è¿‡ç¨‹ã€‚

**æŠ•æ¯’é£é™©ï¼š**

ä»£ç ä¸­å­˜åœ¨æ½œåœ¨çš„æŠ•æ¯’é£é™©ï¼Œä½†æ˜¯é£é™©è¾ƒä½ã€‚ä¸»è¦é›†ä¸­åœ¨ç¼–è¯‘å’Œè¿è¡Œexploitæ—¶ã€‚æ”»å‡»è€…å¯èƒ½é€šè¿‡ä¿®æ”¹ exploit.c æ–‡ä»¶ï¼Œä¾‹å¦‚æ·»åŠ æ¶æ„ä»£ç æˆ–åé—¨ï¼Œä»è€Œåœ¨ç›®æ ‡ç³»ç»Ÿä¸Šæ‰§è¡Œæ¶æ„æ“ä½œã€‚ä½†æ˜¯æ ¹æ®æä¾›çš„POCä»£ç æ¥çœ‹, é£é™©ç³»æ•°è¾ƒä½.

**é£é™©è¯„ä¼°ï¼š**

è¯¥æ¼æ´åˆ©ç”¨çš„æˆåŠŸå–å†³äºç›®æ ‡ç³»ç»Ÿæ˜¯å¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š

*   è¿è¡Œå—å½±å“çš„ Ubuntu å†…æ ¸ç‰ˆæœ¬ã€‚
*   å¯ç”¨äº†æœªæˆæƒç”¨æˆ·å‘½åç©ºé—´å’Œ overlayfs mountã€‚
*   ç›®æ ‡ç³»ç»Ÿä¸Šå­˜åœ¨ `gcc` ç¼–è¯‘å™¨, èƒ½å¤Ÿç¼–è¯‘exploitã€‚

å¦‚æœç›®æ ‡ç³»ç»Ÿæ»¡è¶³è¿™äº›æ¡ä»¶ï¼Œæ”»å‡»è€…å¯ä»¥ä½¿ç”¨æä¾›çš„ POC ä»£ç æˆåŠŸåˆ©ç”¨è¯¥æ¼æ´ï¼Œä»è€Œè·å¾— root æƒé™ã€‚


**é¡¹ç›®åœ°å€:** [fei9747/CVE-2021-3493](https://github.com/fei9747/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #8

**æ¥æº**: [CVE-2021-3493-iamz24_CVE-2021-3493_CVE-2022-3357.md](../2021/CVE-2021-3493-iamz24_CVE-2021-3493_CVE-2022-3357.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒæ¼æ´

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å¯¼è‡´æœ¬åœ°æƒé™æå‡è‡³ root

**å½±å“ç‰ˆæœ¬:** Ubuntu kernels < 5.8.0-50.56, < 5.4.0-72.80, < 4.15.0-142.146, < 4.4.0-209.241

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç›®æ ‡ç³»ç»Ÿå¼€å¯ unprivileged user namespaces å’Œå­˜åœ¨ OverlayFS æœåŠ¡ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2021-3493 æ¼æ´æ˜¯ Linux å†…æ ¸ overlayfs å®ç°ä¸­ï¼Œåœ¨ç”¨æˆ·å‘½åç©ºé—´ä¸­å¯¹åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­çš„æ–‡ä»¶ capabilities éªŒè¯ä¸å½“å¯¼è‡´çš„ã€‚ç”±äº Ubuntu å†…æ ¸ä¸­å­˜åœ¨å…è®¸éç‰¹æƒ overlay æŒ‚è½½çš„è¡¥ä¸ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¯¥æ¼æ´æå‡æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** æ£€æŸ¥ç›®æ ‡ç³»ç»Ÿæ˜¯å¦å­˜åœ¨ overlayfs æœåŠ¡ï¼Œå¦‚æœæ²¡æœ‰åˆ™åŠ è½½ overlay æ¨¡å—ã€‚åŒæ—¶ï¼Œç¡®ä¿å¼€å¯äº† unprivileged user namespacesã€‚
2.  **ç¼–è¯‘ Payloadï¼š** ä½¿ç”¨ GCC ç¼–è¯‘æä¾›çš„ `payload.c` æ–‡ä»¶ã€‚
3.  **è¿è¡Œ Payloadï¼š** è¿è¡Œç¼–è¯‘åçš„å¯æ‰§è¡Œæ–‡ä»¶ `a.out`ã€‚
4.  **è·å– Root Shellï¼š** Payload ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å‘½åç©ºé—´ï¼ŒæŒ‚è½½ overlayfsï¼Œè®¾ç½® capabilityï¼Œæœ€ç»ˆæ‰§è¡Œä¸€ä¸ªå…·æœ‰ root æƒé™çš„ shellã€‚

**æœ‰æ•ˆæ€§ï¼š**

æä¾›çš„ POC ä»£ç åŸºæœ¬æœ‰æ•ˆï¼Œèƒ½å¤Ÿåˆ©ç”¨è¯¥æ¼æ´åœ¨ç¬¦åˆæ¡ä»¶çš„ Ubuntu ç³»ç»Ÿä¸Šå®ç°æœ¬åœ°ææƒã€‚

**æŠ•æ¯’é£é™©ï¼š**

å­˜åœ¨è¾ƒä½çš„æŠ•æ¯’é£é™©ï¼ˆ10%ï¼‰ã€‚è™½ç„¶ä»£ç çš„ä¸»è¦åŠŸèƒ½æ˜¯å®ç°ææƒï¼Œä½†ä»ç„¶éœ€è¦è°¨æ…å¯¹å¾…æ¥æºä¸æ˜çš„ä»£ç ï¼Œä½œè€…å¯èƒ½ä¼šåœ¨å…¶ä¸­éšè—ä¸€äº›æ¶æ„è¡Œä¸ºï¼Œæ¯”å¦‚ä¸Šä¼ æ•æ„Ÿä¿¡æ¯ç­‰ã€‚ç‰¹åˆ«æ˜¯éœ€è¦æ£€æŸ¥ `exploit`å‡½æ•°ä¸­çš„ç›¸å…³æ–‡ä»¶æ“ä½œå’Œå‘½ä»¤æ‰§è¡Œæ˜¯å¦å­˜åœ¨æ¶æ„è¡Œä¸ºã€‚å°¤å…¶å…³æ³¨`system(buf);`æ˜¯å¦ä¼šæ‰§è¡Œæ¶æ„çš„æŒ‡ä»¤ã€‚

**æ€»ç»“ï¼š**

è¯¥æ¼æ´åˆ©ç”¨è¾ƒä¸ºç›´æ¥ï¼Œåˆ©ç”¨æ¡ä»¶ç›¸å¯¹æ˜ç¡®ï¼Œä½†éœ€è¦æ³¨æ„æ½œåœ¨çš„æŠ•æ¯’é£é™©ã€‚åœ¨å®é™…ä½¿ç”¨æ—¶ï¼Œåº”è¯¥ä»”ç»†å®¡æŸ¥ä»£ç ï¼Œç¡®ä¿æ²¡æœ‰æ¶æ„è¡Œä¸ºã€‚

**é¡¹ç›®åœ°å€:** [iamz24/CVE-2021-3493_CVE-2022-3357](https://github.com/iamz24/CVE-2021-3493_CVE-2022-3357)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #9

**æ¥æº**: [CVE-2021-3493-inspiringz_CVE-2021-3493.md](../2021/CVE-2021-3493-inspiringz_CVE-2021-3493.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Ubuntu Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸ä½æƒé™ç”¨æˆ·æå‡åˆ°rootæƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu 4.4, 4.15, 5.4, 5.8 kernels (å—å½±å“ç‰ˆæœ¬è¯¦è§æ¼æ´åº“ä¿¡æ¯)

**åˆ©ç”¨æ¡ä»¶:** Ubuntuå†…æ ¸ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…ï¼Œå¯ç”¨æœªæˆæƒç”¨æˆ·å‘½åç©ºé—´ï¼Œå…è®¸æœªæˆæƒOverlayFSæŒ‚è½½ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 5%

## è¯¦æƒ…

CVE-2021-3493æ˜¯Ubuntuå†…æ ¸ä¸­OverlayFSå®ç°çš„ä¸€ä¸ªæ¼æ´ï¼Œå…è®¸ä½æƒé™ç”¨æˆ·é€šè¿‡åˆ©ç”¨user namespaceå’ŒOverlayFSæŒ‚è½½ç»•è¿‡æ–‡ä»¶ç³»ç»Ÿæƒé™æ£€æŸ¥æ¥æå‡æƒé™ã€‚ 

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡:** æ¼æ´åˆ©ç”¨éœ€è¦å­˜åœ¨Ubuntuç³»ç»Ÿï¼Œä¸”å†…æ ¸ç‰ˆæœ¬åœ¨æ¼æ´åº“ä¿¡æ¯ä¸­æè¿°çš„å—å½±å“èŒƒå›´å†…ï¼Œå¹¶ä¸”éœ€è¦å¯ç”¨æœªæˆæƒç”¨æˆ·å‘½åç©ºé—´(unprivileged user namespaces)ã€‚æ­¤å¤–ï¼Œä¸ºäº†åˆ©ç”¨OverlayFSï¼Œç³»ç»Ÿéœ€è¦é…ç½®å…è®¸æœªæˆæƒç”¨æˆ·è¿›è¡ŒOverlayFSæŒ‚è½½ã€‚
2.  **æ¼æ´åˆ©ç”¨:**  æ”»å‡»è€…é¦–å…ˆåˆ›å»ºä¸€ä¸ªåŒ…å«lower, upper, workç›®å½•çš„OverlayFSç»“æ„ã€‚
3.  **åˆ©ç”¨è¿‡ç¨‹:** åˆ©ç”¨`unshare`ç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€ä¸ªæ–°çš„user namespaceå’Œmount namespaceã€‚ åœ¨æ–°namespaceä¸­ï¼Œå°†è‡ªå·±çš„UIDå’ŒGIDæ˜ å°„åˆ°rootæƒé™ã€‚ ç„¶åï¼Œä½¿ç”¨æ„é€ çš„lowerdirã€upperdirå’ŒworkdiræŒ‚è½½OverlayFSæ–‡ä»¶ç³»ç»Ÿã€‚ æ”»å‡»è€…å°†ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶å¤åˆ¶åˆ°OverlayFSçš„mergeç›®å½•ä¸­ã€‚å…³é”®çš„ä¸€æ­¥æ˜¯ï¼Œæ”»å‡»è€…ä½¿ç”¨`setxattr`ç³»ç»Ÿè°ƒç”¨ï¼Œè®¾ç½®è¯¥å¯æ‰§è¡Œæ–‡ä»¶çš„`security.capability`æ‰©å±•å±æ€§ï¼Œèµ‹äºˆå®ƒ`CAP_SETUID`å’Œ`CAP_SETGID`èƒ½åŠ›ã€‚ ç”±äºOverlayFSçš„æƒé™éªŒè¯ä¸å®Œå–„ï¼Œè¿™ä¸ªæ“ä½œå³ä½¿åœ¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´ä¸­ä¹Ÿèƒ½æˆåŠŸã€‚å½“æ‰§è¡Œè¯¥æ–‡ä»¶æ—¶ï¼Œå®ƒå°†è·å¾—rootæƒé™ï¼Œå¹¶å¯ä»¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚
4.  **POCä»£ç åˆ†æ:** `exploit.c` ä»£ç é¦–å…ˆåˆ›å»ºä¸€ä¸ªoverlayfsç›®å½•ç»“æ„ã€‚ç„¶åï¼Œä½¿ç”¨ `unshare` ç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€ä¸ªæ–°çš„ user namespace å’Œ mount namespaceï¼Œå¹¶å°†å½“å‰ç”¨æˆ·çš„ uid å’Œ gid æ˜ å°„åˆ° root ç”¨æˆ·ã€‚ ä¹‹åï¼Œå®ƒæŒ‚è½½ overlayfsï¼Œå¤åˆ¶å½“å‰æ‰§è¡Œçš„ç¨‹åºåˆ° overlayfs çš„ merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½® capabilityã€‚æœ€åï¼Œæ‰§è¡Œå¤åˆ¶åˆ° overlayfs çš„ç¨‹åºã€‚
5. **æŠ•æ¯’é£é™©åˆ†æ:** ä»£ç æœ¬èº«å®ç°äº†æ¼æ´åˆ©ç”¨çš„åŠŸèƒ½ã€‚ æ½œåœ¨çš„æŠ•æ¯’é£é™©å¯èƒ½å­˜åœ¨äºä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š
    *   **ä¾èµ–é¡¹:**  ä»£ç ä¾èµ–äºæ ‡å‡†çš„Cåº“ï¼Œæœ¬èº«ä¸å­˜åœ¨æ¶æ„ä¾èµ–ã€‚ä½†ç”¨æˆ·åœ¨ç¼–è¯‘æ—¶éœ€è¦æ³¨æ„ç¼–è¯‘å™¨ç¯å¢ƒçš„å®‰å…¨æ€§ã€‚
    *   **ä»£ç é€»è¾‘:**  ä»£ç é€»è¾‘ç›¸å¯¹ç®€å•ï¼Œä¸»è¦é›†ä¸­åœ¨namespaceåˆ›å»ºã€æŒ‚è½½å’Œcapabilityè®¾ç½®ã€‚ ä»”ç»†å®¡æŸ¥ä»£ç ï¼Œæœªå‘ç°æ˜æ˜¾çš„æ¶æ„é€»è¾‘ã€‚
    *   **æ‰§è¡Œå‘½ä»¤:**  ä»£ç ä¸­ä½¿ç”¨äº† `system` å‡½æ•°ï¼Œè¿™æ˜¯ä¸€ä¸ªæ½œåœ¨çš„é£é™©ç‚¹ï¼Œå¯ä»¥æ‰§è¡Œä»»æ„ç³»ç»Ÿå‘½ä»¤ã€‚ä½†æ˜¯ï¼Œè¿™é‡Œåªæ˜¯ç”¨æ¥åˆ é™¤ç›®å½•ï¼Œç›¸å¯¹å®‰å…¨ã€‚
       ç»¼ä¸Šæ‰€è¿°ï¼Œè¯¥POCä»£ç ä¸»è¦é£é™©åœ¨äºç¡®ä¿ç¼–è¯‘ç¯å¢ƒå®‰å…¨ä»¥åŠå¯¹ä¸ç†Ÿæ‚‰çš„å‘½ä»¤ä¿æŒè­¦æƒ•ã€‚æŠ•æ¯’é£é™©è¾ƒä½ï¼Œé¢„ä¼°ä¸º5%ã€‚

**æ€»ç»“ï¼š**

è¯¥æ¼æ´åˆ©ç”¨çš„æ ¸å¿ƒåœ¨äºç»“åˆäº†æœªæˆæƒç”¨æˆ·å‘½åç©ºé—´å’ŒOverlayFSï¼Œåˆ©ç”¨OverlayFSå¯¹capabilitiesè®¾ç½®éªŒè¯çš„ç¼ºé™·ï¼Œå®ç°äº†æœ¬åœ°ææƒã€‚ æ”»å‡»è€…é€šè¿‡åˆ›å»ºç‰¹æ®Šçš„OverlayFSç»“æ„å¹¶è®¾ç½®æ–‡ä»¶capabilitiesï¼Œæœ€ç»ˆè·å¾—rootæƒé™ã€‚

**é¡¹ç›®åœ°å€:** [inspiringz/CVE-2021-3493](https://github.com/inspiringz/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #10

**æ¥æº**: [CVE-2021-3493-oneoy_CVE-2021-3493.md](../2021/CVE-2021-3493-oneoy_CVE-2021-3493.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœ¬åœ°ç”¨æˆ·å¯æå‡è‡³ root æƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu 4.4, 4.15, 5.4, and 5.8 kernels (å…·ä½“ç‰ˆæœ¬å·è§æ¼æ´åº“ä¿¡æ¯)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç›®æ ‡ç³»ç»Ÿå­˜åœ¨æœªä¿®å¤çš„ Ubuntu kernelï¼Œä¸”å¯ç”¨ unprivileged user namespaces å’Œå…è®¸ unprivileged overlayfs mountsã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

è¯¥æ¼æ´å­˜åœ¨äº Ubuntu å†…æ ¸çš„ OverlayFS å®ç°ä¸­ï¼Œç”±äºæœªæ­£ç¡®éªŒè¯ç”¨æˆ·å‘½åç©ºé—´ä¸­åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸Šæ–‡ä»¶ capabilities çš„è®¾ç½®ï¼Œå¯¼è‡´æœ¬åœ°æ”»å‡»è€…å¯åˆ©ç”¨ unprivileged user namespaces å’Œ Ubuntu å†…æ ¸ä¸­å…è®¸ unprivileged overlayfs mounts çš„è¡¥ä¸æ¥æå‡æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ (lower, upper, work, merge)ã€‚
2.  **é…ç½® User Namespace:** åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´ã€‚
3.  **é…ç½® OverlayFS:** ä½¿ç”¨ lowerdir, upperdir, å’Œ workdir é€‰é¡¹æŒ‚è½½ overlay æ–‡ä»¶ç³»ç»Ÿã€‚
4.  **è®¾ç½® Capabilities:** å°†å¯æ‰§è¡Œæ–‡ä»¶å¤åˆ¶åˆ° merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½®å…¶ capabilities (å¦‚ CAP_SETUID, CAP_SETGID, CAP_CHOWN)ã€‚
5.  **è§¦å‘ææƒ:** æ‰§è¡Œ merge ç›®å½•ä¸­çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶å°†ä¼šä»¥ root æƒé™æ‰§è¡Œã€‚

**æŠ•æ¯’é£é™©è¯„ä¼°ï¼š**

æä¾›çš„ `exploit.c` ä»£ç ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨ OverlayFS çš„æ¼æ´è¿›è¡Œææƒã€‚ä»£ç åˆ›å»ºå¿…è¦çš„ç›®å½•ï¼Œé…ç½® user namespace å’Œ overlay æ–‡ä»¶ç³»ç»Ÿï¼Œå¹¶è®¾ç½®å¯æ‰§è¡Œæ–‡ä»¶çš„ capabilitiesã€‚ä»£ç é€»è¾‘æ¸…æ™°ï¼Œæ²¡æœ‰å‘ç°æ¶æ„ä»£ç æˆ–åé—¨ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**

æä¾›çš„ POC ä»£ç åŸºäºå…¬å¼€ä¿¡æ¯ï¼Œå¹¶é’ˆå¯¹ CVE-2021-3493 æ¼æ´è¿›è¡Œäº†åˆ©ç”¨ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯ã€æœç´¢å¼•æ“ç»“æœå’Œä»£ç åˆ†æï¼Œè¯¥ POC ä»£ç åœ¨æ»¡è¶³æ¼æ´åˆ©ç”¨æ¡ä»¶çš„æƒ…å†µä¸‹åº”è¯¥æ˜¯æœ‰æ•ˆçš„ã€‚

**é¡¹ç›®åœ°å€:** [oneoy/CVE-2021-3493](https://github.com/oneoy/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #11

**æ¥æº**: [CVE-2021-3493-pmihsan_OverlayFS-CVE-2021-3493.md](../2021/CVE-2021-3493-pmihsan_OverlayFS-CVE-2021-3493.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœ¬åœ°ç”¨æˆ·å¯æå‡è‡³ root æƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu kernel versions: < 5.8.0-50.56 (5.8 kernel), < 5.4.0-72.80 (5.4 kernel), < 4.15.0-142.146 (4.15 kernel), < 4.4.0-209.241 (4.4 kernel)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦åœ¨å­˜åœ¨æ¼æ´çš„ Ubuntu ç³»ç»Ÿä¸Šæ‰§è¡Œï¼Œå¹¶ä¸”å…è®¸ unprivileged user namespaces å’Œ overlay mountsã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

CVE-2021-3493 æ¼æ´å­˜åœ¨äº Linux å†…æ ¸çš„ overlayfs å®ç°ä¸­ã€‚ç”±äºå¯¹ç”¨æˆ·å‘½åç©ºé—´ä¸­åº•å±‚æ–‡ä»¶ç³»ç»Ÿæ–‡ä»¶ capabilities çš„éªŒè¯ä¸è¶³ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡åˆ›å»ºæ¶æ„çš„ overlayfs æ–‡ä»¶ç³»ç»Ÿï¼Œåˆ©ç”¨ setxattr è®¾ç½®æ–‡ä»¶ capabilitiesï¼Œä»è€Œè·å¾—æå‡çš„æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** åˆ›å»º overlayfs æ‰€éœ€çš„ç›®å½•ç»“æ„ (lower, upper, work, merge)ã€‚
2.  **Namespace åˆ›å»ºï¼š** åˆ›å»ºæ–°çš„ user namespace å’Œ mount namespaceï¼Œéš”ç¦»æƒé™ã€‚
3.  **æƒé™è®¾ç½®ï¼š** ä¿®æ”¹ uid_map å’Œ gid_mapï¼Œä½¿å¾—åœ¨ user namespace ä¸­æ‹¥æœ‰ root æƒé™ã€‚
4.  **Overlayfs Mountï¼š** ä½¿ç”¨ overlayfs mount å‘½ä»¤å°† lowerdir, upperdir, workdir æŒ‚è½½åˆ° mergedirã€‚
5.  **Capabilities è®¾ç½®ï¼š** å¤åˆ¶è‡ªèº«ç¨‹åºåˆ° merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` å‡½æ•°ä¸ºå¤åˆ¶åçš„ç¨‹åºè®¾ç½® capabilities (CAP_SETUID, CAP_SETGID, CAP_DAC_OVERRIDE ç­‰)ã€‚
6.  **æƒé™æå‡ï¼š** æ‰§è¡Œ merge ç›®å½•ä¸‹çš„ç¨‹åºï¼Œæ­¤æ—¶ç¨‹åºå°†ä»¥ root æƒé™è¿è¡Œã€‚

**æœ‰æ•ˆæ€§ï¼š**

æä¾›çš„ POC ä»£ç é€šè¿‡åˆ©ç”¨ overlayfs æ¼æ´ï¼Œå¯ä»¥æˆåŠŸåœ°æå‡æƒé™ã€‚POC ä»£ç é¦–å…ˆåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼Œç„¶ååˆ›å»ºä¸€ä¸ªæ–°çš„ user namespace å’Œ mount namespaceï¼Œæ¥ç€æŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿï¼Œå¹¶ä½¿ç”¨ `setxattr` å‡½æ•°ä¸ºæ–‡ä»¶è®¾ç½® capabilitiesã€‚æœ€åï¼Œæ‰§è¡Œè¯¥æ–‡ä»¶å³å¯è·å¾— root æƒé™ã€‚

**æŠ•æ¯’é£é™©ï¼š**

åˆ†æ POC ä»£ç ï¼Œæ²¡æœ‰å‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç ï¼Œä¾‹å¦‚åå¼¹ shellã€å®‰è£…åé—¨ç­‰ã€‚ä»£ç é€»è¾‘ä¸»è¦é›†ä¸­åœ¨åˆ©ç”¨ overlayfs æ¼æ´ææƒï¼Œå¹¶æ²¡æœ‰é¢å¤–çš„æ“ä½œæ¥æ¤å…¥æ¶æ„ç¨‹åºã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ï¼Œå¯ä»¥è®¤ä¸ºæ˜¯ 0%ã€‚å‚è€ƒçš„ vulnerability description å’Œ exploit ä»£ç éƒ½ç€é‡äºææƒï¼Œè€Œæ²¡æœ‰æåˆ°ä»»ä½•æŠ•æ¯’è¡Œä¸ºã€‚

**é¡¹ç›®åœ°å€:** [pmihsan/OverlayFS-CVE-2021-3493](https://github.com/pmihsan/OverlayFS-CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #12

**æ¥æº**: [CVE-2021-3493-ptkhai15_OverlayFS---CVE-2021-3493.md](../2021/CVE-2021-3493-ptkhai15_OverlayFS---CVE-2021-3493.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Ubuntu Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœ¬åœ°ç”¨æˆ·æå‡æƒé™è‡³ root

**å½±å“ç‰ˆæœ¬:** Ubuntu kernel versions 5.8, 5.4, 4.15, å’Œ 4.4 ä¸­å—å½±å“çš„ç‰ˆæœ¬ï¼ˆå…·ä½“ç‰ˆæœ¬å‚è§æ¼æ´åº“ä¿¡æ¯ï¼‰

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡ç³»ç»Ÿå¿…é¡»æ˜¯å—å½±å“çš„ Ubuntu ç‰ˆæœ¬ï¼Œå¹¶ä¸”å¯ç”¨äº†éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å’Œéç‰¹æƒ overlayfs æŒ‚è½½ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

CVE-2021-3493 æ˜¯ Ubuntu Linux å†…æ ¸ä¸­ OverlayFS å®ç°ä¸­çš„ä¸€ä¸ªæ¼æ´ã€‚è¯¥æ¼æ´å…è®¸éç‰¹æƒç”¨æˆ·åˆ©ç”¨ç”¨æˆ·å‘½åç©ºé—´å’Œéç‰¹æƒ overlayfs æŒ‚è½½ï¼Œé€šè¿‡ä¸æ­£ç¡®åœ°éªŒè¯åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­æ–‡ä»¶çš„ capabilities è®¾ç½®æ¥æå‡æƒé™ã€‚åˆ©ç”¨æ–¹å¼å¦‚ä¸‹ï¼š

1.  **ç¯å¢ƒå‡†å¤‡ï¼š**  åˆ›å»ºä¸€ä¸ªåŸºç¡€ç›®å½•ç»“æ„ï¼ŒåŒ…æ‹¬ workã€lowerã€upper å’Œ merge ç›®å½•ï¼Œè¿™æ˜¯ overlayfs çš„æ ‡å‡†é…ç½®ã€‚
2.  **åˆ›å»ºç”¨æˆ·å‘½åç©ºé—´ï¼š**  ä½¿ç”¨ `unshare` å‘½ä»¤åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´ã€‚è¿™å…è®¸åœ¨æ–°çš„å‘½åç©ºé—´ä¸­æ‹¥æœ‰ä¸åŒçš„ç”¨æˆ·å’Œç»„ IDã€‚
3.  **é…ç½®ç”¨æˆ·å’Œç»„æ˜ å°„ï¼š**  é€šè¿‡ `/proc/self/setgroups`ã€`/proc/self/uid_map` å’Œ `/proc/self/gid_map` æ–‡ä»¶è®¾ç½®ç”¨æˆ·å’Œç»„ ID æ˜ å°„ï¼Œå°†å½“å‰ç”¨æˆ·çš„ UID å’Œ GID æ˜ å°„åˆ°æ–°å‘½åç©ºé—´ä¸­çš„ root ç”¨æˆ·ã€‚
4.  **æŒ‚è½½ OverlayFSï¼š**  ä½¿ç”¨ `mount` å‘½ä»¤æŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿï¼Œå°† lowerã€upper å’Œ work ç›®å½•å…³è”èµ·æ¥ã€‚
5.  **è®¾ç½®æ–‡ä»¶ capabilitiesï¼š**  å¤åˆ¶å½“å‰æ‰§è¡Œç¨‹åºåˆ° overlayfs çš„ merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½®æ–‡ä»¶çš„ capabilities ä¸º `all+ep`ï¼Œå…è®¸è¯¥æ–‡ä»¶æ‰§è¡Œæ—¶æ‹¥æœ‰ root æƒé™ã€‚
6.  **æ‰§è¡Œææƒåçš„ç¨‹åºï¼š**  æ‰§è¡Œä½äº upper ç›®å½•ä¸­çš„å¤åˆ¶åçš„ç¨‹åºã€‚å¦‚æœç¨‹åºæ£€æµ‹åˆ°è‡ªå·±æ˜¯é€šè¿‡ç‰¹å®šæ–¹å¼ï¼ˆä¾‹å¦‚ï¼ŒåŒ…å« "magic" å­—ç¬¦ä¸²æˆ–æ¥å— "shell" å‚æ•°ï¼‰è°ƒç”¨çš„ï¼Œå®ƒä¼šè°ƒç”¨ `setuid(0)` å’Œ `setgid(0)` å°†è¿›ç¨‹çš„ UID å’Œ GID è®¾ç½®ä¸º 0 (root)ï¼Œå¹¶å¯åŠ¨ä¸€ä¸ª root shellã€‚

**å…³äºæŠ•æ¯’é£é™©ï¼š**

åœ¨æä¾›çš„ POC ä»£ç ä¸­ï¼Œæ²¡æœ‰æ˜æ˜¾çš„æŠ•æ¯’ä»£ç ã€‚POC çš„ç›®çš„æ˜¯æ¼”ç¤ºæ¼æ´åˆ©ç”¨è¿‡ç¨‹ï¼Œæ²¡æœ‰å‘ç°æ¶æ„è¡Œä¸ºï¼Œä¾‹å¦‚åå‘ shell æˆ–å…¶ä»–æœªç»æˆæƒçš„è®¿é—®ã€‚


**é¡¹ç›®åœ°å€:** [ptkhai15/OverlayFS---CVE-2021-3493](https://github.com/ptkhai15/OverlayFS---CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #13

**æ¥æº**: [CVE-2021-3493-puckiestyle_CVE-2021-3493.md](../2021/CVE-2021-3493-puckiestyle_CVE-2021-3493.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ”»å‡»è€…å¯åˆ©ç”¨æ­¤æ¼æ´è·å¾— root æƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu 5.8 kernel (< 5.8.0-50.56), 5.4 kernel (< 5.4.0-72.80), 4.15 kernel (< 4.15.0-142.146), 4.4 kernel (< 4.4.0-209.241)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ Ubuntu ç³»ç»Ÿå¼€å¯ unprivileged user namespaces å’Œå…è®¸ unprivileged overlay mounts

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2021-3493 æ˜¯ Ubuntu å†…æ ¸ overlayfs å®ç°ä¸­çš„ä¸€ä¸ªæ¼æ´ï¼Œå…è®¸æœ¬åœ°æ”»å‡»è€…é€šè¿‡æ»¥ç”¨ user namespaces å’Œ overlayfs æŒ‚è½½æœºåˆ¶æå‡æƒé™ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**
æä¾›çš„ POC ä»£ç å°è¯•åˆ©ç”¨è¯¥æ¼æ´ï¼Œé€šè¿‡åˆ›å»º user namespace å’Œ overlayfs æ–‡ä»¶ç³»ç»Ÿæ¥è®¾ç½®å¯æ‰§è¡Œæ–‡ä»¶çš„ capability ä½ï¼Œä½¿å…¶è·å¾— root æƒé™ã€‚ æ¼æ´åº“ä¿¡æ¯,æœç´¢å¼•æ“ç»“æœå’Œæ¼æ´åˆ©ç”¨ä»£ç ä¸€è‡´,è¡¨æ˜è¯¥æ¼æ´çš„POCæ˜¯çœŸå®æœ‰æ•ˆçš„ã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**
æŸ¥çœ‹ `exploit.c` ä»£ç ï¼Œä¸»è¦æ“ä½œåŒ…æ‹¬åˆ›å»ºç›®å½•ã€è®¾ç½® user namespaceã€æŒ‚è½½ overlayfsã€å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶ã€è®¾ç½® capability å±æ€§ï¼Œä»¥åŠæ‰§è¡Œå¤åˆ¶åçš„æ–‡ä»¶ä»¥è·å¾— root æƒé™ã€‚ä»£ç é€»è¾‘è¾ƒä¸ºæ¸…æ™°ï¼Œæœªå‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç ã€‚`README.md` ä¹Ÿè¯´æ˜äº†å¹¶éä½œè€…åŸåˆ›,åªæ˜¯æ¬è¿,å¢åŠ äº†åˆ†æéš¾åº¦.
`exploit.c`ä¸­å­˜åœ¨`system(buf);` è°ƒç”¨ï¼Œè™½ç„¶è¿™é‡Œæ˜¯ç”¨äºæ¸…ç†ç›®å½•ï¼Œä½†å¦‚æœè¢«ç¯¡æ”¹ï¼Œå¯èƒ½æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£é™©è¯„ä¼°ä¸º10%ã€‚ä¸»è¦çš„é£é™©åœ¨äºï¼š

*   `system()` å‡½æ•°æ½œåœ¨çš„å‘½ä»¤æ³¨å…¥é£é™©ï¼Œå¦‚æœä»£ç è¢«ä¿®æ”¹ï¼Œå¯èƒ½å¯¼è‡´æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  åˆ©ç”¨ unshare() åˆ›å»ºä¸€ä¸ªæ–°çš„ user namespace å’Œ mount namespaceã€‚
2.  é…ç½® user namespace çš„ uid_map å’Œ gid_mapï¼Œå°†å½“å‰ç”¨æˆ·æ˜ å°„ä¸º root ç”¨æˆ·ã€‚
3.  åˆ›å»º overlayfs æ‰€éœ€çš„ç›®å½•ç»“æ„ï¼ˆlowerdirã€upperdirã€workdirã€mergedï¼‰ã€‚
4.  æŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿã€‚
5.  å°†æ¼æ´åˆ©ç”¨ç¨‹åºè‡ªèº«å¤åˆ¶åˆ° overlayfs çš„ upperdir/merged ç›®å½•ã€‚
6.  ä½¿ç”¨ setxattr() è®¾ç½®å¤åˆ¶åçš„å¯æ‰§è¡Œæ–‡ä»¶çš„ security.capability å±æ€§ï¼Œèµ‹äºˆå…¶ CAP_SETUID å’Œ CAP_SETGID æƒé™ã€‚
7.  æ‰§è¡Œå¤åˆ¶åçš„ç¨‹åºï¼Œç”±äºè®¾ç½®äº† capabilityï¼Œè¯¥ç¨‹åºä¼šä»¥ root æƒé™è¿è¡Œï¼Œä»è€Œè·å¾— root shellã€‚

**é¡¹ç›®åœ°å€:** [puckiestyle/CVE-2021-3493](https://github.com/puckiestyle/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #14

**æ¥æº**: [CVE-2021-3493-smallkill_CVE-2021-3493.md](../2021/CVE-2021-3493-smallkill_CVE-2021-3493.md)

# CVE-2021-3493

> ğŸ“¦ è¯¥CVEæœ‰ **15** ä¸ªç›¸å…³POCä»“åº“

---

## POC #1

**æ¥æº**: [CVE-2021-3493-Abdennour-py_CVE-2021-3493.md](../2021/CVE-2021-3493-Abdennour-py_CVE-2021-3493.md)

## CVE-2021-3493 Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å¯¼è‡´æ™®é€šç”¨æˆ·æå‡ä¸ºrootæƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu 5.8 kernel < 5.8.0-50.56, 5.4 kernel < 5.4.0-72.80, 4.15 kernel < 4.15.0-142.146, 4.4 kernel < 4.4.0-209.241

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç›®æ ‡ç³»ç»Ÿè¿è¡Œå—å½±å“çš„Ubuntuå†…æ ¸ï¼Œå¹¶ä¸”å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿå’Œä½¿ç”¨user namespace

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

è¯¥æ¼æ´æºäºUbuntuå†…æ ¸ä¸­overlayfså®ç°å¯¹ç”¨æˆ·å‘½åç©ºé—´ä¸­çš„æ–‡ä»¶èƒ½åŠ›éªŒè¯ä¸å½“ã€‚ç»“åˆéç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å’ŒUbuntuå†…æ ¸ä¸­çš„å…è®¸éç‰¹æƒ overlayfs æŒ‚è½½çš„è¡¥ä¸ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´è·å¾—æå‡çš„æƒé™ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**

æä¾›çš„POCä»£ç çœ‹èµ·æ¥æ˜¯æœ‰æ•ˆçš„ã€‚å®ƒåˆ©ç”¨äº† overlayfs å’Œ user namespace çš„ç»„åˆæ¥è®¾ç½®æ–‡ä»¶ capabilityï¼Œä»è€Œå®ç°ææƒã€‚ä»£ç é¦–å…ˆåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼ˆlower, upper, work, mergeï¼‰ï¼Œç„¶åä½¿ç”¨ `unshare` åˆ›å»ºä¸€ä¸ªæ–°çš„ user namespace å’Œ mount namespaceã€‚æ¥ç€ï¼Œå®ƒå†™å…¥ `/proc/self/setgroups`, `/proc/self/uid_map`, å’Œ `/proc/self/gid_map` æ¥è®¾ç½®ç”¨æˆ·å’Œç»„çš„æ˜ å°„ã€‚ç„¶åï¼ŒæŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿï¼Œæ‹·è´è‡ªèº«å¯æ‰§è¡Œæ–‡ä»¶åˆ° overlayfs çš„ merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½® capabilitiesã€‚æœ€åï¼Œå®ƒæ‰§è¡Œä½äº upper ç›®å½•çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶ä¼šå°è¯•ä»¥ root æƒé™æ‰§è¡Œ /bin/bashã€‚

æ ¹æ®æ¼æ´åº“ä¿¡æ¯ï¼ŒCISA å°†æ­¤æ¼æ´æ·»åŠ åˆ°å·²çŸ¥è¢«åˆ©ç”¨çš„æ¼æ´åˆ—è¡¨ä¸­ï¼Œè¿›ä¸€æ­¥è¡¨æ˜äº†è¯¥æ¼æ´çš„æœ‰æ•ˆæ€§ã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

æ£€æŸ¥æä¾›çš„ exploit.c ä»£ç ï¼Œæ²¡æœ‰å‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç æˆ–åé—¨ã€‚ä»£ç é€»è¾‘æ¸…æ™°ï¼Œä¸»è¦æ‰§è¡Œäº† overlayfs çš„æŒ‚è½½ï¼Œæ–‡ä»¶å¤åˆ¶ï¼Œè®¾ç½® xattr å’Œæ‰§è¡Œ shell æ“ä½œã€‚ä»£ç çš„æ„å›¾ä¸æ¼æ´æè¿°ä¸€è‡´ï¼Œæ²¡æœ‰å‘ç°éšè—çš„ã€ä¸æ¼æ´åˆ©ç”¨æ— å…³çš„æ¶æ„è¡Œä¸ºã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£é™©ä¸º 0%ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š**  åœ¨å­˜åœ¨æ¼æ´çš„Ubuntuç³»ç»Ÿä¸Šï¼Œåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ (ovlcap/work, ovlcap/lower, ovlcap/upper, ovlcap/merge)ã€‚
2.  **User Namespaceå’ŒMount Namespaceï¼š** ä½¿ç”¨ `unshare` ç³»ç»Ÿè°ƒç”¨åˆ›å»ºæ–°çš„ user namespace å’Œ mount namespaceã€‚
3.  **IDæ˜ å°„ï¼š**  é…ç½® `/proc/self/setgroups`ï¼Œ`/proc/self/uid_map` å’Œ `/proc/self/gid_map`ï¼Œä»¥ä¾¿åœ¨ user namespace ä¸­è·å¾—æœ‰æ•ˆçš„ç”¨æˆ· ID å’Œç»„ IDã€‚
4.  **OverlayFSæŒ‚è½½ï¼š**  ä½¿ç”¨ `mount` ç³»ç»Ÿè°ƒç”¨æŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿï¼Œå°† lower, upper å’Œ work ç›®å½•å…³è”èµ·æ¥ã€‚
5.  **æ–‡ä»¶æ‹·è´ä¸ Capability è®¾ç½®ï¼š**  å°† exploit ç¨‹åºè‡ªèº«æ‹·è´åˆ° overlayfs çš„ merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½® `security.capability` å±æ€§ï¼Œèµ‹äºˆå…¶ CAP_SETUID å’Œ CAP_SETGID ç­‰æƒé™ã€‚
6.  **ææƒæ‰§è¡Œï¼š** æ‰§è¡Œä½äº upper ç›®å½•çš„ exploit ç¨‹åºçš„æ‹·è´ã€‚ç”±äºè¯¥æ–‡ä»¶å…·æœ‰ capabilitiesï¼Œå› æ­¤å¯ä»¥ä»¥ root æƒé™æ‰§è¡Œ shellã€‚

**é¡¹ç›®åœ°å€:** [Abdennour-py/CVE-2021-3493](https://github.com/Abdennour-py/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #2

**æ¥æº**: [CVE-2021-3493-Sornphut_OverlayFS---CVE-2021-3493.md](../2021/CVE-2021-3493-Sornphut_OverlayFS---CVE-2021-3493.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒæ¼æ´

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Ubuntu Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœ¬åœ°ç”¨æˆ·è·å¾— root æƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu kernels before 5.8.0-50.56, 5.4.0-72.80, 4.15.0-142.146, and 4.4.0-209.241

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦è¿è¡Œåœ¨å­˜åœ¨æ¼æ´çš„ Ubuntu å†…æ ¸ä¸Šï¼Œå¹¶ä¸”å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½ overlayfsã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

è¯¥æ¼æ´å­˜åœ¨äº Ubuntu Linux å†…æ ¸çš„ overlayfs å®ç°ä¸­ã€‚ç”±äº Ubuntu å¯¹ overlayfs æŒ‚è½½çš„ç‰¹å®šä¿®æ”¹ï¼Œå¯¼è‡´åœ¨ç”¨æˆ·å‘½åç©ºé—´å†…ï¼Œå¯¹åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­çš„æ–‡ä»¶ capabilities éªŒè¯ä¸å……åˆ†ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡ overlayfs æŒ‚è½½ç»•è¿‡ capabilities æ£€æŸ¥ï¼Œè®¾ç½®æ–‡ä»¶ capabilities æå‡æƒé™ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  åˆ›å»ºä¸€ä¸ªç›®å½•ç»“æ„ï¼ŒåŒ…æ‹¬ lower, upper, work å’Œ merge ç›®å½•ã€‚
2.  ä½¿ç”¨ `unshare` åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´å’ŒæŒ‚è½½å‘½åç©ºé—´ã€‚
3.  é…ç½® `/proc/self/setgroups`, `/proc/self/uid_map`, å’Œ `/proc/self/gid_map` ä»¥æ˜ å°„ç”¨æˆ· ID å’Œç»„ IDã€‚
4.  ä½¿ç”¨ `mount` å‘½ä»¤æŒ‚è½½ overlayfsï¼Œå°† lower, upper å’Œ work ç›®å½•ä¸ merge ç›®å½•å…³è”èµ·æ¥ã€‚
5.  åœ¨ upper ç›®å½•æˆ– merge ç›®å½•ä¸‹åˆ›å»ºæˆ–å¤åˆ¶ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ã€‚
6.  ä½¿ç”¨ `setxattr` è®¾ç½®å¯æ‰§è¡Œæ–‡ä»¶çš„ capabilitiesï¼Œèµ‹äºˆå…¶ root æƒé™ã€‚
7.  æ‰§è¡Œè¯¥æ–‡ä»¶ï¼Œå³å¯è·å¾— root æƒé™ã€‚

**æœ‰æ•ˆæ€§ï¼š**

æä¾›çš„ POC ä»£ç å°è¯•åˆ©ç”¨ CVE-2021-3493 æ¼æ´ã€‚è¯¥ä»£ç åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´å’ŒæŒ‚è½½å‘½åç©ºé—´ï¼Œå¹¶å°è¯•æŒ‚è½½ overlayfsã€‚ç„¶åï¼Œå®ƒåº”è¯¥è®¾ç½® `magic` äºŒè¿›åˆ¶æ–‡ä»¶çš„ capabilitiesï¼Œä»è€Œè·å¾— root æƒé™ã€‚æ ¹æ®æ¼æ´æè¿°ï¼Œè¯¥ POC åº”è¯¥èƒ½å¤Ÿæœ‰æ•ˆåˆ©ç”¨è¯¥æ¼æ´ã€‚

**æŠ•æ¯’é£é™©ï¼š**

æ£€æŸ¥æä¾›çš„ exploit.c æ–‡ä»¶ï¼Œæœªå‘ç°æ˜æ˜¾çš„æ¶æ„æˆ–éšè—ä»£ç ã€‚ä»£ç é€»è¾‘ä¸»è¦é›†ä¸­äºè®¾ç½® overlayfs æŒ‚è½½å’Œæ–‡ä»¶ capabilitiesã€‚ä½†æ˜¯ï¼Œéœ€è¦å§‹ç»ˆè°¨æ…å¯¹å¾…æ¥è‡ªä¸å—ä¿¡ä»»æ¥æºçš„ä»£ç ã€‚ä¸ºäº†ç¡®ä¿å®‰å…¨ï¼Œå»ºè®®åœ¨å—æ§ç¯å¢ƒä¸­ä»”ç»†å®¡æŸ¥å’Œæµ‹è¯•ä»£ç ã€‚


**é¡¹ç›®åœ°å€:** [Sornphut/OverlayFS---CVE-2021-3493](https://github.com/Sornphut/OverlayFS---CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #3

**æ¥æº**: [CVE-2021-3493-briskets_CVE-2021-3493.md](../2021/CVE-2021-3493-briskets_CVE-2021-3493.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å¯¼è‡´æ™®é€šç”¨æˆ·æƒé™æå‡è‡³rootæƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu kernel versions: < 5.8.0-50.56 (5.8 kernel), < 5.4.0-72.80 (5.4 kernel), < 4.15.0-142.146 (4.15 kernel), < 4.4.0-209.241 (4.4 kernel)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦åœ¨å­˜åœ¨æ¼æ´çš„Ubuntuå†…æ ¸ç‰ˆæœ¬ä¸Šï¼Œå¹¶ä¸”å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½overlayfs

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 5%

## è¯¦æƒ…

CVE-2021-3493 æ¼æ´æ˜¯ç”±äº Linux å†…æ ¸çš„ overlayfs å®ç°æ²¡æœ‰æ­£ç¡®éªŒè¯ç”¨æˆ·å‘½åç©ºé—´ä¸­åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸Šæ–‡ä»¶ capabilities çš„è®¾ç½®ã€‚ç”±äº Ubuntu å†…æ ¸ä¸­å­˜åœ¨å…è®¸éç‰¹æƒ overlay æŒ‚è½½çš„è¡¥ä¸ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´è·å¾—æå‡çš„æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  æ¼æ´åˆ©ç”¨ä»£ç é¦–å…ˆåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ (ovlcap/work, ovlcap/lower, ovlcap/upper, ovlcap/merge)ã€‚
2.  åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´å’ŒæŒ‚è½½å‘½åç©ºé—´ã€‚
3.  åœ¨æ–°çš„ç”¨æˆ·å‘½åç©ºé—´ä¸­ï¼Œå°†å½“å‰ç”¨æˆ·çš„ UID å’Œ GID æ˜ å°„åˆ° root ç”¨æˆ·ã€‚
4.  ä½¿ç”¨ overlayfs å°† lowerdir (ovlcap/lower), upperdir (ovlcap/upper) å’Œ workdir (ovlcap/work) æŒ‚è½½åˆ° mergedir (ovlcap/merge)ã€‚
5.  å¤åˆ¶è‡ªèº« (exploit ç¨‹åº) åˆ° mergedir/magicï¼Œå¹¶è®¾ç½® security.capability æ‰©å±•å±æ€§ä¸º all+epï¼Œèµ‹äºˆè¯¥æ–‡ä»¶ capabilitiesã€‚
6.  æ‰§è¡Œ mergedir/magicï¼Œç”±äº capabilities çš„è®¾ç½®ï¼Œè¯¥ç¨‹åºä¼šä»¥ root æƒé™æ‰§è¡Œã€‚
7.  æœ€åï¼Œæ‰§è¡Œ upperdir/magicï¼Œå¯åŠ¨ä¸€ä¸ª root shellã€‚

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„POCä»£ç æ˜¯æœ‰æ•ˆçš„ï¼Œèƒ½å¤Ÿåˆ©ç”¨ CVE-2021-3493 æ¼æ´åœ¨å—å½±å“çš„ Ubuntu ç³»ç»Ÿä¸Šå®ç°æœ¬åœ°ææƒã€‚

**æŠ•æ¯’é£é™©ï¼š**
è¯¥POCä»£ç çš„ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´è¿›è¡Œææƒï¼Œä½†ä»ç„¶å­˜åœ¨æ½œåœ¨çš„æŠ•æ¯’é£é™©ã€‚æ¯”å¦‚ä½œè€…å¯èƒ½åœ¨ç¼–è¯‘å’Œè¿è¡Œå‰æ·»åŠ ä¸€äº›æ¶æ„ä»£ç ï¼Œä¾‹å¦‚ï¼š

1.  **åé—¨æ¤å…¥ï¼š** åœ¨ææƒæˆåŠŸåï¼Œæ¤å…¥ä¸€ä¸ªåé—¨ç¨‹åºï¼Œå…è®¸æ”»å‡»è€…è¿œç¨‹è®¿é—®ç³»ç»Ÿã€‚
2.  **æ•°æ®çªƒå–ï¼š** åœ¨ææƒè¿‡ç¨‹ä¸­ï¼Œçªƒå–ç”¨æˆ·çš„æ•æ„Ÿæ•°æ®ã€‚
3.  **ç ´åç³»ç»Ÿï¼š** åœ¨ææƒå¤±è´¥æˆ–è€…æˆåŠŸåï¼Œç ´åç³»ç»Ÿæ–‡ä»¶æˆ–è€…é…ç½®ã€‚

è€ƒè™‘åˆ°ä»£ç ç›¸å¯¹ç®€çŸ­ä¸”åŠŸèƒ½æ˜ç¡®ï¼Œè¯„ä¼°æŠ•æ¯’é£é™©ä¸º5%ã€‚ç”¨æˆ·éœ€è¦ä»”ç»†å®¡æŸ¥ä»£ç ï¼Œå¹¶åœ¨å®‰å…¨çš„ç¯å¢ƒä¸­è¿›è¡Œæµ‹è¯•ã€‚

**é¡¹ç›®åœ°å€:** [briskets/CVE-2021-3493](https://github.com/briskets/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #4

**æ¥æº**: [CVE-2021-3493-cyberx-1_OverlayFS-CVE-2021-3493.md](../2021/CVE-2021-3493-cyberx-1_OverlayFS-CVE-2021-3493.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯ä»æ™®é€šç”¨æˆ·ææƒè‡³root

**å½±å“ç‰ˆæœ¬:** Ubuntu kernels: 5.8.0-50.56 (5.8 kernel), 5.4.0-72.80 (5.4 kernel), 4.15.0-142.146 (4.15 kernel), 4.4.0-209.241 (4.4 kernel)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦è¿è¡Œåœ¨å­˜åœ¨æ¼æ´çš„Ubuntuå†…æ ¸ç‰ˆæœ¬ä¸Šï¼Œå¯ç”¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å’Œå…è®¸éç‰¹æƒ overlay mountsã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2021-3493æ˜¯Ubuntuå†…æ ¸OverlayFSå®ç°ä¸­çš„ä¸€ä¸ªæƒé™æå‡æ¼æ´ã€‚ç”±äºoverlayfsåœ¨ç”¨æˆ·å‘½åç©ºé—´ä¸­æ²¡æœ‰æ­£ç¡®éªŒè¯åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­æ–‡ä»¶åŠŸèƒ½è®¾ç½®ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å’ŒUbuntuå†…æ ¸ä¸­çš„éç‰¹æƒoverlayæŒ‚è½½è¡¥ä¸ï¼Œè·å–æå‡çš„æƒé™ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** åœ¨å­˜åœ¨æ¼æ´çš„Ubuntuå†…æ ¸ä¸Šï¼Œç¡®ä¿å¯ç”¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´ã€‚æ¼æ´åº“ä¿¡æ¯æåˆ°ç¦ç”¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å¯ä»¥ä½œä¸ºç¼“è§£æªæ–½ï¼Œæ‰€ä»¥è¦ç¡®ä¿å¯ç”¨ã€‚
2.  **åˆ›å»ºOverlayFSç»“æ„ï¼š** PoCä»£ç é¦–å…ˆåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼ˆlower, upper, work, mergeï¼‰ç”¨äº overlayfs æ–‡ä»¶ç³»ç»Ÿã€‚
3.  **åˆ›å»ºç”¨æˆ·å‘½åç©ºé—´ï¼š** ä½¿ç”¨`unshare`ç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´ã€‚è¿™å…è®¸åœ¨æ–°çš„å‘½åç©ºé—´ä¸­æ‹¥æœ‰ä¸åŒçš„ç”¨æˆ·IDå’Œç»„IDæ˜ å°„ã€‚
4.  **è®¾ç½®UID/GIDæ˜ å°„ï¼š** å°†å½“å‰ç”¨æˆ·çš„UIDå’ŒGIDæ˜ å°„åˆ°æ–°å‘½åç©ºé—´ä¸­çš„rootç”¨æˆ· (UID 0 å’Œ GID 0)ã€‚
5.  **æŒ‚è½½OverlayFSï¼š** ä½¿ç”¨`mount`ç³»ç»Ÿè°ƒç”¨å°† overlayfs æ–‡ä»¶ç³»ç»ŸæŒ‚è½½åˆ° merge ç›®å½•ã€‚æŒ‡å®š lowerdir, upperdir å’Œ workdirã€‚
6.  **å¤åˆ¶è‡ªèº«å¹¶è®¾ç½®Capabilitiesï¼š** å°†è‡ªèº«å¯æ‰§è¡Œæ–‡ä»¶å¤åˆ¶åˆ° overlayfs çš„ merge ç›®å½•ï¼Œç„¶åä½¿ç”¨`setxattr`è®¾ç½®`security.capability`æ‰©å±•å±æ€§ï¼Œèµ‹äºˆè¯¥æ–‡ä»¶ root æƒé™ã€‚
7.  **æ‰§è¡Œææƒåçš„ç¨‹åºï¼š** é€šè¿‡æ‰§è¡Œ upper ç›®å½•ä¸‹çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆä¹‹å‰å¤åˆ¶å¹¶è®¾ç½®äº† capabilities çš„æ–‡ä»¶ï¼‰æ¥è·å– root æƒé™ã€‚è¿™ä¸ªç¨‹åºä¼šæ£€æŸ¥æ˜¯å¦æœ‰"shell"å‚æ•°ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™ä¼šé‡æ–°æ‰§è¡Œè‡ªèº«ï¼Œä½†è¿™æ¬¡ä¼šå¸¦æœ‰`shell`å‚æ•°ï¼Œä»è€Œè§¦å‘`setuid(0)`å’Œ`setgid(0)`ï¼Œæœ€ç»ˆæ‰§è¡Œ`/bin/bash`ï¼Œè·å¾— root shellã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

ä»£ç ä¸­å­˜åœ¨ä¸€å®šçš„æŠ•æ¯’é£é™©ï¼Œè™½ç„¶ä¸»è¦é€»è¾‘æ˜¯åˆ©ç”¨æ¼æ´è¿›è¡Œææƒï¼Œä½†å­˜åœ¨ä¿®æ”¹`/bin/bash`çš„å¯èƒ½æ€§ï¼Œä½†æ˜¯ç»è¿‡ä»£ç åˆ†æä»¥åŠæ¼æ´åŸç†ï¼Œåˆ¤æ–­æ¼æ´åˆ©ç”¨è¿‡ç¨‹ä¸­æ²¡æœ‰ä¿®æ”¹`/bin/bash`æ“ä½œ,ä»£ç ä¸­é£é™©ä¸»è¦å­˜åœ¨äºä»¥ä¸‹å‡ ç‚¹:

1.  **ä¾èµ–å¤–éƒ¨äºŒè¿›åˆ¶æ–‡ä»¶ï¼š** è¯¥æ¼æ´åˆ©ç”¨ä¾èµ–äºç³»ç»Ÿä¸Šçš„`/bin/bash`ã€‚å¦‚æœæ”»å‡»è€…æ›¿æ¢æˆ–ç¯¡æ”¹äº†ç›®æ ‡ç³»ç»Ÿä¸Šçš„`/bin/bash`ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ„å¤–çš„è¡Œä¸ºæˆ–å®‰å…¨é—®é¢˜ã€‚
2.  **æ¸…ç†æ“ä½œé£é™©ï¼š** ä»£ç å¼€å§‹æ—¶ä½¿ç”¨`system(buf)`æ‰§è¡Œ`rm -rf '%s/'`ï¼Œå¦‚æœ`DIR_BASE`è¢«æ¶æ„ä¿®æ”¹ï¼Œå¯èƒ½å¯¼è‡´æ„å¤–çš„æ–‡ä»¶åˆ é™¤ã€‚
3.  **ä¸å®Œå–„çš„é”™è¯¯å¤„ç†ï¼š** è™½ç„¶ PoC ä»£ç åŒ…å«äº†ä¸€äº›é”™è¯¯å¤„ç†ï¼Œä½†åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå¦‚æœé”™è¯¯å¤„ç†ä¸å½“ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ‹’ç»æœåŠ¡æˆ–æœªå®šä¹‰çš„è¡Œä¸ºã€‚

æ€»ä½“è€Œè¨€ï¼Œè¯¥ PoC ä»£ç çš„æŠ•æ¯’é£é™©è¾ƒä½ï¼Œä¸»è¦é£é™©åœ¨äºä¾èµ–å¤–éƒ¨äºŒè¿›åˆ¶æ–‡ä»¶å’Œæ½œåœ¨çš„æ¸…ç†æ“ä½œé£é™©ã€‚ä»£ç æœ¬èº«ä¸»è¦æ˜¯ä¸ºäº†æ¼”ç¤ºæ¼æ´åˆ©ç”¨ï¼Œå¹¶æœªå‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç ã€‚ è¯„ä¼°æŠ•æ¯’é£é™©ä¸º10%ã€‚


**é¡¹ç›®åœ°å€:** [cyberx-1/OverlayFS-CVE-2021-3493](https://github.com/cyberx-1/OverlayFS-CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #5

**æ¥æº**: [CVE-2021-3493-derek-turing_CVE-2021-3493.md](../2021/CVE-2021-3493-derek-turing_CVE-2021-3493.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Ubuntu Linux Kernel

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœ¬åœ°ç”¨æˆ·å¯æå‡è‡³ root æƒé™

**å½±å“ç‰ˆæœ¬:** 4.4 <= kernel < 4.4.0-209.241, 4.15 <= kernel < 4.15.0-142.146, 5.4 <= kernel < 5.4.0-72.80, 5.8 <= kernel < 5.8.0-50.56

**åˆ©ç”¨æ¡ä»¶:** Ubuntu å†…æ ¸å¼€å¯äº† unprivileged user namespaces å’Œ unprivileged overlay mounts

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

è¯¥æ¼æ´å­˜åœ¨äº Ubuntu Linux å†…æ ¸çš„ OverlayFS å®ç°ä¸­ï¼Œç”±äº overlayfs å¯¹åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­æ–‡ä»¶ capabilities çš„è®¾ç½®éªŒè¯ä¸å½“ï¼Œç»“åˆæœªæˆæƒç”¨æˆ·å‘½åç©ºé—´å’Œ Ubuntu å†…æ ¸ä¸­å…è®¸æœªæˆæƒ overlay æŒ‚è½½çš„è¡¥ä¸ï¼Œæ”»å‡»è€…å¯åˆ©ç”¨æ­¤æ¼æ´æå‡æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** é¦–å…ˆï¼Œç¡®ä¿ç›®æ ‡ç³»ç»Ÿæ»¡è¶³æ¼æ´åˆ©ç”¨çš„æ¡ä»¶ï¼Œå³ Ubuntu å†…æ ¸ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…ï¼Œå¹¶ä¸”å¯ç”¨äº† unprivileged user namespaces å’Œ unprivileged overlay mountsã€‚æ¼æ´åº“ä¿¡æ¯ä¸­ç»™å‡ºäº†å—å½±å“çš„ç‰ˆæœ¬èŒƒå›´ã€‚
2.  **åˆ›å»ºç›®å½•ç»“æ„ï¼š** åˆ›å»º overlayfs æ‰€éœ€çš„ç›®å½•ç»“æ„ï¼ŒåŒ…æ‹¬ lowerdirï¼ˆåº•å±‚ç›®å½•ï¼‰ã€upperdirï¼ˆä¸Šå±‚ç›®å½•ï¼‰ã€workdirï¼ˆå·¥ä½œç›®å½•ï¼‰å’Œ mergedirï¼ˆåˆå¹¶ç›®å½•ï¼‰ã€‚
3.  **åˆ›å»ºç”¨æˆ·å‘½åç©ºé—´ï¼š** ä½¿ç”¨ `unshare` å‘½ä»¤åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´ï¼Œè¿™å…è®¸åœ¨éç‰¹æƒç”¨æˆ·ä¸‹æ‰§è¡Œä¸€äº›ç‰¹æƒæ“ä½œã€‚
4.  **è®¾ç½® UID/GID æ˜ å°„ï¼š** åœ¨ç”¨æˆ·å‘½åç©ºé—´ä¸­ï¼Œå°†å½“å‰ç”¨æˆ·çš„ UID å’Œ GID æ˜ å°„åˆ° root ç”¨æˆ· (UID 0) å’Œ root ç»„ (GID 0)ï¼Œè¿™æ ·åœ¨ overlayfs ä¸­åˆ›å»ºçš„æ–‡ä»¶å°†å±äº root ç”¨æˆ·ã€‚
5.  **æŒ‚è½½ OverlayFSï¼š** ä½¿ç”¨ `mount` å‘½ä»¤å°† overlayfs æŒ‚è½½åˆ° mergedirï¼ŒæŒ‡å®š lowerdirã€upperdir å’Œ workdirã€‚
6.  **å¤åˆ¶å¹¶è®¾ç½® Capabilitiesï¼š** å°† exploit ç¨‹åºè‡ªèº«å¤åˆ¶åˆ° mergedir ä¸­ï¼Œå¹¶ä½¿ç”¨ `setxattr` å‘½ä»¤è®¾ç½®å…¶ security.capability æ‰©å±•å±æ€§ï¼Œèµ‹äºˆå…¶ CAP_SETUID å’Œ CAP_SETGID capabilitiesã€‚è¿™ä¸ªcapabilitieså…è®¸ç¨‹åºåœ¨æ²¡æœ‰rootæƒé™çš„æƒ…å†µä¸‹è®¾ç½®uidå’Œgidã€‚
7.  **è§¦å‘ææƒï¼š** è¿è¡Œ mergedir ä¸­çš„ exploit ç¨‹åºï¼Œç”±äºå·²è®¾ç½® capabilitiesï¼Œç¨‹åºå°†ä»¥ root æƒé™è¿è¡Œï¼Œä»è€Œæ‰§è¡Œç‰¹æƒæ“ä½œã€‚

**ä»£ç åˆ†æï¼š**

*   `exploit.c` æ˜¯åˆ©ç”¨ä»£ç ï¼Œå®ƒåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼Œå»ºç«‹ç”¨æˆ·å‘½åç©ºé—´ï¼ŒæŒ‚è½½ overlayfsï¼Œç„¶åå°†è‡ªèº«å¤åˆ¶åˆ° overlayfs ä¸­ï¼Œå¹¶è®¾ç½® capabilitiesã€‚æœ€åï¼Œæ‰§è¡Œå¤åˆ¶åˆ° upperdir ä¸­çš„ç¨‹åºï¼Œè¯¥ç¨‹åºä¼šå°†å½“å‰è¿›ç¨‹ææƒä¸º rootã€‚
*   ä»£ç ä¸­ä½¿ç”¨äº† `setxattr` å‡½æ•°æ¥è®¾ç½®æ–‡ä»¶ capabilitiesï¼Œè¿™æ˜¯åˆ©ç”¨æ¼æ´çš„å…³é”®æ­¥éª¤ã€‚
*   mainå‡½æ•°é¦–å…ˆforkä¸€ä¸ªå­è¿›ç¨‹æ‰§è¡Œexploitå‡½æ•°ï¼Œåœ¨exploitå‡½æ•°æ‰§è¡Œå®Œæ¯•åï¼Œçˆ¶è¿›ç¨‹æ‰§è¡ŒBIN_UPPERä¸­çš„magicç¨‹åºï¼Œå¦‚æœå¸¦æœ‰shellå‚æ•°ï¼Œmagicç¨‹åºä¼šè®¾ç½®uidå’Œgidä¸º0ï¼Œå¹¶ä¸”è¿è¡Œä¸€ä¸ªbash shellã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

ä»”ç»†æ£€æŸ¥äº† POC ä»£ç ï¼Œæ²¡æœ‰å‘ç°æ˜æ˜¾çš„æŠ•æ¯’ä»£ç ã€‚ä»£ç é€»è¾‘æ¸…æ™°ï¼Œä¸»è¦ç”¨äºåˆ›å»º overlayfs ç¯å¢ƒå¹¶è®¾ç½®æ–‡ä»¶ capabilities ä»¥è¿›è¡Œææƒã€‚ä½œè€…å¹¶æ²¡æœ‰å°è¯•åœ¨ä»£ç ä¸­éšè—æ¶æ„è¡Œä¸ºï¼Œä¾‹å¦‚ï¼š

*   è¿æ¥å¤–éƒ¨æœåŠ¡å™¨
*   ä¿®æ”¹ç³»ç»Ÿæ–‡ä»¶
*   å®‰è£…åé—¨
*   æ”¶é›†ç”¨æˆ·ä¿¡æ¯

å› æ­¤ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ (0%)ã€‚

**é¡¹ç›®åœ°å€:** [derek-turing/CVE-2021-3493](https://github.com/derek-turing/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #6

**æ¥æº**: [CVE-2021-3493-fathallah17_OverlayFS-CVE-2021-3493.md](../2021/CVE-2021-3493-fathallah17_OverlayFS-CVE-2021-3493.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°æƒé™æå‡

**å½±å“åº”ç”¨:** Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å¯¼è‡´æœ¬åœ°æƒé™æå‡è‡³root

**å½±å“ç‰ˆæœ¬:** 4.4 <= Linux Kernel < 5.8.0-50.56 (Ubuntu ç‰¹å®šç‰ˆæœ¬)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦å­˜åœ¨Ubuntuå†…æ ¸ä¸­å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½OverlayFSçš„è¡¥ä¸ï¼Œä¸”ç”¨æˆ·å‘½åç©ºé—´æœªè¢«ç¦ç”¨ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 1%

## è¯¦æƒ…

CVE-2021-3493 æ˜¯ä¸€ä¸ªå­˜åœ¨äº Linux å†…æ ¸ OverlayFS å®ç°ä¸­çš„æƒé™æå‡æ¼æ´ã€‚æ¼æ´çš„æ ¹æœ¬åŸå› æ˜¯ OverlayFS åœ¨è®¾ç½®åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­æ–‡ä»¶çš„ capabilities æ—¶ï¼Œæ²¡æœ‰æ­£ç¡®åœ°éªŒè¯ç”¨æˆ·å‘½åç©ºé—´ã€‚åœ¨å­˜åœ¨å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½ OverlayFS çš„ Ubuntu å†…æ ¸è¡¥ä¸çš„ç¯å¢ƒä¸­ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´è·å¾—æå‡çš„æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š**  ç›®æ ‡ç³»ç»Ÿéœ€è¦æ˜¯å—å½±å“çš„ Ubuntu ç‰ˆæœ¬ï¼Œå¹¶ä¸”å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½ OverlayFSï¼ŒåŒæ—¶ç”¨æˆ·å‘½åç©ºé—´æ²¡æœ‰è¢«ç¦ç”¨ã€‚
2.  **è·å–æ¼æ´åˆ©ç”¨ä»£ç ï¼š**  ä»å¯ä¿¡æ¥æºè·å–æ¼æ´åˆ©ç”¨ä»£ç  (ä¾‹å¦‚ SSD-Disclosure æä¾›çš„ exploit.c)ã€‚
3.  **ç¼–è¯‘æ¼æ´åˆ©ç”¨ä»£ç ï¼š**  ä½¿ç”¨ gcc ç­‰ç¼–è¯‘å™¨å°† exploit.c ç¼–è¯‘ä¸ºå¯æ‰§è¡Œæ–‡ä»¶ã€‚
4.  **æ‰§è¡Œæ¼æ´åˆ©ç”¨ä»£ç ï¼š**  è¿è¡Œç¼–è¯‘åçš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚æ¼æ´åˆ©ç”¨ä»£ç ä¼šåˆ©ç”¨ OverlayFS çš„æ¼æ´ï¼Œé€šè¿‡è®¾ç½®æ–‡ä»¶ capabilities æ¥æå‡å½“å‰ç”¨æˆ·çš„æƒé™è‡³ rootã€‚
5.  **è·å– root æƒé™ï¼š**  æˆåŠŸæ‰§è¡Œæ¼æ´åˆ©ç”¨ä»£ç åï¼Œç”¨æˆ·å°†è·å¾— root æƒé™ã€‚

**å…³äºæŠ•æ¯’é£é™©ï¼š**

æä¾›çš„POCä»£ç åªæ˜¯ä¸€ä¸ªç®€å•çš„åˆ©ç”¨æ–¹å¼,ä¸å¤ªå¯èƒ½åŒ…å«æ¶æ„ä»£ç ã€‚ä½†å§‹ç»ˆéœ€è¦å¯¹ä»»ä½•æ¥æºçš„æ¼æ´åˆ©ç”¨ä»£ç è¿›è¡Œå®¡æŸ¥ï¼Œä»¥é™ä½é£é™©ã€‚
å¯¹ä¸‹è½½çš„æ–‡ä»¶è¿›è¡Œæ£€æŸ¥ï¼Œå¦‚å“ˆå¸Œæ ¡éªŒï¼Œå¯ä»¥æœ€å¤§ç¨‹åº¦çš„é¿å…å¼•å…¥æ¶æ„ä»£ç ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**

æ ¹æ®æ¼æ´æè¿°å’Œåˆ©ç”¨ä»£ç ï¼Œè¯¥æ¼æ´åˆ©ç”¨æ˜¯æœ‰æ•ˆçš„ã€‚åˆ©ç”¨ä»£ç é€šè¿‡OverlayFSçš„æ¼æ´ï¼Œå…è®¸ä½æƒé™ç”¨æˆ·è·å¾—rootæƒé™ã€‚

**å…¶ä»–ä¿¡æ¯:**
CISA å·²å°†æ­¤æ¼æ´æ·»åŠ åˆ°å·²çŸ¥è¢«åˆ©ç”¨çš„æ¼æ´ç›®å½• (KEV) ä¸­ï¼Œè¡¨æ˜è¯¥æ¼æ´å·²è¢«å¹¿æ³›åˆ©ç”¨ã€‚

**é¡¹ç›®åœ°å€:** [fathallah17/OverlayFS-CVE-2021-3493](https://github.com/fathallah17/OverlayFS-CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #7

**æ¥æº**: [CVE-2021-3493-fei9747_CVE-2021-3493.md](../2021/CVE-2021-3493-fei9747_CVE-2021-3493.md)

## CVE-2021-3493 Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ”»å‡»è€…å¯åˆ©ç”¨æ­¤æ¼æ´è·å– root æƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu kernel versions: < 5.8.0-50.56, < 5.4.0-72.80, < 4.15.0-142.146, < 4.4.0-209.241

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦åœ¨å­˜åœ¨æ¼æ´çš„ Ubuntu ç³»ç»Ÿä¸Šæœ¬åœ°æ‰§è¡Œ

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 5%

## è¯¦æƒ…

CVE-2021-3493 æ˜¯ä¸€ä¸ªå­˜åœ¨äº Ubuntu Linux å†…æ ¸ overlayfs å®ç°ä¸­çš„æœ¬åœ°ææƒæ¼æ´ã€‚è¯¥æ¼æ´æºäº overlayfs æœªèƒ½æ­£ç¡®éªŒè¯ç”¨æˆ·å‘½åç©ºé—´ä¸­åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸Šæ–‡ä»¶ capabilities çš„è®¾ç½®ã€‚ç»“åˆæœªæˆæƒç”¨æˆ·å‘½åç©ºé—´ä»¥åŠ Ubuntu å†…æ ¸ä¸­å…è®¸æœªæˆæƒ overlay mount çš„è¡¥ä¸ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´æå‡æƒé™ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼ŒåŒ…æ‹¬lowerdirï¼Œupperdirï¼Œworkdirå’Œmergedirã€‚
2.  **åˆ›å»ºå‘½åç©ºé—´ï¼š** ä½¿ç”¨ `unshare` ç³»ç»Ÿè°ƒç”¨åˆ›å»ºæ–°çš„ç”¨æˆ·å‘½åç©ºé—´å’ŒæŒ‚è½½å‘½åç©ºé—´ã€‚
3.  **è®¾ç½®ç”¨æˆ·å’Œç»„IDæ˜ å°„ï¼š** å°†å½“å‰ç”¨æˆ·çš„ UID å’Œ GID æ˜ å°„åˆ°æ–°çš„ç”¨æˆ·å‘½åç©ºé—´ä¸­ï¼Œä»¥ä¾¿åœ¨æ–°çš„å‘½åç©ºé—´ä¸­æ‹¥æœ‰æƒé™ã€‚
4.  **æŒ‚è½½ OverlayFSï¼š** ä½¿ç”¨ `mount` ç³»ç»Ÿè°ƒç”¨ï¼Œå°† overlayfs æŒ‚è½½åˆ° mergedirï¼Œå¹¶å°† lowerdirï¼Œupperdir å’Œ workdir æŒ‡å®šä¸ºç›¸åº”çš„ç›®å½•ã€‚
5.  **è®¾ç½® Capabilitiesï¼š** å¤åˆ¶å½“å‰æ‰§è¡Œçš„ç¨‹åºåˆ° mergedirï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½®è¯¥æ–‡ä»¶çš„ capabilitiesï¼Œä½¿å…¶å…·æœ‰ root æƒé™ã€‚ è¿™æ­¥æ˜¯æ¼æ´åˆ©ç”¨çš„å…³é”®ã€‚
6.  **æ‰§è¡ŒPayloadï¼š** æ‰§è¡Œupperç›®å½•ä¸­çš„æ–‡ä»¶ï¼Œå› ä¸ºè®¾ç½®äº†Capabilitiesï¼Œå¯ä»¥è·å¾—rootæƒé™ã€‚

**æœ‰æ•ˆæ€§ï¼š**

æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’ŒPOCä»£ç æè¿°ï¼Œè¯¥æ¼æ´åœ¨ç‰¹å®šç‰ˆæœ¬çš„ Ubuntu å†…æ ¸ä¸Šæ˜¯å¯åˆ©ç”¨çš„ã€‚æä¾›çš„POCä»£ç å±•ç¤ºäº†åˆ©ç”¨è¯¥æ¼æ´æå‡æƒé™çš„å®Œæ•´è¿‡ç¨‹ã€‚

**æŠ•æ¯’é£é™©ï¼š**

ä»£ç ä¸­å­˜åœ¨æ½œåœ¨çš„æŠ•æ¯’é£é™©ï¼Œä½†æ˜¯é£é™©è¾ƒä½ã€‚ä¸»è¦é›†ä¸­åœ¨ç¼–è¯‘å’Œè¿è¡Œexploitæ—¶ã€‚æ”»å‡»è€…å¯èƒ½é€šè¿‡ä¿®æ”¹ exploit.c æ–‡ä»¶ï¼Œä¾‹å¦‚æ·»åŠ æ¶æ„ä»£ç æˆ–åé—¨ï¼Œä»è€Œåœ¨ç›®æ ‡ç³»ç»Ÿä¸Šæ‰§è¡Œæ¶æ„æ“ä½œã€‚ä½†æ˜¯æ ¹æ®æä¾›çš„POCä»£ç æ¥çœ‹, é£é™©ç³»æ•°è¾ƒä½.

**é£é™©è¯„ä¼°ï¼š**

è¯¥æ¼æ´åˆ©ç”¨çš„æˆåŠŸå–å†³äºç›®æ ‡ç³»ç»Ÿæ˜¯å¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š

*   è¿è¡Œå—å½±å“çš„ Ubuntu å†…æ ¸ç‰ˆæœ¬ã€‚
*   å¯ç”¨äº†æœªæˆæƒç”¨æˆ·å‘½åç©ºé—´å’Œ overlayfs mountã€‚
*   ç›®æ ‡ç³»ç»Ÿä¸Šå­˜åœ¨ `gcc` ç¼–è¯‘å™¨, èƒ½å¤Ÿç¼–è¯‘exploitã€‚

å¦‚æœç›®æ ‡ç³»ç»Ÿæ»¡è¶³è¿™äº›æ¡ä»¶ï¼Œæ”»å‡»è€…å¯ä»¥ä½¿ç”¨æä¾›çš„ POC ä»£ç æˆåŠŸåˆ©ç”¨è¯¥æ¼æ´ï¼Œä»è€Œè·å¾— root æƒé™ã€‚


**é¡¹ç›®åœ°å€:** [fei9747/CVE-2021-3493](https://github.com/fei9747/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #8

**æ¥æº**: [CVE-2021-3493-iamz24_CVE-2021-3493_CVE-2022-3357.md](../2021/CVE-2021-3493-iamz24_CVE-2021-3493_CVE-2022-3357.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒæ¼æ´

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å¯¼è‡´æœ¬åœ°æƒé™æå‡è‡³ root

**å½±å“ç‰ˆæœ¬:** Ubuntu kernels < 5.8.0-50.56, < 5.4.0-72.80, < 4.15.0-142.146, < 4.4.0-209.241

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç›®æ ‡ç³»ç»Ÿå¼€å¯ unprivileged user namespaces å’Œå­˜åœ¨ OverlayFS æœåŠ¡ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2021-3493 æ¼æ´æ˜¯ Linux å†…æ ¸ overlayfs å®ç°ä¸­ï¼Œåœ¨ç”¨æˆ·å‘½åç©ºé—´ä¸­å¯¹åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­çš„æ–‡ä»¶ capabilities éªŒè¯ä¸å½“å¯¼è‡´çš„ã€‚ç”±äº Ubuntu å†…æ ¸ä¸­å­˜åœ¨å…è®¸éç‰¹æƒ overlay æŒ‚è½½çš„è¡¥ä¸ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¯¥æ¼æ´æå‡æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** æ£€æŸ¥ç›®æ ‡ç³»ç»Ÿæ˜¯å¦å­˜åœ¨ overlayfs æœåŠ¡ï¼Œå¦‚æœæ²¡æœ‰åˆ™åŠ è½½ overlay æ¨¡å—ã€‚åŒæ—¶ï¼Œç¡®ä¿å¼€å¯äº† unprivileged user namespacesã€‚
2.  **ç¼–è¯‘ Payloadï¼š** ä½¿ç”¨ GCC ç¼–è¯‘æä¾›çš„ `payload.c` æ–‡ä»¶ã€‚
3.  **è¿è¡Œ Payloadï¼š** è¿è¡Œç¼–è¯‘åçš„å¯æ‰§è¡Œæ–‡ä»¶ `a.out`ã€‚
4.  **è·å– Root Shellï¼š** Payload ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å‘½åç©ºé—´ï¼ŒæŒ‚è½½ overlayfsï¼Œè®¾ç½® capabilityï¼Œæœ€ç»ˆæ‰§è¡Œä¸€ä¸ªå…·æœ‰ root æƒé™çš„ shellã€‚

**æœ‰æ•ˆæ€§ï¼š**

æä¾›çš„ POC ä»£ç åŸºæœ¬æœ‰æ•ˆï¼Œèƒ½å¤Ÿåˆ©ç”¨è¯¥æ¼æ´åœ¨ç¬¦åˆæ¡ä»¶çš„ Ubuntu ç³»ç»Ÿä¸Šå®ç°æœ¬åœ°ææƒã€‚

**æŠ•æ¯’é£é™©ï¼š**

å­˜åœ¨è¾ƒä½çš„æŠ•æ¯’é£é™©ï¼ˆ10%ï¼‰ã€‚è™½ç„¶ä»£ç çš„ä¸»è¦åŠŸèƒ½æ˜¯å®ç°ææƒï¼Œä½†ä»ç„¶éœ€è¦è°¨æ…å¯¹å¾…æ¥æºä¸æ˜çš„ä»£ç ï¼Œä½œè€…å¯èƒ½ä¼šåœ¨å…¶ä¸­éšè—ä¸€äº›æ¶æ„è¡Œä¸ºï¼Œæ¯”å¦‚ä¸Šä¼ æ•æ„Ÿä¿¡æ¯ç­‰ã€‚ç‰¹åˆ«æ˜¯éœ€è¦æ£€æŸ¥ `exploit`å‡½æ•°ä¸­çš„ç›¸å…³æ–‡ä»¶æ“ä½œå’Œå‘½ä»¤æ‰§è¡Œæ˜¯å¦å­˜åœ¨æ¶æ„è¡Œä¸ºã€‚å°¤å…¶å…³æ³¨`system(buf);`æ˜¯å¦ä¼šæ‰§è¡Œæ¶æ„çš„æŒ‡ä»¤ã€‚

**æ€»ç»“ï¼š**

è¯¥æ¼æ´åˆ©ç”¨è¾ƒä¸ºç›´æ¥ï¼Œåˆ©ç”¨æ¡ä»¶ç›¸å¯¹æ˜ç¡®ï¼Œä½†éœ€è¦æ³¨æ„æ½œåœ¨çš„æŠ•æ¯’é£é™©ã€‚åœ¨å®é™…ä½¿ç”¨æ—¶ï¼Œåº”è¯¥ä»”ç»†å®¡æŸ¥ä»£ç ï¼Œç¡®ä¿æ²¡æœ‰æ¶æ„è¡Œä¸ºã€‚

**é¡¹ç›®åœ°å€:** [iamz24/CVE-2021-3493_CVE-2022-3357](https://github.com/iamz24/CVE-2021-3493_CVE-2022-3357)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #9

**æ¥æº**: [CVE-2021-3493-inspiringz_CVE-2021-3493.md](../2021/CVE-2021-3493-inspiringz_CVE-2021-3493.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Ubuntu Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸ä½æƒé™ç”¨æˆ·æå‡åˆ°rootæƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu 4.4, 4.15, 5.4, 5.8 kernels (å—å½±å“ç‰ˆæœ¬è¯¦è§æ¼æ´åº“ä¿¡æ¯)

**åˆ©ç”¨æ¡ä»¶:** Ubuntuå†…æ ¸ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…ï¼Œå¯ç”¨æœªæˆæƒç”¨æˆ·å‘½åç©ºé—´ï¼Œå…è®¸æœªæˆæƒOverlayFSæŒ‚è½½ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 5%

## è¯¦æƒ…

CVE-2021-3493æ˜¯Ubuntuå†…æ ¸ä¸­OverlayFSå®ç°çš„ä¸€ä¸ªæ¼æ´ï¼Œå…è®¸ä½æƒé™ç”¨æˆ·é€šè¿‡åˆ©ç”¨user namespaceå’ŒOverlayFSæŒ‚è½½ç»•è¿‡æ–‡ä»¶ç³»ç»Ÿæƒé™æ£€æŸ¥æ¥æå‡æƒé™ã€‚ 

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡:** æ¼æ´åˆ©ç”¨éœ€è¦å­˜åœ¨Ubuntuç³»ç»Ÿï¼Œä¸”å†…æ ¸ç‰ˆæœ¬åœ¨æ¼æ´åº“ä¿¡æ¯ä¸­æè¿°çš„å—å½±å“èŒƒå›´å†…ï¼Œå¹¶ä¸”éœ€è¦å¯ç”¨æœªæˆæƒç”¨æˆ·å‘½åç©ºé—´(unprivileged user namespaces)ã€‚æ­¤å¤–ï¼Œä¸ºäº†åˆ©ç”¨OverlayFSï¼Œç³»ç»Ÿéœ€è¦é…ç½®å…è®¸æœªæˆæƒç”¨æˆ·è¿›è¡ŒOverlayFSæŒ‚è½½ã€‚
2.  **æ¼æ´åˆ©ç”¨:**  æ”»å‡»è€…é¦–å…ˆåˆ›å»ºä¸€ä¸ªåŒ…å«lower, upper, workç›®å½•çš„OverlayFSç»“æ„ã€‚
3.  **åˆ©ç”¨è¿‡ç¨‹:** åˆ©ç”¨`unshare`ç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€ä¸ªæ–°çš„user namespaceå’Œmount namespaceã€‚ åœ¨æ–°namespaceä¸­ï¼Œå°†è‡ªå·±çš„UIDå’ŒGIDæ˜ å°„åˆ°rootæƒé™ã€‚ ç„¶åï¼Œä½¿ç”¨æ„é€ çš„lowerdirã€upperdirå’ŒworkdiræŒ‚è½½OverlayFSæ–‡ä»¶ç³»ç»Ÿã€‚ æ”»å‡»è€…å°†ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶å¤åˆ¶åˆ°OverlayFSçš„mergeç›®å½•ä¸­ã€‚å…³é”®çš„ä¸€æ­¥æ˜¯ï¼Œæ”»å‡»è€…ä½¿ç”¨`setxattr`ç³»ç»Ÿè°ƒç”¨ï¼Œè®¾ç½®è¯¥å¯æ‰§è¡Œæ–‡ä»¶çš„`security.capability`æ‰©å±•å±æ€§ï¼Œèµ‹äºˆå®ƒ`CAP_SETUID`å’Œ`CAP_SETGID`èƒ½åŠ›ã€‚ ç”±äºOverlayFSçš„æƒé™éªŒè¯ä¸å®Œå–„ï¼Œè¿™ä¸ªæ“ä½œå³ä½¿åœ¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´ä¸­ä¹Ÿèƒ½æˆåŠŸã€‚å½“æ‰§è¡Œè¯¥æ–‡ä»¶æ—¶ï¼Œå®ƒå°†è·å¾—rootæƒé™ï¼Œå¹¶å¯ä»¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚
4.  **POCä»£ç åˆ†æ:** `exploit.c` ä»£ç é¦–å…ˆåˆ›å»ºä¸€ä¸ªoverlayfsç›®å½•ç»“æ„ã€‚ç„¶åï¼Œä½¿ç”¨ `unshare` ç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€ä¸ªæ–°çš„ user namespace å’Œ mount namespaceï¼Œå¹¶å°†å½“å‰ç”¨æˆ·çš„ uid å’Œ gid æ˜ å°„åˆ° root ç”¨æˆ·ã€‚ ä¹‹åï¼Œå®ƒæŒ‚è½½ overlayfsï¼Œå¤åˆ¶å½“å‰æ‰§è¡Œçš„ç¨‹åºåˆ° overlayfs çš„ merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½® capabilityã€‚æœ€åï¼Œæ‰§è¡Œå¤åˆ¶åˆ° overlayfs çš„ç¨‹åºã€‚
5. **æŠ•æ¯’é£é™©åˆ†æ:** ä»£ç æœ¬èº«å®ç°äº†æ¼æ´åˆ©ç”¨çš„åŠŸèƒ½ã€‚ æ½œåœ¨çš„æŠ•æ¯’é£é™©å¯èƒ½å­˜åœ¨äºä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š
    *   **ä¾èµ–é¡¹:**  ä»£ç ä¾èµ–äºæ ‡å‡†çš„Cåº“ï¼Œæœ¬èº«ä¸å­˜åœ¨æ¶æ„ä¾èµ–ã€‚ä½†ç”¨æˆ·åœ¨ç¼–è¯‘æ—¶éœ€è¦æ³¨æ„ç¼–è¯‘å™¨ç¯å¢ƒçš„å®‰å…¨æ€§ã€‚
    *   **ä»£ç é€»è¾‘:**  ä»£ç é€»è¾‘ç›¸å¯¹ç®€å•ï¼Œä¸»è¦é›†ä¸­åœ¨namespaceåˆ›å»ºã€æŒ‚è½½å’Œcapabilityè®¾ç½®ã€‚ ä»”ç»†å®¡æŸ¥ä»£ç ï¼Œæœªå‘ç°æ˜æ˜¾çš„æ¶æ„é€»è¾‘ã€‚
    *   **æ‰§è¡Œå‘½ä»¤:**  ä»£ç ä¸­ä½¿ç”¨äº† `system` å‡½æ•°ï¼Œè¿™æ˜¯ä¸€ä¸ªæ½œåœ¨çš„é£é™©ç‚¹ï¼Œå¯ä»¥æ‰§è¡Œä»»æ„ç³»ç»Ÿå‘½ä»¤ã€‚ä½†æ˜¯ï¼Œè¿™é‡Œåªæ˜¯ç”¨æ¥åˆ é™¤ç›®å½•ï¼Œç›¸å¯¹å®‰å…¨ã€‚
       ç»¼ä¸Šæ‰€è¿°ï¼Œè¯¥POCä»£ç ä¸»è¦é£é™©åœ¨äºç¡®ä¿ç¼–è¯‘ç¯å¢ƒå®‰å…¨ä»¥åŠå¯¹ä¸ç†Ÿæ‚‰çš„å‘½ä»¤ä¿æŒè­¦æƒ•ã€‚æŠ•æ¯’é£é™©è¾ƒä½ï¼Œé¢„ä¼°ä¸º5%ã€‚

**æ€»ç»“ï¼š**

è¯¥æ¼æ´åˆ©ç”¨çš„æ ¸å¿ƒåœ¨äºç»“åˆäº†æœªæˆæƒç”¨æˆ·å‘½åç©ºé—´å’ŒOverlayFSï¼Œåˆ©ç”¨OverlayFSå¯¹capabilitiesè®¾ç½®éªŒè¯çš„ç¼ºé™·ï¼Œå®ç°äº†æœ¬åœ°ææƒã€‚ æ”»å‡»è€…é€šè¿‡åˆ›å»ºç‰¹æ®Šçš„OverlayFSç»“æ„å¹¶è®¾ç½®æ–‡ä»¶capabilitiesï¼Œæœ€ç»ˆè·å¾—rootæƒé™ã€‚

**é¡¹ç›®åœ°å€:** [inspiringz/CVE-2021-3493](https://github.com/inspiringz/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #10

**æ¥æº**: [CVE-2021-3493-oneoy_CVE-2021-3493.md](../2021/CVE-2021-3493-oneoy_CVE-2021-3493.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœ¬åœ°ç”¨æˆ·å¯æå‡è‡³ root æƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu 4.4, 4.15, 5.4, and 5.8 kernels (å…·ä½“ç‰ˆæœ¬å·è§æ¼æ´åº“ä¿¡æ¯)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç›®æ ‡ç³»ç»Ÿå­˜åœ¨æœªä¿®å¤çš„ Ubuntu kernelï¼Œä¸”å¯ç”¨ unprivileged user namespaces å’Œå…è®¸ unprivileged overlayfs mountsã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

è¯¥æ¼æ´å­˜åœ¨äº Ubuntu å†…æ ¸çš„ OverlayFS å®ç°ä¸­ï¼Œç”±äºæœªæ­£ç¡®éªŒè¯ç”¨æˆ·å‘½åç©ºé—´ä¸­åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸Šæ–‡ä»¶ capabilities çš„è®¾ç½®ï¼Œå¯¼è‡´æœ¬åœ°æ”»å‡»è€…å¯åˆ©ç”¨ unprivileged user namespaces å’Œ Ubuntu å†…æ ¸ä¸­å…è®¸ unprivileged overlayfs mounts çš„è¡¥ä¸æ¥æå‡æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ (lower, upper, work, merge)ã€‚
2.  **é…ç½® User Namespace:** åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´ã€‚
3.  **é…ç½® OverlayFS:** ä½¿ç”¨ lowerdir, upperdir, å’Œ workdir é€‰é¡¹æŒ‚è½½ overlay æ–‡ä»¶ç³»ç»Ÿã€‚
4.  **è®¾ç½® Capabilities:** å°†å¯æ‰§è¡Œæ–‡ä»¶å¤åˆ¶åˆ° merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½®å…¶ capabilities (å¦‚ CAP_SETUID, CAP_SETGID, CAP_CHOWN)ã€‚
5.  **è§¦å‘ææƒ:** æ‰§è¡Œ merge ç›®å½•ä¸­çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶å°†ä¼šä»¥ root æƒé™æ‰§è¡Œã€‚

**æŠ•æ¯’é£é™©è¯„ä¼°ï¼š**

æä¾›çš„ `exploit.c` ä»£ç ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨ OverlayFS çš„æ¼æ´è¿›è¡Œææƒã€‚ä»£ç åˆ›å»ºå¿…è¦çš„ç›®å½•ï¼Œé…ç½® user namespace å’Œ overlay æ–‡ä»¶ç³»ç»Ÿï¼Œå¹¶è®¾ç½®å¯æ‰§è¡Œæ–‡ä»¶çš„ capabilitiesã€‚ä»£ç é€»è¾‘æ¸…æ™°ï¼Œæ²¡æœ‰å‘ç°æ¶æ„ä»£ç æˆ–åé—¨ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**

æä¾›çš„ POC ä»£ç åŸºäºå…¬å¼€ä¿¡æ¯ï¼Œå¹¶é’ˆå¯¹ CVE-2021-3493 æ¼æ´è¿›è¡Œäº†åˆ©ç”¨ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯ã€æœç´¢å¼•æ“ç»“æœå’Œä»£ç åˆ†æï¼Œè¯¥ POC ä»£ç åœ¨æ»¡è¶³æ¼æ´åˆ©ç”¨æ¡ä»¶çš„æƒ…å†µä¸‹åº”è¯¥æ˜¯æœ‰æ•ˆçš„ã€‚

**é¡¹ç›®åœ°å€:** [oneoy/CVE-2021-3493](https://github.com/oneoy/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #11

**æ¥æº**: [CVE-2021-3493-pmihsan_OverlayFS-CVE-2021-3493.md](../2021/CVE-2021-3493-pmihsan_OverlayFS-CVE-2021-3493.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœ¬åœ°ç”¨æˆ·å¯æå‡è‡³ root æƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu kernel versions: < 5.8.0-50.56 (5.8 kernel), < 5.4.0-72.80 (5.4 kernel), < 4.15.0-142.146 (4.15 kernel), < 4.4.0-209.241 (4.4 kernel)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦åœ¨å­˜åœ¨æ¼æ´çš„ Ubuntu ç³»ç»Ÿä¸Šæ‰§è¡Œï¼Œå¹¶ä¸”å…è®¸ unprivileged user namespaces å’Œ overlay mountsã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

CVE-2021-3493 æ¼æ´å­˜åœ¨äº Linux å†…æ ¸çš„ overlayfs å®ç°ä¸­ã€‚ç”±äºå¯¹ç”¨æˆ·å‘½åç©ºé—´ä¸­åº•å±‚æ–‡ä»¶ç³»ç»Ÿæ–‡ä»¶ capabilities çš„éªŒè¯ä¸è¶³ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡åˆ›å»ºæ¶æ„çš„ overlayfs æ–‡ä»¶ç³»ç»Ÿï¼Œåˆ©ç”¨ setxattr è®¾ç½®æ–‡ä»¶ capabilitiesï¼Œä»è€Œè·å¾—æå‡çš„æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** åˆ›å»º overlayfs æ‰€éœ€çš„ç›®å½•ç»“æ„ (lower, upper, work, merge)ã€‚
2.  **Namespace åˆ›å»ºï¼š** åˆ›å»ºæ–°çš„ user namespace å’Œ mount namespaceï¼Œéš”ç¦»æƒé™ã€‚
3.  **æƒé™è®¾ç½®ï¼š** ä¿®æ”¹ uid_map å’Œ gid_mapï¼Œä½¿å¾—åœ¨ user namespace ä¸­æ‹¥æœ‰ root æƒé™ã€‚
4.  **Overlayfs Mountï¼š** ä½¿ç”¨ overlayfs mount å‘½ä»¤å°† lowerdir, upperdir, workdir æŒ‚è½½åˆ° mergedirã€‚
5.  **Capabilities è®¾ç½®ï¼š** å¤åˆ¶è‡ªèº«ç¨‹åºåˆ° merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` å‡½æ•°ä¸ºå¤åˆ¶åçš„ç¨‹åºè®¾ç½® capabilities (CAP_SETUID, CAP_SETGID, CAP_DAC_OVERRIDE ç­‰)ã€‚
6.  **æƒé™æå‡ï¼š** æ‰§è¡Œ merge ç›®å½•ä¸‹çš„ç¨‹åºï¼Œæ­¤æ—¶ç¨‹åºå°†ä»¥ root æƒé™è¿è¡Œã€‚

**æœ‰æ•ˆæ€§ï¼š**

æä¾›çš„ POC ä»£ç é€šè¿‡åˆ©ç”¨ overlayfs æ¼æ´ï¼Œå¯ä»¥æˆåŠŸåœ°æå‡æƒé™ã€‚POC ä»£ç é¦–å…ˆåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼Œç„¶ååˆ›å»ºä¸€ä¸ªæ–°çš„ user namespace å’Œ mount namespaceï¼Œæ¥ç€æŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿï¼Œå¹¶ä½¿ç”¨ `setxattr` å‡½æ•°ä¸ºæ–‡ä»¶è®¾ç½® capabilitiesã€‚æœ€åï¼Œæ‰§è¡Œè¯¥æ–‡ä»¶å³å¯è·å¾— root æƒé™ã€‚

**æŠ•æ¯’é£é™©ï¼š**

åˆ†æ POC ä»£ç ï¼Œæ²¡æœ‰å‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç ï¼Œä¾‹å¦‚åå¼¹ shellã€å®‰è£…åé—¨ç­‰ã€‚ä»£ç é€»è¾‘ä¸»è¦é›†ä¸­åœ¨åˆ©ç”¨ overlayfs æ¼æ´ææƒï¼Œå¹¶æ²¡æœ‰é¢å¤–çš„æ“ä½œæ¥æ¤å…¥æ¶æ„ç¨‹åºã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ï¼Œå¯ä»¥è®¤ä¸ºæ˜¯ 0%ã€‚å‚è€ƒçš„ vulnerability description å’Œ exploit ä»£ç éƒ½ç€é‡äºææƒï¼Œè€Œæ²¡æœ‰æåˆ°ä»»ä½•æŠ•æ¯’è¡Œä¸ºã€‚

**é¡¹ç›®åœ°å€:** [pmihsan/OverlayFS-CVE-2021-3493](https://github.com/pmihsan/OverlayFS-CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #12

**æ¥æº**: [CVE-2021-3493-ptkhai15_OverlayFS---CVE-2021-3493.md](../2021/CVE-2021-3493-ptkhai15_OverlayFS---CVE-2021-3493.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Ubuntu Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœ¬åœ°ç”¨æˆ·æå‡æƒé™è‡³ root

**å½±å“ç‰ˆæœ¬:** Ubuntu kernel versions 5.8, 5.4, 4.15, å’Œ 4.4 ä¸­å—å½±å“çš„ç‰ˆæœ¬ï¼ˆå…·ä½“ç‰ˆæœ¬å‚è§æ¼æ´åº“ä¿¡æ¯ï¼‰

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡ç³»ç»Ÿå¿…é¡»æ˜¯å—å½±å“çš„ Ubuntu ç‰ˆæœ¬ï¼Œå¹¶ä¸”å¯ç”¨äº†éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å’Œéç‰¹æƒ overlayfs æŒ‚è½½ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

CVE-2021-3493 æ˜¯ Ubuntu Linux å†…æ ¸ä¸­ OverlayFS å®ç°ä¸­çš„ä¸€ä¸ªæ¼æ´ã€‚è¯¥æ¼æ´å…è®¸éç‰¹æƒç”¨æˆ·åˆ©ç”¨ç”¨æˆ·å‘½åç©ºé—´å’Œéç‰¹æƒ overlayfs æŒ‚è½½ï¼Œé€šè¿‡ä¸æ­£ç¡®åœ°éªŒè¯åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­æ–‡ä»¶çš„ capabilities è®¾ç½®æ¥æå‡æƒé™ã€‚åˆ©ç”¨æ–¹å¼å¦‚ä¸‹ï¼š

1.  **ç¯å¢ƒå‡†å¤‡ï¼š**  åˆ›å»ºä¸€ä¸ªåŸºç¡€ç›®å½•ç»“æ„ï¼ŒåŒ…æ‹¬ workã€lowerã€upper å’Œ merge ç›®å½•ï¼Œè¿™æ˜¯ overlayfs çš„æ ‡å‡†é…ç½®ã€‚
2.  **åˆ›å»ºç”¨æˆ·å‘½åç©ºé—´ï¼š**  ä½¿ç”¨ `unshare` å‘½ä»¤åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´ã€‚è¿™å…è®¸åœ¨æ–°çš„å‘½åç©ºé—´ä¸­æ‹¥æœ‰ä¸åŒçš„ç”¨æˆ·å’Œç»„ IDã€‚
3.  **é…ç½®ç”¨æˆ·å’Œç»„æ˜ å°„ï¼š**  é€šè¿‡ `/proc/self/setgroups`ã€`/proc/self/uid_map` å’Œ `/proc/self/gid_map` æ–‡ä»¶è®¾ç½®ç”¨æˆ·å’Œç»„ ID æ˜ å°„ï¼Œå°†å½“å‰ç”¨æˆ·çš„ UID å’Œ GID æ˜ å°„åˆ°æ–°å‘½åç©ºé—´ä¸­çš„ root ç”¨æˆ·ã€‚
4.  **æŒ‚è½½ OverlayFSï¼š**  ä½¿ç”¨ `mount` å‘½ä»¤æŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿï¼Œå°† lowerã€upper å’Œ work ç›®å½•å…³è”èµ·æ¥ã€‚
5.  **è®¾ç½®æ–‡ä»¶ capabilitiesï¼š**  å¤åˆ¶å½“å‰æ‰§è¡Œç¨‹åºåˆ° overlayfs çš„ merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½®æ–‡ä»¶çš„ capabilities ä¸º `all+ep`ï¼Œå…è®¸è¯¥æ–‡ä»¶æ‰§è¡Œæ—¶æ‹¥æœ‰ root æƒé™ã€‚
6.  **æ‰§è¡Œææƒåçš„ç¨‹åºï¼š**  æ‰§è¡Œä½äº upper ç›®å½•ä¸­çš„å¤åˆ¶åçš„ç¨‹åºã€‚å¦‚æœç¨‹åºæ£€æµ‹åˆ°è‡ªå·±æ˜¯é€šè¿‡ç‰¹å®šæ–¹å¼ï¼ˆä¾‹å¦‚ï¼ŒåŒ…å« "magic" å­—ç¬¦ä¸²æˆ–æ¥å— "shell" å‚æ•°ï¼‰è°ƒç”¨çš„ï¼Œå®ƒä¼šè°ƒç”¨ `setuid(0)` å’Œ `setgid(0)` å°†è¿›ç¨‹çš„ UID å’Œ GID è®¾ç½®ä¸º 0 (root)ï¼Œå¹¶å¯åŠ¨ä¸€ä¸ª root shellã€‚

**å…³äºæŠ•æ¯’é£é™©ï¼š**

åœ¨æä¾›çš„ POC ä»£ç ä¸­ï¼Œæ²¡æœ‰æ˜æ˜¾çš„æŠ•æ¯’ä»£ç ã€‚POC çš„ç›®çš„æ˜¯æ¼”ç¤ºæ¼æ´åˆ©ç”¨è¿‡ç¨‹ï¼Œæ²¡æœ‰å‘ç°æ¶æ„è¡Œä¸ºï¼Œä¾‹å¦‚åå‘ shell æˆ–å…¶ä»–æœªç»æˆæƒçš„è®¿é—®ã€‚


**é¡¹ç›®åœ°å€:** [ptkhai15/OverlayFS---CVE-2021-3493](https://github.com/ptkhai15/OverlayFS---CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #13

**æ¥æº**: [CVE-2021-3493-puckiestyle_CVE-2021-3493.md](../2021/CVE-2021-3493-puckiestyle_CVE-2021-3493.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ”»å‡»è€…å¯åˆ©ç”¨æ­¤æ¼æ´è·å¾— root æƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu 5.8 kernel (< 5.8.0-50.56), 5.4 kernel (< 5.4.0-72.80), 4.15 kernel (< 4.15.0-142.146), 4.4 kernel (< 4.4.0-209.241)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ Ubuntu ç³»ç»Ÿå¼€å¯ unprivileged user namespaces å’Œå…è®¸ unprivileged overlay mounts

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2021-3493 æ˜¯ Ubuntu å†…æ ¸ overlayfs å®ç°ä¸­çš„ä¸€ä¸ªæ¼æ´ï¼Œå…è®¸æœ¬åœ°æ”»å‡»è€…é€šè¿‡æ»¥ç”¨ user namespaces å’Œ overlayfs æŒ‚è½½æœºåˆ¶æå‡æƒé™ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**
æä¾›çš„ POC ä»£ç å°è¯•åˆ©ç”¨è¯¥æ¼æ´ï¼Œé€šè¿‡åˆ›å»º user namespace å’Œ overlayfs æ–‡ä»¶ç³»ç»Ÿæ¥è®¾ç½®å¯æ‰§è¡Œæ–‡ä»¶çš„ capability ä½ï¼Œä½¿å…¶è·å¾— root æƒé™ã€‚ æ¼æ´åº“ä¿¡æ¯,æœç´¢å¼•æ“ç»“æœå’Œæ¼æ´åˆ©ç”¨ä»£ç ä¸€è‡´,è¡¨æ˜è¯¥æ¼æ´çš„POCæ˜¯çœŸå®æœ‰æ•ˆçš„ã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**
æŸ¥çœ‹ `exploit.c` ä»£ç ï¼Œä¸»è¦æ“ä½œåŒ…æ‹¬åˆ›å»ºç›®å½•ã€è®¾ç½® user namespaceã€æŒ‚è½½ overlayfsã€å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶ã€è®¾ç½® capability å±æ€§ï¼Œä»¥åŠæ‰§è¡Œå¤åˆ¶åçš„æ–‡ä»¶ä»¥è·å¾— root æƒé™ã€‚ä»£ç é€»è¾‘è¾ƒä¸ºæ¸…æ™°ï¼Œæœªå‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç ã€‚`README.md` ä¹Ÿè¯´æ˜äº†å¹¶éä½œè€…åŸåˆ›,åªæ˜¯æ¬è¿,å¢åŠ äº†åˆ†æéš¾åº¦.
`exploit.c`ä¸­å­˜åœ¨`system(buf);` è°ƒç”¨ï¼Œè™½ç„¶è¿™é‡Œæ˜¯ç”¨äºæ¸…ç†ç›®å½•ï¼Œä½†å¦‚æœè¢«ç¯¡æ”¹ï¼Œå¯èƒ½æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£é™©è¯„ä¼°ä¸º10%ã€‚ä¸»è¦çš„é£é™©åœ¨äºï¼š

*   `system()` å‡½æ•°æ½œåœ¨çš„å‘½ä»¤æ³¨å…¥é£é™©ï¼Œå¦‚æœä»£ç è¢«ä¿®æ”¹ï¼Œå¯èƒ½å¯¼è‡´æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  åˆ©ç”¨ unshare() åˆ›å»ºä¸€ä¸ªæ–°çš„ user namespace å’Œ mount namespaceã€‚
2.  é…ç½® user namespace çš„ uid_map å’Œ gid_mapï¼Œå°†å½“å‰ç”¨æˆ·æ˜ å°„ä¸º root ç”¨æˆ·ã€‚
3.  åˆ›å»º overlayfs æ‰€éœ€çš„ç›®å½•ç»“æ„ï¼ˆlowerdirã€upperdirã€workdirã€mergedï¼‰ã€‚
4.  æŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿã€‚
5.  å°†æ¼æ´åˆ©ç”¨ç¨‹åºè‡ªèº«å¤åˆ¶åˆ° overlayfs çš„ upperdir/merged ç›®å½•ã€‚
6.  ä½¿ç”¨ setxattr() è®¾ç½®å¤åˆ¶åçš„å¯æ‰§è¡Œæ–‡ä»¶çš„ security.capability å±æ€§ï¼Œèµ‹äºˆå…¶ CAP_SETUID å’Œ CAP_SETGID æƒé™ã€‚
7.  æ‰§è¡Œå¤åˆ¶åçš„ç¨‹åºï¼Œç”±äºè®¾ç½®äº† capabilityï¼Œè¯¥ç¨‹åºä¼šä»¥ root æƒé™è¿è¡Œï¼Œä»è€Œè·å¾— root shellã€‚

**é¡¹ç›®åœ°å€:** [puckiestyle/CVE-2021-3493](https://github.com/puckiestyle/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #14

**æ¥æº**: [CVE-2021-3493-smallkill_CVE-2021-3493.md](../2021/CVE-2021-3493-smallkill_CVE-2021-3493.md)

# CVE-2021-3493

> ğŸ“¦ è¯¥CVEæœ‰ **15** ä¸ªç›¸å…³POCä»“åº“

---

## POC #1

**æ¥æº**: [CVE-2021-3493-Abdennour-py_CVE-2021-3493.md](../2021/CVE-2021-3493-Abdennour-py_CVE-2021-3493.md)

## CVE-2021-3493 Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å¯¼è‡´æ™®é€šç”¨æˆ·æå‡ä¸ºrootæƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu 5.8 kernel < 5.8.0-50.56, 5.4 kernel < 5.4.0-72.80, 4.15 kernel < 4.15.0-142.146, 4.4 kernel < 4.4.0-209.241

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç›®æ ‡ç³»ç»Ÿè¿è¡Œå—å½±å“çš„Ubuntuå†…æ ¸ï¼Œå¹¶ä¸”å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿå’Œä½¿ç”¨user namespace

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

è¯¥æ¼æ´æºäºUbuntuå†…æ ¸ä¸­overlayfså®ç°å¯¹ç”¨æˆ·å‘½åç©ºé—´ä¸­çš„æ–‡ä»¶èƒ½åŠ›éªŒè¯ä¸å½“ã€‚ç»“åˆéç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å’ŒUbuntuå†…æ ¸ä¸­çš„å…è®¸éç‰¹æƒ overlayfs æŒ‚è½½çš„è¡¥ä¸ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´è·å¾—æå‡çš„æƒé™ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**

æä¾›çš„POCä»£ç çœ‹èµ·æ¥æ˜¯æœ‰æ•ˆçš„ã€‚å®ƒåˆ©ç”¨äº† overlayfs å’Œ user namespace çš„ç»„åˆæ¥è®¾ç½®æ–‡ä»¶ capabilityï¼Œä»è€Œå®ç°ææƒã€‚ä»£ç é¦–å…ˆåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼ˆlower, upper, work, mergeï¼‰ï¼Œç„¶åä½¿ç”¨ `unshare` åˆ›å»ºä¸€ä¸ªæ–°çš„ user namespace å’Œ mount namespaceã€‚æ¥ç€ï¼Œå®ƒå†™å…¥ `/proc/self/setgroups`, `/proc/self/uid_map`, å’Œ `/proc/self/gid_map` æ¥è®¾ç½®ç”¨æˆ·å’Œç»„çš„æ˜ å°„ã€‚ç„¶åï¼ŒæŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿï¼Œæ‹·è´è‡ªèº«å¯æ‰§è¡Œæ–‡ä»¶åˆ° overlayfs çš„ merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½® capabilitiesã€‚æœ€åï¼Œå®ƒæ‰§è¡Œä½äº upper ç›®å½•çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶ä¼šå°è¯•ä»¥ root æƒé™æ‰§è¡Œ /bin/bashã€‚

æ ¹æ®æ¼æ´åº“ä¿¡æ¯ï¼ŒCISA å°†æ­¤æ¼æ´æ·»åŠ åˆ°å·²çŸ¥è¢«åˆ©ç”¨çš„æ¼æ´åˆ—è¡¨ä¸­ï¼Œè¿›ä¸€æ­¥è¡¨æ˜äº†è¯¥æ¼æ´çš„æœ‰æ•ˆæ€§ã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

æ£€æŸ¥æä¾›çš„ exploit.c ä»£ç ï¼Œæ²¡æœ‰å‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç æˆ–åé—¨ã€‚ä»£ç é€»è¾‘æ¸…æ™°ï¼Œä¸»è¦æ‰§è¡Œäº† overlayfs çš„æŒ‚è½½ï¼Œæ–‡ä»¶å¤åˆ¶ï¼Œè®¾ç½® xattr å’Œæ‰§è¡Œ shell æ“ä½œã€‚ä»£ç çš„æ„å›¾ä¸æ¼æ´æè¿°ä¸€è‡´ï¼Œæ²¡æœ‰å‘ç°éšè—çš„ã€ä¸æ¼æ´åˆ©ç”¨æ— å…³çš„æ¶æ„è¡Œä¸ºã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£é™©ä¸º 0%ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š**  åœ¨å­˜åœ¨æ¼æ´çš„Ubuntuç³»ç»Ÿä¸Šï¼Œåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ (ovlcap/work, ovlcap/lower, ovlcap/upper, ovlcap/merge)ã€‚
2.  **User Namespaceå’ŒMount Namespaceï¼š** ä½¿ç”¨ `unshare` ç³»ç»Ÿè°ƒç”¨åˆ›å»ºæ–°çš„ user namespace å’Œ mount namespaceã€‚
3.  **IDæ˜ å°„ï¼š**  é…ç½® `/proc/self/setgroups`ï¼Œ`/proc/self/uid_map` å’Œ `/proc/self/gid_map`ï¼Œä»¥ä¾¿åœ¨ user namespace ä¸­è·å¾—æœ‰æ•ˆçš„ç”¨æˆ· ID å’Œç»„ IDã€‚
4.  **OverlayFSæŒ‚è½½ï¼š**  ä½¿ç”¨ `mount` ç³»ç»Ÿè°ƒç”¨æŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿï¼Œå°† lower, upper å’Œ work ç›®å½•å…³è”èµ·æ¥ã€‚
5.  **æ–‡ä»¶æ‹·è´ä¸ Capability è®¾ç½®ï¼š**  å°† exploit ç¨‹åºè‡ªèº«æ‹·è´åˆ° overlayfs çš„ merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½® `security.capability` å±æ€§ï¼Œèµ‹äºˆå…¶ CAP_SETUID å’Œ CAP_SETGID ç­‰æƒé™ã€‚
6.  **ææƒæ‰§è¡Œï¼š** æ‰§è¡Œä½äº upper ç›®å½•çš„ exploit ç¨‹åºçš„æ‹·è´ã€‚ç”±äºè¯¥æ–‡ä»¶å…·æœ‰ capabilitiesï¼Œå› æ­¤å¯ä»¥ä»¥ root æƒé™æ‰§è¡Œ shellã€‚

**é¡¹ç›®åœ°å€:** [Abdennour-py/CVE-2021-3493](https://github.com/Abdennour-py/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #2

**æ¥æº**: [CVE-2021-3493-Sornphut_OverlayFS---CVE-2021-3493.md](../2021/CVE-2021-3493-Sornphut_OverlayFS---CVE-2021-3493.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒæ¼æ´

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Ubuntu Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœ¬åœ°ç”¨æˆ·è·å¾— root æƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu kernels before 5.8.0-50.56, 5.4.0-72.80, 4.15.0-142.146, and 4.4.0-209.241

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦è¿è¡Œåœ¨å­˜åœ¨æ¼æ´çš„ Ubuntu å†…æ ¸ä¸Šï¼Œå¹¶ä¸”å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½ overlayfsã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

è¯¥æ¼æ´å­˜åœ¨äº Ubuntu Linux å†…æ ¸çš„ overlayfs å®ç°ä¸­ã€‚ç”±äº Ubuntu å¯¹ overlayfs æŒ‚è½½çš„ç‰¹å®šä¿®æ”¹ï¼Œå¯¼è‡´åœ¨ç”¨æˆ·å‘½åç©ºé—´å†…ï¼Œå¯¹åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­çš„æ–‡ä»¶ capabilities éªŒè¯ä¸å……åˆ†ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡ overlayfs æŒ‚è½½ç»•è¿‡ capabilities æ£€æŸ¥ï¼Œè®¾ç½®æ–‡ä»¶ capabilities æå‡æƒé™ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  åˆ›å»ºä¸€ä¸ªç›®å½•ç»“æ„ï¼ŒåŒ…æ‹¬ lower, upper, work å’Œ merge ç›®å½•ã€‚
2.  ä½¿ç”¨ `unshare` åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´å’ŒæŒ‚è½½å‘½åç©ºé—´ã€‚
3.  é…ç½® `/proc/self/setgroups`, `/proc/self/uid_map`, å’Œ `/proc/self/gid_map` ä»¥æ˜ å°„ç”¨æˆ· ID å’Œç»„ IDã€‚
4.  ä½¿ç”¨ `mount` å‘½ä»¤æŒ‚è½½ overlayfsï¼Œå°† lower, upper å’Œ work ç›®å½•ä¸ merge ç›®å½•å…³è”èµ·æ¥ã€‚
5.  åœ¨ upper ç›®å½•æˆ– merge ç›®å½•ä¸‹åˆ›å»ºæˆ–å¤åˆ¶ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ã€‚
6.  ä½¿ç”¨ `setxattr` è®¾ç½®å¯æ‰§è¡Œæ–‡ä»¶çš„ capabilitiesï¼Œèµ‹äºˆå…¶ root æƒé™ã€‚
7.  æ‰§è¡Œè¯¥æ–‡ä»¶ï¼Œå³å¯è·å¾— root æƒé™ã€‚

**æœ‰æ•ˆæ€§ï¼š**

æä¾›çš„ POC ä»£ç å°è¯•åˆ©ç”¨ CVE-2021-3493 æ¼æ´ã€‚è¯¥ä»£ç åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´å’ŒæŒ‚è½½å‘½åç©ºé—´ï¼Œå¹¶å°è¯•æŒ‚è½½ overlayfsã€‚ç„¶åï¼Œå®ƒåº”è¯¥è®¾ç½® `magic` äºŒè¿›åˆ¶æ–‡ä»¶çš„ capabilitiesï¼Œä»è€Œè·å¾— root æƒé™ã€‚æ ¹æ®æ¼æ´æè¿°ï¼Œè¯¥ POC åº”è¯¥èƒ½å¤Ÿæœ‰æ•ˆåˆ©ç”¨è¯¥æ¼æ´ã€‚

**æŠ•æ¯’é£é™©ï¼š**

æ£€æŸ¥æä¾›çš„ exploit.c æ–‡ä»¶ï¼Œæœªå‘ç°æ˜æ˜¾çš„æ¶æ„æˆ–éšè—ä»£ç ã€‚ä»£ç é€»è¾‘ä¸»è¦é›†ä¸­äºè®¾ç½® overlayfs æŒ‚è½½å’Œæ–‡ä»¶ capabilitiesã€‚ä½†æ˜¯ï¼Œéœ€è¦å§‹ç»ˆè°¨æ…å¯¹å¾…æ¥è‡ªä¸å—ä¿¡ä»»æ¥æºçš„ä»£ç ã€‚ä¸ºäº†ç¡®ä¿å®‰å…¨ï¼Œå»ºè®®åœ¨å—æ§ç¯å¢ƒä¸­ä»”ç»†å®¡æŸ¥å’Œæµ‹è¯•ä»£ç ã€‚


**é¡¹ç›®åœ°å€:** [Sornphut/OverlayFS---CVE-2021-3493](https://github.com/Sornphut/OverlayFS---CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #3

**æ¥æº**: [CVE-2021-3493-briskets_CVE-2021-3493.md](../2021/CVE-2021-3493-briskets_CVE-2021-3493.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å¯¼è‡´æ™®é€šç”¨æˆ·æƒé™æå‡è‡³rootæƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu kernel versions: < 5.8.0-50.56 (5.8 kernel), < 5.4.0-72.80 (5.4 kernel), < 4.15.0-142.146 (4.15 kernel), < 4.4.0-209.241 (4.4 kernel)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦åœ¨å­˜åœ¨æ¼æ´çš„Ubuntuå†…æ ¸ç‰ˆæœ¬ä¸Šï¼Œå¹¶ä¸”å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½overlayfs

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 5%

## è¯¦æƒ…

CVE-2021-3493 æ¼æ´æ˜¯ç”±äº Linux å†…æ ¸çš„ overlayfs å®ç°æ²¡æœ‰æ­£ç¡®éªŒè¯ç”¨æˆ·å‘½åç©ºé—´ä¸­åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸Šæ–‡ä»¶ capabilities çš„è®¾ç½®ã€‚ç”±äº Ubuntu å†…æ ¸ä¸­å­˜åœ¨å…è®¸éç‰¹æƒ overlay æŒ‚è½½çš„è¡¥ä¸ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´è·å¾—æå‡çš„æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  æ¼æ´åˆ©ç”¨ä»£ç é¦–å…ˆåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ (ovlcap/work, ovlcap/lower, ovlcap/upper, ovlcap/merge)ã€‚
2.  åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´å’ŒæŒ‚è½½å‘½åç©ºé—´ã€‚
3.  åœ¨æ–°çš„ç”¨æˆ·å‘½åç©ºé—´ä¸­ï¼Œå°†å½“å‰ç”¨æˆ·çš„ UID å’Œ GID æ˜ å°„åˆ° root ç”¨æˆ·ã€‚
4.  ä½¿ç”¨ overlayfs å°† lowerdir (ovlcap/lower), upperdir (ovlcap/upper) å’Œ workdir (ovlcap/work) æŒ‚è½½åˆ° mergedir (ovlcap/merge)ã€‚
5.  å¤åˆ¶è‡ªèº« (exploit ç¨‹åº) åˆ° mergedir/magicï¼Œå¹¶è®¾ç½® security.capability æ‰©å±•å±æ€§ä¸º all+epï¼Œèµ‹äºˆè¯¥æ–‡ä»¶ capabilitiesã€‚
6.  æ‰§è¡Œ mergedir/magicï¼Œç”±äº capabilities çš„è®¾ç½®ï¼Œè¯¥ç¨‹åºä¼šä»¥ root æƒé™æ‰§è¡Œã€‚
7.  æœ€åï¼Œæ‰§è¡Œ upperdir/magicï¼Œå¯åŠ¨ä¸€ä¸ª root shellã€‚

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„POCä»£ç æ˜¯æœ‰æ•ˆçš„ï¼Œèƒ½å¤Ÿåˆ©ç”¨ CVE-2021-3493 æ¼æ´åœ¨å—å½±å“çš„ Ubuntu ç³»ç»Ÿä¸Šå®ç°æœ¬åœ°ææƒã€‚

**æŠ•æ¯’é£é™©ï¼š**
è¯¥POCä»£ç çš„ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´è¿›è¡Œææƒï¼Œä½†ä»ç„¶å­˜åœ¨æ½œåœ¨çš„æŠ•æ¯’é£é™©ã€‚æ¯”å¦‚ä½œè€…å¯èƒ½åœ¨ç¼–è¯‘å’Œè¿è¡Œå‰æ·»åŠ ä¸€äº›æ¶æ„ä»£ç ï¼Œä¾‹å¦‚ï¼š

1.  **åé—¨æ¤å…¥ï¼š** åœ¨ææƒæˆåŠŸåï¼Œæ¤å…¥ä¸€ä¸ªåé—¨ç¨‹åºï¼Œå…è®¸æ”»å‡»è€…è¿œç¨‹è®¿é—®ç³»ç»Ÿã€‚
2.  **æ•°æ®çªƒå–ï¼š** åœ¨ææƒè¿‡ç¨‹ä¸­ï¼Œçªƒå–ç”¨æˆ·çš„æ•æ„Ÿæ•°æ®ã€‚
3.  **ç ´åç³»ç»Ÿï¼š** åœ¨ææƒå¤±è´¥æˆ–è€…æˆåŠŸåï¼Œç ´åç³»ç»Ÿæ–‡ä»¶æˆ–è€…é…ç½®ã€‚

è€ƒè™‘åˆ°ä»£ç ç›¸å¯¹ç®€çŸ­ä¸”åŠŸèƒ½æ˜ç¡®ï¼Œè¯„ä¼°æŠ•æ¯’é£é™©ä¸º5%ã€‚ç”¨æˆ·éœ€è¦ä»”ç»†å®¡æŸ¥ä»£ç ï¼Œå¹¶åœ¨å®‰å…¨çš„ç¯å¢ƒä¸­è¿›è¡Œæµ‹è¯•ã€‚

**é¡¹ç›®åœ°å€:** [briskets/CVE-2021-3493](https://github.com/briskets/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #4

**æ¥æº**: [CVE-2021-3493-cyberx-1_OverlayFS-CVE-2021-3493.md](../2021/CVE-2021-3493-cyberx-1_OverlayFS-CVE-2021-3493.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯ä»æ™®é€šç”¨æˆ·ææƒè‡³root

**å½±å“ç‰ˆæœ¬:** Ubuntu kernels: 5.8.0-50.56 (5.8 kernel), 5.4.0-72.80 (5.4 kernel), 4.15.0-142.146 (4.15 kernel), 4.4.0-209.241 (4.4 kernel)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦è¿è¡Œåœ¨å­˜åœ¨æ¼æ´çš„Ubuntuå†…æ ¸ç‰ˆæœ¬ä¸Šï¼Œå¯ç”¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å’Œå…è®¸éç‰¹æƒ overlay mountsã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2021-3493æ˜¯Ubuntuå†…æ ¸OverlayFSå®ç°ä¸­çš„ä¸€ä¸ªæƒé™æå‡æ¼æ´ã€‚ç”±äºoverlayfsåœ¨ç”¨æˆ·å‘½åç©ºé—´ä¸­æ²¡æœ‰æ­£ç¡®éªŒè¯åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­æ–‡ä»¶åŠŸèƒ½è®¾ç½®ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å’ŒUbuntuå†…æ ¸ä¸­çš„éç‰¹æƒoverlayæŒ‚è½½è¡¥ä¸ï¼Œè·å–æå‡çš„æƒé™ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** åœ¨å­˜åœ¨æ¼æ´çš„Ubuntuå†…æ ¸ä¸Šï¼Œç¡®ä¿å¯ç”¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´ã€‚æ¼æ´åº“ä¿¡æ¯æåˆ°ç¦ç”¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å¯ä»¥ä½œä¸ºç¼“è§£æªæ–½ï¼Œæ‰€ä»¥è¦ç¡®ä¿å¯ç”¨ã€‚
2.  **åˆ›å»ºOverlayFSç»“æ„ï¼š** PoCä»£ç é¦–å…ˆåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼ˆlower, upper, work, mergeï¼‰ç”¨äº overlayfs æ–‡ä»¶ç³»ç»Ÿã€‚
3.  **åˆ›å»ºç”¨æˆ·å‘½åç©ºé—´ï¼š** ä½¿ç”¨`unshare`ç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´ã€‚è¿™å…è®¸åœ¨æ–°çš„å‘½åç©ºé—´ä¸­æ‹¥æœ‰ä¸åŒçš„ç”¨æˆ·IDå’Œç»„IDæ˜ å°„ã€‚
4.  **è®¾ç½®UID/GIDæ˜ å°„ï¼š** å°†å½“å‰ç”¨æˆ·çš„UIDå’ŒGIDæ˜ å°„åˆ°æ–°å‘½åç©ºé—´ä¸­çš„rootç”¨æˆ· (UID 0 å’Œ GID 0)ã€‚
5.  **æŒ‚è½½OverlayFSï¼š** ä½¿ç”¨`mount`ç³»ç»Ÿè°ƒç”¨å°† overlayfs æ–‡ä»¶ç³»ç»ŸæŒ‚è½½åˆ° merge ç›®å½•ã€‚æŒ‡å®š lowerdir, upperdir å’Œ workdirã€‚
6.  **å¤åˆ¶è‡ªèº«å¹¶è®¾ç½®Capabilitiesï¼š** å°†è‡ªèº«å¯æ‰§è¡Œæ–‡ä»¶å¤åˆ¶åˆ° overlayfs çš„ merge ç›®å½•ï¼Œç„¶åä½¿ç”¨`setxattr`è®¾ç½®`security.capability`æ‰©å±•å±æ€§ï¼Œèµ‹äºˆè¯¥æ–‡ä»¶ root æƒé™ã€‚
7.  **æ‰§è¡Œææƒåçš„ç¨‹åºï¼š** é€šè¿‡æ‰§è¡Œ upper ç›®å½•ä¸‹çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆä¹‹å‰å¤åˆ¶å¹¶è®¾ç½®äº† capabilities çš„æ–‡ä»¶ï¼‰æ¥è·å– root æƒé™ã€‚è¿™ä¸ªç¨‹åºä¼šæ£€æŸ¥æ˜¯å¦æœ‰"shell"å‚æ•°ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™ä¼šé‡æ–°æ‰§è¡Œè‡ªèº«ï¼Œä½†è¿™æ¬¡ä¼šå¸¦æœ‰`shell`å‚æ•°ï¼Œä»è€Œè§¦å‘`setuid(0)`å’Œ`setgid(0)`ï¼Œæœ€ç»ˆæ‰§è¡Œ`/bin/bash`ï¼Œè·å¾— root shellã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

ä»£ç ä¸­å­˜åœ¨ä¸€å®šçš„æŠ•æ¯’é£é™©ï¼Œè™½ç„¶ä¸»è¦é€»è¾‘æ˜¯åˆ©ç”¨æ¼æ´è¿›è¡Œææƒï¼Œä½†å­˜åœ¨ä¿®æ”¹`/bin/bash`çš„å¯èƒ½æ€§ï¼Œä½†æ˜¯ç»è¿‡ä»£ç åˆ†æä»¥åŠæ¼æ´åŸç†ï¼Œåˆ¤æ–­æ¼æ´åˆ©ç”¨è¿‡ç¨‹ä¸­æ²¡æœ‰ä¿®æ”¹`/bin/bash`æ“ä½œ,ä»£ç ä¸­é£é™©ä¸»è¦å­˜åœ¨äºä»¥ä¸‹å‡ ç‚¹:

1.  **ä¾èµ–å¤–éƒ¨äºŒè¿›åˆ¶æ–‡ä»¶ï¼š** è¯¥æ¼æ´åˆ©ç”¨ä¾èµ–äºç³»ç»Ÿä¸Šçš„`/bin/bash`ã€‚å¦‚æœæ”»å‡»è€…æ›¿æ¢æˆ–ç¯¡æ”¹äº†ç›®æ ‡ç³»ç»Ÿä¸Šçš„`/bin/bash`ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ„å¤–çš„è¡Œä¸ºæˆ–å®‰å…¨é—®é¢˜ã€‚
2.  **æ¸…ç†æ“ä½œé£é™©ï¼š** ä»£ç å¼€å§‹æ—¶ä½¿ç”¨`system(buf)`æ‰§è¡Œ`rm -rf '%s/'`ï¼Œå¦‚æœ`DIR_BASE`è¢«æ¶æ„ä¿®æ”¹ï¼Œå¯èƒ½å¯¼è‡´æ„å¤–çš„æ–‡ä»¶åˆ é™¤ã€‚
3.  **ä¸å®Œå–„çš„é”™è¯¯å¤„ç†ï¼š** è™½ç„¶ PoC ä»£ç åŒ…å«äº†ä¸€äº›é”™è¯¯å¤„ç†ï¼Œä½†åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå¦‚æœé”™è¯¯å¤„ç†ä¸å½“ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ‹’ç»æœåŠ¡æˆ–æœªå®šä¹‰çš„è¡Œä¸ºã€‚

æ€»ä½“è€Œè¨€ï¼Œè¯¥ PoC ä»£ç çš„æŠ•æ¯’é£é™©è¾ƒä½ï¼Œä¸»è¦é£é™©åœ¨äºä¾èµ–å¤–éƒ¨äºŒè¿›åˆ¶æ–‡ä»¶å’Œæ½œåœ¨çš„æ¸…ç†æ“ä½œé£é™©ã€‚ä»£ç æœ¬èº«ä¸»è¦æ˜¯ä¸ºäº†æ¼”ç¤ºæ¼æ´åˆ©ç”¨ï¼Œå¹¶æœªå‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç ã€‚ è¯„ä¼°æŠ•æ¯’é£é™©ä¸º10%ã€‚


**é¡¹ç›®åœ°å€:** [cyberx-1/OverlayFS-CVE-2021-3493](https://github.com/cyberx-1/OverlayFS-CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #5

**æ¥æº**: [CVE-2021-3493-derek-turing_CVE-2021-3493.md](../2021/CVE-2021-3493-derek-turing_CVE-2021-3493.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Ubuntu Linux Kernel

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœ¬åœ°ç”¨æˆ·å¯æå‡è‡³ root æƒé™

**å½±å“ç‰ˆæœ¬:** 4.4 <= kernel < 4.4.0-209.241, 4.15 <= kernel < 4.15.0-142.146, 5.4 <= kernel < 5.4.0-72.80, 5.8 <= kernel < 5.8.0-50.56

**åˆ©ç”¨æ¡ä»¶:** Ubuntu å†…æ ¸å¼€å¯äº† unprivileged user namespaces å’Œ unprivileged overlay mounts

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

è¯¥æ¼æ´å­˜åœ¨äº Ubuntu Linux å†…æ ¸çš„ OverlayFS å®ç°ä¸­ï¼Œç”±äº overlayfs å¯¹åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­æ–‡ä»¶ capabilities çš„è®¾ç½®éªŒè¯ä¸å½“ï¼Œç»“åˆæœªæˆæƒç”¨æˆ·å‘½åç©ºé—´å’Œ Ubuntu å†…æ ¸ä¸­å…è®¸æœªæˆæƒ overlay æŒ‚è½½çš„è¡¥ä¸ï¼Œæ”»å‡»è€…å¯åˆ©ç”¨æ­¤æ¼æ´æå‡æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** é¦–å…ˆï¼Œç¡®ä¿ç›®æ ‡ç³»ç»Ÿæ»¡è¶³æ¼æ´åˆ©ç”¨çš„æ¡ä»¶ï¼Œå³ Ubuntu å†…æ ¸ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…ï¼Œå¹¶ä¸”å¯ç”¨äº† unprivileged user namespaces å’Œ unprivileged overlay mountsã€‚æ¼æ´åº“ä¿¡æ¯ä¸­ç»™å‡ºäº†å—å½±å“çš„ç‰ˆæœ¬èŒƒå›´ã€‚
2.  **åˆ›å»ºç›®å½•ç»“æ„ï¼š** åˆ›å»º overlayfs æ‰€éœ€çš„ç›®å½•ç»“æ„ï¼ŒåŒ…æ‹¬ lowerdirï¼ˆåº•å±‚ç›®å½•ï¼‰ã€upperdirï¼ˆä¸Šå±‚ç›®å½•ï¼‰ã€workdirï¼ˆå·¥ä½œç›®å½•ï¼‰å’Œ mergedirï¼ˆåˆå¹¶ç›®å½•ï¼‰ã€‚
3.  **åˆ›å»ºç”¨æˆ·å‘½åç©ºé—´ï¼š** ä½¿ç”¨ `unshare` å‘½ä»¤åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´ï¼Œè¿™å…è®¸åœ¨éç‰¹æƒç”¨æˆ·ä¸‹æ‰§è¡Œä¸€äº›ç‰¹æƒæ“ä½œã€‚
4.  **è®¾ç½® UID/GID æ˜ å°„ï¼š** åœ¨ç”¨æˆ·å‘½åç©ºé—´ä¸­ï¼Œå°†å½“å‰ç”¨æˆ·çš„ UID å’Œ GID æ˜ å°„åˆ° root ç”¨æˆ· (UID 0) å’Œ root ç»„ (GID 0)ï¼Œè¿™æ ·åœ¨ overlayfs ä¸­åˆ›å»ºçš„æ–‡ä»¶å°†å±äº root ç”¨æˆ·ã€‚
5.  **æŒ‚è½½ OverlayFSï¼š** ä½¿ç”¨ `mount` å‘½ä»¤å°† overlayfs æŒ‚è½½åˆ° mergedirï¼ŒæŒ‡å®š lowerdirã€upperdir å’Œ workdirã€‚
6.  **å¤åˆ¶å¹¶è®¾ç½® Capabilitiesï¼š** å°† exploit ç¨‹åºè‡ªèº«å¤åˆ¶åˆ° mergedir ä¸­ï¼Œå¹¶ä½¿ç”¨ `setxattr` å‘½ä»¤è®¾ç½®å…¶ security.capability æ‰©å±•å±æ€§ï¼Œèµ‹äºˆå…¶ CAP_SETUID å’Œ CAP_SETGID capabilitiesã€‚è¿™ä¸ªcapabilitieså…è®¸ç¨‹åºåœ¨æ²¡æœ‰rootæƒé™çš„æƒ…å†µä¸‹è®¾ç½®uidå’Œgidã€‚
7.  **è§¦å‘ææƒï¼š** è¿è¡Œ mergedir ä¸­çš„ exploit ç¨‹åºï¼Œç”±äºå·²è®¾ç½® capabilitiesï¼Œç¨‹åºå°†ä»¥ root æƒé™è¿è¡Œï¼Œä»è€Œæ‰§è¡Œç‰¹æƒæ“ä½œã€‚

**ä»£ç åˆ†æï¼š**

*   `exploit.c` æ˜¯åˆ©ç”¨ä»£ç ï¼Œå®ƒåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼Œå»ºç«‹ç”¨æˆ·å‘½åç©ºé—´ï¼ŒæŒ‚è½½ overlayfsï¼Œç„¶åå°†è‡ªèº«å¤åˆ¶åˆ° overlayfs ä¸­ï¼Œå¹¶è®¾ç½® capabilitiesã€‚æœ€åï¼Œæ‰§è¡Œå¤åˆ¶åˆ° upperdir ä¸­çš„ç¨‹åºï¼Œè¯¥ç¨‹åºä¼šå°†å½“å‰è¿›ç¨‹ææƒä¸º rootã€‚
*   ä»£ç ä¸­ä½¿ç”¨äº† `setxattr` å‡½æ•°æ¥è®¾ç½®æ–‡ä»¶ capabilitiesï¼Œè¿™æ˜¯åˆ©ç”¨æ¼æ´çš„å…³é”®æ­¥éª¤ã€‚
*   mainå‡½æ•°é¦–å…ˆforkä¸€ä¸ªå­è¿›ç¨‹æ‰§è¡Œexploitå‡½æ•°ï¼Œåœ¨exploitå‡½æ•°æ‰§è¡Œå®Œæ¯•åï¼Œçˆ¶è¿›ç¨‹æ‰§è¡ŒBIN_UPPERä¸­çš„magicç¨‹åºï¼Œå¦‚æœå¸¦æœ‰shellå‚æ•°ï¼Œmagicç¨‹åºä¼šè®¾ç½®uidå’Œgidä¸º0ï¼Œå¹¶ä¸”è¿è¡Œä¸€ä¸ªbash shellã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

ä»”ç»†æ£€æŸ¥äº† POC ä»£ç ï¼Œæ²¡æœ‰å‘ç°æ˜æ˜¾çš„æŠ•æ¯’ä»£ç ã€‚ä»£ç é€»è¾‘æ¸…æ™°ï¼Œä¸»è¦ç”¨äºåˆ›å»º overlayfs ç¯å¢ƒå¹¶è®¾ç½®æ–‡ä»¶ capabilities ä»¥è¿›è¡Œææƒã€‚ä½œè€…å¹¶æ²¡æœ‰å°è¯•åœ¨ä»£ç ä¸­éšè—æ¶æ„è¡Œä¸ºï¼Œä¾‹å¦‚ï¼š

*   è¿æ¥å¤–éƒ¨æœåŠ¡å™¨
*   ä¿®æ”¹ç³»ç»Ÿæ–‡ä»¶
*   å®‰è£…åé—¨
*   æ”¶é›†ç”¨æˆ·ä¿¡æ¯

å› æ­¤ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ (0%)ã€‚

**é¡¹ç›®åœ°å€:** [derek-turing/CVE-2021-3493](https://github.com/derek-turing/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #6

**æ¥æº**: [CVE-2021-3493-fathallah17_OverlayFS-CVE-2021-3493.md](../2021/CVE-2021-3493-fathallah17_OverlayFS-CVE-2021-3493.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°æƒé™æå‡

**å½±å“åº”ç”¨:** Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å¯¼è‡´æœ¬åœ°æƒé™æå‡è‡³root

**å½±å“ç‰ˆæœ¬:** 4.4 <= Linux Kernel < 5.8.0-50.56 (Ubuntu ç‰¹å®šç‰ˆæœ¬)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦å­˜åœ¨Ubuntuå†…æ ¸ä¸­å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½OverlayFSçš„è¡¥ä¸ï¼Œä¸”ç”¨æˆ·å‘½åç©ºé—´æœªè¢«ç¦ç”¨ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 1%

## è¯¦æƒ…

CVE-2021-3493 æ˜¯ä¸€ä¸ªå­˜åœ¨äº Linux å†…æ ¸ OverlayFS å®ç°ä¸­çš„æƒé™æå‡æ¼æ´ã€‚æ¼æ´çš„æ ¹æœ¬åŸå› æ˜¯ OverlayFS åœ¨è®¾ç½®åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­æ–‡ä»¶çš„ capabilities æ—¶ï¼Œæ²¡æœ‰æ­£ç¡®åœ°éªŒè¯ç”¨æˆ·å‘½åç©ºé—´ã€‚åœ¨å­˜åœ¨å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½ OverlayFS çš„ Ubuntu å†…æ ¸è¡¥ä¸çš„ç¯å¢ƒä¸­ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´è·å¾—æå‡çš„æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š**  ç›®æ ‡ç³»ç»Ÿéœ€è¦æ˜¯å—å½±å“çš„ Ubuntu ç‰ˆæœ¬ï¼Œå¹¶ä¸”å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½ OverlayFSï¼ŒåŒæ—¶ç”¨æˆ·å‘½åç©ºé—´æ²¡æœ‰è¢«ç¦ç”¨ã€‚
2.  **è·å–æ¼æ´åˆ©ç”¨ä»£ç ï¼š**  ä»å¯ä¿¡æ¥æºè·å–æ¼æ´åˆ©ç”¨ä»£ç  (ä¾‹å¦‚ SSD-Disclosure æä¾›çš„ exploit.c)ã€‚
3.  **ç¼–è¯‘æ¼æ´åˆ©ç”¨ä»£ç ï¼š**  ä½¿ç”¨ gcc ç­‰ç¼–è¯‘å™¨å°† exploit.c ç¼–è¯‘ä¸ºå¯æ‰§è¡Œæ–‡ä»¶ã€‚
4.  **æ‰§è¡Œæ¼æ´åˆ©ç”¨ä»£ç ï¼š**  è¿è¡Œç¼–è¯‘åçš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚æ¼æ´åˆ©ç”¨ä»£ç ä¼šåˆ©ç”¨ OverlayFS çš„æ¼æ´ï¼Œé€šè¿‡è®¾ç½®æ–‡ä»¶ capabilities æ¥æå‡å½“å‰ç”¨æˆ·çš„æƒé™è‡³ rootã€‚
5.  **è·å– root æƒé™ï¼š**  æˆåŠŸæ‰§è¡Œæ¼æ´åˆ©ç”¨ä»£ç åï¼Œç”¨æˆ·å°†è·å¾— root æƒé™ã€‚

**å…³äºæŠ•æ¯’é£é™©ï¼š**

æä¾›çš„POCä»£ç åªæ˜¯ä¸€ä¸ªç®€å•çš„åˆ©ç”¨æ–¹å¼,ä¸å¤ªå¯èƒ½åŒ…å«æ¶æ„ä»£ç ã€‚ä½†å§‹ç»ˆéœ€è¦å¯¹ä»»ä½•æ¥æºçš„æ¼æ´åˆ©ç”¨ä»£ç è¿›è¡Œå®¡æŸ¥ï¼Œä»¥é™ä½é£é™©ã€‚
å¯¹ä¸‹è½½çš„æ–‡ä»¶è¿›è¡Œæ£€æŸ¥ï¼Œå¦‚å“ˆå¸Œæ ¡éªŒï¼Œå¯ä»¥æœ€å¤§ç¨‹åº¦çš„é¿å…å¼•å…¥æ¶æ„ä»£ç ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**

æ ¹æ®æ¼æ´æè¿°å’Œåˆ©ç”¨ä»£ç ï¼Œè¯¥æ¼æ´åˆ©ç”¨æ˜¯æœ‰æ•ˆçš„ã€‚åˆ©ç”¨ä»£ç é€šè¿‡OverlayFSçš„æ¼æ´ï¼Œå…è®¸ä½æƒé™ç”¨æˆ·è·å¾—rootæƒé™ã€‚

**å…¶ä»–ä¿¡æ¯:**
CISA å·²å°†æ­¤æ¼æ´æ·»åŠ åˆ°å·²çŸ¥è¢«åˆ©ç”¨çš„æ¼æ´ç›®å½• (KEV) ä¸­ï¼Œè¡¨æ˜è¯¥æ¼æ´å·²è¢«å¹¿æ³›åˆ©ç”¨ã€‚

**é¡¹ç›®åœ°å€:** [fathallah17/OverlayFS-CVE-2021-3493](https://github.com/fathallah17/OverlayFS-CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #7

**æ¥æº**: [CVE-2021-3493-fei9747_CVE-2021-3493.md](../2021/CVE-2021-3493-fei9747_CVE-2021-3493.md)

## CVE-2021-3493 Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ”»å‡»è€…å¯åˆ©ç”¨æ­¤æ¼æ´è·å– root æƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu kernel versions: < 5.8.0-50.56, < 5.4.0-72.80, < 4.15.0-142.146, < 4.4.0-209.241

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦åœ¨å­˜åœ¨æ¼æ´çš„ Ubuntu ç³»ç»Ÿä¸Šæœ¬åœ°æ‰§è¡Œ

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 5%

## è¯¦æƒ…

CVE-2021-3493 æ˜¯ä¸€ä¸ªå­˜åœ¨äº Ubuntu Linux å†…æ ¸ overlayfs å®ç°ä¸­çš„æœ¬åœ°ææƒæ¼æ´ã€‚è¯¥æ¼æ´æºäº overlayfs æœªèƒ½æ­£ç¡®éªŒè¯ç”¨æˆ·å‘½åç©ºé—´ä¸­åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸Šæ–‡ä»¶ capabilities çš„è®¾ç½®ã€‚ç»“åˆæœªæˆæƒç”¨æˆ·å‘½åç©ºé—´ä»¥åŠ Ubuntu å†…æ ¸ä¸­å…è®¸æœªæˆæƒ overlay mount çš„è¡¥ä¸ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´æå‡æƒé™ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼ŒåŒ…æ‹¬lowerdirï¼Œupperdirï¼Œworkdirå’Œmergedirã€‚
2.  **åˆ›å»ºå‘½åç©ºé—´ï¼š** ä½¿ç”¨ `unshare` ç³»ç»Ÿè°ƒç”¨åˆ›å»ºæ–°çš„ç”¨æˆ·å‘½åç©ºé—´å’ŒæŒ‚è½½å‘½åç©ºé—´ã€‚
3.  **è®¾ç½®ç”¨æˆ·å’Œç»„IDæ˜ å°„ï¼š** å°†å½“å‰ç”¨æˆ·çš„ UID å’Œ GID æ˜ å°„åˆ°æ–°çš„ç”¨æˆ·å‘½åç©ºé—´ä¸­ï¼Œä»¥ä¾¿åœ¨æ–°çš„å‘½åç©ºé—´ä¸­æ‹¥æœ‰æƒé™ã€‚
4.  **æŒ‚è½½ OverlayFSï¼š** ä½¿ç”¨ `mount` ç³»ç»Ÿè°ƒç”¨ï¼Œå°† overlayfs æŒ‚è½½åˆ° mergedirï¼Œå¹¶å°† lowerdirï¼Œupperdir å’Œ workdir æŒ‡å®šä¸ºç›¸åº”çš„ç›®å½•ã€‚
5.  **è®¾ç½® Capabilitiesï¼š** å¤åˆ¶å½“å‰æ‰§è¡Œçš„ç¨‹åºåˆ° mergedirï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½®è¯¥æ–‡ä»¶çš„ capabilitiesï¼Œä½¿å…¶å…·æœ‰ root æƒé™ã€‚ è¿™æ­¥æ˜¯æ¼æ´åˆ©ç”¨çš„å…³é”®ã€‚
6.  **æ‰§è¡ŒPayloadï¼š** æ‰§è¡Œupperç›®å½•ä¸­çš„æ–‡ä»¶ï¼Œå› ä¸ºè®¾ç½®äº†Capabilitiesï¼Œå¯ä»¥è·å¾—rootæƒé™ã€‚

**æœ‰æ•ˆæ€§ï¼š**

æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’ŒPOCä»£ç æè¿°ï¼Œè¯¥æ¼æ´åœ¨ç‰¹å®šç‰ˆæœ¬çš„ Ubuntu å†…æ ¸ä¸Šæ˜¯å¯åˆ©ç”¨çš„ã€‚æä¾›çš„POCä»£ç å±•ç¤ºäº†åˆ©ç”¨è¯¥æ¼æ´æå‡æƒé™çš„å®Œæ•´è¿‡ç¨‹ã€‚

**æŠ•æ¯’é£é™©ï¼š**

ä»£ç ä¸­å­˜åœ¨æ½œåœ¨çš„æŠ•æ¯’é£é™©ï¼Œä½†æ˜¯é£é™©è¾ƒä½ã€‚ä¸»è¦é›†ä¸­åœ¨ç¼–è¯‘å’Œè¿è¡Œexploitæ—¶ã€‚æ”»å‡»è€…å¯èƒ½é€šè¿‡ä¿®æ”¹ exploit.c æ–‡ä»¶ï¼Œä¾‹å¦‚æ·»åŠ æ¶æ„ä»£ç æˆ–åé—¨ï¼Œä»è€Œåœ¨ç›®æ ‡ç³»ç»Ÿä¸Šæ‰§è¡Œæ¶æ„æ“ä½œã€‚ä½†æ˜¯æ ¹æ®æä¾›çš„POCä»£ç æ¥çœ‹, é£é™©ç³»æ•°è¾ƒä½.

**é£é™©è¯„ä¼°ï¼š**

è¯¥æ¼æ´åˆ©ç”¨çš„æˆåŠŸå–å†³äºç›®æ ‡ç³»ç»Ÿæ˜¯å¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š

*   è¿è¡Œå—å½±å“çš„ Ubuntu å†…æ ¸ç‰ˆæœ¬ã€‚
*   å¯ç”¨äº†æœªæˆæƒç”¨æˆ·å‘½åç©ºé—´å’Œ overlayfs mountã€‚
*   ç›®æ ‡ç³»ç»Ÿä¸Šå­˜åœ¨ `gcc` ç¼–è¯‘å™¨, èƒ½å¤Ÿç¼–è¯‘exploitã€‚

å¦‚æœç›®æ ‡ç³»ç»Ÿæ»¡è¶³è¿™äº›æ¡ä»¶ï¼Œæ”»å‡»è€…å¯ä»¥ä½¿ç”¨æä¾›çš„ POC ä»£ç æˆåŠŸåˆ©ç”¨è¯¥æ¼æ´ï¼Œä»è€Œè·å¾— root æƒé™ã€‚


**é¡¹ç›®åœ°å€:** [fei9747/CVE-2021-3493](https://github.com/fei9747/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #8

**æ¥æº**: [CVE-2021-3493-iamz24_CVE-2021-3493_CVE-2022-3357.md](../2021/CVE-2021-3493-iamz24_CVE-2021-3493_CVE-2022-3357.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒæ¼æ´

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å¯¼è‡´æœ¬åœ°æƒé™æå‡è‡³ root

**å½±å“ç‰ˆæœ¬:** Ubuntu kernels < 5.8.0-50.56, < 5.4.0-72.80, < 4.15.0-142.146, < 4.4.0-209.241

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç›®æ ‡ç³»ç»Ÿå¼€å¯ unprivileged user namespaces å’Œå­˜åœ¨ OverlayFS æœåŠ¡ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2021-3493 æ¼æ´æ˜¯ Linux å†…æ ¸ overlayfs å®ç°ä¸­ï¼Œåœ¨ç”¨æˆ·å‘½åç©ºé—´ä¸­å¯¹åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­çš„æ–‡ä»¶ capabilities éªŒè¯ä¸å½“å¯¼è‡´çš„ã€‚ç”±äº Ubuntu å†…æ ¸ä¸­å­˜åœ¨å…è®¸éç‰¹æƒ overlay æŒ‚è½½çš„è¡¥ä¸ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¯¥æ¼æ´æå‡æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** æ£€æŸ¥ç›®æ ‡ç³»ç»Ÿæ˜¯å¦å­˜åœ¨ overlayfs æœåŠ¡ï¼Œå¦‚æœæ²¡æœ‰åˆ™åŠ è½½ overlay æ¨¡å—ã€‚åŒæ—¶ï¼Œç¡®ä¿å¼€å¯äº† unprivileged user namespacesã€‚
2.  **ç¼–è¯‘ Payloadï¼š** ä½¿ç”¨ GCC ç¼–è¯‘æä¾›çš„ `payload.c` æ–‡ä»¶ã€‚
3.  **è¿è¡Œ Payloadï¼š** è¿è¡Œç¼–è¯‘åçš„å¯æ‰§è¡Œæ–‡ä»¶ `a.out`ã€‚
4.  **è·å– Root Shellï¼š** Payload ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å‘½åç©ºé—´ï¼ŒæŒ‚è½½ overlayfsï¼Œè®¾ç½® capabilityï¼Œæœ€ç»ˆæ‰§è¡Œä¸€ä¸ªå…·æœ‰ root æƒé™çš„ shellã€‚

**æœ‰æ•ˆæ€§ï¼š**

æä¾›çš„ POC ä»£ç åŸºæœ¬æœ‰æ•ˆï¼Œèƒ½å¤Ÿåˆ©ç”¨è¯¥æ¼æ´åœ¨ç¬¦åˆæ¡ä»¶çš„ Ubuntu ç³»ç»Ÿä¸Šå®ç°æœ¬åœ°ææƒã€‚

**æŠ•æ¯’é£é™©ï¼š**

å­˜åœ¨è¾ƒä½çš„æŠ•æ¯’é£é™©ï¼ˆ10%ï¼‰ã€‚è™½ç„¶ä»£ç çš„ä¸»è¦åŠŸèƒ½æ˜¯å®ç°ææƒï¼Œä½†ä»ç„¶éœ€è¦è°¨æ…å¯¹å¾…æ¥æºä¸æ˜çš„ä»£ç ï¼Œä½œè€…å¯èƒ½ä¼šåœ¨å…¶ä¸­éšè—ä¸€äº›æ¶æ„è¡Œä¸ºï¼Œæ¯”å¦‚ä¸Šä¼ æ•æ„Ÿä¿¡æ¯ç­‰ã€‚ç‰¹åˆ«æ˜¯éœ€è¦æ£€æŸ¥ `exploit`å‡½æ•°ä¸­çš„ç›¸å…³æ–‡ä»¶æ“ä½œå’Œå‘½ä»¤æ‰§è¡Œæ˜¯å¦å­˜åœ¨æ¶æ„è¡Œä¸ºã€‚å°¤å…¶å…³æ³¨`system(buf);`æ˜¯å¦ä¼šæ‰§è¡Œæ¶æ„çš„æŒ‡ä»¤ã€‚

**æ€»ç»“ï¼š**

è¯¥æ¼æ´åˆ©ç”¨è¾ƒä¸ºç›´æ¥ï¼Œåˆ©ç”¨æ¡ä»¶ç›¸å¯¹æ˜ç¡®ï¼Œä½†éœ€è¦æ³¨æ„æ½œåœ¨çš„æŠ•æ¯’é£é™©ã€‚åœ¨å®é™…ä½¿ç”¨æ—¶ï¼Œåº”è¯¥ä»”ç»†å®¡æŸ¥ä»£ç ï¼Œç¡®ä¿æ²¡æœ‰æ¶æ„è¡Œä¸ºã€‚

**é¡¹ç›®åœ°å€:** [iamz24/CVE-2021-3493_CVE-2022-3357](https://github.com/iamz24/CVE-2021-3493_CVE-2022-3357)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #9

**æ¥æº**: [CVE-2021-3493-inspiringz_CVE-2021-3493.md](../2021/CVE-2021-3493-inspiringz_CVE-2021-3493.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Ubuntu Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸ä½æƒé™ç”¨æˆ·æå‡åˆ°rootæƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu 4.4, 4.15, 5.4, 5.8 kernels (å—å½±å“ç‰ˆæœ¬è¯¦è§æ¼æ´åº“ä¿¡æ¯)

**åˆ©ç”¨æ¡ä»¶:** Ubuntuå†…æ ¸ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…ï¼Œå¯ç”¨æœªæˆæƒç”¨æˆ·å‘½åç©ºé—´ï¼Œå…è®¸æœªæˆæƒOverlayFSæŒ‚è½½ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 5%

## è¯¦æƒ…

CVE-2021-3493æ˜¯Ubuntuå†…æ ¸ä¸­OverlayFSå®ç°çš„ä¸€ä¸ªæ¼æ´ï¼Œå…è®¸ä½æƒé™ç”¨æˆ·é€šè¿‡åˆ©ç”¨user namespaceå’ŒOverlayFSæŒ‚è½½ç»•è¿‡æ–‡ä»¶ç³»ç»Ÿæƒé™æ£€æŸ¥æ¥æå‡æƒé™ã€‚ 

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡:** æ¼æ´åˆ©ç”¨éœ€è¦å­˜åœ¨Ubuntuç³»ç»Ÿï¼Œä¸”å†…æ ¸ç‰ˆæœ¬åœ¨æ¼æ´åº“ä¿¡æ¯ä¸­æè¿°çš„å—å½±å“èŒƒå›´å†…ï¼Œå¹¶ä¸”éœ€è¦å¯ç”¨æœªæˆæƒç”¨æˆ·å‘½åç©ºé—´(unprivileged user namespaces)ã€‚æ­¤å¤–ï¼Œä¸ºäº†åˆ©ç”¨OverlayFSï¼Œç³»ç»Ÿéœ€è¦é…ç½®å…è®¸æœªæˆæƒç”¨æˆ·è¿›è¡ŒOverlayFSæŒ‚è½½ã€‚
2.  **æ¼æ´åˆ©ç”¨:**  æ”»å‡»è€…é¦–å…ˆåˆ›å»ºä¸€ä¸ªåŒ…å«lower, upper, workç›®å½•çš„OverlayFSç»“æ„ã€‚
3.  **åˆ©ç”¨è¿‡ç¨‹:** åˆ©ç”¨`unshare`ç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€ä¸ªæ–°çš„user namespaceå’Œmount namespaceã€‚ åœ¨æ–°namespaceä¸­ï¼Œå°†è‡ªå·±çš„UIDå’ŒGIDæ˜ å°„åˆ°rootæƒé™ã€‚ ç„¶åï¼Œä½¿ç”¨æ„é€ çš„lowerdirã€upperdirå’ŒworkdiræŒ‚è½½OverlayFSæ–‡ä»¶ç³»ç»Ÿã€‚ æ”»å‡»è€…å°†ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶å¤åˆ¶åˆ°OverlayFSçš„mergeç›®å½•ä¸­ã€‚å…³é”®çš„ä¸€æ­¥æ˜¯ï¼Œæ”»å‡»è€…ä½¿ç”¨`setxattr`ç³»ç»Ÿè°ƒç”¨ï¼Œè®¾ç½®è¯¥å¯æ‰§è¡Œæ–‡ä»¶çš„`security.capability`æ‰©å±•å±æ€§ï¼Œèµ‹äºˆå®ƒ`CAP_SETUID`å’Œ`CAP_SETGID`èƒ½åŠ›ã€‚ ç”±äºOverlayFSçš„æƒé™éªŒè¯ä¸å®Œå–„ï¼Œè¿™ä¸ªæ“ä½œå³ä½¿åœ¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´ä¸­ä¹Ÿèƒ½æˆåŠŸã€‚å½“æ‰§è¡Œè¯¥æ–‡ä»¶æ—¶ï¼Œå®ƒå°†è·å¾—rootæƒé™ï¼Œå¹¶å¯ä»¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚
4.  **POCä»£ç åˆ†æ:** `exploit.c` ä»£ç é¦–å…ˆåˆ›å»ºä¸€ä¸ªoverlayfsç›®å½•ç»“æ„ã€‚ç„¶åï¼Œä½¿ç”¨ `unshare` ç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€ä¸ªæ–°çš„ user namespace å’Œ mount namespaceï¼Œå¹¶å°†å½“å‰ç”¨æˆ·çš„ uid å’Œ gid æ˜ å°„åˆ° root ç”¨æˆ·ã€‚ ä¹‹åï¼Œå®ƒæŒ‚è½½ overlayfsï¼Œå¤åˆ¶å½“å‰æ‰§è¡Œçš„ç¨‹åºåˆ° overlayfs çš„ merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½® capabilityã€‚æœ€åï¼Œæ‰§è¡Œå¤åˆ¶åˆ° overlayfs çš„ç¨‹åºã€‚
5. **æŠ•æ¯’é£é™©åˆ†æ:** ä»£ç æœ¬èº«å®ç°äº†æ¼æ´åˆ©ç”¨çš„åŠŸèƒ½ã€‚ æ½œåœ¨çš„æŠ•æ¯’é£é™©å¯èƒ½å­˜åœ¨äºä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š
    *   **ä¾èµ–é¡¹:**  ä»£ç ä¾èµ–äºæ ‡å‡†çš„Cåº“ï¼Œæœ¬èº«ä¸å­˜åœ¨æ¶æ„ä¾èµ–ã€‚ä½†ç”¨æˆ·åœ¨ç¼–è¯‘æ—¶éœ€è¦æ³¨æ„ç¼–è¯‘å™¨ç¯å¢ƒçš„å®‰å…¨æ€§ã€‚
    *   **ä»£ç é€»è¾‘:**  ä»£ç é€»è¾‘ç›¸å¯¹ç®€å•ï¼Œä¸»è¦é›†ä¸­åœ¨namespaceåˆ›å»ºã€æŒ‚è½½å’Œcapabilityè®¾ç½®ã€‚ ä»”ç»†å®¡æŸ¥ä»£ç ï¼Œæœªå‘ç°æ˜æ˜¾çš„æ¶æ„é€»è¾‘ã€‚
    *   **æ‰§è¡Œå‘½ä»¤:**  ä»£ç ä¸­ä½¿ç”¨äº† `system` å‡½æ•°ï¼Œè¿™æ˜¯ä¸€ä¸ªæ½œåœ¨çš„é£é™©ç‚¹ï¼Œå¯ä»¥æ‰§è¡Œä»»æ„ç³»ç»Ÿå‘½ä»¤ã€‚ä½†æ˜¯ï¼Œè¿™é‡Œåªæ˜¯ç”¨æ¥åˆ é™¤ç›®å½•ï¼Œç›¸å¯¹å®‰å…¨ã€‚
       ç»¼ä¸Šæ‰€è¿°ï¼Œè¯¥POCä»£ç ä¸»è¦é£é™©åœ¨äºç¡®ä¿ç¼–è¯‘ç¯å¢ƒå®‰å…¨ä»¥åŠå¯¹ä¸ç†Ÿæ‚‰çš„å‘½ä»¤ä¿æŒè­¦æƒ•ã€‚æŠ•æ¯’é£é™©è¾ƒä½ï¼Œé¢„ä¼°ä¸º5%ã€‚

**æ€»ç»“ï¼š**

è¯¥æ¼æ´åˆ©ç”¨çš„æ ¸å¿ƒåœ¨äºç»“åˆäº†æœªæˆæƒç”¨æˆ·å‘½åç©ºé—´å’ŒOverlayFSï¼Œåˆ©ç”¨OverlayFSå¯¹capabilitiesè®¾ç½®éªŒè¯çš„ç¼ºé™·ï¼Œå®ç°äº†æœ¬åœ°ææƒã€‚ æ”»å‡»è€…é€šè¿‡åˆ›å»ºç‰¹æ®Šçš„OverlayFSç»“æ„å¹¶è®¾ç½®æ–‡ä»¶capabilitiesï¼Œæœ€ç»ˆè·å¾—rootæƒé™ã€‚

**é¡¹ç›®åœ°å€:** [inspiringz/CVE-2021-3493](https://github.com/inspiringz/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #10

**æ¥æº**: [CVE-2021-3493-oneoy_CVE-2021-3493.md](../2021/CVE-2021-3493-oneoy_CVE-2021-3493.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœ¬åœ°ç”¨æˆ·å¯æå‡è‡³ root æƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu 4.4, 4.15, 5.4, and 5.8 kernels (å…·ä½“ç‰ˆæœ¬å·è§æ¼æ´åº“ä¿¡æ¯)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç›®æ ‡ç³»ç»Ÿå­˜åœ¨æœªä¿®å¤çš„ Ubuntu kernelï¼Œä¸”å¯ç”¨ unprivileged user namespaces å’Œå…è®¸ unprivileged overlayfs mountsã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

è¯¥æ¼æ´å­˜åœ¨äº Ubuntu å†…æ ¸çš„ OverlayFS å®ç°ä¸­ï¼Œç”±äºæœªæ­£ç¡®éªŒè¯ç”¨æˆ·å‘½åç©ºé—´ä¸­åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸Šæ–‡ä»¶ capabilities çš„è®¾ç½®ï¼Œå¯¼è‡´æœ¬åœ°æ”»å‡»è€…å¯åˆ©ç”¨ unprivileged user namespaces å’Œ Ubuntu å†…æ ¸ä¸­å…è®¸ unprivileged overlayfs mounts çš„è¡¥ä¸æ¥æå‡æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ (lower, upper, work, merge)ã€‚
2.  **é…ç½® User Namespace:** åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´ã€‚
3.  **é…ç½® OverlayFS:** ä½¿ç”¨ lowerdir, upperdir, å’Œ workdir é€‰é¡¹æŒ‚è½½ overlay æ–‡ä»¶ç³»ç»Ÿã€‚
4.  **è®¾ç½® Capabilities:** å°†å¯æ‰§è¡Œæ–‡ä»¶å¤åˆ¶åˆ° merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½®å…¶ capabilities (å¦‚ CAP_SETUID, CAP_SETGID, CAP_CHOWN)ã€‚
5.  **è§¦å‘ææƒ:** æ‰§è¡Œ merge ç›®å½•ä¸­çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶å°†ä¼šä»¥ root æƒé™æ‰§è¡Œã€‚

**æŠ•æ¯’é£é™©è¯„ä¼°ï¼š**

æä¾›çš„ `exploit.c` ä»£ç ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨ OverlayFS çš„æ¼æ´è¿›è¡Œææƒã€‚ä»£ç åˆ›å»ºå¿…è¦çš„ç›®å½•ï¼Œé…ç½® user namespace å’Œ overlay æ–‡ä»¶ç³»ç»Ÿï¼Œå¹¶è®¾ç½®å¯æ‰§è¡Œæ–‡ä»¶çš„ capabilitiesã€‚ä»£ç é€»è¾‘æ¸…æ™°ï¼Œæ²¡æœ‰å‘ç°æ¶æ„ä»£ç æˆ–åé—¨ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**

æä¾›çš„ POC ä»£ç åŸºäºå…¬å¼€ä¿¡æ¯ï¼Œå¹¶é’ˆå¯¹ CVE-2021-3493 æ¼æ´è¿›è¡Œäº†åˆ©ç”¨ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯ã€æœç´¢å¼•æ“ç»“æœå’Œä»£ç åˆ†æï¼Œè¯¥ POC ä»£ç åœ¨æ»¡è¶³æ¼æ´åˆ©ç”¨æ¡ä»¶çš„æƒ…å†µä¸‹åº”è¯¥æ˜¯æœ‰æ•ˆçš„ã€‚

**é¡¹ç›®åœ°å€:** [oneoy/CVE-2021-3493](https://github.com/oneoy/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #11

**æ¥æº**: [CVE-2021-3493-pmihsan_OverlayFS-CVE-2021-3493.md](../2021/CVE-2021-3493-pmihsan_OverlayFS-CVE-2021-3493.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœ¬åœ°ç”¨æˆ·å¯æå‡è‡³ root æƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu kernel versions: < 5.8.0-50.56 (5.8 kernel), < 5.4.0-72.80 (5.4 kernel), < 4.15.0-142.146 (4.15 kernel), < 4.4.0-209.241 (4.4 kernel)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦åœ¨å­˜åœ¨æ¼æ´çš„ Ubuntu ç³»ç»Ÿä¸Šæ‰§è¡Œï¼Œå¹¶ä¸”å…è®¸ unprivileged user namespaces å’Œ overlay mountsã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

CVE-2021-3493 æ¼æ´å­˜åœ¨äº Linux å†…æ ¸çš„ overlayfs å®ç°ä¸­ã€‚ç”±äºå¯¹ç”¨æˆ·å‘½åç©ºé—´ä¸­åº•å±‚æ–‡ä»¶ç³»ç»Ÿæ–‡ä»¶ capabilities çš„éªŒè¯ä¸è¶³ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡åˆ›å»ºæ¶æ„çš„ overlayfs æ–‡ä»¶ç³»ç»Ÿï¼Œåˆ©ç”¨ setxattr è®¾ç½®æ–‡ä»¶ capabilitiesï¼Œä»è€Œè·å¾—æå‡çš„æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** åˆ›å»º overlayfs æ‰€éœ€çš„ç›®å½•ç»“æ„ (lower, upper, work, merge)ã€‚
2.  **Namespace åˆ›å»ºï¼š** åˆ›å»ºæ–°çš„ user namespace å’Œ mount namespaceï¼Œéš”ç¦»æƒé™ã€‚
3.  **æƒé™è®¾ç½®ï¼š** ä¿®æ”¹ uid_map å’Œ gid_mapï¼Œä½¿å¾—åœ¨ user namespace ä¸­æ‹¥æœ‰ root æƒé™ã€‚
4.  **Overlayfs Mountï¼š** ä½¿ç”¨ overlayfs mount å‘½ä»¤å°† lowerdir, upperdir, workdir æŒ‚è½½åˆ° mergedirã€‚
5.  **Capabilities è®¾ç½®ï¼š** å¤åˆ¶è‡ªèº«ç¨‹åºåˆ° merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` å‡½æ•°ä¸ºå¤åˆ¶åçš„ç¨‹åºè®¾ç½® capabilities (CAP_SETUID, CAP_SETGID, CAP_DAC_OVERRIDE ç­‰)ã€‚
6.  **æƒé™æå‡ï¼š** æ‰§è¡Œ merge ç›®å½•ä¸‹çš„ç¨‹åºï¼Œæ­¤æ—¶ç¨‹åºå°†ä»¥ root æƒé™è¿è¡Œã€‚

**æœ‰æ•ˆæ€§ï¼š**

æä¾›çš„ POC ä»£ç é€šè¿‡åˆ©ç”¨ overlayfs æ¼æ´ï¼Œå¯ä»¥æˆåŠŸåœ°æå‡æƒé™ã€‚POC ä»£ç é¦–å…ˆåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼Œç„¶ååˆ›å»ºä¸€ä¸ªæ–°çš„ user namespace å’Œ mount namespaceï¼Œæ¥ç€æŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿï¼Œå¹¶ä½¿ç”¨ `setxattr` å‡½æ•°ä¸ºæ–‡ä»¶è®¾ç½® capabilitiesã€‚æœ€åï¼Œæ‰§è¡Œè¯¥æ–‡ä»¶å³å¯è·å¾— root æƒé™ã€‚

**æŠ•æ¯’é£é™©ï¼š**

åˆ†æ POC ä»£ç ï¼Œæ²¡æœ‰å‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç ï¼Œä¾‹å¦‚åå¼¹ shellã€å®‰è£…åé—¨ç­‰ã€‚ä»£ç é€»è¾‘ä¸»è¦é›†ä¸­åœ¨åˆ©ç”¨ overlayfs æ¼æ´ææƒï¼Œå¹¶æ²¡æœ‰é¢å¤–çš„æ“ä½œæ¥æ¤å…¥æ¶æ„ç¨‹åºã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ï¼Œå¯ä»¥è®¤ä¸ºæ˜¯ 0%ã€‚å‚è€ƒçš„ vulnerability description å’Œ exploit ä»£ç éƒ½ç€é‡äºææƒï¼Œè€Œæ²¡æœ‰æåˆ°ä»»ä½•æŠ•æ¯’è¡Œä¸ºã€‚

**é¡¹ç›®åœ°å€:** [pmihsan/OverlayFS-CVE-2021-3493](https://github.com/pmihsan/OverlayFS-CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #12

**æ¥æº**: [CVE-2021-3493-ptkhai15_OverlayFS---CVE-2021-3493.md](../2021/CVE-2021-3493-ptkhai15_OverlayFS---CVE-2021-3493.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Ubuntu Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœ¬åœ°ç”¨æˆ·æå‡æƒé™è‡³ root

**å½±å“ç‰ˆæœ¬:** Ubuntu kernel versions 5.8, 5.4, 4.15, å’Œ 4.4 ä¸­å—å½±å“çš„ç‰ˆæœ¬ï¼ˆå…·ä½“ç‰ˆæœ¬å‚è§æ¼æ´åº“ä¿¡æ¯ï¼‰

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡ç³»ç»Ÿå¿…é¡»æ˜¯å—å½±å“çš„ Ubuntu ç‰ˆæœ¬ï¼Œå¹¶ä¸”å¯ç”¨äº†éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å’Œéç‰¹æƒ overlayfs æŒ‚è½½ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

CVE-2021-3493 æ˜¯ Ubuntu Linux å†…æ ¸ä¸­ OverlayFS å®ç°ä¸­çš„ä¸€ä¸ªæ¼æ´ã€‚è¯¥æ¼æ´å…è®¸éç‰¹æƒç”¨æˆ·åˆ©ç”¨ç”¨æˆ·å‘½åç©ºé—´å’Œéç‰¹æƒ overlayfs æŒ‚è½½ï¼Œé€šè¿‡ä¸æ­£ç¡®åœ°éªŒè¯åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­æ–‡ä»¶çš„ capabilities è®¾ç½®æ¥æå‡æƒé™ã€‚åˆ©ç”¨æ–¹å¼å¦‚ä¸‹ï¼š

1.  **ç¯å¢ƒå‡†å¤‡ï¼š**  åˆ›å»ºä¸€ä¸ªåŸºç¡€ç›®å½•ç»“æ„ï¼ŒåŒ…æ‹¬ workã€lowerã€upper å’Œ merge ç›®å½•ï¼Œè¿™æ˜¯ overlayfs çš„æ ‡å‡†é…ç½®ã€‚
2.  **åˆ›å»ºç”¨æˆ·å‘½åç©ºé—´ï¼š**  ä½¿ç”¨ `unshare` å‘½ä»¤åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´ã€‚è¿™å…è®¸åœ¨æ–°çš„å‘½åç©ºé—´ä¸­æ‹¥æœ‰ä¸åŒçš„ç”¨æˆ·å’Œç»„ IDã€‚
3.  **é…ç½®ç”¨æˆ·å’Œç»„æ˜ å°„ï¼š**  é€šè¿‡ `/proc/self/setgroups`ã€`/proc/self/uid_map` å’Œ `/proc/self/gid_map` æ–‡ä»¶è®¾ç½®ç”¨æˆ·å’Œç»„ ID æ˜ å°„ï¼Œå°†å½“å‰ç”¨æˆ·çš„ UID å’Œ GID æ˜ å°„åˆ°æ–°å‘½åç©ºé—´ä¸­çš„ root ç”¨æˆ·ã€‚
4.  **æŒ‚è½½ OverlayFSï¼š**  ä½¿ç”¨ `mount` å‘½ä»¤æŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿï¼Œå°† lowerã€upper å’Œ work ç›®å½•å…³è”èµ·æ¥ã€‚
5.  **è®¾ç½®æ–‡ä»¶ capabilitiesï¼š**  å¤åˆ¶å½“å‰æ‰§è¡Œç¨‹åºåˆ° overlayfs çš„ merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½®æ–‡ä»¶çš„ capabilities ä¸º `all+ep`ï¼Œå…è®¸è¯¥æ–‡ä»¶æ‰§è¡Œæ—¶æ‹¥æœ‰ root æƒé™ã€‚
6.  **æ‰§è¡Œææƒåçš„ç¨‹åºï¼š**  æ‰§è¡Œä½äº upper ç›®å½•ä¸­çš„å¤åˆ¶åçš„ç¨‹åºã€‚å¦‚æœç¨‹åºæ£€æµ‹åˆ°è‡ªå·±æ˜¯é€šè¿‡ç‰¹å®šæ–¹å¼ï¼ˆä¾‹å¦‚ï¼ŒåŒ…å« "magic" å­—ç¬¦ä¸²æˆ–æ¥å— "shell" å‚æ•°ï¼‰è°ƒç”¨çš„ï¼Œå®ƒä¼šè°ƒç”¨ `setuid(0)` å’Œ `setgid(0)` å°†è¿›ç¨‹çš„ UID å’Œ GID è®¾ç½®ä¸º 0 (root)ï¼Œå¹¶å¯åŠ¨ä¸€ä¸ª root shellã€‚

**å…³äºæŠ•æ¯’é£é™©ï¼š**

åœ¨æä¾›çš„ POC ä»£ç ä¸­ï¼Œæ²¡æœ‰æ˜æ˜¾çš„æŠ•æ¯’ä»£ç ã€‚POC çš„ç›®çš„æ˜¯æ¼”ç¤ºæ¼æ´åˆ©ç”¨è¿‡ç¨‹ï¼Œæ²¡æœ‰å‘ç°æ¶æ„è¡Œä¸ºï¼Œä¾‹å¦‚åå‘ shell æˆ–å…¶ä»–æœªç»æˆæƒçš„è®¿é—®ã€‚


**é¡¹ç›®åœ°å€:** [ptkhai15/OverlayFS---CVE-2021-3493](https://github.com/ptkhai15/OverlayFS---CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #13

**æ¥æº**: [CVE-2021-3493-puckiestyle_CVE-2021-3493.md](../2021/CVE-2021-3493-puckiestyle_CVE-2021-3493.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ”»å‡»è€…å¯åˆ©ç”¨æ­¤æ¼æ´è·å¾— root æƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu 5.8 kernel (< 5.8.0-50.56), 5.4 kernel (< 5.4.0-72.80), 4.15 kernel (< 4.15.0-142.146), 4.4 kernel (< 4.4.0-209.241)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ Ubuntu ç³»ç»Ÿå¼€å¯ unprivileged user namespaces å’Œå…è®¸ unprivileged overlay mounts

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2021-3493 æ˜¯ Ubuntu å†…æ ¸ overlayfs å®ç°ä¸­çš„ä¸€ä¸ªæ¼æ´ï¼Œå…è®¸æœ¬åœ°æ”»å‡»è€…é€šè¿‡æ»¥ç”¨ user namespaces å’Œ overlayfs æŒ‚è½½æœºåˆ¶æå‡æƒé™ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**
æä¾›çš„ POC ä»£ç å°è¯•åˆ©ç”¨è¯¥æ¼æ´ï¼Œé€šè¿‡åˆ›å»º user namespace å’Œ overlayfs æ–‡ä»¶ç³»ç»Ÿæ¥è®¾ç½®å¯æ‰§è¡Œæ–‡ä»¶çš„ capability ä½ï¼Œä½¿å…¶è·å¾— root æƒé™ã€‚ æ¼æ´åº“ä¿¡æ¯,æœç´¢å¼•æ“ç»“æœå’Œæ¼æ´åˆ©ç”¨ä»£ç ä¸€è‡´,è¡¨æ˜è¯¥æ¼æ´çš„POCæ˜¯çœŸå®æœ‰æ•ˆçš„ã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**
æŸ¥çœ‹ `exploit.c` ä»£ç ï¼Œä¸»è¦æ“ä½œåŒ…æ‹¬åˆ›å»ºç›®å½•ã€è®¾ç½® user namespaceã€æŒ‚è½½ overlayfsã€å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶ã€è®¾ç½® capability å±æ€§ï¼Œä»¥åŠæ‰§è¡Œå¤åˆ¶åçš„æ–‡ä»¶ä»¥è·å¾— root æƒé™ã€‚ä»£ç é€»è¾‘è¾ƒä¸ºæ¸…æ™°ï¼Œæœªå‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç ã€‚`README.md` ä¹Ÿè¯´æ˜äº†å¹¶éä½œè€…åŸåˆ›,åªæ˜¯æ¬è¿,å¢åŠ äº†åˆ†æéš¾åº¦.
`exploit.c`ä¸­å­˜åœ¨`system(buf);` è°ƒç”¨ï¼Œè™½ç„¶è¿™é‡Œæ˜¯ç”¨äºæ¸…ç†ç›®å½•ï¼Œä½†å¦‚æœè¢«ç¯¡æ”¹ï¼Œå¯èƒ½æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£é™©è¯„ä¼°ä¸º10%ã€‚ä¸»è¦çš„é£é™©åœ¨äºï¼š

*   `system()` å‡½æ•°æ½œåœ¨çš„å‘½ä»¤æ³¨å…¥é£é™©ï¼Œå¦‚æœä»£ç è¢«ä¿®æ”¹ï¼Œå¯èƒ½å¯¼è‡´æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  åˆ©ç”¨ unshare() åˆ›å»ºä¸€ä¸ªæ–°çš„ user namespace å’Œ mount namespaceã€‚
2.  é…ç½® user namespace çš„ uid_map å’Œ gid_mapï¼Œå°†å½“å‰ç”¨æˆ·æ˜ å°„ä¸º root ç”¨æˆ·ã€‚
3.  åˆ›å»º overlayfs æ‰€éœ€çš„ç›®å½•ç»“æ„ï¼ˆlowerdirã€upperdirã€workdirã€mergedï¼‰ã€‚
4.  æŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿã€‚
5.  å°†æ¼æ´åˆ©ç”¨ç¨‹åºè‡ªèº«å¤åˆ¶åˆ° overlayfs çš„ upperdir/merged ç›®å½•ã€‚
6.  ä½¿ç”¨ setxattr() è®¾ç½®å¤åˆ¶åçš„å¯æ‰§è¡Œæ–‡ä»¶çš„ security.capability å±æ€§ï¼Œèµ‹äºˆå…¶ CAP_SETUID å’Œ CAP_SETGID æƒé™ã€‚
7.  æ‰§è¡Œå¤åˆ¶åçš„ç¨‹åºï¼Œç”±äºè®¾ç½®äº† capabilityï¼Œè¯¥ç¨‹åºä¼šä»¥ root æƒé™è¿è¡Œï¼Œä»è€Œè·å¾— root shellã€‚

**é¡¹ç›®åœ°å€:** [puckiestyle/CVE-2021-3493](https://github.com/puckiestyle/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #14

**æ¥æº**: [CVE-2021-3493-smallkill_CVE-2021-3493.md](../2021/CVE-2021-3493-smallkill_CVE-2021-3493.md)

# CVE-2021-3493

> ğŸ“¦ è¯¥CVEæœ‰ **15** ä¸ªç›¸å…³POCä»“åº“

---

## POC #1

**æ¥æº**: [CVE-2021-3493-Abdennour-py_CVE-2021-3493.md](../2021/CVE-2021-3493-Abdennour-py_CVE-2021-3493.md)

## CVE-2021-3493 Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å¯¼è‡´æ™®é€šç”¨æˆ·æå‡ä¸ºrootæƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu 5.8 kernel < 5.8.0-50.56, 5.4 kernel < 5.4.0-72.80, 4.15 kernel < 4.15.0-142.146, 4.4 kernel < 4.4.0-209.241

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç›®æ ‡ç³»ç»Ÿè¿è¡Œå—å½±å“çš„Ubuntuå†…æ ¸ï¼Œå¹¶ä¸”å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿå’Œä½¿ç”¨user namespace

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

è¯¥æ¼æ´æºäºUbuntuå†…æ ¸ä¸­overlayfså®ç°å¯¹ç”¨æˆ·å‘½åç©ºé—´ä¸­çš„æ–‡ä»¶èƒ½åŠ›éªŒè¯ä¸å½“ã€‚ç»“åˆéç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å’ŒUbuntuå†…æ ¸ä¸­çš„å…è®¸éç‰¹æƒ overlayfs æŒ‚è½½çš„è¡¥ä¸ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´è·å¾—æå‡çš„æƒé™ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**

æä¾›çš„POCä»£ç çœ‹èµ·æ¥æ˜¯æœ‰æ•ˆçš„ã€‚å®ƒåˆ©ç”¨äº† overlayfs å’Œ user namespace çš„ç»„åˆæ¥è®¾ç½®æ–‡ä»¶ capabilityï¼Œä»è€Œå®ç°ææƒã€‚ä»£ç é¦–å…ˆåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼ˆlower, upper, work, mergeï¼‰ï¼Œç„¶åä½¿ç”¨ `unshare` åˆ›å»ºä¸€ä¸ªæ–°çš„ user namespace å’Œ mount namespaceã€‚æ¥ç€ï¼Œå®ƒå†™å…¥ `/proc/self/setgroups`, `/proc/self/uid_map`, å’Œ `/proc/self/gid_map` æ¥è®¾ç½®ç”¨æˆ·å’Œç»„çš„æ˜ å°„ã€‚ç„¶åï¼ŒæŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿï¼Œæ‹·è´è‡ªèº«å¯æ‰§è¡Œæ–‡ä»¶åˆ° overlayfs çš„ merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½® capabilitiesã€‚æœ€åï¼Œå®ƒæ‰§è¡Œä½äº upper ç›®å½•çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶ä¼šå°è¯•ä»¥ root æƒé™æ‰§è¡Œ /bin/bashã€‚

æ ¹æ®æ¼æ´åº“ä¿¡æ¯ï¼ŒCISA å°†æ­¤æ¼æ´æ·»åŠ åˆ°å·²çŸ¥è¢«åˆ©ç”¨çš„æ¼æ´åˆ—è¡¨ä¸­ï¼Œè¿›ä¸€æ­¥è¡¨æ˜äº†è¯¥æ¼æ´çš„æœ‰æ•ˆæ€§ã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

æ£€æŸ¥æä¾›çš„ exploit.c ä»£ç ï¼Œæ²¡æœ‰å‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç æˆ–åé—¨ã€‚ä»£ç é€»è¾‘æ¸…æ™°ï¼Œä¸»è¦æ‰§è¡Œäº† overlayfs çš„æŒ‚è½½ï¼Œæ–‡ä»¶å¤åˆ¶ï¼Œè®¾ç½® xattr å’Œæ‰§è¡Œ shell æ“ä½œã€‚ä»£ç çš„æ„å›¾ä¸æ¼æ´æè¿°ä¸€è‡´ï¼Œæ²¡æœ‰å‘ç°éšè—çš„ã€ä¸æ¼æ´åˆ©ç”¨æ— å…³çš„æ¶æ„è¡Œä¸ºã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£é™©ä¸º 0%ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š**  åœ¨å­˜åœ¨æ¼æ´çš„Ubuntuç³»ç»Ÿä¸Šï¼Œåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ (ovlcap/work, ovlcap/lower, ovlcap/upper, ovlcap/merge)ã€‚
2.  **User Namespaceå’ŒMount Namespaceï¼š** ä½¿ç”¨ `unshare` ç³»ç»Ÿè°ƒç”¨åˆ›å»ºæ–°çš„ user namespace å’Œ mount namespaceã€‚
3.  **IDæ˜ å°„ï¼š**  é…ç½® `/proc/self/setgroups`ï¼Œ`/proc/self/uid_map` å’Œ `/proc/self/gid_map`ï¼Œä»¥ä¾¿åœ¨ user namespace ä¸­è·å¾—æœ‰æ•ˆçš„ç”¨æˆ· ID å’Œç»„ IDã€‚
4.  **OverlayFSæŒ‚è½½ï¼š**  ä½¿ç”¨ `mount` ç³»ç»Ÿè°ƒç”¨æŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿï¼Œå°† lower, upper å’Œ work ç›®å½•å…³è”èµ·æ¥ã€‚
5.  **æ–‡ä»¶æ‹·è´ä¸ Capability è®¾ç½®ï¼š**  å°† exploit ç¨‹åºè‡ªèº«æ‹·è´åˆ° overlayfs çš„ merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½® `security.capability` å±æ€§ï¼Œèµ‹äºˆå…¶ CAP_SETUID å’Œ CAP_SETGID ç­‰æƒé™ã€‚
6.  **ææƒæ‰§è¡Œï¼š** æ‰§è¡Œä½äº upper ç›®å½•çš„ exploit ç¨‹åºçš„æ‹·è´ã€‚ç”±äºè¯¥æ–‡ä»¶å…·æœ‰ capabilitiesï¼Œå› æ­¤å¯ä»¥ä»¥ root æƒé™æ‰§è¡Œ shellã€‚

**é¡¹ç›®åœ°å€:** [Abdennour-py/CVE-2021-3493](https://github.com/Abdennour-py/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #2

**æ¥æº**: [CVE-2021-3493-Sornphut_OverlayFS---CVE-2021-3493.md](../2021/CVE-2021-3493-Sornphut_OverlayFS---CVE-2021-3493.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒæ¼æ´

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Ubuntu Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœ¬åœ°ç”¨æˆ·è·å¾— root æƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu kernels before 5.8.0-50.56, 5.4.0-72.80, 4.15.0-142.146, and 4.4.0-209.241

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦è¿è¡Œåœ¨å­˜åœ¨æ¼æ´çš„ Ubuntu å†…æ ¸ä¸Šï¼Œå¹¶ä¸”å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½ overlayfsã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

è¯¥æ¼æ´å­˜åœ¨äº Ubuntu Linux å†…æ ¸çš„ overlayfs å®ç°ä¸­ã€‚ç”±äº Ubuntu å¯¹ overlayfs æŒ‚è½½çš„ç‰¹å®šä¿®æ”¹ï¼Œå¯¼è‡´åœ¨ç”¨æˆ·å‘½åç©ºé—´å†…ï¼Œå¯¹åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­çš„æ–‡ä»¶ capabilities éªŒè¯ä¸å……åˆ†ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡ overlayfs æŒ‚è½½ç»•è¿‡ capabilities æ£€æŸ¥ï¼Œè®¾ç½®æ–‡ä»¶ capabilities æå‡æƒé™ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  åˆ›å»ºä¸€ä¸ªç›®å½•ç»“æ„ï¼ŒåŒ…æ‹¬ lower, upper, work å’Œ merge ç›®å½•ã€‚
2.  ä½¿ç”¨ `unshare` åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´å’ŒæŒ‚è½½å‘½åç©ºé—´ã€‚
3.  é…ç½® `/proc/self/setgroups`, `/proc/self/uid_map`, å’Œ `/proc/self/gid_map` ä»¥æ˜ å°„ç”¨æˆ· ID å’Œç»„ IDã€‚
4.  ä½¿ç”¨ `mount` å‘½ä»¤æŒ‚è½½ overlayfsï¼Œå°† lower, upper å’Œ work ç›®å½•ä¸ merge ç›®å½•å…³è”èµ·æ¥ã€‚
5.  åœ¨ upper ç›®å½•æˆ– merge ç›®å½•ä¸‹åˆ›å»ºæˆ–å¤åˆ¶ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ã€‚
6.  ä½¿ç”¨ `setxattr` è®¾ç½®å¯æ‰§è¡Œæ–‡ä»¶çš„ capabilitiesï¼Œèµ‹äºˆå…¶ root æƒé™ã€‚
7.  æ‰§è¡Œè¯¥æ–‡ä»¶ï¼Œå³å¯è·å¾— root æƒé™ã€‚

**æœ‰æ•ˆæ€§ï¼š**

æä¾›çš„ POC ä»£ç å°è¯•åˆ©ç”¨ CVE-2021-3493 æ¼æ´ã€‚è¯¥ä»£ç åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´å’ŒæŒ‚è½½å‘½åç©ºé—´ï¼Œå¹¶å°è¯•æŒ‚è½½ overlayfsã€‚ç„¶åï¼Œå®ƒåº”è¯¥è®¾ç½® `magic` äºŒè¿›åˆ¶æ–‡ä»¶çš„ capabilitiesï¼Œä»è€Œè·å¾— root æƒé™ã€‚æ ¹æ®æ¼æ´æè¿°ï¼Œè¯¥ POC åº”è¯¥èƒ½å¤Ÿæœ‰æ•ˆåˆ©ç”¨è¯¥æ¼æ´ã€‚

**æŠ•æ¯’é£é™©ï¼š**

æ£€æŸ¥æä¾›çš„ exploit.c æ–‡ä»¶ï¼Œæœªå‘ç°æ˜æ˜¾çš„æ¶æ„æˆ–éšè—ä»£ç ã€‚ä»£ç é€»è¾‘ä¸»è¦é›†ä¸­äºè®¾ç½® overlayfs æŒ‚è½½å’Œæ–‡ä»¶ capabilitiesã€‚ä½†æ˜¯ï¼Œéœ€è¦å§‹ç»ˆè°¨æ…å¯¹å¾…æ¥è‡ªä¸å—ä¿¡ä»»æ¥æºçš„ä»£ç ã€‚ä¸ºäº†ç¡®ä¿å®‰å…¨ï¼Œå»ºè®®åœ¨å—æ§ç¯å¢ƒä¸­ä»”ç»†å®¡æŸ¥å’Œæµ‹è¯•ä»£ç ã€‚


**é¡¹ç›®åœ°å€:** [Sornphut/OverlayFS---CVE-2021-3493](https://github.com/Sornphut/OverlayFS---CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #3

**æ¥æº**: [CVE-2021-3493-briskets_CVE-2021-3493.md](../2021/CVE-2021-3493-briskets_CVE-2021-3493.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å¯¼è‡´æ™®é€šç”¨æˆ·æƒé™æå‡è‡³rootæƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu kernel versions: < 5.8.0-50.56 (5.8 kernel), < 5.4.0-72.80 (5.4 kernel), < 4.15.0-142.146 (4.15 kernel), < 4.4.0-209.241 (4.4 kernel)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦åœ¨å­˜åœ¨æ¼æ´çš„Ubuntuå†…æ ¸ç‰ˆæœ¬ä¸Šï¼Œå¹¶ä¸”å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½overlayfs

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 5%

## è¯¦æƒ…

CVE-2021-3493 æ¼æ´æ˜¯ç”±äº Linux å†…æ ¸çš„ overlayfs å®ç°æ²¡æœ‰æ­£ç¡®éªŒè¯ç”¨æˆ·å‘½åç©ºé—´ä¸­åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸Šæ–‡ä»¶ capabilities çš„è®¾ç½®ã€‚ç”±äº Ubuntu å†…æ ¸ä¸­å­˜åœ¨å…è®¸éç‰¹æƒ overlay æŒ‚è½½çš„è¡¥ä¸ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´è·å¾—æå‡çš„æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  æ¼æ´åˆ©ç”¨ä»£ç é¦–å…ˆåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ (ovlcap/work, ovlcap/lower, ovlcap/upper, ovlcap/merge)ã€‚
2.  åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´å’ŒæŒ‚è½½å‘½åç©ºé—´ã€‚
3.  åœ¨æ–°çš„ç”¨æˆ·å‘½åç©ºé—´ä¸­ï¼Œå°†å½“å‰ç”¨æˆ·çš„ UID å’Œ GID æ˜ å°„åˆ° root ç”¨æˆ·ã€‚
4.  ä½¿ç”¨ overlayfs å°† lowerdir (ovlcap/lower), upperdir (ovlcap/upper) å’Œ workdir (ovlcap/work) æŒ‚è½½åˆ° mergedir (ovlcap/merge)ã€‚
5.  å¤åˆ¶è‡ªèº« (exploit ç¨‹åº) åˆ° mergedir/magicï¼Œå¹¶è®¾ç½® security.capability æ‰©å±•å±æ€§ä¸º all+epï¼Œèµ‹äºˆè¯¥æ–‡ä»¶ capabilitiesã€‚
6.  æ‰§è¡Œ mergedir/magicï¼Œç”±äº capabilities çš„è®¾ç½®ï¼Œè¯¥ç¨‹åºä¼šä»¥ root æƒé™æ‰§è¡Œã€‚
7.  æœ€åï¼Œæ‰§è¡Œ upperdir/magicï¼Œå¯åŠ¨ä¸€ä¸ª root shellã€‚

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„POCä»£ç æ˜¯æœ‰æ•ˆçš„ï¼Œèƒ½å¤Ÿåˆ©ç”¨ CVE-2021-3493 æ¼æ´åœ¨å—å½±å“çš„ Ubuntu ç³»ç»Ÿä¸Šå®ç°æœ¬åœ°ææƒã€‚

**æŠ•æ¯’é£é™©ï¼š**
è¯¥POCä»£ç çš„ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´è¿›è¡Œææƒï¼Œä½†ä»ç„¶å­˜åœ¨æ½œåœ¨çš„æŠ•æ¯’é£é™©ã€‚æ¯”å¦‚ä½œè€…å¯èƒ½åœ¨ç¼–è¯‘å’Œè¿è¡Œå‰æ·»åŠ ä¸€äº›æ¶æ„ä»£ç ï¼Œä¾‹å¦‚ï¼š

1.  **åé—¨æ¤å…¥ï¼š** åœ¨ææƒæˆåŠŸåï¼Œæ¤å…¥ä¸€ä¸ªåé—¨ç¨‹åºï¼Œå…è®¸æ”»å‡»è€…è¿œç¨‹è®¿é—®ç³»ç»Ÿã€‚
2.  **æ•°æ®çªƒå–ï¼š** åœ¨ææƒè¿‡ç¨‹ä¸­ï¼Œçªƒå–ç”¨æˆ·çš„æ•æ„Ÿæ•°æ®ã€‚
3.  **ç ´åç³»ç»Ÿï¼š** åœ¨ææƒå¤±è´¥æˆ–è€…æˆåŠŸåï¼Œç ´åç³»ç»Ÿæ–‡ä»¶æˆ–è€…é…ç½®ã€‚

è€ƒè™‘åˆ°ä»£ç ç›¸å¯¹ç®€çŸ­ä¸”åŠŸèƒ½æ˜ç¡®ï¼Œè¯„ä¼°æŠ•æ¯’é£é™©ä¸º5%ã€‚ç”¨æˆ·éœ€è¦ä»”ç»†å®¡æŸ¥ä»£ç ï¼Œå¹¶åœ¨å®‰å…¨çš„ç¯å¢ƒä¸­è¿›è¡Œæµ‹è¯•ã€‚

**é¡¹ç›®åœ°å€:** [briskets/CVE-2021-3493](https://github.com/briskets/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #4

**æ¥æº**: [CVE-2021-3493-cyberx-1_OverlayFS-CVE-2021-3493.md](../2021/CVE-2021-3493-cyberx-1_OverlayFS-CVE-2021-3493.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯ä»æ™®é€šç”¨æˆ·ææƒè‡³root

**å½±å“ç‰ˆæœ¬:** Ubuntu kernels: 5.8.0-50.56 (5.8 kernel), 5.4.0-72.80 (5.4 kernel), 4.15.0-142.146 (4.15 kernel), 4.4.0-209.241 (4.4 kernel)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦è¿è¡Œåœ¨å­˜åœ¨æ¼æ´çš„Ubuntuå†…æ ¸ç‰ˆæœ¬ä¸Šï¼Œå¯ç”¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å’Œå…è®¸éç‰¹æƒ overlay mountsã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2021-3493æ˜¯Ubuntuå†…æ ¸OverlayFSå®ç°ä¸­çš„ä¸€ä¸ªæƒé™æå‡æ¼æ´ã€‚ç”±äºoverlayfsåœ¨ç”¨æˆ·å‘½åç©ºé—´ä¸­æ²¡æœ‰æ­£ç¡®éªŒè¯åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­æ–‡ä»¶åŠŸèƒ½è®¾ç½®ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å’ŒUbuntuå†…æ ¸ä¸­çš„éç‰¹æƒoverlayæŒ‚è½½è¡¥ä¸ï¼Œè·å–æå‡çš„æƒé™ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** åœ¨å­˜åœ¨æ¼æ´çš„Ubuntuå†…æ ¸ä¸Šï¼Œç¡®ä¿å¯ç”¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´ã€‚æ¼æ´åº“ä¿¡æ¯æåˆ°ç¦ç”¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å¯ä»¥ä½œä¸ºç¼“è§£æªæ–½ï¼Œæ‰€ä»¥è¦ç¡®ä¿å¯ç”¨ã€‚
2.  **åˆ›å»ºOverlayFSç»“æ„ï¼š** PoCä»£ç é¦–å…ˆåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼ˆlower, upper, work, mergeï¼‰ç”¨äº overlayfs æ–‡ä»¶ç³»ç»Ÿã€‚
3.  **åˆ›å»ºç”¨æˆ·å‘½åç©ºé—´ï¼š** ä½¿ç”¨`unshare`ç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´ã€‚è¿™å…è®¸åœ¨æ–°çš„å‘½åç©ºé—´ä¸­æ‹¥æœ‰ä¸åŒçš„ç”¨æˆ·IDå’Œç»„IDæ˜ å°„ã€‚
4.  **è®¾ç½®UID/GIDæ˜ å°„ï¼š** å°†å½“å‰ç”¨æˆ·çš„UIDå’ŒGIDæ˜ å°„åˆ°æ–°å‘½åç©ºé—´ä¸­çš„rootç”¨æˆ· (UID 0 å’Œ GID 0)ã€‚
5.  **æŒ‚è½½OverlayFSï¼š** ä½¿ç”¨`mount`ç³»ç»Ÿè°ƒç”¨å°† overlayfs æ–‡ä»¶ç³»ç»ŸæŒ‚è½½åˆ° merge ç›®å½•ã€‚æŒ‡å®š lowerdir, upperdir å’Œ workdirã€‚
6.  **å¤åˆ¶è‡ªèº«å¹¶è®¾ç½®Capabilitiesï¼š** å°†è‡ªèº«å¯æ‰§è¡Œæ–‡ä»¶å¤åˆ¶åˆ° overlayfs çš„ merge ç›®å½•ï¼Œç„¶åä½¿ç”¨`setxattr`è®¾ç½®`security.capability`æ‰©å±•å±æ€§ï¼Œèµ‹äºˆè¯¥æ–‡ä»¶ root æƒé™ã€‚
7.  **æ‰§è¡Œææƒåçš„ç¨‹åºï¼š** é€šè¿‡æ‰§è¡Œ upper ç›®å½•ä¸‹çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆä¹‹å‰å¤åˆ¶å¹¶è®¾ç½®äº† capabilities çš„æ–‡ä»¶ï¼‰æ¥è·å– root æƒé™ã€‚è¿™ä¸ªç¨‹åºä¼šæ£€æŸ¥æ˜¯å¦æœ‰"shell"å‚æ•°ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™ä¼šé‡æ–°æ‰§è¡Œè‡ªèº«ï¼Œä½†è¿™æ¬¡ä¼šå¸¦æœ‰`shell`å‚æ•°ï¼Œä»è€Œè§¦å‘`setuid(0)`å’Œ`setgid(0)`ï¼Œæœ€ç»ˆæ‰§è¡Œ`/bin/bash`ï¼Œè·å¾— root shellã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

ä»£ç ä¸­å­˜åœ¨ä¸€å®šçš„æŠ•æ¯’é£é™©ï¼Œè™½ç„¶ä¸»è¦é€»è¾‘æ˜¯åˆ©ç”¨æ¼æ´è¿›è¡Œææƒï¼Œä½†å­˜åœ¨ä¿®æ”¹`/bin/bash`çš„å¯èƒ½æ€§ï¼Œä½†æ˜¯ç»è¿‡ä»£ç åˆ†æä»¥åŠæ¼æ´åŸç†ï¼Œåˆ¤æ–­æ¼æ´åˆ©ç”¨è¿‡ç¨‹ä¸­æ²¡æœ‰ä¿®æ”¹`/bin/bash`æ“ä½œ,ä»£ç ä¸­é£é™©ä¸»è¦å­˜åœ¨äºä»¥ä¸‹å‡ ç‚¹:

1.  **ä¾èµ–å¤–éƒ¨äºŒè¿›åˆ¶æ–‡ä»¶ï¼š** è¯¥æ¼æ´åˆ©ç”¨ä¾èµ–äºç³»ç»Ÿä¸Šçš„`/bin/bash`ã€‚å¦‚æœæ”»å‡»è€…æ›¿æ¢æˆ–ç¯¡æ”¹äº†ç›®æ ‡ç³»ç»Ÿä¸Šçš„`/bin/bash`ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ„å¤–çš„è¡Œä¸ºæˆ–å®‰å…¨é—®é¢˜ã€‚
2.  **æ¸…ç†æ“ä½œé£é™©ï¼š** ä»£ç å¼€å§‹æ—¶ä½¿ç”¨`system(buf)`æ‰§è¡Œ`rm -rf '%s/'`ï¼Œå¦‚æœ`DIR_BASE`è¢«æ¶æ„ä¿®æ”¹ï¼Œå¯èƒ½å¯¼è‡´æ„å¤–çš„æ–‡ä»¶åˆ é™¤ã€‚
3.  **ä¸å®Œå–„çš„é”™è¯¯å¤„ç†ï¼š** è™½ç„¶ PoC ä»£ç åŒ…å«äº†ä¸€äº›é”™è¯¯å¤„ç†ï¼Œä½†åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå¦‚æœé”™è¯¯å¤„ç†ä¸å½“ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ‹’ç»æœåŠ¡æˆ–æœªå®šä¹‰çš„è¡Œä¸ºã€‚

æ€»ä½“è€Œè¨€ï¼Œè¯¥ PoC ä»£ç çš„æŠ•æ¯’é£é™©è¾ƒä½ï¼Œä¸»è¦é£é™©åœ¨äºä¾èµ–å¤–éƒ¨äºŒè¿›åˆ¶æ–‡ä»¶å’Œæ½œåœ¨çš„æ¸…ç†æ“ä½œé£é™©ã€‚ä»£ç æœ¬èº«ä¸»è¦æ˜¯ä¸ºäº†æ¼”ç¤ºæ¼æ´åˆ©ç”¨ï¼Œå¹¶æœªå‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç ã€‚ è¯„ä¼°æŠ•æ¯’é£é™©ä¸º10%ã€‚


**é¡¹ç›®åœ°å€:** [cyberx-1/OverlayFS-CVE-2021-3493](https://github.com/cyberx-1/OverlayFS-CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #5

**æ¥æº**: [CVE-2021-3493-derek-turing_CVE-2021-3493.md](../2021/CVE-2021-3493-derek-turing_CVE-2021-3493.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Ubuntu Linux Kernel

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœ¬åœ°ç”¨æˆ·å¯æå‡è‡³ root æƒé™

**å½±å“ç‰ˆæœ¬:** 4.4 <= kernel < 4.4.0-209.241, 4.15 <= kernel < 4.15.0-142.146, 5.4 <= kernel < 5.4.0-72.80, 5.8 <= kernel < 5.8.0-50.56

**åˆ©ç”¨æ¡ä»¶:** Ubuntu å†…æ ¸å¼€å¯äº† unprivileged user namespaces å’Œ unprivileged overlay mounts

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

è¯¥æ¼æ´å­˜åœ¨äº Ubuntu Linux å†…æ ¸çš„ OverlayFS å®ç°ä¸­ï¼Œç”±äº overlayfs å¯¹åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­æ–‡ä»¶ capabilities çš„è®¾ç½®éªŒè¯ä¸å½“ï¼Œç»“åˆæœªæˆæƒç”¨æˆ·å‘½åç©ºé—´å’Œ Ubuntu å†…æ ¸ä¸­å…è®¸æœªæˆæƒ overlay æŒ‚è½½çš„è¡¥ä¸ï¼Œæ”»å‡»è€…å¯åˆ©ç”¨æ­¤æ¼æ´æå‡æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** é¦–å…ˆï¼Œç¡®ä¿ç›®æ ‡ç³»ç»Ÿæ»¡è¶³æ¼æ´åˆ©ç”¨çš„æ¡ä»¶ï¼Œå³ Ubuntu å†…æ ¸ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…ï¼Œå¹¶ä¸”å¯ç”¨äº† unprivileged user namespaces å’Œ unprivileged overlay mountsã€‚æ¼æ´åº“ä¿¡æ¯ä¸­ç»™å‡ºäº†å—å½±å“çš„ç‰ˆæœ¬èŒƒå›´ã€‚
2.  **åˆ›å»ºç›®å½•ç»“æ„ï¼š** åˆ›å»º overlayfs æ‰€éœ€çš„ç›®å½•ç»“æ„ï¼ŒåŒ…æ‹¬ lowerdirï¼ˆåº•å±‚ç›®å½•ï¼‰ã€upperdirï¼ˆä¸Šå±‚ç›®å½•ï¼‰ã€workdirï¼ˆå·¥ä½œç›®å½•ï¼‰å’Œ mergedirï¼ˆåˆå¹¶ç›®å½•ï¼‰ã€‚
3.  **åˆ›å»ºç”¨æˆ·å‘½åç©ºé—´ï¼š** ä½¿ç”¨ `unshare` å‘½ä»¤åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´ï¼Œè¿™å…è®¸åœ¨éç‰¹æƒç”¨æˆ·ä¸‹æ‰§è¡Œä¸€äº›ç‰¹æƒæ“ä½œã€‚
4.  **è®¾ç½® UID/GID æ˜ å°„ï¼š** åœ¨ç”¨æˆ·å‘½åç©ºé—´ä¸­ï¼Œå°†å½“å‰ç”¨æˆ·çš„ UID å’Œ GID æ˜ å°„åˆ° root ç”¨æˆ· (UID 0) å’Œ root ç»„ (GID 0)ï¼Œè¿™æ ·åœ¨ overlayfs ä¸­åˆ›å»ºçš„æ–‡ä»¶å°†å±äº root ç”¨æˆ·ã€‚
5.  **æŒ‚è½½ OverlayFSï¼š** ä½¿ç”¨ `mount` å‘½ä»¤å°† overlayfs æŒ‚è½½åˆ° mergedirï¼ŒæŒ‡å®š lowerdirã€upperdir å’Œ workdirã€‚
6.  **å¤åˆ¶å¹¶è®¾ç½® Capabilitiesï¼š** å°† exploit ç¨‹åºè‡ªèº«å¤åˆ¶åˆ° mergedir ä¸­ï¼Œå¹¶ä½¿ç”¨ `setxattr` å‘½ä»¤è®¾ç½®å…¶ security.capability æ‰©å±•å±æ€§ï¼Œèµ‹äºˆå…¶ CAP_SETUID å’Œ CAP_SETGID capabilitiesã€‚è¿™ä¸ªcapabilitieså…è®¸ç¨‹åºåœ¨æ²¡æœ‰rootæƒé™çš„æƒ…å†µä¸‹è®¾ç½®uidå’Œgidã€‚
7.  **è§¦å‘ææƒï¼š** è¿è¡Œ mergedir ä¸­çš„ exploit ç¨‹åºï¼Œç”±äºå·²è®¾ç½® capabilitiesï¼Œç¨‹åºå°†ä»¥ root æƒé™è¿è¡Œï¼Œä»è€Œæ‰§è¡Œç‰¹æƒæ“ä½œã€‚

**ä»£ç åˆ†æï¼š**

*   `exploit.c` æ˜¯åˆ©ç”¨ä»£ç ï¼Œå®ƒåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼Œå»ºç«‹ç”¨æˆ·å‘½åç©ºé—´ï¼ŒæŒ‚è½½ overlayfsï¼Œç„¶åå°†è‡ªèº«å¤åˆ¶åˆ° overlayfs ä¸­ï¼Œå¹¶è®¾ç½® capabilitiesã€‚æœ€åï¼Œæ‰§è¡Œå¤åˆ¶åˆ° upperdir ä¸­çš„ç¨‹åºï¼Œè¯¥ç¨‹åºä¼šå°†å½“å‰è¿›ç¨‹ææƒä¸º rootã€‚
*   ä»£ç ä¸­ä½¿ç”¨äº† `setxattr` å‡½æ•°æ¥è®¾ç½®æ–‡ä»¶ capabilitiesï¼Œè¿™æ˜¯åˆ©ç”¨æ¼æ´çš„å…³é”®æ­¥éª¤ã€‚
*   mainå‡½æ•°é¦–å…ˆforkä¸€ä¸ªå­è¿›ç¨‹æ‰§è¡Œexploitå‡½æ•°ï¼Œåœ¨exploitå‡½æ•°æ‰§è¡Œå®Œæ¯•åï¼Œçˆ¶è¿›ç¨‹æ‰§è¡ŒBIN_UPPERä¸­çš„magicç¨‹åºï¼Œå¦‚æœå¸¦æœ‰shellå‚æ•°ï¼Œmagicç¨‹åºä¼šè®¾ç½®uidå’Œgidä¸º0ï¼Œå¹¶ä¸”è¿è¡Œä¸€ä¸ªbash shellã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

ä»”ç»†æ£€æŸ¥äº† POC ä»£ç ï¼Œæ²¡æœ‰å‘ç°æ˜æ˜¾çš„æŠ•æ¯’ä»£ç ã€‚ä»£ç é€»è¾‘æ¸…æ™°ï¼Œä¸»è¦ç”¨äºåˆ›å»º overlayfs ç¯å¢ƒå¹¶è®¾ç½®æ–‡ä»¶ capabilities ä»¥è¿›è¡Œææƒã€‚ä½œè€…å¹¶æ²¡æœ‰å°è¯•åœ¨ä»£ç ä¸­éšè—æ¶æ„è¡Œä¸ºï¼Œä¾‹å¦‚ï¼š

*   è¿æ¥å¤–éƒ¨æœåŠ¡å™¨
*   ä¿®æ”¹ç³»ç»Ÿæ–‡ä»¶
*   å®‰è£…åé—¨
*   æ”¶é›†ç”¨æˆ·ä¿¡æ¯

å› æ­¤ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ (0%)ã€‚

**é¡¹ç›®åœ°å€:** [derek-turing/CVE-2021-3493](https://github.com/derek-turing/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #6

**æ¥æº**: [CVE-2021-3493-fathallah17_OverlayFS-CVE-2021-3493.md](../2021/CVE-2021-3493-fathallah17_OverlayFS-CVE-2021-3493.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°æƒé™æå‡

**å½±å“åº”ç”¨:** Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å¯¼è‡´æœ¬åœ°æƒé™æå‡è‡³root

**å½±å“ç‰ˆæœ¬:** 4.4 <= Linux Kernel < 5.8.0-50.56 (Ubuntu ç‰¹å®šç‰ˆæœ¬)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦å­˜åœ¨Ubuntuå†…æ ¸ä¸­å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½OverlayFSçš„è¡¥ä¸ï¼Œä¸”ç”¨æˆ·å‘½åç©ºé—´æœªè¢«ç¦ç”¨ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 1%

## è¯¦æƒ…

CVE-2021-3493 æ˜¯ä¸€ä¸ªå­˜åœ¨äº Linux å†…æ ¸ OverlayFS å®ç°ä¸­çš„æƒé™æå‡æ¼æ´ã€‚æ¼æ´çš„æ ¹æœ¬åŸå› æ˜¯ OverlayFS åœ¨è®¾ç½®åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­æ–‡ä»¶çš„ capabilities æ—¶ï¼Œæ²¡æœ‰æ­£ç¡®åœ°éªŒè¯ç”¨æˆ·å‘½åç©ºé—´ã€‚åœ¨å­˜åœ¨å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½ OverlayFS çš„ Ubuntu å†…æ ¸è¡¥ä¸çš„ç¯å¢ƒä¸­ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´è·å¾—æå‡çš„æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š**  ç›®æ ‡ç³»ç»Ÿéœ€è¦æ˜¯å—å½±å“çš„ Ubuntu ç‰ˆæœ¬ï¼Œå¹¶ä¸”å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½ OverlayFSï¼ŒåŒæ—¶ç”¨æˆ·å‘½åç©ºé—´æ²¡æœ‰è¢«ç¦ç”¨ã€‚
2.  **è·å–æ¼æ´åˆ©ç”¨ä»£ç ï¼š**  ä»å¯ä¿¡æ¥æºè·å–æ¼æ´åˆ©ç”¨ä»£ç  (ä¾‹å¦‚ SSD-Disclosure æä¾›çš„ exploit.c)ã€‚
3.  **ç¼–è¯‘æ¼æ´åˆ©ç”¨ä»£ç ï¼š**  ä½¿ç”¨ gcc ç­‰ç¼–è¯‘å™¨å°† exploit.c ç¼–è¯‘ä¸ºå¯æ‰§è¡Œæ–‡ä»¶ã€‚
4.  **æ‰§è¡Œæ¼æ´åˆ©ç”¨ä»£ç ï¼š**  è¿è¡Œç¼–è¯‘åçš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚æ¼æ´åˆ©ç”¨ä»£ç ä¼šåˆ©ç”¨ OverlayFS çš„æ¼æ´ï¼Œé€šè¿‡è®¾ç½®æ–‡ä»¶ capabilities æ¥æå‡å½“å‰ç”¨æˆ·çš„æƒé™è‡³ rootã€‚
5.  **è·å– root æƒé™ï¼š**  æˆåŠŸæ‰§è¡Œæ¼æ´åˆ©ç”¨ä»£ç åï¼Œç”¨æˆ·å°†è·å¾— root æƒé™ã€‚

**å…³äºæŠ•æ¯’é£é™©ï¼š**

æä¾›çš„POCä»£ç åªæ˜¯ä¸€ä¸ªç®€å•çš„åˆ©ç”¨æ–¹å¼,ä¸å¤ªå¯èƒ½åŒ…å«æ¶æ„ä»£ç ã€‚ä½†å§‹ç»ˆéœ€è¦å¯¹ä»»ä½•æ¥æºçš„æ¼æ´åˆ©ç”¨ä»£ç è¿›è¡Œå®¡æŸ¥ï¼Œä»¥é™ä½é£é™©ã€‚
å¯¹ä¸‹è½½çš„æ–‡ä»¶è¿›è¡Œæ£€æŸ¥ï¼Œå¦‚å“ˆå¸Œæ ¡éªŒï¼Œå¯ä»¥æœ€å¤§ç¨‹åº¦çš„é¿å…å¼•å…¥æ¶æ„ä»£ç ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**

æ ¹æ®æ¼æ´æè¿°å’Œåˆ©ç”¨ä»£ç ï¼Œè¯¥æ¼æ´åˆ©ç”¨æ˜¯æœ‰æ•ˆçš„ã€‚åˆ©ç”¨ä»£ç é€šè¿‡OverlayFSçš„æ¼æ´ï¼Œå…è®¸ä½æƒé™ç”¨æˆ·è·å¾—rootæƒé™ã€‚

**å…¶ä»–ä¿¡æ¯:**
CISA å·²å°†æ­¤æ¼æ´æ·»åŠ åˆ°å·²çŸ¥è¢«åˆ©ç”¨çš„æ¼æ´ç›®å½• (KEV) ä¸­ï¼Œè¡¨æ˜è¯¥æ¼æ´å·²è¢«å¹¿æ³›åˆ©ç”¨ã€‚

**é¡¹ç›®åœ°å€:** [fathallah17/OverlayFS-CVE-2021-3493](https://github.com/fathallah17/OverlayFS-CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #7

**æ¥æº**: [CVE-2021-3493-fei9747_CVE-2021-3493.md](../2021/CVE-2021-3493-fei9747_CVE-2021-3493.md)

## CVE-2021-3493 Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ”»å‡»è€…å¯åˆ©ç”¨æ­¤æ¼æ´è·å– root æƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu kernel versions: < 5.8.0-50.56, < 5.4.0-72.80, < 4.15.0-142.146, < 4.4.0-209.241

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦åœ¨å­˜åœ¨æ¼æ´çš„ Ubuntu ç³»ç»Ÿä¸Šæœ¬åœ°æ‰§è¡Œ

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 5%

## è¯¦æƒ…

CVE-2021-3493 æ˜¯ä¸€ä¸ªå­˜åœ¨äº Ubuntu Linux å†…æ ¸ overlayfs å®ç°ä¸­çš„æœ¬åœ°ææƒæ¼æ´ã€‚è¯¥æ¼æ´æºäº overlayfs æœªèƒ½æ­£ç¡®éªŒè¯ç”¨æˆ·å‘½åç©ºé—´ä¸­åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸Šæ–‡ä»¶ capabilities çš„è®¾ç½®ã€‚ç»“åˆæœªæˆæƒç”¨æˆ·å‘½åç©ºé—´ä»¥åŠ Ubuntu å†…æ ¸ä¸­å…è®¸æœªæˆæƒ overlay mount çš„è¡¥ä¸ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´æå‡æƒé™ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼ŒåŒ…æ‹¬lowerdirï¼Œupperdirï¼Œworkdirå’Œmergedirã€‚
2.  **åˆ›å»ºå‘½åç©ºé—´ï¼š** ä½¿ç”¨ `unshare` ç³»ç»Ÿè°ƒç”¨åˆ›å»ºæ–°çš„ç”¨æˆ·å‘½åç©ºé—´å’ŒæŒ‚è½½å‘½åç©ºé—´ã€‚
3.  **è®¾ç½®ç”¨æˆ·å’Œç»„IDæ˜ å°„ï¼š** å°†å½“å‰ç”¨æˆ·çš„ UID å’Œ GID æ˜ å°„åˆ°æ–°çš„ç”¨æˆ·å‘½åç©ºé—´ä¸­ï¼Œä»¥ä¾¿åœ¨æ–°çš„å‘½åç©ºé—´ä¸­æ‹¥æœ‰æƒé™ã€‚
4.  **æŒ‚è½½ OverlayFSï¼š** ä½¿ç”¨ `mount` ç³»ç»Ÿè°ƒç”¨ï¼Œå°† overlayfs æŒ‚è½½åˆ° mergedirï¼Œå¹¶å°† lowerdirï¼Œupperdir å’Œ workdir æŒ‡å®šä¸ºç›¸åº”çš„ç›®å½•ã€‚
5.  **è®¾ç½® Capabilitiesï¼š** å¤åˆ¶å½“å‰æ‰§è¡Œçš„ç¨‹åºåˆ° mergedirï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½®è¯¥æ–‡ä»¶çš„ capabilitiesï¼Œä½¿å…¶å…·æœ‰ root æƒé™ã€‚ è¿™æ­¥æ˜¯æ¼æ´åˆ©ç”¨çš„å…³é”®ã€‚
6.  **æ‰§è¡ŒPayloadï¼š** æ‰§è¡Œupperç›®å½•ä¸­çš„æ–‡ä»¶ï¼Œå› ä¸ºè®¾ç½®äº†Capabilitiesï¼Œå¯ä»¥è·å¾—rootæƒé™ã€‚

**æœ‰æ•ˆæ€§ï¼š**

æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’ŒPOCä»£ç æè¿°ï¼Œè¯¥æ¼æ´åœ¨ç‰¹å®šç‰ˆæœ¬çš„ Ubuntu å†…æ ¸ä¸Šæ˜¯å¯åˆ©ç”¨çš„ã€‚æä¾›çš„POCä»£ç å±•ç¤ºäº†åˆ©ç”¨è¯¥æ¼æ´æå‡æƒé™çš„å®Œæ•´è¿‡ç¨‹ã€‚

**æŠ•æ¯’é£é™©ï¼š**

ä»£ç ä¸­å­˜åœ¨æ½œåœ¨çš„æŠ•æ¯’é£é™©ï¼Œä½†æ˜¯é£é™©è¾ƒä½ã€‚ä¸»è¦é›†ä¸­åœ¨ç¼–è¯‘å’Œè¿è¡Œexploitæ—¶ã€‚æ”»å‡»è€…å¯èƒ½é€šè¿‡ä¿®æ”¹ exploit.c æ–‡ä»¶ï¼Œä¾‹å¦‚æ·»åŠ æ¶æ„ä»£ç æˆ–åé—¨ï¼Œä»è€Œåœ¨ç›®æ ‡ç³»ç»Ÿä¸Šæ‰§è¡Œæ¶æ„æ“ä½œã€‚ä½†æ˜¯æ ¹æ®æä¾›çš„POCä»£ç æ¥çœ‹, é£é™©ç³»æ•°è¾ƒä½.

**é£é™©è¯„ä¼°ï¼š**

è¯¥æ¼æ´åˆ©ç”¨çš„æˆåŠŸå–å†³äºç›®æ ‡ç³»ç»Ÿæ˜¯å¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š

*   è¿è¡Œå—å½±å“çš„ Ubuntu å†…æ ¸ç‰ˆæœ¬ã€‚
*   å¯ç”¨äº†æœªæˆæƒç”¨æˆ·å‘½åç©ºé—´å’Œ overlayfs mountã€‚
*   ç›®æ ‡ç³»ç»Ÿä¸Šå­˜åœ¨ `gcc` ç¼–è¯‘å™¨, èƒ½å¤Ÿç¼–è¯‘exploitã€‚

å¦‚æœç›®æ ‡ç³»ç»Ÿæ»¡è¶³è¿™äº›æ¡ä»¶ï¼Œæ”»å‡»è€…å¯ä»¥ä½¿ç”¨æä¾›çš„ POC ä»£ç æˆåŠŸåˆ©ç”¨è¯¥æ¼æ´ï¼Œä»è€Œè·å¾— root æƒé™ã€‚


**é¡¹ç›®åœ°å€:** [fei9747/CVE-2021-3493](https://github.com/fei9747/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #8

**æ¥æº**: [CVE-2021-3493-iamz24_CVE-2021-3493_CVE-2022-3357.md](../2021/CVE-2021-3493-iamz24_CVE-2021-3493_CVE-2022-3357.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒæ¼æ´

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å¯¼è‡´æœ¬åœ°æƒé™æå‡è‡³ root

**å½±å“ç‰ˆæœ¬:** Ubuntu kernels < 5.8.0-50.56, < 5.4.0-72.80, < 4.15.0-142.146, < 4.4.0-209.241

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç›®æ ‡ç³»ç»Ÿå¼€å¯ unprivileged user namespaces å’Œå­˜åœ¨ OverlayFS æœåŠ¡ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2021-3493 æ¼æ´æ˜¯ Linux å†…æ ¸ overlayfs å®ç°ä¸­ï¼Œåœ¨ç”¨æˆ·å‘½åç©ºé—´ä¸­å¯¹åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­çš„æ–‡ä»¶ capabilities éªŒè¯ä¸å½“å¯¼è‡´çš„ã€‚ç”±äº Ubuntu å†…æ ¸ä¸­å­˜åœ¨å…è®¸éç‰¹æƒ overlay æŒ‚è½½çš„è¡¥ä¸ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¯¥æ¼æ´æå‡æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** æ£€æŸ¥ç›®æ ‡ç³»ç»Ÿæ˜¯å¦å­˜åœ¨ overlayfs æœåŠ¡ï¼Œå¦‚æœæ²¡æœ‰åˆ™åŠ è½½ overlay æ¨¡å—ã€‚åŒæ—¶ï¼Œç¡®ä¿å¼€å¯äº† unprivileged user namespacesã€‚
2.  **ç¼–è¯‘ Payloadï¼š** ä½¿ç”¨ GCC ç¼–è¯‘æä¾›çš„ `payload.c` æ–‡ä»¶ã€‚
3.  **è¿è¡Œ Payloadï¼š** è¿è¡Œç¼–è¯‘åçš„å¯æ‰§è¡Œæ–‡ä»¶ `a.out`ã€‚
4.  **è·å– Root Shellï¼š** Payload ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å‘½åç©ºé—´ï¼ŒæŒ‚è½½ overlayfsï¼Œè®¾ç½® capabilityï¼Œæœ€ç»ˆæ‰§è¡Œä¸€ä¸ªå…·æœ‰ root æƒé™çš„ shellã€‚

**æœ‰æ•ˆæ€§ï¼š**

æä¾›çš„ POC ä»£ç åŸºæœ¬æœ‰æ•ˆï¼Œèƒ½å¤Ÿåˆ©ç”¨è¯¥æ¼æ´åœ¨ç¬¦åˆæ¡ä»¶çš„ Ubuntu ç³»ç»Ÿä¸Šå®ç°æœ¬åœ°ææƒã€‚

**æŠ•æ¯’é£é™©ï¼š**

å­˜åœ¨è¾ƒä½çš„æŠ•æ¯’é£é™©ï¼ˆ10%ï¼‰ã€‚è™½ç„¶ä»£ç çš„ä¸»è¦åŠŸèƒ½æ˜¯å®ç°ææƒï¼Œä½†ä»ç„¶éœ€è¦è°¨æ…å¯¹å¾…æ¥æºä¸æ˜çš„ä»£ç ï¼Œä½œè€…å¯èƒ½ä¼šåœ¨å…¶ä¸­éšè—ä¸€äº›æ¶æ„è¡Œä¸ºï¼Œæ¯”å¦‚ä¸Šä¼ æ•æ„Ÿä¿¡æ¯ç­‰ã€‚ç‰¹åˆ«æ˜¯éœ€è¦æ£€æŸ¥ `exploit`å‡½æ•°ä¸­çš„ç›¸å…³æ–‡ä»¶æ“ä½œå’Œå‘½ä»¤æ‰§è¡Œæ˜¯å¦å­˜åœ¨æ¶æ„è¡Œä¸ºã€‚å°¤å…¶å…³æ³¨`system(buf);`æ˜¯å¦ä¼šæ‰§è¡Œæ¶æ„çš„æŒ‡ä»¤ã€‚

**æ€»ç»“ï¼š**

è¯¥æ¼æ´åˆ©ç”¨è¾ƒä¸ºç›´æ¥ï¼Œåˆ©ç”¨æ¡ä»¶ç›¸å¯¹æ˜ç¡®ï¼Œä½†éœ€è¦æ³¨æ„æ½œåœ¨çš„æŠ•æ¯’é£é™©ã€‚åœ¨å®é™…ä½¿ç”¨æ—¶ï¼Œåº”è¯¥ä»”ç»†å®¡æŸ¥ä»£ç ï¼Œç¡®ä¿æ²¡æœ‰æ¶æ„è¡Œä¸ºã€‚

**é¡¹ç›®åœ°å€:** [iamz24/CVE-2021-3493_CVE-2022-3357](https://github.com/iamz24/CVE-2021-3493_CVE-2022-3357)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #9

**æ¥æº**: [CVE-2021-3493-inspiringz_CVE-2021-3493.md](../2021/CVE-2021-3493-inspiringz_CVE-2021-3493.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Ubuntu Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸ä½æƒé™ç”¨æˆ·æå‡åˆ°rootæƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu 4.4, 4.15, 5.4, 5.8 kernels (å—å½±å“ç‰ˆæœ¬è¯¦è§æ¼æ´åº“ä¿¡æ¯)

**åˆ©ç”¨æ¡ä»¶:** Ubuntuå†…æ ¸ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…ï¼Œå¯ç”¨æœªæˆæƒç”¨æˆ·å‘½åç©ºé—´ï¼Œå…è®¸æœªæˆæƒOverlayFSæŒ‚è½½ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 5%

## è¯¦æƒ…

CVE-2021-3493æ˜¯Ubuntuå†…æ ¸ä¸­OverlayFSå®ç°çš„ä¸€ä¸ªæ¼æ´ï¼Œå…è®¸ä½æƒé™ç”¨æˆ·é€šè¿‡åˆ©ç”¨user namespaceå’ŒOverlayFSæŒ‚è½½ç»•è¿‡æ–‡ä»¶ç³»ç»Ÿæƒé™æ£€æŸ¥æ¥æå‡æƒé™ã€‚ 

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡:** æ¼æ´åˆ©ç”¨éœ€è¦å­˜åœ¨Ubuntuç³»ç»Ÿï¼Œä¸”å†…æ ¸ç‰ˆæœ¬åœ¨æ¼æ´åº“ä¿¡æ¯ä¸­æè¿°çš„å—å½±å“èŒƒå›´å†…ï¼Œå¹¶ä¸”éœ€è¦å¯ç”¨æœªæˆæƒç”¨æˆ·å‘½åç©ºé—´(unprivileged user namespaces)ã€‚æ­¤å¤–ï¼Œä¸ºäº†åˆ©ç”¨OverlayFSï¼Œç³»ç»Ÿéœ€è¦é…ç½®å…è®¸æœªæˆæƒç”¨æˆ·è¿›è¡ŒOverlayFSæŒ‚è½½ã€‚
2.  **æ¼æ´åˆ©ç”¨:**  æ”»å‡»è€…é¦–å…ˆåˆ›å»ºä¸€ä¸ªåŒ…å«lower, upper, workç›®å½•çš„OverlayFSç»“æ„ã€‚
3.  **åˆ©ç”¨è¿‡ç¨‹:** åˆ©ç”¨`unshare`ç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€ä¸ªæ–°çš„user namespaceå’Œmount namespaceã€‚ åœ¨æ–°namespaceä¸­ï¼Œå°†è‡ªå·±çš„UIDå’ŒGIDæ˜ å°„åˆ°rootæƒé™ã€‚ ç„¶åï¼Œä½¿ç”¨æ„é€ çš„lowerdirã€upperdirå’ŒworkdiræŒ‚è½½OverlayFSæ–‡ä»¶ç³»ç»Ÿã€‚ æ”»å‡»è€…å°†ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶å¤åˆ¶åˆ°OverlayFSçš„mergeç›®å½•ä¸­ã€‚å…³é”®çš„ä¸€æ­¥æ˜¯ï¼Œæ”»å‡»è€…ä½¿ç”¨`setxattr`ç³»ç»Ÿè°ƒç”¨ï¼Œè®¾ç½®è¯¥å¯æ‰§è¡Œæ–‡ä»¶çš„`security.capability`æ‰©å±•å±æ€§ï¼Œèµ‹äºˆå®ƒ`CAP_SETUID`å’Œ`CAP_SETGID`èƒ½åŠ›ã€‚ ç”±äºOverlayFSçš„æƒé™éªŒè¯ä¸å®Œå–„ï¼Œè¿™ä¸ªæ“ä½œå³ä½¿åœ¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´ä¸­ä¹Ÿèƒ½æˆåŠŸã€‚å½“æ‰§è¡Œè¯¥æ–‡ä»¶æ—¶ï¼Œå®ƒå°†è·å¾—rootæƒé™ï¼Œå¹¶å¯ä»¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚
4.  **POCä»£ç åˆ†æ:** `exploit.c` ä»£ç é¦–å…ˆåˆ›å»ºä¸€ä¸ªoverlayfsç›®å½•ç»“æ„ã€‚ç„¶åï¼Œä½¿ç”¨ `unshare` ç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€ä¸ªæ–°çš„ user namespace å’Œ mount namespaceï¼Œå¹¶å°†å½“å‰ç”¨æˆ·çš„ uid å’Œ gid æ˜ å°„åˆ° root ç”¨æˆ·ã€‚ ä¹‹åï¼Œå®ƒæŒ‚è½½ overlayfsï¼Œå¤åˆ¶å½“å‰æ‰§è¡Œçš„ç¨‹åºåˆ° overlayfs çš„ merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½® capabilityã€‚æœ€åï¼Œæ‰§è¡Œå¤åˆ¶åˆ° overlayfs çš„ç¨‹åºã€‚
5. **æŠ•æ¯’é£é™©åˆ†æ:** ä»£ç æœ¬èº«å®ç°äº†æ¼æ´åˆ©ç”¨çš„åŠŸèƒ½ã€‚ æ½œåœ¨çš„æŠ•æ¯’é£é™©å¯èƒ½å­˜åœ¨äºä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š
    *   **ä¾èµ–é¡¹:**  ä»£ç ä¾èµ–äºæ ‡å‡†çš„Cåº“ï¼Œæœ¬èº«ä¸å­˜åœ¨æ¶æ„ä¾èµ–ã€‚ä½†ç”¨æˆ·åœ¨ç¼–è¯‘æ—¶éœ€è¦æ³¨æ„ç¼–è¯‘å™¨ç¯å¢ƒçš„å®‰å…¨æ€§ã€‚
    *   **ä»£ç é€»è¾‘:**  ä»£ç é€»è¾‘ç›¸å¯¹ç®€å•ï¼Œä¸»è¦é›†ä¸­åœ¨namespaceåˆ›å»ºã€æŒ‚è½½å’Œcapabilityè®¾ç½®ã€‚ ä»”ç»†å®¡æŸ¥ä»£ç ï¼Œæœªå‘ç°æ˜æ˜¾çš„æ¶æ„é€»è¾‘ã€‚
    *   **æ‰§è¡Œå‘½ä»¤:**  ä»£ç ä¸­ä½¿ç”¨äº† `system` å‡½æ•°ï¼Œè¿™æ˜¯ä¸€ä¸ªæ½œåœ¨çš„é£é™©ç‚¹ï¼Œå¯ä»¥æ‰§è¡Œä»»æ„ç³»ç»Ÿå‘½ä»¤ã€‚ä½†æ˜¯ï¼Œè¿™é‡Œåªæ˜¯ç”¨æ¥åˆ é™¤ç›®å½•ï¼Œç›¸å¯¹å®‰å…¨ã€‚
       ç»¼ä¸Šæ‰€è¿°ï¼Œè¯¥POCä»£ç ä¸»è¦é£é™©åœ¨äºç¡®ä¿ç¼–è¯‘ç¯å¢ƒå®‰å…¨ä»¥åŠå¯¹ä¸ç†Ÿæ‚‰çš„å‘½ä»¤ä¿æŒè­¦æƒ•ã€‚æŠ•æ¯’é£é™©è¾ƒä½ï¼Œé¢„ä¼°ä¸º5%ã€‚

**æ€»ç»“ï¼š**

è¯¥æ¼æ´åˆ©ç”¨çš„æ ¸å¿ƒåœ¨äºç»“åˆäº†æœªæˆæƒç”¨æˆ·å‘½åç©ºé—´å’ŒOverlayFSï¼Œåˆ©ç”¨OverlayFSå¯¹capabilitiesè®¾ç½®éªŒè¯çš„ç¼ºé™·ï¼Œå®ç°äº†æœ¬åœ°ææƒã€‚ æ”»å‡»è€…é€šè¿‡åˆ›å»ºç‰¹æ®Šçš„OverlayFSç»“æ„å¹¶è®¾ç½®æ–‡ä»¶capabilitiesï¼Œæœ€ç»ˆè·å¾—rootæƒé™ã€‚

**é¡¹ç›®åœ°å€:** [inspiringz/CVE-2021-3493](https://github.com/inspiringz/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #10

**æ¥æº**: [CVE-2021-3493-oneoy_CVE-2021-3493.md](../2021/CVE-2021-3493-oneoy_CVE-2021-3493.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœ¬åœ°ç”¨æˆ·å¯æå‡è‡³ root æƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu 4.4, 4.15, 5.4, and 5.8 kernels (å…·ä½“ç‰ˆæœ¬å·è§æ¼æ´åº“ä¿¡æ¯)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç›®æ ‡ç³»ç»Ÿå­˜åœ¨æœªä¿®å¤çš„ Ubuntu kernelï¼Œä¸”å¯ç”¨ unprivileged user namespaces å’Œå…è®¸ unprivileged overlayfs mountsã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

è¯¥æ¼æ´å­˜åœ¨äº Ubuntu å†…æ ¸çš„ OverlayFS å®ç°ä¸­ï¼Œç”±äºæœªæ­£ç¡®éªŒè¯ç”¨æˆ·å‘½åç©ºé—´ä¸­åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸Šæ–‡ä»¶ capabilities çš„è®¾ç½®ï¼Œå¯¼è‡´æœ¬åœ°æ”»å‡»è€…å¯åˆ©ç”¨ unprivileged user namespaces å’Œ Ubuntu å†…æ ¸ä¸­å…è®¸ unprivileged overlayfs mounts çš„è¡¥ä¸æ¥æå‡æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ (lower, upper, work, merge)ã€‚
2.  **é…ç½® User Namespace:** åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´ã€‚
3.  **é…ç½® OverlayFS:** ä½¿ç”¨ lowerdir, upperdir, å’Œ workdir é€‰é¡¹æŒ‚è½½ overlay æ–‡ä»¶ç³»ç»Ÿã€‚
4.  **è®¾ç½® Capabilities:** å°†å¯æ‰§è¡Œæ–‡ä»¶å¤åˆ¶åˆ° merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½®å…¶ capabilities (å¦‚ CAP_SETUID, CAP_SETGID, CAP_CHOWN)ã€‚
5.  **è§¦å‘ææƒ:** æ‰§è¡Œ merge ç›®å½•ä¸­çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶å°†ä¼šä»¥ root æƒé™æ‰§è¡Œã€‚

**æŠ•æ¯’é£é™©è¯„ä¼°ï¼š**

æä¾›çš„ `exploit.c` ä»£ç ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨ OverlayFS çš„æ¼æ´è¿›è¡Œææƒã€‚ä»£ç åˆ›å»ºå¿…è¦çš„ç›®å½•ï¼Œé…ç½® user namespace å’Œ overlay æ–‡ä»¶ç³»ç»Ÿï¼Œå¹¶è®¾ç½®å¯æ‰§è¡Œæ–‡ä»¶çš„ capabilitiesã€‚ä»£ç é€»è¾‘æ¸…æ™°ï¼Œæ²¡æœ‰å‘ç°æ¶æ„ä»£ç æˆ–åé—¨ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**

æä¾›çš„ POC ä»£ç åŸºäºå…¬å¼€ä¿¡æ¯ï¼Œå¹¶é’ˆå¯¹ CVE-2021-3493 æ¼æ´è¿›è¡Œäº†åˆ©ç”¨ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯ã€æœç´¢å¼•æ“ç»“æœå’Œä»£ç åˆ†æï¼Œè¯¥ POC ä»£ç åœ¨æ»¡è¶³æ¼æ´åˆ©ç”¨æ¡ä»¶çš„æƒ…å†µä¸‹åº”è¯¥æ˜¯æœ‰æ•ˆçš„ã€‚

**é¡¹ç›®åœ°å€:** [oneoy/CVE-2021-3493](https://github.com/oneoy/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #11

**æ¥æº**: [CVE-2021-3493-pmihsan_OverlayFS-CVE-2021-3493.md](../2021/CVE-2021-3493-pmihsan_OverlayFS-CVE-2021-3493.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœ¬åœ°ç”¨æˆ·å¯æå‡è‡³ root æƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu kernel versions: < 5.8.0-50.56 (5.8 kernel), < 5.4.0-72.80 (5.4 kernel), < 4.15.0-142.146 (4.15 kernel), < 4.4.0-209.241 (4.4 kernel)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦åœ¨å­˜åœ¨æ¼æ´çš„ Ubuntu ç³»ç»Ÿä¸Šæ‰§è¡Œï¼Œå¹¶ä¸”å…è®¸ unprivileged user namespaces å’Œ overlay mountsã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

CVE-2021-3493 æ¼æ´å­˜åœ¨äº Linux å†…æ ¸çš„ overlayfs å®ç°ä¸­ã€‚ç”±äºå¯¹ç”¨æˆ·å‘½åç©ºé—´ä¸­åº•å±‚æ–‡ä»¶ç³»ç»Ÿæ–‡ä»¶ capabilities çš„éªŒè¯ä¸è¶³ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡åˆ›å»ºæ¶æ„çš„ overlayfs æ–‡ä»¶ç³»ç»Ÿï¼Œåˆ©ç”¨ setxattr è®¾ç½®æ–‡ä»¶ capabilitiesï¼Œä»è€Œè·å¾—æå‡çš„æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** åˆ›å»º overlayfs æ‰€éœ€çš„ç›®å½•ç»“æ„ (lower, upper, work, merge)ã€‚
2.  **Namespace åˆ›å»ºï¼š** åˆ›å»ºæ–°çš„ user namespace å’Œ mount namespaceï¼Œéš”ç¦»æƒé™ã€‚
3.  **æƒé™è®¾ç½®ï¼š** ä¿®æ”¹ uid_map å’Œ gid_mapï¼Œä½¿å¾—åœ¨ user namespace ä¸­æ‹¥æœ‰ root æƒé™ã€‚
4.  **Overlayfs Mountï¼š** ä½¿ç”¨ overlayfs mount å‘½ä»¤å°† lowerdir, upperdir, workdir æŒ‚è½½åˆ° mergedirã€‚
5.  **Capabilities è®¾ç½®ï¼š** å¤åˆ¶è‡ªèº«ç¨‹åºåˆ° merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` å‡½æ•°ä¸ºå¤åˆ¶åçš„ç¨‹åºè®¾ç½® capabilities (CAP_SETUID, CAP_SETGID, CAP_DAC_OVERRIDE ç­‰)ã€‚
6.  **æƒé™æå‡ï¼š** æ‰§è¡Œ merge ç›®å½•ä¸‹çš„ç¨‹åºï¼Œæ­¤æ—¶ç¨‹åºå°†ä»¥ root æƒé™è¿è¡Œã€‚

**æœ‰æ•ˆæ€§ï¼š**

æä¾›çš„ POC ä»£ç é€šè¿‡åˆ©ç”¨ overlayfs æ¼æ´ï¼Œå¯ä»¥æˆåŠŸåœ°æå‡æƒé™ã€‚POC ä»£ç é¦–å…ˆåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼Œç„¶ååˆ›å»ºä¸€ä¸ªæ–°çš„ user namespace å’Œ mount namespaceï¼Œæ¥ç€æŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿï¼Œå¹¶ä½¿ç”¨ `setxattr` å‡½æ•°ä¸ºæ–‡ä»¶è®¾ç½® capabilitiesã€‚æœ€åï¼Œæ‰§è¡Œè¯¥æ–‡ä»¶å³å¯è·å¾— root æƒé™ã€‚

**æŠ•æ¯’é£é™©ï¼š**

åˆ†æ POC ä»£ç ï¼Œæ²¡æœ‰å‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç ï¼Œä¾‹å¦‚åå¼¹ shellã€å®‰è£…åé—¨ç­‰ã€‚ä»£ç é€»è¾‘ä¸»è¦é›†ä¸­åœ¨åˆ©ç”¨ overlayfs æ¼æ´ææƒï¼Œå¹¶æ²¡æœ‰é¢å¤–çš„æ“ä½œæ¥æ¤å…¥æ¶æ„ç¨‹åºã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ï¼Œå¯ä»¥è®¤ä¸ºæ˜¯ 0%ã€‚å‚è€ƒçš„ vulnerability description å’Œ exploit ä»£ç éƒ½ç€é‡äºææƒï¼Œè€Œæ²¡æœ‰æåˆ°ä»»ä½•æŠ•æ¯’è¡Œä¸ºã€‚

**é¡¹ç›®åœ°å€:** [pmihsan/OverlayFS-CVE-2021-3493](https://github.com/pmihsan/OverlayFS-CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #12

**æ¥æº**: [CVE-2021-3493-ptkhai15_OverlayFS---CVE-2021-3493.md](../2021/CVE-2021-3493-ptkhai15_OverlayFS---CVE-2021-3493.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Ubuntu Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœ¬åœ°ç”¨æˆ·æå‡æƒé™è‡³ root

**å½±å“ç‰ˆæœ¬:** Ubuntu kernel versions 5.8, 5.4, 4.15, å’Œ 4.4 ä¸­å—å½±å“çš„ç‰ˆæœ¬ï¼ˆå…·ä½“ç‰ˆæœ¬å‚è§æ¼æ´åº“ä¿¡æ¯ï¼‰

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡ç³»ç»Ÿå¿…é¡»æ˜¯å—å½±å“çš„ Ubuntu ç‰ˆæœ¬ï¼Œå¹¶ä¸”å¯ç”¨äº†éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å’Œéç‰¹æƒ overlayfs æŒ‚è½½ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

CVE-2021-3493 æ˜¯ Ubuntu Linux å†…æ ¸ä¸­ OverlayFS å®ç°ä¸­çš„ä¸€ä¸ªæ¼æ´ã€‚è¯¥æ¼æ´å…è®¸éç‰¹æƒç”¨æˆ·åˆ©ç”¨ç”¨æˆ·å‘½åç©ºé—´å’Œéç‰¹æƒ overlayfs æŒ‚è½½ï¼Œé€šè¿‡ä¸æ­£ç¡®åœ°éªŒè¯åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­æ–‡ä»¶çš„ capabilities è®¾ç½®æ¥æå‡æƒé™ã€‚åˆ©ç”¨æ–¹å¼å¦‚ä¸‹ï¼š

1.  **ç¯å¢ƒå‡†å¤‡ï¼š**  åˆ›å»ºä¸€ä¸ªåŸºç¡€ç›®å½•ç»“æ„ï¼ŒåŒ…æ‹¬ workã€lowerã€upper å’Œ merge ç›®å½•ï¼Œè¿™æ˜¯ overlayfs çš„æ ‡å‡†é…ç½®ã€‚
2.  **åˆ›å»ºç”¨æˆ·å‘½åç©ºé—´ï¼š**  ä½¿ç”¨ `unshare` å‘½ä»¤åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´ã€‚è¿™å…è®¸åœ¨æ–°çš„å‘½åç©ºé—´ä¸­æ‹¥æœ‰ä¸åŒçš„ç”¨æˆ·å’Œç»„ IDã€‚
3.  **é…ç½®ç”¨æˆ·å’Œç»„æ˜ å°„ï¼š**  é€šè¿‡ `/proc/self/setgroups`ã€`/proc/self/uid_map` å’Œ `/proc/self/gid_map` æ–‡ä»¶è®¾ç½®ç”¨æˆ·å’Œç»„ ID æ˜ å°„ï¼Œå°†å½“å‰ç”¨æˆ·çš„ UID å’Œ GID æ˜ å°„åˆ°æ–°å‘½åç©ºé—´ä¸­çš„ root ç”¨æˆ·ã€‚
4.  **æŒ‚è½½ OverlayFSï¼š**  ä½¿ç”¨ `mount` å‘½ä»¤æŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿï¼Œå°† lowerã€upper å’Œ work ç›®å½•å…³è”èµ·æ¥ã€‚
5.  **è®¾ç½®æ–‡ä»¶ capabilitiesï¼š**  å¤åˆ¶å½“å‰æ‰§è¡Œç¨‹åºåˆ° overlayfs çš„ merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½®æ–‡ä»¶çš„ capabilities ä¸º `all+ep`ï¼Œå…è®¸è¯¥æ–‡ä»¶æ‰§è¡Œæ—¶æ‹¥æœ‰ root æƒé™ã€‚
6.  **æ‰§è¡Œææƒåçš„ç¨‹åºï¼š**  æ‰§è¡Œä½äº upper ç›®å½•ä¸­çš„å¤åˆ¶åçš„ç¨‹åºã€‚å¦‚æœç¨‹åºæ£€æµ‹åˆ°è‡ªå·±æ˜¯é€šè¿‡ç‰¹å®šæ–¹å¼ï¼ˆä¾‹å¦‚ï¼ŒåŒ…å« "magic" å­—ç¬¦ä¸²æˆ–æ¥å— "shell" å‚æ•°ï¼‰è°ƒç”¨çš„ï¼Œå®ƒä¼šè°ƒç”¨ `setuid(0)` å’Œ `setgid(0)` å°†è¿›ç¨‹çš„ UID å’Œ GID è®¾ç½®ä¸º 0 (root)ï¼Œå¹¶å¯åŠ¨ä¸€ä¸ª root shellã€‚

**å…³äºæŠ•æ¯’é£é™©ï¼š**

åœ¨æä¾›çš„ POC ä»£ç ä¸­ï¼Œæ²¡æœ‰æ˜æ˜¾çš„æŠ•æ¯’ä»£ç ã€‚POC çš„ç›®çš„æ˜¯æ¼”ç¤ºæ¼æ´åˆ©ç”¨è¿‡ç¨‹ï¼Œæ²¡æœ‰å‘ç°æ¶æ„è¡Œä¸ºï¼Œä¾‹å¦‚åå‘ shell æˆ–å…¶ä»–æœªç»æˆæƒçš„è®¿é—®ã€‚


**é¡¹ç›®åœ°å€:** [ptkhai15/OverlayFS---CVE-2021-3493](https://github.com/ptkhai15/OverlayFS---CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #13

**æ¥æº**: [CVE-2021-3493-puckiestyle_CVE-2021-3493.md](../2021/CVE-2021-3493-puckiestyle_CVE-2021-3493.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ”»å‡»è€…å¯åˆ©ç”¨æ­¤æ¼æ´è·å¾— root æƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu 5.8 kernel (< 5.8.0-50.56), 5.4 kernel (< 5.4.0-72.80), 4.15 kernel (< 4.15.0-142.146), 4.4 kernel (< 4.4.0-209.241)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ Ubuntu ç³»ç»Ÿå¼€å¯ unprivileged user namespaces å’Œå…è®¸ unprivileged overlay mounts

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2021-3493 æ˜¯ Ubuntu å†…æ ¸ overlayfs å®ç°ä¸­çš„ä¸€ä¸ªæ¼æ´ï¼Œå…è®¸æœ¬åœ°æ”»å‡»è€…é€šè¿‡æ»¥ç”¨ user namespaces å’Œ overlayfs æŒ‚è½½æœºåˆ¶æå‡æƒé™ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**
æä¾›çš„ POC ä»£ç å°è¯•åˆ©ç”¨è¯¥æ¼æ´ï¼Œé€šè¿‡åˆ›å»º user namespace å’Œ overlayfs æ–‡ä»¶ç³»ç»Ÿæ¥è®¾ç½®å¯æ‰§è¡Œæ–‡ä»¶çš„ capability ä½ï¼Œä½¿å…¶è·å¾— root æƒé™ã€‚ æ¼æ´åº“ä¿¡æ¯,æœç´¢å¼•æ“ç»“æœå’Œæ¼æ´åˆ©ç”¨ä»£ç ä¸€è‡´,è¡¨æ˜è¯¥æ¼æ´çš„POCæ˜¯çœŸå®æœ‰æ•ˆçš„ã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**
æŸ¥çœ‹ `exploit.c` ä»£ç ï¼Œä¸»è¦æ“ä½œåŒ…æ‹¬åˆ›å»ºç›®å½•ã€è®¾ç½® user namespaceã€æŒ‚è½½ overlayfsã€å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶ã€è®¾ç½® capability å±æ€§ï¼Œä»¥åŠæ‰§è¡Œå¤åˆ¶åçš„æ–‡ä»¶ä»¥è·å¾— root æƒé™ã€‚ä»£ç é€»è¾‘è¾ƒä¸ºæ¸…æ™°ï¼Œæœªå‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç ã€‚`README.md` ä¹Ÿè¯´æ˜äº†å¹¶éä½œè€…åŸåˆ›,åªæ˜¯æ¬è¿,å¢åŠ äº†åˆ†æéš¾åº¦.
`exploit.c`ä¸­å­˜åœ¨`system(buf);` è°ƒç”¨ï¼Œè™½ç„¶è¿™é‡Œæ˜¯ç”¨äºæ¸…ç†ç›®å½•ï¼Œä½†å¦‚æœè¢«ç¯¡æ”¹ï¼Œå¯èƒ½æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£é™©è¯„ä¼°ä¸º10%ã€‚ä¸»è¦çš„é£é™©åœ¨äºï¼š

*   `system()` å‡½æ•°æ½œåœ¨çš„å‘½ä»¤æ³¨å…¥é£é™©ï¼Œå¦‚æœä»£ç è¢«ä¿®æ”¹ï¼Œå¯èƒ½å¯¼è‡´æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  åˆ©ç”¨ unshare() åˆ›å»ºä¸€ä¸ªæ–°çš„ user namespace å’Œ mount namespaceã€‚
2.  é…ç½® user namespace çš„ uid_map å’Œ gid_mapï¼Œå°†å½“å‰ç”¨æˆ·æ˜ å°„ä¸º root ç”¨æˆ·ã€‚
3.  åˆ›å»º overlayfs æ‰€éœ€çš„ç›®å½•ç»“æ„ï¼ˆlowerdirã€upperdirã€workdirã€mergedï¼‰ã€‚
4.  æŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿã€‚
5.  å°†æ¼æ´åˆ©ç”¨ç¨‹åºè‡ªèº«å¤åˆ¶åˆ° overlayfs çš„ upperdir/merged ç›®å½•ã€‚
6.  ä½¿ç”¨ setxattr() è®¾ç½®å¤åˆ¶åçš„å¯æ‰§è¡Œæ–‡ä»¶çš„ security.capability å±æ€§ï¼Œèµ‹äºˆå…¶ CAP_SETUID å’Œ CAP_SETGID æƒé™ã€‚
7.  æ‰§è¡Œå¤åˆ¶åçš„ç¨‹åºï¼Œç”±äºè®¾ç½®äº† capabilityï¼Œè¯¥ç¨‹åºä¼šä»¥ root æƒé™è¿è¡Œï¼Œä»è€Œè·å¾— root shellã€‚

**é¡¹ç›®åœ°å€:** [puckiestyle/CVE-2021-3493](https://github.com/puckiestyle/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #14

**æ¥æº**: [CVE-2021-3493-smallkill_CVE-2021-3493.md](../2021/CVE-2021-3493-smallkill_CVE-2021-3493.md)

# CVE-2021-3493

> ğŸ“¦ è¯¥CVEæœ‰ **15** ä¸ªç›¸å…³POCä»“åº“

---

## POC #1

**æ¥æº**: [CVE-2021-3493-Abdennour-py_CVE-2021-3493.md](../2021/CVE-2021-3493-Abdennour-py_CVE-2021-3493.md)

## CVE-2021-3493 Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å¯¼è‡´æ™®é€šç”¨æˆ·æå‡ä¸ºrootæƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu 5.8 kernel < 5.8.0-50.56, 5.4 kernel < 5.4.0-72.80, 4.15 kernel < 4.15.0-142.146, 4.4 kernel < 4.4.0-209.241

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç›®æ ‡ç³»ç»Ÿè¿è¡Œå—å½±å“çš„Ubuntuå†…æ ¸ï¼Œå¹¶ä¸”å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿå’Œä½¿ç”¨user namespace

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

è¯¥æ¼æ´æºäºUbuntuå†…æ ¸ä¸­overlayfså®ç°å¯¹ç”¨æˆ·å‘½åç©ºé—´ä¸­çš„æ–‡ä»¶èƒ½åŠ›éªŒè¯ä¸å½“ã€‚ç»“åˆéç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å’ŒUbuntuå†…æ ¸ä¸­çš„å…è®¸éç‰¹æƒ overlayfs æŒ‚è½½çš„è¡¥ä¸ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´è·å¾—æå‡çš„æƒé™ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**

æä¾›çš„POCä»£ç çœ‹èµ·æ¥æ˜¯æœ‰æ•ˆçš„ã€‚å®ƒåˆ©ç”¨äº† overlayfs å’Œ user namespace çš„ç»„åˆæ¥è®¾ç½®æ–‡ä»¶ capabilityï¼Œä»è€Œå®ç°ææƒã€‚ä»£ç é¦–å…ˆåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼ˆlower, upper, work, mergeï¼‰ï¼Œç„¶åä½¿ç”¨ `unshare` åˆ›å»ºä¸€ä¸ªæ–°çš„ user namespace å’Œ mount namespaceã€‚æ¥ç€ï¼Œå®ƒå†™å…¥ `/proc/self/setgroups`, `/proc/self/uid_map`, å’Œ `/proc/self/gid_map` æ¥è®¾ç½®ç”¨æˆ·å’Œç»„çš„æ˜ å°„ã€‚ç„¶åï¼ŒæŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿï¼Œæ‹·è´è‡ªèº«å¯æ‰§è¡Œæ–‡ä»¶åˆ° overlayfs çš„ merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½® capabilitiesã€‚æœ€åï¼Œå®ƒæ‰§è¡Œä½äº upper ç›®å½•çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶ä¼šå°è¯•ä»¥ root æƒé™æ‰§è¡Œ /bin/bashã€‚

æ ¹æ®æ¼æ´åº“ä¿¡æ¯ï¼ŒCISA å°†æ­¤æ¼æ´æ·»åŠ åˆ°å·²çŸ¥è¢«åˆ©ç”¨çš„æ¼æ´åˆ—è¡¨ä¸­ï¼Œè¿›ä¸€æ­¥è¡¨æ˜äº†è¯¥æ¼æ´çš„æœ‰æ•ˆæ€§ã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

æ£€æŸ¥æä¾›çš„ exploit.c ä»£ç ï¼Œæ²¡æœ‰å‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç æˆ–åé—¨ã€‚ä»£ç é€»è¾‘æ¸…æ™°ï¼Œä¸»è¦æ‰§è¡Œäº† overlayfs çš„æŒ‚è½½ï¼Œæ–‡ä»¶å¤åˆ¶ï¼Œè®¾ç½® xattr å’Œæ‰§è¡Œ shell æ“ä½œã€‚ä»£ç çš„æ„å›¾ä¸æ¼æ´æè¿°ä¸€è‡´ï¼Œæ²¡æœ‰å‘ç°éšè—çš„ã€ä¸æ¼æ´åˆ©ç”¨æ— å…³çš„æ¶æ„è¡Œä¸ºã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£é™©ä¸º 0%ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š**  åœ¨å­˜åœ¨æ¼æ´çš„Ubuntuç³»ç»Ÿä¸Šï¼Œåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ (ovlcap/work, ovlcap/lower, ovlcap/upper, ovlcap/merge)ã€‚
2.  **User Namespaceå’ŒMount Namespaceï¼š** ä½¿ç”¨ `unshare` ç³»ç»Ÿè°ƒç”¨åˆ›å»ºæ–°çš„ user namespace å’Œ mount namespaceã€‚
3.  **IDæ˜ å°„ï¼š**  é…ç½® `/proc/self/setgroups`ï¼Œ`/proc/self/uid_map` å’Œ `/proc/self/gid_map`ï¼Œä»¥ä¾¿åœ¨ user namespace ä¸­è·å¾—æœ‰æ•ˆçš„ç”¨æˆ· ID å’Œç»„ IDã€‚
4.  **OverlayFSæŒ‚è½½ï¼š**  ä½¿ç”¨ `mount` ç³»ç»Ÿè°ƒç”¨æŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿï¼Œå°† lower, upper å’Œ work ç›®å½•å…³è”èµ·æ¥ã€‚
5.  **æ–‡ä»¶æ‹·è´ä¸ Capability è®¾ç½®ï¼š**  å°† exploit ç¨‹åºè‡ªèº«æ‹·è´åˆ° overlayfs çš„ merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½® `security.capability` å±æ€§ï¼Œèµ‹äºˆå…¶ CAP_SETUID å’Œ CAP_SETGID ç­‰æƒé™ã€‚
6.  **ææƒæ‰§è¡Œï¼š** æ‰§è¡Œä½äº upper ç›®å½•çš„ exploit ç¨‹åºçš„æ‹·è´ã€‚ç”±äºè¯¥æ–‡ä»¶å…·æœ‰ capabilitiesï¼Œå› æ­¤å¯ä»¥ä»¥ root æƒé™æ‰§è¡Œ shellã€‚

**é¡¹ç›®åœ°å€:** [Abdennour-py/CVE-2021-3493](https://github.com/Abdennour-py/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #2

**æ¥æº**: [CVE-2021-3493-Sornphut_OverlayFS---CVE-2021-3493.md](../2021/CVE-2021-3493-Sornphut_OverlayFS---CVE-2021-3493.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒæ¼æ´

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Ubuntu Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœ¬åœ°ç”¨æˆ·è·å¾— root æƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu kernels before 5.8.0-50.56, 5.4.0-72.80, 4.15.0-142.146, and 4.4.0-209.241

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦è¿è¡Œåœ¨å­˜åœ¨æ¼æ´çš„ Ubuntu å†…æ ¸ä¸Šï¼Œå¹¶ä¸”å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½ overlayfsã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

è¯¥æ¼æ´å­˜åœ¨äº Ubuntu Linux å†…æ ¸çš„ overlayfs å®ç°ä¸­ã€‚ç”±äº Ubuntu å¯¹ overlayfs æŒ‚è½½çš„ç‰¹å®šä¿®æ”¹ï¼Œå¯¼è‡´åœ¨ç”¨æˆ·å‘½åç©ºé—´å†…ï¼Œå¯¹åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­çš„æ–‡ä»¶ capabilities éªŒè¯ä¸å……åˆ†ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡ overlayfs æŒ‚è½½ç»•è¿‡ capabilities æ£€æŸ¥ï¼Œè®¾ç½®æ–‡ä»¶ capabilities æå‡æƒé™ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  åˆ›å»ºä¸€ä¸ªç›®å½•ç»“æ„ï¼ŒåŒ…æ‹¬ lower, upper, work å’Œ merge ç›®å½•ã€‚
2.  ä½¿ç”¨ `unshare` åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´å’ŒæŒ‚è½½å‘½åç©ºé—´ã€‚
3.  é…ç½® `/proc/self/setgroups`, `/proc/self/uid_map`, å’Œ `/proc/self/gid_map` ä»¥æ˜ å°„ç”¨æˆ· ID å’Œç»„ IDã€‚
4.  ä½¿ç”¨ `mount` å‘½ä»¤æŒ‚è½½ overlayfsï¼Œå°† lower, upper å’Œ work ç›®å½•ä¸ merge ç›®å½•å…³è”èµ·æ¥ã€‚
5.  åœ¨ upper ç›®å½•æˆ– merge ç›®å½•ä¸‹åˆ›å»ºæˆ–å¤åˆ¶ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ã€‚
6.  ä½¿ç”¨ `setxattr` è®¾ç½®å¯æ‰§è¡Œæ–‡ä»¶çš„ capabilitiesï¼Œèµ‹äºˆå…¶ root æƒé™ã€‚
7.  æ‰§è¡Œè¯¥æ–‡ä»¶ï¼Œå³å¯è·å¾— root æƒé™ã€‚

**æœ‰æ•ˆæ€§ï¼š**

æä¾›çš„ POC ä»£ç å°è¯•åˆ©ç”¨ CVE-2021-3493 æ¼æ´ã€‚è¯¥ä»£ç åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´å’ŒæŒ‚è½½å‘½åç©ºé—´ï¼Œå¹¶å°è¯•æŒ‚è½½ overlayfsã€‚ç„¶åï¼Œå®ƒåº”è¯¥è®¾ç½® `magic` äºŒè¿›åˆ¶æ–‡ä»¶çš„ capabilitiesï¼Œä»è€Œè·å¾— root æƒé™ã€‚æ ¹æ®æ¼æ´æè¿°ï¼Œè¯¥ POC åº”è¯¥èƒ½å¤Ÿæœ‰æ•ˆåˆ©ç”¨è¯¥æ¼æ´ã€‚

**æŠ•æ¯’é£é™©ï¼š**

æ£€æŸ¥æä¾›çš„ exploit.c æ–‡ä»¶ï¼Œæœªå‘ç°æ˜æ˜¾çš„æ¶æ„æˆ–éšè—ä»£ç ã€‚ä»£ç é€»è¾‘ä¸»è¦é›†ä¸­äºè®¾ç½® overlayfs æŒ‚è½½å’Œæ–‡ä»¶ capabilitiesã€‚ä½†æ˜¯ï¼Œéœ€è¦å§‹ç»ˆè°¨æ…å¯¹å¾…æ¥è‡ªä¸å—ä¿¡ä»»æ¥æºçš„ä»£ç ã€‚ä¸ºäº†ç¡®ä¿å®‰å…¨ï¼Œå»ºè®®åœ¨å—æ§ç¯å¢ƒä¸­ä»”ç»†å®¡æŸ¥å’Œæµ‹è¯•ä»£ç ã€‚


**é¡¹ç›®åœ°å€:** [Sornphut/OverlayFS---CVE-2021-3493](https://github.com/Sornphut/OverlayFS---CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #3

**æ¥æº**: [CVE-2021-3493-briskets_CVE-2021-3493.md](../2021/CVE-2021-3493-briskets_CVE-2021-3493.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å¯¼è‡´æ™®é€šç”¨æˆ·æƒé™æå‡è‡³rootæƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu kernel versions: < 5.8.0-50.56 (5.8 kernel), < 5.4.0-72.80 (5.4 kernel), < 4.15.0-142.146 (4.15 kernel), < 4.4.0-209.241 (4.4 kernel)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦åœ¨å­˜åœ¨æ¼æ´çš„Ubuntuå†…æ ¸ç‰ˆæœ¬ä¸Šï¼Œå¹¶ä¸”å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½overlayfs

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 5%

## è¯¦æƒ…

CVE-2021-3493 æ¼æ´æ˜¯ç”±äº Linux å†…æ ¸çš„ overlayfs å®ç°æ²¡æœ‰æ­£ç¡®éªŒè¯ç”¨æˆ·å‘½åç©ºé—´ä¸­åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸Šæ–‡ä»¶ capabilities çš„è®¾ç½®ã€‚ç”±äº Ubuntu å†…æ ¸ä¸­å­˜åœ¨å…è®¸éç‰¹æƒ overlay æŒ‚è½½çš„è¡¥ä¸ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´è·å¾—æå‡çš„æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  æ¼æ´åˆ©ç”¨ä»£ç é¦–å…ˆåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ (ovlcap/work, ovlcap/lower, ovlcap/upper, ovlcap/merge)ã€‚
2.  åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´å’ŒæŒ‚è½½å‘½åç©ºé—´ã€‚
3.  åœ¨æ–°çš„ç”¨æˆ·å‘½åç©ºé—´ä¸­ï¼Œå°†å½“å‰ç”¨æˆ·çš„ UID å’Œ GID æ˜ å°„åˆ° root ç”¨æˆ·ã€‚
4.  ä½¿ç”¨ overlayfs å°† lowerdir (ovlcap/lower), upperdir (ovlcap/upper) å’Œ workdir (ovlcap/work) æŒ‚è½½åˆ° mergedir (ovlcap/merge)ã€‚
5.  å¤åˆ¶è‡ªèº« (exploit ç¨‹åº) åˆ° mergedir/magicï¼Œå¹¶è®¾ç½® security.capability æ‰©å±•å±æ€§ä¸º all+epï¼Œèµ‹äºˆè¯¥æ–‡ä»¶ capabilitiesã€‚
6.  æ‰§è¡Œ mergedir/magicï¼Œç”±äº capabilities çš„è®¾ç½®ï¼Œè¯¥ç¨‹åºä¼šä»¥ root æƒé™æ‰§è¡Œã€‚
7.  æœ€åï¼Œæ‰§è¡Œ upperdir/magicï¼Œå¯åŠ¨ä¸€ä¸ª root shellã€‚

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„POCä»£ç æ˜¯æœ‰æ•ˆçš„ï¼Œèƒ½å¤Ÿåˆ©ç”¨ CVE-2021-3493 æ¼æ´åœ¨å—å½±å“çš„ Ubuntu ç³»ç»Ÿä¸Šå®ç°æœ¬åœ°ææƒã€‚

**æŠ•æ¯’é£é™©ï¼š**
è¯¥POCä»£ç çš„ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´è¿›è¡Œææƒï¼Œä½†ä»ç„¶å­˜åœ¨æ½œåœ¨çš„æŠ•æ¯’é£é™©ã€‚æ¯”å¦‚ä½œè€…å¯èƒ½åœ¨ç¼–è¯‘å’Œè¿è¡Œå‰æ·»åŠ ä¸€äº›æ¶æ„ä»£ç ï¼Œä¾‹å¦‚ï¼š

1.  **åé—¨æ¤å…¥ï¼š** åœ¨ææƒæˆåŠŸåï¼Œæ¤å…¥ä¸€ä¸ªåé—¨ç¨‹åºï¼Œå…è®¸æ”»å‡»è€…è¿œç¨‹è®¿é—®ç³»ç»Ÿã€‚
2.  **æ•°æ®çªƒå–ï¼š** åœ¨ææƒè¿‡ç¨‹ä¸­ï¼Œçªƒå–ç”¨æˆ·çš„æ•æ„Ÿæ•°æ®ã€‚
3.  **ç ´åç³»ç»Ÿï¼š** åœ¨ææƒå¤±è´¥æˆ–è€…æˆåŠŸåï¼Œç ´åç³»ç»Ÿæ–‡ä»¶æˆ–è€…é…ç½®ã€‚

è€ƒè™‘åˆ°ä»£ç ç›¸å¯¹ç®€çŸ­ä¸”åŠŸèƒ½æ˜ç¡®ï¼Œè¯„ä¼°æŠ•æ¯’é£é™©ä¸º5%ã€‚ç”¨æˆ·éœ€è¦ä»”ç»†å®¡æŸ¥ä»£ç ï¼Œå¹¶åœ¨å®‰å…¨çš„ç¯å¢ƒä¸­è¿›è¡Œæµ‹è¯•ã€‚

**é¡¹ç›®åœ°å€:** [briskets/CVE-2021-3493](https://github.com/briskets/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #4

**æ¥æº**: [CVE-2021-3493-cyberx-1_OverlayFS-CVE-2021-3493.md](../2021/CVE-2021-3493-cyberx-1_OverlayFS-CVE-2021-3493.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯ä»æ™®é€šç”¨æˆ·ææƒè‡³root

**å½±å“ç‰ˆæœ¬:** Ubuntu kernels: 5.8.0-50.56 (5.8 kernel), 5.4.0-72.80 (5.4 kernel), 4.15.0-142.146 (4.15 kernel), 4.4.0-209.241 (4.4 kernel)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦è¿è¡Œåœ¨å­˜åœ¨æ¼æ´çš„Ubuntuå†…æ ¸ç‰ˆæœ¬ä¸Šï¼Œå¯ç”¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å’Œå…è®¸éç‰¹æƒ overlay mountsã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2021-3493æ˜¯Ubuntuå†…æ ¸OverlayFSå®ç°ä¸­çš„ä¸€ä¸ªæƒé™æå‡æ¼æ´ã€‚ç”±äºoverlayfsåœ¨ç”¨æˆ·å‘½åç©ºé—´ä¸­æ²¡æœ‰æ­£ç¡®éªŒè¯åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­æ–‡ä»¶åŠŸèƒ½è®¾ç½®ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å’ŒUbuntuå†…æ ¸ä¸­çš„éç‰¹æƒoverlayæŒ‚è½½è¡¥ä¸ï¼Œè·å–æå‡çš„æƒé™ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** åœ¨å­˜åœ¨æ¼æ´çš„Ubuntuå†…æ ¸ä¸Šï¼Œç¡®ä¿å¯ç”¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´ã€‚æ¼æ´åº“ä¿¡æ¯æåˆ°ç¦ç”¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å¯ä»¥ä½œä¸ºç¼“è§£æªæ–½ï¼Œæ‰€ä»¥è¦ç¡®ä¿å¯ç”¨ã€‚
2.  **åˆ›å»ºOverlayFSç»“æ„ï¼š** PoCä»£ç é¦–å…ˆåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼ˆlower, upper, work, mergeï¼‰ç”¨äº overlayfs æ–‡ä»¶ç³»ç»Ÿã€‚
3.  **åˆ›å»ºç”¨æˆ·å‘½åç©ºé—´ï¼š** ä½¿ç”¨`unshare`ç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´ã€‚è¿™å…è®¸åœ¨æ–°çš„å‘½åç©ºé—´ä¸­æ‹¥æœ‰ä¸åŒçš„ç”¨æˆ·IDå’Œç»„IDæ˜ å°„ã€‚
4.  **è®¾ç½®UID/GIDæ˜ å°„ï¼š** å°†å½“å‰ç”¨æˆ·çš„UIDå’ŒGIDæ˜ å°„åˆ°æ–°å‘½åç©ºé—´ä¸­çš„rootç”¨æˆ· (UID 0 å’Œ GID 0)ã€‚
5.  **æŒ‚è½½OverlayFSï¼š** ä½¿ç”¨`mount`ç³»ç»Ÿè°ƒç”¨å°† overlayfs æ–‡ä»¶ç³»ç»ŸæŒ‚è½½åˆ° merge ç›®å½•ã€‚æŒ‡å®š lowerdir, upperdir å’Œ workdirã€‚
6.  **å¤åˆ¶è‡ªèº«å¹¶è®¾ç½®Capabilitiesï¼š** å°†è‡ªèº«å¯æ‰§è¡Œæ–‡ä»¶å¤åˆ¶åˆ° overlayfs çš„ merge ç›®å½•ï¼Œç„¶åä½¿ç”¨`setxattr`è®¾ç½®`security.capability`æ‰©å±•å±æ€§ï¼Œèµ‹äºˆè¯¥æ–‡ä»¶ root æƒé™ã€‚
7.  **æ‰§è¡Œææƒåçš„ç¨‹åºï¼š** é€šè¿‡æ‰§è¡Œ upper ç›®å½•ä¸‹çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆä¹‹å‰å¤åˆ¶å¹¶è®¾ç½®äº† capabilities çš„æ–‡ä»¶ï¼‰æ¥è·å– root æƒé™ã€‚è¿™ä¸ªç¨‹åºä¼šæ£€æŸ¥æ˜¯å¦æœ‰"shell"å‚æ•°ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™ä¼šé‡æ–°æ‰§è¡Œè‡ªèº«ï¼Œä½†è¿™æ¬¡ä¼šå¸¦æœ‰`shell`å‚æ•°ï¼Œä»è€Œè§¦å‘`setuid(0)`å’Œ`setgid(0)`ï¼Œæœ€ç»ˆæ‰§è¡Œ`/bin/bash`ï¼Œè·å¾— root shellã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

ä»£ç ä¸­å­˜åœ¨ä¸€å®šçš„æŠ•æ¯’é£é™©ï¼Œè™½ç„¶ä¸»è¦é€»è¾‘æ˜¯åˆ©ç”¨æ¼æ´è¿›è¡Œææƒï¼Œä½†å­˜åœ¨ä¿®æ”¹`/bin/bash`çš„å¯èƒ½æ€§ï¼Œä½†æ˜¯ç»è¿‡ä»£ç åˆ†æä»¥åŠæ¼æ´åŸç†ï¼Œåˆ¤æ–­æ¼æ´åˆ©ç”¨è¿‡ç¨‹ä¸­æ²¡æœ‰ä¿®æ”¹`/bin/bash`æ“ä½œ,ä»£ç ä¸­é£é™©ä¸»è¦å­˜åœ¨äºä»¥ä¸‹å‡ ç‚¹:

1.  **ä¾èµ–å¤–éƒ¨äºŒè¿›åˆ¶æ–‡ä»¶ï¼š** è¯¥æ¼æ´åˆ©ç”¨ä¾èµ–äºç³»ç»Ÿä¸Šçš„`/bin/bash`ã€‚å¦‚æœæ”»å‡»è€…æ›¿æ¢æˆ–ç¯¡æ”¹äº†ç›®æ ‡ç³»ç»Ÿä¸Šçš„`/bin/bash`ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ„å¤–çš„è¡Œä¸ºæˆ–å®‰å…¨é—®é¢˜ã€‚
2.  **æ¸…ç†æ“ä½œé£é™©ï¼š** ä»£ç å¼€å§‹æ—¶ä½¿ç”¨`system(buf)`æ‰§è¡Œ`rm -rf '%s/'`ï¼Œå¦‚æœ`DIR_BASE`è¢«æ¶æ„ä¿®æ”¹ï¼Œå¯èƒ½å¯¼è‡´æ„å¤–çš„æ–‡ä»¶åˆ é™¤ã€‚
3.  **ä¸å®Œå–„çš„é”™è¯¯å¤„ç†ï¼š** è™½ç„¶ PoC ä»£ç åŒ…å«äº†ä¸€äº›é”™è¯¯å¤„ç†ï¼Œä½†åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå¦‚æœé”™è¯¯å¤„ç†ä¸å½“ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ‹’ç»æœåŠ¡æˆ–æœªå®šä¹‰çš„è¡Œä¸ºã€‚

æ€»ä½“è€Œè¨€ï¼Œè¯¥ PoC ä»£ç çš„æŠ•æ¯’é£é™©è¾ƒä½ï¼Œä¸»è¦é£é™©åœ¨äºä¾èµ–å¤–éƒ¨äºŒè¿›åˆ¶æ–‡ä»¶å’Œæ½œåœ¨çš„æ¸…ç†æ“ä½œé£é™©ã€‚ä»£ç æœ¬èº«ä¸»è¦æ˜¯ä¸ºäº†æ¼”ç¤ºæ¼æ´åˆ©ç”¨ï¼Œå¹¶æœªå‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç ã€‚ è¯„ä¼°æŠ•æ¯’é£é™©ä¸º10%ã€‚


**é¡¹ç›®åœ°å€:** [cyberx-1/OverlayFS-CVE-2021-3493](https://github.com/cyberx-1/OverlayFS-CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #5

**æ¥æº**: [CVE-2021-3493-derek-turing_CVE-2021-3493.md](../2021/CVE-2021-3493-derek-turing_CVE-2021-3493.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Ubuntu Linux Kernel

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœ¬åœ°ç”¨æˆ·å¯æå‡è‡³ root æƒé™

**å½±å“ç‰ˆæœ¬:** 4.4 <= kernel < 4.4.0-209.241, 4.15 <= kernel < 4.15.0-142.146, 5.4 <= kernel < 5.4.0-72.80, 5.8 <= kernel < 5.8.0-50.56

**åˆ©ç”¨æ¡ä»¶:** Ubuntu å†…æ ¸å¼€å¯äº† unprivileged user namespaces å’Œ unprivileged overlay mounts

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

è¯¥æ¼æ´å­˜åœ¨äº Ubuntu Linux å†…æ ¸çš„ OverlayFS å®ç°ä¸­ï¼Œç”±äº overlayfs å¯¹åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­æ–‡ä»¶ capabilities çš„è®¾ç½®éªŒè¯ä¸å½“ï¼Œç»“åˆæœªæˆæƒç”¨æˆ·å‘½åç©ºé—´å’Œ Ubuntu å†…æ ¸ä¸­å…è®¸æœªæˆæƒ overlay æŒ‚è½½çš„è¡¥ä¸ï¼Œæ”»å‡»è€…å¯åˆ©ç”¨æ­¤æ¼æ´æå‡æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** é¦–å…ˆï¼Œç¡®ä¿ç›®æ ‡ç³»ç»Ÿæ»¡è¶³æ¼æ´åˆ©ç”¨çš„æ¡ä»¶ï¼Œå³ Ubuntu å†…æ ¸ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…ï¼Œå¹¶ä¸”å¯ç”¨äº† unprivileged user namespaces å’Œ unprivileged overlay mountsã€‚æ¼æ´åº“ä¿¡æ¯ä¸­ç»™å‡ºäº†å—å½±å“çš„ç‰ˆæœ¬èŒƒå›´ã€‚
2.  **åˆ›å»ºç›®å½•ç»“æ„ï¼š** åˆ›å»º overlayfs æ‰€éœ€çš„ç›®å½•ç»“æ„ï¼ŒåŒ…æ‹¬ lowerdirï¼ˆåº•å±‚ç›®å½•ï¼‰ã€upperdirï¼ˆä¸Šå±‚ç›®å½•ï¼‰ã€workdirï¼ˆå·¥ä½œç›®å½•ï¼‰å’Œ mergedirï¼ˆåˆå¹¶ç›®å½•ï¼‰ã€‚
3.  **åˆ›å»ºç”¨æˆ·å‘½åç©ºé—´ï¼š** ä½¿ç”¨ `unshare` å‘½ä»¤åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´ï¼Œè¿™å…è®¸åœ¨éç‰¹æƒç”¨æˆ·ä¸‹æ‰§è¡Œä¸€äº›ç‰¹æƒæ“ä½œã€‚
4.  **è®¾ç½® UID/GID æ˜ å°„ï¼š** åœ¨ç”¨æˆ·å‘½åç©ºé—´ä¸­ï¼Œå°†å½“å‰ç”¨æˆ·çš„ UID å’Œ GID æ˜ å°„åˆ° root ç”¨æˆ· (UID 0) å’Œ root ç»„ (GID 0)ï¼Œè¿™æ ·åœ¨ overlayfs ä¸­åˆ›å»ºçš„æ–‡ä»¶å°†å±äº root ç”¨æˆ·ã€‚
5.  **æŒ‚è½½ OverlayFSï¼š** ä½¿ç”¨ `mount` å‘½ä»¤å°† overlayfs æŒ‚è½½åˆ° mergedirï¼ŒæŒ‡å®š lowerdirã€upperdir å’Œ workdirã€‚
6.  **å¤åˆ¶å¹¶è®¾ç½® Capabilitiesï¼š** å°† exploit ç¨‹åºè‡ªèº«å¤åˆ¶åˆ° mergedir ä¸­ï¼Œå¹¶ä½¿ç”¨ `setxattr` å‘½ä»¤è®¾ç½®å…¶ security.capability æ‰©å±•å±æ€§ï¼Œèµ‹äºˆå…¶ CAP_SETUID å’Œ CAP_SETGID capabilitiesã€‚è¿™ä¸ªcapabilitieså…è®¸ç¨‹åºåœ¨æ²¡æœ‰rootæƒé™çš„æƒ…å†µä¸‹è®¾ç½®uidå’Œgidã€‚
7.  **è§¦å‘ææƒï¼š** è¿è¡Œ mergedir ä¸­çš„ exploit ç¨‹åºï¼Œç”±äºå·²è®¾ç½® capabilitiesï¼Œç¨‹åºå°†ä»¥ root æƒé™è¿è¡Œï¼Œä»è€Œæ‰§è¡Œç‰¹æƒæ“ä½œã€‚

**ä»£ç åˆ†æï¼š**

*   `exploit.c` æ˜¯åˆ©ç”¨ä»£ç ï¼Œå®ƒåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼Œå»ºç«‹ç”¨æˆ·å‘½åç©ºé—´ï¼ŒæŒ‚è½½ overlayfsï¼Œç„¶åå°†è‡ªèº«å¤åˆ¶åˆ° overlayfs ä¸­ï¼Œå¹¶è®¾ç½® capabilitiesã€‚æœ€åï¼Œæ‰§è¡Œå¤åˆ¶åˆ° upperdir ä¸­çš„ç¨‹åºï¼Œè¯¥ç¨‹åºä¼šå°†å½“å‰è¿›ç¨‹ææƒä¸º rootã€‚
*   ä»£ç ä¸­ä½¿ç”¨äº† `setxattr` å‡½æ•°æ¥è®¾ç½®æ–‡ä»¶ capabilitiesï¼Œè¿™æ˜¯åˆ©ç”¨æ¼æ´çš„å…³é”®æ­¥éª¤ã€‚
*   mainå‡½æ•°é¦–å…ˆforkä¸€ä¸ªå­è¿›ç¨‹æ‰§è¡Œexploitå‡½æ•°ï¼Œåœ¨exploitå‡½æ•°æ‰§è¡Œå®Œæ¯•åï¼Œçˆ¶è¿›ç¨‹æ‰§è¡ŒBIN_UPPERä¸­çš„magicç¨‹åºï¼Œå¦‚æœå¸¦æœ‰shellå‚æ•°ï¼Œmagicç¨‹åºä¼šè®¾ç½®uidå’Œgidä¸º0ï¼Œå¹¶ä¸”è¿è¡Œä¸€ä¸ªbash shellã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

ä»”ç»†æ£€æŸ¥äº† POC ä»£ç ï¼Œæ²¡æœ‰å‘ç°æ˜æ˜¾çš„æŠ•æ¯’ä»£ç ã€‚ä»£ç é€»è¾‘æ¸…æ™°ï¼Œä¸»è¦ç”¨äºåˆ›å»º overlayfs ç¯å¢ƒå¹¶è®¾ç½®æ–‡ä»¶ capabilities ä»¥è¿›è¡Œææƒã€‚ä½œè€…å¹¶æ²¡æœ‰å°è¯•åœ¨ä»£ç ä¸­éšè—æ¶æ„è¡Œä¸ºï¼Œä¾‹å¦‚ï¼š

*   è¿æ¥å¤–éƒ¨æœåŠ¡å™¨
*   ä¿®æ”¹ç³»ç»Ÿæ–‡ä»¶
*   å®‰è£…åé—¨
*   æ”¶é›†ç”¨æˆ·ä¿¡æ¯

å› æ­¤ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ (0%)ã€‚

**é¡¹ç›®åœ°å€:** [derek-turing/CVE-2021-3493](https://github.com/derek-turing/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #6

**æ¥æº**: [CVE-2021-3493-fathallah17_OverlayFS-CVE-2021-3493.md](../2021/CVE-2021-3493-fathallah17_OverlayFS-CVE-2021-3493.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°æƒé™æå‡

**å½±å“åº”ç”¨:** Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å¯¼è‡´æœ¬åœ°æƒé™æå‡è‡³root

**å½±å“ç‰ˆæœ¬:** 4.4 <= Linux Kernel < 5.8.0-50.56 (Ubuntu ç‰¹å®šç‰ˆæœ¬)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦å­˜åœ¨Ubuntuå†…æ ¸ä¸­å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½OverlayFSçš„è¡¥ä¸ï¼Œä¸”ç”¨æˆ·å‘½åç©ºé—´æœªè¢«ç¦ç”¨ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 1%

## è¯¦æƒ…

CVE-2021-3493 æ˜¯ä¸€ä¸ªå­˜åœ¨äº Linux å†…æ ¸ OverlayFS å®ç°ä¸­çš„æƒé™æå‡æ¼æ´ã€‚æ¼æ´çš„æ ¹æœ¬åŸå› æ˜¯ OverlayFS åœ¨è®¾ç½®åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­æ–‡ä»¶çš„ capabilities æ—¶ï¼Œæ²¡æœ‰æ­£ç¡®åœ°éªŒè¯ç”¨æˆ·å‘½åç©ºé—´ã€‚åœ¨å­˜åœ¨å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½ OverlayFS çš„ Ubuntu å†…æ ¸è¡¥ä¸çš„ç¯å¢ƒä¸­ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´è·å¾—æå‡çš„æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š**  ç›®æ ‡ç³»ç»Ÿéœ€è¦æ˜¯å—å½±å“çš„ Ubuntu ç‰ˆæœ¬ï¼Œå¹¶ä¸”å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½ OverlayFSï¼ŒåŒæ—¶ç”¨æˆ·å‘½åç©ºé—´æ²¡æœ‰è¢«ç¦ç”¨ã€‚
2.  **è·å–æ¼æ´åˆ©ç”¨ä»£ç ï¼š**  ä»å¯ä¿¡æ¥æºè·å–æ¼æ´åˆ©ç”¨ä»£ç  (ä¾‹å¦‚ SSD-Disclosure æä¾›çš„ exploit.c)ã€‚
3.  **ç¼–è¯‘æ¼æ´åˆ©ç”¨ä»£ç ï¼š**  ä½¿ç”¨ gcc ç­‰ç¼–è¯‘å™¨å°† exploit.c ç¼–è¯‘ä¸ºå¯æ‰§è¡Œæ–‡ä»¶ã€‚
4.  **æ‰§è¡Œæ¼æ´åˆ©ç”¨ä»£ç ï¼š**  è¿è¡Œç¼–è¯‘åçš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚æ¼æ´åˆ©ç”¨ä»£ç ä¼šåˆ©ç”¨ OverlayFS çš„æ¼æ´ï¼Œé€šè¿‡è®¾ç½®æ–‡ä»¶ capabilities æ¥æå‡å½“å‰ç”¨æˆ·çš„æƒé™è‡³ rootã€‚
5.  **è·å– root æƒé™ï¼š**  æˆåŠŸæ‰§è¡Œæ¼æ´åˆ©ç”¨ä»£ç åï¼Œç”¨æˆ·å°†è·å¾— root æƒé™ã€‚

**å…³äºæŠ•æ¯’é£é™©ï¼š**

æä¾›çš„POCä»£ç åªæ˜¯ä¸€ä¸ªç®€å•çš„åˆ©ç”¨æ–¹å¼,ä¸å¤ªå¯èƒ½åŒ…å«æ¶æ„ä»£ç ã€‚ä½†å§‹ç»ˆéœ€è¦å¯¹ä»»ä½•æ¥æºçš„æ¼æ´åˆ©ç”¨ä»£ç è¿›è¡Œå®¡æŸ¥ï¼Œä»¥é™ä½é£é™©ã€‚
å¯¹ä¸‹è½½çš„æ–‡ä»¶è¿›è¡Œæ£€æŸ¥ï¼Œå¦‚å“ˆå¸Œæ ¡éªŒï¼Œå¯ä»¥æœ€å¤§ç¨‹åº¦çš„é¿å…å¼•å…¥æ¶æ„ä»£ç ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**

æ ¹æ®æ¼æ´æè¿°å’Œåˆ©ç”¨ä»£ç ï¼Œè¯¥æ¼æ´åˆ©ç”¨æ˜¯æœ‰æ•ˆçš„ã€‚åˆ©ç”¨ä»£ç é€šè¿‡OverlayFSçš„æ¼æ´ï¼Œå…è®¸ä½æƒé™ç”¨æˆ·è·å¾—rootæƒé™ã€‚

**å…¶ä»–ä¿¡æ¯:**
CISA å·²å°†æ­¤æ¼æ´æ·»åŠ åˆ°å·²çŸ¥è¢«åˆ©ç”¨çš„æ¼æ´ç›®å½• (KEV) ä¸­ï¼Œè¡¨æ˜è¯¥æ¼æ´å·²è¢«å¹¿æ³›åˆ©ç”¨ã€‚

**é¡¹ç›®åœ°å€:** [fathallah17/OverlayFS-CVE-2021-3493](https://github.com/fathallah17/OverlayFS-CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #7

**æ¥æº**: [CVE-2021-3493-fei9747_CVE-2021-3493.md](../2021/CVE-2021-3493-fei9747_CVE-2021-3493.md)

## CVE-2021-3493 Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ”»å‡»è€…å¯åˆ©ç”¨æ­¤æ¼æ´è·å– root æƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu kernel versions: < 5.8.0-50.56, < 5.4.0-72.80, < 4.15.0-142.146, < 4.4.0-209.241

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦åœ¨å­˜åœ¨æ¼æ´çš„ Ubuntu ç³»ç»Ÿä¸Šæœ¬åœ°æ‰§è¡Œ

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 5%

## è¯¦æƒ…

CVE-2021-3493 æ˜¯ä¸€ä¸ªå­˜åœ¨äº Ubuntu Linux å†…æ ¸ overlayfs å®ç°ä¸­çš„æœ¬åœ°ææƒæ¼æ´ã€‚è¯¥æ¼æ´æºäº overlayfs æœªèƒ½æ­£ç¡®éªŒè¯ç”¨æˆ·å‘½åç©ºé—´ä¸­åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸Šæ–‡ä»¶ capabilities çš„è®¾ç½®ã€‚ç»“åˆæœªæˆæƒç”¨æˆ·å‘½åç©ºé—´ä»¥åŠ Ubuntu å†…æ ¸ä¸­å…è®¸æœªæˆæƒ overlay mount çš„è¡¥ä¸ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´æå‡æƒé™ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼ŒåŒ…æ‹¬lowerdirï¼Œupperdirï¼Œworkdirå’Œmergedirã€‚
2.  **åˆ›å»ºå‘½åç©ºé—´ï¼š** ä½¿ç”¨ `unshare` ç³»ç»Ÿè°ƒç”¨åˆ›å»ºæ–°çš„ç”¨æˆ·å‘½åç©ºé—´å’ŒæŒ‚è½½å‘½åç©ºé—´ã€‚
3.  **è®¾ç½®ç”¨æˆ·å’Œç»„IDæ˜ å°„ï¼š** å°†å½“å‰ç”¨æˆ·çš„ UID å’Œ GID æ˜ å°„åˆ°æ–°çš„ç”¨æˆ·å‘½åç©ºé—´ä¸­ï¼Œä»¥ä¾¿åœ¨æ–°çš„å‘½åç©ºé—´ä¸­æ‹¥æœ‰æƒé™ã€‚
4.  **æŒ‚è½½ OverlayFSï¼š** ä½¿ç”¨ `mount` ç³»ç»Ÿè°ƒç”¨ï¼Œå°† overlayfs æŒ‚è½½åˆ° mergedirï¼Œå¹¶å°† lowerdirï¼Œupperdir å’Œ workdir æŒ‡å®šä¸ºç›¸åº”çš„ç›®å½•ã€‚
5.  **è®¾ç½® Capabilitiesï¼š** å¤åˆ¶å½“å‰æ‰§è¡Œçš„ç¨‹åºåˆ° mergedirï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½®è¯¥æ–‡ä»¶çš„ capabilitiesï¼Œä½¿å…¶å…·æœ‰ root æƒé™ã€‚ è¿™æ­¥æ˜¯æ¼æ´åˆ©ç”¨çš„å…³é”®ã€‚
6.  **æ‰§è¡ŒPayloadï¼š** æ‰§è¡Œupperç›®å½•ä¸­çš„æ–‡ä»¶ï¼Œå› ä¸ºè®¾ç½®äº†Capabilitiesï¼Œå¯ä»¥è·å¾—rootæƒé™ã€‚

**æœ‰æ•ˆæ€§ï¼š**

æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’ŒPOCä»£ç æè¿°ï¼Œè¯¥æ¼æ´åœ¨ç‰¹å®šç‰ˆæœ¬çš„ Ubuntu å†…æ ¸ä¸Šæ˜¯å¯åˆ©ç”¨çš„ã€‚æä¾›çš„POCä»£ç å±•ç¤ºäº†åˆ©ç”¨è¯¥æ¼æ´æå‡æƒé™çš„å®Œæ•´è¿‡ç¨‹ã€‚

**æŠ•æ¯’é£é™©ï¼š**

ä»£ç ä¸­å­˜åœ¨æ½œåœ¨çš„æŠ•æ¯’é£é™©ï¼Œä½†æ˜¯é£é™©è¾ƒä½ã€‚ä¸»è¦é›†ä¸­åœ¨ç¼–è¯‘å’Œè¿è¡Œexploitæ—¶ã€‚æ”»å‡»è€…å¯èƒ½é€šè¿‡ä¿®æ”¹ exploit.c æ–‡ä»¶ï¼Œä¾‹å¦‚æ·»åŠ æ¶æ„ä»£ç æˆ–åé—¨ï¼Œä»è€Œåœ¨ç›®æ ‡ç³»ç»Ÿä¸Šæ‰§è¡Œæ¶æ„æ“ä½œã€‚ä½†æ˜¯æ ¹æ®æä¾›çš„POCä»£ç æ¥çœ‹, é£é™©ç³»æ•°è¾ƒä½.

**é£é™©è¯„ä¼°ï¼š**

è¯¥æ¼æ´åˆ©ç”¨çš„æˆåŠŸå–å†³äºç›®æ ‡ç³»ç»Ÿæ˜¯å¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š

*   è¿è¡Œå—å½±å“çš„ Ubuntu å†…æ ¸ç‰ˆæœ¬ã€‚
*   å¯ç”¨äº†æœªæˆæƒç”¨æˆ·å‘½åç©ºé—´å’Œ overlayfs mountã€‚
*   ç›®æ ‡ç³»ç»Ÿä¸Šå­˜åœ¨ `gcc` ç¼–è¯‘å™¨, èƒ½å¤Ÿç¼–è¯‘exploitã€‚

å¦‚æœç›®æ ‡ç³»ç»Ÿæ»¡è¶³è¿™äº›æ¡ä»¶ï¼Œæ”»å‡»è€…å¯ä»¥ä½¿ç”¨æä¾›çš„ POC ä»£ç æˆåŠŸåˆ©ç”¨è¯¥æ¼æ´ï¼Œä»è€Œè·å¾— root æƒé™ã€‚


**é¡¹ç›®åœ°å€:** [fei9747/CVE-2021-3493](https://github.com/fei9747/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #8

**æ¥æº**: [CVE-2021-3493-iamz24_CVE-2021-3493_CVE-2022-3357.md](../2021/CVE-2021-3493-iamz24_CVE-2021-3493_CVE-2022-3357.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒæ¼æ´

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å¯¼è‡´æœ¬åœ°æƒé™æå‡è‡³ root

**å½±å“ç‰ˆæœ¬:** Ubuntu kernels < 5.8.0-50.56, < 5.4.0-72.80, < 4.15.0-142.146, < 4.4.0-209.241

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç›®æ ‡ç³»ç»Ÿå¼€å¯ unprivileged user namespaces å’Œå­˜åœ¨ OverlayFS æœåŠ¡ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2021-3493 æ¼æ´æ˜¯ Linux å†…æ ¸ overlayfs å®ç°ä¸­ï¼Œåœ¨ç”¨æˆ·å‘½åç©ºé—´ä¸­å¯¹åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­çš„æ–‡ä»¶ capabilities éªŒè¯ä¸å½“å¯¼è‡´çš„ã€‚ç”±äº Ubuntu å†…æ ¸ä¸­å­˜åœ¨å…è®¸éç‰¹æƒ overlay æŒ‚è½½çš„è¡¥ä¸ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¯¥æ¼æ´æå‡æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** æ£€æŸ¥ç›®æ ‡ç³»ç»Ÿæ˜¯å¦å­˜åœ¨ overlayfs æœåŠ¡ï¼Œå¦‚æœæ²¡æœ‰åˆ™åŠ è½½ overlay æ¨¡å—ã€‚åŒæ—¶ï¼Œç¡®ä¿å¼€å¯äº† unprivileged user namespacesã€‚
2.  **ç¼–è¯‘ Payloadï¼š** ä½¿ç”¨ GCC ç¼–è¯‘æä¾›çš„ `payload.c` æ–‡ä»¶ã€‚
3.  **è¿è¡Œ Payloadï¼š** è¿è¡Œç¼–è¯‘åçš„å¯æ‰§è¡Œæ–‡ä»¶ `a.out`ã€‚
4.  **è·å– Root Shellï¼š** Payload ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å‘½åç©ºé—´ï¼ŒæŒ‚è½½ overlayfsï¼Œè®¾ç½® capabilityï¼Œæœ€ç»ˆæ‰§è¡Œä¸€ä¸ªå…·æœ‰ root æƒé™çš„ shellã€‚

**æœ‰æ•ˆæ€§ï¼š**

æä¾›çš„ POC ä»£ç åŸºæœ¬æœ‰æ•ˆï¼Œèƒ½å¤Ÿåˆ©ç”¨è¯¥æ¼æ´åœ¨ç¬¦åˆæ¡ä»¶çš„ Ubuntu ç³»ç»Ÿä¸Šå®ç°æœ¬åœ°ææƒã€‚

**æŠ•æ¯’é£é™©ï¼š**

å­˜åœ¨è¾ƒä½çš„æŠ•æ¯’é£é™©ï¼ˆ10%ï¼‰ã€‚è™½ç„¶ä»£ç çš„ä¸»è¦åŠŸèƒ½æ˜¯å®ç°ææƒï¼Œä½†ä»ç„¶éœ€è¦è°¨æ…å¯¹å¾…æ¥æºä¸æ˜çš„ä»£ç ï¼Œä½œè€…å¯èƒ½ä¼šåœ¨å…¶ä¸­éšè—ä¸€äº›æ¶æ„è¡Œä¸ºï¼Œæ¯”å¦‚ä¸Šä¼ æ•æ„Ÿä¿¡æ¯ç­‰ã€‚ç‰¹åˆ«æ˜¯éœ€è¦æ£€æŸ¥ `exploit`å‡½æ•°ä¸­çš„ç›¸å…³æ–‡ä»¶æ“ä½œå’Œå‘½ä»¤æ‰§è¡Œæ˜¯å¦å­˜åœ¨æ¶æ„è¡Œä¸ºã€‚å°¤å…¶å…³æ³¨`system(buf);`æ˜¯å¦ä¼šæ‰§è¡Œæ¶æ„çš„æŒ‡ä»¤ã€‚

**æ€»ç»“ï¼š**

è¯¥æ¼æ´åˆ©ç”¨è¾ƒä¸ºç›´æ¥ï¼Œåˆ©ç”¨æ¡ä»¶ç›¸å¯¹æ˜ç¡®ï¼Œä½†éœ€è¦æ³¨æ„æ½œåœ¨çš„æŠ•æ¯’é£é™©ã€‚åœ¨å®é™…ä½¿ç”¨æ—¶ï¼Œåº”è¯¥ä»”ç»†å®¡æŸ¥ä»£ç ï¼Œç¡®ä¿æ²¡æœ‰æ¶æ„è¡Œä¸ºã€‚

**é¡¹ç›®åœ°å€:** [iamz24/CVE-2021-3493_CVE-2022-3357](https://github.com/iamz24/CVE-2021-3493_CVE-2022-3357)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #9

**æ¥æº**: [CVE-2021-3493-inspiringz_CVE-2021-3493.md](../2021/CVE-2021-3493-inspiringz_CVE-2021-3493.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Ubuntu Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸ä½æƒé™ç”¨æˆ·æå‡åˆ°rootæƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu 4.4, 4.15, 5.4, 5.8 kernels (å—å½±å“ç‰ˆæœ¬è¯¦è§æ¼æ´åº“ä¿¡æ¯)

**åˆ©ç”¨æ¡ä»¶:** Ubuntuå†…æ ¸ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…ï¼Œå¯ç”¨æœªæˆæƒç”¨æˆ·å‘½åç©ºé—´ï¼Œå…è®¸æœªæˆæƒOverlayFSæŒ‚è½½ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 5%

## è¯¦æƒ…

CVE-2021-3493æ˜¯Ubuntuå†…æ ¸ä¸­OverlayFSå®ç°çš„ä¸€ä¸ªæ¼æ´ï¼Œå…è®¸ä½æƒé™ç”¨æˆ·é€šè¿‡åˆ©ç”¨user namespaceå’ŒOverlayFSæŒ‚è½½ç»•è¿‡æ–‡ä»¶ç³»ç»Ÿæƒé™æ£€æŸ¥æ¥æå‡æƒé™ã€‚ 

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡:** æ¼æ´åˆ©ç”¨éœ€è¦å­˜åœ¨Ubuntuç³»ç»Ÿï¼Œä¸”å†…æ ¸ç‰ˆæœ¬åœ¨æ¼æ´åº“ä¿¡æ¯ä¸­æè¿°çš„å—å½±å“èŒƒå›´å†…ï¼Œå¹¶ä¸”éœ€è¦å¯ç”¨æœªæˆæƒç”¨æˆ·å‘½åç©ºé—´(unprivileged user namespaces)ã€‚æ­¤å¤–ï¼Œä¸ºäº†åˆ©ç”¨OverlayFSï¼Œç³»ç»Ÿéœ€è¦é…ç½®å…è®¸æœªæˆæƒç”¨æˆ·è¿›è¡ŒOverlayFSæŒ‚è½½ã€‚
2.  **æ¼æ´åˆ©ç”¨:**  æ”»å‡»è€…é¦–å…ˆåˆ›å»ºä¸€ä¸ªåŒ…å«lower, upper, workç›®å½•çš„OverlayFSç»“æ„ã€‚
3.  **åˆ©ç”¨è¿‡ç¨‹:** åˆ©ç”¨`unshare`ç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€ä¸ªæ–°çš„user namespaceå’Œmount namespaceã€‚ åœ¨æ–°namespaceä¸­ï¼Œå°†è‡ªå·±çš„UIDå’ŒGIDæ˜ å°„åˆ°rootæƒé™ã€‚ ç„¶åï¼Œä½¿ç”¨æ„é€ çš„lowerdirã€upperdirå’ŒworkdiræŒ‚è½½OverlayFSæ–‡ä»¶ç³»ç»Ÿã€‚ æ”»å‡»è€…å°†ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶å¤åˆ¶åˆ°OverlayFSçš„mergeç›®å½•ä¸­ã€‚å…³é”®çš„ä¸€æ­¥æ˜¯ï¼Œæ”»å‡»è€…ä½¿ç”¨`setxattr`ç³»ç»Ÿè°ƒç”¨ï¼Œè®¾ç½®è¯¥å¯æ‰§è¡Œæ–‡ä»¶çš„`security.capability`æ‰©å±•å±æ€§ï¼Œèµ‹äºˆå®ƒ`CAP_SETUID`å’Œ`CAP_SETGID`èƒ½åŠ›ã€‚ ç”±äºOverlayFSçš„æƒé™éªŒè¯ä¸å®Œå–„ï¼Œè¿™ä¸ªæ“ä½œå³ä½¿åœ¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´ä¸­ä¹Ÿèƒ½æˆåŠŸã€‚å½“æ‰§è¡Œè¯¥æ–‡ä»¶æ—¶ï¼Œå®ƒå°†è·å¾—rootæƒé™ï¼Œå¹¶å¯ä»¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚
4.  **POCä»£ç åˆ†æ:** `exploit.c` ä»£ç é¦–å…ˆåˆ›å»ºä¸€ä¸ªoverlayfsç›®å½•ç»“æ„ã€‚ç„¶åï¼Œä½¿ç”¨ `unshare` ç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€ä¸ªæ–°çš„ user namespace å’Œ mount namespaceï¼Œå¹¶å°†å½“å‰ç”¨æˆ·çš„ uid å’Œ gid æ˜ å°„åˆ° root ç”¨æˆ·ã€‚ ä¹‹åï¼Œå®ƒæŒ‚è½½ overlayfsï¼Œå¤åˆ¶å½“å‰æ‰§è¡Œçš„ç¨‹åºåˆ° overlayfs çš„ merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½® capabilityã€‚æœ€åï¼Œæ‰§è¡Œå¤åˆ¶åˆ° overlayfs çš„ç¨‹åºã€‚
5. **æŠ•æ¯’é£é™©åˆ†æ:** ä»£ç æœ¬èº«å®ç°äº†æ¼æ´åˆ©ç”¨çš„åŠŸèƒ½ã€‚ æ½œåœ¨çš„æŠ•æ¯’é£é™©å¯èƒ½å­˜åœ¨äºä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š
    *   **ä¾èµ–é¡¹:**  ä»£ç ä¾èµ–äºæ ‡å‡†çš„Cåº“ï¼Œæœ¬èº«ä¸å­˜åœ¨æ¶æ„ä¾èµ–ã€‚ä½†ç”¨æˆ·åœ¨ç¼–è¯‘æ—¶éœ€è¦æ³¨æ„ç¼–è¯‘å™¨ç¯å¢ƒçš„å®‰å…¨æ€§ã€‚
    *   **ä»£ç é€»è¾‘:**  ä»£ç é€»è¾‘ç›¸å¯¹ç®€å•ï¼Œä¸»è¦é›†ä¸­åœ¨namespaceåˆ›å»ºã€æŒ‚è½½å’Œcapabilityè®¾ç½®ã€‚ ä»”ç»†å®¡æŸ¥ä»£ç ï¼Œæœªå‘ç°æ˜æ˜¾çš„æ¶æ„é€»è¾‘ã€‚
    *   **æ‰§è¡Œå‘½ä»¤:**  ä»£ç ä¸­ä½¿ç”¨äº† `system` å‡½æ•°ï¼Œè¿™æ˜¯ä¸€ä¸ªæ½œåœ¨çš„é£é™©ç‚¹ï¼Œå¯ä»¥æ‰§è¡Œä»»æ„ç³»ç»Ÿå‘½ä»¤ã€‚ä½†æ˜¯ï¼Œè¿™é‡Œåªæ˜¯ç”¨æ¥åˆ é™¤ç›®å½•ï¼Œç›¸å¯¹å®‰å…¨ã€‚
       ç»¼ä¸Šæ‰€è¿°ï¼Œè¯¥POCä»£ç ä¸»è¦é£é™©åœ¨äºç¡®ä¿ç¼–è¯‘ç¯å¢ƒå®‰å…¨ä»¥åŠå¯¹ä¸ç†Ÿæ‚‰çš„å‘½ä»¤ä¿æŒè­¦æƒ•ã€‚æŠ•æ¯’é£é™©è¾ƒä½ï¼Œé¢„ä¼°ä¸º5%ã€‚

**æ€»ç»“ï¼š**

è¯¥æ¼æ´åˆ©ç”¨çš„æ ¸å¿ƒåœ¨äºç»“åˆäº†æœªæˆæƒç”¨æˆ·å‘½åç©ºé—´å’ŒOverlayFSï¼Œåˆ©ç”¨OverlayFSå¯¹capabilitiesè®¾ç½®éªŒè¯çš„ç¼ºé™·ï¼Œå®ç°äº†æœ¬åœ°ææƒã€‚ æ”»å‡»è€…é€šè¿‡åˆ›å»ºç‰¹æ®Šçš„OverlayFSç»“æ„å¹¶è®¾ç½®æ–‡ä»¶capabilitiesï¼Œæœ€ç»ˆè·å¾—rootæƒé™ã€‚

**é¡¹ç›®åœ°å€:** [inspiringz/CVE-2021-3493](https://github.com/inspiringz/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #10

**æ¥æº**: [CVE-2021-3493-oneoy_CVE-2021-3493.md](../2021/CVE-2021-3493-oneoy_CVE-2021-3493.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœ¬åœ°ç”¨æˆ·å¯æå‡è‡³ root æƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu 4.4, 4.15, 5.4, and 5.8 kernels (å…·ä½“ç‰ˆæœ¬å·è§æ¼æ´åº“ä¿¡æ¯)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç›®æ ‡ç³»ç»Ÿå­˜åœ¨æœªä¿®å¤çš„ Ubuntu kernelï¼Œä¸”å¯ç”¨ unprivileged user namespaces å’Œå…è®¸ unprivileged overlayfs mountsã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

è¯¥æ¼æ´å­˜åœ¨äº Ubuntu å†…æ ¸çš„ OverlayFS å®ç°ä¸­ï¼Œç”±äºæœªæ­£ç¡®éªŒè¯ç”¨æˆ·å‘½åç©ºé—´ä¸­åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸Šæ–‡ä»¶ capabilities çš„è®¾ç½®ï¼Œå¯¼è‡´æœ¬åœ°æ”»å‡»è€…å¯åˆ©ç”¨ unprivileged user namespaces å’Œ Ubuntu å†…æ ¸ä¸­å…è®¸ unprivileged overlayfs mounts çš„è¡¥ä¸æ¥æå‡æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ (lower, upper, work, merge)ã€‚
2.  **é…ç½® User Namespace:** åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´ã€‚
3.  **é…ç½® OverlayFS:** ä½¿ç”¨ lowerdir, upperdir, å’Œ workdir é€‰é¡¹æŒ‚è½½ overlay æ–‡ä»¶ç³»ç»Ÿã€‚
4.  **è®¾ç½® Capabilities:** å°†å¯æ‰§è¡Œæ–‡ä»¶å¤åˆ¶åˆ° merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½®å…¶ capabilities (å¦‚ CAP_SETUID, CAP_SETGID, CAP_CHOWN)ã€‚
5.  **è§¦å‘ææƒ:** æ‰§è¡Œ merge ç›®å½•ä¸­çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶å°†ä¼šä»¥ root æƒé™æ‰§è¡Œã€‚

**æŠ•æ¯’é£é™©è¯„ä¼°ï¼š**

æä¾›çš„ `exploit.c` ä»£ç ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨ OverlayFS çš„æ¼æ´è¿›è¡Œææƒã€‚ä»£ç åˆ›å»ºå¿…è¦çš„ç›®å½•ï¼Œé…ç½® user namespace å’Œ overlay æ–‡ä»¶ç³»ç»Ÿï¼Œå¹¶è®¾ç½®å¯æ‰§è¡Œæ–‡ä»¶çš„ capabilitiesã€‚ä»£ç é€»è¾‘æ¸…æ™°ï¼Œæ²¡æœ‰å‘ç°æ¶æ„ä»£ç æˆ–åé—¨ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**

æä¾›çš„ POC ä»£ç åŸºäºå…¬å¼€ä¿¡æ¯ï¼Œå¹¶é’ˆå¯¹ CVE-2021-3493 æ¼æ´è¿›è¡Œäº†åˆ©ç”¨ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯ã€æœç´¢å¼•æ“ç»“æœå’Œä»£ç åˆ†æï¼Œè¯¥ POC ä»£ç åœ¨æ»¡è¶³æ¼æ´åˆ©ç”¨æ¡ä»¶çš„æƒ…å†µä¸‹åº”è¯¥æ˜¯æœ‰æ•ˆçš„ã€‚

**é¡¹ç›®åœ°å€:** [oneoy/CVE-2021-3493](https://github.com/oneoy/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #11

**æ¥æº**: [CVE-2021-3493-pmihsan_OverlayFS-CVE-2021-3493.md](../2021/CVE-2021-3493-pmihsan_OverlayFS-CVE-2021-3493.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœ¬åœ°ç”¨æˆ·å¯æå‡è‡³ root æƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu kernel versions: < 5.8.0-50.56 (5.8 kernel), < 5.4.0-72.80 (5.4 kernel), < 4.15.0-142.146 (4.15 kernel), < 4.4.0-209.241 (4.4 kernel)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦åœ¨å­˜åœ¨æ¼æ´çš„ Ubuntu ç³»ç»Ÿä¸Šæ‰§è¡Œï¼Œå¹¶ä¸”å…è®¸ unprivileged user namespaces å’Œ overlay mountsã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

CVE-2021-3493 æ¼æ´å­˜åœ¨äº Linux å†…æ ¸çš„ overlayfs å®ç°ä¸­ã€‚ç”±äºå¯¹ç”¨æˆ·å‘½åç©ºé—´ä¸­åº•å±‚æ–‡ä»¶ç³»ç»Ÿæ–‡ä»¶ capabilities çš„éªŒè¯ä¸è¶³ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡åˆ›å»ºæ¶æ„çš„ overlayfs æ–‡ä»¶ç³»ç»Ÿï¼Œåˆ©ç”¨ setxattr è®¾ç½®æ–‡ä»¶ capabilitiesï¼Œä»è€Œè·å¾—æå‡çš„æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** åˆ›å»º overlayfs æ‰€éœ€çš„ç›®å½•ç»“æ„ (lower, upper, work, merge)ã€‚
2.  **Namespace åˆ›å»ºï¼š** åˆ›å»ºæ–°çš„ user namespace å’Œ mount namespaceï¼Œéš”ç¦»æƒé™ã€‚
3.  **æƒé™è®¾ç½®ï¼š** ä¿®æ”¹ uid_map å’Œ gid_mapï¼Œä½¿å¾—åœ¨ user namespace ä¸­æ‹¥æœ‰ root æƒé™ã€‚
4.  **Overlayfs Mountï¼š** ä½¿ç”¨ overlayfs mount å‘½ä»¤å°† lowerdir, upperdir, workdir æŒ‚è½½åˆ° mergedirã€‚
5.  **Capabilities è®¾ç½®ï¼š** å¤åˆ¶è‡ªèº«ç¨‹åºåˆ° merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` å‡½æ•°ä¸ºå¤åˆ¶åçš„ç¨‹åºè®¾ç½® capabilities (CAP_SETUID, CAP_SETGID, CAP_DAC_OVERRIDE ç­‰)ã€‚
6.  **æƒé™æå‡ï¼š** æ‰§è¡Œ merge ç›®å½•ä¸‹çš„ç¨‹åºï¼Œæ­¤æ—¶ç¨‹åºå°†ä»¥ root æƒé™è¿è¡Œã€‚

**æœ‰æ•ˆæ€§ï¼š**

æä¾›çš„ POC ä»£ç é€šè¿‡åˆ©ç”¨ overlayfs æ¼æ´ï¼Œå¯ä»¥æˆåŠŸåœ°æå‡æƒé™ã€‚POC ä»£ç é¦–å…ˆåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼Œç„¶ååˆ›å»ºä¸€ä¸ªæ–°çš„ user namespace å’Œ mount namespaceï¼Œæ¥ç€æŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿï¼Œå¹¶ä½¿ç”¨ `setxattr` å‡½æ•°ä¸ºæ–‡ä»¶è®¾ç½® capabilitiesã€‚æœ€åï¼Œæ‰§è¡Œè¯¥æ–‡ä»¶å³å¯è·å¾— root æƒé™ã€‚

**æŠ•æ¯’é£é™©ï¼š**

åˆ†æ POC ä»£ç ï¼Œæ²¡æœ‰å‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç ï¼Œä¾‹å¦‚åå¼¹ shellã€å®‰è£…åé—¨ç­‰ã€‚ä»£ç é€»è¾‘ä¸»è¦é›†ä¸­åœ¨åˆ©ç”¨ overlayfs æ¼æ´ææƒï¼Œå¹¶æ²¡æœ‰é¢å¤–çš„æ“ä½œæ¥æ¤å…¥æ¶æ„ç¨‹åºã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ï¼Œå¯ä»¥è®¤ä¸ºæ˜¯ 0%ã€‚å‚è€ƒçš„ vulnerability description å’Œ exploit ä»£ç éƒ½ç€é‡äºææƒï¼Œè€Œæ²¡æœ‰æåˆ°ä»»ä½•æŠ•æ¯’è¡Œä¸ºã€‚

**é¡¹ç›®åœ°å€:** [pmihsan/OverlayFS-CVE-2021-3493](https://github.com/pmihsan/OverlayFS-CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #12

**æ¥æº**: [CVE-2021-3493-ptkhai15_OverlayFS---CVE-2021-3493.md](../2021/CVE-2021-3493-ptkhai15_OverlayFS---CVE-2021-3493.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Ubuntu Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœ¬åœ°ç”¨æˆ·æå‡æƒé™è‡³ root

**å½±å“ç‰ˆæœ¬:** Ubuntu kernel versions 5.8, 5.4, 4.15, å’Œ 4.4 ä¸­å—å½±å“çš„ç‰ˆæœ¬ï¼ˆå…·ä½“ç‰ˆæœ¬å‚è§æ¼æ´åº“ä¿¡æ¯ï¼‰

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡ç³»ç»Ÿå¿…é¡»æ˜¯å—å½±å“çš„ Ubuntu ç‰ˆæœ¬ï¼Œå¹¶ä¸”å¯ç”¨äº†éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å’Œéç‰¹æƒ overlayfs æŒ‚è½½ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

CVE-2021-3493 æ˜¯ Ubuntu Linux å†…æ ¸ä¸­ OverlayFS å®ç°ä¸­çš„ä¸€ä¸ªæ¼æ´ã€‚è¯¥æ¼æ´å…è®¸éç‰¹æƒç”¨æˆ·åˆ©ç”¨ç”¨æˆ·å‘½åç©ºé—´å’Œéç‰¹æƒ overlayfs æŒ‚è½½ï¼Œé€šè¿‡ä¸æ­£ç¡®åœ°éªŒè¯åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­æ–‡ä»¶çš„ capabilities è®¾ç½®æ¥æå‡æƒé™ã€‚åˆ©ç”¨æ–¹å¼å¦‚ä¸‹ï¼š

1.  **ç¯å¢ƒå‡†å¤‡ï¼š**  åˆ›å»ºä¸€ä¸ªåŸºç¡€ç›®å½•ç»“æ„ï¼ŒåŒ…æ‹¬ workã€lowerã€upper å’Œ merge ç›®å½•ï¼Œè¿™æ˜¯ overlayfs çš„æ ‡å‡†é…ç½®ã€‚
2.  **åˆ›å»ºç”¨æˆ·å‘½åç©ºé—´ï¼š**  ä½¿ç”¨ `unshare` å‘½ä»¤åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´ã€‚è¿™å…è®¸åœ¨æ–°çš„å‘½åç©ºé—´ä¸­æ‹¥æœ‰ä¸åŒçš„ç”¨æˆ·å’Œç»„ IDã€‚
3.  **é…ç½®ç”¨æˆ·å’Œç»„æ˜ å°„ï¼š**  é€šè¿‡ `/proc/self/setgroups`ã€`/proc/self/uid_map` å’Œ `/proc/self/gid_map` æ–‡ä»¶è®¾ç½®ç”¨æˆ·å’Œç»„ ID æ˜ å°„ï¼Œå°†å½“å‰ç”¨æˆ·çš„ UID å’Œ GID æ˜ å°„åˆ°æ–°å‘½åç©ºé—´ä¸­çš„ root ç”¨æˆ·ã€‚
4.  **æŒ‚è½½ OverlayFSï¼š**  ä½¿ç”¨ `mount` å‘½ä»¤æŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿï¼Œå°† lowerã€upper å’Œ work ç›®å½•å…³è”èµ·æ¥ã€‚
5.  **è®¾ç½®æ–‡ä»¶ capabilitiesï¼š**  å¤åˆ¶å½“å‰æ‰§è¡Œç¨‹åºåˆ° overlayfs çš„ merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½®æ–‡ä»¶çš„ capabilities ä¸º `all+ep`ï¼Œå…è®¸è¯¥æ–‡ä»¶æ‰§è¡Œæ—¶æ‹¥æœ‰ root æƒé™ã€‚
6.  **æ‰§è¡Œææƒåçš„ç¨‹åºï¼š**  æ‰§è¡Œä½äº upper ç›®å½•ä¸­çš„å¤åˆ¶åçš„ç¨‹åºã€‚å¦‚æœç¨‹åºæ£€æµ‹åˆ°è‡ªå·±æ˜¯é€šè¿‡ç‰¹å®šæ–¹å¼ï¼ˆä¾‹å¦‚ï¼ŒåŒ…å« "magic" å­—ç¬¦ä¸²æˆ–æ¥å— "shell" å‚æ•°ï¼‰è°ƒç”¨çš„ï¼Œå®ƒä¼šè°ƒç”¨ `setuid(0)` å’Œ `setgid(0)` å°†è¿›ç¨‹çš„ UID å’Œ GID è®¾ç½®ä¸º 0 (root)ï¼Œå¹¶å¯åŠ¨ä¸€ä¸ª root shellã€‚

**å…³äºæŠ•æ¯’é£é™©ï¼š**

åœ¨æä¾›çš„ POC ä»£ç ä¸­ï¼Œæ²¡æœ‰æ˜æ˜¾çš„æŠ•æ¯’ä»£ç ã€‚POC çš„ç›®çš„æ˜¯æ¼”ç¤ºæ¼æ´åˆ©ç”¨è¿‡ç¨‹ï¼Œæ²¡æœ‰å‘ç°æ¶æ„è¡Œä¸ºï¼Œä¾‹å¦‚åå‘ shell æˆ–å…¶ä»–æœªç»æˆæƒçš„è®¿é—®ã€‚


**é¡¹ç›®åœ°å€:** [ptkhai15/OverlayFS---CVE-2021-3493](https://github.com/ptkhai15/OverlayFS---CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #13

**æ¥æº**: [CVE-2021-3493-puckiestyle_CVE-2021-3493.md](../2021/CVE-2021-3493-puckiestyle_CVE-2021-3493.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ”»å‡»è€…å¯åˆ©ç”¨æ­¤æ¼æ´è·å¾— root æƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu 5.8 kernel (< 5.8.0-50.56), 5.4 kernel (< 5.4.0-72.80), 4.15 kernel (< 4.15.0-142.146), 4.4 kernel (< 4.4.0-209.241)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ Ubuntu ç³»ç»Ÿå¼€å¯ unprivileged user namespaces å’Œå…è®¸ unprivileged overlay mounts

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2021-3493 æ˜¯ Ubuntu å†…æ ¸ overlayfs å®ç°ä¸­çš„ä¸€ä¸ªæ¼æ´ï¼Œå…è®¸æœ¬åœ°æ”»å‡»è€…é€šè¿‡æ»¥ç”¨ user namespaces å’Œ overlayfs æŒ‚è½½æœºåˆ¶æå‡æƒé™ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**
æä¾›çš„ POC ä»£ç å°è¯•åˆ©ç”¨è¯¥æ¼æ´ï¼Œé€šè¿‡åˆ›å»º user namespace å’Œ overlayfs æ–‡ä»¶ç³»ç»Ÿæ¥è®¾ç½®å¯æ‰§è¡Œæ–‡ä»¶çš„ capability ä½ï¼Œä½¿å…¶è·å¾— root æƒé™ã€‚ æ¼æ´åº“ä¿¡æ¯,æœç´¢å¼•æ“ç»“æœå’Œæ¼æ´åˆ©ç”¨ä»£ç ä¸€è‡´,è¡¨æ˜è¯¥æ¼æ´çš„POCæ˜¯çœŸå®æœ‰æ•ˆçš„ã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**
æŸ¥çœ‹ `exploit.c` ä»£ç ï¼Œä¸»è¦æ“ä½œåŒ…æ‹¬åˆ›å»ºç›®å½•ã€è®¾ç½® user namespaceã€æŒ‚è½½ overlayfsã€å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶ã€è®¾ç½® capability å±æ€§ï¼Œä»¥åŠæ‰§è¡Œå¤åˆ¶åçš„æ–‡ä»¶ä»¥è·å¾— root æƒé™ã€‚ä»£ç é€»è¾‘è¾ƒä¸ºæ¸…æ™°ï¼Œæœªå‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç ã€‚`README.md` ä¹Ÿè¯´æ˜äº†å¹¶éä½œè€…åŸåˆ›,åªæ˜¯æ¬è¿,å¢åŠ äº†åˆ†æéš¾åº¦.
`exploit.c`ä¸­å­˜åœ¨`system(buf);` è°ƒç”¨ï¼Œè™½ç„¶è¿™é‡Œæ˜¯ç”¨äºæ¸…ç†ç›®å½•ï¼Œä½†å¦‚æœè¢«ç¯¡æ”¹ï¼Œå¯èƒ½æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£é™©è¯„ä¼°ä¸º10%ã€‚ä¸»è¦çš„é£é™©åœ¨äºï¼š

*   `system()` å‡½æ•°æ½œåœ¨çš„å‘½ä»¤æ³¨å…¥é£é™©ï¼Œå¦‚æœä»£ç è¢«ä¿®æ”¹ï¼Œå¯èƒ½å¯¼è‡´æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  åˆ©ç”¨ unshare() åˆ›å»ºä¸€ä¸ªæ–°çš„ user namespace å’Œ mount namespaceã€‚
2.  é…ç½® user namespace çš„ uid_map å’Œ gid_mapï¼Œå°†å½“å‰ç”¨æˆ·æ˜ å°„ä¸º root ç”¨æˆ·ã€‚
3.  åˆ›å»º overlayfs æ‰€éœ€çš„ç›®å½•ç»“æ„ï¼ˆlowerdirã€upperdirã€workdirã€mergedï¼‰ã€‚
4.  æŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿã€‚
5.  å°†æ¼æ´åˆ©ç”¨ç¨‹åºè‡ªèº«å¤åˆ¶åˆ° overlayfs çš„ upperdir/merged ç›®å½•ã€‚
6.  ä½¿ç”¨ setxattr() è®¾ç½®å¤åˆ¶åçš„å¯æ‰§è¡Œæ–‡ä»¶çš„ security.capability å±æ€§ï¼Œèµ‹äºˆå…¶ CAP_SETUID å’Œ CAP_SETGID æƒé™ã€‚
7.  æ‰§è¡Œå¤åˆ¶åçš„ç¨‹åºï¼Œç”±äºè®¾ç½®äº† capabilityï¼Œè¯¥ç¨‹åºä¼šä»¥ root æƒé™è¿è¡Œï¼Œä»è€Œè·å¾— root shellã€‚

**é¡¹ç›®åœ°å€:** [puckiestyle/CVE-2021-3493](https://github.com/puckiestyle/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #14

**æ¥æº**: [CVE-2021-3493-smallkill_CVE-2021-3493.md](../2021/CVE-2021-3493-smallkill_CVE-2021-3493.md)

# CVE-2021-3493

> ğŸ“¦ è¯¥CVEæœ‰ **15** ä¸ªç›¸å…³POCä»“åº“

---

## POC #1

**æ¥æº**: [CVE-2021-3493-Abdennour-py_CVE-2021-3493.md](../2021/CVE-2021-3493-Abdennour-py_CVE-2021-3493.md)

## CVE-2021-3493 Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å¯¼è‡´æ™®é€šç”¨æˆ·æå‡ä¸ºrootæƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu 5.8 kernel < 5.8.0-50.56, 5.4 kernel < 5.4.0-72.80, 4.15 kernel < 4.15.0-142.146, 4.4 kernel < 4.4.0-209.241

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç›®æ ‡ç³»ç»Ÿè¿è¡Œå—å½±å“çš„Ubuntuå†…æ ¸ï¼Œå¹¶ä¸”å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿå’Œä½¿ç”¨user namespace

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

è¯¥æ¼æ´æºäºUbuntuå†…æ ¸ä¸­overlayfså®ç°å¯¹ç”¨æˆ·å‘½åç©ºé—´ä¸­çš„æ–‡ä»¶èƒ½åŠ›éªŒè¯ä¸å½“ã€‚ç»“åˆéç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å’ŒUbuntuå†…æ ¸ä¸­çš„å…è®¸éç‰¹æƒ overlayfs æŒ‚è½½çš„è¡¥ä¸ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´è·å¾—æå‡çš„æƒé™ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**

æä¾›çš„POCä»£ç çœ‹èµ·æ¥æ˜¯æœ‰æ•ˆçš„ã€‚å®ƒåˆ©ç”¨äº† overlayfs å’Œ user namespace çš„ç»„åˆæ¥è®¾ç½®æ–‡ä»¶ capabilityï¼Œä»è€Œå®ç°ææƒã€‚ä»£ç é¦–å…ˆåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼ˆlower, upper, work, mergeï¼‰ï¼Œç„¶åä½¿ç”¨ `unshare` åˆ›å»ºä¸€ä¸ªæ–°çš„ user namespace å’Œ mount namespaceã€‚æ¥ç€ï¼Œå®ƒå†™å…¥ `/proc/self/setgroups`, `/proc/self/uid_map`, å’Œ `/proc/self/gid_map` æ¥è®¾ç½®ç”¨æˆ·å’Œç»„çš„æ˜ å°„ã€‚ç„¶åï¼ŒæŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿï¼Œæ‹·è´è‡ªèº«å¯æ‰§è¡Œæ–‡ä»¶åˆ° overlayfs çš„ merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½® capabilitiesã€‚æœ€åï¼Œå®ƒæ‰§è¡Œä½äº upper ç›®å½•çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶ä¼šå°è¯•ä»¥ root æƒé™æ‰§è¡Œ /bin/bashã€‚

æ ¹æ®æ¼æ´åº“ä¿¡æ¯ï¼ŒCISA å°†æ­¤æ¼æ´æ·»åŠ åˆ°å·²çŸ¥è¢«åˆ©ç”¨çš„æ¼æ´åˆ—è¡¨ä¸­ï¼Œè¿›ä¸€æ­¥è¡¨æ˜äº†è¯¥æ¼æ´çš„æœ‰æ•ˆæ€§ã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

æ£€æŸ¥æä¾›çš„ exploit.c ä»£ç ï¼Œæ²¡æœ‰å‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç æˆ–åé—¨ã€‚ä»£ç é€»è¾‘æ¸…æ™°ï¼Œä¸»è¦æ‰§è¡Œäº† overlayfs çš„æŒ‚è½½ï¼Œæ–‡ä»¶å¤åˆ¶ï¼Œè®¾ç½® xattr å’Œæ‰§è¡Œ shell æ“ä½œã€‚ä»£ç çš„æ„å›¾ä¸æ¼æ´æè¿°ä¸€è‡´ï¼Œæ²¡æœ‰å‘ç°éšè—çš„ã€ä¸æ¼æ´åˆ©ç”¨æ— å…³çš„æ¶æ„è¡Œä¸ºã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£é™©ä¸º 0%ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š**  åœ¨å­˜åœ¨æ¼æ´çš„Ubuntuç³»ç»Ÿä¸Šï¼Œåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ (ovlcap/work, ovlcap/lower, ovlcap/upper, ovlcap/merge)ã€‚
2.  **User Namespaceå’ŒMount Namespaceï¼š** ä½¿ç”¨ `unshare` ç³»ç»Ÿè°ƒç”¨åˆ›å»ºæ–°çš„ user namespace å’Œ mount namespaceã€‚
3.  **IDæ˜ å°„ï¼š**  é…ç½® `/proc/self/setgroups`ï¼Œ`/proc/self/uid_map` å’Œ `/proc/self/gid_map`ï¼Œä»¥ä¾¿åœ¨ user namespace ä¸­è·å¾—æœ‰æ•ˆçš„ç”¨æˆ· ID å’Œç»„ IDã€‚
4.  **OverlayFSæŒ‚è½½ï¼š**  ä½¿ç”¨ `mount` ç³»ç»Ÿè°ƒç”¨æŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿï¼Œå°† lower, upper å’Œ work ç›®å½•å…³è”èµ·æ¥ã€‚
5.  **æ–‡ä»¶æ‹·è´ä¸ Capability è®¾ç½®ï¼š**  å°† exploit ç¨‹åºè‡ªèº«æ‹·è´åˆ° overlayfs çš„ merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½® `security.capability` å±æ€§ï¼Œèµ‹äºˆå…¶ CAP_SETUID å’Œ CAP_SETGID ç­‰æƒé™ã€‚
6.  **ææƒæ‰§è¡Œï¼š** æ‰§è¡Œä½äº upper ç›®å½•çš„ exploit ç¨‹åºçš„æ‹·è´ã€‚ç”±äºè¯¥æ–‡ä»¶å…·æœ‰ capabilitiesï¼Œå› æ­¤å¯ä»¥ä»¥ root æƒé™æ‰§è¡Œ shellã€‚

**é¡¹ç›®åœ°å€:** [Abdennour-py/CVE-2021-3493](https://github.com/Abdennour-py/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #2

**æ¥æº**: [CVE-2021-3493-Sornphut_OverlayFS---CVE-2021-3493.md](../2021/CVE-2021-3493-Sornphut_OverlayFS---CVE-2021-3493.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒæ¼æ´

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Ubuntu Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœ¬åœ°ç”¨æˆ·è·å¾— root æƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu kernels before 5.8.0-50.56, 5.4.0-72.80, 4.15.0-142.146, and 4.4.0-209.241

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦è¿è¡Œåœ¨å­˜åœ¨æ¼æ´çš„ Ubuntu å†…æ ¸ä¸Šï¼Œå¹¶ä¸”å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½ overlayfsã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

è¯¥æ¼æ´å­˜åœ¨äº Ubuntu Linux å†…æ ¸çš„ overlayfs å®ç°ä¸­ã€‚ç”±äº Ubuntu å¯¹ overlayfs æŒ‚è½½çš„ç‰¹å®šä¿®æ”¹ï¼Œå¯¼è‡´åœ¨ç”¨æˆ·å‘½åç©ºé—´å†…ï¼Œå¯¹åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­çš„æ–‡ä»¶ capabilities éªŒè¯ä¸å……åˆ†ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡ overlayfs æŒ‚è½½ç»•è¿‡ capabilities æ£€æŸ¥ï¼Œè®¾ç½®æ–‡ä»¶ capabilities æå‡æƒé™ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  åˆ›å»ºä¸€ä¸ªç›®å½•ç»“æ„ï¼ŒåŒ…æ‹¬ lower, upper, work å’Œ merge ç›®å½•ã€‚
2.  ä½¿ç”¨ `unshare` åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´å’ŒæŒ‚è½½å‘½åç©ºé—´ã€‚
3.  é…ç½® `/proc/self/setgroups`, `/proc/self/uid_map`, å’Œ `/proc/self/gid_map` ä»¥æ˜ å°„ç”¨æˆ· ID å’Œç»„ IDã€‚
4.  ä½¿ç”¨ `mount` å‘½ä»¤æŒ‚è½½ overlayfsï¼Œå°† lower, upper å’Œ work ç›®å½•ä¸ merge ç›®å½•å…³è”èµ·æ¥ã€‚
5.  åœ¨ upper ç›®å½•æˆ– merge ç›®å½•ä¸‹åˆ›å»ºæˆ–å¤åˆ¶ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ã€‚
6.  ä½¿ç”¨ `setxattr` è®¾ç½®å¯æ‰§è¡Œæ–‡ä»¶çš„ capabilitiesï¼Œèµ‹äºˆå…¶ root æƒé™ã€‚
7.  æ‰§è¡Œè¯¥æ–‡ä»¶ï¼Œå³å¯è·å¾— root æƒé™ã€‚

**æœ‰æ•ˆæ€§ï¼š**

æä¾›çš„ POC ä»£ç å°è¯•åˆ©ç”¨ CVE-2021-3493 æ¼æ´ã€‚è¯¥ä»£ç åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´å’ŒæŒ‚è½½å‘½åç©ºé—´ï¼Œå¹¶å°è¯•æŒ‚è½½ overlayfsã€‚ç„¶åï¼Œå®ƒåº”è¯¥è®¾ç½® `magic` äºŒè¿›åˆ¶æ–‡ä»¶çš„ capabilitiesï¼Œä»è€Œè·å¾— root æƒé™ã€‚æ ¹æ®æ¼æ´æè¿°ï¼Œè¯¥ POC åº”è¯¥èƒ½å¤Ÿæœ‰æ•ˆåˆ©ç”¨è¯¥æ¼æ´ã€‚

**æŠ•æ¯’é£é™©ï¼š**

æ£€æŸ¥æä¾›çš„ exploit.c æ–‡ä»¶ï¼Œæœªå‘ç°æ˜æ˜¾çš„æ¶æ„æˆ–éšè—ä»£ç ã€‚ä»£ç é€»è¾‘ä¸»è¦é›†ä¸­äºè®¾ç½® overlayfs æŒ‚è½½å’Œæ–‡ä»¶ capabilitiesã€‚ä½†æ˜¯ï¼Œéœ€è¦å§‹ç»ˆè°¨æ…å¯¹å¾…æ¥è‡ªä¸å—ä¿¡ä»»æ¥æºçš„ä»£ç ã€‚ä¸ºäº†ç¡®ä¿å®‰å…¨ï¼Œå»ºè®®åœ¨å—æ§ç¯å¢ƒä¸­ä»”ç»†å®¡æŸ¥å’Œæµ‹è¯•ä»£ç ã€‚


**é¡¹ç›®åœ°å€:** [Sornphut/OverlayFS---CVE-2021-3493](https://github.com/Sornphut/OverlayFS---CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #3

**æ¥æº**: [CVE-2021-3493-briskets_CVE-2021-3493.md](../2021/CVE-2021-3493-briskets_CVE-2021-3493.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å¯¼è‡´æ™®é€šç”¨æˆ·æƒé™æå‡è‡³rootæƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu kernel versions: < 5.8.0-50.56 (5.8 kernel), < 5.4.0-72.80 (5.4 kernel), < 4.15.0-142.146 (4.15 kernel), < 4.4.0-209.241 (4.4 kernel)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦åœ¨å­˜åœ¨æ¼æ´çš„Ubuntuå†…æ ¸ç‰ˆæœ¬ä¸Šï¼Œå¹¶ä¸”å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½overlayfs

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 5%

## è¯¦æƒ…

CVE-2021-3493 æ¼æ´æ˜¯ç”±äº Linux å†…æ ¸çš„ overlayfs å®ç°æ²¡æœ‰æ­£ç¡®éªŒè¯ç”¨æˆ·å‘½åç©ºé—´ä¸­åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸Šæ–‡ä»¶ capabilities çš„è®¾ç½®ã€‚ç”±äº Ubuntu å†…æ ¸ä¸­å­˜åœ¨å…è®¸éç‰¹æƒ overlay æŒ‚è½½çš„è¡¥ä¸ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´è·å¾—æå‡çš„æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  æ¼æ´åˆ©ç”¨ä»£ç é¦–å…ˆåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ (ovlcap/work, ovlcap/lower, ovlcap/upper, ovlcap/merge)ã€‚
2.  åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´å’ŒæŒ‚è½½å‘½åç©ºé—´ã€‚
3.  åœ¨æ–°çš„ç”¨æˆ·å‘½åç©ºé—´ä¸­ï¼Œå°†å½“å‰ç”¨æˆ·çš„ UID å’Œ GID æ˜ å°„åˆ° root ç”¨æˆ·ã€‚
4.  ä½¿ç”¨ overlayfs å°† lowerdir (ovlcap/lower), upperdir (ovlcap/upper) å’Œ workdir (ovlcap/work) æŒ‚è½½åˆ° mergedir (ovlcap/merge)ã€‚
5.  å¤åˆ¶è‡ªèº« (exploit ç¨‹åº) åˆ° mergedir/magicï¼Œå¹¶è®¾ç½® security.capability æ‰©å±•å±æ€§ä¸º all+epï¼Œèµ‹äºˆè¯¥æ–‡ä»¶ capabilitiesã€‚
6.  æ‰§è¡Œ mergedir/magicï¼Œç”±äº capabilities çš„è®¾ç½®ï¼Œè¯¥ç¨‹åºä¼šä»¥ root æƒé™æ‰§è¡Œã€‚
7.  æœ€åï¼Œæ‰§è¡Œ upperdir/magicï¼Œå¯åŠ¨ä¸€ä¸ª root shellã€‚

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„POCä»£ç æ˜¯æœ‰æ•ˆçš„ï¼Œèƒ½å¤Ÿåˆ©ç”¨ CVE-2021-3493 æ¼æ´åœ¨å—å½±å“çš„ Ubuntu ç³»ç»Ÿä¸Šå®ç°æœ¬åœ°ææƒã€‚

**æŠ•æ¯’é£é™©ï¼š**
è¯¥POCä»£ç çš„ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´è¿›è¡Œææƒï¼Œä½†ä»ç„¶å­˜åœ¨æ½œåœ¨çš„æŠ•æ¯’é£é™©ã€‚æ¯”å¦‚ä½œè€…å¯èƒ½åœ¨ç¼–è¯‘å’Œè¿è¡Œå‰æ·»åŠ ä¸€äº›æ¶æ„ä»£ç ï¼Œä¾‹å¦‚ï¼š

1.  **åé—¨æ¤å…¥ï¼š** åœ¨ææƒæˆåŠŸåï¼Œæ¤å…¥ä¸€ä¸ªåé—¨ç¨‹åºï¼Œå…è®¸æ”»å‡»è€…è¿œç¨‹è®¿é—®ç³»ç»Ÿã€‚
2.  **æ•°æ®çªƒå–ï¼š** åœ¨ææƒè¿‡ç¨‹ä¸­ï¼Œçªƒå–ç”¨æˆ·çš„æ•æ„Ÿæ•°æ®ã€‚
3.  **ç ´åç³»ç»Ÿï¼š** åœ¨ææƒå¤±è´¥æˆ–è€…æˆåŠŸåï¼Œç ´åç³»ç»Ÿæ–‡ä»¶æˆ–è€…é…ç½®ã€‚

è€ƒè™‘åˆ°ä»£ç ç›¸å¯¹ç®€çŸ­ä¸”åŠŸèƒ½æ˜ç¡®ï¼Œè¯„ä¼°æŠ•æ¯’é£é™©ä¸º5%ã€‚ç”¨æˆ·éœ€è¦ä»”ç»†å®¡æŸ¥ä»£ç ï¼Œå¹¶åœ¨å®‰å…¨çš„ç¯å¢ƒä¸­è¿›è¡Œæµ‹è¯•ã€‚

**é¡¹ç›®åœ°å€:** [briskets/CVE-2021-3493](https://github.com/briskets/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #4

**æ¥æº**: [CVE-2021-3493-cyberx-1_OverlayFS-CVE-2021-3493.md](../2021/CVE-2021-3493-cyberx-1_OverlayFS-CVE-2021-3493.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯ä»æ™®é€šç”¨æˆ·ææƒè‡³root

**å½±å“ç‰ˆæœ¬:** Ubuntu kernels: 5.8.0-50.56 (5.8 kernel), 5.4.0-72.80 (5.4 kernel), 4.15.0-142.146 (4.15 kernel), 4.4.0-209.241 (4.4 kernel)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦è¿è¡Œåœ¨å­˜åœ¨æ¼æ´çš„Ubuntuå†…æ ¸ç‰ˆæœ¬ä¸Šï¼Œå¯ç”¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å’Œå…è®¸éç‰¹æƒ overlay mountsã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2021-3493æ˜¯Ubuntuå†…æ ¸OverlayFSå®ç°ä¸­çš„ä¸€ä¸ªæƒé™æå‡æ¼æ´ã€‚ç”±äºoverlayfsåœ¨ç”¨æˆ·å‘½åç©ºé—´ä¸­æ²¡æœ‰æ­£ç¡®éªŒè¯åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­æ–‡ä»¶åŠŸèƒ½è®¾ç½®ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å’ŒUbuntuå†…æ ¸ä¸­çš„éç‰¹æƒoverlayæŒ‚è½½è¡¥ä¸ï¼Œè·å–æå‡çš„æƒé™ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** åœ¨å­˜åœ¨æ¼æ´çš„Ubuntuå†…æ ¸ä¸Šï¼Œç¡®ä¿å¯ç”¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´ã€‚æ¼æ´åº“ä¿¡æ¯æåˆ°ç¦ç”¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å¯ä»¥ä½œä¸ºç¼“è§£æªæ–½ï¼Œæ‰€ä»¥è¦ç¡®ä¿å¯ç”¨ã€‚
2.  **åˆ›å»ºOverlayFSç»“æ„ï¼š** PoCä»£ç é¦–å…ˆåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼ˆlower, upper, work, mergeï¼‰ç”¨äº overlayfs æ–‡ä»¶ç³»ç»Ÿã€‚
3.  **åˆ›å»ºç”¨æˆ·å‘½åç©ºé—´ï¼š** ä½¿ç”¨`unshare`ç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´ã€‚è¿™å…è®¸åœ¨æ–°çš„å‘½åç©ºé—´ä¸­æ‹¥æœ‰ä¸åŒçš„ç”¨æˆ·IDå’Œç»„IDæ˜ å°„ã€‚
4.  **è®¾ç½®UID/GIDæ˜ å°„ï¼š** å°†å½“å‰ç”¨æˆ·çš„UIDå’ŒGIDæ˜ å°„åˆ°æ–°å‘½åç©ºé—´ä¸­çš„rootç”¨æˆ· (UID 0 å’Œ GID 0)ã€‚
5.  **æŒ‚è½½OverlayFSï¼š** ä½¿ç”¨`mount`ç³»ç»Ÿè°ƒç”¨å°† overlayfs æ–‡ä»¶ç³»ç»ŸæŒ‚è½½åˆ° merge ç›®å½•ã€‚æŒ‡å®š lowerdir, upperdir å’Œ workdirã€‚
6.  **å¤åˆ¶è‡ªèº«å¹¶è®¾ç½®Capabilitiesï¼š** å°†è‡ªèº«å¯æ‰§è¡Œæ–‡ä»¶å¤åˆ¶åˆ° overlayfs çš„ merge ç›®å½•ï¼Œç„¶åä½¿ç”¨`setxattr`è®¾ç½®`security.capability`æ‰©å±•å±æ€§ï¼Œèµ‹äºˆè¯¥æ–‡ä»¶ root æƒé™ã€‚
7.  **æ‰§è¡Œææƒåçš„ç¨‹åºï¼š** é€šè¿‡æ‰§è¡Œ upper ç›®å½•ä¸‹çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆä¹‹å‰å¤åˆ¶å¹¶è®¾ç½®äº† capabilities çš„æ–‡ä»¶ï¼‰æ¥è·å– root æƒé™ã€‚è¿™ä¸ªç¨‹åºä¼šæ£€æŸ¥æ˜¯å¦æœ‰"shell"å‚æ•°ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™ä¼šé‡æ–°æ‰§è¡Œè‡ªèº«ï¼Œä½†è¿™æ¬¡ä¼šå¸¦æœ‰`shell`å‚æ•°ï¼Œä»è€Œè§¦å‘`setuid(0)`å’Œ`setgid(0)`ï¼Œæœ€ç»ˆæ‰§è¡Œ`/bin/bash`ï¼Œè·å¾— root shellã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

ä»£ç ä¸­å­˜åœ¨ä¸€å®šçš„æŠ•æ¯’é£é™©ï¼Œè™½ç„¶ä¸»è¦é€»è¾‘æ˜¯åˆ©ç”¨æ¼æ´è¿›è¡Œææƒï¼Œä½†å­˜åœ¨ä¿®æ”¹`/bin/bash`çš„å¯èƒ½æ€§ï¼Œä½†æ˜¯ç»è¿‡ä»£ç åˆ†æä»¥åŠæ¼æ´åŸç†ï¼Œåˆ¤æ–­æ¼æ´åˆ©ç”¨è¿‡ç¨‹ä¸­æ²¡æœ‰ä¿®æ”¹`/bin/bash`æ“ä½œ,ä»£ç ä¸­é£é™©ä¸»è¦å­˜åœ¨äºä»¥ä¸‹å‡ ç‚¹:

1.  **ä¾èµ–å¤–éƒ¨äºŒè¿›åˆ¶æ–‡ä»¶ï¼š** è¯¥æ¼æ´åˆ©ç”¨ä¾èµ–äºç³»ç»Ÿä¸Šçš„`/bin/bash`ã€‚å¦‚æœæ”»å‡»è€…æ›¿æ¢æˆ–ç¯¡æ”¹äº†ç›®æ ‡ç³»ç»Ÿä¸Šçš„`/bin/bash`ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ„å¤–çš„è¡Œä¸ºæˆ–å®‰å…¨é—®é¢˜ã€‚
2.  **æ¸…ç†æ“ä½œé£é™©ï¼š** ä»£ç å¼€å§‹æ—¶ä½¿ç”¨`system(buf)`æ‰§è¡Œ`rm -rf '%s/'`ï¼Œå¦‚æœ`DIR_BASE`è¢«æ¶æ„ä¿®æ”¹ï¼Œå¯èƒ½å¯¼è‡´æ„å¤–çš„æ–‡ä»¶åˆ é™¤ã€‚
3.  **ä¸å®Œå–„çš„é”™è¯¯å¤„ç†ï¼š** è™½ç„¶ PoC ä»£ç åŒ…å«äº†ä¸€äº›é”™è¯¯å¤„ç†ï¼Œä½†åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå¦‚æœé”™è¯¯å¤„ç†ä¸å½“ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ‹’ç»æœåŠ¡æˆ–æœªå®šä¹‰çš„è¡Œä¸ºã€‚

æ€»ä½“è€Œè¨€ï¼Œè¯¥ PoC ä»£ç çš„æŠ•æ¯’é£é™©è¾ƒä½ï¼Œä¸»è¦é£é™©åœ¨äºä¾èµ–å¤–éƒ¨äºŒè¿›åˆ¶æ–‡ä»¶å’Œæ½œåœ¨çš„æ¸…ç†æ“ä½œé£é™©ã€‚ä»£ç æœ¬èº«ä¸»è¦æ˜¯ä¸ºäº†æ¼”ç¤ºæ¼æ´åˆ©ç”¨ï¼Œå¹¶æœªå‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç ã€‚ è¯„ä¼°æŠ•æ¯’é£é™©ä¸º10%ã€‚


**é¡¹ç›®åœ°å€:** [cyberx-1/OverlayFS-CVE-2021-3493](https://github.com/cyberx-1/OverlayFS-CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #5

**æ¥æº**: [CVE-2021-3493-derek-turing_CVE-2021-3493.md](../2021/CVE-2021-3493-derek-turing_CVE-2021-3493.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Ubuntu Linux Kernel

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœ¬åœ°ç”¨æˆ·å¯æå‡è‡³ root æƒé™

**å½±å“ç‰ˆæœ¬:** 4.4 <= kernel < 4.4.0-209.241, 4.15 <= kernel < 4.15.0-142.146, 5.4 <= kernel < 5.4.0-72.80, 5.8 <= kernel < 5.8.0-50.56

**åˆ©ç”¨æ¡ä»¶:** Ubuntu å†…æ ¸å¼€å¯äº† unprivileged user namespaces å’Œ unprivileged overlay mounts

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

è¯¥æ¼æ´å­˜åœ¨äº Ubuntu Linux å†…æ ¸çš„ OverlayFS å®ç°ä¸­ï¼Œç”±äº overlayfs å¯¹åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­æ–‡ä»¶ capabilities çš„è®¾ç½®éªŒè¯ä¸å½“ï¼Œç»“åˆæœªæˆæƒç”¨æˆ·å‘½åç©ºé—´å’Œ Ubuntu å†…æ ¸ä¸­å…è®¸æœªæˆæƒ overlay æŒ‚è½½çš„è¡¥ä¸ï¼Œæ”»å‡»è€…å¯åˆ©ç”¨æ­¤æ¼æ´æå‡æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** é¦–å…ˆï¼Œç¡®ä¿ç›®æ ‡ç³»ç»Ÿæ»¡è¶³æ¼æ´åˆ©ç”¨çš„æ¡ä»¶ï¼Œå³ Ubuntu å†…æ ¸ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…ï¼Œå¹¶ä¸”å¯ç”¨äº† unprivileged user namespaces å’Œ unprivileged overlay mountsã€‚æ¼æ´åº“ä¿¡æ¯ä¸­ç»™å‡ºäº†å—å½±å“çš„ç‰ˆæœ¬èŒƒå›´ã€‚
2.  **åˆ›å»ºç›®å½•ç»“æ„ï¼š** åˆ›å»º overlayfs æ‰€éœ€çš„ç›®å½•ç»“æ„ï¼ŒåŒ…æ‹¬ lowerdirï¼ˆåº•å±‚ç›®å½•ï¼‰ã€upperdirï¼ˆä¸Šå±‚ç›®å½•ï¼‰ã€workdirï¼ˆå·¥ä½œç›®å½•ï¼‰å’Œ mergedirï¼ˆåˆå¹¶ç›®å½•ï¼‰ã€‚
3.  **åˆ›å»ºç”¨æˆ·å‘½åç©ºé—´ï¼š** ä½¿ç”¨ `unshare` å‘½ä»¤åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´ï¼Œè¿™å…è®¸åœ¨éç‰¹æƒç”¨æˆ·ä¸‹æ‰§è¡Œä¸€äº›ç‰¹æƒæ“ä½œã€‚
4.  **è®¾ç½® UID/GID æ˜ å°„ï¼š** åœ¨ç”¨æˆ·å‘½åç©ºé—´ä¸­ï¼Œå°†å½“å‰ç”¨æˆ·çš„ UID å’Œ GID æ˜ å°„åˆ° root ç”¨æˆ· (UID 0) å’Œ root ç»„ (GID 0)ï¼Œè¿™æ ·åœ¨ overlayfs ä¸­åˆ›å»ºçš„æ–‡ä»¶å°†å±äº root ç”¨æˆ·ã€‚
5.  **æŒ‚è½½ OverlayFSï¼š** ä½¿ç”¨ `mount` å‘½ä»¤å°† overlayfs æŒ‚è½½åˆ° mergedirï¼ŒæŒ‡å®š lowerdirã€upperdir å’Œ workdirã€‚
6.  **å¤åˆ¶å¹¶è®¾ç½® Capabilitiesï¼š** å°† exploit ç¨‹åºè‡ªèº«å¤åˆ¶åˆ° mergedir ä¸­ï¼Œå¹¶ä½¿ç”¨ `setxattr` å‘½ä»¤è®¾ç½®å…¶ security.capability æ‰©å±•å±æ€§ï¼Œèµ‹äºˆå…¶ CAP_SETUID å’Œ CAP_SETGID capabilitiesã€‚è¿™ä¸ªcapabilitieså…è®¸ç¨‹åºåœ¨æ²¡æœ‰rootæƒé™çš„æƒ…å†µä¸‹è®¾ç½®uidå’Œgidã€‚
7.  **è§¦å‘ææƒï¼š** è¿è¡Œ mergedir ä¸­çš„ exploit ç¨‹åºï¼Œç”±äºå·²è®¾ç½® capabilitiesï¼Œç¨‹åºå°†ä»¥ root æƒé™è¿è¡Œï¼Œä»è€Œæ‰§è¡Œç‰¹æƒæ“ä½œã€‚

**ä»£ç åˆ†æï¼š**

*   `exploit.c` æ˜¯åˆ©ç”¨ä»£ç ï¼Œå®ƒåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼Œå»ºç«‹ç”¨æˆ·å‘½åç©ºé—´ï¼ŒæŒ‚è½½ overlayfsï¼Œç„¶åå°†è‡ªèº«å¤åˆ¶åˆ° overlayfs ä¸­ï¼Œå¹¶è®¾ç½® capabilitiesã€‚æœ€åï¼Œæ‰§è¡Œå¤åˆ¶åˆ° upperdir ä¸­çš„ç¨‹åºï¼Œè¯¥ç¨‹åºä¼šå°†å½“å‰è¿›ç¨‹ææƒä¸º rootã€‚
*   ä»£ç ä¸­ä½¿ç”¨äº† `setxattr` å‡½æ•°æ¥è®¾ç½®æ–‡ä»¶ capabilitiesï¼Œè¿™æ˜¯åˆ©ç”¨æ¼æ´çš„å…³é”®æ­¥éª¤ã€‚
*   mainå‡½æ•°é¦–å…ˆforkä¸€ä¸ªå­è¿›ç¨‹æ‰§è¡Œexploitå‡½æ•°ï¼Œåœ¨exploitå‡½æ•°æ‰§è¡Œå®Œæ¯•åï¼Œçˆ¶è¿›ç¨‹æ‰§è¡ŒBIN_UPPERä¸­çš„magicç¨‹åºï¼Œå¦‚æœå¸¦æœ‰shellå‚æ•°ï¼Œmagicç¨‹åºä¼šè®¾ç½®uidå’Œgidä¸º0ï¼Œå¹¶ä¸”è¿è¡Œä¸€ä¸ªbash shellã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

ä»”ç»†æ£€æŸ¥äº† POC ä»£ç ï¼Œæ²¡æœ‰å‘ç°æ˜æ˜¾çš„æŠ•æ¯’ä»£ç ã€‚ä»£ç é€»è¾‘æ¸…æ™°ï¼Œä¸»è¦ç”¨äºåˆ›å»º overlayfs ç¯å¢ƒå¹¶è®¾ç½®æ–‡ä»¶ capabilities ä»¥è¿›è¡Œææƒã€‚ä½œè€…å¹¶æ²¡æœ‰å°è¯•åœ¨ä»£ç ä¸­éšè—æ¶æ„è¡Œä¸ºï¼Œä¾‹å¦‚ï¼š

*   è¿æ¥å¤–éƒ¨æœåŠ¡å™¨
*   ä¿®æ”¹ç³»ç»Ÿæ–‡ä»¶
*   å®‰è£…åé—¨
*   æ”¶é›†ç”¨æˆ·ä¿¡æ¯

å› æ­¤ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ (0%)ã€‚

**é¡¹ç›®åœ°å€:** [derek-turing/CVE-2021-3493](https://github.com/derek-turing/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #6

**æ¥æº**: [CVE-2021-3493-fathallah17_OverlayFS-CVE-2021-3493.md](../2021/CVE-2021-3493-fathallah17_OverlayFS-CVE-2021-3493.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°æƒé™æå‡

**å½±å“åº”ç”¨:** Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å¯¼è‡´æœ¬åœ°æƒé™æå‡è‡³root

**å½±å“ç‰ˆæœ¬:** 4.4 <= Linux Kernel < 5.8.0-50.56 (Ubuntu ç‰¹å®šç‰ˆæœ¬)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦å­˜åœ¨Ubuntuå†…æ ¸ä¸­å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½OverlayFSçš„è¡¥ä¸ï¼Œä¸”ç”¨æˆ·å‘½åç©ºé—´æœªè¢«ç¦ç”¨ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 1%

## è¯¦æƒ…

CVE-2021-3493 æ˜¯ä¸€ä¸ªå­˜åœ¨äº Linux å†…æ ¸ OverlayFS å®ç°ä¸­çš„æƒé™æå‡æ¼æ´ã€‚æ¼æ´çš„æ ¹æœ¬åŸå› æ˜¯ OverlayFS åœ¨è®¾ç½®åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­æ–‡ä»¶çš„ capabilities æ—¶ï¼Œæ²¡æœ‰æ­£ç¡®åœ°éªŒè¯ç”¨æˆ·å‘½åç©ºé—´ã€‚åœ¨å­˜åœ¨å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½ OverlayFS çš„ Ubuntu å†…æ ¸è¡¥ä¸çš„ç¯å¢ƒä¸­ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´è·å¾—æå‡çš„æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š**  ç›®æ ‡ç³»ç»Ÿéœ€è¦æ˜¯å—å½±å“çš„ Ubuntu ç‰ˆæœ¬ï¼Œå¹¶ä¸”å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½ OverlayFSï¼ŒåŒæ—¶ç”¨æˆ·å‘½åç©ºé—´æ²¡æœ‰è¢«ç¦ç”¨ã€‚
2.  **è·å–æ¼æ´åˆ©ç”¨ä»£ç ï¼š**  ä»å¯ä¿¡æ¥æºè·å–æ¼æ´åˆ©ç”¨ä»£ç  (ä¾‹å¦‚ SSD-Disclosure æä¾›çš„ exploit.c)ã€‚
3.  **ç¼–è¯‘æ¼æ´åˆ©ç”¨ä»£ç ï¼š**  ä½¿ç”¨ gcc ç­‰ç¼–è¯‘å™¨å°† exploit.c ç¼–è¯‘ä¸ºå¯æ‰§è¡Œæ–‡ä»¶ã€‚
4.  **æ‰§è¡Œæ¼æ´åˆ©ç”¨ä»£ç ï¼š**  è¿è¡Œç¼–è¯‘åçš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚æ¼æ´åˆ©ç”¨ä»£ç ä¼šåˆ©ç”¨ OverlayFS çš„æ¼æ´ï¼Œé€šè¿‡è®¾ç½®æ–‡ä»¶ capabilities æ¥æå‡å½“å‰ç”¨æˆ·çš„æƒé™è‡³ rootã€‚
5.  **è·å– root æƒé™ï¼š**  æˆåŠŸæ‰§è¡Œæ¼æ´åˆ©ç”¨ä»£ç åï¼Œç”¨æˆ·å°†è·å¾— root æƒé™ã€‚

**å…³äºæŠ•æ¯’é£é™©ï¼š**

æä¾›çš„POCä»£ç åªæ˜¯ä¸€ä¸ªç®€å•çš„åˆ©ç”¨æ–¹å¼,ä¸å¤ªå¯èƒ½åŒ…å«æ¶æ„ä»£ç ã€‚ä½†å§‹ç»ˆéœ€è¦å¯¹ä»»ä½•æ¥æºçš„æ¼æ´åˆ©ç”¨ä»£ç è¿›è¡Œå®¡æŸ¥ï¼Œä»¥é™ä½é£é™©ã€‚
å¯¹ä¸‹è½½çš„æ–‡ä»¶è¿›è¡Œæ£€æŸ¥ï¼Œå¦‚å“ˆå¸Œæ ¡éªŒï¼Œå¯ä»¥æœ€å¤§ç¨‹åº¦çš„é¿å…å¼•å…¥æ¶æ„ä»£ç ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**

æ ¹æ®æ¼æ´æè¿°å’Œåˆ©ç”¨ä»£ç ï¼Œè¯¥æ¼æ´åˆ©ç”¨æ˜¯æœ‰æ•ˆçš„ã€‚åˆ©ç”¨ä»£ç é€šè¿‡OverlayFSçš„æ¼æ´ï¼Œå…è®¸ä½æƒé™ç”¨æˆ·è·å¾—rootæƒé™ã€‚

**å…¶ä»–ä¿¡æ¯:**
CISA å·²å°†æ­¤æ¼æ´æ·»åŠ åˆ°å·²çŸ¥è¢«åˆ©ç”¨çš„æ¼æ´ç›®å½• (KEV) ä¸­ï¼Œè¡¨æ˜è¯¥æ¼æ´å·²è¢«å¹¿æ³›åˆ©ç”¨ã€‚

**é¡¹ç›®åœ°å€:** [fathallah17/OverlayFS-CVE-2021-3493](https://github.com/fathallah17/OverlayFS-CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #7

**æ¥æº**: [CVE-2021-3493-fei9747_CVE-2021-3493.md](../2021/CVE-2021-3493-fei9747_CVE-2021-3493.md)

## CVE-2021-3493 Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ”»å‡»è€…å¯åˆ©ç”¨æ­¤æ¼æ´è·å– root æƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu kernel versions: < 5.8.0-50.56, < 5.4.0-72.80, < 4.15.0-142.146, < 4.4.0-209.241

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦åœ¨å­˜åœ¨æ¼æ´çš„ Ubuntu ç³»ç»Ÿä¸Šæœ¬åœ°æ‰§è¡Œ

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 5%

## è¯¦æƒ…

CVE-2021-3493 æ˜¯ä¸€ä¸ªå­˜åœ¨äº Ubuntu Linux å†…æ ¸ overlayfs å®ç°ä¸­çš„æœ¬åœ°ææƒæ¼æ´ã€‚è¯¥æ¼æ´æºäº overlayfs æœªèƒ½æ­£ç¡®éªŒè¯ç”¨æˆ·å‘½åç©ºé—´ä¸­åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸Šæ–‡ä»¶ capabilities çš„è®¾ç½®ã€‚ç»“åˆæœªæˆæƒç”¨æˆ·å‘½åç©ºé—´ä»¥åŠ Ubuntu å†…æ ¸ä¸­å…è®¸æœªæˆæƒ overlay mount çš„è¡¥ä¸ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´æå‡æƒé™ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼ŒåŒ…æ‹¬lowerdirï¼Œupperdirï¼Œworkdirå’Œmergedirã€‚
2.  **åˆ›å»ºå‘½åç©ºé—´ï¼š** ä½¿ç”¨ `unshare` ç³»ç»Ÿè°ƒç”¨åˆ›å»ºæ–°çš„ç”¨æˆ·å‘½åç©ºé—´å’ŒæŒ‚è½½å‘½åç©ºé—´ã€‚
3.  **è®¾ç½®ç”¨æˆ·å’Œç»„IDæ˜ å°„ï¼š** å°†å½“å‰ç”¨æˆ·çš„ UID å’Œ GID æ˜ å°„åˆ°æ–°çš„ç”¨æˆ·å‘½åç©ºé—´ä¸­ï¼Œä»¥ä¾¿åœ¨æ–°çš„å‘½åç©ºé—´ä¸­æ‹¥æœ‰æƒé™ã€‚
4.  **æŒ‚è½½ OverlayFSï¼š** ä½¿ç”¨ `mount` ç³»ç»Ÿè°ƒç”¨ï¼Œå°† overlayfs æŒ‚è½½åˆ° mergedirï¼Œå¹¶å°† lowerdirï¼Œupperdir å’Œ workdir æŒ‡å®šä¸ºç›¸åº”çš„ç›®å½•ã€‚
5.  **è®¾ç½® Capabilitiesï¼š** å¤åˆ¶å½“å‰æ‰§è¡Œçš„ç¨‹åºåˆ° mergedirï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½®è¯¥æ–‡ä»¶çš„ capabilitiesï¼Œä½¿å…¶å…·æœ‰ root æƒé™ã€‚ è¿™æ­¥æ˜¯æ¼æ´åˆ©ç”¨çš„å…³é”®ã€‚
6.  **æ‰§è¡ŒPayloadï¼š** æ‰§è¡Œupperç›®å½•ä¸­çš„æ–‡ä»¶ï¼Œå› ä¸ºè®¾ç½®äº†Capabilitiesï¼Œå¯ä»¥è·å¾—rootæƒé™ã€‚

**æœ‰æ•ˆæ€§ï¼š**

æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’ŒPOCä»£ç æè¿°ï¼Œè¯¥æ¼æ´åœ¨ç‰¹å®šç‰ˆæœ¬çš„ Ubuntu å†…æ ¸ä¸Šæ˜¯å¯åˆ©ç”¨çš„ã€‚æä¾›çš„POCä»£ç å±•ç¤ºäº†åˆ©ç”¨è¯¥æ¼æ´æå‡æƒé™çš„å®Œæ•´è¿‡ç¨‹ã€‚

**æŠ•æ¯’é£é™©ï¼š**

ä»£ç ä¸­å­˜åœ¨æ½œåœ¨çš„æŠ•æ¯’é£é™©ï¼Œä½†æ˜¯é£é™©è¾ƒä½ã€‚ä¸»è¦é›†ä¸­åœ¨ç¼–è¯‘å’Œè¿è¡Œexploitæ—¶ã€‚æ”»å‡»è€…å¯èƒ½é€šè¿‡ä¿®æ”¹ exploit.c æ–‡ä»¶ï¼Œä¾‹å¦‚æ·»åŠ æ¶æ„ä»£ç æˆ–åé—¨ï¼Œä»è€Œåœ¨ç›®æ ‡ç³»ç»Ÿä¸Šæ‰§è¡Œæ¶æ„æ“ä½œã€‚ä½†æ˜¯æ ¹æ®æä¾›çš„POCä»£ç æ¥çœ‹, é£é™©ç³»æ•°è¾ƒä½.

**é£é™©è¯„ä¼°ï¼š**

è¯¥æ¼æ´åˆ©ç”¨çš„æˆåŠŸå–å†³äºç›®æ ‡ç³»ç»Ÿæ˜¯å¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š

*   è¿è¡Œå—å½±å“çš„ Ubuntu å†…æ ¸ç‰ˆæœ¬ã€‚
*   å¯ç”¨äº†æœªæˆæƒç”¨æˆ·å‘½åç©ºé—´å’Œ overlayfs mountã€‚
*   ç›®æ ‡ç³»ç»Ÿä¸Šå­˜åœ¨ `gcc` ç¼–è¯‘å™¨, èƒ½å¤Ÿç¼–è¯‘exploitã€‚

å¦‚æœç›®æ ‡ç³»ç»Ÿæ»¡è¶³è¿™äº›æ¡ä»¶ï¼Œæ”»å‡»è€…å¯ä»¥ä½¿ç”¨æä¾›çš„ POC ä»£ç æˆåŠŸåˆ©ç”¨è¯¥æ¼æ´ï¼Œä»è€Œè·å¾— root æƒé™ã€‚


**é¡¹ç›®åœ°å€:** [fei9747/CVE-2021-3493](https://github.com/fei9747/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #8

**æ¥æº**: [CVE-2021-3493-iamz24_CVE-2021-3493_CVE-2022-3357.md](../2021/CVE-2021-3493-iamz24_CVE-2021-3493_CVE-2022-3357.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒæ¼æ´

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å¯¼è‡´æœ¬åœ°æƒé™æå‡è‡³ root

**å½±å“ç‰ˆæœ¬:** Ubuntu kernels < 5.8.0-50.56, < 5.4.0-72.80, < 4.15.0-142.146, < 4.4.0-209.241

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç›®æ ‡ç³»ç»Ÿå¼€å¯ unprivileged user namespaces å’Œå­˜åœ¨ OverlayFS æœåŠ¡ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2021-3493 æ¼æ´æ˜¯ Linux å†…æ ¸ overlayfs å®ç°ä¸­ï¼Œåœ¨ç”¨æˆ·å‘½åç©ºé—´ä¸­å¯¹åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­çš„æ–‡ä»¶ capabilities éªŒè¯ä¸å½“å¯¼è‡´çš„ã€‚ç”±äº Ubuntu å†…æ ¸ä¸­å­˜åœ¨å…è®¸éç‰¹æƒ overlay æŒ‚è½½çš„è¡¥ä¸ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¯¥æ¼æ´æå‡æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** æ£€æŸ¥ç›®æ ‡ç³»ç»Ÿæ˜¯å¦å­˜åœ¨ overlayfs æœåŠ¡ï¼Œå¦‚æœæ²¡æœ‰åˆ™åŠ è½½ overlay æ¨¡å—ã€‚åŒæ—¶ï¼Œç¡®ä¿å¼€å¯äº† unprivileged user namespacesã€‚
2.  **ç¼–è¯‘ Payloadï¼š** ä½¿ç”¨ GCC ç¼–è¯‘æä¾›çš„ `payload.c` æ–‡ä»¶ã€‚
3.  **è¿è¡Œ Payloadï¼š** è¿è¡Œç¼–è¯‘åçš„å¯æ‰§è¡Œæ–‡ä»¶ `a.out`ã€‚
4.  **è·å– Root Shellï¼š** Payload ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å‘½åç©ºé—´ï¼ŒæŒ‚è½½ overlayfsï¼Œè®¾ç½® capabilityï¼Œæœ€ç»ˆæ‰§è¡Œä¸€ä¸ªå…·æœ‰ root æƒé™çš„ shellã€‚

**æœ‰æ•ˆæ€§ï¼š**

æä¾›çš„ POC ä»£ç åŸºæœ¬æœ‰æ•ˆï¼Œèƒ½å¤Ÿåˆ©ç”¨è¯¥æ¼æ´åœ¨ç¬¦åˆæ¡ä»¶çš„ Ubuntu ç³»ç»Ÿä¸Šå®ç°æœ¬åœ°ææƒã€‚

**æŠ•æ¯’é£é™©ï¼š**

å­˜åœ¨è¾ƒä½çš„æŠ•æ¯’é£é™©ï¼ˆ10%ï¼‰ã€‚è™½ç„¶ä»£ç çš„ä¸»è¦åŠŸèƒ½æ˜¯å®ç°ææƒï¼Œä½†ä»ç„¶éœ€è¦è°¨æ…å¯¹å¾…æ¥æºä¸æ˜çš„ä»£ç ï¼Œä½œè€…å¯èƒ½ä¼šåœ¨å…¶ä¸­éšè—ä¸€äº›æ¶æ„è¡Œä¸ºï¼Œæ¯”å¦‚ä¸Šä¼ æ•æ„Ÿä¿¡æ¯ç­‰ã€‚ç‰¹åˆ«æ˜¯éœ€è¦æ£€æŸ¥ `exploit`å‡½æ•°ä¸­çš„ç›¸å…³æ–‡ä»¶æ“ä½œå’Œå‘½ä»¤æ‰§è¡Œæ˜¯å¦å­˜åœ¨æ¶æ„è¡Œä¸ºã€‚å°¤å…¶å…³æ³¨`system(buf);`æ˜¯å¦ä¼šæ‰§è¡Œæ¶æ„çš„æŒ‡ä»¤ã€‚

**æ€»ç»“ï¼š**

è¯¥æ¼æ´åˆ©ç”¨è¾ƒä¸ºç›´æ¥ï¼Œåˆ©ç”¨æ¡ä»¶ç›¸å¯¹æ˜ç¡®ï¼Œä½†éœ€è¦æ³¨æ„æ½œåœ¨çš„æŠ•æ¯’é£é™©ã€‚åœ¨å®é™…ä½¿ç”¨æ—¶ï¼Œåº”è¯¥ä»”ç»†å®¡æŸ¥ä»£ç ï¼Œç¡®ä¿æ²¡æœ‰æ¶æ„è¡Œä¸ºã€‚

**é¡¹ç›®åœ°å€:** [iamz24/CVE-2021-3493_CVE-2022-3357](https://github.com/iamz24/CVE-2021-3493_CVE-2022-3357)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #9

**æ¥æº**: [CVE-2021-3493-inspiringz_CVE-2021-3493.md](../2021/CVE-2021-3493-inspiringz_CVE-2021-3493.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Ubuntu Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸ä½æƒé™ç”¨æˆ·æå‡åˆ°rootæƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu 4.4, 4.15, 5.4, 5.8 kernels (å—å½±å“ç‰ˆæœ¬è¯¦è§æ¼æ´åº“ä¿¡æ¯)

**åˆ©ç”¨æ¡ä»¶:** Ubuntuå†…æ ¸ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…ï¼Œå¯ç”¨æœªæˆæƒç”¨æˆ·å‘½åç©ºé—´ï¼Œå…è®¸æœªæˆæƒOverlayFSæŒ‚è½½ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 5%

## è¯¦æƒ…

CVE-2021-3493æ˜¯Ubuntuå†…æ ¸ä¸­OverlayFSå®ç°çš„ä¸€ä¸ªæ¼æ´ï¼Œå…è®¸ä½æƒé™ç”¨æˆ·é€šè¿‡åˆ©ç”¨user namespaceå’ŒOverlayFSæŒ‚è½½ç»•è¿‡æ–‡ä»¶ç³»ç»Ÿæƒé™æ£€æŸ¥æ¥æå‡æƒé™ã€‚ 

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡:** æ¼æ´åˆ©ç”¨éœ€è¦å­˜åœ¨Ubuntuç³»ç»Ÿï¼Œä¸”å†…æ ¸ç‰ˆæœ¬åœ¨æ¼æ´åº“ä¿¡æ¯ä¸­æè¿°çš„å—å½±å“èŒƒå›´å†…ï¼Œå¹¶ä¸”éœ€è¦å¯ç”¨æœªæˆæƒç”¨æˆ·å‘½åç©ºé—´(unprivileged user namespaces)ã€‚æ­¤å¤–ï¼Œä¸ºäº†åˆ©ç”¨OverlayFSï¼Œç³»ç»Ÿéœ€è¦é…ç½®å…è®¸æœªæˆæƒç”¨æˆ·è¿›è¡ŒOverlayFSæŒ‚è½½ã€‚
2.  **æ¼æ´åˆ©ç”¨:**  æ”»å‡»è€…é¦–å…ˆåˆ›å»ºä¸€ä¸ªåŒ…å«lower, upper, workç›®å½•çš„OverlayFSç»“æ„ã€‚
3.  **åˆ©ç”¨è¿‡ç¨‹:** åˆ©ç”¨`unshare`ç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€ä¸ªæ–°çš„user namespaceå’Œmount namespaceã€‚ åœ¨æ–°namespaceä¸­ï¼Œå°†è‡ªå·±çš„UIDå’ŒGIDæ˜ å°„åˆ°rootæƒé™ã€‚ ç„¶åï¼Œä½¿ç”¨æ„é€ çš„lowerdirã€upperdirå’ŒworkdiræŒ‚è½½OverlayFSæ–‡ä»¶ç³»ç»Ÿã€‚ æ”»å‡»è€…å°†ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶å¤åˆ¶åˆ°OverlayFSçš„mergeç›®å½•ä¸­ã€‚å…³é”®çš„ä¸€æ­¥æ˜¯ï¼Œæ”»å‡»è€…ä½¿ç”¨`setxattr`ç³»ç»Ÿè°ƒç”¨ï¼Œè®¾ç½®è¯¥å¯æ‰§è¡Œæ–‡ä»¶çš„`security.capability`æ‰©å±•å±æ€§ï¼Œèµ‹äºˆå®ƒ`CAP_SETUID`å’Œ`CAP_SETGID`èƒ½åŠ›ã€‚ ç”±äºOverlayFSçš„æƒé™éªŒè¯ä¸å®Œå–„ï¼Œè¿™ä¸ªæ“ä½œå³ä½¿åœ¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´ä¸­ä¹Ÿèƒ½æˆåŠŸã€‚å½“æ‰§è¡Œè¯¥æ–‡ä»¶æ—¶ï¼Œå®ƒå°†è·å¾—rootæƒé™ï¼Œå¹¶å¯ä»¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚
4.  **POCä»£ç åˆ†æ:** `exploit.c` ä»£ç é¦–å…ˆåˆ›å»ºä¸€ä¸ªoverlayfsç›®å½•ç»“æ„ã€‚ç„¶åï¼Œä½¿ç”¨ `unshare` ç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€ä¸ªæ–°çš„ user namespace å’Œ mount namespaceï¼Œå¹¶å°†å½“å‰ç”¨æˆ·çš„ uid å’Œ gid æ˜ å°„åˆ° root ç”¨æˆ·ã€‚ ä¹‹åï¼Œå®ƒæŒ‚è½½ overlayfsï¼Œå¤åˆ¶å½“å‰æ‰§è¡Œçš„ç¨‹åºåˆ° overlayfs çš„ merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½® capabilityã€‚æœ€åï¼Œæ‰§è¡Œå¤åˆ¶åˆ° overlayfs çš„ç¨‹åºã€‚
5. **æŠ•æ¯’é£é™©åˆ†æ:** ä»£ç æœ¬èº«å®ç°äº†æ¼æ´åˆ©ç”¨çš„åŠŸèƒ½ã€‚ æ½œåœ¨çš„æŠ•æ¯’é£é™©å¯èƒ½å­˜åœ¨äºä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š
    *   **ä¾èµ–é¡¹:**  ä»£ç ä¾èµ–äºæ ‡å‡†çš„Cåº“ï¼Œæœ¬èº«ä¸å­˜åœ¨æ¶æ„ä¾èµ–ã€‚ä½†ç”¨æˆ·åœ¨ç¼–è¯‘æ—¶éœ€è¦æ³¨æ„ç¼–è¯‘å™¨ç¯å¢ƒçš„å®‰å…¨æ€§ã€‚
    *   **ä»£ç é€»è¾‘:**  ä»£ç é€»è¾‘ç›¸å¯¹ç®€å•ï¼Œä¸»è¦é›†ä¸­åœ¨namespaceåˆ›å»ºã€æŒ‚è½½å’Œcapabilityè®¾ç½®ã€‚ ä»”ç»†å®¡æŸ¥ä»£ç ï¼Œæœªå‘ç°æ˜æ˜¾çš„æ¶æ„é€»è¾‘ã€‚
    *   **æ‰§è¡Œå‘½ä»¤:**  ä»£ç ä¸­ä½¿ç”¨äº† `system` å‡½æ•°ï¼Œè¿™æ˜¯ä¸€ä¸ªæ½œåœ¨çš„é£é™©ç‚¹ï¼Œå¯ä»¥æ‰§è¡Œä»»æ„ç³»ç»Ÿå‘½ä»¤ã€‚ä½†æ˜¯ï¼Œè¿™é‡Œåªæ˜¯ç”¨æ¥åˆ é™¤ç›®å½•ï¼Œç›¸å¯¹å®‰å…¨ã€‚
       ç»¼ä¸Šæ‰€è¿°ï¼Œè¯¥POCä»£ç ä¸»è¦é£é™©åœ¨äºç¡®ä¿ç¼–è¯‘ç¯å¢ƒå®‰å…¨ä»¥åŠå¯¹ä¸ç†Ÿæ‚‰çš„å‘½ä»¤ä¿æŒè­¦æƒ•ã€‚æŠ•æ¯’é£é™©è¾ƒä½ï¼Œé¢„ä¼°ä¸º5%ã€‚

**æ€»ç»“ï¼š**

è¯¥æ¼æ´åˆ©ç”¨çš„æ ¸å¿ƒåœ¨äºç»“åˆäº†æœªæˆæƒç”¨æˆ·å‘½åç©ºé—´å’ŒOverlayFSï¼Œåˆ©ç”¨OverlayFSå¯¹capabilitiesè®¾ç½®éªŒè¯çš„ç¼ºé™·ï¼Œå®ç°äº†æœ¬åœ°ææƒã€‚ æ”»å‡»è€…é€šè¿‡åˆ›å»ºç‰¹æ®Šçš„OverlayFSç»“æ„å¹¶è®¾ç½®æ–‡ä»¶capabilitiesï¼Œæœ€ç»ˆè·å¾—rootæƒé™ã€‚

**é¡¹ç›®åœ°å€:** [inspiringz/CVE-2021-3493](https://github.com/inspiringz/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #10

**æ¥æº**: [CVE-2021-3493-oneoy_CVE-2021-3493.md](../2021/CVE-2021-3493-oneoy_CVE-2021-3493.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœ¬åœ°ç”¨æˆ·å¯æå‡è‡³ root æƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu 4.4, 4.15, 5.4, and 5.8 kernels (å…·ä½“ç‰ˆæœ¬å·è§æ¼æ´åº“ä¿¡æ¯)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç›®æ ‡ç³»ç»Ÿå­˜åœ¨æœªä¿®å¤çš„ Ubuntu kernelï¼Œä¸”å¯ç”¨ unprivileged user namespaces å’Œå…è®¸ unprivileged overlayfs mountsã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

è¯¥æ¼æ´å­˜åœ¨äº Ubuntu å†…æ ¸çš„ OverlayFS å®ç°ä¸­ï¼Œç”±äºæœªæ­£ç¡®éªŒè¯ç”¨æˆ·å‘½åç©ºé—´ä¸­åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸Šæ–‡ä»¶ capabilities çš„è®¾ç½®ï¼Œå¯¼è‡´æœ¬åœ°æ”»å‡»è€…å¯åˆ©ç”¨ unprivileged user namespaces å’Œ Ubuntu å†…æ ¸ä¸­å…è®¸ unprivileged overlayfs mounts çš„è¡¥ä¸æ¥æå‡æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ (lower, upper, work, merge)ã€‚
2.  **é…ç½® User Namespace:** åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´ã€‚
3.  **é…ç½® OverlayFS:** ä½¿ç”¨ lowerdir, upperdir, å’Œ workdir é€‰é¡¹æŒ‚è½½ overlay æ–‡ä»¶ç³»ç»Ÿã€‚
4.  **è®¾ç½® Capabilities:** å°†å¯æ‰§è¡Œæ–‡ä»¶å¤åˆ¶åˆ° merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½®å…¶ capabilities (å¦‚ CAP_SETUID, CAP_SETGID, CAP_CHOWN)ã€‚
5.  **è§¦å‘ææƒ:** æ‰§è¡Œ merge ç›®å½•ä¸­çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶å°†ä¼šä»¥ root æƒé™æ‰§è¡Œã€‚

**æŠ•æ¯’é£é™©è¯„ä¼°ï¼š**

æä¾›çš„ `exploit.c` ä»£ç ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨ OverlayFS çš„æ¼æ´è¿›è¡Œææƒã€‚ä»£ç åˆ›å»ºå¿…è¦çš„ç›®å½•ï¼Œé…ç½® user namespace å’Œ overlay æ–‡ä»¶ç³»ç»Ÿï¼Œå¹¶è®¾ç½®å¯æ‰§è¡Œæ–‡ä»¶çš„ capabilitiesã€‚ä»£ç é€»è¾‘æ¸…æ™°ï¼Œæ²¡æœ‰å‘ç°æ¶æ„ä»£ç æˆ–åé—¨ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**

æä¾›çš„ POC ä»£ç åŸºäºå…¬å¼€ä¿¡æ¯ï¼Œå¹¶é’ˆå¯¹ CVE-2021-3493 æ¼æ´è¿›è¡Œäº†åˆ©ç”¨ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯ã€æœç´¢å¼•æ“ç»“æœå’Œä»£ç åˆ†æï¼Œè¯¥ POC ä»£ç åœ¨æ»¡è¶³æ¼æ´åˆ©ç”¨æ¡ä»¶çš„æƒ…å†µä¸‹åº”è¯¥æ˜¯æœ‰æ•ˆçš„ã€‚

**é¡¹ç›®åœ°å€:** [oneoy/CVE-2021-3493](https://github.com/oneoy/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #11

**æ¥æº**: [CVE-2021-3493-pmihsan_OverlayFS-CVE-2021-3493.md](../2021/CVE-2021-3493-pmihsan_OverlayFS-CVE-2021-3493.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœ¬åœ°ç”¨æˆ·å¯æå‡è‡³ root æƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu kernel versions: < 5.8.0-50.56 (5.8 kernel), < 5.4.0-72.80 (5.4 kernel), < 4.15.0-142.146 (4.15 kernel), < 4.4.0-209.241 (4.4 kernel)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦åœ¨å­˜åœ¨æ¼æ´çš„ Ubuntu ç³»ç»Ÿä¸Šæ‰§è¡Œï¼Œå¹¶ä¸”å…è®¸ unprivileged user namespaces å’Œ overlay mountsã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

CVE-2021-3493 æ¼æ´å­˜åœ¨äº Linux å†…æ ¸çš„ overlayfs å®ç°ä¸­ã€‚ç”±äºå¯¹ç”¨æˆ·å‘½åç©ºé—´ä¸­åº•å±‚æ–‡ä»¶ç³»ç»Ÿæ–‡ä»¶ capabilities çš„éªŒè¯ä¸è¶³ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡åˆ›å»ºæ¶æ„çš„ overlayfs æ–‡ä»¶ç³»ç»Ÿï¼Œåˆ©ç”¨ setxattr è®¾ç½®æ–‡ä»¶ capabilitiesï¼Œä»è€Œè·å¾—æå‡çš„æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** åˆ›å»º overlayfs æ‰€éœ€çš„ç›®å½•ç»“æ„ (lower, upper, work, merge)ã€‚
2.  **Namespace åˆ›å»ºï¼š** åˆ›å»ºæ–°çš„ user namespace å’Œ mount namespaceï¼Œéš”ç¦»æƒé™ã€‚
3.  **æƒé™è®¾ç½®ï¼š** ä¿®æ”¹ uid_map å’Œ gid_mapï¼Œä½¿å¾—åœ¨ user namespace ä¸­æ‹¥æœ‰ root æƒé™ã€‚
4.  **Overlayfs Mountï¼š** ä½¿ç”¨ overlayfs mount å‘½ä»¤å°† lowerdir, upperdir, workdir æŒ‚è½½åˆ° mergedirã€‚
5.  **Capabilities è®¾ç½®ï¼š** å¤åˆ¶è‡ªèº«ç¨‹åºåˆ° merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` å‡½æ•°ä¸ºå¤åˆ¶åçš„ç¨‹åºè®¾ç½® capabilities (CAP_SETUID, CAP_SETGID, CAP_DAC_OVERRIDE ç­‰)ã€‚
6.  **æƒé™æå‡ï¼š** æ‰§è¡Œ merge ç›®å½•ä¸‹çš„ç¨‹åºï¼Œæ­¤æ—¶ç¨‹åºå°†ä»¥ root æƒé™è¿è¡Œã€‚

**æœ‰æ•ˆæ€§ï¼š**

æä¾›çš„ POC ä»£ç é€šè¿‡åˆ©ç”¨ overlayfs æ¼æ´ï¼Œå¯ä»¥æˆåŠŸåœ°æå‡æƒé™ã€‚POC ä»£ç é¦–å…ˆåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼Œç„¶ååˆ›å»ºä¸€ä¸ªæ–°çš„ user namespace å’Œ mount namespaceï¼Œæ¥ç€æŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿï¼Œå¹¶ä½¿ç”¨ `setxattr` å‡½æ•°ä¸ºæ–‡ä»¶è®¾ç½® capabilitiesã€‚æœ€åï¼Œæ‰§è¡Œè¯¥æ–‡ä»¶å³å¯è·å¾— root æƒé™ã€‚

**æŠ•æ¯’é£é™©ï¼š**

åˆ†æ POC ä»£ç ï¼Œæ²¡æœ‰å‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç ï¼Œä¾‹å¦‚åå¼¹ shellã€å®‰è£…åé—¨ç­‰ã€‚ä»£ç é€»è¾‘ä¸»è¦é›†ä¸­åœ¨åˆ©ç”¨ overlayfs æ¼æ´ææƒï¼Œå¹¶æ²¡æœ‰é¢å¤–çš„æ“ä½œæ¥æ¤å…¥æ¶æ„ç¨‹åºã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ï¼Œå¯ä»¥è®¤ä¸ºæ˜¯ 0%ã€‚å‚è€ƒçš„ vulnerability description å’Œ exploit ä»£ç éƒ½ç€é‡äºææƒï¼Œè€Œæ²¡æœ‰æåˆ°ä»»ä½•æŠ•æ¯’è¡Œä¸ºã€‚

**é¡¹ç›®åœ°å€:** [pmihsan/OverlayFS-CVE-2021-3493](https://github.com/pmihsan/OverlayFS-CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #12

**æ¥æº**: [CVE-2021-3493-ptkhai15_OverlayFS---CVE-2021-3493.md](../2021/CVE-2021-3493-ptkhai15_OverlayFS---CVE-2021-3493.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Ubuntu Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœ¬åœ°ç”¨æˆ·æå‡æƒé™è‡³ root

**å½±å“ç‰ˆæœ¬:** Ubuntu kernel versions 5.8, 5.4, 4.15, å’Œ 4.4 ä¸­å—å½±å“çš„ç‰ˆæœ¬ï¼ˆå…·ä½“ç‰ˆæœ¬å‚è§æ¼æ´åº“ä¿¡æ¯ï¼‰

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡ç³»ç»Ÿå¿…é¡»æ˜¯å—å½±å“çš„ Ubuntu ç‰ˆæœ¬ï¼Œå¹¶ä¸”å¯ç”¨äº†éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å’Œéç‰¹æƒ overlayfs æŒ‚è½½ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

CVE-2021-3493 æ˜¯ Ubuntu Linux å†…æ ¸ä¸­ OverlayFS å®ç°ä¸­çš„ä¸€ä¸ªæ¼æ´ã€‚è¯¥æ¼æ´å…è®¸éç‰¹æƒç”¨æˆ·åˆ©ç”¨ç”¨æˆ·å‘½åç©ºé—´å’Œéç‰¹æƒ overlayfs æŒ‚è½½ï¼Œé€šè¿‡ä¸æ­£ç¡®åœ°éªŒè¯åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­æ–‡ä»¶çš„ capabilities è®¾ç½®æ¥æå‡æƒé™ã€‚åˆ©ç”¨æ–¹å¼å¦‚ä¸‹ï¼š

1.  **ç¯å¢ƒå‡†å¤‡ï¼š**  åˆ›å»ºä¸€ä¸ªåŸºç¡€ç›®å½•ç»“æ„ï¼ŒåŒ…æ‹¬ workã€lowerã€upper å’Œ merge ç›®å½•ï¼Œè¿™æ˜¯ overlayfs çš„æ ‡å‡†é…ç½®ã€‚
2.  **åˆ›å»ºç”¨æˆ·å‘½åç©ºé—´ï¼š**  ä½¿ç”¨ `unshare` å‘½ä»¤åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´ã€‚è¿™å…è®¸åœ¨æ–°çš„å‘½åç©ºé—´ä¸­æ‹¥æœ‰ä¸åŒçš„ç”¨æˆ·å’Œç»„ IDã€‚
3.  **é…ç½®ç”¨æˆ·å’Œç»„æ˜ å°„ï¼š**  é€šè¿‡ `/proc/self/setgroups`ã€`/proc/self/uid_map` å’Œ `/proc/self/gid_map` æ–‡ä»¶è®¾ç½®ç”¨æˆ·å’Œç»„ ID æ˜ å°„ï¼Œå°†å½“å‰ç”¨æˆ·çš„ UID å’Œ GID æ˜ å°„åˆ°æ–°å‘½åç©ºé—´ä¸­çš„ root ç”¨æˆ·ã€‚
4.  **æŒ‚è½½ OverlayFSï¼š**  ä½¿ç”¨ `mount` å‘½ä»¤æŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿï¼Œå°† lowerã€upper å’Œ work ç›®å½•å…³è”èµ·æ¥ã€‚
5.  **è®¾ç½®æ–‡ä»¶ capabilitiesï¼š**  å¤åˆ¶å½“å‰æ‰§è¡Œç¨‹åºåˆ° overlayfs çš„ merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½®æ–‡ä»¶çš„ capabilities ä¸º `all+ep`ï¼Œå…è®¸è¯¥æ–‡ä»¶æ‰§è¡Œæ—¶æ‹¥æœ‰ root æƒé™ã€‚
6.  **æ‰§è¡Œææƒåçš„ç¨‹åºï¼š**  æ‰§è¡Œä½äº upper ç›®å½•ä¸­çš„å¤åˆ¶åçš„ç¨‹åºã€‚å¦‚æœç¨‹åºæ£€æµ‹åˆ°è‡ªå·±æ˜¯é€šè¿‡ç‰¹å®šæ–¹å¼ï¼ˆä¾‹å¦‚ï¼ŒåŒ…å« "magic" å­—ç¬¦ä¸²æˆ–æ¥å— "shell" å‚æ•°ï¼‰è°ƒç”¨çš„ï¼Œå®ƒä¼šè°ƒç”¨ `setuid(0)` å’Œ `setgid(0)` å°†è¿›ç¨‹çš„ UID å’Œ GID è®¾ç½®ä¸º 0 (root)ï¼Œå¹¶å¯åŠ¨ä¸€ä¸ª root shellã€‚

**å…³äºæŠ•æ¯’é£é™©ï¼š**

åœ¨æä¾›çš„ POC ä»£ç ä¸­ï¼Œæ²¡æœ‰æ˜æ˜¾çš„æŠ•æ¯’ä»£ç ã€‚POC çš„ç›®çš„æ˜¯æ¼”ç¤ºæ¼æ´åˆ©ç”¨è¿‡ç¨‹ï¼Œæ²¡æœ‰å‘ç°æ¶æ„è¡Œä¸ºï¼Œä¾‹å¦‚åå‘ shell æˆ–å…¶ä»–æœªç»æˆæƒçš„è®¿é—®ã€‚


**é¡¹ç›®åœ°å€:** [ptkhai15/OverlayFS---CVE-2021-3493](https://github.com/ptkhai15/OverlayFS---CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #13

**æ¥æº**: [CVE-2021-3493-puckiestyle_CVE-2021-3493.md](../2021/CVE-2021-3493-puckiestyle_CVE-2021-3493.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ”»å‡»è€…å¯åˆ©ç”¨æ­¤æ¼æ´è·å¾— root æƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu 5.8 kernel (< 5.8.0-50.56), 5.4 kernel (< 5.4.0-72.80), 4.15 kernel (< 4.15.0-142.146), 4.4 kernel (< 4.4.0-209.241)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ Ubuntu ç³»ç»Ÿå¼€å¯ unprivileged user namespaces å’Œå…è®¸ unprivileged overlay mounts

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2021-3493 æ˜¯ Ubuntu å†…æ ¸ overlayfs å®ç°ä¸­çš„ä¸€ä¸ªæ¼æ´ï¼Œå…è®¸æœ¬åœ°æ”»å‡»è€…é€šè¿‡æ»¥ç”¨ user namespaces å’Œ overlayfs æŒ‚è½½æœºåˆ¶æå‡æƒé™ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**
æä¾›çš„ POC ä»£ç å°è¯•åˆ©ç”¨è¯¥æ¼æ´ï¼Œé€šè¿‡åˆ›å»º user namespace å’Œ overlayfs æ–‡ä»¶ç³»ç»Ÿæ¥è®¾ç½®å¯æ‰§è¡Œæ–‡ä»¶çš„ capability ä½ï¼Œä½¿å…¶è·å¾— root æƒé™ã€‚ æ¼æ´åº“ä¿¡æ¯,æœç´¢å¼•æ“ç»“æœå’Œæ¼æ´åˆ©ç”¨ä»£ç ä¸€è‡´,è¡¨æ˜è¯¥æ¼æ´çš„POCæ˜¯çœŸå®æœ‰æ•ˆçš„ã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**
æŸ¥çœ‹ `exploit.c` ä»£ç ï¼Œä¸»è¦æ“ä½œåŒ…æ‹¬åˆ›å»ºç›®å½•ã€è®¾ç½® user namespaceã€æŒ‚è½½ overlayfsã€å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶ã€è®¾ç½® capability å±æ€§ï¼Œä»¥åŠæ‰§è¡Œå¤åˆ¶åçš„æ–‡ä»¶ä»¥è·å¾— root æƒé™ã€‚ä»£ç é€»è¾‘è¾ƒä¸ºæ¸…æ™°ï¼Œæœªå‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç ã€‚`README.md` ä¹Ÿè¯´æ˜äº†å¹¶éä½œè€…åŸåˆ›,åªæ˜¯æ¬è¿,å¢åŠ äº†åˆ†æéš¾åº¦.
`exploit.c`ä¸­å­˜åœ¨`system(buf);` è°ƒç”¨ï¼Œè™½ç„¶è¿™é‡Œæ˜¯ç”¨äºæ¸…ç†ç›®å½•ï¼Œä½†å¦‚æœè¢«ç¯¡æ”¹ï¼Œå¯èƒ½æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£é™©è¯„ä¼°ä¸º10%ã€‚ä¸»è¦çš„é£é™©åœ¨äºï¼š

*   `system()` å‡½æ•°æ½œåœ¨çš„å‘½ä»¤æ³¨å…¥é£é™©ï¼Œå¦‚æœä»£ç è¢«ä¿®æ”¹ï¼Œå¯èƒ½å¯¼è‡´æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  åˆ©ç”¨ unshare() åˆ›å»ºä¸€ä¸ªæ–°çš„ user namespace å’Œ mount namespaceã€‚
2.  é…ç½® user namespace çš„ uid_map å’Œ gid_mapï¼Œå°†å½“å‰ç”¨æˆ·æ˜ å°„ä¸º root ç”¨æˆ·ã€‚
3.  åˆ›å»º overlayfs æ‰€éœ€çš„ç›®å½•ç»“æ„ï¼ˆlowerdirã€upperdirã€workdirã€mergedï¼‰ã€‚
4.  æŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿã€‚
5.  å°†æ¼æ´åˆ©ç”¨ç¨‹åºè‡ªèº«å¤åˆ¶åˆ° overlayfs çš„ upperdir/merged ç›®å½•ã€‚
6.  ä½¿ç”¨ setxattr() è®¾ç½®å¤åˆ¶åçš„å¯æ‰§è¡Œæ–‡ä»¶çš„ security.capability å±æ€§ï¼Œèµ‹äºˆå…¶ CAP_SETUID å’Œ CAP_SETGID æƒé™ã€‚
7.  æ‰§è¡Œå¤åˆ¶åçš„ç¨‹åºï¼Œç”±äºè®¾ç½®äº† capabilityï¼Œè¯¥ç¨‹åºä¼šä»¥ root æƒé™è¿è¡Œï¼Œä»è€Œè·å¾— root shellã€‚

**é¡¹ç›®åœ°å€:** [puckiestyle/CVE-2021-3493](https://github.com/puckiestyle/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #14

**æ¥æº**: [CVE-2021-3493-smallkill_CVE-2021-3493.md](../2021/CVE-2021-3493-smallkill_CVE-2021-3493.md)

# CVE-2021-3493

> ğŸ“¦ è¯¥CVEæœ‰ **15** ä¸ªç›¸å…³POCä»“åº“

---

## POC #1

**æ¥æº**: [CVE-2021-3493-Abdennour-py_CVE-2021-3493.md](../2021/CVE-2021-3493-Abdennour-py_CVE-2021-3493.md)

## CVE-2021-3493 Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å¯¼è‡´æ™®é€šç”¨æˆ·æå‡ä¸ºrootæƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu 5.8 kernel < 5.8.0-50.56, 5.4 kernel < 5.4.0-72.80, 4.15 kernel < 4.15.0-142.146, 4.4 kernel < 4.4.0-209.241

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç›®æ ‡ç³»ç»Ÿè¿è¡Œå—å½±å“çš„Ubuntuå†…æ ¸ï¼Œå¹¶ä¸”å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿå’Œä½¿ç”¨user namespace

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

è¯¥æ¼æ´æºäºUbuntuå†…æ ¸ä¸­overlayfså®ç°å¯¹ç”¨æˆ·å‘½åç©ºé—´ä¸­çš„æ–‡ä»¶èƒ½åŠ›éªŒè¯ä¸å½“ã€‚ç»“åˆéç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å’ŒUbuntuå†…æ ¸ä¸­çš„å…è®¸éç‰¹æƒ overlayfs æŒ‚è½½çš„è¡¥ä¸ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´è·å¾—æå‡çš„æƒé™ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**

æä¾›çš„POCä»£ç çœ‹èµ·æ¥æ˜¯æœ‰æ•ˆçš„ã€‚å®ƒåˆ©ç”¨äº† overlayfs å’Œ user namespace çš„ç»„åˆæ¥è®¾ç½®æ–‡ä»¶ capabilityï¼Œä»è€Œå®ç°ææƒã€‚ä»£ç é¦–å…ˆåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼ˆlower, upper, work, mergeï¼‰ï¼Œç„¶åä½¿ç”¨ `unshare` åˆ›å»ºä¸€ä¸ªæ–°çš„ user namespace å’Œ mount namespaceã€‚æ¥ç€ï¼Œå®ƒå†™å…¥ `/proc/self/setgroups`, `/proc/self/uid_map`, å’Œ `/proc/self/gid_map` æ¥è®¾ç½®ç”¨æˆ·å’Œç»„çš„æ˜ å°„ã€‚ç„¶åï¼ŒæŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿï¼Œæ‹·è´è‡ªèº«å¯æ‰§è¡Œæ–‡ä»¶åˆ° overlayfs çš„ merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½® capabilitiesã€‚æœ€åï¼Œå®ƒæ‰§è¡Œä½äº upper ç›®å½•çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶ä¼šå°è¯•ä»¥ root æƒé™æ‰§è¡Œ /bin/bashã€‚

æ ¹æ®æ¼æ´åº“ä¿¡æ¯ï¼ŒCISA å°†æ­¤æ¼æ´æ·»åŠ åˆ°å·²çŸ¥è¢«åˆ©ç”¨çš„æ¼æ´åˆ—è¡¨ä¸­ï¼Œè¿›ä¸€æ­¥è¡¨æ˜äº†è¯¥æ¼æ´çš„æœ‰æ•ˆæ€§ã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

æ£€æŸ¥æä¾›çš„ exploit.c ä»£ç ï¼Œæ²¡æœ‰å‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç æˆ–åé—¨ã€‚ä»£ç é€»è¾‘æ¸…æ™°ï¼Œä¸»è¦æ‰§è¡Œäº† overlayfs çš„æŒ‚è½½ï¼Œæ–‡ä»¶å¤åˆ¶ï¼Œè®¾ç½® xattr å’Œæ‰§è¡Œ shell æ“ä½œã€‚ä»£ç çš„æ„å›¾ä¸æ¼æ´æè¿°ä¸€è‡´ï¼Œæ²¡æœ‰å‘ç°éšè—çš„ã€ä¸æ¼æ´åˆ©ç”¨æ— å…³çš„æ¶æ„è¡Œä¸ºã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£é™©ä¸º 0%ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š**  åœ¨å­˜åœ¨æ¼æ´çš„Ubuntuç³»ç»Ÿä¸Šï¼Œåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ (ovlcap/work, ovlcap/lower, ovlcap/upper, ovlcap/merge)ã€‚
2.  **User Namespaceå’ŒMount Namespaceï¼š** ä½¿ç”¨ `unshare` ç³»ç»Ÿè°ƒç”¨åˆ›å»ºæ–°çš„ user namespace å’Œ mount namespaceã€‚
3.  **IDæ˜ å°„ï¼š**  é…ç½® `/proc/self/setgroups`ï¼Œ`/proc/self/uid_map` å’Œ `/proc/self/gid_map`ï¼Œä»¥ä¾¿åœ¨ user namespace ä¸­è·å¾—æœ‰æ•ˆçš„ç”¨æˆ· ID å’Œç»„ IDã€‚
4.  **OverlayFSæŒ‚è½½ï¼š**  ä½¿ç”¨ `mount` ç³»ç»Ÿè°ƒç”¨æŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿï¼Œå°† lower, upper å’Œ work ç›®å½•å…³è”èµ·æ¥ã€‚
5.  **æ–‡ä»¶æ‹·è´ä¸ Capability è®¾ç½®ï¼š**  å°† exploit ç¨‹åºè‡ªèº«æ‹·è´åˆ° overlayfs çš„ merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½® `security.capability` å±æ€§ï¼Œèµ‹äºˆå…¶ CAP_SETUID å’Œ CAP_SETGID ç­‰æƒé™ã€‚
6.  **ææƒæ‰§è¡Œï¼š** æ‰§è¡Œä½äº upper ç›®å½•çš„ exploit ç¨‹åºçš„æ‹·è´ã€‚ç”±äºè¯¥æ–‡ä»¶å…·æœ‰ capabilitiesï¼Œå› æ­¤å¯ä»¥ä»¥ root æƒé™æ‰§è¡Œ shellã€‚

**é¡¹ç›®åœ°å€:** [Abdennour-py/CVE-2021-3493](https://github.com/Abdennour-py/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #2

**æ¥æº**: [CVE-2021-3493-Sornphut_OverlayFS---CVE-2021-3493.md](../2021/CVE-2021-3493-Sornphut_OverlayFS---CVE-2021-3493.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒæ¼æ´

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Ubuntu Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœ¬åœ°ç”¨æˆ·è·å¾— root æƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu kernels before 5.8.0-50.56, 5.4.0-72.80, 4.15.0-142.146, and 4.4.0-209.241

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦è¿è¡Œåœ¨å­˜åœ¨æ¼æ´çš„ Ubuntu å†…æ ¸ä¸Šï¼Œå¹¶ä¸”å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½ overlayfsã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

è¯¥æ¼æ´å­˜åœ¨äº Ubuntu Linux å†…æ ¸çš„ overlayfs å®ç°ä¸­ã€‚ç”±äº Ubuntu å¯¹ overlayfs æŒ‚è½½çš„ç‰¹å®šä¿®æ”¹ï¼Œå¯¼è‡´åœ¨ç”¨æˆ·å‘½åç©ºé—´å†…ï¼Œå¯¹åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­çš„æ–‡ä»¶ capabilities éªŒè¯ä¸å……åˆ†ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡ overlayfs æŒ‚è½½ç»•è¿‡ capabilities æ£€æŸ¥ï¼Œè®¾ç½®æ–‡ä»¶ capabilities æå‡æƒé™ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  åˆ›å»ºä¸€ä¸ªç›®å½•ç»“æ„ï¼ŒåŒ…æ‹¬ lower, upper, work å’Œ merge ç›®å½•ã€‚
2.  ä½¿ç”¨ `unshare` åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´å’ŒæŒ‚è½½å‘½åç©ºé—´ã€‚
3.  é…ç½® `/proc/self/setgroups`, `/proc/self/uid_map`, å’Œ `/proc/self/gid_map` ä»¥æ˜ å°„ç”¨æˆ· ID å’Œç»„ IDã€‚
4.  ä½¿ç”¨ `mount` å‘½ä»¤æŒ‚è½½ overlayfsï¼Œå°† lower, upper å’Œ work ç›®å½•ä¸ merge ç›®å½•å…³è”èµ·æ¥ã€‚
5.  åœ¨ upper ç›®å½•æˆ– merge ç›®å½•ä¸‹åˆ›å»ºæˆ–å¤åˆ¶ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ã€‚
6.  ä½¿ç”¨ `setxattr` è®¾ç½®å¯æ‰§è¡Œæ–‡ä»¶çš„ capabilitiesï¼Œèµ‹äºˆå…¶ root æƒé™ã€‚
7.  æ‰§è¡Œè¯¥æ–‡ä»¶ï¼Œå³å¯è·å¾— root æƒé™ã€‚

**æœ‰æ•ˆæ€§ï¼š**

æä¾›çš„ POC ä»£ç å°è¯•åˆ©ç”¨ CVE-2021-3493 æ¼æ´ã€‚è¯¥ä»£ç åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´å’ŒæŒ‚è½½å‘½åç©ºé—´ï¼Œå¹¶å°è¯•æŒ‚è½½ overlayfsã€‚ç„¶åï¼Œå®ƒåº”è¯¥è®¾ç½® `magic` äºŒè¿›åˆ¶æ–‡ä»¶çš„ capabilitiesï¼Œä»è€Œè·å¾— root æƒé™ã€‚æ ¹æ®æ¼æ´æè¿°ï¼Œè¯¥ POC åº”è¯¥èƒ½å¤Ÿæœ‰æ•ˆåˆ©ç”¨è¯¥æ¼æ´ã€‚

**æŠ•æ¯’é£é™©ï¼š**

æ£€æŸ¥æä¾›çš„ exploit.c æ–‡ä»¶ï¼Œæœªå‘ç°æ˜æ˜¾çš„æ¶æ„æˆ–éšè—ä»£ç ã€‚ä»£ç é€»è¾‘ä¸»è¦é›†ä¸­äºè®¾ç½® overlayfs æŒ‚è½½å’Œæ–‡ä»¶ capabilitiesã€‚ä½†æ˜¯ï¼Œéœ€è¦å§‹ç»ˆè°¨æ…å¯¹å¾…æ¥è‡ªä¸å—ä¿¡ä»»æ¥æºçš„ä»£ç ã€‚ä¸ºäº†ç¡®ä¿å®‰å…¨ï¼Œå»ºè®®åœ¨å—æ§ç¯å¢ƒä¸­ä»”ç»†å®¡æŸ¥å’Œæµ‹è¯•ä»£ç ã€‚


**é¡¹ç›®åœ°å€:** [Sornphut/OverlayFS---CVE-2021-3493](https://github.com/Sornphut/OverlayFS---CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #3

**æ¥æº**: [CVE-2021-3493-briskets_CVE-2021-3493.md](../2021/CVE-2021-3493-briskets_CVE-2021-3493.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å¯¼è‡´æ™®é€šç”¨æˆ·æƒé™æå‡è‡³rootæƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu kernel versions: < 5.8.0-50.56 (5.8 kernel), < 5.4.0-72.80 (5.4 kernel), < 4.15.0-142.146 (4.15 kernel), < 4.4.0-209.241 (4.4 kernel)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦åœ¨å­˜åœ¨æ¼æ´çš„Ubuntuå†…æ ¸ç‰ˆæœ¬ä¸Šï¼Œå¹¶ä¸”å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½overlayfs

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 5%

## è¯¦æƒ…

CVE-2021-3493 æ¼æ´æ˜¯ç”±äº Linux å†…æ ¸çš„ overlayfs å®ç°æ²¡æœ‰æ­£ç¡®éªŒè¯ç”¨æˆ·å‘½åç©ºé—´ä¸­åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸Šæ–‡ä»¶ capabilities çš„è®¾ç½®ã€‚ç”±äº Ubuntu å†…æ ¸ä¸­å­˜åœ¨å…è®¸éç‰¹æƒ overlay æŒ‚è½½çš„è¡¥ä¸ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´è·å¾—æå‡çš„æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  æ¼æ´åˆ©ç”¨ä»£ç é¦–å…ˆåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ (ovlcap/work, ovlcap/lower, ovlcap/upper, ovlcap/merge)ã€‚
2.  åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´å’ŒæŒ‚è½½å‘½åç©ºé—´ã€‚
3.  åœ¨æ–°çš„ç”¨æˆ·å‘½åç©ºé—´ä¸­ï¼Œå°†å½“å‰ç”¨æˆ·çš„ UID å’Œ GID æ˜ å°„åˆ° root ç”¨æˆ·ã€‚
4.  ä½¿ç”¨ overlayfs å°† lowerdir (ovlcap/lower), upperdir (ovlcap/upper) å’Œ workdir (ovlcap/work) æŒ‚è½½åˆ° mergedir (ovlcap/merge)ã€‚
5.  å¤åˆ¶è‡ªèº« (exploit ç¨‹åº) åˆ° mergedir/magicï¼Œå¹¶è®¾ç½® security.capability æ‰©å±•å±æ€§ä¸º all+epï¼Œèµ‹äºˆè¯¥æ–‡ä»¶ capabilitiesã€‚
6.  æ‰§è¡Œ mergedir/magicï¼Œç”±äº capabilities çš„è®¾ç½®ï¼Œè¯¥ç¨‹åºä¼šä»¥ root æƒé™æ‰§è¡Œã€‚
7.  æœ€åï¼Œæ‰§è¡Œ upperdir/magicï¼Œå¯åŠ¨ä¸€ä¸ª root shellã€‚

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„POCä»£ç æ˜¯æœ‰æ•ˆçš„ï¼Œèƒ½å¤Ÿåˆ©ç”¨ CVE-2021-3493 æ¼æ´åœ¨å—å½±å“çš„ Ubuntu ç³»ç»Ÿä¸Šå®ç°æœ¬åœ°ææƒã€‚

**æŠ•æ¯’é£é™©ï¼š**
è¯¥POCä»£ç çš„ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´è¿›è¡Œææƒï¼Œä½†ä»ç„¶å­˜åœ¨æ½œåœ¨çš„æŠ•æ¯’é£é™©ã€‚æ¯”å¦‚ä½œè€…å¯èƒ½åœ¨ç¼–è¯‘å’Œè¿è¡Œå‰æ·»åŠ ä¸€äº›æ¶æ„ä»£ç ï¼Œä¾‹å¦‚ï¼š

1.  **åé—¨æ¤å…¥ï¼š** åœ¨ææƒæˆåŠŸåï¼Œæ¤å…¥ä¸€ä¸ªåé—¨ç¨‹åºï¼Œå…è®¸æ”»å‡»è€…è¿œç¨‹è®¿é—®ç³»ç»Ÿã€‚
2.  **æ•°æ®çªƒå–ï¼š** åœ¨ææƒè¿‡ç¨‹ä¸­ï¼Œçªƒå–ç”¨æˆ·çš„æ•æ„Ÿæ•°æ®ã€‚
3.  **ç ´åç³»ç»Ÿï¼š** åœ¨ææƒå¤±è´¥æˆ–è€…æˆåŠŸåï¼Œç ´åç³»ç»Ÿæ–‡ä»¶æˆ–è€…é…ç½®ã€‚

è€ƒè™‘åˆ°ä»£ç ç›¸å¯¹ç®€çŸ­ä¸”åŠŸèƒ½æ˜ç¡®ï¼Œè¯„ä¼°æŠ•æ¯’é£é™©ä¸º5%ã€‚ç”¨æˆ·éœ€è¦ä»”ç»†å®¡æŸ¥ä»£ç ï¼Œå¹¶åœ¨å®‰å…¨çš„ç¯å¢ƒä¸­è¿›è¡Œæµ‹è¯•ã€‚

**é¡¹ç›®åœ°å€:** [briskets/CVE-2021-3493](https://github.com/briskets/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #4

**æ¥æº**: [CVE-2021-3493-cyberx-1_OverlayFS-CVE-2021-3493.md](../2021/CVE-2021-3493-cyberx-1_OverlayFS-CVE-2021-3493.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯ä»æ™®é€šç”¨æˆ·ææƒè‡³root

**å½±å“ç‰ˆæœ¬:** Ubuntu kernels: 5.8.0-50.56 (5.8 kernel), 5.4.0-72.80 (5.4 kernel), 4.15.0-142.146 (4.15 kernel), 4.4.0-209.241 (4.4 kernel)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦è¿è¡Œåœ¨å­˜åœ¨æ¼æ´çš„Ubuntuå†…æ ¸ç‰ˆæœ¬ä¸Šï¼Œå¯ç”¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å’Œå…è®¸éç‰¹æƒ overlay mountsã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2021-3493æ˜¯Ubuntuå†…æ ¸OverlayFSå®ç°ä¸­çš„ä¸€ä¸ªæƒé™æå‡æ¼æ´ã€‚ç”±äºoverlayfsåœ¨ç”¨æˆ·å‘½åç©ºé—´ä¸­æ²¡æœ‰æ­£ç¡®éªŒè¯åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­æ–‡ä»¶åŠŸèƒ½è®¾ç½®ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å’ŒUbuntuå†…æ ¸ä¸­çš„éç‰¹æƒoverlayæŒ‚è½½è¡¥ä¸ï¼Œè·å–æå‡çš„æƒé™ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** åœ¨å­˜åœ¨æ¼æ´çš„Ubuntuå†…æ ¸ä¸Šï¼Œç¡®ä¿å¯ç”¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´ã€‚æ¼æ´åº“ä¿¡æ¯æåˆ°ç¦ç”¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å¯ä»¥ä½œä¸ºç¼“è§£æªæ–½ï¼Œæ‰€ä»¥è¦ç¡®ä¿å¯ç”¨ã€‚
2.  **åˆ›å»ºOverlayFSç»“æ„ï¼š** PoCä»£ç é¦–å…ˆåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼ˆlower, upper, work, mergeï¼‰ç”¨äº overlayfs æ–‡ä»¶ç³»ç»Ÿã€‚
3.  **åˆ›å»ºç”¨æˆ·å‘½åç©ºé—´ï¼š** ä½¿ç”¨`unshare`ç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´ã€‚è¿™å…è®¸åœ¨æ–°çš„å‘½åç©ºé—´ä¸­æ‹¥æœ‰ä¸åŒçš„ç”¨æˆ·IDå’Œç»„IDæ˜ å°„ã€‚
4.  **è®¾ç½®UID/GIDæ˜ å°„ï¼š** å°†å½“å‰ç”¨æˆ·çš„UIDå’ŒGIDæ˜ å°„åˆ°æ–°å‘½åç©ºé—´ä¸­çš„rootç”¨æˆ· (UID 0 å’Œ GID 0)ã€‚
5.  **æŒ‚è½½OverlayFSï¼š** ä½¿ç”¨`mount`ç³»ç»Ÿè°ƒç”¨å°† overlayfs æ–‡ä»¶ç³»ç»ŸæŒ‚è½½åˆ° merge ç›®å½•ã€‚æŒ‡å®š lowerdir, upperdir å’Œ workdirã€‚
6.  **å¤åˆ¶è‡ªèº«å¹¶è®¾ç½®Capabilitiesï¼š** å°†è‡ªèº«å¯æ‰§è¡Œæ–‡ä»¶å¤åˆ¶åˆ° overlayfs çš„ merge ç›®å½•ï¼Œç„¶åä½¿ç”¨`setxattr`è®¾ç½®`security.capability`æ‰©å±•å±æ€§ï¼Œèµ‹äºˆè¯¥æ–‡ä»¶ root æƒé™ã€‚
7.  **æ‰§è¡Œææƒåçš„ç¨‹åºï¼š** é€šè¿‡æ‰§è¡Œ upper ç›®å½•ä¸‹çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆä¹‹å‰å¤åˆ¶å¹¶è®¾ç½®äº† capabilities çš„æ–‡ä»¶ï¼‰æ¥è·å– root æƒé™ã€‚è¿™ä¸ªç¨‹åºä¼šæ£€æŸ¥æ˜¯å¦æœ‰"shell"å‚æ•°ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™ä¼šé‡æ–°æ‰§è¡Œè‡ªèº«ï¼Œä½†è¿™æ¬¡ä¼šå¸¦æœ‰`shell`å‚æ•°ï¼Œä»è€Œè§¦å‘`setuid(0)`å’Œ`setgid(0)`ï¼Œæœ€ç»ˆæ‰§è¡Œ`/bin/bash`ï¼Œè·å¾— root shellã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

ä»£ç ä¸­å­˜åœ¨ä¸€å®šçš„æŠ•æ¯’é£é™©ï¼Œè™½ç„¶ä¸»è¦é€»è¾‘æ˜¯åˆ©ç”¨æ¼æ´è¿›è¡Œææƒï¼Œä½†å­˜åœ¨ä¿®æ”¹`/bin/bash`çš„å¯èƒ½æ€§ï¼Œä½†æ˜¯ç»è¿‡ä»£ç åˆ†æä»¥åŠæ¼æ´åŸç†ï¼Œåˆ¤æ–­æ¼æ´åˆ©ç”¨è¿‡ç¨‹ä¸­æ²¡æœ‰ä¿®æ”¹`/bin/bash`æ“ä½œ,ä»£ç ä¸­é£é™©ä¸»è¦å­˜åœ¨äºä»¥ä¸‹å‡ ç‚¹:

1.  **ä¾èµ–å¤–éƒ¨äºŒè¿›åˆ¶æ–‡ä»¶ï¼š** è¯¥æ¼æ´åˆ©ç”¨ä¾èµ–äºç³»ç»Ÿä¸Šçš„`/bin/bash`ã€‚å¦‚æœæ”»å‡»è€…æ›¿æ¢æˆ–ç¯¡æ”¹äº†ç›®æ ‡ç³»ç»Ÿä¸Šçš„`/bin/bash`ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ„å¤–çš„è¡Œä¸ºæˆ–å®‰å…¨é—®é¢˜ã€‚
2.  **æ¸…ç†æ“ä½œé£é™©ï¼š** ä»£ç å¼€å§‹æ—¶ä½¿ç”¨`system(buf)`æ‰§è¡Œ`rm -rf '%s/'`ï¼Œå¦‚æœ`DIR_BASE`è¢«æ¶æ„ä¿®æ”¹ï¼Œå¯èƒ½å¯¼è‡´æ„å¤–çš„æ–‡ä»¶åˆ é™¤ã€‚
3.  **ä¸å®Œå–„çš„é”™è¯¯å¤„ç†ï¼š** è™½ç„¶ PoC ä»£ç åŒ…å«äº†ä¸€äº›é”™è¯¯å¤„ç†ï¼Œä½†åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå¦‚æœé”™è¯¯å¤„ç†ä¸å½“ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ‹’ç»æœåŠ¡æˆ–æœªå®šä¹‰çš„è¡Œä¸ºã€‚

æ€»ä½“è€Œè¨€ï¼Œè¯¥ PoC ä»£ç çš„æŠ•æ¯’é£é™©è¾ƒä½ï¼Œä¸»è¦é£é™©åœ¨äºä¾èµ–å¤–éƒ¨äºŒè¿›åˆ¶æ–‡ä»¶å’Œæ½œåœ¨çš„æ¸…ç†æ“ä½œé£é™©ã€‚ä»£ç æœ¬èº«ä¸»è¦æ˜¯ä¸ºäº†æ¼”ç¤ºæ¼æ´åˆ©ç”¨ï¼Œå¹¶æœªå‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç ã€‚ è¯„ä¼°æŠ•æ¯’é£é™©ä¸º10%ã€‚


**é¡¹ç›®åœ°å€:** [cyberx-1/OverlayFS-CVE-2021-3493](https://github.com/cyberx-1/OverlayFS-CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #5

**æ¥æº**: [CVE-2021-3493-derek-turing_CVE-2021-3493.md](../2021/CVE-2021-3493-derek-turing_CVE-2021-3493.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Ubuntu Linux Kernel

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœ¬åœ°ç”¨æˆ·å¯æå‡è‡³ root æƒé™

**å½±å“ç‰ˆæœ¬:** 4.4 <= kernel < 4.4.0-209.241, 4.15 <= kernel < 4.15.0-142.146, 5.4 <= kernel < 5.4.0-72.80, 5.8 <= kernel < 5.8.0-50.56

**åˆ©ç”¨æ¡ä»¶:** Ubuntu å†…æ ¸å¼€å¯äº† unprivileged user namespaces å’Œ unprivileged overlay mounts

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

è¯¥æ¼æ´å­˜åœ¨äº Ubuntu Linux å†…æ ¸çš„ OverlayFS å®ç°ä¸­ï¼Œç”±äº overlayfs å¯¹åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­æ–‡ä»¶ capabilities çš„è®¾ç½®éªŒè¯ä¸å½“ï¼Œç»“åˆæœªæˆæƒç”¨æˆ·å‘½åç©ºé—´å’Œ Ubuntu å†…æ ¸ä¸­å…è®¸æœªæˆæƒ overlay æŒ‚è½½çš„è¡¥ä¸ï¼Œæ”»å‡»è€…å¯åˆ©ç”¨æ­¤æ¼æ´æå‡æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** é¦–å…ˆï¼Œç¡®ä¿ç›®æ ‡ç³»ç»Ÿæ»¡è¶³æ¼æ´åˆ©ç”¨çš„æ¡ä»¶ï¼Œå³ Ubuntu å†…æ ¸ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…ï¼Œå¹¶ä¸”å¯ç”¨äº† unprivileged user namespaces å’Œ unprivileged overlay mountsã€‚æ¼æ´åº“ä¿¡æ¯ä¸­ç»™å‡ºäº†å—å½±å“çš„ç‰ˆæœ¬èŒƒå›´ã€‚
2.  **åˆ›å»ºç›®å½•ç»“æ„ï¼š** åˆ›å»º overlayfs æ‰€éœ€çš„ç›®å½•ç»“æ„ï¼ŒåŒ…æ‹¬ lowerdirï¼ˆåº•å±‚ç›®å½•ï¼‰ã€upperdirï¼ˆä¸Šå±‚ç›®å½•ï¼‰ã€workdirï¼ˆå·¥ä½œç›®å½•ï¼‰å’Œ mergedirï¼ˆåˆå¹¶ç›®å½•ï¼‰ã€‚
3.  **åˆ›å»ºç”¨æˆ·å‘½åç©ºé—´ï¼š** ä½¿ç”¨ `unshare` å‘½ä»¤åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´ï¼Œè¿™å…è®¸åœ¨éç‰¹æƒç”¨æˆ·ä¸‹æ‰§è¡Œä¸€äº›ç‰¹æƒæ“ä½œã€‚
4.  **è®¾ç½® UID/GID æ˜ å°„ï¼š** åœ¨ç”¨æˆ·å‘½åç©ºé—´ä¸­ï¼Œå°†å½“å‰ç”¨æˆ·çš„ UID å’Œ GID æ˜ å°„åˆ° root ç”¨æˆ· (UID 0) å’Œ root ç»„ (GID 0)ï¼Œè¿™æ ·åœ¨ overlayfs ä¸­åˆ›å»ºçš„æ–‡ä»¶å°†å±äº root ç”¨æˆ·ã€‚
5.  **æŒ‚è½½ OverlayFSï¼š** ä½¿ç”¨ `mount` å‘½ä»¤å°† overlayfs æŒ‚è½½åˆ° mergedirï¼ŒæŒ‡å®š lowerdirã€upperdir å’Œ workdirã€‚
6.  **å¤åˆ¶å¹¶è®¾ç½® Capabilitiesï¼š** å°† exploit ç¨‹åºè‡ªèº«å¤åˆ¶åˆ° mergedir ä¸­ï¼Œå¹¶ä½¿ç”¨ `setxattr` å‘½ä»¤è®¾ç½®å…¶ security.capability æ‰©å±•å±æ€§ï¼Œèµ‹äºˆå…¶ CAP_SETUID å’Œ CAP_SETGID capabilitiesã€‚è¿™ä¸ªcapabilitieså…è®¸ç¨‹åºåœ¨æ²¡æœ‰rootæƒé™çš„æƒ…å†µä¸‹è®¾ç½®uidå’Œgidã€‚
7.  **è§¦å‘ææƒï¼š** è¿è¡Œ mergedir ä¸­çš„ exploit ç¨‹åºï¼Œç”±äºå·²è®¾ç½® capabilitiesï¼Œç¨‹åºå°†ä»¥ root æƒé™è¿è¡Œï¼Œä»è€Œæ‰§è¡Œç‰¹æƒæ“ä½œã€‚

**ä»£ç åˆ†æï¼š**

*   `exploit.c` æ˜¯åˆ©ç”¨ä»£ç ï¼Œå®ƒåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼Œå»ºç«‹ç”¨æˆ·å‘½åç©ºé—´ï¼ŒæŒ‚è½½ overlayfsï¼Œç„¶åå°†è‡ªèº«å¤åˆ¶åˆ° overlayfs ä¸­ï¼Œå¹¶è®¾ç½® capabilitiesã€‚æœ€åï¼Œæ‰§è¡Œå¤åˆ¶åˆ° upperdir ä¸­çš„ç¨‹åºï¼Œè¯¥ç¨‹åºä¼šå°†å½“å‰è¿›ç¨‹ææƒä¸º rootã€‚
*   ä»£ç ä¸­ä½¿ç”¨äº† `setxattr` å‡½æ•°æ¥è®¾ç½®æ–‡ä»¶ capabilitiesï¼Œè¿™æ˜¯åˆ©ç”¨æ¼æ´çš„å…³é”®æ­¥éª¤ã€‚
*   mainå‡½æ•°é¦–å…ˆforkä¸€ä¸ªå­è¿›ç¨‹æ‰§è¡Œexploitå‡½æ•°ï¼Œåœ¨exploitå‡½æ•°æ‰§è¡Œå®Œæ¯•åï¼Œçˆ¶è¿›ç¨‹æ‰§è¡ŒBIN_UPPERä¸­çš„magicç¨‹åºï¼Œå¦‚æœå¸¦æœ‰shellå‚æ•°ï¼Œmagicç¨‹åºä¼šè®¾ç½®uidå’Œgidä¸º0ï¼Œå¹¶ä¸”è¿è¡Œä¸€ä¸ªbash shellã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

ä»”ç»†æ£€æŸ¥äº† POC ä»£ç ï¼Œæ²¡æœ‰å‘ç°æ˜æ˜¾çš„æŠ•æ¯’ä»£ç ã€‚ä»£ç é€»è¾‘æ¸…æ™°ï¼Œä¸»è¦ç”¨äºåˆ›å»º overlayfs ç¯å¢ƒå¹¶è®¾ç½®æ–‡ä»¶ capabilities ä»¥è¿›è¡Œææƒã€‚ä½œè€…å¹¶æ²¡æœ‰å°è¯•åœ¨ä»£ç ä¸­éšè—æ¶æ„è¡Œä¸ºï¼Œä¾‹å¦‚ï¼š

*   è¿æ¥å¤–éƒ¨æœåŠ¡å™¨
*   ä¿®æ”¹ç³»ç»Ÿæ–‡ä»¶
*   å®‰è£…åé—¨
*   æ”¶é›†ç”¨æˆ·ä¿¡æ¯

å› æ­¤ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ (0%)ã€‚

**é¡¹ç›®åœ°å€:** [derek-turing/CVE-2021-3493](https://github.com/derek-turing/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #6

**æ¥æº**: [CVE-2021-3493-fathallah17_OverlayFS-CVE-2021-3493.md](../2021/CVE-2021-3493-fathallah17_OverlayFS-CVE-2021-3493.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°æƒé™æå‡

**å½±å“åº”ç”¨:** Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å¯¼è‡´æœ¬åœ°æƒé™æå‡è‡³root

**å½±å“ç‰ˆæœ¬:** 4.4 <= Linux Kernel < 5.8.0-50.56 (Ubuntu ç‰¹å®šç‰ˆæœ¬)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦å­˜åœ¨Ubuntuå†…æ ¸ä¸­å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½OverlayFSçš„è¡¥ä¸ï¼Œä¸”ç”¨æˆ·å‘½åç©ºé—´æœªè¢«ç¦ç”¨ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 1%

## è¯¦æƒ…

CVE-2021-3493 æ˜¯ä¸€ä¸ªå­˜åœ¨äº Linux å†…æ ¸ OverlayFS å®ç°ä¸­çš„æƒé™æå‡æ¼æ´ã€‚æ¼æ´çš„æ ¹æœ¬åŸå› æ˜¯ OverlayFS åœ¨è®¾ç½®åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­æ–‡ä»¶çš„ capabilities æ—¶ï¼Œæ²¡æœ‰æ­£ç¡®åœ°éªŒè¯ç”¨æˆ·å‘½åç©ºé—´ã€‚åœ¨å­˜åœ¨å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½ OverlayFS çš„ Ubuntu å†…æ ¸è¡¥ä¸çš„ç¯å¢ƒä¸­ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´è·å¾—æå‡çš„æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š**  ç›®æ ‡ç³»ç»Ÿéœ€è¦æ˜¯å—å½±å“çš„ Ubuntu ç‰ˆæœ¬ï¼Œå¹¶ä¸”å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½ OverlayFSï¼ŒåŒæ—¶ç”¨æˆ·å‘½åç©ºé—´æ²¡æœ‰è¢«ç¦ç”¨ã€‚
2.  **è·å–æ¼æ´åˆ©ç”¨ä»£ç ï¼š**  ä»å¯ä¿¡æ¥æºè·å–æ¼æ´åˆ©ç”¨ä»£ç  (ä¾‹å¦‚ SSD-Disclosure æä¾›çš„ exploit.c)ã€‚
3.  **ç¼–è¯‘æ¼æ´åˆ©ç”¨ä»£ç ï¼š**  ä½¿ç”¨ gcc ç­‰ç¼–è¯‘å™¨å°† exploit.c ç¼–è¯‘ä¸ºå¯æ‰§è¡Œæ–‡ä»¶ã€‚
4.  **æ‰§è¡Œæ¼æ´åˆ©ç”¨ä»£ç ï¼š**  è¿è¡Œç¼–è¯‘åçš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚æ¼æ´åˆ©ç”¨ä»£ç ä¼šåˆ©ç”¨ OverlayFS çš„æ¼æ´ï¼Œé€šè¿‡è®¾ç½®æ–‡ä»¶ capabilities æ¥æå‡å½“å‰ç”¨æˆ·çš„æƒé™è‡³ rootã€‚
5.  **è·å– root æƒé™ï¼š**  æˆåŠŸæ‰§è¡Œæ¼æ´åˆ©ç”¨ä»£ç åï¼Œç”¨æˆ·å°†è·å¾— root æƒé™ã€‚

**å…³äºæŠ•æ¯’é£é™©ï¼š**

æä¾›çš„POCä»£ç åªæ˜¯ä¸€ä¸ªç®€å•çš„åˆ©ç”¨æ–¹å¼,ä¸å¤ªå¯èƒ½åŒ…å«æ¶æ„ä»£ç ã€‚ä½†å§‹ç»ˆéœ€è¦å¯¹ä»»ä½•æ¥æºçš„æ¼æ´åˆ©ç”¨ä»£ç è¿›è¡Œå®¡æŸ¥ï¼Œä»¥é™ä½é£é™©ã€‚
å¯¹ä¸‹è½½çš„æ–‡ä»¶è¿›è¡Œæ£€æŸ¥ï¼Œå¦‚å“ˆå¸Œæ ¡éªŒï¼Œå¯ä»¥æœ€å¤§ç¨‹åº¦çš„é¿å…å¼•å…¥æ¶æ„ä»£ç ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**

æ ¹æ®æ¼æ´æè¿°å’Œåˆ©ç”¨ä»£ç ï¼Œè¯¥æ¼æ´åˆ©ç”¨æ˜¯æœ‰æ•ˆçš„ã€‚åˆ©ç”¨ä»£ç é€šè¿‡OverlayFSçš„æ¼æ´ï¼Œå…è®¸ä½æƒé™ç”¨æˆ·è·å¾—rootæƒé™ã€‚

**å…¶ä»–ä¿¡æ¯:**
CISA å·²å°†æ­¤æ¼æ´æ·»åŠ åˆ°å·²çŸ¥è¢«åˆ©ç”¨çš„æ¼æ´ç›®å½• (KEV) ä¸­ï¼Œè¡¨æ˜è¯¥æ¼æ´å·²è¢«å¹¿æ³›åˆ©ç”¨ã€‚

**é¡¹ç›®åœ°å€:** [fathallah17/OverlayFS-CVE-2021-3493](https://github.com/fathallah17/OverlayFS-CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #7

**æ¥æº**: [CVE-2021-3493-fei9747_CVE-2021-3493.md](../2021/CVE-2021-3493-fei9747_CVE-2021-3493.md)

## CVE-2021-3493 Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ”»å‡»è€…å¯åˆ©ç”¨æ­¤æ¼æ´è·å– root æƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu kernel versions: < 5.8.0-50.56, < 5.4.0-72.80, < 4.15.0-142.146, < 4.4.0-209.241

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦åœ¨å­˜åœ¨æ¼æ´çš„ Ubuntu ç³»ç»Ÿä¸Šæœ¬åœ°æ‰§è¡Œ

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 5%

## è¯¦æƒ…

CVE-2021-3493 æ˜¯ä¸€ä¸ªå­˜åœ¨äº Ubuntu Linux å†…æ ¸ overlayfs å®ç°ä¸­çš„æœ¬åœ°ææƒæ¼æ´ã€‚è¯¥æ¼æ´æºäº overlayfs æœªèƒ½æ­£ç¡®éªŒè¯ç”¨æˆ·å‘½åç©ºé—´ä¸­åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸Šæ–‡ä»¶ capabilities çš„è®¾ç½®ã€‚ç»“åˆæœªæˆæƒç”¨æˆ·å‘½åç©ºé—´ä»¥åŠ Ubuntu å†…æ ¸ä¸­å…è®¸æœªæˆæƒ overlay mount çš„è¡¥ä¸ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´æå‡æƒé™ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼ŒåŒ…æ‹¬lowerdirï¼Œupperdirï¼Œworkdirå’Œmergedirã€‚
2.  **åˆ›å»ºå‘½åç©ºé—´ï¼š** ä½¿ç”¨ `unshare` ç³»ç»Ÿè°ƒç”¨åˆ›å»ºæ–°çš„ç”¨æˆ·å‘½åç©ºé—´å’ŒæŒ‚è½½å‘½åç©ºé—´ã€‚
3.  **è®¾ç½®ç”¨æˆ·å’Œç»„IDæ˜ å°„ï¼š** å°†å½“å‰ç”¨æˆ·çš„ UID å’Œ GID æ˜ å°„åˆ°æ–°çš„ç”¨æˆ·å‘½åç©ºé—´ä¸­ï¼Œä»¥ä¾¿åœ¨æ–°çš„å‘½åç©ºé—´ä¸­æ‹¥æœ‰æƒé™ã€‚
4.  **æŒ‚è½½ OverlayFSï¼š** ä½¿ç”¨ `mount` ç³»ç»Ÿè°ƒç”¨ï¼Œå°† overlayfs æŒ‚è½½åˆ° mergedirï¼Œå¹¶å°† lowerdirï¼Œupperdir å’Œ workdir æŒ‡å®šä¸ºç›¸åº”çš„ç›®å½•ã€‚
5.  **è®¾ç½® Capabilitiesï¼š** å¤åˆ¶å½“å‰æ‰§è¡Œçš„ç¨‹åºåˆ° mergedirï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½®è¯¥æ–‡ä»¶çš„ capabilitiesï¼Œä½¿å…¶å…·æœ‰ root æƒé™ã€‚ è¿™æ­¥æ˜¯æ¼æ´åˆ©ç”¨çš„å…³é”®ã€‚
6.  **æ‰§è¡ŒPayloadï¼š** æ‰§è¡Œupperç›®å½•ä¸­çš„æ–‡ä»¶ï¼Œå› ä¸ºè®¾ç½®äº†Capabilitiesï¼Œå¯ä»¥è·å¾—rootæƒé™ã€‚

**æœ‰æ•ˆæ€§ï¼š**

æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’ŒPOCä»£ç æè¿°ï¼Œè¯¥æ¼æ´åœ¨ç‰¹å®šç‰ˆæœ¬çš„ Ubuntu å†…æ ¸ä¸Šæ˜¯å¯åˆ©ç”¨çš„ã€‚æä¾›çš„POCä»£ç å±•ç¤ºäº†åˆ©ç”¨è¯¥æ¼æ´æå‡æƒé™çš„å®Œæ•´è¿‡ç¨‹ã€‚

**æŠ•æ¯’é£é™©ï¼š**

ä»£ç ä¸­å­˜åœ¨æ½œåœ¨çš„æŠ•æ¯’é£é™©ï¼Œä½†æ˜¯é£é™©è¾ƒä½ã€‚ä¸»è¦é›†ä¸­åœ¨ç¼–è¯‘å’Œè¿è¡Œexploitæ—¶ã€‚æ”»å‡»è€…å¯èƒ½é€šè¿‡ä¿®æ”¹ exploit.c æ–‡ä»¶ï¼Œä¾‹å¦‚æ·»åŠ æ¶æ„ä»£ç æˆ–åé—¨ï¼Œä»è€Œåœ¨ç›®æ ‡ç³»ç»Ÿä¸Šæ‰§è¡Œæ¶æ„æ“ä½œã€‚ä½†æ˜¯æ ¹æ®æä¾›çš„POCä»£ç æ¥çœ‹, é£é™©ç³»æ•°è¾ƒä½.

**é£é™©è¯„ä¼°ï¼š**

è¯¥æ¼æ´åˆ©ç”¨çš„æˆåŠŸå–å†³äºç›®æ ‡ç³»ç»Ÿæ˜¯å¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š

*   è¿è¡Œå—å½±å“çš„ Ubuntu å†…æ ¸ç‰ˆæœ¬ã€‚
*   å¯ç”¨äº†æœªæˆæƒç”¨æˆ·å‘½åç©ºé—´å’Œ overlayfs mountã€‚
*   ç›®æ ‡ç³»ç»Ÿä¸Šå­˜åœ¨ `gcc` ç¼–è¯‘å™¨, èƒ½å¤Ÿç¼–è¯‘exploitã€‚

å¦‚æœç›®æ ‡ç³»ç»Ÿæ»¡è¶³è¿™äº›æ¡ä»¶ï¼Œæ”»å‡»è€…å¯ä»¥ä½¿ç”¨æä¾›çš„ POC ä»£ç æˆåŠŸåˆ©ç”¨è¯¥æ¼æ´ï¼Œä»è€Œè·å¾— root æƒé™ã€‚


**é¡¹ç›®åœ°å€:** [fei9747/CVE-2021-3493](https://github.com/fei9747/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #8

**æ¥æº**: [CVE-2021-3493-iamz24_CVE-2021-3493_CVE-2022-3357.md](../2021/CVE-2021-3493-iamz24_CVE-2021-3493_CVE-2022-3357.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒæ¼æ´

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å¯¼è‡´æœ¬åœ°æƒé™æå‡è‡³ root

**å½±å“ç‰ˆæœ¬:** Ubuntu kernels < 5.8.0-50.56, < 5.4.0-72.80, < 4.15.0-142.146, < 4.4.0-209.241

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç›®æ ‡ç³»ç»Ÿå¼€å¯ unprivileged user namespaces å’Œå­˜åœ¨ OverlayFS æœåŠ¡ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2021-3493 æ¼æ´æ˜¯ Linux å†…æ ¸ overlayfs å®ç°ä¸­ï¼Œåœ¨ç”¨æˆ·å‘½åç©ºé—´ä¸­å¯¹åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­çš„æ–‡ä»¶ capabilities éªŒè¯ä¸å½“å¯¼è‡´çš„ã€‚ç”±äº Ubuntu å†…æ ¸ä¸­å­˜åœ¨å…è®¸éç‰¹æƒ overlay æŒ‚è½½çš„è¡¥ä¸ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¯¥æ¼æ´æå‡æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** æ£€æŸ¥ç›®æ ‡ç³»ç»Ÿæ˜¯å¦å­˜åœ¨ overlayfs æœåŠ¡ï¼Œå¦‚æœæ²¡æœ‰åˆ™åŠ è½½ overlay æ¨¡å—ã€‚åŒæ—¶ï¼Œç¡®ä¿å¼€å¯äº† unprivileged user namespacesã€‚
2.  **ç¼–è¯‘ Payloadï¼š** ä½¿ç”¨ GCC ç¼–è¯‘æä¾›çš„ `payload.c` æ–‡ä»¶ã€‚
3.  **è¿è¡Œ Payloadï¼š** è¿è¡Œç¼–è¯‘åçš„å¯æ‰§è¡Œæ–‡ä»¶ `a.out`ã€‚
4.  **è·å– Root Shellï¼š** Payload ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å‘½åç©ºé—´ï¼ŒæŒ‚è½½ overlayfsï¼Œè®¾ç½® capabilityï¼Œæœ€ç»ˆæ‰§è¡Œä¸€ä¸ªå…·æœ‰ root æƒé™çš„ shellã€‚

**æœ‰æ•ˆæ€§ï¼š**

æä¾›çš„ POC ä»£ç åŸºæœ¬æœ‰æ•ˆï¼Œèƒ½å¤Ÿåˆ©ç”¨è¯¥æ¼æ´åœ¨ç¬¦åˆæ¡ä»¶çš„ Ubuntu ç³»ç»Ÿä¸Šå®ç°æœ¬åœ°ææƒã€‚

**æŠ•æ¯’é£é™©ï¼š**

å­˜åœ¨è¾ƒä½çš„æŠ•æ¯’é£é™©ï¼ˆ10%ï¼‰ã€‚è™½ç„¶ä»£ç çš„ä¸»è¦åŠŸèƒ½æ˜¯å®ç°ææƒï¼Œä½†ä»ç„¶éœ€è¦è°¨æ…å¯¹å¾…æ¥æºä¸æ˜çš„ä»£ç ï¼Œä½œè€…å¯èƒ½ä¼šåœ¨å…¶ä¸­éšè—ä¸€äº›æ¶æ„è¡Œä¸ºï¼Œæ¯”å¦‚ä¸Šä¼ æ•æ„Ÿä¿¡æ¯ç­‰ã€‚ç‰¹åˆ«æ˜¯éœ€è¦æ£€æŸ¥ `exploit`å‡½æ•°ä¸­çš„ç›¸å…³æ–‡ä»¶æ“ä½œå’Œå‘½ä»¤æ‰§è¡Œæ˜¯å¦å­˜åœ¨æ¶æ„è¡Œä¸ºã€‚å°¤å…¶å…³æ³¨`system(buf);`æ˜¯å¦ä¼šæ‰§è¡Œæ¶æ„çš„æŒ‡ä»¤ã€‚

**æ€»ç»“ï¼š**

è¯¥æ¼æ´åˆ©ç”¨è¾ƒä¸ºç›´æ¥ï¼Œåˆ©ç”¨æ¡ä»¶ç›¸å¯¹æ˜ç¡®ï¼Œä½†éœ€è¦æ³¨æ„æ½œåœ¨çš„æŠ•æ¯’é£é™©ã€‚åœ¨å®é™…ä½¿ç”¨æ—¶ï¼Œåº”è¯¥ä»”ç»†å®¡æŸ¥ä»£ç ï¼Œç¡®ä¿æ²¡æœ‰æ¶æ„è¡Œä¸ºã€‚

**é¡¹ç›®åœ°å€:** [iamz24/CVE-2021-3493_CVE-2022-3357](https://github.com/iamz24/CVE-2021-3493_CVE-2022-3357)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #9

**æ¥æº**: [CVE-2021-3493-inspiringz_CVE-2021-3493.md](../2021/CVE-2021-3493-inspiringz_CVE-2021-3493.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Ubuntu Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸ä½æƒé™ç”¨æˆ·æå‡åˆ°rootæƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu 4.4, 4.15, 5.4, 5.8 kernels (å—å½±å“ç‰ˆæœ¬è¯¦è§æ¼æ´åº“ä¿¡æ¯)

**åˆ©ç”¨æ¡ä»¶:** Ubuntuå†…æ ¸ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…ï¼Œå¯ç”¨æœªæˆæƒç”¨æˆ·å‘½åç©ºé—´ï¼Œå…è®¸æœªæˆæƒOverlayFSæŒ‚è½½ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 5%

## è¯¦æƒ…

CVE-2021-3493æ˜¯Ubuntuå†…æ ¸ä¸­OverlayFSå®ç°çš„ä¸€ä¸ªæ¼æ´ï¼Œå…è®¸ä½æƒé™ç”¨æˆ·é€šè¿‡åˆ©ç”¨user namespaceå’ŒOverlayFSæŒ‚è½½ç»•è¿‡æ–‡ä»¶ç³»ç»Ÿæƒé™æ£€æŸ¥æ¥æå‡æƒé™ã€‚ 

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡:** æ¼æ´åˆ©ç”¨éœ€è¦å­˜åœ¨Ubuntuç³»ç»Ÿï¼Œä¸”å†…æ ¸ç‰ˆæœ¬åœ¨æ¼æ´åº“ä¿¡æ¯ä¸­æè¿°çš„å—å½±å“èŒƒå›´å†…ï¼Œå¹¶ä¸”éœ€è¦å¯ç”¨æœªæˆæƒç”¨æˆ·å‘½åç©ºé—´(unprivileged user namespaces)ã€‚æ­¤å¤–ï¼Œä¸ºäº†åˆ©ç”¨OverlayFSï¼Œç³»ç»Ÿéœ€è¦é…ç½®å…è®¸æœªæˆæƒç”¨æˆ·è¿›è¡ŒOverlayFSæŒ‚è½½ã€‚
2.  **æ¼æ´åˆ©ç”¨:**  æ”»å‡»è€…é¦–å…ˆåˆ›å»ºä¸€ä¸ªåŒ…å«lower, upper, workç›®å½•çš„OverlayFSç»“æ„ã€‚
3.  **åˆ©ç”¨è¿‡ç¨‹:** åˆ©ç”¨`unshare`ç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€ä¸ªæ–°çš„user namespaceå’Œmount namespaceã€‚ åœ¨æ–°namespaceä¸­ï¼Œå°†è‡ªå·±çš„UIDå’ŒGIDæ˜ å°„åˆ°rootæƒé™ã€‚ ç„¶åï¼Œä½¿ç”¨æ„é€ çš„lowerdirã€upperdirå’ŒworkdiræŒ‚è½½OverlayFSæ–‡ä»¶ç³»ç»Ÿã€‚ æ”»å‡»è€…å°†ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶å¤åˆ¶åˆ°OverlayFSçš„mergeç›®å½•ä¸­ã€‚å…³é”®çš„ä¸€æ­¥æ˜¯ï¼Œæ”»å‡»è€…ä½¿ç”¨`setxattr`ç³»ç»Ÿè°ƒç”¨ï¼Œè®¾ç½®è¯¥å¯æ‰§è¡Œæ–‡ä»¶çš„`security.capability`æ‰©å±•å±æ€§ï¼Œèµ‹äºˆå®ƒ`CAP_SETUID`å’Œ`CAP_SETGID`èƒ½åŠ›ã€‚ ç”±äºOverlayFSçš„æƒé™éªŒè¯ä¸å®Œå–„ï¼Œè¿™ä¸ªæ“ä½œå³ä½¿åœ¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´ä¸­ä¹Ÿèƒ½æˆåŠŸã€‚å½“æ‰§è¡Œè¯¥æ–‡ä»¶æ—¶ï¼Œå®ƒå°†è·å¾—rootæƒé™ï¼Œå¹¶å¯ä»¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚
4.  **POCä»£ç åˆ†æ:** `exploit.c` ä»£ç é¦–å…ˆåˆ›å»ºä¸€ä¸ªoverlayfsç›®å½•ç»“æ„ã€‚ç„¶åï¼Œä½¿ç”¨ `unshare` ç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€ä¸ªæ–°çš„ user namespace å’Œ mount namespaceï¼Œå¹¶å°†å½“å‰ç”¨æˆ·çš„ uid å’Œ gid æ˜ å°„åˆ° root ç”¨æˆ·ã€‚ ä¹‹åï¼Œå®ƒæŒ‚è½½ overlayfsï¼Œå¤åˆ¶å½“å‰æ‰§è¡Œçš„ç¨‹åºåˆ° overlayfs çš„ merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½® capabilityã€‚æœ€åï¼Œæ‰§è¡Œå¤åˆ¶åˆ° overlayfs çš„ç¨‹åºã€‚
5. **æŠ•æ¯’é£é™©åˆ†æ:** ä»£ç æœ¬èº«å®ç°äº†æ¼æ´åˆ©ç”¨çš„åŠŸèƒ½ã€‚ æ½œåœ¨çš„æŠ•æ¯’é£é™©å¯èƒ½å­˜åœ¨äºä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š
    *   **ä¾èµ–é¡¹:**  ä»£ç ä¾èµ–äºæ ‡å‡†çš„Cåº“ï¼Œæœ¬èº«ä¸å­˜åœ¨æ¶æ„ä¾èµ–ã€‚ä½†ç”¨æˆ·åœ¨ç¼–è¯‘æ—¶éœ€è¦æ³¨æ„ç¼–è¯‘å™¨ç¯å¢ƒçš„å®‰å…¨æ€§ã€‚
    *   **ä»£ç é€»è¾‘:**  ä»£ç é€»è¾‘ç›¸å¯¹ç®€å•ï¼Œä¸»è¦é›†ä¸­åœ¨namespaceåˆ›å»ºã€æŒ‚è½½å’Œcapabilityè®¾ç½®ã€‚ ä»”ç»†å®¡æŸ¥ä»£ç ï¼Œæœªå‘ç°æ˜æ˜¾çš„æ¶æ„é€»è¾‘ã€‚
    *   **æ‰§è¡Œå‘½ä»¤:**  ä»£ç ä¸­ä½¿ç”¨äº† `system` å‡½æ•°ï¼Œè¿™æ˜¯ä¸€ä¸ªæ½œåœ¨çš„é£é™©ç‚¹ï¼Œå¯ä»¥æ‰§è¡Œä»»æ„ç³»ç»Ÿå‘½ä»¤ã€‚ä½†æ˜¯ï¼Œè¿™é‡Œåªæ˜¯ç”¨æ¥åˆ é™¤ç›®å½•ï¼Œç›¸å¯¹å®‰å…¨ã€‚
       ç»¼ä¸Šæ‰€è¿°ï¼Œè¯¥POCä»£ç ä¸»è¦é£é™©åœ¨äºç¡®ä¿ç¼–è¯‘ç¯å¢ƒå®‰å…¨ä»¥åŠå¯¹ä¸ç†Ÿæ‚‰çš„å‘½ä»¤ä¿æŒè­¦æƒ•ã€‚æŠ•æ¯’é£é™©è¾ƒä½ï¼Œé¢„ä¼°ä¸º5%ã€‚

**æ€»ç»“ï¼š**

è¯¥æ¼æ´åˆ©ç”¨çš„æ ¸å¿ƒåœ¨äºç»“åˆäº†æœªæˆæƒç”¨æˆ·å‘½åç©ºé—´å’ŒOverlayFSï¼Œåˆ©ç”¨OverlayFSå¯¹capabilitiesè®¾ç½®éªŒè¯çš„ç¼ºé™·ï¼Œå®ç°äº†æœ¬åœ°ææƒã€‚ æ”»å‡»è€…é€šè¿‡åˆ›å»ºç‰¹æ®Šçš„OverlayFSç»“æ„å¹¶è®¾ç½®æ–‡ä»¶capabilitiesï¼Œæœ€ç»ˆè·å¾—rootæƒé™ã€‚

**é¡¹ç›®åœ°å€:** [inspiringz/CVE-2021-3493](https://github.com/inspiringz/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #10

**æ¥æº**: [CVE-2021-3493-oneoy_CVE-2021-3493.md](../2021/CVE-2021-3493-oneoy_CVE-2021-3493.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœ¬åœ°ç”¨æˆ·å¯æå‡è‡³ root æƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu 4.4, 4.15, 5.4, and 5.8 kernels (å…·ä½“ç‰ˆæœ¬å·è§æ¼æ´åº“ä¿¡æ¯)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç›®æ ‡ç³»ç»Ÿå­˜åœ¨æœªä¿®å¤çš„ Ubuntu kernelï¼Œä¸”å¯ç”¨ unprivileged user namespaces å’Œå…è®¸ unprivileged overlayfs mountsã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

è¯¥æ¼æ´å­˜åœ¨äº Ubuntu å†…æ ¸çš„ OverlayFS å®ç°ä¸­ï¼Œç”±äºæœªæ­£ç¡®éªŒè¯ç”¨æˆ·å‘½åç©ºé—´ä¸­åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸Šæ–‡ä»¶ capabilities çš„è®¾ç½®ï¼Œå¯¼è‡´æœ¬åœ°æ”»å‡»è€…å¯åˆ©ç”¨ unprivileged user namespaces å’Œ Ubuntu å†…æ ¸ä¸­å…è®¸ unprivileged overlayfs mounts çš„è¡¥ä¸æ¥æå‡æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ (lower, upper, work, merge)ã€‚
2.  **é…ç½® User Namespace:** åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´ã€‚
3.  **é…ç½® OverlayFS:** ä½¿ç”¨ lowerdir, upperdir, å’Œ workdir é€‰é¡¹æŒ‚è½½ overlay æ–‡ä»¶ç³»ç»Ÿã€‚
4.  **è®¾ç½® Capabilities:** å°†å¯æ‰§è¡Œæ–‡ä»¶å¤åˆ¶åˆ° merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½®å…¶ capabilities (å¦‚ CAP_SETUID, CAP_SETGID, CAP_CHOWN)ã€‚
5.  **è§¦å‘ææƒ:** æ‰§è¡Œ merge ç›®å½•ä¸­çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶å°†ä¼šä»¥ root æƒé™æ‰§è¡Œã€‚

**æŠ•æ¯’é£é™©è¯„ä¼°ï¼š**

æä¾›çš„ `exploit.c` ä»£ç ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨ OverlayFS çš„æ¼æ´è¿›è¡Œææƒã€‚ä»£ç åˆ›å»ºå¿…è¦çš„ç›®å½•ï¼Œé…ç½® user namespace å’Œ overlay æ–‡ä»¶ç³»ç»Ÿï¼Œå¹¶è®¾ç½®å¯æ‰§è¡Œæ–‡ä»¶çš„ capabilitiesã€‚ä»£ç é€»è¾‘æ¸…æ™°ï¼Œæ²¡æœ‰å‘ç°æ¶æ„ä»£ç æˆ–åé—¨ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**

æä¾›çš„ POC ä»£ç åŸºäºå…¬å¼€ä¿¡æ¯ï¼Œå¹¶é’ˆå¯¹ CVE-2021-3493 æ¼æ´è¿›è¡Œäº†åˆ©ç”¨ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯ã€æœç´¢å¼•æ“ç»“æœå’Œä»£ç åˆ†æï¼Œè¯¥ POC ä»£ç åœ¨æ»¡è¶³æ¼æ´åˆ©ç”¨æ¡ä»¶çš„æƒ…å†µä¸‹åº”è¯¥æ˜¯æœ‰æ•ˆçš„ã€‚

**é¡¹ç›®åœ°å€:** [oneoy/CVE-2021-3493](https://github.com/oneoy/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #11

**æ¥æº**: [CVE-2021-3493-pmihsan_OverlayFS-CVE-2021-3493.md](../2021/CVE-2021-3493-pmihsan_OverlayFS-CVE-2021-3493.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœ¬åœ°ç”¨æˆ·å¯æå‡è‡³ root æƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu kernel versions: < 5.8.0-50.56 (5.8 kernel), < 5.4.0-72.80 (5.4 kernel), < 4.15.0-142.146 (4.15 kernel), < 4.4.0-209.241 (4.4 kernel)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦åœ¨å­˜åœ¨æ¼æ´çš„ Ubuntu ç³»ç»Ÿä¸Šæ‰§è¡Œï¼Œå¹¶ä¸”å…è®¸ unprivileged user namespaces å’Œ overlay mountsã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

CVE-2021-3493 æ¼æ´å­˜åœ¨äº Linux å†…æ ¸çš„ overlayfs å®ç°ä¸­ã€‚ç”±äºå¯¹ç”¨æˆ·å‘½åç©ºé—´ä¸­åº•å±‚æ–‡ä»¶ç³»ç»Ÿæ–‡ä»¶ capabilities çš„éªŒè¯ä¸è¶³ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡åˆ›å»ºæ¶æ„çš„ overlayfs æ–‡ä»¶ç³»ç»Ÿï¼Œåˆ©ç”¨ setxattr è®¾ç½®æ–‡ä»¶ capabilitiesï¼Œä»è€Œè·å¾—æå‡çš„æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** åˆ›å»º overlayfs æ‰€éœ€çš„ç›®å½•ç»“æ„ (lower, upper, work, merge)ã€‚
2.  **Namespace åˆ›å»ºï¼š** åˆ›å»ºæ–°çš„ user namespace å’Œ mount namespaceï¼Œéš”ç¦»æƒé™ã€‚
3.  **æƒé™è®¾ç½®ï¼š** ä¿®æ”¹ uid_map å’Œ gid_mapï¼Œä½¿å¾—åœ¨ user namespace ä¸­æ‹¥æœ‰ root æƒé™ã€‚
4.  **Overlayfs Mountï¼š** ä½¿ç”¨ overlayfs mount å‘½ä»¤å°† lowerdir, upperdir, workdir æŒ‚è½½åˆ° mergedirã€‚
5.  **Capabilities è®¾ç½®ï¼š** å¤åˆ¶è‡ªèº«ç¨‹åºåˆ° merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` å‡½æ•°ä¸ºå¤åˆ¶åçš„ç¨‹åºè®¾ç½® capabilities (CAP_SETUID, CAP_SETGID, CAP_DAC_OVERRIDE ç­‰)ã€‚
6.  **æƒé™æå‡ï¼š** æ‰§è¡Œ merge ç›®å½•ä¸‹çš„ç¨‹åºï¼Œæ­¤æ—¶ç¨‹åºå°†ä»¥ root æƒé™è¿è¡Œã€‚

**æœ‰æ•ˆæ€§ï¼š**

æä¾›çš„ POC ä»£ç é€šè¿‡åˆ©ç”¨ overlayfs æ¼æ´ï¼Œå¯ä»¥æˆåŠŸåœ°æå‡æƒé™ã€‚POC ä»£ç é¦–å…ˆåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼Œç„¶ååˆ›å»ºä¸€ä¸ªæ–°çš„ user namespace å’Œ mount namespaceï¼Œæ¥ç€æŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿï¼Œå¹¶ä½¿ç”¨ `setxattr` å‡½æ•°ä¸ºæ–‡ä»¶è®¾ç½® capabilitiesã€‚æœ€åï¼Œæ‰§è¡Œè¯¥æ–‡ä»¶å³å¯è·å¾— root æƒé™ã€‚

**æŠ•æ¯’é£é™©ï¼š**

åˆ†æ POC ä»£ç ï¼Œæ²¡æœ‰å‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç ï¼Œä¾‹å¦‚åå¼¹ shellã€å®‰è£…åé—¨ç­‰ã€‚ä»£ç é€»è¾‘ä¸»è¦é›†ä¸­åœ¨åˆ©ç”¨ overlayfs æ¼æ´ææƒï¼Œå¹¶æ²¡æœ‰é¢å¤–çš„æ“ä½œæ¥æ¤å…¥æ¶æ„ç¨‹åºã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ï¼Œå¯ä»¥è®¤ä¸ºæ˜¯ 0%ã€‚å‚è€ƒçš„ vulnerability description å’Œ exploit ä»£ç éƒ½ç€é‡äºææƒï¼Œè€Œæ²¡æœ‰æåˆ°ä»»ä½•æŠ•æ¯’è¡Œä¸ºã€‚

**é¡¹ç›®åœ°å€:** [pmihsan/OverlayFS-CVE-2021-3493](https://github.com/pmihsan/OverlayFS-CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #12

**æ¥æº**: [CVE-2021-3493-ptkhai15_OverlayFS---CVE-2021-3493.md](../2021/CVE-2021-3493-ptkhai15_OverlayFS---CVE-2021-3493.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Ubuntu Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœ¬åœ°ç”¨æˆ·æå‡æƒé™è‡³ root

**å½±å“ç‰ˆæœ¬:** Ubuntu kernel versions 5.8, 5.4, 4.15, å’Œ 4.4 ä¸­å—å½±å“çš„ç‰ˆæœ¬ï¼ˆå…·ä½“ç‰ˆæœ¬å‚è§æ¼æ´åº“ä¿¡æ¯ï¼‰

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡ç³»ç»Ÿå¿…é¡»æ˜¯å—å½±å“çš„ Ubuntu ç‰ˆæœ¬ï¼Œå¹¶ä¸”å¯ç”¨äº†éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å’Œéç‰¹æƒ overlayfs æŒ‚è½½ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

CVE-2021-3493 æ˜¯ Ubuntu Linux å†…æ ¸ä¸­ OverlayFS å®ç°ä¸­çš„ä¸€ä¸ªæ¼æ´ã€‚è¯¥æ¼æ´å…è®¸éç‰¹æƒç”¨æˆ·åˆ©ç”¨ç”¨æˆ·å‘½åç©ºé—´å’Œéç‰¹æƒ overlayfs æŒ‚è½½ï¼Œé€šè¿‡ä¸æ­£ç¡®åœ°éªŒè¯åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­æ–‡ä»¶çš„ capabilities è®¾ç½®æ¥æå‡æƒé™ã€‚åˆ©ç”¨æ–¹å¼å¦‚ä¸‹ï¼š

1.  **ç¯å¢ƒå‡†å¤‡ï¼š**  åˆ›å»ºä¸€ä¸ªåŸºç¡€ç›®å½•ç»“æ„ï¼ŒåŒ…æ‹¬ workã€lowerã€upper å’Œ merge ç›®å½•ï¼Œè¿™æ˜¯ overlayfs çš„æ ‡å‡†é…ç½®ã€‚
2.  **åˆ›å»ºç”¨æˆ·å‘½åç©ºé—´ï¼š**  ä½¿ç”¨ `unshare` å‘½ä»¤åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´ã€‚è¿™å…è®¸åœ¨æ–°çš„å‘½åç©ºé—´ä¸­æ‹¥æœ‰ä¸åŒçš„ç”¨æˆ·å’Œç»„ IDã€‚
3.  **é…ç½®ç”¨æˆ·å’Œç»„æ˜ å°„ï¼š**  é€šè¿‡ `/proc/self/setgroups`ã€`/proc/self/uid_map` å’Œ `/proc/self/gid_map` æ–‡ä»¶è®¾ç½®ç”¨æˆ·å’Œç»„ ID æ˜ å°„ï¼Œå°†å½“å‰ç”¨æˆ·çš„ UID å’Œ GID æ˜ å°„åˆ°æ–°å‘½åç©ºé—´ä¸­çš„ root ç”¨æˆ·ã€‚
4.  **æŒ‚è½½ OverlayFSï¼š**  ä½¿ç”¨ `mount` å‘½ä»¤æŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿï¼Œå°† lowerã€upper å’Œ work ç›®å½•å…³è”èµ·æ¥ã€‚
5.  **è®¾ç½®æ–‡ä»¶ capabilitiesï¼š**  å¤åˆ¶å½“å‰æ‰§è¡Œç¨‹åºåˆ° overlayfs çš„ merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½®æ–‡ä»¶çš„ capabilities ä¸º `all+ep`ï¼Œå…è®¸è¯¥æ–‡ä»¶æ‰§è¡Œæ—¶æ‹¥æœ‰ root æƒé™ã€‚
6.  **æ‰§è¡Œææƒåçš„ç¨‹åºï¼š**  æ‰§è¡Œä½äº upper ç›®å½•ä¸­çš„å¤åˆ¶åçš„ç¨‹åºã€‚å¦‚æœç¨‹åºæ£€æµ‹åˆ°è‡ªå·±æ˜¯é€šè¿‡ç‰¹å®šæ–¹å¼ï¼ˆä¾‹å¦‚ï¼ŒåŒ…å« "magic" å­—ç¬¦ä¸²æˆ–æ¥å— "shell" å‚æ•°ï¼‰è°ƒç”¨çš„ï¼Œå®ƒä¼šè°ƒç”¨ `setuid(0)` å’Œ `setgid(0)` å°†è¿›ç¨‹çš„ UID å’Œ GID è®¾ç½®ä¸º 0 (root)ï¼Œå¹¶å¯åŠ¨ä¸€ä¸ª root shellã€‚

**å…³äºæŠ•æ¯’é£é™©ï¼š**

åœ¨æä¾›çš„ POC ä»£ç ä¸­ï¼Œæ²¡æœ‰æ˜æ˜¾çš„æŠ•æ¯’ä»£ç ã€‚POC çš„ç›®çš„æ˜¯æ¼”ç¤ºæ¼æ´åˆ©ç”¨è¿‡ç¨‹ï¼Œæ²¡æœ‰å‘ç°æ¶æ„è¡Œä¸ºï¼Œä¾‹å¦‚åå‘ shell æˆ–å…¶ä»–æœªç»æˆæƒçš„è®¿é—®ã€‚


**é¡¹ç›®åœ°å€:** [ptkhai15/OverlayFS---CVE-2021-3493](https://github.com/ptkhai15/OverlayFS---CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #13

**æ¥æº**: [CVE-2021-3493-puckiestyle_CVE-2021-3493.md](../2021/CVE-2021-3493-puckiestyle_CVE-2021-3493.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ”»å‡»è€…å¯åˆ©ç”¨æ­¤æ¼æ´è·å¾— root æƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu 5.8 kernel (< 5.8.0-50.56), 5.4 kernel (< 5.4.0-72.80), 4.15 kernel (< 4.15.0-142.146), 4.4 kernel (< 4.4.0-209.241)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ Ubuntu ç³»ç»Ÿå¼€å¯ unprivileged user namespaces å’Œå…è®¸ unprivileged overlay mounts

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2021-3493 æ˜¯ Ubuntu å†…æ ¸ overlayfs å®ç°ä¸­çš„ä¸€ä¸ªæ¼æ´ï¼Œå…è®¸æœ¬åœ°æ”»å‡»è€…é€šè¿‡æ»¥ç”¨ user namespaces å’Œ overlayfs æŒ‚è½½æœºåˆ¶æå‡æƒé™ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**
æä¾›çš„ POC ä»£ç å°è¯•åˆ©ç”¨è¯¥æ¼æ´ï¼Œé€šè¿‡åˆ›å»º user namespace å’Œ overlayfs æ–‡ä»¶ç³»ç»Ÿæ¥è®¾ç½®å¯æ‰§è¡Œæ–‡ä»¶çš„ capability ä½ï¼Œä½¿å…¶è·å¾— root æƒé™ã€‚ æ¼æ´åº“ä¿¡æ¯,æœç´¢å¼•æ“ç»“æœå’Œæ¼æ´åˆ©ç”¨ä»£ç ä¸€è‡´,è¡¨æ˜è¯¥æ¼æ´çš„POCæ˜¯çœŸå®æœ‰æ•ˆçš„ã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**
æŸ¥çœ‹ `exploit.c` ä»£ç ï¼Œä¸»è¦æ“ä½œåŒ…æ‹¬åˆ›å»ºç›®å½•ã€è®¾ç½® user namespaceã€æŒ‚è½½ overlayfsã€å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶ã€è®¾ç½® capability å±æ€§ï¼Œä»¥åŠæ‰§è¡Œå¤åˆ¶åçš„æ–‡ä»¶ä»¥è·å¾— root æƒé™ã€‚ä»£ç é€»è¾‘è¾ƒä¸ºæ¸…æ™°ï¼Œæœªå‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç ã€‚`README.md` ä¹Ÿè¯´æ˜äº†å¹¶éä½œè€…åŸåˆ›,åªæ˜¯æ¬è¿,å¢åŠ äº†åˆ†æéš¾åº¦.
`exploit.c`ä¸­å­˜åœ¨`system(buf);` è°ƒç”¨ï¼Œè™½ç„¶è¿™é‡Œæ˜¯ç”¨äºæ¸…ç†ç›®å½•ï¼Œä½†å¦‚æœè¢«ç¯¡æ”¹ï¼Œå¯èƒ½æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£é™©è¯„ä¼°ä¸º10%ã€‚ä¸»è¦çš„é£é™©åœ¨äºï¼š

*   `system()` å‡½æ•°æ½œåœ¨çš„å‘½ä»¤æ³¨å…¥é£é™©ï¼Œå¦‚æœä»£ç è¢«ä¿®æ”¹ï¼Œå¯èƒ½å¯¼è‡´æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  åˆ©ç”¨ unshare() åˆ›å»ºä¸€ä¸ªæ–°çš„ user namespace å’Œ mount namespaceã€‚
2.  é…ç½® user namespace çš„ uid_map å’Œ gid_mapï¼Œå°†å½“å‰ç”¨æˆ·æ˜ å°„ä¸º root ç”¨æˆ·ã€‚
3.  åˆ›å»º overlayfs æ‰€éœ€çš„ç›®å½•ç»“æ„ï¼ˆlowerdirã€upperdirã€workdirã€mergedï¼‰ã€‚
4.  æŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿã€‚
5.  å°†æ¼æ´åˆ©ç”¨ç¨‹åºè‡ªèº«å¤åˆ¶åˆ° overlayfs çš„ upperdir/merged ç›®å½•ã€‚
6.  ä½¿ç”¨ setxattr() è®¾ç½®å¤åˆ¶åçš„å¯æ‰§è¡Œæ–‡ä»¶çš„ security.capability å±æ€§ï¼Œèµ‹äºˆå…¶ CAP_SETUID å’Œ CAP_SETGID æƒé™ã€‚
7.  æ‰§è¡Œå¤åˆ¶åçš„ç¨‹åºï¼Œç”±äºè®¾ç½®äº† capabilityï¼Œè¯¥ç¨‹åºä¼šä»¥ root æƒé™è¿è¡Œï¼Œä»è€Œè·å¾— root shellã€‚

**é¡¹ç›®åœ°å€:** [puckiestyle/CVE-2021-3493](https://github.com/puckiestyle/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #14

**æ¥æº**: [CVE-2021-3493-smallkill_CVE-2021-3493.md](../2021/CVE-2021-3493-smallkill_CVE-2021-3493.md)

# CVE-2021-3493

> ğŸ“¦ è¯¥CVEæœ‰ **15** ä¸ªç›¸å…³POCä»“åº“

---

## POC #1

**æ¥æº**: [CVE-2021-3493-Abdennour-py_CVE-2021-3493.md](../2021/CVE-2021-3493-Abdennour-py_CVE-2021-3493.md)

## CVE-2021-3493 Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å¯¼è‡´æ™®é€šç”¨æˆ·æå‡ä¸ºrootæƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu 5.8 kernel < 5.8.0-50.56, 5.4 kernel < 5.4.0-72.80, 4.15 kernel < 4.15.0-142.146, 4.4 kernel < 4.4.0-209.241

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç›®æ ‡ç³»ç»Ÿè¿è¡Œå—å½±å“çš„Ubuntuå†…æ ¸ï¼Œå¹¶ä¸”å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿå’Œä½¿ç”¨user namespace

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

è¯¥æ¼æ´æºäºUbuntuå†…æ ¸ä¸­overlayfså®ç°å¯¹ç”¨æˆ·å‘½åç©ºé—´ä¸­çš„æ–‡ä»¶èƒ½åŠ›éªŒè¯ä¸å½“ã€‚ç»“åˆéç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å’ŒUbuntuå†…æ ¸ä¸­çš„å…è®¸éç‰¹æƒ overlayfs æŒ‚è½½çš„è¡¥ä¸ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´è·å¾—æå‡çš„æƒé™ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**

æä¾›çš„POCä»£ç çœ‹èµ·æ¥æ˜¯æœ‰æ•ˆçš„ã€‚å®ƒåˆ©ç”¨äº† overlayfs å’Œ user namespace çš„ç»„åˆæ¥è®¾ç½®æ–‡ä»¶ capabilityï¼Œä»è€Œå®ç°ææƒã€‚ä»£ç é¦–å…ˆåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼ˆlower, upper, work, mergeï¼‰ï¼Œç„¶åä½¿ç”¨ `unshare` åˆ›å»ºä¸€ä¸ªæ–°çš„ user namespace å’Œ mount namespaceã€‚æ¥ç€ï¼Œå®ƒå†™å…¥ `/proc/self/setgroups`, `/proc/self/uid_map`, å’Œ `/proc/self/gid_map` æ¥è®¾ç½®ç”¨æˆ·å’Œç»„çš„æ˜ å°„ã€‚ç„¶åï¼ŒæŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿï¼Œæ‹·è´è‡ªèº«å¯æ‰§è¡Œæ–‡ä»¶åˆ° overlayfs çš„ merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½® capabilitiesã€‚æœ€åï¼Œå®ƒæ‰§è¡Œä½äº upper ç›®å½•çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶ä¼šå°è¯•ä»¥ root æƒé™æ‰§è¡Œ /bin/bashã€‚

æ ¹æ®æ¼æ´åº“ä¿¡æ¯ï¼ŒCISA å°†æ­¤æ¼æ´æ·»åŠ åˆ°å·²çŸ¥è¢«åˆ©ç”¨çš„æ¼æ´åˆ—è¡¨ä¸­ï¼Œè¿›ä¸€æ­¥è¡¨æ˜äº†è¯¥æ¼æ´çš„æœ‰æ•ˆæ€§ã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

æ£€æŸ¥æä¾›çš„ exploit.c ä»£ç ï¼Œæ²¡æœ‰å‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç æˆ–åé—¨ã€‚ä»£ç é€»è¾‘æ¸…æ™°ï¼Œä¸»è¦æ‰§è¡Œäº† overlayfs çš„æŒ‚è½½ï¼Œæ–‡ä»¶å¤åˆ¶ï¼Œè®¾ç½® xattr å’Œæ‰§è¡Œ shell æ“ä½œã€‚ä»£ç çš„æ„å›¾ä¸æ¼æ´æè¿°ä¸€è‡´ï¼Œæ²¡æœ‰å‘ç°éšè—çš„ã€ä¸æ¼æ´åˆ©ç”¨æ— å…³çš„æ¶æ„è¡Œä¸ºã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£é™©ä¸º 0%ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š**  åœ¨å­˜åœ¨æ¼æ´çš„Ubuntuç³»ç»Ÿä¸Šï¼Œåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ (ovlcap/work, ovlcap/lower, ovlcap/upper, ovlcap/merge)ã€‚
2.  **User Namespaceå’ŒMount Namespaceï¼š** ä½¿ç”¨ `unshare` ç³»ç»Ÿè°ƒç”¨åˆ›å»ºæ–°çš„ user namespace å’Œ mount namespaceã€‚
3.  **IDæ˜ å°„ï¼š**  é…ç½® `/proc/self/setgroups`ï¼Œ`/proc/self/uid_map` å’Œ `/proc/self/gid_map`ï¼Œä»¥ä¾¿åœ¨ user namespace ä¸­è·å¾—æœ‰æ•ˆçš„ç”¨æˆ· ID å’Œç»„ IDã€‚
4.  **OverlayFSæŒ‚è½½ï¼š**  ä½¿ç”¨ `mount` ç³»ç»Ÿè°ƒç”¨æŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿï¼Œå°† lower, upper å’Œ work ç›®å½•å…³è”èµ·æ¥ã€‚
5.  **æ–‡ä»¶æ‹·è´ä¸ Capability è®¾ç½®ï¼š**  å°† exploit ç¨‹åºè‡ªèº«æ‹·è´åˆ° overlayfs çš„ merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½® `security.capability` å±æ€§ï¼Œèµ‹äºˆå…¶ CAP_SETUID å’Œ CAP_SETGID ç­‰æƒé™ã€‚
6.  **ææƒæ‰§è¡Œï¼š** æ‰§è¡Œä½äº upper ç›®å½•çš„ exploit ç¨‹åºçš„æ‹·è´ã€‚ç”±äºè¯¥æ–‡ä»¶å…·æœ‰ capabilitiesï¼Œå› æ­¤å¯ä»¥ä»¥ root æƒé™æ‰§è¡Œ shellã€‚

**é¡¹ç›®åœ°å€:** [Abdennour-py/CVE-2021-3493](https://github.com/Abdennour-py/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #2

**æ¥æº**: [CVE-2021-3493-Sornphut_OverlayFS---CVE-2021-3493.md](../2021/CVE-2021-3493-Sornphut_OverlayFS---CVE-2021-3493.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒæ¼æ´

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Ubuntu Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœ¬åœ°ç”¨æˆ·è·å¾— root æƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu kernels before 5.8.0-50.56, 5.4.0-72.80, 4.15.0-142.146, and 4.4.0-209.241

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦è¿è¡Œåœ¨å­˜åœ¨æ¼æ´çš„ Ubuntu å†…æ ¸ä¸Šï¼Œå¹¶ä¸”å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½ overlayfsã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

è¯¥æ¼æ´å­˜åœ¨äº Ubuntu Linux å†…æ ¸çš„ overlayfs å®ç°ä¸­ã€‚ç”±äº Ubuntu å¯¹ overlayfs æŒ‚è½½çš„ç‰¹å®šä¿®æ”¹ï¼Œå¯¼è‡´åœ¨ç”¨æˆ·å‘½åç©ºé—´å†…ï¼Œå¯¹åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­çš„æ–‡ä»¶ capabilities éªŒè¯ä¸å……åˆ†ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡ overlayfs æŒ‚è½½ç»•è¿‡ capabilities æ£€æŸ¥ï¼Œè®¾ç½®æ–‡ä»¶ capabilities æå‡æƒé™ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  åˆ›å»ºä¸€ä¸ªç›®å½•ç»“æ„ï¼ŒåŒ…æ‹¬ lower, upper, work å’Œ merge ç›®å½•ã€‚
2.  ä½¿ç”¨ `unshare` åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´å’ŒæŒ‚è½½å‘½åç©ºé—´ã€‚
3.  é…ç½® `/proc/self/setgroups`, `/proc/self/uid_map`, å’Œ `/proc/self/gid_map` ä»¥æ˜ å°„ç”¨æˆ· ID å’Œç»„ IDã€‚
4.  ä½¿ç”¨ `mount` å‘½ä»¤æŒ‚è½½ overlayfsï¼Œå°† lower, upper å’Œ work ç›®å½•ä¸ merge ç›®å½•å…³è”èµ·æ¥ã€‚
5.  åœ¨ upper ç›®å½•æˆ– merge ç›®å½•ä¸‹åˆ›å»ºæˆ–å¤åˆ¶ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ã€‚
6.  ä½¿ç”¨ `setxattr` è®¾ç½®å¯æ‰§è¡Œæ–‡ä»¶çš„ capabilitiesï¼Œèµ‹äºˆå…¶ root æƒé™ã€‚
7.  æ‰§è¡Œè¯¥æ–‡ä»¶ï¼Œå³å¯è·å¾— root æƒé™ã€‚

**æœ‰æ•ˆæ€§ï¼š**

æä¾›çš„ POC ä»£ç å°è¯•åˆ©ç”¨ CVE-2021-3493 æ¼æ´ã€‚è¯¥ä»£ç åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´å’ŒæŒ‚è½½å‘½åç©ºé—´ï¼Œå¹¶å°è¯•æŒ‚è½½ overlayfsã€‚ç„¶åï¼Œå®ƒåº”è¯¥è®¾ç½® `magic` äºŒè¿›åˆ¶æ–‡ä»¶çš„ capabilitiesï¼Œä»è€Œè·å¾— root æƒé™ã€‚æ ¹æ®æ¼æ´æè¿°ï¼Œè¯¥ POC åº”è¯¥èƒ½å¤Ÿæœ‰æ•ˆåˆ©ç”¨è¯¥æ¼æ´ã€‚

**æŠ•æ¯’é£é™©ï¼š**

æ£€æŸ¥æä¾›çš„ exploit.c æ–‡ä»¶ï¼Œæœªå‘ç°æ˜æ˜¾çš„æ¶æ„æˆ–éšè—ä»£ç ã€‚ä»£ç é€»è¾‘ä¸»è¦é›†ä¸­äºè®¾ç½® overlayfs æŒ‚è½½å’Œæ–‡ä»¶ capabilitiesã€‚ä½†æ˜¯ï¼Œéœ€è¦å§‹ç»ˆè°¨æ…å¯¹å¾…æ¥è‡ªä¸å—ä¿¡ä»»æ¥æºçš„ä»£ç ã€‚ä¸ºäº†ç¡®ä¿å®‰å…¨ï¼Œå»ºè®®åœ¨å—æ§ç¯å¢ƒä¸­ä»”ç»†å®¡æŸ¥å’Œæµ‹è¯•ä»£ç ã€‚


**é¡¹ç›®åœ°å€:** [Sornphut/OverlayFS---CVE-2021-3493](https://github.com/Sornphut/OverlayFS---CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #3

**æ¥æº**: [CVE-2021-3493-briskets_CVE-2021-3493.md](../2021/CVE-2021-3493-briskets_CVE-2021-3493.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å¯¼è‡´æ™®é€šç”¨æˆ·æƒé™æå‡è‡³rootæƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu kernel versions: < 5.8.0-50.56 (5.8 kernel), < 5.4.0-72.80 (5.4 kernel), < 4.15.0-142.146 (4.15 kernel), < 4.4.0-209.241 (4.4 kernel)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦åœ¨å­˜åœ¨æ¼æ´çš„Ubuntuå†…æ ¸ç‰ˆæœ¬ä¸Šï¼Œå¹¶ä¸”å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½overlayfs

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 5%

## è¯¦æƒ…

CVE-2021-3493 æ¼æ´æ˜¯ç”±äº Linux å†…æ ¸çš„ overlayfs å®ç°æ²¡æœ‰æ­£ç¡®éªŒè¯ç”¨æˆ·å‘½åç©ºé—´ä¸­åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸Šæ–‡ä»¶ capabilities çš„è®¾ç½®ã€‚ç”±äº Ubuntu å†…æ ¸ä¸­å­˜åœ¨å…è®¸éç‰¹æƒ overlay æŒ‚è½½çš„è¡¥ä¸ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´è·å¾—æå‡çš„æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  æ¼æ´åˆ©ç”¨ä»£ç é¦–å…ˆåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ (ovlcap/work, ovlcap/lower, ovlcap/upper, ovlcap/merge)ã€‚
2.  åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´å’ŒæŒ‚è½½å‘½åç©ºé—´ã€‚
3.  åœ¨æ–°çš„ç”¨æˆ·å‘½åç©ºé—´ä¸­ï¼Œå°†å½“å‰ç”¨æˆ·çš„ UID å’Œ GID æ˜ å°„åˆ° root ç”¨æˆ·ã€‚
4.  ä½¿ç”¨ overlayfs å°† lowerdir (ovlcap/lower), upperdir (ovlcap/upper) å’Œ workdir (ovlcap/work) æŒ‚è½½åˆ° mergedir (ovlcap/merge)ã€‚
5.  å¤åˆ¶è‡ªèº« (exploit ç¨‹åº) åˆ° mergedir/magicï¼Œå¹¶è®¾ç½® security.capability æ‰©å±•å±æ€§ä¸º all+epï¼Œèµ‹äºˆè¯¥æ–‡ä»¶ capabilitiesã€‚
6.  æ‰§è¡Œ mergedir/magicï¼Œç”±äº capabilities çš„è®¾ç½®ï¼Œè¯¥ç¨‹åºä¼šä»¥ root æƒé™æ‰§è¡Œã€‚
7.  æœ€åï¼Œæ‰§è¡Œ upperdir/magicï¼Œå¯åŠ¨ä¸€ä¸ª root shellã€‚

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„POCä»£ç æ˜¯æœ‰æ•ˆçš„ï¼Œèƒ½å¤Ÿåˆ©ç”¨ CVE-2021-3493 æ¼æ´åœ¨å—å½±å“çš„ Ubuntu ç³»ç»Ÿä¸Šå®ç°æœ¬åœ°ææƒã€‚

**æŠ•æ¯’é£é™©ï¼š**
è¯¥POCä»£ç çš„ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´è¿›è¡Œææƒï¼Œä½†ä»ç„¶å­˜åœ¨æ½œåœ¨çš„æŠ•æ¯’é£é™©ã€‚æ¯”å¦‚ä½œè€…å¯èƒ½åœ¨ç¼–è¯‘å’Œè¿è¡Œå‰æ·»åŠ ä¸€äº›æ¶æ„ä»£ç ï¼Œä¾‹å¦‚ï¼š

1.  **åé—¨æ¤å…¥ï¼š** åœ¨ææƒæˆåŠŸåï¼Œæ¤å…¥ä¸€ä¸ªåé—¨ç¨‹åºï¼Œå…è®¸æ”»å‡»è€…è¿œç¨‹è®¿é—®ç³»ç»Ÿã€‚
2.  **æ•°æ®çªƒå–ï¼š** åœ¨ææƒè¿‡ç¨‹ä¸­ï¼Œçªƒå–ç”¨æˆ·çš„æ•æ„Ÿæ•°æ®ã€‚
3.  **ç ´åç³»ç»Ÿï¼š** åœ¨ææƒå¤±è´¥æˆ–è€…æˆåŠŸåï¼Œç ´åç³»ç»Ÿæ–‡ä»¶æˆ–è€…é…ç½®ã€‚

è€ƒè™‘åˆ°ä»£ç ç›¸å¯¹ç®€çŸ­ä¸”åŠŸèƒ½æ˜ç¡®ï¼Œè¯„ä¼°æŠ•æ¯’é£é™©ä¸º5%ã€‚ç”¨æˆ·éœ€è¦ä»”ç»†å®¡æŸ¥ä»£ç ï¼Œå¹¶åœ¨å®‰å…¨çš„ç¯å¢ƒä¸­è¿›è¡Œæµ‹è¯•ã€‚

**é¡¹ç›®åœ°å€:** [briskets/CVE-2021-3493](https://github.com/briskets/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #4

**æ¥æº**: [CVE-2021-3493-cyberx-1_OverlayFS-CVE-2021-3493.md](../2021/CVE-2021-3493-cyberx-1_OverlayFS-CVE-2021-3493.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯ä»æ™®é€šç”¨æˆ·ææƒè‡³root

**å½±å“ç‰ˆæœ¬:** Ubuntu kernels: 5.8.0-50.56 (5.8 kernel), 5.4.0-72.80 (5.4 kernel), 4.15.0-142.146 (4.15 kernel), 4.4.0-209.241 (4.4 kernel)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦è¿è¡Œåœ¨å­˜åœ¨æ¼æ´çš„Ubuntuå†…æ ¸ç‰ˆæœ¬ä¸Šï¼Œå¯ç”¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å’Œå…è®¸éç‰¹æƒ overlay mountsã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2021-3493æ˜¯Ubuntuå†…æ ¸OverlayFSå®ç°ä¸­çš„ä¸€ä¸ªæƒé™æå‡æ¼æ´ã€‚ç”±äºoverlayfsåœ¨ç”¨æˆ·å‘½åç©ºé—´ä¸­æ²¡æœ‰æ­£ç¡®éªŒè¯åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­æ–‡ä»¶åŠŸèƒ½è®¾ç½®ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å’ŒUbuntuå†…æ ¸ä¸­çš„éç‰¹æƒoverlayæŒ‚è½½è¡¥ä¸ï¼Œè·å–æå‡çš„æƒé™ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** åœ¨å­˜åœ¨æ¼æ´çš„Ubuntuå†…æ ¸ä¸Šï¼Œç¡®ä¿å¯ç”¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´ã€‚æ¼æ´åº“ä¿¡æ¯æåˆ°ç¦ç”¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å¯ä»¥ä½œä¸ºç¼“è§£æªæ–½ï¼Œæ‰€ä»¥è¦ç¡®ä¿å¯ç”¨ã€‚
2.  **åˆ›å»ºOverlayFSç»“æ„ï¼š** PoCä»£ç é¦–å…ˆåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼ˆlower, upper, work, mergeï¼‰ç”¨äº overlayfs æ–‡ä»¶ç³»ç»Ÿã€‚
3.  **åˆ›å»ºç”¨æˆ·å‘½åç©ºé—´ï¼š** ä½¿ç”¨`unshare`ç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´ã€‚è¿™å…è®¸åœ¨æ–°çš„å‘½åç©ºé—´ä¸­æ‹¥æœ‰ä¸åŒçš„ç”¨æˆ·IDå’Œç»„IDæ˜ å°„ã€‚
4.  **è®¾ç½®UID/GIDæ˜ å°„ï¼š** å°†å½“å‰ç”¨æˆ·çš„UIDå’ŒGIDæ˜ å°„åˆ°æ–°å‘½åç©ºé—´ä¸­çš„rootç”¨æˆ· (UID 0 å’Œ GID 0)ã€‚
5.  **æŒ‚è½½OverlayFSï¼š** ä½¿ç”¨`mount`ç³»ç»Ÿè°ƒç”¨å°† overlayfs æ–‡ä»¶ç³»ç»ŸæŒ‚è½½åˆ° merge ç›®å½•ã€‚æŒ‡å®š lowerdir, upperdir å’Œ workdirã€‚
6.  **å¤åˆ¶è‡ªèº«å¹¶è®¾ç½®Capabilitiesï¼š** å°†è‡ªèº«å¯æ‰§è¡Œæ–‡ä»¶å¤åˆ¶åˆ° overlayfs çš„ merge ç›®å½•ï¼Œç„¶åä½¿ç”¨`setxattr`è®¾ç½®`security.capability`æ‰©å±•å±æ€§ï¼Œèµ‹äºˆè¯¥æ–‡ä»¶ root æƒé™ã€‚
7.  **æ‰§è¡Œææƒåçš„ç¨‹åºï¼š** é€šè¿‡æ‰§è¡Œ upper ç›®å½•ä¸‹çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆä¹‹å‰å¤åˆ¶å¹¶è®¾ç½®äº† capabilities çš„æ–‡ä»¶ï¼‰æ¥è·å– root æƒé™ã€‚è¿™ä¸ªç¨‹åºä¼šæ£€æŸ¥æ˜¯å¦æœ‰"shell"å‚æ•°ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™ä¼šé‡æ–°æ‰§è¡Œè‡ªèº«ï¼Œä½†è¿™æ¬¡ä¼šå¸¦æœ‰`shell`å‚æ•°ï¼Œä»è€Œè§¦å‘`setuid(0)`å’Œ`setgid(0)`ï¼Œæœ€ç»ˆæ‰§è¡Œ`/bin/bash`ï¼Œè·å¾— root shellã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

ä»£ç ä¸­å­˜åœ¨ä¸€å®šçš„æŠ•æ¯’é£é™©ï¼Œè™½ç„¶ä¸»è¦é€»è¾‘æ˜¯åˆ©ç”¨æ¼æ´è¿›è¡Œææƒï¼Œä½†å­˜åœ¨ä¿®æ”¹`/bin/bash`çš„å¯èƒ½æ€§ï¼Œä½†æ˜¯ç»è¿‡ä»£ç åˆ†æä»¥åŠæ¼æ´åŸç†ï¼Œåˆ¤æ–­æ¼æ´åˆ©ç”¨è¿‡ç¨‹ä¸­æ²¡æœ‰ä¿®æ”¹`/bin/bash`æ“ä½œ,ä»£ç ä¸­é£é™©ä¸»è¦å­˜åœ¨äºä»¥ä¸‹å‡ ç‚¹:

1.  **ä¾èµ–å¤–éƒ¨äºŒè¿›åˆ¶æ–‡ä»¶ï¼š** è¯¥æ¼æ´åˆ©ç”¨ä¾èµ–äºç³»ç»Ÿä¸Šçš„`/bin/bash`ã€‚å¦‚æœæ”»å‡»è€…æ›¿æ¢æˆ–ç¯¡æ”¹äº†ç›®æ ‡ç³»ç»Ÿä¸Šçš„`/bin/bash`ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ„å¤–çš„è¡Œä¸ºæˆ–å®‰å…¨é—®é¢˜ã€‚
2.  **æ¸…ç†æ“ä½œé£é™©ï¼š** ä»£ç å¼€å§‹æ—¶ä½¿ç”¨`system(buf)`æ‰§è¡Œ`rm -rf '%s/'`ï¼Œå¦‚æœ`DIR_BASE`è¢«æ¶æ„ä¿®æ”¹ï¼Œå¯èƒ½å¯¼è‡´æ„å¤–çš„æ–‡ä»¶åˆ é™¤ã€‚
3.  **ä¸å®Œå–„çš„é”™è¯¯å¤„ç†ï¼š** è™½ç„¶ PoC ä»£ç åŒ…å«äº†ä¸€äº›é”™è¯¯å¤„ç†ï¼Œä½†åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå¦‚æœé”™è¯¯å¤„ç†ä¸å½“ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ‹’ç»æœåŠ¡æˆ–æœªå®šä¹‰çš„è¡Œä¸ºã€‚

æ€»ä½“è€Œè¨€ï¼Œè¯¥ PoC ä»£ç çš„æŠ•æ¯’é£é™©è¾ƒä½ï¼Œä¸»è¦é£é™©åœ¨äºä¾èµ–å¤–éƒ¨äºŒè¿›åˆ¶æ–‡ä»¶å’Œæ½œåœ¨çš„æ¸…ç†æ“ä½œé£é™©ã€‚ä»£ç æœ¬èº«ä¸»è¦æ˜¯ä¸ºäº†æ¼”ç¤ºæ¼æ´åˆ©ç”¨ï¼Œå¹¶æœªå‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç ã€‚ è¯„ä¼°æŠ•æ¯’é£é™©ä¸º10%ã€‚


**é¡¹ç›®åœ°å€:** [cyberx-1/OverlayFS-CVE-2021-3493](https://github.com/cyberx-1/OverlayFS-CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #5

**æ¥æº**: [CVE-2021-3493-derek-turing_CVE-2021-3493.md](../2021/CVE-2021-3493-derek-turing_CVE-2021-3493.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Ubuntu Linux Kernel

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœ¬åœ°ç”¨æˆ·å¯æå‡è‡³ root æƒé™

**å½±å“ç‰ˆæœ¬:** 4.4 <= kernel < 4.4.0-209.241, 4.15 <= kernel < 4.15.0-142.146, 5.4 <= kernel < 5.4.0-72.80, 5.8 <= kernel < 5.8.0-50.56

**åˆ©ç”¨æ¡ä»¶:** Ubuntu å†…æ ¸å¼€å¯äº† unprivileged user namespaces å’Œ unprivileged overlay mounts

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

è¯¥æ¼æ´å­˜åœ¨äº Ubuntu Linux å†…æ ¸çš„ OverlayFS å®ç°ä¸­ï¼Œç”±äº overlayfs å¯¹åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­æ–‡ä»¶ capabilities çš„è®¾ç½®éªŒè¯ä¸å½“ï¼Œç»“åˆæœªæˆæƒç”¨æˆ·å‘½åç©ºé—´å’Œ Ubuntu å†…æ ¸ä¸­å…è®¸æœªæˆæƒ overlay æŒ‚è½½çš„è¡¥ä¸ï¼Œæ”»å‡»è€…å¯åˆ©ç”¨æ­¤æ¼æ´æå‡æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** é¦–å…ˆï¼Œç¡®ä¿ç›®æ ‡ç³»ç»Ÿæ»¡è¶³æ¼æ´åˆ©ç”¨çš„æ¡ä»¶ï¼Œå³ Ubuntu å†…æ ¸ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…ï¼Œå¹¶ä¸”å¯ç”¨äº† unprivileged user namespaces å’Œ unprivileged overlay mountsã€‚æ¼æ´åº“ä¿¡æ¯ä¸­ç»™å‡ºäº†å—å½±å“çš„ç‰ˆæœ¬èŒƒå›´ã€‚
2.  **åˆ›å»ºç›®å½•ç»“æ„ï¼š** åˆ›å»º overlayfs æ‰€éœ€çš„ç›®å½•ç»“æ„ï¼ŒåŒ…æ‹¬ lowerdirï¼ˆåº•å±‚ç›®å½•ï¼‰ã€upperdirï¼ˆä¸Šå±‚ç›®å½•ï¼‰ã€workdirï¼ˆå·¥ä½œç›®å½•ï¼‰å’Œ mergedirï¼ˆåˆå¹¶ç›®å½•ï¼‰ã€‚
3.  **åˆ›å»ºç”¨æˆ·å‘½åç©ºé—´ï¼š** ä½¿ç”¨ `unshare` å‘½ä»¤åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´ï¼Œè¿™å…è®¸åœ¨éç‰¹æƒç”¨æˆ·ä¸‹æ‰§è¡Œä¸€äº›ç‰¹æƒæ“ä½œã€‚
4.  **è®¾ç½® UID/GID æ˜ å°„ï¼š** åœ¨ç”¨æˆ·å‘½åç©ºé—´ä¸­ï¼Œå°†å½“å‰ç”¨æˆ·çš„ UID å’Œ GID æ˜ å°„åˆ° root ç”¨æˆ· (UID 0) å’Œ root ç»„ (GID 0)ï¼Œè¿™æ ·åœ¨ overlayfs ä¸­åˆ›å»ºçš„æ–‡ä»¶å°†å±äº root ç”¨æˆ·ã€‚
5.  **æŒ‚è½½ OverlayFSï¼š** ä½¿ç”¨ `mount` å‘½ä»¤å°† overlayfs æŒ‚è½½åˆ° mergedirï¼ŒæŒ‡å®š lowerdirã€upperdir å’Œ workdirã€‚
6.  **å¤åˆ¶å¹¶è®¾ç½® Capabilitiesï¼š** å°† exploit ç¨‹åºè‡ªèº«å¤åˆ¶åˆ° mergedir ä¸­ï¼Œå¹¶ä½¿ç”¨ `setxattr` å‘½ä»¤è®¾ç½®å…¶ security.capability æ‰©å±•å±æ€§ï¼Œèµ‹äºˆå…¶ CAP_SETUID å’Œ CAP_SETGID capabilitiesã€‚è¿™ä¸ªcapabilitieså…è®¸ç¨‹åºåœ¨æ²¡æœ‰rootæƒé™çš„æƒ…å†µä¸‹è®¾ç½®uidå’Œgidã€‚
7.  **è§¦å‘ææƒï¼š** è¿è¡Œ mergedir ä¸­çš„ exploit ç¨‹åºï¼Œç”±äºå·²è®¾ç½® capabilitiesï¼Œç¨‹åºå°†ä»¥ root æƒé™è¿è¡Œï¼Œä»è€Œæ‰§è¡Œç‰¹æƒæ“ä½œã€‚

**ä»£ç åˆ†æï¼š**

*   `exploit.c` æ˜¯åˆ©ç”¨ä»£ç ï¼Œå®ƒåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼Œå»ºç«‹ç”¨æˆ·å‘½åç©ºé—´ï¼ŒæŒ‚è½½ overlayfsï¼Œç„¶åå°†è‡ªèº«å¤åˆ¶åˆ° overlayfs ä¸­ï¼Œå¹¶è®¾ç½® capabilitiesã€‚æœ€åï¼Œæ‰§è¡Œå¤åˆ¶åˆ° upperdir ä¸­çš„ç¨‹åºï¼Œè¯¥ç¨‹åºä¼šå°†å½“å‰è¿›ç¨‹ææƒä¸º rootã€‚
*   ä»£ç ä¸­ä½¿ç”¨äº† `setxattr` å‡½æ•°æ¥è®¾ç½®æ–‡ä»¶ capabilitiesï¼Œè¿™æ˜¯åˆ©ç”¨æ¼æ´çš„å…³é”®æ­¥éª¤ã€‚
*   mainå‡½æ•°é¦–å…ˆforkä¸€ä¸ªå­è¿›ç¨‹æ‰§è¡Œexploitå‡½æ•°ï¼Œåœ¨exploitå‡½æ•°æ‰§è¡Œå®Œæ¯•åï¼Œçˆ¶è¿›ç¨‹æ‰§è¡ŒBIN_UPPERä¸­çš„magicç¨‹åºï¼Œå¦‚æœå¸¦æœ‰shellå‚æ•°ï¼Œmagicç¨‹åºä¼šè®¾ç½®uidå’Œgidä¸º0ï¼Œå¹¶ä¸”è¿è¡Œä¸€ä¸ªbash shellã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

ä»”ç»†æ£€æŸ¥äº† POC ä»£ç ï¼Œæ²¡æœ‰å‘ç°æ˜æ˜¾çš„æŠ•æ¯’ä»£ç ã€‚ä»£ç é€»è¾‘æ¸…æ™°ï¼Œä¸»è¦ç”¨äºåˆ›å»º overlayfs ç¯å¢ƒå¹¶è®¾ç½®æ–‡ä»¶ capabilities ä»¥è¿›è¡Œææƒã€‚ä½œè€…å¹¶æ²¡æœ‰å°è¯•åœ¨ä»£ç ä¸­éšè—æ¶æ„è¡Œä¸ºï¼Œä¾‹å¦‚ï¼š

*   è¿æ¥å¤–éƒ¨æœåŠ¡å™¨
*   ä¿®æ”¹ç³»ç»Ÿæ–‡ä»¶
*   å®‰è£…åé—¨
*   æ”¶é›†ç”¨æˆ·ä¿¡æ¯

å› æ­¤ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ (0%)ã€‚

**é¡¹ç›®åœ°å€:** [derek-turing/CVE-2021-3493](https://github.com/derek-turing/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #6

**æ¥æº**: [CVE-2021-3493-fathallah17_OverlayFS-CVE-2021-3493.md](../2021/CVE-2021-3493-fathallah17_OverlayFS-CVE-2021-3493.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°æƒé™æå‡

**å½±å“åº”ç”¨:** Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å¯¼è‡´æœ¬åœ°æƒé™æå‡è‡³root

**å½±å“ç‰ˆæœ¬:** 4.4 <= Linux Kernel < 5.8.0-50.56 (Ubuntu ç‰¹å®šç‰ˆæœ¬)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦å­˜åœ¨Ubuntuå†…æ ¸ä¸­å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½OverlayFSçš„è¡¥ä¸ï¼Œä¸”ç”¨æˆ·å‘½åç©ºé—´æœªè¢«ç¦ç”¨ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 1%

## è¯¦æƒ…

CVE-2021-3493 æ˜¯ä¸€ä¸ªå­˜åœ¨äº Linux å†…æ ¸ OverlayFS å®ç°ä¸­çš„æƒé™æå‡æ¼æ´ã€‚æ¼æ´çš„æ ¹æœ¬åŸå› æ˜¯ OverlayFS åœ¨è®¾ç½®åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­æ–‡ä»¶çš„ capabilities æ—¶ï¼Œæ²¡æœ‰æ­£ç¡®åœ°éªŒè¯ç”¨æˆ·å‘½åç©ºé—´ã€‚åœ¨å­˜åœ¨å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½ OverlayFS çš„ Ubuntu å†…æ ¸è¡¥ä¸çš„ç¯å¢ƒä¸­ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´è·å¾—æå‡çš„æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š**  ç›®æ ‡ç³»ç»Ÿéœ€è¦æ˜¯å—å½±å“çš„ Ubuntu ç‰ˆæœ¬ï¼Œå¹¶ä¸”å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½ OverlayFSï¼ŒåŒæ—¶ç”¨æˆ·å‘½åç©ºé—´æ²¡æœ‰è¢«ç¦ç”¨ã€‚
2.  **è·å–æ¼æ´åˆ©ç”¨ä»£ç ï¼š**  ä»å¯ä¿¡æ¥æºè·å–æ¼æ´åˆ©ç”¨ä»£ç  (ä¾‹å¦‚ SSD-Disclosure æä¾›çš„ exploit.c)ã€‚
3.  **ç¼–è¯‘æ¼æ´åˆ©ç”¨ä»£ç ï¼š**  ä½¿ç”¨ gcc ç­‰ç¼–è¯‘å™¨å°† exploit.c ç¼–è¯‘ä¸ºå¯æ‰§è¡Œæ–‡ä»¶ã€‚
4.  **æ‰§è¡Œæ¼æ´åˆ©ç”¨ä»£ç ï¼š**  è¿è¡Œç¼–è¯‘åçš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚æ¼æ´åˆ©ç”¨ä»£ç ä¼šåˆ©ç”¨ OverlayFS çš„æ¼æ´ï¼Œé€šè¿‡è®¾ç½®æ–‡ä»¶ capabilities æ¥æå‡å½“å‰ç”¨æˆ·çš„æƒé™è‡³ rootã€‚
5.  **è·å– root æƒé™ï¼š**  æˆåŠŸæ‰§è¡Œæ¼æ´åˆ©ç”¨ä»£ç åï¼Œç”¨æˆ·å°†è·å¾— root æƒé™ã€‚

**å…³äºæŠ•æ¯’é£é™©ï¼š**

æä¾›çš„POCä»£ç åªæ˜¯ä¸€ä¸ªç®€å•çš„åˆ©ç”¨æ–¹å¼,ä¸å¤ªå¯èƒ½åŒ…å«æ¶æ„ä»£ç ã€‚ä½†å§‹ç»ˆéœ€è¦å¯¹ä»»ä½•æ¥æºçš„æ¼æ´åˆ©ç”¨ä»£ç è¿›è¡Œå®¡æŸ¥ï¼Œä»¥é™ä½é£é™©ã€‚
å¯¹ä¸‹è½½çš„æ–‡ä»¶è¿›è¡Œæ£€æŸ¥ï¼Œå¦‚å“ˆå¸Œæ ¡éªŒï¼Œå¯ä»¥æœ€å¤§ç¨‹åº¦çš„é¿å…å¼•å…¥æ¶æ„ä»£ç ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**

æ ¹æ®æ¼æ´æè¿°å’Œåˆ©ç”¨ä»£ç ï¼Œè¯¥æ¼æ´åˆ©ç”¨æ˜¯æœ‰æ•ˆçš„ã€‚åˆ©ç”¨ä»£ç é€šè¿‡OverlayFSçš„æ¼æ´ï¼Œå…è®¸ä½æƒé™ç”¨æˆ·è·å¾—rootæƒé™ã€‚

**å…¶ä»–ä¿¡æ¯:**
CISA å·²å°†æ­¤æ¼æ´æ·»åŠ åˆ°å·²çŸ¥è¢«åˆ©ç”¨çš„æ¼æ´ç›®å½• (KEV) ä¸­ï¼Œè¡¨æ˜è¯¥æ¼æ´å·²è¢«å¹¿æ³›åˆ©ç”¨ã€‚

**é¡¹ç›®åœ°å€:** [fathallah17/OverlayFS-CVE-2021-3493](https://github.com/fathallah17/OverlayFS-CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #7

**æ¥æº**: [CVE-2021-3493-fei9747_CVE-2021-3493.md](../2021/CVE-2021-3493-fei9747_CVE-2021-3493.md)

## CVE-2021-3493 Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ”»å‡»è€…å¯åˆ©ç”¨æ­¤æ¼æ´è·å– root æƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu kernel versions: < 5.8.0-50.56, < 5.4.0-72.80, < 4.15.0-142.146, < 4.4.0-209.241

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦åœ¨å­˜åœ¨æ¼æ´çš„ Ubuntu ç³»ç»Ÿä¸Šæœ¬åœ°æ‰§è¡Œ

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 5%

## è¯¦æƒ…

CVE-2021-3493 æ˜¯ä¸€ä¸ªå­˜åœ¨äº Ubuntu Linux å†…æ ¸ overlayfs å®ç°ä¸­çš„æœ¬åœ°ææƒæ¼æ´ã€‚è¯¥æ¼æ´æºäº overlayfs æœªèƒ½æ­£ç¡®éªŒè¯ç”¨æˆ·å‘½åç©ºé—´ä¸­åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸Šæ–‡ä»¶ capabilities çš„è®¾ç½®ã€‚ç»“åˆæœªæˆæƒç”¨æˆ·å‘½åç©ºé—´ä»¥åŠ Ubuntu å†…æ ¸ä¸­å…è®¸æœªæˆæƒ overlay mount çš„è¡¥ä¸ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´æå‡æƒé™ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼ŒåŒ…æ‹¬lowerdirï¼Œupperdirï¼Œworkdirå’Œmergedirã€‚
2.  **åˆ›å»ºå‘½åç©ºé—´ï¼š** ä½¿ç”¨ `unshare` ç³»ç»Ÿè°ƒç”¨åˆ›å»ºæ–°çš„ç”¨æˆ·å‘½åç©ºé—´å’ŒæŒ‚è½½å‘½åç©ºé—´ã€‚
3.  **è®¾ç½®ç”¨æˆ·å’Œç»„IDæ˜ å°„ï¼š** å°†å½“å‰ç”¨æˆ·çš„ UID å’Œ GID æ˜ å°„åˆ°æ–°çš„ç”¨æˆ·å‘½åç©ºé—´ä¸­ï¼Œä»¥ä¾¿åœ¨æ–°çš„å‘½åç©ºé—´ä¸­æ‹¥æœ‰æƒé™ã€‚
4.  **æŒ‚è½½ OverlayFSï¼š** ä½¿ç”¨ `mount` ç³»ç»Ÿè°ƒç”¨ï¼Œå°† overlayfs æŒ‚è½½åˆ° mergedirï¼Œå¹¶å°† lowerdirï¼Œupperdir å’Œ workdir æŒ‡å®šä¸ºç›¸åº”çš„ç›®å½•ã€‚
5.  **è®¾ç½® Capabilitiesï¼š** å¤åˆ¶å½“å‰æ‰§è¡Œçš„ç¨‹åºåˆ° mergedirï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½®è¯¥æ–‡ä»¶çš„ capabilitiesï¼Œä½¿å…¶å…·æœ‰ root æƒé™ã€‚ è¿™æ­¥æ˜¯æ¼æ´åˆ©ç”¨çš„å…³é”®ã€‚
6.  **æ‰§è¡ŒPayloadï¼š** æ‰§è¡Œupperç›®å½•ä¸­çš„æ–‡ä»¶ï¼Œå› ä¸ºè®¾ç½®äº†Capabilitiesï¼Œå¯ä»¥è·å¾—rootæƒé™ã€‚

**æœ‰æ•ˆæ€§ï¼š**

æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’ŒPOCä»£ç æè¿°ï¼Œè¯¥æ¼æ´åœ¨ç‰¹å®šç‰ˆæœ¬çš„ Ubuntu å†…æ ¸ä¸Šæ˜¯å¯åˆ©ç”¨çš„ã€‚æä¾›çš„POCä»£ç å±•ç¤ºäº†åˆ©ç”¨è¯¥æ¼æ´æå‡æƒé™çš„å®Œæ•´è¿‡ç¨‹ã€‚

**æŠ•æ¯’é£é™©ï¼š**

ä»£ç ä¸­å­˜åœ¨æ½œåœ¨çš„æŠ•æ¯’é£é™©ï¼Œä½†æ˜¯é£é™©è¾ƒä½ã€‚ä¸»è¦é›†ä¸­åœ¨ç¼–è¯‘å’Œè¿è¡Œexploitæ—¶ã€‚æ”»å‡»è€…å¯èƒ½é€šè¿‡ä¿®æ”¹ exploit.c æ–‡ä»¶ï¼Œä¾‹å¦‚æ·»åŠ æ¶æ„ä»£ç æˆ–åé—¨ï¼Œä»è€Œåœ¨ç›®æ ‡ç³»ç»Ÿä¸Šæ‰§è¡Œæ¶æ„æ“ä½œã€‚ä½†æ˜¯æ ¹æ®æä¾›çš„POCä»£ç æ¥çœ‹, é£é™©ç³»æ•°è¾ƒä½.

**é£é™©è¯„ä¼°ï¼š**

è¯¥æ¼æ´åˆ©ç”¨çš„æˆåŠŸå–å†³äºç›®æ ‡ç³»ç»Ÿæ˜¯å¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š

*   è¿è¡Œå—å½±å“çš„ Ubuntu å†…æ ¸ç‰ˆæœ¬ã€‚
*   å¯ç”¨äº†æœªæˆæƒç”¨æˆ·å‘½åç©ºé—´å’Œ overlayfs mountã€‚
*   ç›®æ ‡ç³»ç»Ÿä¸Šå­˜åœ¨ `gcc` ç¼–è¯‘å™¨, èƒ½å¤Ÿç¼–è¯‘exploitã€‚

å¦‚æœç›®æ ‡ç³»ç»Ÿæ»¡è¶³è¿™äº›æ¡ä»¶ï¼Œæ”»å‡»è€…å¯ä»¥ä½¿ç”¨æä¾›çš„ POC ä»£ç æˆåŠŸåˆ©ç”¨è¯¥æ¼æ´ï¼Œä»è€Œè·å¾— root æƒé™ã€‚


**é¡¹ç›®åœ°å€:** [fei9747/CVE-2021-3493](https://github.com/fei9747/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #8

**æ¥æº**: [CVE-2021-3493-iamz24_CVE-2021-3493_CVE-2022-3357.md](../2021/CVE-2021-3493-iamz24_CVE-2021-3493_CVE-2022-3357.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒæ¼æ´

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å¯¼è‡´æœ¬åœ°æƒé™æå‡è‡³ root

**å½±å“ç‰ˆæœ¬:** Ubuntu kernels < 5.8.0-50.56, < 5.4.0-72.80, < 4.15.0-142.146, < 4.4.0-209.241

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç›®æ ‡ç³»ç»Ÿå¼€å¯ unprivileged user namespaces å’Œå­˜åœ¨ OverlayFS æœåŠ¡ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2021-3493 æ¼æ´æ˜¯ Linux å†…æ ¸ overlayfs å®ç°ä¸­ï¼Œåœ¨ç”¨æˆ·å‘½åç©ºé—´ä¸­å¯¹åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­çš„æ–‡ä»¶ capabilities éªŒè¯ä¸å½“å¯¼è‡´çš„ã€‚ç”±äº Ubuntu å†…æ ¸ä¸­å­˜åœ¨å…è®¸éç‰¹æƒ overlay æŒ‚è½½çš„è¡¥ä¸ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¯¥æ¼æ´æå‡æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** æ£€æŸ¥ç›®æ ‡ç³»ç»Ÿæ˜¯å¦å­˜åœ¨ overlayfs æœåŠ¡ï¼Œå¦‚æœæ²¡æœ‰åˆ™åŠ è½½ overlay æ¨¡å—ã€‚åŒæ—¶ï¼Œç¡®ä¿å¼€å¯äº† unprivileged user namespacesã€‚
2.  **ç¼–è¯‘ Payloadï¼š** ä½¿ç”¨ GCC ç¼–è¯‘æä¾›çš„ `payload.c` æ–‡ä»¶ã€‚
3.  **è¿è¡Œ Payloadï¼š** è¿è¡Œç¼–è¯‘åçš„å¯æ‰§è¡Œæ–‡ä»¶ `a.out`ã€‚
4.  **è·å– Root Shellï¼š** Payload ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å‘½åç©ºé—´ï¼ŒæŒ‚è½½ overlayfsï¼Œè®¾ç½® capabilityï¼Œæœ€ç»ˆæ‰§è¡Œä¸€ä¸ªå…·æœ‰ root æƒé™çš„ shellã€‚

**æœ‰æ•ˆæ€§ï¼š**

æä¾›çš„ POC ä»£ç åŸºæœ¬æœ‰æ•ˆï¼Œèƒ½å¤Ÿåˆ©ç”¨è¯¥æ¼æ´åœ¨ç¬¦åˆæ¡ä»¶çš„ Ubuntu ç³»ç»Ÿä¸Šå®ç°æœ¬åœ°ææƒã€‚

**æŠ•æ¯’é£é™©ï¼š**

å­˜åœ¨è¾ƒä½çš„æŠ•æ¯’é£é™©ï¼ˆ10%ï¼‰ã€‚è™½ç„¶ä»£ç çš„ä¸»è¦åŠŸèƒ½æ˜¯å®ç°ææƒï¼Œä½†ä»ç„¶éœ€è¦è°¨æ…å¯¹å¾…æ¥æºä¸æ˜çš„ä»£ç ï¼Œä½œè€…å¯èƒ½ä¼šåœ¨å…¶ä¸­éšè—ä¸€äº›æ¶æ„è¡Œä¸ºï¼Œæ¯”å¦‚ä¸Šä¼ æ•æ„Ÿä¿¡æ¯ç­‰ã€‚ç‰¹åˆ«æ˜¯éœ€è¦æ£€æŸ¥ `exploit`å‡½æ•°ä¸­çš„ç›¸å…³æ–‡ä»¶æ“ä½œå’Œå‘½ä»¤æ‰§è¡Œæ˜¯å¦å­˜åœ¨æ¶æ„è¡Œä¸ºã€‚å°¤å…¶å…³æ³¨`system(buf);`æ˜¯å¦ä¼šæ‰§è¡Œæ¶æ„çš„æŒ‡ä»¤ã€‚

**æ€»ç»“ï¼š**

è¯¥æ¼æ´åˆ©ç”¨è¾ƒä¸ºç›´æ¥ï¼Œåˆ©ç”¨æ¡ä»¶ç›¸å¯¹æ˜ç¡®ï¼Œä½†éœ€è¦æ³¨æ„æ½œåœ¨çš„æŠ•æ¯’é£é™©ã€‚åœ¨å®é™…ä½¿ç”¨æ—¶ï¼Œåº”è¯¥ä»”ç»†å®¡æŸ¥ä»£ç ï¼Œç¡®ä¿æ²¡æœ‰æ¶æ„è¡Œä¸ºã€‚

**é¡¹ç›®åœ°å€:** [iamz24/CVE-2021-3493_CVE-2022-3357](https://github.com/iamz24/CVE-2021-3493_CVE-2022-3357)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #9

**æ¥æº**: [CVE-2021-3493-inspiringz_CVE-2021-3493.md](../2021/CVE-2021-3493-inspiringz_CVE-2021-3493.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Ubuntu Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸ä½æƒé™ç”¨æˆ·æå‡åˆ°rootæƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu 4.4, 4.15, 5.4, 5.8 kernels (å—å½±å“ç‰ˆæœ¬è¯¦è§æ¼æ´åº“ä¿¡æ¯)

**åˆ©ç”¨æ¡ä»¶:** Ubuntuå†…æ ¸ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…ï¼Œå¯ç”¨æœªæˆæƒç”¨æˆ·å‘½åç©ºé—´ï¼Œå…è®¸æœªæˆæƒOverlayFSæŒ‚è½½ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 5%

## è¯¦æƒ…

CVE-2021-3493æ˜¯Ubuntuå†…æ ¸ä¸­OverlayFSå®ç°çš„ä¸€ä¸ªæ¼æ´ï¼Œå…è®¸ä½æƒé™ç”¨æˆ·é€šè¿‡åˆ©ç”¨user namespaceå’ŒOverlayFSæŒ‚è½½ç»•è¿‡æ–‡ä»¶ç³»ç»Ÿæƒé™æ£€æŸ¥æ¥æå‡æƒé™ã€‚ 

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡:** æ¼æ´åˆ©ç”¨éœ€è¦å­˜åœ¨Ubuntuç³»ç»Ÿï¼Œä¸”å†…æ ¸ç‰ˆæœ¬åœ¨æ¼æ´åº“ä¿¡æ¯ä¸­æè¿°çš„å—å½±å“èŒƒå›´å†…ï¼Œå¹¶ä¸”éœ€è¦å¯ç”¨æœªæˆæƒç”¨æˆ·å‘½åç©ºé—´(unprivileged user namespaces)ã€‚æ­¤å¤–ï¼Œä¸ºäº†åˆ©ç”¨OverlayFSï¼Œç³»ç»Ÿéœ€è¦é…ç½®å…è®¸æœªæˆæƒç”¨æˆ·è¿›è¡ŒOverlayFSæŒ‚è½½ã€‚
2.  **æ¼æ´åˆ©ç”¨:**  æ”»å‡»è€…é¦–å…ˆåˆ›å»ºä¸€ä¸ªåŒ…å«lower, upper, workç›®å½•çš„OverlayFSç»“æ„ã€‚
3.  **åˆ©ç”¨è¿‡ç¨‹:** åˆ©ç”¨`unshare`ç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€ä¸ªæ–°çš„user namespaceå’Œmount namespaceã€‚ åœ¨æ–°namespaceä¸­ï¼Œå°†è‡ªå·±çš„UIDå’ŒGIDæ˜ å°„åˆ°rootæƒé™ã€‚ ç„¶åï¼Œä½¿ç”¨æ„é€ çš„lowerdirã€upperdirå’ŒworkdiræŒ‚è½½OverlayFSæ–‡ä»¶ç³»ç»Ÿã€‚ æ”»å‡»è€…å°†ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶å¤åˆ¶åˆ°OverlayFSçš„mergeç›®å½•ä¸­ã€‚å…³é”®çš„ä¸€æ­¥æ˜¯ï¼Œæ”»å‡»è€…ä½¿ç”¨`setxattr`ç³»ç»Ÿè°ƒç”¨ï¼Œè®¾ç½®è¯¥å¯æ‰§è¡Œæ–‡ä»¶çš„`security.capability`æ‰©å±•å±æ€§ï¼Œèµ‹äºˆå®ƒ`CAP_SETUID`å’Œ`CAP_SETGID`èƒ½åŠ›ã€‚ ç”±äºOverlayFSçš„æƒé™éªŒè¯ä¸å®Œå–„ï¼Œè¿™ä¸ªæ“ä½œå³ä½¿åœ¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´ä¸­ä¹Ÿèƒ½æˆåŠŸã€‚å½“æ‰§è¡Œè¯¥æ–‡ä»¶æ—¶ï¼Œå®ƒå°†è·å¾—rootæƒé™ï¼Œå¹¶å¯ä»¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚
4.  **POCä»£ç åˆ†æ:** `exploit.c` ä»£ç é¦–å…ˆåˆ›å»ºä¸€ä¸ªoverlayfsç›®å½•ç»“æ„ã€‚ç„¶åï¼Œä½¿ç”¨ `unshare` ç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€ä¸ªæ–°çš„ user namespace å’Œ mount namespaceï¼Œå¹¶å°†å½“å‰ç”¨æˆ·çš„ uid å’Œ gid æ˜ å°„åˆ° root ç”¨æˆ·ã€‚ ä¹‹åï¼Œå®ƒæŒ‚è½½ overlayfsï¼Œå¤åˆ¶å½“å‰æ‰§è¡Œçš„ç¨‹åºåˆ° overlayfs çš„ merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½® capabilityã€‚æœ€åï¼Œæ‰§è¡Œå¤åˆ¶åˆ° overlayfs çš„ç¨‹åºã€‚
5. **æŠ•æ¯’é£é™©åˆ†æ:** ä»£ç æœ¬èº«å®ç°äº†æ¼æ´åˆ©ç”¨çš„åŠŸèƒ½ã€‚ æ½œåœ¨çš„æŠ•æ¯’é£é™©å¯èƒ½å­˜åœ¨äºä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š
    *   **ä¾èµ–é¡¹:**  ä»£ç ä¾èµ–äºæ ‡å‡†çš„Cåº“ï¼Œæœ¬èº«ä¸å­˜åœ¨æ¶æ„ä¾èµ–ã€‚ä½†ç”¨æˆ·åœ¨ç¼–è¯‘æ—¶éœ€è¦æ³¨æ„ç¼–è¯‘å™¨ç¯å¢ƒçš„å®‰å…¨æ€§ã€‚
    *   **ä»£ç é€»è¾‘:**  ä»£ç é€»è¾‘ç›¸å¯¹ç®€å•ï¼Œä¸»è¦é›†ä¸­åœ¨namespaceåˆ›å»ºã€æŒ‚è½½å’Œcapabilityè®¾ç½®ã€‚ ä»”ç»†å®¡æŸ¥ä»£ç ï¼Œæœªå‘ç°æ˜æ˜¾çš„æ¶æ„é€»è¾‘ã€‚
    *   **æ‰§è¡Œå‘½ä»¤:**  ä»£ç ä¸­ä½¿ç”¨äº† `system` å‡½æ•°ï¼Œè¿™æ˜¯ä¸€ä¸ªæ½œåœ¨çš„é£é™©ç‚¹ï¼Œå¯ä»¥æ‰§è¡Œä»»æ„ç³»ç»Ÿå‘½ä»¤ã€‚ä½†æ˜¯ï¼Œè¿™é‡Œåªæ˜¯ç”¨æ¥åˆ é™¤ç›®å½•ï¼Œç›¸å¯¹å®‰å…¨ã€‚
       ç»¼ä¸Šæ‰€è¿°ï¼Œè¯¥POCä»£ç ä¸»è¦é£é™©åœ¨äºç¡®ä¿ç¼–è¯‘ç¯å¢ƒå®‰å…¨ä»¥åŠå¯¹ä¸ç†Ÿæ‚‰çš„å‘½ä»¤ä¿æŒè­¦æƒ•ã€‚æŠ•æ¯’é£é™©è¾ƒä½ï¼Œé¢„ä¼°ä¸º5%ã€‚

**æ€»ç»“ï¼š**

è¯¥æ¼æ´åˆ©ç”¨çš„æ ¸å¿ƒåœ¨äºç»“åˆäº†æœªæˆæƒç”¨æˆ·å‘½åç©ºé—´å’ŒOverlayFSï¼Œåˆ©ç”¨OverlayFSå¯¹capabilitiesè®¾ç½®éªŒè¯çš„ç¼ºé™·ï¼Œå®ç°äº†æœ¬åœ°ææƒã€‚ æ”»å‡»è€…é€šè¿‡åˆ›å»ºç‰¹æ®Šçš„OverlayFSç»“æ„å¹¶è®¾ç½®æ–‡ä»¶capabilitiesï¼Œæœ€ç»ˆè·å¾—rootæƒé™ã€‚

**é¡¹ç›®åœ°å€:** [inspiringz/CVE-2021-3493](https://github.com/inspiringz/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #10

**æ¥æº**: [CVE-2021-3493-oneoy_CVE-2021-3493.md](../2021/CVE-2021-3493-oneoy_CVE-2021-3493.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœ¬åœ°ç”¨æˆ·å¯æå‡è‡³ root æƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu 4.4, 4.15, 5.4, and 5.8 kernels (å…·ä½“ç‰ˆæœ¬å·è§æ¼æ´åº“ä¿¡æ¯)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç›®æ ‡ç³»ç»Ÿå­˜åœ¨æœªä¿®å¤çš„ Ubuntu kernelï¼Œä¸”å¯ç”¨ unprivileged user namespaces å’Œå…è®¸ unprivileged overlayfs mountsã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

è¯¥æ¼æ´å­˜åœ¨äº Ubuntu å†…æ ¸çš„ OverlayFS å®ç°ä¸­ï¼Œç”±äºæœªæ­£ç¡®éªŒè¯ç”¨æˆ·å‘½åç©ºé—´ä¸­åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸Šæ–‡ä»¶ capabilities çš„è®¾ç½®ï¼Œå¯¼è‡´æœ¬åœ°æ”»å‡»è€…å¯åˆ©ç”¨ unprivileged user namespaces å’Œ Ubuntu å†…æ ¸ä¸­å…è®¸ unprivileged overlayfs mounts çš„è¡¥ä¸æ¥æå‡æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ (lower, upper, work, merge)ã€‚
2.  **é…ç½® User Namespace:** åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´ã€‚
3.  **é…ç½® OverlayFS:** ä½¿ç”¨ lowerdir, upperdir, å’Œ workdir é€‰é¡¹æŒ‚è½½ overlay æ–‡ä»¶ç³»ç»Ÿã€‚
4.  **è®¾ç½® Capabilities:** å°†å¯æ‰§è¡Œæ–‡ä»¶å¤åˆ¶åˆ° merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½®å…¶ capabilities (å¦‚ CAP_SETUID, CAP_SETGID, CAP_CHOWN)ã€‚
5.  **è§¦å‘ææƒ:** æ‰§è¡Œ merge ç›®å½•ä¸­çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶å°†ä¼šä»¥ root æƒé™æ‰§è¡Œã€‚

**æŠ•æ¯’é£é™©è¯„ä¼°ï¼š**

æä¾›çš„ `exploit.c` ä»£ç ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨ OverlayFS çš„æ¼æ´è¿›è¡Œææƒã€‚ä»£ç åˆ›å»ºå¿…è¦çš„ç›®å½•ï¼Œé…ç½® user namespace å’Œ overlay æ–‡ä»¶ç³»ç»Ÿï¼Œå¹¶è®¾ç½®å¯æ‰§è¡Œæ–‡ä»¶çš„ capabilitiesã€‚ä»£ç é€»è¾‘æ¸…æ™°ï¼Œæ²¡æœ‰å‘ç°æ¶æ„ä»£ç æˆ–åé—¨ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**

æä¾›çš„ POC ä»£ç åŸºäºå…¬å¼€ä¿¡æ¯ï¼Œå¹¶é’ˆå¯¹ CVE-2021-3493 æ¼æ´è¿›è¡Œäº†åˆ©ç”¨ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯ã€æœç´¢å¼•æ“ç»“æœå’Œä»£ç åˆ†æï¼Œè¯¥ POC ä»£ç åœ¨æ»¡è¶³æ¼æ´åˆ©ç”¨æ¡ä»¶çš„æƒ…å†µä¸‹åº”è¯¥æ˜¯æœ‰æ•ˆçš„ã€‚

**é¡¹ç›®åœ°å€:** [oneoy/CVE-2021-3493](https://github.com/oneoy/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #11

**æ¥æº**: [CVE-2021-3493-pmihsan_OverlayFS-CVE-2021-3493.md](../2021/CVE-2021-3493-pmihsan_OverlayFS-CVE-2021-3493.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœ¬åœ°ç”¨æˆ·å¯æå‡è‡³ root æƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu kernel versions: < 5.8.0-50.56 (5.8 kernel), < 5.4.0-72.80 (5.4 kernel), < 4.15.0-142.146 (4.15 kernel), < 4.4.0-209.241 (4.4 kernel)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦åœ¨å­˜åœ¨æ¼æ´çš„ Ubuntu ç³»ç»Ÿä¸Šæ‰§è¡Œï¼Œå¹¶ä¸”å…è®¸ unprivileged user namespaces å’Œ overlay mountsã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

CVE-2021-3493 æ¼æ´å­˜åœ¨äº Linux å†…æ ¸çš„ overlayfs å®ç°ä¸­ã€‚ç”±äºå¯¹ç”¨æˆ·å‘½åç©ºé—´ä¸­åº•å±‚æ–‡ä»¶ç³»ç»Ÿæ–‡ä»¶ capabilities çš„éªŒè¯ä¸è¶³ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡åˆ›å»ºæ¶æ„çš„ overlayfs æ–‡ä»¶ç³»ç»Ÿï¼Œåˆ©ç”¨ setxattr è®¾ç½®æ–‡ä»¶ capabilitiesï¼Œä»è€Œè·å¾—æå‡çš„æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** åˆ›å»º overlayfs æ‰€éœ€çš„ç›®å½•ç»“æ„ (lower, upper, work, merge)ã€‚
2.  **Namespace åˆ›å»ºï¼š** åˆ›å»ºæ–°çš„ user namespace å’Œ mount namespaceï¼Œéš”ç¦»æƒé™ã€‚
3.  **æƒé™è®¾ç½®ï¼š** ä¿®æ”¹ uid_map å’Œ gid_mapï¼Œä½¿å¾—åœ¨ user namespace ä¸­æ‹¥æœ‰ root æƒé™ã€‚
4.  **Overlayfs Mountï¼š** ä½¿ç”¨ overlayfs mount å‘½ä»¤å°† lowerdir, upperdir, workdir æŒ‚è½½åˆ° mergedirã€‚
5.  **Capabilities è®¾ç½®ï¼š** å¤åˆ¶è‡ªèº«ç¨‹åºåˆ° merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` å‡½æ•°ä¸ºå¤åˆ¶åçš„ç¨‹åºè®¾ç½® capabilities (CAP_SETUID, CAP_SETGID, CAP_DAC_OVERRIDE ç­‰)ã€‚
6.  **æƒé™æå‡ï¼š** æ‰§è¡Œ merge ç›®å½•ä¸‹çš„ç¨‹åºï¼Œæ­¤æ—¶ç¨‹åºå°†ä»¥ root æƒé™è¿è¡Œã€‚

**æœ‰æ•ˆæ€§ï¼š**

æä¾›çš„ POC ä»£ç é€šè¿‡åˆ©ç”¨ overlayfs æ¼æ´ï¼Œå¯ä»¥æˆåŠŸåœ°æå‡æƒé™ã€‚POC ä»£ç é¦–å…ˆåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼Œç„¶ååˆ›å»ºä¸€ä¸ªæ–°çš„ user namespace å’Œ mount namespaceï¼Œæ¥ç€æŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿï¼Œå¹¶ä½¿ç”¨ `setxattr` å‡½æ•°ä¸ºæ–‡ä»¶è®¾ç½® capabilitiesã€‚æœ€åï¼Œæ‰§è¡Œè¯¥æ–‡ä»¶å³å¯è·å¾— root æƒé™ã€‚

**æŠ•æ¯’é£é™©ï¼š**

åˆ†æ POC ä»£ç ï¼Œæ²¡æœ‰å‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç ï¼Œä¾‹å¦‚åå¼¹ shellã€å®‰è£…åé—¨ç­‰ã€‚ä»£ç é€»è¾‘ä¸»è¦é›†ä¸­åœ¨åˆ©ç”¨ overlayfs æ¼æ´ææƒï¼Œå¹¶æ²¡æœ‰é¢å¤–çš„æ“ä½œæ¥æ¤å…¥æ¶æ„ç¨‹åºã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ï¼Œå¯ä»¥è®¤ä¸ºæ˜¯ 0%ã€‚å‚è€ƒçš„ vulnerability description å’Œ exploit ä»£ç éƒ½ç€é‡äºææƒï¼Œè€Œæ²¡æœ‰æåˆ°ä»»ä½•æŠ•æ¯’è¡Œä¸ºã€‚

**é¡¹ç›®åœ°å€:** [pmihsan/OverlayFS-CVE-2021-3493](https://github.com/pmihsan/OverlayFS-CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #12

**æ¥æº**: [CVE-2021-3493-ptkhai15_OverlayFS---CVE-2021-3493.md](../2021/CVE-2021-3493-ptkhai15_OverlayFS---CVE-2021-3493.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Ubuntu Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœ¬åœ°ç”¨æˆ·æå‡æƒé™è‡³ root

**å½±å“ç‰ˆæœ¬:** Ubuntu kernel versions 5.8, 5.4, 4.15, å’Œ 4.4 ä¸­å—å½±å“çš„ç‰ˆæœ¬ï¼ˆå…·ä½“ç‰ˆæœ¬å‚è§æ¼æ´åº“ä¿¡æ¯ï¼‰

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡ç³»ç»Ÿå¿…é¡»æ˜¯å—å½±å“çš„ Ubuntu ç‰ˆæœ¬ï¼Œå¹¶ä¸”å¯ç”¨äº†éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å’Œéç‰¹æƒ overlayfs æŒ‚è½½ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

CVE-2021-3493 æ˜¯ Ubuntu Linux å†…æ ¸ä¸­ OverlayFS å®ç°ä¸­çš„ä¸€ä¸ªæ¼æ´ã€‚è¯¥æ¼æ´å…è®¸éç‰¹æƒç”¨æˆ·åˆ©ç”¨ç”¨æˆ·å‘½åç©ºé—´å’Œéç‰¹æƒ overlayfs æŒ‚è½½ï¼Œé€šè¿‡ä¸æ­£ç¡®åœ°éªŒè¯åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­æ–‡ä»¶çš„ capabilities è®¾ç½®æ¥æå‡æƒé™ã€‚åˆ©ç”¨æ–¹å¼å¦‚ä¸‹ï¼š

1.  **ç¯å¢ƒå‡†å¤‡ï¼š**  åˆ›å»ºä¸€ä¸ªåŸºç¡€ç›®å½•ç»“æ„ï¼ŒåŒ…æ‹¬ workã€lowerã€upper å’Œ merge ç›®å½•ï¼Œè¿™æ˜¯ overlayfs çš„æ ‡å‡†é…ç½®ã€‚
2.  **åˆ›å»ºç”¨æˆ·å‘½åç©ºé—´ï¼š**  ä½¿ç”¨ `unshare` å‘½ä»¤åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´ã€‚è¿™å…è®¸åœ¨æ–°çš„å‘½åç©ºé—´ä¸­æ‹¥æœ‰ä¸åŒçš„ç”¨æˆ·å’Œç»„ IDã€‚
3.  **é…ç½®ç”¨æˆ·å’Œç»„æ˜ å°„ï¼š**  é€šè¿‡ `/proc/self/setgroups`ã€`/proc/self/uid_map` å’Œ `/proc/self/gid_map` æ–‡ä»¶è®¾ç½®ç”¨æˆ·å’Œç»„ ID æ˜ å°„ï¼Œå°†å½“å‰ç”¨æˆ·çš„ UID å’Œ GID æ˜ å°„åˆ°æ–°å‘½åç©ºé—´ä¸­çš„ root ç”¨æˆ·ã€‚
4.  **æŒ‚è½½ OverlayFSï¼š**  ä½¿ç”¨ `mount` å‘½ä»¤æŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿï¼Œå°† lowerã€upper å’Œ work ç›®å½•å…³è”èµ·æ¥ã€‚
5.  **è®¾ç½®æ–‡ä»¶ capabilitiesï¼š**  å¤åˆ¶å½“å‰æ‰§è¡Œç¨‹åºåˆ° overlayfs çš„ merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½®æ–‡ä»¶çš„ capabilities ä¸º `all+ep`ï¼Œå…è®¸è¯¥æ–‡ä»¶æ‰§è¡Œæ—¶æ‹¥æœ‰ root æƒé™ã€‚
6.  **æ‰§è¡Œææƒåçš„ç¨‹åºï¼š**  æ‰§è¡Œä½äº upper ç›®å½•ä¸­çš„å¤åˆ¶åçš„ç¨‹åºã€‚å¦‚æœç¨‹åºæ£€æµ‹åˆ°è‡ªå·±æ˜¯é€šè¿‡ç‰¹å®šæ–¹å¼ï¼ˆä¾‹å¦‚ï¼ŒåŒ…å« "magic" å­—ç¬¦ä¸²æˆ–æ¥å— "shell" å‚æ•°ï¼‰è°ƒç”¨çš„ï¼Œå®ƒä¼šè°ƒç”¨ `setuid(0)` å’Œ `setgid(0)` å°†è¿›ç¨‹çš„ UID å’Œ GID è®¾ç½®ä¸º 0 (root)ï¼Œå¹¶å¯åŠ¨ä¸€ä¸ª root shellã€‚

**å…³äºæŠ•æ¯’é£é™©ï¼š**

åœ¨æä¾›çš„ POC ä»£ç ä¸­ï¼Œæ²¡æœ‰æ˜æ˜¾çš„æŠ•æ¯’ä»£ç ã€‚POC çš„ç›®çš„æ˜¯æ¼”ç¤ºæ¼æ´åˆ©ç”¨è¿‡ç¨‹ï¼Œæ²¡æœ‰å‘ç°æ¶æ„è¡Œä¸ºï¼Œä¾‹å¦‚åå‘ shell æˆ–å…¶ä»–æœªç»æˆæƒçš„è®¿é—®ã€‚


**é¡¹ç›®åœ°å€:** [ptkhai15/OverlayFS---CVE-2021-3493](https://github.com/ptkhai15/OverlayFS---CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #13

**æ¥æº**: [CVE-2021-3493-puckiestyle_CVE-2021-3493.md](../2021/CVE-2021-3493-puckiestyle_CVE-2021-3493.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ”»å‡»è€…å¯åˆ©ç”¨æ­¤æ¼æ´è·å¾— root æƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu 5.8 kernel (< 5.8.0-50.56), 5.4 kernel (< 5.4.0-72.80), 4.15 kernel (< 4.15.0-142.146), 4.4 kernel (< 4.4.0-209.241)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ Ubuntu ç³»ç»Ÿå¼€å¯ unprivileged user namespaces å’Œå…è®¸ unprivileged overlay mounts

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2021-3493 æ˜¯ Ubuntu å†…æ ¸ overlayfs å®ç°ä¸­çš„ä¸€ä¸ªæ¼æ´ï¼Œå…è®¸æœ¬åœ°æ”»å‡»è€…é€šè¿‡æ»¥ç”¨ user namespaces å’Œ overlayfs æŒ‚è½½æœºåˆ¶æå‡æƒé™ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**
æä¾›çš„ POC ä»£ç å°è¯•åˆ©ç”¨è¯¥æ¼æ´ï¼Œé€šè¿‡åˆ›å»º user namespace å’Œ overlayfs æ–‡ä»¶ç³»ç»Ÿæ¥è®¾ç½®å¯æ‰§è¡Œæ–‡ä»¶çš„ capability ä½ï¼Œä½¿å…¶è·å¾— root æƒé™ã€‚ æ¼æ´åº“ä¿¡æ¯,æœç´¢å¼•æ“ç»“æœå’Œæ¼æ´åˆ©ç”¨ä»£ç ä¸€è‡´,è¡¨æ˜è¯¥æ¼æ´çš„POCæ˜¯çœŸå®æœ‰æ•ˆçš„ã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**
æŸ¥çœ‹ `exploit.c` ä»£ç ï¼Œä¸»è¦æ“ä½œåŒ…æ‹¬åˆ›å»ºç›®å½•ã€è®¾ç½® user namespaceã€æŒ‚è½½ overlayfsã€å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶ã€è®¾ç½® capability å±æ€§ï¼Œä»¥åŠæ‰§è¡Œå¤åˆ¶åçš„æ–‡ä»¶ä»¥è·å¾— root æƒé™ã€‚ä»£ç é€»è¾‘è¾ƒä¸ºæ¸…æ™°ï¼Œæœªå‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç ã€‚`README.md` ä¹Ÿè¯´æ˜äº†å¹¶éä½œè€…åŸåˆ›,åªæ˜¯æ¬è¿,å¢åŠ äº†åˆ†æéš¾åº¦.
`exploit.c`ä¸­å­˜åœ¨`system(buf);` è°ƒç”¨ï¼Œè™½ç„¶è¿™é‡Œæ˜¯ç”¨äºæ¸…ç†ç›®å½•ï¼Œä½†å¦‚æœè¢«ç¯¡æ”¹ï¼Œå¯èƒ½æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£é™©è¯„ä¼°ä¸º10%ã€‚ä¸»è¦çš„é£é™©åœ¨äºï¼š

*   `system()` å‡½æ•°æ½œåœ¨çš„å‘½ä»¤æ³¨å…¥é£é™©ï¼Œå¦‚æœä»£ç è¢«ä¿®æ”¹ï¼Œå¯èƒ½å¯¼è‡´æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  åˆ©ç”¨ unshare() åˆ›å»ºä¸€ä¸ªæ–°çš„ user namespace å’Œ mount namespaceã€‚
2.  é…ç½® user namespace çš„ uid_map å’Œ gid_mapï¼Œå°†å½“å‰ç”¨æˆ·æ˜ å°„ä¸º root ç”¨æˆ·ã€‚
3.  åˆ›å»º overlayfs æ‰€éœ€çš„ç›®å½•ç»“æ„ï¼ˆlowerdirã€upperdirã€workdirã€mergedï¼‰ã€‚
4.  æŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿã€‚
5.  å°†æ¼æ´åˆ©ç”¨ç¨‹åºè‡ªèº«å¤åˆ¶åˆ° overlayfs çš„ upperdir/merged ç›®å½•ã€‚
6.  ä½¿ç”¨ setxattr() è®¾ç½®å¤åˆ¶åçš„å¯æ‰§è¡Œæ–‡ä»¶çš„ security.capability å±æ€§ï¼Œèµ‹äºˆå…¶ CAP_SETUID å’Œ CAP_SETGID æƒé™ã€‚
7.  æ‰§è¡Œå¤åˆ¶åçš„ç¨‹åºï¼Œç”±äºè®¾ç½®äº† capabilityï¼Œè¯¥ç¨‹åºä¼šä»¥ root æƒé™è¿è¡Œï¼Œä»è€Œè·å¾— root shellã€‚

**é¡¹ç›®åœ°å€:** [puckiestyle/CVE-2021-3493](https://github.com/puckiestyle/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #14

**æ¥æº**: [CVE-2021-3493-smallkill_CVE-2021-3493.md](../2021/CVE-2021-3493-smallkill_CVE-2021-3493.md)

# CVE-2021-3493

> ğŸ“¦ è¯¥CVEæœ‰ **15** ä¸ªç›¸å…³POCä»“åº“

---

## POC #1

**æ¥æº**: [CVE-2021-3493-Abdennour-py_CVE-2021-3493.md](../2021/CVE-2021-3493-Abdennour-py_CVE-2021-3493.md)

## CVE-2021-3493 Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å¯¼è‡´æ™®é€šç”¨æˆ·æå‡ä¸ºrootæƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu 5.8 kernel < 5.8.0-50.56, 5.4 kernel < 5.4.0-72.80, 4.15 kernel < 4.15.0-142.146, 4.4 kernel < 4.4.0-209.241

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç›®æ ‡ç³»ç»Ÿè¿è¡Œå—å½±å“çš„Ubuntuå†…æ ¸ï¼Œå¹¶ä¸”å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿå’Œä½¿ç”¨user namespace

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

è¯¥æ¼æ´æºäºUbuntuå†…æ ¸ä¸­overlayfså®ç°å¯¹ç”¨æˆ·å‘½åç©ºé—´ä¸­çš„æ–‡ä»¶èƒ½åŠ›éªŒè¯ä¸å½“ã€‚ç»“åˆéç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å’ŒUbuntuå†…æ ¸ä¸­çš„å…è®¸éç‰¹æƒ overlayfs æŒ‚è½½çš„è¡¥ä¸ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´è·å¾—æå‡çš„æƒé™ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**

æä¾›çš„POCä»£ç çœ‹èµ·æ¥æ˜¯æœ‰æ•ˆçš„ã€‚å®ƒåˆ©ç”¨äº† overlayfs å’Œ user namespace çš„ç»„åˆæ¥è®¾ç½®æ–‡ä»¶ capabilityï¼Œä»è€Œå®ç°ææƒã€‚ä»£ç é¦–å…ˆåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼ˆlower, upper, work, mergeï¼‰ï¼Œç„¶åä½¿ç”¨ `unshare` åˆ›å»ºä¸€ä¸ªæ–°çš„ user namespace å’Œ mount namespaceã€‚æ¥ç€ï¼Œå®ƒå†™å…¥ `/proc/self/setgroups`, `/proc/self/uid_map`, å’Œ `/proc/self/gid_map` æ¥è®¾ç½®ç”¨æˆ·å’Œç»„çš„æ˜ å°„ã€‚ç„¶åï¼ŒæŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿï¼Œæ‹·è´è‡ªèº«å¯æ‰§è¡Œæ–‡ä»¶åˆ° overlayfs çš„ merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½® capabilitiesã€‚æœ€åï¼Œå®ƒæ‰§è¡Œä½äº upper ç›®å½•çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶ä¼šå°è¯•ä»¥ root æƒé™æ‰§è¡Œ /bin/bashã€‚

æ ¹æ®æ¼æ´åº“ä¿¡æ¯ï¼ŒCISA å°†æ­¤æ¼æ´æ·»åŠ åˆ°å·²çŸ¥è¢«åˆ©ç”¨çš„æ¼æ´åˆ—è¡¨ä¸­ï¼Œè¿›ä¸€æ­¥è¡¨æ˜äº†è¯¥æ¼æ´çš„æœ‰æ•ˆæ€§ã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

æ£€æŸ¥æä¾›çš„ exploit.c ä»£ç ï¼Œæ²¡æœ‰å‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç æˆ–åé—¨ã€‚ä»£ç é€»è¾‘æ¸…æ™°ï¼Œä¸»è¦æ‰§è¡Œäº† overlayfs çš„æŒ‚è½½ï¼Œæ–‡ä»¶å¤åˆ¶ï¼Œè®¾ç½® xattr å’Œæ‰§è¡Œ shell æ“ä½œã€‚ä»£ç çš„æ„å›¾ä¸æ¼æ´æè¿°ä¸€è‡´ï¼Œæ²¡æœ‰å‘ç°éšè—çš„ã€ä¸æ¼æ´åˆ©ç”¨æ— å…³çš„æ¶æ„è¡Œä¸ºã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£é™©ä¸º 0%ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š**  åœ¨å­˜åœ¨æ¼æ´çš„Ubuntuç³»ç»Ÿä¸Šï¼Œåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ (ovlcap/work, ovlcap/lower, ovlcap/upper, ovlcap/merge)ã€‚
2.  **User Namespaceå’ŒMount Namespaceï¼š** ä½¿ç”¨ `unshare` ç³»ç»Ÿè°ƒç”¨åˆ›å»ºæ–°çš„ user namespace å’Œ mount namespaceã€‚
3.  **IDæ˜ å°„ï¼š**  é…ç½® `/proc/self/setgroups`ï¼Œ`/proc/self/uid_map` å’Œ `/proc/self/gid_map`ï¼Œä»¥ä¾¿åœ¨ user namespace ä¸­è·å¾—æœ‰æ•ˆçš„ç”¨æˆ· ID å’Œç»„ IDã€‚
4.  **OverlayFSæŒ‚è½½ï¼š**  ä½¿ç”¨ `mount` ç³»ç»Ÿè°ƒç”¨æŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿï¼Œå°† lower, upper å’Œ work ç›®å½•å…³è”èµ·æ¥ã€‚
5.  **æ–‡ä»¶æ‹·è´ä¸ Capability è®¾ç½®ï¼š**  å°† exploit ç¨‹åºè‡ªèº«æ‹·è´åˆ° overlayfs çš„ merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½® `security.capability` å±æ€§ï¼Œèµ‹äºˆå…¶ CAP_SETUID å’Œ CAP_SETGID ç­‰æƒé™ã€‚
6.  **ææƒæ‰§è¡Œï¼š** æ‰§è¡Œä½äº upper ç›®å½•çš„ exploit ç¨‹åºçš„æ‹·è´ã€‚ç”±äºè¯¥æ–‡ä»¶å…·æœ‰ capabilitiesï¼Œå› æ­¤å¯ä»¥ä»¥ root æƒé™æ‰§è¡Œ shellã€‚

**é¡¹ç›®åœ°å€:** [Abdennour-py/CVE-2021-3493](https://github.com/Abdennour-py/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #2

**æ¥æº**: [CVE-2021-3493-Sornphut_OverlayFS---CVE-2021-3493.md](../2021/CVE-2021-3493-Sornphut_OverlayFS---CVE-2021-3493.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒæ¼æ´

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Ubuntu Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœ¬åœ°ç”¨æˆ·è·å¾— root æƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu kernels before 5.8.0-50.56, 5.4.0-72.80, 4.15.0-142.146, and 4.4.0-209.241

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦è¿è¡Œåœ¨å­˜åœ¨æ¼æ´çš„ Ubuntu å†…æ ¸ä¸Šï¼Œå¹¶ä¸”å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½ overlayfsã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

è¯¥æ¼æ´å­˜åœ¨äº Ubuntu Linux å†…æ ¸çš„ overlayfs å®ç°ä¸­ã€‚ç”±äº Ubuntu å¯¹ overlayfs æŒ‚è½½çš„ç‰¹å®šä¿®æ”¹ï¼Œå¯¼è‡´åœ¨ç”¨æˆ·å‘½åç©ºé—´å†…ï¼Œå¯¹åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­çš„æ–‡ä»¶ capabilities éªŒè¯ä¸å……åˆ†ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡ overlayfs æŒ‚è½½ç»•è¿‡ capabilities æ£€æŸ¥ï¼Œè®¾ç½®æ–‡ä»¶ capabilities æå‡æƒé™ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  åˆ›å»ºä¸€ä¸ªç›®å½•ç»“æ„ï¼ŒåŒ…æ‹¬ lower, upper, work å’Œ merge ç›®å½•ã€‚
2.  ä½¿ç”¨ `unshare` åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´å’ŒæŒ‚è½½å‘½åç©ºé—´ã€‚
3.  é…ç½® `/proc/self/setgroups`, `/proc/self/uid_map`, å’Œ `/proc/self/gid_map` ä»¥æ˜ å°„ç”¨æˆ· ID å’Œç»„ IDã€‚
4.  ä½¿ç”¨ `mount` å‘½ä»¤æŒ‚è½½ overlayfsï¼Œå°† lower, upper å’Œ work ç›®å½•ä¸ merge ç›®å½•å…³è”èµ·æ¥ã€‚
5.  åœ¨ upper ç›®å½•æˆ– merge ç›®å½•ä¸‹åˆ›å»ºæˆ–å¤åˆ¶ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ã€‚
6.  ä½¿ç”¨ `setxattr` è®¾ç½®å¯æ‰§è¡Œæ–‡ä»¶çš„ capabilitiesï¼Œèµ‹äºˆå…¶ root æƒé™ã€‚
7.  æ‰§è¡Œè¯¥æ–‡ä»¶ï¼Œå³å¯è·å¾— root æƒé™ã€‚

**æœ‰æ•ˆæ€§ï¼š**

æä¾›çš„ POC ä»£ç å°è¯•åˆ©ç”¨ CVE-2021-3493 æ¼æ´ã€‚è¯¥ä»£ç åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´å’ŒæŒ‚è½½å‘½åç©ºé—´ï¼Œå¹¶å°è¯•æŒ‚è½½ overlayfsã€‚ç„¶åï¼Œå®ƒåº”è¯¥è®¾ç½® `magic` äºŒè¿›åˆ¶æ–‡ä»¶çš„ capabilitiesï¼Œä»è€Œè·å¾— root æƒé™ã€‚æ ¹æ®æ¼æ´æè¿°ï¼Œè¯¥ POC åº”è¯¥èƒ½å¤Ÿæœ‰æ•ˆåˆ©ç”¨è¯¥æ¼æ´ã€‚

**æŠ•æ¯’é£é™©ï¼š**

æ£€æŸ¥æä¾›çš„ exploit.c æ–‡ä»¶ï¼Œæœªå‘ç°æ˜æ˜¾çš„æ¶æ„æˆ–éšè—ä»£ç ã€‚ä»£ç é€»è¾‘ä¸»è¦é›†ä¸­äºè®¾ç½® overlayfs æŒ‚è½½å’Œæ–‡ä»¶ capabilitiesã€‚ä½†æ˜¯ï¼Œéœ€è¦å§‹ç»ˆè°¨æ…å¯¹å¾…æ¥è‡ªä¸å—ä¿¡ä»»æ¥æºçš„ä»£ç ã€‚ä¸ºäº†ç¡®ä¿å®‰å…¨ï¼Œå»ºè®®åœ¨å—æ§ç¯å¢ƒä¸­ä»”ç»†å®¡æŸ¥å’Œæµ‹è¯•ä»£ç ã€‚


**é¡¹ç›®åœ°å€:** [Sornphut/OverlayFS---CVE-2021-3493](https://github.com/Sornphut/OverlayFS---CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #3

**æ¥æº**: [CVE-2021-3493-briskets_CVE-2021-3493.md](../2021/CVE-2021-3493-briskets_CVE-2021-3493.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å¯¼è‡´æ™®é€šç”¨æˆ·æƒé™æå‡è‡³rootæƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu kernel versions: < 5.8.0-50.56 (5.8 kernel), < 5.4.0-72.80 (5.4 kernel), < 4.15.0-142.146 (4.15 kernel), < 4.4.0-209.241 (4.4 kernel)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦åœ¨å­˜åœ¨æ¼æ´çš„Ubuntuå†…æ ¸ç‰ˆæœ¬ä¸Šï¼Œå¹¶ä¸”å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½overlayfs

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 5%

## è¯¦æƒ…

CVE-2021-3493 æ¼æ´æ˜¯ç”±äº Linux å†…æ ¸çš„ overlayfs å®ç°æ²¡æœ‰æ­£ç¡®éªŒè¯ç”¨æˆ·å‘½åç©ºé—´ä¸­åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸Šæ–‡ä»¶ capabilities çš„è®¾ç½®ã€‚ç”±äº Ubuntu å†…æ ¸ä¸­å­˜åœ¨å…è®¸éç‰¹æƒ overlay æŒ‚è½½çš„è¡¥ä¸ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´è·å¾—æå‡çš„æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  æ¼æ´åˆ©ç”¨ä»£ç é¦–å…ˆåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ (ovlcap/work, ovlcap/lower, ovlcap/upper, ovlcap/merge)ã€‚
2.  åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´å’ŒæŒ‚è½½å‘½åç©ºé—´ã€‚
3.  åœ¨æ–°çš„ç”¨æˆ·å‘½åç©ºé—´ä¸­ï¼Œå°†å½“å‰ç”¨æˆ·çš„ UID å’Œ GID æ˜ å°„åˆ° root ç”¨æˆ·ã€‚
4.  ä½¿ç”¨ overlayfs å°† lowerdir (ovlcap/lower), upperdir (ovlcap/upper) å’Œ workdir (ovlcap/work) æŒ‚è½½åˆ° mergedir (ovlcap/merge)ã€‚
5.  å¤åˆ¶è‡ªèº« (exploit ç¨‹åº) åˆ° mergedir/magicï¼Œå¹¶è®¾ç½® security.capability æ‰©å±•å±æ€§ä¸º all+epï¼Œèµ‹äºˆè¯¥æ–‡ä»¶ capabilitiesã€‚
6.  æ‰§è¡Œ mergedir/magicï¼Œç”±äº capabilities çš„è®¾ç½®ï¼Œè¯¥ç¨‹åºä¼šä»¥ root æƒé™æ‰§è¡Œã€‚
7.  æœ€åï¼Œæ‰§è¡Œ upperdir/magicï¼Œå¯åŠ¨ä¸€ä¸ª root shellã€‚

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„POCä»£ç æ˜¯æœ‰æ•ˆçš„ï¼Œèƒ½å¤Ÿåˆ©ç”¨ CVE-2021-3493 æ¼æ´åœ¨å—å½±å“çš„ Ubuntu ç³»ç»Ÿä¸Šå®ç°æœ¬åœ°ææƒã€‚

**æŠ•æ¯’é£é™©ï¼š**
è¯¥POCä»£ç çš„ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´è¿›è¡Œææƒï¼Œä½†ä»ç„¶å­˜åœ¨æ½œåœ¨çš„æŠ•æ¯’é£é™©ã€‚æ¯”å¦‚ä½œè€…å¯èƒ½åœ¨ç¼–è¯‘å’Œè¿è¡Œå‰æ·»åŠ ä¸€äº›æ¶æ„ä»£ç ï¼Œä¾‹å¦‚ï¼š

1.  **åé—¨æ¤å…¥ï¼š** åœ¨ææƒæˆåŠŸåï¼Œæ¤å…¥ä¸€ä¸ªåé—¨ç¨‹åºï¼Œå…è®¸æ”»å‡»è€…è¿œç¨‹è®¿é—®ç³»ç»Ÿã€‚
2.  **æ•°æ®çªƒå–ï¼š** åœ¨ææƒè¿‡ç¨‹ä¸­ï¼Œçªƒå–ç”¨æˆ·çš„æ•æ„Ÿæ•°æ®ã€‚
3.  **ç ´åç³»ç»Ÿï¼š** åœ¨ææƒå¤±è´¥æˆ–è€…æˆåŠŸåï¼Œç ´åç³»ç»Ÿæ–‡ä»¶æˆ–è€…é…ç½®ã€‚

è€ƒè™‘åˆ°ä»£ç ç›¸å¯¹ç®€çŸ­ä¸”åŠŸèƒ½æ˜ç¡®ï¼Œè¯„ä¼°æŠ•æ¯’é£é™©ä¸º5%ã€‚ç”¨æˆ·éœ€è¦ä»”ç»†å®¡æŸ¥ä»£ç ï¼Œå¹¶åœ¨å®‰å…¨çš„ç¯å¢ƒä¸­è¿›è¡Œæµ‹è¯•ã€‚

**é¡¹ç›®åœ°å€:** [briskets/CVE-2021-3493](https://github.com/briskets/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #4

**æ¥æº**: [CVE-2021-3493-cyberx-1_OverlayFS-CVE-2021-3493.md](../2021/CVE-2021-3493-cyberx-1_OverlayFS-CVE-2021-3493.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯ä»æ™®é€šç”¨æˆ·ææƒè‡³root

**å½±å“ç‰ˆæœ¬:** Ubuntu kernels: 5.8.0-50.56 (5.8 kernel), 5.4.0-72.80 (5.4 kernel), 4.15.0-142.146 (4.15 kernel), 4.4.0-209.241 (4.4 kernel)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦è¿è¡Œåœ¨å­˜åœ¨æ¼æ´çš„Ubuntuå†…æ ¸ç‰ˆæœ¬ä¸Šï¼Œå¯ç”¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å’Œå…è®¸éç‰¹æƒ overlay mountsã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2021-3493æ˜¯Ubuntuå†…æ ¸OverlayFSå®ç°ä¸­çš„ä¸€ä¸ªæƒé™æå‡æ¼æ´ã€‚ç”±äºoverlayfsåœ¨ç”¨æˆ·å‘½åç©ºé—´ä¸­æ²¡æœ‰æ­£ç¡®éªŒè¯åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­æ–‡ä»¶åŠŸèƒ½è®¾ç½®ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å’ŒUbuntuå†…æ ¸ä¸­çš„éç‰¹æƒoverlayæŒ‚è½½è¡¥ä¸ï¼Œè·å–æå‡çš„æƒé™ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** åœ¨å­˜åœ¨æ¼æ´çš„Ubuntuå†…æ ¸ä¸Šï¼Œç¡®ä¿å¯ç”¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´ã€‚æ¼æ´åº“ä¿¡æ¯æåˆ°ç¦ç”¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å¯ä»¥ä½œä¸ºç¼“è§£æªæ–½ï¼Œæ‰€ä»¥è¦ç¡®ä¿å¯ç”¨ã€‚
2.  **åˆ›å»ºOverlayFSç»“æ„ï¼š** PoCä»£ç é¦–å…ˆåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼ˆlower, upper, work, mergeï¼‰ç”¨äº overlayfs æ–‡ä»¶ç³»ç»Ÿã€‚
3.  **åˆ›å»ºç”¨æˆ·å‘½åç©ºé—´ï¼š** ä½¿ç”¨`unshare`ç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´ã€‚è¿™å…è®¸åœ¨æ–°çš„å‘½åç©ºé—´ä¸­æ‹¥æœ‰ä¸åŒçš„ç”¨æˆ·IDå’Œç»„IDæ˜ å°„ã€‚
4.  **è®¾ç½®UID/GIDæ˜ å°„ï¼š** å°†å½“å‰ç”¨æˆ·çš„UIDå’ŒGIDæ˜ å°„åˆ°æ–°å‘½åç©ºé—´ä¸­çš„rootç”¨æˆ· (UID 0 å’Œ GID 0)ã€‚
5.  **æŒ‚è½½OverlayFSï¼š** ä½¿ç”¨`mount`ç³»ç»Ÿè°ƒç”¨å°† overlayfs æ–‡ä»¶ç³»ç»ŸæŒ‚è½½åˆ° merge ç›®å½•ã€‚æŒ‡å®š lowerdir, upperdir å’Œ workdirã€‚
6.  **å¤åˆ¶è‡ªèº«å¹¶è®¾ç½®Capabilitiesï¼š** å°†è‡ªèº«å¯æ‰§è¡Œæ–‡ä»¶å¤åˆ¶åˆ° overlayfs çš„ merge ç›®å½•ï¼Œç„¶åä½¿ç”¨`setxattr`è®¾ç½®`security.capability`æ‰©å±•å±æ€§ï¼Œèµ‹äºˆè¯¥æ–‡ä»¶ root æƒé™ã€‚
7.  **æ‰§è¡Œææƒåçš„ç¨‹åºï¼š** é€šè¿‡æ‰§è¡Œ upper ç›®å½•ä¸‹çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆä¹‹å‰å¤åˆ¶å¹¶è®¾ç½®äº† capabilities çš„æ–‡ä»¶ï¼‰æ¥è·å– root æƒé™ã€‚è¿™ä¸ªç¨‹åºä¼šæ£€æŸ¥æ˜¯å¦æœ‰"shell"å‚æ•°ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™ä¼šé‡æ–°æ‰§è¡Œè‡ªèº«ï¼Œä½†è¿™æ¬¡ä¼šå¸¦æœ‰`shell`å‚æ•°ï¼Œä»è€Œè§¦å‘`setuid(0)`å’Œ`setgid(0)`ï¼Œæœ€ç»ˆæ‰§è¡Œ`/bin/bash`ï¼Œè·å¾— root shellã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

ä»£ç ä¸­å­˜åœ¨ä¸€å®šçš„æŠ•æ¯’é£é™©ï¼Œè™½ç„¶ä¸»è¦é€»è¾‘æ˜¯åˆ©ç”¨æ¼æ´è¿›è¡Œææƒï¼Œä½†å­˜åœ¨ä¿®æ”¹`/bin/bash`çš„å¯èƒ½æ€§ï¼Œä½†æ˜¯ç»è¿‡ä»£ç åˆ†æä»¥åŠæ¼æ´åŸç†ï¼Œåˆ¤æ–­æ¼æ´åˆ©ç”¨è¿‡ç¨‹ä¸­æ²¡æœ‰ä¿®æ”¹`/bin/bash`æ“ä½œ,ä»£ç ä¸­é£é™©ä¸»è¦å­˜åœ¨äºä»¥ä¸‹å‡ ç‚¹:

1.  **ä¾èµ–å¤–éƒ¨äºŒè¿›åˆ¶æ–‡ä»¶ï¼š** è¯¥æ¼æ´åˆ©ç”¨ä¾èµ–äºç³»ç»Ÿä¸Šçš„`/bin/bash`ã€‚å¦‚æœæ”»å‡»è€…æ›¿æ¢æˆ–ç¯¡æ”¹äº†ç›®æ ‡ç³»ç»Ÿä¸Šçš„`/bin/bash`ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ„å¤–çš„è¡Œä¸ºæˆ–å®‰å…¨é—®é¢˜ã€‚
2.  **æ¸…ç†æ“ä½œé£é™©ï¼š** ä»£ç å¼€å§‹æ—¶ä½¿ç”¨`system(buf)`æ‰§è¡Œ`rm -rf '%s/'`ï¼Œå¦‚æœ`DIR_BASE`è¢«æ¶æ„ä¿®æ”¹ï¼Œå¯èƒ½å¯¼è‡´æ„å¤–çš„æ–‡ä»¶åˆ é™¤ã€‚
3.  **ä¸å®Œå–„çš„é”™è¯¯å¤„ç†ï¼š** è™½ç„¶ PoC ä»£ç åŒ…å«äº†ä¸€äº›é”™è¯¯å¤„ç†ï¼Œä½†åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå¦‚æœé”™è¯¯å¤„ç†ä¸å½“ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ‹’ç»æœåŠ¡æˆ–æœªå®šä¹‰çš„è¡Œä¸ºã€‚

æ€»ä½“è€Œè¨€ï¼Œè¯¥ PoC ä»£ç çš„æŠ•æ¯’é£é™©è¾ƒä½ï¼Œä¸»è¦é£é™©åœ¨äºä¾èµ–å¤–éƒ¨äºŒè¿›åˆ¶æ–‡ä»¶å’Œæ½œåœ¨çš„æ¸…ç†æ“ä½œé£é™©ã€‚ä»£ç æœ¬èº«ä¸»è¦æ˜¯ä¸ºäº†æ¼”ç¤ºæ¼æ´åˆ©ç”¨ï¼Œå¹¶æœªå‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç ã€‚ è¯„ä¼°æŠ•æ¯’é£é™©ä¸º10%ã€‚


**é¡¹ç›®åœ°å€:** [cyberx-1/OverlayFS-CVE-2021-3493](https://github.com/cyberx-1/OverlayFS-CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #5

**æ¥æº**: [CVE-2021-3493-derek-turing_CVE-2021-3493.md](../2021/CVE-2021-3493-derek-turing_CVE-2021-3493.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Ubuntu Linux Kernel

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœ¬åœ°ç”¨æˆ·å¯æå‡è‡³ root æƒé™

**å½±å“ç‰ˆæœ¬:** 4.4 <= kernel < 4.4.0-209.241, 4.15 <= kernel < 4.15.0-142.146, 5.4 <= kernel < 5.4.0-72.80, 5.8 <= kernel < 5.8.0-50.56

**åˆ©ç”¨æ¡ä»¶:** Ubuntu å†…æ ¸å¼€å¯äº† unprivileged user namespaces å’Œ unprivileged overlay mounts

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

è¯¥æ¼æ´å­˜åœ¨äº Ubuntu Linux å†…æ ¸çš„ OverlayFS å®ç°ä¸­ï¼Œç”±äº overlayfs å¯¹åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­æ–‡ä»¶ capabilities çš„è®¾ç½®éªŒè¯ä¸å½“ï¼Œç»“åˆæœªæˆæƒç”¨æˆ·å‘½åç©ºé—´å’Œ Ubuntu å†…æ ¸ä¸­å…è®¸æœªæˆæƒ overlay æŒ‚è½½çš„è¡¥ä¸ï¼Œæ”»å‡»è€…å¯åˆ©ç”¨æ­¤æ¼æ´æå‡æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** é¦–å…ˆï¼Œç¡®ä¿ç›®æ ‡ç³»ç»Ÿæ»¡è¶³æ¼æ´åˆ©ç”¨çš„æ¡ä»¶ï¼Œå³ Ubuntu å†…æ ¸ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…ï¼Œå¹¶ä¸”å¯ç”¨äº† unprivileged user namespaces å’Œ unprivileged overlay mountsã€‚æ¼æ´åº“ä¿¡æ¯ä¸­ç»™å‡ºäº†å—å½±å“çš„ç‰ˆæœ¬èŒƒå›´ã€‚
2.  **åˆ›å»ºç›®å½•ç»“æ„ï¼š** åˆ›å»º overlayfs æ‰€éœ€çš„ç›®å½•ç»“æ„ï¼ŒåŒ…æ‹¬ lowerdirï¼ˆåº•å±‚ç›®å½•ï¼‰ã€upperdirï¼ˆä¸Šå±‚ç›®å½•ï¼‰ã€workdirï¼ˆå·¥ä½œç›®å½•ï¼‰å’Œ mergedirï¼ˆåˆå¹¶ç›®å½•ï¼‰ã€‚
3.  **åˆ›å»ºç”¨æˆ·å‘½åç©ºé—´ï¼š** ä½¿ç”¨ `unshare` å‘½ä»¤åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´ï¼Œè¿™å…è®¸åœ¨éç‰¹æƒç”¨æˆ·ä¸‹æ‰§è¡Œä¸€äº›ç‰¹æƒæ“ä½œã€‚
4.  **è®¾ç½® UID/GID æ˜ å°„ï¼š** åœ¨ç”¨æˆ·å‘½åç©ºé—´ä¸­ï¼Œå°†å½“å‰ç”¨æˆ·çš„ UID å’Œ GID æ˜ å°„åˆ° root ç”¨æˆ· (UID 0) å’Œ root ç»„ (GID 0)ï¼Œè¿™æ ·åœ¨ overlayfs ä¸­åˆ›å»ºçš„æ–‡ä»¶å°†å±äº root ç”¨æˆ·ã€‚
5.  **æŒ‚è½½ OverlayFSï¼š** ä½¿ç”¨ `mount` å‘½ä»¤å°† overlayfs æŒ‚è½½åˆ° mergedirï¼ŒæŒ‡å®š lowerdirã€upperdir å’Œ workdirã€‚
6.  **å¤åˆ¶å¹¶è®¾ç½® Capabilitiesï¼š** å°† exploit ç¨‹åºè‡ªèº«å¤åˆ¶åˆ° mergedir ä¸­ï¼Œå¹¶ä½¿ç”¨ `setxattr` å‘½ä»¤è®¾ç½®å…¶ security.capability æ‰©å±•å±æ€§ï¼Œèµ‹äºˆå…¶ CAP_SETUID å’Œ CAP_SETGID capabilitiesã€‚è¿™ä¸ªcapabilitieså…è®¸ç¨‹åºåœ¨æ²¡æœ‰rootæƒé™çš„æƒ…å†µä¸‹è®¾ç½®uidå’Œgidã€‚
7.  **è§¦å‘ææƒï¼š** è¿è¡Œ mergedir ä¸­çš„ exploit ç¨‹åºï¼Œç”±äºå·²è®¾ç½® capabilitiesï¼Œç¨‹åºå°†ä»¥ root æƒé™è¿è¡Œï¼Œä»è€Œæ‰§è¡Œç‰¹æƒæ“ä½œã€‚

**ä»£ç åˆ†æï¼š**

*   `exploit.c` æ˜¯åˆ©ç”¨ä»£ç ï¼Œå®ƒåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼Œå»ºç«‹ç”¨æˆ·å‘½åç©ºé—´ï¼ŒæŒ‚è½½ overlayfsï¼Œç„¶åå°†è‡ªèº«å¤åˆ¶åˆ° overlayfs ä¸­ï¼Œå¹¶è®¾ç½® capabilitiesã€‚æœ€åï¼Œæ‰§è¡Œå¤åˆ¶åˆ° upperdir ä¸­çš„ç¨‹åºï¼Œè¯¥ç¨‹åºä¼šå°†å½“å‰è¿›ç¨‹ææƒä¸º rootã€‚
*   ä»£ç ä¸­ä½¿ç”¨äº† `setxattr` å‡½æ•°æ¥è®¾ç½®æ–‡ä»¶ capabilitiesï¼Œè¿™æ˜¯åˆ©ç”¨æ¼æ´çš„å…³é”®æ­¥éª¤ã€‚
*   mainå‡½æ•°é¦–å…ˆforkä¸€ä¸ªå­è¿›ç¨‹æ‰§è¡Œexploitå‡½æ•°ï¼Œåœ¨exploitå‡½æ•°æ‰§è¡Œå®Œæ¯•åï¼Œçˆ¶è¿›ç¨‹æ‰§è¡ŒBIN_UPPERä¸­çš„magicç¨‹åºï¼Œå¦‚æœå¸¦æœ‰shellå‚æ•°ï¼Œmagicç¨‹åºä¼šè®¾ç½®uidå’Œgidä¸º0ï¼Œå¹¶ä¸”è¿è¡Œä¸€ä¸ªbash shellã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

ä»”ç»†æ£€æŸ¥äº† POC ä»£ç ï¼Œæ²¡æœ‰å‘ç°æ˜æ˜¾çš„æŠ•æ¯’ä»£ç ã€‚ä»£ç é€»è¾‘æ¸…æ™°ï¼Œä¸»è¦ç”¨äºåˆ›å»º overlayfs ç¯å¢ƒå¹¶è®¾ç½®æ–‡ä»¶ capabilities ä»¥è¿›è¡Œææƒã€‚ä½œè€…å¹¶æ²¡æœ‰å°è¯•åœ¨ä»£ç ä¸­éšè—æ¶æ„è¡Œä¸ºï¼Œä¾‹å¦‚ï¼š

*   è¿æ¥å¤–éƒ¨æœåŠ¡å™¨
*   ä¿®æ”¹ç³»ç»Ÿæ–‡ä»¶
*   å®‰è£…åé—¨
*   æ”¶é›†ç”¨æˆ·ä¿¡æ¯

å› æ­¤ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ (0%)ã€‚

**é¡¹ç›®åœ°å€:** [derek-turing/CVE-2021-3493](https://github.com/derek-turing/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #6

**æ¥æº**: [CVE-2021-3493-fathallah17_OverlayFS-CVE-2021-3493.md](../2021/CVE-2021-3493-fathallah17_OverlayFS-CVE-2021-3493.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°æƒé™æå‡

**å½±å“åº”ç”¨:** Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å¯¼è‡´æœ¬åœ°æƒé™æå‡è‡³root

**å½±å“ç‰ˆæœ¬:** 4.4 <= Linux Kernel < 5.8.0-50.56 (Ubuntu ç‰¹å®šç‰ˆæœ¬)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦å­˜åœ¨Ubuntuå†…æ ¸ä¸­å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½OverlayFSçš„è¡¥ä¸ï¼Œä¸”ç”¨æˆ·å‘½åç©ºé—´æœªè¢«ç¦ç”¨ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 1%

## è¯¦æƒ…

CVE-2021-3493 æ˜¯ä¸€ä¸ªå­˜åœ¨äº Linux å†…æ ¸ OverlayFS å®ç°ä¸­çš„æƒé™æå‡æ¼æ´ã€‚æ¼æ´çš„æ ¹æœ¬åŸå› æ˜¯ OverlayFS åœ¨è®¾ç½®åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­æ–‡ä»¶çš„ capabilities æ—¶ï¼Œæ²¡æœ‰æ­£ç¡®åœ°éªŒè¯ç”¨æˆ·å‘½åç©ºé—´ã€‚åœ¨å­˜åœ¨å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½ OverlayFS çš„ Ubuntu å†…æ ¸è¡¥ä¸çš„ç¯å¢ƒä¸­ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´è·å¾—æå‡çš„æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š**  ç›®æ ‡ç³»ç»Ÿéœ€è¦æ˜¯å—å½±å“çš„ Ubuntu ç‰ˆæœ¬ï¼Œå¹¶ä¸”å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½ OverlayFSï¼ŒåŒæ—¶ç”¨æˆ·å‘½åç©ºé—´æ²¡æœ‰è¢«ç¦ç”¨ã€‚
2.  **è·å–æ¼æ´åˆ©ç”¨ä»£ç ï¼š**  ä»å¯ä¿¡æ¥æºè·å–æ¼æ´åˆ©ç”¨ä»£ç  (ä¾‹å¦‚ SSD-Disclosure æä¾›çš„ exploit.c)ã€‚
3.  **ç¼–è¯‘æ¼æ´åˆ©ç”¨ä»£ç ï¼š**  ä½¿ç”¨ gcc ç­‰ç¼–è¯‘å™¨å°† exploit.c ç¼–è¯‘ä¸ºå¯æ‰§è¡Œæ–‡ä»¶ã€‚
4.  **æ‰§è¡Œæ¼æ´åˆ©ç”¨ä»£ç ï¼š**  è¿è¡Œç¼–è¯‘åçš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚æ¼æ´åˆ©ç”¨ä»£ç ä¼šåˆ©ç”¨ OverlayFS çš„æ¼æ´ï¼Œé€šè¿‡è®¾ç½®æ–‡ä»¶ capabilities æ¥æå‡å½“å‰ç”¨æˆ·çš„æƒé™è‡³ rootã€‚
5.  **è·å– root æƒé™ï¼š**  æˆåŠŸæ‰§è¡Œæ¼æ´åˆ©ç”¨ä»£ç åï¼Œç”¨æˆ·å°†è·å¾— root æƒé™ã€‚

**å…³äºæŠ•æ¯’é£é™©ï¼š**

æä¾›çš„POCä»£ç åªæ˜¯ä¸€ä¸ªç®€å•çš„åˆ©ç”¨æ–¹å¼,ä¸å¤ªå¯èƒ½åŒ…å«æ¶æ„ä»£ç ã€‚ä½†å§‹ç»ˆéœ€è¦å¯¹ä»»ä½•æ¥æºçš„æ¼æ´åˆ©ç”¨ä»£ç è¿›è¡Œå®¡æŸ¥ï¼Œä»¥é™ä½é£é™©ã€‚
å¯¹ä¸‹è½½çš„æ–‡ä»¶è¿›è¡Œæ£€æŸ¥ï¼Œå¦‚å“ˆå¸Œæ ¡éªŒï¼Œå¯ä»¥æœ€å¤§ç¨‹åº¦çš„é¿å…å¼•å…¥æ¶æ„ä»£ç ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**

æ ¹æ®æ¼æ´æè¿°å’Œåˆ©ç”¨ä»£ç ï¼Œè¯¥æ¼æ´åˆ©ç”¨æ˜¯æœ‰æ•ˆçš„ã€‚åˆ©ç”¨ä»£ç é€šè¿‡OverlayFSçš„æ¼æ´ï¼Œå…è®¸ä½æƒé™ç”¨æˆ·è·å¾—rootæƒé™ã€‚

**å…¶ä»–ä¿¡æ¯:**
CISA å·²å°†æ­¤æ¼æ´æ·»åŠ åˆ°å·²çŸ¥è¢«åˆ©ç”¨çš„æ¼æ´ç›®å½• (KEV) ä¸­ï¼Œè¡¨æ˜è¯¥æ¼æ´å·²è¢«å¹¿æ³›åˆ©ç”¨ã€‚

**é¡¹ç›®åœ°å€:** [fathallah17/OverlayFS-CVE-2021-3493](https://github.com/fathallah17/OverlayFS-CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #7

**æ¥æº**: [CVE-2021-3493-fei9747_CVE-2021-3493.md](../2021/CVE-2021-3493-fei9747_CVE-2021-3493.md)

## CVE-2021-3493 Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ”»å‡»è€…å¯åˆ©ç”¨æ­¤æ¼æ´è·å– root æƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu kernel versions: < 5.8.0-50.56, < 5.4.0-72.80, < 4.15.0-142.146, < 4.4.0-209.241

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦åœ¨å­˜åœ¨æ¼æ´çš„ Ubuntu ç³»ç»Ÿä¸Šæœ¬åœ°æ‰§è¡Œ

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 5%

## è¯¦æƒ…

CVE-2021-3493 æ˜¯ä¸€ä¸ªå­˜åœ¨äº Ubuntu Linux å†…æ ¸ overlayfs å®ç°ä¸­çš„æœ¬åœ°ææƒæ¼æ´ã€‚è¯¥æ¼æ´æºäº overlayfs æœªèƒ½æ­£ç¡®éªŒè¯ç”¨æˆ·å‘½åç©ºé—´ä¸­åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸Šæ–‡ä»¶ capabilities çš„è®¾ç½®ã€‚ç»“åˆæœªæˆæƒç”¨æˆ·å‘½åç©ºé—´ä»¥åŠ Ubuntu å†…æ ¸ä¸­å…è®¸æœªæˆæƒ overlay mount çš„è¡¥ä¸ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´æå‡æƒé™ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼ŒåŒ…æ‹¬lowerdirï¼Œupperdirï¼Œworkdirå’Œmergedirã€‚
2.  **åˆ›å»ºå‘½åç©ºé—´ï¼š** ä½¿ç”¨ `unshare` ç³»ç»Ÿè°ƒç”¨åˆ›å»ºæ–°çš„ç”¨æˆ·å‘½åç©ºé—´å’ŒæŒ‚è½½å‘½åç©ºé—´ã€‚
3.  **è®¾ç½®ç”¨æˆ·å’Œç»„IDæ˜ å°„ï¼š** å°†å½“å‰ç”¨æˆ·çš„ UID å’Œ GID æ˜ å°„åˆ°æ–°çš„ç”¨æˆ·å‘½åç©ºé—´ä¸­ï¼Œä»¥ä¾¿åœ¨æ–°çš„å‘½åç©ºé—´ä¸­æ‹¥æœ‰æƒé™ã€‚
4.  **æŒ‚è½½ OverlayFSï¼š** ä½¿ç”¨ `mount` ç³»ç»Ÿè°ƒç”¨ï¼Œå°† overlayfs æŒ‚è½½åˆ° mergedirï¼Œå¹¶å°† lowerdirï¼Œupperdir å’Œ workdir æŒ‡å®šä¸ºç›¸åº”çš„ç›®å½•ã€‚
5.  **è®¾ç½® Capabilitiesï¼š** å¤åˆ¶å½“å‰æ‰§è¡Œçš„ç¨‹åºåˆ° mergedirï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½®è¯¥æ–‡ä»¶çš„ capabilitiesï¼Œä½¿å…¶å…·æœ‰ root æƒé™ã€‚ è¿™æ­¥æ˜¯æ¼æ´åˆ©ç”¨çš„å…³é”®ã€‚
6.  **æ‰§è¡ŒPayloadï¼š** æ‰§è¡Œupperç›®å½•ä¸­çš„æ–‡ä»¶ï¼Œå› ä¸ºè®¾ç½®äº†Capabilitiesï¼Œå¯ä»¥è·å¾—rootæƒé™ã€‚

**æœ‰æ•ˆæ€§ï¼š**

æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’ŒPOCä»£ç æè¿°ï¼Œè¯¥æ¼æ´åœ¨ç‰¹å®šç‰ˆæœ¬çš„ Ubuntu å†…æ ¸ä¸Šæ˜¯å¯åˆ©ç”¨çš„ã€‚æä¾›çš„POCä»£ç å±•ç¤ºäº†åˆ©ç”¨è¯¥æ¼æ´æå‡æƒé™çš„å®Œæ•´è¿‡ç¨‹ã€‚

**æŠ•æ¯’é£é™©ï¼š**

ä»£ç ä¸­å­˜åœ¨æ½œåœ¨çš„æŠ•æ¯’é£é™©ï¼Œä½†æ˜¯é£é™©è¾ƒä½ã€‚ä¸»è¦é›†ä¸­åœ¨ç¼–è¯‘å’Œè¿è¡Œexploitæ—¶ã€‚æ”»å‡»è€…å¯èƒ½é€šè¿‡ä¿®æ”¹ exploit.c æ–‡ä»¶ï¼Œä¾‹å¦‚æ·»åŠ æ¶æ„ä»£ç æˆ–åé—¨ï¼Œä»è€Œåœ¨ç›®æ ‡ç³»ç»Ÿä¸Šæ‰§è¡Œæ¶æ„æ“ä½œã€‚ä½†æ˜¯æ ¹æ®æä¾›çš„POCä»£ç æ¥çœ‹, é£é™©ç³»æ•°è¾ƒä½.

**é£é™©è¯„ä¼°ï¼š**

è¯¥æ¼æ´åˆ©ç”¨çš„æˆåŠŸå–å†³äºç›®æ ‡ç³»ç»Ÿæ˜¯å¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š

*   è¿è¡Œå—å½±å“çš„ Ubuntu å†…æ ¸ç‰ˆæœ¬ã€‚
*   å¯ç”¨äº†æœªæˆæƒç”¨æˆ·å‘½åç©ºé—´å’Œ overlayfs mountã€‚
*   ç›®æ ‡ç³»ç»Ÿä¸Šå­˜åœ¨ `gcc` ç¼–è¯‘å™¨, èƒ½å¤Ÿç¼–è¯‘exploitã€‚

å¦‚æœç›®æ ‡ç³»ç»Ÿæ»¡è¶³è¿™äº›æ¡ä»¶ï¼Œæ”»å‡»è€…å¯ä»¥ä½¿ç”¨æä¾›çš„ POC ä»£ç æˆåŠŸåˆ©ç”¨è¯¥æ¼æ´ï¼Œä»è€Œè·å¾— root æƒé™ã€‚


**é¡¹ç›®åœ°å€:** [fei9747/CVE-2021-3493](https://github.com/fei9747/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #8

**æ¥æº**: [CVE-2021-3493-iamz24_CVE-2021-3493_CVE-2022-3357.md](../2021/CVE-2021-3493-iamz24_CVE-2021-3493_CVE-2022-3357.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒæ¼æ´

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å¯¼è‡´æœ¬åœ°æƒé™æå‡è‡³ root

**å½±å“ç‰ˆæœ¬:** Ubuntu kernels < 5.8.0-50.56, < 5.4.0-72.80, < 4.15.0-142.146, < 4.4.0-209.241

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç›®æ ‡ç³»ç»Ÿå¼€å¯ unprivileged user namespaces å’Œå­˜åœ¨ OverlayFS æœåŠ¡ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2021-3493 æ¼æ´æ˜¯ Linux å†…æ ¸ overlayfs å®ç°ä¸­ï¼Œåœ¨ç”¨æˆ·å‘½åç©ºé—´ä¸­å¯¹åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­çš„æ–‡ä»¶ capabilities éªŒè¯ä¸å½“å¯¼è‡´çš„ã€‚ç”±äº Ubuntu å†…æ ¸ä¸­å­˜åœ¨å…è®¸éç‰¹æƒ overlay æŒ‚è½½çš„è¡¥ä¸ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¯¥æ¼æ´æå‡æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** æ£€æŸ¥ç›®æ ‡ç³»ç»Ÿæ˜¯å¦å­˜åœ¨ overlayfs æœåŠ¡ï¼Œå¦‚æœæ²¡æœ‰åˆ™åŠ è½½ overlay æ¨¡å—ã€‚åŒæ—¶ï¼Œç¡®ä¿å¼€å¯äº† unprivileged user namespacesã€‚
2.  **ç¼–è¯‘ Payloadï¼š** ä½¿ç”¨ GCC ç¼–è¯‘æä¾›çš„ `payload.c` æ–‡ä»¶ã€‚
3.  **è¿è¡Œ Payloadï¼š** è¿è¡Œç¼–è¯‘åçš„å¯æ‰§è¡Œæ–‡ä»¶ `a.out`ã€‚
4.  **è·å– Root Shellï¼š** Payload ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å‘½åç©ºé—´ï¼ŒæŒ‚è½½ overlayfsï¼Œè®¾ç½® capabilityï¼Œæœ€ç»ˆæ‰§è¡Œä¸€ä¸ªå…·æœ‰ root æƒé™çš„ shellã€‚

**æœ‰æ•ˆæ€§ï¼š**

æä¾›çš„ POC ä»£ç åŸºæœ¬æœ‰æ•ˆï¼Œèƒ½å¤Ÿåˆ©ç”¨è¯¥æ¼æ´åœ¨ç¬¦åˆæ¡ä»¶çš„ Ubuntu ç³»ç»Ÿä¸Šå®ç°æœ¬åœ°ææƒã€‚

**æŠ•æ¯’é£é™©ï¼š**

å­˜åœ¨è¾ƒä½çš„æŠ•æ¯’é£é™©ï¼ˆ10%ï¼‰ã€‚è™½ç„¶ä»£ç çš„ä¸»è¦åŠŸèƒ½æ˜¯å®ç°ææƒï¼Œä½†ä»ç„¶éœ€è¦è°¨æ…å¯¹å¾…æ¥æºä¸æ˜çš„ä»£ç ï¼Œä½œè€…å¯èƒ½ä¼šåœ¨å…¶ä¸­éšè—ä¸€äº›æ¶æ„è¡Œä¸ºï¼Œæ¯”å¦‚ä¸Šä¼ æ•æ„Ÿä¿¡æ¯ç­‰ã€‚ç‰¹åˆ«æ˜¯éœ€è¦æ£€æŸ¥ `exploit`å‡½æ•°ä¸­çš„ç›¸å…³æ–‡ä»¶æ“ä½œå’Œå‘½ä»¤æ‰§è¡Œæ˜¯å¦å­˜åœ¨æ¶æ„è¡Œä¸ºã€‚å°¤å…¶å…³æ³¨`system(buf);`æ˜¯å¦ä¼šæ‰§è¡Œæ¶æ„çš„æŒ‡ä»¤ã€‚

**æ€»ç»“ï¼š**

è¯¥æ¼æ´åˆ©ç”¨è¾ƒä¸ºç›´æ¥ï¼Œåˆ©ç”¨æ¡ä»¶ç›¸å¯¹æ˜ç¡®ï¼Œä½†éœ€è¦æ³¨æ„æ½œåœ¨çš„æŠ•æ¯’é£é™©ã€‚åœ¨å®é™…ä½¿ç”¨æ—¶ï¼Œåº”è¯¥ä»”ç»†å®¡æŸ¥ä»£ç ï¼Œç¡®ä¿æ²¡æœ‰æ¶æ„è¡Œä¸ºã€‚

**é¡¹ç›®åœ°å€:** [iamz24/CVE-2021-3493_CVE-2022-3357](https://github.com/iamz24/CVE-2021-3493_CVE-2022-3357)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #9

**æ¥æº**: [CVE-2021-3493-inspiringz_CVE-2021-3493.md](../2021/CVE-2021-3493-inspiringz_CVE-2021-3493.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Ubuntu Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸ä½æƒé™ç”¨æˆ·æå‡åˆ°rootæƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu 4.4, 4.15, 5.4, 5.8 kernels (å—å½±å“ç‰ˆæœ¬è¯¦è§æ¼æ´åº“ä¿¡æ¯)

**åˆ©ç”¨æ¡ä»¶:** Ubuntuå†…æ ¸ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…ï¼Œå¯ç”¨æœªæˆæƒç”¨æˆ·å‘½åç©ºé—´ï¼Œå…è®¸æœªæˆæƒOverlayFSæŒ‚è½½ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 5%

## è¯¦æƒ…

CVE-2021-3493æ˜¯Ubuntuå†…æ ¸ä¸­OverlayFSå®ç°çš„ä¸€ä¸ªæ¼æ´ï¼Œå…è®¸ä½æƒé™ç”¨æˆ·é€šè¿‡åˆ©ç”¨user namespaceå’ŒOverlayFSæŒ‚è½½ç»•è¿‡æ–‡ä»¶ç³»ç»Ÿæƒé™æ£€æŸ¥æ¥æå‡æƒé™ã€‚ 

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡:** æ¼æ´åˆ©ç”¨éœ€è¦å­˜åœ¨Ubuntuç³»ç»Ÿï¼Œä¸”å†…æ ¸ç‰ˆæœ¬åœ¨æ¼æ´åº“ä¿¡æ¯ä¸­æè¿°çš„å—å½±å“èŒƒå›´å†…ï¼Œå¹¶ä¸”éœ€è¦å¯ç”¨æœªæˆæƒç”¨æˆ·å‘½åç©ºé—´(unprivileged user namespaces)ã€‚æ­¤å¤–ï¼Œä¸ºäº†åˆ©ç”¨OverlayFSï¼Œç³»ç»Ÿéœ€è¦é…ç½®å…è®¸æœªæˆæƒç”¨æˆ·è¿›è¡ŒOverlayFSæŒ‚è½½ã€‚
2.  **æ¼æ´åˆ©ç”¨:**  æ”»å‡»è€…é¦–å…ˆåˆ›å»ºä¸€ä¸ªåŒ…å«lower, upper, workç›®å½•çš„OverlayFSç»“æ„ã€‚
3.  **åˆ©ç”¨è¿‡ç¨‹:** åˆ©ç”¨`unshare`ç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€ä¸ªæ–°çš„user namespaceå’Œmount namespaceã€‚ åœ¨æ–°namespaceä¸­ï¼Œå°†è‡ªå·±çš„UIDå’ŒGIDæ˜ å°„åˆ°rootæƒé™ã€‚ ç„¶åï¼Œä½¿ç”¨æ„é€ çš„lowerdirã€upperdirå’ŒworkdiræŒ‚è½½OverlayFSæ–‡ä»¶ç³»ç»Ÿã€‚ æ”»å‡»è€…å°†ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶å¤åˆ¶åˆ°OverlayFSçš„mergeç›®å½•ä¸­ã€‚å…³é”®çš„ä¸€æ­¥æ˜¯ï¼Œæ”»å‡»è€…ä½¿ç”¨`setxattr`ç³»ç»Ÿè°ƒç”¨ï¼Œè®¾ç½®è¯¥å¯æ‰§è¡Œæ–‡ä»¶çš„`security.capability`æ‰©å±•å±æ€§ï¼Œèµ‹äºˆå®ƒ`CAP_SETUID`å’Œ`CAP_SETGID`èƒ½åŠ›ã€‚ ç”±äºOverlayFSçš„æƒé™éªŒè¯ä¸å®Œå–„ï¼Œè¿™ä¸ªæ“ä½œå³ä½¿åœ¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´ä¸­ä¹Ÿèƒ½æˆåŠŸã€‚å½“æ‰§è¡Œè¯¥æ–‡ä»¶æ—¶ï¼Œå®ƒå°†è·å¾—rootæƒé™ï¼Œå¹¶å¯ä»¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚
4.  **POCä»£ç åˆ†æ:** `exploit.c` ä»£ç é¦–å…ˆåˆ›å»ºä¸€ä¸ªoverlayfsç›®å½•ç»“æ„ã€‚ç„¶åï¼Œä½¿ç”¨ `unshare` ç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€ä¸ªæ–°çš„ user namespace å’Œ mount namespaceï¼Œå¹¶å°†å½“å‰ç”¨æˆ·çš„ uid å’Œ gid æ˜ å°„åˆ° root ç”¨æˆ·ã€‚ ä¹‹åï¼Œå®ƒæŒ‚è½½ overlayfsï¼Œå¤åˆ¶å½“å‰æ‰§è¡Œçš„ç¨‹åºåˆ° overlayfs çš„ merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½® capabilityã€‚æœ€åï¼Œæ‰§è¡Œå¤åˆ¶åˆ° overlayfs çš„ç¨‹åºã€‚
5. **æŠ•æ¯’é£é™©åˆ†æ:** ä»£ç æœ¬èº«å®ç°äº†æ¼æ´åˆ©ç”¨çš„åŠŸèƒ½ã€‚ æ½œåœ¨çš„æŠ•æ¯’é£é™©å¯èƒ½å­˜åœ¨äºä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š
    *   **ä¾èµ–é¡¹:**  ä»£ç ä¾èµ–äºæ ‡å‡†çš„Cåº“ï¼Œæœ¬èº«ä¸å­˜åœ¨æ¶æ„ä¾èµ–ã€‚ä½†ç”¨æˆ·åœ¨ç¼–è¯‘æ—¶éœ€è¦æ³¨æ„ç¼–è¯‘å™¨ç¯å¢ƒçš„å®‰å…¨æ€§ã€‚
    *   **ä»£ç é€»è¾‘:**  ä»£ç é€»è¾‘ç›¸å¯¹ç®€å•ï¼Œä¸»è¦é›†ä¸­åœ¨namespaceåˆ›å»ºã€æŒ‚è½½å’Œcapabilityè®¾ç½®ã€‚ ä»”ç»†å®¡æŸ¥ä»£ç ï¼Œæœªå‘ç°æ˜æ˜¾çš„æ¶æ„é€»è¾‘ã€‚
    *   **æ‰§è¡Œå‘½ä»¤:**  ä»£ç ä¸­ä½¿ç”¨äº† `system` å‡½æ•°ï¼Œè¿™æ˜¯ä¸€ä¸ªæ½œåœ¨çš„é£é™©ç‚¹ï¼Œå¯ä»¥æ‰§è¡Œä»»æ„ç³»ç»Ÿå‘½ä»¤ã€‚ä½†æ˜¯ï¼Œè¿™é‡Œåªæ˜¯ç”¨æ¥åˆ é™¤ç›®å½•ï¼Œç›¸å¯¹å®‰å…¨ã€‚
       ç»¼ä¸Šæ‰€è¿°ï¼Œè¯¥POCä»£ç ä¸»è¦é£é™©åœ¨äºç¡®ä¿ç¼–è¯‘ç¯å¢ƒå®‰å…¨ä»¥åŠå¯¹ä¸ç†Ÿæ‚‰çš„å‘½ä»¤ä¿æŒè­¦æƒ•ã€‚æŠ•æ¯’é£é™©è¾ƒä½ï¼Œé¢„ä¼°ä¸º5%ã€‚

**æ€»ç»“ï¼š**

è¯¥æ¼æ´åˆ©ç”¨çš„æ ¸å¿ƒåœ¨äºç»“åˆäº†æœªæˆæƒç”¨æˆ·å‘½åç©ºé—´å’ŒOverlayFSï¼Œåˆ©ç”¨OverlayFSå¯¹capabilitiesè®¾ç½®éªŒè¯çš„ç¼ºé™·ï¼Œå®ç°äº†æœ¬åœ°ææƒã€‚ æ”»å‡»è€…é€šè¿‡åˆ›å»ºç‰¹æ®Šçš„OverlayFSç»“æ„å¹¶è®¾ç½®æ–‡ä»¶capabilitiesï¼Œæœ€ç»ˆè·å¾—rootæƒé™ã€‚

**é¡¹ç›®åœ°å€:** [inspiringz/CVE-2021-3493](https://github.com/inspiringz/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #10

**æ¥æº**: [CVE-2021-3493-oneoy_CVE-2021-3493.md](../2021/CVE-2021-3493-oneoy_CVE-2021-3493.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœ¬åœ°ç”¨æˆ·å¯æå‡è‡³ root æƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu 4.4, 4.15, 5.4, and 5.8 kernels (å…·ä½“ç‰ˆæœ¬å·è§æ¼æ´åº“ä¿¡æ¯)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç›®æ ‡ç³»ç»Ÿå­˜åœ¨æœªä¿®å¤çš„ Ubuntu kernelï¼Œä¸”å¯ç”¨ unprivileged user namespaces å’Œå…è®¸ unprivileged overlayfs mountsã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

è¯¥æ¼æ´å­˜åœ¨äº Ubuntu å†…æ ¸çš„ OverlayFS å®ç°ä¸­ï¼Œç”±äºæœªæ­£ç¡®éªŒè¯ç”¨æˆ·å‘½åç©ºé—´ä¸­åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸Šæ–‡ä»¶ capabilities çš„è®¾ç½®ï¼Œå¯¼è‡´æœ¬åœ°æ”»å‡»è€…å¯åˆ©ç”¨ unprivileged user namespaces å’Œ Ubuntu å†…æ ¸ä¸­å…è®¸ unprivileged overlayfs mounts çš„è¡¥ä¸æ¥æå‡æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ (lower, upper, work, merge)ã€‚
2.  **é…ç½® User Namespace:** åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´ã€‚
3.  **é…ç½® OverlayFS:** ä½¿ç”¨ lowerdir, upperdir, å’Œ workdir é€‰é¡¹æŒ‚è½½ overlay æ–‡ä»¶ç³»ç»Ÿã€‚
4.  **è®¾ç½® Capabilities:** å°†å¯æ‰§è¡Œæ–‡ä»¶å¤åˆ¶åˆ° merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½®å…¶ capabilities (å¦‚ CAP_SETUID, CAP_SETGID, CAP_CHOWN)ã€‚
5.  **è§¦å‘ææƒ:** æ‰§è¡Œ merge ç›®å½•ä¸­çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶å°†ä¼šä»¥ root æƒé™æ‰§è¡Œã€‚

**æŠ•æ¯’é£é™©è¯„ä¼°ï¼š**

æä¾›çš„ `exploit.c` ä»£ç ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨ OverlayFS çš„æ¼æ´è¿›è¡Œææƒã€‚ä»£ç åˆ›å»ºå¿…è¦çš„ç›®å½•ï¼Œé…ç½® user namespace å’Œ overlay æ–‡ä»¶ç³»ç»Ÿï¼Œå¹¶è®¾ç½®å¯æ‰§è¡Œæ–‡ä»¶çš„ capabilitiesã€‚ä»£ç é€»è¾‘æ¸…æ™°ï¼Œæ²¡æœ‰å‘ç°æ¶æ„ä»£ç æˆ–åé—¨ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**

æä¾›çš„ POC ä»£ç åŸºäºå…¬å¼€ä¿¡æ¯ï¼Œå¹¶é’ˆå¯¹ CVE-2021-3493 æ¼æ´è¿›è¡Œäº†åˆ©ç”¨ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯ã€æœç´¢å¼•æ“ç»“æœå’Œä»£ç åˆ†æï¼Œè¯¥ POC ä»£ç åœ¨æ»¡è¶³æ¼æ´åˆ©ç”¨æ¡ä»¶çš„æƒ…å†µä¸‹åº”è¯¥æ˜¯æœ‰æ•ˆçš„ã€‚

**é¡¹ç›®åœ°å€:** [oneoy/CVE-2021-3493](https://github.com/oneoy/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #11

**æ¥æº**: [CVE-2021-3493-pmihsan_OverlayFS-CVE-2021-3493.md](../2021/CVE-2021-3493-pmihsan_OverlayFS-CVE-2021-3493.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœ¬åœ°ç”¨æˆ·å¯æå‡è‡³ root æƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu kernel versions: < 5.8.0-50.56 (5.8 kernel), < 5.4.0-72.80 (5.4 kernel), < 4.15.0-142.146 (4.15 kernel), < 4.4.0-209.241 (4.4 kernel)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦åœ¨å­˜åœ¨æ¼æ´çš„ Ubuntu ç³»ç»Ÿä¸Šæ‰§è¡Œï¼Œå¹¶ä¸”å…è®¸ unprivileged user namespaces å’Œ overlay mountsã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

CVE-2021-3493 æ¼æ´å­˜åœ¨äº Linux å†…æ ¸çš„ overlayfs å®ç°ä¸­ã€‚ç”±äºå¯¹ç”¨æˆ·å‘½åç©ºé—´ä¸­åº•å±‚æ–‡ä»¶ç³»ç»Ÿæ–‡ä»¶ capabilities çš„éªŒè¯ä¸è¶³ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡åˆ›å»ºæ¶æ„çš„ overlayfs æ–‡ä»¶ç³»ç»Ÿï¼Œåˆ©ç”¨ setxattr è®¾ç½®æ–‡ä»¶ capabilitiesï¼Œä»è€Œè·å¾—æå‡çš„æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** åˆ›å»º overlayfs æ‰€éœ€çš„ç›®å½•ç»“æ„ (lower, upper, work, merge)ã€‚
2.  **Namespace åˆ›å»ºï¼š** åˆ›å»ºæ–°çš„ user namespace å’Œ mount namespaceï¼Œéš”ç¦»æƒé™ã€‚
3.  **æƒé™è®¾ç½®ï¼š** ä¿®æ”¹ uid_map å’Œ gid_mapï¼Œä½¿å¾—åœ¨ user namespace ä¸­æ‹¥æœ‰ root æƒé™ã€‚
4.  **Overlayfs Mountï¼š** ä½¿ç”¨ overlayfs mount å‘½ä»¤å°† lowerdir, upperdir, workdir æŒ‚è½½åˆ° mergedirã€‚
5.  **Capabilities è®¾ç½®ï¼š** å¤åˆ¶è‡ªèº«ç¨‹åºåˆ° merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` å‡½æ•°ä¸ºå¤åˆ¶åçš„ç¨‹åºè®¾ç½® capabilities (CAP_SETUID, CAP_SETGID, CAP_DAC_OVERRIDE ç­‰)ã€‚
6.  **æƒé™æå‡ï¼š** æ‰§è¡Œ merge ç›®å½•ä¸‹çš„ç¨‹åºï¼Œæ­¤æ—¶ç¨‹åºå°†ä»¥ root æƒé™è¿è¡Œã€‚

**æœ‰æ•ˆæ€§ï¼š**

æä¾›çš„ POC ä»£ç é€šè¿‡åˆ©ç”¨ overlayfs æ¼æ´ï¼Œå¯ä»¥æˆåŠŸåœ°æå‡æƒé™ã€‚POC ä»£ç é¦–å…ˆåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼Œç„¶ååˆ›å»ºä¸€ä¸ªæ–°çš„ user namespace å’Œ mount namespaceï¼Œæ¥ç€æŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿï¼Œå¹¶ä½¿ç”¨ `setxattr` å‡½æ•°ä¸ºæ–‡ä»¶è®¾ç½® capabilitiesã€‚æœ€åï¼Œæ‰§è¡Œè¯¥æ–‡ä»¶å³å¯è·å¾— root æƒé™ã€‚

**æŠ•æ¯’é£é™©ï¼š**

åˆ†æ POC ä»£ç ï¼Œæ²¡æœ‰å‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç ï¼Œä¾‹å¦‚åå¼¹ shellã€å®‰è£…åé—¨ç­‰ã€‚ä»£ç é€»è¾‘ä¸»è¦é›†ä¸­åœ¨åˆ©ç”¨ overlayfs æ¼æ´ææƒï¼Œå¹¶æ²¡æœ‰é¢å¤–çš„æ“ä½œæ¥æ¤å…¥æ¶æ„ç¨‹åºã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ï¼Œå¯ä»¥è®¤ä¸ºæ˜¯ 0%ã€‚å‚è€ƒçš„ vulnerability description å’Œ exploit ä»£ç éƒ½ç€é‡äºææƒï¼Œè€Œæ²¡æœ‰æåˆ°ä»»ä½•æŠ•æ¯’è¡Œä¸ºã€‚

**é¡¹ç›®åœ°å€:** [pmihsan/OverlayFS-CVE-2021-3493](https://github.com/pmihsan/OverlayFS-CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #12

**æ¥æº**: [CVE-2021-3493-ptkhai15_OverlayFS---CVE-2021-3493.md](../2021/CVE-2021-3493-ptkhai15_OverlayFS---CVE-2021-3493.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Ubuntu Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœ¬åœ°ç”¨æˆ·æå‡æƒé™è‡³ root

**å½±å“ç‰ˆæœ¬:** Ubuntu kernel versions 5.8, 5.4, 4.15, å’Œ 4.4 ä¸­å—å½±å“çš„ç‰ˆæœ¬ï¼ˆå…·ä½“ç‰ˆæœ¬å‚è§æ¼æ´åº“ä¿¡æ¯ï¼‰

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡ç³»ç»Ÿå¿…é¡»æ˜¯å—å½±å“çš„ Ubuntu ç‰ˆæœ¬ï¼Œå¹¶ä¸”å¯ç”¨äº†éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å’Œéç‰¹æƒ overlayfs æŒ‚è½½ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

CVE-2021-3493 æ˜¯ Ubuntu Linux å†…æ ¸ä¸­ OverlayFS å®ç°ä¸­çš„ä¸€ä¸ªæ¼æ´ã€‚è¯¥æ¼æ´å…è®¸éç‰¹æƒç”¨æˆ·åˆ©ç”¨ç”¨æˆ·å‘½åç©ºé—´å’Œéç‰¹æƒ overlayfs æŒ‚è½½ï¼Œé€šè¿‡ä¸æ­£ç¡®åœ°éªŒè¯åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­æ–‡ä»¶çš„ capabilities è®¾ç½®æ¥æå‡æƒé™ã€‚åˆ©ç”¨æ–¹å¼å¦‚ä¸‹ï¼š

1.  **ç¯å¢ƒå‡†å¤‡ï¼š**  åˆ›å»ºä¸€ä¸ªåŸºç¡€ç›®å½•ç»“æ„ï¼ŒåŒ…æ‹¬ workã€lowerã€upper å’Œ merge ç›®å½•ï¼Œè¿™æ˜¯ overlayfs çš„æ ‡å‡†é…ç½®ã€‚
2.  **åˆ›å»ºç”¨æˆ·å‘½åç©ºé—´ï¼š**  ä½¿ç”¨ `unshare` å‘½ä»¤åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´ã€‚è¿™å…è®¸åœ¨æ–°çš„å‘½åç©ºé—´ä¸­æ‹¥æœ‰ä¸åŒçš„ç”¨æˆ·å’Œç»„ IDã€‚
3.  **é…ç½®ç”¨æˆ·å’Œç»„æ˜ å°„ï¼š**  é€šè¿‡ `/proc/self/setgroups`ã€`/proc/self/uid_map` å’Œ `/proc/self/gid_map` æ–‡ä»¶è®¾ç½®ç”¨æˆ·å’Œç»„ ID æ˜ å°„ï¼Œå°†å½“å‰ç”¨æˆ·çš„ UID å’Œ GID æ˜ å°„åˆ°æ–°å‘½åç©ºé—´ä¸­çš„ root ç”¨æˆ·ã€‚
4.  **æŒ‚è½½ OverlayFSï¼š**  ä½¿ç”¨ `mount` å‘½ä»¤æŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿï¼Œå°† lowerã€upper å’Œ work ç›®å½•å…³è”èµ·æ¥ã€‚
5.  **è®¾ç½®æ–‡ä»¶ capabilitiesï¼š**  å¤åˆ¶å½“å‰æ‰§è¡Œç¨‹åºåˆ° overlayfs çš„ merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½®æ–‡ä»¶çš„ capabilities ä¸º `all+ep`ï¼Œå…è®¸è¯¥æ–‡ä»¶æ‰§è¡Œæ—¶æ‹¥æœ‰ root æƒé™ã€‚
6.  **æ‰§è¡Œææƒåçš„ç¨‹åºï¼š**  æ‰§è¡Œä½äº upper ç›®å½•ä¸­çš„å¤åˆ¶åçš„ç¨‹åºã€‚å¦‚æœç¨‹åºæ£€æµ‹åˆ°è‡ªå·±æ˜¯é€šè¿‡ç‰¹å®šæ–¹å¼ï¼ˆä¾‹å¦‚ï¼ŒåŒ…å« "magic" å­—ç¬¦ä¸²æˆ–æ¥å— "shell" å‚æ•°ï¼‰è°ƒç”¨çš„ï¼Œå®ƒä¼šè°ƒç”¨ `setuid(0)` å’Œ `setgid(0)` å°†è¿›ç¨‹çš„ UID å’Œ GID è®¾ç½®ä¸º 0 (root)ï¼Œå¹¶å¯åŠ¨ä¸€ä¸ª root shellã€‚

**å…³äºæŠ•æ¯’é£é™©ï¼š**

åœ¨æä¾›çš„ POC ä»£ç ä¸­ï¼Œæ²¡æœ‰æ˜æ˜¾çš„æŠ•æ¯’ä»£ç ã€‚POC çš„ç›®çš„æ˜¯æ¼”ç¤ºæ¼æ´åˆ©ç”¨è¿‡ç¨‹ï¼Œæ²¡æœ‰å‘ç°æ¶æ„è¡Œä¸ºï¼Œä¾‹å¦‚åå‘ shell æˆ–å…¶ä»–æœªç»æˆæƒçš„è®¿é—®ã€‚


**é¡¹ç›®åœ°å€:** [ptkhai15/OverlayFS---CVE-2021-3493](https://github.com/ptkhai15/OverlayFS---CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #13

**æ¥æº**: [CVE-2021-3493-puckiestyle_CVE-2021-3493.md](../2021/CVE-2021-3493-puckiestyle_CVE-2021-3493.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ”»å‡»è€…å¯åˆ©ç”¨æ­¤æ¼æ´è·å¾— root æƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu 5.8 kernel (< 5.8.0-50.56), 5.4 kernel (< 5.4.0-72.80), 4.15 kernel (< 4.15.0-142.146), 4.4 kernel (< 4.4.0-209.241)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ Ubuntu ç³»ç»Ÿå¼€å¯ unprivileged user namespaces å’Œå…è®¸ unprivileged overlay mounts

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2021-3493 æ˜¯ Ubuntu å†…æ ¸ overlayfs å®ç°ä¸­çš„ä¸€ä¸ªæ¼æ´ï¼Œå…è®¸æœ¬åœ°æ”»å‡»è€…é€šè¿‡æ»¥ç”¨ user namespaces å’Œ overlayfs æŒ‚è½½æœºåˆ¶æå‡æƒé™ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**
æä¾›çš„ POC ä»£ç å°è¯•åˆ©ç”¨è¯¥æ¼æ´ï¼Œé€šè¿‡åˆ›å»º user namespace å’Œ overlayfs æ–‡ä»¶ç³»ç»Ÿæ¥è®¾ç½®å¯æ‰§è¡Œæ–‡ä»¶çš„ capability ä½ï¼Œä½¿å…¶è·å¾— root æƒé™ã€‚ æ¼æ´åº“ä¿¡æ¯,æœç´¢å¼•æ“ç»“æœå’Œæ¼æ´åˆ©ç”¨ä»£ç ä¸€è‡´,è¡¨æ˜è¯¥æ¼æ´çš„POCæ˜¯çœŸå®æœ‰æ•ˆçš„ã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**
æŸ¥çœ‹ `exploit.c` ä»£ç ï¼Œä¸»è¦æ“ä½œåŒ…æ‹¬åˆ›å»ºç›®å½•ã€è®¾ç½® user namespaceã€æŒ‚è½½ overlayfsã€å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶ã€è®¾ç½® capability å±æ€§ï¼Œä»¥åŠæ‰§è¡Œå¤åˆ¶åçš„æ–‡ä»¶ä»¥è·å¾— root æƒé™ã€‚ä»£ç é€»è¾‘è¾ƒä¸ºæ¸…æ™°ï¼Œæœªå‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç ã€‚`README.md` ä¹Ÿè¯´æ˜äº†å¹¶éä½œè€…åŸåˆ›,åªæ˜¯æ¬è¿,å¢åŠ äº†åˆ†æéš¾åº¦.
`exploit.c`ä¸­å­˜åœ¨`system(buf);` è°ƒç”¨ï¼Œè™½ç„¶è¿™é‡Œæ˜¯ç”¨äºæ¸…ç†ç›®å½•ï¼Œä½†å¦‚æœè¢«ç¯¡æ”¹ï¼Œå¯èƒ½æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£é™©è¯„ä¼°ä¸º10%ã€‚ä¸»è¦çš„é£é™©åœ¨äºï¼š

*   `system()` å‡½æ•°æ½œåœ¨çš„å‘½ä»¤æ³¨å…¥é£é™©ï¼Œå¦‚æœä»£ç è¢«ä¿®æ”¹ï¼Œå¯èƒ½å¯¼è‡´æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  åˆ©ç”¨ unshare() åˆ›å»ºä¸€ä¸ªæ–°çš„ user namespace å’Œ mount namespaceã€‚
2.  é…ç½® user namespace çš„ uid_map å’Œ gid_mapï¼Œå°†å½“å‰ç”¨æˆ·æ˜ å°„ä¸º root ç”¨æˆ·ã€‚
3.  åˆ›å»º overlayfs æ‰€éœ€çš„ç›®å½•ç»“æ„ï¼ˆlowerdirã€upperdirã€workdirã€mergedï¼‰ã€‚
4.  æŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿã€‚
5.  å°†æ¼æ´åˆ©ç”¨ç¨‹åºè‡ªèº«å¤åˆ¶åˆ° overlayfs çš„ upperdir/merged ç›®å½•ã€‚
6.  ä½¿ç”¨ setxattr() è®¾ç½®å¤åˆ¶åçš„å¯æ‰§è¡Œæ–‡ä»¶çš„ security.capability å±æ€§ï¼Œèµ‹äºˆå…¶ CAP_SETUID å’Œ CAP_SETGID æƒé™ã€‚
7.  æ‰§è¡Œå¤åˆ¶åçš„ç¨‹åºï¼Œç”±äºè®¾ç½®äº† capabilityï¼Œè¯¥ç¨‹åºä¼šä»¥ root æƒé™è¿è¡Œï¼Œä»è€Œè·å¾— root shellã€‚

**é¡¹ç›®åœ°å€:** [puckiestyle/CVE-2021-3493](https://github.com/puckiestyle/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #14

**æ¥æº**: [CVE-2021-3493-smallkill_CVE-2021-3493.md](../2021/CVE-2021-3493-smallkill_CVE-2021-3493.md)

# CVE-2021-3493

> ğŸ“¦ è¯¥CVEæœ‰ **15** ä¸ªç›¸å…³POCä»“åº“

---

## POC #1

**æ¥æº**: [CVE-2021-3493-Abdennour-py_CVE-2021-3493.md](../2021/CVE-2021-3493-Abdennour-py_CVE-2021-3493.md)

## CVE-2021-3493 Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å¯¼è‡´æ™®é€šç”¨æˆ·æå‡ä¸ºrootæƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu 5.8 kernel < 5.8.0-50.56, 5.4 kernel < 5.4.0-72.80, 4.15 kernel < 4.15.0-142.146, 4.4 kernel < 4.4.0-209.241

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç›®æ ‡ç³»ç»Ÿè¿è¡Œå—å½±å“çš„Ubuntuå†…æ ¸ï¼Œå¹¶ä¸”å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿå’Œä½¿ç”¨user namespace

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

è¯¥æ¼æ´æºäºUbuntuå†…æ ¸ä¸­overlayfså®ç°å¯¹ç”¨æˆ·å‘½åç©ºé—´ä¸­çš„æ–‡ä»¶èƒ½åŠ›éªŒè¯ä¸å½“ã€‚ç»“åˆéç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å’ŒUbuntuå†…æ ¸ä¸­çš„å…è®¸éç‰¹æƒ overlayfs æŒ‚è½½çš„è¡¥ä¸ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´è·å¾—æå‡çš„æƒé™ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**

æä¾›çš„POCä»£ç çœ‹èµ·æ¥æ˜¯æœ‰æ•ˆçš„ã€‚å®ƒåˆ©ç”¨äº† overlayfs å’Œ user namespace çš„ç»„åˆæ¥è®¾ç½®æ–‡ä»¶ capabilityï¼Œä»è€Œå®ç°ææƒã€‚ä»£ç é¦–å…ˆåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼ˆlower, upper, work, mergeï¼‰ï¼Œç„¶åä½¿ç”¨ `unshare` åˆ›å»ºä¸€ä¸ªæ–°çš„ user namespace å’Œ mount namespaceã€‚æ¥ç€ï¼Œå®ƒå†™å…¥ `/proc/self/setgroups`, `/proc/self/uid_map`, å’Œ `/proc/self/gid_map` æ¥è®¾ç½®ç”¨æˆ·å’Œç»„çš„æ˜ å°„ã€‚ç„¶åï¼ŒæŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿï¼Œæ‹·è´è‡ªèº«å¯æ‰§è¡Œæ–‡ä»¶åˆ° overlayfs çš„ merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½® capabilitiesã€‚æœ€åï¼Œå®ƒæ‰§è¡Œä½äº upper ç›®å½•çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶ä¼šå°è¯•ä»¥ root æƒé™æ‰§è¡Œ /bin/bashã€‚

æ ¹æ®æ¼æ´åº“ä¿¡æ¯ï¼ŒCISA å°†æ­¤æ¼æ´æ·»åŠ åˆ°å·²çŸ¥è¢«åˆ©ç”¨çš„æ¼æ´åˆ—è¡¨ä¸­ï¼Œè¿›ä¸€æ­¥è¡¨æ˜äº†è¯¥æ¼æ´çš„æœ‰æ•ˆæ€§ã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

æ£€æŸ¥æä¾›çš„ exploit.c ä»£ç ï¼Œæ²¡æœ‰å‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç æˆ–åé—¨ã€‚ä»£ç é€»è¾‘æ¸…æ™°ï¼Œä¸»è¦æ‰§è¡Œäº† overlayfs çš„æŒ‚è½½ï¼Œæ–‡ä»¶å¤åˆ¶ï¼Œè®¾ç½® xattr å’Œæ‰§è¡Œ shell æ“ä½œã€‚ä»£ç çš„æ„å›¾ä¸æ¼æ´æè¿°ä¸€è‡´ï¼Œæ²¡æœ‰å‘ç°éšè—çš„ã€ä¸æ¼æ´åˆ©ç”¨æ— å…³çš„æ¶æ„è¡Œä¸ºã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£é™©ä¸º 0%ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š**  åœ¨å­˜åœ¨æ¼æ´çš„Ubuntuç³»ç»Ÿä¸Šï¼Œåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ (ovlcap/work, ovlcap/lower, ovlcap/upper, ovlcap/merge)ã€‚
2.  **User Namespaceå’ŒMount Namespaceï¼š** ä½¿ç”¨ `unshare` ç³»ç»Ÿè°ƒç”¨åˆ›å»ºæ–°çš„ user namespace å’Œ mount namespaceã€‚
3.  **IDæ˜ å°„ï¼š**  é…ç½® `/proc/self/setgroups`ï¼Œ`/proc/self/uid_map` å’Œ `/proc/self/gid_map`ï¼Œä»¥ä¾¿åœ¨ user namespace ä¸­è·å¾—æœ‰æ•ˆçš„ç”¨æˆ· ID å’Œç»„ IDã€‚
4.  **OverlayFSæŒ‚è½½ï¼š**  ä½¿ç”¨ `mount` ç³»ç»Ÿè°ƒç”¨æŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿï¼Œå°† lower, upper å’Œ work ç›®å½•å…³è”èµ·æ¥ã€‚
5.  **æ–‡ä»¶æ‹·è´ä¸ Capability è®¾ç½®ï¼š**  å°† exploit ç¨‹åºè‡ªèº«æ‹·è´åˆ° overlayfs çš„ merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½® `security.capability` å±æ€§ï¼Œèµ‹äºˆå…¶ CAP_SETUID å’Œ CAP_SETGID ç­‰æƒé™ã€‚
6.  **ææƒæ‰§è¡Œï¼š** æ‰§è¡Œä½äº upper ç›®å½•çš„ exploit ç¨‹åºçš„æ‹·è´ã€‚ç”±äºè¯¥æ–‡ä»¶å…·æœ‰ capabilitiesï¼Œå› æ­¤å¯ä»¥ä»¥ root æƒé™æ‰§è¡Œ shellã€‚

**é¡¹ç›®åœ°å€:** [Abdennour-py/CVE-2021-3493](https://github.com/Abdennour-py/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #2

**æ¥æº**: [CVE-2021-3493-Sornphut_OverlayFS---CVE-2021-3493.md](../2021/CVE-2021-3493-Sornphut_OverlayFS---CVE-2021-3493.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒæ¼æ´

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Ubuntu Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœ¬åœ°ç”¨æˆ·è·å¾— root æƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu kernels before 5.8.0-50.56, 5.4.0-72.80, 4.15.0-142.146, and 4.4.0-209.241

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦è¿è¡Œåœ¨å­˜åœ¨æ¼æ´çš„ Ubuntu å†…æ ¸ä¸Šï¼Œå¹¶ä¸”å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½ overlayfsã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

è¯¥æ¼æ´å­˜åœ¨äº Ubuntu Linux å†…æ ¸çš„ overlayfs å®ç°ä¸­ã€‚ç”±äº Ubuntu å¯¹ overlayfs æŒ‚è½½çš„ç‰¹å®šä¿®æ”¹ï¼Œå¯¼è‡´åœ¨ç”¨æˆ·å‘½åç©ºé—´å†…ï¼Œå¯¹åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­çš„æ–‡ä»¶ capabilities éªŒè¯ä¸å……åˆ†ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡ overlayfs æŒ‚è½½ç»•è¿‡ capabilities æ£€æŸ¥ï¼Œè®¾ç½®æ–‡ä»¶ capabilities æå‡æƒé™ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  åˆ›å»ºä¸€ä¸ªç›®å½•ç»“æ„ï¼ŒåŒ…æ‹¬ lower, upper, work å’Œ merge ç›®å½•ã€‚
2.  ä½¿ç”¨ `unshare` åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´å’ŒæŒ‚è½½å‘½åç©ºé—´ã€‚
3.  é…ç½® `/proc/self/setgroups`, `/proc/self/uid_map`, å’Œ `/proc/self/gid_map` ä»¥æ˜ å°„ç”¨æˆ· ID å’Œç»„ IDã€‚
4.  ä½¿ç”¨ `mount` å‘½ä»¤æŒ‚è½½ overlayfsï¼Œå°† lower, upper å’Œ work ç›®å½•ä¸ merge ç›®å½•å…³è”èµ·æ¥ã€‚
5.  åœ¨ upper ç›®å½•æˆ– merge ç›®å½•ä¸‹åˆ›å»ºæˆ–å¤åˆ¶ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ã€‚
6.  ä½¿ç”¨ `setxattr` è®¾ç½®å¯æ‰§è¡Œæ–‡ä»¶çš„ capabilitiesï¼Œèµ‹äºˆå…¶ root æƒé™ã€‚
7.  æ‰§è¡Œè¯¥æ–‡ä»¶ï¼Œå³å¯è·å¾— root æƒé™ã€‚

**æœ‰æ•ˆæ€§ï¼š**

æä¾›çš„ POC ä»£ç å°è¯•åˆ©ç”¨ CVE-2021-3493 æ¼æ´ã€‚è¯¥ä»£ç åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´å’ŒæŒ‚è½½å‘½åç©ºé—´ï¼Œå¹¶å°è¯•æŒ‚è½½ overlayfsã€‚ç„¶åï¼Œå®ƒåº”è¯¥è®¾ç½® `magic` äºŒè¿›åˆ¶æ–‡ä»¶çš„ capabilitiesï¼Œä»è€Œè·å¾— root æƒé™ã€‚æ ¹æ®æ¼æ´æè¿°ï¼Œè¯¥ POC åº”è¯¥èƒ½å¤Ÿæœ‰æ•ˆåˆ©ç”¨è¯¥æ¼æ´ã€‚

**æŠ•æ¯’é£é™©ï¼š**

æ£€æŸ¥æä¾›çš„ exploit.c æ–‡ä»¶ï¼Œæœªå‘ç°æ˜æ˜¾çš„æ¶æ„æˆ–éšè—ä»£ç ã€‚ä»£ç é€»è¾‘ä¸»è¦é›†ä¸­äºè®¾ç½® overlayfs æŒ‚è½½å’Œæ–‡ä»¶ capabilitiesã€‚ä½†æ˜¯ï¼Œéœ€è¦å§‹ç»ˆè°¨æ…å¯¹å¾…æ¥è‡ªä¸å—ä¿¡ä»»æ¥æºçš„ä»£ç ã€‚ä¸ºäº†ç¡®ä¿å®‰å…¨ï¼Œå»ºè®®åœ¨å—æ§ç¯å¢ƒä¸­ä»”ç»†å®¡æŸ¥å’Œæµ‹è¯•ä»£ç ã€‚


**é¡¹ç›®åœ°å€:** [Sornphut/OverlayFS---CVE-2021-3493](https://github.com/Sornphut/OverlayFS---CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #3

**æ¥æº**: [CVE-2021-3493-briskets_CVE-2021-3493.md](../2021/CVE-2021-3493-briskets_CVE-2021-3493.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å¯¼è‡´æ™®é€šç”¨æˆ·æƒé™æå‡è‡³rootæƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu kernel versions: < 5.8.0-50.56 (5.8 kernel), < 5.4.0-72.80 (5.4 kernel), < 4.15.0-142.146 (4.15 kernel), < 4.4.0-209.241 (4.4 kernel)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦åœ¨å­˜åœ¨æ¼æ´çš„Ubuntuå†…æ ¸ç‰ˆæœ¬ä¸Šï¼Œå¹¶ä¸”å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½overlayfs

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 5%

## è¯¦æƒ…

CVE-2021-3493 æ¼æ´æ˜¯ç”±äº Linux å†…æ ¸çš„ overlayfs å®ç°æ²¡æœ‰æ­£ç¡®éªŒè¯ç”¨æˆ·å‘½åç©ºé—´ä¸­åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸Šæ–‡ä»¶ capabilities çš„è®¾ç½®ã€‚ç”±äº Ubuntu å†…æ ¸ä¸­å­˜åœ¨å…è®¸éç‰¹æƒ overlay æŒ‚è½½çš„è¡¥ä¸ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´è·å¾—æå‡çš„æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  æ¼æ´åˆ©ç”¨ä»£ç é¦–å…ˆåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ (ovlcap/work, ovlcap/lower, ovlcap/upper, ovlcap/merge)ã€‚
2.  åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´å’ŒæŒ‚è½½å‘½åç©ºé—´ã€‚
3.  åœ¨æ–°çš„ç”¨æˆ·å‘½åç©ºé—´ä¸­ï¼Œå°†å½“å‰ç”¨æˆ·çš„ UID å’Œ GID æ˜ å°„åˆ° root ç”¨æˆ·ã€‚
4.  ä½¿ç”¨ overlayfs å°† lowerdir (ovlcap/lower), upperdir (ovlcap/upper) å’Œ workdir (ovlcap/work) æŒ‚è½½åˆ° mergedir (ovlcap/merge)ã€‚
5.  å¤åˆ¶è‡ªèº« (exploit ç¨‹åº) åˆ° mergedir/magicï¼Œå¹¶è®¾ç½® security.capability æ‰©å±•å±æ€§ä¸º all+epï¼Œèµ‹äºˆè¯¥æ–‡ä»¶ capabilitiesã€‚
6.  æ‰§è¡Œ mergedir/magicï¼Œç”±äº capabilities çš„è®¾ç½®ï¼Œè¯¥ç¨‹åºä¼šä»¥ root æƒé™æ‰§è¡Œã€‚
7.  æœ€åï¼Œæ‰§è¡Œ upperdir/magicï¼Œå¯åŠ¨ä¸€ä¸ª root shellã€‚

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„POCä»£ç æ˜¯æœ‰æ•ˆçš„ï¼Œèƒ½å¤Ÿåˆ©ç”¨ CVE-2021-3493 æ¼æ´åœ¨å—å½±å“çš„ Ubuntu ç³»ç»Ÿä¸Šå®ç°æœ¬åœ°ææƒã€‚

**æŠ•æ¯’é£é™©ï¼š**
è¯¥POCä»£ç çš„ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´è¿›è¡Œææƒï¼Œä½†ä»ç„¶å­˜åœ¨æ½œåœ¨çš„æŠ•æ¯’é£é™©ã€‚æ¯”å¦‚ä½œè€…å¯èƒ½åœ¨ç¼–è¯‘å’Œè¿è¡Œå‰æ·»åŠ ä¸€äº›æ¶æ„ä»£ç ï¼Œä¾‹å¦‚ï¼š

1.  **åé—¨æ¤å…¥ï¼š** åœ¨ææƒæˆåŠŸåï¼Œæ¤å…¥ä¸€ä¸ªåé—¨ç¨‹åºï¼Œå…è®¸æ”»å‡»è€…è¿œç¨‹è®¿é—®ç³»ç»Ÿã€‚
2.  **æ•°æ®çªƒå–ï¼š** åœ¨ææƒè¿‡ç¨‹ä¸­ï¼Œçªƒå–ç”¨æˆ·çš„æ•æ„Ÿæ•°æ®ã€‚
3.  **ç ´åç³»ç»Ÿï¼š** åœ¨ææƒå¤±è´¥æˆ–è€…æˆåŠŸåï¼Œç ´åç³»ç»Ÿæ–‡ä»¶æˆ–è€…é…ç½®ã€‚

è€ƒè™‘åˆ°ä»£ç ç›¸å¯¹ç®€çŸ­ä¸”åŠŸèƒ½æ˜ç¡®ï¼Œè¯„ä¼°æŠ•æ¯’é£é™©ä¸º5%ã€‚ç”¨æˆ·éœ€è¦ä»”ç»†å®¡æŸ¥ä»£ç ï¼Œå¹¶åœ¨å®‰å…¨çš„ç¯å¢ƒä¸­è¿›è¡Œæµ‹è¯•ã€‚

**é¡¹ç›®åœ°å€:** [briskets/CVE-2021-3493](https://github.com/briskets/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #4

**æ¥æº**: [CVE-2021-3493-cyberx-1_OverlayFS-CVE-2021-3493.md](../2021/CVE-2021-3493-cyberx-1_OverlayFS-CVE-2021-3493.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯ä»æ™®é€šç”¨æˆ·ææƒè‡³root

**å½±å“ç‰ˆæœ¬:** Ubuntu kernels: 5.8.0-50.56 (5.8 kernel), 5.4.0-72.80 (5.4 kernel), 4.15.0-142.146 (4.15 kernel), 4.4.0-209.241 (4.4 kernel)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦è¿è¡Œåœ¨å­˜åœ¨æ¼æ´çš„Ubuntuå†…æ ¸ç‰ˆæœ¬ä¸Šï¼Œå¯ç”¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å’Œå…è®¸éç‰¹æƒ overlay mountsã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2021-3493æ˜¯Ubuntuå†…æ ¸OverlayFSå®ç°ä¸­çš„ä¸€ä¸ªæƒé™æå‡æ¼æ´ã€‚ç”±äºoverlayfsåœ¨ç”¨æˆ·å‘½åç©ºé—´ä¸­æ²¡æœ‰æ­£ç¡®éªŒè¯åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­æ–‡ä»¶åŠŸèƒ½è®¾ç½®ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å’ŒUbuntuå†…æ ¸ä¸­çš„éç‰¹æƒoverlayæŒ‚è½½è¡¥ä¸ï¼Œè·å–æå‡çš„æƒé™ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** åœ¨å­˜åœ¨æ¼æ´çš„Ubuntuå†…æ ¸ä¸Šï¼Œç¡®ä¿å¯ç”¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´ã€‚æ¼æ´åº“ä¿¡æ¯æåˆ°ç¦ç”¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å¯ä»¥ä½œä¸ºç¼“è§£æªæ–½ï¼Œæ‰€ä»¥è¦ç¡®ä¿å¯ç”¨ã€‚
2.  **åˆ›å»ºOverlayFSç»“æ„ï¼š** PoCä»£ç é¦–å…ˆåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼ˆlower, upper, work, mergeï¼‰ç”¨äº overlayfs æ–‡ä»¶ç³»ç»Ÿã€‚
3.  **åˆ›å»ºç”¨æˆ·å‘½åç©ºé—´ï¼š** ä½¿ç”¨`unshare`ç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´ã€‚è¿™å…è®¸åœ¨æ–°çš„å‘½åç©ºé—´ä¸­æ‹¥æœ‰ä¸åŒçš„ç”¨æˆ·IDå’Œç»„IDæ˜ å°„ã€‚
4.  **è®¾ç½®UID/GIDæ˜ å°„ï¼š** å°†å½“å‰ç”¨æˆ·çš„UIDå’ŒGIDæ˜ å°„åˆ°æ–°å‘½åç©ºé—´ä¸­çš„rootç”¨æˆ· (UID 0 å’Œ GID 0)ã€‚
5.  **æŒ‚è½½OverlayFSï¼š** ä½¿ç”¨`mount`ç³»ç»Ÿè°ƒç”¨å°† overlayfs æ–‡ä»¶ç³»ç»ŸæŒ‚è½½åˆ° merge ç›®å½•ã€‚æŒ‡å®š lowerdir, upperdir å’Œ workdirã€‚
6.  **å¤åˆ¶è‡ªèº«å¹¶è®¾ç½®Capabilitiesï¼š** å°†è‡ªèº«å¯æ‰§è¡Œæ–‡ä»¶å¤åˆ¶åˆ° overlayfs çš„ merge ç›®å½•ï¼Œç„¶åä½¿ç”¨`setxattr`è®¾ç½®`security.capability`æ‰©å±•å±æ€§ï¼Œèµ‹äºˆè¯¥æ–‡ä»¶ root æƒé™ã€‚
7.  **æ‰§è¡Œææƒåçš„ç¨‹åºï¼š** é€šè¿‡æ‰§è¡Œ upper ç›®å½•ä¸‹çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆä¹‹å‰å¤åˆ¶å¹¶è®¾ç½®äº† capabilities çš„æ–‡ä»¶ï¼‰æ¥è·å– root æƒé™ã€‚è¿™ä¸ªç¨‹åºä¼šæ£€æŸ¥æ˜¯å¦æœ‰"shell"å‚æ•°ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™ä¼šé‡æ–°æ‰§è¡Œè‡ªèº«ï¼Œä½†è¿™æ¬¡ä¼šå¸¦æœ‰`shell`å‚æ•°ï¼Œä»è€Œè§¦å‘`setuid(0)`å’Œ`setgid(0)`ï¼Œæœ€ç»ˆæ‰§è¡Œ`/bin/bash`ï¼Œè·å¾— root shellã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

ä»£ç ä¸­å­˜åœ¨ä¸€å®šçš„æŠ•æ¯’é£é™©ï¼Œè™½ç„¶ä¸»è¦é€»è¾‘æ˜¯åˆ©ç”¨æ¼æ´è¿›è¡Œææƒï¼Œä½†å­˜åœ¨ä¿®æ”¹`/bin/bash`çš„å¯èƒ½æ€§ï¼Œä½†æ˜¯ç»è¿‡ä»£ç åˆ†æä»¥åŠæ¼æ´åŸç†ï¼Œåˆ¤æ–­æ¼æ´åˆ©ç”¨è¿‡ç¨‹ä¸­æ²¡æœ‰ä¿®æ”¹`/bin/bash`æ“ä½œ,ä»£ç ä¸­é£é™©ä¸»è¦å­˜åœ¨äºä»¥ä¸‹å‡ ç‚¹:

1.  **ä¾èµ–å¤–éƒ¨äºŒè¿›åˆ¶æ–‡ä»¶ï¼š** è¯¥æ¼æ´åˆ©ç”¨ä¾èµ–äºç³»ç»Ÿä¸Šçš„`/bin/bash`ã€‚å¦‚æœæ”»å‡»è€…æ›¿æ¢æˆ–ç¯¡æ”¹äº†ç›®æ ‡ç³»ç»Ÿä¸Šçš„`/bin/bash`ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ„å¤–çš„è¡Œä¸ºæˆ–å®‰å…¨é—®é¢˜ã€‚
2.  **æ¸…ç†æ“ä½œé£é™©ï¼š** ä»£ç å¼€å§‹æ—¶ä½¿ç”¨`system(buf)`æ‰§è¡Œ`rm -rf '%s/'`ï¼Œå¦‚æœ`DIR_BASE`è¢«æ¶æ„ä¿®æ”¹ï¼Œå¯èƒ½å¯¼è‡´æ„å¤–çš„æ–‡ä»¶åˆ é™¤ã€‚
3.  **ä¸å®Œå–„çš„é”™è¯¯å¤„ç†ï¼š** è™½ç„¶ PoC ä»£ç åŒ…å«äº†ä¸€äº›é”™è¯¯å¤„ç†ï¼Œä½†åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå¦‚æœé”™è¯¯å¤„ç†ä¸å½“ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ‹’ç»æœåŠ¡æˆ–æœªå®šä¹‰çš„è¡Œä¸ºã€‚

æ€»ä½“è€Œè¨€ï¼Œè¯¥ PoC ä»£ç çš„æŠ•æ¯’é£é™©è¾ƒä½ï¼Œä¸»è¦é£é™©åœ¨äºä¾èµ–å¤–éƒ¨äºŒè¿›åˆ¶æ–‡ä»¶å’Œæ½œåœ¨çš„æ¸…ç†æ“ä½œé£é™©ã€‚ä»£ç æœ¬èº«ä¸»è¦æ˜¯ä¸ºäº†æ¼”ç¤ºæ¼æ´åˆ©ç”¨ï¼Œå¹¶æœªå‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç ã€‚ è¯„ä¼°æŠ•æ¯’é£é™©ä¸º10%ã€‚


**é¡¹ç›®åœ°å€:** [cyberx-1/OverlayFS-CVE-2021-3493](https://github.com/cyberx-1/OverlayFS-CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #5

**æ¥æº**: [CVE-2021-3493-derek-turing_CVE-2021-3493.md](../2021/CVE-2021-3493-derek-turing_CVE-2021-3493.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Ubuntu Linux Kernel

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœ¬åœ°ç”¨æˆ·å¯æå‡è‡³ root æƒé™

**å½±å“ç‰ˆæœ¬:** 4.4 <= kernel < 4.4.0-209.241, 4.15 <= kernel < 4.15.0-142.146, 5.4 <= kernel < 5.4.0-72.80, 5.8 <= kernel < 5.8.0-50.56

**åˆ©ç”¨æ¡ä»¶:** Ubuntu å†…æ ¸å¼€å¯äº† unprivileged user namespaces å’Œ unprivileged overlay mounts

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

è¯¥æ¼æ´å­˜åœ¨äº Ubuntu Linux å†…æ ¸çš„ OverlayFS å®ç°ä¸­ï¼Œç”±äº overlayfs å¯¹åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­æ–‡ä»¶ capabilities çš„è®¾ç½®éªŒè¯ä¸å½“ï¼Œç»“åˆæœªæˆæƒç”¨æˆ·å‘½åç©ºé—´å’Œ Ubuntu å†…æ ¸ä¸­å…è®¸æœªæˆæƒ overlay æŒ‚è½½çš„è¡¥ä¸ï¼Œæ”»å‡»è€…å¯åˆ©ç”¨æ­¤æ¼æ´æå‡æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** é¦–å…ˆï¼Œç¡®ä¿ç›®æ ‡ç³»ç»Ÿæ»¡è¶³æ¼æ´åˆ©ç”¨çš„æ¡ä»¶ï¼Œå³ Ubuntu å†…æ ¸ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…ï¼Œå¹¶ä¸”å¯ç”¨äº† unprivileged user namespaces å’Œ unprivileged overlay mountsã€‚æ¼æ´åº“ä¿¡æ¯ä¸­ç»™å‡ºäº†å—å½±å“çš„ç‰ˆæœ¬èŒƒå›´ã€‚
2.  **åˆ›å»ºç›®å½•ç»“æ„ï¼š** åˆ›å»º overlayfs æ‰€éœ€çš„ç›®å½•ç»“æ„ï¼ŒåŒ…æ‹¬ lowerdirï¼ˆåº•å±‚ç›®å½•ï¼‰ã€upperdirï¼ˆä¸Šå±‚ç›®å½•ï¼‰ã€workdirï¼ˆå·¥ä½œç›®å½•ï¼‰å’Œ mergedirï¼ˆåˆå¹¶ç›®å½•ï¼‰ã€‚
3.  **åˆ›å»ºç”¨æˆ·å‘½åç©ºé—´ï¼š** ä½¿ç”¨ `unshare` å‘½ä»¤åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´ï¼Œè¿™å…è®¸åœ¨éç‰¹æƒç”¨æˆ·ä¸‹æ‰§è¡Œä¸€äº›ç‰¹æƒæ“ä½œã€‚
4.  **è®¾ç½® UID/GID æ˜ å°„ï¼š** åœ¨ç”¨æˆ·å‘½åç©ºé—´ä¸­ï¼Œå°†å½“å‰ç”¨æˆ·çš„ UID å’Œ GID æ˜ å°„åˆ° root ç”¨æˆ· (UID 0) å’Œ root ç»„ (GID 0)ï¼Œè¿™æ ·åœ¨ overlayfs ä¸­åˆ›å»ºçš„æ–‡ä»¶å°†å±äº root ç”¨æˆ·ã€‚
5.  **æŒ‚è½½ OverlayFSï¼š** ä½¿ç”¨ `mount` å‘½ä»¤å°† overlayfs æŒ‚è½½åˆ° mergedirï¼ŒæŒ‡å®š lowerdirã€upperdir å’Œ workdirã€‚
6.  **å¤åˆ¶å¹¶è®¾ç½® Capabilitiesï¼š** å°† exploit ç¨‹åºè‡ªèº«å¤åˆ¶åˆ° mergedir ä¸­ï¼Œå¹¶ä½¿ç”¨ `setxattr` å‘½ä»¤è®¾ç½®å…¶ security.capability æ‰©å±•å±æ€§ï¼Œèµ‹äºˆå…¶ CAP_SETUID å’Œ CAP_SETGID capabilitiesã€‚è¿™ä¸ªcapabilitieså…è®¸ç¨‹åºåœ¨æ²¡æœ‰rootæƒé™çš„æƒ…å†µä¸‹è®¾ç½®uidå’Œgidã€‚
7.  **è§¦å‘ææƒï¼š** è¿è¡Œ mergedir ä¸­çš„ exploit ç¨‹åºï¼Œç”±äºå·²è®¾ç½® capabilitiesï¼Œç¨‹åºå°†ä»¥ root æƒé™è¿è¡Œï¼Œä»è€Œæ‰§è¡Œç‰¹æƒæ“ä½œã€‚

**ä»£ç åˆ†æï¼š**

*   `exploit.c` æ˜¯åˆ©ç”¨ä»£ç ï¼Œå®ƒåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼Œå»ºç«‹ç”¨æˆ·å‘½åç©ºé—´ï¼ŒæŒ‚è½½ overlayfsï¼Œç„¶åå°†è‡ªèº«å¤åˆ¶åˆ° overlayfs ä¸­ï¼Œå¹¶è®¾ç½® capabilitiesã€‚æœ€åï¼Œæ‰§è¡Œå¤åˆ¶åˆ° upperdir ä¸­çš„ç¨‹åºï¼Œè¯¥ç¨‹åºä¼šå°†å½“å‰è¿›ç¨‹ææƒä¸º rootã€‚
*   ä»£ç ä¸­ä½¿ç”¨äº† `setxattr` å‡½æ•°æ¥è®¾ç½®æ–‡ä»¶ capabilitiesï¼Œè¿™æ˜¯åˆ©ç”¨æ¼æ´çš„å…³é”®æ­¥éª¤ã€‚
*   mainå‡½æ•°é¦–å…ˆforkä¸€ä¸ªå­è¿›ç¨‹æ‰§è¡Œexploitå‡½æ•°ï¼Œåœ¨exploitå‡½æ•°æ‰§è¡Œå®Œæ¯•åï¼Œçˆ¶è¿›ç¨‹æ‰§è¡ŒBIN_UPPERä¸­çš„magicç¨‹åºï¼Œå¦‚æœå¸¦æœ‰shellå‚æ•°ï¼Œmagicç¨‹åºä¼šè®¾ç½®uidå’Œgidä¸º0ï¼Œå¹¶ä¸”è¿è¡Œä¸€ä¸ªbash shellã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

ä»”ç»†æ£€æŸ¥äº† POC ä»£ç ï¼Œæ²¡æœ‰å‘ç°æ˜æ˜¾çš„æŠ•æ¯’ä»£ç ã€‚ä»£ç é€»è¾‘æ¸…æ™°ï¼Œä¸»è¦ç”¨äºåˆ›å»º overlayfs ç¯å¢ƒå¹¶è®¾ç½®æ–‡ä»¶ capabilities ä»¥è¿›è¡Œææƒã€‚ä½œè€…å¹¶æ²¡æœ‰å°è¯•åœ¨ä»£ç ä¸­éšè—æ¶æ„è¡Œä¸ºï¼Œä¾‹å¦‚ï¼š

*   è¿æ¥å¤–éƒ¨æœåŠ¡å™¨
*   ä¿®æ”¹ç³»ç»Ÿæ–‡ä»¶
*   å®‰è£…åé—¨
*   æ”¶é›†ç”¨æˆ·ä¿¡æ¯

å› æ­¤ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ (0%)ã€‚

**é¡¹ç›®åœ°å€:** [derek-turing/CVE-2021-3493](https://github.com/derek-turing/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #6

**æ¥æº**: [CVE-2021-3493-fathallah17_OverlayFS-CVE-2021-3493.md](../2021/CVE-2021-3493-fathallah17_OverlayFS-CVE-2021-3493.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°æƒé™æå‡

**å½±å“åº”ç”¨:** Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å¯¼è‡´æœ¬åœ°æƒé™æå‡è‡³root

**å½±å“ç‰ˆæœ¬:** 4.4 <= Linux Kernel < 5.8.0-50.56 (Ubuntu ç‰¹å®šç‰ˆæœ¬)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦å­˜åœ¨Ubuntuå†…æ ¸ä¸­å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½OverlayFSçš„è¡¥ä¸ï¼Œä¸”ç”¨æˆ·å‘½åç©ºé—´æœªè¢«ç¦ç”¨ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 1%

## è¯¦æƒ…

CVE-2021-3493 æ˜¯ä¸€ä¸ªå­˜åœ¨äº Linux å†…æ ¸ OverlayFS å®ç°ä¸­çš„æƒé™æå‡æ¼æ´ã€‚æ¼æ´çš„æ ¹æœ¬åŸå› æ˜¯ OverlayFS åœ¨è®¾ç½®åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­æ–‡ä»¶çš„ capabilities æ—¶ï¼Œæ²¡æœ‰æ­£ç¡®åœ°éªŒè¯ç”¨æˆ·å‘½åç©ºé—´ã€‚åœ¨å­˜åœ¨å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½ OverlayFS çš„ Ubuntu å†…æ ¸è¡¥ä¸çš„ç¯å¢ƒä¸­ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´è·å¾—æå‡çš„æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š**  ç›®æ ‡ç³»ç»Ÿéœ€è¦æ˜¯å—å½±å“çš„ Ubuntu ç‰ˆæœ¬ï¼Œå¹¶ä¸”å…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½ OverlayFSï¼ŒåŒæ—¶ç”¨æˆ·å‘½åç©ºé—´æ²¡æœ‰è¢«ç¦ç”¨ã€‚
2.  **è·å–æ¼æ´åˆ©ç”¨ä»£ç ï¼š**  ä»å¯ä¿¡æ¥æºè·å–æ¼æ´åˆ©ç”¨ä»£ç  (ä¾‹å¦‚ SSD-Disclosure æä¾›çš„ exploit.c)ã€‚
3.  **ç¼–è¯‘æ¼æ´åˆ©ç”¨ä»£ç ï¼š**  ä½¿ç”¨ gcc ç­‰ç¼–è¯‘å™¨å°† exploit.c ç¼–è¯‘ä¸ºå¯æ‰§è¡Œæ–‡ä»¶ã€‚
4.  **æ‰§è¡Œæ¼æ´åˆ©ç”¨ä»£ç ï¼š**  è¿è¡Œç¼–è¯‘åçš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚æ¼æ´åˆ©ç”¨ä»£ç ä¼šåˆ©ç”¨ OverlayFS çš„æ¼æ´ï¼Œé€šè¿‡è®¾ç½®æ–‡ä»¶ capabilities æ¥æå‡å½“å‰ç”¨æˆ·çš„æƒé™è‡³ rootã€‚
5.  **è·å– root æƒé™ï¼š**  æˆåŠŸæ‰§è¡Œæ¼æ´åˆ©ç”¨ä»£ç åï¼Œç”¨æˆ·å°†è·å¾— root æƒé™ã€‚

**å…³äºæŠ•æ¯’é£é™©ï¼š**

æä¾›çš„POCä»£ç åªæ˜¯ä¸€ä¸ªç®€å•çš„åˆ©ç”¨æ–¹å¼,ä¸å¤ªå¯èƒ½åŒ…å«æ¶æ„ä»£ç ã€‚ä½†å§‹ç»ˆéœ€è¦å¯¹ä»»ä½•æ¥æºçš„æ¼æ´åˆ©ç”¨ä»£ç è¿›è¡Œå®¡æŸ¥ï¼Œä»¥é™ä½é£é™©ã€‚
å¯¹ä¸‹è½½çš„æ–‡ä»¶è¿›è¡Œæ£€æŸ¥ï¼Œå¦‚å“ˆå¸Œæ ¡éªŒï¼Œå¯ä»¥æœ€å¤§ç¨‹åº¦çš„é¿å…å¼•å…¥æ¶æ„ä»£ç ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**

æ ¹æ®æ¼æ´æè¿°å’Œåˆ©ç”¨ä»£ç ï¼Œè¯¥æ¼æ´åˆ©ç”¨æ˜¯æœ‰æ•ˆçš„ã€‚åˆ©ç”¨ä»£ç é€šè¿‡OverlayFSçš„æ¼æ´ï¼Œå…è®¸ä½æƒé™ç”¨æˆ·è·å¾—rootæƒé™ã€‚

**å…¶ä»–ä¿¡æ¯:**
CISA å·²å°†æ­¤æ¼æ´æ·»åŠ åˆ°å·²çŸ¥è¢«åˆ©ç”¨çš„æ¼æ´ç›®å½• (KEV) ä¸­ï¼Œè¡¨æ˜è¯¥æ¼æ´å·²è¢«å¹¿æ³›åˆ©ç”¨ã€‚

**é¡¹ç›®åœ°å€:** [fathallah17/OverlayFS-CVE-2021-3493](https://github.com/fathallah17/OverlayFS-CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #7

**æ¥æº**: [CVE-2021-3493-fei9747_CVE-2021-3493.md](../2021/CVE-2021-3493-fei9747_CVE-2021-3493.md)

## CVE-2021-3493 Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ”»å‡»è€…å¯åˆ©ç”¨æ­¤æ¼æ´è·å– root æƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu kernel versions: < 5.8.0-50.56, < 5.4.0-72.80, < 4.15.0-142.146, < 4.4.0-209.241

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦åœ¨å­˜åœ¨æ¼æ´çš„ Ubuntu ç³»ç»Ÿä¸Šæœ¬åœ°æ‰§è¡Œ

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 5%

## è¯¦æƒ…

CVE-2021-3493 æ˜¯ä¸€ä¸ªå­˜åœ¨äº Ubuntu Linux å†…æ ¸ overlayfs å®ç°ä¸­çš„æœ¬åœ°ææƒæ¼æ´ã€‚è¯¥æ¼æ´æºäº overlayfs æœªèƒ½æ­£ç¡®éªŒè¯ç”¨æˆ·å‘½åç©ºé—´ä¸­åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸Šæ–‡ä»¶ capabilities çš„è®¾ç½®ã€‚ç»“åˆæœªæˆæƒç”¨æˆ·å‘½åç©ºé—´ä»¥åŠ Ubuntu å†…æ ¸ä¸­å…è®¸æœªæˆæƒ overlay mount çš„è¡¥ä¸ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´æå‡æƒé™ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼ŒåŒ…æ‹¬lowerdirï¼Œupperdirï¼Œworkdirå’Œmergedirã€‚
2.  **åˆ›å»ºå‘½åç©ºé—´ï¼š** ä½¿ç”¨ `unshare` ç³»ç»Ÿè°ƒç”¨åˆ›å»ºæ–°çš„ç”¨æˆ·å‘½åç©ºé—´å’ŒæŒ‚è½½å‘½åç©ºé—´ã€‚
3.  **è®¾ç½®ç”¨æˆ·å’Œç»„IDæ˜ å°„ï¼š** å°†å½“å‰ç”¨æˆ·çš„ UID å’Œ GID æ˜ å°„åˆ°æ–°çš„ç”¨æˆ·å‘½åç©ºé—´ä¸­ï¼Œä»¥ä¾¿åœ¨æ–°çš„å‘½åç©ºé—´ä¸­æ‹¥æœ‰æƒé™ã€‚
4.  **æŒ‚è½½ OverlayFSï¼š** ä½¿ç”¨ `mount` ç³»ç»Ÿè°ƒç”¨ï¼Œå°† overlayfs æŒ‚è½½åˆ° mergedirï¼Œå¹¶å°† lowerdirï¼Œupperdir å’Œ workdir æŒ‡å®šä¸ºç›¸åº”çš„ç›®å½•ã€‚
5.  **è®¾ç½® Capabilitiesï¼š** å¤åˆ¶å½“å‰æ‰§è¡Œçš„ç¨‹åºåˆ° mergedirï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½®è¯¥æ–‡ä»¶çš„ capabilitiesï¼Œä½¿å…¶å…·æœ‰ root æƒé™ã€‚ è¿™æ­¥æ˜¯æ¼æ´åˆ©ç”¨çš„å…³é”®ã€‚
6.  **æ‰§è¡ŒPayloadï¼š** æ‰§è¡Œupperç›®å½•ä¸­çš„æ–‡ä»¶ï¼Œå› ä¸ºè®¾ç½®äº†Capabilitiesï¼Œå¯ä»¥è·å¾—rootæƒé™ã€‚

**æœ‰æ•ˆæ€§ï¼š**

æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’ŒPOCä»£ç æè¿°ï¼Œè¯¥æ¼æ´åœ¨ç‰¹å®šç‰ˆæœ¬çš„ Ubuntu å†…æ ¸ä¸Šæ˜¯å¯åˆ©ç”¨çš„ã€‚æä¾›çš„POCä»£ç å±•ç¤ºäº†åˆ©ç”¨è¯¥æ¼æ´æå‡æƒé™çš„å®Œæ•´è¿‡ç¨‹ã€‚

**æŠ•æ¯’é£é™©ï¼š**

ä»£ç ä¸­å­˜åœ¨æ½œåœ¨çš„æŠ•æ¯’é£é™©ï¼Œä½†æ˜¯é£é™©è¾ƒä½ã€‚ä¸»è¦é›†ä¸­åœ¨ç¼–è¯‘å’Œè¿è¡Œexploitæ—¶ã€‚æ”»å‡»è€…å¯èƒ½é€šè¿‡ä¿®æ”¹ exploit.c æ–‡ä»¶ï¼Œä¾‹å¦‚æ·»åŠ æ¶æ„ä»£ç æˆ–åé—¨ï¼Œä»è€Œåœ¨ç›®æ ‡ç³»ç»Ÿä¸Šæ‰§è¡Œæ¶æ„æ“ä½œã€‚ä½†æ˜¯æ ¹æ®æä¾›çš„POCä»£ç æ¥çœ‹, é£é™©ç³»æ•°è¾ƒä½.

**é£é™©è¯„ä¼°ï¼š**

è¯¥æ¼æ´åˆ©ç”¨çš„æˆåŠŸå–å†³äºç›®æ ‡ç³»ç»Ÿæ˜¯å¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š

*   è¿è¡Œå—å½±å“çš„ Ubuntu å†…æ ¸ç‰ˆæœ¬ã€‚
*   å¯ç”¨äº†æœªæˆæƒç”¨æˆ·å‘½åç©ºé—´å’Œ overlayfs mountã€‚
*   ç›®æ ‡ç³»ç»Ÿä¸Šå­˜åœ¨ `gcc` ç¼–è¯‘å™¨, èƒ½å¤Ÿç¼–è¯‘exploitã€‚

å¦‚æœç›®æ ‡ç³»ç»Ÿæ»¡è¶³è¿™äº›æ¡ä»¶ï¼Œæ”»å‡»è€…å¯ä»¥ä½¿ç”¨æä¾›çš„ POC ä»£ç æˆåŠŸåˆ©ç”¨è¯¥æ¼æ´ï¼Œä»è€Œè·å¾— root æƒé™ã€‚


**é¡¹ç›®åœ°å€:** [fei9747/CVE-2021-3493](https://github.com/fei9747/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #8

**æ¥æº**: [CVE-2021-3493-iamz24_CVE-2021-3493_CVE-2022-3357.md](../2021/CVE-2021-3493-iamz24_CVE-2021-3493_CVE-2022-3357.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒæ¼æ´

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å¯¼è‡´æœ¬åœ°æƒé™æå‡è‡³ root

**å½±å“ç‰ˆæœ¬:** Ubuntu kernels < 5.8.0-50.56, < 5.4.0-72.80, < 4.15.0-142.146, < 4.4.0-209.241

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç›®æ ‡ç³»ç»Ÿå¼€å¯ unprivileged user namespaces å’Œå­˜åœ¨ OverlayFS æœåŠ¡ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2021-3493 æ¼æ´æ˜¯ Linux å†…æ ¸ overlayfs å®ç°ä¸­ï¼Œåœ¨ç”¨æˆ·å‘½åç©ºé—´ä¸­å¯¹åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­çš„æ–‡ä»¶ capabilities éªŒè¯ä¸å½“å¯¼è‡´çš„ã€‚ç”±äº Ubuntu å†…æ ¸ä¸­å­˜åœ¨å…è®¸éç‰¹æƒ overlay æŒ‚è½½çš„è¡¥ä¸ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¯¥æ¼æ´æå‡æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** æ£€æŸ¥ç›®æ ‡ç³»ç»Ÿæ˜¯å¦å­˜åœ¨ overlayfs æœåŠ¡ï¼Œå¦‚æœæ²¡æœ‰åˆ™åŠ è½½ overlay æ¨¡å—ã€‚åŒæ—¶ï¼Œç¡®ä¿å¼€å¯äº† unprivileged user namespacesã€‚
2.  **ç¼–è¯‘ Payloadï¼š** ä½¿ç”¨ GCC ç¼–è¯‘æä¾›çš„ `payload.c` æ–‡ä»¶ã€‚
3.  **è¿è¡Œ Payloadï¼š** è¿è¡Œç¼–è¯‘åçš„å¯æ‰§è¡Œæ–‡ä»¶ `a.out`ã€‚
4.  **è·å– Root Shellï¼š** Payload ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å‘½åç©ºé—´ï¼ŒæŒ‚è½½ overlayfsï¼Œè®¾ç½® capabilityï¼Œæœ€ç»ˆæ‰§è¡Œä¸€ä¸ªå…·æœ‰ root æƒé™çš„ shellã€‚

**æœ‰æ•ˆæ€§ï¼š**

æä¾›çš„ POC ä»£ç åŸºæœ¬æœ‰æ•ˆï¼Œèƒ½å¤Ÿåˆ©ç”¨è¯¥æ¼æ´åœ¨ç¬¦åˆæ¡ä»¶çš„ Ubuntu ç³»ç»Ÿä¸Šå®ç°æœ¬åœ°ææƒã€‚

**æŠ•æ¯’é£é™©ï¼š**

å­˜åœ¨è¾ƒä½çš„æŠ•æ¯’é£é™©ï¼ˆ10%ï¼‰ã€‚è™½ç„¶ä»£ç çš„ä¸»è¦åŠŸèƒ½æ˜¯å®ç°ææƒï¼Œä½†ä»ç„¶éœ€è¦è°¨æ…å¯¹å¾…æ¥æºä¸æ˜çš„ä»£ç ï¼Œä½œè€…å¯èƒ½ä¼šåœ¨å…¶ä¸­éšè—ä¸€äº›æ¶æ„è¡Œä¸ºï¼Œæ¯”å¦‚ä¸Šä¼ æ•æ„Ÿä¿¡æ¯ç­‰ã€‚ç‰¹åˆ«æ˜¯éœ€è¦æ£€æŸ¥ `exploit`å‡½æ•°ä¸­çš„ç›¸å…³æ–‡ä»¶æ“ä½œå’Œå‘½ä»¤æ‰§è¡Œæ˜¯å¦å­˜åœ¨æ¶æ„è¡Œä¸ºã€‚å°¤å…¶å…³æ³¨`system(buf);`æ˜¯å¦ä¼šæ‰§è¡Œæ¶æ„çš„æŒ‡ä»¤ã€‚

**æ€»ç»“ï¼š**

è¯¥æ¼æ´åˆ©ç”¨è¾ƒä¸ºç›´æ¥ï¼Œåˆ©ç”¨æ¡ä»¶ç›¸å¯¹æ˜ç¡®ï¼Œä½†éœ€è¦æ³¨æ„æ½œåœ¨çš„æŠ•æ¯’é£é™©ã€‚åœ¨å®é™…ä½¿ç”¨æ—¶ï¼Œåº”è¯¥ä»”ç»†å®¡æŸ¥ä»£ç ï¼Œç¡®ä¿æ²¡æœ‰æ¶æ„è¡Œä¸ºã€‚

**é¡¹ç›®åœ°å€:** [iamz24/CVE-2021-3493_CVE-2022-3357](https://github.com/iamz24/CVE-2021-3493_CVE-2022-3357)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #9

**æ¥æº**: [CVE-2021-3493-inspiringz_CVE-2021-3493.md](../2021/CVE-2021-3493-inspiringz_CVE-2021-3493.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Ubuntu Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸ä½æƒé™ç”¨æˆ·æå‡åˆ°rootæƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu 4.4, 4.15, 5.4, 5.8 kernels (å—å½±å“ç‰ˆæœ¬è¯¦è§æ¼æ´åº“ä¿¡æ¯)

**åˆ©ç”¨æ¡ä»¶:** Ubuntuå†…æ ¸ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…ï¼Œå¯ç”¨æœªæˆæƒç”¨æˆ·å‘½åç©ºé—´ï¼Œå…è®¸æœªæˆæƒOverlayFSæŒ‚è½½ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 5%

## è¯¦æƒ…

CVE-2021-3493æ˜¯Ubuntuå†…æ ¸ä¸­OverlayFSå®ç°çš„ä¸€ä¸ªæ¼æ´ï¼Œå…è®¸ä½æƒé™ç”¨æˆ·é€šè¿‡åˆ©ç”¨user namespaceå’ŒOverlayFSæŒ‚è½½ç»•è¿‡æ–‡ä»¶ç³»ç»Ÿæƒé™æ£€æŸ¥æ¥æå‡æƒé™ã€‚ 

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡:** æ¼æ´åˆ©ç”¨éœ€è¦å­˜åœ¨Ubuntuç³»ç»Ÿï¼Œä¸”å†…æ ¸ç‰ˆæœ¬åœ¨æ¼æ´åº“ä¿¡æ¯ä¸­æè¿°çš„å—å½±å“èŒƒå›´å†…ï¼Œå¹¶ä¸”éœ€è¦å¯ç”¨æœªæˆæƒç”¨æˆ·å‘½åç©ºé—´(unprivileged user namespaces)ã€‚æ­¤å¤–ï¼Œä¸ºäº†åˆ©ç”¨OverlayFSï¼Œç³»ç»Ÿéœ€è¦é…ç½®å…è®¸æœªæˆæƒç”¨æˆ·è¿›è¡ŒOverlayFSæŒ‚è½½ã€‚
2.  **æ¼æ´åˆ©ç”¨:**  æ”»å‡»è€…é¦–å…ˆåˆ›å»ºä¸€ä¸ªåŒ…å«lower, upper, workç›®å½•çš„OverlayFSç»“æ„ã€‚
3.  **åˆ©ç”¨è¿‡ç¨‹:** åˆ©ç”¨`unshare`ç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€ä¸ªæ–°çš„user namespaceå’Œmount namespaceã€‚ åœ¨æ–°namespaceä¸­ï¼Œå°†è‡ªå·±çš„UIDå’ŒGIDæ˜ å°„åˆ°rootæƒé™ã€‚ ç„¶åï¼Œä½¿ç”¨æ„é€ çš„lowerdirã€upperdirå’ŒworkdiræŒ‚è½½OverlayFSæ–‡ä»¶ç³»ç»Ÿã€‚ æ”»å‡»è€…å°†ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶å¤åˆ¶åˆ°OverlayFSçš„mergeç›®å½•ä¸­ã€‚å…³é”®çš„ä¸€æ­¥æ˜¯ï¼Œæ”»å‡»è€…ä½¿ç”¨`setxattr`ç³»ç»Ÿè°ƒç”¨ï¼Œè®¾ç½®è¯¥å¯æ‰§è¡Œæ–‡ä»¶çš„`security.capability`æ‰©å±•å±æ€§ï¼Œèµ‹äºˆå®ƒ`CAP_SETUID`å’Œ`CAP_SETGID`èƒ½åŠ›ã€‚ ç”±äºOverlayFSçš„æƒé™éªŒè¯ä¸å®Œå–„ï¼Œè¿™ä¸ªæ“ä½œå³ä½¿åœ¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´ä¸­ä¹Ÿèƒ½æˆåŠŸã€‚å½“æ‰§è¡Œè¯¥æ–‡ä»¶æ—¶ï¼Œå®ƒå°†è·å¾—rootæƒé™ï¼Œå¹¶å¯ä»¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚
4.  **POCä»£ç åˆ†æ:** `exploit.c` ä»£ç é¦–å…ˆåˆ›å»ºä¸€ä¸ªoverlayfsç›®å½•ç»“æ„ã€‚ç„¶åï¼Œä½¿ç”¨ `unshare` ç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€ä¸ªæ–°çš„ user namespace å’Œ mount namespaceï¼Œå¹¶å°†å½“å‰ç”¨æˆ·çš„ uid å’Œ gid æ˜ å°„åˆ° root ç”¨æˆ·ã€‚ ä¹‹åï¼Œå®ƒæŒ‚è½½ overlayfsï¼Œå¤åˆ¶å½“å‰æ‰§è¡Œçš„ç¨‹åºåˆ° overlayfs çš„ merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½® capabilityã€‚æœ€åï¼Œæ‰§è¡Œå¤åˆ¶åˆ° overlayfs çš„ç¨‹åºã€‚
5. **æŠ•æ¯’é£é™©åˆ†æ:** ä»£ç æœ¬èº«å®ç°äº†æ¼æ´åˆ©ç”¨çš„åŠŸèƒ½ã€‚ æ½œåœ¨çš„æŠ•æ¯’é£é™©å¯èƒ½å­˜åœ¨äºä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š
    *   **ä¾èµ–é¡¹:**  ä»£ç ä¾èµ–äºæ ‡å‡†çš„Cåº“ï¼Œæœ¬èº«ä¸å­˜åœ¨æ¶æ„ä¾èµ–ã€‚ä½†ç”¨æˆ·åœ¨ç¼–è¯‘æ—¶éœ€è¦æ³¨æ„ç¼–è¯‘å™¨ç¯å¢ƒçš„å®‰å…¨æ€§ã€‚
    *   **ä»£ç é€»è¾‘:**  ä»£ç é€»è¾‘ç›¸å¯¹ç®€å•ï¼Œä¸»è¦é›†ä¸­åœ¨namespaceåˆ›å»ºã€æŒ‚è½½å’Œcapabilityè®¾ç½®ã€‚ ä»”ç»†å®¡æŸ¥ä»£ç ï¼Œæœªå‘ç°æ˜æ˜¾çš„æ¶æ„é€»è¾‘ã€‚
    *   **æ‰§è¡Œå‘½ä»¤:**  ä»£ç ä¸­ä½¿ç”¨äº† `system` å‡½æ•°ï¼Œè¿™æ˜¯ä¸€ä¸ªæ½œåœ¨çš„é£é™©ç‚¹ï¼Œå¯ä»¥æ‰§è¡Œä»»æ„ç³»ç»Ÿå‘½ä»¤ã€‚ä½†æ˜¯ï¼Œè¿™é‡Œåªæ˜¯ç”¨æ¥åˆ é™¤ç›®å½•ï¼Œç›¸å¯¹å®‰å…¨ã€‚
       ç»¼ä¸Šæ‰€è¿°ï¼Œè¯¥POCä»£ç ä¸»è¦é£é™©åœ¨äºç¡®ä¿ç¼–è¯‘ç¯å¢ƒå®‰å…¨ä»¥åŠå¯¹ä¸ç†Ÿæ‚‰çš„å‘½ä»¤ä¿æŒè­¦æƒ•ã€‚æŠ•æ¯’é£é™©è¾ƒä½ï¼Œé¢„ä¼°ä¸º5%ã€‚

**æ€»ç»“ï¼š**

è¯¥æ¼æ´åˆ©ç”¨çš„æ ¸å¿ƒåœ¨äºç»“åˆäº†æœªæˆæƒç”¨æˆ·å‘½åç©ºé—´å’ŒOverlayFSï¼Œåˆ©ç”¨OverlayFSå¯¹capabilitiesè®¾ç½®éªŒè¯çš„ç¼ºé™·ï¼Œå®ç°äº†æœ¬åœ°ææƒã€‚ æ”»å‡»è€…é€šè¿‡åˆ›å»ºç‰¹æ®Šçš„OverlayFSç»“æ„å¹¶è®¾ç½®æ–‡ä»¶capabilitiesï¼Œæœ€ç»ˆè·å¾—rootæƒé™ã€‚

**é¡¹ç›®åœ°å€:** [inspiringz/CVE-2021-3493](https://github.com/inspiringz/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #10

**æ¥æº**: [CVE-2021-3493-oneoy_CVE-2021-3493.md](../2021/CVE-2021-3493-oneoy_CVE-2021-3493.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœ¬åœ°ç”¨æˆ·å¯æå‡è‡³ root æƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu 4.4, 4.15, 5.4, and 5.8 kernels (å…·ä½“ç‰ˆæœ¬å·è§æ¼æ´åº“ä¿¡æ¯)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç›®æ ‡ç³»ç»Ÿå­˜åœ¨æœªä¿®å¤çš„ Ubuntu kernelï¼Œä¸”å¯ç”¨ unprivileged user namespaces å’Œå…è®¸ unprivileged overlayfs mountsã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

è¯¥æ¼æ´å­˜åœ¨äº Ubuntu å†…æ ¸çš„ OverlayFS å®ç°ä¸­ï¼Œç”±äºæœªæ­£ç¡®éªŒè¯ç”¨æˆ·å‘½åç©ºé—´ä¸­åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸Šæ–‡ä»¶ capabilities çš„è®¾ç½®ï¼Œå¯¼è‡´æœ¬åœ°æ”»å‡»è€…å¯åˆ©ç”¨ unprivileged user namespaces å’Œ Ubuntu å†…æ ¸ä¸­å…è®¸ unprivileged overlayfs mounts çš„è¡¥ä¸æ¥æå‡æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ (lower, upper, work, merge)ã€‚
2.  **é…ç½® User Namespace:** åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´ã€‚
3.  **é…ç½® OverlayFS:** ä½¿ç”¨ lowerdir, upperdir, å’Œ workdir é€‰é¡¹æŒ‚è½½ overlay æ–‡ä»¶ç³»ç»Ÿã€‚
4.  **è®¾ç½® Capabilities:** å°†å¯æ‰§è¡Œæ–‡ä»¶å¤åˆ¶åˆ° merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½®å…¶ capabilities (å¦‚ CAP_SETUID, CAP_SETGID, CAP_CHOWN)ã€‚
5.  **è§¦å‘ææƒ:** æ‰§è¡Œ merge ç›®å½•ä¸­çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶å°†ä¼šä»¥ root æƒé™æ‰§è¡Œã€‚

**æŠ•æ¯’é£é™©è¯„ä¼°ï¼š**

æä¾›çš„ `exploit.c` ä»£ç ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨ OverlayFS çš„æ¼æ´è¿›è¡Œææƒã€‚ä»£ç åˆ›å»ºå¿…è¦çš„ç›®å½•ï¼Œé…ç½® user namespace å’Œ overlay æ–‡ä»¶ç³»ç»Ÿï¼Œå¹¶è®¾ç½®å¯æ‰§è¡Œæ–‡ä»¶çš„ capabilitiesã€‚ä»£ç é€»è¾‘æ¸…æ™°ï¼Œæ²¡æœ‰å‘ç°æ¶æ„ä»£ç æˆ–åé—¨ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**

æä¾›çš„ POC ä»£ç åŸºäºå…¬å¼€ä¿¡æ¯ï¼Œå¹¶é’ˆå¯¹ CVE-2021-3493 æ¼æ´è¿›è¡Œäº†åˆ©ç”¨ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯ã€æœç´¢å¼•æ“ç»“æœå’Œä»£ç åˆ†æï¼Œè¯¥ POC ä»£ç åœ¨æ»¡è¶³æ¼æ´åˆ©ç”¨æ¡ä»¶çš„æƒ…å†µä¸‹åº”è¯¥æ˜¯æœ‰æ•ˆçš„ã€‚

**é¡¹ç›®åœ°å€:** [oneoy/CVE-2021-3493](https://github.com/oneoy/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #11

**æ¥æº**: [CVE-2021-3493-pmihsan_OverlayFS-CVE-2021-3493.md](../2021/CVE-2021-3493-pmihsan_OverlayFS-CVE-2021-3493.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœ¬åœ°ç”¨æˆ·å¯æå‡è‡³ root æƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu kernel versions: < 5.8.0-50.56 (5.8 kernel), < 5.4.0-72.80 (5.4 kernel), < 4.15.0-142.146 (4.15 kernel), < 4.4.0-209.241 (4.4 kernel)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦åœ¨å­˜åœ¨æ¼æ´çš„ Ubuntu ç³»ç»Ÿä¸Šæ‰§è¡Œï¼Œå¹¶ä¸”å…è®¸ unprivileged user namespaces å’Œ overlay mountsã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

CVE-2021-3493 æ¼æ´å­˜åœ¨äº Linux å†…æ ¸çš„ overlayfs å®ç°ä¸­ã€‚ç”±äºå¯¹ç”¨æˆ·å‘½åç©ºé—´ä¸­åº•å±‚æ–‡ä»¶ç³»ç»Ÿæ–‡ä»¶ capabilities çš„éªŒè¯ä¸è¶³ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡åˆ›å»ºæ¶æ„çš„ overlayfs æ–‡ä»¶ç³»ç»Ÿï¼Œåˆ©ç”¨ setxattr è®¾ç½®æ–‡ä»¶ capabilitiesï¼Œä»è€Œè·å¾—æå‡çš„æƒé™ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡ï¼š** åˆ›å»º overlayfs æ‰€éœ€çš„ç›®å½•ç»“æ„ (lower, upper, work, merge)ã€‚
2.  **Namespace åˆ›å»ºï¼š** åˆ›å»ºæ–°çš„ user namespace å’Œ mount namespaceï¼Œéš”ç¦»æƒé™ã€‚
3.  **æƒé™è®¾ç½®ï¼š** ä¿®æ”¹ uid_map å’Œ gid_mapï¼Œä½¿å¾—åœ¨ user namespace ä¸­æ‹¥æœ‰ root æƒé™ã€‚
4.  **Overlayfs Mountï¼š** ä½¿ç”¨ overlayfs mount å‘½ä»¤å°† lowerdir, upperdir, workdir æŒ‚è½½åˆ° mergedirã€‚
5.  **Capabilities è®¾ç½®ï¼š** å¤åˆ¶è‡ªèº«ç¨‹åºåˆ° merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` å‡½æ•°ä¸ºå¤åˆ¶åçš„ç¨‹åºè®¾ç½® capabilities (CAP_SETUID, CAP_SETGID, CAP_DAC_OVERRIDE ç­‰)ã€‚
6.  **æƒé™æå‡ï¼š** æ‰§è¡Œ merge ç›®å½•ä¸‹çš„ç¨‹åºï¼Œæ­¤æ—¶ç¨‹åºå°†ä»¥ root æƒé™è¿è¡Œã€‚

**æœ‰æ•ˆæ€§ï¼š**

æä¾›çš„ POC ä»£ç é€šè¿‡åˆ©ç”¨ overlayfs æ¼æ´ï¼Œå¯ä»¥æˆåŠŸåœ°æå‡æƒé™ã€‚POC ä»£ç é¦–å…ˆåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼Œç„¶ååˆ›å»ºä¸€ä¸ªæ–°çš„ user namespace å’Œ mount namespaceï¼Œæ¥ç€æŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿï¼Œå¹¶ä½¿ç”¨ `setxattr` å‡½æ•°ä¸ºæ–‡ä»¶è®¾ç½® capabilitiesã€‚æœ€åï¼Œæ‰§è¡Œè¯¥æ–‡ä»¶å³å¯è·å¾— root æƒé™ã€‚

**æŠ•æ¯’é£é™©ï¼š**

åˆ†æ POC ä»£ç ï¼Œæ²¡æœ‰å‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç ï¼Œä¾‹å¦‚åå¼¹ shellã€å®‰è£…åé—¨ç­‰ã€‚ä»£ç é€»è¾‘ä¸»è¦é›†ä¸­åœ¨åˆ©ç”¨ overlayfs æ¼æ´ææƒï¼Œå¹¶æ²¡æœ‰é¢å¤–çš„æ“ä½œæ¥æ¤å…¥æ¶æ„ç¨‹åºã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ï¼Œå¯ä»¥è®¤ä¸ºæ˜¯ 0%ã€‚å‚è€ƒçš„ vulnerability description å’Œ exploit ä»£ç éƒ½ç€é‡äºææƒï¼Œè€Œæ²¡æœ‰æåˆ°ä»»ä½•æŠ•æ¯’è¡Œä¸ºã€‚

**é¡¹ç›®åœ°å€:** [pmihsan/OverlayFS-CVE-2021-3493](https://github.com/pmihsan/OverlayFS-CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #12

**æ¥æº**: [CVE-2021-3493-ptkhai15_OverlayFS---CVE-2021-3493.md](../2021/CVE-2021-3493-ptkhai15_OverlayFS---CVE-2021-3493.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Ubuntu Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœ¬åœ°ç”¨æˆ·æå‡æƒé™è‡³ root

**å½±å“ç‰ˆæœ¬:** Ubuntu kernel versions 5.8, 5.4, 4.15, å’Œ 4.4 ä¸­å—å½±å“çš„ç‰ˆæœ¬ï¼ˆå…·ä½“ç‰ˆæœ¬å‚è§æ¼æ´åº“ä¿¡æ¯ï¼‰

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡ç³»ç»Ÿå¿…é¡»æ˜¯å—å½±å“çš„ Ubuntu ç‰ˆæœ¬ï¼Œå¹¶ä¸”å¯ç”¨äº†éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å’Œéç‰¹æƒ overlayfs æŒ‚è½½ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

CVE-2021-3493 æ˜¯ Ubuntu Linux å†…æ ¸ä¸­ OverlayFS å®ç°ä¸­çš„ä¸€ä¸ªæ¼æ´ã€‚è¯¥æ¼æ´å…è®¸éç‰¹æƒç”¨æˆ·åˆ©ç”¨ç”¨æˆ·å‘½åç©ºé—´å’Œéç‰¹æƒ overlayfs æŒ‚è½½ï¼Œé€šè¿‡ä¸æ­£ç¡®åœ°éªŒè¯åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­æ–‡ä»¶çš„ capabilities è®¾ç½®æ¥æå‡æƒé™ã€‚åˆ©ç”¨æ–¹å¼å¦‚ä¸‹ï¼š

1.  **ç¯å¢ƒå‡†å¤‡ï¼š**  åˆ›å»ºä¸€ä¸ªåŸºç¡€ç›®å½•ç»“æ„ï¼ŒåŒ…æ‹¬ workã€lowerã€upper å’Œ merge ç›®å½•ï¼Œè¿™æ˜¯ overlayfs çš„æ ‡å‡†é…ç½®ã€‚
2.  **åˆ›å»ºç”¨æˆ·å‘½åç©ºé—´ï¼š**  ä½¿ç”¨ `unshare` å‘½ä»¤åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´ã€‚è¿™å…è®¸åœ¨æ–°çš„å‘½åç©ºé—´ä¸­æ‹¥æœ‰ä¸åŒçš„ç”¨æˆ·å’Œç»„ IDã€‚
3.  **é…ç½®ç”¨æˆ·å’Œç»„æ˜ å°„ï¼š**  é€šè¿‡ `/proc/self/setgroups`ã€`/proc/self/uid_map` å’Œ `/proc/self/gid_map` æ–‡ä»¶è®¾ç½®ç”¨æˆ·å’Œç»„ ID æ˜ å°„ï¼Œå°†å½“å‰ç”¨æˆ·çš„ UID å’Œ GID æ˜ å°„åˆ°æ–°å‘½åç©ºé—´ä¸­çš„ root ç”¨æˆ·ã€‚
4.  **æŒ‚è½½ OverlayFSï¼š**  ä½¿ç”¨ `mount` å‘½ä»¤æŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿï¼Œå°† lowerã€upper å’Œ work ç›®å½•å…³è”èµ·æ¥ã€‚
5.  **è®¾ç½®æ–‡ä»¶ capabilitiesï¼š**  å¤åˆ¶å½“å‰æ‰§è¡Œç¨‹åºåˆ° overlayfs çš„ merge ç›®å½•ï¼Œå¹¶ä½¿ç”¨ `setxattr` è®¾ç½®æ–‡ä»¶çš„ capabilities ä¸º `all+ep`ï¼Œå…è®¸è¯¥æ–‡ä»¶æ‰§è¡Œæ—¶æ‹¥æœ‰ root æƒé™ã€‚
6.  **æ‰§è¡Œææƒåçš„ç¨‹åºï¼š**  æ‰§è¡Œä½äº upper ç›®å½•ä¸­çš„å¤åˆ¶åçš„ç¨‹åºã€‚å¦‚æœç¨‹åºæ£€æµ‹åˆ°è‡ªå·±æ˜¯é€šè¿‡ç‰¹å®šæ–¹å¼ï¼ˆä¾‹å¦‚ï¼ŒåŒ…å« "magic" å­—ç¬¦ä¸²æˆ–æ¥å— "shell" å‚æ•°ï¼‰è°ƒç”¨çš„ï¼Œå®ƒä¼šè°ƒç”¨ `setuid(0)` å’Œ `setgid(0)` å°†è¿›ç¨‹çš„ UID å’Œ GID è®¾ç½®ä¸º 0 (root)ï¼Œå¹¶å¯åŠ¨ä¸€ä¸ª root shellã€‚

**å…³äºæŠ•æ¯’é£é™©ï¼š**

åœ¨æä¾›çš„ POC ä»£ç ä¸­ï¼Œæ²¡æœ‰æ˜æ˜¾çš„æŠ•æ¯’ä»£ç ã€‚POC çš„ç›®çš„æ˜¯æ¼”ç¤ºæ¼æ´åˆ©ç”¨è¿‡ç¨‹ï¼Œæ²¡æœ‰å‘ç°æ¶æ„è¡Œä¸ºï¼Œä¾‹å¦‚åå‘ shell æˆ–å…¶ä»–æœªç»æˆæƒçš„è®¿é—®ã€‚


**é¡¹ç›®åœ°å€:** [ptkhai15/OverlayFS---CVE-2021-3493](https://github.com/ptkhai15/OverlayFS---CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #13

**æ¥æº**: [CVE-2021-3493-puckiestyle_CVE-2021-3493.md](../2021/CVE-2021-3493-puckiestyle_CVE-2021-3493.md)

## CVE-2021-3493 - Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°ææƒ

**å½±å“åº”ç”¨:** Linux Kernel (Ubuntu)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ”»å‡»è€…å¯åˆ©ç”¨æ­¤æ¼æ´è·å¾— root æƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu 5.8 kernel (< 5.8.0-50.56), 5.4 kernel (< 5.4.0-72.80), 4.15 kernel (< 4.15.0-142.146), 4.4 kernel (< 4.4.0-209.241)

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ Ubuntu ç³»ç»Ÿå¼€å¯ unprivileged user namespaces å’Œå…è®¸ unprivileged overlay mounts

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2021-3493 æ˜¯ Ubuntu å†…æ ¸ overlayfs å®ç°ä¸­çš„ä¸€ä¸ªæ¼æ´ï¼Œå…è®¸æœ¬åœ°æ”»å‡»è€…é€šè¿‡æ»¥ç”¨ user namespaces å’Œ overlayfs æŒ‚è½½æœºåˆ¶æå‡æƒé™ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**
æä¾›çš„ POC ä»£ç å°è¯•åˆ©ç”¨è¯¥æ¼æ´ï¼Œé€šè¿‡åˆ›å»º user namespace å’Œ overlayfs æ–‡ä»¶ç³»ç»Ÿæ¥è®¾ç½®å¯æ‰§è¡Œæ–‡ä»¶çš„ capability ä½ï¼Œä½¿å…¶è·å¾— root æƒé™ã€‚ æ¼æ´åº“ä¿¡æ¯,æœç´¢å¼•æ“ç»“æœå’Œæ¼æ´åˆ©ç”¨ä»£ç ä¸€è‡´,è¡¨æ˜è¯¥æ¼æ´çš„POCæ˜¯çœŸå®æœ‰æ•ˆçš„ã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**
æŸ¥çœ‹ `exploit.c` ä»£ç ï¼Œä¸»è¦æ“ä½œåŒ…æ‹¬åˆ›å»ºç›®å½•ã€è®¾ç½® user namespaceã€æŒ‚è½½ overlayfsã€å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶ã€è®¾ç½® capability å±æ€§ï¼Œä»¥åŠæ‰§è¡Œå¤åˆ¶åçš„æ–‡ä»¶ä»¥è·å¾— root æƒé™ã€‚ä»£ç é€»è¾‘è¾ƒä¸ºæ¸…æ™°ï¼Œæœªå‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç ã€‚`README.md` ä¹Ÿè¯´æ˜äº†å¹¶éä½œè€…åŸåˆ›,åªæ˜¯æ¬è¿,å¢åŠ äº†åˆ†æéš¾åº¦.
`exploit.c`ä¸­å­˜åœ¨`system(buf);` è°ƒç”¨ï¼Œè™½ç„¶è¿™é‡Œæ˜¯ç”¨äºæ¸…ç†ç›®å½•ï¼Œä½†å¦‚æœè¢«ç¯¡æ”¹ï¼Œå¯èƒ½æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚å› æ­¤ï¼ŒæŠ•æ¯’é£é™©è¯„ä¼°ä¸º10%ã€‚ä¸»è¦çš„é£é™©åœ¨äºï¼š

*   `system()` å‡½æ•°æ½œåœ¨çš„å‘½ä»¤æ³¨å…¥é£é™©ï¼Œå¦‚æœä»£ç è¢«ä¿®æ”¹ï¼Œå¯èƒ½å¯¼è‡´æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  åˆ©ç”¨ unshare() åˆ›å»ºä¸€ä¸ªæ–°çš„ user namespace å’Œ mount namespaceã€‚
2.  é…ç½® user namespace çš„ uid_map å’Œ gid_mapï¼Œå°†å½“å‰ç”¨æˆ·æ˜ å°„ä¸º root ç”¨æˆ·ã€‚
3.  åˆ›å»º overlayfs æ‰€éœ€çš„ç›®å½•ç»“æ„ï¼ˆlowerdirã€upperdirã€workdirã€mergedï¼‰ã€‚
4.  æŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿã€‚
5.  å°†æ¼æ´åˆ©ç”¨ç¨‹åºè‡ªèº«å¤åˆ¶åˆ° overlayfs çš„ upperdir/merged ç›®å½•ã€‚
6.  ä½¿ç”¨ setxattr() è®¾ç½®å¤åˆ¶åçš„å¯æ‰§è¡Œæ–‡ä»¶çš„ security.capability å±æ€§ï¼Œèµ‹äºˆå…¶ CAP_SETUID å’Œ CAP_SETGID æƒé™ã€‚
7.  æ‰§è¡Œå¤åˆ¶åçš„ç¨‹åºï¼Œç”±äºè®¾ç½®äº† capabilityï¼Œè¯¥ç¨‹åºä¼šä»¥ root æƒé™è¿è¡Œï¼Œä»è€Œè·å¾— root shellã€‚

**é¡¹ç›®åœ°å€:** [puckiestyle/CVE-2021-3493](https://github.com/puckiestyle/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #14

**æ¥æº**: [CVE-2021-3493-smallkill_CVE-2021-3493.md](../2021/CVE-2021-3493-smallkill_CVE-2021-3493.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°æƒé™æå‡

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æœ¬åœ°æƒé™æå‡

**å½±å“åº”ç”¨:** Ubuntu Linux Kernel

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯ä½¿ä½æƒé™ç”¨æˆ·è·å¾— root æƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu kernel versions before 5.8.0-50.56, 5.4.0-72.80, 4.15.0-142.146, and 4.4.0-209.241

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç›®æ ‡ç³»ç»Ÿè¿è¡Œå­˜åœ¨æ¼æ´çš„ Ubuntu kernelï¼Œä¸”å¼€å¯äº†æœªæˆæƒç”¨æˆ·å‘½åç©ºé—´å’Œæœªæˆæƒ overlay mount

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

CVE-2021-3493 æ˜¯ä¸€ä¸ª Ubuntu Linux kernel overlayfs å®ç°ä¸­çš„æƒé™æå‡æ¼æ´ã€‚è¯¥æ¼æ´æºäº overlayfs åœ¨ç”¨æˆ·å‘½åç©ºé—´ä¸­æœªæ­£ç¡®éªŒè¯åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­æ–‡ä»¶ capabilities çš„è®¾ç½®ã€‚ç”±äº Ubuntu kernel ä¸­å­˜åœ¨å…è®¸æœªæˆæƒ overlay æŒ‚è½½çš„ patchï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æœªæˆæƒç”¨æˆ·å‘½åç©ºé—´æ¥æå‡æƒé™ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¯å¢ƒå‡†å¤‡:**  åˆ›å»ºä¸€ä¸ªç›®å½•ç»“æ„ï¼ŒåŒ…æ‹¬ lowerdir, upperdir, workdir, mergedirã€‚è¿™äº›ç›®å½•ç”¨äºé…ç½® overlayfs æ–‡ä»¶ç³»ç»Ÿã€‚
2.  **åˆ›å»ºç”¨æˆ·å‘½åç©ºé—´:**  åˆ©ç”¨ `unshare` ç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´ã€‚åœ¨ç”¨æˆ·å‘½åç©ºé—´ä¸­ï¼Œæ”»å‡»è€…å¯ä»¥æ‹¥æœ‰æ›´é«˜çš„æƒé™ï¼Œä½†ä¸ä¼šå½±å“åˆ°å®¿ä¸»æœºçš„æƒé™ã€‚
3.  **é…ç½®ç”¨æˆ·å’Œç»„ ID æ˜ å°„:**  å°†ç”¨æˆ·å‘½åç©ºé—´ä¸­çš„ç”¨æˆ· ID å’Œç»„ ID æ˜ å°„åˆ°å®¿ä¸»æœºä¸Šçš„ç”¨æˆ· ID å’Œç»„ IDã€‚è¿™å…è®¸ç”¨æˆ·å‘½åç©ºé—´ä¸­çš„è¿›ç¨‹ä»¥å®¿ä¸»æœºç”¨æˆ·çš„èº«ä»½è¿è¡Œã€‚
4.  **æŒ‚è½½ OverlayFS:** ä½¿ç”¨ `mount` ç³»ç»Ÿè°ƒç”¨æŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿã€‚`lowerdir` æŒ‡å‘åªè¯»çš„åº•å±‚æ–‡ä»¶ç³»ç»Ÿï¼Œ`upperdir` æŒ‡å‘å¯å†™çš„ä¸Šå±‚æ–‡ä»¶ç³»ç»Ÿï¼Œ`workdir` ç”¨äº overlayfs çš„å·¥ä½œç›®å½•ï¼Œ `mergedir` æ˜¯æŒ‚è½½ç‚¹ï¼Œç”¨æˆ·å¯ä»¥è®¿é—®åˆå¹¶åçš„æ–‡ä»¶ç³»ç»Ÿã€‚
5.  **è®¾ç½®æ–‡ä»¶ capabilities:**  åœ¨ overlayfs æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œåˆ›å»ºä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼Œå¹¶ä½¿ç”¨ `setxattr` ç³»ç»Ÿè°ƒç”¨è®¾ç½®è¯¥æ–‡ä»¶çš„ capabilitiesã€‚Capabilities å…è®¸è¿›ç¨‹åœ¨æ²¡æœ‰ root æƒé™çš„æƒ…å†µä¸‹æ‰§è¡Œç‰¹æƒæ“ä½œã€‚expolitä»£ç ä¸­è®¾ç½®äº†all+ep capabilities,è¿™æ„å‘³ç€è¯¥æ–‡ä»¶å¯ä»¥æ‰§è¡Œæ‰€æœ‰çš„ç‰¹æƒæ“ä½œã€‚
6.  **æ‰§è¡Œå¯æ‰§è¡Œæ–‡ä»¶:**  æ‰§è¡Œè®¾ç½®äº† capabilities çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚ç”±äºè¯¥æ–‡ä»¶å…·æœ‰ capabilitiesï¼Œå› æ­¤å¯ä»¥ä»¥ root æƒé™è¿è¡Œï¼Œä»è€Œæå‡æƒé™ã€‚

**æœ‰æ•ˆæ€§:**
æä¾›çš„ POC ä»£ç å°è¯•åˆ©ç”¨ CVE-2021-3493 æ¼æ´ã€‚å®ƒé¦–å…ˆåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼Œç„¶ååˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å‘½åç©ºé—´ï¼Œé…ç½® ID æ˜ å°„ï¼ŒæŒ‚è½½ overlayfs æ–‡ä»¶ç³»ç»Ÿï¼Œå¹¶è®¾ç½®å¯æ‰§è¡Œæ–‡ä»¶çš„ capabilitiesã€‚æœ€åï¼Œå®ƒæ‰§è¡Œè¯¥æ–‡ä»¶ä»¥æå‡æƒé™ã€‚æ­¤ä»£ç åº”è¯¥å¯ä»¥æˆåŠŸåˆ©ç”¨æ¼æ´ã€‚

**æŠ•æ¯’é£é™©:**
åˆ†ææä¾›çš„ exploit.c å’Œ README.md æ–‡ä»¶ï¼Œ**æœªå‘ç°æ˜æ˜¾çš„æŠ•æ¯’ä»£ç **ã€‚ è¯¥ä»£ç çš„ç›®çš„æ˜¯åˆ©ç”¨æ¼æ´æå‡æƒé™ï¼Œè€Œä¸æ˜¯æ‰§è¡Œä»»ä½•æ¶æ„æ“ä½œã€‚æ‰€æœ‰æ“ä½œéƒ½åœ¨åˆ©ç”¨æ¼æ´çš„èŒƒå›´å†…ï¼Œæ²¡æœ‰å‘ç°éšè—çš„åé—¨æˆ–æ¶æ„è¡Œä¸ºã€‚å› æ­¤ï¼Œå¯ä»¥è®¤ä¸ºæŠ•æ¯’é£é™©ä¸º 0%ã€‚

**é¡¹ç›®åœ°å€:** [smallkill/CVE-2021-3493](https://github.com/smallkill/CVE-2021-3493)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

## POC #15

**æ¥æº**: [CVE-2021-3493-spideyctf_UbuntuTouchSecurityVAPTReport.md](../2021/CVE-2021-3493-spideyctf_UbuntuTouchSecurityVAPTReport.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æƒé™æå‡

**å½±å“åº”ç”¨:** Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´ä»æ™®é€šç”¨æˆ·æå‡åˆ°rootæƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu kernels < 5.8.0-50.56, < 5.4.0-72.80, < 4.15.0-142.146, < 4.4.0-209.241

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç›®æ ‡ç³»ç»Ÿè¿è¡Œå­˜åœ¨æ¼æ´çš„Ubuntuå†…æ ¸ç‰ˆæœ¬ï¼Œå¹¶å¯ç”¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´ä»¥åŠå…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½overlayfsæ–‡ä»¶ç³»ç»Ÿ

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 5%

## è¯¦æƒ…

CVE-2021-3493 æ¼æ´å­˜åœ¨äº Linux Kernel çš„ OverlayFS å®ç°ä¸­ã€‚åœ¨Ubuntuå†…æ ¸ä¸­ï¼Œç”±äºå…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½ overlayfs ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨ä¸æ­£ç¡®çš„æƒé™éªŒè¯æœºåˆ¶ï¼Œç»“åˆéç‰¹æƒç”¨æˆ·å‘½åç©ºé—´ï¼Œåœ¨åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸Šè®¾ç½®æ–‡ä»¶ capabilitiesï¼Œä»è€Œè·å¾—æå‡çš„æƒé™ã€‚æä¾›çš„POCä»£ç åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼Œå¹¶å°è¯•æŒ‚è½½overlayfsæ–‡ä»¶ç³»ç»Ÿï¼Œç„¶ååˆ›å»ºæ¶æ„æ–‡ä»¶ï¼Œå¹¶è®¾ç½®suidæƒé™ï¼Œè¾¾åˆ°æƒé™æå‡çš„ç›®çš„ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**
æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’ŒPOCä»£ç ï¼Œæ­¤æ¼æ´åˆ©ç”¨åœ¨ç‰¹å®šUbuntuå†…æ ¸ç‰ˆæœ¬ä¸Šæ˜¯æœ‰æ•ˆçš„ï¼Œå› ä¸ºè¿™äº›ç‰ˆæœ¬åŒæ—¶å¯ç”¨äº†éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å’Œéç‰¹æƒoverlayfsæŒ‚è½½ã€‚

**æŠ•æ¯’é£é™©è¯„ä¼°ï¼š**
POCä»£ç ä¸»è¦æ˜¯åˆ›å»ºç›®å½•ï¼ŒæŒ‚è½½æ–‡ä»¶ç³»ç»Ÿï¼Œä»¥åŠè®¾ç½®ä¸€äº›æ–‡ä»¶æƒé™ï¼Œæ€»ä½“æ¥è¯´ä»£ç é‡ä¸å¤§ï¼Œé€»è¾‘æ¯”è¾ƒæ¸…æ™°ï¼Œæ²¡æœ‰æ˜æ˜¾çš„æŠ•æ¯’è¡Œä¸ºã€‚å¯èƒ½å­˜åœ¨çš„é£é™©åœ¨äºç¼–è¯‘åçš„äºŒè¿›åˆ¶æ–‡ä»¶å¯èƒ½ä¼šè¢«ç”¨äºå…¶ä»–æ¶æ„ç›®çš„ï¼Œä½†è¿™ä¸æ˜¯ä»£ç æœ¬èº«çš„æŠ•æ¯’ã€‚é£é™©è¯„ä¼°ä¸º5%ä¸»è¦æ˜¯è€ƒè™‘åˆ°ä»»ä½•ä»£ç éƒ½å¯èƒ½è¢«æ»¥ç”¨ï¼Œè€Œéä»£ç æœ¬èº«å­˜åœ¨æ¶æ„é€»è¾‘ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  **ç¯å¢ƒå‡†å¤‡:** åˆ›å»º lower, upper, work, overlay ç›®å½•ã€‚
2.  **æ–‡ä»¶ç³»ç»ŸæŒ‚è½½:** ä½¿ç”¨ OverlayFS å°† lower å’Œ upper ç›®å½•æŒ‚è½½åˆ° overlay ç›®å½•ã€‚
3.  **æƒé™è®¾ç½®:** åœ¨ overlay ç›®å½•ä¸­åˆ›å»ºæ¶æ„æ–‡ä»¶å¹¶è®¾ç½® suid æƒé™ï¼Œå› ä¸ºoverlayfs æ²¡æœ‰æ­£ç¡®æ ¡éªŒæ–‡ä»¶capabilities ï¼Œå› æ­¤å¯ä»¥å°†æƒé™èµ‹äºˆæ–‡ä»¶ã€‚
4.  **æƒé™æå‡:** æ‰§è¡Œæ¶æ„æ–‡ä»¶ï¼Œç”±äº suid æƒé™ï¼Œå¯ä»¥æå‡åˆ°æ–‡ä»¶æ‹¥æœ‰è€…çš„æƒé™ï¼ˆé€šå¸¸æ˜¯rootï¼‰ã€‚

**é¡¹ç›®åœ°å€:** [spideyctf/UbuntuTouchSecurityVAPTReport](https://github.com/spideyctf/UbuntuTouchSecurityVAPTReport)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---



---

## POC #15

**æ¥æº**: [CVE-2021-3493-spideyctf_UbuntuTouchSecurityVAPTReport.md](../2021/CVE-2021-3493-spideyctf_UbuntuTouchSecurityVAPTReport.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æƒé™æå‡

**å½±å“åº”ç”¨:** Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´ä»æ™®é€šç”¨æˆ·æå‡åˆ°rootæƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu kernels < 5.8.0-50.56, < 5.4.0-72.80, < 4.15.0-142.146, < 4.4.0-209.241

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç›®æ ‡ç³»ç»Ÿè¿è¡Œå­˜åœ¨æ¼æ´çš„Ubuntuå†…æ ¸ç‰ˆæœ¬ï¼Œå¹¶å¯ç”¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´ä»¥åŠå…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½overlayfsæ–‡ä»¶ç³»ç»Ÿ

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 5%

## è¯¦æƒ…

CVE-2021-3493 æ¼æ´å­˜åœ¨äº Linux Kernel çš„ OverlayFS å®ç°ä¸­ã€‚åœ¨Ubuntuå†…æ ¸ä¸­ï¼Œç”±äºå…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½ overlayfs ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨ä¸æ­£ç¡®çš„æƒé™éªŒè¯æœºåˆ¶ï¼Œç»“åˆéç‰¹æƒç”¨æˆ·å‘½åç©ºé—´ï¼Œåœ¨åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸Šè®¾ç½®æ–‡ä»¶ capabilitiesï¼Œä»è€Œè·å¾—æå‡çš„æƒé™ã€‚æä¾›çš„POCä»£ç åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼Œå¹¶å°è¯•æŒ‚è½½overlayfsæ–‡ä»¶ç³»ç»Ÿï¼Œç„¶ååˆ›å»ºæ¶æ„æ–‡ä»¶ï¼Œå¹¶è®¾ç½®suidæƒé™ï¼Œè¾¾åˆ°æƒé™æå‡çš„ç›®çš„ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**
æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’ŒPOCä»£ç ï¼Œæ­¤æ¼æ´åˆ©ç”¨åœ¨ç‰¹å®šUbuntuå†…æ ¸ç‰ˆæœ¬ä¸Šæ˜¯æœ‰æ•ˆçš„ï¼Œå› ä¸ºè¿™äº›ç‰ˆæœ¬åŒæ—¶å¯ç”¨äº†éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å’Œéç‰¹æƒoverlayfsæŒ‚è½½ã€‚

**æŠ•æ¯’é£é™©è¯„ä¼°ï¼š**
POCä»£ç ä¸»è¦æ˜¯åˆ›å»ºç›®å½•ï¼ŒæŒ‚è½½æ–‡ä»¶ç³»ç»Ÿï¼Œä»¥åŠè®¾ç½®ä¸€äº›æ–‡ä»¶æƒé™ï¼Œæ€»ä½“æ¥è¯´ä»£ç é‡ä¸å¤§ï¼Œé€»è¾‘æ¯”è¾ƒæ¸…æ™°ï¼Œæ²¡æœ‰æ˜æ˜¾çš„æŠ•æ¯’è¡Œä¸ºã€‚å¯èƒ½å­˜åœ¨çš„é£é™©åœ¨äºç¼–è¯‘åçš„äºŒè¿›åˆ¶æ–‡ä»¶å¯èƒ½ä¼šè¢«ç”¨äºå…¶ä»–æ¶æ„ç›®çš„ï¼Œä½†è¿™ä¸æ˜¯ä»£ç æœ¬èº«çš„æŠ•æ¯’ã€‚é£é™©è¯„ä¼°ä¸º5%ä¸»è¦æ˜¯è€ƒè™‘åˆ°ä»»ä½•ä»£ç éƒ½å¯èƒ½è¢«æ»¥ç”¨ï¼Œè€Œéä»£ç æœ¬èº«å­˜åœ¨æ¶æ„é€»è¾‘ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  **ç¯å¢ƒå‡†å¤‡:** åˆ›å»º lower, upper, work, overlay ç›®å½•ã€‚
2.  **æ–‡ä»¶ç³»ç»ŸæŒ‚è½½:** ä½¿ç”¨ OverlayFS å°† lower å’Œ upper ç›®å½•æŒ‚è½½åˆ° overlay ç›®å½•ã€‚
3.  **æƒé™è®¾ç½®:** åœ¨ overlay ç›®å½•ä¸­åˆ›å»ºæ¶æ„æ–‡ä»¶å¹¶è®¾ç½® suid æƒé™ï¼Œå› ä¸ºoverlayfs æ²¡æœ‰æ­£ç¡®æ ¡éªŒæ–‡ä»¶capabilities ï¼Œå› æ­¤å¯ä»¥å°†æƒé™èµ‹äºˆæ–‡ä»¶ã€‚
4.  **æƒé™æå‡:** æ‰§è¡Œæ¶æ„æ–‡ä»¶ï¼Œç”±äº suid æƒé™ï¼Œå¯ä»¥æå‡åˆ°æ–‡ä»¶æ‹¥æœ‰è€…çš„æƒé™ï¼ˆé€šå¸¸æ˜¯rootï¼‰ã€‚

**é¡¹ç›®åœ°å€:** [spideyctf/UbuntuTouchSecurityVAPTReport](https://github.com/spideyctf/UbuntuTouchSecurityVAPTReport)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---



---

## POC #15

**æ¥æº**: [CVE-2021-3493-spideyctf_UbuntuTouchSecurityVAPTReport.md](../2021/CVE-2021-3493-spideyctf_UbuntuTouchSecurityVAPTReport.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æƒé™æå‡

**å½±å“åº”ç”¨:** Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´ä»æ™®é€šç”¨æˆ·æå‡åˆ°rootæƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu kernels < 5.8.0-50.56, < 5.4.0-72.80, < 4.15.0-142.146, < 4.4.0-209.241

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç›®æ ‡ç³»ç»Ÿè¿è¡Œå­˜åœ¨æ¼æ´çš„Ubuntuå†…æ ¸ç‰ˆæœ¬ï¼Œå¹¶å¯ç”¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´ä»¥åŠå…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½overlayfsæ–‡ä»¶ç³»ç»Ÿ

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 5%

## è¯¦æƒ…

CVE-2021-3493 æ¼æ´å­˜åœ¨äº Linux Kernel çš„ OverlayFS å®ç°ä¸­ã€‚åœ¨Ubuntuå†…æ ¸ä¸­ï¼Œç”±äºå…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½ overlayfs ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨ä¸æ­£ç¡®çš„æƒé™éªŒè¯æœºåˆ¶ï¼Œç»“åˆéç‰¹æƒç”¨æˆ·å‘½åç©ºé—´ï¼Œåœ¨åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸Šè®¾ç½®æ–‡ä»¶ capabilitiesï¼Œä»è€Œè·å¾—æå‡çš„æƒé™ã€‚æä¾›çš„POCä»£ç åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼Œå¹¶å°è¯•æŒ‚è½½overlayfsæ–‡ä»¶ç³»ç»Ÿï¼Œç„¶ååˆ›å»ºæ¶æ„æ–‡ä»¶ï¼Œå¹¶è®¾ç½®suidæƒé™ï¼Œè¾¾åˆ°æƒé™æå‡çš„ç›®çš„ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**
æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’ŒPOCä»£ç ï¼Œæ­¤æ¼æ´åˆ©ç”¨åœ¨ç‰¹å®šUbuntuå†…æ ¸ç‰ˆæœ¬ä¸Šæ˜¯æœ‰æ•ˆçš„ï¼Œå› ä¸ºè¿™äº›ç‰ˆæœ¬åŒæ—¶å¯ç”¨äº†éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å’Œéç‰¹æƒoverlayfsæŒ‚è½½ã€‚

**æŠ•æ¯’é£é™©è¯„ä¼°ï¼š**
POCä»£ç ä¸»è¦æ˜¯åˆ›å»ºç›®å½•ï¼ŒæŒ‚è½½æ–‡ä»¶ç³»ç»Ÿï¼Œä»¥åŠè®¾ç½®ä¸€äº›æ–‡ä»¶æƒé™ï¼Œæ€»ä½“æ¥è¯´ä»£ç é‡ä¸å¤§ï¼Œé€»è¾‘æ¯”è¾ƒæ¸…æ™°ï¼Œæ²¡æœ‰æ˜æ˜¾çš„æŠ•æ¯’è¡Œä¸ºã€‚å¯èƒ½å­˜åœ¨çš„é£é™©åœ¨äºç¼–è¯‘åçš„äºŒè¿›åˆ¶æ–‡ä»¶å¯èƒ½ä¼šè¢«ç”¨äºå…¶ä»–æ¶æ„ç›®çš„ï¼Œä½†è¿™ä¸æ˜¯ä»£ç æœ¬èº«çš„æŠ•æ¯’ã€‚é£é™©è¯„ä¼°ä¸º5%ä¸»è¦æ˜¯è€ƒè™‘åˆ°ä»»ä½•ä»£ç éƒ½å¯èƒ½è¢«æ»¥ç”¨ï¼Œè€Œéä»£ç æœ¬èº«å­˜åœ¨æ¶æ„é€»è¾‘ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  **ç¯å¢ƒå‡†å¤‡:** åˆ›å»º lower, upper, work, overlay ç›®å½•ã€‚
2.  **æ–‡ä»¶ç³»ç»ŸæŒ‚è½½:** ä½¿ç”¨ OverlayFS å°† lower å’Œ upper ç›®å½•æŒ‚è½½åˆ° overlay ç›®å½•ã€‚
3.  **æƒé™è®¾ç½®:** åœ¨ overlay ç›®å½•ä¸­åˆ›å»ºæ¶æ„æ–‡ä»¶å¹¶è®¾ç½® suid æƒé™ï¼Œå› ä¸ºoverlayfs æ²¡æœ‰æ­£ç¡®æ ¡éªŒæ–‡ä»¶capabilities ï¼Œå› æ­¤å¯ä»¥å°†æƒé™èµ‹äºˆæ–‡ä»¶ã€‚
4.  **æƒé™æå‡:** æ‰§è¡Œæ¶æ„æ–‡ä»¶ï¼Œç”±äº suid æƒé™ï¼Œå¯ä»¥æå‡åˆ°æ–‡ä»¶æ‹¥æœ‰è€…çš„æƒé™ï¼ˆé€šå¸¸æ˜¯rootï¼‰ã€‚

**é¡¹ç›®åœ°å€:** [spideyctf/UbuntuTouchSecurityVAPTReport](https://github.com/spideyctf/UbuntuTouchSecurityVAPTReport)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---



---

## POC #15

**æ¥æº**: [CVE-2021-3493-spideyctf_UbuntuTouchSecurityVAPTReport.md](../2021/CVE-2021-3493-spideyctf_UbuntuTouchSecurityVAPTReport.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æƒé™æå‡

**å½±å“åº”ç”¨:** Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´ä»æ™®é€šç”¨æˆ·æå‡åˆ°rootæƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu kernels < 5.8.0-50.56, < 5.4.0-72.80, < 4.15.0-142.146, < 4.4.0-209.241

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç›®æ ‡ç³»ç»Ÿè¿è¡Œå­˜åœ¨æ¼æ´çš„Ubuntuå†…æ ¸ç‰ˆæœ¬ï¼Œå¹¶å¯ç”¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´ä»¥åŠå…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½overlayfsæ–‡ä»¶ç³»ç»Ÿ

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 5%

## è¯¦æƒ…

CVE-2021-3493 æ¼æ´å­˜åœ¨äº Linux Kernel çš„ OverlayFS å®ç°ä¸­ã€‚åœ¨Ubuntuå†…æ ¸ä¸­ï¼Œç”±äºå…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½ overlayfs ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨ä¸æ­£ç¡®çš„æƒé™éªŒè¯æœºåˆ¶ï¼Œç»“åˆéç‰¹æƒç”¨æˆ·å‘½åç©ºé—´ï¼Œåœ¨åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸Šè®¾ç½®æ–‡ä»¶ capabilitiesï¼Œä»è€Œè·å¾—æå‡çš„æƒé™ã€‚æä¾›çš„POCä»£ç åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼Œå¹¶å°è¯•æŒ‚è½½overlayfsæ–‡ä»¶ç³»ç»Ÿï¼Œç„¶ååˆ›å»ºæ¶æ„æ–‡ä»¶ï¼Œå¹¶è®¾ç½®suidæƒé™ï¼Œè¾¾åˆ°æƒé™æå‡çš„ç›®çš„ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**
æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’ŒPOCä»£ç ï¼Œæ­¤æ¼æ´åˆ©ç”¨åœ¨ç‰¹å®šUbuntuå†…æ ¸ç‰ˆæœ¬ä¸Šæ˜¯æœ‰æ•ˆçš„ï¼Œå› ä¸ºè¿™äº›ç‰ˆæœ¬åŒæ—¶å¯ç”¨äº†éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å’Œéç‰¹æƒoverlayfsæŒ‚è½½ã€‚

**æŠ•æ¯’é£é™©è¯„ä¼°ï¼š**
POCä»£ç ä¸»è¦æ˜¯åˆ›å»ºç›®å½•ï¼ŒæŒ‚è½½æ–‡ä»¶ç³»ç»Ÿï¼Œä»¥åŠè®¾ç½®ä¸€äº›æ–‡ä»¶æƒé™ï¼Œæ€»ä½“æ¥è¯´ä»£ç é‡ä¸å¤§ï¼Œé€»è¾‘æ¯”è¾ƒæ¸…æ™°ï¼Œæ²¡æœ‰æ˜æ˜¾çš„æŠ•æ¯’è¡Œä¸ºã€‚å¯èƒ½å­˜åœ¨çš„é£é™©åœ¨äºç¼–è¯‘åçš„äºŒè¿›åˆ¶æ–‡ä»¶å¯èƒ½ä¼šè¢«ç”¨äºå…¶ä»–æ¶æ„ç›®çš„ï¼Œä½†è¿™ä¸æ˜¯ä»£ç æœ¬èº«çš„æŠ•æ¯’ã€‚é£é™©è¯„ä¼°ä¸º5%ä¸»è¦æ˜¯è€ƒè™‘åˆ°ä»»ä½•ä»£ç éƒ½å¯èƒ½è¢«æ»¥ç”¨ï¼Œè€Œéä»£ç æœ¬èº«å­˜åœ¨æ¶æ„é€»è¾‘ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  **ç¯å¢ƒå‡†å¤‡:** åˆ›å»º lower, upper, work, overlay ç›®å½•ã€‚
2.  **æ–‡ä»¶ç³»ç»ŸæŒ‚è½½:** ä½¿ç”¨ OverlayFS å°† lower å’Œ upper ç›®å½•æŒ‚è½½åˆ° overlay ç›®å½•ã€‚
3.  **æƒé™è®¾ç½®:** åœ¨ overlay ç›®å½•ä¸­åˆ›å»ºæ¶æ„æ–‡ä»¶å¹¶è®¾ç½® suid æƒé™ï¼Œå› ä¸ºoverlayfs æ²¡æœ‰æ­£ç¡®æ ¡éªŒæ–‡ä»¶capabilities ï¼Œå› æ­¤å¯ä»¥å°†æƒé™èµ‹äºˆæ–‡ä»¶ã€‚
4.  **æƒé™æå‡:** æ‰§è¡Œæ¶æ„æ–‡ä»¶ï¼Œç”±äº suid æƒé™ï¼Œå¯ä»¥æå‡åˆ°æ–‡ä»¶æ‹¥æœ‰è€…çš„æƒé™ï¼ˆé€šå¸¸æ˜¯rootï¼‰ã€‚

**é¡¹ç›®åœ°å€:** [spideyctf/UbuntuTouchSecurityVAPTReport](https://github.com/spideyctf/UbuntuTouchSecurityVAPTReport)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---



---

## POC #15

**æ¥æº**: [CVE-2021-3493-spideyctf_UbuntuTouchSecurityVAPTReport.md](../2021/CVE-2021-3493-spideyctf_UbuntuTouchSecurityVAPTReport.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æƒé™æå‡

**å½±å“åº”ç”¨:** Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´ä»æ™®é€šç”¨æˆ·æå‡åˆ°rootæƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu kernels < 5.8.0-50.56, < 5.4.0-72.80, < 4.15.0-142.146, < 4.4.0-209.241

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç›®æ ‡ç³»ç»Ÿè¿è¡Œå­˜åœ¨æ¼æ´çš„Ubuntuå†…æ ¸ç‰ˆæœ¬ï¼Œå¹¶å¯ç”¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´ä»¥åŠå…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½overlayfsæ–‡ä»¶ç³»ç»Ÿ

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 5%

## è¯¦æƒ…

CVE-2021-3493 æ¼æ´å­˜åœ¨äº Linux Kernel çš„ OverlayFS å®ç°ä¸­ã€‚åœ¨Ubuntuå†…æ ¸ä¸­ï¼Œç”±äºå…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½ overlayfs ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨ä¸æ­£ç¡®çš„æƒé™éªŒè¯æœºåˆ¶ï¼Œç»“åˆéç‰¹æƒç”¨æˆ·å‘½åç©ºé—´ï¼Œåœ¨åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸Šè®¾ç½®æ–‡ä»¶ capabilitiesï¼Œä»è€Œè·å¾—æå‡çš„æƒé™ã€‚æä¾›çš„POCä»£ç åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼Œå¹¶å°è¯•æŒ‚è½½overlayfsæ–‡ä»¶ç³»ç»Ÿï¼Œç„¶ååˆ›å»ºæ¶æ„æ–‡ä»¶ï¼Œå¹¶è®¾ç½®suidæƒé™ï¼Œè¾¾åˆ°æƒé™æå‡çš„ç›®çš„ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**
æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’ŒPOCä»£ç ï¼Œæ­¤æ¼æ´åˆ©ç”¨åœ¨ç‰¹å®šUbuntuå†…æ ¸ç‰ˆæœ¬ä¸Šæ˜¯æœ‰æ•ˆçš„ï¼Œå› ä¸ºè¿™äº›ç‰ˆæœ¬åŒæ—¶å¯ç”¨äº†éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å’Œéç‰¹æƒoverlayfsæŒ‚è½½ã€‚

**æŠ•æ¯’é£é™©è¯„ä¼°ï¼š**
POCä»£ç ä¸»è¦æ˜¯åˆ›å»ºç›®å½•ï¼ŒæŒ‚è½½æ–‡ä»¶ç³»ç»Ÿï¼Œä»¥åŠè®¾ç½®ä¸€äº›æ–‡ä»¶æƒé™ï¼Œæ€»ä½“æ¥è¯´ä»£ç é‡ä¸å¤§ï¼Œé€»è¾‘æ¯”è¾ƒæ¸…æ™°ï¼Œæ²¡æœ‰æ˜æ˜¾çš„æŠ•æ¯’è¡Œä¸ºã€‚å¯èƒ½å­˜åœ¨çš„é£é™©åœ¨äºç¼–è¯‘åçš„äºŒè¿›åˆ¶æ–‡ä»¶å¯èƒ½ä¼šè¢«ç”¨äºå…¶ä»–æ¶æ„ç›®çš„ï¼Œä½†è¿™ä¸æ˜¯ä»£ç æœ¬èº«çš„æŠ•æ¯’ã€‚é£é™©è¯„ä¼°ä¸º5%ä¸»è¦æ˜¯è€ƒè™‘åˆ°ä»»ä½•ä»£ç éƒ½å¯èƒ½è¢«æ»¥ç”¨ï¼Œè€Œéä»£ç æœ¬èº«å­˜åœ¨æ¶æ„é€»è¾‘ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  **ç¯å¢ƒå‡†å¤‡:** åˆ›å»º lower, upper, work, overlay ç›®å½•ã€‚
2.  **æ–‡ä»¶ç³»ç»ŸæŒ‚è½½:** ä½¿ç”¨ OverlayFS å°† lower å’Œ upper ç›®å½•æŒ‚è½½åˆ° overlay ç›®å½•ã€‚
3.  **æƒé™è®¾ç½®:** åœ¨ overlay ç›®å½•ä¸­åˆ›å»ºæ¶æ„æ–‡ä»¶å¹¶è®¾ç½® suid æƒé™ï¼Œå› ä¸ºoverlayfs æ²¡æœ‰æ­£ç¡®æ ¡éªŒæ–‡ä»¶capabilities ï¼Œå› æ­¤å¯ä»¥å°†æƒé™èµ‹äºˆæ–‡ä»¶ã€‚
4.  **æƒé™æå‡:** æ‰§è¡Œæ¶æ„æ–‡ä»¶ï¼Œç”±äº suid æƒé™ï¼Œå¯ä»¥æå‡åˆ°æ–‡ä»¶æ‹¥æœ‰è€…çš„æƒé™ï¼ˆé€šå¸¸æ˜¯rootï¼‰ã€‚

**é¡¹ç›®åœ°å€:** [spideyctf/UbuntuTouchSecurityVAPTReport](https://github.com/spideyctf/UbuntuTouchSecurityVAPTReport)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---



---

## POC #15

**æ¥æº**: [CVE-2021-3493-spideyctf_UbuntuTouchSecurityVAPTReport.md](../2021/CVE-2021-3493-spideyctf_UbuntuTouchSecurityVAPTReport.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æƒé™æå‡

**å½±å“åº”ç”¨:** Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´ä»æ™®é€šç”¨æˆ·æå‡åˆ°rootæƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu kernels < 5.8.0-50.56, < 5.4.0-72.80, < 4.15.0-142.146, < 4.4.0-209.241

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç›®æ ‡ç³»ç»Ÿè¿è¡Œå­˜åœ¨æ¼æ´çš„Ubuntuå†…æ ¸ç‰ˆæœ¬ï¼Œå¹¶å¯ç”¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´ä»¥åŠå…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½overlayfsæ–‡ä»¶ç³»ç»Ÿ

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 5%

## è¯¦æƒ…

CVE-2021-3493 æ¼æ´å­˜åœ¨äº Linux Kernel çš„ OverlayFS å®ç°ä¸­ã€‚åœ¨Ubuntuå†…æ ¸ä¸­ï¼Œç”±äºå…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½ overlayfs ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨ä¸æ­£ç¡®çš„æƒé™éªŒè¯æœºåˆ¶ï¼Œç»“åˆéç‰¹æƒç”¨æˆ·å‘½åç©ºé—´ï¼Œåœ¨åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸Šè®¾ç½®æ–‡ä»¶ capabilitiesï¼Œä»è€Œè·å¾—æå‡çš„æƒé™ã€‚æä¾›çš„POCä»£ç åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼Œå¹¶å°è¯•æŒ‚è½½overlayfsæ–‡ä»¶ç³»ç»Ÿï¼Œç„¶ååˆ›å»ºæ¶æ„æ–‡ä»¶ï¼Œå¹¶è®¾ç½®suidæƒé™ï¼Œè¾¾åˆ°æƒé™æå‡çš„ç›®çš„ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**
æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’ŒPOCä»£ç ï¼Œæ­¤æ¼æ´åˆ©ç”¨åœ¨ç‰¹å®šUbuntuå†…æ ¸ç‰ˆæœ¬ä¸Šæ˜¯æœ‰æ•ˆçš„ï¼Œå› ä¸ºè¿™äº›ç‰ˆæœ¬åŒæ—¶å¯ç”¨äº†éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å’Œéç‰¹æƒoverlayfsæŒ‚è½½ã€‚

**æŠ•æ¯’é£é™©è¯„ä¼°ï¼š**
POCä»£ç ä¸»è¦æ˜¯åˆ›å»ºç›®å½•ï¼ŒæŒ‚è½½æ–‡ä»¶ç³»ç»Ÿï¼Œä»¥åŠè®¾ç½®ä¸€äº›æ–‡ä»¶æƒé™ï¼Œæ€»ä½“æ¥è¯´ä»£ç é‡ä¸å¤§ï¼Œé€»è¾‘æ¯”è¾ƒæ¸…æ™°ï¼Œæ²¡æœ‰æ˜æ˜¾çš„æŠ•æ¯’è¡Œä¸ºã€‚å¯èƒ½å­˜åœ¨çš„é£é™©åœ¨äºç¼–è¯‘åçš„äºŒè¿›åˆ¶æ–‡ä»¶å¯èƒ½ä¼šè¢«ç”¨äºå…¶ä»–æ¶æ„ç›®çš„ï¼Œä½†è¿™ä¸æ˜¯ä»£ç æœ¬èº«çš„æŠ•æ¯’ã€‚é£é™©è¯„ä¼°ä¸º5%ä¸»è¦æ˜¯è€ƒè™‘åˆ°ä»»ä½•ä»£ç éƒ½å¯èƒ½è¢«æ»¥ç”¨ï¼Œè€Œéä»£ç æœ¬èº«å­˜åœ¨æ¶æ„é€»è¾‘ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  **ç¯å¢ƒå‡†å¤‡:** åˆ›å»º lower, upper, work, overlay ç›®å½•ã€‚
2.  **æ–‡ä»¶ç³»ç»ŸæŒ‚è½½:** ä½¿ç”¨ OverlayFS å°† lower å’Œ upper ç›®å½•æŒ‚è½½åˆ° overlay ç›®å½•ã€‚
3.  **æƒé™è®¾ç½®:** åœ¨ overlay ç›®å½•ä¸­åˆ›å»ºæ¶æ„æ–‡ä»¶å¹¶è®¾ç½® suid æƒé™ï¼Œå› ä¸ºoverlayfs æ²¡æœ‰æ­£ç¡®æ ¡éªŒæ–‡ä»¶capabilities ï¼Œå› æ­¤å¯ä»¥å°†æƒé™èµ‹äºˆæ–‡ä»¶ã€‚
4.  **æƒé™æå‡:** æ‰§è¡Œæ¶æ„æ–‡ä»¶ï¼Œç”±äº suid æƒé™ï¼Œå¯ä»¥æå‡åˆ°æ–‡ä»¶æ‹¥æœ‰è€…çš„æƒé™ï¼ˆé€šå¸¸æ˜¯rootï¼‰ã€‚

**é¡¹ç›®åœ°å€:** [spideyctf/UbuntuTouchSecurityVAPTReport](https://github.com/spideyctf/UbuntuTouchSecurityVAPTReport)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---



---

## POC #15

**æ¥æº**: [CVE-2021-3493-spideyctf_UbuntuTouchSecurityVAPTReport.md](../2021/CVE-2021-3493-spideyctf_UbuntuTouchSecurityVAPTReport.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æƒé™æå‡

**å½±å“åº”ç”¨:** Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´ä»æ™®é€šç”¨æˆ·æå‡åˆ°rootæƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu kernels < 5.8.0-50.56, < 5.4.0-72.80, < 4.15.0-142.146, < 4.4.0-209.241

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç›®æ ‡ç³»ç»Ÿè¿è¡Œå­˜åœ¨æ¼æ´çš„Ubuntuå†…æ ¸ç‰ˆæœ¬ï¼Œå¹¶å¯ç”¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´ä»¥åŠå…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½overlayfsæ–‡ä»¶ç³»ç»Ÿ

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 5%

## è¯¦æƒ…

CVE-2021-3493 æ¼æ´å­˜åœ¨äº Linux Kernel çš„ OverlayFS å®ç°ä¸­ã€‚åœ¨Ubuntuå†…æ ¸ä¸­ï¼Œç”±äºå…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½ overlayfs ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨ä¸æ­£ç¡®çš„æƒé™éªŒè¯æœºåˆ¶ï¼Œç»“åˆéç‰¹æƒç”¨æˆ·å‘½åç©ºé—´ï¼Œåœ¨åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸Šè®¾ç½®æ–‡ä»¶ capabilitiesï¼Œä»è€Œè·å¾—æå‡çš„æƒé™ã€‚æä¾›çš„POCä»£ç åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼Œå¹¶å°è¯•æŒ‚è½½overlayfsæ–‡ä»¶ç³»ç»Ÿï¼Œç„¶ååˆ›å»ºæ¶æ„æ–‡ä»¶ï¼Œå¹¶è®¾ç½®suidæƒé™ï¼Œè¾¾åˆ°æƒé™æå‡çš„ç›®çš„ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**
æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’ŒPOCä»£ç ï¼Œæ­¤æ¼æ´åˆ©ç”¨åœ¨ç‰¹å®šUbuntuå†…æ ¸ç‰ˆæœ¬ä¸Šæ˜¯æœ‰æ•ˆçš„ï¼Œå› ä¸ºè¿™äº›ç‰ˆæœ¬åŒæ—¶å¯ç”¨äº†éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å’Œéç‰¹æƒoverlayfsæŒ‚è½½ã€‚

**æŠ•æ¯’é£é™©è¯„ä¼°ï¼š**
POCä»£ç ä¸»è¦æ˜¯åˆ›å»ºç›®å½•ï¼ŒæŒ‚è½½æ–‡ä»¶ç³»ç»Ÿï¼Œä»¥åŠè®¾ç½®ä¸€äº›æ–‡ä»¶æƒé™ï¼Œæ€»ä½“æ¥è¯´ä»£ç é‡ä¸å¤§ï¼Œé€»è¾‘æ¯”è¾ƒæ¸…æ™°ï¼Œæ²¡æœ‰æ˜æ˜¾çš„æŠ•æ¯’è¡Œä¸ºã€‚å¯èƒ½å­˜åœ¨çš„é£é™©åœ¨äºç¼–è¯‘åçš„äºŒè¿›åˆ¶æ–‡ä»¶å¯èƒ½ä¼šè¢«ç”¨äºå…¶ä»–æ¶æ„ç›®çš„ï¼Œä½†è¿™ä¸æ˜¯ä»£ç æœ¬èº«çš„æŠ•æ¯’ã€‚é£é™©è¯„ä¼°ä¸º5%ä¸»è¦æ˜¯è€ƒè™‘åˆ°ä»»ä½•ä»£ç éƒ½å¯èƒ½è¢«æ»¥ç”¨ï¼Œè€Œéä»£ç æœ¬èº«å­˜åœ¨æ¶æ„é€»è¾‘ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  **ç¯å¢ƒå‡†å¤‡:** åˆ›å»º lower, upper, work, overlay ç›®å½•ã€‚
2.  **æ–‡ä»¶ç³»ç»ŸæŒ‚è½½:** ä½¿ç”¨ OverlayFS å°† lower å’Œ upper ç›®å½•æŒ‚è½½åˆ° overlay ç›®å½•ã€‚
3.  **æƒé™è®¾ç½®:** åœ¨ overlay ç›®å½•ä¸­åˆ›å»ºæ¶æ„æ–‡ä»¶å¹¶è®¾ç½® suid æƒé™ï¼Œå› ä¸ºoverlayfs æ²¡æœ‰æ­£ç¡®æ ¡éªŒæ–‡ä»¶capabilities ï¼Œå› æ­¤å¯ä»¥å°†æƒé™èµ‹äºˆæ–‡ä»¶ã€‚
4.  **æƒé™æå‡:** æ‰§è¡Œæ¶æ„æ–‡ä»¶ï¼Œç”±äº suid æƒé™ï¼Œå¯ä»¥æå‡åˆ°æ–‡ä»¶æ‹¥æœ‰è€…çš„æƒé™ï¼ˆé€šå¸¸æ˜¯rootï¼‰ã€‚

**é¡¹ç›®åœ°å€:** [spideyctf/UbuntuTouchSecurityVAPTReport](https://github.com/spideyctf/UbuntuTouchSecurityVAPTReport)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---



---

## POC #15

**æ¥æº**: [CVE-2021-3493-spideyctf_UbuntuTouchSecurityVAPTReport.md](../2021/CVE-2021-3493-spideyctf_UbuntuTouchSecurityVAPTReport.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æƒé™æå‡

**å½±å“åº”ç”¨:** Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´ä»æ™®é€šç”¨æˆ·æå‡åˆ°rootæƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu kernels < 5.8.0-50.56, < 5.4.0-72.80, < 4.15.0-142.146, < 4.4.0-209.241

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç›®æ ‡ç³»ç»Ÿè¿è¡Œå­˜åœ¨æ¼æ´çš„Ubuntuå†…æ ¸ç‰ˆæœ¬ï¼Œå¹¶å¯ç”¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´ä»¥åŠå…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½overlayfsæ–‡ä»¶ç³»ç»Ÿ

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 5%

## è¯¦æƒ…

CVE-2021-3493 æ¼æ´å­˜åœ¨äº Linux Kernel çš„ OverlayFS å®ç°ä¸­ã€‚åœ¨Ubuntuå†…æ ¸ä¸­ï¼Œç”±äºå…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½ overlayfs ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨ä¸æ­£ç¡®çš„æƒé™éªŒè¯æœºåˆ¶ï¼Œç»“åˆéç‰¹æƒç”¨æˆ·å‘½åç©ºé—´ï¼Œåœ¨åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸Šè®¾ç½®æ–‡ä»¶ capabilitiesï¼Œä»è€Œè·å¾—æå‡çš„æƒé™ã€‚æä¾›çš„POCä»£ç åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼Œå¹¶å°è¯•æŒ‚è½½overlayfsæ–‡ä»¶ç³»ç»Ÿï¼Œç„¶ååˆ›å»ºæ¶æ„æ–‡ä»¶ï¼Œå¹¶è®¾ç½®suidæƒé™ï¼Œè¾¾åˆ°æƒé™æå‡çš„ç›®çš„ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**
æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’ŒPOCä»£ç ï¼Œæ­¤æ¼æ´åˆ©ç”¨åœ¨ç‰¹å®šUbuntuå†…æ ¸ç‰ˆæœ¬ä¸Šæ˜¯æœ‰æ•ˆçš„ï¼Œå› ä¸ºè¿™äº›ç‰ˆæœ¬åŒæ—¶å¯ç”¨äº†éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å’Œéç‰¹æƒoverlayfsæŒ‚è½½ã€‚

**æŠ•æ¯’é£é™©è¯„ä¼°ï¼š**
POCä»£ç ä¸»è¦æ˜¯åˆ›å»ºç›®å½•ï¼ŒæŒ‚è½½æ–‡ä»¶ç³»ç»Ÿï¼Œä»¥åŠè®¾ç½®ä¸€äº›æ–‡ä»¶æƒé™ï¼Œæ€»ä½“æ¥è¯´ä»£ç é‡ä¸å¤§ï¼Œé€»è¾‘æ¯”è¾ƒæ¸…æ™°ï¼Œæ²¡æœ‰æ˜æ˜¾çš„æŠ•æ¯’è¡Œä¸ºã€‚å¯èƒ½å­˜åœ¨çš„é£é™©åœ¨äºç¼–è¯‘åçš„äºŒè¿›åˆ¶æ–‡ä»¶å¯èƒ½ä¼šè¢«ç”¨äºå…¶ä»–æ¶æ„ç›®çš„ï¼Œä½†è¿™ä¸æ˜¯ä»£ç æœ¬èº«çš„æŠ•æ¯’ã€‚é£é™©è¯„ä¼°ä¸º5%ä¸»è¦æ˜¯è€ƒè™‘åˆ°ä»»ä½•ä»£ç éƒ½å¯èƒ½è¢«æ»¥ç”¨ï¼Œè€Œéä»£ç æœ¬èº«å­˜åœ¨æ¶æ„é€»è¾‘ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  **ç¯å¢ƒå‡†å¤‡:** åˆ›å»º lower, upper, work, overlay ç›®å½•ã€‚
2.  **æ–‡ä»¶ç³»ç»ŸæŒ‚è½½:** ä½¿ç”¨ OverlayFS å°† lower å’Œ upper ç›®å½•æŒ‚è½½åˆ° overlay ç›®å½•ã€‚
3.  **æƒé™è®¾ç½®:** åœ¨ overlay ç›®å½•ä¸­åˆ›å»ºæ¶æ„æ–‡ä»¶å¹¶è®¾ç½® suid æƒé™ï¼Œå› ä¸ºoverlayfs æ²¡æœ‰æ­£ç¡®æ ¡éªŒæ–‡ä»¶capabilities ï¼Œå› æ­¤å¯ä»¥å°†æƒé™èµ‹äºˆæ–‡ä»¶ã€‚
4.  **æƒé™æå‡:** æ‰§è¡Œæ¶æ„æ–‡ä»¶ï¼Œç”±äº suid æƒé™ï¼Œå¯ä»¥æå‡åˆ°æ–‡ä»¶æ‹¥æœ‰è€…çš„æƒé™ï¼ˆé€šå¸¸æ˜¯rootï¼‰ã€‚

**é¡¹ç›®åœ°å€:** [spideyctf/UbuntuTouchSecurityVAPTReport](https://github.com/spideyctf/UbuntuTouchSecurityVAPTReport)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---



---

## POC #15

**æ¥æº**: [CVE-2021-3493-spideyctf_UbuntuTouchSecurityVAPTReport.md](../2021/CVE-2021-3493-spideyctf_UbuntuTouchSecurityVAPTReport.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æƒé™æå‡

**å½±å“åº”ç”¨:** Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´ä»æ™®é€šç”¨æˆ·æå‡åˆ°rootæƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu kernels < 5.8.0-50.56, < 5.4.0-72.80, < 4.15.0-142.146, < 4.4.0-209.241

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç›®æ ‡ç³»ç»Ÿè¿è¡Œå­˜åœ¨æ¼æ´çš„Ubuntuå†…æ ¸ç‰ˆæœ¬ï¼Œå¹¶å¯ç”¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´ä»¥åŠå…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½overlayfsæ–‡ä»¶ç³»ç»Ÿ

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 5%

## è¯¦æƒ…

CVE-2021-3493 æ¼æ´å­˜åœ¨äº Linux Kernel çš„ OverlayFS å®ç°ä¸­ã€‚åœ¨Ubuntuå†…æ ¸ä¸­ï¼Œç”±äºå…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½ overlayfs ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨ä¸æ­£ç¡®çš„æƒé™éªŒè¯æœºåˆ¶ï¼Œç»“åˆéç‰¹æƒç”¨æˆ·å‘½åç©ºé—´ï¼Œåœ¨åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸Šè®¾ç½®æ–‡ä»¶ capabilitiesï¼Œä»è€Œè·å¾—æå‡çš„æƒé™ã€‚æä¾›çš„POCä»£ç åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼Œå¹¶å°è¯•æŒ‚è½½overlayfsæ–‡ä»¶ç³»ç»Ÿï¼Œç„¶ååˆ›å»ºæ¶æ„æ–‡ä»¶ï¼Œå¹¶è®¾ç½®suidæƒé™ï¼Œè¾¾åˆ°æƒé™æå‡çš„ç›®çš„ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**
æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’ŒPOCä»£ç ï¼Œæ­¤æ¼æ´åˆ©ç”¨åœ¨ç‰¹å®šUbuntuå†…æ ¸ç‰ˆæœ¬ä¸Šæ˜¯æœ‰æ•ˆçš„ï¼Œå› ä¸ºè¿™äº›ç‰ˆæœ¬åŒæ—¶å¯ç”¨äº†éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å’Œéç‰¹æƒoverlayfsæŒ‚è½½ã€‚

**æŠ•æ¯’é£é™©è¯„ä¼°ï¼š**
POCä»£ç ä¸»è¦æ˜¯åˆ›å»ºç›®å½•ï¼ŒæŒ‚è½½æ–‡ä»¶ç³»ç»Ÿï¼Œä»¥åŠè®¾ç½®ä¸€äº›æ–‡ä»¶æƒé™ï¼Œæ€»ä½“æ¥è¯´ä»£ç é‡ä¸å¤§ï¼Œé€»è¾‘æ¯”è¾ƒæ¸…æ™°ï¼Œæ²¡æœ‰æ˜æ˜¾çš„æŠ•æ¯’è¡Œä¸ºã€‚å¯èƒ½å­˜åœ¨çš„é£é™©åœ¨äºç¼–è¯‘åçš„äºŒè¿›åˆ¶æ–‡ä»¶å¯èƒ½ä¼šè¢«ç”¨äºå…¶ä»–æ¶æ„ç›®çš„ï¼Œä½†è¿™ä¸æ˜¯ä»£ç æœ¬èº«çš„æŠ•æ¯’ã€‚é£é™©è¯„ä¼°ä¸º5%ä¸»è¦æ˜¯è€ƒè™‘åˆ°ä»»ä½•ä»£ç éƒ½å¯èƒ½è¢«æ»¥ç”¨ï¼Œè€Œéä»£ç æœ¬èº«å­˜åœ¨æ¶æ„é€»è¾‘ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  **ç¯å¢ƒå‡†å¤‡:** åˆ›å»º lower, upper, work, overlay ç›®å½•ã€‚
2.  **æ–‡ä»¶ç³»ç»ŸæŒ‚è½½:** ä½¿ç”¨ OverlayFS å°† lower å’Œ upper ç›®å½•æŒ‚è½½åˆ° overlay ç›®å½•ã€‚
3.  **æƒé™è®¾ç½®:** åœ¨ overlay ç›®å½•ä¸­åˆ›å»ºæ¶æ„æ–‡ä»¶å¹¶è®¾ç½® suid æƒé™ï¼Œå› ä¸ºoverlayfs æ²¡æœ‰æ­£ç¡®æ ¡éªŒæ–‡ä»¶capabilities ï¼Œå› æ­¤å¯ä»¥å°†æƒé™èµ‹äºˆæ–‡ä»¶ã€‚
4.  **æƒé™æå‡:** æ‰§è¡Œæ¶æ„æ–‡ä»¶ï¼Œç”±äº suid æƒé™ï¼Œå¯ä»¥æå‡åˆ°æ–‡ä»¶æ‹¥æœ‰è€…çš„æƒé™ï¼ˆé€šå¸¸æ˜¯rootï¼‰ã€‚

**é¡¹ç›®åœ°å€:** [spideyctf/UbuntuTouchSecurityVAPTReport](https://github.com/spideyctf/UbuntuTouchSecurityVAPTReport)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---



---

## POC #15

**æ¥æº**: [CVE-2021-3493-spideyctf_UbuntuTouchSecurityVAPTReport.md](../2021/CVE-2021-3493-spideyctf_UbuntuTouchSecurityVAPTReport.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æƒé™æå‡

**å½±å“åº”ç”¨:** Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´ä»æ™®é€šç”¨æˆ·æå‡åˆ°rootæƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu kernels < 5.8.0-50.56, < 5.4.0-72.80, < 4.15.0-142.146, < 4.4.0-209.241

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç›®æ ‡ç³»ç»Ÿè¿è¡Œå­˜åœ¨æ¼æ´çš„Ubuntuå†…æ ¸ç‰ˆæœ¬ï¼Œå¹¶å¯ç”¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´ä»¥åŠå…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½overlayfsæ–‡ä»¶ç³»ç»Ÿ

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 5%

## è¯¦æƒ…

CVE-2021-3493 æ¼æ´å­˜åœ¨äº Linux Kernel çš„ OverlayFS å®ç°ä¸­ã€‚åœ¨Ubuntuå†…æ ¸ä¸­ï¼Œç”±äºå…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½ overlayfs ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨ä¸æ­£ç¡®çš„æƒé™éªŒè¯æœºåˆ¶ï¼Œç»“åˆéç‰¹æƒç”¨æˆ·å‘½åç©ºé—´ï¼Œåœ¨åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸Šè®¾ç½®æ–‡ä»¶ capabilitiesï¼Œä»è€Œè·å¾—æå‡çš„æƒé™ã€‚æä¾›çš„POCä»£ç åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼Œå¹¶å°è¯•æŒ‚è½½overlayfsæ–‡ä»¶ç³»ç»Ÿï¼Œç„¶ååˆ›å»ºæ¶æ„æ–‡ä»¶ï¼Œå¹¶è®¾ç½®suidæƒé™ï¼Œè¾¾åˆ°æƒé™æå‡çš„ç›®çš„ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**
æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’ŒPOCä»£ç ï¼Œæ­¤æ¼æ´åˆ©ç”¨åœ¨ç‰¹å®šUbuntuå†…æ ¸ç‰ˆæœ¬ä¸Šæ˜¯æœ‰æ•ˆçš„ï¼Œå› ä¸ºè¿™äº›ç‰ˆæœ¬åŒæ—¶å¯ç”¨äº†éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å’Œéç‰¹æƒoverlayfsæŒ‚è½½ã€‚

**æŠ•æ¯’é£é™©è¯„ä¼°ï¼š**
POCä»£ç ä¸»è¦æ˜¯åˆ›å»ºç›®å½•ï¼ŒæŒ‚è½½æ–‡ä»¶ç³»ç»Ÿï¼Œä»¥åŠè®¾ç½®ä¸€äº›æ–‡ä»¶æƒé™ï¼Œæ€»ä½“æ¥è¯´ä»£ç é‡ä¸å¤§ï¼Œé€»è¾‘æ¯”è¾ƒæ¸…æ™°ï¼Œæ²¡æœ‰æ˜æ˜¾çš„æŠ•æ¯’è¡Œä¸ºã€‚å¯èƒ½å­˜åœ¨çš„é£é™©åœ¨äºç¼–è¯‘åçš„äºŒè¿›åˆ¶æ–‡ä»¶å¯èƒ½ä¼šè¢«ç”¨äºå…¶ä»–æ¶æ„ç›®çš„ï¼Œä½†è¿™ä¸æ˜¯ä»£ç æœ¬èº«çš„æŠ•æ¯’ã€‚é£é™©è¯„ä¼°ä¸º5%ä¸»è¦æ˜¯è€ƒè™‘åˆ°ä»»ä½•ä»£ç éƒ½å¯èƒ½è¢«æ»¥ç”¨ï¼Œè€Œéä»£ç æœ¬èº«å­˜åœ¨æ¶æ„é€»è¾‘ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  **ç¯å¢ƒå‡†å¤‡:** åˆ›å»º lower, upper, work, overlay ç›®å½•ã€‚
2.  **æ–‡ä»¶ç³»ç»ŸæŒ‚è½½:** ä½¿ç”¨ OverlayFS å°† lower å’Œ upper ç›®å½•æŒ‚è½½åˆ° overlay ç›®å½•ã€‚
3.  **æƒé™è®¾ç½®:** åœ¨ overlay ç›®å½•ä¸­åˆ›å»ºæ¶æ„æ–‡ä»¶å¹¶è®¾ç½® suid æƒé™ï¼Œå› ä¸ºoverlayfs æ²¡æœ‰æ­£ç¡®æ ¡éªŒæ–‡ä»¶capabilities ï¼Œå› æ­¤å¯ä»¥å°†æƒé™èµ‹äºˆæ–‡ä»¶ã€‚
4.  **æƒé™æå‡:** æ‰§è¡Œæ¶æ„æ–‡ä»¶ï¼Œç”±äº suid æƒé™ï¼Œå¯ä»¥æå‡åˆ°æ–‡ä»¶æ‹¥æœ‰è€…çš„æƒé™ï¼ˆé€šå¸¸æ˜¯rootï¼‰ã€‚

**é¡¹ç›®åœ°å€:** [spideyctf/UbuntuTouchSecurityVAPTReport](https://github.com/spideyctf/UbuntuTouchSecurityVAPTReport)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---



---

## POC #15

**æ¥æº**: [CVE-2021-3493-spideyctf_UbuntuTouchSecurityVAPTReport.md](../2021/CVE-2021-3493-spideyctf_UbuntuTouchSecurityVAPTReport.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æƒé™æå‡

**å½±å“åº”ç”¨:** Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´ä»æ™®é€šç”¨æˆ·æå‡åˆ°rootæƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu kernels < 5.8.0-50.56, < 5.4.0-72.80, < 4.15.0-142.146, < 4.4.0-209.241

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç›®æ ‡ç³»ç»Ÿè¿è¡Œå­˜åœ¨æ¼æ´çš„Ubuntuå†…æ ¸ç‰ˆæœ¬ï¼Œå¹¶å¯ç”¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´ä»¥åŠå…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½overlayfsæ–‡ä»¶ç³»ç»Ÿ

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 5%

## è¯¦æƒ…

CVE-2021-3493 æ¼æ´å­˜åœ¨äº Linux Kernel çš„ OverlayFS å®ç°ä¸­ã€‚åœ¨Ubuntuå†…æ ¸ä¸­ï¼Œç”±äºå…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½ overlayfs ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨ä¸æ­£ç¡®çš„æƒé™éªŒè¯æœºåˆ¶ï¼Œç»“åˆéç‰¹æƒç”¨æˆ·å‘½åç©ºé—´ï¼Œåœ¨åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸Šè®¾ç½®æ–‡ä»¶ capabilitiesï¼Œä»è€Œè·å¾—æå‡çš„æƒé™ã€‚æä¾›çš„POCä»£ç åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼Œå¹¶å°è¯•æŒ‚è½½overlayfsæ–‡ä»¶ç³»ç»Ÿï¼Œç„¶ååˆ›å»ºæ¶æ„æ–‡ä»¶ï¼Œå¹¶è®¾ç½®suidæƒé™ï¼Œè¾¾åˆ°æƒé™æå‡çš„ç›®çš„ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**
æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’ŒPOCä»£ç ï¼Œæ­¤æ¼æ´åˆ©ç”¨åœ¨ç‰¹å®šUbuntuå†…æ ¸ç‰ˆæœ¬ä¸Šæ˜¯æœ‰æ•ˆçš„ï¼Œå› ä¸ºè¿™äº›ç‰ˆæœ¬åŒæ—¶å¯ç”¨äº†éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å’Œéç‰¹æƒoverlayfsæŒ‚è½½ã€‚

**æŠ•æ¯’é£é™©è¯„ä¼°ï¼š**
POCä»£ç ä¸»è¦æ˜¯åˆ›å»ºç›®å½•ï¼ŒæŒ‚è½½æ–‡ä»¶ç³»ç»Ÿï¼Œä»¥åŠè®¾ç½®ä¸€äº›æ–‡ä»¶æƒé™ï¼Œæ€»ä½“æ¥è¯´ä»£ç é‡ä¸å¤§ï¼Œé€»è¾‘æ¯”è¾ƒæ¸…æ™°ï¼Œæ²¡æœ‰æ˜æ˜¾çš„æŠ•æ¯’è¡Œä¸ºã€‚å¯èƒ½å­˜åœ¨çš„é£é™©åœ¨äºç¼–è¯‘åçš„äºŒè¿›åˆ¶æ–‡ä»¶å¯èƒ½ä¼šè¢«ç”¨äºå…¶ä»–æ¶æ„ç›®çš„ï¼Œä½†è¿™ä¸æ˜¯ä»£ç æœ¬èº«çš„æŠ•æ¯’ã€‚é£é™©è¯„ä¼°ä¸º5%ä¸»è¦æ˜¯è€ƒè™‘åˆ°ä»»ä½•ä»£ç éƒ½å¯èƒ½è¢«æ»¥ç”¨ï¼Œè€Œéä»£ç æœ¬èº«å­˜åœ¨æ¶æ„é€»è¾‘ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  **ç¯å¢ƒå‡†å¤‡:** åˆ›å»º lower, upper, work, overlay ç›®å½•ã€‚
2.  **æ–‡ä»¶ç³»ç»ŸæŒ‚è½½:** ä½¿ç”¨ OverlayFS å°† lower å’Œ upper ç›®å½•æŒ‚è½½åˆ° overlay ç›®å½•ã€‚
3.  **æƒé™è®¾ç½®:** åœ¨ overlay ç›®å½•ä¸­åˆ›å»ºæ¶æ„æ–‡ä»¶å¹¶è®¾ç½® suid æƒé™ï¼Œå› ä¸ºoverlayfs æ²¡æœ‰æ­£ç¡®æ ¡éªŒæ–‡ä»¶capabilities ï¼Œå› æ­¤å¯ä»¥å°†æƒé™èµ‹äºˆæ–‡ä»¶ã€‚
4.  **æƒé™æå‡:** æ‰§è¡Œæ¶æ„æ–‡ä»¶ï¼Œç”±äº suid æƒé™ï¼Œå¯ä»¥æå‡åˆ°æ–‡ä»¶æ‹¥æœ‰è€…çš„æƒé™ï¼ˆé€šå¸¸æ˜¯rootï¼‰ã€‚

**é¡¹ç›®åœ°å€:** [spideyctf/UbuntuTouchSecurityVAPTReport](https://github.com/spideyctf/UbuntuTouchSecurityVAPTReport)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---



---

## POC #15

**æ¥æº**: [CVE-2021-3493-spideyctf_UbuntuTouchSecurityVAPTReport.md](../2021/CVE-2021-3493-spideyctf_UbuntuTouchSecurityVAPTReport.md)

## CVE-2021-3493-Ubuntu OverlayFS æœ¬åœ°ææƒ

**æ¼æ´ç¼–å·:** CVE-2021-3493

**æ¼æ´ç±»å‹:** æƒé™æå‡

**å½±å“åº”ç”¨:** Linux Kernel (OverlayFS)

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´ä»æ™®é€šç”¨æˆ·æå‡åˆ°rootæƒé™

**å½±å“ç‰ˆæœ¬:** Ubuntu kernels < 5.8.0-50.56, < 5.4.0-72.80, < 4.15.0-142.146, < 4.4.0-209.241

**åˆ©ç”¨æ¡ä»¶:** éœ€è¦ç›®æ ‡ç³»ç»Ÿè¿è¡Œå­˜åœ¨æ¼æ´çš„Ubuntuå†…æ ¸ç‰ˆæœ¬ï¼Œå¹¶å¯ç”¨éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´ä»¥åŠå…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½overlayfsæ–‡ä»¶ç³»ç»Ÿ

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 5%

## è¯¦æƒ…

CVE-2021-3493 æ¼æ´å­˜åœ¨äº Linux Kernel çš„ OverlayFS å®ç°ä¸­ã€‚åœ¨Ubuntuå†…æ ¸ä¸­ï¼Œç”±äºå…è®¸éç‰¹æƒç”¨æˆ·æŒ‚è½½ overlayfs ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨ä¸æ­£ç¡®çš„æƒé™éªŒè¯æœºåˆ¶ï¼Œç»“åˆéç‰¹æƒç”¨æˆ·å‘½åç©ºé—´ï¼Œåœ¨åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸Šè®¾ç½®æ–‡ä»¶ capabilitiesï¼Œä»è€Œè·å¾—æå‡çš„æƒé™ã€‚æä¾›çš„POCä»£ç åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼Œå¹¶å°è¯•æŒ‚è½½overlayfsæ–‡ä»¶ç³»ç»Ÿï¼Œç„¶ååˆ›å»ºæ¶æ„æ–‡ä»¶ï¼Œå¹¶è®¾ç½®suidæƒé™ï¼Œè¾¾åˆ°æƒé™æå‡çš„ç›®çš„ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**
æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’ŒPOCä»£ç ï¼Œæ­¤æ¼æ´åˆ©ç”¨åœ¨ç‰¹å®šUbuntuå†…æ ¸ç‰ˆæœ¬ä¸Šæ˜¯æœ‰æ•ˆçš„ï¼Œå› ä¸ºè¿™äº›ç‰ˆæœ¬åŒæ—¶å¯ç”¨äº†éç‰¹æƒç”¨æˆ·å‘½åç©ºé—´å’Œéç‰¹æƒoverlayfsæŒ‚è½½ã€‚

**æŠ•æ¯’é£é™©è¯„ä¼°ï¼š**
POCä»£ç ä¸»è¦æ˜¯åˆ›å»ºç›®å½•ï¼ŒæŒ‚è½½æ–‡ä»¶ç³»ç»Ÿï¼Œä»¥åŠè®¾ç½®ä¸€äº›æ–‡ä»¶æƒé™ï¼Œæ€»ä½“æ¥è¯´ä»£ç é‡ä¸å¤§ï¼Œé€»è¾‘æ¯”è¾ƒæ¸…æ™°ï¼Œæ²¡æœ‰æ˜æ˜¾çš„æŠ•æ¯’è¡Œä¸ºã€‚å¯èƒ½å­˜åœ¨çš„é£é™©åœ¨äºç¼–è¯‘åçš„äºŒè¿›åˆ¶æ–‡ä»¶å¯èƒ½ä¼šè¢«ç”¨äºå…¶ä»–æ¶æ„ç›®çš„ï¼Œä½†è¿™ä¸æ˜¯ä»£ç æœ¬èº«çš„æŠ•æ¯’ã€‚é£é™©è¯„ä¼°ä¸º5%ä¸»è¦æ˜¯è€ƒè™‘åˆ°ä»»ä½•ä»£ç éƒ½å¯èƒ½è¢«æ»¥ç”¨ï¼Œè€Œéä»£ç æœ¬èº«å­˜åœ¨æ¶æ„é€»è¾‘ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  **ç¯å¢ƒå‡†å¤‡:** åˆ›å»º lower, upper, work, overlay ç›®å½•ã€‚
2.  **æ–‡ä»¶ç³»ç»ŸæŒ‚è½½:** ä½¿ç”¨ OverlayFS å°† lower å’Œ upper ç›®å½•æŒ‚è½½åˆ° overlay ç›®å½•ã€‚
3.  **æƒé™è®¾ç½®:** åœ¨ overlay ç›®å½•ä¸­åˆ›å»ºæ¶æ„æ–‡ä»¶å¹¶è®¾ç½® suid æƒé™ï¼Œå› ä¸ºoverlayfs æ²¡æœ‰æ­£ç¡®æ ¡éªŒæ–‡ä»¶capabilities ï¼Œå› æ­¤å¯ä»¥å°†æƒé™èµ‹äºˆæ–‡ä»¶ã€‚
4.  **æƒé™æå‡:** æ‰§è¡Œæ¶æ„æ–‡ä»¶ï¼Œç”±äº suid æƒé™ï¼Œå¯ä»¥æå‡åˆ°æ–‡ä»¶æ‹¥æœ‰è€…çš„æƒé™ï¼ˆé€šå¸¸æ˜¯rootï¼‰ã€‚

**é¡¹ç›®åœ°å€:** [spideyctf/UbuntuTouchSecurityVAPTReport](https://github.com/spideyctf/UbuntuTouchSecurityVAPTReport)

**æ¼æ´è¯¦æƒ…:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)

---

