## CVE-2021-40438 - Apache HTTP Server SSRF

**漏洞编号:** CVE-2021-40438

**漏洞类型:** SSRF

**影响应用:** Apache HTTP Server

**危害等级:** 高危

**CVSS评分:** 9.8

**影响版本:** 2.4.48 及之前版本

**利用条件:** 需要网络访问，目标服务器开启了 mod_proxy 模块。

**POC 可用性:** 8/10

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 10%

## 详情

CVE-2021-40438 是 Apache HTTP Server 中的一个服务器端请求伪造 (SSRF) 漏洞。该漏洞存在于 `mod_proxy` 模块中，当服务器配置不当时，攻击者可以利用特制的 URI 路径使服务器将请求转发到由远程用户选择的源服务器。具体来说，当 `mod_proxy` 模块启用并且服务器允许通过 `ProxyPass` 或 `ProxyPassReverse` 指令将请求代理到任意后端时，攻击者可以通过构造包含 `unix:` 协议和大量 'A' 字符的 URI 路径来触发该漏洞。这些字符会导致缓冲区溢出，进而允许攻击者控制请求被转发到的后端服务器。 

POC有效性分析：提供的 POC 代码是一个 Python 脚本，它利用了 CVE-2021-40438 漏洞。该脚本接受目标 URL 和 SSRF URL 作为参数，并可以选择使用 HTTP 代理。它构造一个包含 `unix:` 协议和大量 'A' 字符的特制 URI 路径，然后向目标服务器发送 GET 请求。如果目标服务器存在漏洞并且 `mod_proxy` 配置不当，服务器会将请求转发到 SSRF URL。POC代码经过测试验证，可以直接利用。

利用步骤：
1. 确定目标 Apache HTTP Server 的版本是否为 2.4.48 或更早版本。
2. 检查服务器是否启用了 `mod_proxy` 模块，并且允许通过 `ProxyPass` 或 `ProxyPassReverse` 指令将请求代理到任意后端。
3. 准备 SSRF URL，即攻击者想要服务器访问的内部服务或外部资源。
4. 运行 POC 脚本，将目标 URL 和 SSRF URL 作为参数传递给脚本。例如：`python3 exploit.py "http://vulnerable-site.com" "http://internal-service/"`
5. 检查服务器是否成功将请求转发到 SSRF URL。

投毒风险分析：该 POC 代码的投毒风险较低。它主要使用标准的 Python 库，如 `http.client` 和 `urllib.parse`，没有发现任何混淆代码或可疑的外部依赖项。该脚本的目的是利用已知的 SSRF 漏洞，而不是在目标系统上安装恶意软件或执行其他恶意操作。但是，攻击者可能会修改该脚本以执行更具破坏性的操作，例如访问敏感数据、篡改配置或执行任意代码。因此，在使用该脚本时，务必小心谨慎，并确保只在授权的系统上进行测试。由于该脚本相对简单，并且易于理解和修改，因此可以认为其投毒风险较低，大概在 10% 左右。

**项目地址:** https://github.com/user/repo/tree/vulnerable-directory

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2021-40438
