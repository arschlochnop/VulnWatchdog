## CVE-2021-3156 - Sudo 堆缓冲区溢出

**漏洞编号:** CVE-2021-3156

**漏洞类型:** 堆缓冲区溢出

**影响应用:** Sudo

**危害等级:** 高危 (High)

**CVSS评分:** 7.8 (CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H)

**影响版本:** Sudo 1.8.2 到 1.8.31p2; 1.9.0 到 1.9.5p1

**利用条件:** 具有本地普通用户访问权限，能够执行sudoedit命令

**POC 可用性:** 9/10

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 15%

## 详情

POC有效性分析：此POC（由blasty开发）针对CVE-2021-3156（又称Baron Samedit）提供了非常完整的自动化利用实现。漏洞根源在于Sudo对命令行参数处理时的off-by-one错误。当以'sudoedit -s'模式运行，且参数以单个反斜杠结尾时，sudo会跳过空字符读取内存，导致堆溢出。该POC通过精心构造的LC_ALL环境变量和命令行参数，精准控制堆分配布局。利用步骤如下：1. 编译生成hax.c（主漏洞利用程序）和lib.c（恶意的nss库）。2. 运行sudo-hax-me-a-sandwich并选择目标系统模板（如Ubuntu 18/20或Debian 10）。3. 程序通过execve启动sudoedit，传入构造的溢出载荷。4. 溢出导致sudo加载位于libnss_X目录下的恶意共享对象文件。5. 恶意库被加载后以root权限执行setuid(0)并弹出shell。经分析，该代码针对不同版本的Glibc和Sudo提供了特定的偏移量参数，具有极高的实战可靠性和单次成功率，不需要暴力破解即可完成提权。投毒风险分析：该代码库结构清晰，包含标准的Makefile和纯C源码。经过静态分析，未发现隐藏的恶意行为。其核心逻辑在于本地文件操作（创建libnss_X目录）和进程执行。代码中出现的'P0P_SH3LLZ_.so.2'虽然命名具有黑客风格，但其逻辑仅为提权验证，不包含反弹shell、凭据窃取或远程下载等恶意payload。风险点主要在于：如果用户从非官方来源下载经过修改的编译脚本，攻击者可能在Makefile中植入恶意命令。但就目前提供的原始POC代码而言，其行为完全符合安全研究范畴，属于低风险、高质量的研究样本。建议在隔离的沙箱环境进行测试，以防对生产系统的sudo配置或库路径产生意外副作用。

**项目地址:** [https://github.com/blasty/CVE-2021-3156](https://github.com/blasty/CVE-2021-3156)

**漏洞详情:** [https://nvd.nist.gov/vuln/detail/CVE-2021-3156](https://nvd.nist.gov/vuln/detail/CVE-2021-3156)
