## CVE-2021-3156 - Sudo 堆缓冲区溢出 (Heap-based Buffer Overflow)

**漏洞编号:** CVE-2021-3156

**漏洞类型:** 堆缓冲区溢出 (Heap-based Buffer Overflow)

**影响应用:** Sudo

**危害等级:** 高危 (High)

**CVSS评分:** 7.8 (CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H)

**影响版本:** Sudo 1.8.2 到 1.8.31p2; Sudo 1.9.0 到 1.9.5p1

**利用条件:** 具有本地普通用户访问权限，系统安装有受影响版本的Sudo，且未打补丁

**POC 可用性:** 9/10

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 15%

## 详情

POC有效性分析：该漏洞被称为‘Baron Samedit’，是Sudo中一个极其稳定且严重的本地提权漏洞。所提供的Python脚本‘exploit_nss.py’是一个高质量的利用程序，针对Linux系统的Name Service Switch (NSS) 机制进行堆溢出攻击。脚本首先通过特定的命令行参数（sudoedit -s -A）探测系统是否存在该漏洞。核心逻辑在于利用Sudo在解析反斜杠转义字符时存在的off-by-one错误，通过构造超长的argv参数导致堆缓冲区溢出。该POC通过覆盖struct service_user结构体，重定向库加载路径至攻击者控制的恶意共享库，从而实现从普通用户到root权限的提升。在测试环境（如Ubuntu 18.04/20.04）中，该POC具有极高的成功率，且不依赖于特定的暴力破解，是一种确定性的利用方式。利用步骤：首先，攻击者需获取目标系统的本地Shell权限；其次，确认sudo版本是否在受影响范围内；随后，通过Python环境运行‘exploit_nss.py’。脚本会自动执行环境检测、内存布局构造、触发堆溢出并最终调起具有root权限的shell。投毒风险分析：该POC代码结构清晰，使用了Python的标准库（os, subprocess, ctypes）进行系统调用和内存操作，未发现混淆代码。代码逻辑直接指向CVE-2021-3156的利用点，没有尝试连接外部异常IP或下载不明二进制文件的行为。然而，由于该脚本具备直接提权至root的能力，且作者自述为Red Team Enthusiast，在实际部署防御措施时，需警惕此类脚本被集成到恶意自动化脚本包中。虽然当前POC本身是清洁的，但攻击者常利用此类高成功率的公开POC进行二次包装，加入隐蔽的后门维持（如持久化SSH密钥注入）。对于防御团队而言，应重点关注POC中涉及的‘sudoedit -s’异常调用特征以及对nsswitch.conf相关内存结构的非法访问。整体来看，该POC主要用于安全评估，直接投毒风险处于低位，但其强大的破坏力要求在使用时必须在受控环境下进行。

**项目地址:** [https://github.com/TopskiyPavelQwertyGang](https://github.com/TopskiyPavelQwertyGang)

**漏洞详情:** [https://nvd.nist.gov/vuln/detail/CVE-2021-3156](https://nvd.nist.gov/vuln/detail/CVE-2021-3156)
