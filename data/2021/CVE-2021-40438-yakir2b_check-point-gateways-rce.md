## CVE-2021-40438 - Check Point Security Gateways RCE

**漏洞编号:** CVE-2021-40438

**漏洞类型:** RCE

**影响应用:** Check Point Security Gateways

**危害等级:** Critical

**CVSS评分:** 9.8

**影响版本:** 2.4.48 及更早版本, R81.10 T335, R80.40 T294

**利用条件:** 需要网络访问，需要目标网关存在 mod_proxy 模块并且配置不当。

**POC 可用性:** 9/10

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 10%

## 详情

CVE-2021-40438 允许远程攻击者通过精心设计的请求 URI 路径，使 mod_proxy 将请求转发到由远程用户选择的源服务器。该漏洞存在于 Apache HTTP Server 2.4.48 及更早版本中。该漏洞被成功利用于 Check Point Security Gateways，通过与 UNIX sockets 交互，攻击者可以利用 `/tmp` 目录下 Check Point 存储的各种 sockets，从而实现远程代码执行。

POC有效性分析：
POC代码 `check_point_gateways_rce.py` 提供了一个完整的利用链，包括两个主要功能：dump 和 reset。dump 模式可以用来获取网关的敏感信息，例如 expertpwd 和 installer:last_update_time，通过发送包含 `unix:/tmp/xdumps|http://.` 的特殊 URI 路径的 GET 请求到 `/gaia_docs` 接口。reset 模式可以用来重置管理员密码，通过构造包含用户名和新的密码哈希值的 payload，并将其发送到 `/gaia_docs` 接口，同样利用了 `unix:/tmp/xsets|http://.` 路径。该POC经过测试，可以成功在 R81.10 T335 和 R80.40 T294 版本的 Check Point Security Gateways 上执行。

利用步骤：
1.  使用 `python3 check_point_gateways_rce.py --mode dump https://192.168.0.100` 命令来dump目标网关的配置信息。如果成功，会在终端输出包含 expertpwd 和 installer:last_update_time 的信息。
2.  使用 `python3 check_point_gateways_rce.py --mode reset --offset <offset> https://192.168.0.100` 命令来重置管理员密码，其中 `<offset>` 是需要根据目标环境调整的偏移量。如果没有指定用户名和密码，脚本会自动生成一个随机密码。

投毒风险分析：
POC代码主要使用了 `requests` 库来发送 HTTP 请求，以及 `struct` 库来构造二进制 payload。代码中包含了一些字符串拼接操作，但没有发现明显的恶意代码或后门。`utils.py` 文件中包含 `monkey_patch` 函数，用于禁用 requests 库的 SSL 证书验证，这在某些情况下可能会带来安全风险，但不是直接的投毒行为。脚本通过与目标系统上的 UNIX sockets 交互来实现 RCE，这种利用方式相对隐蔽，但如果被恶意利用，可能会导致严重的安全事件。代码整体结构清晰，没有发现明显的混淆或加密行为。因此，该POC的投毒风险较低，大约在10%左右。

**项目地址:** https://github.com/element-security/check_point_gateways_rce

**漏洞详情:** https://nvd.nist.gov/vuln/detail/CVE-2021-40438
