## CVE-2021-4034 - polkit (pkexec) 本地权限提升 (LPE)

**漏洞编号:** CVE-2021-4034

**漏洞类型:** 本地权限提升 (LPE)

**影响应用:** polkit (pkexec)

**危害等级:** 高危

**CVSS评分:** 7.8 (CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H)

**影响版本:** 所有主流 Linux 发行版中包含 polkit 的版本（自 2009 年起）

**利用条件:** 攻击者必须拥有目标系统的低权限本地用户访问权限（Shell 访问）。

**POC 可用性:** 8/10

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 15%

## 详情

POC有效性分析：该漏洞被命名为 PwnKit，是 polkit 软件包中 pkexec 程序的内存损坏漏洞。pkexec 是一个 setuid 程序，旨在允许非特权用户以特权身份运行命令。此漏洞源于 pkexec 在处理命令行参数时，未正确验证参数计数（argc）。当 argc 为 0 时，pkexec 仍会尝试读取 argv[1]，导致越界读取并将环境变量作为参数处理。通过注入精心构造的环境变量（如 GIO_USE_VFS），攻击者可以欺骗 pkexec 加载并执行恶意的共享库（.so文件），从而以 root 身份执行任意代码。本 POC（exploit.py）是一个辅助脚本，它通过 python3 环境下载并编译原始的 C 语言利用代码（PwnKit.c），随后执行。代码中明确调用了 gcc 编译参数 '-shared -fPIC' 来生成共享库，这是利用 PwnKit 漏洞的标准方式。该漏洞利用非常稳定且高效，在几乎所有未修复的 Linux 发行版上都能实现 100% 的成功率。利用步骤：1. 获取目标 Linux 系统的低权限 Shell 访问。2. 上传或在本地运行 exploit.py 脚本。3. 脚本会自动检查系统中的 /usr/bin/pkexec 是否具有 SUID 位。4. 脚本尝试从远程源下载 PwnKit.c 源码或利用本地存在的源码进行编译。5. 脚本调用 gcc 将 C 源码编译为共享库二进制文件。6. 运行生成的二进制文件，通过触发 pkexec 的参数处理错误来加载该共享库。7. 成功后，用户身份将从普通用户切换为 root。投毒风险分析：该 POC 脚本的投毒风险处于低至中等水平（约 15%）。主要风险点在于其外部资源依赖。代码中硬编码了一个 GitHub 原始链接 ([https://raw.githubusercontent.com/ly4k/PwnKit/refs/heads/main/PwnKit.c](https://raw.githubusercontent.com/ly4k/PwnKit/refs/heads/main/PwnKit.c)) 用于下载核心利用代码。如果该 GitHub 仓库被维护者修改或发生中间人攻击，下载的 C 代码可能被注入恶意 payload（如反弹 Shell、持久化后门或勒索病毒）。虽然此 POC 脚本本身使用了标准库（os, subprocess, argparse），逻辑清晰且未经过度混淆，但其自动化下载并编译远程代码的行为在受控防御性研究环境中属于高危行为。此外，脚本中的 argparse 部分虽然定义了 ip 和 port 参数，但在截断的代码片段中并未看到明显的外部反弹逻辑，这可能意味着脚本具备扩展成攻击工具的潜力。安全研究员在使用时应首先审查远程下载的 C 源码内容，并建议在断网的沙箱环境中手动编译，以规避潜在的供应链投毒风险。脚本在执行过程中会生成名为 'PwnKit' 的二进制文件并修改权限（chmod +x），这也可能触发某些主机安全防护软件（EDR）的警报。

**项目地址:** [https://github.com/ly4k/PwnKit](https://github.com/ly4k/PwnKit)

**漏洞详情:** [https://nvd.nist.gov/vuln/detail/CVE-2021-4034](https://nvd.nist.gov/vuln/detail/CVE-2021-4034)
