## CVE-2021-4034 - Polkit (pkexec) 本地权限提升 (LPE)

**漏洞编号:** CVE-2021-4034

**漏洞类型:** 本地权限提升 (LPE)

**影响应用:** Polkit (pkexec)

**危害等级:** 高危 (High)

**CVSS评分:** 7.8 (CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H)

**影响版本:** 所有主流 Linux 发行版中的 polkit 版本 (2009年至今)

**利用条件:** 具有普通用户权限的本地访问权限，系统中安装有 pkexec 且具备 setuid 权限

**POC 可用性:** 9/10

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 5%

## 详情

POC有效性分析：该漏洞被广泛称为 'PwnKit'，源于 pkexec 命令行参数处理中的越界读取（OOB Read）和越界写入（OOB Write）。提供的 Exploit.c 脚本通过一种极其巧妙的方式利用了这一特性。在 pkexec 执行时，如果 argc 为 0，程序会尝试读取 argv[1]，实际上读取到了环境变量数组（envp）。攻击者通过构造特定的环境变量（如 PATH=GCONV_PATH=.），强制 pkexec 加载非标准的 gconv 转换模块。在提供的代码中，第一步创建了一个名为 'GCONV_PATH=.' 的目录和相关触发文件；第二步生成了一个名为 pwnkit.c 的恶意共享库源代码，其 gconv_init 函数内嵌了提升权限的核心逻辑（调用 setuid(0) 和 setgid(0)）；第三步使用 gcc 编译该代码为 .so 文件；最后通过 execve 系统调用以空参数列表触发 pkexec。由于 pkexec 具有 SUID 权限，加载的恶意模块将以 root 身份执行，从而产生一个具有 root 权限的交互式 bash 会话。该 POC 逻辑清晰、路径引用准确且包含自动编译步骤，具有极高的实战有效性和复现成功率。利用步骤：1. 在目标系统中创建一个临时工作目录；2. 将 Exploit.c 代码写入文件；3. 运行 GCC 编译该 POC；4. 执行编译后的二进制文件。程序将自动完成目录创建、恶意模块编译及环境变量注入，最终直接弹出 root shell。投毒风险分析：该代码段属于典型的防御性研究 POC。代码逻辑透明，使用了标准的 C 语言库函数（stdio.h, stdlib.h, unistd.h）和系统命令（mkdir, touch, chmod, gcc）。虽然代码中包含 system("rm -rf ...") 命令，但其目的是为了清理攻击产生的临时痕迹（GCONV_PATH 目录和 pwnkit 文件夹），属于自清理行为，而非恶意破坏系统。代码中没有发现任何外部网络通信、敏感信息外传、二进制混淆或针对研究人员主机的持久化后门植入行为。核心 payload 明确指向 /bin/bash 的获取。唯一潜在风险在于，如果攻击者将其包装在复杂的自动化脚本中而不告知用户，用户可能会在不经意间提升权限。但就代码本身而言，其行为完全符合安全研究和漏洞验证的标准流程，投毒风险极低（约 5%），属于安全的参考实现。

**项目地址:** [https://github.com/berdav/CVE-2021-4034](https://github.com/berdav/CVE-2021-4034)

**漏洞详情:** [https://nvd.nist.gov/vuln/detail/CVE-2021-4034](https://nvd.nist.gov/vuln/detail/CVE-2021-4034)
