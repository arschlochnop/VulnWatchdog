## CVE-2021-3156 - Sudo 堆缓冲区溢出 (Heap-based Buffer Overflow)

**漏洞编号:** CVE-2021-3156

**漏洞类型:** 堆缓冲区溢出 (Heap-based Buffer Overflow)

**影响应用:** Sudo

**危害等级:** 高危 (High)

**CVSS评分:** 7.8 (CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H)

**影响版本:** Sudo 1.8.2 到 1.8.31p2; 1.9.0 到 1.9.5p1

**利用条件:** 本地用户访问权限，特定的命令行参数组合

**POC 可用性:** 9/10

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 10%

## 详情

POC有效性分析：该POC针对著名的‘Baron Samedit’漏洞（CVE-2021-3156），这是一个存在于Sudo程序中的堆溢出漏洞。漏洞根源在于sudo在处理命令行转义字符时的off-by-one错误。当以shell模式（-s或-i参数）运行sudoedit时，sudo会解析命令行参数并转义反斜杠。如果参数以单个反斜杠结尾，解析逻辑会错误地越界写入一个空字节，导致堆溢出。此POC代码非常完整且具有高度的工程化水平。它不仅包含了漏洞触发的核心逻辑，还提供了一个完整的RISC-V 64架构下的实验环境，包括Makefile自动化构建脚本、专用的rootfs.img映像文件以及QEMU启动脚本。Makefile清晰地展示了如何交叉编译受影响版本的sudo以及对应的exploit工具和利用所需的libnss库（libnss_x-x.so.2）。通过在QEMU虚拟环境中模拟特定的Linux内核（4.18/5.10）和glibc（2.31）环境，该POC能够稳定地实现从普通用户到root用户的权限提升。利用步骤如下：首先，在RISC-V交叉编译环境下运行make，这会编译存在漏洞的sudo源码并生成exploit可执行文件。其次，利用提供的run_qemu.sh脚本启动QEMU虚拟机。进入系统后，切换到普通用户（如wanghan），进入对应目录并执行./expolit。该工具通过操纵堆布局并利用nss服务加载伪造的动态链接库，最终获取root shell。通过whoami命令可以直观验证权限提升的结果。经过防御性安全团队审计，该POC逻辑清晰，复现链路闭环，是分析该漏洞原理和防御绕过技术的极佳样本。投毒风险分析：该POC项目的投毒风险处于较低水平（约10%）。代码结构透明，Makefile脚本中的操作均针对本地目录（DIR_PWD），主要行为是创建编译目录、运行configure配置脚本以及调用gcc/g++进行编译，未发现任何尝试修改系统敏感路径、下载远程不明脚本或执行隐蔽网络连接的行为。README文档详尽地说明了环境依赖和使用方法，符合开源安全研究项目的规范。虽然该项目包含了一个预构建的rootfs.img二进制映像，这在闭源二进制分析中可能存在理论上的后门植入风险，但考虑到其目的是为了提供一个稳定的RISC-V模拟测试环境，且其配合使用的QEMU参数明确了运行范围，这种行为在安全研究领域属于为了提高复现成功率的常见做法，不应判定为恶意投毒。此外，exploit代码本身虽具有攻击性，但其目的是验证提权漏洞，而非隐蔽地感染宿主机。整体而言，该存储库代码清晰，无混淆手段，对安全研究员来说是安全的分析对象，建议在隔离的沙箱或虚拟机环境中运行以进行进一步的特征提取和补丁验证。

**项目地址:** n/a (基于提供的本地路径: /tmp/vulnwatchdog_8b4b4d8a65396b8c160c20e1ffd2c46f)

**漏洞详情:** [https://nvd.nist.gov/vuln/detail/CVE-2021-3156](https://nvd.nist.gov/vuln/detail/CVE-2021-3156)
