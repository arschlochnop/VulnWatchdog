## CVE-2021-3156 - Sudo 堆缓冲区溢出

**漏洞编号:** CVE-2021-3156

**漏洞类型:** 堆缓冲区溢出

**影响应用:** Sudo

**危害等级:** 高危

**CVSS评分:** 7.8 (CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H)

**影响版本:** 1.8.2 到 1.8.31p2; 1.9.0 到 1.9.5p1

**利用条件:** 本地用户访问权限，能够执行带有特殊参数的sudoedit命令

**POC 可用性:** 8/10

**POC 类型:** 完整利用

**攻击复杂度:** 中

**投毒风险:** 15%

## 详情

【POC有效性分析】该漏洞被称为‘Baron Samedit’，源于Sudo在处理命令行参数时的转义字符解析错误。分析提供的POC代码可见，其核心逻辑在于触发sudoedit中的off-by-one错误。exploit.c 通过精心构造的 argv 数组（包含带有反斜杠的缓冲区）和 envp 环境变量（用于Heap Feng-Shui堆布局），试图精确控制内存分配。代码通过LC_MESSAGES等环境变量在堆上分配特定大小的内存块，以此对齐目标缓冲区。当sudo执行并尝试剥离参数中的反斜杠时，会越界写入一个空字节或后续数据到堆中，从而覆盖关键的nss_groups结构。配套的shellcode.c被编译为libnss_x/x.so.2，这是一个共享库劫持攻击。一旦sudo加载了被覆盖指向的伪造NSS服务，它将以root权限执行shellcode中的constructor函数。shellcode通过系统调用setuid(0)和setgid(0)获取最高权限并生成交互式shell。该POC结构清晰，包含了完整的Makefile编译脚本、堆布局控制代码以及权限提升后的Payload，是一个具有高度实操性的漏洞利用示例，能够有效验证目标系统的漏洞存在性。利用步骤如下：首先，在本地环境解压并使用Makefile进行编译，生成exploit二进制文件和伪造的共享库文件；其次，确保libnss_x目录及其中的x.so.2位于可访问路径；最后，运行./exploit，程序将通过execve调用sudoedit并注入构造的环境变量，成功后将直接获得root Shell。【投毒风险分析】在对此POC代码的安全审查中，未发现明显的恶意混淆或后门植入迹象。exploit.c 的代码逻辑透明，主要集中在内存地址展示（通过printf输出指针地址）和环境变量构建上，这符合安全研究人员进行调试和演示的需求。shellcode.c 部分使用了标准的内联汇编来实现提权操作，其指令流清晰地指向了提升用户ID组ID以及执行/bin/sh的行为，这属于合法的提权漏洞验证范畴。虽然Makefile中包含了清理和编译指令，但并没有尝试连接外部C2服务器或下载不明脚本的隐蔽操作。15%的风险评分主要来自于此类提权工具的天然属性：攻击者可能将此代码修改后集成到蠕虫或自动化勒索软件中，作为其横向移动后的本地权限提升模块。此外，用户在下载此类POC时需警惕被二次修改的版本，但在当前提供的源代码层面，该代码库表现出较高的技术透明度和较低的直接投毒风险。代码中加入的getchar()暂停机制也进一步证明了其主要设计目的是为了教学和研究过程中的内存观察，而非静默的自动化攻击。

**项目地址:** [https://github.com/qualys/CVE-2021-3156](https://www.google.com/search?q=https://github.com/qualys/CVE-2021-3156)

**漏洞详情:** [https://nvd.nist.gov/vuln/detail/CVE-2021-3156](https://nvd.nist.gov/vuln/detail/CVE-2021-3156)
