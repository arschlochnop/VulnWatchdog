## CVE-2021-3156 - Sudo 本地提权 (LPE)

**漏洞编号:** CVE-2021-3156

**漏洞类型:** 本地提权 (LPE)

**影响应用:** Sudo

**危害等级:** 高危 (High)

**CVSS评分:** 7.8 (CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H)

**影响版本:** 1.8.2 到 1.8.31p2; 1.9.0 到 1.9.5p1

**利用条件:** 攻击者必须拥有本地受限用户访问权限，能够执行带有特定参数的sudo命令。

**POC 可用性:** 8/10

**POC 类型:** 完整利用

**攻击复杂度:** 中

**投毒风险:** 15%

## 详情

POC有效性分析：此POC（Baron Samedit）针对CVE-2021-3156漏洞，利用了Sudo在处理命令行参数时的off-by-one错误。该错误存在于sudo处理反斜杠（\）转义字符的逻辑中，当使用'sudoedit -s'且参数以单个反斜杠结尾时，解析逻辑会越过缓冲区边界。代码通过精心构造的user_buff（0x30字节）和大量的环境变量（envp）来填充堆空间。其中OVERFLOW偏移量被设定为1072字节，旨在覆盖堆上分配的service_user结构。通过操纵LC_TIME等环境变量，攻击者可以控制溢出后的内存布局，最终通过加载恶意的伪造库（ffs/ffs）来实现Root权限提升。该POC逻辑清晰，包含了关键的内存对齐和溢出长度计算，在Ubuntu 20.04.1 LTS（Sudo 1.8.31p2）等特定版本上具有极高的成功率。利用步骤：1. 准备Linux编译环境。2. 将代码保存为exploit.c并使用gcc进行编译。3. 运行编译后的二进制文件。4. 程序将调用execve触发sudoedit，通过溢出覆盖堆中的nsswitch结构。5. 系统尝试根据覆盖后的结构加载恶意库，从而获取Root Shell。投毒风险分析：该POC代码结构简洁透明，主要使用了标准C库（stdio.h, stdlib.h, string.h）和Linux系统调用（execve）。代码中不存在任何网络通信、未授权的文件读写或二进制加密逻辑，符合防御性安全研究的特征。主要的‘投毒’或‘风险’点在于其硬编码的库路径（ffs/ffs），在实战部署中需注意该路径是否指向预期的测试负载，而非系统关键组件。由于代码采用明文编写，没有任何混淆手段，且逻辑完全围绕漏洞利用展开，未发现恶意后门植入迹象，风险等级处于较低水平（15%），仅需警惕攻击者可能将其作为自动化提权脚本的一部分进行集成。总体而言，该代码对于研究堆溢出利用技术和Sudo权限管控具有极高的参考价值。

**项目地址:** N/A

**漏洞详情:** [https://nvd.nist.gov/vuln/detail/CVE-2021-3156](https://nvd.nist.gov/vuln/detail/CVE-2021-3156)
