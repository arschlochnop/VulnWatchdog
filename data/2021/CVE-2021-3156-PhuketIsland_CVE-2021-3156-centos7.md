## CVE-2021-3156 - Sudo 堆缓冲区溢出 (Heap-based Buffer Overflow)

**漏洞编号:** CVE-2021-3156

**漏洞类型:** 堆缓冲区溢出 (Heap-based Buffer Overflow)

**影响应用:** Sudo

**危害等级:** 高危 (High)

**CVSS评分:** 7.8 (CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H)

**影响版本:** 1.8.2 到 1.8.31p2; 1.9.0 到 1.9.5p1

**利用条件:** 具有本地普通用户访问权限，能够执行 sudoedit 命令

**POC 可用性:** 8/10

**POC 类型:** 完整利用

**攻击复杂度:** 中

**投毒风险:** 15%

## 详情

POC有效性分析：该POC针对CVE-2021-3156（又称Baron Samedit）漏洞编写。该漏洞源于Sudo在处理命令行参数时的转义逻辑错误。具体而言，当以非标准方式调用sudo（如通过sudoedit -s）且参数以单个反斜杠结尾时，Sudo会发生off-by-one错误，导致在堆上分配的缓冲区发生越界写入。此POC采用了高级利用技术，通过ctypes调用libc的execve函数，并精细构造了内存布局。代码中定义的TARGET_CMND_SIZE和复杂的epage/SA（栈地址偏移）计算，旨在实现对Sudo内部数据结构的覆盖。通过操纵堆块，攻击者可以覆盖sudoers解析过程中的结构体，从而绕过权限检查，将普通用户权限提升至root。该POC展示了极高的技术成熟度，能够精确控制溢出长度和内容，在多数Linux发行版上经过微调即可实现稳定利用。利用步骤：首先，攻击者需拥有目标系统的普通Shell访问权限。其次，检查Sudo版本是否处于受影响范围。执行时，脚本会调用资源限制调整函数（resource.setrlimit）以增大栈空间，随后利用ctypes库在内存中构造虚假的sudoers数据结构和member、cmndspec等关键内存对象。最后，通过调用带有构造参数的sudoedit触发漏洞。该脚本通过精心设计的命令行参数（以反斜杠结尾）触发溢出，覆盖特定的内存指针，最终劫持程序执行流以执行具有root权限的 shell 命令或修改/etc/passwd文件。投毒风险分析：该POC代码主要使用Python标准库（os, sys, resource, struct）和ctypes库。经过深度代码审计，该脚本的核心逻辑集中在漏洞触发和堆内存布局构造上。虽然代码中出现了对/etc/passwd文件的硬编码引用（APPEND_CONTENT），但这属于典型的提权POC验证行为，旨在测试是否具备写入特权文件的权限，而非恶意投毒行为。代码逻辑透明，没有发现明显的Base64混淆、外部恶意URL下载或反弹Shell到第三方服务器的可疑行为。然而，由于该POC涉及直接操作libc底层函数和内存地址，不当的修改或在生产环境直接运行可能导致系统服务崩溃（Segmentation Fault）。风险主要源于代码被恶意第三方二次打包。鉴于代码的可读性较高，防御者在使用前应仔细比对内存偏移量（如STACK_ADDR_PAGE），以确保其在特定内核版本下的安全性。总体而言，该代码作为安全研究用途是安全的，投毒风险较低。

**项目地址:** [https://nvd.nist.gov/vuln/detail/CVE-2021-3156](https://nvd.nist.gov/vuln/detail/CVE-2021-3156)

**漏洞详情:** [https://nvd.nist.gov/vuln/detail/CVE-2021-3156](https://nvd.nist.gov/vuln/detail/CVE-2021-3156)
