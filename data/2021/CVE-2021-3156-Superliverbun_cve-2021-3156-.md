## CVE-2021-3156 - Sudo 提权 (Privilege Escalation) / 堆缓冲区溢出 (Heap-based Buffer Overflow)

**漏洞编号:** CVE-2021-3156

**漏洞类型:** 提权 (Privilege Escalation) / 堆缓冲区溢出 (Heap-based Buffer Overflow)

**影响应用:** Sudo

**危害等级:** 高危 (High)

**CVSS评分:** 7.8 (CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H)

**影响版本:** 1.8.2 到 1.8.31p2; 1.9.0 到 1.9.5p1

**利用条件:** 具有本地用户权限，系统中安装了受影响版本的 Sudo 实用程序

**POC 可用性:** 8/10

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 15%

## 详情

POC有效性分析：提供的POC代码针对CVE-2021-3156（Baron Samedit）漏洞。该漏洞源于sudo在解析命令行参数时处理转义字符的逻辑错误。当以‘sudoedit -s’模式运行且参数以单个反斜杠结尾时，sudo会发生脱离边界的写操作，导致堆缓冲区溢出。代码hax.c通过构造特定的argv和envp数组触发溢出。它使用了大量的反斜杠和特定的环境变量（LC_MESSAGES, LC_ALL等）来精确控制堆布局。Makefile显示，该利用程序会编译一个共享库lib.c（生成的so文件名为libnss_X/P0P_SH3LLZ_.so.2），利用sudo在处理错误时加载nss配置的特性，劫持执行流。lib.c中的构造函数（constructor）在库加载时自动执行，通过setuid(0)获取Root权限并弹出shell。此POC逻辑清晰，符合该漏洞已知的利用路径，对于Ubuntu 20.04等特定版本具有极高的执行成功率。利用步骤：1. 准备受影响的Linux环境（如Ubuntu 20.04）。2. 将hax.c、lib.c和Makefile放在同一目录下。3. 执行make命令进行编译，生成攻击载荷sudo-hax-me-a-sandwich和恶意共享库。4. 运行编译出的二进制文件，程序将调用execve触发sudoedit漏洞。5. 如果利用成功，系统将加载恶意库并返回一个具有root权限的shell。投毒风险分析：该POC代码结构透明，主要由C语言编写。Makefile中定义的编译流程仅包含本地gcc调用，没有发现wget、curl等从远程服务器下载未知脚本的行为。hax.c的代码逻辑专注于漏洞触发，未发现混淆代码。lib.c的内容为典型的安全研究提权验证代码，其核心功能是提升权限并执行/bin/sh。虽然它包含提权操作，但这是POC功能的预期行为，而非隐蔽的恶意后门。文件名'P0P_SH3LLZ_'虽具有黑客风格，但属于技术演示范畴。主要的潜在风险在于Makefile可能被修改以包含隐蔽的系统清理或持久化指令，但在此样本中未见异常。综合评估，该POC是标准的漏洞验证代码，投毒风险较低，主要风险在于其强大的提权能力可能被未经授权的人员直接用于攻击现有系统。建议在隔离的沙箱环境中使用，并确保编译环境安全。

**项目地址:** [https://github.com/kalitor0/CVE-2021-3156](https://www.google.com/search?q=https://github.com/kalitor0/CVE-2021-3156)

**漏洞详情:** [https://nvd.nist.gov/vuln/detail/CVE-2021-3156](https://nvd.nist.gov/vuln/detail/CVE-2021-3156)
