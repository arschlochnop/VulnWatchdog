## CVE-2021-3156 - Sudo (sudo/sudoedit) 本地提权 (Privilege Escalation)

**漏洞编号:** CVE-2021-3156

**漏洞类型:** 本地提权 (Privilege Escalation)

**影响应用:** Sudo (sudo/sudoedit)

**危害等级:** 高危

**CVSS评分:** 7.8 (CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H)

**影响版本:** Sudo 1.8.2 到 1.8.31p2; Sudo 1.9.0 到 1.9.5p1

**利用条件:** 本地普通用户访问权限，无需密码验证

**POC 可用性:** 9/10

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 5%

## 详情

POC有效性分析：该POC针对CVE-2021-3156（又称Baron Samedit）提供了完整的本地提权方案。该漏洞源于sudo在解析命令行参数时处理反斜杠（\）的逻辑错误，导致堆缓冲区溢出。代码中，exploit.c 通过构造特制的 argv 参数（以 sudoedit -s 开头并以单个反斜杠结尾）触发溢出。为了确保利用的稳定性，POC采用了堆风水（Heap Feng-Shui）技术，通过设置环境变量 LC_MESSAGES、LC_TELEPHONE 和 LC_MEASUREMENT 来精确控制堆内存布局，使溢出的数据能够覆盖目标 service_user 结构体。随后，利用 sudo 加载 NSS（Name Service Switch）模块的机制，通过 shellcode.c 编译生成的恶意共享库 libnss_x/x.so.2 实现提权。该POC在 Ubuntu 20.04 等主流发行版上具有极高的成功率，无需进行暴力破解或复杂的偏移量扫描，是一个经过高度优化且可直接运行的利用脚本。利用步骤：首先，使用提供的 Makefile 编译项目，生成 exploit 可执行文件和恶意的 NSS 共享库。Makefile 会将 shellcode 编译为 libnss_x/x.so.2。接着，运行 ./exploit，程序将通过 execve 调用 sudoedit，利用精心构造的堆布局覆盖内存中的 service_user 结构。当 sudo 尝试查找用户信息并加载对应的 NSS 库时，会加载并执行攻击者预设的恶意共享库。最终，由于 sudo 以 root 权限运行，恶意库中的代码将启动一个具有 root 权限的交互式 shell。投毒风险分析：经过对提供的源代码（Dockerfile, Makefile, exploit.c, shellcode.c）进行深度审计，未发现明显的恶意行为或投毒迹象。代码逻辑清晰，主要使用了标准 C 库函数（如 memset, strcat, execve 等），没有检测到任何外部域名请求、加密的二进制 payload 或混淆处理。Dockerfile 明确指定了基础镜像和受影响的旧版本 sudo，符合安全研究和实验环境的构建标准。虽然提权代码本身具有攻击性，但其行为完全局限于本地系统，目的是为了验证漏洞的危害性。Makefile 的行为也是标准的编译流程，没有尝试修改系统核心配置或持久化后门。风险评分极低的主要原因在于代码透明度高且来源可溯，开发者明确注明了参考 Qualys 的官方研究。对于防御团队而言，该 POC 是极佳的检测规则测试样本，不具备针对分析者的供应链投毒特征。

**项目地址:** 本地提取 POC (原作者 Max Kamper)

**漏洞详情:** [https://nvd.nist.gov/vuln/detail/CVE-2021-3156](https://nvd.nist.gov/vuln/detail/CVE-2021-3156)
