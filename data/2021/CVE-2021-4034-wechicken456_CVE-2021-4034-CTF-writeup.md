## CVE-2021-4034 - polkit (PolicyKit) 本地提权 (LPE)

**漏洞编号:** CVE-2021-4034

**漏洞类型:** 本地提权 (LPE)

**影响应用:** polkit (PolicyKit)

**危害等级:** 高危 (High)

**CVSS评分:** 7.8 (CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H)

**影响版本:** polkit 所有版本 (自2009年5月最初提交以来)

**利用条件:** 需要拥有受影响系统的本地普通用户权限（低权限Shell）。

**POC 可用性:** 7/10

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 10%

## 详情

【POC有效性分析】该漏洞（被称为 PwnKit）存在于 polkit 的 pkexec 实用程序中。根本原因是 pkexec 在处理命令行参数时存在内存越界写入漏洞。当 argc 为 0 时（通过 execve 传递空数组），pkexec 会错误地读取并写入环境变量。POC代码分析显示，它利用了这种越界写入能力，通过操纵环境变量（如 GCONV_PATH）强制 pkexec 加载恶意的共享库（如代码中提到的 shelly.so），从而以 root 身份执行代码。此漏洞极其稳定且通用，不依赖于特定的内存布局或复杂的堆喷射，因此在绝大多数 Linux 发行版上都具有极高的成功率。本案例中的 POC 呈现为一个 CTF 挑战形式，提供了 C 语言编写的模拟程序 `chal` 和利用载荷 `shelly.so`。其逻辑清晰地展示了如何通过 `execve` 调用触发漏洞。利用步骤如下：1. 在目标系统中编译包含恶意 `gconv-modules` 配置和 `.so` 载荷的项目；2. 设置特定的环境变量触发 pkexec 的越界读取；3. pkexec 运行并因为 SUID 权限以 root 身份加载并执行攻击者的 `.so` 文件；4. 获取 root shell 并读取 `flag.txt`。此 POC 针对 CTF 场景进行了封装，虽然需要手动配置部分环境（如安装特定版本的 libpolkit），但核心逻辑是真实有效的。【投毒风险分析】该 POC 的投毒风险被评为低（10%）。代码主要以教学和竞赛（CTF）为目的，结构透明，主要包含 C 源代码和 README 说明文档。README 详细描述了环境搭建步骤，包括安装旧版受影响软件包的方法。代码中未发现混淆处理、未授权的远程网络请求（C2回连）或破坏性的删除操作。唯一的安全顾虑在于提供者提供的 `shelly.so` 二进制文件，在生产防御研究中，应重新从源码编译该动态库以排除任何预编译后门的风险。作为防御性研究员，应注意到此漏洞的公开极大地降低了 Linux 提权的门槛，任何拥有本地访问权限的攻击者都能轻易获取管理员权限。防御措施应侧重于升级 polkit 补丁或在无法立即升级的情况下，通过 `chmod 0755 /usr/bin/pkexec` 去除 SUID 权限作为临时规避手段。

**项目地址:** /tmp/vulnwatchdog_adac42aec66a6f96a6a7a6bed849ecd0/

**漏洞详情:** [https://nvd.nist.gov/vuln/detail/CVE-2021-4034](https://nvd.nist.gov/vuln/detail/CVE-2021-4034)
