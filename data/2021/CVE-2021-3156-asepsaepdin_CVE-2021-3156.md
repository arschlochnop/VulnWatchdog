## CVE-2021-3156 - Sudo 堆缓冲区溢出 (Heap-based Buffer Overflow)

**漏洞编号:** CVE-2021-3156

**漏洞类型:** 堆缓冲区溢出 (Heap-based Buffer Overflow)

**影响应用:** Sudo

**危害等级:** 高危 (High)

**CVSS评分:** 7.8 (CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H)

**影响版本:** Sudo 1.8.2 到 1.8.31p2; 1.9.0 到 1.9.5p1 (1.9.5p2 以前版本)

**利用条件:** 本地普通用户访问权限，能够执行 sudoedit 或带有特定标志的 sudo 命令。

**POC 可用性:** 9/10

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 10%

## 详情

【POC有效性分析】该POC针对的是著名的'Baron Samedit'漏洞（CVE-2021-3156）。通过分析提供的源码，发现该POC采用了经典的利用策略：利用sudo在解析命令行参数时存在的off-by-one错误。代码首先通过Makefile构建环境，生成一个名为libnss_x/x.so.2的共享库，这是利用NSS（Name Service Switch）机制进行提权的关键步骤。在exploit.c中，程序构造了一个精心设计的argv数组，其中包含'sudoedit'和'-s'标志。其核心逻辑在于构造一个以反斜杠'\'结尾的缓冲区buf，当sudo在mode包含MODE_SHELL或MODE_EDIT时，会错误地跳过反斜杠并继续读取，从而导致堆缓冲区溢出。代码中还展示了复杂的堆风水（Heap Feng-Shui）技术，通过设置LC_MESSAGES、LC_TELEPHONE等环境变量来精确控制堆内存布局，旨在溢出并覆盖service_user结构体。一旦结构体被覆盖，sudo在执行时会加载攻击者指定的恶意共享库（即libnss_x/x.so.2），从而在root权限下执行shellcode。从代码逻辑看，该POC结构完整，包含了环境准备、堆布局、溢出触发和Payload执行，具有极高的实战有效性，在Ubuntu 20.04等受影响系统上可直接获取Root权限。【利用步骤】1. 准备环境：在目标Linux系统上安装必要的编译工具（gcc, make）。2. 获取源码：克隆POC项目仓库。3. 编译：在项目根目录运行'make'，这将生成恶意共享库和主漏洞利用程序。4. 执行利用：运行编译生成的'./exploit'文件。5. 验证结果：如果成功，程序将绕过权限检查并开启一个具有root权限的新shell。【投毒风险分析】经过对提供的C代码和Makefile的深度审计，未发现明显的投毒行为或后门植入。Makefile逻辑清晰，仅用于编译本地组件。exploit.c代码中使用的函数均为标准C库函数（如execve, memset, strcat），且所有操作均在本地内存空间和文件系统中进行，未见网络外连、敏感信息上传或隐藏的可执行脚本。尽管该POC涉及创建共享库并覆盖系统结构，但这属于漏洞利用的标准提权动作，而非针对研究员环境的攻击。仓库README中引用的链接指向了知名的安全研究机构Qualys和合法的GitHub研究仓库，增强了其可信度。然而，考虑到此类高价值POC常被二次打包，防御方在使用时仍需注意README中的git clone地址。在本例中，代码逻辑纯粹，主要风险在于其强大的破坏性提权能力而非恶意软件植入，投毒风险评估为10%（主要为脚本下载过程中的潜在供应链风险）。

**项目地址:** [https://github.com/asepsaepdin/CVE-2021-3156](https://github.com/asepsaepdin/CVE-2021-3156)

**漏洞详情:** [https://nvd.nist.gov/vuln/detail/CVE-2021-3156](https://nvd.nist.gov/vuln/detail/CVE-2021-3156)
