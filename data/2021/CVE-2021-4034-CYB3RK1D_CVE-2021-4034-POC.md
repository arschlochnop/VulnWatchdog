## CVE-2021-4034 - polkit (pkexec utility) 本地权限提升(LPE)

**漏洞编号:** CVE-2021-4034

**漏洞类型:** 本地权限提升(LPE)

**影响应用:** polkit (pkexec utility)

**危害等级:** 高危

**CVSS评分:** 7.8 (CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H)

**影响版本:** 所有主流Linux发行版中包含pkexec的polkit版本(2009年5月至今)

**利用条件:** 本地用户访问权限

**POC 可用性:** 9/10

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 10%

## 详情

POC有效性分析：该POC针对的是polkit中pkexec工具自2009年以来存在的内存溢出漏洞（PwnKit）。通过对提供的C语言源码分析，该代码逻辑清晰且具有极高的实战有效性。其核心原理是利用pkexec在处理命令行参数时的逻辑缺陷：当argc为0时，pkexec会错误地尝试读取argv[1]，导致越界读取并将其视为环境变量。POC通过精心构造的环境变量（如GCONV_PATH）和本地文件系统布局，强制触发glibc加载自定义的gconv-modules。代码中通过mkdir创建名为'GCONV_PATH=.'的目录，并构造伪造的环境变量数组envp。随后，它在本地编译一个恶意的.so共享库（payload.so），该库在gconv_init初始化函数中调用setuid(0)并执行/bin/sh。这种利用方式避开了传统的内存保护机制，是非常稳定的提权手段。代码实现包含了文件创建、GCC编译调用及execve系统调用，是一个开箱即用的完整利用链。利用步骤：1. 在本地环境中创建名为'GCONV_PATH=.'的文件夹及辅助目录'lpe'。2. 编写并编译恶意的payload.c文件，生成名为payload.so的共享对象，其中包含提权并执行shell的逻辑。3. 创建并写入gconv-modules配置文件，将自定义编码映射到恶意共享库。4. 通过execve函数调用/usr/bin/pkexec，并传入精心构造的环境变量数组，触发漏洞。投毒风险分析：该POC代码逻辑高度透明，主要使用标准C库函数（stdio.h, stdlib.h, unistd.h）进行文件操作和进程控制。经过静态代码审计，未发现任何混淆代码、外部敏感域名请求或非预期的系统破坏行为。代码中的恶意行为（如调用setuid(0)和execve("/bin/sh",...)）属于典型的漏洞利用验证逻辑，目的是获取Root权限，而非针对研究者本机的投毒行为。虽然代码中调用了system("gcc ...")来动态编译payload，但这在防御性安全研究中是常见的动态生成Exploit的方法。唯一需要警惕的是其创建的本地文件和目录可能残留，但在受控实验环境下风险极低。整体来看，该代码属于高质量的公开安全研究资料，不存在明显的后门投毒风险，风险百分比评估为10%，主要源于其具备直接破坏系统安全性的能力，而非代码本身的欺骗性。

**项目地址:** [https://github.com/arthepsy/CVE-2021-4034/blob/main/cve-2021-4034-poc.c](https://github.com/arthepsy/CVE-2021-4034/blob/main/cve-2021-4034-poc.c)

**漏洞详情:** [https://nvd.nist.gov/vuln/detail/CVE-2021-4034](https://nvd.nist.gov/vuln/detail/CVE-2021-4034)
