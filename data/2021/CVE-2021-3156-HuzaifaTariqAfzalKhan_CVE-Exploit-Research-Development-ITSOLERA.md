## CVE-2021-3156 - Sudo 堆缓冲区溢出 (Heap-based Buffer Overflow)

**漏洞编号:** CVE-2021-3156

**漏洞类型:** 堆缓冲区溢出 (Heap-based Buffer Overflow)

**影响应用:** Sudo

**危害等级:** 高危 (High)

**CVSS评分:** 7.8 (CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H)

**影响版本:** 1.8.2 到 1.8.31p2; 1.9.0 到 1.9.5p1

**利用条件:** 具有本地普通用户访问权限，能够执行命令

**POC 可用性:** 8/10

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 10%

## 详情

【POC有效性分析】该漏洞被称为“Baron Samedit”，是Sudo组件中极其严重的本地提权漏洞。漏洞根源在于sudo在解析命令行参数时存在off-by-one错误。当以shell模式（使用-s或-i参数）运行sudoedit时，代码在处理以反斜杠结尾的转义字符时，由于边界检查逻辑错误，会导致程序跳过预期的字符串结束符，从而向堆缓冲区写入超出分配范围的数据。提供的POC代码包含了Dockerfile环境搭建和核心利用逻辑。C语言源码通过构造特定的argv参数和环境变量触发溢出。源码中展示了核心利用思路：分配一个特定的PAYLOAD_SIZE大小的缓冲区，并在末尾添加反斜杠，结合-s参数调用sudoedit。虽然此简化版POC仅展示了如何触发崩溃或初步溢出，但其配套说明指向了知名的GitHub利用工具（blasty/CVE-2021-3156），该工具已被安全社区广泛验证，能够通过精准的堆布局控制实现在Ubuntu、Debian等主流发行版上的root提权。利用该POC，攻击者可以绕过/etc/sudoers的权限限制，从普通用户直接获取root Shell。 【利用步骤】1. 环境准备：通过提供的Dockerfile构建测试容器，确保sudo版本为1.8.31。2. 编译：使用gcc编译exploit.c生成二进制执行文件。3. 执行：运行编译出的程序，程序会调用execve启动sudoedit。4. 提权验证：如果利用成功，程序会通过溢出覆盖堆中的相关结构，进而劫持执行流或修改权限标志位，最终弹出root权限的shell。5. 目标适配：针对不同发行版，通常需要调整堆对齐参数（如POC说明中提到的Target 0/1/2）。 【投毒风险分析】该POC本身具有极低的投毒风险。分析其代码结构，exploit.c逻辑非常透明：首先通过memset填充缓冲区，最后一位设为反斜杠，随后使用标准execve系统调用。代码中没有发现任何网络连接、文件系统持久化隐藏、或混淆加密等恶意特征。README说明部分指向了GitHub公认的安全研究仓库，而非不明来源的二进制文件。Dockerfile的使用进一步增强了安全性，因为研究人员可以在隔离的容器环境中进行验证。虽然该漏洞威力巨大，但此代码片段仅作为教学和漏洞防御评估使用。代码中不包含任何下载外部Payload的指令，变量命名清晰，符合漏洞原理展示的特征。然而，在下载外部引用的完整利用工具（如从GitHub克隆）时，用户仍需核对仓库的Star数和提交记录，以防供应链投毒。在本POC范围内，代码是安全且可审计的。

**项目地址:** [https://github.com/blasty/CVE-2021-3156](https://github.com/blasty/CVE-2021-3156)

**漏洞详情:** [https://nvd.nist.gov/vuln/detail/CVE-2021-3156](https://nvd.nist.gov/vuln/detail/CVE-2021-3156)
