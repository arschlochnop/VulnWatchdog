## CVE-2021-4034 - Polkit (pkexec) 本地权限提升 (LPE)

**漏洞编号:** CVE-2021-4034

**漏洞类型:** 本地权限提升 (LPE)

**影响应用:** Polkit (pkexec)

**危害等级:** 高危

**CVSS评分:** 7.8 (CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H)

**影响版本:** 所有主流 Linux 发行版中包含 polkit 的版本（自 2009 年起）

**利用条件:** 具有受影响系统的本地普通用户访问权限

**POC 可用性:** 10/10

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 5%

## 详情

【POC有效性分析】该漏洞被称为 PwnKit，存在于 polkit 的 pkexec 工具中。该工具在处理命令行参数时存在越界读取缺陷。根据提供的 POC 代码分析，其有效性极高。核心逻辑在于 pkexec 无法处理 argc 为 0 的情况。在 cve-2021-4034.c 中，通过 execve 调用 pkexec 并将 argv 数组设为空（仅包含 NULL），此时 pkexec 依然会尝试读取 argv[1]，实际上越界读取到了 envp[0]。攻击者通过构造特定的环境变量（如 PATH=GCONV_PATH=.），强制 pkexec 查找非标准的 gconv 模块。随后，通过创建配套的目录结构、gconv-modules 映射文件以及恶意共享对象 pwnkit.so，当 pkexec 尝试进行字符集转换时，会加载并执行 pwnkit.so 中的 gconv_init 函数。该函数调用 setuid(0) 和 setgid(0) 后执行 /bin/sh，从而获得 root shell。此 POC 逻辑闭环，文件结构完整且符合原漏洞披露的技术细节，是极具代表性的实战化利用代码。

【利用步骤】1. 编译环境：使用 gcc 编译主程序 cve-2021-4034.c 和 payload 库 pwnkit.c，生成共享库 pwnkit.so。2. 构造环境：在本地目录创建一个名为 'GCONV_PATH=.' 的文件夹，并在其内部创建一个名为 pwnkit.so 的空文件（或通过软链接/复制方式），此步骤是为了绕过 pkexec 对路径的初步检查。3. 配置文件：创建 gconv-modules 文件，定义自定义编码转换模块。4. 执行触发：运行编译后的可执行文件。该程序会触发 pkexec 的逻辑缺陷，使其加载当前目录下的恶意 gconv 模块，最终在 root 权限下弹出 shell。

【投毒风险分析】该 POC 代码具有极高的透明度，投毒风险极低（评估为 5%）。首先，代码逻辑完全基于标准 C 库函数（unistd.h, stdio.h, stdlib.h），没有任何混淆或加密处理，安全研究员可以轻易审计每一行指令。其次，pwnkit.c 中的核心 Payload 仅包含标准的 setuid/execve 操作，旨在开启 shell，未发现任何网络外联行为（如反弹 shell 到非法 IP）、文件加密、磁盘破坏或凭据窃取等恶意后门。gconv-modules 配置文件内容清晰，仅用于配合漏洞利用演示。尽管该 POC 威力巨大，但其作为防御性研究和渗透测试工具的属性非常明确。唯一需要注意的是，此类 POC 在公开环境中传播时，可能会被初级攻击者（Script Kiddies）直接用于非法活动，但这属于武器化滥用而非代码投毒。从代码审计角度看，此仓库未包含任何针对开发者的恶意指令或隐藏负载，属于安全且高质量的验证代码。

**项目地址:** 本地模拟路径: /tmp/vulnwatchdog_96b42168a29419d97d855e4c5b84c485/

**漏洞详情:** [https://nvd.nist.gov/vuln/detail/CVE-2021-4034](https://nvd.nist.gov/vuln/detail/CVE-2021-4034)
