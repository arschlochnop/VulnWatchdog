## CVE-2021-4034 - polkit (pkexec) 本地权限提升 (LPE)

**漏洞编号:** CVE-2021-4034

**漏洞类型:** 本地权限提升 (LPE)

**影响应用:** polkit (pkexec)

**危害等级:** 高危 (High)

**CVSS评分:** 7.8 (CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H)

**影响版本:** 所有主流 Linux 发行版中的 polkit 版本 (自2009年以来)

**利用条件:** 需要具有本地普通用户访问权限 (Shell 访问)

**POC 可用性:** 9/10

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 5%

## 详情

POC有效性分析：该漏洞被命名为 'PwnKit'，是一个存在于 polkit 的 pkexec 工具中的内存越界写入漏洞。分析 POC 代码（exploit.c）可以发现，它利用了 pkexec 在处理命令行参数（argc 为 0 时）的逻辑缺陷。pkexec 在没有参数输入时，会错误地将环境变量列表的首个元素当作参数进行处理。POC 通过精心构造的环境变量（如 GCONV_PATH 和 CHARSET）触发 glibc 的图标转换函数。具体步骤如下：1. 创建一个名为 'GCONV_PATH=.' 的目录。2. 在该目录下创建一个伪造的可执行文件和配置文件。3. 调用 execve 启动 pkexec，并传入空的参数列表（argv 为空）以及包含恶意环境变量的列表。4. pkexec 在运行时会越界读取环境变量，并将其视为待处理的路径，最终通过环境变量注入诱导 pkexec 以 root 权限加载攻击者提供的共享库（.so 文件）。5. 在共享库的 gconv_init 函数中，代码调用 setuid(0) 和 setgid(0) 获取超级用户权限，并弹出 /bin/sh。此 POC 逻辑清晰，利用了 Linux 动态链接器的经典特性，由于其不依赖于复杂的内核堆喷射或竞争条件，成功率极高且在 Debian 10、Ubuntu 等主流系统上经过验证。/n/n投毒风险分析：该 POC 代码展示了极高的透明度和教育性，属于典型的安全研究产物。代码中使用了标准的 C 库函数（stdio.h, stdlib.h, unistd.h），没有引入任何第三方混淆库或加密的二进制载荷。在 exploit.c 中，恶意逻辑（即获取 root 权限的代码）被明文写在 shell 变量中，方便研究员审查。虽然代码包含 system("rm -rf ...") 命令，但这属于利用后的痕迹清理，旨在删除漏洞触发过程中产生的临时目录（GCONV_PATH=. 等），并非针对用户数据的恶意破坏。由于代码中没有网络外连请求（如反弹 Shell 或下载远程脚本），也没有对系统关键文件（如 /etc/shadow）的持久化修改（除非是通过弹出的 root shell 手动执行），因此该 POC 的投毒风险极低。对于防御性团队而言，主要的风险点在于该 POC 可能被未授权用户直接下载并用于内网渗透，而非 POC 源码本身携带后门。研究员在测试时应在受控的虚拟机环境中运行，以防止意外的系统环境损坏。

**项目地址:** [https://github.com/arthepsy/CVE-2021-4034](https://github.com/arthepsy/CVE-2021-4034)

**漏洞详情:** [https://nvd.nist.gov/vuln/detail/CVE-2021-4034](https://nvd.nist.gov/vuln/detail/CVE-2021-4034)
