## CVE-2021-3493-Ubuntu OverlayFS 本地提权

**漏洞编号:** CVE-2021-3493

**漏洞类型:** 本地提权

**影响应用:** Ubuntu Linux Kernel (OverlayFS)

**危害等级:** 高危，允许低权限用户提升到root权限

**影响版本:** Ubuntu 4.4, 4.15, 5.4, 5.8 kernels (受影响版本详见漏洞库信息)

**利用条件:** Ubuntu内核版本在受影响范围内，启用未授权用户命名空间，允许未授权OverlayFS挂载。

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2021-3493是Ubuntu内核中OverlayFS实现的一个漏洞，允许低权限用户通过利用user namespace和OverlayFS挂载绕过文件系统权限检查来提升权限。 

**漏洞利用方式：**

1.  **环境准备:** 漏洞利用需要存在Ubuntu系统，且内核版本在漏洞库信息中描述的受影响范围内，并且需要启用未授权用户命名空间(unprivileged user namespaces)。此外，为了利用OverlayFS，系统需要配置允许未授权用户进行OverlayFS挂载。
2.  **漏洞利用:**  攻击者首先创建一个包含lower, upper, work目录的OverlayFS结构。
3.  **利用过程:** 利用`unshare`系统调用创建一个新的user namespace和mount namespace。 在新namespace中，将自己的UID和GID映射到root权限。 然后，使用构造的lowerdir、upperdir和workdir挂载OverlayFS文件系统。 攻击者将一个可执行文件复制到OverlayFS的merge目录中。关键的一步是，攻击者使用`setxattr`系统调用，设置该可执行文件的`security.capability`扩展属性，赋予它`CAP_SETUID`和`CAP_SETGID`能力。 由于OverlayFS的权限验证不完善，这个操作即使在非特权用户命名空间中也能成功。当执行该文件时，它将获得root权限，并可以执行任意命令。
4.  **POC代码分析:** `exploit.c` 代码首先创建一个overlayfs目录结构。然后，使用 `unshare` 系统调用创建一个新的 user namespace 和 mount namespace，并将当前用户的 uid 和 gid 映射到 root 用户。 之后，它挂载 overlayfs，复制当前执行的程序到 overlayfs 的 merge 目录，并使用 `setxattr` 设置 capability。最后，执行复制到 overlayfs 的程序。
5. **投毒风险分析:** 代码本身实现了漏洞利用的功能。 潜在的投毒风险可能存在于以下几个方面：
    *   **依赖项:**  代码依赖于标准的C库，本身不存在恶意依赖。但用户在编译时需要注意编译器环境的安全性。
    *   **代码逻辑:**  代码逻辑相对简单，主要集中在namespace创建、挂载和capability设置。 仔细审查代码，未发现明显的恶意逻辑。
    *   **执行命令:**  代码中使用了 `system` 函数，这是一个潜在的风险点，可以执行任意系统命令。但是，这里只是用来删除目录，相对安全。
       综上所述，该POC代码主要风险在于确保编译环境安全以及对不熟悉的命令保持警惕。投毒风险较低，预估为5%。

**总结：**

该漏洞利用的核心在于结合了未授权用户命名空间和OverlayFS，利用OverlayFS对capabilities设置验证的缺陷，实现了本地提权。 攻击者通过创建特殊的OverlayFS结构并设置文件capabilities，最终获得root权限。

**项目地址:** [inspiringz/CVE-2021-3493](https://github.com/inspiringz/CVE-2021-3493)

**漏洞详情:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)