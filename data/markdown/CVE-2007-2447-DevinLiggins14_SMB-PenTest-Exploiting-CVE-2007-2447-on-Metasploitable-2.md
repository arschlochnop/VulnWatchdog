## CVE-2007-2447-Samba-远程命令注入

**漏洞编号:** CVE-2007-2447

**漏洞类型:** 远程命令注入

**影响应用:** Samba

**危害等级:** 高危，可能导致远程代码执行

**影响版本:** 3.0.0 to 3.0.25rc3

**利用条件:** 需要目标系统运行受影响版本的Samba，并且在smb.conf中启用"username map script"选项（对于SamrChangePassword函数的利用）或者具备对远程打印机和文件共享管理的认证用户权限。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2007-2447 存在于 Samba 3.0.0 到 3.0.25rc3 版本的 smbd 守护程序中。该漏洞允许远程攻击者通过 shell 元字符执行任意命令。该漏洞存在于 MS-RPC 功能中，具体来说，涉及到以下几个方面：

1.  **SamrChangePassword 函数：** 当 `smb.conf` 文件中启用了 `username map script` 选项时，可以通过向 `SamrChangePassword` 函数传递包含 shell 元字符的参数来执行任意命令。
2.  **远程打印机管理：** 经过身份验证的用户可以通过操作远程打印机管理相关的 MS-RPC 函数，并利用 shell 元字符注入执行命令。
3.  **文件共享管理：** 经过身份验证的用户可以通过操作文件共享管理相关的 MS-RPC 函数，并利用 shell 元字符注入执行命令。

**利用方式：**

1.  **识别目标系统：** 确定目标系统运行的 Samba 版本是否在受影响范围内（3.0.0 到 3.0.25rc3）。
2.  **检查配置：** 如果要利用 `SamrChangePassword` 函数的漏洞，需要确认目标系统的 `smb.conf` 文件中是否启用了 `username map script` 选项。
3.  **构造恶意请求：** 构造包含 shell 元字符的恶意 MS-RPC 请求，并将其发送到目标系统的 smbd 守护程序。对于 `SamrChangePassword` 函数，恶意字符应包含在用户名或密码参数中。对于远程打印机和文件共享管理，需要找到相应的 MS-RPC 函数，并在可控的参数中注入恶意字符。
4.  **执行命令：** 成功利用漏洞后，攻击者可以在目标系统上执行任意命令，例如添加用户、修改文件、安装恶意软件等。

**关于提供的 POC 代码：**

提供的 POC 代码只有一个 `README.md` 文件，描述了如何利用 CVE-2007-2447 在 Metasploitable 2 上进行渗透测试。它本身不包含任何漏洞利用代码，而更像是一个教程或指南，因此POC代码有效性依赖实际攻击代码。

**投毒风险分析：**

由于提供的代码只有一个 `README.md` 文件，其中只包含文字描述，所以本身不包含任何可执行的代码。因此，直接在 `README.md` 文件中隐藏投毒代码的可能性很小，可以认为投毒概率较低。 但如果该仓库中的其他资源（如链接、脚本等）指向恶意地址或者包含恶意代码，则存在间接投毒的风险。因此，需要进一步检查该仓库中是否有其他潜在的恶意组件。 因为只有文档，所以认为投毒风险为10%。

**项目地址:** [DevinLiggins14/SMB-PenTest-Exploiting-CVE-2007-2447-on-Metasploitable-2](https://github.com/DevinLiggins14/SMB-PenTest-Exploiting-CVE-2007-2447-on-Metasploitable-2)

**漏洞详情:** [CVE-2007-2447](https://nvd.nist.gov/vuln/detail/CVE-2007-2447)