## CVE-2022-22947-Spring Cloud Gateway代码注入

**漏洞编号:** CVE-2022-22947

**漏洞类型:** 代码注入

**影响应用:** Spring Cloud Gateway

**危害等级:** 高危，允许远程代码执行

**影响版本:** Spring cloud gateway versions 3.1.x prior to 3.1.1+, 3.0.x prior to 3.0.7+ and all old and unsupported versions

**利用条件:** Gateway Actuator endpoint is enabled, exposed and unsecured.

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2022-22947 是一个 Spring Cloud Gateway 中的代码注入漏洞。根据漏洞描述，当 Gateway Actuator 端点启用、公开且未受到保护时，应用程序容易受到代码注入攻击。攻击者可以发送恶意构造的请求，从而允许在远程主机上执行任意远程代码。

**有效性：**
提供的 POC 代码 `CVE-2022-22947-memshell.py` 看起来是有效的。它利用了 SpEL 表达式注入漏洞，通过构造包含恶意 SpEL 表达式的请求，在目标系统上动态定义一个名为 `SpringRequestMappingMemshell` 的类，实现内存马注入。代码首先对恶意类进行base64编码, 然后通过SpEL表达式解码并加载到JVM中,达到了远程代码执行的效果。

**投毒风险：**
评估 POC 代码是否存在投毒风险。代码的主要功能是利用漏洞注入内存马，实现远程代码执行。其中注入的`SpringRequestMappingMemshell`类需要进一步分析。

通过检查代码，发现注入的类功能是注册一个requestMapping，执行的command命令可以从request参数中获取，具有命令执行功能，但它本身是漏洞利用的一部分，不能算作是作者隐藏的投毒代码。

但考虑到任何远程代码执行漏洞都可能被滥用，因此使用此POC的风险仍然较高。考虑到风险的存在，但不是代码编写者有意为之的恶意添加，评估投毒风险为5%。

**利用方式：**
1.  **前提条件：** 目标 Spring Cloud Gateway 实例的 Actuator 端点必须启用、公开且未受保护。
2.  **漏洞利用：** 攻击者构造一个包含恶意 SpEL 表达式的 HTTP 请求，该表达式会被 Gateway Actuator 处理。
3.  **代码注入：** 恶意 SpEL 表达式用于在服务器的内存中定义一个新的 Java 类 (内存马)。
4.  **远程代码执行：** 注入的 Java 类执行攻击者指定的任意代码。

总而言之，此漏洞的利用方式是通过SpEL表达式注入，动态注册一个新的路由，并将处理逻辑绑定到恶意构造的Java类，该类可以接受参数并在服务器上执行任意命令。此过程允许攻击者在目标系统上实现未经授权的远程代码执行。

**项目地址:** [Wrong-pixel/CVE-2022-22947-exp](https://github.com/Wrong-pixel/CVE-2022-22947-exp)

**漏洞详情:** [CVE-2022-22947](https://nvd.nist.gov/vuln/detail/CVE-2022-22947)