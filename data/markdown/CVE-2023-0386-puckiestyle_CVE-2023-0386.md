## CVE-2023-0386 - Linux Kernel OverlayFS Privilege Escalation

**漏洞编号:** CVE-2023-0386

**漏洞类型:** 权限提升

**影响应用:** Linux Kernel (OverlayFS)

**危害等级:** 高危，本地用户可提升权限至 root

**影响版本:** Linux kernel 6.2-rc6 (受影响范围可能更广，需进一步测试)

**利用条件:** 本地用户权限，需要系统开启OverlayFS。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

该漏洞存在于Linux内核的OverlayFS子系统中，当用户尝试将具有 capability 的 setuid 文件从 nosuid 挂载点复制到另一个挂载点时，OverlayFS处理不当导致权限提升。利用方式如下：

1.  **漏洞原理：** OverlayFS 允许将两个目录（lowerdir 和 upperdir）合并到一个视图中（mergedir）。如果 lowerdir 中存在具有 capability 的 setuid 文件，攻击者可以通过精心构造的文件系统操作，使得该文件在 mergedir 中被错误地赋予权限，从而实现权限提升。

2.  **利用步骤（基于提供的代码）：**
    *   **编译：** 使用 `make all` 命令编译 `fuse.c` (fuse文件系统), `exp.c` (漏洞利用程序) 和 `getshell.c` (用于获取 shell 的程序)。
    *   **创建目录：** 创建 overlayfs 所需的 `lowerdir`、`upperdir`、`workdir` 和 `mergedir`。
    *   **FUSE 挂载（Terminal 1）：** 运行 `./fuse ./ovlcap/lower ./gc` 模拟 lowerdir，创建一个具有 setuid 权限的文件 `/file`。
    *   **OverlayFS 挂载（Terminal 2）：** 运行 `./exp` 创建一个新的用户命名空间和挂载命名空间，并将 overlayfs 挂载到 `mergedir`。
    *   **触发漏洞：** `exp.c`尝试在upperdir中创建文件。这个操作配合fuse文件系统，会触发权限提升的漏洞。
    *   **获取 root 权限：**  由于 `/file` 文件现在具有错误的权限，执行它将以 root 权限运行。

3.  **有效性：** 提供的代码看起来有效，因为它实现了上述利用步骤，并包含了编译脚本和相关的源文件。漏洞库信息和搜索引擎结果也表明此漏洞存在且可被利用。

4.  **投毒风险：** 代码中`fuse.c` 和 `getshell.c` 有潜在的投毒风险。`fuse.c`可以被修改以记录用户信息或执行恶意操作，虽然当前代码比较简洁，但存在被修改的可能。`getshell.c` 如果被替换为包含恶意代码的版本，可能在权限提升后执行恶意行为。总体来说，投毒风险较低，大概10%，因为exp.c的主要逻辑是利用漏洞提权，并没有明显的恶意代码。

5.  **缓解措施：**
    *   及时更新Linux内核到已修复的版本。
    *   禁用 OverlayFS，如果不需要的话。
    *   加强对OverlayFS配置的审计，确保配置安全。
    *   使用 AppArmor 或 SELinux 等强制访问控制机制来限制进程的权限。

**项目地址:** [puckiestyle/CVE-2023-0386](https://github.com/puckiestyle/CVE-2023-0386)

**漏洞详情:** [CVE-2023-0386](https://nvd.nist.gov/vuln/detail/CVE-2023-0386)