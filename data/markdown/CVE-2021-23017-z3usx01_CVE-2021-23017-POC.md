## CVE-2021-23017-Nginx Resolver 1-byte内存覆盖

**漏洞编号:** CVE-2021-23017

**漏洞类型:** 内存覆盖

**影响应用:** Nginx

**危害等级:** 中危，可能导致worker进程崩溃或潜在的其他影响

**影响版本:** Nginx Web Server versions 0.6.18 thru 1.20.0 before 1.20.1, Nginx plus versions R13 thru R23 before R23 P1. Nginx plus version R24 before R24 P1

**利用条件:** 需要Nginx配置中使用了"resolver"指令，并且攻击者能够伪造来自DNS服务器的UDP数据包。

**POC 可用性:** 是

**投毒风险:** 1%

## 详情

CVE-2021-23017是Nginx resolver中的一个安全问题，允许攻击者通过伪造来自DNS服务器的UDP数据包，导致1字节的内存覆盖，从而导致worker进程崩溃或潜在的其他影响。

**漏洞利用方式：**

1.  **环境准备：** 目标Nginx服务器需要启用resolver指令，并且攻击者需要位于可以拦截和伪造DNS响应的网络位置。
2.  **ARP欺骗（可选）：**  PoC代码包含ARP欺骗功能，用于将目标服务器的DNS流量重定向到攻击者机器。这依赖于`scapy`库。这部分代码并非必须，如果攻击者已经可以拦截DNS流量，则可以省略。
3.  **DNS请求监听：** 使用`scapy`监听目标服务器发送的DNS请求。
4.  **构造恶意DNS响应：** 当监听到DNS请求时，PoC代码会解析该请求，并构造一个恶意的DNS响应。该响应包含一个精心设计的payload，旨在覆盖目标服务器resolver中的内存。Payload的构造过程如下：
    *   复制原始DNS请求的头部信息。
    *   修改ANCOUNT字段为1，表示响应包含一个answer。
    *   构造answer部分，其中包含指向恶意数据的指针。
    *   恶意数据本身包含一系列'A'字符，以及一个指向原始请求的指针(C0 04)，造成内存覆盖。
5.  **发送恶意DNS响应：** 将构造好的恶意DNS响应发送给目标服务器。由于攻击者已经可以伪造DNS响应，因此该响应将被目标服务器接受。
6.  **内存覆盖：**  恶意DNS响应被解析后，将导致目标服务器resolver中的内存被覆盖，从而可能导致worker进程崩溃或其他影响。

**投毒风险分析：**

代码中存在`os.system`调用，执行了`iptables`命令，阻止了转发到53端口的UDP数据包。这实际上是为了方便利用，防止真实的DNS响应干扰攻击。总体来看，该POC代码的主要目的是验证漏洞，虽然使用了`os.system`,但目的是为poc本身服务，并不能判断为恶意投毒。但是代码编写风格不利于阅读，可读性较差，存在很低的潜在投毒风险，约为1%。


**项目地址:** [z3usx01/CVE-2021-23017-POC](https://github.com/z3usx01/CVE-2021-23017-POC)

**漏洞详情:** [CVE-2021-23017](https://nvd.nist.gov/vuln/detail/CVE-2021-23017)