## CVE-2023-46604-Apache ActiveMQ-RCE

**漏洞编号:** CVE-2023-46604

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Apache ActiveMQ

**危害等级:** 高危，允许远程攻击者执行任意shell命令

**影响版本:** 5.15.0 <= version < 5.15.16, 5.16.0 <= version < 5.16.7, 5.17.0 <= version < 5.17.6, 5.18.0 <= version < 5.18.3

**利用条件:** 需要网络访问ActiveMQ的OpenWire端口 (默认61616)。无需身份验证。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2023-46604 是 Apache ActiveMQ 中的一个反序列化漏洞，存在于 OpenWire 协议的marshaller中。攻击者可以通过操纵 OpenWire 协议中的序列化类类型，使客户端或 broker（取决于哪个易受攻击）实例化 classpath 上的任何类，从而执行任意 shell 命令。

**有效性：** 根据漏洞库信息、搜索结果和提供的POC代码，该漏洞是有效的，并且已经被积极利用。

**投毒风险：**  POC利用方式是发送恶意的XML配置，通过 Spring 的 `ClassPathXmlApplicationContext` 来执行命令。在提供的 `poc.xml` 文件中，包含从攻击者IP地址拉取reverse shell的命令。风险点在于，如果攻击者修改 `poc.xml` 文件，可能会植入恶意后门或其他有害操作。

`rule_protect.txt` 旨在通过 `iptables` 阻止对 61616 端口的访问，降低攻击面，属于防御性质的文件。

`docker-compose.yml` 定义了包含易受攻击的 ActiveMQ 实例和攻击者机器的 Docker 环境，用于快速复现和测试漏洞。本身无恶意代码。

`/tmp/31787494a4240de44c33d47751af417b/exploit.py` 代码从指定的URL加载XML文件，这个URL存在被替换的可能性，如果URL被替换为恶意地址，存在一定的投毒风险，代码本身没有明显的投毒行为，但是存在利用的可能性。

评估：整体的投毒风险较低，大约10%。 主要风险点在于 `poc.xml` 的内容可被恶意修改，但这个风险是所有RCE漏洞的固有风险，而不是代码仓库作者特意植入的。

**利用方式：**

1.  攻击者搭建一个HTTP服务器，用于托管恶意的 `poc.xml` 文件。
2.  攻击者使用 `exploit.py` 脚本，指定 ActiveMQ 服务器的IP地址、端口和 `poc.xml` 文件的URL。
3.  `exploit.py` 脚本将构造包含恶意类的序列化数据包，通过 OpenWire 协议发送给 ActiveMQ 服务器。
4.  ActiveMQ 服务器反序列化该数据包，并实例化 `poc.xml` 中指定的类 `org.springframework.context.support.ClassPathXmlApplicationContext`。
5.  `ClassPathXmlApplicationContext` 加载并解析 `poc.xml` 文件，执行其中定义的命令，即反弹shell到攻击者机器。

根据搜索引擎结果，该漏洞已被 Kinsing 恶意软件利用，表明该漏洞在野外被积极利用。

**项目地址:** [cuanh2333/CVE-2023-46604](https://github.com/cuanh2333/CVE-2023-46604)

**漏洞详情:** [CVE-2023-46604](https://nvd.nist.gov/vuln/detail/CVE-2023-46604)