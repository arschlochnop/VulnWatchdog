## CVE-2021-4034-Polkit pkexec本地提权

**漏洞编号:** CVE-2021-4034

**漏洞类型:** 本地提权

**影响应用:** polkit

**危害等级:** 高危，允许低权限用户获得root权限

**影响版本:** all (受影响版本)

**利用条件:** 目标系统上存在pkexec且未修复漏洞

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-4034 (PwnKit) 是 polkit pkexec 工具中的一个本地权限提升漏洞。pkexec 是一个 setuid 工具，允许未经授权的用户按照预定义的策略以特权用户身份运行命令。此漏洞的利用方式如下：

1.  **漏洞原理：** pkexec 在处理调用参数数量时存在缺陷，导致其尝试将环境变量作为命令执行，从而允许攻击者通过精心构造的环境变量来执行任意代码。
2.  **利用步骤：**
    *   创建一个包含恶意代码的动态链接库 (pwnkit.so)。该库的 `gconv_init` 函数会设置用户ID和组ID为0，然后执行一个shell。
    *   创建一个 `gconv-modules` 文件，用于告诉 `iconv` 如何使用恶意库将 UTF-8 转换为 PWNKIT 编码。
    *   设置 `GCONV_PATH=.` 环境变量，使 `iconv` 在当前目录中查找转换模块。
    *   运行利用程序 (exp)。这个利用程序会触发 pkexec 的漏洞，导致它加载并执行恶意动态链接库，从而获得 root 权限。
3.  **有效性评估：** 根据漏洞信息、搜索结果以及提供的PoC代码，该PoC代码**有效**，可以利用此漏洞实现本地提权。
4.  **投毒风险分析：** 提供的代码中，存在投毒的可能性较低，大约10%。主要风险在于`pwnkit.c`文件，在实际环境中，攻击者可以替换shell的路径或其他恶意代码，例如删除关键文件或植入后门。虽然当前代码的目标是提升权限，但恶意修改后可能造成更大的危害。`chmod -R 777 2>/dev/null` 这行代码较为可疑，虽然看起来像是为了确保执行权限，但也可能是为了方便植入后门或执行其他恶意操作，因为这样会允许任何用户修改这些文件。但考虑到这是已编译后的项目，赋予所有权限以方便使用也在情理之中,因此投毒风险较低。
5. **利用方式总结:** 通过构造特定的环境变量，特别是`GCONV_PATH`，以及相应的`gconv-modules`配置文件，使得`pkexec`加载恶意的动态链接库，该库在初始化时将当前进程的用户ID和组ID设置为0，并执行一个shell，从而获得root权限。

**项目地址:** [Part01-Pai/Polkit-Permission-promotion-compiled](https://github.com/Part01-Pai/Polkit-Permission-promotion-compiled)

**漏洞详情:** [CVE-2021-4034](https://nvd.nist.gov/vuln/detail/CVE-2021-4034)