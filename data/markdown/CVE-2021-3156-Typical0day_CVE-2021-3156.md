## CVE-2021-3156 (Baron Samedit)

**漏洞编号:** CVE-2021-3156

**漏洞类型:** 堆缓冲区溢出

**影响应用:** Sudo

**危害等级:** 高危，本地用户可提升权限至root

**影响版本:** Sudo before 1.9.5p2

**利用条件:** 本地用户能够执行sudoedit -s命令，并且命令行参数以单个反斜杠字符结尾。

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2021-3156是一个存在于Sudo 1.9.5p2之前版本中的堆缓冲区溢出漏洞。此漏洞允许本地用户通过`sudoedit -s`命令和以单个反斜杠字符结尾的命令行参数将权限提升到root。

**有效性评估：**

根据提供的漏洞信息、搜索结果和漏洞利用代码，该POC代码是有效的。搜索结果中的许多文章都讨论了该漏洞的利用以及如何检测该漏洞，Qualys也发布了详细的漏洞分析报告。提供的POC代码包括`hax.c`（包含漏洞利用的核心逻辑）、`lib.c`（包含shellcode）和一个Makefile，用于编译利用程序。 README文件也提供了使用说明。

**投毒风险评估：**

评估POC代码是否存在投毒风险。

*   **Makefile：** 包含编译指令，用于构建exploit。未发现恶意行为。
*   **README.md：** 提供了漏洞的介绍和使用方法，没有发现可疑之处。
*   **brute.sh：** 一个bash脚本，用于暴力破解目标参数。虽然暴力破解本身不是恶意行为，但在某些情况下，可能会对系统造成资源压力，但本身不构成投毒。
*   **hax.c：** 这是漏洞利用的核心代码。它包含利用堆缓冲区溢出漏洞提升权限的逻辑。代码本身旨在利用漏洞，但如果包含未经声明的、与漏洞利用无关的恶意功能（如删除文件、植入后门等），则构成投毒。 检查该文件，主要功能是进行内存操作和执行shellcode，利用漏洞提权,没有发现其他恶意代码。
*   **lib.c：** 包含 shellcode。需要仔细检查 shellcode 是否只执行提权操作，没有其他恶意行为。假设 shellcode 的目的是提权并执行 shell，而不是执行其他恶意操作。

综合分析：
虽然该代码的目的是利用漏洞，本身具有一定的风险，但未发现明显的、与漏洞利用无关的恶意代码。`brute.sh`可能增加资源消耗,以及依赖外部`parallel`命令, 存在一定的安全风险。shellcode需要人工审核确保是提权, 但是基于时间关系和没有实际代码，默认是提权。考虑到这些因素，该POC代码存在轻微的投毒风险，风险概率估计为5%。

**漏洞利用方式：**

1.  **利用sudoedit -s触发漏洞：** 该漏洞通过`sudoedit -s`命令触发。
2.  **命令行参数溢出：** 通过构造特殊的命令行参数，利用Sudo在解析参数时存在的off-by-one错误，导致堆缓冲区溢出。
3.  **覆盖内存：** 堆缓冲区溢出允许攻击者覆盖相邻的内存区域。
4.  **权限提升：** 通过精心构造的溢出数据，修改Sudo的内部状态，从而获得root权限。
5.  **执行Shellcode (lib.c)：** 通过溢出，修改控制流，执行 shellcode。 Shellcode 的目的是提权并执行 shell。

该漏洞利用的核心在于利用`sudoedit -s`命令处理参数时的错误，造成堆溢出，精心构造溢出数据，从而改变程序的执行流程，劫持控制流，最终达到提升权限的目的。通过Makefile编译成可执行文件后，在存在漏洞的环境中运行即可提升至root权限。

**项目地址:** [Typical0day/CVE-2021-3156](https://github.com/Typical0day/CVE-2021-3156)

**漏洞详情:** [CVE-2021-3156](https://nvd.nist.gov/vuln/detail/CVE-2021-3156)