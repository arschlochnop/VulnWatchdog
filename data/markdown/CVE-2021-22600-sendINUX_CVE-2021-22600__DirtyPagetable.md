## CVE-2021-22600 Linux Kernel af_packet.c Double Free 权限提升漏洞

**漏洞编号:** CVE-2021-22600

**漏洞类型:** Double Free

**影响应用:** Linux Kernel

**危害等级:** 高危，本地用户可利用提升权限或拒绝服务

**影响版本:** < 5.4.168, < 5.10.88, < 5.15.11, < 5.16-rc6

**利用条件:** 本地用户权限，需构造特定的系统调用

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-22600 是 Linux Kernel 中 `net/packet/af_packet.c` 文件中的 `packet_set_ring()` 函数存在的一个双重释放漏洞。本地用户可以通过构造恶意系统调用来利用此漏洞提升权限或造成拒绝服务。根据漏洞库信息，该漏洞影响 Linux Kernel 的多个版本，建议升级内核版本或重新编译代码。 

**漏洞利用方式分析：**

提供的漏洞利用代码 `exploit_baseline.c` 采用了一种“Spray and Pray”的方法，结合了DirtyPagetable技术。该代码的利用流程如下：

1.  **Socket 创建和设置：** 创建 `AF_PACKET` 类型的 socket，并设置 `PACKET_VERSION` 为 `TPACKET_V3`。
2.  **`pg_vec` 分配：** 通过设置 `PACKET_RX_RING` 选项，分配 `pg_vec` 结构体（`kmalloc-128` 类型的内存）。`tp_block_nr` 控制着 kmalloc 的大小。
3.  **预分配 slab：** 使用 `signalfd` 对象进行预分配，以便稍后释放时能获得一个空的 slab。
4.  **第一次释放：** 通过将 `tp_block_nr` 设置为 0，触发第一次释放。
5.  **利用 `signalfd` 占用释放的 `pg_vec`：** 再次使用 `signalfd` 对象填充先前释放的内存。
6.  **切换到 `TPACKET_V2`：** 将 `PACKET_VERSION` 设置为 `TPACKET_V2`。
7.  **第二次释放：** 通过设置 `PACKET_RX_RING` 选项并修改相关参数，触发第二次释放（`kmalloc-128`）。
8.  **`seq_operations` 喷射：** 使用 `seq_operations` 对象进行喷射，试图覆盖被释放的 `signal_ctx` 内存区域。
9.  **泄露 `signal_fd`：** 找到特定的 `signal_ctx` 的 fd。
10. **PTE 喷射：** 使用 DirtyPagetable 技术进行 PTE 喷射。
11. **释放资源：** 释放先前分配的 `signalfd` 和 `seq_operations` 对象。

**有效性分析：**

根据搜索引擎结果，CVE-2021-22600 漏洞已被公开披露并被积极利用。该 POC 似乎是基于对该漏洞的深入理解而编写的，利用了 `af_packet` 协议栈中的双重释放漏洞，结合了内存喷射等技术。 因此,该POC代码具有一定的有效性。

**投毒风险分析：**

代码中存在一定的投毒风险，主要体现在以下几个方面：

*   **休眠函数：** 代码中使用了 `sleep(20)` 函数，这可能会在实际利用过程中延迟漏洞触发，增加分析难度，同时，攻击者可能设置更大的休眠时间，用以绕过安全检测机制，该函数可能被用于隐藏恶意行为。
*   **PTE 喷射的不确定性：** PTE 喷射的成功依赖于内存布局，可能不稳定，攻击者可以通过控制喷射参数来影响目标系统的行为，潜在地植入恶意代码。
*   **Cross Cache Attack潜在风险:**代码中注释掉了一段循环释放signal_ctx的逻辑，以及对slabinfo的检查。如果攻击者开启这段代码，配合seq_operations的释放，可能会导致更难以预测的内存破坏，从而影响其他进程或服务。

尽管代码看起来是为了漏洞利用，但潜在的风险在于攻击者可以利用这些机制来隐藏恶意代码或者干扰系统正常运行。考虑到代码作者声明“Only for educational purposes.”，并结合以上分析，**投毒风险评估为10%**。

**项目地址:** [sendINUX/CVE-2021-22600__DirtyPagetable](https://github.com/sendINUX/CVE-2021-22600__DirtyPagetable)

**漏洞详情:** [CVE-2021-22600](https://nvd.nist.gov/vuln/detail/CVE-2021-22600)