## CVE-2019-18634-Sudo-Stack Buffer Overflow

**漏洞编号:** CVE-2019-18634

**漏洞类型:** 栈缓冲区溢出

**影响应用:** Sudo

**危害等级:** 高危，可导致权限提升

**影响版本:** < 1.8.26

**利用条件:** pwfeedback在/etc/sudoers中启用

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2019-18634 存在于 Sudo 1.8.26 之前的版本中。如果 /etc/sudoers 文件中启用了 pwfeedback，普通用户可以触发特权 sudo 进程中的基于栈的缓冲区溢出。根据漏洞信息和搜索结果，POC代码利用了 tgetpass.c 中的 getln() 函数的栈缓冲区溢出漏洞。该利用代码首先配置了反向shell，然后利用缓冲区溢出覆盖了 tgetpass_flags 和 user_details 结构体，以绕过密码验证并获得 root 权限。

**有效性：** 根据提供的漏洞信息、搜索结果（特别是GitHub上的POC仓库）和漏洞利用代码，该漏洞的POC代码是有效的。该代码旨在Ubuntu 20.04上，sudo版本为1.8.25，并且需要安装pwntools。

**投毒风险：** 分析提供的 exploit.py 文件，未发现明显的恶意代码或后门。该脚本的功能集中于利用漏洞本身，创建反向 shell 连接到攻击者控制的端口。 该脚本首先创建一个反向 shell 脚本 `/tmp/reverse.sh`。然后，它尝试启动一个连接到 `127.0.0.1` 上的指定端口 (30678) 的反向 shell。这段代码本身没有隐藏的恶意功能，是漏洞利用的常规组成部分。然后利用缓冲区溢出覆盖 `tgetpass_flags` 和 `user_details` 结构，劫持控制流。

**利用方式：**
1.  **条件检查：** 确认目标系统上的 `/etc/sudoers` 文件中启用了 `pwfeedback` 选项。
2.  **编译环境:** 准备存在漏洞的sudo版本，比如1.8.25，并配置好运行环境如pwntools等。
3.  **缓冲区溢出：** 构造一个长字符串，作为密码输入到 `sudo` 命令中。此字符串会溢出 `getln()` 函数中的栈缓冲区。
4.  **覆盖关键数据：** 在溢出字符串中，覆盖栈上的 `tgetpass_flags` 变量，将其设置为 `TGP_ASKPASS` (0x4)。这会跳过密码验证。
5.  **覆盖用户详情：**覆盖栈上的 user_details 结构，修改用户 ID 为 0，从而获得 root 权限。
6.  **反向 Shell：**利用代码设置环境变量 `SUDO_ASKPASS` 指向一个反向 shell 脚本，并在成功利用漏洞后，通过反向 shell 获得目标系统的 root 权限。

**项目地址:** [aesophor/CVE-2019-18634](https://github.com/aesophor/CVE-2019-18634)

**漏洞详情:** [CVE-2019-18634](https://nvd.nist.gov/vuln/detail/CVE-2019-18634)