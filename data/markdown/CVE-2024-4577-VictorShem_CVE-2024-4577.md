## CVE-2024-4577 - PHP CGI Argument Injection

**漏洞编号:** CVE-2024-4577

**漏洞类型:** 远程代码执行

**影响应用:** PHP (运行于 Windows CGI 模式)

**危害等级:** 高危，允许未经身份验证的攻击者在服务器上执行任意代码

**影响版本:** PHP 8.1.* before 8.1.29, 8.2.* before 8.2.20, 8.3.* before 8.3.8

**利用条件:** Windows 系统上 PHP 以 CGI 模式运行，且系统启用了使用 "Best Fit" 策略的代码页。通常是 XAMPP 环境

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-4577 漏洞是 PHP 在 Windows 系统中以 CGI 模式运行时的一个参数注入漏洞。当系统配置为使用某些代码页时，Windows 可能会使用 "Best-Fit" 行为替换传递给 Win32 API 函数的命令行参数中的字符。PHP CGI 模块可能会将这些字符错误地解释为 PHP 选项，从而允许恶意用户将选项传递给正在运行的 PHP 二进制文件，从而泄露脚本源代码或执行任意 PHP 代码。

**有效性：** 提供的 POC 代码 `CVE-2024-4577.yaml` 看起来是有效的 Nuclei 模板，旨在检测和利用此漏洞。它通过向目标 URL 发送带有特殊构造的 payload 的 HTTP 请求，payload 中包含 `%AD` 字符和恶意的 PHP 配置选项（`allow_url_include=1` 和 `auto_prepend_file=php://input`），以及要执行的 PHP 代码（`<?php phpinfo(); ?>`）。如果漏洞存在且利用成功，服务器应该返回包含 PHP 版本信息的页面。

**投毒风险：**
查看了提供的 POC 代码 `CVE-2024-4577.yaml` 和 `README.md` 文件。其中利用方式是通过构造特定的 URL，包含 `%AD` 字符以及 `allow_url_include` 和 `auto_prepend_file` 等配置项，结合 POST 请求执行 PHP 代码。这个利用过程本身就是一种后门植入的方式，但这是漏洞利用的固有行为，不应被视为恶意投毒。

`README.md` 中包含用于 FOFA 和 Censys 的搜索语句，用于发现暴露在公网上的 XAMPP 服务器。这部分内容本身无害，只是为了方便漏洞发现和利用。但也可能会被恶意攻击者利用。

综合来看，该仓库中不存在明显的恶意投毒代码，但存在被滥用的风险，因此给出 10% 的投毒风险。

**利用方式：**
1.  **环境准备：** 目标系统必须是运行在 Windows 上的 PHP，并且是以 CGI 模式运行。同时，系统的代码页需要启用 "Best Fit" 策略。
2.  **构造 Payload：** 攻击者需要构造包含 `%AD` 字符的特殊 URL，以及恶意的 PHP 配置选项，例如 `allow_url_include=1` 和 `auto_prepend_file=php://input`。其中 `%AD` 是触发 Windows "Best Fit" 转换的关键。
3.  **发送请求：** 攻击者通过 HTTP POST 请求将构造好的 payload 发送到目标服务器的 PHP 脚本，同时在 POST body 中包含要执行的 PHP 代码。
4.  **远程代码执行：** 如果漏洞存在且利用成功，目标服务器将执行 POST body 中的 PHP 代码，从而实现远程代码执行。

**项目地址:** [VictorShem/CVE-2024-4577](https://github.com/VictorShem/CVE-2024-4577)

**漏洞详情:** [CVE-2024-4577](https://nvd.nist.gov/vuln/detail/CVE-2024-4577)