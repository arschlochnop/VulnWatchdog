## CVE-2021-1931-Qualcomm-fastboot-buffer-overflow

**漏洞编号:** CVE-2021-1931

**漏洞类型:** 缓冲区溢出

**影响应用:** Snapdragon Auto, Snapdragon Compute, Snapdragon Connectivity, Snapdragon Consumer IOT, Snapdragon Industrial IOT, Snapdragon Mobile, Snapdragon Voice & Music (多种高通芯片)

**危害等级:** 高危，可能导致代码执行

**影响版本:** 受影响版本众多，见漏洞库信息

**利用条件:** 需要具备fastboot访问权限，通常需要设备进入fastboot模式

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-1931 是Qualcomm芯片fastboot命令处理中存在的缓冲区溢出漏洞。漏洞原因是fastboot命令处理过程中对缓冲区长度验证不当。

**有效性分析：**

根据提供的漏洞信息、搜索结果和漏洞利用代码，可以判断POC代码具有一定的有效性。漏洞库信息确认了漏洞的存在，搜索引擎结果也指向了该漏洞的细节描述。提供的C代码尝试利用libusb库与fastboot设备进行通信，发送"oem info"命令，并解析返回信息以检测固件版本。如果能成功利用fastboot接口发送特制的恶意命令，则可能导致缓冲区溢出，实现代码执行。

**投毒风险分析：**

提供的C代码中，存在一定的投毒风险。风险点在于：

1.  **依赖libusb库：**  攻击者可能修改`libusb` 库的安装方式，引导用户安装恶意版本的库。这部分风险较高，因为用户通常不检查底层库的源代码。
2.  **版本检测逻辑：** 代码中检测固件版本的逻辑存在缺陷，可能被攻击者利用。例如，攻击者可以构造特殊的返回信息，导致代码误判固件版本，从而执行错误的利用代码。这部分风险较低，因为这段逻辑相对简单。
3.  **隐蔽的恶意代码：** 恶意代码可能隐藏在字符串处理的细节中，例如，在解析“oem info”的响应时，如果响应格式不是预期的，可能会导致未定义的行为或缓冲区溢出。

综合考虑，投毒风险评估为10%。主要的风险在于第三方库的替换。

**利用方式分析：**

1.  **进入Fastboot模式：**  首先，需要使目标设备进入fastboot模式。通常，这需要按住特定的按键组合（例如，电源键+音量减小键）启动设备。
2.  **USB连接：**  通过USB数据线将设备连接到运行POC代码的计算机。
3.  **设备枚举：**  POC代码使用libusb库枚举连接的USB设备，查找VID和PID与目标设备匹配的设备（`BB_VID`和`BB_PID`）。
4.  **接口声明：**  代码声明USB接口，并找到输入和输出端点（ep_in和ep_out）。
5.  **发送Payload：**  利用 `write_to_adu` 函数，向目标设备发送精心构造的fastboot命令，其中包含溢出缓冲区的数据。
6.  **执行代码：**  如果溢出成功，攻击者可以控制程序计数器，执行任意代码。

**总结：**
该漏洞利用方式需要较高权限（fastboot访问），但一旦成功，可能导致设备完全受控。提供的POC代码具备漏洞验证和利用的初步框架。通过修改发送的fastboot命令，可以尝试触发缓冲区溢出。

**项目地址:** [FakeShell/CVE-2021-1931-BBRY-KEY2](https://github.com/FakeShell/CVE-2021-1931-BBRY-KEY2)

**漏洞详情:** [CVE-2021-1931](https://nvd.nist.gov/vuln/detail/CVE-2021-1931)