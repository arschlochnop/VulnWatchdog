## CVE-2024-32002 - Git 递归克隆远程代码执行漏洞

**漏洞编号:** CVE-2024-32002

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Git

**危害等级:** 高危，可能导致服务器被完全控制

**影响版本:** 受影响版本包括 2.45.0, 2.44.0, 2.43.0 < 2.43.4, 2.42.0 < 2.42.2, 2.41.0, 2.40.0 < 2.40.2, 以及 < 2.39.4

**利用条件:** 目标系统必须使用大小写不敏感的文件系统且启用符号链接（或未禁用）。需要能够访问恶意Git仓库。

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2024-32002 漏洞允许攻击者通过构造包含恶意子模块的 Git 仓库，在目标系统上实现远程代码执行。漏洞原理是当Git在大小写不敏感的文件系统上递归克隆包含子模块的仓库时，攻击者可以利用大小写差异将文件写入 `.git/` 目录，从而覆盖或创建恶意 hook。当执行 `git clone --recursive` 命令时，恶意 hook 会被触发，导致任意代码执行。

**漏洞利用方式：**

1.  **创建恶意仓库：** 攻击者创建一个包含子模块的 Git 仓库。该子模块的路径经过特殊构造，利用大小写差异（例如 `A/modules/x` 和 `a/modules/x`）以及符号链接，指向子模块的 `.git/` 目录。
2.  **植入恶意Hook：** 在子模块的 `.git/hooks/` 目录下放置恶意的 Git hook 脚本（例如 `post-checkout`）。
3.  **诱导克隆：** 诱导受害者使用 `git clone --recursive` 命令克隆该恶意仓库。
4.  **触发执行：** 当受害者克隆仓库时，由于文件系统的大小写不敏感特性和符号链接，恶意 hook 会被写入 `.git/` 目录并被执行，导致远程代码执行。

**POC有效性评估：**

根据提供的漏洞信息、搜索结果和漏洞利用代码，该POC代码有效。它演示了如何通过精心构造的 Git 仓库和子模块，利用 Git 的递归克隆功能在目标系统上执行任意代码。POC需要用户输入gitea服务器的ip地址、用户名和api token，然后创建两个仓库，并在其中一个仓库中添加恶意hook。另外, 需要手动修改 .gitmodules 文件，指向包含恶意hook的仓库。

**投毒风险评估：**

提供的POC代码主要用于演示漏洞的利用，旨在帮助安全研究人员理解和复现该漏洞。其中涉及的恶意代码（如在 hook 中执行 `calc.exe`）仅用于演示 RCE，并非旨在窃取或破坏用户数据，不构成直接的投毒行为。虽然该POC代码本身不包含投毒代码，但如果被恶意使用者利用，可能会被修改以植入更具破坏性的代码。 因此,投毒的风险概率为0%。

**缓解措施：**

1.  升级 Git 版本到已修复该漏洞的版本（>= 2.39.4, >= 2.40.2, >= 2.41.1, >= 2.42.2, >= 2.43.4, >= 2.44.1, >= 2.45.1）。
2.  禁用 Git 的符号链接支持（`git config --global core.symlinks false`）。
3.  避免克隆来自不受信任来源的 Git 仓库。


**项目地址:** [chrisWalker11/running-CVE-2024-32002-locally-for-tesing](https://github.com/chrisWalker11/running-CVE-2024-32002-locally-for-tesing)

**漏洞详情:** [CVE-2024-32002](https://nvd.nist.gov/vuln/detail/CVE-2024-32002)