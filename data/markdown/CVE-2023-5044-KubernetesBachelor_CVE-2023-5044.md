## CVE-2023-5044-ingress-nginx-代码注入

**漏洞编号:** CVE-2023-5044

**漏洞类型:** 代码注入

**影响应用:** ingress-nginx

**危害等级:** 高危，可能导致集群权限提升，敏感信息泄露

**影响版本:** < 1.9.0

**利用条件:** 需要对 Kubernetes 集群具有较低权限，能够创建 Ingress 资源

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2023-5044 漏洞允许攻击者通过在 `nginx.ingress.kubernetes.io/permanent-redirect` 注释中注入恶意代码来执行任意代码。该漏洞存在于 Kubernetes ingress-nginx controller 1.9.0 之前的版本中。

**有效性评估：**

提供的 PoC 代码利用了 `nginx.ingress.kubernetes.io/permanent-redirect` 注释中的代码注入漏洞。PoC 设置了一个简单的 http-echo 服务，并配置了一个包含漏洞利用的 Ingress 资源。具体来说，它使用了一个精心构造的 `permanent-redirect` 注释，该注释包含恶意 Lua 代码，该代码旨在读取 Ingress Nginx 的 Service Account Token，并尝试创建文件。如果成功读取到 Service Account Token，攻击者可以使用该令牌访问 Kubernetes API 并执行恶意操作。

搜索结果中的信息也表明该漏洞确实存在，并且有多种利用方法。多个安全厂商和研究人员已经发布了关于该漏洞的分析和利用文章，例如 Wiz.io, Covertswarm, CloudDefense.ai 等等，进一步证实了该漏洞的有效性。

**投毒风险分析：**

虽然主要的利用代码是相对清晰和直接的，但是仍然存在潜在的风险。具体分析如下：

1.  **表面代码：** 主要的攻击代码读取 `/var/run/secrets/kubernetes.io/serviceaccount/token` 并返回，这部分是漏洞利用的典型步骤，目的是获取 Ingress Controller 的服务帐户令牌。
2.  **潜在风险代码：** `os.execute("touch /you")` 代码，虽然表面上看起来只是创建一个文件，但是攻击者可能会利用它来检测漏洞是否成功利用，或者作为更复杂攻击的一部分。但它也可能被用于其他潜在的、未明确声明的目的，所以存在一定的风险。

综合来看，仓库的大部分代码是为了演示漏洞利用，但 `os.execute("touch /you")` 代码略有可疑，这部分具有一定的投毒风险，但整体风险较低，大约为10%。

**利用方式：**

1.  **攻击者创建一个恶意的 Ingress 资源：** 该 Ingress 资源包含一个精心构造的 `nginx.ingress.kubernetes.io/permanent-redirect` 注释，其中包含恶意代码。
2.  **恶意代码被注入到 Nginx 配置中：** 当 Ingress Controller 处理该 Ingress 资源时，会将注释中的代码注入到 Nginx 的配置文件中。
3.  **恶意代码被执行：** 当 Nginx 重新加载配置时，恶意代码会被执行。在 PoC 中，恶意代码读取 Ingress Controller 的 Service Account Token 并返回给攻击者。
4.  **攻击者利用 Service Account Token 提升权限：** 攻击者可以使用获得的 Service Account Token 访问 Kubernetes API 并执行恶意操作，例如读取 secret，创建恶意的 workload 等。

**总结：**

CVE-2023-5044 是一个严重的代码注入漏洞，攻击者可以通过该漏洞在 Kubernetes 集群中提升权限并执行恶意操作。提供的 PoC 代码有效，但存在较低的投毒风险。建议尽快升级 Ingress Nginx Controller 到 1.9.0 或更高版本，以修复此漏洞。

**项目地址:** [KubernetesBachelor/CVE-2023-5044](https://github.com/KubernetesBachelor/CVE-2023-5044)

**漏洞详情:** [CVE-2023-5044](https://nvd.nist.gov/vuln/detail/CVE-2023-5044)