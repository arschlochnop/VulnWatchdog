## CVE-2021-3493-Ubuntu OverlayFS 本地提权

**漏洞编号:** CVE-2021-3493

**漏洞类型:** 本地提权

**影响应用:** Ubuntu Linux Kernel (OverlayFS)

**危害等级:** 高危，允许本地用户提升权限至 root

**影响版本:** Ubuntu kernel versions 5.8, 5.4, 4.15, 和 4.4 中受影响的版本（具体版本参见漏洞库信息）

**利用条件:** 目标系统必须是受影响的 Ubuntu 版本，并且启用了非特权用户命名空间和非特权 overlayfs 挂载。

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2021-3493 是 Ubuntu Linux 内核中 OverlayFS 实现中的一个漏洞。该漏洞允许非特权用户利用用户命名空间和非特权 overlayfs 挂载，通过不正确地验证底层文件系统中文件的 capabilities 设置来提升权限。利用方式如下：

1.  **环境准备：**  创建一个基础目录结构，包括 work、lower、upper 和 merge 目录，这是 overlayfs 的标准配置。
2.  **创建用户命名空间：**  使用 `unshare` 命令创建一个新的用户命名空间。这允许在新的命名空间中拥有不同的用户和组 ID。
3.  **配置用户和组映射：**  通过 `/proc/self/setgroups`、`/proc/self/uid_map` 和 `/proc/self/gid_map` 文件设置用户和组 ID 映射，将当前用户的 UID 和 GID 映射到新命名空间中的 root 用户。
4.  **挂载 OverlayFS：**  使用 `mount` 命令挂载 overlayfs 文件系统，将 lower、upper 和 work 目录关联起来。
5.  **设置文件 capabilities：**  复制当前执行程序到 overlayfs 的 merge 目录，并使用 `setxattr` 设置文件的 capabilities 为 `all+ep`，允许该文件执行时拥有 root 权限。
6.  **执行提权后的程序：**  执行位于 upper 目录中的复制后的程序。如果程序检测到自己是通过特定方式（例如，包含 "magic" 字符串或接受 "shell" 参数）调用的，它会调用 `setuid(0)` 和 `setgid(0)` 将进程的 UID 和 GID 设置为 0 (root)，并启动一个 root shell。

**关于投毒风险：**

在提供的 POC 代码中，没有明显的投毒代码。POC 的目的是演示漏洞利用过程，没有发现恶意行为，例如反向 shell 或其他未经授权的访问。


**项目地址:** [ptkhai15/OverlayFS---CVE-2021-3493](https://github.com/ptkhai15/OverlayFS---CVE-2021-3493)

**漏洞详情:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)