## CVE-2022-46169-Cacti-命令注入

**漏洞编号:** CVE-2022-46169

**漏洞类型:** 命令注入

**影响应用:** Cacti

**危害等级:** 高危，允许未经身份验证的用户执行任意命令

**影响版本:** < 1.2.23

**利用条件:** 目标系统运行着受影响版本的Cacti，并且存在具有`POLLER_ACTION_SCRIPT_PHP`动作类型的poller_item。

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2022-46169 是 Cacti 1.2.23 之前版本中存在的一个未经身份验证的命令注入漏洞。攻击者可以通过操纵 `X-Forwarded-For` HTTP Header绕过身份验证，并结合构造恶意的 `poller_id` 参数，在 `remote_agent.php` 文件中执行任意操作系统命令。 

**有效性分析：**

根据漏洞描述和提供的漏洞利用代码，该漏洞利用过程如下：

1.  **身份验证绕过：** 通过设置 `X-Forwarded-For` HTTP Header 为 `127.0.0.1` 来欺骗 `get_client_addr` 函数，使其返回 Cacti 服务器的 IP 地址，从而绕过身份验证检查。
2.  **寻找有效的 `host_id` 和 `local_data_ids[]`：** 漏洞利用代码使用暴力破解的方式查找具有 `POLLER_ACTION_SCRIPT_PHP` 动作类型的 `poller_item` 所对应的 `host_id` 和 `local_data_ids[]`。  这是必要的，因为需要一个特定的配置才能触发命令注入点。
3.  **命令注入：** 构造包含恶意命令的 `poller_id` 参数，并将其发送到 `remote_agent.php`。由于 `poller_id` 参数未经过滤，恶意命令会被注入到 `proc_open` 函数中执行。

参考搜索引擎结果，已经有公开的利用该漏洞的报告和利用代码，表明该漏洞是可利用的。

**投毒风险分析：**

代码本身的主要功能是利用 CVE-2022-46169 漏洞进行命令注入，实现远程代码执行。仔细审查代码，并未发现明显的恶意行为，例如上传恶意文件、篡改系统配置等。但是，任何从互联网上下载的代码都存在潜在风险，因此仍需谨慎使用。

以下是一些潜在的投毒风险和缓解措施：

*   **依赖项风险：** 代码中使用了 `requests` 和 `urllib.parse` 库。虽然这些库本身是安全的，但如果通过 `pip` 安装时，存在被中间人攻击替换为恶意库的风险。 建议从官方源安装依赖项，并验证其完整性。
*   **Payload 风险：** 攻击者可以构造恶意的命令，对目标系统造成破坏。例如，删除关键文件、停止服务等。用户在使用时需要谨慎，避免执行不信任的命令。
*   **隐蔽后门：** 作者可能在代码中添加一些不明显的后门，例如，将执行结果发送到远程服务器，或在系统上创建一个隐藏的账户。 尽管当前代码未发现此类行为，但仍需保持警惕。

综合考虑，认为该代码存在较低的投毒风险，约为 5%。 主要风险来自于使用者自身对命令的控制不当，以及作者可能加入不易察觉的隐蔽后门代码的可能性。使用前应仔细审查代码，并进行安全测试。

**漏洞利用方式：**

1.  攻击者发送带有特制 `X-Forwarded-For` 头的 HTTP 请求到 `remote_agent.php`，绕过身份验证。
2.  攻击者通过暴力破解或其它方式，找到有效的 `host_id` 和 `local_data_ids[]`，它们对应于一个配置为 `POLLER_ACTION_SCRIPT_PHP` 的 `poller_item`。
3.  攻击者构造包含恶意命令的 `poller_id` 参数，并将其发送到 `remote_agent.php`。
4.  服务器执行恶意命令，攻击者获得对服务器的控制权。

**项目地址:** [r1nzleer/RCE-Cacti-1.2.22](https://github.com/r1nzleer/RCE-Cacti-1.2.22)

**漏洞详情:** [CVE-2022-46169](https://nvd.nist.gov/vuln/detail/CVE-2022-46169)