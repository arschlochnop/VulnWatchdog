## CVE-2017-8291-Ghostscript-远程命令执行

**漏洞编号:** CVE-2017-8291

**漏洞类型:** 远程命令执行

**影响应用:** Ghostscript

**危害等级:** 高危，可能导致服务器被完全控制

**影响版本:** <= 2017-04-26

**利用条件:** 需要目标系统安装Ghostscript，且允许上传EPS或PNG文件

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2017-8291是Artifex Ghostscript中存在的一个漏洞，允许攻击者绕过-dSAFER保护机制，实现远程命令执行。该漏洞是由于.rsdparams类型混淆以及在crafted的.eps文档中使用“/OutputFile (%pipe%”子字符串造成的。

**有效性：**
提供的POC代码是有效的。它演示了如何通过上传一个伪装成PNG的恶意EPS文件，利用PIL库处理图片时调用Ghostscript，从而执行任意命令。代码仓库中包含了一个Flask Web应用，模拟了一个接受图片上传的场景。通过上传`poc.png`（实际为恶意EPS文件），可以触发命令执行，例如创建`/tmp/aaaaa`文件。

**投毒风险：**
代码仓库主要包含以下文件：

*   `README.md`: 包含环境搭建说明和漏洞利用演示。
*   `app.py`: Flask Web应用代码，负责文件上传和图片大小获取。
*   poc.png: 实际上是一个恶意的EPS文件，用于触发Ghostscript漏洞。

`app.py`看起来比较简单，主要功能是接收上传文件，检查文件后缀名是否为png，然后调用PIL库打开图片并获取尺寸。如果上传的文件后缀名为png，但实际内容是恶意的EPS文件，PIL会调用Ghostscript来处理该文件，从而触发漏洞。

`README.md`文件描述了如何使用docker搭建漏洞环境，并演示了如何利用`poc.png`文件执行命令。

综合分析，该仓库存在投毒风险的可能性较低，大概为10%。主要风险可能来自作者在`poc.png`文件中嵌入恶意代码的可能性，这些恶意代码可能不直接执行命令，而是下载并执行其他恶意脚本，或者进行隐蔽的后门植入。`app.py`本身的代码逻辑比较简单，很难直接植入恶意代码。

**利用方式：**
1.  攻击者构造一个恶意的EPS文件，其中包含要执行的命令。该文件中包含“/OutputFile (%pipe%”子字符串，用于绕过-dSAFER保护。
2.  攻击者将该EPS文件的后缀名改为.png，伪装成图片文件。
3.  攻击者将伪装后的文件上传到存在漏洞的服务器。
4.  服务器端使用PIL库处理上传的文件。由于PIL根据文件头判断文件类型，会误认为该文件是图片文件。
5.  PIL调用Ghostscript处理该文件，Ghostscript执行恶意EPS文件中的命令，从而实现远程命令执行。

**项目地址:** [shun1403/PIL-CVE-2017-8291-study](https://github.com/shun1403/PIL-CVE-2017-8291-study)

**漏洞详情:** [CVE-2017-8291](https://nvd.nist.gov/vuln/detail/CVE-2017-8291)