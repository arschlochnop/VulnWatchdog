## CVE-2019-5420 - Rails 开发模式远程代码执行

**漏洞编号:** CVE-2019-5420

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Rails

**危害等级:** 高危，允许未经身份验证的攻击者执行任意代码

**影响版本:** < 5.2.2.1, < 6.0.0.beta3 (仅限开发模式)

**利用条件:** 目标Rails应用必须运行在开发模式下，且攻击者能够获取或猜测到应用名称，并能访问应用的网络端口

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2019-5420 是一个存在于Rails框架中的远程代码执行漏洞。该漏洞只影响运行在开发模式下的Rails应用。攻击者可以通过以下步骤利用此漏洞：

1.  **猜测密钥:** 在开发模式下，Rails会自动生成一个secret token，用于加密session数据。此漏洞允许攻击者通过已知的信息（主要是应用程序的名称）来猜测该secret token。`exploit.py` 脚本演示了如何根据应用名称计算出可能的密钥。
2.  **解密 Session:** 获得secret token后，攻击者可以解密服务器的session数据。Rails使用AES-256-GCM加密session，只要知道了密钥，就能解密。
3.  **构造恶意Session:**  攻击者可以修改或构造恶意的session数据，然后使用猜测到的secret token进行加密。
4.  **利用恶意Session:** 将构造好的恶意session发送给服务器。如果服务器没有进行适当的验证，攻击者就可以利用这个session来执行任意代码。

**漏洞利用有效性:**
提供的POC代码 `exploit.py` 旨在帮助攻击者解密Rails应用程序的session，一旦密钥泄露（通过应用程序名称猜测），RCE的可能性非常高。

**投毒风险分析:**
虽然提供的代码看起来像是实现了Session解密和密钥生成的逻辑，但仍存在一定的投毒风险。风险点在于：
*   对 `backports.pbkdf2` 和 `pycryptodome` 的依赖，如果这些库被恶意篡改，可能导致安全问题。但这种风险属于供应链攻击范畴，而非代码本身携带恶意payload。
*   脚本本身并没有明显的恶意行为，例如反向shell或者信息收集。主要功能集中在密钥派生和Session解密上。
综合考虑，我评估投毒风险为 **10%**。主要风险来自于依赖库被篡改的可能性，而POC代码本身的行为相对明确。

**利用方式总结:**
1.  确定目标Rails应用是否运行在开发模式。
2.  确定目标Rails应用的应用名称。
3.  使用 `exploit.py` 脚本，输入应用名称，计算出可能的secret token。
4.  获取服务器的session cookie。
5.  将session cookie输入 `exploit.py` 脚本，解密session数据。
6.  构造恶意的session数据。
7.  使用secret token加密恶意的session数据。
8.  将恶意的session发送给服务器，尝试利用漏洞执行任意代码。

**项目地址:** [j4k0m/CVE-2019-5420](https://github.com/j4k0m/CVE-2019-5420)

**漏洞详情:** [CVE-2019-5420](https://nvd.nist.gov/vuln/detail/CVE-2019-5420)