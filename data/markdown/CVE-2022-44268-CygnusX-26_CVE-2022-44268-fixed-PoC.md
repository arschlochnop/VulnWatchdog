## CVE-2022-44268-ImageMagick-任意文件读取

**漏洞编号:** CVE-2022-44268

**漏洞类型:** 任意文件读取

**影响应用:** ImageMagick

**危害等级:** 高危，可能导致敏感信息泄露

**影响版本:** 7.1.0-49

**利用条件:** 需要ImageMagick处理恶意构造的PNG图片

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2022-44268 漏洞存在于 ImageMagick 7.1.0-49 版本中。当 ImageMagick 解析 PNG 图像时，如果攻击者能够控制 PNG 图像的内容，则可以将任意文件的内容嵌入到结果图像中，从而实现任意文件读取。

**有效性：**
根据漏洞信息和搜索引擎结果，该漏洞是真实存在的，且POC代码可用。提供的POC代码看起来有效，它使用 Pillow 库来创建和修改 PNG 图像，将指定文件的内容添加到 PNG 图像的文本块中。然后，当 ImageMagick 处理该 PNG 图像时，会将嵌入的文件内容输出到结果图像中，从而实现任意文件读取。

**投毒风险：**
分析提供的POC代码和相关文件，发现存在一定的投毒风险，但概率较低（10%）。

*   **README.md:** 提到了 "fixed version"，这可能暗示原始PoC存在问题。但该仓库同时声明修复了某些文件内容无法使用原始PoC的问题，并且提供了提取数据的方法，不能直接定义为投毒。
*   **MagickPNG.py:** 该脚本本身实现了漏洞利用的功能，但没有发现明显的恶意代码。脚本利用 `PIL` 库进行图像处理，功能相对简单。但如果攻击者修改了脚本，例如，在提取文件内容时添加额外的操作（如将提取的内容发送到远程服务器），则可能存在投毒行为。虽然如此，但当前的代码主要实现了POC。
*   **requirements.txt:**  依赖库 `Pillow` 的版本是明确指定的，降低了供应链投毒的风险。

考虑到代码的简洁性以及修复已知PoC问题的说明，投毒风险较低，但不排除经过精心设计的隐蔽恶意代码的存在。

**利用方式：**
1.  准备一张基础图片（例如PNG）。
2.  使用提供的 `MagickPNG.py` 脚本，利用 `-i` 参数指定基础图片，`-f` 参数指定要读取的任意文件，`-o` 参数指定输出的恶意PNG图片。例如：`python3 MagickPNG.py -i base.png -f /etc/passwd -o evil.png`
3.  将生成的 `evil.png` 图片上传到目标服务器，并触发 ImageMagick 对其进行处理（例如，进行缩放、转换等操作）。
4.  如果目标服务器存在漏洞，ImageMagick 在处理 `evil.png` 时，会将 `/etc/passwd` 文件的内容嵌入到结果图像中。
5.  攻击者可以下载处理后的图像，并从中提取 `/etc/passwd` 文件的内容，从而实现任意文件读取。可以使用提供的脚本的`-d`参数提取数据,或使用`exiftool`提取。

总而言之，该漏洞允许攻击者通过上传特制的PNG图像，诱使存在漏洞的ImageMagick服务读取服务器上的任意文件内容。

**项目地址:** [CygnusX-26/CVE-2022-44268-fixed-PoC](https://github.com/CygnusX-26/CVE-2022-44268-fixed-PoC)

**漏洞详情:** [CVE-2022-44268](https://nvd.nist.gov/vuln/detail/CVE-2022-44268)