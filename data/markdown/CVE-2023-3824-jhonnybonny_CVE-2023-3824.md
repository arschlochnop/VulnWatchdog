## CVE-2023-3824 - PHP Phar 堆栈缓冲区溢出

**漏洞编号:** CVE-2023-3824

**漏洞类型:** 堆栈缓冲区溢出

**影响应用:** PHP

**危害等级:** 高危，可能导致内存损坏或远程代码执行

**影响版本:** < 8.0.30, < 8.1.22, < 8.2.8

**利用条件:** 需要能够加载并处理恶意的 Phar 文件。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2023-3824 是一个存在于 PHP Phar 扩展中的堆栈缓冲区溢出漏洞。当 PHP 加载 Phar 文件并读取目录条目时，由于缺少足够的长度检查，可能导致堆栈缓冲区溢出，从而导致内存损坏或远程代码执行。\n\n**有效性分析：**
根据漏洞信息和搜索引擎结果，该漏洞的存在已被确认，且有多个来源表明该漏洞影响特定版本的 PHP。提供的 POC 代码旨在创建一个恶意的 Phar 文件，该文件在被 PHP 处理时会触发缓冲区溢出。根据代码，`create_phar.php` 创建一个 `malicious.phar` 文件，其中包含一个长度接近 `PHP_MAXPATHLEN` 的文件名。`trigger_overflow.php` 使用 `opendir` 和 `readdir` 函数尝试读取恶意 Phar 文件的目录内容，这正是触发漏洞的地方。因此，提供的POC代码是有效的，可以触发该漏洞。
\n**投毒风险分析：**
提供的 POC 代码主要包含两个文件：`create_phar.php` 用于创建恶意的 PHAR 文件，`trigger_overflow.php` 用于触发漏洞。仔细检查这两个文件，可以发现 `create_phar.php` 中的恶意行为是将文件名长度设置为 `PHP_MAXPATHLEN - 1`，这会触发缓冲区溢出。`trigger_overflow.php` 只是简单地打开和读取该 PHAR 文件，并无其他恶意行为。因此，投毒风险较低，主要风险在于利用漏洞本身造成的损害。虽然存在隐蔽后门的可能，但该可能性很小。综合判断，投毒风险为 10%。
\n**利用方式分析：**
1.  **创建恶意 Phar 文件：** 攻击者首先使用 `create_phar.php` 中的代码创建一个包含超长文件名的 Phar 文件。这个文件名长度接近 PHP 允许的最大路径长度，目的是溢出缓冲区。
2.  **触发漏洞：** 然后，攻击者通过某种方式让目标 PHP 应用程序处理这个恶意的 Phar 文件。例如，可以通过上传功能上传该文件，或者通过包含文件的方式让 PHP 加载该文件。
3.  **利用 `opendir` 和 `readdir` 函数：** 当 PHP 尝试使用 `opendir` 和 `readdir` 函数读取 Phar 文件的目录条目时，由于文件名过长，会触发缓冲区溢出，覆盖堆栈上的其他数据。
4.  **潜在的 RCE：** 如果攻击者能够精确控制溢出的内容，他们可能可以覆盖返回地址，从而实现远程代码执行 (RCE)。即使不能直接 RCE，内存损坏也可能导致拒绝服务或其他安全问题。

**项目地址:** [jhonnybonny/CVE-2023-3824](https://github.com/jhonnybonny/CVE-2023-3824)

**漏洞详情:** [CVE-2023-3824](https://nvd.nist.gov/vuln/detail/CVE-2023-3824)