## CVE-2025-39913 - Linux Kernel eBPF SOCKMAP UAF

**漏洞编号:** CVE-2025-39913

**漏洞类型:** Use-After-Free (UAF)

**影响应用:** Linux Kernel

**危害等级:** 高危，可能导致内核崩溃、权限提升甚至任意代码执行

**影响版本:** <= 6.12.38

**利用条件:** 需要目标系统运行受影响的内核版本，且开启了SOCKMAP支持，需要能够加载和运行 eBPF 程序，需要配置好网络环境以便进行socket通信

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2025-39913 漏洞存在于Linux内核的`tcp_bpf_send_verdict()` 函数中。当`bpf_msg_cork_bytes()` 尝试分配 `psock->cork` 失败时，内核可能跳过释放 `sk_msg`，导致内存管理错误。

**利用方式：**

1.  加载一个 eBPF `sk_msg` 程序，该程序调用 `bpf_msg_cork_bytes(msg, cork_bytes)` 设置大于实际发送数据量的 `cork_bytes`。
2.  将该程序附加到 `SOCKMAP`。
3.  将一个 socket 添加到 `SOCKMAP`。
4.  触发内存分配失败（例如，通过 fault injection）。
5.  发送小于 `cork_bytes` 的数据。

由于内存分配失败，`tcp_bpf_send_verdict()` 无法分配 `psock->cork` 来保存数据，并且在没有释放 `sk_msg` 的情况下返回，导致use-after-free。

**有效性评估：**

根据提供的POC代码，该代码旨在利用此UAF漏洞。它包括一个Makefile用于构建，源代码文件（如`main.c`, `load_bpf.c`, `bpf_injection.c`等）以及一个README.md文件，其中包含有关漏洞利用的信息。POC代码包含加载ebpf程序、创建sockmap、发送数据等步骤，与漏洞描述一致，因此POC代码看起来是有效的。

**投毒风险评估：**

分析了提供的POC代码，发现以下潜在风险因素:

* `exit_asm.c` 和 `asm_exit.h`:  包含汇编相关的退出函数，存在一定的风险，可能被用于隐藏恶意代码。如果汇编代码被替换为执行恶意操作的指令，则可能构成投毒。
* `bpf_injection.c`: 这是BPF程序的代码，攻击逻辑都在这里实现, 存在被篡改风险.
* 代码库从第三方平台引用：存在安全风险。
* 检查结果：根据目前提供的文件来看，投毒风险较低，约为10%，主要集中在以上风险点。 但需要对 `exit_asm.c` 和 `bpf_injection.c` 仔细分析，确认其行为是否符合预期。


**项目地址:** [byteReaper77/CVE-2025-39913-](https://github.com/byteReaper77/CVE-2025-39913-)

**漏洞详情:** [CVE-2025-39913](https://nvd.nist.gov/vuln/detail/CVE-2025-39913)