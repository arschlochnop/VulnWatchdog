## CVE-2023-38646 Metabase RCE

**漏洞编号:** CVE-2023-38646

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Metabase

**危害等级:** 高危，未经身份验证即可执行任意命令

**影响版本:** Metabase open source < 0.46.6.1 和 Metabase Enterprise < 1.46.6.1

**利用条件:** 目标Metabase实例可网络访问，且版本在受影响范围内

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2023-38646 允许未经身份验证的攻击者在 Metabase 服务器上执行任意命令。根据漏洞库信息和搜索引擎结果，此漏洞的严重程度为高危，因为攻击者可以完全控制受影响的服务器。

**利用方式：**

1.  **获取 Token:** POC代码首先尝试从 `[TARGET_URL]/api/session/properties` 获取 setup-token。
2.  **构造 Payload:** 利用获取到的token，POC构造一个包含恶意数据库连接字符串的 payload。该字符串中包含可执行命令（通过 `COMMAND` 参数传入），通常通过 Base64 编码进行混淆。
3.  **发送 Payload:** 构造好的payload会被发送到 Metabase 服务器，利用其对数据库连接字符串处理不当的漏洞，执行攻击者指定的命令。
4.  **命令执行:**  通过创建触发器和利用H2数据库特性，实现在服务器上执行任意命令。

**有效性评估：**

根据漏洞描述、搜索引擎结果（例如，[https://www.assetnote.io/resources/research/chaining-our-way-to-pre-auth-rce-in-metabase-cve-2023-38646/](https://www.assetnote.io/resources/research/chaining-our-way-to-pre-auth-rce-in-metabase-cve-2023-38646/) ）和POC代码，此漏洞利用的有效性较高。多个来源表明，该漏洞允许未经身份验证的远程代码执行。

**投毒风险评估：**

POC代码中存在一定的投毒风险。虽然主要功能是利用漏洞执行命令，但代码中存在以下潜在的风险点：

*   **自定义 Base64 编码:**  `CustomBase64Encode` 函数使用自定义的 Base64 编码方式，虽然目的是为了符合漏洞利用的要求，但也可能被用来隐藏恶意代码。
*   **Payload 构造:** Payload的构造过程比较复杂，攻击者可能在payload中嵌入额外的恶意代码，例如，在连接字符串中添加额外的参数，以便在目标服务器上执行其他恶意操作。
*   **代理设置:** 恶意攻击者可能会通过代理服务器发起攻击, 从而隐藏自己的身份信息.

尽管如此，根据代码本身，大部分代码是用于实现漏洞利用功能的，投毒的可能性相对较低，估计在10%左右。需要人工审核Payload构造部分。


**项目地址:** [DaniTheHack3r/CVE-2023-38646](https://github.com/DaniTheHack3r/CVE-2023-38646)

**漏洞详情:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)