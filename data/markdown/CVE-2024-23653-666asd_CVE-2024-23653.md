## CVE-2024-23653-BuildKit-权限绕过

**漏洞编号:** CVE-2024-23653

**漏洞类型:** 权限绕过

**影响应用:** BuildKit

**危害等级:** 高危，可能导致容器逃逸和远程代码执行

**影响版本:** < 0.12.5

**利用条件:** 需要运行BuildKit服务，并使用恶意构造的Dockerfile。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-23653是BuildKit中存在的一个权限绕过漏洞，影响版本低于0.12.5。该漏洞源于BuildKit交互式容器API未充分验证授权，攻击者可以利用特制的Dockerfile，通过`#syntax`指令指定恶意的外部BuildKit前端（例如`docker.io/zdfa/evilerfile`），绕过权限检查，从而运行具有提升权限的容器。这可能导致容器逃逸，在宿主机上执行任意代码。 

**有效性分析：**
提供的POC代码通过指定自定义的BuildKit前端`docker.io/zdfa/evilerfile`，并利用`#syntax`指令来触发漏洞。代码尝试读取`/proc/self/status`文件，检查容器的Capabilities。从提供的输出来看，第一次执行出错，但输出了Capabilities，第二次执行成功，但仍然受到Capabilities限制。这表明POC在一定程度上验证了漏洞的存在，但需要进一步的利用才能完全实现容器逃逸。

**投毒风险分析：**
 代码中存在投毒风险的可能性，但可能性较低（估计10%）。以下是分析：
* `docker.io/zdfa/evilerfile` 这个自定义的BuildKit前端是最主要的风险点。如果这个镜像被篡改，或者作者有意植入恶意代码，那么所有使用它的BuildKit构建过程都会受到影响。攻击者可以在构建过程中执行任意操作，例如窃取敏感信息、修改构建结果、或者在宿主机上安装后门。
*  提供的`evilerfile`的实现细节未知，这意味着我们无法确定它是否包含恶意代码。考虑到这是一位不知名用户提供的镜像，我们有理由保持警惕。
*  Dockerfile中的`grep Cap /proc/self/status` 命令只是一个简单的权限检查，本身不构成威胁，但如果与恶意的BuildKit前端结合，就可能被利用。
*  从目前的证据来看，投毒风险主要集中在 `docker.io/zdfa/evilerfile` 镜像本身，而非Dockerfile或者`buildctl`命令的执行。

**利用方式：**
1.  **指定恶意前端：** 攻击者需要首先创建一个恶意的BuildKit前端镜像（例如`docker.io/zdfa/evilerfile`）。这个镜像可以包含任意的恶意代码。
2.  **构造恶意Dockerfile：**  攻击者需要构造一个Dockerfile，并在第一行使用`#syntax`指令指定上述恶意前端。例如：`#syntax=docker.io/zdfa/evilerfile`。
3.  **执行构建：**  攻击者使用`buildctl build`命令，并指定Dockerfile的路径。当BuildKit执行构建过程时，它会使用攻击者指定的恶意前端来处理Dockerfile。
4.  **权限提升和代码执行：**  恶意前端可以绕过权限检查，从而运行具有提升权限的容器。这使得攻击者可以在容器内部执行任意代码，甚至可以逃逸到宿主机。

综上所述，CVE-2024-23653是一个严重的安全漏洞，攻击者可以通过构造恶意的Dockerfile来绕过权限检查，从而运行具有提升权限的容器。用户应该尽快升级到BuildKit v0.12.5或更高版本，并避免使用来自不受信任来源的BuildKit前端。

**项目地址:** [666asd/CVE-2024-23653](https://github.com/666asd/CVE-2024-23653)

**漏洞详情:** [CVE-2024-23653](https://nvd.nist.gov/vuln/detail/CVE-2024-23653)