## CVE-2025-29824 Windows Common Log File System Driver Elevation of Privilege Vulnerability

**漏洞编号:** CVE-2025-29824

**漏洞类型:** 权限提升 (Elevation of Privilege)

**影响应用:** Windows Common Log File System Driver

**危害等级:** 高危，本地权限提升

**影响版本:** 受影响的Windows版本范围广泛，具体参见CVE描述。

**利用条件:** 本地访问权限

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2025-29824 是一个Windows Common Log File System (CLFS) 驱动中的 Use-After-Free 漏洞。攻击者可以利用此漏洞在本地提升权限。

**漏洞利用方式：**

1.  **触发条件：** 该漏洞发生在 `CClfsRequest::Cleanup` 函数中，该函数在 `CloseHandle` 调用后被调用，用于清理文件对象。`FsContext2` 是一个指向 `CClfsLogCcb` 对象的指针。
2.  **UAF 发生点：** `CClfsRequest::Cleanup` 函数首先调用 `CClfsLogCcb::AddRef` 增加引用计数，然后调用 `CClfsLogCcb::Cleanup`，接着调用 `CClfsLogCcb::Release` 减少引用计数并可能释放 `FsContext2` 指向的内存。
3.  **竞争条件：** 漏洞利用的关键在于 `CClfsRequest::Close` 函数在 `CClfsRequest::Cleanup` 释放 `FsContext2` 之后，但实际执行之前存在时间差。如果此时分配相同大小的内存，则可能重新分配到先前释放的地址，从而导致Use-After-Free。
4.  **利用过程：** 利用该漏洞需要精心构造一个竞争条件，确保在 `FsContext2` 释放后，但在 `CClfsRequest::Close` 使用之前，能够重新分配相同大小的内存，并用恶意数据填充。然后，当 `CClfsRequest::Close` 尝试访问 `FsContext2` 时，会触发 Use-After-Free 漏洞，从而允许攻击者执行任意代码，提升权限。
5. **具体步骤**:
    * 首先，`CloseHandle()` 调用 `CClfsRequest::Cleanup()` 和 `CClfsRequest::Close()` 来释放 `FsContext2`。
    * `CClfsRequest::Cleanup()` 成功运行，但 `CClfsRequest::Close()` 尚未运行。
    * 攻击者分配内存，并且该内存被放置在之前 `FsContext2` 所在的位置。
    * `DeviceIoControl()` 调用一个函数，该函数使用 `FsContext2` 触发 UAF。
    * 最后，`CClfsRequest::Close()` 运行。

**有效性：**

根据漏洞描述和POC分析，此漏洞利用是有效的，因为已经有实际攻击案例。

**投毒风险：**

POC 代码存在一定的投毒风险，因为攻击者可能会在重新分配的内存中注入恶意代码，或者操纵内存分配，劫持控制流。`poison` 概率评估为10%，因为更多的是需要根据目标系统进行定制化的利用，直接添加后门的意义不大，需要结合实际场景。

**项目地址:** [zmkeh/CVE-2025-29824-CLFS-Local-privilege-escalation](https://github.com/zmkeh/CVE-2025-29824-CLFS-Local-privilege-escalation)

**漏洞详情:** [CVE-2025-29824](https://nvd.nist.gov/vuln/detail/CVE-2025-29824)