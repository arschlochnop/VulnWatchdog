## CVE-2022-24112-Apache APISIX-RCE

**漏洞编号:** CVE-2022-24112

**漏洞类型:** 远程代码执行

**影响应用:** Apache APISIX

**危害等级:** 高危，可能导致服务器完全控制

**影响版本:** < 2.12.1, < 2.10.4, 1.3

**利用条件:** 需要启用batch-requests插件，并且使用默认API密钥

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2022-24112 漏洞存在于 Apache APISIX 的 batch-requests 插件中。攻击者可以利用此漏洞绕过 Admin API 的 IP 限制，如果 Apache APISIX 使用默认 API 密钥配置，则可能导致远程代码执行。

**有效性分析：**
提供的 POC 代码利用了 batch-requests 插件的缺陷，通过构造包含恶意 Lua 代码的请求，可以在服务器端执行任意命令。搜索引擎结果也表明该漏洞被广泛关注并存在公开可用的利用代码，因此该 POC 代码有效。

**投毒风险分析：**
POC 代码中存在一定的投毒风险，主要体现在以下几个方面：
1.  **X-API-KEY:**  POC使用了默认的`edd1c9f034335f136f87ad84b625c8f1`。如果目标已经修改了默认密钥，该POC将无法直接使用。虽然不是直接的投毒，但这种硬编码的默认值，可能会导致攻击者在未充分了解环境的情况下进行攻击，从而暴露自身。
2.  **硬编码的 Payload:**  `filter_func` 字段中包含了反弹 shell 的 Lua 代码。这段代码会被直接注入到 APISIX 的配置中。虽然这个反弹shell是攻击者期望的行为，但是也可能被用于植入其他恶意代码或者后门程序。例如, 如果攻击者修改了`os.execute`中的命令，可能会对目标系统造成进一步的危害。
3.  **目标依赖：**该利用代码依赖于目标APISIX使用默认配置，包括API Key等。如果目标修改了默认配置，攻击者直接运行此POC可能导致利用失败，甚至可能触发报警。
总体来说，该 POC 存在一定的投毒风险，但主要集中在利用的便捷性和潜在的二次利用可能性上。该风险评估为 10%。

**利用方式：**
1.  **漏洞触发：** 攻击者首先需要向 `/apisix/batch-requests` 端点发送 POST 请求，该请求的 body 包含一个 JSON 对象，其中 `pipeline` 数组定义了一系列需要执行的请求。
2.  **IP 限制绕过：** 在 `pipeline` 中，攻击者设置了 `X-Real-IP` 头，试图绕过 Admin API 的 IP 限制。由于 batch-requests 插件的缺陷，这个头会被错误地信任，从而允许攻击者从任意 IP 地址访问 Admin API。
3.  **远程代码执行：** 在 `pipeline` 中，攻击者创建或更新一个 route (路由)，并在 route 的 `filter_func` 字段中插入恶意的 Lua 代码。这段 Lua 代码使用 `os.execute` 函数执行 shell 命令，从而实现远程代码执行。POC中使用反弹shell，将目标机器的shell反弹到攻击者的监听端口。
4.  **触发Payload:** 访问payload中指定的uri，触发payload。

**项目地址:** [M4xSec/Apache-APISIX-CVE-2022-24112](https://github.com/M4xSec/Apache-APISIX-CVE-2022-24112)

**漏洞详情:** [CVE-2022-24112](https://nvd.nist.gov/vuln/detail/CVE-2022-24112)