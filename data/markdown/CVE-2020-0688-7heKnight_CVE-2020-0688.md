## CVE-2020-0688 Microsoft Exchange Server 远程代码执行漏洞

**漏洞编号:** CVE-2020-0688

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Microsoft Exchange Server

**危害等级:** 高危，可能导致服务器完全控制

**影响版本:** Microsoft Exchange Server 2010 SP3 UR30, 2013 CU23, 2016 CU14/CU15, 2019 CU3/CU4

**利用条件:** 需要具有Exchange Control Panel (ECP) 的访问权限和有效的Exchange用户凭据。也需要能够访问服务器上的特定URL。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2020-0688 是一个 Microsoft Exchange Server 中的远程代码执行漏洞，该漏洞源于 Exchange Control Panel (ECP) 在反序列化 ViewState 数据时使用了静态密钥。攻击者可以通过构造恶意的 ViewState 数据，利用这个静态密钥进行反序列化，从而在服务器上执行任意代码。

**有效性：** 根据漏洞库信息、搜索引擎结果和提供的POC代码，可以判断该漏洞利用的有效性较高。搜索引擎结果中存在多个关于该漏洞的描述、利用和检测的文章，甚至有公开发布的POC代码。提供的 PowerShell 脚本 `CVE-2020-0688.ps1` 旨在生成恶意的 ViewState，攻击者可以将其注入到 ECP 请求中。

**投毒风险：** 分析提供的POC代码，`CVE-2020-0688.ps1` 脚本主要是生成ViewState，以及调用指定的xaml。`NULL-File.xml` 文件的功能是尝试通过 `Environment.GetEnvironmentVariable` 获取 Exchange 的安装路径，然后修改 `liveiderror.aspx` 文件。风险点在于，如果攻击者修改了 `NULL-File.xml`，他们可以写入任意内容到 `liveiderror.aspx`，甚至可能写入包含后门代码的webshell。因此，存在一定的投毒风险。虽然xml本身是为了利用漏洞，如果攻击者植入webshell到xml文件中进行利用，xml本身就是投毒文件。xml的目的是修改服务器上的文件。但因为给出的样本本身没有后门代码，所以认定投毒风险较低。

**利用方式：**

1.  **获取有效凭据：** 攻击者首先需要获得一个有效的 Exchange 用户账户的凭据。
2.  **计算 ViewStateGenerator：** 根据`/ecp`和目标URI（例如`auth/logon.aspx`）计算`__VIEWSTATEGENERATOR`的值，POC代码`CVE-2020-0688.ps1`正是用于计算和生成该值。
3.  **生成恶意 ViewState：** 使用 POC 脚本 `CVE-2020-0688.ps1` 和 `NULL-File.xml` 生成恶意的 `__VIEWSTATE`。脚本首先读取 `NULL-File.xml` 的内容，然后使用静态密钥进行序列化和签名，生成最终的 `__VIEWSTATE`。
4.  **发送恶意请求：** 攻击者将生成的恶意 `__VIEWSTATE` 和计算出的 `__VIEWSTATEGENERATOR` 注入到发送给 Exchange ECP 的 POST 请求中。例如，攻击者可以向 `autodiscover/autodiscover.xml` 或 `ecp/default.aspx` 发送包含恶意 ViewState 的请求。
5.  **执行代码：** 当 Exchange 服务器处理包含恶意 ViewState 的请求时，由于静态密钥的存在，反序列化过程会成功执行，从而触发 `NULL-File.xml` 中定义的恶意操作，例如写入文件或执行任意代码。

通过以上步骤，攻击者可以利用 CVE-2020-0688 漏洞在未打补丁的 Exchange 服务器上实现远程代码执行，进而控制整个服务器。

**项目地址:** [7heKnight/CVE-2020-0688](https://github.com/7heKnight/CVE-2020-0688)

**漏洞详情:** [CVE-2020-0688](https://nvd.nist.gov/vuln/detail/CVE-2020-0688)