## CVE-2025-38561-ksmbd-竞态条件

**漏洞编号:** CVE-2025-38561

**漏洞类型:** 竞态条件

**影响应用:** ksmbd (Linux Kernel)

**危害等级:** 高危，可能导致拒绝服务或代码执行（具体取决于竞态条件如何被利用）

**影响版本:** Linux kernel 5.15 到受影响的各个分支的修复版本之前

**利用条件:** 目标系统运行ksmbd服务，攻击者能够发送多个SMB会话设置请求

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2025-38561 存在于 Linux kernel 的 ksmbd 服务中，是一个 `Preauh_HashValue` 竞态条件漏洞。当客户端向 ksmbd 发送多个会话设置请求时，可能触发此漏洞。

**利用方式：**
1.  攻击者利用提供的 `exploit.py` 脚本，指定目标IP地址，线程数，以及包含SMB协商和会话设置数据的二进制文件 (默认 `negotiate.bin` 和 `session_setup.bin`)。
2.  脚本会创建多个线程，每个线程并发地向目标服务器发送 SMB 协商和会话设置请求。
3.  通过高并发请求触发 `Preauh_HashValue` 的竞态条件，如果成功利用，可能导致 ksmbd 服务崩溃，或更严重的安全问题，例如代码执行。

**有效性评估：**
提供的 POC 代码 (`exploit.py`) 尝试通过并发发送会话设置请求来利用竞态条件。漏洞描述确认该竞态条件存在于特定版本的 Linux 内核中。因此，如果目标系统符合漏洞描述中的受影响版本，则提供的 POC 代码可能有效。

**投毒风险评估：**
虽然代码的目的是利用竞态条件，但仍需考虑代码中可能存在的恶意行为。

* `exploit.py` 脚本读取外部文件 `negotiate.bin` 和 `session_setup.bin`。攻击者可能替换这些文件为恶意文件，使得攻击者可以自定义发送的数据包，从而达到植入后门等恶意目的。需要谨慎对待这些外部文件，确保来源可信。
* `session.py` 脚本的作用是帮助创建和发送SMB数据包，从代码逻辑上来看，没有发现明显的恶意行为。
*  在 `mal_conn` 函数中的 `os.system` 调用被注释掉了，所以不存在直接执行系统命令的情况，因此直接的命令注入风险较低。
* 脚本中没有发现明显的后门或恶意代码，但是攻击者可能通过修改脚本中的参数或添加额外的功能来植入后门。

**结论：**
漏洞利用代码的有效性取决于目标系统的版本和配置。投毒风险较低，主要风险在于外部的SMB请求二进制文件可能被替换。建议在可信的环境中测试和验证 POC 代码，并仔细审查用到的外部二进制文件。

**项目地址:** [toshithh/CVE-2025-38561](https://github.com/toshithh/CVE-2025-38561)

**漏洞详情:** [CVE-2025-38561](https://nvd.nist.gov/vuln/detail/CVE-2025-38561)