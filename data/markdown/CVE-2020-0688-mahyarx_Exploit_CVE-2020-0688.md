## CVE-2020-0688-Microsoft Exchange Server-远程代码执行

**漏洞编号:** CVE-2020-0688

**漏洞类型:** 远程代码执行

**影响应用:** Microsoft Exchange Server

**危害等级:** 高危，可完全控制受影响的Exchange服务器

**影响版本:** Microsoft Exchange Server 2010 SP3 UR30, 2013 CU23, 2016 CU14/CU15, 2019 CU3/CU4

**利用条件:** 需要Exchange服务器Web界面访问权限和有效的凭据或者能够获取到有效的凭据，以及目标服务器未安装相关补丁

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2020-0688是Microsoft Exchange Server中的一个远程代码执行漏洞。该漏洞是由于Exchange在安装时未能正确创建唯一的密钥导致的。攻击者可以利用该漏洞，通过构造恶意的ViewState，在受影响的Exchange服务器上执行任意代码，完全控制服务器。

**有效性：**
根据漏洞库信息和搜索结果，该漏洞已经确认存在并且有公开的PoC。提供的PoC代码看起来有效，因为它利用了静态密钥进行ViewState反序列化，从而执行任意代码。

**投毒风险：**
提供的PoC代码主要功能是生成恶意的ViewState，本身不包含明显的恶意代码，例如直接执行shell命令。但是，`NULL-File.xml`文件中通过`Environment.GetEnvironmentVariable` 获取 `ExchangeInstallPath`，然后向`ClientAccess\Autodiscover\Imx.aspx`写入空字符串, 这种操作行为可以被用于删除或者篡改文件，从而导致拒绝服务等攻击，存在一定的潜在风险，但概率较低。因此，投毒风险估计为10%。

**利用方式：**
1.  **获取密钥：**  攻击者需要获取受影响Exchange服务器的`validationKey`和`decryptionKey`。由于CVE-2020-0688利用的是静态密钥，所以可以事先计算好或者从网上找到公开的密钥（如果目标环境未使用更新过的补丁）。
2.  **构造恶意ViewState：**  攻击者利用获取的密钥，结合`TextFormattingRunPropertiesMarshal`类创建一个可以执行任意代码的反序列化对象，并将其序列化。
3.  **计算__VIEWSTATEGENERATOR：**PoC代码中计算`__VIEWSTATEGENERATOR`的方式与实际利用一致。`__VIEWSTATEGENERATOR`用于验证ViewState的来源，需要正确计算才能成功利用。
4.  **发送请求：**  攻击者将构造好的ViewState作为参数，通过HTTP POST请求发送到Exchange服务器的`ecp`虚拟目录。通过精心构造的Xaml，恶意代码在服务器端被反序列化并执行。
5.  **控制服务器：**  成功利用该漏洞后，攻击者可以在Exchange服务器上执行任意代码，从而完全控制服务器。

**项目地址:** [mahyarx/Exploit_CVE-2020-0688](https://github.com/mahyarx/Exploit_CVE-2020-0688)

**漏洞详情:** [CVE-2020-0688](https://nvd.nist.gov/vuln/detail/CVE-2020-0688)