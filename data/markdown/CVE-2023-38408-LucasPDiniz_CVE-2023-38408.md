## CVE-2023-38408-OpenSSH-RCE

**漏洞编号:** CVE-2023-38408

**漏洞类型:** 远程代码执行

**影响应用:** OpenSSH

**危害等级:** 高危，可能导致远程代码执行和权限提升

**影响版本:** < 9.3p2

**利用条件:** 需要开启ssh-agent转发功能，并且攻击者能够控制目标服务器文件系统

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

该漏洞存在于OpenSSH的ssh-agent的PKCS#11功能中，由于搜索路径不安全导致。攻击者可以通过控制转发的agent-socket，并在受害者机器上写入文件，从而执行任意代码。根据提供的POC，攻击者首先连接到服务器，然后利用`nc`将shellcode注入到agent的内存中，再通过`ssh-add -s`加载恶意的动态链接库，触发SIGSEGV信号来劫持程序执行流程，最终通过shellcode建立反向连接。

**漏洞利用有效性评估：**

根据漏洞描述和POC代码，该漏洞利用方法是有效的。POC详细描述了利用过程，包括如何获取SSH Agent socket，如何注入shellcode，以及如何利用SIGSEGV信号劫持控制流。

**投毒风险评估：**

仓库本身主要提供的是漏洞的利用方法和复现步骤，直接的恶意代码(比如后门)可能性较低，但仍然存在一定的风险。例如，POC中依赖的动态链接库和shellcode可能存在被替换成恶意版本的风险，例如监听反弹shell。另外，利用过程中需要手动执行一些步骤，这使得插入恶意代码的机会增加。考虑到POC代码的复杂性和潜在的风险，投毒风险估计为10%。

**漏洞利用方式：**

1.  **前提条件:** 需要OpenSSH Agent Forwarding开启，攻击者需要能够控制目标服务器的文件系统，并且目标OpenSSH版本低于9.3p2。
2.  **获取SSH Agent Socket:** 攻击者需要找到受害者SSH Agent的Socket文件（`$SSH_AUTH_SOCK`）。
3.  **注入Shellcode:**  利用`nc`命令将精心构造的shellcode注入到SSH Agent进程的内存中。Shellcode的目的是建立一个反向连接，让攻击者可以执行命令。
4.  **加载恶意动态链接库:** 使用 `ssh-add -s` 命令添加恶意的动态链接库 (`libttcn3-rt2-dynamic.so`, `libKF5SonnetUi.so.5.92.0` 和 `libns3.35-wave.so.0.0.0`)。
5.  **触发SIGSEGV:**  加载的恶意动态链接库会触发一个段错误 (SIGSEGV)。
6.  **劫持控制流:**  通过劫持SIGSEGV信号处理程序，将程序控制流导向之前注入的shellcode。
7.  **反向连接与命令执行:**  Shellcode建立一个反向连接，攻击者可以通过这个连接在受害者机器上执行任意命令。

**项目地址:** [LucasPDiniz/CVE-2023-38408](https://github.com/LucasPDiniz/CVE-2023-38408)

**漏洞详情:** [CVE-2023-38408](https://nvd.nist.gov/vuln/detail/CVE-2023-38408)