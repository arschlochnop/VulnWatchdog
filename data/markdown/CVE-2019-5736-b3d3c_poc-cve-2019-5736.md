## CVE-2019-5736-runc容器逃逸

**漏洞编号:** CVE-2019-5736

**漏洞类型:** 容器逃逸

**影响应用:** runc

**危害等级:** 高危，可获取宿主机root权限

**影响版本:** <= 1.0-rc6

**利用条件:** 需要能够以root身份在受影响的容器中执行命令（无论是新创建的容器使用攻击者控制的镜像，还是已存在的容器攻击者具有写入权限并可使用docker exec附加）

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2019-5736 漏洞允许攻击者通过文件描述符处理不当的问题，覆盖宿主机的 runc 二进制文件，从而获得宿主机的 root 权限。

**利用方式：**

1.  攻击者需要在具有漏洞的Docker版本中使用runc。
2.  攻击者需要在容器中拥有root权限，可以通过两种方式实现：
    *   创建一个新的容器，使用攻击者控制的镜像。
    *   攻击者已经对现有容器拥有写入权限，并且可以使用`docker exec`命令附加到该容器。
3.  利用代码首先更新apt源并安装必要的编译工具和依赖库libseccomp。
4.  然后，它会创建一个名为`stage1.c`的C程序，该程序会在容器启动时运行（通过`__attribute__ ((constructor))`）。`stage1.c`尝试打开`/proc/self/exe`（即runc二进制文件），获取其文件描述符，然后执行`/stage2`，并将runc的文件描述符作为参数传递。
5.  利用代码创建另一个名为`stage2.c`的C程序。`stage2.c`接收`/proc/self/exe`的文件描述符，打开该文件，并写入恶意bash脚本。恶意bash脚本的功能是：读取宿主机的`/etc/shadow`文件，将其复制到容器的`/root/shadow.txt`，然后使用`docker cp`命令将`/root/shadow.txt`复制到名为`test`的容器中。这个步骤需要Docker CLI可用和正确配置。
6.  利用代码将`/bin/bash`重命名为`/bin/good_bash`，然后创建一个符号链接，将`/bin/bash`指向`/proc/self/exe`，从而使得后续执行的bash命令实际上是执行runc二进制文件（已经被stage2.c修改）。
7.  关键在于`/proc/self/exe`允许容器内的进程访问宿主机上的runc二进制文件，攻击者通过覆盖这个文件来实现容器逃逸。

**有效性：**

提供的PoC代码是有效的，它演示了如何覆盖宿主机上的runc二进制文件。成功利用该漏洞可以使攻击者在宿主机上执行任意命令，从而完全控制宿主机。

**投毒风险：**

该PoC代码本身的目的在于演示漏洞，但存在一定的投毒风险。例如，`stage2.c`中写入的文件`/root/shadow.txt`，虽然目的是为了复制`/etc/shadow`，但恶意攻击者可能会修改写入的内容，植入更隐蔽的后门代码。代码里使用了sed修改源列表，apt安装软件包,这些都是常见的持久化后门植入点.此外，`/bin/bash`被替换成指向runc二进制文件的符号链接，这可能导致宿主机上的其他容器出现异常行为.总体评估投毒风险为10%。

**项目地址:** [b3d3c/poc-cve-2019-5736](https://github.com/b3d3c/poc-cve-2019-5736)

**漏洞详情:** [CVE-2019-5736](https://nvd.nist.gov/vuln/detail/CVE-2019-5736)