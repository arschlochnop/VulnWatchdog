## CVE-2017-5638 Apache Struts远程代码执行

**漏洞编号:** CVE-2017-5638

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Apache Struts

**危害等级:** 高危，可能导致服务器被完全控制

**影响版本:** 2.3.x (before 2.3.32), 2.5.x (before 2.5.10.1)

**利用条件:** 目标系统运行存在漏洞版本的Apache Struts，且允许外部访问。

**POC 可用性:** 是

**投毒风险:** 20%

## 详情

CVE-2017-5638是Apache Struts Jakarta Multipart解析器中的一个漏洞，由于不正确的异常处理和错误消息生成，允许远程攻击者通过精心构造的Content-Type、Content-Disposition或Content-Length HTTP头执行任意命令。漏洞利用方式是通过在HTTP请求头中注入OGNL表达式，服务器在解析过程中会执行该表达式，从而实现远程代码执行。

**有效性：**
根据漏洞库信息和搜索引擎结果，该漏洞在野外被广泛利用，并且存在多个可用的POC。提供的POC代码`Invoke-WebRequest -Uri "http://localhost:8080/" -Method POST -Headers @{ "Content-Type" = "%{#context['com.opensymphony.xwork2.dispatcher.HttpServletResponse'].addHeader('AttackSuccessTestingRCE',2*2)}.multipart/form-data" }` 尝试通过修改Content-Type头来触发漏洞，并设置一个特定的header 'AttackSuccessTestingRCE' 来检测漏洞是否被成功利用，该代码能够达到漏洞检测效果，因此该POC有效。

**投毒风险：**
提供的两个文件，一个是PowerShell命令用于测试，另一个是Jupyter Notebook，其中定义了一个 Flask 应用来模拟存在漏洞的 Struts 应用，并检测 header 中是否存在恶意代码的特征。虽然这个 Flask 应用本身是为了演示漏洞，但如果直接部署到生产环境，可能存在潜在的风险。但是代码分析来看，没有明显的恶意代码。Demos.ipynb 中的检测恶意代码的逻辑 `SUSPICIOUS_PATTERNS = ["%{", "Runtime.getRuntime", "ProcessBuilder"]`，可以检测到OGNL表达式相关的Payload。因此投毒风险存在，但不是很高，大约20%。

**利用方式：**
攻击者通过发送包含恶意OGNL表达式的HTTP请求，该表达式被注入到Content-Type、Content-Disposition 或 Content-Length 等HTTP头中。Struts在处理Multipart请求时，由于使用了存在漏洞的Jakarta Multipart解析器，会尝试解析这些头，从而触发OGNL表达式的执行。攻击者可以利用OGNL表达式执行任意系统命令，例如下载恶意软件、修改系统配置或窃取敏感数据。

**项目地址:** [kaylertee/Computer-Security-Equifax-2017](https://github.com/kaylertee/Computer-Security-Equifax-2017)

**漏洞详情:** [CVE-2017-5638](https://nvd.nist.gov/vuln/detail/CVE-2017-5638)