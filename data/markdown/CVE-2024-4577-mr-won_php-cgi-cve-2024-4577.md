## CVE-2024-4577-PHP-CGI参数注入

**漏洞编号:** CVE-2024-4577

**漏洞类型:** 远程代码执行

**影响应用:** PHP

**危害等级:** 高危，可导致服务器被完全控制

**影响版本:** PHP 8.1.* before 8.1.29, 8.2.* before 8.2.20, 8.3.* before 8.3.8

**利用条件:** Windows系统，运行在CGI模式下，并且系统启用了使用"Best Fit"策略的代码页。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-4577是一个PHP-CGI参数注入漏洞，存在于Windows系统上的PHP CGI实现中。当PHP以CGI模式运行时，如果系统启用了使用"Best Fit"策略的代码页，Windows可能会使用"Best-Fit"行为来替换命令行中的字符，导致PHP CGI模块错误地将这些字符解释为PHP选项，攻击者可以通过构造特殊的URL，向PHP二进制文件传递恶意参数，从而实现远程代码执行。

**有效性：**

根据漏洞库信息和搜索结果，此漏洞已经确认有效，并且存在公开的PoC代码，Metasploit也发布了相应的利用模块。 Akamai的研究表明，漏洞披露后不久就观察到了大量的利用尝试。

**投毒风险：**

提供的PoC代码实际上是一个README.md文件，描述了对CVE-2024-4577的事件检测。其中提到了利用`%AD`进行参数注入，服务器通过自动转换功能（Best-fit）可能会将该字符转换为其他可执行的参数，从而进行二次攻击。代码本身没有明显的投毒行为，但存在通过代码描述引导攻击者进行恶意利用的可能性。因此,该存储库存在的投毒风险较低，大约10%。

**利用方式：**

1.  **环境要求：** 受影响的PHP版本（8.1.* before 8.1.29, 8.2.* before 8.2.20, 8.3.* before 8.3.8）、Windows服务器、PHP以CGI模式运行、系统启用使用"Best Fit"策略的代码页。
2.  **漏洞触发：** 攻击者构造包含特殊字符（如`%AD`）的URL，发送给目标服务器。
3.  **参数注入：** Windows的"Best Fit"机制将特殊字符转换为其他字符，PHP CGI模块错误地将转换后的字符解析为PHP选项。
4.  **代码执行：** 攻击者可以通过注入`-d`参数来修改php.ini配置，例如禁用`disable_functions`，或者通过其他方式执行任意PHP代码。
5.  **远程控制：** 成功执行PHP代码后，攻击者可以获取服务器的控制权。

**项目地址:** [mr-won/php-cgi-cve-2024-4577](https://github.com/mr-won/php-cgi-cve-2024-4577)

**漏洞详情:** [CVE-2024-4577](https://nvd.nist.gov/vuln/detail/CVE-2024-4577)