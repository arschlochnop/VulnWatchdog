## CVE-2024-38475-Apache-mod_rewrite文件读取/代码执行

**漏洞编号:** CVE-2024-38475

**漏洞类型:** 文件读取/代码执行

**影响应用:** Apache HTTP Server

**危害等级:** 高危，可能导致源代码泄露和远程代码执行

**影响版本:** <= 2.4.59

**利用条件:** 服务器启用了 mod_rewrite 模块并且存在不安全的 RewriteRule 配置，特别是当重写规则的目标路径包含来自反向引用或变量的片段时。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-38475 是 Apache HTTP Server 2.4.59 及之前版本 mod_rewrite 模块中存在的一个不当输出转义漏洞。该漏洞允许攻击者通过构造恶意的 URL，将其映射到服务器允许提供但并非有意通过 URL 直接访问的文件系统位置，从而导致代码执行或源代码泄露。

**有效性评估：**

根据漏洞描述，搜索引擎结果（特别是SonicWall的案例）以及提供的POC代码，可以判断此POC代码有效。
POC代码 `script.py` 通过对目标URL进行 fuzzing，尝试利用 `mod_rewrite` 的缺陷来访问受保护的目录或文件。
它通过对目录和文件使用字典爆破，并附加 `%3F` 或 `%3Faaaaaaaaaaaaaaaaaaaaaa.php` 这样的 payload，尝试绕过服务器的安全检查，以达到泄漏源代码的目的。

**投毒风险评估：**

提供的 POC 代码的主要功能是利用 `mod_rewrite` 的漏洞进行目录枚举和源代码泄露尝试。代码本身并没有明显的恶意行为，例如执行系统命令或上传恶意文件。
但是，代码中使用了外部文件（`webroots.txt`，`raft-medium-directories.txt`，`raft-medium-files.txt`）作为输入。如果这些文件被篡改，例如添加了精心构造的路径或文件名，可能会导致代码利用漏洞尝试访问或泄露敏感信息，或者触发其他未预期的行为。
考虑到代码依赖外部字典文件以及可能被用于非法目的，存在一定的投毒风险，大约为10%。

**利用方式：**

1.  **不安全 RewriteRule 配置：** 该漏洞的根本原因是 Apache HTTP Server 的 `mod_rewrite` 模块中存在不安全的重写规则。当重写规则的目标路径包含来自反向引用或变量的片段时，可能会出现问题。如果这些片段没有经过适当的转义，攻击者可以通过控制这些片段来构造恶意的路径，从而访问服务器上的任意文件。
2.  **Payload 构造：** 攻击者通过构造特殊的 URL，利用 `mod_rewrite` 模块的缺陷，将 URL 映射到文件系统的敏感位置。例如，可以使用 `?` 或其他特殊字符来绕过路径检查。
3.  **源代码泄露：** 通过成功利用该漏洞，攻击者可以读取服务器上的源代码文件，从而了解应用程序的内部结构和逻辑。这可能会为进一步的攻击提供信息。
4.  **代码执行：** 如果攻击者能够将恶意代码（例如 PHP 脚本）上传到服务器，并利用该漏洞执行该代码，就可以实现远程代码执行。

**缓解措施：**

1.  升级 Apache HTTP Server 到 2.4.60 或更高版本。
2.  仔细检查 `mod_rewrite` 的配置，确保所有重写规则都是安全的，特别是当重写规则的目标路径包含来自反向引用或变量的片段时。使用 "UnsafePrefixStat" rewrite flag,如果确信重写规则目标路径适当限制.
3.  限制 Apache HTTP Server 的文件系统访问权限，只允许其访问必要的文件和目录。
4.  使用 Web 应用防火墙（WAF）来过滤恶意请求。

**项目地址:** [soltanali0/CVE-2024-38475](https://github.com/soltanali0/CVE-2024-38475)

**漏洞详情:** [CVE-2024-38475](https://nvd.nist.gov/vuln/detail/CVE-2024-38475)