## CVE-2025-1974-ingress-nginx-RCE

**漏洞编号:** CVE-2025-1974

**漏洞类型:** 远程代码执行(RCE)

**影响应用:** ingress-nginx

**危害等级:** 高危，可能导致集群范围内的 Secrets 泄露和任意代码执行

**影响版本:** <=1.11.4 和 1.12.0

**利用条件:** 需要对 Pod 网络访问权限

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2025-1974 是 Kubernetes ingress-nginx 中的一个严重漏洞，允许未经身份验证的攻击者通过 Pod 网络访问权限，在 ingress-nginx 控制器的上下文中执行任意代码。这可能导致 Secrets 泄露（默认安装可以访问整个集群的 Secrets）。

**利用方式：**

1.  **漏洞原理：** 该漏洞是由于 ingress-nginx 验证 Admission Controller 功能中的配置注入漏洞造成的，允许攻击者通过特制的 Ingress 资源绕过路径限制。
2.  **攻击步骤：**
    *   攻击者需要能够访问 Pod 网络。
    *   攻击者构造包含恶意配置的 Ingress 资源，特别是利用 `nginx.ingress.kubernetes.io/auth-url` 注释。
    *   恶意配置通过 Admission Controller 被注入到 nginx.conf 中。
    *   通过精心构造的配置，攻击者可以加载恶意的动态链接库 (shell.so) 到 nginx 进程中，从而执行任意代码。
3.  **POC 分析：**
    *   `Makefile`：使用 Docker 构建 shell.so 动态链接库。
    *   `build.sh`：用于在 Alpine Linux 环境中编译 shell.so，确保其与 ingress-nginx 控制器的环境兼容 (musl-libc)。使用了国内镜像加速。
    *   `shell.c`（未提供，但根据 README 可知需要修改 IP 地址）：该文件包含恶意代码，通常是一个反弹 shell，用于在目标系统上建立连接。
    *   `exploit.py`：该 Python 脚本利用该漏洞。
        *   它首先读取 shell.so 的内容。
        *   然后，它循环遍历可能的 PID 和 FD 范围，猜测包含 nginx 配置文件的 /proc 文件路径。
        *   它构造包含恶意 `nginx.ingress.kubernetes.io/auth-url` 注释的 Ingress 资源，其中包含指向猜测的 /proc 文件路径的 `ssl_engine` 指令。当 Admission Controller 处理这个 Ingress 资源时，会将恶意配置注入到 nginx.conf 中，从而加载 shell.so。
        *   同时，它还尝试上传 shellcode 到一个URL，这个URL是需要预先部署的，目的是为了将shellcode写入到/proc/pid/fd/fd中去.这里存在竞争条件。
    *   `req.json`：包含 Ingress 资源的 JSON 模板，用于发送到 Admission Controller。
    *   `pyproject.toml`：Python 项目的依赖声明，需要 httpx 库。

**有效性：**

根据漏洞信息和 POC 代码分析，该 POC 代码是有效的，如果满足漏洞利用条件，可以成功实现远程代码执行。

**投毒风险：**

该仓库存在一定的投毒风险。具体如下：

*   `shell.c` 代码未提供，无法确认其功能是否超出反弹 shell 的范围。存在植入恶意后门的可能。
*   `exploit.py` 代码中 `upload()` 函数向外部 URL 上传 shellcode，这个 URL 如果被攻击者控制，可能导致上传恶意代码。
*   虽然使用了国内镜像源加速，但仍然存在被劫持的风险。

综合评估，投毒风险大约为 10%，主要是 `shell.c` 代码未知和 `upload()` 函数的潜在风险。

**项目地址:** [Rickerd12/exploit-cve-2025-1974](https://github.com/Rickerd12/exploit-cve-2025-1974)

**漏洞详情:** [CVE-2025-1974](https://nvd.nist.gov/vuln/detail/CVE-2025-1974)