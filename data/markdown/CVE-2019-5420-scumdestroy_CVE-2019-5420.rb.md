## CVE-2019-5420 - Rails Development Mode Remote Code Execution

**漏洞编号:** CVE-2019-5420

**漏洞类型:** 远程代码执行

**影响应用:** Rails

**危害等级:** 高危，可能导致服务器完全控制

**影响版本:** < 5.2.2.1, < 6.0.0.beta3

**利用条件:** Rails应用运行在开发模式下

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2019-5420 漏洞允许攻击者在Rails应用处于开发模式时执行远程代码。这是因为开发模式下 Rails 自动生成的 secret token 容易被猜测。攻击者通过猜测到的 secret token，结合 Rails 内部机制，可以提升权限并执行任意代码。

**有效性：**
提供的PoC代码有效。它通过以下步骤利用漏洞：
1.  获取开发模式 Rails 应用的 cookie。
2.  使用应用的名称作为盐值，通过 MD5 哈希和 PKCS5 Key Derivation Function 2 (PBKDF2) 生成 secret key。
3.  解密 cookie 数据，然后反序列化。
4.  修改解密后的数据，比如修改 user_id 来提权。
5.  重新加密数据，生成新的 cookie。
6.  将新的 cookie 发送给服务器，从而以目标用户的身份进行操作。

**投毒风险：**
PoC 代码的投毒风险较低，大约为 10%。 风险点在于:
*   脚本要求用户手动插入目标Rails应用名称和Cookie, 这种用户交互降低了自动利用的风险，减少了大范围攻击的可能性。


**利用方式：**
1.  **目标环境确认:** 首先，确认目标 Rails 应用是否运行在开发模式下。这是漏洞利用的前提条件。
2.  **应用名称枚举:** 尝试枚举 Rails 应用的名称。PoC 代码中使用应用名称作为生成 secret key 的盐值。可以通过信息泄露、错误页面等方式获取应用名称。
3.  **Cookie捕获:** 获得目标 Rails 应用的 Cookie。这可以通过网络抓包或者浏览器开发者工具来获取。
4.  **Secret Key生成:** 使用提供的 Ruby 脚本，结合应用名称和默认的盐值生成 secret key。
5.  **Cookie解密和篡改:** 使用生成的 secret key 解密 Cookie，修改其中的用户 ID 或其他敏感信息。
6.  **Cookie重加密和发送:** 使用 secret key 重新加密 Cookie，然后将篡改后的 Cookie 发送给服务器。
7.  **权限提升:** 如果 Cookie 篡改成功，攻击者将以被篡改用户的身份登录，获得相应的权限。

**项目地址:** [scumdestroy/CVE-2019-5420.rb](https://github.com/scumdestroy/CVE-2019-5420.rb)

**漏洞详情:** [CVE-2019-5420](https://nvd.nist.gov/vuln/detail/CVE-2019-5420)