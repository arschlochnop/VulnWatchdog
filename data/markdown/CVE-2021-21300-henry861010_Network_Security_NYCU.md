## CVE-2021-21300-Git-RCE

**漏洞编号:** CVE-2021-21300

**漏洞类型:** 远程代码执行

**影响应用:** Git

**危害等级:** 高危，可能导致远程代码执行

**影响版本:** 2.14.2 <= Git版本 < 2.17.6, 2.18.0 <= Git版本 < 2.18.5, 2.19.0 <= Git版本 < 2.19.6, 2.20.0 <= Git版本 < 2.20.5, 2.21.0 <= Git版本 < 2.21.4, 2.22.0 <= Git版本 < 2.22.5, 2.23.0 <= Git版本 < 2.23.4, 2.24.0 <= Git版本 < 2.24.4, 2.25.0 <= Git版本 < 2.25.5, 2.26.0 <= Git版本 < 2.26.3, 2.27.0 <= Git版本 < 2.27.1, 2.28.0 <= Git版本 < 2.28.1, 2.29.0 <= Git版本 < 2.29.3, 2.30.0 <= Git版本 < 2.30.1

**利用条件:** 目标系统文件系统不区分大小写(如NTFS, HFS+)，并且配置了clean/smudge filter（例如Git LFS）

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2021-21300 漏洞允许恶意 Git 仓库在克隆时执行任意代码。利用方式为：

1.  **创建恶意仓库：** 攻击者创建一个包含恶意配置的 Git 仓库。
2.  **利用符号链接：** 仓库中包含一个符号链接（symbolic link），指向 `.git/hooks` 目录下的一个钩子脚本（例如 `post-checkout`）。
3.  **clean/smudge filter：** 仓库的 `.gitattributes` 文件配置了 clean/smudge 过滤器，如 Git LFS。
4.  **触发执行：** 当用户克隆恶意仓库，并且文件系统不区分大小写（如Windows的NTFS），Git 会尝试更新工作目录。由于符号链接的存在，并且文件系统不区分大小写，Git 会错误地将符号链接指向的钩子脚本（如 `A/post-checkout`）复制到 `.git/hooks/post-checkout`，从而导致该脚本在后续的 `git checkout` 操作时被执行。
5.  **远程代码执行：** 恶意脚本被执行，实现远程代码执行。

**POC有效性：** 提供的 POC 代码 `build_bad_repo.sh` 尝试利用上述方法创建恶意仓库。它首先初始化一个 Git 仓库，然后创建 `.gitattributes` 文件，配置 `filter=lfs`。接着，创建一个名为 `A/post-checkout` 的可执行脚本，该脚本包含恶意代码。然后，创建一个名为 `a` 的符号链接，指向 `.git/hooks` 目录。最后，将这些文件添加到 Git 仓库并提交。当用户克隆此恶意仓库并在易受攻击的系统上检出时，`A/post-checkout` 中的代码将被执行，从而验证漏洞的存在。

**投毒风险：**  提供的 POC 代码本身即为漏洞利用代码，目的是创建一个能触发 RCE 的恶意仓库。其中 `A/post-checkout` 脚本的内容 `echo HACKed(unauthorized_command) >&2` 仅用于演示目的，表明代码已被执行。脚本本身的行为只是输出一段文字，没有隐藏其他恶意代码，因此可以认为不存在投毒风险。Poison 为0%.

**缓解措施：**

*   升级 Git 版本到修复版本。
*   禁用符号链接支持 (`git config --global core.symlinks false`)。
*   避免克隆来自不受信任来源的仓库。

**项目地址:** [henry861010/Network_Security_NYCU](https://github.com/henry861010/Network_Security_NYCU)

**漏洞详情:** [CVE-2021-21300](https://nvd.nist.gov/vuln/detail/CVE-2021-21300)