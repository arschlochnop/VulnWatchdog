## CVE-2024-1086-Linux Kernel-Use-After-Free

**漏洞编号:** CVE-2024-1086

**漏洞类型:** Use-After-Free

**影响应用:** Linux Kernel

**危害等级:** 高危，可导致本地权限提升

**影响版本:** 3.15 <= Kernel Version < 6.8

**利用条件:** 需要在本地执行代码，并且目标内核版本在受影响范围内

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-1086是Linux内核netfilter: nf_tables组件中的一个use-after-free漏洞。根据漏洞库信息和搜索结果，该漏洞允许本地攻击者提升权限。漏洞存在于 `nft_verdict_init()` 函数，该函数允许将正值作为hook verdict中的drop错误，从而导致`nf_hook_slow()` 函数在NF_DROP与类似于NF_ACCEPT的drop错误一起发出时可能发生double free漏洞。

**有效性：**

根据提供的漏洞利用代码和搜索引擎结果，POC代码是有效的。 搜索引擎结果和CISA KEV都说明该漏洞已被积极利用，github上也存在poc。

**投毒风险：**

代码仓库中存在投毒代码的风险较低，约为10%。以下是分析依据：

*   **说明文字：** README.md文件说明了该代码仅用于学习目的，并引用了其他参考资料。
*   **编译方式：** 编译指令简单，直接使用gcc编译，没有隐藏的编译选项。
*   **代码逻辑：** exp.c文件中的代码主要涉及nftables的配置和数据包的发送，用于触发漏洞。
*   **可疑点：** CONFIG_STATIC_USERMODEHELPER_PATH="/sbin/usermode-helper" 可能会被恶意利用，因为 `usermode-helper` 用于执行用户空间的辅助程序，如果被篡改，可能导致执行恶意代码。然而，这个配置本身是内核的一个功能，不一定意味着投毒。
*   **Double Free WARNING：** 漏洞利用代码中出现了内核的Warning，说明触发了double free。

总体来看，该漏洞利用代码主要关注漏洞的利用，没有明显的恶意代码或者后门。但是，不能完全排除作者隐藏了细微的投毒代码的可能性。

**利用方式：**

1.  **环境准备：** 需要一个受影响的Linux内核版本(3.15 <= Kernel Version < 6.8)，安装libnftnl-dev和libmnl-dev依赖。
2.  **配置nftables：** 利用nftables API设置特定的规则和链，这些规则和链旨在触发漏洞。
3.  **触发Double Free：** 通过发送特定的数据包，例如精心构造的IP数据包，触发`nf_hook_slow()`中的double free漏洞。 这包括通过nftables配置，将NF_DROP 与类似于NF_ACCEPT的drop错误一起发出。
4.  **权限提升：** 成功触发use-after-free漏洞后，攻击者可以利用该漏洞来覆盖内核内存，从而实现权限提升（通常提升到root权限）。该步骤通常涉及内存布局的精确控制和ROP（Return-Oriented Programming）技术。

**缓解措施：**

升级到已修复的内核版本（>=6.8）是缓解此漏洞的最有效方法。 此外，可以限制对nftables的访问，并监控nftables规则的配置。

**项目地址:** [LLfam/CVE-2024-1086](https://github.com/LLfam/CVE-2024-1086)

**漏洞详情:** [CVE-2024-1086](https://nvd.nist.gov/vuln/detail/CVE-2024-1086)