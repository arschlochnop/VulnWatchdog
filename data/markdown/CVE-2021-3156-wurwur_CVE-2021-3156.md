## CVE-2021-3156-Sudo-Heap-Based Buffer Overflow

**漏洞编号:** CVE-2021-3156

**漏洞类型:** Heap-Based Buffer Overflow

**影响应用:** Sudo

**危害等级:** 高危，允许本地用户提升权限至root

**影响版本:** Sudo before 1.9.5p2

**利用条件:** 本地用户可执行sudo

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-3156，又名Baron Samedit，是Sudo 1.9.5p2之前版本中存在的一个堆缓冲区溢出漏洞。该漏洞允许本地用户利用`sudoedit -s`命令以及以单个反斜杠字符结尾的命令行参数，将权限提升至root。

**有效性：**
根据漏洞库信息、搜索引擎结果和提供的漏洞利用代码，该漏洞的POC代码是有效的。多个信息来源都证实了该漏洞的存在，并且有可用的利用代码。

**投毒风险：**
提供的POC代码包含一个名为`backdoor.php`的文件，这是一个通过weevely生成的PHP后门，密码为`H@rmW#sH4rE!`。该后门允许攻击者以Apache用户的身份获得SSH会话的访问权限。`shell.php%00.jpg` 是利用NULL字节绕过文件上传验证的尝试。`exploit.py`是主要的漏洞利用程序，其目标是利用CVE-2021-3156提升权限。

因此，存在一定的投毒风险，因为利用代码仓库中包含一个PHP后门。尽管主漏洞利用程序`exploit.py`本身似乎是良性的，旨在利用CVE-2021-3156，但`backdoor.php`的存在意味着该仓库可能被用于传播恶意软件。将后门与漏洞利用代码放在一起，可以增加攻击成功的几率，也增加了普通用户误用的可能性。

考虑到该仓库包含一个明确的后门文件以及一个利用NULL字节绕过的文件名，我认为存在10%的投毒风险。

**利用方式：**
该漏洞的利用方式如下：

1.  **漏洞触发：** 通过执行`sudoedit -s`命令，并提供一个以单个反斜杠字符结尾的恶意构造的命令行参数。
2.  **堆缓冲区溢出：** 由于Sudo在处理命令行参数时的off-by-one错误，导致堆缓冲区溢出。
3.  **权限提升：** 攻击者通过控制堆中的数据，覆盖关键的Sudo数据结构，最终将权限提升至root。

`exploit.py` 通过伪造defaults对象，计算内存地址，构造恶意环境变量，然后执行sudoedit，从而触发漏洞，最终实现权限提升。它包含了攻击CentOS 7上sudo 1.8.23的特定偏移量。

**总结：**
CVE-2021-3156是一个严重的安全漏洞，允许本地用户提升权限至root。 虽然POC代码看起来针对CVE-2021-3156，但`backdoor.php`文件的存在增加了投毒的风险。

**项目地址:** [wurwur/CVE-2021-3156](https://github.com/wurwur/CVE-2021-3156)

**漏洞详情:** [CVE-2021-3156](https://nvd.nist.gov/vuln/detail/CVE-2021-3156)