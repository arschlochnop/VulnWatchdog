## CVE-2024-4577-PHP-CGI参数注入远程代码执行

**漏洞编号:** CVE-2024-4577

**漏洞类型:** 参数注入/远程代码执行

**影响应用:** PHP (Windows CGI)

**危害等级:** 极高，远程代码执行

**影响版本:** PHP 8.1.* before 8.1.29, 8.2.* before 8.2.20, 8.3.* before 8.3.8

**利用条件:** Windows系统，Apache服务器，PHP以CGI模式运行，系统启用了使用"Best Fit"策略的代码页。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-4577是一个存在于Windows PHP-CGI配置中的严重漏洞。当PHP以CGI模式在Windows服务器上运行时，如果系统配置了特定的代码页，Windows可能会使用“Best-Fit”策略来替换命令行参数中的字符。PHP-CGI模块可能会错误地将这些替换后的字符解析为PHP选项，从而允许攻击者向PHP二进制文件传递恶意参数。这可能导致泄露脚本源码，执行任意PHP代码，甚至在服务器上执行操作系统命令。

**利用方式：**

1.  **攻击向量：** 通过HTTP请求，构造恶意的URL或POST数据，向PHP-CGI传递恶意参数。
2.  **利用条件：**
    *   目标服务器是Windows系统。
    *   PHP以CGI模式运行。
    *   Web服务器（如Apache）用于处理PHP请求。
    *   系统启用了特定的代码页，允许字符替换。
3.  **攻击步骤：**
    *   利用Windows的“Best-Fit”字符替换机制，将特殊字符转换为PHP选项。
    *   通过`?`或`-`等字符引导，注入恶意PHP配置选项，例如`-d allow_url_include=1 -d auto_prepend_file=php://input`。
    *   通过`POST`请求发送PHP代码，实现远程代码执行。

**有效性：**

根据漏洞描述、搜索结果以及提供的POC代码，该漏洞的利用是有效的。已经有公开的PoC代码可以实现远程代码执行。漏洞库信息和搜索引擎结果都确认了该漏洞的存在以及可利用性。

提供的PoC利用了DNS重绑定技术，允许攻击者通过受害者的浏览器，对内网的PHP-CGI服务器进行攻击。这个方法绕过了同源策略(SOP)，使得攻击者能够攻击原本无法直接从外部访问的内网系统。

**投毒风险：**

提供的PoC代码主要由三个部分组成: `README.md`, `client.html`。其中`README.md`文件主要描述漏洞原理、利用方式和配置说明，`client.html`是漏洞利用的核心代码。

*  **client.html分析:**  该文件包含Javascript代码，用于执行DNS重绑定攻击，并向目标IP发送包含恶意payload的请求。攻击payload可以在 `client.html`文件中被修改.

虽然该PoC本身旨在利用漏洞，但以下情况可能构成投毒风险：

1.  **依赖的第三方服务:**  PoC依赖于`duckdns.org`提供DNS服务, 一旦服务出现问题或者被劫持,可能会导致PoC失效甚至被恶意利用。
2.  **内网扫描IP列表:** `client.html`中包含一个可以修改的内网IP列表. 如果这个列表被替换成其他恶意IP地址，可能导致攻击者扫描或攻击非预期目标。
3.  **Payload内容:**  虽然默认的payload为`calc`,用户可以自定义payload,潜在的风险在于如果用户不熟悉PHP, 可能会引入不安全的PHP代码或者连接恶意URL。
4.  **DNS Rebinding 的滥用:**  DNS Rebinding 本身就是一项有争议的技术，在没有充分安全措施的情况下使用，可能会造成隐私泄露或者其他安全问题。

因此，综合考量，该仓库的投毒风险评定为10%。主要风险在于使用者可能修改PoC中的payload或者IP列表，从而引入额外的风险。作者本身并没有加入后门代码。

**项目地址:** [ZeroMemoryEx/PHP-CGI-INTERNAL-RCE](https://github.com/ZeroMemoryEx/PHP-CGI-INTERNAL-RCE)

**漏洞详情:** [CVE-2024-4577](https://nvd.nist.gov/vuln/detail/CVE-2024-4577)