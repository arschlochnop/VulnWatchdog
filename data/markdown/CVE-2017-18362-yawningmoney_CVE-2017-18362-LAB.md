## CVE-2017-18362-KaseyaVSA-SQL注入

**漏洞编号:** CVE-2017-18362

**漏洞类型:** SQL注入

**影响应用:** Kaseya VSA

**危害等级:** 高危，可能导致数据泄露、远程代码执行和Ransomware攻击

**影响版本:** ConnectWise ManagedITSync integration through 2017

**利用条件:** 需要目标系统存在Kaseya VSA，并集成了存在漏洞的ConnectWise ManagedITSync组件。ManagedIT.asmx页面需要可以通过Kaseya VSA Web界面访问。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2017-18362 存在于Kaseya VSA的 ConnectWise ManagedITSync 集成中，由于ManagedIT.asmx/GetDataSet接口存在SQL注入漏洞，未经身份验证的攻击者可以通过构造恶意的SQL语句，实现对Kaseya VSA数据库的任意读写操作。此漏洞曾在野外被利用，攻击者利用此漏洞下载和执行勒索软件payload，攻击所有由 VSA 服务器管理的终端节点。

**有效性分析：**

提供的POC代码模拟了该漏洞环境，通过docker compose构建了包含易受攻击的Web应用程序和SQL Server数据库的实验环境。POC中提供了使用Nuclei扫描器检测漏洞的模板，以及如何利用POST请求向`/KaseyaCwWebService/ManagedIT.asmx/GetDataSet`发送包含恶意SQL语句的`sql`参数来触发SQL注入。

根据POC的描述和提供的Nuclei模板，可以验证该漏洞的存在性，以及利用SQL注入执行任意SQL查询的能力，从而证明POC有效。

**投毒风险分析：**

代码仓库中主要包含docker-compose文件、Dockerfile、SQL Server初始化脚本以及Nuclei检测模板。这些文件本身不包含明显的恶意代码。但是，以下情况需要注意：

1.  **基础镜像：** Dockerfile使用了`mcr.microsoft.com/mssql/server:2019-latest`和`mcr.microsoft.com/dotnet/aspnet:8.0`。虽然这些是官方镜像，但仍需验证其完整性和安全性，以防官方镜像本身已被篡改（可能性较低）。
2.  **entrypoint.sh：**  该脚本用于初始化SQL Server数据库。如果脚本中包含未经验证的SQL语句或命令，可能会引入安全风险。
3.  **Nuclei模板：**  虽然Nuclei模板本身不包含恶意代码，但如果攻击者修改了模板，可能会导致误报或漏报，从而影响漏洞评估的准确性。

总体而言，该仓库中存在明显的投毒代码的可能性较低，但仍需要对基础镜像、初始化脚本等进行仔细审查，以降低潜在的风险。根据分析，存在投毒风险的可能性大约为10%。主要来源于基础镜像被篡改或者脚本中存在后门的可能。 务必在隔离环境运行POC。

**利用方式：**

1.  **漏洞定位：** 攻击者首先需要找到目标系统上的`/KaseyaCwWebService/ManagedIT.asmx` 页面。
2.  **构造恶意SQL：**  攻击者构造包含恶意SQL语句的POST请求，并将SQL语句作为`sql`参数的值发送到`/KaseyaCwWebService/ManagedIT.asmx/GetDataSet`接口。
3.  **执行SQL注入：**  服务器端未对`sql`参数进行充分的过滤和转义，直接将其拼接到SQL查询语句中，导致SQL注入漏洞。
4.  **获取敏感数据/控制系统：**  攻击者利用SQL注入漏洞，可以读取数据库中的敏感信息（例如用户名、密码、客户数据），或者执行任意SQL命令来修改数据库内容、添加恶意用户、执行系统命令等，最终控制整个系统。

**项目地址:** [yawningmoney/CVE-2017-18362-LAB](https://github.com/yawningmoney/CVE-2017-18362-LAB)

**漏洞详情:** [CVE-2017-18362](https://nvd.nist.gov/vuln/detail/CVE-2017-18362)