## CVE-2022-31813-Apache HTTP Server-X-Forwarded-For绕过

**漏洞编号:** CVE-2022-31813

**漏洞类型:** HTTP Header Spoofing (X-Forwarded-For Bypass)

**影响应用:** Apache HTTP Server

**危害等级:** 中危，可能导致IP地址认证绕过

**影响版本:** <= 2.4.53

**利用条件:** 需要目标服务器使用了Apache HTTP Server作为反向代理，并依赖X-Forwarded-* header进行IP地址认证。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2022-31813 漏洞存在于 Apache HTTP Server 2.4.53 及更早版本中。由于 mod_proxy 模块处理 'Connection' header 的 hop-by-hop 机制不当，可能导致服务器未将 X-Forwarded-* headers 正确地传递给后端服务器。这使得攻击者可以通过构造恶意的 'Connection' header 来阻止 Apache 将正确的客户端 IP 地址通过 X-Forwarded-For header 传递给后端应用，从而绕过基于 IP 地址的身份验证。

**漏洞利用方式：**

1.  攻击者发送特制的 HTTP 请求，包含一个精心构造的 'Connection' header。该 header 指示 Apache 不要转发 X-Forwarded-* headers。
2.  Apache 服务器由于漏洞，没有将 X-Forwarded-* headers 传递给后端服务器。
3.  后端服务器错误地认为请求来自 Apache 服务器本身的 IP 地址，而不是真实的客户端 IP 地址。
4.  如果后端应用依赖 X-Forwarded-For header 进行身份验证或访问控制，攻击者就可以绕过这些机制。

**POC 代码分析：**

提供的 POC 代码是一个黑盒漏洞扫描器，用于检测目标服务器是否存在 CVE-2022-31813 漏洞。 它通过发送带有特定构造的 'Connection' header 的 HTTP 请求来测试目标服务器。 该代码使用了 `requests` 库发送 HTTP 请求，`selenium` 库模拟浏览器行为并进行截图取证, `pandas`库用于生成csv报告。

**投毒风险评估：**

虽然 POC 代码的功能看似正常，但仍然存在一定的投毒风险。主要的风险点在于以下几个方面：

*   **依赖项风险：** 代码依赖于 `requests`、`selenium`和 `pandas`库。 这些库本身可能存在安全漏洞，或者被恶意篡改。 使用 `--break-system-packages` 可能会影响系统包的完整性, 但不属于投毒。
*   **chromedriver的来源：** 如果chromedriver来源不可信，可能存在投毒风险。
*   **截图和报告：** 代码会截取屏幕截图并生成 CSV 报告。 这些操作可能被用于窃取敏感信息或植入恶意代码(可能性较低).

因此，综合考虑，虽然POC主要功能是漏洞检测，但也需要谨慎评估其潜在的投毒风险，占比约为10%。

**项目地址:** [dodiorne/cve-2022-31813](https://github.com/dodiorne/cve-2022-31813)

**漏洞详情:** [CVE-2022-31813](https://nvd.nist.gov/vuln/detail/CVE-2022-31813)