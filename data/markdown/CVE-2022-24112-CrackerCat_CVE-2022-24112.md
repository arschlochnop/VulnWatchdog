## CVE-2022-24112 - Apache APISIX Batch Requests RCE

**漏洞编号:** CVE-2022-24112

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Apache APISIX

**危害等级:** 高危，可能导致服务器完全控制

**影响版本:** < 2.12.1, < 2.10.4, >= 1.3

**利用条件:** 需要开启 batch-requests 插件，且使用默认 API key 或未限制 Admin API 访问 IP。

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2022-24112 漏洞存在于 Apache APISIX 的 batch-requests 插件中。攻击者可以通过构造特殊的请求，绕过 Admin API 的 IP 限制，然后通过 Admin API 创建恶意的路由，在路由的 filter_func 中执行任意 Lua 代码，从而实现远程代码执行。

**漏洞利用方式：**

1.  攻击者利用 batch-requests 插件的漏洞，通过 X-REAL-IP 头欺骗 APISIX，绕过 Admin API 的 IP 访问控制。
2.  攻击者向 /apisix/batch-requests 发送包含恶意配置的请求，该请求会创建或修改路由，并在 filter_func 字段中注入恶意 Lua 代码。
3.  当有流量匹配到该恶意路由时，filter_func 中的 Lua 代码会被执行，从而实现远程代码执行。
4.  POC 代码首先构造一个包含恶意配置的 JSON 数据，该数据经过 Base64 编码后通过 /apisix/batch-requests 接口发送给 APISIX 服务器。恶意配置会在 APISIX 中创建一个路由，并将 `filter_func` 设置为执行命令的 Lua 代码。exp.py中将curl命令结果发送到dnslog服务器。然后，POC 代码向该路由发送一个 GET 请求，触发 filter_func 的执行，从而实现远程代码执行。

**投毒风险分析：**

该 POC 主要利用已知的漏洞进行 RCE，直接执行命令。但其中存在一定的投毒风险，
1.  **潜在的恶意命令修改：** POC中的命令`curl localhost.xxx.dnslog.cn`，虽然目前是用来验证漏洞的存在，但如果被替换成其他恶意命令，例如删除文件、下载恶意软件等，则会直接对目标系统造成危害。不过这个风险较低，因为使用者可以检查和修改命令。

因此，综合评估投毒风险较低，约 5%。主要集中在使用者未仔细审查POC代码可能存在的恶意行为。


**项目地址:** [CrackerCat/CVE-2022-24112](https://github.com/CrackerCat/CVE-2022-24112)

**漏洞详情:** [CVE-2022-24112](https://nvd.nist.gov/vuln/detail/CVE-2022-24112)