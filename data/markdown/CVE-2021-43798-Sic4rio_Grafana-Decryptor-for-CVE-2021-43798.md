## CVE-2021-43798-Grafana-目录遍历

**漏洞编号:** CVE-2021-43798

**漏洞类型:** 目录遍历

**影响应用:** Grafana

**危害等级:** 高危，可能导致敏感信息泄露

**影响版本:** 8.0.0-beta1 to 8.3.0 (除已修复版本)

**利用条件:** 需要网络访问，目标Grafana实例存在漏洞且插件目录可访问

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

该漏洞存在于 Grafana 的插件目录处理中，攻击者可以通过构造包含目录遍历字符的 URL，读取服务器上的任意文件。根据提供的漏洞信息，受影响的版本为 8.0.0-beta1 到 8.3.0。利用方式是通过访问 `grafana_host_url/public/plugins/<plugin_id>/`，并在 plugin_id 中包含目录遍历的payload，例如 `../../../../etc/passwd`。PoC代码提供了一个解密 Grafana 数据源密码的脚本，利用 CVE-2021-43798 读取 grafana.db 和 grafana.ini 文件，然后使用 ini 文件中的 secret_key 解密数据库中的密码。虽然主要功能是密码解密，但是利用该漏洞读取任意文件是漏洞利用的根本，因此有效性很高。

**有效性分析：**
根据漏洞描述和 PoC 代码，漏洞利用的有效性较高。PoC 脚本能够利用目录遍历漏洞读取敏感文件，进而解密数据源密码，证明了漏洞的可利用性。

**投毒风险分析：**
对 PoC 代码进行了分析，发现投毒风险较低，风险占比5%。

1.  **依赖包:** PoC代码依赖的第三方库均为常用的密码学和网络请求库(requests, questionary, termcolor, cryptography)，被植入恶意代码的可能性较低。
2.  **代码逻辑:** 代码主要实现了从 Grafana 配置文件中读取密钥并解密数据库中存储的密码。该逻辑与漏洞描述一致，没有发现额外的恶意操作。
3.  **输入输出:** 该脚本需要用户提供 grafana.db 和 grafana.ini 文件的路径，并将解密后的密码输出到控制台。没有发现将敏感信息发送到外部服务器或执行其他恶意操作的代码。

**利用方式：**
1.  **确定目标Grafana版本:** 确认目标Grafana实例的版本在受影响范围内 (8.0.0-beta1 to 8.3.0).
2.  **获取plugin ID:**  获取目标Grafana实例已安装插件的ID，可以在 Grafana 的插件管理页面找到。
3.  **构造恶意URL:** 构造包含目录遍历payload的URL，例如 `grafana_host_url/public/plugins/<plugin_id>/../../../../etc/passwd`。
4.  **读取敏感文件:**  通过发送构造的URL请求，尝试读取服务器上的敏感文件，例如 `/etc/passwd`、`grafana.ini`、`grafana.db` 等。
5.  **解密数据源密码 (如果成功读取grafana.ini和grafana.db):**  使用 PoC 脚本解密数据源密码。

总而言之，此漏洞的利用方式清晰且有效，攻击者可以利用目录遍历读取敏感信息，存在较高的安全风险。

**项目地址:** [Sic4rio/Grafana-Decryptor-for-CVE-2021-43798](https://github.com/Sic4rio/Grafana-Decryptor-for-CVE-2021-43798)

**漏洞详情:** [CVE-2021-43798](https://nvd.nist.gov/vuln/detail/CVE-2021-43798)