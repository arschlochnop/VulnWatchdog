## CVE-2022-22947-Spring Cloud Gateway-代码注入

**漏洞编号:** CVE-2022-22947

**漏洞类型:** 代码注入

**影响应用:** Spring Cloud Gateway

**危害等级:** 高危，可能导致远程代码执行

**影响版本:** 3.1.x (prior to 3.1.1+), 3.0.x (prior to 3.0.7+)

**利用条件:** Gateway Actuator endpoint enabled, exposed, and unsecured

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2022-22947 存在于 Spring Cloud Gateway 中，当 Gateway Actuator 端点启用、暴露且未进行安全保护时，应用程序容易受到代码注入攻击。远程攻击者可以构造恶意请求，从而允许在远程主机上执行任意代码。

**有效性：**

根据漏洞信息、搜索结果和提供的PoC代码，此漏洞是有效的。PoC 代码演示了如何利用 SpEL 表达式注入执行任意命令。

**投毒风险：**

PoC 代码本身旨在演示漏洞利用，但仔细检查 `Dockerfile` 和 `README.md` 文件后，发现投毒风险较低，约为10%。主要原因是：

*   `Dockerfile`：仅包含从官方 `openjdk:11-jre-slim` 镜像构建，复制预编译的 `spring-gateway-demo-0.0.1-SNAPSHOT.jar` 文件，并执行该 jar 文件。不存在直接执行恶意命令或下载恶意文件的操作。但该 `spring-gateway-demo-0.0.1-SNAPSHOT.jar`  是否存在后门，无法判定。
*   `README.md`：仅包含构建和运行 Docker 容器的说明，以及发送恶意请求的 PoC。不包含任何额外的恶意指令。

**存在的微小风险在于预编译的 `spring-gateway-demo-0.0.1-SNAPSHOT.jar` 文件可能包含后门， 但属于PoC验证必要文件，不能认定为投毒。**

**利用方式：**

1.  **前提条件：** 目标 Spring Cloud Gateway 实例启用了 Actuator 端点，并且该端点未进行身份验证。
2.  **注入 SpEL 表达式：** 通过向 `/actuator/gateway/routes/{route_id}` 发送 POST 请求，创建一个新的路由或更新现有路由，其中 `filters` 数组包含一个 `AddResponseHeader` 过滤器。该过滤器的 `args` 中的 `value` 字段包含一个恶意的 SpEL 表达式。PoC 中使用的 SpEL 表达式执行 `id` 命令，并将结果添加到响应头中。
3.  **刷新 Gateway：** 向 `/actuator/gateway/refresh` 发送 POST 请求，强制 Gateway 刷新其路由配置。这将触发 SpEL 表达式的执行。
4.  **触发路由：** 访问触发了含有恶意SpEL表达式的路由，从而执行远程命令。
5.  **清除（可选）：** 使用 DELETE 请求删除创建的路由，并再次刷新 Gateway，以避免后续的恶意执行。

**项目地址:** [twseptian/cve-2022-22947](https://github.com/twseptian/cve-2022-22947)

**漏洞详情:** [CVE-2022-22947](https://nvd.nist.gov/vuln/detail/CVE-2022-22947)