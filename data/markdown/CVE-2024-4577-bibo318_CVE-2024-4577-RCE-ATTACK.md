## CVE-2024-4577 PHP-CGI 参数注入远程代码执行

**漏洞编号:** CVE-2024-4577

**漏洞类型:** 远程代码执行

**影响应用:** PHP

**危害等级:** 高危，允许未经身份验证的攻击者在Windows服务器上执行任意代码

**影响版本:** PHP 8.1.* before 8.1.29, 8.2.* before 8.2.20, 8.3.* before 8.3.8 (Windows, CGI模式, 特定代码页)

**利用条件:** Windows服务器, 运行在CGI模式下的PHP, 系统配置为使用某些代码页, 允许"Best-Fit"行为替换字符。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-4577 是一个存在于 PHP 中的参数注入漏洞，当 PHP 在 Windows 上以 CGI 模式运行时，如果系统配置为使用某些代码页，Windows 可能会使用 "Best-Fit" 行为替换命令行中的字符。PHP CGI 模块可能会错误地将这些字符解释为 PHP 选项，从而允许恶意用户将选项传递给正在运行的 PHP 二进制文件，进而可能泄露脚本源代码或在服务器上运行任意 PHP 代码。

**有效性分析：**
根据漏洞信息，搜索引擎结果和提供的PoC代码，该漏洞利用的有效性较高。漏洞库信息表明该漏洞已被公开披露，并且存在受影响的版本范围。搜索引擎结果显示，该漏洞在公开后不久就出现了大量的利用尝试。PoC代码提供了一个扫描器和利用工具，可以用来检测和利用此漏洞。该PoC代码通过构造包含特定参数的URL，并结合`php://input`流，允许执行任意PHP代码。

**投毒风险分析：**
PoC代码主要包含以下功能：
1.  **Payload选择：** 提供了几个不同的payload，攻击者可以选择使用哪个payload进行攻击。
2.  **漏洞扫描：** 通过发送带有payload的POST请求，检测目标是否存在漏洞，根据响应内容判断。
3.  **漏洞利用：** 读取用户提供的PHP payload文件内容，并通过POST请求发送到目标服务器执行。

风险点在于payload文件的内容。如果payload文件本身包含恶意代码（例如反弹shell、webshell等），那么执行利用操作会导致服务器被植入后门。PoC代码本身没有明显的恶意行为，风险主要来自用户提供的payload。代码存在投毒风险，是因为攻击者可能会修改脚本，在用户不知情的情况下，添加额外的恶意操作，例如：在成功利用后，自动下载并执行特定的恶意文件。或者将服务器信息发送到指定服务器。因此，使用此PoC需要谨慎，验证payload的内容，并确保来源可信，降低投毒风险。投毒风险评估为10%，主要是考虑到使用者可能会引入恶意payload文件。

**利用方式分析：**
1.  **确定目标环境：** 目标服务器必须是Windows系统，并且PHP运行在CGI模式下。
2.  **配置系统代码页：** 目标系统需要配置为使用某些代码页，允许 "Best-Fit" 行为。
3.  **构造恶意请求：** 构造包含恶意参数的URL。这些参数通常包含 `allow_url_include=1` 和 `auto_prepend_file=php://input`，允许包含远程文件，并将POST请求的内容作为PHP代码执行。
4.  **发送PHP Payload：**  通过POST请求将包含恶意代码的PHP payload发送到目标服务器。由于`auto_prepend_file`参数的存在，POST请求中的PHP代码会被执行，从而实现远程代码执行。
5.  **执行任意代码：**  成功利用漏洞后，可以在目标服务器上执行任意代码，例如：上传webshell，获取服务器权限。

**项目地址:** [bibo318/CVE-2024-4577-RCE-ATTACK](https://github.com/bibo318/CVE-2024-4577-RCE-ATTACK)

**漏洞详情:** [CVE-2024-4577](https://nvd.nist.gov/vuln/detail/CVE-2024-4577)