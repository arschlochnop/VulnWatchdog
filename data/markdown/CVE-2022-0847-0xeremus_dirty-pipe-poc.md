## CVE-2022-0847 Dirty Pipe 本地提权

**漏洞编号:** CVE-2022-0847

**漏洞类型:** 本地提权

**影响应用:** Linux Kernel

**危害等级:** 高危，可导致本地用户提升为root权限

**影响版本:** Linux Kernel 5.17 rc6 (受影响范围较广，参见搜索结果)

**利用条件:** 需要本地用户权限

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2022-0847 (Dirty Pipe) 是一个 Linux 内核中的权限提升漏洞。该漏洞源于`copy_page_to_iter_pipe`和`push_pipe`函数中新的管道缓冲区结构的“flags”成员缺乏适当的初始化，可能包含陈旧的值。利用该漏洞，非特权本地用户可以将数据写入由只读文件支持的页面缓存中的页面，从而提升他们在系统上的权限。

**有效性：**

根据漏洞库信息和搜索结果，此漏洞的exploit是可靠的，可以获得root权限。
提供的Python POC代码通过以下步骤利用该漏洞:

1.  找到`/etc/group`文件中sudo条目的偏移量。
2.  打开`/etc/group`文件和管道。
3.  通过写入和读取管道来污染管道缓冲区的flags。
4.  使用`splice`将`/etc/group`中的一个字节复制到管道。
5.  将用户名附加到管道中的sudo条目。
6.  将修改后的内容写回`/etc/group`，从而将用户添加到sudo组。

**投毒风险：**

该代码的投毒风险较低。代码会备份`/etc/group`到`/tmp/group_backup`,作者已知攻击代码会损坏`/etc/group`文件中sudo条目后面的行，但是提供了通过复制备份文件修复的方法。 唯一的风险是修改`/etc/group`后，目标系统可能变得不稳定，如果`/etc/group`损坏严重，则可能导致拒绝服务或需要手动修复。存在恶意修改备份文件或清理例程的微小风险，但总体来说，投毒的可能性不大。

**利用方式：**

该漏洞利用方式主要分为以下几步：

1.  **查找sudo组偏移量：** 脚本首先查找/etc/group文件中sudo组条目的偏移量，这是为了后续精确修改该条目。
2.  **管道污染：** 利用Linux管道机制，通过写入和读取管道，污染管道缓冲区的标志位。这是漏洞利用的关键步骤，允许后续写入只读文件。
3.  **splice操作：** 使用splice系统调用将/etc/group文件中的一个字节（偏移量之前）拼接到管道中，准备好注入恶意数据的位置。
4.  **注入用户名：** 将目标用户名追加到管道中sudo组的条目后面，从而将用户添加到sudo组。
5.  **写回/etc/group：** 将修改后的管道内容写回/etc/group文件，实现提权。 

此利用方式需要在本地执行，并且目标系统存在/etc/group文件，并且用户具有读取该文件的权限。 该漏洞利用需要Python 3.10及以上版本，因为它使用了`os.splice`调用。

**项目地址:** [0xeremus/dirty-pipe-poc](https://github.com/0xeremus/dirty-pipe-poc)

**漏洞详情:** [CVE-2022-0847](https://nvd.nist.gov/vuln/detail/CVE-2022-0847)