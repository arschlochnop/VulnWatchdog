## CVE-2022-22947 - Spring Cloud Gateway Code Injection

**漏洞编号:** CVE-2022-22947

**漏洞类型:** 代码注入

**影响应用:** Spring Cloud Gateway

**危害等级:** 高危，可导致远程代码执行

**影响版本:** Spring cloud gateway versions 3.1.x prior to 3.1.1+, 3.0.x prior to 3.0.7+ and all old and unsupported versions

**利用条件:** Gateway Actuator endpoint 启用、公开且未受保护

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2022-22947 是 Spring Cloud Gateway 中的一个代码注入漏洞。当 Gateway Actuator 端点启用、公开且未受保护时，远程攻击者可以发送恶意构造的请求，从而在远程主机上执行任意代码。

**有效性：**

根据提供的漏洞信息、搜索结果以及漏洞利用代码，可以判断该漏洞的 POC 代码是有效的。搜索结果表明该漏洞已在野外被利用，并已被添加到 CISA KEV 列表中，证明了其真实性和危害性。

**投毒风险：**

提供的 POC 代码主要用于验证漏洞是否存在，并执行简单的命令（`id`）。虽然该代码本身不包含明显的恶意代码，但攻击者可以修改此 POC 以执行更危险的操作。`README.md`文件和python脚本存在分离性,增加了潜在风险。

投毒风险评估：5%。主要风险在于攻击者可能修改 POC 脚本以包含恶意负载。

**利用方式：**

1.  攻击者首先需要确定目标 Spring Cloud Gateway 实例的 Actuator 端点是否已启用、公开且未受保护。
2.  然后，攻击者使用 POST 请求向 `/actuator/gateway/routes/{route_id}` 端点添加恶意路由，并在 `AddResponseHeader` 过滤器中使用 SpEL 表达式注入恶意代码。POC中使用了`${new String(T(org.springframework.util.StreamUtils).copyToByteArray(T(java.lang.Runtime).getRuntime().exec(new String[]{"id"}).getInputStream()))}` 来执行id命令
3.  攻击者使用 POST 请求向 `/actuator/gateway/refresh` 端点刷新路由，使恶意路由生效。
4.  最后，攻击者访问添加的恶意路由，触发 SpEL 表达式的执行，从而在服务器上执行任意代码。
5.  攻击者删除添加的路由，并刷新路由，完成利用。


**项目地址:** [talentsec/Spring-Cloud-Gateway-CVE-2022-22947](https://github.com/talentsec/Spring-Cloud-Gateway-CVE-2022-22947)

**漏洞详情:** [CVE-2022-22947](https://nvd.nist.gov/vuln/detail/CVE-2022-22947)