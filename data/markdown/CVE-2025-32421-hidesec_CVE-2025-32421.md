## CVE-2025-32421 Next.js Race Condition to Cache Poisoning + XSS

**漏洞编号:** CVE-2025-32421

**漏洞类型:** 缓存投毒 + XSS

**影响应用:** Next.js

**危害等级:** 高危，可能导致敏感信息泄露和任意代码执行

**影响版本:** < 14.2.24 and >= 15.0.0, < 15.1.6

**利用条件:** 需要目标应用存在特定的配置缺陷（Pages Router 使用不当，且未正确处理 `x-now-route-matches` 头部），且存在XSS漏洞

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

该漏洞是 Next.js 在特定配置下的竞态条件导致的缓存投毒，结合 XSS 漏洞可造成更大的危害。

**漏洞利用有效性：**
提供的PoC代码有效。它演示了如何利用竞态条件结合XSS漏洞，从而暴露敏感信息。

**投毒风险分析：**
虽然PoC代码本身侧重于演示漏洞利用，但存在一定的投毒风险，大约为10%。PoC中涉及XSS payload，可能被用于注入恶意脚本。攻击者可以在PoC的基础上修改XSS payload，从而实现更隐蔽和恶意的攻击，例如窃取用户凭据、篡改页面内容或进行DDoS攻击。

**漏洞利用方式：**
1.  **竞态条件（Race Condition）：** 利用 Next.js 在处理并发请求时的竞态条件，通过同时发送多个请求，尝试触发缓存投毒。
2.  **头部操纵：** 利用`x-now-route-matches` 头部来影响路由匹配。
3.  **XSS 注入：**  通过构造恶意的Cookie（theme、userInput等）包含XSS payload，利用 `dangerouslySetInnerHTML` 执行任意JavaScript代码。
4.  **信息泄露：**  利用 XSS 读取隐藏的全局数据（`globalData`），包括监控配置（dsn、apiKey）、用户偏好和管理员权限。
5.  **权限提升：** 如果成功窃取管理员权限，攻击者可以执行管理操作。

**缓解措施：**
*   升级 Next.js 到 14.2.24 或 15.1.6 或更高版本。
*   在 CDN 或反向代理层剥离 `x-now-route-matches` 头部。
*   对所有响应设置 `cache-control: no-store`。
*   只缓存带有显式 `cache-control` 头的响应。
*   对用户输入进行严格的验证和转义，防止 XSS 攻击。
*   使用 HTTPOnly 保护 Cookie，防止客户端脚本访问敏感 Cookie。
*   实施内容安全策略 (CSP)，限制可执行脚本的来源。

**项目地址:** [hidesec/CVE-2025-32421](https://github.com/hidesec/CVE-2025-32421)

**漏洞详情:** [CVE-2025-32421](https://nvd.nist.gov/vuln/detail/CVE-2025-32421)