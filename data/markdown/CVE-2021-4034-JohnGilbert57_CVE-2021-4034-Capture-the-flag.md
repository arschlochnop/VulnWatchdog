## CVE-2021-4034-Polkit-pkexec本地提权

**漏洞编号:** CVE-2021-4034

**漏洞类型:** 本地提权

**影响应用:** Polkit

**危害等级:** 高危，允许低权限用户提升为root权限

**影响版本:** 所有版本（受影响版本）

**利用条件:** 目标系统必须安装易受攻击的Polkit版本，且攻击者需要本地访问权限

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-4034 (PwnKit) 存在于 polkit 的 pkexec 工具中。pkexec 是一个 setuid 工具，旨在允许非特权用户根据预定义的策略以特权用户身份运行命令。漏洞原因是 pkexec 没有正确处理调用参数的个数，导致尝试将环境变量作为命令执行。攻击者可以通过构造特殊的环境变量，诱使 pkexec 执行任意代码，从而获得 root 权限。

**有效性：**
根据漏洞描述、搜索结果和提供的漏洞利用代码，该漏洞是有效的。搜索结果中多个链接（例如，Qualys 的博客文章、Red Hat 的安全公告）都确认了该漏洞的存在，并提供了利用的细节。提供的 POC 代码旨在利用此漏洞。

**投毒风险：**
提供的 exploit.c 代码的功能是：
1.  创建 `GCONV_PATH=.` 目录。
2.  创建 `GCONV_PATH=./exploit` 文件，并赋予执行权限。
3.  创建 `exploit` 目录。
4.  创建 `exploit/gconv-modules` 文件，包含 gconv 模块的配置信息。
5.  创建 `exploit/shelltospawn.c` 文件，包含 C 代码，该代码将设置 uid 和 gid 为 0，并执行 `/bin/bash`。
6.  编译 `exploit/shelltospawn.c` 为共享库 `exploit/ISO646.so`。
7.  使用 `execve` 函数，设置特殊的环境变量（`PATH`, `CHARSET`, `SHELL`），并执行 `/usr/bin/pkexec`。

这个利用方法利用了 `gconv` 机制中的一个漏洞，允许通过环境变量加载恶意共享库，从而执行提权操作。

从代码本身来看，没有明显的**直接的后门代码**，例如植入 SSH 密钥或创建后门账户。然而，`system("/bin/bash")` 这行代码的功能是启动一个 root shell，攻击者可以使用该 shell 执行任何操作。因此，可以将整个利用过程视为一种投毒，因为它的最终结果是在目标系统上留下一个可以完全控制系统的 root shell。

 考虑到这种最终结果，将投毒风险评为 10% 是考虑到存在其他利用此漏洞的方式，而当前提供的 exploit.c 更加侧重于漏洞利用本身。

**利用方式：**
1.  **环境准备：** 创建必要的目录和文件，包括 `GCONV_PATH` 和包含恶意代码的共享库。
2.  **配置 gconv：** 创建 `gconv-modules` 文件，配置 gconv 模块，使其加载恶意的共享库。
3.  **设置环境变量：** 设置 `PATH`、`CHARSET` 和 `SHELL` 环境变量，以便 pkexec 能够加载恶意的 gconv 模块。
4.  **执行 pkexec：** 使用 `execve` 函数执行 `/usr/bin/pkexec`，触发漏洞，加载恶意代码，从而获得 root 权限。

利用的关键在于 `pkexec` 在处理环境变量时存在漏洞，允许攻击者控制加载的 gconv 模块，从而执行任意代码。

**项目地址:** [JohnGilbert57/CVE-2021-4034-Capture-the-flag](https://github.com/JohnGilbert57/CVE-2021-4034-Capture-the-flag)

**漏洞详情:** [CVE-2021-4034](https://nvd.nist.gov/vuln/detail/CVE-2021-4034)