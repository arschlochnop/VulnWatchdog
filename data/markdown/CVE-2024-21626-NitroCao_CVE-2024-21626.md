## CVE-2024-21626-runc-container-breakout

**漏洞编号:** CVE-2024-21626

**漏洞类型:** 容器逃逸

**影响应用:** runc

**危害等级:** 高危，可能导致主机完全控制

**影响版本:** < 1.1.12

**利用条件:** 需要runc版本小于1.1.12，并且容器需要执行exec或run操作

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-21626是一个runc容器逃逸漏洞，由于内部文件描述符泄露，攻击者可以使新生成的容器进程（来自runc exec）在主机文件系统命名空间中具有工作目录，从而允许通过访问主机文件系统来逃逸容器。恶意镜像也可以使用相同的攻击，允许容器进程通过runc run获得对主机文件系统的访问权限。 

**有效性：**

提供的POC代码是有效的，它展示了三种利用该漏洞的方法：

*   **通过运行容器：** 使用`docker run -w /proc/self/fd/8 ...`命令，`-w`参数设置容器的工作目录到`/proc/self/fd/8`，利用文件描述符泄露，将容器的工作目录设置为主机的文件系统。
*   **通过exec进入正在运行的容器：** 类似于运行容器的方式，通过`docker exec`进入容器并设置工作目录。
*   **通过runc本身：** 使用`runc spec`生成配置文件，然后修改`config.json`中的`cwd`字段为`/proc/self/fd/7`，最后使用`runc run`启动容器。

**投毒风险：**

该漏洞利用代码本身没有明显的投毒代码。该存储库主要提供漏洞的说明和利用示例。 但需要注意的是，任何从互联网下载的代码都存在潜在风险，以下为风险评估说明:

*   **依赖风险:** 该漏洞的利用依赖于操作系统命令，任何对其进行修改都可能导致潜在的风险，占比4%。
*   **代码隐藏风险:** 作者可能在其他位置（例如，图片文件或其他不明显的文件）嵌入恶意代码，但这需要进一步分析，占比6%。

因此，总体投毒风险评估为10%。

**利用方式：**

利用方式主要基于文件描述符泄露。当runc执行`exec`或`run`操作时，会泄露一个文件描述符，该文件描述符指向主机的文件系统。通过将容器的工作目录设置为`/proc/self/fd/<fd>`，容器内的进程就可以访问主机的文件系统，从而可以读取敏感信息、修改系统文件甚至执行任意代码，最终实现容器逃逸。

**总结：**

CVE-2024-21626是一个高危漏洞，利用简单，影响广泛。建议尽快升级runc到1.1.12或更高版本。

**项目地址:** [NitroCao/CVE-2024-21626](https://github.com/NitroCao/CVE-2024-21626)

**漏洞详情:** [CVE-2024-21626](https://nvd.nist.gov/vuln/detail/CVE-2024-21626)