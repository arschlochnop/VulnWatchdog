## CVE-2024-31497-PuTTY-ECDSA私钥泄露

**漏洞编号:** CVE-2024-31497

**漏洞类型:** 私钥泄露

**影响应用:** PuTTY, FileZilla, WinSCP, TortoiseGit, TortoiseSVN

**危害等级:** 高危，可能导致身份伪造和供应链攻击

**影响版本:** PuTTY 0.68 through 0.80 (FileZilla < 3.67.0, WinSCP < 6.3.3, TortoiseGit < 2.15.0.1, TortoiseSVN <= 1.14.6)

**利用条件:** 需要约60个PuTTY签名的消息，可以通过监听SSH连接或从公共Git仓库获取

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-31497 存在于 PuTTY 0.68 到 0.80 版本（不包括 0.81）中。漏洞原因是 ECDSA 签名过程中使用的 nonce 生成存在偏差，允许攻击者在获得大约 60 个签名后恢复 NIST P-521 私钥。这对于使用 SSH 密钥进行 Git 提交签名或通过代理转发机制使用 Pageant 的情况尤为重要。攻击者可以从公开的 Git 服务或通过恶意 SSH 服务器获取足够的信息来破解私钥，从而进行供应链攻击。 

**POC 分析：**

提供的 POC 代码包含一个 Dockerfile、Makefile、authorized_keys、ecdsa-p521.ppk、go.mod、go.sum 和 id_rsa 文件。

*   `Dockerfile`：用于构建一个包含私钥 (`id_rsa`) 和 SSH 服务器二进制文件 (`server-linux`) 的 Docker 镜像。
*   `Makefile`：用于编译 SSH 服务器二进制文件，并构建用于 amd64 和 arm64 架构的 Docker 镜像。
*   `authorized_keys`：包含一个公钥，用于 SSH 服务器的身份验证。
*   `ecdsa-p521.ppk`：包含 PuTTY 格式的私钥。
*   `go.mod` 和 `go.sum`：定义 Go 模块的依赖项。
*   `id_rsa`：包含 OpenSSH 格式的私钥。

提供的server端模拟了一个ssh server的功能,验证私钥是否能够成功认证。 

**利用方式：**

1.  **数据收集：** 攻击者首先需要收集受影响的 PuTTY 版本生成的签名消息。这些消息可以从公共 Git 仓库、SSH 服务器日志或通过中间人攻击获取。
2.  **密钥恢复：** 使用 `BreakingECDSAwithLLL` 工具（参考链接：[https://github.com/daedalus/BreakingECDSAwithLLL](https://github.com/daedalus/BreakingECDSAwithLLL)）分析收集到的签名，恢复 NIST P-521 私钥。
3.  **身份伪造：** 使用恢复的私钥冒充受害者，访问受害者可以访问的任何系统，包括 Git 仓库、SSH 服务器等。
4.  **供应链攻击：** 如果受害者使用私钥对软件进行签名，攻击者可以使用恢复的私钥对恶意软件进行签名，从而进行供应链攻击。

**投毒风险分析：**

该仓库可能存在低概率的投毒风险。 虽然提供的 `id_rsa`和`id_rsa.pub`可能用于验证poc的效果，但是也可能被恶意使用者滥用，例如替换dockerfile中的id_rsa,在不知情的情况下构建包含恶意后门的镜像，因此判定投毒风险为 10%。 多数代码都比较直观，用于搭建一个包含易受攻击密钥的 SSH 服务器，并没有明显的恶意代码。

**项目地址:** [edutko/cve-2024-31497](https://github.com/edutko/cve-2024-31497)

**漏洞详情:** [CVE-2024-31497](https://nvd.nist.gov/vuln/detail/CVE-2024-31497)