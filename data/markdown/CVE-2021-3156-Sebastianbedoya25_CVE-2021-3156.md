## CVE-2021-3156 - Sudo Heap-Based Buffer Overflow (Baron Samedit)

**漏洞编号:** CVE-2021-3156

**漏洞类型:** Heap-Based Buffer Overflow

**影响应用:** Sudo

**危害等级:** 高危，允许本地普通用户提升权限至root

**影响版本:** < 1.9.5p2

**利用条件:** 本地用户可执行sudo命令且sudo版本在受影响范围内

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2021-3156（Baron Samedit）是一个存在于Sudo 1.9.5p2之前的版本中的堆缓冲区溢出漏洞。此漏洞允许任何本地用户通过`sudoedit -s`和一个以单个反斜杠字符结尾的命令行参数来提升权限至root。

**有效性分析：**

提供的POC代码包括一个Makefile、exploit.c和一个shellcode.c，看起来是完整的利用代码。从exploit.c的代码注释和实现来看，它旨在利用`sudoedit -s`的命令行参数解析中的off-by-one错误触发堆溢出。代码中使用了堆风水（heap feng shui）技术，通过环境变量`LC_MESSAGES`, `LC_TELEPHONE`，`LC_MEASUREMENT`和精心构造的`overflow`变量，来控制堆的布局，从而覆盖目标内存区域。shellcode.c包含提权至root并执行/bin/sh的代码。Makefile文件用于编译exploit和shellcode，将shellcode编译为动态链接库`libnss_x/x.so.2`，但exploit.c并没有用到这个动态链接库，而是直接使用execve执行`/bin/sh`。 根据搜索结果和漏洞库信息，该漏洞利用方法是可行的，并被广泛研究和利用。

**投毒风险分析：**

*   **Makefile:**  Makefile只包含编译和清理目标，没有可疑行为。 *   **exploit.c:** exploit.c的代码主要用于构造漏洞利用所需的参数和环境变量，并调用`execve`执行`/usr/bin/sudoedit`。代码逻辑上是为了触发漏洞利用，没有发现明显的恶意代码，如反弹shell或植入后门。但是，该代码的功能就是提权，本身具有一定风险，应当在测试环境中使用。 *   **shellcode.c:** shellcode.c包含提权代码（setuid(0), setgid(0)）并执行/bin/sh的代码。这段代码的目的是在成功利用漏洞后获取root权限的shell。这里需要注意的是，这段shellcode会将当前用户的权限提升到root，并执行/bin/sh，本质上是打开一个具有root权限的shell会话。从利用漏洞的角度看，这是预期的行为，不能被认为是投毒行为。 *   **综合判断：** 由于提供的代码主要功能是验证漏洞并提权，没有发现明显的恶意行为，因此可以认为投毒的可能性较低。虽然代码本身具有提权功能，但是这是漏洞利用的正常组成部分。因此，投毒风险评估为0%。

**利用方式分析：**

1.  **编译：** 使用Makefile编译exploit.c和shellcode.c。Shellcode被编译成一个动态链接库，但在这个提供的exploit.c版本中，并没有显式加载或者依赖这个动态链接库。 2.  **堆风水：** 设置环境变量`LC_MESSAGES`， `LC_TELEPHONE`， `LC_MEASUREMENT`和 `overflow`，来控制堆的内存布局，方便覆盖关键数据。 3.  **触发漏洞：** 调用`sudoedit -s`，并传入一个以反斜杠结尾的长字符串作为参数。这个反斜杠会触发off-by-one错误，导致堆缓冲区溢出。 4.  **覆盖：** 堆缓冲区溢出覆盖相邻的内存区域，通常是覆盖`sudo`进程的关键数据结构。 5.  **提权和执行Shellcode：**  尽管shellcode编译成了动态链接库，但实际的利用是通过溢出覆盖数据，使sudo以root权限执行`/bin/sh`， 或者覆盖函数指针，劫持控制流执行shellcode（当前提供的exploit.c没有使用shellcode）。

总而言之，利用方式是通过构造特殊的命令行参数和环境变量，利用`sudoedit -s`的off-by-one错误触发堆溢出，最终获得root权限。

**项目地址:** [Sebastianbedoya25/CVE-2021-3156](https://github.com/Sebastianbedoya25/CVE-2021-3156)

**漏洞详情:** [CVE-2021-3156](https://nvd.nist.gov/vuln/detail/CVE-2021-3156)