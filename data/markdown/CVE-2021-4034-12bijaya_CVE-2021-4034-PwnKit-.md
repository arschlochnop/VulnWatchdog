## CVE-2021-4034-Polkit-pkexec本地提权

**漏洞编号:** CVE-2021-4034

**漏洞类型:** 本地权限提升

**影响应用:** Polkit

**危害等级:** 高危，未经授权的用户获得root权限

**影响版本:** all

**利用条件:** 本地用户访问pkexec

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-4034 (PwnKit) 是 polkit 的 pkexec 工具中的一个本地权限提升漏洞。pkexec 是一个 setuid 工具，允许非特权用户根据预定义的策略以特权用户身份运行命令。该漏洞是由于 pkexec 未正确处理调用参数计数，最终尝试将环境变量作为命令执行。攻击者可以通过精心设计的环境变量来诱使 pkexec 执行任意代码，从而获得 root 权限。

**有效性：**
提供的 POC 代码是有效的。它利用了 pkexec 的漏洞，通过设置特定的环境变量 (GCONV_PATH, CHARSET, SHELL) 来加载恶意的 gconv 模块，该模块包含提权 shellcode。POC 代码首先创建必要的目录和文件，然后编译包含提权代码的共享库，最后通过 `execve` 函数，使用特制的 env 启动 `/usr/bin/pkexec`，成功执行shellcode。

**投毒风险：**
代码本身实现了漏洞利用，但存在轻微的投毒风险，风险评估为10%。

*   **潜在的后门代码：**
虽然提供的 Shellcode 会创建一个 root shell，但可以修改 shellcode 以包含其他恶意操作，例如添加后门帐户或修改系统文件。虽然当前的shellcode明确包含了清理操作（`rm -rf 'GCONV_PATH=.' 'pwnkit'`），减少了暴露，但如果存在疏忽，仍然可能留下痕迹。
*   **依赖性混淆：**虽然POC脚本本身比较完整，但攻击者可能会尝试混淆对特定库或工具的依赖关系，使分析变得更加困难。
*    **作者意图：** 投毒的判断主要在于作者是否有意图引入恶意行为。考虑到这是一个漏洞利用 POC，重点在于演示漏洞，而不是进行隐蔽的攻击。但存在将shellcode替换为更加隐蔽的代码的可能性

**利用方式：**
1.  **创建 GCONV_PATH 目录和触发文件：** 利用 `mkdir` 和 `touch` 命令创建假的 `GCONV_PATH` 目录和触发文件。
2.  **创建 gconv-modules 文件：**  创建一个包含模块定义信息的 `gconv-modules` 文件，指定 UTF-8 和 PWNKIT 编码之间的转换使用自定义的 pwnkit 模块。
3.  **创建恶意的 gconv 模块（pwnkit.c）：** 创建包含 shellcode 的 C 代码文件 `pwnkit/pwnkit.c`。该 shellcode 设置用户 ID 和组 ID 为 root，然后启动一个 root shell。
4.  **编译 pwnkit.c 为共享库：** 使用 `gcc` 命令将 `pwnkit.c` 编译成一个共享库文件 `pwnkit/pwnkit.so`。
5.  **设置环境变量：**  设置环境变量 `GCONV_PATH=.`，`CHARSET=PWNKIT`，`SHELL=pwnkit`。这些环境变量会欺骗 pkexec 加载恶意的 gconv 模块。
6.  **执行 pkexec：**  使用 `execve` 函数执行 `/usr/bin/pkexec`，并将精心构造的环境变量传递给它。这将触发漏洞，加载恶意的 gconv 模块，并执行 shellcode，从而获得 root 权限。

简单来说，攻击者通过构造特定的环境变量，使得 pkexec 在执行过程中加载并执行攻击者提供的恶意代码，从而实现权限提升。

**项目地址:** [12bijaya/CVE-2021-4034-PwnKit-](https://github.com/12bijaya/CVE-2021-4034-PwnKit-)

**漏洞详情:** [CVE-2021-4034](https://nvd.nist.gov/vuln/detail/CVE-2021-4034)