## CVE-2019-11043 - PHP-FPM 远程代码执行

**漏洞编号:** CVE-2019-11043

**漏洞类型:** 缓冲区溢出

**影响应用:** PHP-FPM (结合 Nginx)

**危害等级:** 高危，可能导致远程代码执行

**影响版本:** PHP 7.1.x (< 7.1.33), 7.2.x (< 7.2.24), 7.3.x (< 7.3.11)

**利用条件:** 需要 Nginx 作为前端，配置不当，将请求传递给 PHP-FPM，并存在 `env_path_info` 下溢漏洞。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2019-11043 漏洞是一个 PHP-FPM 的缓冲区溢出漏洞，存在于 `fpm_main.c` 文件中的 `env_path_info` 处理逻辑中。当 Nginx 配置不正确时，攻击者可以利用此漏洞实现远程代码执行。

**利用方式：**

1.  **构造恶意请求：** 攻击者通过构造特殊的 URL，利用 `env_path_info` 下溢漏洞。
2.  **缓冲区溢出：**  精心设计的请求会导致 PHP-FPM 在处理 FastCGI 协议数据时，写入超出分配缓冲区范围的数据。
3.  **远程代码执行：** 通过溢出，覆盖 FCGI 协议数据，进而控制 PHP-FPM 进程，执行任意代码。

**有效性评估：**

根据漏洞库信息、搜索结果和提供的 POC 代码，可以确认该漏洞是真实存在的，并且存在可利用的 POC 代码。多个安全厂商和研究人员都对此漏洞进行了分析和复现。

提供的 POC 代码 `exploit.py` 主要步骤如下：

1.  **探测 QSL (Query String Length)：** 脚本首先通过发送一系列不同长度的请求，探测能够触发 500 错误（服务器内部错误）的 QSL 范围。这是为了找到合适的请求长度，以便利用缓冲区溢出漏洞。
2.  **利用漏洞设置 PHP 配置：** 一旦找到合适的 QSL，脚本就会发送带有 `PHP_VALUE` 的请求，尝试修改 PHP 的配置选项，例如 `session.auto_start`。这是利用该漏洞的关键步骤，攻击者通过覆盖某些变量，最终可以执行任意 PHP 代码。
3.  **远程代码执行：** 在成功设置 PHP 配置后，攻击者可以利用修改后的配置执行任意命令。POC 代码中使用了 `extension` 设置来执行命令。

**投毒风险评估：**

分析 POC 代码后，发现存在一定的投毒风险，约 10%。风险主要体现在：

1.  **隐蔽的 PHP 设置：** POC 利用了 `PHP_VALUE` 来修改 PHP 的配置，这些配置可能包含一些隐蔽的后门，例如设置 `auto_prepend_file` 或 `auto_append_file` 来包含恶意代码。
2.  **依赖外部资源：** 虽然 POC 没有直接包含恶意代码，但是它可能会依赖服务器上的其他文件或资源，这些文件或资源可能被替换为恶意代码。
3.  **复杂逻辑：** POC 的代码逻辑比较复杂，攻击者可能会在其中插入一些难以察觉的恶意代码，例如在 `requests.get` 中添加一些额外的参数或头部，将敏感数据发送到远程服务器。

**总体评估：**

该漏洞的利用难度较高，需要对 Nginx 和 PHP-FPM 的配置以及 FastCGI 协议有一定的了解。但是，一旦成功利用，攻击者可以完全控制服务器，造成严重的危害。

**防范建议：**

1.  **升级 PHP 版本：** 升级到不受此漏洞影响的 PHP 版本。
2.  **正确配置 Nginx：** 确保 Nginx 配置正确，防止将恶意请求传递给 PHP-FPM。可以使用 `try_files` 或 `if (-f $uri)` 等指令来检查目标文件是否存在。
3.  **WAF 防护：** 使用 Web 应用防火墙 (WAF) 来检测和阻止利用此漏洞的攻击。

**项目地址:** [theMiddleBlue/CVE-2019-11043](https://github.com/theMiddleBlue/CVE-2019-11043)

**漏洞详情:** [CVE-2019-11043](https://nvd.nist.gov/vuln/detail/CVE-2019-11043)