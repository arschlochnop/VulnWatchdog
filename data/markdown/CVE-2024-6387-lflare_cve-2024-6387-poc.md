## CVE-2024-6387-OpenSSH-竞争条件

**漏洞编号:** CVE-2024-6387

**漏洞类型:** 竞争条件

**影响应用:** OpenSSH

**危害等级:** 高危，可能导致远程代码执行或拒绝服务

**影响版本:** 8.5p1 <= 版本 <= 9.7p1

**利用条件:** 需要网络访问OpenSSH服务

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-6387是OpenSSH服务器(sshd)中的一个竞争条件漏洞，源于CVE-2006-5051的安全回归。当sshd在不安全的方式下处理某些信号时，未经验证的远程攻击者可能通过在设定的时间内未能成功验证身份来触发此漏洞。

**有效性评估：**
根据漏洞信息和搜索结果，此漏洞的PoC已经发布，并且被广泛讨论，证明了其有效性。PoC代码（`7etsuo-regreSSHion.c`）尝试利用此漏洞，通过以下步骤：

1.  **连接建立：** 与目标OpenSSH服务器建立TCP连接。
2.  **SSH握手：** 执行初步的SSH协议握手。
3.  **堆准备：** 准备堆布局以进行利用。
4.  **时间测量：** 测量数据包解析时间。
5.  **竞争条件尝试：** 尝试触发竞争条件，利用信号处理中的不安全函数调用，最终目标是执行shellcode，提权至root。
6.  **ASLR绕过：**尝试不同的glibc基地址，以绕过地址空间布局随机化(ASLR)。

代码中包含了尝试20000次利用的循环，以及100ms的延时，这些都符合漏洞分析文章的描述，增加了利用成功的可能性。

**投毒风险评估：**

此PoC代码存在一定程度的投毒风险，因为:

1.  **Shellcode:** PoC代码包含一个shellcode占位符，攻击者需要替换成真实的shellcode。如果提供的shellcode本身是恶意的，那么使用此PoC会导致投毒。
2. **glibc地址:** PoC代码包含glibc基址，攻击者需要手动调整为目标系统的基址。如果提供的基址不正确，或者根本无法确定正确的基址，会影响利用成功率。如果攻击者故意提供错误的基址或者使用错误的基址绕过策略，也有可能导致拒绝服务。
3.  **定时参数：** PoC代码中的定时参数需要根据目标系统的响应速度进行调整。如果定时不当，可能导致利用失败，甚至使目标系统崩溃。
4.  **heap布局:** OpenSSH的堆布局会随着版本的变化而变化，需要针对不同的版本进行调整。如果不调整，可能无法成功利用。

**评估：**
PoC代码的编写者可能在代码中加入不易察觉的恶意行为，例如收集目标系统信息并发送到远程服务器等。但是，考虑到PoC的主要目的是为了验证漏洞，因此这种风险相对较低。PoC中已经存在大量的需要修改的地方，需要使用者有一定的漏洞知识储备，因此投毒风险相对较低。

**综合评估**：PoC中投毒风险预估为10%，

**利用方式总结：**

1.  攻击者首先需要与目标OpenSSH服务器建立连接。
2.  然后，攻击者需要执行SSH握手协议。
3.  接着，攻击者发送特制的数据包，触发sshd中的竞争条件。
4.  竞争条件允许攻击者覆盖内存中的关键数据结构。
5.  攻击者通过覆盖的数据结构，执行预先准备好的shellcode，从而获得目标系统的root权限。
6. 利用过程需要绕过ASLR保护，这可能需要多次尝试，或者使用其他信息泄露漏洞。
7. 攻击需要一定的timing， 把握好发送数据包的时间。

**项目地址:** [lflare/cve-2024-6387-poc](https://github.com/lflare/cve-2024-6387-poc)

**漏洞详情:** [CVE-2024-6387](https://nvd.nist.gov/vuln/detail/CVE-2024-6387)