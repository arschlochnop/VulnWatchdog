## CVE-2022-44268-ImageMagick-Arbitrary File Read

**漏洞编号:** CVE-2022-44268

**漏洞类型:** 任意文件读取

**影响应用:** ImageMagick

**危害等级:** 高危，可能导致敏感信息泄露

**影响版本:** <= 7.1.0-49

**利用条件:** 需要ImageMagick处理恶意构造的PNG图片，Magick binary需要有读取目标文件的权限

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2022-44268是ImageMagick的一个任意文件读取漏洞。当ImageMagick解析PNG图像时，攻击者可以通过在PNG文件中嵌入指向目标文件的payload，使ImageMagick读取该文件内容。利用方式如下：

1.  **生成恶意PNG图片：** 使用提供的`generate.py`脚本，指定要读取的文件路径（`-f`参数）和输出文件名（`-o`参数）。该脚本首先创建一个空白PNG图片，然后将文件路径嵌入到PNG的text chunk中。
2.  **使用ImageMagick转换PNG图片：** 使用`convert`命令处理生成的PNG图片。这个步骤会触发漏洞，ImageMagick尝试读取PNG文件中指定的路径。
3.  **读取转换后的图片信息：** 使用`identify -verbose`命令查看转换后的PNG图片的详细信息。目标文件的内容会被编码后包含在Raw profile type字段中。
4.  **解码文件内容：** 使用Python脚本解码Raw profile type字段中的内容，即可获取目标文件的内容。

**有效性：** 根据漏洞描述和提供的PoC代码，该漏洞利用是有效的，可以读取服务器上ImageMagick进程有权限访问的任意文件。

**投毒风险：**  分析`generate.py`脚本，该脚本的功能主要是生成包含payload的PNG文件，没有发现任何恶意代码或者后门，因此，投毒风险为0%。 脚本的主要流程为：生成一个基础png图片(gradient.png)，然后使用PIL库将要读取的文件路径作为文本信息添加到png图片的PngInfo中，最后保存图片。没有发现任何可疑操作。

**利用方式：** 该漏洞通过在PNG图片中嵌入指向目标文件的路径，当ImageMagick处理该图片时，会尝试读取目标文件，并将文件内容嵌入到输出图片的元数据中，攻击者可以通过读取输出图片的元数据来获取目标文件的内容。

**项目地址:** [Sybil-Scan/imagemagick-lfi-poc](https://github.com/Sybil-Scan/imagemagick-lfi-poc)

**漏洞详情:** [CVE-2022-44268](https://nvd.nist.gov/vuln/detail/CVE-2022-44268)