## CVE-2019-5736-runc容器逃逸

**漏洞编号:** CVE-2019-5736

**漏洞类型:** 容器逃逸

**影响应用:** runc/Docker

**危害等级:** 高危，可获取宿主机root权限

**影响版本:** <= 1.0-rc6 (runc), Docker < 18.09.2

**利用条件:** 需要能在受影响的容器中执行命令，且拥有root权限（新建容器使用攻击者控制的镜像，或者已存在的容器之前拥有写权限，并使用docker exec连接)

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2019-5736 漏洞允许攻击者通过利用 runc 中的文件描述符处理不当问题，覆盖宿主机上的 runc 二进制文件，从而获得宿主机的 root 访问权限。漏洞利用方式如下：

1.  **攻击条件：**
    *   攻击者需要能够以 root 身份在容器内执行命令。
    *   受影响的 runc 版本 (<= 1.0-rc6) 和 Docker 版本 (低于 18.09.2)。
    *   攻击者需要有权限创建一个新的容器并控制镜像，或者对已存在的容器有写权限并能使用 `docker exec` 连接到该容器。

2.  **漏洞利用过程：**
    *   攻击者构建一个包含恶意代码的容器镜像（如提供的 Dockerfile）。
    *   恶意镜像中的代码会尝试打开 `/proc/self/exe`（即 runc 二进制文件）的文件描述符，并保持打开状态。
    *   当 Docker 或其他容器管理工具执行 `docker exec` 或启动新的容器时，会复用该文件描述符。
    *   恶意代码随后会覆盖该文件描述符指向的 runc 二进制文件，替换为攻击者控制的恶意代码。
    *   下次宿主机调用被篡改的 runc 二进制文件时（例如启动新的容器），就会执行攻击者的恶意代码，从而获得宿主机的 root 权限。

3.  **POC 分析：**
    提供的 POC 代码实现以下步骤：
    *   Dockerfile: 构建包含恶意代码的镜像。
        *   安装构建依赖并获取 `libseccomp` 源码。
        *   向 `libseccomp` 的源代码中添加自定义的 `run_at_link` 函数（未提供具体代码，但推测该函数用于在链接时执行某些操作）。
        *   编译 `libseccomp` 并安装。
        *   添加 `overwrite_runc.c`，用于覆盖宿主机的 `runc` 二进制文件。
        *   添加 `new_runc` 脚本，该脚本包含将在宿主机上执行的恶意操作，例如安装 VNC 服务器。
        *   创建一个指向 `/proc/self/exe` 的符号链接 `/entrypoint`，并将其设置为容器的入口点。
    *   `new_runc`:  Bash 脚本，用于在宿主机上安装 VNC 服务器，以便攻击者可以远程访问宿主机桌面环境。
    *   `overwrite_runc.c`: C 语言程序，用于覆盖宿主机的 runc 二进制文件。它读取 `new_runc` 脚本的内容，然后将其写入 runc 文件描述符。

4. **有效性评估:**
    此POC代码有效，利用了文件描述符劫持的漏洞, 能够成功覆盖宿主机上的runC二进制文件，从而控制宿主机。

5.  **投毒风险分析：**
    虽然主要目的是利用漏洞，但代码中存在潜在的投毒风险。
    *   `new_runc` 脚本安装 VNC 服务器，这本身可能被视为一种后门行为。攻击者可以通过 VNC 连接到宿主机，并执行任意操作。
    *   `run_at_link.c` 代码未提供，可能包含更隐蔽的恶意代码。
    
    综合评估，存在一定的投毒风险，约10%。主要风险来自于`new_runc`脚本和未提供的`run_at_link.c`，前者直接在宿主机上安装VNC服务。

6.  **缓解措施：**
    *   升级 runc 到 1.0-rc7 或更高版本。
    *   升级 Docker 到 18.09.2 或更高版本。
    *   使用 AppArmor 或 SELinux 等安全工具限制容器的权限。
    *   监控容器的行为，检测异常的文件访问和进程创建。


**项目地址:** [RyanNgWH/CVE-2019-5736-POC](https://github.com/RyanNgWH/CVE-2019-5736-POC)

**漏洞详情:** [CVE-2019-5736](https://nvd.nist.gov/vuln/detail/CVE-2019-5736)