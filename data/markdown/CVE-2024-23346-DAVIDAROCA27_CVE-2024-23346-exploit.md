## CVE-2024-23346-pymatgen-代码注入

**漏洞编号:** CVE-2024-23346

**漏洞类型:** 代码注入

**影响应用:** pymatgen

**危害等级:** 高危，可导致任意代码执行

**影响版本:** < 2024.2.20

**利用条件:** 需要目标存在pymatgen库的易受攻击版本，且允许上传CIF文件

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

该漏洞存在于 pymatgen 库的 `JonesFaithfulTransformation.from_transformation_str()` 方法中，由于其使用 `eval()` 函数处理输入，攻击者可以通过构造恶意的 CIF 文件，上传后执行任意代码。

**有效性：**
根据漏洞描述和搜索结果，该漏洞是由于 `eval()` 函数的使用导致的代码注入，POC代码通过构造恶意的 CIF 文件，利用 `_space_group_magn.transform_BNS_Pp_abc` 字段中的 `eval()` 执行命令，从而达到任意代码执行的目的。因此POC代码有效。

**投毒风险：**
POC代码中存在一定投毒风险。主要体现在以下几个方面：
1.  **命令执行位置：**
    *   恶意代码注入点在CIF文件的 `_space_group_magn.transform_BNS_Pp_abc` 字段中，利用了`eval()`函数执行系统命令。
2.  **反弹shell的处理：**
    *   使用`nc`命令反弹shell，增加了服务器风险。

代码的其他部分，如登录、删除结构等，主要是为了配合漏洞利用，本身不构成直接的投毒行为。整体风险较低，评估投毒风险为10%。

**利用方式：**
1.  **身份验证：**  首先需要获取目标系统的有效session cookie。如果未登录，POC会尝试使用提供的用户名和密码登录，然后获取cookie。
2.  **清理环境：**  漏洞利用前，POC会尝试删除服务器上已存在的结构，以确保漏洞利用的成功（delete函数）。
3.  **构造恶意CIF文件：**  POC会构造一个恶意的CIF文件，其中 `_space_group_magn.transform_BNS_Pp_abc` 字段包含要执行的恶意代码。该代码使用 `eval()` 函数执行，并利用 `os.system()` 函数执行系统命令，将命令执行的结果通过`nc`反弹到攻击者指定的IP和端口。
4.  **上传恶意CIF文件：**  POC将构造好的CIF文件上传到服务器上的`/upload`路径。
5.  **触发漏洞：**  上传完成后，访问 `/structure/{pattern.group(1)}` 触发漏洞执行。
6.  **清理环境：**  利用完成后，POC会再次尝试删除服务器上已存在的结构(delete函数)，实现清理。
7.  **交互式命令执行：**  漏洞利用支持交互式命令执行，允许攻击者重复执行命令。

综上，漏洞利用过程较为完整，包含身份验证、环境清理、漏洞触发和利用后清理等步骤。

**项目地址:** [DAVIDAROCA27/CVE-2024-23346-exploit](https://github.com/DAVIDAROCA27/CVE-2024-23346-exploit)

**漏洞详情:** [CVE-2024-23346](https://nvd.nist.gov/vuln/detail/CVE-2024-23346)