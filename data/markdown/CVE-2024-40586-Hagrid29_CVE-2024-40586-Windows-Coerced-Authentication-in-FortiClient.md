## CVE-2024-40586 FortiClient Windows 本地提权漏洞

**漏洞编号:** CVE-2024-40586

**漏洞类型:** 权限提升

**影响应用:** FortiClientWindows

**危害等级:** 中危，本地权限提升

**影响版本:** 7.4.0, <=7.2.6, <=7.0.13

**利用条件:** 需要本地访问

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-40586 是 FortiClient Windows 版本中的一个不当访问控制漏洞 (CWE-284)。该漏洞允许本地用户通过 FortiSSLVPNd 服务管道提升其权限。根据漏洞利用代码，攻击者可以通过向 `FortiSslvpnNamedPipe` 命名管道发送特制的流量，触发操作码 24，从而强制 `FortiSSLVPNdaemon.exe` 进程以 SYSTEM 权限调用 `CreateFileA`。这允许攻击者通过 UNC 路径连接到远程文件服务器或本地命名管道，从而实现权限提升。 

**漏洞利用方式:**

1.  **场景 1：强制 Windows 主机向其他机器进行身份验证 (Coerced Authentication):**
    *   攻击者在其机器上启动一个监听器，以接收强制身份验证。
    *   攻击者向受害者机器的 `\\<victim IP>\pipe\FortiSslvpnNamedPipe` 命名管道发送特制 payload（`\x00\x00\x00\x00\x18\x00` + `\\<attacker IP>\fake\fake`），强制 `FortiSSLVPNdaemon.exe` 进程通过 UNC 路径 `\\<attacker IP>\fake\fake` 连接到远程文件。
    *   攻击者可以执行中继攻击或身份验证降级攻击，类似于 SpoolSample 攻击。

2.  **场景 2：从具有 `SeImpersonatePrivilege` 权限的本地用户提升权限到 SYSTEM:**
    *   创建一个命名管道服务器，等待连接。
    *   向本地 `\\.\pipe\FortiSslvpnNamedPipe` 命名管道发送特制 payload（`\x00\x00\x00\x00\x18\x00` + `\\127.0.0.1\pipe\<pipe server>\XXX`），强制 `FortiSSLVPNdaemon.exe` 进程连接到攻击者的命名管道服务器。
    *   在连接建立后，调用 `ImpersonateNamedPipeClient()` 来模拟 SYSTEM 权限。

**投毒风险分析:**

该POC代码主要功能是构造和发送特定的数据包到存在漏洞的命名管道，利用windows API函数进行权限提升，本身不具备后门或恶意功能。但是，由于 POC 代码是一个 Visual Studio 项目，存在编译后植入恶意代码的可能。虽然代码本身功能是权限提升，但也不排除作者在代码中插入了执行恶意操作（例如反弹shell，安装后门）的可能性。因此，判断存在 10% 的投毒可能性。

**项目地址:** [Hagrid29/CVE-2024-40586-Windows-Coerced-Authentication-in-FortiClient](https://github.com/Hagrid29/CVE-2024-40586-Windows-Coerced-Authentication-in-FortiClient)

**漏洞详情:** [CVE-2024-40586](https://nvd.nist.gov/vuln/detail/CVE-2024-40586)