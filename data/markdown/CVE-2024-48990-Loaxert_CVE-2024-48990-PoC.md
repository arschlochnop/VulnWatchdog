## CVE-2024-48990-needrestart-权限提升

**漏洞编号:** CVE-2024-48990

**漏洞类型:** 权限提升

**影响应用:** needrestart

**危害等级:** 高危，允许本地用户提升为root权限

**影响版本:** < 3.8

**利用条件:** 需要本地用户权限，目标系统安装了受影响的needrestart版本

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2024-48990 漏洞存在于 needrestart 3.8 之前的版本中。该漏洞允许本地攻击者通过操纵 `PYTHONPATH` 环境变量来以 root 权限执行任意代码。 

**利用方式：**

1.  攻击者创建一个包含恶意代码的 Python 库（此处的 `__init__.so`）。
2.  攻击者创建一个 Python 脚本 `e.py`，该脚本尝试导入 `importlib`。
3.  攻击者设置 `PYTHONPATH` 环境变量指向包含恶意库的目录。
4.  当 needrestart 运行时，它会读取受攻击进程的 `PYTHONPATH` 环境变量，并在其自己的 Python 解释器中设置它。
5.  由于 `PYTHONPATH` 被设置为指向恶意库，needrestart 的 Python 解释器会加载并执行恶意代码，从而导致权限提升。

**POC 分析：**

*   `binary.sh` 脚本编译一个共享库 `__init__.so`。该库包含一个在加载时自动执行的函数 `a()`。这个函数会检查当前进程是否以 root 权限运行，如果是，则创建一个 SUID 权限的 shell `/tmp/poc`，并尝试将 `ALL ALL=NOPASSWD: /tmp/poc` 添加到 `/etc/sudoers` 文件中，允许任何用户无需密码以root权限运行 `/tmp/poc`。 
*   `runner.sh` 脚本首先创建一个目录 `/tmp/malicious/importlib`，然后从攻击者的 HTTP 服务器下载编译好的恶意库 `__init__.so` 到该目录。 接着，它创建一个 Python 脚本 `e.py`，这个脚本在一个无限循环中尝试导入 `importlib`。 关键在于，该脚本设置了 `PYTHONPATH` 环境变量指向 `/tmp/malicious` 目录，然后运行 `e.py`。
*   **漏洞利用流程:** `runner.sh` 创建一个进程，并设置PYTHONPATH。当以root权限运行 `needrestart` 时，`needrestart` 会读取这个进程的PYTHONPATH，并在自己的环境中设置它。这使得`needrestart`的python 解释器加载了`__init__.so`，触发了权限提升。

**投毒风险：**

提供的代码中没有明显的投毒代码。`binary.sh` 创建的后门虽然危险，但这是 PoC 的预期行为，用于演示权限提升。 脚本的目标是在 `/tmp` 目录下创建一个 SUID 权限的 shell，并通过修改 `/etc/sudoers` 文件来允许无密码 sudo。 虽然这些操作具有潜在的风险，但它们的目的是演示漏洞利用，而不是隐藏恶意代码或对系统造成长期损害。

 **有效性：** 提供的POC代码有效，能成功利用该漏洞。

**项目地址:** [Loaxert/CVE-2024-48990-PoC](https://github.com/Loaxert/CVE-2024-48990-PoC)

**漏洞详情:** [CVE-2024-48990](https://nvd.nist.gov/vuln/detail/CVE-2024-48990)