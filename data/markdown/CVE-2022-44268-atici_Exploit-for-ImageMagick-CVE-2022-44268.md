## CVE-2022-44268-ImageMagick-任意文件读取

**漏洞编号:** CVE-2022-44268

**漏洞类型:** 任意文件读取

**影响应用:** ImageMagick

**危害等级:** 高危，可能导致敏感信息泄露

**影响版本:** 7.1.0-49 (受影响版本)

**利用条件:** 需要ImageMagick能够解析攻击者提供的PNG图片，且Magick二进制文件具有读取目标文件的权限。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2022-44268 漏洞存在于 ImageMagick 中，当它解析 PNG 图像（例如，为了调整大小）时，生成的图像可能嵌入任意文件的内容（如果 magick 二进制文件具有读取该文件的权限）。

**有效性：**
根据漏洞库信息和搜索结果，该漏洞确实存在，并且影响 ImageMagick 7.1.0-49。提供的POC代码旨在利用此漏洞。

**投毒风险：**
分析 `script.sh` 脚本：

1.  **常规操作：** 脚本的主要功能是使用 `pngcrush` 工具将指定文件的内容作为文本元数据嵌入到 PNG 图像中。这个操作本身是利用漏洞的关键。
2.  **依赖外部工具：** 脚本依赖于 `imagemagick`、`exiftool`、`pngcrush` 和 `exiv2`，这些工具本身是常见的图像处理工具。如果这些工具被篡改，可能存在投毒风险。但是，脚本本身没有主动去下载或安装这些工具，只是检查它们是否存在。
3.  **提取数据：**  脚本包含一个提取数据的选项 `-d`，它从修改后的PNG文件中提取嵌入的文件内容。提取是通过`identify`命令和一系列文本处理命令完成的，没有发现恶意操作。
4.  **潜在风险：** 虽然脚本本身的功能看起来没有明显的恶意代码，但是如果攻击者诱导用户下载并执行此脚本，而用户又恰好以 root 权限运行，那么脚本可能会读取一些敏感文件（例如 `/etc/passwd`），从而导致信息泄露。 另一种风险存在于脚本对用户输入（路径和文件名）的直接使用，如果输入不经过充分的验证，可能导致一些意想不到的问题，但这些问题主要属于脚本的健壮性问题，而非主动投毒。

**综合评估：**
*   此仓库中存在作者隐藏的投毒代码的可能性较低。风险主要集中在用户误用脚本，或者系统上依赖的外部工具被篡改的情况。 我认为有百分之10的可能性存在我没有发现的隐藏投毒代码。

**利用方式：**
1.  **准备PNG图片：** 准备一个合法的PNG图片作为基础。
2.  **执行脚本：** 运行`script.sh -p [Path to Read] [PNG Image] [Output[Optional, if not used defaults to pngout.png]]`，例如 `./script.sh -p /etc/passwd sample.png output.png`。
3.  **利用`pngcrush`嵌入文件：** 脚本使用`pngcrush`将指定的文件（例如 `/etc/passwd`）的内容以文本元数据的方式嵌入到PNG图像中。
4.  **触发漏洞：** 将生成的PNG图像提交给使用存在漏洞的 ImageMagick 版本的服务或应用。当 ImageMagick 处理此PNG图像时，会读取嵌入的文件内容。
5.  **提取文件内容：** 运行`script.sh -d [PNG Image]` 从包含注入数据的PNG文件中提取文件内容。 例如 `./script.sh -d pngout.png`

**项目地址:** [atici/Exploit-for-ImageMagick-CVE-2022-44268](https://github.com/atici/Exploit-for-ImageMagick-CVE-2022-44268)

**漏洞详情:** [CVE-2022-44268](https://nvd.nist.gov/vuln/detail/CVE-2022-44268)