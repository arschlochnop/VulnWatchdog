## CVE-2024-38475 - Apache HTTP Server mod_rewrite 不当转义漏洞

**漏洞编号:** CVE-2024-38475

**漏洞类型:** 路径遍历/代码执行/源码泄露

**影响应用:** Apache HTTP Server

**危害等级:** 高危，可能导致代码执行或源码泄露

**影响版本:** <= 2.4.59

**利用条件:** 服务器配置了存在缺陷的mod_rewrite规则，且允许访问目标文件系统位置。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-38475 存在于 Apache HTTP Server 的 mod_rewrite 模块中，由于不当的输出转义，攻击者可以通过构造特殊的 URL，利用服务器上配置的 mod_rewrite 规则，将 URL 映射到文件系统上本不应该直接访问的位置，从而导致代码执行或源码泄露。

**漏洞利用方式：**

1.  **利用场景：** 该漏洞利用依赖于服务器上配置的特定的、存在缺陷的 `mod_rewrite` 规则。这些规则通常会使用后向引用或变量作为替换的第一个段，并且没有充分限制替换目标。
2.  **攻击步骤：**
    *   攻击者构造一个恶意的 URL，该 URL 可以被存在缺陷的 `mod_rewrite` 规则处理。
    *   `mod_rewrite` 规则在处理该 URL 时，由于不当的输出转义，会将 URL 映射到服务器文件系统上本不应该直接访问的位置，比如 Web 根目录之外的目录或敏感配置文件。
    *   服务器返回该位置的文件内容（源码泄露）或执行其中的代码（代码执行）。

**提供的PoC代码分析：**

提供的 `scanner.sh` 脚本并非直接利用 CVE-2024-38475 漏洞，而是用于扫描目标网站，尝试寻找可以绕过访问限制的文件。它通过以下步骤进行：

1.  **目录扫描 (403 Bypass)：**  使用 `ffuf` 工具，扫描目标网站的常见目录，寻找返回 HTTP 403 (Forbidden) 错误的目录。`ffuf`是一个模糊测试工具，用于发现Web应用程序中的各种漏洞。
2.  **文件扫描 (Bypass Payloads)：** 对于找到的 403 目录，脚本尝试使用一些 Payload (`%3F`, `%3Fooooo.php`) 来绕过限制，扫描这些目录下的常见文件。如果某个文件可以被访问（返回 HTTP 200），则将其 URL 记录到 `final_report.txt` 文件中。
3.  **报告生成：** 脚本会将所有发现的可访问的 URL 记录到 `final_report.txt` 文件中。

**有效性评估：**

提供的PoC代码本身并不能直接利用 CVE-2024-38475 漏洞，它只是一个通用的网站扫描工具，用于查找绕过访问限制的文件。但是，如果目标网站存在可以通过修改URL（例如使用`%3F`或附加特定后缀）绕过访问限制的文件，这个脚本就可以找到它们。因此，**不能直接验证 CVE-2024-38475 的利用情况**。

**投毒风险评估：**

*   **目标文件：** `scanner.sh` 和 `targets.txt`
*   **潜在风险点：** 脚本使用外部词表文件 (`/usr/share/seclists/Discovery/Web-Content/raft-medium-directories.txt` 和 `/usr/share/seclists/Discovery/Web-Content/raft-medium-files.txt`) 和简单的payload，以及`jq`和`ffuf`命令。 投毒的可能性主要集中在 targets.txt 和恶意命令执行。  但是当前脚本并没有发现存在异常。
*   **风险分析：**  targets.txt 可能包含恶意的URL，导致扫描行为本身触犯法律法规。 脚本依赖的外部命令可能存在潜在风险，如果被人篡改可能导致恶意行为。 另外两个词表文件如果被篡改,虽然存在风险,但是影响较小。
*   **风险比例：** 整体风险较低，约为 10%。这个比例主要来源于对外部词表文件的依赖，以及可能被滥用的扫描行为。脚本本身的代码看起来相对简单，没有明显的恶意代码。

**总结：**

CVE-2024-38475 是一个高危漏洞，但利用条件较为苛刻，需要服务器配置存在缺陷的 `mod_rewrite` 规则。提供的 PoC 代码并不能直接利用该漏洞，而是一个通用的网站扫描工具，用于查找可绕过访问限制的文件。该脚本存在一定的投毒风险，主要集中在使用未经严格审核的外部词表文件和滥用扫描行为的可能性上。

**项目地址:** [syaifulandy/CVE-2024-38475](https://github.com/syaifulandy/CVE-2024-38475)

**漏洞详情:** [CVE-2024-38475](https://nvd.nist.gov/vuln/detail/CVE-2024-38475)