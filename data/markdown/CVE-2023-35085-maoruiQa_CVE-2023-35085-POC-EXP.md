## CVE-2023-35085 - Ubiquiti UniFi 设备 SNMP 整数溢出远程代码执行

**漏洞编号:** CVE-2023-35085

**漏洞类型:** 整数溢出导致远程代码执行

**影响应用:** Ubiquiti UniFi Access Points/Switches

**危害等级:** 高危，可被未经授权的攻击者利用，实现远程代码执行

**影响版本:** <= 6.5.50 (UniFi Access Points), <= 6.5.32 (UniFi Switches, excluding Switch Flex Mini)

**利用条件:** 需要开启SNMP监控，并使用默认设置。设备需要存在漏洞版本。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2023-35085 存在于 Ubiquiti UniFi 接入点和交换机中，是一个整数溢出漏洞。该漏洞位于SNMP监控功能中，如果设备启用了SNMP监控，攻击者可能通过发送特制的SNMP请求触发整数溢出，导致缓冲区溢出，最终实现远程代码执行。

**有效性分析：**
提供的POC代码尝试利用此漏洞。代码首先尝试识别API端点，然后生成多种反向shell有效负载，并尝试通过不同的API端点（例如`/mifs/rest/api/v2/command/exec`, `/mifs/aad/api/v2/config/exec`, `/api/v2/system/shell`）执行命令。它还尝试通过修改User-Agent头注入日志，如果日志被脚本处理，也可能导致命令执行。POC还对payload进行了base64编码，试图绕过一些简单的过滤。

**投毒风险分析：**
该POC代码的主要功能是利用已知漏洞进行远程代码执行，风险较低。但仍然存在一定的投毒风险：
1.  **依赖风险：** 代码使用了requests库，如果作者修改了requirements.txt文件，并引导用户安装恶意依赖，可能导致投毒。
2.  **后门风险：** 作者可能在反向shell中加入隐藏的指令，例如在成功建立连接后，执行一些未授权的操作，但是经过审核，反向连接的shell命令未发现异常。
3.  **Payload修改：** 代码中可以修改payload，增加一些恶意操作，如删除文件、修改配置等。
综合分析，该POC存在一定的投毒风险，但是风险较低，预估投毒概率为10%。

**利用方式：**
1.  **目标确认：** 确认目标UniFi设备存在漏洞（版本低于或等于6.5.50 for Access Points，6.5.32 for Switches，不包括Switch Flex Mini），且开启了SNMP监控。
2.  **API端点识别：** POC代码尝试自动识别API端点，但如果识别失败，可能需要手动指定。
3.  **反向Shell Payload生成：** POC代码生成多种反向shell payload，攻击者可以根据目标环境选择合适的payload。
4.  **漏洞利用：** POC代码通过不同的API端点发送构造的请求，尝试执行反向shell payload。
5.  **反向连接：** 攻击者需要监听指定的IP地址和端口，等待目标设备反向连接，从而获得shell控制权。

**项目地址:** [maoruiQa/CVE-2023-35085-POC-EXP](https://github.com/maoruiQa/CVE-2023-35085-POC-EXP)

**漏洞详情:** [CVE-2023-35085](https://nvd.nist.gov/vuln/detail/CVE-2023-35085)