## CVE-2023-25157-GeoServer-SQL注入

**漏洞编号:** CVE-2023-25157

**漏洞类型:** SQL注入

**影响应用:** GeoServer

**危害等级:** 高危，可能导致数据泄露和远程代码执行

**影响版本:** < 2.21.4, >= 2.22.0, < 2.22.2

**利用条件:** 需要网络访问，目标GeoServer实例存在漏洞。

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

该漏洞是GeoServer中的SQL注入漏洞，源于对OGC Filter表达式语言和OGC Common Query Language (CQL) 的不当处理。攻击者可以通过构造恶意的CQL_FILTER参数，利用`strEndsWith`，`strStartsWith`和`PropertyIsLike`函数，或者`FeatureId`绕过防御，执行任意SQL查询。

**有效性：**
根据提供的漏洞库信息和搜索引擎结果，此漏洞影响特定版本的GeoServer，且有可用的PoC代码。PoC代码通过构造恶意的CQL_FILTER参数进行攻击，尝试注入SQL语句以获取数据库版本信息。提供的`dbFinder.py`脚本首先尝试连接到目标GeoServer实例，然后获取FeatureType名称，并使用精心构造的CQL_FILTER尝试执行SQL注入。PoC代码有效。

**投毒风险：**
分析提供的PoC代码，`dbFinder.py` 主要功能是检测目标是否存在漏洞，其核心在于构造恶意的CQL_FILTER，没有发现明显的恶意行为或后门代码。`README.md` 只是提供了漏洞说明和使用方法。投毒风险较低，但仍需注意，因为任何从互联网上获取的代码都存在潜在风险，建议在使用前进行代码审查。 此处的投毒风险主要考虑作者是否在代码中隐藏了其他恶意行为，例如上传敏感信息等。鉴于代码功能较为简单，且主要依赖于SQL注入，因此判断投毒可能性较低，为5%。

**利用方式：**
1.  攻击者首先需要确定目标GeoServer实例的版本是否在受影响范围内（< 2.21.4, >= 2.22.0, < 2.22.2）。
2.  利用提供的PoC脚本或者其他方式，构造包含恶意SQL语句的CQL_FILTER参数。
3.  将构造的CQL_FILTER参数附加到WFS GetFeature请求中，例如：
    `/geoserver/ows?service=wfs&version=1.0.0&request=GetFeature&typeName=<featureType>&CQL_FILTER=<恶意CQL_FILTER>`
4.  如果目标存在漏洞，恶意SQL语句将被执行，攻击者可以获取数据库中的敏感信息，甚至执行任意代码。

**缓解措施：**
*   升级GeoServer到不受影响的版本（>= 2.21.4 或 >= 2.22.2）。
*   如果无法升级，禁用PostGIS Datastore的*encode functions*设置，并启用*preparedStatements*设置。

**项目地址:** [dr-cable-tv/Geoserver-CVE-2023-25157](https://github.com/dr-cable-tv/Geoserver-CVE-2023-25157)

**漏洞详情:** [CVE-2023-25157](https://nvd.nist.gov/vuln/detail/CVE-2023-25157)