## CVE-2020-0688 Microsoft Exchange Server 远程代码执行漏洞

**漏洞编号:** CVE-2020-0688

**漏洞类型:** 远程代码执行

**影响应用:** Microsoft Exchange Server

**危害等级:** 高危，可能导致完全系统控制

**影响版本:** Microsoft Exchange Server 2010 SP3 UR30, 2013 CU23, 2016 CU14/CU15, 2019 CU3/CU4

**利用条件:** 需要Exchange服务器的访问权限，以及有效的Exchange用户凭据（可以通过窃取获得）。利用需要目标服务器未安装相应的安全补丁，且攻击者能够访问 ECP (Exchange Control Panel) 或 OWA (Outlook Web App)。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2020-0688 是一个 Microsoft Exchange Server 中的远程代码执行漏洞，源于 Exchange 在安装时未能正确创建唯一的密钥。攻击者可以利用此漏洞通过构造恶意的 ViewState 数据包，在服务器上执行任意代码。攻击通常涉及以下步骤：

1.  **获取 Exchange 服务器的验证密钥 (validationKey) 和解密密钥 (decryptionKey)**：这些密钥通常存储在 web.config 文件中。虽然不是 POC 的一部分，但是利用此漏洞需要获取这些密钥。
2.  **构造恶意的 ViewState**：利用提供的 PowerShell 脚本 `CVE-2020-0688.ps1`，结合 `NULL-File.xml` payload，可以生成恶意的 ViewState。脚本的核心在于通过 TextFormattingRunPropertiesMarshal 类进行反序列化操作，从而执行任意代码。
3.  **发送 ViewState**：将构造的 ViewState 作为参数发送到 Exchange 服务器的 ECP 或 OWA 页面。

**有效性评估：**

提供的 POC 代码有效。它利用了 ViewState 的不安全反序列化漏洞来执行任意代码。多个来源（包括 GitHub 和安全博客）都确认了此漏洞的存在和利用的有效性。

**投毒风险评估：**

尽管提供的 POC 脚本主要功能是生成 ViewState，看似无害，但是依然存在微小的投毒风险（10%）。`NULL-File.xml` 文件的目的是创建一个 `Ravin.aspx` 文件，文件内容为空。作者可能替换掉这个aspx文件内容，植入恶意代码,从而实现后门。此外，攻击者可以修改 PowerShell 脚本以包含额外的恶意操作，例如，下载并执行任意程序。不过，从表面上看，该脚本的主要功能是生成 ViewState，而真正的恶意代码需要在 ViewState 中构造。

**漏洞利用方式：**

1.  **攻击者需要具有Exchange用户的权限。**
2.  **获取validationKey和decryptionKey。** 这是成功利用漏洞的关键。
3.  **利用 PowerShell 脚本构造恶意的 ViewState。** 脚本 `CVE-2020-0688.ps1` 使用 `NULL-File.xml` 作为 payload 示例。 `NULL-File.xml` 的作用是尝试在 Exchange 服务器上创建一个空白的 ASPX 文件 (`Ravin.aspx`)。这本身可能不是恶意行为，但它为进一步的攻击打开了大门，攻击者可以上传包含恶意代码的 ASPX 文件，从而实现远程代码执行。
4.  **将构造的 ViewState 通过 HTTP 请求发送到 Exchange 服务器的 ECP 或 OWA 页面。**  目标页面通常是 `ecp/default.aspx` 或 `owa/auth/logon.aspx`。由于脚本中使用了 `/ecp` 和 `_aspx` 进行 Hash 计算，因此uri参数必须为ecp,否则无法成功。

如果服务器未打补丁，恶意 ViewState 将被反序列化，导致执行 `NULL-File.xml` 中定义的恶意操作，最终导致远程代码执行。

**项目地址:** [ravinacademy/CVE-2020-0688](https://github.com/ravinacademy/CVE-2020-0688)

**漏洞详情:** [CVE-2020-0688](https://nvd.nist.gov/vuln/detail/CVE-2020-0688)