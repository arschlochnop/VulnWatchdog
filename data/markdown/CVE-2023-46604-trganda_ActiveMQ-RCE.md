## CVE-2023-46604 - Apache ActiveMQ RCE

**漏洞编号:** CVE-2023-46604

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Apache ActiveMQ

**危害等级:** 高危，可导致服务器被完全控制

**影响版本:** < 5.18.3, < 5.17.6, < 5.16.7, < 5.15.16

**利用条件:** 需要网络访问ActiveMQ broker的OpenWire协议端口（默认为61616）

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2023-46604是一个Apache ActiveMQ中的远程代码执行漏洞。攻击者可以利用OpenWire协议中的反序列化漏洞，通过发送特制的恶意数据包，使ActiveMQ Broker或Client实例化classpath中的任意类，从而执行任意代码。

**有效性分析：**

根据提供的漏洞信息和利用代码，该POC有效。漏洞库信息和搜索引擎结果都表明这是一个已公开且被广泛利用的RCE漏洞。POC代码通过构造一个包含恶意Spring Bean定义的XML文件，并利用`ClassPathXmlApplicationContext`加载该文件，从而触发代码执行。提供的代码演示了如何利用`java.lang.ProcessBuilder`来执行系统命令（打开计算器）。

**投毒风险分析：**

代码本身未发现明显的恶意投毒行为。`ClassPathXmlApplicationContext`类被修改为继承`Throwable`，看起来是为了方便在`ExceptionResponse`中使用，属于漏洞利用的一部分，不是恶意投毒。 XML 文件的内容从 http server 加载，这部分是可以人为控制的，存在替换成恶意 XML 文件的风险，但是当前提供的代码仓库本身并无明显恶意行为。但是，也不能排除作者未来添加恶意代码的可能性，只是目前的代码相对干净。 投毒风险判断为 5%。

**漏洞利用方式：**

1.  攻击者创建一个包含恶意Bean定义的Spring XML文件，该Bean定义指定要执行的系统命令。
2.  攻击者搭建一个HTTP服务器，用于托管该XML文件。
3.  攻击者构造一个ActiveMQ OpenWire协议消息，其中包含一个`ExceptionResponse`对象，该对象的`exception`字段被设置为一个`ClassPathXmlApplicationContext`实例，该实例的构造函数参数指向攻击者托管的XML文件的URL。
4.  攻击者将该消息发送到ActiveMQ Broker。
5.  ActiveMQ Broker反序列化该消息，实例化`ClassPathXmlApplicationContext`，加载并解析XML文件，最终执行XML中定义的恶意Bean，导致RCE。

总体来说，该漏洞利用方式较为直接，依赖于Java反序列化漏洞和Spring Bean的实例化机制。由于ActiveMQ默认配置下OpenWire协议未做严格限制，攻击者可以未经身份验证地发送恶意消息，因此该漏洞的危害性极高。

**项目地址:** [trganda/ActiveMQ-RCE](https://github.com/trganda/ActiveMQ-RCE)

**漏洞详情:** [CVE-2023-46604](https://nvd.nist.gov/vuln/detail/CVE-2023-46604)