## CVE-2022-46169-Cacti-命令注入

**漏洞编号:** CVE-2022-46169

**漏洞类型:** 命令注入

**影响应用:** Cacti

**危害等级:** 高危，允许未授权的远程代码执行

**影响版本:** < 1.2.23

**利用条件:** 需要目标系统运行受影响版本的Cacti，并且存在具有`POLLER_ACTION_SCRIPT_PHP`操作的`poller_item`。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2022-46169是Cacti 1.2.23之前版本中的一个命令注入漏洞。攻击者可以通过构造`X-Forwarded-For`头绕过身份验证，然后利用`remote_agent.php`中的`polldata`操作注入恶意命令。该POC利用`X-Forwarded-For`头伪造客户端IP，绕过身份验证，然后通过`poller_id`参数向`proc_open`函数传递恶意payload，从而执行任意命令。POC尝试通过暴力破解`host_id`来找到一个可用的`poller_item`。代码中使用了`pexpect`来创建一个交互式的nc会话，以便接收反向shell。虽然使用了base64编码，但这是为了避免命令中的特殊字符导致问题，不是隐藏恶意代码，但是通过nc反弹shell存在被利用进行恶意操作的风险，因此存在一定的投毒风险，但是概率较低。整体而言，POC代码目的是为了验证漏洞存在，因此投毒概率较低，约为10%。

**漏洞利用方式：**

1.  **绕过认证：** 通过设置`X-Forwarded-For`头为Cacti服务器的IP地址，欺骗`get_client_addr`函数，绕过认证。
2.  **触发命令注入：**  向`remote_agent.php`发送包含`polldata` action的请求，并将恶意命令注入到`poller_id`参数中。  利用`proc_open`函数执行注入的命令。
3. **反弹shell:** 该poc通过反弹shell获得服务器控制权。

**项目地址:** [Safarchand/CVE-2022-46169](https://github.com/Safarchand/CVE-2022-46169)

**漏洞详情:** [CVE-2022-46169](https://nvd.nist.gov/vuln/detail/CVE-2022-46169)