## CVE-2024-4577-PHP-CGI参数注入

**漏洞编号:** CVE-2024-4577

**漏洞类型:** PHP-CGI参数注入/远程代码执行

**影响应用:** PHP (Windows)

**危害等级:** 严重，可能导致远程代码执行，信息泄露

**影响版本:** 8.1.* before 8.1.29, 8.2.* before 8.2.20, 8.3.* before 8.3.8

**利用条件:** Windows系统，运行在CGI模式下的PHP，并且系统启用了使用"Best Fit"策略的编码页。需要目标开启php-cgi服务。

**POC 可用性:** 是

**投毒风险:** 1%

## 详情

CVE-2024-4577 是一个存在于 Windows 版本的 PHP 中的严重漏洞，当 PHP 在 CGI 模式下运行时，可能会导致远程代码执行。该漏洞源于 Windows 的 "Best Fit" 编码转换行为，当系统设置为使用某些代码页时，Windows 可能会使用 "Best Fit" 行为来替换传递给 Win32 API 函数的命令行中的字符。 PHP CGI 模块可能会错误地将这些字符解释为 PHP 选项，从而允许恶意用户将选项传递给正在运行的 PHP 二进制文件，进而泄露脚本源代码或在服务器上运行任意 PHP 代码。

**漏洞利用方式：**

1.  **检测php-cgi服务是否存在:**  攻击者首先需要确定目标服务器是否运行在 Windows 上，并且使用了 CGI 模式的 PHP。可通过访问`/php-cgi/php-cgi.exe`来判断，如果返回500状态码，则可能存在漏洞。
2.  **编码绕过:** 由于Best-Fit转换的存在，某些字符会被替换，因此攻击者需要构造特殊的URL，利用这一特性，将恶意参数注入到PHP命令中。
3.  **参数注入:** 通过在 URL 中添加 `?%add+cgi.force_redirect%3dXCANWIN+%add+allow_url_include%3don+%add+auto_prepend_file%3dphp%3a//input` 这样的参数，可以强制 `cgi.force_redirect` 为任意值，开启 `allow_url_include` 选项，并且将 `auto_prepend_file` 设置为 `php://input`。`php://input` 允许攻击者通过 POST 请求的内容来执行 PHP 代码。
4.  **代码执行:**  攻击者通过 POST 请求发送恶意的 PHP 代码，例如 `<?php phpinfo();?>`，由于 `auto_prepend_file` 被设置为 `php://input`，这段代码会被 PHP 执行，从而实现远程代码执行。

**POC有效性：**

提供的 POC 代码看起来是有效的。它包含了以下关键步骤：

*   **连接性检查:**  `check_connectivity` 函数用于检测目标 URL 是否可访问。
*   **CGI 存在性检查:**  `check_cgi_exist` 函数检测 `/php-cgi/php-cgi.exe` 是否存在。
*   **PHP 版本获取:**  `get_phpversion` 函数尝试从响应头或响应内容中获取 PHP 版本。
*   **漏洞利用:**  `exploit` 函数通过构造包含恶意参数的 URL，并发送包含 PHP 代码的 POST 请求来利用漏洞。 通过判断`phpinfo()`的执行结果判断是否成功。

**投毒风险分析：**

代码主要功能为扫描和利用 CVE-2024-4577，本身功能较为直接。`requirements.txt` 只包含 `requests` 库，没有引入其他可疑的依赖项。因此投毒风险较低，判断投毒风险为1%。 主要风险在于使用者需要自行配置 `urls.txt`，如果该文件被恶意修改，可能会导致扫描错误的 URL。


**项目地址:** [ywChen-NTUST/PHP-CGI-RCE-Scanner](https://github.com/ywChen-NTUST/PHP-CGI-RCE-Scanner)

**漏洞详情:** [CVE-2024-4577](https://nvd.nist.gov/vuln/detail/CVE-2024-4577)