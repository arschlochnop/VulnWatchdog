## CVE-2021-34527 PrintNightmare

**漏洞编号:** CVE-2021-34527

**漏洞类型:** 远程代码执行

**影响应用:** Windows Print Spooler

**危害等级:** 高危，允许未经授权的用户通过Print Spooler服务远程执行代码，可能导致完全系统控制

**影响版本:** 受影响版本包括多个Windows版本，详见漏洞库信息

**利用条件:** 需要目标系统开启Print Spooler服务，且允许网络访问。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-34527，也被称为PrintNightmare，是一个Windows Print Spooler服务中的远程代码执行漏洞。攻击者可以利用此漏洞在目标系统上以SYSTEM权限执行任意代码。根据漏洞库信息和搜索结果，该漏洞影响多个Windows版本。提供的漏洞利用代码实际上是一个缓解脚本，用于禁用Print Spooler接受客户端连接，通过修改注册表键值`HKLM\Software\Policies\Microsoft\Windows NT\Printers\RegisterSpoolerRemoteRpcEndPoint`为2来禁用远程连接。利用方式通常涉及滥用`RpcAddPrinterDriverEx`函数加载恶意驱动程序，从而实现代码执行。缓解方法是安装Microsoft发布的补丁或使用提供的脚本禁用Print Spooler的远程连接。

**有效性:**
根据搜索结果，存在多个POC利用代码。该缓解脚本代码有效，但目的与攻击利用相反。 它只是通过修改注册表来禁用远程连接，从而降低风险，

**投毒风险:**
该脚本本身的功能是禁用远程连接，没有发现直接的投毒代码。但是，存在一定的投毒风险：
*   **依赖外部源:** 该脚本依赖于Windows自身的`reg`命令和`shutdown`命令。攻击者理论上可以通过替换系统命令，诱导用户运行恶意程序(可能性极低)。
*   **误导用户:** 攻击者可能修改脚本描述，诱导用户在不需要的情况下禁用打印服务，从而影响正常使用。
*   **未来修改:** 仓库作者或其他人可能在未来版本中添加恶意代码。
该脚本本身用于缓解漏洞，直接包含恶意代码可能性较低，但考虑到软件供应链的安全风险，仍然存在一定的投毒可能。

**利用方式：**
PrintNightmare漏洞的利用方式通常包含以下步骤：
1.  攻击者利用具有漏洞的`RpcAddPrinterDriverEx`函数。
2.  上传包含恶意代码的驱动程序文件。
3.  Print Spooler服务尝试加载该驱动程序。
4.  由于Print Spooler以SYSTEM权限运行，恶意代码也以SYSTEM权限执行。

**项目地址:** [rdboboia/disable-RegisterSpoolerRemoteRpcEndPoint](https://github.com/rdboboia/disable-RegisterSpoolerRemoteRpcEndPoint)

**漏洞详情:** [CVE-2021-34527](https://nvd.nist.gov/vuln/detail/CVE-2021-34527)