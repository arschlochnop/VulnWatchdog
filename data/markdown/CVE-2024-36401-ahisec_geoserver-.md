## CVE-2024-36401 - GeoServer RCE

**漏洞编号:** CVE-2024-36401

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** GeoServer

**危害等级:** 严重，未经身份验证的远程代码执行

**影响版本:** 2.22.x (< 2.22.6), 2.23.x (>= 2.23.0, < 2.23.6), 2.24.x (>= 2.24.0, < 2.24.4), 2.25.x (>= 2.25.0, < 2.25.2)

**利用条件:** 默认 GeoServer 安装，允许通过 WFS/WMS/WPS 接口进行网络访问

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2024-36401 允许未经身份验证的攻击者通过构造特制的OGC请求（例如 WFS GetFeature、WFS GetPropertyValue、WMS GetMap、WMS GetFeatureInfo 和 WPS Execute）来执行远程代码。漏洞根源在于 GeoServer 使用的 GeoTools 库不安全地将属性名称作为 XPath 表达式传递给 commons-jxpath 库，这使得攻击者可以在 XPath 表达式中注入恶意代码。提供的PoC代码展示了如何利用 `wfs:GetPropertyValue` 请求执行命令。它首先建议使用 `wfs:ListStoredQueries` 获取有效的 `wfs:ReturnFeatureType` 值，然后将其用于构建 `wfs:Query typeNames` 参数，以提高漏洞利用的准确性。示例payload包括了ping命令的执行和反弹shell的payload，以及内存马注入的payload。文章中提到的误判几率较高是因为直接使用 `sf:archsites` ，如果目标环境中不存在该feature type,则会报错。建议先获取可用的feature type名称。

**有效性：**
提供的PoC代码利用了漏洞描述中提到的攻击向量，并且参考了GitHub上的公开PoC（https://github.com/Mr-xn/CVE-2024-36401）。多个搜索结果表明该漏洞正在被积极利用（https://www.fortinet.com/blog/threat-research/threat-actors-exploit-geoserver-vulnerability-cve-2024-36401，https://www.sonicwall.com/blog/geoserver-rce-vulnerability-cve-2024-36401-being-exploited-in-the-wild），表明该漏洞的利用是有效的。

**投毒风险：**
在提供的PoC代码中，没有发现明显的投毒代码。代码主要提供了漏洞利用的思路和示例payload，包括执行ping命令、反弹shell和注入内存马。反弹shell和内存马需要用户提供恶意代码，因此不存在作者隐藏的后门代码。因此，投毒风险评估为0%。

**利用方式：**
1.  **确定目标 GeoServer 版本：** 确认目标 GeoServer 版本在受影响的范围内。
2.  **获取有效的Feature Type：** 使用 `wfs:ListStoredQueries` 请求获取有效的 `<wfs:ReturnFeatureType>`值。
3.  **构造恶意请求：** 构造包含恶意 XPath 表达式的 `wfs:GetPropertyValue` 请求，其中 `wfs:Query typeNames` 参数使用从步骤2中获得的Feature Type.
4.  **发送请求：** 将构造的恶意请求发送到目标 GeoServer 的 WFS 接口。
5.  **执行任意代码：** 成功利用漏洞后，攻击者可以在目标服务器上执行任意代码。

**项目地址:** [ahisec/geoserver-](https://github.com/ahisec/geoserver-)

**漏洞详情:** [CVE-2024-36401](https://nvd.nist.gov/vuln/detail/CVE-2024-36401)