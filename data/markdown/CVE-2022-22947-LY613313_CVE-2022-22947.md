## CVE-2022-22947 - Spring Cloud Gateway 代码注入

**漏洞编号:** CVE-2022-22947

**漏洞类型:** 代码注入

**影响应用:** Spring Cloud Gateway

**危害等级:** 高危，可能导致远程代码执行

**影响版本:** Spring cloud gateway versions 3.1.x prior to 3.1.1+, 3.0.x prior to 3.0.7+ and all old and unsupported versions

**利用条件:** Gateway Actuator endpoint 启用、暴露且未进行安全保护

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

该漏洞存在于Spring Cloud Gateway中，当Gateway Actuator endpoint 启用、暴露且未进行安全保护时，攻击者可以通过构造恶意请求，利用SpEL表达式注入，执行任意代码。利用方式是发送包含恶意SpEL表达式的POST请求到/actuator/gateway/routes端点，然后刷新路由，触发SpEL表达式的执行，从而实现远程代码执行。

**有效性评估：**
根据漏洞信息和POC代码，此POC代码是有效的。漏洞库信息明确指出该漏洞允许远程代码执行，搜索引擎结果也确认了这一点，并且提供了公开的漏洞利用代码。

**投毒风险评估：**
代码本身看起来是标准的漏洞利用代码，用于利用 CVE-2022-22947 漏洞。其中一个潜在的风险点在于 `commond` 变量，该变量从用户输入获取，然后拼接到 SpEL 表达式中。如果用户输入恶意或过长的命令，可能会导致目标系统崩溃或执行意外操作。但是，这不属于作者投毒的范畴。`base64cmd` 函数将用户输入的命令进行 Base64 编码，这本身并非恶意行为，但如果用户输入的命令本身就具有破坏性，Base64 编码只是对其进行了编码，并没有改变其本质。总体来看，该 POC 代码的投毒风险较低，约为 10%。主要的风险在于用户输入，而非代码本身。

**漏洞利用方式：**
1.  **条件判断：** 确定目标系统运行着受影响的 Spring Cloud Gateway 版本，并且 Gateway Actuator endpoint 处于启用、暴露且未进行安全保护的状态。
2.  **构造恶意请求：** 使用POST请求，构造包含恶意SpEL表达式的JSON数据，发送到`/actuator/gateway/routes`端点。SpEL表达式中包含要执行的系统命令。
3.  **刷新路由：** 发送POST请求到`/actuator/gateway/refresh`端点，刷新Gateway的路由配置，触发SpEL表达式的执行。
4.  **执行任意代码：** 恶意SpEL表达式被执行，从而在目标系统上执行任意代码，例如反弹shell。
5.  **清理：** 删除添加的路由，再次刷新路由。


**项目地址:** [LY613313/CVE-2022-22947](https://github.com/LY613313/CVE-2022-22947)

**漏洞详情:** [CVE-2022-22947](https://nvd.nist.gov/vuln/detail/CVE-2022-22947)