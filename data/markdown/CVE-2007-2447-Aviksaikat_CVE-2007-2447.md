## CVE-2007-2447-Samba-远程命令注入

**漏洞编号:** CVE-2007-2447

**漏洞类型:** 远程命令注入

**影响应用:** Samba

**危害等级:** 高危，可能导致远程代码执行

**影响版本:** 3.0.0 through 3.0.25rc3

**利用条件:** 目标Samba服务器运行在受影响版本，并且启用了 `username map script` 选项 (对于 SamrChangePassword 函数的利用) 或者攻击者拥有有效的Samba账户（对于其他MS-RPC函数的利用）。 需要能够访问目标服务器的445端口。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2007-2447 存在于Samba的smbd服务中，允许远程攻击者通过MS-RPC功能执行任意命令。漏洞主要有两个利用点:

1.  **SamrChangePassword函数 + `username map script`:** 当Samba配置文件 (smb.conf) 中启用了`username map script`选项时，未经身份验证的攻击者可以通过构造包含shell元字符的恶意用户名来触发命令注入。
2.  **其他MS-RPC函数 (远程打印和文件共享管理):** 经过身份验证的攻击者可以通过其他MS-RPC函数，利用shell元字符进行命令注入。

**漏洞利用方式：**

该漏洞利用代码 (`exploit-smb-3.0.20.py`) 主要针对第一种利用场景， 即 SamrChangePassword 函数和 `username map script` 。 攻击者通过以下步骤利用漏洞:

1.  **生成 Payload:**  使用`msfvenom`生成反向连接shell的payload (默认使用`cmd/unix/reverse_netcat`，但可以修改)。
2.  **构造恶意用户名:** 将生成的payload嵌入到用户名字符串中，利用shell元字符， 例如反引号 (`` ` ``)， 来执行payload。
3.  **建立SMB连接:** 使用pysmb库建立到目标SMB服务器的连接，使用构造的恶意用户名作为`userID`进行连接，密码可以随意设置。
4.  **触发漏洞:**  连接建立后，Samba服务器会尝试解析恶意用户名，并执行其中的payload，从而导致远程命令执行。

**有效性评估：**

根据漏洞库信息、搜索引擎结果和漏洞利用代码，该漏洞的POC代码在特定条件下是有效的。 漏洞利用的成功取决于以下因素:

*   目标Samba服务器运行在受影响的版本 (3.0.0 - 3.0.25rc3)。
*   Samba配置文件中启用了 `username map script` 选项 (或者攻击者拥有有效的Samba账户)。
*   目标服务器可以访问攻击者的监听端口 (反向连接shell)。

**投毒风险评估：**

该POC代码主要由以下几部分组成：参数解析、payload生成和SMB连接与漏洞触发。 投毒风险主要存在于以下几个方面：

*   **Payload生成:** 该脚本使用`msfvenom`生成payload。如果攻击者的机器上安装了被篡改的`msfvenom`，则生成的payload可能包含恶意代码。
*   **执行外部命令:** `getoutput`函数执行外部命令 `msfvenom`，存在一定的安全风险，比如命令注入。
*   **反向连接:** 该脚本使用反向连接shell，如果目标网络环境复杂，可能导致连接失败。

 评估投毒风险为10%, 主要原因是该脚本依赖于外部程序`msfvenom`，如果`msfvenom`本身被投毒，则可能导致生成的payload包含恶意代码。


**项目地址:** [Aviksaikat/CVE-2007-2447](https://github.com/Aviksaikat/CVE-2007-2447)

**漏洞详情:** [CVE-2007-2447](https://nvd.nist.gov/vuln/detail/CVE-2007-2447)