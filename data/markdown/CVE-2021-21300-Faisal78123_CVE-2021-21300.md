## CVE-2021-21300-Git-远程代码执行

**漏洞编号:** CVE-2021-21300

**漏洞类型:** 远程代码执行

**影响应用:** Git

**危害等级:** 高危，可能导致远程代码执行

**影响版本:** >= 2.14.2, < 2.17.6
>= 2.18.0, < 2.18.5
>= 2.19.0, < 2.19.6
>= 2.20.0, < 2.20.5
>= 2.21.0, < 2.21.4
>= 2.22.0, < 2.22.5
>= 2.23.0, < 2.23.4
>= 2.24.0, < 2.24.4
>= 2.25.0, < 2.25.5
>= 2.26.0, < 2.26.3
>= 2.27.0, < 2.27.1
>= 2.28.0, < 2.28.1
>= 2.29.0, < 2.29.3
>= 2.30.0, < 2.30.1

**利用条件:** 目标系统文件系统大小写不敏感（如NTFS, HFS+, APFS），且配置了clean/smudge filter（如Git LFS）。用户克隆恶意仓库。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-21300 是一个存在于 Git 中的远程代码执行漏洞。该漏洞源于 Git 客户端在大小写不敏感的文件系统上，处理包含符号链接和带有 clean/smudge 过滤器的文件（如 Git LFS）的恶意仓库时，可能执行恶意代码。

**有效性分析：**

提供的 POC 代码尝试利用此漏洞。`exploit.sh` 脚本创建一个包含恶意配置的 Git 仓库。它首先初始化一个 Git 仓库 `delayed-checkout`，然后创建一个 `.gitattributes` 文件，该文件将 `post-checkout` 过滤器应用于目录 `A`。脚本随后在 `A/post-checkout` 中创建一个可执行脚本，当检出 `A` 目录时会执行该脚本。脚本创建一个符号链接 `a`，指向 `.git/hooks`，并将 `a` 添加到版本控制中。当在大小写不敏感的文件系统上克隆此仓库时，Git 可能会错误地执行位于 `.git/hooks` 目录中的恶意 `post-checkout` 脚本。

根据漏洞描述以及POC的行为，可以判定POC的有效性高。

**投毒风险分析：**

POC 代码本身主要关注漏洞利用，旨在演示漏洞触发和利用的方式。其中 `A/post-checkout` 脚本仅仅执行 `echo PWNED >&2`。因此，漏洞利用代码本身不包含明显的投毒代码。但任何git仓库都有投毒的可能，如作者可以修改git配置项，让用户每次提交都触发恶意代码执行等。

基于代码分析，投毒风险较低，但无法完全排除，假设存在一些隐蔽性极高的投毒手法，给出一个较低的概率估计，比如10%。

**利用方式：**

1.  攻击者创建一个恶意的 Git 仓库，其中包含：
    *   一个 `.gitattributes` 文件，配置了 clean/smudge 过滤器（例如 Git LFS）和一个 `post-checkout` 钩子。
    *   一个符号链接，指向 `.git/hooks` 目录。
    *   一个 `post-checkout` 脚本，包含攻击者想要执行的恶意代码。
2.  攻击者将此恶意仓库托管在公共或私有 Git 服务器上。
3.  攻击者诱骗受害者克隆此恶意仓库到大小写不敏感的文件系统（例如 Windows 或 macOS）。
4.  当受害者克隆仓库时，Git 会执行 `post-checkout` 钩子中的恶意代码，导致远程代码执行。

**修复方案：**

*   升级 Git 到已修复版本（>= 2.30.1, 2.29.3, 2.28.1, 2.27.1, 2.26.3, 2.25.5, 2.24.4, 2.23.4, 2.22.5, 2.21.4, 2.20.5, 2.19.6, 2.18.5, 2.17.6）。
*   禁用 Git 中的符号链接支持 (`git config --global core.symlinks false`)。
*   避免克隆来自不受信任来源的仓库。

**项目地址:** [Faisal78123/CVE-2021-21300](https://github.com/Faisal78123/CVE-2021-21300)

**漏洞详情:** [CVE-2021-21300](https://nvd.nist.gov/vuln/detail/CVE-2021-21300)