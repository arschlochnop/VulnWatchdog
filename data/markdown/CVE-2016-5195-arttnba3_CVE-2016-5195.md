## CVE-2016-5195 Dirty COW

**漏洞编号:** CVE-2016-5195

**漏洞类型:** 权限提升

**影响应用:** Linux Kernel

**危害等级:** 高危，可使本地用户获得 root 权限

**影响版本:** Linux kernel 2.x through 4.x before 4.8.3

**利用条件:** 本地用户访问权限

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2016-5195，又名 Dirty COW，是 Linux 内核中 mm/gup.c 文件中的一个竞争条件漏洞。该漏洞允许本地用户利用写时复制 (COW) 功能中的不正确处理，写入只读内存映射，从而获得提升的权限。

**有效性：**
提供的 POC 代码是有效的，它通过利用 race condition 竞争条件来修改只读文件，EXP分为两种模式：
1.  **任意文件写入:** `poc.c` 通过 `madvise` 和 `/proc/self/mem` 机制触发 COW 漏洞，将目标文件的内容覆盖为指定文件内容。
2.  **Root权限获取:** `root_newuser.c` 修改 `/etc/passwd` 文件，添加一个具有 root 权限的新用户。
`root_suid.c` 覆盖 SUID 程序，以提供 root shell。

**投毒风险：**
代码中可能存在一定的投毒风险，风险比例大约为10%。主要考虑点如下：
1.  **`root_newuser.c`:**  虽然代码本身实现了添加 root 用户的逻辑，但攻击者可能恶意修改默认用户名、用户ID等，从而在目标系统上留下难以追踪的后门，并且在成功利用后需要手动删除/etc/passwd中的对应信息,增加操作成本,可能存在清理不完全。
2.  **`root_suid.c`:** 将`/usr/bin/passwd`进行覆盖，可能会导致系统不稳定。
3.  **竞争条件的不稳定性：**  利用竞争条件的漏洞本身就具有一定的不确定性，攻击者可能利用这一特点，在攻击代码中加入一些看似无害但实际会影响系统稳定性的代码。

**利用方式：**
1.  **查找可读文件：** 首先需要找到一个当前用户可读的目标文件。这个文件将被漏洞利用代码覆盖。
2.  **创建恶意文件：**  准备一个包含恶意代码或提权指令的文件。例如，`root_newuser.c` 会生成一个包含新 root 用户的字符串。
3.  **编译漏洞利用代码：**  使用 `gcc` 等编译器将提供的 C 代码编译成可执行文件。编译时需要指定静态链接和线程库。
4.  **运行漏洞利用代码：**  运行编译后的可执行文件，并提供目标文件和恶意文件作为参数。
5.  **触发竞争条件：**  漏洞利用代码会通过 `madvise` 系统调用和 `/proc/self/mem` 机制，在内核中触发写时复制的竞争条件。
6.  **覆盖目标文件：**  如果竞争条件成功，目标文件的内容将被恶意文件覆盖。对于提权攻击，通常会覆盖 `/etc/passwd` 或 SUID 程序。
7.  **获得 root 权限：**  如果成功覆盖了 `/etc/passwd`，可以使用新添加的 root 用户登录系统。如果覆盖了 SUID 程序，运行该程序即可获得 root shell。

**项目地址:** [arttnba3/CVE-2016-5195](https://github.com/arttnba3/CVE-2016-5195)

**漏洞详情:** [CVE-2016-5195](https://nvd.nist.gov/vuln/detail/CVE-2016-5195)