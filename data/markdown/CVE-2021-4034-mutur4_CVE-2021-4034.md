## CVE-2021-4034-Polkit-pkexec 本地提权

**漏洞编号:** CVE-2021-4034

**漏洞类型:** 本地提权

**影响应用:** Polkit

**危害等级:** 高危，可使低权限用户获得root权限

**影响版本:** 受影响版本 <= 0.105

**利用条件:** 本地用户可执行pkexec

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-4034 (PwnKit) 是 polkit 的 pkexec 工具中的一个本地提权漏洞。pkexec 是一个 setuid 工具，允许未经授权的用户根据预定义的策略以特权用户身份运行命令。漏洞原因是 pkexec 在处理调用参数计数时存在缺陷，导致尝试将环境变量作为命令执行。攻击者可以精心构造环境变量，诱导 pkexec 执行任意代码，从而获得 root 权限。

**利用方式：**

1.  **漏洞原理:** pkexec在没有正确处理参数的情况下，会尝试把环境变量当作命令执行，存在内存越界写入，从而getshell
2.  **POC 代码分析:**

    *   `Makefile`: 用于编译漏洞利用程序 `pwnkit.c`。 使用静态编译 `-static`，可以减少依赖，但会增加二进制文件的大小。
    *   `README.md`: 描述了漏洞和利用方法。
    *   `pwnkit.c`: 主要的漏洞利用代码，包含了利用漏洞的逻辑。

    *   `checkConditions` 函数：检查目标系统是否满足利用条件，例如 `gcc` 和 `pkexec` 是否存在，以及 pkexec 的版本是否在受影响的范围内（<=0.105）。
    *   `exploitVuln` 函数：包含利用漏洞的核心代码。 它创建特定的目录结构和文件，设置特殊的环境变量，并执行 `pkexec`。利用了 `GCONV_PATH` 环境变量来加载恶意共享库，从而实现提权。

3.  **利用过程：**

    *   创建 `GCONV_PATH=.` 和 `tmp` 目录。
    *   创建 `GCONV_PATH=./tmp` 文件。
    *   生成恶意的 gconv 模块 `tmp/gconv-modules`，包含 `module UTF-8// EXPLOIT// preload 2`
    *   编译包含提权代码的共享库 `tmp/preload.c`，该代码在初始化时调用 `setreuid(0, 0)` 和 `setregid(0, 0)`，然后执行 `/bin/sh`。
    *   设置环境变量 `CHARSET=EXPLOIT`，`SHELL=xxx` 和 `PATH=GCONV_PATH=.`。
    *   执行 `pkexec`，由于环境变量的设置，`pkexec` 会加载恶意的 gconv 模块，执行其中的提权代码，从而获得 root shell。

**有效性：**

提供的 POC 代码是有效的，可以成功利用 CVE-2021-4034 漏洞在目标系统上实现本地提权。

**投毒风险：**

代码中存在一定程度的投毒风险。虽然代码的主要目的是利用已知的漏洞，但可能存在以下情况：

*   **后门代码：** 虽然没有发现明显的后门代码，但恶意作者可能会在编译的共享库中添加额外的代码，例如植入持久性后门。
*   **依赖风险：**  此POC代码依赖于gcc和系统环境，如果系统环境被污染，会导致提权失败，或者执行其他恶意代码。
*   **潜在的破坏：**  利用过程可能不稳定，可能导致目标系统崩溃或数据损坏。

因此，在未进行充分审查的情况下，不建议直接在生产环境中使用此 POC 代码。


**项目地址:** [mutur4/CVE-2021-4034](https://github.com/mutur4/CVE-2021-4034)

**漏洞详情:** [CVE-2021-4034](https://nvd.nist.gov/vuln/detail/CVE-2021-4034)