## CVE-2024-6387 OpenSSH 竞争条件导致 RCE/DoS

**漏洞编号:** CVE-2024-6387

**漏洞类型:** 竞争条件

**影响应用:** OpenSSH

**危害等级:** 高危，可能导致远程代码执行和拒绝服务

**影响版本:** 8.5p1 <= OpenSSH <= 9.7p1

**利用条件:** 需要目标系统运行受影响版本的OpenSSH，且基于glibc的Linux系统。需要发起大量连接尝试触发竞争条件。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-6387 是 OpenSSH 服务中的一个竞争条件漏洞，源于 CVE-2006-5051 的回归。未经身份验证的远程攻击者可以通过在短时间内发起大量失败的身份验证尝试来触发此漏洞。利用此漏洞需要在glibc堆中插入指令，进而可能导致远程代码执行（RCE）或拒绝服务（DoS）。

**有效性：**
根据漏洞库信息和搜索引擎结果，该漏洞确实存在，并且有公开的PoC利用代码。该PoC通过建立大量的 SSH 连接并进行不成功的身份验证来触发竞争条件。参考[webpage 3]，此漏洞允许glibc Linux发行版在堆中插入指令，从而实现代码执行。提供的PoC代码尝试利用这一点，但成功率可能较低，因为竞争条件需要精确的时间控制。

**投毒风险：**
提供的PoC代码`/tmp/fe03af2a23123389ff9785e2fb119f2c/PoC.py` 包含了从文件中读取glibc地址的功能。 虽然代码本身没有明显的恶意行为，但如果提供的 `glibc_file` 包含恶意构造的地址，可能会导致非预期的行为，甚至导致拒绝服务。例如，如果`glibc_base`地址指向了关键系统函数，覆盖该地址可能造成系统崩溃。另一个潜在的风险点是 `timing_adjustment`，如果调整不当可能造成DoS。综上所述，投毒风险为10%。主要是考虑到作者可能在利用代码的 `glibc_file` 参数中提供恶意的 glibc 地址，诱导用户使用，从而达到破坏目标系统的目的。

**利用方式：**
1.  **建立连接：** 攻击者首先建立与目标 OpenSSH 服务器的 TCP 连接。
2.  **SSH 握手：** 攻击者执行 SSH 握手过程，例如发送 SSH 版本字符串。
3.  **堆准备：** PoC尝试在堆上分配一些数据，为利用竞争条件做准备。
4.  **触发竞争条件：**  通过快速发送大量失败的身份验证请求，攻击者试图触发 `sshd` 进程中的竞争条件。这涉及利用 `LoginGraceTime` 参数，该参数允许攻击者在身份验证超时之前发送多个请求。根据[webpage 6]，利用此漏洞需要大量连接尝试才能准确触发竞争条件。
5.  **代码执行：**  如果竞争条件被成功触发，攻击者可以在内存中写入恶意代码，从而实现远程代码执行。提供的 PoC 代码尝试通过覆盖 glibc 的地址来实现这一点。如果成功利用，攻击者可以获得 root 权限，如[webpage 1][webpage 4]所描述。
6.  **拒绝服务：** 即使未能成功实现 RCE，攻击者也可能通过耗尽服务器资源来实现拒绝服务。由于竞争条件涉及信号处理，不正确的信号处理可能导致 `sshd` 崩溃。

**项目地址:** [AzrDll/CVE-2024-6387](https://github.com/AzrDll/CVE-2024-6387)

**漏洞详情:** [CVE-2024-6387](https://nvd.nist.gov/vuln/detail/CVE-2024-6387)