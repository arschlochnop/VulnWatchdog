## CVE-2022-22947-Spring Cloud Gateway-代码注入

**漏洞编号:** CVE-2022-22947

**漏洞类型:** 代码注入

**影响应用:** Spring Cloud Gateway

**危害等级:** 高危，可能导致远程代码执行

**影响版本:** Spring cloud gateway versions 3.1.x prior to 3.1.1+, 3.0.x prior to 3.0.7+ and all old and unsupported versions

**利用条件:** Gateway Actuator endpoint is enabled, exposed and unsecured

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2022-22947 是 Spring Cloud Gateway 中的一个代码注入漏洞。当 Gateway Actuator 端点启用、公开且未受保护时，远程攻击者可以发送恶意构造的请求，从而在远程主机上执行任意代码。

**利用方式：**

1.  **漏洞触发：** 攻击者通过向目标 Spring Cloud Gateway 的 `/actuator/gateway/routes` 端点发送 POST 请求，创建一个恶意的路由配置。该配置包含一个 SpEL 表达式，该表达式会被执行。
2.  **表达式注入：**  `AddResponseHeader` 过滤器被用于将命令执行的结果添加到响应头中。SpEL 表达式 `#{new String(T(org.springframework.util.StreamUtils).copyToByteArray(T(java.lang.Runtime).getRuntime().exec(new String[]{\"id\"}).getInputStream()))}`  用于执行 `id` 命令，并将结果转换为字符串。
3.  **命令执行：**  `T(java.lang.Runtime).getRuntime().exec(new String[]{\"id\"})` 部分会执行系统命令（在这个例子中是 `id` 命令）。
4.  **刷新路由：** 攻击者通过向 `/actuator/gateway/refresh` 端点发送 POST 请求来刷新 Gateway 的路由，使得新创建的恶意路由生效。
5.  **获取执行结果：** 攻击者通过GET `/actuator/gateway/routes/hacktest` 获取执行结果,通过响应头中的`Result`字段获取。
6.  **清理：** 利用完成后，攻击者删除创建的恶意路由并再次刷新路由, 避免残留。

**有效性：**

根据漏洞库信息、搜索引擎结果以及提供的 POC 代码，该漏洞利用是有效的。POC 代码通过创建恶意的路由配置并刷新路由来执行任意代码。

**投毒风险：**

该 POC 代码主要用于验证漏洞，没有发现作者有意添加的投毒代码。 代码意图清晰，主要是为了创建、刷新、删除路由，并执行`id`命令来验证漏洞的存在。虽然利用本身会造成安全风险，但代码本身没有隐藏的恶意功能，因此投毒风险较低。


**项目地址:** [stayfoolish777/CVE-2022-22947-POC](https://github.com/stayfoolish777/CVE-2022-22947-POC)

**漏洞详情:** [CVE-2022-22947](https://nvd.nist.gov/vuln/detail/CVE-2022-22947)