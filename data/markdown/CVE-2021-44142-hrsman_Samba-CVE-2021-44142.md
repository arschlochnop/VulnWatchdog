## CVE-2021-44142-Samba-vfs_fruit模块堆溢出

**漏洞编号:** CVE-2021-44142

**漏洞类型:** 堆溢出

**影响应用:** Samba

**危害等级:** 高危，允许远程代码执行

**影响版本:** < 4.13.17, < 4.14.12, < 4.15.5

**利用条件:** 需要启用vfs_fruit模块，且攻击者需要对共享目录具有写入扩展属性的权限。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-44142是Samba vfs_fruit模块中的一个堆溢出漏洞。该模块用于提供与Apple SMB客户端的增强兼容性和与Netatalk 3 AFP文件服务器的互操作性。

**有效性：**
提供的PoC代码看起来是有效的。它包含一个用于检查Samba服务器是否存在CVE-2021-44142漏洞的Python脚本（check_vulnerable.py），以及辅助文件（apple.py，LICENSE，README.md）。脚本通过SMB协议连接到目标服务器，并利用漏洞读取堆cookie和链表指针。脚本明确说明了如果服务器配置了Western Digital定制的Samba补丁，则需要模拟来自OSX的连接。

**投毒风险：**
代码本身看起来比较简单，主要功能是验证漏洞的存在，而不是执行恶意操作。检查了LICENSE(MIT协议)和README.md，未发现明显恶意代码的迹象。但仍存在小概率(10%)的投毒风险，例如：
*   代码可能存在细微的错误，导致目标系统崩溃或不稳定。
*   利用该漏洞进行进一步攻击可能需要结合其他恶意代码。
*   代码可能收集用户信息并上传到恶意服务器（尽管目前的代码未发现此行为）。

**利用方式：**
1.  **配置vfs_fruit模块：** Samba服务器必须配置并启用vfs_fruit模块。
2.  **写入扩展属性：** 攻击者需要对共享目录具有写入扩展属性（EA, xattr）的权限。
3.  **发送特制请求：** 攻击者通过SMB协议发送特制请求，写入恶意的扩展文件属性。这些恶意属性会触发vfs_fruit模块中的堆溢出漏洞。
4.  **远程代码执行：** 成功利用该漏洞后，攻击者可以smbd的权限（通常是root权限）执行任意代码。

**总结：**
此漏洞利用过程依赖于`vfs_fruit`模块，该模块在Samba服务器中处理与Apple文件共享相关的扩展属性。通过精心构造的扩展属性，攻击者可以触发堆溢出，从而控制服务器的执行流程。由于该漏洞允许以root权限执行任意代码，因此风险非常高。

**项目地址:** [hrsman/Samba-CVE-2021-44142](https://github.com/hrsman/Samba-CVE-2021-44142)

**漏洞详情:** [CVE-2021-44142](https://nvd.nist.gov/vuln/detail/CVE-2021-44142)