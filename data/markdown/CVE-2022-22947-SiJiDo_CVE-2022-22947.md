## CVE-2022-22947-Spring Cloud Gateway-代码注入

**漏洞编号:** CVE-2022-22947

**漏洞类型:** 代码注入

**影响应用:** Spring Cloud Gateway

**危害等级:** 高危，允许远程代码执行

**影响版本:** 3.1.x (prior to 3.1.1+), 3.0.x (prior to 3.0.7+), and unsupported versions

**利用条件:** Gateway Actuator endpoint enabled, exposed, and unsecured

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2022-22947 是一个 Spring Cloud Gateway 的代码注入漏洞。攻击者可以在 Gateway Actuator 端点开启且未进行安全保护的情况下，通过构造恶意请求执行任意代码。漏洞利用方式如下：

1.  **漏洞原理：** 该漏洞源于 Spring Cloud Gateway 中 SpEL 表达式的执行，攻击者可以通过 SpEL 表达式注入恶意代码，进而执行任意命令。
2.  **利用条件：**
    *   目标系统使用存在漏洞的 Spring Cloud Gateway 版本。
    *   Gateway Actuator 端点被启用。
    *   Gateway Actuator 端点对外暴露且未进行任何身份验证。
3.  **漏洞利用代码分析：** 提供的Python脚本 (exp.py)首先定义了一个`GMem`类，将编译后的java字节码进行base64解码后赋值给`classbytes`。该Java类主要功能：
    *   通过反射机制定义类 (`ReflectUtils.defineClass`)
    *   执行命令
    *   进行base64编码/解码等操作。
    *   创建了一个包含payload的HashMap，payload被精心构造用于在目标服务器上执行命令。
    脚本通过修改`RequestMappingInfo`的`Builder`并调用`build()`方法触发漏洞，最终导致RCE。
4.  **有效性评估：** 根据漏洞信息和利用代码，该漏洞利用的有效性较高。CISA 将其添加到已知被利用的漏洞目录中，表明该漏洞在野外已被积极利用。
5.  **投毒风险评估：** 代码存在一定的投毒风险。虽然脚本主要功能是利用漏洞，但其中嵌入的Java类和SpEL表达式可能包含其他未知的恶意行为。该脚本通过Base64编码隐藏了部分代码，增加了分析难度。该脚本存在投毒风险的可能性为10%, 主要是由于代码混淆和潜在的Java恶意行为。
6.  **利用方式总结：**
    *   攻击者发送恶意构造的 HTTP 请求到 Gateway Actuator 端点。
    *   请求中包含 SpEL 表达式，用于执行任意代码。
    *   Spring Cloud Gateway 在处理请求时，由于没有对 SpEL 表达式进行充分的验证和过滤，导致代码注入。
    *   攻击者通过代码注入执行恶意命令，例如反弹 shell 或执行其他恶意操作。

综上所述，CVE-2022-22947 是一个严重的安全漏洞，攻击者可以利用它在目标系统上执行任意代码，因此需要及时修复。

**项目地址:** [SiJiDo/CVE-2022-22947](https://github.com/SiJiDo/CVE-2022-22947)

**漏洞详情:** [CVE-2022-22947](https://nvd.nist.gov/vuln/detail/CVE-2022-22947)