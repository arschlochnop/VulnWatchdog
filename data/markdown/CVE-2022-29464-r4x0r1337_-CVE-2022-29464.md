## CVE-2022-29464 - WSO2 Unrestricted File Upload

**漏洞编号:** CVE-2022-29464

**漏洞类型:** 任意文件上传导致远程代码执行

**影响应用:** WSO2 API Manager, Identity Server, Enterprise Integrator, Open Banking AM/KM

**危害等级:** 高危，可能导致服务器完全控制

**影响版本:** WSO2 API Manager 2.2.0 to 4.0.0, WSO2 Identity Server 5.2.0 to 5.11.0, WSO2 Identity Server Analytics 5.4.0, 5.4.1, 5.5.0 and 5.6.0, WSO2 Identity Server as Key Manager 5.3.0 to 5.11.0, WSO2 Enterprise Integrator 6.2.0 to 6.6.0, WSO2 Open Banking AM 1.4.0 to 2.0.0 and WSO2 Open Banking KM 1.4.0 to 2.0.0

**利用条件:** 需要目标服务器存在/fileupload端点且未进行严格的文件类型和路径校验

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2022-29464是一个存在于多个WSO2产品中的严重漏洞，允许未经授权的攻击者上传任意文件，并最终导致远程代码执行。根据漏洞描述和搜索结果，攻击者可以通过`/fileupload`端点，利用`Content-Disposition`头中的目录遍历序列，将恶意文件上传到Web根目录下的可执行位置，例如`../../../../repository/deployment/server/webapps`目录。  

提供的POC代码包含两个python脚本：`deface.py` 和 `shell.py`。 `shell.py`会上传一个包含命令执行功能的jsp文件，`deface.py`上传任意文件。  

**有效性：**  根据漏洞描述和POC代码，该漏洞的利用方式是有效的。POC代码通过构造包含目录遍历的请求，将恶意JSP文件上传到服务器的webapps目录下，从而实现远程代码执行。脚本使用了requests库发送POST请求，并禁用SSL验证，绕过证书校验。

**投毒风险：** 提供的代码较为简洁，主要功能是利用漏洞上传恶意文件。 虽然存在使用`requests.post(f'{host}/fileupload/toolsAny', files=files, verify=False)`语句, 禁用SSL证书验证，但这是为了POC的通用性，方便在各种环境下测试，不一定是投毒行为。由于没有发现明显的恶意代码或后门，因此投毒风险较低，评估为5%。

**利用方式：**
1.  攻击者利用`fileupload`端点。
2.  在POST请求的`Content-Disposition`头中构造目录遍历序列（例如`../../../../`）。
3.  将恶意JSP文件（或其他服务器支持的脚本文件）上传到`repository/deployment/server/webapps`目录或其他Web根目录下的可执行位置。
4.  通过Web浏览器访问上传的JSP文件，执行任意命令。

**项目地址:** [r4x0r1337/-CVE-2022-29464](https://github.com/r4x0r1337/-CVE-2022-29464)

**漏洞详情:** [CVE-2022-29464](https://nvd.nist.gov/vuln/detail/CVE-2022-29464)