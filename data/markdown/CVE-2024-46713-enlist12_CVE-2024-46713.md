## CVE-2024-46713-Linux kernel perf/aux 竞争条件UAF

**漏洞编号:** CVE-2024-46713

**漏洞类型:** Use-After-Free (UAF)

**影响应用:** Linux Kernel

**危害等级:** 高危，可能导致权限提升或任意代码执行

**影响版本:** Linux kernel versions prior to versions containing the fix commits.

**利用条件:** 需要一定的perf事件操作权限，依赖于硬件环境或修改内核启用软件事件AUX buffer

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-46713 漏洞是 Linux 内核 perf/aux 组件中的一个竞争条件导致的 UAF (Use-After-Free) 漏洞。漏洞源于对AUX buffer的序列化不足。攻击者可以利用此漏洞在perf事件处理中触发UAF，导致内核内存破坏，进而可能实现权限提升或任意代码执行。

**有效性：**
根据提供的漏洞利用代码和描述，该PoC利用了perf事件中的竞争条件，成功利用需要满足特定的条件：
*   **内核版本：**影响的内核版本需要是未修复的版本。
*   **环境依赖：**该漏洞原本只在真实硬件上可利用，因为软件PMU通常不支持AUX buffers。但是，PoC提到可以通过修改内核来启用软件事件的AUX buffers，从而在虚拟机中进行测试。
*   **缓解措施：**PoC也指出，由于主要的发行版缓解了PoC中使用的页面损坏技术，直接在生产环境运行可能会导致系统崩溃或`bad page`错误。

**投毒风险：**
评估PoC代码是否存在投毒风险，需要关注以下几个方面：
*   **代码逻辑：**`exploit.c`包含了利用该漏洞的完整逻辑，如perf事件配置、内存操作和提权等，暂未发现明显的恶意代码。
*   **外部依赖：**该PoC依赖于`perf.c`， `race_util.c`，`stage1.c`， `stage2.c`，`stage3.c`，`util.c`这些文件，需要进一步审计以确认是否存在隐藏后门。
*   **编译过程：**`build.sh`使用`gcc`编译PoC代码，并使用`cpio`创建`rootfs.cpio`，检查编译选项中是否存在恶意注入。
*   **启动脚本：**`start.sh`使用`qemu-system-x86_64`启动虚拟机，加载内核和initrd，检查是否存在恶意参数。
综合分析，PoC代码本身未发现明显投毒代码，但由于其复杂性，存在一定的隐藏恶意代码的可能性。考虑到其利用难度和依赖条件，以及作者已经声明该PoC可能导致系统崩溃，**投毒风险估计为10%**。

**利用方式：**
1.  **环境准备：** 准备一个受影响的内核版本，或者修改内核源码以启用软件事件的AUX buffers。
2.  **编译PoC：** 使用`build.sh`编译PoC代码，生成可执行文件`exp`和`rootfs.cpio`。
3.  **运行PoC：** 使用`start.sh`启动虚拟机，并将`exp`复制到虚拟机中。
4.  **触发漏洞：** 在虚拟机中运行`exp`，PoC会利用perf事件竞争条件触发UAF漏洞。
5.  **提权：** 成功触发漏洞后，PoC会尝试利用UAF漏洞进行提权，获取root shell。

**项目地址:** [enlist12/CVE-2024-46713](https://github.com/enlist12/CVE-2024-46713)

**漏洞详情:** [CVE-2024-46713](https://nvd.nist.gov/vuln/detail/CVE-2024-46713)