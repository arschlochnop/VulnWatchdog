## CVE-2021-3156 - Sudo Baron Samedit Heap-Based Buffer Overflow

**漏洞编号:** CVE-2021-3156

**漏洞类型:** Heap-Based Buffer Overflow

**影响应用:** Sudo

**危害等级:** 高危，本地权限提升至root

**影响版本:** < 1.9.5p2

**利用条件:** 本地用户可执行sudo

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-3156，又名Baron Samedit，是一个存在于Sudo 1.9.5p2之前的版本中的堆缓冲区溢出漏洞。此漏洞允许本地用户通过`sudoedit -s`和一个以单个反斜杠字符结尾的命令行参数来提升权限至root。

**漏洞利用分析：**

1.  **有效性：** 提供的PoC代码看起来是有效的。`hax.c`文件包含了利用漏洞所需的参数构造，包括特制的`s_argv`和`s_envp`，利用`execve`函数执行`sudoedit`命令。`lib.c`包含了在成功利用漏洞后执行的payload，即提权到root并执行`/bin/sh`。
2.  **投毒风险：** 
    * Makefile：该文件用于编译PoC。没有发现明显的恶意行为。
    * README.md：该文件仅包含漏洞名称，没有恶意代码。
    * hax.c：此文件是漏洞利用的主要入口点。虽然它的目的是利用漏洞，但其本身不包含任何后门或恶意代码。它只是构造特定的参数传递给`sudoedit`。
    * lib.c：此文件是一个共享库，它在被加载时执行提权操作并启动一个shell。这里需要注意，如果该共享库被替换成包含恶意代码的版本，可能会造成投毒。但是，就目前提供的代码而言，它只是执行了预期的提权操作。代码中虽然没有明显的恶意代码，但是依然存在投毒的可能，因此风险存在。该利用本身就是一种提权行为，所以很难直接判断是否是投毒行为。不过 `lib.c` 编译成动态链接库，可以被替换，存在一定风险。
    * 总体评估：PoC代码本身主要是利用漏洞，但存在被替换成恶意版本的风险，因此存在一定的投毒风险。
3.  **利用方式：**
    *   编译：首先，使用`make`命令编译提供的代码，生成`sudo-hax-me-a-sandwich`可执行文件和`libnss_X/P0P_SH3LLZ_ .so.2`动态链接库。
    *   执行：运行编译后的`sudo-hax-me-a-sandwich`可执行文件。该程序会使用精心构造的参数和环境变量调用`sudoedit`命令，触发堆缓冲区溢出漏洞。
    *   提权：如果漏洞利用成功，`libnss_X/P0P_SH3LLZ_ .so.2`动态链接库将被加载，其中定义的`_init`函数会被执行，从而将当前用户的权限提升到root，并启动一个root shell。

**总结：**
该PoC代码有效，旨在利用CVE-2021-3156漏洞将本地用户的权限提升到root。 虽然代码本身不包含明显的后门，但是`lib.c`动态链接库存在替换风险，存在潜在的投毒风险。

**项目地址:** [Superliverbun/cve-2021-3156-](https://github.com/Superliverbun/cve-2021-3156-)

**漏洞详情:** [CVE-2021-3156](https://nvd.nist.gov/vuln/detail/CVE-2021-3156)