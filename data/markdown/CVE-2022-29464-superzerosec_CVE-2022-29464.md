## CVE-2022-29464 - WSO2 任意文件上传导致远程代码执行

**漏洞编号:** CVE-2022-29464

**漏洞类型:** 任意文件上传/远程代码执行

**影响应用:** WSO2 API Manager, Identity Server, Enterprise Integrator, Open Banking AM/KM

**危害等级:** 高危，可能导致服务器被完全控制

**影响版本:** WSO2 API Manager 2.2.0 up to 4.0.0, WSO2 Identity Server 5.2.0 up to 5.11.0, WSO2 Identity Server Analytics 5.4.0, 5.4.1, 5.5.0 and 5.6.0, WSO2 Identity Server as Key Manager 5.3.0 up to 5.11.0, WSO2 Enterprise Integrator 6.2.0 up to 6.6.0, WSO2 Open Banking AM 1.4.0 up to 2.0.0 and WSO2 Open Banking KM 1.4.0, up to 2.0.0.

**利用条件:** 目标服务器存在/fileupload端点，且未进行适当的文件上传限制。

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2022-29464 是一个存在于多个 WSO2 产品中的严重漏洞，它允许未经授权的攻击者上传任意文件，从而导致远程代码执行。该漏洞的核心在于 `/fileupload` 端点缺乏适当的验证机制，攻击者可以通过构造包含目录遍历序列（如 `../../../../`）的 `Content-Disposition` 头来将恶意文件上传到 Web 根目录下的任意位置，例如 `repository/deployment/server/webapps` 目录。 

**利用方式：**

1.  **发送恶意文件上传请求：** 攻击者构造一个包含恶意 JSP webshell 的 HTTP POST 请求，该请求的目标是 `/fileupload` 端点。在请求头中，`Content-Disposition` 字段被设置为包含目录遍历序列，以便将文件上传到 `repository/deployment/server/webapps/authenticationendpoint` 目录下。
2.  **绕过文件类型限制（如果存在）：** 某些 WSO2 产品可能存在文件类型验证，但通常可以通过修改文件名或 Content-Type 头来绕过这些限制。
3.  **访问上传的 Webshell：** 成功上传 Webshell 后，攻击者可以通过 Web 浏览器访问该 Webshell，从而在服务器上执行任意命令。

**有效性评估：**

提供的 POC 代码是有效的。代码首先定义了一个 JSP webshell，然后构造一个 HTTP POST 请求，利用目录遍历漏洞将该 webshell 上传到目标服务器的 `authenticationendpoint` 目录下。最后，攻击者可以通过访问上传的 webshell 来执行命令。

**投毒风险评估：**

经过分析，提供的 POC 代码本身**没有明显的投毒代码**。webshell 的内容是直接嵌入在脚本中的，功能是执行用户通过 HTTP 请求传递的命令。风险评估为0%。


**项目地址:** [superzerosec/CVE-2022-29464](https://github.com/superzerosec/CVE-2022-29464)

**漏洞详情:** [CVE-2022-29464](https://nvd.nist.gov/vuln/detail/CVE-2022-29464)