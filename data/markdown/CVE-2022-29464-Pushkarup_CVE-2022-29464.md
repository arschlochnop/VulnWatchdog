## CVE-2022-29464 - WSO2 Unrestricted File Upload RCE

**漏洞编号:** CVE-2022-29464

**漏洞类型:** 任意文件上传导致远程代码执行

**影响应用:** WSO2 API Manager, Identity Server, Enterprise Integrator, Open Banking AM/KM

**危害等级:** 高危，可导致服务器完全控制

**影响版本:** WSO2 API Manager 2.2.0 up to 4.0.0, WSO2 Identity Server 5.2.0 up to 5.11.0, WSO2 Identity Server Analytics 5.4.0, 5.4.1, 5.5.0 and 5.6.0, WSO2 Identity Server as Key Manager 5.3.0 up to 5.11.0, WSO2 Enterprise Integrator 6.2.0 up to 6.6.0, WSO2 Open Banking AM 1.4.0 up to 2.0.0 and WSO2 Open Banking KM 1.4.0, up to 2.0.0.

**利用条件:** 目标系统存在/fileupload接口且未进行严格的文件类型和路径校验。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2022-29464是一个存在于多个WSO2产品中的关键漏洞，它允许未经授权的攻击者上传任意文件，从而导致远程代码执行（RCE）。

**漏洞利用方式：**

1.  攻击者通过`/fileupload`端点上传恶意文件，通常是包含恶意代码的JSP webshell。
2.  攻击者利用`Content-Disposition`头中的目录遍历序列（例如`../../../../`）绕过文件上传限制，将webshell上传到Web根目录下的可执行目录，例如`repository/deployment/server/webapps`。
3.  一旦webshell上传成功，攻击者可以通过访问该webshell的URL来执行任意代码。

**有效性评估：**

*   根据漏洞信息、搜索引擎结果和提供的POC代码，此漏洞的利用是有效的。 搜索引擎结果显示，该漏洞已被积极利用（例如TrendMicro报告）。 提供的POC代码（`wso.py` 脚本）旨在自动化利用过程，包括上传webshell并执行命令。

**投毒风险评估：**

该漏洞利用代码主要包含以下几个文件:

*   `LICENSE`：MIT许可证声明，表明代码是开源的，并允许修改和分发。
*   `README.md`：包含漏洞描述、免责声明、利用说明、webshell功能介绍、安装步骤、使用方法、贡献方式、许可协议和联系方式等信息。免责声明明确表示该POC仅用于教育目的，禁止用于非法活动。
*   `wso.py`：此Python脚本包含漏洞利用的核心代码，用于扫描目标站点是否存在漏洞、上传webshell、执行命令等操作。
*   `requirements.txt`：列出了脚本运行所需的Python依赖包，包括requests、colorama和urllib3。

考虑到代码的结构和功能，投毒的潜在风险较低，但仍然存在以下可能性：

1.  **Webshell后门植入**: `wso.py`脚本可能包含额外的后门或恶意代码，虽然webshell本身就是后门，但可能隐藏更深层的控制机制。
2.  **依赖包投毒**: 虽然 `requirements.txt` 文件中的依赖包看起来是标准的，但攻击者可能会使用拼写相似的恶意包来替换它们（例如，将`requests`替换为`requ3sts`）。
3.  **信息收集**: 脚本可能会暗中收集目标系统的信息，并将这些信息发送给攻击者。
4.  **资源消耗**: 脚本可能设计为消耗目标系统的资源，例如CPU或内存，从而导致拒绝服务。

鉴于以上分析，我估计该POC代码存在10%的投毒风险。 这个比例基于以下因素：

*   该POC的主要功能是利用已知的漏洞，目的是方便用户进行测试和验证。
*   POC的作者声明仅用于教育目的。
*   代码开源，方便其他人审查。
*   潜在的风险因素（如webshell后门、依赖包投毒、信息收集和资源消耗）依然存在，需要保持警惕。

**安全建议：**

*   在运行此POC之前，务必在一个隔离的环境中进行。
*   仔细审查代码，特别注意webshell和依赖包。
*   使用网络监控工具来检测任何异常的网络活动。


**项目地址:** [Pushkarup/CVE-2022-29464](https://github.com/Pushkarup/CVE-2022-29464)

**漏洞详情:** [CVE-2022-29464](https://nvd.nist.gov/vuln/detail/CVE-2022-29464)