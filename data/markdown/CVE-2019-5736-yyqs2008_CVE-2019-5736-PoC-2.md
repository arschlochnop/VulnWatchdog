## CVE-2019-5736-runc容器逃逸

**漏洞编号:** CVE-2019-5736

**漏洞类型:** 容器逃逸

**影响应用:** runc/Docker

**危害等级:** 高危，允许容器逃逸并获得宿主机root权限

**影响版本:** <= 1.0-rc6 (runc), Docker < 18.09.2

**利用条件:** 需要能够以root权限在受影响的容器内执行代码，或者能够控制容器镜像。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2019-5736漏洞允许攻击者通过操纵`/proc/self/exe`文件描述符，覆盖宿主机上的runc二进制文件。成功利用后，当宿主机再次运行容器时，会执行被覆盖的runc二进制文件，从而允许攻击者在宿主机上执行任意代码，获得root权限。

**漏洞利用分析：**
1.  **Dockerfile:**  定义了一个包含漏洞利用程序的Docker镜像。它基于Ubuntu 18.04，安装了必要的编译工具，并将漏洞利用代码（`exploit.c`，`payload.c`，`start.sh`）添加到镜像中。
2.  **Makefile:**  用于编译`exploit.c`和`payload.c`，生成可执行文件。
3.  **exploit.c:** 漏洞利用的核心代码。它尝试打开目标runc二进制文件（通过`/proc/*/exe`找到），然后使用恶意payload覆盖该文件。
4.  **payload.c:**  定义了攻击载荷。该payload创建反向shell连接到攻击者的机器（`127.0.0.1:4455`）。
5.  **start.sh:**  该脚本负责持续扫描`/proc/*/exe`，查找包含`runc`关键字的进程，并尝试运行`exploit`程序覆盖runc二进制文件。它还通过修改`/bin/sh`指向`/proc/self/exe`来尝试加速漏洞触发。该脚本还会过滤掉空的cmdline，避免exploit执行出错。
6.  **README.md:** 描述了漏洞利用步骤，包括镜像构建和运行。

**投毒风险分析：**
虽然提供的代码主要目的是实现容器逃逸，但仍然存在一定的投毒风险。`payload.c`中的反向shell地址硬编码为`127.0.0.1`，这意味着如果直接使用该代码，反向shell只会连接到容器内部。然而，攻击者可能修改`payload.c`，将反向shell地址更改为攻击者控制的服务器。此外，`start.sh` 脚本尝试修改`/bin/sh`，这可能会导致宿主机上的其他容器或进程出现问题。综合考虑，投毒风险评估为10%。大多数代码意图明显，且payload相对简单，但存在修改payload进行恶意利用的可能性。

**利用方式总结：**
1.  构建包含漏洞利用代码的Docker镜像。
2.  运行该镜像，启动一个恶意容器。
3.  该容器内的`start.sh`脚本会持续扫描`/proc/*/exe`，查找runc进程。
4.  当找到runc进程时，`exploit`程序会尝试打开并覆盖宿主机上的runc二进制文件。
5.  一旦runc二进制文件被覆盖，下次宿主机运行容器时，就会执行恶意payload，从而获得宿主机的root权限。
6.  Payload建立一个反向shell连接到攻击者的服务器，从而允许攻击者控制宿主机。

**项目地址:** [yyqs2008/CVE-2019-5736-PoC-2](https://github.com/yyqs2008/CVE-2019-5736-PoC-2)

**漏洞详情:** [CVE-2019-5736](https://nvd.nist.gov/vuln/detail/CVE-2019-5736)