## CVE-2023-42793 - TeamCity 身份验证绕过导致RCE

**漏洞编号:** CVE-2023-42793

**漏洞类型:** 身份验证绕过

**影响应用:** JetBrains TeamCity

**危害等级:** 高危，可导致远程代码执行

**影响版本:** < 2023.05.4

**利用条件:** 需要网络访问TeamCity服务器

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2023-42793 是 JetBrains TeamCity 中存在的一个身份验证绕过漏洞，未经身份验证的攻击者可以通过发送特制的 HTTP 请求绕过身份验证，从而创建管理员账户并最终实现远程代码执行。

**有效性：**
根据漏洞库信息、搜索引擎结果以及漏洞利用代码，该漏洞的POC代码是有效的。搜索引擎结果中多个链接都提到了该漏洞被积极利用，包括APT组织。漏洞利用代码提供了创建管理员账户和执行RCE的脚本，并且说明了如何利用该漏洞，包括如何获取反向shell。

**投毒风险：**
分析提供的`exploit.py`和`rce_exploit.py`，主要功能是创建管理员账户和执行任意命令。脚本本身的代码逻辑相对简单，没有明显的恶意代码。其中`exploit.py`会生成随机用户名、密码和邮箱地址，这可能被误认为恶意行为，但这是为了方便利用而设计的，并非投毒。`rce_exploit.py`脚本依赖于第一个脚本创建的token文件。虽然没有发现明显的后门代码，但仍存在极小的风险，例如在生成随机字符串时引入偏差，虽然可能性极小，但理论上存在被利用的可能性，将投毒风险评定为5%。

**利用方式：**
1.  **身份验证绕过：** 攻击者首先利用身份验证绕过漏洞，该漏洞允许未经身份验证的攻击者与TeamCity服务器进行交互，绕过正常的身份验证流程。
2.  **创建管理员账户：** 使用 `exploit.py` 脚本，通过发送特制的 POST 请求，在 TeamCity 服务器上创建一个新的管理员账户。可以指定用户名、密码和邮箱，也可以使用随机生成的凭据。成功创建后，会将凭据保存到token文件中。
3.  **远程代码执行：** 使用 `rce.py` 脚本，该脚本首先启用debug processes，然后利用创建的管理员账户，通过 TeamCity 的 API 接口执行任意命令。可以执行系统命令，例如 `whoami`，也可以获取反向 shell，从而完全控制服务器。
4.  **反向Shell:** 利用rce.py执行命令，通过反弹shell到攻击者机器上，来获取服务器的控制权。


**项目地址:** [B4l3rI0n/CVE-2023-42793](https://github.com/B4l3rI0n/CVE-2023-42793)

**漏洞详情:** [CVE-2023-42793](https://nvd.nist.gov/vuln/detail/CVE-2023-42793)