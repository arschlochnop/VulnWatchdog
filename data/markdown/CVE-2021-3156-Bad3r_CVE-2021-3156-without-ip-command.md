## CVE-2021-3156 (Baron Samedit) Sudo Heap-Based Buffer Overflow

**漏洞编号:** CVE-2021-3156

**漏洞类型:** Heap-Based Buffer Overflow

**影响应用:** Sudo

**危害等级:** 高危，可导致权限提升至root

**影响版本:** Sudo before 1.9.5p2

**利用条件:** 本地用户可执行sudo

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-3156 (Baron Samedit) 存在于 Sudo 1.9.5p2 之前的版本中。这是一个堆缓冲区溢出漏洞，允许本地用户通过 `sudoedit -s` 命令以及以单个反斜杠字符结尾的命令行参数将权限提升为 root。

**有效性：**
根据漏洞库信息和搜索结果，该漏洞是一个已知的，并且已经有公开可用的利用代码(POC)。该漏洞利用代码在多个平台和版本上成功进行了利用，可以有效地将权限提升到root。

**投毒风险：**
提供的POC代码 (`exploit_nss.py`) 看起来像是 `worawit/CVE-2021-3156` 的一个fork，修改为使用 `ifconfig` 命令而不是 `ip` 命令。虽然这个修改本身是合理的 (为了兼容性)，但仍然存在轻微的投毒风险。投毒风险评估为 10%的原因如下：
  1. **代码来源：** 虽然代码fork自一个已知的漏洞利用仓库，但仍然需要检查fork后的代码是否引入了恶意修改。
  2. **代码复杂性：** 漏洞利用代码通常比较复杂，增加了隐藏恶意代码的可能性。
  3. **权限提升：** 由于漏洞利用本身会提升权限到root，恶意代码一旦成功执行，可能会造成严重的危害。
  4. **依赖外部资源：**  虽然作者说使用了ifconfig,但是还是依赖nscd等外部服务,如果被篡改,同样有提权风险.

**利用方式：**
1.  漏洞利用的触发点在于 `sudoedit -s` 命令在解析命令行参数时存在的 off-by-one 错误。
2.  攻击者需要构造一个以单个反斜杠字符结尾的恶意命令行参数。
3.  该参数会触发堆缓冲区溢出，覆盖内存中的数据结构（`service_user` 结构体）。
4.  通过精心构造溢出内容，可以覆盖 `service_user` 结构体中的指针，劫持程序执行流程。
5.  利用劫持的程序执行流程，攻击者可以执行任意代码，从而将权限提升到 root。
6.  此POC 使用 `ifconfig` 命令而不是 `ip` 命令，可能是为了增加在不同环境下的兼容性，因为 `ip` 命令可能不是所有系统默认安装的。

**项目地址:** [Bad3r/CVE-2021-3156-without-ip-command](https://github.com/Bad3r/CVE-2021-3156-without-ip-command)

**漏洞详情:** [CVE-2021-3156](https://nvd.nist.gov/vuln/detail/CVE-2021-3156)