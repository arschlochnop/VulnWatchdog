## CVE-2024-4040-CrushFTP-服务器端模板注入

**漏洞编号:** CVE-2024-4040

**漏洞类型:** 服务器端模板注入 (SSTI)

**影响应用:** CrushFTP

**危害等级:** 高危，可能导致任意文件读取、身份验证绕过和远程代码执行

**影响版本:** < 10.7.1 和 < 11.1.0

**利用条件:** 目标CrushFTP实例运行在受影响的版本上，且攻击者可以发起网络请求。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-4040 是 CrushFTP 中存在的一个服务器端模板注入 (SSTI) 漏洞。未经身份验证的远程攻击者可以通过该漏洞读取 VFS 沙箱之外的文件系统上的文件，绕过身份验证以获得管理访问权限，并在服务器上执行远程代码。

**有效性：**
根据漏洞库信息、搜索结果和提供的PoC代码，该漏洞的PoC是有效的。漏洞库信息中明确说明了该漏洞可导致任意文件读取和远程代码执行，并提供了相关的GitHub链接（airbus-cert/CVE-2024-4040）。搜索引擎结果也表明该漏洞正在被积极利用。PoC代码中包含了利用该漏洞进行文件读取和代码执行的 Python 脚本 `crushed.py`。虽然提供的 Dockerfile 主要用于搭建测试环境，但其中并没有直接包含利用代码。`crushed.py` 使用了 requests 库与目标 CrushFTP 服务器进行交互，并尝试利用 SSTI 漏洞。

**投毒风险：**
分析提供的文件列表，主要关注 `crushed.py` 文件。该文件相对较长，需要仔细审查是否存在恶意代码。根据代码内容, `crushed.py` 包含发送 HTTP 请求的代码，用于探测和利用目标服务器。仓库的其他文件，如 Dockerfile、docker-compose.yaml、k8s.yaml 和 policy.yaml，主要用于搭建测试环境和定义安全策略，自身不构成直接的投毒风险。需要注意的是, 容器镜像 `safeeraccuknox/demo:cve-2024-4040-poc` 存在潜在风险，因为它是由第三方提供的，可能包含未知恶意代码, 这里不考虑. 风险主要集中在`crushed.py`文件是否包含恶意逻辑。初步评估认为，该脚本的风险较低,但**不能排除**代码作者在 HTTP 请求中隐藏恶意代码或使用不安全的库函数等潜在风险。`policy.yaml`是针对 kubearmor 的策略，阻止访问敏感文件，是防御措施，不是投毒代码。综合评估，投毒风险大约为10%。

**利用方式：**
1.  攻击者发送特制的 HTTP 请求到易受攻击的 CrushFTP 服务器的 WebInterface 端点。
2.  该请求包含一个恶意的模板表达式，该表达式将被服务器的模板引擎执行。
3.  通过服务器端模板注入 (SSTI)，攻击者可以实现以下操作：
    *   读取服务器上的任意文件（VFS 沙箱之外的文件）。
    *   绕过身份验证，获得管理员权限。
    *   在服务器上执行任意代码。

**项目地址:** [safeer-accuknox/CrushFTP-cve-2024-4040-poc](https://github.com/safeer-accuknox/CrushFTP-cve-2024-4040-poc)

**漏洞详情:** [CVE-2024-4040](https://nvd.nist.gov/vuln/detail/CVE-2024-4040)