## CVE-2019-5736-runc-容器逃逸

**漏洞编号:** CVE-2019-5736

**漏洞类型:** 容器逃逸

**影响应用:** runc (Docker)

**危害等级:** 高危，可获得宿主机root权限

**影响版本:** <= 1.0-rc6 (Docker before 18.09.2)

**利用条件:** 需要能够在容器内以root身份执行命令，或者能够通过`docker exec`进入具有写权限的已存在容器。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2019-5736 漏洞允许攻击者通过恶意容器覆盖宿主机上的 `runc` 二进制文件，从而获得宿主机的 root 权限。 

**漏洞利用方式：**

1.  **攻击准备：** 攻击者需要在一个存在漏洞的Docker环境中运行一个容器。这个容器可以是新建的，也可以是攻击者已经具有写权限的。 
2.  **第一阶段 (stage1.c)：**
    *   编译后的 `stage1.c` 会被注入到 `libseccomp` 的 `src/api.c` 中，构建一个新的 `libseccomp` 包。
    *   当容器启动时，修改后的 `libseccomp` 中的构造函数 `foo()` 会被执行。
    *   `foo()` 函数尝试打开 `/proc/self/exe`（即 runc 二进制文件）的只读文件描述符。
    *   然后，它构造一个包含 `/stage2` 路径和文件描述符路径的参数数组。
    *   最后，它使用 `execve()` 函数执行 `/stage2`，并将文件描述符传递给它。
3.  **第二阶段 (stage2.c)：**
    *   `stage2.c` 的主要功能是打开通过参数传递的文件描述符，并以读写追加模式打开，向该文件描述符写入特定的字符串（`cve-2019-5736`）。
    *   由于传递的文件描述符指向宿主机的 `runc` 二进制文件，因此 `stage2.c` 实际上是将字符串追加到宿主机的 `runc` 二进制文件中。
4.  **触发：**
    *   当下一次调用 `runc` 执行容器操作（例如 `docker run` 或 `docker exec`）时，被篡改的 `runc` 二进制文件会被执行。
    *   如果在`stage2.c`中修改为恶意的shell命令，下次启动容器时会执行root权限的恶意shell命令，攻击者就获得了宿主机的 root 权限。

**有效性：**

提供的PoC 代码有效，它可以覆盖宿主机上的 `runc` 二进制文件。 虽然这个 PoC 只是简单地追加字符串，但是可以很容易地修改 `stage2.c` 来执行任意代码，从而实现完整的容器逃逸。

**投毒风险：**

该 PoC 仓库中存在一定投毒风险，分析结果为10%。
* Dockerfile里存在从源码构建libseccomp的行为，增加了潜在的供应链风险，如果构建环境被污染，可能引入恶意代码。
* stage2.c可以被修改为任意的恶意程序，存在被利用的风险。

**总结：**

CVE-2019-5736 是一个严重的容器逃逸漏洞，利用起来相对简单，并且可以导致完全控制宿主机。因此，强烈建议受影响的用户尽快升级 `runc` 和 Docker 到安全版本。

**项目地址:** [q3k/cve-2019-5736-poc](https://github.com/q3k/cve-2019-5736-poc)

**漏洞详情:** [CVE-2019-5736](https://nvd.nist.gov/vuln/detail/CVE-2019-5736)