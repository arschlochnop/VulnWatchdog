## CVE-2024-39943-rejetto HFS-远程命令执行

**漏洞编号:** CVE-2024-39943

**漏洞类型:** 远程命令执行

**影响应用:** rejetto HFS (HTTP File Server)

**危害等级:** 高危，可能导致完全控制服务器

**影响版本:** < 0.52.10

**利用条件:** 需要目标服务器运行rejetto HFS且攻击者拥有上传权限（或能通过其他方式获取上传权限）。

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2024-39943 允许经过身份验证的远程用户（如果他们具有上传权限）执行操作系统命令。这是因为 shell 用于执行 `df` 命令（即，在 Node.js 的 `child_process` 中使用 `execSync` 而不是 `spawnSync`）。

**漏洞利用方式：**

根据提供的PoC代码，此漏洞可以通过以下方式利用：

1.  **用户认证：** 首先，攻击者需要拥有一个有效的rejetto HFS用户账号，并且该账号需要具有上传权限。`config.yaml`文件展示了可以配置用户账号和权限。

2.  **创建包含恶意命令的目录：** PoC利用了文件系统在处理文件/目录大小计算时调用`df`命令的特性，通过创建一个名称包含恶意命令的目录，触发命令执行。恶意命令会被编码成Base64，避免直接出现在目录名中。

3.  **触发漏洞：**通过PUT请求上传文件到恶意的目录中，服务端调用df时，会执行目录名中构造的恶意代码。

PoC中提供了两种利用方式：

*   **poc_user_admin.py：** 利用了HFS的API接口来添加VFS目录，并设置上传权限。然后，创建包含恶意命令的目录，并通过`get_ls`接口来触发漏洞。
*   **poc_user_guest.py：** 模拟了普通用户上传文件的情况。该PoC首先上传文件到包含恶意命令的目录，如果目录不存在，则需要发送两次PUT请求才能成功执行命令。这是因为第一次请求创建了目录，但尚未触发`df`命令的执行。第二次请求才会触发。

**投毒风险评估：**

虽然PoC代码本身是为了演示漏洞利用而编写的，但是其中仍然存在一定的投毒风险：

*   **`poc_user_admin.py`可能被修改：** 攻击者可能会修改`poc_user_admin.py`，例如添加额外的后门代码，或者修改payload，使其执行恶意操作。
*   **`config.yaml`可能包含恶意配置：** `config.yaml`文件可能被篡改，添加具有管理员权限的恶意用户，或者修改现有用户的权限。
*  **虽然整体投毒风险较低，但需要谨慎使用，防止被恶意利用。**

综合评估，该漏洞利用的有效性较高，因为PoC代码已经能够成功地在目标系统上执行任意命令。投毒风险较低，但需要注意PoC代码本身可能被篡改。攻击者需要具备一定的权限才能利用该漏洞。

**项目地址:** [truonghuuphuc/CVE-2024-39943-Poc](https://github.com/truonghuuphuc/CVE-2024-39943-Poc)

**漏洞详情:** [CVE-2024-39943](https://nvd.nist.gov/vuln/detail/CVE-2024-39943)