## CVE-2023-41892 Craft CMS 远程代码执行漏洞

**漏洞编号:** CVE-2023-41892

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Craft CMS

**危害等级:** 严重，可能导致完全控制服务器

**影响版本:** >= 4.0.0-RC1, <= 4.4.14

**利用条件:** 无需认证，目标服务器需存在漏洞版本

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2023-41892 存在于 Craft CMS 中，是一个未经身份验证的远程代码执行漏洞。攻击者可以通过精心构造的请求，在目标服务器上执行任意代码。从提供的搜索引擎结果和漏洞库信息来看，该漏洞影响 Craft CMS 4.0.0-RC1 到 4.4.14 版本。漏洞利用代码包括两个 Python 脚本：poc_noauth.py 和 poc_auth.py。

*   **有效性：**
    *   `poc_noauth.py`：这个脚本利用未经身份验证的漏洞，直接执行操作系统命令。它首先通过 `conditions/render` action 获取 `upload_tmp_dir` 和 `DOCUMENT_ROOT`。然后，它上传一个包含 `system($_GET['cmd']);` 的 PHP webshell 到 `DOCUMENT_ROOT/cpresources/shell.php`。最后，攻击者可以通过访问 `shell.php?cmd=<命令>` 来执行任意命令，此PoC直接并且有效。
    *   `poc_auth.py`：这个脚本也利用了相同的漏洞，但增加了一个简单的基于密钥的身份验证层。攻击者需要提供正确的密钥才能执行命令。密钥的 SHA-256 哈希值硬编码在 webshell 中。攻击者需要先计算密钥的 SHA-256 哈希值，然后替换 webshell 代码中的 `YOUR_SECRET_KEY`。使用方法参考脚本内的说明。
*   **投毒风险：**
    *   分析提供的代码，没有发现作者植入恶意代码的迹象，如反向shell，木马程序，删除数据的操作。`poc_auth.py` 的 webshell 部分可以被认为是预期的漏洞利用行为，而不是恶意投毒行为。
    *   考虑到代码的简洁性和目的性（漏洞利用），以及双 PoC 的存在（一个无认证，一个简单认证），投毒的可能性较低。
    *   综合判断，投毒风险评估为0%。
*   **利用方式：**
    1.  **信息收集：** 使用`conditions/render` action和`\GuzzleHttp\Psr7\FnStream`类来获得`upload_tmp_dir` 和 `DOCUMENT_ROOT`的值。因为文档根目录和临时目录对于 webshell 的写入至关重要。
    2.  **上传 Webshell (NoAuth)：**  脚本将一个简单的 PHP webshell (`<?php system($_GET['cmd']); ?>`) 上传到目标服务器的 `DOCUMENT_ROOT/cpresources/shell.php` 路径下。
    3.  **上传 Webshell (Auth):** 脚本利用 `Imagick` 组件上传webshell, webshell 中包含一个密钥验证的逻辑，只有提供正确的密钥才能执行命令。
    4.  **触发 Imagick 组件 (Auth):** 使用 `Imagick` 组件激活webshell，具体函数是 `activate_imagick`。
    5.  **命令执行：**  通过访问 webshell 的 URL 并提供 `cmd` 参数，即可在服务器上执行任意命令 (NoAuth)。或者提供密钥与命令 (Auth)。例如，`{target}/cpresources/shell.php?cmd=id` 或 `{target}/cpresources/shell.php?k=(YOUR_KEY)&c=id`。

总的来说，该漏洞利用过程简单直接，利用成功后，攻击者可以完全控制受影响的 Craft CMS 服务器。

**项目地址:** [user01-1/CVE-2023-41892_poc](https://github.com/user01-1/CVE-2023-41892_poc)

**漏洞详情:** [CVE-2023-41892](https://nvd.nist.gov/vuln/detail/CVE-2023-41892)