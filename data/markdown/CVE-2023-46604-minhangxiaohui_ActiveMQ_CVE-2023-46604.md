## CVE-2023-46604-Apache ActiveMQ-RCE

**漏洞编号:** CVE-2023-46604

**漏洞类型:** 远程代码执行

**影响应用:** Apache ActiveMQ

**危害等级:** 高危，可能导致远程代码执行，系统完全控制

**影响版本:** < 5.15.16, < 5.16.7, < 5.17.6, < 5.18.3

**利用条件:** 需要网络访问ActiveMQ服务，并且ActiveMQ服务使用了存在漏洞的OpenWire协议。

**POC 可用性:** 是

**投毒风险:** 1%

## 详情

CVE-2023-46604 是 Apache ActiveMQ 中 Java OpenWire 协议 marshaller 存在反序列化漏洞导致的远程代码执行漏洞。攻击者可以利用此漏洞，通过构造恶意的 OpenWire 协议数据包，使 ActiveMQ Broker 或 Client 实例化任意类，从而执行任意 shell 命令。

**有效性：**

根据漏洞库信息和搜索结果，该漏洞已经确认被野外利用，并且有公开的POC。提供的POC代码看起来是有效的，实现了构造包含恶意类的序列化数据，发送给 ActiveMQ 服务。

**投毒风险：**

分析POC代码，`/tmp/c0a082fa63db8611bcfc45c3cff01a2f/cve-2023-46604.py` 主要功能是根据用户输入的参数，构造恶意数据包并发送到目标ActiveMQ服务器，触发反序列化漏洞，从而达到远程代码执行的效果。`/tmp/c0a082fa63db8611bcfc45c3cff01a2f/README.md` 文件只是对 POC 的简单说明，没有可执行代码。综合来看，此仓库中直接隐藏恶意投毒代码的可能性较低。用户需要自己搭建http服务，托管恶意的xml文件，存在一定的利用门槛。

但是存在一种潜在的风险：攻击者可能会修改 `xmlurl_string` 参数，指向一个包含恶意payload的XML文件，从而实现攻击。因此，使用者必须验证`xmlurl_string`指向的URL的安全性。仓库本身投毒风险评估为 1%。

**利用方式：**

1.  **确定目标：** 确定目标 ActiveMQ 服务的 IP 地址和端口（默认为 61616）。
2.  **选择Gadget：** 根据目标环境选择合适的Gadget，poc提供了`org.springframework.context.support.FileSystemXmlApplicationContext` 和 `org.springframework.context.support.ClassPathXmlApplicationContext` 两种选择，`FileSystemXmlApplicationContext` 可以绕过一些 IDS 检测。
3.  **构造恶意XML文件：** 构造一个恶意的 XML 配置文件，其中包含执行恶意命令的代码。这个XML文件会被ActiveMQ服务加载并执行。
4.  **运行POC：** 运行提供的 POC 代码，输入目标 IP 地址、端口和恶意 XML 文件的 URL。POC 会构造包含恶意类的序列化数据，并通过 OpenWire 协议发送给 ActiveMQ 服务。
5.  **触发漏洞：** ActiveMQ 服务接收到恶意数据后，会尝试反序列化数据中的类，从而加载并执行恶意 XML 文件中的代码，最终实现远程代码执行。

**安全建议：**

*   升级 ActiveMQ 版本到 5.15.16, 5.16.7, 5.17.6, 或 5.18.3 及以上。
*   限制 ActiveMQ 的网络访问，只允许受信任的客户端连接。
*   配置防火墙，阻止对 ActiveMQ 端口的未授权访问。
*   使用网络入侵检测系统（NIDS）或入侵防御系统（IPS）来检测和阻止恶意 OpenWire 协议数据包。

**项目地址:** [minhangxiaohui/ActiveMQ_CVE-2023-46604](https://github.com/minhangxiaohui/ActiveMQ_CVE-2023-46604)

**漏洞详情:** [CVE-2023-46604](https://nvd.nist.gov/vuln/detail/CVE-2023-46604)