## CVE-2024-4577-PHP-CGI参数注入

**漏洞编号:** CVE-2024-4577

**漏洞类型:** PHP-CGI参数注入

**影响应用:** PHP

**危害等级:** 高危，可能导致远程代码执行

**影响版本:** 8.1.* before 8.1.29, 8.2.* before 8.2.20, 8.3.* before 8.3.8

**利用条件:** Windows系统，Apache服务器，PHP以CGI模式运行，系统使用某些开启了"Best Fit"策略的代码页。

**POC 可用性:** 是

**投毒风险:** 1%

## 详情

CVE-2024-4577是一个影响Windows系统上PHP-CGI模式的远程代码执行漏洞。当PHP在CGI模式下运行时，如果系统配置为使用某些代码页，Windows可能会使用“Best-Fit”行为来替换命令行中的字符。PHP CGI模块可能会错误地将这些字符解释为PHP选项，从而允许恶意用户将选项传递给正在运行的PHP二进制文件，从而泄露脚本源代码或执行任意PHP代码。

**有效性：**
提供的POC代码有效。它通过在URL中注入恶意参数，利用`allow_url_include`和`auto_prepend_file`选项来包含和执行POST请求中提供的PHP代码。

**投毒风险：**
该POC代码本身的功能是利用漏洞进行远程代码执行。代码中添加了protocol检测，确保target可用。但仔细检查后发现，README.md文件不完整，文件末尾被截断。由于github仓库图片链接域名存在github.com，该仓库可能存在钓鱼风险，因此投毒风险预估为1%。

**利用方式：**
1.  **扫描：** 使用脚本的`-s`参数扫描目标URL是否存在漏洞。扫描器通过构造包含特定payload的URL，并发送POST请求，检测服务器返回结果中是否包含预期字符串（“Test”）。
2.  **利用：** 使用脚本的`-e`参数，配合`-p`参数指定包含PHP代码的payload文件，利用漏洞执行任意PHP代码。攻击者通过构造包含特定payload的URL，并发送包含PHP代码的POST请求。
3. 脚本通过`allow_url_include`和`auto_prepend_file`配置项的组合来包含并执行php代码。

**项目地址:** [longhoangth18/CVE-2024-4577](https://github.com/longhoangth18/CVE-2024-4577)

**漏洞详情:** [CVE-2024-4577](https://nvd.nist.gov/vuln/detail/CVE-2024-4577)