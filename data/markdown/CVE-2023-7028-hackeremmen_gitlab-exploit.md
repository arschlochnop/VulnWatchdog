## CVE-2023-7028 - GitLab 弱密码恢复机制漏洞

**漏洞编号:** CVE-2023-7028

**漏洞类型:** 弱密码恢复机制漏洞

**影响应用:** GitLab CE/EE

**危害等级:** 高危，可导致账户接管

**影响版本:** 16.1 prior to 16.1.6, 16.2 prior to 16.2.9, 16.3 prior to 16.3.7, 16.4 prior to 16.4.5, 16.5 prior to 16.5.6, 16.6 prior to 16.6.4, and 16.7 prior to 16.7.2

**利用条件:** 目标GitLab实例存在漏洞且可网络访问

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2023-7028 存在于 GitLab 的密码重置功能中。攻击者可以通过在密码重置请求中提供两个邮箱地址（目标邮箱和攻击者自己的邮箱），从而使密码重置链接同时发送到这两个邮箱。攻击者可以利用收到的重置链接来重置目标用户的密码并接管其帐户。 

**有效性：** 
提供的POC代码是有效的，它利用了GitLab的弱密码恢复机制漏洞。该代码首先获取CSRF token，然后构造包含目标邮箱和攻击者邮箱的密码重置请求，最后发送请求。如果目标GitLab实例存在漏洞，攻击者将在其邮箱中收到密码重置链接，从而可以重置目标用户的密码。

**投毒风险：** 
分析了提供的POC代码后，存在轻微的投毒风险（10%）。 主要的风险点在于`attack.py`中有一行打印 `Flag value: {bytes.fromhex("6163636f756e745f6861636b2364").decode()}`， 这可能是为了迷惑使用者或用于测试目的。 但是，真正的攻击场景下，攻击者不会这样明目张胆地留下标记。总体而言，该代码的功能主要是实现漏洞利用，没有发现明显的恶意代码或后门，但`Flag value`的存在略微增加了投毒的可能。其他的投毒风险在于代码依赖的requests模块本身的安全问题，如果requests模块被篡改，则可能存在投毒风险。

**利用方式：** 
1.  **目标确定：** 确定存在漏洞的GitLab实例和目标用户。 
2.  **获取CSRF Token：**  使用POC代码中的`get_csrf_token`函数从GitLab的密码重置页面获取CSRF token。 
3.  **构造恶意请求：**  构造包含目标邮箱和攻击者邮箱的密码重置请求。POC代码使用`urllib.parse.urlencode`函数来构造请求体。 
4.  **发送请求：**  使用POC代码中的`ask_reset`函数将构造的请求发送到GitLab的密码重置端点。 
5.  **接收重置链接：**  攻击者在其邮箱中收到密码重置链接。 
6.  **重置密码：**  攻击者使用收到的重置链接重置目标用户的密码并接管其帐户。

**项目地址:** [hackeremmen/gitlab-exploit](https://github.com/hackeremmen/gitlab-exploit)

**漏洞详情:** [CVE-2023-7028](https://nvd.nist.gov/vuln/detail/CVE-2023-7028)