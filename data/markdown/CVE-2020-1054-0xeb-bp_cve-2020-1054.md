## CVE-2020-1054 Win32k 权限提升漏洞

**漏洞编号:** CVE-2020-1054

**漏洞类型:** 权限提升

**影响应用:** Windows

**危害等级:** 高危，可能导致本地权限提升

**影响版本:** 受影响的Windows版本包括Windows 7 SP1, Windows 8.1, Windows 10 (多个版本), Windows Server (多个版本)

**利用条件:** 本地访问

**POC 可用性:** 是

**投毒风险:** 1%

## 详情

CVE-2020-1054 是一个 Windows 内核模式驱动程序未能正确处理内存中的对象时存在的权限提升漏洞。该漏洞存在于 Win32k 组件中，允许经过身份验证的攻击者在本地系统上执行任意代码，提升权限。 

**有效性：**

提供的漏洞利用代码（Rust）似乎针对 CVE-2020-1054 漏洞，并且专门针对 Windows 7 x64。 代码尝试通过 `NtQuerySystemInformation` 获取进程信息，然后查找目标进程的 Token，并修改Token权限。搜索结果中Github链接指向的仓库也佐证了这一点，显示了针对Windows 7 x64的利用。

**投毒风险：**

代码本身相当复杂，但是包含了相关的注释，并且从代码逻辑上来看，主要目的是通过内存操作修改当前进程的权限。 检查Cargo.toml文件，发现依赖项中winapi, ntapi没有发现可疑的篡改行为。考虑到安全研究员通常会将POC发布到Github上，并且该POC已经存在了一段时间，如果存在明显的恶意代码，应该会被发现。 因此，投毒的概率较低。 粗略估计投毒的可能性在1%左右。投毒分析主要基于代码逻辑和依赖项检查，不能保证完全准确。

**利用方式：**

1.  **信息收集：** 利用`NtQuerySystemInformation`收集系统句柄信息，包括进程ID、句柄值和对象地址。
2.  **定位Token：** 在收集到的句柄信息中，查找当前进程的Token句柄及其对应的内核对象地址（EPROCESS）。
3.  **修改权限：**  通过计算EPROCESS结构中Token权限的偏移，直接修改Token的权限，从而提升当前进程的权限。
4.  **Bitmap对象操作：** 利用`CreateCompatibleDC`和`CreateCompatibleBitmap`创建设备上下文和Bitmap对象，通过`DrawIconEx`函数触发漏洞，实现内存破坏，可能导致权限提升。

**项目地址:** [0xeb-bp/cve-2020-1054](https://github.com/0xeb-bp/cve-2020-1054)

**漏洞详情:** [CVE-2020-1054](https://nvd.nist.gov/vuln/detail/CVE-2020-1054)