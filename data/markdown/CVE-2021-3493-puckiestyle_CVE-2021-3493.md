## CVE-2021-3493 - Ubuntu OverlayFS 本地提权

**漏洞编号:** CVE-2021-3493

**漏洞类型:** 本地提权

**影响应用:** Linux Kernel (Ubuntu)

**危害等级:** 高危，攻击者可利用此漏洞获得 root 权限

**影响版本:** Ubuntu 5.8 kernel (< 5.8.0-50.56), 5.4 kernel (< 5.4.0-72.80), 4.15 kernel (< 4.15.0-142.146), 4.4 kernel (< 4.4.0-209.241)

**利用条件:** 需要 Ubuntu 系统开启 unprivileged user namespaces 和允许 unprivileged overlay mounts

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-3493 是 Ubuntu 内核 overlayfs 实现中的一个漏洞，允许本地攻击者通过滥用 user namespaces 和 overlayfs 挂载机制提升权限。

**有效性评估：**
提供的 POC 代码尝试利用该漏洞，通过创建 user namespace 和 overlayfs 文件系统来设置可执行文件的 capability 位，使其获得 root 权限。 漏洞库信息,搜索引擎结果和漏洞利用代码一致,表明该漏洞的POC是真实有效的。

**投毒风险分析：**
查看 `exploit.c` 代码，主要操作包括创建目录、设置 user namespace、挂载 overlayfs、复制可执行文件、设置 capability 属性，以及执行复制后的文件以获得 root 权限。代码逻辑较为清晰，未发现明显的恶意代码。`README.md` 也说明了并非作者原创,只是搬运,增加了分析难度.
`exploit.c`中存在`system(buf);` 调用，虽然这里是用于清理目录，但如果被篡改，可能执行任意命令。因此，投毒风险评估为10%。主要的风险在于：

*   `system()` 函数潜在的命令注入风险，如果代码被修改，可能导致执行任意命令。

**利用方式：**
1.  利用 unshare() 创建一个新的 user namespace 和 mount namespace。
2.  配置 user namespace 的 uid_map 和 gid_map，将当前用户映射为 root 用户。
3.  创建 overlayfs 所需的目录结构（lowerdir、upperdir、workdir、merged）。
4.  挂载 overlayfs 文件系统。
5.  将漏洞利用程序自身复制到 overlayfs 的 upperdir/merged 目录。
6.  使用 setxattr() 设置复制后的可执行文件的 security.capability 属性，赋予其 CAP_SETUID 和 CAP_SETGID 权限。
7.  执行复制后的程序，由于设置了 capability，该程序会以 root 权限运行，从而获得 root shell。

**项目地址:** [puckiestyle/CVE-2021-3493](https://github.com/puckiestyle/CVE-2021-3493)

**漏洞详情:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)