## CVE-2016-5195 - Dirty COW

**漏洞编号:** CVE-2016-5195

**漏洞类型:** 权限提升

**影响应用:** Linux Kernel

**危害等级:** 高危，可使普通用户获得root权限

**影响版本:** Linux kernel 2.x through 4.x before 4.8.3

**利用条件:** 本地用户，需要目标系统存在可执行的suid程序

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2016-5195，又名Dirty COW，是一个Linux内核中的竞争条件漏洞。漏洞存在于`mm/gup.c`中，由于内核不正确地处理写时复制（COW）特性，允许本地用户利用此漏洞，通过写入只读内存映射来获得提升的权限。该POC代码通过以下步骤利用该漏洞：

1.  **目标选择：** 选择一个SUID程序，例如`/usr/bin/passwd`，作为攻击目标。
2.  **内存映射：** 使用`mmap()`将目标程序映射到进程的内存空间，映射类型为`MAP_PRIVATE`和`PROT_READ`，即只读私有映射。
3.  **准备Payload：** 创建一个payload，该payload的大小与目标SUID程序的大小相同。用NOP指令填充payload，并将shellcode复制到payload的起始位置。
4.  **竞争条件：** 创建两个线程：
    *   **madvise线程：** 调用`madvise()`函数，并传入`MADV_DONTNEED`标志。这个操作会释放映射的内存页，但不会解除映射。
    *   **procselfmem线程：** 打开`/proc/self/mem`文件，并使用`lseek()`函数将文件指针移动到映射内存的起始位置。然后，使用`write()`函数将payload写入`/proc/self/mem`，从而覆盖映射的内存。
5.  **利用原理：** `madvise()`和`write()`操作之间存在竞争条件。`madvise(MADV_DONTNEED)`会触发COW，而`write()`尝试写入只读映射，从而触发漏洞。
6.  **执行目标：** 在漏洞利用成功后，使用`system()`函数执行目标SUID程序，从而获得root权限。

**有效性：**
根据漏洞信息和搜索结果，该漏洞利用代码是有效的，因为该漏洞已经被广泛利用。

**投毒风险：**
该代码没有明显的投毒行为。Shellcode用于提权，是将shellcode写入只读的`/usr/bin/passwd`。

**利用方式总结：**
1.  利用竞争条件，修改只读内存。
2.  修改SUID程序，覆盖原来的指令为恶意shellcode。
3.  执行被篡改的程序，获得root权限。

**项目地址:** [LinuxKernelContent/DirtyCow](https://github.com/LinuxKernelContent/DirtyCow)

**漏洞详情:** [CVE-2016-5195](https://nvd.nist.gov/vuln/detail/CVE-2016-5195)