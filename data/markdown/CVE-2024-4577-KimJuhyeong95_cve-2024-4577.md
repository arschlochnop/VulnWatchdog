## CVE-2024-4577 - PHP-CGI 参数注入导致RCE

**漏洞编号:** CVE-2024-4577

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** PHP (Windows, CGI 模式)

**危害等级:** 高危，可能导致服务器被完全控制

**影响版本:** PHP 8.1.* (< 8.1.29), 8.2.* (< 8.2.20), 8.3.* (< 8.3.8)

**利用条件:** Windows服务器，PHP以CGI模式运行，开启了使用"Best Fit"策略的编码页。

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2024-4577是一个存在于Windows环境下以CGI模式运行的PHP中的高危漏洞。由于Windows系统在特定代码页下，会使用"Best-Fit"策略转换命令行参数中的字符，PHP-CGI模块可能错误地将这些字符解析为PHP选项，从而允许攻击者注入恶意PHP代码。  

**利用方式：**
攻击者通过构造包含特定字符的URL，欺骗PHP-CGI解析器将恶意代码作为配置选项执行。POC代码`cve_2024_4577_tester.py`通过发送包含如下Payload的POST请求来验证漏洞：

```
?%ADd+allow_url_include=1+%ADd+auto_prepend_file=php://input
```
以及 POST Body:
```php
<?php echo 'CVE-2024-4577-TEST'; ?>
```
其中，`%AD` 和 `d` 的组合是为了绕过某些安全限制。`allow_url_include=1` 允许包含远程文件，`auto_prepend_file=php://input`  将POST请求的内容作为PHP代码执行。

**投毒风险分析：**
虽然POC代码本身是为了验证漏洞，但仍然存在一定的投毒风险。该脚本从用户处获取目标URL，然后发送包含PHP代码的POST请求。如果攻击者修改此脚本，例如：

1.  **修改Payload：**  将测试用的`echo`语句替换为更隐蔽的恶意代码，例如反弹shell，上传webshell等。
2.  **增加后门：**  在成功利用漏洞后，在目标服务器上留下后门，以便长期控制。
3.  **信息收集：**  收集用户输入的目标URL和其他信息，发送给攻击者。

尽管存在风险，但此POC代码相对简单，风险主要取决于使用者是否对其进行修改和滥用。 由于代码短小, 容易审核, 投毒风险较低, 估计为 5%。

**项目地址:** [KimJuhyeong95/cve-2024-4577](https://github.com/KimJuhyeong95/cve-2024-4577)

**漏洞详情:** [CVE-2024-4577](https://nvd.nist.gov/vuln/detail/CVE-2024-4577)