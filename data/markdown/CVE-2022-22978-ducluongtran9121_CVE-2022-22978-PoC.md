## CVE-2022-22978 - Spring Security Authorization Bypass

**漏洞编号:** CVE-2022-22978

**漏洞类型:** 授权绕过

**影响应用:** Spring Security

**危害等级:** 高危，可能导致未经授权的访问

**影响版本:** Spring Security 5.4.x prior to 5.4.11, 5.5.x prior to 5.5.7, 5.6.x prior to 5.6.4 以及所有更早的未支持版本

**利用条件:** 应用程序使用RegexRequestMatcher，且正则表达式中包含`.`

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2022-22978 漏洞存在于 Spring Security 的 RegexRequestMatcher 类中。当应用程序使用 RegexRequestMatcher，且正则表达式中包含 `.` 时，由于 servlet 容器对换行符处理的差异，攻击者可以通过在 URL 中插入 \r (%0d) 或 \n (%0a) 字符来绕过授权。 

**利用方式：**

1.  应用程序使用 Spring Security，且版本在受影响范围内（5.4.x < 5.4.11, 5.5.x < 5.5.7, 5.6.x < 5.6.4）。
2.  Spring Security 配置中使用了 RegexRequestMatcher 来进行 URL 匹配和授权控制。
3.  RegexRequestMatcher 的正则表达式包含 `.` 字符，用于匹配任意字符。
4.  攻击者构造包含 `%0d` 或 `%0a` 的恶意 URL，例如 `/admin/%0dxyz`。
5.  由于 Spring Security 默认的正则表达式引擎无法正确处理这些换行符，导致授权检查被绕过，攻击者可以访问 `/admin/xyz` 资源，而无需经过身份验证。

**POC有效性分析：**
提供的POC代码通过创建一个简单的 Spring Boot Web 应用程序，并使用 RegexRequestMatcher 配置对 `/admin/*` 路径进行保护。POC 演示了如何在受影响的 Spring Security 版本中，使用 `%0d` 或 `%0a` 绕过授权。因此，提供的 POC 代码是有效的，它重现了漏洞并证明了其可利用性。

**投毒风险分析：**
分析提供的 `build.gradle` 和 `README.md` 文件，以及给出的POC代码，看起来是一个简单的漏洞演示，用于重现和验证 CVE-2022-22978 漏洞。`build.gradle` 文件指定了存在漏洞的 Spring Security 版本（5.6.3），`README.md` 提供了漏洞描述、分析、演示和修复方法。由于是漏洞验证代码，因此作者可能通过一些方式来绕过spring security 的安全验证，从而实现漏洞的验证。虽然该仓库的主要目的是演示漏洞，但仍然存在作者在其他地方（例如图片链接指向恶意网站或在Demo程序埋藏后门）进行投毒的风险，但这种可能性较小。因此，投毒风险约为 5%。

**项目地址:** [ducluongtran9121/CVE-2022-22978-PoC](https://github.com/ducluongtran9121/CVE-2022-22978-PoC)

**漏洞详情:** [CVE-2022-22978](https://nvd.nist.gov/vuln/detail/CVE-2022-22978)