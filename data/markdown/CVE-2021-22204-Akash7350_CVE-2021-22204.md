## CVE-2021-22204-ExifTool-代码执行

**漏洞编号:** CVE-2021-22204

**漏洞类型:** 代码执行

**影响应用:** ExifTool

**危害等级:** 高危，可能导致远程代码执行

**影响版本:** >=7.44, <12.24

**利用条件:** 需要目标系统安装ExifTool，且版本在受影响范围内。攻击者需要能够上传恶意DjVu文件或以其他方式使ExifTool处理该文件。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-22204 是 ExifTool 中 DjVu 文件格式处理不当导致的代码执行漏洞。漏洞存在于 ExifTool 的 DjVu 模块中，当解析恶意图像时，由于用户数据未经过适当的清理，导致 eval 注入。攻击者可以构造一个恶意的 DjVu 文件，其中包含恶意的 Perl 代码。当 ExifTool 解析该文件时，恶意代码会被执行，从而导致任意代码执行。

**有效性：** 根据漏洞库信息和提供的漏洞利用代码，该漏洞是有效的。CISA 已将其添加到已知被利用的漏洞目录中，说明该漏洞在野外已被利用。

**投毒风险：** 提供的exploit.py 主要功能是生成恶意DjVu文件。在分析代码后，发现其主要功能是构建包含恶意perl代码的DjVu文件，并未发现有主动后门代码植入或恶意行为。但是，存在一些风险，例如：

*   **依赖问题：** 脚本依赖于`djvulibre-bin`和`exiftool`，如果用户从非官方源安装这些依赖项，则可能引入恶意代码。
*   **命令注入风险：** 虽然脚本本身看起来没有明显的投毒行为，但是最终执行的命令取决于用户提供的command参数。如果用户提供的命令本身是恶意的，那么就会造成危害。
*   **元数据篡改：** 通过修改图片元数据进行攻击。尽管这个是漏洞的利用方式，但如果攻击者在用户不知情的情况下修改了图片元数据，可能会造成数据篡改。

综合来看，投毒风险较低，主要风险在于用户自己提供的命令和依赖项的来源。

**利用方式：**

1.  攻击者构造一个恶意的 DjVu 文件，该文件包含可以执行任意命令的恶意 Perl 代码。
2.  攻击者诱使用户使用易受攻击的 ExifTool 版本处理该恶意 DjVu 文件。
3.  当 ExifTool 解析该文件时，会执行嵌入的恶意 Perl 代码，从而使攻击者能够在目标系统上执行任意代码。

POC代码中首先检查依赖项是否安装，然后创建一个包含恶意perl代码的DjVu文件，该文件利用了ExifTool中的eval注入漏洞。可以通过提供自定义命令或生成反向shell来利用此漏洞。最后将有效负载插入到JPEG图像中。

**项目地址:** [Akash7350/CVE-2021-22204](https://github.com/Akash7350/CVE-2021-22204)

**漏洞详情:** [CVE-2021-22204](https://nvd.nist.gov/vuln/detail/CVE-2021-22204)