## CVE-2023-46604-Apache ActiveMQ-远程代码执行

**漏洞编号:** CVE-2023-46604

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Apache ActiveMQ

**危害等级:** 高危，可能导致远程代码执行和服务器控制

**影响版本:** 5.15.16之前, 5.16.7之前, 5.17.6之前, 5.18.3之前

**利用条件:** 需要网络访问ActiveMQ broker或client的OpenWire协议端口（默认61616）

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2023-46604是Apache ActiveMQ中Java OpenWire协议marshaller存在的一个远程代码执行漏洞。攻击者可以通过操纵OpenWire协议中的序列化类类型，使broker或client实例化classpath上的任意类，从而执行任意shell命令。

**有效性：**
提供的POC代码利用了Spring的ClassPathXmlApplicationContext来加载远程XML文件，XML文件中定义了ProcessBuilder bean，可以执行任意命令。该POC在多个安全博客和漏洞分析报告中被证实有效，可以实现远程代码执行。

**投毒风险：**
该漏洞利用代码主要由三个文件组成：`README.md`、`main.go`和`poc-linux.xml` (以及 `poc-windows.xml`)。
*   `README.md`: 描述了漏洞利用方法和步骤，包含一些图片和链接。
*   `main.go`: Go语言编写的漏洞利用程序，负责构造和发送OpenWire协议数据包。
*   `poc-linux.xml` (和 `poc-windows.xml`): Spring XML配置文件，定义了执行命令的ProcessBuilder bean。

分析代码后，发现主要风险在于远程加载的XML文件。如果XML文件被替换为恶意文件，则可能导致攻击者执行其他恶意操作。例如，执行下载并运行恶意软件，或者修改系统配置等。`main.go`本身没有明显的投毒代码，但它允许从远程URL加载XML，这引入了间接的投毒可能性。 `poc-linux.xml` 默认从指定IP的8001端口下载 test.elf 文件并执行。如果该IP被恶意人员控制，可能导致下载恶意文件。
考虑到利用依赖外部XML文件和下载的elf文件，如果这些文件被替换，则存在潜在的风险。由于`main.go`文件本身比较简单，直接被投毒的可能性较低。

**利用方式：**
1.  攻击者首先需要找到存在漏洞的ActiveMQ broker或client，目标版本在受影响的版本范围内。
2.  攻击者准备一个恶意的Spring XML配置文件，其中包含执行任意命令的ProcessBuilder bean。
3.  攻击者启动一个HTTP服务器，托管该XML文件。
4.  攻击者使用POC代码，指定目标ActiveMQ服务器的IP地址和XML文件的URL。
5.  POC代码会构造一个包含恶意XML文件URL的OpenWire协议数据包，并将其发送到目标服务器。
6.  目标服务器收到数据包后，会尝试反序列化数据，并加载远程XML文件。
7.  Spring框架会解析XML文件，并实例化ProcessBuilder bean，执行XML中定义的命令，从而实现远程代码执行。

通过搜索结果可以发现，该漏洞已经被广泛利用，被多个恶意软件家族利用，例如Kinsing和Ransomware。

**项目地址:** [SaumyajeetDas/CVE-2023-46604-RCE-Reverse-Shell-Apache-ActiveMQ](https://github.com/SaumyajeetDas/CVE-2023-46604-RCE-Reverse-Shell-Apache-ActiveMQ)

**漏洞详情:** [CVE-2023-46604](https://nvd.nist.gov/vuln/detail/CVE-2023-46604)