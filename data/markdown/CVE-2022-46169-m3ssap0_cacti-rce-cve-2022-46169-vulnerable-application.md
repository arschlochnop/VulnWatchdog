## CVE-2022-46169 - Cacti 未授权命令注入

**漏洞编号:** CVE-2022-46169

**漏洞类型:** 命令注入

**影响应用:** Cacti

**危害等级:** 高危，允许未授权用户执行任意代码

**影响版本:** < 1.2.23

**利用条件:** 需要目标系统运行受影响的Cacti版本，且存在 action 类型为 POLLER_ACTION_SCRIPT_PHP (2) 的 poller_item 配置。

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2022-46169 是 Cacti 1.2.23 之前版本中存在的一个未授权命令注入漏洞。攻击者可以通过利用 `remote_agent.php` 文件的认证绕过漏洞，结合 `polldata` 操作，最终实现命令注入。漏洞利用流程如下：

1.  **认证绕过：** 攻击者通过伪造 `HTTP_` 请求头（例如 `Forwarded-For`），使得 `get_client_addr` 函数返回 Cacti 服务器自身的 IP 地址。这样，后续的 hostname 检查会被绕过，从而无需认证即可访问 `remote_agent.php`。
2.  **触发 polldata 操作：** 成功绕过认证后，攻击者可以调用 `remote_agent.php` 的 `polldata` 操作。
3.  **命令注入：** `poll_for_data` 函数从请求参数中获取 `poller_id`，该参数没有经过充分过滤，直接拼接到 `proc_open` 函数的参数中，导致命令注入。
4.  **条件：** 漏洞触发需要数据库中存在 action类型为`POLLER_ACTION_SCRIPT_PHP` (`2`)的`poller_item`。

**POC 代码分析：**

提供的 Dockerfile 构建了一个易受攻击的 Cacti 1.2.22 环境，用于漏洞测试。该 Dockerfile 主要完成了以下工作：

*   安装必要的依赖项，例如 `rrdtool`、`mariadb-server`、`snmp` 等。
*   配置 PHP 扩展。
*   从 GitHub 克隆 Cacti 1.2.22 版本的代码。
*   配置 Cacti 数据库和初始化脚本。
*   配置 cron 任务来运行 `poller.php`。

**有效性评估：**

根据漏洞描述和 POC 代码，可以判断该漏洞利用的有效性很高。POC 代码提供了一个可复现的环境，方便研究人员进行漏洞测试和利用。

**投毒风险评估：**

该存储库中的投毒风险较低（约 5%）。理由如下：

*   Dockerfile 内容清晰：Dockerfile 中的指令主要用于构建 Cacti 运行环境，没有发现任何可疑的恶意代码或后门。 *   cacti.sql 来源于官方github仓库，该文件被篡改风险较低。 *   config.php主要是数据库配置，不具备投毒条件。
*   README.md 包含警告信息：该文件明确指出此应用包含安全漏洞，并建议在受保护的环境中运行，降低了恶意使用的可能性。
*   LICENSE 使用的是公共领域许可证：这表明作者放弃了对代码的版权，鼓励自由使用和修改，但同时也增加了代码被滥用的风险。

尽管如此，仍然存在一些潜在的风险：

*   依赖项可能存在漏洞：Dockerfile 中安装的软件包可能存在未知的安全漏洞，攻击者可以通过这些漏洞入侵系统。 *   配置错误：不正确的 Cacti 配置可能导致安全问题。

**总体来说，该存储库的投毒风险较低，但仍需谨慎使用，并及时更新依赖项以避免潜在的安全风险。**

**项目地址:** [m3ssap0/cacti-rce-cve-2022-46169-vulnerable-application](https://github.com/m3ssap0/cacti-rce-cve-2022-46169-vulnerable-application)

**漏洞详情:** [CVE-2022-46169](https://nvd.nist.gov/vuln/detail/CVE-2022-46169)