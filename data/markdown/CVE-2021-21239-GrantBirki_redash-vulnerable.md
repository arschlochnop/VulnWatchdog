## CVE-2021-21239-pysaml2-签名绕过

**漏洞编号:** CVE-2021-21239

**漏洞类型:** 签名绕过

**影响应用:** pysaml2

**危害等级:** 中危，可能导致身份认证绕过，进而未授权访问

**影响版本:** < 6.5.0

**利用条件:** 目标系统使用pysaml2作为SAML认证库，并且使用默认的CryptoBackendXmlSec1后端。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-21239是pysaml2中的一个签名验证漏洞。攻击者可以通过构造恶意的SAML响应，利用xmlsec1默认接受任意类型密钥的特性，嵌入RSA密钥并绕过签名验证。  

**有效性：**
根据漏洞库信息、搜索引擎结果和提供的PoC代码，可以判断此漏洞是有效的。漏洞库信息明确指出pysaml2 < 6.5.0 存在签名验证问题，且有公开的PoC可以利用。

**利用方式：**
PoC代码 `poc.py` 展示了如何构造恶意的SAML响应。其利用方式为：
1.  生成一个用于伪造签名使用的RSA密钥对。
2.  构造一个包含恶意断言（Assertion）的SAML响应，将攻击者的公钥嵌入到`KeyInfo`标签的`KeyValue`中，而非使用X.509证书。
3.  由于`xmlsec1`默认接受嵌入的RSA密钥，因此在服务端验证签名时，会使用攻击者提供的公钥进行验证，从而绕过正常的证书验证。
4.  将构造的SAML响应发送到目标Redash服务器的SAML回调地址，实现身份认证绕过。

**投毒风险：**
虽然提供的`docker-compose.yml` 和 `README.md`文件可能包含配置相关的信息，帮助搭建漏洞环境，但是核心的攻击代码在`poc.py`中。 检查`poc.py`，发现其主要逻辑是构造恶意的SAML响应以利用漏洞。代码本身没有明显的后门或恶意行为。`docker-compose.yml`中使用的是redash/redash:10.0.0.b50363这个镜像，这是一个公开的Redash镜像，降低了投毒的可能。但是，仍然存在一定的投毒风险，例如：
1.  作者可能在`script/server`脚本中添加了恶意代码。
2.  docker-compose.yml文件中指定的redash镜像可能被篡改。

考虑到redash镜像的公开性和poc.py代码的相对简单性，以及脚本文件中可能存在的隐蔽风险，因此投毒风险较低，估计为10%。

**项目地址:** [GrantBirki/redash-vulnerable](https://github.com/GrantBirki/redash-vulnerable)

**漏洞详情:** [CVE-2021-21239](https://nvd.nist.gov/vuln/detail/CVE-2021-21239)