## CVE-2022-42889-Apache Commons Text-RCE

**漏洞编号:** CVE-2022-42889

**漏洞类型:** 远程代码执行(RCE)

**影响应用:** Apache Commons Text

**危害等级:** 高危，允许未授权的攻击者执行任意代码

**影响版本:** 1.5 <= version <= 1.9

**利用条件:** 应用程序使用受影响版本的Apache Commons Text, 并且允许变量插值处理不受信任的输入。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2022-42889，也被称为Text4Shell，是一个存在于Apache Commons Text库中的高危漏洞。该漏洞源于库中不安全的变量插值默认设置。攻击者可以通过构造包含恶意表达式的输入，利用`${prefix:name}`格式进行插值，触发远程代码执行。

**有效性：** 根据漏洞库信息和搜索结果，该漏洞利用是有效的，并且影响Apache Commons Text 1.5到1.9版本。提供的POC代码尝试利用`script`, `url` 和 `dns` 等 lookup 实现远程代码执行。

**投毒风险：**
*   POC代码本身的主要目的是为了验证漏洞的存在，利用interactsh来验证命令执行。投毒风险评估较低，约为10%。
*   投毒风险主要来自以下方面：虽然POC主要目的是进行漏洞验证，但如果使用者不小心，直接在生产环境运行，可能会造成破坏。此外，攻击者可能修改POC代码，添加恶意功能，例如植入后门，并传播修改后的POC。
*   代码中使用了 `ping` 命令进行验证，这本身没有危害，但恶意修改者可能替换成更危险的命令。

**利用方式：**
1.  **漏洞定位：** 确定目标应用程序使用了Apache Commons Text 1.5到1.9的受影响版本。
2.  **构造Payload：** 构造包含恶意表达式的输入字符串，利用`${script:javascript:java.lang.Runtime.getRuntime().exec('command')}`, `${url:UTF-8:java.lang.Runtime.getRuntime().exec('command')}` 或者 `${dns:address:java.lang.Runtime.getRuntime().exec('command')}` 这样的格式。
3.  **发送Payload：** 将构造的Payload作为输入发送到目标应用程序，例如通过HTTP请求的查询参数或User-Agent头。
4.  **执行代码：** 如果应用程序使用Commons Text对Payload进行变量插值，恶意代码将被执行。
5.  **验证：** 使用interactsh等工具验证代码是否成功执行。例如, 通过DNS请求或者ping命令。

**缓解措施：**
*   升级到Apache Commons Text 1.10.0或更高版本，该版本默认禁用了有问题的插值器。
*   如果无法升级，可以配置`StringLookupFactory`以禁用`script`、`dns`和`url`查找。
*   对所有用户输入进行严格的验证和清理，避免将不受信任的数据传递给Commons Text进行处理。

**项目地址:** [gokul-ramesh/text4shell-exploit](https://github.com/gokul-ramesh/text4shell-exploit)

**漏洞详情:** [CVE-2022-42889](https://nvd.nist.gov/vuln/detail/CVE-2022-42889)