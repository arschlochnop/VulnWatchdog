## CVE-2020-7247-OpenSMTPD-远程命令执行

**漏洞编号:** CVE-2020-7247

**漏洞类型:** 远程命令执行

**影响应用:** OpenSMTPD

**危害等级:** 高危，可能导致完全控制受影响的服务器

**影响版本:** < 6.6.2

**利用条件:** 需要目标服务器运行OpenSMTPD服务，且配置为默认的未注释配置

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2020-7247 存在于OpenSMTPD 6.6.2之前的版本中。攻击者可以通过在`MAIL FROM`字段中注入shell元字符，利用SMTP会话执行任意系统命令，获得root权限。漏洞的根本原因是程序没有充分过滤用户可控的输入。

**有效性:** 提供的POC代码（poc1.py）看起来是有效的。它使用`pwn`库来建立与目标SMTP服务器的连接，并发送一系列SMTP命令，其中`MAIL FROM`命令包含恶意shell代码。如果目标服务器存在漏洞，这段代码将执行任意命令。

**投毒风险:**  POC代码主要目的是利用该漏洞，实现远程命令执行。其中值得关注的点：

*   **使用mkfifo创建管道:** 代码使用`mkfifo`创建一个命名管道`/tmp/nnwo`，然后使用`nc`将命令发送到该管道，并通过`/bin/sh`执行，最后将结果重定向到该管道，并将错误信息也重定向。这个过程本身是为了建立一个反向shell。
*   **清除痕迹:** 代码尝试在攻击完成后通过`pkill nc`清除网络连接的痕迹。


以下情况可以视为潜在的投毒代码风险：

* **恶意payload替换：** POC中可以使用更具破坏性的命令，例如删除关键系统文件或者植入长期后门程序。
* **后门植入：**  虽然`pkill nc`试图清除痕迹，但更隐蔽的后门可能被安装，以便后续访问。

综合考虑，该POC主要是为了验证漏洞的存在并执行命令。但是，因为执行了网络连接和创建管道等操作，存在一定被滥用和修改为更具恶意目的的可能性。 因此，将其判定为有 **10%** 的投毒风险。

**利用方式:**

1.  **建立SMTP连接:** 使用`pwn`库与目标OpenSMTPD服务器建立TCP连接。
2.  **发送SMTP命令序列:** 发送`HELO`、`MAIL FROM`、`RCPT TO`和`DATA`等SMTP命令。
3.  **注入恶意代码:** 在`MAIL FROM`命令中，通过注入shell元字符，构造恶意shell命令。例如，``MAIL FROM:<;for i in r j A F L X;do read;done;sh;exit 0;>``
4.  **发送Payload:** 在`DATA`命令之后，发送实际要执行的命令。POC中使用`mkfifo`和`nc`来建立反向shell连接。
5.  **监听反向Shell:** 攻击者在本地主机上使用`nc`监听指定的端口，等待目标服务器建立连接，从而获得shell访问权限。
6.  **清理痕迹:** 攻击完成后，尝试清除在目标系统上留下的痕迹（如通过`pkill nc`杀死nc进程）。

**项目地址:** [superzerosec/cve-2020-7247](https://github.com/superzerosec/cve-2020-7247)

**漏洞详情:** [CVE-2020-7247](https://nvd.nist.gov/vuln/detail/CVE-2020-7247)