## CVE-2022-22947 Spring Cloud Gateway 代码注入

**漏洞编号:** CVE-2022-22947

**漏洞类型:** 代码注入

**影响应用:** Spring Cloud Gateway

**危害等级:** 高危，可能导致远程代码执行

**影响版本:** Spring Cloud Gateway < 3.1.1, Spring Cloud Gateway < 3.0.7

**利用条件:** Gateway Actuator endpoint 启用、暴露且未进行安全保护

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2022-22947是Spring Cloud Gateway中的一个代码注入漏洞。当Gateway Actuator endpoint启用、暴露且未进行安全保护时，远程攻击者可以发送特制的恶意请求，利用SpEL表达式注入执行任意代码。

**有效性：**
提供的POC代码是有效的。从搜索引擎结果和漏洞利用代码来看，该漏洞利用方式已经公开，并且存在可用的PoC。

**投毒风险：**
提供的漏洞利用代码主要包含以下内容：
1.  README文件，描述了漏洞信息，受影响版本，修复建议等。
2.  漏洞复现步骤，包含发送恶意请求添加路由，刷新路由，查看结果，清理路由等步骤说明，以及对应的数据包示例。
3.  Python脚本，用于自动化漏洞利用过程，通过构造恶意请求实现远程代码执行。

分析代码，主要风险在于攻击者可能将恶意代码隐藏在SpEL表达式中，例如执行反弹shell或下载恶意软件。在提供的代码中，`Spring Cloud Gateway Actuator API SpEL表达式注入命令执行（CVE-2022-22947）.md`文件中展示的PoC中使用了`#{new java.lang.String(T(org.springframework.util.StreamUtils).copyToByteArray(T(java.lang.Runtime).getRuntime().exec(new String[]{"id"}).getInputStream()))}`，该payload用于执行`id`命令，若替换为其他命令，存在潜在的风险。

**利用方式：**
1.  攻击者首先发送POST请求到`/actuator/gateway/routes/{route_id}`，创建一个包含恶意SpEL表达式的路由。SpEL表达式被嵌入到`filters`的`AddResponseHeader`的`value`参数中，用于执行任意命令。
2.  然后，攻击者发送POST请求到`/actuator/gateway/refresh`，强制网关刷新路由配置，触发SpEL表达式的执行。
3.  攻击者发送GET请求到`/actuator/gateway/routes/{route_id}`，查看执行结果。
4.  最后，攻击者发送DELETE请求到`/actuator/gateway/routes/{route_id}`，删除恶意路由。

综上所述，该漏洞利用的有效性较高。虽然存在一定的投毒风险（10%），但可以通过仔细审查和修改PoC代码来降低风险。

**项目地址:** [kmahyyg/CVE-2022-22947](https://github.com/kmahyyg/CVE-2022-22947)

**漏洞详情:** [CVE-2022-22947](https://nvd.nist.gov/vuln/detail/CVE-2022-22947)