## CVE-2023-34468: Apache NiFi H2 JDBC URL 远程代码执行

**漏洞编号:** CVE-2023-34468

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Apache NiFi

**危害等级:** 高危，可能导致服务器完全控制

**影响版本:** 0.0.2 <= version <= 1.21.0

**利用条件:** 需要经过身份验证和授权的用户，能够配置数据库连接池服务

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2023-34468 允许经过身份验证和授权的用户，通过配置使用H2数据库驱动的数据库URL，来执行自定义代码。漏洞存在于Apache NiFi的DBCPConnectionPool和HikariCPConnectionPool控制器服务中。攻击者可以构造包含恶意代码的H2 JDBC URL，NiFi在尝试建立数据库连接时执行该代码。漏洞利用需要有效的NiFi用户凭据，并且需要有权限配置Controller Services。

根据GitHub仓库信息，POC利用的详细步骤和方法可以在提供的PDF文档中找到。Metasploit中也有相关的利用模块。

关于投毒风险的评估：该漏洞利用代码仓库主要包含一个README.md文件和一个PDF文档的链接。由于POC本身利用了H2数据库的特性来实现RCE，不能简单地将利用代码执行后的恶意行为判定为“投毒”。然而，考虑到攻击者可能修改提供的PDF文档或利用仓库进行其他恶意活动(例如，提供修改过的NiFi安装包)，存在一定的投毒风险。这里给予一个较低的概率，大概为10%。

利用方式总结：
1. 攻击者需要拥有一个具有配置Controller Services权限的Apache NiFi账户。
2. 攻击者配置一个DBCPConnectionPool或者HikariCPConnectionPool，并设置数据库连接URL为恶意的H2 JDBC URL。例如，使用 `jdbc:h2:mem:testdb;MODE=MySQL;init=CREATE ALIAS SHELLEXEC AS $$ String shellexec(String cmd) throws java.io.IOException { Runtime.getRuntime().exec(cmd); return ""; } $$;CALL SHELLEXEC('touch /tmp/success');`。这段代码会在服务器上创建一个 `/tmp/success` 文件。
3. NiFi尝试连接数据库时，H2会执行URL中包含的恶意代码，从而实现远程代码执行。
4. NiFi 1.22.0 及以后版本通过验证数据库URL来缓解这个问题，但是后续又发现CVE-2023-40037漏洞可以绕过这些安全措施，影响版本直到1.23.0。

根据搜索结果，已经有公开的漏洞分析报告和利用代码，并且有Metasploit模块可用，因此漏洞的利用难度较低，攻击有效性较高。

**项目地址:** [mbadanoiu/CVE-2023-34468](https://github.com/mbadanoiu/CVE-2023-34468)

**漏洞详情:** [CVE-2023-34468](https://nvd.nist.gov/vuln/detail/CVE-2023-34468)