## CVE-2021-41163-Discourse-RCE

**漏洞编号:** CVE-2021-41163

**漏洞类型:** 远程代码执行

**影响应用:** Discourse

**危害等级:** 高危，可导致服务器被完全控制

**影响版本:** < 2.7.9 (stable), < 2.8.0.beta7 (beta and tests-passed)

**利用条件:** 需要用户具有导入主题的权限（通常是管理员权限，但可能存在权限配置不当的情况）

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-41163 存在于 Discourse 的主题导入功能中。攻击者可以创建一个包含恶意 JavaScript 和 CSS 代码的主题 ZIP 文件，通过导入该主题，利用 Discourse 对主题文件验证不足的缺陷，实现远程代码执行。该漏洞的利用方式主要包括以下步骤：

1.  **获取 CSRF Token：** 通过访问 Discourse 网站，提取 CSRF Token，用于后续的认证请求。
2.  **创建恶意主题：** 创建包含恶意 JavaScript (evil.js) 和 CSS (evil.css) 代码的主题 ZIP 文件。evil.js 中的 payload 尝试利用 Node.js 的 `child_process` 模块执行系统命令（如 `id`），读取敏感文件（如 `/etc/passwd`），获取环境变量，并将结果发送到攻击者的服务器。同时，窃取管理员 Cookie 和 CSRF Token。evil.css 尝试使用 `javascript:` URL 进行 XSS 攻击。
3.  **上传恶意主题：** 利用 Discourse 的主题导入功能，将恶意主题 ZIP 文件上传到服务器。
4.  **触发漏洞：** 上传成功后，Discourse 会解析并应用该主题，恶意 JavaScript 和 CSS 代码会被执行，从而实现远程代码执行。

**有效性：** 根据漏洞信息和漏洞利用代码来看，该POC代码是有效的。漏洞库信息表明该漏洞是由于对 `subscribe_url` 值的验证不足造成的，而POC代码利用了主题导入功能，通过上传包含恶意代码的主题来实现RCE，这与漏洞描述相符。搜索引擎结果中也提到了该漏洞的严重性和修复紧急性，进一步验证了该漏洞的有效性。

**投毒风险：** 该POC代码存在一定的投毒风险。虽然主要功能是利用 CVE-2021-41163 漏洞，但 `evil.js` 中的 payload 包含以下可能被滥用的代码：

*   尝试将执行结果（如 `id` 命令的输出、`/etc/passwd` 文件内容）发送到 `evil.com`。这可能被用于窃取敏感信息。
*   尝试窃取 Cookie 和 CSRF Token 并发送到 `evil.com`。这可能被用于冒充管理员执行操作。

虽然这些功能是为了验证漏洞，但恶意攻击者可能会修改 `evil.com` 为自己的服务器，从而利用此 POC 代码进行实际攻击。因此，存在一定程度的投毒风险，大约为 10%。（这个比例表示代码本身有作为后门使用的可能性，但主要目的还是漏洞验证。）

**利用方式总结：**

1.  攻击者首先需要获得一个有效的Discourse账号,并拥有导入主题的权限(通常为管理员)。
2.  使用POC脚本生成包含恶意代码的主题文件。
3.  利用Discourse后台主题上传功能上传恶意主题文件。
4.  成功上传后,恶意代码被执行,攻击者可以远程执行任意命令，读取服务器敏感数据，控制服务器。
5.  `evil.com` 可以被替换为攻击者自己的服务器，以便收集被攻击系统的敏感信息。


**项目地址:** [ibrahmsql/CVE-2021-41163](https://github.com/ibrahmsql/CVE-2021-41163)

**漏洞详情:** [CVE-2021-41163](https://nvd.nist.gov/vuln/detail/CVE-2021-41163)