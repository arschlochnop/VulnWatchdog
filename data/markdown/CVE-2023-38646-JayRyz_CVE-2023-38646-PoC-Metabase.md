## CVE-2023-38646-Metabase-RCE

**漏洞编号:** CVE-2023-38646

**漏洞类型:** 远程代码执行(RCE)

**影响应用:** Metabase

**危害等级:** 高危，未经身份验证的远程代码执行

**影响版本:** Metabase open source < 0.46.6.1 和 Metabase Enterprise < 1.46.6.1

**利用条件:** 目标Metabase实例运行在受影响版本，且网络可达。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2023-38646 漏洞允许未经身份验证的攻击者在Metabase服务器上执行任意命令。根据漏洞库信息和搜索引擎结果，此漏洞影响Metabase开源版本低于0.46.6.1和Metabase企业版本低于1.46.6.1。

**利用方式：**

1.  **获取Setup Token：** 利用 PoC 代码中的 `get_token` 函数，通过访问 `/api/session/properties` 接口获取 setup-token。
2.  **构造恶意Payload：** 利用获取的 setup-token, 构造包含恶意命令的payload。PoC 代码使用 H2 数据库的特性，在数据库连接字符串中嵌入恶意 SQL 语句，该语句创建一个触发器（TRIGGER），在触发器中执行命令。命令使用了反弹shell的技术。 首先将要执行的shell命令进行base64编码, 然后利用`java.lang.Runtime.getRuntime().exec()` 来执行命令。
3.  **发送Exploit：** 通过 POST 请求将构造的 payload 发送到 Metabase 服务器。
4.  **反弹 Shell：** 攻击者使用 `nc` 监听指定端口，等待目标服务器执行命令后反弹 shell。

**有效性：**

根据提供的漏洞信息和PoC代码，此漏洞的利用是有效的。漏洞库信息明确指出无需身份验证即可利用此漏洞执行任意命令。搜索引擎结果中也包含大量关于此漏洞的分析和利用文章，进一步验证了其有效性。PoC代码提供了自动化利用的脚本。

**投毒风险：**

提供的 PoC 代码中存在潜在的投毒风险。虽然主要功能是利用漏洞，但代码中可能包含以下潜在风险：

*   **反弹 Shell 地址：** PoC 代码允许用户指定反弹 shell 的 IP 地址和端口，但如果用户不小心使用了攻击者控制的 IP 地址和端口，可能会被反弹 shell，导致自身系统被攻击者控制。
*   **其他恶意命令：**  攻击者可能会修改 PoC 代码，添加额外的恶意命令，例如删除文件、修改系统配置等。代码中的`convert_command`函数和`create_payload`函数可以被修改注入恶意代码。
*   **依赖项风险：** 虽然PoC代码依赖的requests库本身风险较低，但是如果攻击者提供修改过的poc,增加其他恶意依赖库, 可能会存在安全风险。

综合分析，投毒风险评估为 10%，主要风险集中在用户错误使用或恶意修改 PoC 代码的可能性上。

**项目地址:** [JayRyz/CVE-2023-38646-PoC-Metabase](https://github.com/JayRyz/CVE-2023-38646-PoC-Metabase)

**漏洞详情:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)