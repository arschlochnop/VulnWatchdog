## CVE-2017-16995 - Linux Kernel eBPF 权限提升

**漏洞编号:** CVE-2017-16995

**漏洞类型:** 权限提升

**影响应用:** Linux Kernel

**危害等级:** 高危，允许本地非特权用户获得 root 权限

**影响版本:** <= 4.4

**利用条件:** 需要目标系统运行受影响的 Linux kernel 版本，并且启用 BPF syscall (CONFIG_BPF_SYSCALL)

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2017-16995 漏洞存在于 Linux 内核的 eBPF 验证器模块中。`check_alu_op` 函数在验证 eBPF 程序时，由于符号扩展处理不当，可能导致计算错误，使得攻击者可以构造恶意的 BPF 程序，进而实现任意内存读写。

**利用方式：**

1.  **构造恶意 eBPF 程序：** 攻击者编写一个特殊的 eBPF 程序，利用验证器中的符号扩展漏洞，使其能够执行非法操作。
2.  **加载 eBPF 程序：** 攻击者通过 `bpf(2)` 系统调用将恶意的 eBPF 程序加载到内核中。
3.  **触发漏洞：** 当内核执行该 eBPF 程序时，验证器中的漏洞会被触发，导致内存破坏或任意内存读写。
4.  **权限提升：** 利用任意内存读写，攻击者可以修改当前进程的 `cred` 结构体中的 UID、GID 等信息，将其修改为 root 用户的 UID 和 GID，从而获得 root 权限。

**有效性评估：**

提供的 POC 代码（`exploit.c`）针对 Ubuntu 16.04.4 (kernel 4.4.0-116-generic) 进行了测试，并成功实现了权限提升。代码通过构造恶意的 BPF 程序，覆盖当前进程的 `cred` 结构，将用户 ID 修改为 0，从而获得 root 权限。根据漏洞库信息和搜索结果，此漏洞利用方式是有效的，并存在多个公开可用的exploit。

**投毒风险分析：**

POC 代码 `exploit.c` 看起来比较直接，主要逻辑是构造 BPF 程序，并利用漏洞修改 `cred` 结构。`README.md` 文件也提供了漏洞描述、演示、修复建议和相关链接。 但是，由于eBPF程序本身较为复杂，且涉及到直接的内存操作，仍然存在一些潜在的投毒风险。

1.  **隐藏的后门代码：** 攻击者可能在 BPF 程序中嵌入一些不易察觉的指令，例如在提权之外，额外修改其他内核数据结构，造成系统不稳定或者为后续攻击留下后门。
2.  **特定环境依赖：** 攻击者可能使 exploit 只能在特定内核版本或配置下运行，如果用户在不兼容的环境下运行 exploit，可能会导致系统崩溃。

总的来说，虽然 POC 代码表面上看起来安全，但考虑到 BPF 程序的复杂性和内核利用的风险，投毒风险仍然存在，比例大约为 10%。 需要对代码进行深入分析才能完全排除风险。

**项目地址:** [C0dak/CVE-2017-16995](https://github.com/C0dak/CVE-2017-16995)

**漏洞详情:** [CVE-2017-16995](https://nvd.nist.gov/vuln/detail/CVE-2017-16995)