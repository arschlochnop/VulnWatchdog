## CVE-2021-25646 Apache Druid RCE

**漏洞编号:** CVE-2021-25646

**漏洞类型:** 远程代码执行

**影响应用:** Apache Druid

**危害等级:** 高危，可能导致服务器被完全控制

**影响版本:** <= 0.20.0

**利用条件:** 需要目标Druid服务器运行在受影响版本，且攻击者需要具有经过身份验证的用户权限，或者服务器未配置身份验证。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-25646 允许经过身份验证的用户通过构造特殊的请求来执行任意 JavaScript 代码，即使服务器配置禁用了该功能。根据漏洞库信息和搜索结果，利用方式主要是通过发送包含恶意 JavaScript 代码的 HTTP 请求，该代码会在 Druid 服务器上执行，从而实现远程代码执行。提供的 POC 代码展示了一个 POST 请求，其中包含一个 JSON payload，该 payload 利用了 Druid 的 indexer API 和 JavaScript filter 功能来执行任意命令。攻击者可以通过修改 POC 代码中的 JavaScript 函数，来执行不同的恶意操作。 

**有效性：**

根据漏洞库信息、搜索结果以及提供的 POC 代码，此漏洞的利用是有效的。大量的安全博客和漏洞分析报告都证实了该漏洞的存在和可利用性。

**投毒风险：**

该仓库中存在作者隐藏投毒代码的风险较低。POC 本身的功能是执行任意命令，示例中是下载并执行一个 shell 脚本。如果作者将这个 shell 脚本替换为恶意脚本，则会存在投毒风险。但目前提供的readme文件仅仅只是一个命令执行的演示，没有恶意投毒迹象。因此，投毒风险评估为10%，主要考虑到潜在的脚本替换风险。

**利用方式：**

1.  **身份验证：** 首先，攻击者需要获得 Druid 集群的身份验证权限。如果 Druid 集群未启用身份验证，则可以跳过此步骤。
2.  **构造恶意请求：** 攻击者需要构造一个包含恶意 JavaScript 代码的 HTTP POST 请求。请求的目标端点是 `/druid/indexer/v1/sampler?for=filter`。
3.  **注入恶意代码：** 在请求的 JSON payload 中，需要将恶意 JavaScript 代码注入到 transformSpec.filter.function 字段中。该 JavaScript 代码将使用 java.lang.Runtime.getRuntime().exec() 执行任意命令。
4.  **发送请求：** 将构造好的 HTTP 请求发送到目标 Druid 服务器。
5.  **代码执行：** Druid 服务器将执行请求中包含的 JavaScript 代码，从而在服务器上执行任意命令。
6.  **反弹shell:** 通过执行wget和sh命令，下载恶意脚本，从而控制服务器。

**项目地址:** [lp008/CVE-2021-25646](https://github.com/lp008/CVE-2021-25646)

**漏洞详情:** [CVE-2021-25646](https://nvd.nist.gov/vuln/detail/CVE-2021-25646)