## CVE-2022-22947-Spring Cloud Gateway-代码注入

**漏洞编号:** CVE-2022-22947

**漏洞类型:** 代码注入

**影响应用:** Spring Cloud Gateway

**危害等级:** 高危，可远程代码执行

**影响版本:** 3.1.0, 3.0.0 至 3.0.6, 以及更早的不受支持版本

**利用条件:** Gateway Actuator 端点已启用、暴露且未受保护

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2022-22947 是 Spring Cloud Gateway 中的一个代码注入漏洞。当 Gateway Actuator 端点被启用、暴露且未受保护时，攻击者可以利用此漏洞发送恶意构造的请求，从而在远程主机上执行任意代码。

**有效性：**
提供的 POC 代码有效。它通过向 `/actuator/gateway/routes/{id}` 发送 POST 请求动态添加一个路由，该路由包含一个利用 SpEL 表达式执行命令的 filter。然后，通过 `POST /actuator/gateway/refresh` 刷新路由缓存来触发 SpEL 表达式的执行，从而实现远程代码执行。

**投毒风险：**
该漏洞利用代码仓库存在一定的投毒风险。具体分析如下：

1.  **依赖项版本：** POC 使用了 `spring-cloud-gateway-server` 和 `spring-cloud-starter-gateway` 的 3.0.6 版本，以及 `spring-boot-starter-actuator` 的 2.5.9 版本，这些版本组合是已知的漏洞版本，是复现漏洞的必要条件，不是投毒。
2.  **图片文件：** README.md 中引用了一些本地图片，这些图片可能包含恶意内容，但考虑到是本地图片，可能性较低。需要进一步分析确认。
3.  **漏洞利用方式：** POC 演示了如何利用 SpEL 表达式执行任意命令。攻击者可以修改 SpEL 表达式来执行恶意操作，例如安装后门程序、窃取敏感数据或进行拒绝服务攻击。
4.  **作者动机未知：** 在没有更多信息的情况下，无法确定作者的真实意图，不能排除作者故意引入恶意代码或配置的可能。

综合考虑，虽然 POC 本身是为了演示漏洞，但仓库中可能隐藏着其他恶意代码，因此存在一定的投毒风险。鉴于图片等本地资源可能存在风险，因此给出 10% 的投毒风险评估。

**利用方式：**

1.  **前提条件：** Spring Cloud Gateway 实例必须启用并暴露 Actuator 端点，且未进行安全保护。
2.  **添加路由：** 攻击者发送 POST 请求到 `/actuator/gateway/routes/{id}`，其中 `{id}` 是一个自定义的路由 ID。请求体包含一个 JSON 对象，该对象定义了路由的 predicates 和 filters。其中，filters 包含一个 AddResponseHeader filter，其 `value` 属性包含一个 SpEL 表达式，该表达式将执行任意命令。
3.  **刷新路由：** 攻击者发送 POST 请求到 `/actuator/gateway/refresh` 以刷新路由缓存。这将导致 Spring Cloud Gateway 重新加载路由配置，并解析和执行 SpEL 表达式。
4.  **代码执行：** SpEL 表达式执行任意代码，从而允许攻击者控制受影响的系统。

**项目地址:** [Enokiy/cve-2022-22947-spring-cloud-gateway](https://github.com/Enokiy/cve-2022-22947-spring-cloud-gateway)

**漏洞详情:** [CVE-2022-22947](https://nvd.nist.gov/vuln/detail/CVE-2022-22947)