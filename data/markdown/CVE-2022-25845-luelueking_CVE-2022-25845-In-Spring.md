## CVE-2022-25845-Fastjson-反序列化

**漏洞编号:** CVE-2022-25845

**漏洞类型:** 反序列化

**影响应用:** Fastjson

**危害等级:** 高危，可能导致远程代码执行

**影响版本:** < 1.2.83

**利用条件:** 需要目标应用使用存在漏洞的Fastjson版本，并且未启用safeMode。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2022-25845 是一个 Fastjson 的反序列化漏洞，攻击者可以通过绕过 autoType 检查机制，实现远程代码执行。根据提供的漏洞库信息和搜索引擎结果，该漏洞的威胁较高，存在公开的POC。提供的POC代码利用了`java.io.InputStream`、`org.apache.commons.io`等类，结合file协议读取敏感文件内容，然后写入恶意字节码到服务器，最后触发恶意类加载执行，从而实现远程代码执行。 

**有效性评估：**
提供的POC代码看起来是有效的，因为它详细描述了利用步骤，包括将 java.io.InputStream 加入 fastjson autotype 缓存，使用 file 协议读取文件，写入恶意字节码，并最终触发恶意类加载。Dockerfile 提供了运行环境，也说明了有效性。

**投毒风险分析：**
虽然POC本身是为了验证漏洞，但也存在潜在的投毒风险。风险主要来源于以下几个方面：
1.  **恶意代码注入：**  虽然POC中提供了利用链，但是实际使用时，攻击者可以将`${shellcode}`替换为任意恶意代码，例如植入后门、窃取数据等。因为代码涉及动态写入文件，因此存在一定风险。
2.  **依赖污染：**  虽然POM文件声明了commons-io依赖，但是如果引入了其他不必要的、存在已知漏洞的依赖，也可能造成安全隐患。当前POM文件比较简洁，风险较低。
3. **隐藏Payload:** POC中的ClassLoader可能加载执行一些未知的类或恶意代码。 

总体评估，投毒风险约为10%。风险主要来源于使用者可能将`${shellcode}`替换为恶意代码。

**利用方式总结：**

1.  **绕过autoTypeCheck：**  该漏洞的关键在于绕过了 Fastjson 的 autoTypeCheck 机制，允许反序列化某些被限制的类。
2.  **利用java.io.InputStream和org.apache.commons-io：**  POC 利用这些类，结合 file 协议读取服务器上的敏感文件，比如tomcat的docBase路径等。
3.  **写入恶意文件：**  利用反序列化漏洞，将恶意的字节码写入到服务器的web目录，例如tomcat的docBase目录下。
4.  **触发恶意类加载：**  最后，通过构造特定的 JSON 数据，触发服务器加载并执行写入的恶意类，从而实现远程代码执行。

**项目地址:** [luelueking/CVE-2022-25845-In-Spring](https://github.com/luelueking/CVE-2022-25845-In-Spring)

**漏洞详情:** [CVE-2022-25845](https://nvd.nist.gov/vuln/detail/CVE-2022-25845)