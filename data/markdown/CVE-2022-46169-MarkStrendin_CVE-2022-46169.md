## CVE-2022-46169-Cacti-命令注入

**漏洞编号:** CVE-2022-46169

**漏洞类型:** 命令注入

**影响应用:** Cacti

**危害等级:** 高危，未经身份验证的远程命令执行

**影响版本:** < 1.2.23

**利用条件:** Cacti服务器运行，且存在具有`POLLER_ACTION_SCRIPT_PHP`动作类型的poller_item，需要网络可达。

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2022-46169 是 Cacti 1.2.23 之前的版本中存在的一个未经身份验证的命令注入漏洞。攻击者可以通过构造特制的 HTTP 请求绕过身份验证，并利用 `remote_agent.php` 文件中的漏洞执行任意系统命令。

**漏洞利用方式：**

1.  **身份验证绕过：** 攻击者可以通过设置 `X-Forwarded-For` 或其他 `HTTP_` 开头的 HTTP Header，伪造客户端IP地址，使其与Cacti服务器自身的IP地址相同。`get_client_addr` 函数会读取这些header，然后 `gethostbyaddr` 函数将伪造的IP解析为主机名。由于 Cacti 的 `poller` 表中默认存在服务器自身的主机名记录，因此绕过身份验证。
2.  **命令注入：** 成功绕过身份验证后，攻击者可以向 `remote_agent.php` 发送带有 `action=polldata` 参数的请求，并指定 `host_id`、`local_data_ids[]` 和 `poller_id`。其中，`poller_id` 参数没有经过充分的过滤，攻击者可以在 `poller_id` 中注入恶意命令。
3.  **寻找合适的poller_item：** 为了触发命令注入，需要存在一个 `poller_item`，其 `action` 字段的值为 `POLLER_ACTION_SCRIPT_PHP` (值为2)。

**POC代码分析：**

提供的POC代码是一个 Python 脚本，用于利用 CVE-2022-46169 漏洞。该脚本首先检查目标是否易受攻击，然后暴力破解 `host_id` 和 `local_data_id`，以便找到具有 `POLLER_ACTION_SCRIPT_PHP` 操作的 `poller_item`。 一旦找到，它会构造一个包含恶意负载的 HTTP 请求并发送到 `remote_agent.php`。

**投毒风险分析：**

该代码主要目的是发送payload以获得反向shell，并没有发现恶意修改或删除文件等高危操作。代码的功能基本符合描述，但仍然存在一些潜在风险。

*   **依赖风险：** 代码依赖 `requests` 库，如果 `requests` 库被恶意篡改，可能会导致安全问题。
*   **配置错误：** 攻击者可能会错误配置 `attacker_ip` 和 `attacker_port`，导致攻击失败或暴露自己的IP地址。

根据以上分析，该POC存在较低的投毒风险。 代码的主要功能是利用已知漏洞，没有发现额外的恶意代码或隐藏功能，但也不能完全排除攻击者在实际使用中进行修改以达到其他目的的可能性。 风险评估较低，约为5%。

**结论：**

该漏洞的利用较为直接，POC代码有效。 漏洞存在投毒风险，但风险较低。

**项目地址:** [MarkStrendin/CVE-2022-46169](https://github.com/MarkStrendin/CVE-2022-46169)

**漏洞详情:** [CVE-2022-46169](https://nvd.nist.gov/vuln/detail/CVE-2022-46169)