## CVE-2023-46604 - Apache ActiveMQ OpenWire RCE

**漏洞编号:** CVE-2023-46604

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Apache ActiveMQ

**危害等级:** 高危，可能导致服务器完全控制

**影响版本:** 5.15.0 - 5.18.2, 5.15.x < 5.15.16, 5.16.x < 5.16.7, 5.17.x < 5.17.6, 5.18.x < 5.18.3

**利用条件:** 需要网络访问 ActiveMQ Broker 的 OpenWire 端口（默认为 61616）

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2023-46604 是一个存在于 Apache ActiveMQ OpenWire 协议中的反序列化漏洞，允许未经身份验证的远程攻击者通过操纵 OpenWire 协议中的序列化类类型，使 Broker 或 Client 实例化 classpath 上的任意类，从而执行任意 shell 命令。

**漏洞分析：**

漏洞源于 ActiveMQ Broker 在处理 OpenWire 消息时，没有对消息中包含的类进行严格的类型校验，导致攻击者可以发送包含恶意类的序列化数据。

**漏洞利用方式：**

1.  攻击者向 ActiveMQ Broker 的 OpenWire 端口（默认为 61616）发送特制的恶意 OpenWire 消息。
2.  该消息包含一个指向恶意类的序列化对象，该恶意类在被反序列化时会执行攻击者预先设定的任意代码。
3.  Broker 反序列化该对象，导致恶意代码在服务器上执行，实现远程代码执行。

**POC 分析：**

提供的 POC 代码主要利用 `org.springframework.context.support.ClassPathXmlApplicationContext` 类，该类在实例化时会解析给定的 XML 文件，攻击者可以通过构造恶意的 XML 文件，利用 Spring Framework 的特性执行任意代码。

`ExceptionResponsePoc.java` 文件构建了一个`ExceptionResponse`消息，其构造函数使用`ClassPathXmlApplicationContext`加载远程XML文件。这个 XML 文件包含了恶意配置，导致代码执行。POC 通过 ActiveMQ 的 OpenWire 协议将恶意消息发送到目标 ActiveMQ Broker。

**投毒风险评估：**

仓库中存在投毒代码的可能性较低，约为10%。主要考量如下：

*   `README.md` 文件指向了一个分析文章，表明该仓库的目的是为了进行漏洞分析。
*   `pom.xml` 文件中声明了漏洞利用所需的依赖，看起来是正常的项目依赖。
*   `ExceptionResponsePoc.java` 中的代码逻辑清晰，主要用于构建和发送恶意消息，没有发现可疑的后门代码。
*   虽然使用了 `ClassPathXmlApplicationContext` 加载远程 XML，具有一定的风险，但是这是漏洞利用的核心，而非投毒代码。

虽然代码本身并未发现明显的投毒行为，但是由于漏洞的特殊性，利用成功后，攻击者可以向目标服务器植入任意后门，需要注意这一点。

**项目地址:** [thinkycx/activemq-rce-cve-2023-46604](https://github.com/thinkycx/activemq-rce-cve-2023-46604)

**漏洞详情:** [CVE-2023-46604](https://nvd.nist.gov/vuln/detail/CVE-2023-46604)