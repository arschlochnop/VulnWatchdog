## CVE-2022-22947 Spring Cloud Gateway RCE

**漏洞编号:** CVE-2022-22947

**漏洞类型:** 代码注入

**影响应用:** Spring Cloud Gateway

**危害等级:** 高危，可导致远程代码执行

**影响版本:** Spring cloud gateway versions 3.1.x prior to 3.1.1+, 3.0.x prior to 3.0.7+ and all old and unsupported versions

**利用条件:** Gateway Actuator endpoint is enabled, exposed and unsecured

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2022-22947是Spring Cloud Gateway中的一个代码注入漏洞，当Gateway Actuator端点启用、暴露且未进行安全保护时，攻击者可以利用SpEL表达式注入执行任意代码。

**有效性：**

根据漏洞库信息、搜索引擎结果以及提供的漏洞利用代码，此漏洞是有效的。多个来源都证实了该漏洞的存在以及远程代码执行的可能性。提供的POC代码可以直接利用该漏洞。

**投毒风险：**

分析提供的POC代码，发现主要的恶意代码在于 `spring-cloud-gateway-rce.py` 中构建和发送的payload。该payload利用SpEL表达式在目标系统上执行任意命令。虽然POC本身是为了演示漏洞利用，但在实际场景中，攻击者可能会修改 `-c` 参数来执行恶意操作。`requirements.txt` 文件声明了项目所需的依赖项（colorama, requests, urllib3），这些库本身没有已知的恶意行为，但如果项目被篡改，可能会引入恶意依赖。

评估投毒风险时，主要考虑以下因素：

*   **代码可读性：** 代码相对简单，易于理解，这意味着潜在的恶意修改也更容易被发现。
*   **外部依赖：** 项目依赖外部库，如果这些库的源被攻破，可能会引入恶意代码。
*   **Payload生成：** Payload是动态生成的，如果攻击者能够控制Payload生成过程，就可以注入恶意代码。

综合来看，此仓库存在一定的投毒风险，风险值评估为10%。主要的风险点在于攻击者可能会修改Payload生成逻辑或引入恶意的依赖项，利用使用者执行恶意代码。

**利用方式：**

1.  **漏洞触发前提：** Spring Cloud Gateway的Actuator端点必须启用、暴露并且没有进行安全保护（例如，没有进行身份验证）。
2.  **构造Payload：** POC代码根据目标主机的操作系统（Linux或Windows）构造包含SpEL表达式的JSON payload。该payload利用`AddResponseHeader`过滤器，将执行命令的结果添加到响应头中。
3.  **发送Payload：** 使用POST请求将payload发送到`/actuator/gateway/routes/{id}`端点，其中`{id}`是路由的ID（在POC中为`k`）。
4.  **刷新路由：** 发送POST请求到`/actuator/gateway/refresh`端点，强制Spring Cloud Gateway刷新路由配置，从而触发SpEL表达式的执行。
5.  **获取结果：** 发送GET请求到`/actuator/gateway/routes/{id}`端点，获取路由信息，其中包含命令执行的结果。
6.  **删除路由：** 发送DELETE请求到`/actuator/gateway/routes/{id}`端点，删除添加的路由。

简而言之，攻击者通过构造包含恶意SpEL表达式的请求，利用Actuator端点动态注册路由，并在路由刷新时触发SpEL表达式执行，从而实现远程代码执行。

**项目地址:** [k3rwin/spring-cloud-gateway-rce](https://github.com/k3rwin/spring-cloud-gateway-rce)

**漏洞详情:** [CVE-2022-22947](https://nvd.nist.gov/vuln/detail/CVE-2022-22947)