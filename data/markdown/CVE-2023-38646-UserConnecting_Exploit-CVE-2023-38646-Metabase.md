## CVE-2023-38646-Metabase-RCE

**漏洞编号:** CVE-2023-38646

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Metabase

**危害等级:** 高危，无需身份验证即可执行任意命令

**影响版本:** 0.46.6.1之前 (开源版), 1.46.6.1之前 (企业版)

**利用条件:** 目标Metabase实例版本受影响，并且可以通过网络访问。

**POC 可用性:** 是

**投毒风险:** 1%

## 详情

CVE-2023-38646 允许未经身份验证的攻击者在 Metabase 服务器上以服务器的权限级别执行任意命令。根据漏洞库信息、搜索结果和提供的漏洞利用代码，此漏洞的利用方式是：

1.  **漏洞原理：** 该漏洞存在于 Metabase 的 `/api/setup/validate` 接口，利用了 H2 数据库的特性，通过在数据库连接字符串中插入恶意 SQL 语句来执行任意代码。
2.  **利用步骤：**
    *   **获取 `setup-token`：**  通过访问 `/api/session/properties` 获取 `setup-token`。
    *   **构造恶意请求：**  构造一个包含恶意 H2 连接字符串的 JSON payload，该连接字符串包含一个 `CREATE TRIGGER` 语句，该语句在每次查询 `INFORMATION_SCHEMA.TABLES` 时执行系统命令。
    *   **发送请求：**  将构造的 JSON payload 发送到 `/api/setup/validate` 接口。

3.  **POC 分析：** 提供的 Python 脚本 `metabase_exploit.py` 实现了上述步骤：
    *   它接受 Metabase 的 URL、`setup-token`、操作类型（`exec` 或 `revshell`）和命令作为参数。
    *   它使用 `command_encoding` 函数对命令进行 Base64 编码，并处理填充字符 `=`。
    *   它构造包含恶意 H2 连接字符串的 JSON payload。
    *   它发送 POST 请求到 `/api/setup/validate` 接口。

4.  **有效性：** 根据漏洞描述和提供的 PoC 代码，该 PoC 是有效的，可以在未授权的情况下执行任意代码。

5.  **投毒风险：**
    *   代码主要功能是构造并发送恶意请求，风险较低。
    *   `command_encoding` 函数看起来正常，用于避免Base64编码中的填充字符的问题，但也有可能存在其他编码漏洞。
    *   代码明确声明仅用于教育目的，但不能完全排除作者植入后门的可能。
    *   总体而言，投毒风险较低，大概在1%左右。主要风险在于使用者是否会用此代码执行非法操作。

综上所述，CVE-2023-38646 是一个严重的安全漏洞，攻击者可以利用该漏洞在 Metabase 服务器上执行任意命令。提供的 PoC 代码可以有效利用该漏洞，使用者应该谨慎对待，避免滥用。代码本身具有轻微的投毒风险，主要在于编码和声明的免责声明之间的潜在矛盾。

**项目地址:** [UserConnecting/Exploit-CVE-2023-38646-Metabase](https://github.com/UserConnecting/Exploit-CVE-2023-38646-Metabase)

**漏洞详情:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)