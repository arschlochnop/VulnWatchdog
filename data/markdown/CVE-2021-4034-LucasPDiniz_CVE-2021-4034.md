## CVE-2021-4034 - Polkit pkexec 本地提权漏洞 (Pwnkit)

**漏洞编号:** CVE-2021-4034

**漏洞类型:** 本地权限提升

**影响应用:** Polkit

**危害等级:** 高危，允许低权限用户获取root权限

**影响版本:** <= 0.105

**利用条件:** 本地用户访问，pkexec setuid root程序存在且未修复

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-4034 (Pwnkit) 漏洞是 polkit pkexec 工具中的一个本地权限提升漏洞。pkexec 是一个 setuid-root 程序，允许授权用户以特权用户身份执行命令。该漏洞源于 pkexec 在处理命令行参数时存在缺陷，导致可以覆盖环境变量。攻击者可以通过构造特定的环境变量，诱使 pkexec 执行任意代码，从而获得 root 权限。

**有效性:**
根据漏洞库信息、搜索结果和提供的漏洞利用代码，该漏洞的PoC代码是有效的。漏洞利用代码通过利用 pkexec 的参数处理缺陷来覆盖环境变量，尤其是 `GCONV_PATH`。通过设置 `GCONV_PATH` 指向包含恶意共享对象的目录，并设置 `CHARSET` 触发 glibc 的 gconv 机制，加载恶意共享对象，从而执行任意代码。

**投毒风险:**
提供的PoC代码本身看起来是一个完整的漏洞利用程序，但存在一些潜在的投毒风险，概率为10%。
1.  **`rm -rf 'GCONV_PATH=.' 'pwnkit'`**:  此命令旨在清理利用过程中创建的文件和目录。但如果目标系统上存在同名但重要的文件或目录，则可能造成意外删除。
2.  **对/bin/sh的依赖性**脚本依赖于 /bin/sh 的存在和功能。在某些受限环境中，/bin/sh可能不存在或受到限制，从而导致利用失败。攻击者可能通过其他命令达到破坏的目的。

**利用方式:**
1.  **准备恶意共享对象：** 首先，创建一个包含 shellcode 的 C 文件（例如 `pwnkit.c`）。该 shellcode 的作用是设置有效的用户和组 ID (UID/GID) 为 0 (root)，然后执行一个 shell (通常是 `/bin/sh`)。
2.  **编译恶意共享对象：** 使用 GCC 将 C 文件编译成共享对象 (`.so` 文件)，例如 `pwnkit.so`。
3.  **创建 GCONV_PATH 目录：** 创建一个名为 `GCONV_PATH=.` 的目录，并创建一个空文件 `GCONV_PATH=./pwnkit`。这是为了欺骗 pkexec 在当前目录中查找 gconv 模块。
4.  **创建 gconv-modules 文件：** 创建一个名为 `gconv-modules` 的文件，其中包含指定自定义 gconv 模块的配置信息。
5.  **设置环境变量并执行 pkexec：** 设置环境变量 `GCONV_PATH=.`、`CHARSET=PWNKIT` 和 `SHELL=pwnkit`。然后，不带任何参数执行 `pkexec`。由于 pkexec 的参数处理缺陷，这会导致覆盖环境变量，并触发 gconv 机制加载并执行恶意共享对象，从而获得 root 权限。

**总结:**
CVE-2021-4034 是一个严重的安全漏洞，可以被本地低权限用户利用来获得 root 权限。该漏洞利用简单，影响广泛，需要及时修复。虽然提供的 PoC 代码看起来直接，但仍需警惕潜在的投毒风险，并在测试环境中仔细评估。

**项目地址:** [LucasPDiniz/CVE-2021-4034](https://github.com/LucasPDiniz/CVE-2021-4034)

**漏洞详情:** [CVE-2021-4034](https://nvd.nist.gov/vuln/detail/CVE-2021-4034)