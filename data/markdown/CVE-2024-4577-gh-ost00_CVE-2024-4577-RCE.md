## CVE-2024-4577 PHP CGI Argument Injection RCE

**漏洞编号:** CVE-2024-4577

**漏洞类型:** 远程代码执行

**影响应用:** PHP

**危害等级:** 高危，允许未经身份验证的攻击者在Windows服务器上执行任意代码。

**影响版本:** PHP 8.1.* before 8.1.29, 8.2.* before 8.2.20, 8.3.* before 8.3.8

**利用条件:** Windows服务器，使用Apache和PHP-CGI，系统设置为使用特定的代码页（可能涉及"Best-Fit"行为）。目标服务器必须配置为以CGI模式运行PHP脚本。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-4577是一个影响Windows上PHP的远程代码执行漏洞，当PHP以CGI模式运行时会受到影响。该漏洞源于Windows在将命令行参数传递给Win32 API函数时，会使用“Best-Fit”行为转换字符。PHP CGI模块可能会错误地将这些转换后的字符解释为PHP选项，从而允许攻击者向PHP二进制文件传递恶意选项。该漏洞利用方式涉及构造包含特定字符的HTTP请求，这些字符在经过Windows的字符转换后，会被PHP-CGI解析为恶意的PHP配置指令，例如`allow_url_include`和`auto_prepend_file`，进而包含远程或本地文件，最终导致任意代码执行。

**漏洞利用有效性：**
根据漏洞信息、搜索结果和提供的PoC代码，该漏洞利用是有效的。搜索结果表明，CVE-2024-4577自披露后不久就出现了大量的利用尝试，并且已被积极利用。

**投毒风险分析：**
提供的PoC代码主要包含以下部分：
1.  **扫描模块：** 用于检测目标是否易受攻击，通过发送包含特定payload的请求来检查响应中是否存在“Test”字符串。
2.  **利用模块：**  利用`allow_url_include`和`auto_prepend_file`指令，通过POST请求发送PHP payload来执行任意代码。

虽然该代码的功能主要是漏洞利用，但存在一定的投毒风险，主要体现在以下几个方面：
1.  **Payload文件：**  利用模块需要指定一个payload文件，如果用户使用了恶意的payload文件，可能会对目标系统造成损害。**这是主要投毒风险来源。**
2.  **Payload混淆：**  Payload中使用了`%AD`，这是一种简单的混淆手段，可能会被用于绕过一些简单的安全检测，也可能被用于隐藏恶意代码。
3.  **依赖风险：** 虽然代码依赖少,但是如果`requirements.txt`文件被篡改，可能导致引入恶意依赖。

综合考虑，PoC本身实现的投毒风险较低，主要风险在于用户提供的`payload_file`可能包含恶意代码。仓库中`README.md`文件提供了下载链接，可能存在被篡改的风险。

**利用方式总结：**
1.  **目标确认：** 确认目标系统满足漏洞利用的条件（Windows、PHP-CGI、受影响的PHP版本、特定的代码页设置）。
2.  **发送恶意请求：**  构造包含恶意payload的HTTP请求，该payload包含经过编码的PHP配置指令，例如`?%ADd+allow_url_include%3d1+%ADd+auto_prepend_file%3dphp://input`。
3.  **执行任意代码：**  通过`auto_prepend_file`包含远程或本地文件，执行其中的PHP代码。通常，攻击者会利用此漏洞上传webshell或执行其他恶意操作。
4. **利用编码绕过:** 某些特定代码页设置下，对某些特殊字符进行转换，才可触发该漏洞。

**项目地址:** [gh-ost00/CVE-2024-4577-RCE](https://github.com/gh-ost00/CVE-2024-4577-RCE)

**漏洞详情:** [CVE-2024-4577](https://nvd.nist.gov/vuln/detail/CVE-2024-4577)