## CVE-2018-15133 Laravel Framework Token Unserialize RCE

**漏洞编号:** CVE-2018-15133

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Laravel Framework

**危害等级:** 高危，可能导致服务器完全控制

**影响版本:** <= 5.5.40 和 5.6.x <= 5.6.29

**利用条件:** 需要知道 APP_KEY，通常需要之前已经获得的特权访问或成功利用了之前的漏洞。

**POC 可用性:** 是

**投毒风险:** 1%

## 详情

CVE-2018-15133 漏洞是 Laravel Framework 中由于对 X-XSRF-TOKEN 值进行不安全的反序列化操作导致的远程代码执行漏洞。攻击者可以通过伪造恶意的 X-XSRF-TOKEN，并将其加密后发送给服务器，服务器在解密并反序列化该 token 时，会执行攻击者预先设定的恶意代码。

**有效性：**
根据漏洞库信息、搜索引擎结果以及提供的漏洞利用代码，此漏洞的 POC 代码是有效的。搜索引擎结果中包含了多个指向该漏洞的详细描述、利用代码示例以及缓解措施的文章，包括 CISA 将其添加到已知被利用的漏洞目录中。
提供的 Dockerfile 文件和 README.md 文件描述了如何搭建一个存在漏洞的 Laravel 环境并利用 `cve-2018-15133.php` 脚本进行攻击。README.md 中给出了详细的利用步骤，包括获取 APP_KEY，生成反序列化 Payload，加密 Payload，最后通过 POST 请求发送 Payload。脚本通过构造特定的 PHP 对象，在反序列化时触发 `system()` 函数来执行任意命令。

**投毒风险：**
Dockerfile文件用于构建一个包含漏洞版本的Laravel应用的Docker镜像。 cve-2018-15133.php 用于漏洞利用，并没有发现可疑或恶意行为，因此投毒风险较低。

代码仓库中主要为演示漏洞利用的代码，并无发现存在恶意行为或后门的代码。`phpggc` 用于生成payload，但其本身不是由该作者提供的,所以此处不做分析。Dockerfile 安装的是已知漏洞版本的 Laravel，用于复现，而不是植入后门，所以投毒可能性较低。 投毒风险较低，大约在1%以下。

**利用方式：**
1.  **获取 APP_KEY：** 攻击者需要首先获取 Laravel 应用的 APP_KEY。通常，这需要攻击者已经获得了服务器的某些权限，例如读取 `.env` 文件的权限。可以通过`docker exec -it $(docker ps --latest --quiet) grep -e ^APP_KEY /var/www/html/laravel/.env`来获取，这说明需要一定的权限才能获取该KEY，这使得利用难度增大。
2.  **生成反序列化 Payload：** 攻击者使用 `phpggc` 工具（或类似工具）生成一个恶意 PHP 反序列化 Payload。该 Payload 包含一个精心构造的对象链，当被反序列化时，会执行任意命令。 例如，`phpggc Laravel/RCE1 'uname -a' -b`。
3.  **加密 Payload：** 使用 Laravel 的加密机制（`Illuminate\Encryption\Encrypter`）以及 APP_KEY 对 Payload 进行加密，生成一个类似于 Laravel XSRF-TOKEN 的字符串。这通过 cve-2018-15133.php 进行
4.  **发送 Payload：** 将加密后的 Payload 放在 `X-XSRF-TOKEN` HTTP header 中，发送一个 POST 请求到存在漏洞的 Laravel 应用。 例如：`curl localhost:8000 -X POST -H 'X-XSRF-TOKEN: eyJpdiI6Imp3c1BUejE5aGFFUVM4a0NcLzIyODBnPT0iLCJ2YWx1ZSI6InZrTEdOY2o1NlVJdlltWFl3OFBxTEY1a1pCZWlaSDRSdXM1STNSa21sSE5Cb3hFd09cL2JUdU0wWHhjK0dUU0dYQzlTd3ZYSm50NTc4NW90UnNrZW5mMHc2RHdcLzZia01cL29wVUhjQml5cCtmZ1VcL2lwbnVySG52MHEwWXdZMVFVSXhWYjFEQlwveTZPQ3JORnRYdVQyeVFnODM1UGVCSVFcL3B6RGs2VDczOTZEbkFKdFwvc3lpZXBtcUo4VllLNU4zS0pMV3ZBUlNXZDRHRmNnOG1vOFZUWDVicE5uV0FcL1NSXC9HRjh2XC9YR2pLUDlEdlEwaytWRHl5TFhvb3RXM0Y4ejNXIiwibWFjIjoiOTMwMTNkZDYwYzNjYmQ1YTg4ZjRmNjM2NmZhMzBjNzA5NTgzYmI`
5.  **触发 RCE：** Laravel 应用在处理请求时，会解密并反序列化 `X-XSRF-TOKEN` 的值。由于 Payload 是恶意的，反序列化过程会触发远程代码执行，导致服务器执行攻击者预先设定的命令。


**项目地址:** [kozmic/laravel-poc-CVE-2018-15133](https://github.com/kozmic/laravel-poc-CVE-2018-15133)

**漏洞详情:** [CVE-2018-15133](https://nvd.nist.gov/vuln/detail/CVE-2018-15133)