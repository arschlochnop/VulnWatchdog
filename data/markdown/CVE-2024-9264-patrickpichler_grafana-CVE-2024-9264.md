## CVE-2024-9264-Grafana-命令注入和本地文件包含

**漏洞编号:** CVE-2024-9264

**漏洞类型:** 命令注入和本地文件包含

**影响应用:** Grafana

**危害等级:** 高危，可能导致远程代码执行和敏感信息泄露

**影响版本:** 11.0.0 <= version < 11.0.5, 11.0.6, 11.1.0 <= version < 11.1.6, 11.1.7, 11.2.0 <= version < 11.2.1, 11.2.2

**利用条件:** 需要Grafana启用SQL Expressions实验性功能，且duckdb二进制文件存在于Grafana的$PATH中，以及VIEWER或更高权限的用户。

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2024-9264 存在于 Grafana 的 SQL Expressions 实验性功能中。该功能允许执行包含用户输入的 `duckdb` 查询。由于在将这些查询传递给 `duckdb` 之前未经过充分的安全过滤，因此会导致命令注入和本地文件包含漏洞。任何具有 VIEWER 或更高权限的用户都可能执行此攻击。

**漏洞利用方式：**

1.  攻击者需要拥有 Grafana 实例的 Viewer 或更高的权限。
2.  Grafana 实例必须启用 SQL Expressions 实验性功能。
3.  Grafana 服务器上必须存在 `duckdb` 可执行文件，并且该文件位于 Grafana 进程的 `$PATH` 中。
4.  攻击者构造恶意的 `duckdb` 查询，其中包含命令注入或本地文件包含的 payload。
5.  Grafana 将未经过充分过滤的查询传递给 `duckdb` 执行。
6.  恶意代码在 Grafana 服务器上执行，或者攻击者可以读取服务器上的任意文件。

**有效性：**

根据漏洞描述和搜索引擎结果（wiz.io, sonicwall, indusface, broadcom），该漏洞允许攻击者在服务器上执行命令和读取本地文件，因此 POC 代码是有效的。

**投毒风险：**

查看提供的 Dockerfile，它首先从 `curlimages/curl:8.15.0` 下载 `duckdb` 的预编译版本，然后将 `duckdb` 二进制文件复制到 Grafana 镜像中，并未发现任何额外的或可疑的操作。该 Dockerfile 只是为了方便部署一个包含漏洞利用所需组件的环境，使得漏洞可复现，因此推测投毒风险较低，风险概率为0%。

**搜索引擎结果总结：**

根据搜索结果，多个安全厂商（SonicWall，Wiz，Indusface，Broadcom，Snyk）都对该漏洞进行了分析和披露，确认了漏洞的存在性和严重性，并提供了缓解措施和升级建议。RedHat的安全公告也确认了该漏洞。Grafana官方博客也发布了安全更新，修复了该漏洞。

**项目地址:** [patrickpichler/grafana-CVE-2024-9264](https://github.com/patrickpichler/grafana-CVE-2024-9264)

**漏洞详情:** [CVE-2024-9264](https://nvd.nist.gov/vuln/detail/CVE-2024-9264)