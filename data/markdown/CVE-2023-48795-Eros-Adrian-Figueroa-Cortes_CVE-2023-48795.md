## CVE-2023-48795-Terrapin Attack

**漏洞编号:** CVE-2023-48795

**漏洞类型:** SSH中间人攻击，降级加密

**影响应用:** OpenSSH 及其他SSH客户端/服务端

**危害等级:** 中危，允许中间人攻击者通过截断 SSH 握手过程中的数据包，从而降级连接的安全性。

**影响版本:** OpenSSH < 9.6 及其他受影响软件版本 (见CVE描述)

**利用条件:** 攻击者需要处于客户端和服务端之间的网络位置，能够拦截和篡改 SSH 流量

**POC 可用性:** 是

**投毒风险:** 1%

## 详情

CVE-2023-48795 (Terrapin Attack) 是一种针对 SSH 协议的中间人攻击。该漏洞允许攻击者在 SSH 握手阶段截断数据包，从而影响密钥交换和算法协商。攻击利用了 SSH BPP 对握手阶段序列号处理的缺陷。通过选择性地丢弃某些数据包，攻击者可以迫使客户端和服务端使用较弱的加密算法，或者禁用某些安全特性，例如 ChaCha20-Poly1305 或者 CBC with Encrypt-then-MAC 算法。  

**POC有效性：**  
提供的 Python POC 代码 `CVE-2023-48795.py`  的主要功能是扫描目标 SSH 服务版本，判断其是否受到 Terrapin 攻击的影响。它使用 `netcat` (`nc`) 命令获取 SSH banner，然后通过正则表达式提取版本号。如果版本号低于 9.6 (对于 OpenSSH)，则认为目标易受攻击。此POC**不能直接利用此漏洞进行攻击**，而是**用于检测漏洞是否存在**,因此**有效性高**.真正的攻击需要中间人劫持流量并进行数据包截断。  

**投毒风险：**
代码进行分析后，未发现明显的恶意代码或后门。该脚本主要功能是版本检测，投毒风险较低。但是仍然存在极低的风险，因为代码可以通过修改 `get_remote_ssh_version` 函数中的命令执行逻辑，例如，可以加入反弹shell或者执行其他命令。但是代码整体的复杂度并不高，逻辑简单，因此人工审计可以发现潜在风险.  **投毒风险评估为 1%**. 

**利用方式：**
1.  **中间人位置：** 攻击者必须能够拦截客户端和服务器之间的 SSH 流量。这可以通过 ARP 欺骗、DNS 劫持或在网络路径上进行监听来实现。
2.  **握手截断：** 在 SSH 握手期间，攻击者会选择性地丢弃某些数据包，特别是与密钥交换和算法协商相关的消息。
3.  **降级协商：** 通过截断数据包，攻击者可以影响客户端和服务器的算法协商过程，迫使它们使用较弱的加密算法或禁用某些安全特性。
4.  **数据篡改/窃取：**  一旦连接降级，攻击者就可以更容易地解密和篡改传输的数据。

**缓解措施：**
*   升级 OpenSSH 到 9.6 或更高版本。
*   禁用受影响的加密算法，例如 ChaCha20-Poly1305 和 CBC with Encrypt-then-MAC。
*   使用严格的密钥交换算法，例如 Curve25519。
*   部署网络入侵检测系统 (NIDS) 来检测潜在的中间人攻击。

**项目地址:** [Eros-Adrian-Figueroa-Cortes/CVE-2023-48795](https://github.com/Eros-Adrian-Figueroa-Cortes/CVE-2023-48795)

**漏洞详情:** [CVE-2023-48795](https://nvd.nist.gov/vuln/detail/CVE-2023-48795)