## CVE-2023-0386-Linux Kernel OverlayFS 本地提权

**漏洞编号:** CVE-2023-0386

**漏洞类型:** 本地提权

**影响应用:** Linux Kernel OverlayFS

**危害等级:** 高危，本地用户可提升权限

**影响版本:** Linux kernel 6.2-rc6

**利用条件:** 需要存在 OverlayFS 文件系统，用户拥有文件写入权限

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2023-0386 漏洞存在于 Linux Kernel 的 OverlayFS 子系统中，允许本地用户通过利用具有 capabilities 的 setuid 文件复制过程中的权限映射错误，将权限提升到 root 权限。

**有效性：**

根据提供的漏洞库信息、搜索引擎结果和漏洞利用代码，该漏洞利用是有效的。搜索引擎结果中包含多个关于该漏洞的描述和利用示例，表明该漏洞已得到广泛关注和研究。漏洞利用代码 `CVE-2023-0386-exp.c` 提供了一个 POC，通过 FUSE 创建一个文件系统，并在 OverlayFS 中利用该文件系统中的 setuid 文件来提升权限。

**利用方式：**

1.  **创建 FUSE 文件系统：** 漏洞利用代码使用 FUSE（Filesystem in Userspace）创建一个用户态的文件系统。该文件系统包含一个具有 setuid 权限的可执行文件 `/hello`。
2.  **挂载 OverlayFS：** 漏洞利用代码使用 `unshare` 命令创建一个新的 mount namespace，并在该 namespace 中挂载 OverlayFS。OverlayFS 将 FUSE 文件系统作为 lowerdir，并将另外两个目录作为 upperdir 和 workdir。
3.  **触发漏洞：** 当用户尝试访问 OverlayFS 中的 `/hello` 文件时，内核会尝试复制该文件。由于 OverlayFS 存在权限映射错误，复制后的文件会保留 setuid 权限，从而允许本地用户以 root 权限执行该文件。
4.  **权限提升：** 执行具有 setuid 权限的文件会使得本地用户获得 root 权限，从而实现权限提升。

**投毒风险：**

该漏洞利用代码主要用于演示漏洞利用过程，并提升权限。漏洞利用代码中包含的shellcode的功能是通过调用execve执行/bin/sh以提升权限，并没有发现直接的恶意代码或后门逻辑。但是，仍然存在一些潜在的投毒风险：

*   **隐藏的后门代码：** 作者可能在 shellcode 中插入隐藏的后门代码，例如，收集系统信息并发送到远程服务器。 由于汇编指令不易读懂，因此较难进行分析
*   **环境依赖性：** 漏洞利用代码可能依赖特定的系统环境或库，这可能会导致漏洞利用失败，或者在某些情况下，触发意外的行为。 这部分代码有概率包含恶意指令。
*   **覆盖或修改文件：** 漏洞利用代码可能会覆盖或修改系统中的文件，这可能会导致系统不稳定或数据丢失。

综合评估，该漏洞利用代码的投毒风险较低，估计约为 5%。因为这段shellcode很短，执行的操作也很简单，不包含明显的恶意逻辑，但是作者仍然可能通过微妙的方式隐藏恶意行为。


**项目地址:** [AiK1d/CVE-2023-0386](https://github.com/AiK1d/CVE-2023-0386)

**漏洞详情:** [CVE-2023-0386](https://nvd.nist.gov/vuln/detail/CVE-2023-0386)