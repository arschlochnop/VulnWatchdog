## CVE-2023-46604 - Apache ActiveMQ RCE

**漏洞编号:** CVE-2023-46604

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Apache ActiveMQ

**危害等级:** 严重，可能导致完全系统控制

**影响版本:** 5.15.16之前, 5.16.7之前, 5.17.6之前, 5.18.3之前

**利用条件:** 需要网络访问OpenWire协议端口 (默认61616)

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2023-46604 是 Apache ActiveMQ 中的一个远程代码执行漏洞。该漏洞源于 OpenWire 协议中对不可信数据反序列化处理不当，允许未经身份验证的远程攻击者通过操纵序列化的类类型，导致客户端或 Broker 实例化 classpath 上的任何类，从而执行任意 shell 命令。

**有效性分析：**

根据漏洞库信息和搜索结果，此漏洞的严重性评级为CRITICAL，并且已被积极利用。提供的POC代码旨在利用此漏洞。POC代码使用 Golang 编写，包含构建和发送恶意 OpenWire 消息的功能。漏洞利用的关键在于通过构造特定的 OpenWire 消息，诱使 ActiveMQ Broker 反序列化恶意的 Spring XML 文件。该 XML 文件包含可以执行任意代码的 payload。

**投毒风险分析：**

该仓库中包含的只有漏洞利用代码和一个README文件，README 文件包含对 OpenWire 协议的分析、漏洞原理的描述和漏洞利用方法。该仓库本身不包含任何后门或恶意代码，投毒风险为 0%。

**利用方式：**

1.  **理解OpenWire协议：** 攻击者需要理解 ActiveMQ 的 OpenWire 协议，包括消息的结构和序列化方式。
2.  **构造恶意OpenWire消息：** 攻击者需要构造包含恶意类的序列化 OpenWire 消息。这个恶意类通常是一个能够执行任意代码的类，例如利用 Spring Framework 的 `ClassPathXmlApplicationContext` 来加载远程 XML 配置文件。
3.  **部署恶意XML文件：** 攻击者需要部署一个恶意的 Spring XML 配置文件到一个可以通过 HTTP 访问的服务器上。这个 XML 文件包含用于执行任意代码的 payload。
4.  **发送恶意消息：** 攻击者将构造好的恶意 OpenWire 消息发送到目标 ActiveMQ Broker。
5.  **触发反序列化：** ActiveMQ Broker 接收到消息后，尝试反序列化消息中的类。如果成功，恶意类将被实例化，从而导致远程代码执行。

**POC代码分析：**

POC代码 (`ActiveMQ-RCE`) 接收 ActiveMQ Broker 的 IP 地址和包含 payload 的 XML 文件的 URL 作为参数。 它构造一个恶意的 OpenWire 消息，该消息包含对远程 XML 文件的引用，然后将该消息发送到 Broker 。 成功利用此漏洞将允许攻击者在 ActiveMQ 服务器上执行任意命令。

**项目地址:** [X1r0z/ActiveMQ-RCE](https://github.com/X1r0z/ActiveMQ-RCE)

**漏洞详情:** [CVE-2023-46604](https://nvd.nist.gov/vuln/detail/CVE-2023-46604)