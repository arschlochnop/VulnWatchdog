## CVE-2023-38646-Metabase-RCE

**漏洞编号:** CVE-2023-38646

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Metabase

**危害等级:** 高危，无需身份验证即可远程执行任意命令

**影响版本:** < 0.46.6.1 和 Metabase Enterprise < 1.46.6.1

**利用条件:** 目标Metabase实例未打补丁且网络可达。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2023-38646 允许未经身份验证的攻击者在 Metabase 服务器上以服务器权限级别执行任意命令。根据漏洞库信息、搜索结果和提供的漏洞利用代码，可以得出以下结论：

**有效性：**

提供的 PoC 代码看起来是有效的。它利用了 Metabase 安装设置过程中的一个漏洞，即在设置过程中可以指定数据库连接，并且未对数据库连接字符串进行充分的验证。通过构造恶意的 H2 数据库连接字符串，可以执行任意代码。

*   该PoC首先获取 `setup-token` 和 Metabase 版本信息。
*   然后，对包含反向shell命令的payload进行base64编码。
*   接着，它构造一个包含恶意H2数据库连接字符串的JSON payload，该字符串利用了`CREATE TRIGGER` 语句和内嵌的JavaScript代码来执行操作系统命令。
*   最后，它将此payload发送到`/api/setup/validate`端点，触发命令执行，反弹shell到攻击者控制的IP地址和端口。

参考搜索结果 [7] 提供了 GitHub 链接，进一步证实了 PoC 的存在。

**投毒风险：**

虽然PoC本身的目的是利用漏洞，但存在一定程度的投毒风险。PoC代码中，攻击者可以自定义反弹shell的IP地址和端口。如果攻击者恶意修改PoC代码，例如添加额外的后门或恶意功能，并将其传播给其他用户，则可能导致更大范围的攻击。风险主要体现在以下几个方面：

*   **依赖第三方库:** 检查 PoC 代码依赖的第三方库是否存在恶意代码。
*   **Payload修改:** 用户可能直接使用 PoC 代码，而不检查其内容。攻击者可能修改 payload，例如植入挖矿程序或者其他恶意软件。
*   **社区传播:** 修改后的 PoC 代码可能在安全社区中传播，导致更多用户受到影响。

综合来看，投毒风险大约为 10%。这个百分比并不高，因为大多数安全研究人员会检查代码后再使用，但仍然需要警惕。

**利用方式：**

1.  **获取Setup Token:**  利用 `/api/session/properties` 端点获取 Metabase 实例的 setup token。
2.  **构造恶意数据库连接字符串:**  创建一个包含恶意 H2 数据库连接字符串的 JSON payload。该字符串利用 H2 数据库的特性，通过`CREATE TRIGGER`执行任意命令。
3.  **发送请求:**  将构造的 JSON payload 发送到 `/api/setup/validate` 端点。
4.  **反弹Shell:**  如果漏洞利用成功，目标 Metabase 服务器将反弹 shell 到攻击者指定的 IP 地址和端口。
5.  **利用搜索结果** 搜索结果中提及该漏洞可能被利用 (Web Attack: Metabase RCE Vulnerability CVE-2023-38646)，并提供了缓解措施，表明该漏洞在野外可能被利用。

**缓解措施：**

*   将 Metabase 升级到受影响版本以外的版本 (>= 0.46.6.1 或 >= 1.46.6.1)或其他修复版本 (0.45.4.1, 1.45.4.1, 0.44.7.1, 1.44.7.1, 0.43.7.2, 和 1.43.7.2)。


**项目地址:** [threatHNTR/CVE-2023-38646](https://github.com/threatHNTR/CVE-2023-38646)

**漏洞详情:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)