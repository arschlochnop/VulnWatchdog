## CVE-2021-31166: HTTP Protocol Stack Remote Code Execution Vulnerability

**漏洞编号:** CVE-2021-31166

**漏洞类型:** 远程代码执行

**影响应用:** Microsoft Windows HTTP.sys

**危害等级:** 高危，可导致远程代码执行

**影响版本:** Windows 10 Version 2004, Windows Server version 2004, Windows 10 Version 20H2, Windows Server version 20H2 (版本低于10.0.19041.982和10.0.19042.982)

**利用条件:** 需要网络访问，目标系统运行存在漏洞的HTTP.sys服务

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-31166 是一个 HTTP 协议栈远程代码执行漏洞，存在于 `http.sys` 中。该漏洞是由于 `http!UlpParseContentCoding` 函数中 use-after-free 错误导致的。攻击者可以发送特制的 HTTP 请求到存在漏洞的服务器，触发该漏洞，导致服务器崩溃（Bugcheck）或执行恶意代码。

**有效性：**
提供的POC代码利用了 `http!UlpParseContentCoding` 函数中的 use-after-free 漏洞，通过特定的 HTTP 请求触发该漏洞，导致系统崩溃。根据漏洞描述和POC代码的说明，该POC代码是有效的。

**投毒风险：**
提供的代码包括一个MIT许可证和漏洞说明文档(README.md)。漏洞利用代码主要集中在HTTP请求的构造上，以便触发`http.sys`中的漏洞。虽然无法完全排除投毒的可能性，但从代码内容来看，作者隐藏恶意代码的可能性较低。可以认为存在10%的投毒风险,主要体现在编译过程和HTTP请求构造的细节中，可能存在隐藏的恶意行为，比如信息泄露或权限提升。

**利用方式：**
1.  攻击者构造恶意的 HTTP 请求，该请求包含特定的 `Accept-Encoding` 头部。
2.  当 `http.sys` 解析该 HTTP 请求时，`UlpParseContentCoding` 函数中的漏洞会被触发。
3.  漏洞触发会导致一个 LIST_ENTRY 结构体被错误地释放，然后在后续操作中被再次访问。
4.  最终导致系统崩溃（Bugcheck）或允许攻击者执行任意代码。简单的POC可能仅仅触发拒绝服务(DoS),复杂的利用可以构造内存布局执行任意代码.
5.  漏洞利用通常涉及到精心构造的HTTP请求，这些请求需要发送到目标服务器的HTTP服务端口（通常是80或443端口）。

**项目地址:** [0vercl0k/CVE-2021-31166](https://github.com/0vercl0k/CVE-2021-31166)

**漏洞详情:** [CVE-2021-31166](https://nvd.nist.gov/vuln/detail/CVE-2021-31166)