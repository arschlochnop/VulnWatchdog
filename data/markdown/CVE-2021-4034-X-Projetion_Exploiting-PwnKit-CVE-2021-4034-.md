## CVE-2021-4034 - Polkit pkexec 本地提权漏洞 (PwnKit)

**漏洞编号:** CVE-2021-4034

**漏洞类型:** 本地提权

**影响应用:** Polkit

**危害等级:** 高危，可使低权限用户获得 root 权限

**影响版本:** All (受影响版本)

**利用条件:** 需要本地访问

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

该漏洞存在于 polkit 的 pkexec 工具中。pkexec 是一个 setuid 工具，旨在允许非特权用户根据预定义的策略以特权用户身份运行命令。漏洞原因是 pkexec 在处理调用参数计数时存在缺陷，导致尝试将环境变量作为命令执行。攻击者可以精心构造环境变量，诱使 pkexec 执行任意代码，从而实现本地提权。

**有效性：**
提供的 PoC 代码是有效的，利用了 pkexec 的环境变量处理缺陷。利用方式包括编译 C 代码生成共享库，然后设置特定的环境变量来触发漏洞，最终执行恶意代码以获得 root 权限。从搜索引擎结果和漏洞库信息来看，该漏洞的 PoC 已经被广泛公开，并且有大量的成功利用案例。

**投毒风险：**
该仓库中存在少量投毒风险，大约为 10%。

虽然主要代码是为了利用漏洞，但是sh脚本中存在`(sleep 1 && rm ./PwnKit & )`，该命令会在执行漏洞利用程序后删除自身。这可以被视为一种轻微的混淆手段，虽然并非直接注入恶意代码，但增加了分析和溯源的难度。所以存在一定投毒风险。

**利用方式：**
1.  **利用核心：** 利用 `pkexec` 程序解析参数时的漏洞，将恶意代码注入到环境变量中。
2.  **创建 GCONV_PATH：**  创建目录 `GCONV_PATH=.` 和 `.pkexec`，以及文件 `.pkexec/gconv-modules`，用于欺骗 `pkexec` 程序加载自定义的 gconv 模块。
3.  **编译恶意共享库：**  将 `PwnKit.c` 编译为共享库 `PwnKit.so`，其中包含 `entry` 和 `gconv` 函数。`entry` 函数负责设置环境变量，`gconv` 函数负责执行提权后的操作。
4.  **设置环境变量：**  设置 `PATH`、`CHARSET`、`SHELL` 等环境变量，使得 `pkexec` 程序加载恶意的 gconv 模块。
5.  **执行 pkexec：**  执行 `/usr/bin/pkexec` 或 `pkexec` 程序，触发漏洞，执行 `gconv` 函数中的提权代码。
6.  **提权：** `gconv` 函数会设置 uid 和 gid 为 0，然后执行 `CMD` 环境变量指定的命令，或者启动一个 root shell。
7. **清理:** 在成功执行利用后,清除恶意目录和文件。

综上，该 PoC 代码有效，但存在少量投毒风险，利用方式清晰，可实现本地提权。

**项目地址:** [X-Projetion/Exploiting-PwnKit-CVE-2021-4034-](https://github.com/X-Projetion/Exploiting-PwnKit-CVE-2021-4034-)

**漏洞详情:** [CVE-2021-4034](https://nvd.nist.gov/vuln/detail/CVE-2021-4034)