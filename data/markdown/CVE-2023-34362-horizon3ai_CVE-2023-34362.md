## CVE-2023-34362-MOVEit Transfer-SQL注入

**漏洞编号:** CVE-2023-34362

**漏洞类型:** SQL注入

**影响应用:** MOVEit Transfer

**危害等级:** 高危，可能导致未经身份验证的攻击者访问数据库，泄露、修改或删除数据，甚至执行任意SQL语句。

**影响版本:** 所有版本 (例如, 2020.0 和 2019x) 在 2021.0.6 (13.0.6), 2021.1.4 (13.1.4), 2022.0.4 (14.0.4), 2022.1.5 (14.1.5), 和 2023.0.1 (15.0.1) 之前都受影响，包括较旧的不受支持的版本。

**利用条件:** 需要网络访问MOVEit Transfer Web应用程序，且目标系统存在漏洞。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2023-34362是MOVEit Transfer Web应用程序中的一个SQL注入漏洞。未经身份验证的攻击者可以通过构造恶意SQL语句来访问MOVEit Transfer的数据库。根据使用的数据库引擎（MySQL、Microsoft SQL Server或Azure SQL），攻击者可能能够推断有关数据库的结构和内容的信息，并执行SQL语句来更改或删除数据库元素。该漏洞已在野外被积极利用。 

**漏洞利用方式：**

1.  **获取CSRF Token：** 使用`get_csrf`函数，通过向`guestaccess.aspx`发送POST请求，获取CSRF token。
2.  **设置Session变量：** 使用`set_session_variables`函数，利用`MOVEitISAPI.dll`中的漏洞来设置session变量，从而执行SQL注入。该函数通过修改`xx-silock-transaction`和`X-siLock-Transaction`头部来欺骗服务器，执行`session_setvars`。
3.  **触发SQL注入：** 使用`do_guest_access`函数，通过向`guestaccess.aspx`发送包含CSRF token的POST请求，触发SQL注入。
4.  **执行注入：** 使用`do_injection`函数，组合以上步骤，将SQL语句注入到`MyPkgSelfProvisionedRecips` session变量中，最终在`guestaccess.aspx`页面触发SQL注入。

**有效性评估：**

该PoC代码看起来有效，因为它实现了利用CVE-2023-34362漏洞所需的步骤：获取CSRF Token、设置Session变量、触发SQL注入。

**投毒风险评估：**

PoC代码的主要功能是利用SQL注入漏洞。代码中存在以下潜在的投毒风险，但风险较低：

*   **JWT相关代码：** 代码中包含`create_jwt`函数，用于创建JWT。虽然当前代码段中没有直接使用恶意payload，但可能被用于后续的权限绕过或其他攻击。这段代码增加了复杂性，如果使用不当，可能引入新的漏洞或后门。但根据已知信息，此漏洞主要通过SQL注入利用，JWT代码在此上下文中显得不必要，存在一定恶意使用的嫌疑。
*   **依赖库：** 代码依赖多个第三方库，如`requests`，`cryptography`，`jwt`。 如果这些库存在安全问题，可能会被利用。
*   **错误处理：** 代码中的错误处理相对简单，可能存在绕过机制，使得恶意代码可以执行。
*   **参数处理：** 代码中的参数处理可能存在漏洞，例如未对用户输入的SQL语句进行严格的过滤，导致更严重的SQL注入。

总体来看，投毒风险较低，估计在10%左右。主要的风险在于JWT相关代码的潜在恶意使用，以及对第三方库的依赖。由于该漏洞本质是SQL注入，此PoC主要目的还是验证SQL注入漏洞，添加后门或者植入恶意代码的可能性比较低。

**项目地址:** [horizon3ai/CVE-2023-34362](https://github.com/horizon3ai/CVE-2023-34362)

**漏洞详情:** [CVE-2023-34362](https://nvd.nist.gov/vuln/detail/CVE-2023-34362)