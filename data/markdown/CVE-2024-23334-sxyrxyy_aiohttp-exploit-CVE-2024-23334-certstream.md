## CVE-2024-23334-aiohttp-目录穿越

**漏洞编号:** CVE-2024-23334

**漏洞类型:** 目录穿越

**影响应用:** aiohttp

**危害等级:** 中危，可能导致敏感信息泄露

**影响版本:** < 3.9.2

**利用条件:** 服务器启用了静态文件服务，并且follow_symlinks=True

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-23334 是 aiohttp 框架中存在的一个目录穿越漏洞。当 aiohttp 被用作 Web 服务器，并且配置了静态路由，同时 `follow_symlinks` 选项设置为 `True` 时，攻击者可以通过构造包含 `../` 的恶意 URL，绕过静态文件目录的限制，访问服务器上的任意文件。即使没有符号链接，也存在此漏洞。

**有效性分析：**
提供的 POC 代码尝试利用此漏洞。它首先从 `certstream.calidog.io` 收集域名，然后检查这些域名是否运行 aiohttp 服务器并启用了静态文件服务。如果确认服务器使用了 aiohttp，POC 会构造包含多个 `../` 的 URL，尝试读取 `/etc/passwd` 文件。如果成功读取到该文件（判断依据是响应中包含 `root:`），POC 会将 URL 和文件内容发送到预定义的 Discord webhook。

**投毒风险分析：**
代码中存在以下潜在的投毒风险：

*   **Discord Webhook:**  POC 代码包含一个 Discord webhook URL。虽然这本身不一定是恶意行为，但攻击者可能会利用此 webhook 收集目标信息。攻击者可能会监控此webhook来确定哪些目标容易受到攻击，并且提取有价值的信息。Webhook本身的存在并不直接表明投毒，但是它确实增加了额外的风险。可以被滥用以收集信息或进行进一步的攻击。
*   **域名收集：** `domain_collector.py`文件收集域名。收集的域名的意图可能用于其他恶意活动，例如网络钓鱼或垃圾邮件。
*   **证书流依赖：**代码依赖外部证书流服务，如果服务本身被攻陷或提供恶意信息，可能导致误报或者执行恶意操作。此外，对域名长度的限制（小于15个字符）非常奇怪，可能被用于绕过检测。

综合考虑，投毒风险评估为10%。主要风险点在于 Discord webhook 和 域名收集模块，以及对域名长度的限制。攻击者可以通过监控webhook来确定哪些目标服务器容易受到攻击，并且提取有价值的信息。

**利用方式：**
1.  **确定目标：** 扫描目标服务器，识别运行 aiohttp 且启用了静态文件服务的服务器。确认 `follow_symlinks` 选项设置为 `True`。
2.  **构造恶意 URL：**  构造包含 `../` 的 URL，例如 `/static/../../../../etc/passwd`。`../` 的数量需要根据静态文件目录的深度进行调整，确保能够穿越到根目录。
3.  **发送请求：**  向目标服务器发送构造好的 URL 的 HTTP GET 请求。
4.  **提取信息：**  如果服务器存在漏洞，将会返回被穿越访问的文件内容。攻击者可以提取其中的敏感信息，例如用户名、密码哈希等。

**项目地址:** [sxyrxyy/aiohttp-exploit-CVE-2024-23334-certstream](https://github.com/sxyrxyy/aiohttp-exploit-CVE-2024-23334-certstream)

**漏洞详情:** [CVE-2024-23334](https://nvd.nist.gov/vuln/detail/CVE-2024-23334)