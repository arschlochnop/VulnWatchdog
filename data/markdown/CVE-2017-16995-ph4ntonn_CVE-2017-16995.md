## CVE-2017-16995-Linux Kernel BPF 权限提升

**漏洞编号:** CVE-2017-16995

**漏洞类型:** 本地权限提升 (LPE)

**影响应用:** Linux Kernel

**危害等级:** 高危，可从普通用户提升到root权限

**影响版本:** <= 4.4

**利用条件:** 本地用户权限，需要开启 BPF syscall (CONFIG_BPF_SYSCALL)

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2017-16995 漏洞存在于 Linux Kernel 的 BPF 验证器 (verifier.c) 中的 `check_alu_op` 函数中。由于不正确的符号扩展，本地用户可以利用此漏洞导致拒绝服务（内存损坏）或可能造成未指定的其他影响，例如权限提升。

**有效性:**
根据漏洞库信息和搜索结果，该漏洞影响 Linux kernel 4.4 及更早版本，并有多个公开可用的exp。
提供的POC代码 `exp.c` 似乎是漏洞利用程序，它使用了 `bpf_prog_load` 和 `bpf_create_map` 等系统调用来加载恶意 BPF 程序并创建 BPF map。该程序旨在通过利用 BPF 验证器中的符号扩展错误来覆盖内核内存，从而实现权限提升。因此，提供的POC代码大概率有效。

**投毒风险:**
分析POC代码：
*   代码本身比较短小，主要功能是加载和运行 BPF 程序。没有明显的恶意行为，如反向shell、持久化等。
*   代码依赖于`__prog`变量，该变量定义了实际的 BPF 指令。攻击的核心逻辑都在这个BPF程序中。需要进一步分析该 BPF 程序。
*  BPF 程序通过 `bpf_update_elem` 和 `bpf_lookup_elem` 和map进行交互。
从代码层面看，没有发现明显的后门。但由于 BPF 指令是二进制形式，难以直接分析其行为。潜在的投毒可能隐藏在 BPF 指令中，例如修改 BPF 指令以执行预期之外的内核操作，或者尝试利用其他内核漏洞，或者通过侧信道泄露信息，因此存在一定的投毒风险。代码编译后，实际运行的指令与源代码指令可能会有出入,作者有可能在编译的二进制文件中动手脚,但由于缺少可执行的二进制程序,所以无法判断。
综合考虑，POC代码的投毒风险较低，估计为10%。

**利用方式:**
1.  **漏洞触发:** 攻击者构造一个恶意的 BPF 程序，其中包含会导致 `check_alu_op` 函数中符号扩展错误的指令。
2.  **内存损坏:** 当 BPF 验证器检查到错误的指令时，会发生内存损坏。这可以允许攻击者覆盖内核内存的特定部分，例如当前用户的凭据结构体。
3.  **权限提升:** 通过覆盖凭据结构体中的 UID、EUID、GID 和 EGID 等字段，攻击者可以将自己的权限提升到 root。
4.  **代码执行流程:** 程序首先创建了一个 BPF map，然后加载了一个 socket 过滤器类型的 BPF 程序。接着， BPF 程序被执行，利用漏洞进行提权。

**项目地址:** [ph4ntonn/CVE-2017-16995](https://github.com/ph4ntonn/CVE-2017-16995)

**漏洞详情:** [CVE-2017-16995](https://nvd.nist.gov/vuln/detail/CVE-2017-16995)