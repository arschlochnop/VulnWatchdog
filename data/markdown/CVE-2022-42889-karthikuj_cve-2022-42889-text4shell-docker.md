## CVE-2022-42889-Apache Commons Text-RCE

**漏洞编号:** CVE-2022-42889

**漏洞类型:** 远程代码执行（RCE）

**影响应用:** Apache Commons Text

**危害等级:** 高危，可能导致服务器完全控制

**影响版本:** 1.5 <= version <= 1.9

**利用条件:** 应用程序使用受影响版本的 Apache Commons Text 并且允许用户控制输入到变量插值器的字符串。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2022-42889，又名 Text4Shell，是 Apache Commons Text 库中的一个漏洞，允许攻击者通过精心构造的字符串执行任意代码。漏洞原因是 `StringSubstitutor` 类在默认情况下启用了一些不安全的 lookup，例如 `script`、`dns` 和 `url`。 攻击者可以将这些 lookup 嵌入到用户可控的字符串中，从而执行任意代码或进行其他恶意操作。 

**有效性：**
根据提供的漏洞信息、搜索结果和漏洞利用代码，该漏洞是有效的。漏洞库信息明确指出受影响的版本存在 RCE 风险。搜索结果也证实了该漏洞的存在以及严重性。提供的 POC 代码演示了如何利用 `script` lookup 执行任意命令。`pom.xml` 文件中使用的是 `commons-text` 的 1.8 版本，属于受影响的版本范围内。

**投毒风险：**
提供的代码库主要是为了演示漏洞利用。投毒风险较低，大概10%。以下是分析：
  *   **Dockerfile:** Dockerfile 仅用于构建包含漏洞应用的 Docker 镜像，没有发现恶意行为。
  *   **README.md:** README 文件提供了构建、运行和测试漏洞的步骤，本身不包含恶意代码。
  *   **pom.xml:** pom.xml 文件定义了项目的依赖和构建配置，其中的 commons-text 版本 1.8 存在漏洞，但这是为了演示漏洞本身，不属于投毒。
  *   **src/main/java:** Java 源代码实现了漏洞利用所需的变量插值逻辑，利用了 commons-text 的漏洞特性，以展示利用方法。虽然本身是漏洞利用，但并不构成投毒。
  *   **src/test/java:**  测试文件只是一个占位符，没有实际测试代码，因此没有投毒风险。

**潜在的轻微投毒风险点是作者可能在构建好的jar包中加入一些隐藏的后门,虽然代码中没有体现。**

**利用方式：**
1.  应用程序使用 Apache Commons Text 1.5 到 1.9 版本。
2.  应用程序允许用户控制输入到 `StringSubstitutor.replace()` 方法的字符串。
3.  攻击者在输入字符串中插入包含恶意 lookup 的表达式，例如 `${script:javascript:java.lang.Runtime.getRuntime().exec('command')}`。
4.  `StringSubstitutor` 解析表达式并执行其中的代码。

**防范措施：**
1.  升级到 Apache Commons Text 1.10.0 或更高版本，该版本默认禁用了不安全的 lookup。
2.  如果无法升级，请配置 `StringSubstitutor` 实例以禁用不安全的 lookup。
3.  对用户输入进行严格的验证和过滤，防止恶意表达式注入。

**项目地址:** [karthikuj/cve-2022-42889-text4shell-docker](https://github.com/karthikuj/cve-2022-42889-text4shell-docker)

**漏洞详情:** [CVE-2022-42889](https://nvd.nist.gov/vuln/detail/CVE-2022-42889)