## CVE-2024-47051 - Mautic 远程代码执行和文件删除

**漏洞编号:** CVE-2024-47051

**漏洞类型:** 远程代码执行 (RCE) 和 路径遍历文件删除

**影响应用:** Mautic

**危害等级:** 高危，可能导致服务器完全控制、数据丢失和拒绝服务

**影响版本:** < 5.2.3

**利用条件:** 需要已认证的用户身份

**POC 可用性:** 是，但未完全公开

**投毒风险:** 5%

## 详情

CVE-2024-47051 存在于 Mautic 5.2.3 之前的版本中，允许经过身份验证的用户执行以下操作：

**1. 远程代码执行 (RCE):**
   - 漏洞位于 Asset 编辑功能中，对上传文件的内容、类型和扩展名的清理不当。
   - 攻击者可以绕过文件扩展名限制，上传恶意的 PHP 脚本或其他可执行文件。
   - 具体而言，`app/Bundles/AssetBundle/Entity/Asset.php` 中的 `preUpload()` 方法存在缺陷。通过构造请求，攻击者可以使 `$this->getFile()->guessExtension()` 返回 NULL，从而利用 `pathinfo()` 函数提取文件扩展名，允许上传任意扩展名的文件。
   - `upload()` 方法随后将文件写入 Web 目录，导致 RCE。
   - 可以通过修改现有Asset或创建新的Asset进行攻击。

**2. 路径遍历文件删除:**
   - 在验证临时上传时，用于存储临时文件的目录会在请求结束时被递归删除。
   - 攻击者可以利用路径遍历漏洞，操纵临时目录的名称，从而删除系统上 Web 用户具有权限的任何目录。
   - 这可能导致数据丢失，甚至破坏整个文件系统（如果服务器以 root 用户身份运行）。

**有效性:**
提供的PoC代码描述了漏洞原理，但并未提供完整的可执行脚本。然而，代码中提供的细节，比如涉及的文件和函数(`app/Bundles/AssetBundle/Controller/AssetController.php`, `app/Bundles/AssetBundle/Entity/Asset.php`, `preUpload()`, `upload()`)，以及攻击的步骤，足以重现该漏洞。搜索结果中指向的GitHub链接(`https://github.com/mallo-m/CVE-2024-47051`)表明存在一个可用的PoC，尽管可能尚未完全公开。

**投毒风险:**
此仓库的主要目的是展示漏洞利用方法，而非提供完整的攻击脚本。投毒风险较低，约 5%。风险点在于，如果公开的PoC中包含恶意代码或不安全的操作，可能会导致攻击者在利用漏洞时意外地破坏目标系统，或者暴露自己的攻击行为。

**利用方式:**

1.  **RCE：**
    *   登录到 Mautic 实例。
    *   访问 Asset 编辑页面（`/assets/view/{assetID}`）或创建新Asset页面(`/s/assets/new`)。
    *   上传一个包含恶意 PHP 代码的文件，并利用 `preUpload()` 方法的缺陷，绕过文件扩展名限制。
    *   刷新 Asset 详情页面，获取上传文件的名称。
    *   通过访问上传的 PHP 文件，执行恶意代码。
2.  **路径遍历文件删除：**
    *   登录到 Mautic 实例。
    *   发起新的 Asset 创建或编辑请求（`/s/assets/new` 或 `/s/assets/edit/{assetId}`）。
    *   在请求中，将用于指定临时目录名称的参数设置为包含路径遍历序列（例如 `../../../../`）的恶意值，指向要删除的目标目录。
    *   提交请求，服务器将尝试删除目标目录及其内容。

**项目地址:** [mallo-m/CVE-2024-47051](https://github.com/mallo-m/CVE-2024-47051)

**漏洞详情:** [CVE-2024-47051](https://nvd.nist.gov/vuln/detail/CVE-2024-47051)