## CVE-2024-4577 - PHP-CGI Argument Injection

**漏洞编号:** CVE-2024-4577

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** PHP

**危害等级:** 高危，允许攻击者执行任意代码。

**影响版本:** PHP 8.1.* before 8.1.29, 8.2.* before 8.2.20, 8.3.* before 8.3.8，在Windows系统上，运行在CGI模式下

**利用条件:** 需要目标系统是Windows，PHP运行在CGI模式下，并且系统使用了某些代码页，开启了"Best Fit"策略。

**POC 可用性:** 是

**投毒风险:** 50%

## 详情

CVE-2024-4577是一个PHP-CGI中的参数注入漏洞，影响运行在Windows上的PHP。当PHP以CGI模式运行时，Windows系统的"Best Fit"代码页转换可能导致恶意字符被错误地解释为PHP选项，从而允许攻击者向PHP二进制文件传递参数。这可以用来泄露源代码，执行任意PHP代码，或者直接在服务器上运行命令。

**有效性：**

根据漏洞信息和搜索结果，该漏洞的PoC已经公开，并且在野外被积极利用。提供的`CVE-2024-4577.go` 和 `CVE-2024-4577.py` 文件都是利用此漏洞的检测代码。它们通过构造包含恶意PHP选项的URL，向目标服务器发送POST请求，并检查返回的响应是否包含`PHP Version`字符串，来判断目标是否存在漏洞。这些代码的功能是探测漏洞是否存在，利用了`allow_url_include`和`auto_prepend_file`两个PHP配置项来远程包含和执行`phpinfo()`代码。

**投毒风险：**

分析`CVE-2024-4577.go`的代码，发现其中包含一个名为`nFPfVl()`的函数。该函数经过混淆处理，但其作用是从字符串数组中提取数据，拼接成一个URL，并使用`/bin/sh -c`执行该URL。这是一种潜在的后门行为，意味着在漏洞验证过程中，如果目标系统存在漏洞，这段代码可能会下载并执行来自该URL的恶意代码。考虑到这段代码的存在，可以认为该Go程序存在一定的投毒风险，但该后门在golang代码中只会在扫描的时候触发，相对隐蔽。`CVE-2024-4577.py`看起来是正常的poc代码。

基于分析，综合评估认为`CVE-2024-4577.go`有50%的投毒风险，`CVE-2024-4577.py`没有投毒风险

**利用方式：**

1.  **确定目标环境：** 目标服务器必须是Windows系统，并且PHP以CGI模式运行。
2.  **利用代码页转换：** 攻击者需要利用Windows系统的"Best Fit"代码页转换，构造包含恶意PHP选项的URL。
3.  **参数注入：** 通过精心构造的URL，将恶意参数注入到PHP二进制文件中。
4.  **远程代码执行：** 利用`allow_url_include`和`auto_prepend_file`等PHP配置项，执行任意PHP代码或者直接执行系统命令。
5.  **检测漏洞：** 通过检查响应的内容，可以判断目标是否存在漏洞，例如检查`PHP Version`字符串。

**项目地址:** [cheerfulempl/CVE-2024-4577-PHP-RCE](https://github.com/cheerfulempl/CVE-2024-4577-PHP-RCE)

**漏洞详情:** [CVE-2024-4577](https://nvd.nist.gov/vuln/detail/CVE-2024-4577)