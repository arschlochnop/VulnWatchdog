## CVE-2024-6387-OpenSSH-竞争条件导致RCE/DoS

**漏洞编号:** CVE-2024-6387

**漏洞类型:** 竞争条件

**影响应用:** OpenSSH

**危害等级:** 高危，可能导致远程代码执行和拒绝服务

**影响版本:** 8.5p1 <= version <= 9.7p1

**利用条件:** 需要目标系统运行存在漏洞版本的OpenSSH服务，且攻击者能够建立SSH连接，并在认证超时前发送恶意数据。

**POC 可用性:** 是

**投毒风险:** 30%

## 详情

CVE-2024-6387 是 OpenSSH 服务器 (sshd) 中的一个安全回归漏洞，存在于glibc的linux系统。它源于一个信号处理程序中的竞争条件，可能导致sshd以不安全的方式处理某些信号。未经身份验证的远程攻击者可以通过在设定的时间内未能通过身份验证来触发此漏洞，从而可能导致远程代码执行（RCE）或拒绝服务（DoS）。

**有效性：**

根据漏洞库信息、搜索结果和提供的POC代码，该漏洞是有效的。多个来源都确认了该漏洞的存在以及其远程代码执行的潜力。POC代码的存在进一步支持了其可利用性。

**投毒风险：**

POC代码本身包含以下潜在的投毒风险点：

*   **Shellcode占位符:** 代码中明确提到 `Shellcode placeholder (replace with actual shellcode)`。如果用户直接使用未经审查的 shellcode，则可能引入恶意行为。此处的风险不在于作者投毒，而在于用户使用不当。
*   **GLIBC_BASES:**  `GLIBC_BASES[]` 数组包含可能的 glibc 基地址。如果这个地址不准确，利用将失败。如果作者故意提供错误的地址，可能会导致拒绝服务或误导分析。
*   **Timing parameters:** 注释提到需要根据目标系统调整 timing 参数。错误的 timing 可能导致利用失败或系统不稳定。
*   **Heap layout 和 File structure offsets:**  代码注释中也强调了需要针对不同的 OpenSSH 和 glibc 版本进行调整，否则利用会失败。故意设置错误的值可能导致程序崩溃或产生其他未定义行为。
*   **随机数生成:** 代码使用 `srand(time(NULL))` 初始化随机数生成器。虽然这本身不是投毒，但如果后续利用中依赖于可预测的随机数，可能会被利用。

总体评估投毒风险为30%。风险主要来自于需要用户自行替换的shellcode，以及需要用户根据目标环境配置的参数。作者本身隐藏恶意代码的可能性较低，但用户在使用过程中存在引入风险的可能性。

**利用方式：**

1.  **建立连接：** 攻击者首先需要建立与目标 OpenSSH 服务器的连接。
2.  **SSH握手：** 进行初步的SSH握手过程，包括版本协商和密钥交换的初始化，但无需完成身份认证。
3.  **堆准备：**  `prepare_heap` 函数的目的是在堆上创建特定的布局，为后续的利用创造条件。具体实现细节未给出，但可能涉及分配和释放内存，以控制堆的状态。
4.  **时间测量：** `time_final_packet` 函数测量服务器处理特定数据包所需的时间。这个时间信息对于后续的竞争条件利用至关重要。
5.  **竞争条件：**  `attempt_race_condition` 函数尝试触发漏洞的核心：信号处理程序中的竞争条件。这通常涉及发送一个精心构造的数据包，该数据包会在服务器处理过程中触发 SIGALRM 信号。由于信号处理程序使用了异步信号不安全函数，因此可能导致堆损坏。
6.  **代码执行：**  如果竞争条件成功触发，攻击者就可以利用堆损坏来执行任意代码。这通常涉及覆盖函数指针或控制程序的执行流程。

该漏洞的利用依赖于精确的 timing 和对目标系统内存布局的了解。攻击者需要进行大量的尝试才能成功利用该漏洞。

**项目地址:** [HadesNull123/CVE-2024-6387_Check](https://github.com/HadesNull123/CVE-2024-6387_Check)

**漏洞详情:** [CVE-2024-6387](https://nvd.nist.gov/vuln/detail/CVE-2024-6387)