## CVE-2020-0688 Microsoft Exchange Server 远程代码执行漏洞

**漏洞编号:** CVE-2020-0688

**漏洞类型:** 远程代码执行

**影响应用:** Microsoft Exchange Server

**危害等级:** 高危，可完全控制 Exchange 服务器

**影响版本:** 受影响版本包括：Microsoft Exchange Server 2010 SP3 UR30, 2013 CU23, 2016 CU14/CU15, 2019 CU3/CU4

**利用条件:** 攻击者需要有效的 Exchange 用户凭据才能利用此漏洞，或能够获取到有效的ASP.NET_SessionId

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2020-0688 是一个 Microsoft Exchange Server 的远程代码执行漏洞，存在于 Exchange Control Panel (ECP) 组件中。该漏洞是由于 ECP 在生成 ViewState 时使用了静态密钥进行加密，导致攻击者可以通过已知的密钥构造恶意的 ViewState 数据，从而在服务器上执行任意代码。

**有效性：**
根据漏洞库信息、搜索引擎结果和提供的 POC 代码，可以确定此漏洞的 POC 代码是有效的。多个来源表明 CVE-2020-0688 已经被广泛利用，并且存在公开的 POC 代码。

**投毒风险：**
提供的 POC 代码 `fuckchina_v2.py`  包含了以下信息，可能存在投毒风险：
*   作者声明免责声明，表明对非法行为不负责任。
*   代码中使用了`WScript.Shell`对象来执行系统命令，存在潜在的风险。

考虑到代码的开源性质和用途，认为投毒风险较低，大约为10%。这主要是因为攻击者可以审查和修改代码，以适应他们的需要。因此，任何潜在的投毒代码都可能被检测到并删除。

**利用方式：**
1.  **获取 Exchange 用户凭据或有效的 ASP.NET_SessionId：** 攻击者需要有效的 Exchange 用户凭据，或者能够获取到有效的 ASP.NET_SessionId。
2.  **泄露 __VIEWSTATEGENERATOR 值：** 攻击者需要访问 `/ecp/default.aspx` 页面，并从中提取 __VIEWSTATEGENERATOR 值。如果无法提取，则尝试默认值 `B97B4E27`。
3.  **构造恶意的 ViewState 数据：** 使用泄露的 __VIEWSTATEGENERATOR 值和已知的静态密钥，攻击者可以构造恶意的 ViewState 数据，其中包含要执行的恶意代码。
4.  **发送包含恶意 ViewState 数据的请求：** 攻击者将构造的恶意 ViewState 数据通过 POST 请求发送到 ECP 的某个页面，例如 `default.aspx`。
5.  **执行远程代码：** Exchange 服务器在处理包含恶意 ViewState 数据的请求时，会反序列化 ViewState 数据并执行其中的恶意代码，从而导致远程代码执行。

`fuckchina_v2.py`脚本通过上传一个C#编写的ASPX webshell来实现RCE。 webshell 使用 XML 和 XSLT 来绕过 ViewState 的默认大小限制，并执行 `cmd /c` 命令。

**项目地址:** [w4fz5uck5/cve-2020-0688-webshell-upload-technique](https://github.com/w4fz5uck5/cve-2020-0688-webshell-upload-technique)

**漏洞详情:** [CVE-2020-0688](https://nvd.nist.gov/vuln/detail/CVE-2020-0688)