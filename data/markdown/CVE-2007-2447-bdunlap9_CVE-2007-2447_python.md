## CVE-2007-2447-Samba-远程命令执行

**漏洞编号:** CVE-2007-2447

**漏洞类型:** 远程命令执行

**影响应用:** Samba

**危害等级:** 高危，可能导致系统被完全控制

**影响版本:** 3.0.0 到 3.0.25rc3

**利用条件:** 目标Samba服务器启用了"username map script"选项（对于SamrChangePassword函数利用）或者允许远程用户进行打印机或文件共享管理（对于其他MS-RPC函数利用），需要知道目标IP和端口。

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2007-2447 漏洞存在于 Samba 3.0.0 到 3.0.25rc3 版本的 smbd 服务中。该漏洞允许远程攻击者通过 MS-RPC 功能，利用 shell 元字符执行任意命令。

**漏洞利用方式：**

1.  **SamrChangePassword 函数：** 当 Samba 配置中的 `username map script` 选项被启用时，攻击者可以向 SamrChangePassword 函数传递包含 shell 元字符的恶意用户名，从而执行任意命令。
2.  **其他 MS-RPC 函数 (打印机/文件共享管理)：** 经过身份验证的远程用户可以通过其他 MS-RPC 函数（例如用于管理远程打印机和文件共享的函数）中的 shell 元字符执行命令。

**POC 代码分析：**

提供的 Python POC 代码 `samba_Usermap.py` 针对的是利用 `username map script` 选项的 SamrChangePassword 函数漏洞。

*   代码使用 `smb.SMBConnection` 库来建立 SMB 连接。
*   它将包含 shell 命令的 payload 嵌入到用户名中（user = '`/nohup ' + self.payload + '`'）。这里使用nohup是为了保证执行的命令在连接断开后依然执行
*   通过 SMB 连接尝试连接到目标服务器，触发漏洞。

**有效性评估：**

根据漏洞描述和 POC 代码，该代码**有效**，可以用来在目标系统上执行任意命令，如果目标Samba服务器版本在受影响范围内，且满足 "username map script" 启用或者允许进行打印或文件共享管理等条件。

**投毒风险评估：**

该 POC 代码相对简单，主要功能是构造恶意的用户名并尝试建立 SMB 连接。代码中可能存在极小的投毒风险（例如，作者在 payload 构造上做手脚，使得 payload 在特定情况下执行恶意操作），但从代码逻辑上来看，投毒概率较低。评估的投毒风险为 5%。主要是因为该脚本调用外部命令执行，存在一定的潜在风险。


**项目地址:** [bdunlap9/CVE-2007-2447_python](https://github.com/bdunlap9/CVE-2007-2447_python)

**漏洞详情:** [CVE-2007-2447](https://nvd.nist.gov/vuln/detail/CVE-2007-2447)