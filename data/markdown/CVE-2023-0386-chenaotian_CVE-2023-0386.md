## CVE-2023-0386 OverlayFS 本地提权漏洞

**漏洞编号:** CVE-2023-0386

**漏洞类型:** 本地提权

**影响应用:** Linux Kernel OverlayFS

**危害等级:** 高危，可导致本地权限提升

**影响版本:** 5.11 ~ 5.19

**利用条件:** 需要能够 unshare 或创建 overlay 文件系统

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

该漏洞存在于 Linux 内核的 OverlayFS 子系统中，允许本地用户通过利用 OverlayFS 的特性，结合用户命名空间绕过权限检查，从而将权限提升为 root。

**漏洞利用方式：**

1.  **环境准备：** 准备一个存在漏洞的 Linux 内核环境（版本 5.11 ~ 5.19），确保内核配置启用了 OverlayFS 和 FUSE 文件系统。
2.  **创建用户命名空间：** 使用 `unshare` 命令创建一个新的用户命名空间。在新命名空间中，创建者拥有 root 权限，但初始命名空间的 root 用户未被映射，会被识别为 nobody。
3.  **创建 OverlayFS 文件系统：** 创建 OverlayFS 文件系统，包含 lowerdir（只读层） 和 upperdir（可写层）。将一个具有 setuid 权限的可执行文件放置在 lowerdir 中，且该文件的属主在当前用户命名空间中没有映射(nobody)。
4.  **触发漏洞：**  当尝试执行 lowerdir 中的 setuid 程序时，OverlayFS 会尝试将该文件拷贝到 upperdir。由于漏洞存在，拷贝过程会忽略用户命名空间的权限映射检查，导致该文件在 upperdir 中被赋予不正确的权限。
5.  **权限提升：**  执行 upperdir 中具有 setuid 权限的拷贝文件，由于权限不正确，攻击者可以利用它来执行任意代码，从而提升权限。

**有效性：**

根据漏洞信息和搜索结果，该漏洞利用代码利用 OverlayFS 在用户命名空间中拷贝文件时的权限检查缺陷，能够成功实现本地提权。提供的 POC 代码 `exp.c` 通过 FUSE 创建 OverlayFS 文件系统，并利用该漏洞。

**投毒风险：**

查看提供的代码文件，其中包含一个 README.md 和一个 exp.c 文件。README.md 文件只是描述了漏洞原理和编译运行方式，没有发现恶意代码。查看`exp.c`需要进一步的分析，才能确定是否存在后门。目前判断的投毒风险较低，暂时判定为 10%。后续需要进一步人工审计`exp.c`代码。


**项目地址:** [chenaotian/CVE-2023-0386](https://github.com/chenaotian/CVE-2023-0386)

**漏洞详情:** [CVE-2023-0386](https://nvd.nist.gov/vuln/detail/CVE-2023-0386)