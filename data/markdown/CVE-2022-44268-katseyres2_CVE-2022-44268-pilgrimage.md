## CVE-2022-44268-ImageMagick-任意文件读取

**漏洞编号:** CVE-2022-44268

**漏洞类型:** 任意文件读取

**影响应用:** ImageMagick

**危害等级:** 高危，可能导致敏感信息泄露

**影响版本:** 7.1.0-49 (以及可能更早的版本，例如6.9.11-60)

**利用条件:** ImageMagick需要解析攻击者可控的PNG图像。

**POC 可用性:** 是

**投毒风险:** 1%

## 详情

CVE-2022-44268 漏洞存在于 ImageMagick 中，当其解析 PNG 图像时，可能允许攻击者读取服务器上的任意文件。漏洞利用方式是构造一个特殊的 PNG 图像，该图像的 text chunk 中包含了要读取的文件路径。当 ImageMagick 处理此图像（例如，进行缩放）时，会将指定文件的内容嵌入到生成的图像中，从而实现信息泄露。

**有效性评估：**

根据漏洞描述和提供的 PoC 代码，该漏洞利用方法是有效的。PoC 代码通过以下步骤利用该漏洞：

1.  **生成恶意 PNG 图像 (`src/main.rs`)：**  `src/main.rs`  使用 `png` crate 生成一个 PNG 图像。关键之处在于，它使用 `encoder.add_text_chunk` 函数将目标文件路径（例如 `/etc/passwd`）作为 `profile` 文本 chunk 的值嵌入到 PNG 图像的 header 中。这个恶意构造的PNG图片命名为 `image.png`。
2.  **上传 PNG 图像 (`script.py`)：** `script.py` 脚本将 `image.png` 上传到目标服务器的 `/` 路径，通过 `requests` 库模拟 HTTP POST 请求，服务器处理该图像。
3.  **下载处理后的图像 (`script.py`)：** 服务器使用 ImageMagick 处理上传的图像，由于漏洞的存在，目标文件的内容被嵌入到图像中。脚本从服务器下载处理后的图像(`infected.png`)。
4.  **提取嵌入的文件内容 (`script.py`)：** 脚本使用 `identify -verbose` 命令（ImageMagick 的一部分）来提取 PNG 图像中的文本数据，然后提取包含文件内容的长十六进制字符串并将其解码，最后保存到 `decoded` 文件中。
5.  **自动化流程 (`main.sh`)**: `main.sh` 通过循环运行 `script.py` 三次，然后将 `decoded` 文件的内容打印到标准输出。

根据README的描述，该POC已经在 ImageMagick v. 7.1.0-48 和 6.9.11-60上测试通过。

**投毒风险分析：**

评估仓库中作者隐藏的投毒代码的风险，风险较低：1%。代码整体结构比较简单，`script.py` 的主要功能是上传、下载和解码图像，恶意行为不太容易隐藏。
主要风险点在于  `subprocess.Popen`  的使用，尤其是  `shell=True` 。虽然这里执行的命令看起来无害（`cargo run`、`identify`），但如果攻击者能够控制 `file_to_read` 变量，仍然可能通过命令注入执行恶意代码。但是，因为这个 `file_to_read` 来源于外部输入，属于漏洞利用的一部分，而不是作者恶意添加的后门，所以判定投毒风险较低。

**漏洞利用方式总结：**

1.  利用 ImageMagick 处理 PNG 图像时存在的任意文件读取漏洞 (CVE-2022-44268)。
2.  通过构造包含目标文件路径的 PNG 图像，诱使 ImageMagick 读取该文件。
3.  从处理后的图像中提取文件内容。

**项目地址:** [katseyres2/CVE-2022-44268-pilgrimage](https://github.com/katseyres2/CVE-2022-44268-pilgrimage)

**漏洞详情:** [CVE-2022-44268](https://nvd.nist.gov/vuln/detail/CVE-2022-44268)