## CVE-2019-5420 - Rails Development Mode Remote Code Execution

**漏洞编号:** CVE-2019-5420

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Rails

**危害等级:** 高危，可能导致服务器完全控制

**影响版本:** < 5.2.2.1, < 6.0.0.beta3

**利用条件:** Rails 应用运行于开发模式，且能被公开访问

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2019-5420 漏洞存在于 Rails 框架的开发模式下。由于在开发模式下，Rails 会自动生成一个 secret token，并且这个 token 的生成方式存在缺陷，攻击者可以猜测到该 token。

**利用方式：**

1.  **获取 Cookie:** 攻击者首先需要获取目标 Rails 应用的 Cookie。
2.  **猜测 Secret Token:**  攻击者使用应用名称（appname）通过MD5哈希和PBKDF2算法推导出密钥。
3.  **解密 Cookie:** 使用猜测到的 secret token 解密 Cookie，得到 session 数据。
4.  **篡改 Session:**  篡改 session 数据，例如将 `user_id` 修改为 `1`，从而冒充管理员或其他用户。
5.  **重新加密 Cookie:** 使用猜测到的 secret token 重新加密篡改后的 session 数据，生成新的 Cookie。
6.  **发送恶意 Cookie:** 将新的 Cookie 发送给目标 Rails 应用。

**POC 分析：**

提供的 Python 脚本 `cve-2019-5420.py` 实现了上述利用方式。脚本接收 Cookie 和应用名称作为参数，解密、篡改、重新加密 Cookie，并输出新的 Cookie。该脚本依赖 `Cryptodome` 库。

**投毒风险评估：**

该代码的主要功能是利用漏洞，本身不包含恶意后门代码。但是，存在极低的投毒风险（估计为5%），原因如下：

*   **依赖安装**: 攻击者可能会修改安装依赖（如`Cryptodome`），引入包含恶意代码的第三方库。
*   **代码执行**: 如果目标服务器直接执行未经审计的脚本，可能存在其他安全风险，但这不是脚本本身造成的。

**总结：**

该漏洞利用代码有效，攻击者可以利用它来篡改 session 数据，从而进行权限提升或其他恶意操作。但是，需要注意的是，该漏洞只存在于 Rails 应用的开发模式下，并且需要攻击者能够访问到目标应用。此外，代码中存在极低的投毒风险。建议在生产环境中禁用开发模式，并使用强密码作为 secret token。

**项目地址:** [Eremiel/CVE-2019-5420](https://github.com/Eremiel/CVE-2019-5420)

**漏洞详情:** [CVE-2019-5420](https://nvd.nist.gov/vuln/detail/CVE-2019-5420)