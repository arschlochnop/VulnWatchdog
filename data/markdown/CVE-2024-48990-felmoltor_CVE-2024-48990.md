## CVE-2024-48990-needrestart-权限提升

**漏洞编号:** CVE-2024-48990

**漏洞类型:** 权限提升

**影响应用:** needrestart

**危害等级:** 高危，允许本地用户以root权限执行任意代码

**影响版本:** < 3.8

**利用条件:** 需要本地用户权限，以及needrestart版本低于3.8

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2024-48990 漏洞存在于 needrestart 3.8 之前的版本中。该漏洞允许本地攻击者通过欺骗 needrestart 使用攻击者控制的 PYTHONPATH 环境变量来以 root 权限执行任意代码。利用方式如下：

1.  **漏洞原理：** needrestart 在扫描需要重启的服务时，会使用 Python 解释器执行一些脚本。如果攻击者能够控制 `PYTHONPATH` 环境变量，就可以让 Python 解释器加载攻击者提供的恶意模块，从而执行任意代码。
2.  **POC 代码分析：**
    *   `exploit.sh`：主脚本，负责编译恶意库、运行循环脚本、等待提权后的root shell，最后执行root shell。
    *   `library.c`：恶意 Python 库的 C 源代码。当 Python 解释器加载该库时，`PyInit_importlib` 函数会被执行。此函数将一个可执行文件的所有者更改为root，并设置SUID权限。攻击者需提前编译一个提权的shell,然后通过library.c植入SUID权限。
    *   `loop.py`：一个简单的 Python 脚本，无限循环，目的是为了让 needrestart 有机会执行扫描操作。
    *   `rootshell.c`：一个简单的 C 语言程序，它将当前进程的 UID 和 GID 设置为 0（root），然后执行 `/bin/bash`，从而获得 root shell。
3.  **利用方式：**
    a.  攻击者编译`rootshell.c`生成提权shell。
    b.  攻击者编译恶意库 `library.c`，生成 `importlib/__init__.so` 文件。需要注意的是，编译library.c时需要python3的头文件。
    c.  攻击者设置 `PYTHONPATH` 环境变量，指向包含恶意库的目录。
    d.  攻击者运行 `exploit.sh` 脚本。脚本会启动`loop.py`，目的是为了触发needrestart。
    e.  needrestart 在扫描服务时，会使用 Python 解释器加载恶意库，执行其中的恶意代码。
    f.  恶意代码将`rootshell`所有者改为root,并赋予SUID权限。
    g.  `exploit.sh`检测到root shell被成功提权后，执行`rootshell`获得 root shell。
4.  **有效性：** 提供的 POC 代码看起来有效，可以利用此漏洞提升权限。
5.  **投毒风险：** 根据提供的代码，没有发现明显的投毒代码。所有代码都直接用于实现权限提升。攻击者可能会通过修改代码逻辑或添加额外的恶意功能来进行投毒，但就目前的代码而言，可以认为投毒风险较低（0%）。

**项目地址:** [felmoltor/CVE-2024-48990](https://github.com/felmoltor/CVE-2024-48990)

**漏洞详情:** [CVE-2024-48990](https://nvd.nist.gov/vuln/detail/CVE-2024-48990)