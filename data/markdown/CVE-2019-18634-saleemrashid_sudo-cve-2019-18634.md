## CVE-2019-18634-Sudo-Stack Buffer Overflow

**漏洞编号:** CVE-2019-18634

**漏洞类型:** 栈缓冲区溢出

**影响应用:** Sudo

**危害等级:** 高危，可能导致权限提升

**影响版本:** < 1.8.26

**利用条件:** pwfeedback 在 /etc/sudoers 中启用

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2019-18634 漏洞是 Sudo 1.8.26 之前版本中存在的一个栈缓冲区溢出漏洞。当 /etc/sudoers 文件中启用了 `pwfeedback` 选项时，攻击者可以通过向 `getln()` 函数的 stdin 传递一个过长的字符串来触发此漏洞，从而导致权限提升。

**有效性：**
根据漏洞信息、搜索结果和提供的漏洞利用代码，可以判断该漏洞是有效的。

*   漏洞库信息明确指出，在启用 `pwfeedback` 的情况下，用户可以触发栈缓冲区溢出。
*   搜索结果中包含 NVD、Red Hat 等多个来源的确认信息。
*   Plazmaz 在 Github 上发布了功能性漏洞利用代码。
*   提供的 PoC 代码看起来也实现了漏洞的利用。这个PoC 代码尝试通过创建一个伪终端，并向 sudo 发送大量数据，从而触发缓冲区溢出。

**投毒风险：**
分析提供的PoC代码，不存在作者隐藏的恶意投毒代码。代码逻辑清晰，主要目标是利用缓冲区溢出漏洞进行提权。该代码包含以下几个部分：

1.  **main 函数：** 这是程序的入口点。
2.  **参数判断：**  判断是否被sudo作为askpass程序重新执行。如果是，则清除SUDO_ASKPASS环境变量，并将标准输入输出重定向到标准错误输出，然后执行shell。
3.  **伪终端分配：** 分配一个伪终端（pty），以确保Sudo以终端模式运行。这是利用漏洞的先决条件，因为漏洞利用依赖于`sudo_term_kill`变量，该变量只有在存在终端时才不为0。
4.  **终端设置：** 设置伪终端的属性，例如禁用原始模式下的预处理。更改 VEOF 字符，以避免与 TGP_ASKPASS 冲突。
5.  **构造payload：**精心构造的payload，包含大量的'A'字符，以及覆盖返回地址所需的地址。
6.  **触发漏洞：**通过`execlp`启动sudo，并使用管道将payload传递给sudo的密码输入。

因此，可以判断此仓库中不存在作者隐藏的投毒代码，投毒风险为 0%。

**利用方式：**
该漏洞的利用方式如下：

1.  **前提条件：** `pwfeedback` 选项必须在 `/etc/sudoers` 文件中启用。
2.  **创建伪终端：** 分配一个伪终端，用于绕过对终端的检查。
3.  **构造 Payload：** 构造一个过长的字符串，使其超出 `getln()` 函数的缓冲区大小，覆盖栈上的返回地址等关键数据。
4.  **触发漏洞：** 运行 `sudo` 命令，并使程序进入密码输入阶段。将构造好的 Payload 通过 stdin 发送给 `sudo` 进程，触发缓冲区溢出。
5.  **权限提升：** 通过覆盖返回地址，将程序控制流劫持到预先设定的 shellcode 或其他代码区域，从而实现权限提升。

**项目地址:** [saleemrashid/sudo-cve-2019-18634](https://github.com/saleemrashid/sudo-cve-2019-18634)

**漏洞详情:** [CVE-2019-18634](https://nvd.nist.gov/vuln/detail/CVE-2019-18634)