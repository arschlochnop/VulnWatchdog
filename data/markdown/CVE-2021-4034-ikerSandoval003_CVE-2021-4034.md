## CVE-2021-4034 Polkit pkexec 本地提权漏洞

**漏洞编号:** CVE-2021-4034

**漏洞类型:** 本地提权

**影响应用:** Polkit pkexec

**危害等级:** 高危，本地用户可提升至root权限

**影响版本:** all (受影响版本)

**利用条件:** 需要本地用户权限

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2021-4034 是 Polkit 的 pkexec 工具中的一个本地权限提升漏洞。pkexec 是一个 setuid 工具，允许非特权用户按照预定义的策略以特权用户身份运行命令。漏洞原因是 pkexec 在处理调用参数计数时存在错误，导致其尝试将环境变量作为命令执行。攻击者可以通过精心构造环境变量来诱使 pkexec 执行任意代码，从而获得 root 权限。

**利用方式：**

1.  **编译exploit代码：** 首先需要编译提供的cve-2021-4034.c, pwnkit.c，以及生成gconv-modules。
2.  **构造恶意环境变量：**  利用代码设置了一系列环境变量，如 `pwnkit.so:.`, `PATH=GCONV_PATH=.`, `CHARSET=PWNKIT` 等。 其中PATH被设置为当前目录, 使得动态链接器优先加载当前目录下的恶意动态链接库。
3.  **执行 pkexec：** 通过 `execve` 函数执行 `/usr/bin/pkexec`，并传递构造好的环境变量。
4.  **利用 gconv 机制提权：**  `pwnkit.c` 中的 `gconv_init` 函数会被调用，该函数将当前用户设置为 root 用户 (uid 0, gid 0)，然后执行 `/bin/sh`，从而获得 root shell。

**有效性：**

根据漏洞信息和利用代码，该 PoC 代码有效。多个信息源表明 CVE-2021-4034 漏洞已被积极利用，并且该 PoC 的实现方式与公开的漏洞利用方法一致。

**投毒风险：**

分析提供的代码，存在轻微的投毒风险，可能性为5%。 风险点在于Makefile中包含TRUE=/bin/bash, 以及拷贝该文件到GCONV_PATH中，如果攻击者替换/bin/bash为其他恶意程序，可能存在隐患。但是结合其他信息,认为其目的是为了方便利用,增加稳定性和兼容性。

总的来说，提供的 PoC 代码是有效的，且投毒风险较低。 该漏洞影响范围广，利用简单，危害性高。

**项目地址:** [ikerSandoval003/CVE-2021-4034](https://github.com/ikerSandoval003/CVE-2021-4034)

**漏洞详情:** [CVE-2021-4034](https://nvd.nist.gov/vuln/detail/CVE-2021-4034)