## CVE-2023-4911-glibc-本地提权

**漏洞编号:** CVE-2023-4911

**漏洞类型:** 本地提权

**影响应用:** glibc

**危害等级:** 高危，可导致本地权限提升至root

**影响版本:** 2.34 < version < 2.39

**利用条件:** 需要本地用户权限

**POC 可用性:** 是

**投毒风险:** 1%

## 详情

CVE-2023-4911，又名“Looney Tunables”，是一个glibc动态链接器ld.so中的缓冲区溢出漏洞。该漏洞源于处理GLIBC_TUNABLES环境变量时存在缺陷。 

**有效性：**

根据漏洞信息、搜索结果和提供的PoC代码，可以判断该漏洞利用是有效的。搜索结果中多个链接（如Qualys的博客、Uptycs的博客）都表明该漏洞存在可利用性，并且危害严重。提供的PoC代码也旨在利用该漏洞实现本地提权。

**投毒风险：**

PoC代码本身主要目的是演示漏洞利用，实现提权。代码中存在少量潜在的投毒风险，风险率大约为1%。主要风险在于:

*   **依赖项风险:** PoC依赖pwntools库，如果pwntools库被恶意篡改，可能引入额外的安全风险。
*   **libc替换风险:** PoC会尝试替换系统libc，如果替换过程出错，可能导致系统不稳定甚至崩溃。虽然PoC的目的是用包含提权shellcode的libc替换原libc，但如果该shellcode被替换为恶意代码，则可能造成破坏。
*   **不完善的错误处理:** 代码中缺乏完善的错误处理机制，可能导致利用过程中的意外行为，被攻击者利用。

总体而言，PoC代码的投毒风险较低，主要集中在对依赖项和替换操作的潜在恶意利用上。需要谨慎使用和审查PoC代码，以降低潜在风险。

**利用方式：**

1.  **漏洞原理：** 该漏洞是由于`ld.so`在解析`GLIBC_TUNABLES`环境变量时，没有充分验证输入，导致缓冲区溢出。
2.  **利用过程：**
    *   攻击者构造恶意的`GLIBC_TUNABLES`环境变量，其中包含精心设计的payload，用于覆盖`ld.so`的内存。
    *   通过`su`等具有SUID权限的程序触发漏洞，因为这些程序会加载`ld.so`。
    *   Payload覆盖`ld.so`的内存后，控制程序执行流程，最终执行攻击者预设的shellcode，实现提权。
3.  **PoC代码分析：**
    *   `drop_libc()`函数：
        *   创建一个包含提权shellcode的`libc.so.6`副本。
        *   确保目标机器存在保存修改后`libc.so.6`的目录。该目录名称来自`su`二进制文件的符号，通过`su_symbol`变量控制。
        *   将修改后的`libc.so.6`复制到目标目录。
    *   环境变量构造：
        *   `filler`、`kv`、`filler2`：用于填充和构造特定的内存布局。
        *   `dt_rpath`：包含指向`su_symbol`（即修改后的`libc.so.6`所在目录）的路径，利用动态链接器的`DT_RPATH`机制。
        *   `envp`：构造完整的环境变量数组，包含填充数据、payload和指向恶意`libc.so.6`的路径。
    *   利用触发：
        *   使用`os.fork()`创建子进程。
        *   在子进程中使用`libc.execve()`执行`/usr/bin/su`，并传入构造好的环境变量。
        *   通过循环和时间差判断利用是否成功，如果`su`执行时间过长，则认为利用成功。

**项目地址:** [guffre/CVE-2023-4911](https://github.com/guffre/CVE-2023-4911)

**漏洞详情:** [CVE-2023-4911](https://nvd.nist.gov/vuln/detail/CVE-2023-4911)