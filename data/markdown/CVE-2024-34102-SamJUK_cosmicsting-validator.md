## CVE-2024-34102 - Adobe Commerce XXE 漏洞

**漏洞编号:** CVE-2024-34102

**漏洞类型:** XML 外部实体注入 (XXE)

**影响应用:** Adobe Commerce (Magento)

**危害等级:** 高危，可能导致任意代码执行、敏感信息泄露

**影响版本:** <= 2.4.4-p8 (以及其他受影响版本)

**利用条件:** 无需用户交互，需要网络访问

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-34102 是 Adobe Commerce 和 Magento 中存在的 XML 外部实体注入 (XXE) 漏洞。攻击者可以发送特制的 XML 文档，其中包含对外部实体的引用，从而利用此漏洞。成功利用此漏洞可能允许攻击者执行任意代码，并公开加密密钥和其他敏感信息，从而获得完全管理员访问权限。

**利用方式：**

1.  **构造恶意的 XML Payload：** 攻击者需要构造一个包含外部实体声明的 XML 文档。这个外部实体指向攻击者控制的 URL。
2.  **利用外部实体读取文件：** 外部实体声明可以使用 `file://` 协议读取服务器上的任意文件。例如，可以读取包含加密密钥的文件。
3.  **使用 php://filter 包装器进行 Base64 编码：** 为了绕过某些限制，可以使用 `php://filter/convert.base64-encode/resource=` 包装器对读取的文件内容进行 Base64 编码。
4.  **通过 SSRF 回调将数据发送到攻击者服务器：** PoC 使用了 `https://api.cvssadvisor.com/ssrf/api/instance` API 作为一个回调服务器，将读取到的 Base64 编码数据发送到攻击者控制的服务器。
5.  **解码数据：** 攻击者接收到 Base64 编码的数据后，对其进行解码以获取文件内容。

**有效性：**

提供的 PoC 代码看起来是有效的，并且旨在利用 CVE-2024-34102 漏洞。它包含以下关键步骤：

*   创建一个回调 URL，该 URL 指向托管恶意 DTD 文件的远程服务器。
*   构造一个恶意的 XML Payload，其中包含对外部实体的引用。
*   发送 XML Payload 到易受攻击的 Adobe Commerce 实例。
*   检查回调 URL 的日志以确认漏洞利用成功。

**投毒风险：**

该仓库存在一定的投毒风险。主要体现在以下几个方面：

*   **依赖第三方 API：** PoC 依赖于 `https://api.cvssadvisor.com/ssrf/api/instance` 这个第三方 API 来进行 SSRF 回调。如果这个 API 被篡改或关闭，PoC 将无法正常工作。但这个不是投毒，只能说存在依赖风险。
*   **DTD 文件托管：** PoC 使用 `https://fars.ee/` 托管 DTD 文件。如果这个网站被恶意控制，攻击者可以修改 DTD 文件，从而在受害者服务器上执行恶意代码。这是潜在的投毒风险。
*   **`z_compromise_check` 脚本：** 虽然这个脚本的目的是监控站点是否被入侵，但也可能被用来植入后门或者篡改文件。需要仔细审查该脚本。
*   **`requirements.txt` 文件：**虽然`requirements.txt`看起来正常,但是存在被替换为包含恶意包的风险. 比如,拼写相似的恶意包。

综合分析，投毒风险不能排除，但可能性较低，约 10%。主要风险在于第三方依赖和可能被篡改的 DTD 文件。

**项目地址:** [SamJUK/cosmicsting-validator](https://github.com/SamJUK/cosmicsting-validator)

**漏洞详情:** [CVE-2024-34102](https://nvd.nist.gov/vuln/detail/CVE-2024-34102)