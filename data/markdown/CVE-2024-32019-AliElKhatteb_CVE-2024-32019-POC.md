## CVE-2024-32019 - Netdata ndsudo 本地提权

**漏洞编号:** CVE-2024-32019

**漏洞类型:** 本地提权

**影响应用:** Netdata

**危害等级:** 高危，允许低权限用户获得root权限

**影响版本:** >= 1.45.0, < 1.45.3 和 >= 1.44.0-60, < 1.45.0-169

**利用条件:** 需要Netdata agent运行在受影响的版本，且攻击者需要能够写入文件系统并执行程序。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-32019 漏洞是 Netdata Agent 中 `ndsudo` 工具的本地提权漏洞。`ndsudo` 是一个 SUID root 的程序，用于以 root 权限执行某些命令。漏洞的根源在于 `ndsudo` 使用了用户可控的 `PATH` 环境变量来查找要执行的命令。攻击者可以通过在 `PATH` 中添加一个指向恶意目录的路径，然后在该目录中放置一个与 `ndsudo` 将要执行的命令同名的恶意程序，当 `ndsudo` 尝试执行该命令时，实际上会执行攻击者的恶意程序，从而获得 root 权限。

**漏洞利用有效性：**

提供的 PoC 代码是有效的。它包含一个 exploit.c 文件，编译后会生成一个可执行文件。这个可执行文件会将当前用户的 UID 和 GID 设置为 0 (root)，然后执行一个反弹 shell 到攻击者指定的 IP 地址和端口上。利用步骤如下：

1.  编译 exploit.c 文件。
2.  将编译后的可执行文件上传到目标机器上，并赋予执行权限。
3.  修改 `PATH` 环境变量，使其包含可执行文件所在的目录。
4.  调用 `ndsudo` 执行 `nvme-list` 命令，由于 `PATH` 被修改，`ndsudo` 实际上会执行攻击者上传的可执行文件，从而获得 root 权限。

**投毒风险分析：**

PoC 代码本身存在一定投毒风险，风险评估为10%。主要风险点在于 `exploit.c` 文件中的硬编码 IP 地址 `ADD_YOU_IP_ADDRESS` 和端口 `9001`。如果攻击者直接使用这个 PoC，而没有修改 IP 地址，可能会导致攻击失败，甚至暴露攻击者的 IP 地址。此外，反弹 shell 的方式本身也可能被防火墙或其他安全设备阻止。另外一种风险在于编译过程中可能引入恶意代码。总体来说，风险较低，但使用者应谨慎。

**漏洞利用方式：**

1.  **编译恶意程序：** 攻击者编写一个恶意程序，例如反弹 shell 或执行任意命令。  PoC 中的 `exploit.c` 就是这样一个恶意程序。
2.  **上传恶意程序：** 将编译后的恶意程序上传到目标机器上，攻击者具有写入权限的目录。
3.  **修改 PATH 环境变量：**  修改 `PATH` 环境变量，将包含恶意程序的目录添加到 `PATH` 的最前面。  例如 `PATH=$(pwd):$PATH`。
4.  **触发 ndsudo：**  调用 `ndsudo` 执行某个允许的命令，例如 `nvme-list`。 由于 `PATH` 被篡改，`ndsudo` 将会执行攻击者上传的恶意程序，而不是原有的系统命令。
5.  **获得 root 权限：**  恶意程序被执行，攻击者获得 root 权限。

**项目地址:** [AliElKhatteb/CVE-2024-32019-POC](https://github.com/AliElKhatteb/CVE-2024-32019-POC)

**漏洞详情:** [CVE-2024-32019](https://nvd.nist.gov/vuln/detail/CVE-2024-32019)