## CVE-2021-4034-Polkit-pkexec本地提权

**漏洞编号:** CVE-2021-4034

**漏洞类型:** 本地权限提升

**影响应用:** Polkit pkexec

**危害等级:** 高危，允许本地普通用户提升到root权限

**影响版本:** 受影响版本广泛，具体取决于Polkit版本

**利用条件:** 本地用户可执行pkexec

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2021-4034 是 polkit's pkexec 工具中的一个本地权限提升漏洞。pkexec 是一个 setuid 工具，旨在允许非特权用户以特权用户身份运行命令，前提是符合预定义的策略。该漏洞的根本原因是 pkexec 没有正确处理调用参数的数量，导致它尝试将环境变量作为命令执行。攻击者可以通过构造特定的环境变量，诱使 pkexec 执行任意代码，从而获得 root 权限。

**漏洞利用分析：**

1.  **漏洞原理：** pkexec 在处理参数时存在缺陷，会将环境变量当作命令执行。
2.  **利用方式：** 攻击者通过构造恶意的 GCONV_PATH 和 gconv-modules 文件，使得 pkexec 加载一个恶意的共享库 (.so)。这个共享库包含攻击者的 payload，当 pkexec 尝试执行时，payload 就会以 root 权限执行。
3.  **POC 代码分析：**  提供的 python 脚本 `poc-cve-2021-4034.py` 用于自动化利用过程，它执行以下操作：
    *   创建一个包含 payload 的共享库文件（lib-cve-2021-4034.so）。默认的 payload 是一个反向 shell，连接到攻击者指定的 IP 地址和端口。
    *   创建 GCONV_PATH=. 目录，以及 lab-cve-2021-4034 目录。
    *   创建 GCONV_PATH=./lab-cve-2021-4034 文件和 lab-cve-2021-4034/gconv-modules 文件，gconv-modules 文件指向恶意的共享库。
    *   使用构造的环境变量调用 execve 执行 /usr/bin/pkexec。

**有效性：**

根据漏洞描述、搜索结果和提供的 POC 代码，该漏洞利用是有效的，成功利用后可以提升到 root 权限。Qualys 的研究团队已经发现了这个漏洞，并且存在公开可用的利用代码。

**投毒风险：**

该仓库可能存在投毒风险，虽然主要功能是利用漏洞，payload 部分（Base64 编码的共享对象）可能被替换为具有恶意功能的代码，可能性为5%。以下是评估依据：

*   **Payload 的可替换性：** POC 的 payload 是一个 Base64 编码的字符串，攻击者可以轻松地替换为其他恶意代码。
*   **网络连接：** 默认 payload 是一个反向 shell，这意味着执行后会尝试连接到攻击者的服务器。攻击者可以在服务器上执行任意命令。
*   **Setup 脚本分析:** `setup.sh` 脚本主要用于安装依赖和配置 Docker 环境，没有明显的恶意代码。但安装的依赖项，如 docker 等，后续可以被植入恶意镜像。

**结论：**

该漏洞是一个高危漏洞，利用简单，影响广泛。虽然提供的 POC 代码主要是用于演示漏洞利用，但存在被恶意利用的风险，特别是 payload 部分。用户在使用前需要仔细检查 payload 的内容，并确保来源可信。


**项目地址:** [ps-interactive/lab_cve-2021-4034-polkit-emulation-and-detection](https://github.com/ps-interactive/lab_cve-2021-4034-polkit-emulation-and-detection)

**漏洞详情:** [CVE-2021-4034](https://nvd.nist.gov/vuln/detail/CVE-2021-4034)