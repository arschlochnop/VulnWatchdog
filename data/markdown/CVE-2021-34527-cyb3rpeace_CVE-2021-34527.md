## CVE-2021-34527 PrintNightmare

**漏洞编号:** CVE-2021-34527

**漏洞类型:** 远程代码执行

**影响应用:** Windows Print Spooler

**危害等级:** 高危，允许未经授权的用户以SYSTEM权限执行任意代码

**影响版本:** 受影响的Windows版本和补丁版本请参考漏洞库信息

**利用条件:** 需要目标系统存在Print Spooler服务，且攻击者需要拥有一定的权限(例如，已认证的用户)

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-34527，又名PrintNightmare，是Windows Print Spooler服务中的一个远程代码执行漏洞。攻击者可以利用此漏洞在目标系统上以SYSTEM权限执行任意代码。 

**有效性：**
根据漏洞库信息和搜索结果，该漏洞在公开后被广泛利用，并且存在公开可用的PoC代码，说明该漏洞的有效性很高。

**投毒风险：**
提供的PowerShell脚本 `CVE-2021-34527.ps1`  分析如下：

1.  **主要功能：** 脚本的主要目的是利用 PrintNightmare 漏洞，通过添加恶意的打印机驱动程序来执行任意代码。默认情况下，它会创建一个新的本地管理员用户，并设置指定的用户名和密码。
2.  **DLL 注入：** 脚本允许用户指定自己的 DLL 文件，或者使用内置的 DLL 文件。
3.  **内置 DLL：** 如果不提供 DLL，脚本会使用一个内置的 payload，该 payload 的目的是创建用户并添加到管理员组。这部分代码存在一定的风险，如果 payload 被篡改，可能会执行恶意操作。
4. **风险分析：**
    *  脚本本身功能就是利用漏洞，目的是执行代码。
    *  脚本允许使用用户提供的 DLL，这本身就存在风险，用户可能提供恶意的 DLL 文件。
    *  脚本中存在内置的 DLL，如果攻击者修改了脚本中的 get_nightmare_dll 函数，使其返回恶意的 DLL，那么在使用默认选项的情况下，会执行攻击者预设的恶意操作。
   *   `get_nightmare_dll` 函数未提供,无法进一步判断。

鉴于以上分析，认为存在一定的投毒风险，但风险主要集中在对脚本和 DLL 的篡改上。脚本本身的目的就是利用漏洞执行代码，因此不能将漏洞利用代码本身视为投毒代码。如果 `get_nightmare_dll` 函数返回的DLL被替换成其他恶意代码，则存在较高投毒风险，这里我们给出 **10%** 的投毒风险概率。

**利用方式：**

1.  **攻击者**需要具备一定的权限，例如已经通过身份验证的用户。
2.  **攻击者**运行 PoC 脚本，脚本将执行以下操作：
    *   如果指定了 DLL 文件，则使用指定的 DLL 文件。
    *   如果没有指定 DLL 文件，则使用内置的 DLL 文件，并根据指定的用户名和密码，修改 DLL 中的相应字段。
    *   将 DLL 文件写入到临时目录。
    *   使用 `AddPrinterDriverEx` 函数添加恶意的打印机驱动程序，该驱动程序将加载 DLL 文件，并执行其中的代码。
3.  **DLL** 中的代码将以 SYSTEM 权限执行，从而允许攻击者执行任意操作，例如添加新的管理员用户、安装恶意软件等。
4.  **修复方案:** 及时安装Microsoft发布的针对CVE-2021-34527的补丁，并确保相关注册表设置正确配置。

**项目地址:** [cyb3rpeace/CVE-2021-34527](https://github.com/cyb3rpeace/CVE-2021-34527)

**漏洞详情:** [CVE-2021-34527](https://nvd.nist.gov/vuln/detail/CVE-2021-34527)