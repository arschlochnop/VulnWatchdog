## CVE-2024-38063 Windows TCP/IP 远程代码执行漏洞

**漏洞编号:** CVE-2024-38063

**漏洞类型:** 远程代码执行

**影响应用:** Windows TCP/IP

**危害等级:** 高危，可导致远程代码执行

**影响版本:** 受影响的Windows版本包括Windows 10, Windows 11, Windows Server 2008 - 2022等，具体版本范围参考漏洞库信息

**利用条件:** 需要目标系统启用IPv6，并且攻击者能够发送IPv6数据包到目标系统。

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2024-38063是一个Windows TCP/IP协议栈中的远程代码执行漏洞。攻击者可以通过发送特制的IPv6数据包来触发此漏洞，从而在目标系统上执行任意代码。

**漏洞利用方式：**

1.  **触发条件：** 漏洞利用依赖于IPv6协议栈，因此目标系统必须启用IPv6。此外，Windows在特定情况下会将多个IP数据包合并处理（packet coalescing）。
2.  **漏洞原理：**  当Windows合并处理IPv6数据包时，会先处理扩展头部。在处理“目标选项”扩展头部时，若出现解析错误，`tcpip!IppSendErrorList`函数会被调用，此函数会遍历数据包链表并调用`tcpip!IppSendError`。`tcpip!IppSendError`在特定条件下会将数据包的偏移重置为0。但只有第一个数据包会被标记为错误，后续数据包的扩展头仍然会被解析，但此时数据已经“回滚”到IPv6头部，导致后续的处理出现异常，从而触发漏洞。
3.  **POC利用：** 提供的POC代码使用`scapy`库构造恶意的IPv6数据包。攻击者需要配置目标IP地址(`ip_addr`)，以及发送数据包的接口(`iface`)。POC通过发送多个数据包批次(`num_tries`和`num_batches`)来增加触发漏洞的可能性。
4.  **利用手段：**  POC利用`Ipv6pReceiveFragment`函数，此函数会解析分片扩展头。漏洞利用的关键在于，在计算非头部数据长度时，假设数据包的偏移量至少为`0x28`。如果偏移量被重置为0，计算出的长度会出错，可能导致整数下溢或其他内存错误，从而实现远程代码执行。

**有效性：**

根据提供的漏洞信息、搜索结果和POC代码，该漏洞的POC代码是有效的。搜索结果中存在多个关于该漏洞的分析和利用的文章，`malwaretech.com`的文章对漏洞进行了Root Cause分析，并提供了POC。POC的有效性依赖于目标系统是否开启IPv6，以及能否成功触发数据包合并。

**投毒风险：**

POC代码本身主要功能是构造和发送恶意IPv6数据包。代码比较短小，且目的性明确，主要通过网络协议交互触发漏洞。 检查了`LICENSE`和`README.md`文件，没有发现恶意代码或隐藏的后门。`README.md`中说明这是一个“rather flaky”的POC，意味着该POC可能不稳定，不一定每次都能成功触发漏洞。但从代码本身来看，投毒的概率较低，判断投毒风险约为5%。


**项目地址:** [ynwarcs/CVE-2024-38063](https://github.com/ynwarcs/CVE-2024-38063)

**漏洞详情:** [CVE-2024-38063](https://nvd.nist.gov/vuln/detail/CVE-2024-38063)