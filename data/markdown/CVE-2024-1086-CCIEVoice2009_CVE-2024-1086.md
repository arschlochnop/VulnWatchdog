## CVE-2024-1086

**漏洞编号:** CVE-2024-1086

**漏洞类型:** Use-After-Free

**影响应用:** Linux Kernel (netfilter: nf_tables)

**危害等级:** 高危，本地权限提升

**影响版本:** v3.15 to v6.8 (不含已修复版本)

**利用条件:** 需要启用 nf_tables, user namespaces (CONFIG_USER_NS=y), 且 user namespaces 权限非特权 (sysctl kernel.unprivileged_userns_clone = 1)

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-1086 是 Linux 内核 netfilter 组件 nf_tables 中的一个 use-after-free 漏洞。攻击者可以利用此漏洞实现本地权限提升。

**有效性评估：**

根据漏洞库信息和搜索引擎结果，该漏洞已被积极利用，存在公开的 PoC 代码。提供的漏洞利用代码仓库包含 Makefile、源代码 (src 目录) 和说明文档，表明这是一个可运行的漏洞利用程序。

**投毒风险评估：**

阅读了提供的 Makefile 文件，以及 src/main.c、src/env.c、src/net.c、src/nftnl.c、src/file.c 文件，发现整个漏洞利用代码利用了漏洞本身, 并未发现后门和恶意代码。

但是README中提及了“The kernel panic (system crash) after running the exploit is a side-effect which deliberately hasn't been fixed to prevent malicious usage of the exploit (i.e. exploitation attempts should now be more noticeable, and unpractical in real-world operations).” 意味着作者有意保留了导致内核崩溃的副作用，以防止恶意利用。这在某种程度上可以被视为一种“defense by denial”，但同时也可能给测试和调试带来不便。因此认为存在一定的投毒风险， 风险比例约为10%。

**利用方式：**

1.  **漏洞触发：** 通过构造特定的 nf_tables 规则，在 `nft_verdict_init()` 函数中设置一个正值的 drop error，并导致 `NF_DROP` 与类似于 `NF_ACCEPT` 的 drop error 一起被触发。
2.  **Use-After-Free：** 触发 `nf_hook_slow()` 函数中的 double free 漏洞，释放已经被释放的内存。
3.  **权限提升：** 利用 UAF 漏洞，通过内存布局控制等技术，覆盖内核数据结构，最终获得 root 权限。

总体来说，利用方式较为复杂，需要对 netfilter 和 nf_tables 的内部机制有深入的理解。

**项目地址:** [CCIEVoice2009/CVE-2024-1086](https://github.com/CCIEVoice2009/CVE-2024-1086)

**漏洞详情:** [CVE-2024-1086](https://nvd.nist.gov/vuln/detail/CVE-2024-1086)