## CVE-2020-7247-OpenSMTPD-远程代码执行

**漏洞编号:** CVE-2020-7247

**漏洞类型:** 远程代码执行

**影响应用:** OpenSMTPD

**危害等级:** 高危，可导致完全控制目标系统

**影响版本:** 6.6（受影响版本包括 6.4.0 - 6.6.1）

**利用条件:** 目标系统运行着存在漏洞的 OpenSMTPD，且默认配置未修改

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2020-7247 允许未经身份验证的远程攻击者以 root 权限在受影响的 OpenSMTPD 服务器上执行任意命令。该漏洞存在于 `smtp_session.c` 文件的 `smtp_mailaddr` 函数中，由于输入验证不充分，导致可以通过在 `MAIL FROM` 字段中注入 shell 元字符来执行命令。

**有效性分析：**

提供的 PoC 代码 (`exploit.py`) 旨在利用此漏洞。它通过以下步骤与目标 OpenSMTPD 服务器交互：

1.  **连接目标：** 连接到目标主机和端口。
2.  **验证 OpenSMTPD：** 检查服务器 banner 以确认目标正在运行 OpenSMTPD。
3.  **发送恶意 MAIL FROM：** 发送包含 shell 元字符的 `MAIL FROM` 命令，从而触发漏洞。
4.  **发送 RCPT TO 和 DATA：** 发送 `RCPT TO` 和 `DATA` 命令以完成 SMTP 握手。
5.  **发送反弹 shell payload：** 在 DATA 部分发送 bash 反弹 shell payload，连接到攻击者的监听端口。
6.  **监听连接：** PoC 启动一个监听器，等待目标服务器反弹 shell 连接。

根据漏洞描述和 PoC 代码，以及搜索引擎结果中 Qualys 和 Rapid7 的分析，该漏洞是可利用的，提供的 PoC 代码在适当条件下应能成功利用。

**投毒风险分析：**

查看`exploit.py`文件，其功能主要是发送构造好的SMTP命令，利用漏洞执行payload。虽然存在执行恶意命令的可能，但这属于漏洞利用的正常流程。`README.md`文件只是说明漏洞和用法。`img/example.svg`文件仅为图片，因此，没有发现明显的恶意代码或隐藏的后门。投毒风险为0%。

**利用方式总结：**

利用此漏洞的步骤如下：

1.  攻击者连接到目标 OpenSMTPD 服务器的 SMTP 端口（通常是 25 端口）。
2.  攻击者发起 SMTP 会话，并发送包含恶意 shell 命令的 `MAIL FROM` 命令。关键在于在 MAIL FROM 中注入了恶意代码：`;for d in x t J z 5 o N G K 9 3 B 1 n Y;do read d;done;bash;exit 0;>`。这段代码本质上利用了 OpenSMTPD 在处理 MAIL FROM 地址时，由于验证不当，会将分号后的内容作为命令执行。
3.  OpenSMTPD 尝试解析 `MAIL FROM` 地址，但由于注入的 shell 元字符，导致执行了攻击者提供的命令。 通常这个命令会通过反弹shell连接到攻击者控制的机器。
4.  如果利用成功，攻击者就可以在目标系统上以 root 权限执行任意命令。

**项目地址:** [QTranspose/CVE-2020-7247-exploit](https://github.com/QTranspose/CVE-2020-7247-exploit)

**漏洞详情:** [CVE-2020-7247](https://nvd.nist.gov/vuln/detail/CVE-2020-7247)