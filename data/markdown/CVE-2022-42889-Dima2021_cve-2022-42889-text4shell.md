## CVE-2022-42889-Apache Commons Text-RCE

**漏洞编号:** CVE-2022-42889

**漏洞类型:** 远程代码执行（RCE）

**影响应用:** Apache Commons Text

**危害等级:** 高危，可能导致服务器被完全控制

**影响版本:** 1.5 <= version <= 1.9

**利用条件:** 应用程序使用了受影响版本的 Apache Commons Text，并且允许用户控制输入，该输入会被用于字符串插值。

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2022-42889，也被称为Text4Shell，是一个影响Apache Commons Text库的远程代码执行漏洞。该漏洞源于Apache Commons Text在1.5到1.9版本中，默认启用了一些不安全的StringLookup实现，如`script`，`dns`和`url`。当应用程序使用这些默认的Lookup实例并且允许用户控制输入时，攻击者可以通过构造恶意的字符串，利用变量插值功能执行任意代码。

**有效性分析：**

提供的POC代码是一个Spring Boot应用程序，它使用Apache Commons Text库进行字符串插值。`HelloController.java`文件中的`attack`方法接收一个名为`search`的请求参数，并使用`StringSubstitutor.createInterpolator()`创建一个插值器，然后使用`interpolator.replace(search)`方法对`search`参数进行插值。这意味着攻击者可以通过`search`参数传递恶意的字符串，例如`${script:javascript:java.lang.Runtime.getRuntime().exec('touch /tmp/foo')}`，来执行任意代码。`pom.xml`文件显示该项目使用了Apache Commons Text 1.8版本，属于受影响的版本范围。`README.md`文件提供了构建、运行和测试该POC应用程序的步骤，并提供了一个示例攻击payload。

根据漏洞信息和POC代码分析，该POC代码是有效的，可以用于演示和验证CVE-2022-42889漏洞。

**投毒风险分析：**

分析提供的代码，没有发现明显的投毒代码。该仓库的主要目的是为了演示CVE-2022-42889漏洞，代码结构清晰，功能单一，主要就是接收输入并利用commons-text进行解析。

**利用方式：**

1.  攻击者首先需要找到一个应用程序，该应用程序使用了受影响版本的Apache Commons Text库（1.5到1.9）。
2.  攻击者需要找到一个允许用户控制输入的地方，该输入会被传递给`StringSubstitutor.replace()`方法进行插值。
3.  攻击者构造一个包含恶意payload的字符串，例如`${script:javascript:java.lang.Runtime.getRuntime().exec('command')}`，其中`command`是要执行的任意命令。
4.  攻击者将构造的恶意字符串作为输入传递给应用程序。
5.  应用程序使用`StringSubstitutor.replace()`方法对输入进行插值，从而执行攻击者指定的命令。

利用`dns`，攻击者可以构造payload让服务器解析恶意域名，从而进行信息收集或发起其他攻击。利用`url`，攻击者可以让服务器请求恶意URL，从而可能导致SSRF（服务器端请求伪造）漏洞。

**修复建议：**

升级到Apache Commons Text 1.10.0或更高版本。新版本默认禁用了`script`，`dns`和`url`等不安全的StringLookup实现。如果必须使用这些Lookup，请确保只在可信的环境中使用。

**项目地址:** [Dima2021/cve-2022-42889-text4shell](https://github.com/Dima2021/cve-2022-42889-text4shell)

**漏洞详情:** [CVE-2022-42889](https://nvd.nist.gov/vuln/detail/CVE-2022-42889)