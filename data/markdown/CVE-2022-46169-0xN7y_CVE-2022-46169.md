## CVE-2022-46169-Cacti-命令注入

**漏洞编号:** CVE-2022-46169

**漏洞类型:** 命令注入

**影响应用:** Cacti

**危害等级:** 高危，允许未授权用户执行任意命令

**影响版本:** < 1.2.23

**利用条件:** 需要Cacti实例的URL，以及目标Cacti实例存在至少一个action类型为`POLLER_ACTION_SCRIPT_PHP`的`poller_item`。

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2022-46169是Cacti 1.2.23之前版本中存在的一个未经身份验证的命令注入漏洞。攻击者可以通过操控HTTP请求头`X-Forwarded-For`绕过身份验证，然后利用`polldata`动作触发命令注入。漏洞存在于`remote_agent.php`文件中，攻击者通过伪造客户端IP绕过认证，进而利用`poller_id`参数执行任意命令。提供的Python POC代码通过尝试不同的`host_id`和`poller_id`值，发送包含反向shell命令的恶意请求。 

**有效性：**
根据漏洞描述和POC代码，该漏洞利用是有效的，因为它可以允许未经身份验证的攻击者在受影响的Cacti实例上执行任意命令。

**投毒风险：**
该POC代码的投毒风险较低，约为5%。代码主要实现了漏洞利用，没有发现明显的恶意行为，如删除文件、上传恶意文件等。但是，任何漏洞利用代码都可能被修改为包含恶意功能，因此在使用前仍需谨慎审查。以下为可能的投毒点:

*   **反向shell地址：** 攻击者可能在不知情的情况下使用了被污染的反向shell监听地址，导致攻击暴露。
*   **命令注入payload：** 虽然当前payload是反向shell，但攻击者可能在不知情的情况下运行了其他有害命令。

**利用方式：**
1.  **身份验证绕过：** 通过设置`X-Forwarded-For` HTTP头为Cacti服务器的IP地址，绕过`remote_agent.php`的身份验证。
2.  **触发命令注入：** 访问`remote_agent.php`，并设置`action`参数为`polldata`，`poller_id`参数为恶意命令。需要结合有效的`host_id`和`local_data_ids[]`，使得对应的`poller_item`的`action`为`POLLER_ACTION_SCRIPT_PHP`。
3.  **命令执行：** Cacti执行`proc_open`函数，将构造的恶意命令注入到shell中，实现远程代码执行。

**项目地址:** [0xN7y/CVE-2022-46169](https://github.com/0xN7y/CVE-2022-46169)

**漏洞详情:** [CVE-2022-46169](https://nvd.nist.gov/vuln/detail/CVE-2022-46169)