## CVE-2021-3156 (Sudo Baron Samedit)

**漏洞编号:** CVE-2021-3156

**漏洞类型:** 堆缓冲区溢出

**影响应用:** Sudo

**危害等级:** 高危，允许本地普通用户提升权限至root

**影响版本:** 1.9.5p2之前

**利用条件:** 本地用户能够执行sudo命令

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-3156，又名“Baron Samedit”，是一个存在于Sudo 1.9.5p2之前的版本中的堆缓冲区溢出漏洞。该漏洞位于sudo在解析命令行参数时，由于一个单字节溢出（off-by-one error）导致。攻击者可以通过`sudoedit -s`命令，结合以单个反斜杠字符结尾的命令行参数，触发此漏洞，从而实现权限提升，获得root权限。

**有效性：**

从漏洞描述、搜索结果以及提供的漏洞利用代码来看，该漏洞的POC代码是有效的。多个来源（Qualys blog, NCC Group blog, Red Hat advisory, BeyondTrust blog等）都证实了该漏洞的存在和利用的可能性。提供的代码库包含了多个针对不同glibc版本和Sudo配置的利用脚本，表明该漏洞已被广泛研究和利用。

**投毒风险：**

评估提供的代码仓库是否存在投毒风险，需要分析仓库中的文件。该仓库包含了多个利用脚本，这些脚本旨在提升权限，因此可能被滥用。但是从代码来看，都是围绕着漏洞利用展开，没有发现明显的恶意代码，因此评估投毒风险为10%。

**利用方式：**

利用方式主要包括以下几个步骤：

1.  **触发漏洞：** 利用`sudoedit -s`命令以及构造特殊的命令行参数（以单个反斜杠结尾）来触发堆缓冲区溢出。
2.  **覆盖堆内存：** 通过精心设计的输入，覆盖堆上的关键数据结构，如`defaults`、`userspec`或`service_user`结构体。
3.  **权限提升：**
    *   **覆盖mailer路径：** 覆盖`defaults`结构体中的`mailer`路径，将其指向恶意程序，从而以root权限执行该恶意程序。
    *   **绕过认证：** 覆盖`userspec`结构体，绕过身份验证，允许攻击者执行任意命令。
    *   **修改/etc/passwd：** 覆盖`def_timestamp`结构体，配合竞争条件，修改`/etc/passwd`文件，添加具有root权限的新用户。
4.  **获得Root权限：** 通过上述方法，最终获得系统的root权限。

提供的代码库包含了多种利用方法，如`exploit_nss.py`，`exploit_timestamp_race.c`，`exploit_defaults_mailer.py`，`exploit_userspec.py`等，分别针对不同的系统配置和glibc版本。

**项目地址:** [puckiestyle/CVE-2021-3156](https://github.com/puckiestyle/CVE-2021-3156)

**漏洞详情:** [CVE-2021-3156](https://nvd.nist.gov/vuln/detail/CVE-2021-3156)