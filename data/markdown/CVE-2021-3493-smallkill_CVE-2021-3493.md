## CVE-2021-3493-Ubuntu OverlayFS 本地权限提升

**漏洞编号:** CVE-2021-3493

**漏洞类型:** 本地权限提升

**影响应用:** Ubuntu Linux Kernel

**危害等级:** 高危，可使低权限用户获得 root 权限

**影响版本:** Ubuntu kernel versions before 5.8.0-50.56, 5.4.0-72.80, 4.15.0-142.146, and 4.4.0-209.241

**利用条件:** 需要目标系统运行存在漏洞的 Ubuntu kernel，且开启了未授权用户命名空间和未授权 overlay mount

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2021-3493 是一个 Ubuntu Linux kernel overlayfs 实现中的权限提升漏洞。该漏洞源于 overlayfs 在用户命名空间中未正确验证底层文件系统中文件 capabilities 的设置。由于 Ubuntu kernel 中存在允许未授权 overlay 挂载的 patch，攻击者可以利用未授权用户命名空间来提升权限。

**漏洞利用方式：**

1.  **环境准备:**  创建一个目录结构，包括 lowerdir, upperdir, workdir, mergedir。这些目录用于配置 overlayfs 文件系统。
2.  **创建用户命名空间:**  利用 `unshare` 系统调用创建一个新的用户命名空间。在用户命名空间中，攻击者可以拥有更高的权限，但不会影响到宿主机的权限。
3.  **配置用户和组 ID 映射:**  将用户命名空间中的用户 ID 和组 ID 映射到宿主机上的用户 ID 和组 ID。这允许用户命名空间中的进程以宿主机用户的身份运行。
4.  **挂载 OverlayFS:** 使用 `mount` 系统调用挂载 overlayfs 文件系统。`lowerdir` 指向只读的底层文件系统，`upperdir` 指向可写的上层文件系统，`workdir` 用于 overlayfs 的工作目录， `mergedir` 是挂载点，用户可以访问合并后的文件系统。
5.  **设置文件 capabilities:**  在 overlayfs 文件系统中，创建一个可执行文件，并使用 `setxattr` 系统调用设置该文件的 capabilities。Capabilities 允许进程在没有 root 权限的情况下执行特权操作。expolit代码中设置了all+ep capabilities,这意味着该文件可以执行所有的特权操作。
6.  **执行可执行文件:**  执行设置了 capabilities 的可执行文件。由于该文件具有 capabilities，因此可以以 root 权限运行，从而提升权限。

**有效性:**
提供的 POC 代码尝试利用 CVE-2021-3493 漏洞。它首先创建必要的目录结构，然后创建一个新的用户命名空间，配置 ID 映射，挂载 overlayfs 文件系统，并设置可执行文件的 capabilities。最后，它执行该文件以提升权限。此代码应该可以成功利用漏洞。

**投毒风险:**
分析提供的 exploit.c 和 README.md 文件，**未发现明显的投毒代码**。 该代码的目的是利用漏洞提升权限，而不是执行任何恶意操作。所有操作都在利用漏洞的范围内，没有发现隐藏的后门或恶意行为。因此，可以认为投毒风险为 0%。

**项目地址:** [smallkill/CVE-2021-3493](https://github.com/smallkill/CVE-2021-3493)

**漏洞详情:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)