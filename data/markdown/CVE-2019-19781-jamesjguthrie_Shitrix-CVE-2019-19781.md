## CVE-2019-19781-Citrix ADC/Gateway-目录遍历与远程代码执行

**漏洞编号:** CVE-2019-19781

**漏洞类型:** 目录遍历与远程代码执行

**影响应用:** Citrix Application Delivery Controller (ADC) 和 Gateway

**危害等级:** 高危，可导致远程代码执行和敏感信息泄露

**影响版本:** 10.5, 11.1, 12.0, 12.1, and 13.0

**利用条件:** 需要网络访问到存在漏洞的Citrix ADC/Gateway服务

**POC 可用性:** 是

**投毒风险:** 1%

## 详情

CVE-2019-19781 是 Citrix ADC 和 Gateway 中存在的目录遍历漏洞，未经身份验证的攻击者可利用此漏洞读取任意文件，甚至可以结合其他技术实现远程代码执行。根据漏洞库信息、搜索引擎结果和提供的POC代码，可以进行如下分析：

1. **有效性：**
   根据搜索引擎结果（Rapid7, Palo Alto Networks, CISA 等）以及漏洞利用代码仓库的描述，该漏洞已被广泛利用，证明了POC的有效性。

2. **投毒风险：**
   提供的`shitrix.sh`脚本通过构造恶意请求头，利用目录遍历读取`/netscaler/portal/templates/`目录下的文件，并执行其中的代码。脚本包含如下操作：
    * 生成随机字符串作为文件名。
    * 对要执行的命令进行Base64编码和URL编码。
    * 使用`curl`发送POST和GET请求，其中包含了精心构造的`NSC_USER`头，利用了template injection的漏洞。
   该脚本本身的目的就是进行漏洞利用，风险主要来源于脚本本身，而非额外的投毒代码。但如果该代码仓库被恶意修改，或者攻击者使用该脚本执行恶意命令，则可能造成投毒。例如，使用该漏洞在目标系统上安装后门。由于脚本代码量不大，人工审核较为容易，故投毒风险较低，初步评估为1%。

3. **利用方式：**
   利用方式主要分为以下几个步骤：
    1.  **目录遍历：** 通过构造包含`../../`的路径，访问到`/netscaler/portal/templates/`目录下的任意文件。
    2.  **模板注入：**  通过`NSC_USER`请求头，向目标服务器注入恶意模板代码，这些代码会被服务器解析执行。
    3.  **远程代码执行：**  利用模板引擎的特性，执行任意系统命令。具体来说，`shitrix.sh`脚本首先将要执行的命令进行Base64编码，然后利用`echo`和`b64decode`命令解码并执行。
    4.  **具体实现：** 脚本通过构造恶意请求，将命令注入到模板中，并通过curl发送请求。服务器在处理请求时，会解析模板并执行其中的命令，从而实现远程代码执行。

4.  **排序优先级：** 搜索引擎结果 > 漏洞利用代码 > 漏洞库信息


**项目地址:** [jamesjguthrie/Shitrix-CVE-2019-19781](https://github.com/jamesjguthrie/Shitrix-CVE-2019-19781)

**漏洞详情:** [CVE-2019-19781](https://nvd.nist.gov/vuln/detail/CVE-2019-19781)