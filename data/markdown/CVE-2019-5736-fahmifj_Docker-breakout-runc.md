## CVE-2019-5736-runc容器逃逸

**漏洞编号:** CVE-2019-5736

**漏洞类型:** 容器逃逸

**影响应用:** runc/Docker

**危害等级:** 高危，允许容器逃逸并获得主机root权限

**影响版本:** <= 1.0-rc6 (runc), Docker before 18.09.2

**利用条件:** 需要能够以root身份在受影响的容器内执行命令（通过创建新容器或docker exec现有容器）

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2019-5736 漏洞允许攻击者通过操控文件描述符，覆盖宿主机上的runc二进制文件，从而获得宿主机的 root 权限。利用方式如下：

1.  **漏洞原理：** 容器启动时，runc 会打开 `/proc/self/exe` 文件，该文件指向 runc 自身的二进制文件。由于文件描述符处理不当，攻击者可以在容器启动后保持对 runc 二进制文件的文件描述符的引用。
2.  **利用条件：** 攻击者需要在容器内部以 root 权限运行代码，这可以通过两种方式实现：
    *   创建一个包含恶意镜像的新容器。
    *   使用 `docker exec` 连接到攻击者具有写入权限的现有容器。
3.  **攻击步骤：**
    *   **替换 `/bin/sh`：** 将容器内的 `/bin/sh` 替换为一个解释器脚本，该脚本会在 runc 被执行时被调用。该解释器脚本会将 `/proc/self/exe` 的内容（即 runc 二进制文件）覆盖为恶意代码。
    *   **寻找 runc 进程：** 通过扫描 `/proc` 目录，找到正在运行的 runc 进程的 PID。
    *   **打开 `/proc/<runc_pid>/exe`：**  尝试打开 runc 进程对应的 `/proc/<runc_pid>/exe` 文件，并获取文件描述符。
    *   **覆盖 runc 二进制文件：**  使用获取到的文件描述符，通过 `/proc/self/fd/<fd>` 覆盖宿主机上的 runc 二进制文件。
    *   **触发漏洞：** 当 Docker 或其他容器管理工具再次调用 runc 时，被覆盖的恶意代码将以 root 权限在宿主机上执行。

**有效性：** 提供的PoC代码基本有效，能够利用该漏洞实现容器逃逸。但是，该PoC代码可能需要根据实际环境进行调整，例如，文件描述符的值可能因环境而异。

**投毒风险：** 仓库存在一定的投毒风险，概率约为10%。
    *   该仓库中提供的`README.md`和`main.go`文件本身实现了CVE-2019-5736漏洞的利用，即容器逃逸，在未打补丁的环境下具有真实危害。
    *   但由于代码功能比较集中，且逻辑相对简单，可以判定作者未在PoC中隐藏额外的后门，或具备其他危害的恶意代码。
    *   存在的风险在于，攻击者可能在下载的 PoC 代码中添加自己的恶意代码，然后再传播，从而达到攻击其他用户的目的。该风险并非源于作者本身，而是代码传播的潜在风险。


**项目地址:** [fahmifj/Docker-breakout-runc](https://github.com/fahmifj/Docker-breakout-runc)

**漏洞详情:** [CVE-2019-5736](https://nvd.nist.gov/vuln/detail/CVE-2019-5736)