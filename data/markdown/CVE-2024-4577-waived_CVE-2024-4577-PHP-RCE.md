## CVE-2024-4577-PHP-CGI参数注入

**漏洞编号:** CVE-2024-4577

**漏洞类型:** 远程代码执行

**影响应用:** PHP

**危害等级:** 高危，可能导致服务器被完全控制

**影响版本:** PHP 8.1.* < 8.1.29, 8.2.* < 8.2.20, 8.3.* < 8.3.8 (Windows, CGI模式)

**利用条件:** PHP 在 Windows 下以 CGI 模式运行，且系统配置使用包含 "Best Fit" 策略的编码页。

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2024-4577 是一个 PHP-CGI 参数注入漏洞，当 PHP 在 Windows 下以 CGI 模式运行时，如果系统配置使用包含 "Best Fit" 策略的编码页，攻击者可以通过构造特殊字符绕过安全检查，将恶意参数传递给 PHP 解释器，导致远程代码执行。

**漏洞利用方式：**

1.  **利用原理：** Windows 的 "Best Fit" 编码转换可能会将请求中的特定字符转换为其他字符，从而绕过 PHP 的安全过滤。攻击者可以利用这一点，注入 `-d` 参数来修改 PHP 的配置。
2.  **攻击方式：**  根据漏洞库信息和POC代码，攻击者可以通过在URL中构造类似 `/?%ADd+allow_url_include%3d1+%ADd+auto_prepend_file%3dphp://input` 这样的 Payload。 其中 `%AD` 字符可能经过 "Best Fit" 转换后，仍然能够被 PHP 解析为 `-d` 参数的一部分。
3.  **Payload 解释：**
    *   `allow_url_include=1`： 允许包含远程文件。
    *   `auto_prepend_file=php://input`：  设置在执行 PHP 代码之前自动包含的文件为 `php://input`，这意味着请求体中的内容会被当作 PHP 代码执行。
4.  **执行流程：** 攻击者发送包含恶意 PHP 代码的 POST 请求，由于 `auto_prepend_file` 被设置为 `php://input`，恶意代码会被执行，从而实现远程代码执行。

**关于投毒风险：**

分析提供的 POC 代码，该代码主要用于检测目标是否存在 CVE-2024-4577 漏洞。代码逻辑是发送包含特定参数的 HTTP POST 请求，并检查响应中是否包含 "PHP Version" 字符串。如果存在，则认为目标存在漏洞。没有发现任何隐藏的、恶意的功能，因此投毒风险为 0%。

综上所述，提供的 POC 代码有效，且不存在投毒风险。利用方式是利用 Windows 的 "Best Fit" 编码转换特性，通过构造特殊的 URL 和 POST 请求，将恶意 PHP 代码注入到目标服务器执行，最终实现远程代码执行。

**项目地址:** [waived/CVE-2024-4577-PHP-RCE](https://github.com/waived/CVE-2024-4577-PHP-RCE)

**漏洞详情:** [CVE-2024-4577](https://nvd.nist.gov/vuln/detail/CVE-2024-4577)