## CVE-2021-22911-Rocket.Chat-NoSQL注入

**漏洞编号:** CVE-2021-22911

**漏洞类型:** NoSQL注入

**影响应用:** Rocket.Chat

**危害等级:** 高危，可能导致远程代码执行

**影响版本:** 3.11, 3.12, 3.13 (Fixed in: 3.13.2, 3.12.4, 3.11.4)

**利用条件:** 目标系统运行存在漏洞的Rocket.Chat版本，且攻击者能够通过网络访问Rocket.Chat服务。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-22911是Rocket.Chat 3.11、3.12和3.13版本中存在的NoSQL注入漏洞。由于未正确过滤输入，未经身份验证的攻击者可以利用此漏洞进行NoSQL注入，最终可能导致远程代码执行(RCE)。

**有效性：**

根据提供的漏洞信息、搜索引擎结果和漏洞利用代码，可以判断该漏洞的POC代码是有效的。 搜索引擎结果中Exploit-DB提供了expolit代码(50108.py), 以及github上存在完整的RCE利用(Rocket.Chat-Automated-Account-Takeover-RCE-CVE-2021-22911)。提供的POC代码 (rocketchat.py) 实现了利用该漏洞重置管理员密码并获得管理员权限，然后可执行任意代码。

**投毒风险：**

分析POC代码，发现rocketchat.py脚本中主要功能为利用NoSQL注入重置管理员密码，然后通过修改管理员密码登录并执行命令。未发现明显恶意代码。`README.md`文件提供利用说明，帮助用户完成漏洞验证。但考虑到任何代码都存在潜在风险，作者有可能通过细微修改增加恶意行为，例如上传webshell，添加后门账号等。因此投毒风险较低，估计为10%。

**利用方式：**

1.  **目标识别：** 确定目标Rocket.Chat服务器运行的版本在3.11, 3.12 & 3.13范围内。
2.  **发送密码重置请求：** 针对低权限用户和管理员邮箱，利用`sendForgotPasswordEmail`方法发送密码重置邮件。
3.  **获取Reset Token：** 利用`getPasswordPolicy`方法中的NoSQL注入漏洞，通过正则表达式匹配的方式逐步获取管理员密码重置的token。
4.  **重置管理员密码：** 使用获取到的token，调用`resetPassword`方法重置管理员密码为已知密码。
5.  **双因素认证绕过/获取管理员Token:** 若目标开启双因素认证，则利用NoSQL注入漏洞获取管理员的2FA secret, 获取管理员token后可以执行任意命令实现RCE。
6.  **登录并执行命令:** 使用新密码登录管理员帐户，然后执行任意代码以实现RCE。

总而言之，该漏洞的利用方式较为复杂，需要多个步骤才能最终实现RCE。但由于是不需要授权的NoSQL注入，利用的危害性很高。

**项目地址:** [yoohhuu/Rocket-Chat-3.12.1-PoC-CVE-2021-22911-](https://github.com/yoohhuu/Rocket-Chat-3.12.1-PoC-CVE-2021-22911-)

**漏洞详情:** [CVE-2021-22911](https://nvd.nist.gov/vuln/detail/CVE-2021-22911)