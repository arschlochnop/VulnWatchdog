## CVE-2022-31053: Discourse SSRF via Onebox URL Preview

**漏洞编号:** CVE-2022-31053

**漏洞类型:** SSRF（服务器端请求伪造）

**影响应用:** Discourse

**危害等级:** 高危，允许攻击者访问内部资源，可能导致敏感信息泄露。

**影响版本:** < 2.8.5 和 < 2.9.0.beta6

**利用条件:** 目标系统运行受影响的Discourse版本，且启用了Onebox URL预览功能。

**POC 可用性:** 是

**投毒风险:** 2%

## 详情

该漏洞存在于Discourse的Onebox URL预览功能中。攻击者可以通过构造恶意的URL，使服务器向内部或外部资源发起请求。从漏洞利用代码来看，利用方式为首先获取CSRF token，然后通过Onebox功能发送包含恶意URL的请求。恶意URL包括尝试访问内部端口（如22, 80, 443, 3000, 5432, 6379, 9200, 8080），私有IP地址（如192.168.1.1, 10.0.0.1, 172.16.0.1），云元数据终点（如169.254.169.254）以及使用file协议读取本地文件（如/etc/passwd）。HTTP服务器代码用于捕获SSRF回调，验证漏洞是否存在。由于该代码的编写目的是测试SSRF，因此它依赖外部服务（burpcollaborator.net）进行盲SSRF测试,存在一定的风险.但整体投毒风险较低。

有效性：基于漏洞库信息和搜索结果，该漏洞为真实存在，且危害等级为严重。提供的PoC代码尝试利用该漏洞，访问内部资源和云元数据，因此判断PoC代码有效。

投毒风险：该ruby脚本的主要功能是发送特制的http请求以测试SSRF漏洞。虽然代码中包含了使用Burp Collaborator进行盲SSRF测试的逻辑，但未发现明显的恶意代码植入行为，例如执行系统命令或者回传敏感信息。Burp Collaborator是一个合法的安全测试工具，用于验证是否存在SSRF漏洞。因此，初步评估认为投毒风险较低，约为2%。

利用方式：
1.  获取CSRF Token：从目标Discourse站点获取CSRF Token，用于绕过CSRF保护。
2.  发送恶意请求：构造包含恶意URL的请求，通过Discourse的Onebox功能触发SSRF。
3.  测试SSRF：通过访问内部资源、私有IP地址、云元数据终点以及使用file协议等方式测试SSRF漏洞。
4.  捕获回调：启动HTTP服务器，捕获SSRF回调，验证漏洞是否存在。

**项目地址:** [ibrahmsql/CVE-2022-31053](https://github.com/ibrahmsql/CVE-2022-31053)

**漏洞详情:** [CVE-2022-31053](https://nvd.nist.gov/vuln/detail/CVE-2022-31053)