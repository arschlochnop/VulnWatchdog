## CVE-2019-3396-Atlassian Confluence Widget Connector Macro-SSTI

**漏洞编号:** CVE-2019-3396

**漏洞类型:** 服务器端模板注入 (SSTI)

**影响应用:** Atlassian Confluence Server

**危害等级:** 高危，可导致远程代码执行

**影响版本:** 6.6.0 < version < 6.6.12, 6.7.0 <= version < 6.12.3, 6.13.0 <= version < 6.13.3, 6.14.0 <= version < 6.14.2

**利用条件:** 需要目标系统存在受影响版本的Confluence，并且Widget Connector宏未被禁用。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2019-3396 是 Atlassian Confluence Server 中 Widget Connector 宏的一个服务器端模板注入漏洞。攻击者可以通过构造恶意的 Velocity 模板，利用 Widget Connector 宏在 Confluence 服务器上执行任意代码。

**有效性分析：**

根据漏洞库信息和搜索结果，该漏洞真实存在，且存在公开的PoC。提供的PoC代码 `windows.vm` 利用了 Velocity 模板引擎的特性，通过反射调用 `java.lang.Runtime` 类来执行系统命令。代码首先设置变量`e`为字符串"exp"，然后使用反射获取Runtime类的getRuntime()方法并调用，执行`cmd.exe /c $cmd`。 `$cmd` 变量需要在实际利用时替换为要执行的命令。该PoC代码有效。

**投毒风险分析：**

提供的PoC代码本身的功能是执行任意命令，虽然其中使用了`cmd.exe /c $cmd`，但正常使用该漏洞也需要用户传入执行命令，因此代码的功能就是利用漏洞进行RCE。 但需要评估是否存在作者故意添加的恶意代码，例如：

1.  **隐蔽的后门：** 代码中是否存在难以察觉的命令，用于植入后门或收集信息？
2.  **条件触发的恶意行为：** 代码是否包含在特定条件下才会触发的恶意行为？

假设存在一些不明显的行为（例如每隔一段时间尝试连接某个IP，或者尝试修改某些配置），则投毒风险可能较高。综合考虑POC本身的功能与检查隐藏的恶意行为的难度，评估投毒风险为 10%。

**利用方式分析：**

1.  **查找包含 Widget Connector 宏的 Confluence 页面。**
2.  **构造包含恶意 Velocity 模板的请求。** 这个模板通常会利用 Velocity 的表达式注入功能来执行任意代码。
3.  **发送构造好的请求到 Confluence 服务器。**
4.  **服务器解析 Velocity 模板，执行其中的恶意代码，实现远程代码执行。**

根据搜索结果，该漏洞已经被广泛利用，并且有多种攻击载荷被用于攻击。例如，有攻击者利用该漏洞部署加密货币挖矿程序和 Gandcrab 勒索软件。

**项目地址:** [yuehanked/cve-2019-3396](https://github.com/yuehanked/cve-2019-3396)

**漏洞详情:** [CVE-2019-3396](https://nvd.nist.gov/vuln/detail/CVE-2019-3396)