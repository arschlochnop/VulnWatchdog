## CVE-2019-18634-Sudo-堆栈缓冲区溢出

**漏洞编号:** CVE-2019-18634

**漏洞类型:** 堆栈缓冲区溢出

**影响应用:** Sudo

**危害等级:** 高危，可能导致权限提升

**影响版本:** < 1.8.26 (实际 PoC 针对 <= 1.8.30)

**利用条件:** pwfeedback 在 /etc/sudoers 中启用

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2019-18634 是 Sudo 1.8.26 之前版本中存在的一个堆栈缓冲区溢出漏洞。当 /etc/sudoers 文件中启用了 pwfeedback 时，用户可以通过向 `tgetpass.c` 中的 `getln()` 函数的 stdin 发送过长的字符串来触发该漏洞，导致特权 `sudo` 进程中的缓冲区溢出，从而实现权限提升。漏洞利用代码分析如下：

1.  **有效性分析：**根据提供的漏洞信息和漏洞利用代码，该PoC代码针对 Sudo <= 1.8.30 版本，且需要在 `/etc/sudoers` 中启用 `pwfeedback`。`README.md` 指出该代码在 1.8.25 上测试通过，但在更高版本上存在字符处理差异问题，但不影响漏洞的可利用性。搜索引擎结果也提供了多个漏洞分析和利用的参考链接，确认了漏洞的存在和可利用性。

2.  **投毒风险分析：**PoC 代码主要由以下几个部分组成：
    *   `xpl.pl`: Perl 脚本，用于生成溢出 payload。该脚本构造一个包含大量 `\x00\x15` 的字符串，以及一些标志位和用户详情，以触发缓冲区溢出。
    *   `exec.c`: C 语言程序，用于修改 `/proc/self/exe` 的权限，使其具有 SUID 位。如果当前用户不是 root，则该程序会将 `sudo` 二进制文件更改为 root 用户所有，并设置 SUID 位。如果是 root 用户，则直接调用 `execve("/bin/bash",NULL,NULL)` 获取 root shell。这一部分的功能具有一定的风险，可能被恶意利用，但是根据代码功能来看，它仅仅是为了提升权限所做的操作。因此，将此部分判定为投毒风险的概率较低。
    *   `self-contained.sh`: Shell 脚本，用于下载 socat (如果不存在)，创建命名管道，设置 `SUDO_ASKPASS` 环境变量，并执行 `sudo` 命令。`socat` 用于创建伪终端，`SUDO_ASKPASS` 用于指定密码输入程序。这个脚本是整个漏洞利用的核心。

    综合来看，该漏洞利用代码的目的是实现权限提升。其中,`exec.c`的功能如果被滥用可能会导致程序SUID权限的滥用，但这是漏洞利用过程中的一部分，无法直接断定为恶意投毒。socat作为辅助工具，本身不包含投毒行为。因此，整体投毒风险较低，判定为 **5%**。

3.  **利用方式总结：**
    1.  **前提条件：**
        *   目标系统上存在漏洞版本的 `sudo`（< 1.8.26，PoC 适用于 <= 1.8.30）。
        *   `/etc/sudoers` 中启用了 `pwfeedback`。
    2.  **利用步骤：**
        *   下载或创建 `socat` 工具。
        *   创建命名管道 `/tmp/pipe`。
        *   设置 `SUDO_ASKPASS` 环境变量，指向 `/tmp/pipe`。
        *   运行 `sudo -k -S id < /tmp/pty`，触发密码提示。
        *   `xpl.pl` 脚本生成恶意 payload，通过管道发送给 `sudo` 进程。
        *   `sudo` 进程中的 `getln()` 函数发生缓冲区溢出，覆盖堆栈上的数据。
        *   `exec.c` 程序被执行，修改 `sudo` 权限或直接获取 root shell。

    通过精心构造的 payload，攻击者可以在 `sudo` 进程中覆盖返回地址，从而劫持程序执行流程，最终实现权限提升。

**项目地址:** [Plazmaz/CVE-2019-18634](https://github.com/Plazmaz/CVE-2019-18634)

**漏洞详情:** [CVE-2019-18634](https://nvd.nist.gov/vuln/detail/CVE-2019-18634)