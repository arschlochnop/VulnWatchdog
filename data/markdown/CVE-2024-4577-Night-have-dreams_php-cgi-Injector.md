## CVE-2024-4577 PHP-CGI 参数注入 RCE

**漏洞编号:** CVE-2024-4577

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** PHP

**危害等级:** 高危，可能导致远程代码执行，服务器完全控制

**影响版本:** PHP 8.1.* before 8.1.29, 8.2.* before 8.2.20, 8.3.* before 8.3.8 (Windows, CGI mode, specific code page)

**利用条件:** Windows 系统，PHP 以 CGI 模式运行，系统配置使用特定的代码页，允许Best-Fit转换。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-4577 是一个 PHP-CGI 参数注入漏洞，存在于 Windows 系统下以 CGI 模式运行的 PHP 版本中。如果系统配置使用了某些代码页，Windows 可能会使用 "Best-Fit" 策略来替换命令行参数中的字符。PHP CGI 模块可能错误地将这些字符解析为 PHP 选项，从而允许攻击者向 PHP 二进制文件传递选项，导致泄露源代码、执行任意 PHP 代码甚至执行系统命令。

**有效性：**
提供的漏洞利用代码看起来是有效的。它是一个 Python 脚本，旨在自动化 CVE-2024-4577 和 CVE-2024-8926 的利用。它提供了多种攻击模式，例如执行系统命令、执行 PHP 代码、上传和下载文件。脚本还具有 Tor 代理支持、日志记录和自动编码转换等功能，这表明它是一个功能齐全的漏洞利用工具。

**投毒风险：**
该仓库的投毒风险评估为 10%。该脚本主要利用了已知的漏洞，并没有明显的恶意代码。风险主要来自于以下几点：
* 使用 Tor 代理支持，有可能会连接到恶意的 Tor 节点。
* 脚本提供文件上传功能，攻击者可能会上传恶意文件到服务器。
* 脚本的作者身份未知，存在潜在的供应链风险。

**利用方式：**
1.  **环境准备：**  攻击者需要一个运行易受攻击的 PHP 版本的 Windows 服务器，并以 CGI 模式运行。此外，系统还应配置为使用具有 Best-Fit 转换的代码页。
2.  **漏洞利用：**  攻击者将构造一个包含恶意 PHP 选项的 HTTP 请求。由于 Best-Fit 转换，服务器会将某些字符替换为其他字符，这将被 PHP CGI 模块错误地解析为 PHP 选项。例如，攻击者可以传递 `-d allow_url_include=1 -d auto_prepend_file=php://input` 选项，以允许包含远程文件并执行任意 PHP 代码。
3.  **远程代码执行：**  通过上述操作，攻击者可以执行任意 PHP 代码，包括执行系统命令、上传 webshell 等。

综上所述，CVE-2024-4577 是一个严重的安全漏洞，利用起来相对简单，攻击后果非常严重，可能导致服务器完全沦陷。强烈建议受影响的用户尽快升级到受保护的版本。

**项目地址:** [Night-have-dreams/php-cgi-Injector](https://github.com/Night-have-dreams/php-cgi-Injector)

**漏洞详情:** [CVE-2024-4577](https://nvd.nist.gov/vuln/detail/CVE-2024-4577)