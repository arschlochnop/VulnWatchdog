## CVE-2018-15473 OpenSSH 用户枚举

**漏洞编号:** CVE-2018-15473

**漏洞类型:** 用户枚举

**影响应用:** OpenSSH

**危害等级:** 中危，可能导致信息泄露，为后续攻击提供便利

**影响版本:** <= 7.7

**利用条件:** 需要网络访问SSH服务端口（默认22）

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2018-15473 漏洞允许未经授权的远程攻击者枚举目标系统上的有效用户名。该漏洞存在于 OpenSSH 7.7 及更早版本中，由于 OpenSSH 没有延迟对无效身份验证用户的退出，直到包含该请求的数据包被完全解析之后。攻击者可以通过发送特制的 SSH 请求来探测用户名是否存在。

**有效性分析：**

根据漏洞库信息和搜索引擎结果，该漏洞确实存在于 OpenSSH 7.7 及更早版本中，并且存在可用的利用代码。

提供的 POC 代码包含以下几个文件：

*   `README.md`: 包含脚本的简要说明和使用方法。
*   `cve.py`:  实现了漏洞利用的核心逻辑，通过修改 paramiko 库的行为，判断用户名是否有效。
*   `main.py`:  主脚本，用于从 Shodan 获取 IP 地址列表，并使用 `cve.py` 对这些 IP 地址进行用户枚举。
*   `users.txt`:  包含常用用户名列表，用于进行枚举。

`cve.py`脚本通过篡改`paramiko`库的`MSG_SERVICE_ACCEPT`和`MSG_USERAUTH_FAILURE`消息处理函数，使得服务器在接收到无效用户名时立即响应，从而允许攻击者区分有效和无效的用户名。具体来说，它通过覆盖 `paramiko.message.Message.add_boolean` 函数来改变数据包的结构，并通过自定义的 `invalid_username` 函数在用户名无效时抛出异常。`check_user` 函数尝试使用伪造的公钥对用户进行身份验证，根据是否抛出 `AuthenticationException` 异常来判断用户名是否存在。

**投毒风险分析：**

仔细审查提供的 POC 代码后，发现其中存在轻微的投毒风险。`main.py`脚本需要用户手动填写 Shodan API 密钥，如果用户不小心填写了错误的或者无效的 API 密钥，可能导致脚本运行失败或者泄露密钥信息。此外，`main.py` 从 Shodan 获取大量 IP 地址，并对这些 IP 地址进行扫描，可能被 Shodan 封禁 API 密钥。`cve.py` 脚本修改了 `paramiko` 库的内部行为，可能导致其他使用该库的程序出现异常。
`poison` 设置为 `5%`是因为，脚本中并没有直接的恶意代码（例如删除文件、安装后门等），但是存在可能导致API Key泄露和扫描行为被阻断的情况。因此，评估为较低的投毒风险。

**利用方式：**

1.  准备：安装必要的 Python 库 (paramiko, shodan, argparse)。
2.  配置：在 `main.py` 中填入有效的 Shodan API 密钥。
3.  执行：运行 `main.py` 脚本，它会自动从 Shodan 获取 SSH 服务器的 IP 地址列表，并使用 `cve.py` 脚本对每个 IP 地址进行用户枚举，枚举的用户名列表来自 `users.txt` 文件。
4.  结果：有效的用户名将打印到标准输出。

该漏洞的利用方式相对简单，只需要一个有效的 Shodan API 密钥和目标 SSH 服务器的 IP 地址即可。

**项目地址:** [66quentin/shodan-CVE-2018-15473](https://github.com/66quentin/shodan-CVE-2018-15473)

**漏洞详情:** [CVE-2018-15473](https://nvd.nist.gov/vuln/detail/CVE-2018-15473)