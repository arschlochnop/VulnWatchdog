## CVE-2024-42327-Zabbix-SQL注入

**漏洞编号:** CVE-2024-42327

**漏洞类型:** SQL注入

**影响应用:** Zabbix

**危害等级:** 高危，可能导致数据泄露、权限提升和远程代码执行

**影响版本:** <=6.0.31, <=6.4.16, <=7.0.1

**利用条件:** 需要Zabbix前端的非管理员用户账户，且该账户具有API访问权限

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2024-42327是Zabbix服务器中存在的一个SQL注入漏洞。该漏洞位于`CUser`类的`addRelatedObjects`函数中，该函数被`CUser.get`函数调用。由于`CUser.get`函数对所有具有API访问权限的用户都可用，因此，拥有Zabbix前端非管理员用户账户，且具备API访问权限的攻击者，便可以利用此漏洞，通过构造恶意的SQL语句，执行未授权的数据库操作。

**有效性评估：**
根据漏洞信息和搜索引擎结果，该漏洞是真实存在的，并且具有较高的CVSS评分(9.9)。提供的PoC代码旨在利用时间型SQL注入来提取管理员会话ID，然后利用该ID来执行远程代码执行。PoC利用了Zabbix API的user.get方法，通过构造包含`SLEEP()`函数的SQL注入语句来判断管理员会话ID的字符。从代码的逻辑和github的内容来看，利用方式是可行的。

**投毒风险评估：**
分析PoC代码，主要是通过时间盲注的方式，获取admin的sessionid，然后通过sessionid获取权限，执行创建item等操作，最终达到RCE。在给出的代码中，并发线程数量设置成了10。这种设置本身并不直接构成投毒。但存在一种潜在的风险：如果目标服务器的资源非常有限，或者数据库连接数已经接近上限，过多的并发请求可能会导致拒绝服务(DoS)攻击。此外，Payload本身如果连接到外网的服务器，如果外网服务器被控制，也可能被用于恶意用途。

综上，PoC本身存在极低的投毒风险，大约为5%。

**利用方式：**
1.  **身份验证：** 使用Zabbix API的`user.login`方法，通过提供的用户名和密码获取身份验证token（`auth_token`）。
2.  **SQL注入：** 使用Zabbix API的`user.get`方法，构造恶意的SQL查询，利用时间盲注技术逐步提取管理员会话ID（`admin_session`）。
3.  **信息收集：** 使用提取到的`admin_session`，通过Zabbix API的`host.get`请求，获取目标主机和接口的ID。
4.  **远程代码执行：** 利用获取到的主机和接口ID，通过Zabbix API的`item.create`请求，创建一个包含反向shell命令的item，从而在目标服务器上执行任意代码。

**项目地址:** [BridgerAlderson/Zabbix-CVE-2024-42327-SQL-Injection-RCE](https://github.com/BridgerAlderson/Zabbix-CVE-2024-42327-SQL-Injection-RCE)

**漏洞详情:** [CVE-2024-42327](https://nvd.nist.gov/vuln/detail/CVE-2024-42327)