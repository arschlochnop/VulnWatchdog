## CVE-2021-25646-Apache Druid-远程代码执行

**漏洞编号:** CVE-2021-25646

**漏洞类型:** 远程代码执行

**影响应用:** Apache Druid

**危害等级:** 高危，可导致服务器被完全控制

**影响版本:** <= 0.20.0

**利用条件:** 需要目标Druid服务版本小于等于0.20.0，且攻击者需要能够发送构造好的恶意请求到Druid服务器。

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2021-25646 是 Apache Druid 中的一个远程代码执行漏洞。攻击者可以通过发送特制的请求，在目标服务器上执行任意 JavaScript 代码。漏洞存在于 Druid 处理某些请求时，允许用户提供的 JavaScript 代码绕过默认的安全设置。该漏洞的利用方式是，首先攻击者需要构造一个包含恶意 JavaScript 代码的 JSON payload。这个 payload 会被发送到 Druid 服务器的 `/druid/indexer/v1/sampler` 接口。Druid 在处理这个 payload 时，会执行其中的 JavaScript 代码，从而导致远程代码执行。

**有效性：**

根据漏洞库信息、搜索引擎结果和提供的 POC 代码，此漏洞利用**有效**。搜索引擎结果中多篇文章都描述了该漏洞，并指出它可以导致远程代码执行。提供的 POC 代码 `cve-2021-25646.py` 实现了漏洞利用，通过构造包含恶意 JavaScript 代码的请求，可以触发远程代码执行。

**投毒风险：**

虽然POC代码本身实现了漏洞利用，但仍需分析是否存在其他潜在的投毒代码。以下是关于投毒风险的评估：

*   **代码分析：** POC代码主要功能是发送包含恶意JavaScript的POST请求。它接受URL和命令作为参数，并将命令嵌入到JavaScript代码中。代码本身看起来比较直接，没有明显的后门或恶意行为。
*   **外部依赖：** POC代码依赖于 `requests` 和 `json` 库，这两个库是常用的 Python 库，风险较低。
*   **作者信誉：** 根据README文件,漏洞作者来自github,但无法有效评估此作者的信誉，因此存在一定的风险，但总体较低。
*   **网络行为：** POC代码会向目标 Druid 服务器发送 POST 请求，这是漏洞利用的正常行为。但如果代码还尝试连接其他未知的服务器，则可能存在投毒风险。

综合以上因素，**投毒风险较低，约为 5%**。主要风险可能来自于对作者的不信任，以及无法完全保证代码中不存在隐藏的恶意行为。

**利用方式：**

1.  **身份验证：** 根据漏洞描述，此漏洞需要**认证用户**才能触发，但搜索引擎的结果显示部分场景下无需认证。
2.  **构造 Payload：** 攻击者需要构造一个包含恶意 JavaScript 代码的 JSON payload。POC 代码已经提供了一个 payload 模板，只需要修改其中的 JavaScript 代码即可。
3.  **发送请求：** 将构造好的 payload 发送到 Druid 服务器的 `/druid/indexer/v1/sampler` 接口。
4.  **执行代码：** Druid 服务器会执行 payload 中的 JavaScript 代码，从而导致远程代码执行。

POC 使用了内联数据源和 JSON 输入格式，并在转换规范中使用 JavaScript filter 来执行命令。攻击者可以将任意命令嵌入到 JavaScript 代码中，例如执行系统命令、读取文件或下载恶意软件。

**修复建议：**

*   升级到 Druid 0.20.1 或更高版本。
*   限制对 Druid 集群机器的网络访问，仅允许受信任的主机访问。

**项目地址:** [j2ekim/CVE-2021-25646](https://github.com/j2ekim/CVE-2021-25646)

**漏洞详情:** [CVE-2021-25646](https://nvd.nist.gov/vuln/detail/CVE-2021-25646)