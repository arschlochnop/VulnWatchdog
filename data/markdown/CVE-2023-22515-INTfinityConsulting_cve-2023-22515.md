## CVE-2023-22515 - Confluence 破损的访问控制

**漏洞编号:** CVE-2023-22515

**漏洞类型:** 破损的访问控制

**影响应用:** Atlassian Confluence Server 和 Data Center

**危害等级:** 严重，允许未授权的远程攻击者创建 Confluence 管理员账户并访问 Confluence 实例，最终导致远程代码执行。

**影响版本:** 受影响版本：8.0.0 <= version < 8.3.3, 8.4.0 <= version < 8.4.3, 8.5.0 <= version < 8.5.2

**利用条件:** Confluence 实例需公开访问。

**POC 可用性:** 是

**投毒风险:** 20%

## 详情

CVE-2023-22515 是 Atlassian Confluence Server 和 Data Center 中的一个破损的访问控制漏洞。该漏洞允许未经身份验证的攻击者创建未授权的 Confluence 管理员帐户，从而获得对 Confluence 实例的完全控制权。利用方式如下：

1.  **绕过初始化设置：** 攻击者发送一个 GET 请求到 `/server-info.action?bootstrapStatusProvider.applicationConfig.setupComplete=false`，使 Confluence 实例重新进入引导模式（bootstrap mode）。
2.  **创建管理员账户：** 攻击者使用 POST 请求向 `/setup/setupadministrator.action` 端点发送包含新管理员账户信息的请求，从而创建一个新的管理员账户。
3.  **完成引导过程：** 攻击者使用 POST 请求向 `/setup/finishsetup.action` 端点发送请求，完成引导过程。
4.  **获取 UPM Token：** 使用新创建的管理员账户的凭据进行 base64 编码，并通过 Basic 认证向 `/rest/plugins/1.0/?os_authType=basic` 发送 GET 请求，获取 UPM（Universal Plugin Manager）token。
5.  **上传恶意插件：** 攻击者使用获取的 UPM token，通过 POST 请求将包含恶意代码的插件上传到 `/rest/plugins/1.0/?token=<UPM_TOKEN>` 端点。
6.  **远程代码执行：** 恶意插件被安装后，其中的代码可以在 Confluence 服务器上执行，实现远程代码执行。

**有效性：** 根据漏洞库信息、搜索结果和提供的漏洞利用代码，可以判断该POC代码是有效的。搜索结果中许多文章都提到了该漏洞被积极利用，并且提供了利用脚本的链接。提供的 Python 脚本实现了创建管理员账户并上传恶意插件以实现 RCE 的过程。

**投毒风险：** 漏洞利用代码包含两个 Python 脚本（CVE-2023-22515.py 和 confluence-client.py）以及一些插件相关的配置文件。主要的风险点在于上传的插件 (`logger-1.0.0-SNAPSHOT.jar`)。虽然提供了构建插件所需的 pom.xml 和一些其他文件，但**无法完全确定**该插件中是否包含作者隐藏的恶意代码。CVE-2023-22515.py本身的作用是创建一个新的管理员用户，并上传jar插件。confluence-client.py 用于与上传的恶意plugin进行交互，执行命令。LICENSE和README只是插件的辅助描述文件，不包含恶意代码。因此投毒的风险主要集中在 jar文件本身, 考虑jar文件需要进行二次开发，存在一定门槛，因此投毒风险为20%。

**利用方式：** 该漏洞的利用方式是未经授权创建管理员账户，然后利用管理员权限上传恶意插件以实现远程代码执行。

**项目地址:** [INTfinityConsulting/cve-2023-22515](https://github.com/INTfinityConsulting/cve-2023-22515)

**漏洞详情:** [CVE-2023-22515](https://nvd.nist.gov/vuln/detail/CVE-2023-22515)