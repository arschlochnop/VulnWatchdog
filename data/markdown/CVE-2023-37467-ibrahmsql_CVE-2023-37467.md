## CVE-2023-37467: Discourse CSP Nonce Reuse Bypass

**漏洞编号:** CVE-2023-37467

**漏洞类型:** CSP Nonce 重用漏洞

**影响应用:** Discourse

**危害等级:** 中危，可能导致XSS攻击

**影响版本:** < 3.1.1 stable, < 3.2.0.beta2

**利用条件:** 需要目标Discourse实例存在CSP策略，且未修复此漏洞，匿名用户可利用

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

该漏洞源于Discourse在特定版本中对匿名用户Content Security Policy (CSP) nonce 的重用。POC代码首先检测目标是否存在CSP策略，然后尝试发现页面中的nonce。如果发现可用的nonce，则测试这些nonce是否可以在不同的请求中重用。如果nonce可以重用，攻击者可以利用该nonce绕过CSP的保护，从而执行跨站脚本攻击 (XSS)。

**有效性分析：**

根据漏洞信息和POC代码，此漏洞利用是有效的。POC代码实现了漏洞的检测和利用过程，包括CSP策略的检测、nonce的发现和nonce的重用测试。如果nonce可以被重用，则证明漏洞存在，攻击者可以构造包含该nonce的恶意脚本来绕过CSP。

**投毒风险分析：**

该POC代码主要用于验证漏洞是否存在，并未发现明显的恶意行为或后门代码。 代码逻辑主要集中在请求页面，解析CSP策略，提取nonce以及测试nonce的有效性。 基于目前的分析, 投毒的可能性较低.但不能排除未来版本存在投毒的风险, 建议人工代码审计.风险概率为0%。

**利用方式：**

1.  **检测CSP策略：** 检查目标网站是否存在CSP策略，以及CSP策略是否使用了nonce。
2.  **发现nonce：** 从目标网站的HTML代码中提取CSP nonce。POC尝试在多个常见页面 (/, /login, /signup, /categories, /latest, /admin, /users) 中获取nonce
3.  **测试nonce重用：** 验证提取的nonce是否可以在不同的HTTP请求中重用。
4.  **XSS攻击：** 如果nonce可以重用，构造包含该nonce的恶意JavaScript代码，嵌入到网页中，从而绕过CSP的保护，实现XSS攻击。
5.  **利用范围限制:** 此漏洞只影响匿名用户，登录用户不受影响。
6.  **缓解措施:** 禁用Google Tag Manager, 或升级到 >= 3.1.0.beta7 版本.

**项目地址:** [ibrahmsql/CVE-2023-37467](https://github.com/ibrahmsql/CVE-2023-37467)

**漏洞详情:** [CVE-2023-37467](https://nvd.nist.gov/vuln/detail/CVE-2023-37467)