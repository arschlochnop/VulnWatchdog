## CVE-2021-29447-WordPress-XXE

**漏洞编号:** CVE-2021-29447

**漏洞类型:** XML外部实体注入 (XXE)

**影响应用:** WordPress

**危害等级:** 高危，可能导致敏感文件泄露

**影响版本:** >= 5.6.0, < 5.7.1 (PHP 8)

**利用条件:** 需要WordPress运行在PHP 8环境下，并具有上传文件的权限（例如，作者角色）

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

此漏洞存在于WordPress的媒体库中，允许具有上传文件权限的用户（如作者）通过上传包含恶意XML的WAV文件来执行XXE攻击。攻击需要目标WordPress站点运行在PHP 8环境下。POC代码通过创建一个包含恶意XML声明的WAV文件，该声明定义了一个外部实体，指向攻击者控制的服务器上的DTD文件。DTD文件定义了如何处理外部实体，这里配置为读取服务器上的`/etc/passwd`文件并通过HTTP请求发送给攻击者。攻击者运行一个简单的Web服务器来接收泄露的数据。

**有效性：**
根据漏洞库信息、搜索结果以及提供的POC代码，此漏洞利用是有效的，前提是目标环境满足漏洞利用的先决条件（WordPress版本 >= 5.6.0 且 < 5.7.1，运行在PHP 8环境下，攻击者具有文件上传权限）。搜索结果中存在多个关于此漏洞的讨论和POC代码，验证了其有效性。

**投毒风险：**
评估投毒风险需要检查POC代码中是否存在除了漏洞利用之外，还执行其他恶意操作的代码。在此案例中，主要关注`attacker/malicious_wav/index.js`，`attacker/www/evil.dtd`和`attacker/decode.php`。`index.js`负责生成恶意WAV文件，而`evil.dtd`定义了XXE的行为，`decode.php`用于解码泄露的数据。`Makefile`，`docker-compose.yml`和`README.md`都属于辅助文件。

潜在的投毒代码可能存在于以下几个方面：
1.  **`index.js`**: 恶意WAV生成脚本可能被修改，以在生成过程中包含其他恶意代码（例如，在WAV文件的其他部分添加可执行代码，虽然利用难度较大）。
2.  **`evil.dtd`**: DTD文件可能被修改，以尝试读取其他更敏感的文件，或者尝试执行服务器端请求伪造（SSRF）攻击。
3.  **`decode.php`**: 解码脚本可能被修改，在解码过程中执行其他恶意操作（例如，尝试利用解码过程中的漏洞执行代码）。

由于漏洞利用的目的是读取文件并通过HTTP发送到攻击者控制的服务器，因此主要的风险在于DTD文件中指定的远程服务器是否被用于记录IP地址并进行进一步的攻击。此外，`decode.php`脚本本身是否包含后门也是需要关注的点，虽然可能性较小。

总体来说，该仓库中存在严重投毒代码的可能性相对较低（约为10%），但仍然需要仔细审查。

**利用方式：**
1.  **环境准备：** 设置一个易受攻击的WordPress实例（版本5.6.0到5.7.0，运行在PHP 8上）。
2.  **启动攻击者服务器：** 启动一个Web服务器来托管恶意DTD文件并接收泄露的数据。
3.  **生成恶意WAV文件：** 使用提供的脚本生成包含恶意XML声明的WAV文件。
4.  **上传WAV文件：** 以具有文件上传权限的用户身份登录到WordPress后台，并将生成的WAV文件上传到媒体库。
5.  **触发XXE：** 上传文件后，WordPress尝试解析该文件，触发XXE漏洞。
6.  **接收泄露的数据：** 攻击者的Web服务器接收到包含/etc/passwd文件内容的HTTP请求。
7.  **解码数据：** 使用提供的解码脚本解码泄露的数据。

**项目地址:** [specializzazione-cyber-security/demo-CVE-2021-29447-lezione](https://github.com/specializzazione-cyber-security/demo-CVE-2021-29447-lezione)

**漏洞详情:** [CVE-2021-29447](https://nvd.nist.gov/vuln/detail/CVE-2021-29447)