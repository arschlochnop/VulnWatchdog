## CVE-2024-6387 - OpenSSH RegreSSHion 漏洞

**漏洞编号:** CVE-2024-6387

**漏洞类型:** 竞争条件漏洞

**影响应用:** OpenSSH

**危害等级:** 高危，可能导致远程代码执行 (RCE) 或拒绝服务 (DoS)

**影响版本:** 8.5p1 <= 版本 <= 9.7p1

**利用条件:** 需要目标系统基于 glibc，且 OpenSSH 版本在受影响范围内

**POC 可用性:** 是

**投毒风险:** 20%

## 详情

CVE-2024-6387 (RegreSSHion) 是 OpenSSH 服务器 (sshd) 中的一个安全回归漏洞，源于 CVE-2006-5051。它是一个信号处理程序中的竞争条件，可能导致 `sshd` 以不安全的方式处理某些信号。未经验证的远程攻击者可以通过在设定的时间内未能通过身份验证来触发此漏洞。成功利用可能允许攻击者在目标系统上以 root 权限执行任意代码或导致拒绝服务。

**有效性评估：**
根据漏洞库信息和搜索结果，此漏洞的 PoC 已被公开，并且漏洞利用的复杂性较高。搜索结果表明，该漏洞影响 glibc 基础的 Linux 系统。提供的 POC 代码似乎旨在利用此漏洞。

**投毒风险分析：**
该 POC 代码中存在一定的投毒风险，大约 20%。原因如下：
*   **Shellcode 占位符:** 代码中包含 `unsigned char shellcode[] = "\x90\x90\x90\x90";` 这一行，明确指出需要替换为实际的 shellcode。如果用户不小心使用了该占位符，或者植入了其他有害 shellcode，则可能导致不可预期的后果。
*   **GLIBC 基地址硬编码:** 代码中定义了 `uint64_t GLIBC_BASES[] = { 0xb7200000, 0xb7400000 };`，并表示 “Needs adjustment for specific target systems”。如果 GLIBC 基地址不正确，可能导致利用失败，甚至造成程序崩溃。攻击者可能会故意提供错误的基地址，使得用户在尝试利用时受到干扰，或者执行其他恶意操作。
*   **Timing 参数需要微调:** 代码注释中提到 “Timing parameters: Fine-tune based on target system responsiveness”。如果 timing 参数设置不当，可能导致竞争条件无法触发，或者引发其他问题。攻击者可能会提供误导性的 timing 参数，使得用户在尝试利用时遇到困难，或者触发非预期的行为。
*   **Heap 布局和文件结构偏移量:** 代码注释提到 “Heap layout : Requires tweaking for different OpenSSH versions” 和 “File structure offsets: Verify for the specific glibc version.” 这表示该漏洞利用依赖于特定的堆布局和文件结构偏移量。如果这些值不正确，则可能导致利用失败，甚至造成程序崩溃。攻击者可能会提供不兼容的值，使得用户在尝试利用时受到干扰，或者触发非预期的行为。
*   **错误处理不完善:** 代码中虽然包含了一些错误处理逻辑，但可能存在未处理的异常情况。攻击者可能会利用这些漏洞，使得程序在特定条件下崩溃或执行非预期的操作。

**利用方式：**
利用方式主要涉及以下步骤：
1.  **建立连接：** 与目标 SSH 服务器建立 TCP 连接。
2.  **SSH 握手：** 执行 SSH 握手过程，包括版本交换和密钥交换。
3.  **堆准备：** 通过发送特定的数据包，在堆上创建特定的布局。
4.  **时间控制：** 精确控制数据包的发送时间，以便触发竞争条件。
5.  **竞争条件触发：** 通过大量连接尝试和认证失败，利用信号处理程序的竞争条件在内存中注入恶意代码，通常包括修改 glibc 的数据结构。
6.  **代码执行：** 利用注入的恶意代码来执行任意命令。
7.  **绕过 ASLR：** 由于地址空间布局随机化 (ASLR) 的存在，需要确定 glibc 的基地址。PoC 代码中尝试了几个常见的基地址。

总体而言，该漏洞利用较为复杂，需要对 SSH 协议、glibc 内部机制和竞争条件有深入的了解。该漏洞的成功利用还依赖于目标系统的特定配置和状态。

**项目地址:** [awusan125/test_for6387](https://github.com/awusan125/test_for6387)

**漏洞详情:** [CVE-2024-6387](https://nvd.nist.gov/vuln/detail/CVE-2024-6387)