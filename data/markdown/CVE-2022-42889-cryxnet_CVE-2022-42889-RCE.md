## CVE-2022-42889-Apache Commons Text RCE (Text4Shell)

**漏洞编号:** CVE-2022-42889

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Apache Commons Text

**危害等级:** 高危，允许未经身份验证的攻击者执行任意命令

**影响版本:** 1.5 - 1.9

**利用条件:** 需要应用程序使用Apache Commons Text 1.5-1.9版本,并且允许从不受信任的源接收和处理字符串输入。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2022-42889，也被称为Text4Shell，是Apache Commons Text库中的一个远程代码执行漏洞。该漏洞源于库中存在不安全的变量插值功能。攻击者可以通过构造包含恶意表达式的字符串，利用`${prefix:name}`格式进行插值，其中 `prefix` 指定了 `StringLookup` 的实例，而 `name` 包含了要执行的命令或表达式。

**有效性：**
根据提供的漏洞信息和搜索结果，该漏洞是真实存在的，并且影响Apache Commons Text 1.5到1.9版本。POC代码的`README.md`文件描述了漏洞原理和利用方式，`main.py`文件包含了利用漏洞的代码示例。利用脚本中使用了`script`、`url` 和 `dns` 等前缀，这些前缀在受影响的版本中默认启用，可导致任意代码执行。

**投毒风险：**
该POC代码主要目标是利用漏洞，但存在一定的投毒风险。风险评估在10%。主要原因分析如下：

*   **代码混淆/隐藏：** 虽然没有明显的混淆，但是代码的可读性不是非常高，存在一些压缩和简化写法，这可能用来隐藏恶意代码。
*   **恶意依赖：** 脚本中使用了`os`, `requests`, `colorama`, `base64`, `nmap`库。这些库本身没有问题，但存在被滥用的可能. 比如`os.system` 或 `subprocess.call` 执行恶意命令.
*   **Payload生成：** 脚本中定义了`payloads`字典，其中包含一些 RCE Payload。攻击者可能会修改这些payload执行恶意指令。
*   **网络行为：** 脚本使用`requests`库，可能用于下载恶意payload或者回传信息。`nmap` 也可能被滥用。
*   **powershellRevshell：** 脚本包含了一个powershell reverse shell 脚本，需要LHOST和LPORT，可能被用于植入后门。

**利用方式：**
利用方式如下：
1.  **漏洞定位：** 找到使用存在漏洞的 Apache Commons Text 库，且允许用户可控输入的地方。
2.  **构造Payload：** 构造包含恶意表达式的字符串，例如 `${script:javascript:java.lang.Runtime.getRuntime().exec('COMMAND')}`。将 'COMMAND' 替换为要执行的命令。
3.  **发送Payload：** 将构造的Payload发送到目标应用程序。
4.  **执行代码：** 如果应用程序使用存在漏洞的Commons Text库处理了Payload，那么恶意命令将被执行。

**总结：**
该漏洞利用的有效性较高，因为可以通过多种方式执行任意命令。虽然提供的POC主要是为了验证漏洞，但是如果被恶意修改，仍然存在投毒的可能。使用该POC时需要注意安全风险，并对其代码进行详细审查。

**项目地址:** [cryxnet/CVE-2022-42889-RCE](https://github.com/cryxnet/CVE-2022-42889-RCE)

**漏洞详情:** [CVE-2022-42889](https://nvd.nist.gov/vuln/detail/CVE-2022-42889)