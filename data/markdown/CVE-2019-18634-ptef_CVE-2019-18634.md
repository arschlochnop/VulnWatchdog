## CVE-2019-18634-Sudo-Stack Buffer Overflow

**漏洞编号:** CVE-2019-18634

**漏洞类型:** 栈缓冲区溢出

**影响应用:** Sudo

**危害等级:** 高危，可能导致提权

**影响版本:** < 1.8.26

**利用条件:** pwfeedback在/etc/sudoers中被启用

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2019-18634是一个存在于Sudo 1.8.26之前的版本中的栈缓冲区溢出漏洞。当/etc/sudoers中启用了pwfeedback选项时，攻击者可以通过向getln()函数（位于tgetpass.c文件中）的stdin传递一个长字符串来触发此漏洞。根据漏洞利用代码中的README.md文件，提供的exploit.c是为Linux Mint 19.1编写的，可能不适用于其他发行版。代码利用了sudo在处理密码反馈时的逻辑缺陷。它首先创建一个伪终端(PTY)，然后设置SUDO_ASKPASS环境变量指向自身的可执行文件。当sudo需要密码时，它会调用这个程序，攻击者通过精心构造的payload溢出缓冲区，从而获得root权限。

**有效性评估：**
提供的POC代码的有效性取决于目标系统是否满足以下条件：
1.  Sudo版本低于1.8.26。
2.  /etc/sudoers文件中启用了pwfeedback选项。
3.  目标系统是Linux Mint 19.1或与其环境相似。
如果满足这些条件，则POC代码可能有效。由于该exploit.c是专门为Linux Mint 19.1编写的，因此在其他系统上的有效性可能会降低，可能需要修改偏移量和其他参数。

**投毒风险评估：**
检查提供的POC代码，`/tmp/90dfda9b786d9360fffaee181aa67425/exploit.c`中存在可疑的代码，风险点主要存在于以下几点：
1.  **硬编码的利用目标：** README.md表明该漏洞利用程序是为特定的Linux Mint版本编写的，这意味着它可能包含特定于该环境的偏移量或配置。如果未经修改直接在其他系统上使用，可能会导致崩溃或不可预测的行为。
2.  **关于payload的注释不清晰：**
    /*
     * below we build the payload that will trigger the vulnerability.
     * we need to fill the following BSS variables: buf + askpass + signo
     * + se_state + user_details. 
     * FIXME: corrigir o texto e explicar melhor
     */ 这一段注释表明作者本人对payload的构造细节也不是特别理解，存在一定的风险。
3.  **对`PLEASE_EXEC_MY_SHELL`环境变量的使用:** 这段代码中使用了环境变量 `PLEASE_EXEC_MY_SHELL` 来执行 `/bin/sh`。虽然代码本身没有明显的恶意行为，但如果攻击者能够控制这个环境变量的值，他们可能会执行任意命令。尽管这部分代码的目的是为了获得shell，但如果被滥用，也可能导致系统被攻陷。
4.  **错误处理不足：** 该漏洞利用代码中存在一些错误处理，但可能不够完善。例如，如果`readlink`失败，它会简单地调用`err`退出，这可能会阻止漏洞利用程序继续执行。更健壮的错误处理机制可以提高漏洞利用程序的可靠性。
总的来说，该漏洞利用代码的投毒风险预估为10%。它主要是为了利用漏洞而不是进行恶意活动而设计的，但潜在的滥用风险仍然存在，特别是如果攻击者可以控制某些环境变量或修改代码本身。

**利用方式分析：**
该漏洞的利用方式如下：
1.  **环境准备：** 确保目标系统上启用了pwfeedback选项，并且Sudo版本易受攻击。
2.  **编译漏洞利用代码：** 使用gcc等编译器编译提供的exploit.c文件。
3.  **运行漏洞利用代码：** 运行编译后的可执行文件。该程序将创建一个伪终端，设置SUDO_ASKPASS环境变量，并执行sudo -S 命令。
4.  **触发缓冲区溢出：** 当sudo提示输入密码时，漏洞利用代码将发送一个特制的payload，覆盖栈上的缓冲区。
5.  **提权：** 如果payload构造正确，成功溢出缓冲区后，攻击者将获得root权限。

**项目地址:** [ptef/CVE-2019-18634](https://github.com/ptef/CVE-2019-18634)

**漏洞详情:** [CVE-2019-18634](https://nvd.nist.gov/vuln/detail/CVE-2019-18634)