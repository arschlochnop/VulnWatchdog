## CVE-2022-30190 - Microsoft MSDT 远程代码执行漏洞 (Follina)

**漏洞编号:** CVE-2022-30190

**漏洞类型:** 远程代码执行

**影响应用:** Microsoft Windows Support Diagnostic Tool (MSDT)

**危害等级:** 高危，攻击者可以利用此漏洞在受害者系统上执行任意代码，完全控制受害者系统。

**影响版本:** 受影响的版本包括Windows 7到Windows 11和Windows Server的多个版本，具体参见漏洞库信息。

**利用条件:** 需要用户打开恶意的Office文档（如Word）或访问包含恶意代码的网页。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2022-30190（又名Follina）是一个存在于Microsoft支持诊断工具（MSDT）中的远程代码执行漏洞。攻击者可以诱骗用户打开包含恶意链接或嵌入对象的Office文档（例如Word文档）。当用户打开恶意文档时，MSDT会尝试通过URL协议连接到攻击者控制的远程服务器。该服务器会提供一个包含恶意代码的HTML文件。这个HTML文件利用`ms-msdt:`协议触发MSDT执行任意代码。\n\n**利用方式分析：**\n
1.  **攻击者准备：** 攻击者需要搭建一个HTTP服务器，用于托管恶意payload。同时，攻击者需要创建一个恶意的Office文档，该文档包含一个指向攻击者服务器上HTML payload的链接。
2.  **诱骗受害者：** 攻击者通过电子邮件、社交媒体或其他方式将恶意Office文档发送给受害者。\n3.  **漏洞触发：** 受害者打开恶意Office文档。Word会尝试通过URL协议访问攻击者服务器上的HTML payload。\n4.  **代码执行：** HTML payload利用`ms-msdt:`协议，导致MSDT执行攻击者指定的命令。攻击者可以利用此漏洞安装恶意软件、窃取数据、创建新账户等。\n\n**代码分析：**\n
提供的Go代码是一个PoC，用于生成利用该漏洞的恶意docx文件。其主要步骤如下：

1.  `createMaliciousDocx` 函数：读取模板文件 `template/document.xml.rels.template`，将占位符 `{staged_html}` 替换为 payload 的 URL，然后将其写入 `template/doc/word/_rels/document.xml.rels`。接着调用 `zipDoc` 函数，将 `template/doc/` 目录下的所有文件打包成一个恶意的 docx 文件（tmp/file.docx）。
2.  `zipDoc` 函数：创建一个zip文件 (tmp/file.docx)，然后调用 `addFilesToArchive` 函数将 `template/doc/` 目录下的所有文件添加到该zip文件中。
3.  `addFilesToArchive` 函数：递归地将指定目录下的所有文件添加到zip文件中。
4.  `createPayload` 函数：生成包含恶意 ms-msdt 协议调用的 HTML payload。这个 payload 会使用 PowerShell 下载并执行攻击者指定的反向shell程序。
5.  `hostDropper` 函数：启动一个HTTP服务器，用于托管 payload.html 和反向shell程序 (poop.exe)。

**投毒风险分析：**\n
PoC 代码主要用于生成恶意的 docx 文件，核心在于生成包含恶意 `ms-msdt` 协议调用的 `payload.html` 文件。仔细检查代码，没有发现明显的恶意后门，但是存在以下几点潜在风险：

1.  **反向 Shell：**  代码中使用反向 shell。如果攻击者使用 PoC 生成恶意文件，他们可以完全控制受害者的计算机。PoC 本身不是后门，但容易被滥用。`revshellpath` 参数允许攻击者指定任意可执行文件，这为植入恶意软件提供了机会。
2.  **依赖性：** 此 PoC 依赖于模板文件 `template/document.xml.rels.template` 和指定的反向 shell 程序。如果这些文件被篡改，PoC 的行为可能会发生变化。在实际应用中，攻击者可以修改模板文件，例如嵌入其他的恶意代码。
3. **随机字符串生成器:** 代码中使用随机字符串来填充html，增加分析难度，也可能存在一定的随机性风险。

总体来说，此 PoC 存在一定的投毒风险，主要是由于反向 shell 的使用，以及对外部文件的依赖。但代码本身并不包含明显的恶意后门。 风险概率估计为 10%， 主要来自第三方恶意软件捆绑或者程序被篡改。

**项目地址:** [Zitchev/go_follina](https://github.com/Zitchev/go_follina)

**漏洞详情:** [CVE-2022-30190](https://nvd.nist.gov/vuln/detail/CVE-2022-30190)