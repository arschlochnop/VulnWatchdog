## CVE-2022-42889 Text4Shell

**漏洞编号:** CVE-2022-42889

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Apache Commons Text

**危害等级:** 高危，允许未经身份验证的攻击者执行任意代码

**影响版本:** 1.5 <= version <= 1.9

**利用条件:** 应用程序使用了受影响版本的Apache Commons Text，并且允许用户可控的字符串传递给`StringSubstitutor.replace()`方法。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2022-42889，又名Text4Shell，是Apache Commons Text库中的一个漏洞。该漏洞源于库中使用的字符串插值功能，攻击者可以通过构造包含恶意表达式的字符串，利用`script`, `dns` 或 `url` 等前缀，触发远程代码执行。该漏洞利用的有效性较高，因为提供的POC代码直接演示了如何使用`script`前缀执行`touch /tmp/foo`命令。Docker文件和README文件提供了构建和运行包含漏洞的应用程序的详细说明。尽管POC展示了RCE，但是仍然需要确认是否存在投毒风险，通过阅读所有提供的文件，没有发现任何隐藏的后门代码或其他恶意行为。Dockerfile文件用于构建包含漏洞应用程序的Docker镜像，pom.xml指定了所使用的commons-text版本为1.8，处于漏洞影响范围内。java代码也用于漏洞的验证。`HelloController.java` 暴露了一个 `/text4shell/attack` 的API接口，接收一个名为 `search` 的参数，并使用 `StringSubstitutor.replace()` 方法对其进行处理，从而导致漏洞。风险主要在于，这个demo程序是否会被滥用，作者是否会把这个程序用于攻击等等。 经过评估,作者投毒的可能性较小，但是仍然有一定的潜在风险，大约为10%。

**利用方式：**
1.  攻击者将特制的字符串（包含`${prefix:payload}`格式的恶意表达式）作为输入，传递给使用了`StringSubstitutor.replace()`方法的应用程序。
2.  `StringSubstitutor`会对字符串进行插值，如果`prefix`是`script`，`dns`或者`url`，则会调用相应的lookup来解析`payload`。
3.  `script`前缀允许执行任意的Java代码，`dns`前缀允许进行DNS查询，`url`前缀允许从URL加载内容，恶意构造的`payload`可以导致RCE或SSRF攻击。

**项目地址:** [MendDemo-josh/cve-2022-42889-text4shell](https://github.com/MendDemo-josh/cve-2022-42889-text4shell)

**漏洞详情:** [CVE-2022-42889](https://nvd.nist.gov/vuln/detail/CVE-2022-42889)