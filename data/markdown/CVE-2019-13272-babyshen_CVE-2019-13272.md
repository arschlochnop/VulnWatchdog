## CVE-2019-13272 Linux Kernel PTRACE_TRACEME 本地提权漏洞

**漏洞编号:** CVE-2019-13272

**漏洞类型:** 本地提权

**影响应用:** Linux Kernel

**危害等级:** 高危，可导致本地用户获取root权限

**影响版本:** < 5.1.17

**利用条件:** 需要在存在PolKit agent的user session上下文执行，且kernel.yama.ptrace_scope < 2，SELinux deny_ptrace=off

**POC 可用性:** 是

**投毒风险:** 1%

## 详情

CVE-2019-13272是Linux内核中由于`ptrace_link`函数在处理`PTRACE_TRACEME`时，credential记录不当导致的一个本地提权漏洞。攻击者可以利用具有父子进程关系的场景，父进程降权并调用`execve`，从而获取root权限。利用该漏洞的POC代码通常会利用`pkexec` helper进行提权。 

**有效性评估：**
从提供的漏洞信息和利用代码来看，此漏洞利用的有效性较高。漏洞库信息中提供了多个验证链接，搜索引擎结果也显示了该漏洞的存在和影响。漏洞利用代码中包含了详细的注释，描述了漏洞原理，利用方法，以及测试通过的操作系统和内核版本，证明了此POC的有效性。

**投毒风险分析：**
浏览提供的POC代码，主要是利用 `ptrace` 系统调用和 Polkit 机制的交互。代码的目的是寻找合适的Polkit helper, 然后利用`pkexec`执行特定的命令。其中存在投毒风险的可能性极低。代码主要逻辑集中在利用漏洞本身，没有发现任何明显的恶意代码或后门。
评估结果：1%

**漏洞利用方式：**
1.  **环境检查:** 检查目标系统是否满足漏洞利用的前提条件，例如内核版本，是否存在PolKit agent，`kernel.yama.ptrace_scope`和SELinux的状态。
2.  **寻找Helper:** 利用`pkaction`命令或者预定义的helper路径，寻找可用的PolKit helper程序。这些helper程序通常是具有SUID权限的程序，可以被用来提权。
3.  **进程关系建立:** 创建一个父子进程关系。父进程降权，然后执行`pkexec`命令，子进程使用`PTRACE_TRACEME` attach 到父进程。
4.  **权限提升:** 由于内核中的漏洞，子进程可以获得父进程的权限，从而执行特权操作。
5.  **执行Payload:** 子进程获得root权限后，可以执行任意的payload，例如启动一个shell。

**项目地址:** [babyshen/CVE-2019-13272](https://github.com/babyshen/CVE-2019-13272)

**漏洞详情:** [CVE-2019-13272](https://nvd.nist.gov/vuln/detail/CVE-2019-13272)