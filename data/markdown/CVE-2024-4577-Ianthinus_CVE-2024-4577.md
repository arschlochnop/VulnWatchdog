## CVE-2024-4577-PHP-CGI Argument Injection

**漏洞编号:** CVE-2024-4577

**漏洞类型:** 远程代码执行

**影响应用:** PHP

**危害等级:** 高危，可能导致远程代码执行和敏感信息泄露

**影响版本:** PHP 8.1.* before 8.1.29, 8.2.* before 8.2.20, 8.3.* before 8.3.8

**利用条件:** Windows 系统 + Apache + PHP-CGI + 存在Best-Fit策略的codepage

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-4577 是一个 PHP-CGI 参数注入漏洞，存在于 Windows 版本的 PHP 中，当以 CGI 模式运行时，并且系统启用了使用 "Best Fit" 策略的代码页时，可能受到攻击。

**利用方式：**
攻击者可以利用 Windows 的 "Best-Fit" 字符转换行为，将恶意参数注入到 PHP CGI 进程的命令行参数中。PHP CGI 模块会将这些被转换后的字符解释为 PHP 选项，从而允许攻击者执行以下操作：

1.  **源代码泄露：** 通过注入参数来泄露 PHP 脚本的源代码。
2.  **远程代码执行：** 通过注入参数来执行任意 PHP 代码。

**POC 代码分析：**
提供的 POC 代码包含以下文件：

*   `Readme`：包含使用 PowerShell 进行漏洞利用的示例。通过 POST 请求，将包含恶意 PHP 代码的 payload 发送到目标服务器，并利用 `%AD` 字符绕过某些安全限制，设置 `allow_url_include` 和 `auto_prepend_file` 选项，从而执行远程代码。
*   `check.php`：用于检测目标环境是否满足漏洞利用的条件，包括 PHP 版本、SAPI 模式、操作系统和系统区域设置。
*   `httpd-xampp.conf`：XAMPP 的 Apache 配置文件，用于配置 PHP 环境。

**有效性：**
提供的 POC 代码是有效的，可以用于在满足漏洞利用条件的环境中执行任意 PHP 代码。搜索引擎结果也表明该漏洞已经被广泛利用。

**投毒风险：**
该仓库主要用于演示和验证 CVE-2024-4577 漏洞。 虽然主要代码看起来是无害的，但考虑到以下因素，存在一定的投毒风险：

*   POC本身就是一段恶意的代码，能执行远程命令。
*   `Readme` 文件中的 PowerShell 命令直接执行 POST 请求，存在注入恶意代码的可能性。 虽然例子是`whoami`但是如果被替换成别的, 则会造成投毒。

考虑到POC的特殊性，这里将投毒风险评估为10%。主要原因是，大部分代码是用于漏洞检测和利用，恶意代码的存在是为了利用漏洞，而不是为了隐藏恶意功能。

**项目地址:** [Ianthinus/CVE-2024-4577](https://github.com/Ianthinus/CVE-2024-4577)

**漏洞详情:** [CVE-2024-4577](https://nvd.nist.gov/vuln/detail/CVE-2024-4577)