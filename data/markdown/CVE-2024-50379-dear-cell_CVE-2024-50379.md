## CVE-2024-50379-Apache Tomcat-TOCTOU Race Condition RCE

**漏洞编号:** CVE-2024-50379

**漏洞类型:** TOCTOU Race Condition RCE

**影响应用:** Apache Tomcat

**危害等级:** 高危，可能导致远程代码执行

**影响版本:** 11.0.0-M1 <= version <= 11.0.1, 10.1.0-M1 <= version <= 10.1.33, 9.0.0.M1 <= version <= 9.0.97

**利用条件:** 默认servlet配置为可写(非默认配置)，文件系统大小写不敏感

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2024-50379 是一个 Apache Tomcat 中的 Time-of-check Time-of-use (TOCTOU) 竞争条件漏洞。当默认 servlet 配置为可写（非默认配置）且文件系统大小写不敏感时，攻击者可以通过竞争条件在JSP编译期间执行任意代码，导致远程代码执行（RCE）。

**漏洞利用方式：**

1.  **竞争条件：** 利用JSP编译过程中的TOCTOU漏洞，通过并发请求修改正在编译的文件。
2.  **PUT请求：** POC代码使用PUT方法尝试上传JSP文件到目标URL（/asd.Jsp 和 /qwe.Jsp）。
3.  **GET请求：** POC代码也使用GET请求访问JSP文件。
4.  **1.jsp和2.jsp:** POC利用了 /1.jsp 和 /2.jsp 文件，其中2.jsp 似乎动态生成jsp马，写入到/1.jsp.
5.  **并发执行：** 使用线程池并发执行PUT和GET请求，增加竞争成功的概率。
6.  **Payload：**  `upload.txt` 文件包含JSP payload，用于写入恶意代码。

**有效性评估：**

根据漏洞描述，搜索引擎结果和POC代码，该漏洞利用是有效的。POC代码尝试利用竞争条件上传包含恶意代码的JSP文件。

**投毒风险评估：**

POC代码本身的主要目的是利用漏洞，但存在一定的投毒风险，主要体现在以下几个方面：

1.  **恶意Payload：**`upload.txt` 文件中的payload可能包含恶意代码，如果使用者不检查该文件内容直接运行POC，可能会在目标系统上植入后门。
2.  **隐藏逻辑：** 脚本中可能存在隐蔽的后门代码, 虽然代码主要逻辑围绕竞争和JSP上传, 但不能完全排除作者添加额外恶意行为的可能性, 虽然可能性较低。
3.  **依赖风险：**虽然代码本身没有直接的外部依赖，如果`upload.txt`来自于外部，那风险就变得不可控。
总体来说，投毒风险较低，大约5%，但需要仔细审查`upload.txt`的内容，确保其安全性。

**建议：**
* 升级到Tomcat 11.0.2, 10.1.34 或 9.0.98。
* 禁用默认servlet的写入权限。
* 仔细审查并测试POC代码，确保理解其行为，避免未知的风险。

**项目地址:** [dear-cell/CVE-2024-50379](https://github.com/dear-cell/CVE-2024-50379)

**漏洞详情:** [CVE-2024-50379](https://nvd.nist.gov/vuln/detail/CVE-2024-50379)