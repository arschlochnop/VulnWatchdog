## CVE-2024-50379-Apache Tomcat-TOCTOU Race Condition RCE

**漏洞编号:** CVE-2024-50379

**漏洞类型:** TOCTOU Race Condition RCE

**影响应用:** Apache Tomcat

**危害等级:** 高危，可能导致远程代码执行

**影响版本:** 11.0.0-M1 <= version <= 11.0.1, 10.1.0-M1 <= version <= 10.1.33, 9.0.0.M1 <= version <= 9.0.97

**利用条件:** 需要在大小写不敏感的文件系统上运行，且Default Servlet开启了写入权限 (非默认配置)

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-50379是Apache Tomcat中JSP编译期间的TOCTOU竞争条件漏洞。 在大小写不敏感的文件系统（如Windows）上，如果Default Servlet被配置为允许写入（这并非默认配置），则可能导致远程代码执行。

**有效性：**
提供的POC代码是有效的，它展示了如何利用TOCTOU竞争条件漏洞。 POC通过上传JSP文件，然后迅速替换为大小写不同的相同文件名的JSP文件，从而利用文件系统的大小写不敏感性覆盖原始文件。

**投毒风险：**
该漏洞利用代码的投毒风险较低，约为10%。主要风险在于upload.jsp 中上传路径是可控的，有可能被修改指向其他目录，导致拒绝服务。

**利用方式：**
1.  **环境准备：**  目标系统必须运行在大小写不敏感的文件系统上（例如Windows）。同时，Tomcat的Default Servlet必须配置为允许写入，这需要修改`web.xml`。
2.  **上传恶意JSP文件：**  首先，上传一个JSP文件（例如`file.jsp`），该文件包含恶意代码，比如执行系统命令。
3.  **竞争条件利用：**  在上传`file.jsp`后，立即尝试上传一个大小写不同的同名文件（例如`FILE.JSP`）。由于文件系统的大小写不敏感性，后上传的文件会覆盖之前的文件。
4.  **代码执行：**  Tomcat会尝试编译和执行新上传的JSP文件，从而执行攻击者注入的恶意代码。

**总结：**
此漏洞利用的关键在于利用TOCTOU竞争条件和文件系统的大小写不敏感性，绕过Tomcat的安全检查，最终实现远程代码执行。

**项目地址:** [v3153/CVE-2024-50379-POC](https://github.com/v3153/CVE-2024-50379-POC)

**漏洞详情:** [CVE-2024-50379](https://nvd.nist.gov/vuln/detail/CVE-2024-50379)