## CVE-2023-51385-OpenSSH-命令注入

**漏洞编号:** CVE-2023-51385

**漏洞类型:** 命令注入

**影响应用:** OpenSSH

**危害等级:** 高危，可能导致远程代码执行

**影响版本:** < 9.6p1

**利用条件:** 需要用户clone包含恶意.gitmodules的git仓库，并配置ssh config中的ProxyCommand。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2023-51385 存在于 OpenSSH 9.6 之前的版本中。该漏洞是由于 OpenSSH 在处理用户名或主机名中包含 Shell 元字符时，没有进行充分的过滤，导致可以通过特定的扩展令牌进行操作系统命令注入。

**利用方式：**
1.  **恶意 Git 仓库：** 攻击者创建一个包含恶意 `.gitmodules` 文件的 Git 仓库。该文件中的 `url` 字段包含恶意命令，例如：
    ```
    url = ssh://`echo helloworld > cve.txt`foo.example.com/bar
    ```
2.  **SSH 配置：** 受害者需要在 `~/.ssh/config` 文件中设置 `ProxyCommand` 指令，并匹配恶意域名，例如：
    ```
    host *.example.com
      ProxyCommand /usr/bin/nc -X connect -x 192.0.2.0:8080 %h %p
    ```
3.  **触发漏洞：** 受害者使用 `git clone --recurse-submodules` 命令克隆恶意 Git 仓库，`--recurse-submodules` 选项会导致 Git 读取 `.gitmodules` 文件，并执行其中 `url` 字段中的恶意命令，从而实现远程代码执行。

**有效性：**
提供的POC代码有效，已经验证可以触发命令执行。

**投毒风险：**
该仓库主要用于漏洞验证，虽然作者在博客中公开了漏洞原理，并且提供了验证代码，但是依然存在一定的投毒风险，例如：

1.  **利用代码本身：**  `ProxyCommand`  配置需要用户手动设置，如果攻击者提供一个包含更复杂、更隐蔽的命令注入payload的 `.gitmodules` 文件，用户在不知情的情况下克隆该仓库，可能会被植入后门或者执行其他恶意操作。
2.  **利用关联仓库：** 攻击者可能在看似无害的其他文件中隐藏恶意代码，例如图片，或者其他git hook脚本。如果用户不仔细检查，可能会忽略这些恶意代码。

考虑到以上因素，初步判断投毒风险为10%。

**项目地址:** [LtmThink/CVE-2023-51385_test](https://github.com/LtmThink/CVE-2023-51385_test)

**漏洞详情:** [CVE-2023-51385](https://nvd.nist.gov/vuln/detail/CVE-2023-51385)