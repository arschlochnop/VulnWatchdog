## CVE-2024-32019-Netdata-ndsudo本地提权

**漏洞编号:** CVE-2024-32019

**漏洞类型:** 本地权限提升

**影响应用:** Netdata

**危害等级:** 高危，允许低权限用户获得root权限

**影响版本:** >= 1.45.0, < 1.45.3 和 >= 1.44.0-60, < 1.45.0-169

**利用条件:** 需要本地shell访问，能够执行ndsudo命令

**POC 可用性:** 是

**投毒风险:** 1%

## 详情

CVE-2024-32019 是 Netdata 中 ndsudo 工具的一个本地权限提升漏洞。ndsudo 是一个 SUID root 的可执行文件，但它使用 PATH 环境变量来查找要执行的命令。攻击者可以通过将恶意脚本放置在 PATH 环境变量中优先级更高的目录中，并将其命名为 ndsudo 允许执行的命令（例如 nvme），来欺骗 ndsudo 执行该恶意脚本并获得 root 权限。

**有效性：**

提供的 POC 代码描述了一种利用此漏洞的有效方法。它包括以下步骤：

1.  创建一个恶意脚本（poc.py），该脚本执行提权操作（例如，启动一个 root shell）。
2.  将此脚本重命名为 ndsudo 允许执行的命令之一（例如 nvme）。
3.  将包含恶意脚本的目录添加到 PATH 环境变量的开头。
4.  运行 ndsudo nvme-list，这将导致 ndsudo 执行恶意脚本，从而获得 root 权限。

**投毒风险：**

提供的代码仓库本身投毒风险较低。`poc.py` 代码非常简单，仅包含提权执行bash的代码，不太可能存在隐藏的恶意代码。`README.md` 文件提供了清晰的漏洞利用说明。但用户仍然需要注意，在实际环境中，从不可信的来源下载或复制漏洞利用代码都存在一定的风险，需要仔细检查代码是否存在恶意行为，再执行。

**利用方式：**

1.  **漏洞原理：** `ndsudo` 以 root 权限运行，但其搜索命令的路径依赖于用户的 `PATH` 环境变量。
2.  **攻击步骤：**
    *   创建恶意脚本，该脚本执行提权操作（例如，启动一个 root shell）。
    *   将此脚本重命名为 `ndsudo` 允许执行的命令之一（通过 `ndsudo --help` 查看）。
    *   将包含恶意脚本的目录添加到 `PATH` 环境变量的开头，确保恶意脚本优先被搜索到。
    *   运行 `ndsudo <allowed_command>`，这将导致 `ndsudo` 执行恶意脚本，从而获得 root 权限。

**总结：**

该漏洞利用较为简单，POC 代码的有效性较高，但应注意来源不明的exploit代码的潜在投毒风险。该漏洞允许低权限用户通过操纵 `PATH` 环境变量，利用 SUID 程序 `ndsudo` 提升至 root 权限。务必及时升级 Netdata 版本以修复此漏洞。

**项目地址:** [hexared/CVE-2024-32019_poc](https://github.com/hexared/CVE-2024-32019_poc)

**漏洞详情:** [CVE-2024-32019](https://nvd.nist.gov/vuln/detail/CVE-2024-32019)