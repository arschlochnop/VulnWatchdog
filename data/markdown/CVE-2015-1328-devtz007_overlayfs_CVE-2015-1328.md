## CVE-2015-1328 - Overlayfs 本地提权

**漏洞编号:** CVE-2015-1328

**漏洞类型:** 权限提升

**影响应用:** Linux Kernel (Overlayfs)

**危害等级:** 高危，本地用户可获取 root 权限

**影响版本:** Ubuntu Linux kernel package before 3.19.0-21.21 (Ubuntu through 15.04)

**利用条件:** 需要本地用户权限，overlayfs 被允许在用户命名空间中挂载。

**POC 可用性:** 是

**投毒风险:** 1%

## 详情

CVE-2015-1328 是一个存在于 Linux 内核 overlayfs 实现中的权限提升漏洞。在 Ubuntu 15.04 及更早版本的内核（直到 3.19.0-21.21）中，overlayfs 对 upper filesystem 目录中的文件创建权限检查不当，允许本地用户利用此漏洞获取 root 权限。漏洞利用方式如下：

1.  **利用方式：**
    *   利用 overlayfs 在用户命名空间中的挂载功能。
    *   创建一个 overlayfs 文件系统，将 `/proc/sys/kernel` 或 `/sys/kernel/security/apparmor` 作为 lowerdir，将 `/tmp/ns_sploit/upper` 作为 upperdir。
    *   在 overlayfs 文件系统中，尝试重命名 `ns_last_pid` 或 `.access` 文件为 `ld.so.preload`。由于权限检查不当，可以成功创建。
    *   然后卸载第一个 overlayfs 文件系统，再使用 `/tmp/ns_sploit/upper` 作为 lowerdir，`/etc` 作为 upperdir 创建一个新的overlayfs挂载点。
    *   修改`/tmp/ns_sploit/o/ld.so.preload`权限，卸载第二个挂载点
    *   创建一个恶意的共享库 `/tmp/ofs-lib.so`，其中包含在 `getuid()` 函数被调用时执行提权操作的代码，即调用 `setresuid(0, 0, 0)` 和 `execle("/bin/sh", "sh", "-i", NULL, NULL)`。
    *   将 `/tmp/ofs-lib.so` 的路径写入 `/etc/ld.so.preload`，使得系统加载该共享库。
    *   当任何程序调用 `getuid()` 时，恶意的 `getuid()` 函数会被执行，从而获得 root 权限。
    *   POC 代码中使用了 `su` 命令来触发提权。

2.  **有效性：**
    *   提供的 POC 代码在漏洞描述中指定的 Ubuntu 版本上是有效的。搜索引擎结果也显示存在可用的利用模块。

3.  **投毒风险：**
    *   代码中没有明显的投毒代码。但存在极小的风险(1%)，作者可能在动态链接库的生成或者其他地方埋藏后门，这个需要更多的代码审计来确定.例如，动态链接库编译过程中可能存在恶意指令。如果确认gcc来自可信源，并且没有其他可疑操作，则可以认为投毒风险较低。

**项目地址:** [devtz007/overlayfs_CVE-2015-1328](https://github.com/devtz007/overlayfs_CVE-2015-1328)

**漏洞详情:** [CVE-2015-1328](https://nvd.nist.gov/vuln/detail/CVE-2015-1328)