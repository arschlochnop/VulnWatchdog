## CVE-2020-11651 SaltStack 认证绕过/远程代码执行

**漏洞编号:** CVE-2020-11651

**漏洞类型:** 认证绕过/远程代码执行

**影响应用:** SaltStack

**危害等级:** 高危，可能导致数据泄露和远程代码执行

**影响版本:** < 3000.2, < 2019.2.4, 2017.*, 2018.*

**利用条件:** 需要网络访问Salt Master端口（默认4505和4506）

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2020-11651 是 SaltStack 中 ClearFuncs 类方法调用验证不当导致的认证绕过漏洞。未经身份验证的远程攻击者可以利用此漏洞读取 Salt Master 上的用户令牌和/或在 Salt Minion 上执行任意命令。

**漏洞利用有效性：**

根据漏洞库信息、搜索结果（尤其是packetstormsecurity的漏洞利用）和提供的漏洞利用代码，此漏洞利用的有效性较高。PoC代码旨在通过未授权访问来读取文件和写入文件，从而实现远程代码执行。

**投毒风险：**

分析提供的PoC代码，发现存在一定的投毒风险。虽然PoC的主要功能是利用漏洞添加用户，但是`write_file`函数存在向任意路径写入文件的能力，该函数中使用了`../../../../../../../../{path}`，虽然看似为了写入`/etc/`下的文件，但也存在构造恶意路径绕过限制写入其他敏感文件的可能性，因此具有一定的投毒风险。此外，代码中虽然有日志记录，但攻击者可以修改代码删除日志，从而隐藏其恶意行为。

**利用方式：**

1.  **认证绕过：** 利用 Salt Master 进程 ClearFuncs 类中方法调用验证不当的漏洞，绕过身份验证。
2.  **获取 Root Key：** 通过`_prep_auth_info`方法获取 Salt Master 的 Root Key。
3.  **读取任意文件：** 使用 Root Key，利用`file_roots.read` wheel 函数读取 Salt Master 上的任意文件，例如`/etc/shadow`，`/etc/passwd`文件，泄露敏感信息。
4.  **写入任意文件：** 使用 Root Key，利用`file_roots.write` wheel 函数向 Salt Master 上的任意文件写入内容，例如修改`/etc/shadow`或`/etc/passwd`文件添加恶意用户，或者写入webshell。
5.  **远程代码执行：** 通过写入恶意文件或者执行 Salt 命令，最终在 Salt Minion 上实现远程代码执行。

PoC 代码主要通过添加用户的方式进行利用，首先生成一个包含随机密码的用户，然后调用`file_roots.write` wheel 函数将用户添加到 `/etc/passwd` 和 `/etc/shadow` 文件中。代码中通过`req_channel`函数建立未授权连接，攻击者无需身份验证即可与 Salt Master 通信。


**项目地址:** [Drew-Alleman/CVE-2020-11651](https://github.com/Drew-Alleman/CVE-2020-11651)

**漏洞详情:** [CVE-2020-11651](https://nvd.nist.gov/vuln/detail/CVE-2020-11651)