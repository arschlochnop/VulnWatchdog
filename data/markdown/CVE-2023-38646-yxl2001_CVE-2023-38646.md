## CVE-2023-38646-Metabase-RCE

**漏洞编号:** CVE-2023-38646

**漏洞类型:** 远程代码执行

**影响应用:** Metabase

**危害等级:** 高危，无需认证即可远程代码执行

**影响版本:** < 0.46.6.1 and < 1.46.6.1

**利用条件:** Metabase服务可网络访问

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2023-38646 漏洞允许未经身份验证的攻击者在 Metabase 服务器上执行任意命令。该漏洞存在于 Metabase 开源版本 0.46.6.1 之前和 Metabase 企业版本 1.46.6.1 之前的版本中。

**利用方式：**

1.  **获取 Setup Token:** 首先，利用`CVE-2023-38646-POC.py`脚本，通过访问`/api/session/properties`接口来获取 Metabase 实例的 `setup-token`。此步骤用于判断目标是否存在漏洞，以及获取后续利用所需的token。
2.  **构造恶意请求:**  使用`CVE-2023-38646-Reverse-Shell.py`脚本，该脚本利用 H2 数据库的特性，在数据库连接字符串中嵌入恶意代码。具体来说，它创建了一个触发器 `pwnshell`，该触发器在访问 `INFORMATION_SCHEMA.TABLES` 表之前执行，从而触发 `java.lang.Runtime.getRuntime().exec()` 执行任意命令。脚本将反弹shell的bash命令进行base64编码，然后将其注入到触发器中。
3.  **发送 POST 请求:** 将构造好的包含恶意代码的 JSON 数据通过 POST 请求发送到 `/api/setup/validate` 接口。此请求使用获取的 `setup-token` 进行验证，并触发 H2 数据库连接，从而执行嵌入的恶意代码。

**有效性：**

根据漏洞信息和提供的漏洞利用代码，该漏洞的 POC 代码有效。搜索引擎结果也表明存在公开的 POC 并且该漏洞已被积极利用。

**投毒风险：**

`CVE-2023-38646-POC.py` 脚本只是用于获取 setup token，相对安全，投毒风险较低。
`CVE-2023-38646-Reverse-Shell.py`脚本本身实现了漏洞利用，但主要的功能是实现反弹 shell。 代码中对bash命令进行了base64编码,一定程度上增加了代码阅读的难度。存在一定风险：
    * 编码可能存在植入后门的风险，例如插入额外的命令或修改反弹 shell 的行为。尽管目前代码看上去是实现正常的反弹shell，但存在被篡改的可能性。例如，在base64编码前后加入恶意指令。
    * 该脚本依赖于目标系统上存在 bash 和 base64 命令。虽然大多数 Linux 系统都包含这些命令，但在某些受限环境中可能不存在。作者清楚这一点,但并未对这种情况进行处理,容易造成误判.
综合来看，投毒风险较低，约为10%。主要的风险集中在base64编码内容可能存在被修改或植入后门的风险。

**项目地址:** [yxl2001/CVE-2023-38646](https://github.com/yxl2001/CVE-2023-38646)

**漏洞详情:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)