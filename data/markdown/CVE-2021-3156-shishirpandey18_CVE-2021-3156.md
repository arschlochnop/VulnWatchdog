## CVE-2021-3156 - Sudo Baron Samedit 堆缓冲区溢出

**漏洞编号:** CVE-2021-3156

**漏洞类型:** 堆缓冲区溢出

**影响应用:** Sudo

**危害等级:** 高危，可导致本地提权至root

**影响版本:** Sudo 1.8.31p2之前版本到1.9.5p2之前版本

**利用条件:** 本地用户可执行sudo命令

**POC 可用性:** 是

**投毒风险:** 1%

## 详情

CVE-2021-3156 (Baron Samedit) 是 Sudo 1.9.5p2 之前版本中存在的一个堆缓冲区溢出漏洞。此漏洞允许本地用户通过 `sudoedit -s` 命令以及以单个反斜杠字符结尾的命令行参数，将权限提升为 root。

**有效性：**
提供的PoC代码利用了 CVE-2021-3156 漏洞。`exploit_launcher.c` 构造特定的命令行参数和环境变量，触发 sudoedit 的参数解析过程中的 off-by-one 错误，导致堆缓冲区溢出。溢出数据覆盖关键数据结构，最终执行 `exploit_payload.c` 中的代码，该代码通过 `setuid(0)` 等函数将当前进程的 uid 设置为 0，从而获得 root 权限。`Makefile` 用于编译和构建 exploit。 根据搜索结果和漏洞描述，此漏洞利用方式是有效的。

**投毒风险：**
PoC代码中存在的投毒风险较低，大约为1%。`exploit_payload.c` 仅仅调用了`setuid(0)`等函数修改用户ID以及执行了 `/bin/sh`。攻击者可能进行代码投毒的地方有:

1.  **环境变量操纵:**  理论上，可以尝试通过修改环境变量来影响 `/bin/sh` 的行为，但这属于利用漏洞后的行为，而非在利用代码中进行投毒。
2.  **Payload替换:** 恶意攻击者可以修改`exploit_payload.c`中的payload,植入恶意代码。

考虑到原始PoC的目的是为了演示漏洞，而不是进行实际的攻击，因此投毒的可能性相对较低。但用户仍需谨慎使用未经验证的PoC。

**利用方式：**
1.  **漏洞触发：**  利用 `sudoedit -s` 命令，并构造特定的、以反斜杠结尾的命令行参数，触发 off-by-one 错误。
2.  **缓冲区溢出：**  通过构造大量的 'A' 和 'B' 字符，造成堆缓冲区溢出。
3.  **Payload执行：**  覆盖关键数据结构，劫持控制流，执行预先编译好的 payload (`exploit_payload.c`)。
4.  **权限提升：**  Payload 代码将当前进程的 uid 设置为 0，获得 root 权限，并执行 `/bin/sh`，获得 root shell。

**项目地址:** [shishirpandey18/CVE-2021-3156](https://github.com/shishirpandey18/CVE-2021-3156)

**漏洞详情:** [CVE-2021-3156](https://nvd.nist.gov/vuln/detail/CVE-2021-3156)