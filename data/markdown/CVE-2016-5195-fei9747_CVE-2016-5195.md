## CVE-2016-5195 - Dirty COW 本地提权

**漏洞编号:** CVE-2016-5195

**漏洞类型:** 本地权限提升

**影响应用:** Linux Kernel

**危害等级:** 高危，可导致普通用户获得root权限

**影响版本:** Linux kernel 2.x ~ 4.x (before 4.8.3)

**利用条件:** 本地用户，目标系统内核版本在受影响范围内

**POC 可用性:** 是

**投毒风险:** 1%

## 详情

CVE-2016-5195，也被称为“Dirty COW”，是一个Linux内核中的竞争条件漏洞。该漏洞存在于内存管理子系统(mm/gup.c)处理写时复制(COW)时的方式中，允许恶意本地用户利用不正确的COW处理来写入只读存储器映射，从而获得提升的权限。

**有效性分析：**

根据漏洞信息和搜索结果，该漏洞是一个已知的、被广泛利用的本地权限提升漏洞。网络上存在大量PoC代码，证明了该漏洞的可利用性。

提供的POC代码通过以下步骤利用该漏洞：

1.  备份`/etc/passwd`文件到`/tmp/passwd.bak`。
2.  提示用户输入新的密码。
3.  使用`crypt()`函数生成密码哈希值。
4.  构造一个新的`/etc/passwd`条目，替换root用户的信息（默认创建`firefart`用户）。
5.  使用`mmap()`将`/etc/passwd`文件映射到内存中。
6.  创建一个线程，使用`madvise()`函数触发写时复制(COW)。
7.  使用`ptrace_pokedata`，利用竞争条件，将新的`/etc/passwd`条目覆盖到内存映射中。
8.  由于`/etc/passwd`被映射到内存，因此对内存的修改会直接反映到磁盘上的文件中。

**投毒风险分析：**

通过分析提供的POC代码，可以发现以下潜在的风险点：

1.  **硬编码的用户名：** 代码中默认创建的用户名为 `firefart`，虽然可以修改，但如果用户直接使用未修改的代码，可能会暴露攻击意图。
2.  **覆盖root账户：**  该脚本会直接覆盖`/etc/passwd`文件中的root账户，如果利用失败，可能会导致系统无法正常启动。
3.  **备份恢复：**  代码建议在利用后恢复`/etc/passwd`，如果用户忘记恢复，可能会导致安全风险。
4.  **Salt值:** 代码中Salt值写死为firefart.

**投毒代码分析：**

总体而言，该POC代码的主要目的是利用Dirty COW漏洞进行权限提升，而不是进行恶意投毒。尽管存在上述风险点，但这些更多是由于不当使用或配置造成的，而非作者故意植入的恶意代码。

但是，仍然存在极小的投毒风险，作者可能在以下方面进行隐藏：
* 在madvise线程中加入恶意代码，触发未知行为.
* 修改默认用户名,使其他用户难以发现。

综合评估，投毒风险较低，约为1%。

**利用方式总结：**

1.  **本地权限提升：** 该漏洞允许低权限的本地用户通过利用写时复制机制中的竞争条件，修改只读文件，进而获得root权限。
2.  **修改`/etc/passwd`文件：** 常见的利用方式是通过修改`/etc/passwd`文件，添加或修改用户账户的信息，例如添加一个新的具有root权限的用户。
3.  **需要编译：**该POC代码需要使用gcc编译后才能执行。
4.  **需要root权限编译:** 编译和运行都需要在存在漏洞的机器上进行。
5.  **需要修复:** 成功利用后必须手动还原`/etc/passwd`文件。

**项目地址:** [fei9747/CVE-2016-5195](https://github.com/fei9747/CVE-2016-5195)

**漏洞详情:** [CVE-2016-5195](https://nvd.nist.gov/vuln/detail/CVE-2016-5195)