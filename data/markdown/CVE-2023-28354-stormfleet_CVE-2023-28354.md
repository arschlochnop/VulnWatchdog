## CVE-2023-28354-Opsview Monitor Agent-命令注入

**漏洞编号:** CVE-2023-28354

**漏洞类型:** 命令注入

**影响应用:** Opsview Monitor Agent

**危害等级:** 高危，允许未授权的远程攻击者以NT_AUTHORITY\SYSTEM权限执行任意命令

**影响版本:** 6.8

**利用条件:** 需要能够通过网络访问目标系统的NRPE端口，目标系统需安装Opsview Monitor Agent 6.8并使用默认配置，即允许参数和特殊字符。

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2023-28354 存在于 Opsview Monitor Agent 6.8 中。未经过身份验证的远程攻击者可以调用受影响目标上的 check_nrpe，并指定已知的 NRPE 插件。默认安装配置为接受命令控制字符，并将其传递给命令行解释器以执行 NRPE 插件。这允许攻击者绕过 NRPE 插件执行，并在目标上以 NT_AUTHORITY\SYSTEM 身份远程执行命令。

**漏洞利用方式：**

1.  攻击者通过网络访问目标系统的 NRPE 端口（通常是 5666 端口）。
2.  攻击者使用 check_nrpe 工具，指定一个已知的 NRPE 插件，例如 `check_mountpoint`，`check_services` 等。
3.  攻击者在传递给 NRPE 插件的参数中，插入命令注入的 payload。由于 `allow_arguments=1` 和 `allow_nasty_meta_chars=1`，NRPE 将接受这些参数。
4.  NRPE 插件在执行时，会将参数传递给 PowerShell，攻击者可以通过 PowerShell 的命令注入特性执行任意系统命令，如'&& calc.exe'。例如，使用 `check_mountpoint` 插件并传递 `ARG1` 为 `'C:\'&& calc.exe'` 将执行计算器程序。
5.  由于 Opsview Agent 服务以 Local System 权限运行，攻击者执行的命令也具有 Local System 权限，因此可以完全控制目标系统。

**投毒风险分析：**

查看了提供的POC的`README.md`文件，该文件主要描述了漏洞的原理和利用方法。没有发现作者隐藏恶意代码或者后门的迹象。仓库仅包含漏洞说明和利用示例，本身不具备可执行性，因此投毒风险较低。


**项目地址:** [stormfleet/CVE-2023-28354](https://github.com/stormfleet/CVE-2023-28354)

**漏洞详情:** [CVE-2023-28354](https://nvd.nist.gov/vuln/detail/CVE-2023-28354)