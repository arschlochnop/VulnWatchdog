## CVE-2021-31956 Windows NTFS 权限提升漏洞

**漏洞编号:** CVE-2021-31956

**漏洞类型:** 权限提升

**影响应用:** Windows NTFS

**危害等级:** 高危，允许低权限用户提升到 SYSTEM 权限

**影响版本:** 受影响的Windows版本：Windows 10 Version 1809, Windows Server 2019, Windows 10 Version 1909, Windows 10 Version 21H1, Windows 10 Version 2004, Windows Server version 2004, Windows 10 Version 20H2, Windows Server version 20H2, Windows 10 Version 1507, Windows 10 Version 1607, Windows Server 2016, Windows 7, Windows 8.1, Windows Server 2008, Windows Server 2012等。

**利用条件:** 本地访问

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2021-31956 是一个 Windows NTFS 文件系统中的权限提升漏洞。该漏洞允许经过身份验证的攻击者在本地系统上提升权限。漏洞原理是NTFS处理特定操作时存在缺陷，导致内核内存损坏。从搜索引擎结果来看，该漏洞已经被积极利用，并且有相关的分析文章和利用示例。NCC Group的两篇文章深入分析了该漏洞的利用方式，包括如何实现较高的利用成功率以及所需的清理操作。

漏洞利用代码分析：
提供的C++代码尝试利用此漏洞进行权限提升。代码首先创建一个临时文件，然后使用 NtSetEaFile 设置扩展属性（EA）。利用点在于通过精心构造的 EA 信息，覆盖 WNF (Windows Notification Facility) 状态数据结构。代码通过 `EA_append` 函数构造特殊的EA块，其中包括覆盖WNF数据所需的 PoolHeader 和 WNF_STATE_DATA，从而实现内核内存的破坏。

有效性评估：
根据搜索结果和漏洞利用代码分析，可以判断此漏洞利用方式是有效的。搜索引擎结果中提到了有exp（利用），博客文章也详细描述了漏洞的利用过程，提供的POC代码也实现了构造和触发漏洞的逻辑。

投毒风险评估：
从提供的C++代码来看，主要目的是利用NTFS漏洞进行权限提升，没有发现明显的投毒代码。代码主要包括创建文件、设置EA属性、覆盖内核内存等操作。虽然代码存在潜在的风险，如可能导致系统崩溃，但没有证据表明作者故意插入恶意代码以进行进一步的攻击或者控制受害者系统。因此，投毒风险评估为0%。

利用方式总结：
1.  创建一个临时文件。
2.  构造包含恶意数据的扩展属性 (EA) 块，覆盖 WNF 状态数据结构。
3.  使用 NtCreateFile 创建文件。
4.  使用 NtSetEaFile 将构造的 EA 块写入文件，触发漏洞并覆盖内核内存。
5.  利用覆盖后的 WNF 状态数据，最终提升权限。


**项目地址:** [hzshang/CVE-2021-31956](https://github.com/hzshang/CVE-2021-31956)

**漏洞详情:** [CVE-2021-31956](https://nvd.nist.gov/vuln/detail/CVE-2021-31956)