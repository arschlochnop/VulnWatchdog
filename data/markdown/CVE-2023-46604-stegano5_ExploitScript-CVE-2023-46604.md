## CVE-2023-46604-Apache ActiveMQ-远程代码执行

**漏洞编号:** CVE-2023-46604

**漏洞类型:** 远程代码执行

**影响应用:** Apache ActiveMQ

**危害等级:** 高危，可导致服务器被完全控制

**影响版本:** < 5.15.16, < 5.16.7, < 5.17.6, < 5.18.3

**利用条件:** 需要网络访问ActiveMQ broker，目标存在于受影响版本中

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2023-46604是Apache ActiveMQ中的一个远程代码执行漏洞。攻击者可以通过操纵OpenWire协议中的序列化类类型，使客户端或broker实例化classpath上的任何类，从而执行任意shell命令。\n\n**有效性：**\n根据漏洞信息和搜索结果，该漏洞已被广泛利用。提供的POC代码通过构造恶意的OpenWire消息，利用`ClassPathXmlApplicationContext`加载远程XML配置文件，实现远程代码执行，因此POC代码有效。\n\n**投毒风险：**\n代码仓库中存在投毒的风险较低。主要风险点在于`config.xml`文件中反连shell的IP和端口，如果用户不修改这个IP，可能会将权限暴露给POC作者。`shell.py`脚本相对简单，功能明确，没有发现明显的恶意代码。所以判断存在轻微的投毒风险。\n\n**利用方式：**\n1.  攻击者需要找到存在CVE-2023-46604漏洞的Apache ActiveMQ broker实例。\n2.  攻击者需要一个可以被目标broker访问的HTTP服务器，用于托管恶意的`config.xml`文件。`config.xml`文件包含Spring Bean配置，该配置使用`ProcessBuilder`来执行shell命令。在这个POC里，是反弹shell。
3.  攻击者使用POC脚本`shell.py`，指定目标broker的IP地址、端口和`config.xml`文件的URL。
4.  `shell.py`脚本构造一个恶意的OpenWire消息，该消息指示broker加载`ClassPathXmlApplicationContext`并从指定的URL加载`config.xml`文件。
5.  当broker处理这个消息时，它会加载`config.xml`，`ProcessBuilder` bean会被实例化，执行指定的shell命令，从而实现远程代码执行。

**项目地址:** [stegano5/ExploitScript-CVE-2023-46604](https://github.com/stegano5/ExploitScript-CVE-2023-46604)

**漏洞详情:** [CVE-2023-46604](https://nvd.nist.gov/vuln/detail/CVE-2023-46604)