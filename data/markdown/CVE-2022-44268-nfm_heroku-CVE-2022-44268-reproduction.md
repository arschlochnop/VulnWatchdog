## CVE-2022-44268-ImageMagick-任意文件读取

**漏洞编号:** CVE-2022-44268

**漏洞类型:** 任意文件读取

**影响应用:** ImageMagick

**危害等级:** 高危，可能导致敏感信息泄露

**影响版本:** 7.1.0-49

**利用条件:** 需要ImageMagick处理PNG图片的权限，且Magick二进制文件需要有读取目标文件的权限

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

该漏洞存在于ImageMagick 7.1.0-49版本中。当ImageMagick解析PNG图片（例如，用于调整大小）时，攻击者可以通过构造恶意的PNG文件，将任意文件的内容嵌入到结果图片中。攻击者可以使用`pngcrush -text a "profile" "/etc/hosts" any-png-you-have.png`命令构造恶意PNG文件，其中`/etc/hosts`为要读取的目标文件。上传该恶意PNG文件后，下载处理后的图片，然后使用`exiftool`提取Raw Profile Type数据，最后可以使用CyberChef的From Hex功能将提取的数据转换为可读的文本，从而实现任意文件读取。

**利用方式：**

1.  使用`pngcrush`（或其他PNG编辑工具）创建一个包含恶意文本块的PNG文件，该文本块包含要读取的文件的路径（例如，`/etc/passwd`或`/app/super-secret`）。文本块类型应为`profile`。
2.  将此PNG文件上传到易受攻击的ImageMagick实例。
3.  ImageMagick将尝试处理此图像，并将指定文件的内容嵌入到输出图像的元数据中。
4.  下载处理后的图像。
5.  使用`exiftool`或其他元数据提取工具从图像中提取嵌入的文件内容。如果输出过大，可以使用`exiftool -b`来获取原始数据。
6.  使用CyberChef（From Hex with Delimiter: auto）或类似的工具将提取的十六进制数据解码为原始文件内容。

**有效性：**

根据漏洞库信息、搜索结果以及提供的POC代码，该漏洞利用是有效的。POC代码提供了一个简单的Web界面，允许用户上传PNG文件，然后使用ImageMagick进行处理。处理后的图片会作为附件下载，用户可以使用`exiftool`提取文件内容。

**投毒风险：**

在提供的代码中，并没有发现明显的恶意代码或后门。所有代码都是为了演示该漏洞的利用过程，没有发现任何试图损害服务器或窃取用户信息的行为。因此，评估的投毒风险为0%。代码的功能仅限于接收上传的PNG文件，调用ImageMagick处理，然后返回处理后的图片。

**排序优先级依据：**

搜索引擎结果、漏洞利用代码、漏洞库信息。

**项目地址:** [nfm/heroku-CVE-2022-44268-reproduction](https://github.com/nfm/heroku-CVE-2022-44268-reproduction)

**漏洞详情:** [CVE-2022-44268](https://nvd.nist.gov/vuln/detail/CVE-2022-44268)