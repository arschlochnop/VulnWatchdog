## CVE-2022-22965 Spring4Shell RCE

**漏洞编号:** CVE-2022-22965

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Spring Framework

**危害等级:** 高危，可能导致服务器完全控制

**影响版本:** Spring Framework versions 5.3.X prior to 5.3.18+, 5.2.x prior to 5.2.20+ and all old and unsupported versions

**利用条件:** JDK 9+, Tomcat WAR deployment, Spring MVC or Spring WebFlux application

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2022-22965（Spring4Shell）是一个远程代码执行漏洞，存在于Spring Framework中。根据漏洞信息，该漏洞只在特定条件下可被利用，即：

*   运行在JDK 9+之上。
*   以WAR包形式部署在Tomcat上。
*   使用了Spring MVC或Spring WebFlux。

**POC有效性评估：**

提供的`test.py`脚本尝试利用此漏洞。它通过修改`class.module.classLoader.resources.context.parent.pipeline.first`属性来写入恶意JSP文件到Tomcat的webapps/ROOT目录下，从而实现RCE。脚本尝试设置`pattern`属性（用于定义JSP文件的内容，包含后门代码），`suffix`属性（设置为.jsp），`directory`属性（设置为webapps/ROOT），`prefix`属性（设置为tomcatwar），以及`fileDateFormat`属性。

根据搜索引擎结果，此漏洞在野外已被积极利用，并且存在公开的POC。`test.py`脚本中的payload结构与公开的Spring4Shell利用方式相符，所以该POC代码有效。

**投毒风险评估：**

该仓库包含三个文件：`README.md`，`fw_handler.py` 和 `test.py`。

*   `README.md` 描述了对漏洞的分析和防御措施，无投毒风险。
*   `fw_handler.py` 实现了简单的防火墙，用于阻止包含特定payload的请求，用于防御攻击，无投毒风险。
*   `test.py` 包含漏洞利用代码，旨在验证漏洞是否存在。它通过发送包含特定payload的POST请求，尝试在目标服务器上写入恶意的JSP文件。该文件的目的是创建一个后门，允许通过`pwd`和`cmd`参数执行任意命令。此部分**并非**投毒代码，而是漏洞验证和利用的一部分。

虽然整个仓库的主题是关于漏洞分析和防御，但 `test.py` 中的利用代码如果被恶意使用，可能会导致安全风险。但就仓库本身而言，作者直接植入恶意代码的可能性较低，`fw_handler.py`反而是防御手段, 漏洞利用代码本身是利用漏洞的手段，不应被视为投毒。投毒风险较低，估计为10%。这个10%主要考虑的是仓库的维护者可能被黑客入侵，然后植入恶意代码。

**利用方式总结：**

1.  攻击者发送特制的HTTP请求，其中包含用于修改`class.module.classLoader.resources.context.parent.pipeline.first`属性的payload。
2.  这些属性的修改允许攻击者在Tomcat的webapps/ROOT目录下写入任意JSP文件。
3.  写入的JSP文件包含恶意代码（例如一个Webshell）。
4.  攻击者可以通过访问该JSP文件来执行任意命令，从而控制服务器。

**项目地址:** [jashan-lefty/Spring4Shell](https://github.com/jashan-lefty/Spring4Shell)

**漏洞详情:** [CVE-2022-22965](https://nvd.nist.gov/vuln/detail/CVE-2022-22965)