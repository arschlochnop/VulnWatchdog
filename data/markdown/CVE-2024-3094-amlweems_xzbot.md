## CVE-2024-3094 - XZ Utils供应链后门

**漏洞编号:** CVE-2024-3094

**漏洞类型:** 供应链攻击/后门

**影响应用:** XZ Utils

**危害等级:** 极危，允许未经授权的远程SSH访问和代码执行

**影响版本:** 5.6.0, 5.6.1

**利用条件:** 系统使用了受感染的XZ Utils版本，并且sshd链接了liblzma

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-3094 涉及在 XZ Utils 5.6.0 和 5.6.1 版本中发现的恶意代码。这个后门允许攻击者绕过 SSH 身份验证并执行远程代码。 

**有效性:**
提供的POC代码显示了利用此漏洞的有效方法。它包括：
*   一个蜜罐，用于检测利用尝试。
*   一个用于将 liblzma.so 补丁到使用攻击者自己的 ED448 公钥的代码。这允许攻击者触发后门。
*   后门payload格式的描述，包括加密和签名方案。
*   一个命令行工具 (xzbot) 用于触发远程代码执行。

根据POC代码和搜索结果，该漏洞可以被成功利用。

**投毒风险:**
此仓库中存在投毒代码的风险较低，但仍不能完全排除。理由如下：
*   **公开透明:** 该仓库旨在探索已知的漏洞，并提供利用和检测的方法。代码的目的是为了复现漏洞。
*   **定制化利用:** 提供的 `patch.py` 脚本用于修改 `liblzma.so` 文件。如果脚本被恶意修改，可能会引入其他漏洞或恶意行为。然而，这种风险取决于用户是否仔细检查脚本的内容。
*   **依赖外部资源:** 该代码依赖于从其他地方下载受感染的 `liblzma.so` 文件。如果下载源被篡改，可能会导致执行恶意代码。
*   **密钥的安全性:** 仓库中硬编码了攻击者的密钥。如果攻击者更换密钥或者使用其他方式，则当前代码无法有效利用。

虽然该仓库的主要目标是研究和演示已知的漏洞，但用户仍需谨慎，并仔细检查所有代码和依赖项，以避免潜在的风险。

**利用方式:**
1.  **准备环境:** 准备一台运行易受攻击的 XZ Utils 版本的 Linux 系统，并且sshd 链接了 liblzma。
2.  **获取payload:** 获取一个 backdoored 的 `liblzma.so` 共享对象（例如，从 https://snapshot.debian.org/package/xz-utils/5.6.1-1）。
3.  **替换公钥（可选但推荐）:** 使用 `patch.py` 脚本将 liblzma.so 中的攻击者的 ED448 公钥替换为您自己的公钥，这样您可以控制后门。
4.  **运行 SSH 服务器:** 使用修改后的 `liblzma.so` 运行 SSH 服务器。
5.  **生成Payload:** 使用 `xzbot` 工具生成包含恶意命令的payload。
6.  **触发后门:** 使用 SSH 客户端连接到目标服务器。`xzbot` 工具会自动构造包含恶意 payload 的 SSH 证书。
7.  **远程代码执行:** 后门将提取 payload、解密并验证签名，然后使用 `system()` 函数执行恶意命令。

**项目地址:** [amlweems/xzbot](https://github.com/amlweems/xzbot)

**漏洞详情:** [CVE-2024-3094](https://nvd.nist.gov/vuln/detail/CVE-2024-3094)