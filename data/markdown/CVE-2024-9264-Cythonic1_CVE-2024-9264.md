## CVE-2024-9264-Grafana-命令注入和文件包含

**漏洞编号:** CVE-2024-9264

**漏洞类型:** 命令注入和文件包含

**影响应用:** Grafana

**危害等级:** 高危，可能导致远程代码执行和敏感信息泄露

**影响版本:** 11.0.x, 11.1.x, 11.2.x (小于 11.0.5, 11.1.6, 11.2.1, 11.0.6, 11.1.7, 11.2.2)

**利用条件:** 需要Grafana实例启用SQL Expressions实验性功能，且duckdb二进制文件存在于Grafana的$PATH中。需要具有Viewer或更高权限的用户。

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2024-9264 存在于 Grafana 的 SQL Expressions 实验性功能中。该功能允许执行包含用户输入的 duckdb 查询。由于输入未经过充分的过滤，导致可以进行命令注入和本地文件包含。攻击者需要拥有 Viewer 或更高权限才能利用此漏洞。

**有效性分析：**
根据漏洞库信息和搜索引擎结果，此漏洞被认为是高危的，并且已经存在公开的PoC代码。PoC代码验证了可以通过构造恶意的SQL表达式来读取任意文件。

**投毒风险分析：**
提供的 PoC 代码的主要功能是模拟登录 Grafana，然后构造包含恶意文件路径的 SQL 表达式，发送给 Grafana 服务器，以此来读取服务器上的文件。没有发现明显的投毒代码，例如反弹shell，添加用户等恶意操作。因此，投毒风险较低。

**利用方式：**
1.  **登录:** 使用有效的 Grafana 用户凭据（Viewer 或更高权限）进行身份验证。
2.  **构造Payload:** 构造包含恶意`duckdb` SQL查询的JSON Payload。该查询使用`read_csv_auto`函数读取目标文件，例如`/etc/passwd`。
3.  **发送请求:**  将构造的 Payload 发送到 `/api/ds/query` 端点，并指定 `ds_type=__expr__`。
4.  **执行和信息泄露:** Grafana 执行恶意 `duckdb` 查询，导致读取指定文件内容，攻击者从响应中获取敏感信息。

**项目地址:** [Cythonic1/CVE-2024-9264](https://github.com/Cythonic1/CVE-2024-9264)

**漏洞详情:** [CVE-2024-9264](https://nvd.nist.gov/vuln/detail/CVE-2024-9264)