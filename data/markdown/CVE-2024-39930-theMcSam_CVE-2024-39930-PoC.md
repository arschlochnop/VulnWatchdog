## CVE-2024-39930-Gogs-远程代码执行

**漏洞编号:** CVE-2024-39930

**漏洞类型:** 远程代码执行

**影响应用:** Gogs

**危害等级:** 高危，可能导致服务器完全控制

**影响版本:** <= 0.13.0

**利用条件:** 需要Gogs内置SSH服务已启用，并拥有一个有效的用户账户

**POC 可用性:** 是

**投毒风险:** 1%

## 详情

CVE-2024-39930是Gogs 0.13.0及更早版本中内置SSH服务器存在的一个参数注入漏洞。攻击者可以通过建立SSH连接，并发送恶意的`--split-string`环境变量请求，从而执行任意代码。该漏洞影响Linux环境下的Gogs实例，Windows实例不受影响。

**漏洞利用方式：**

1.  **获取API Token：** 首先，利用Gogs API，通过用户名和密码获取API Token。这是后续操作的身份验证凭据。
2.  **创建仓库（可选）：** 创建一个新的Git仓库，虽然从原理上来说不是必须，但是poc中做了此操作,可能是为了更方便的触发git相关功能。
3.  **删除现有SSH Key：** 删除用户已有的SSH Key，保证攻击者可以上传自己控制的Key。
4.  **添加SSH Key：** 上传攻击者自己的SSH Key，为后续的SSH连接做准备。
5.  **SSH 连接并执行命令：** 使用Paramiko库建立SSH连接，关键在于设置环境变量`--split-string`，该变量的值会被注入到`git-upload-pack`命令中，导致命令执行。实际执行的命令是`git-upload-pack <repo_path>`，而`--split-string`的值会作为额外的参数传递给这个命令。

**投毒风险分析：**

该POC代码主要分为两个部分：一部分是利用Gogs API进行用户认证、创建仓库、管理SSH Key等操作；另一部分是建立SSH连接，并利用`--split-string`参数注入执行命令。

API调用部分的代码相对安全，风险较低。主要的潜在投毒点在于以下几个方面：

*   **命令执行字符串：** 攻击者可能会在提供的command参数中嵌入恶意代码，但这是用户可控的，不属于POC本身投毒。
*   **SSH密钥生成或处理：** 如果POC包含SSH密钥生成功能，可能会生成弱密钥或者后门密钥。但当前代码直接使用用户提供的密钥文件，因此不存在此风险。
*   **其他隐藏的恶意代码：** 理论上，作者可以在代码中添加其他隐藏的恶意行为，例如收集用户信息、植入持久化后门等。但是，该POC代码逻辑相对简单，没有发现明显的恶意代码。

基于以上分析，此POC的投毒风险较低，大约为1%。风险主要集中在用户提供的执行命令字符串本身是否存在恶意行为，而非POC代码本身。

**项目地址:** [theMcSam/CVE-2024-39930-PoC](https://github.com/theMcSam/CVE-2024-39930-PoC)

**漏洞详情:** [CVE-2024-39930](https://nvd.nist.gov/vuln/detail/CVE-2024-39930)