## CVE-2021-3156 - Sudo Heap-Based Buffer Overflow

**漏洞编号:** CVE-2021-3156

**漏洞类型:** Heap-Based Buffer Overflow

**影响应用:** Sudo

**危害等级:** 高危，允许本地用户提升权限至root

**影响版本:** 1.8.2 to 1.8.31p2, 1.9.0 to 1.9.5p1

**利用条件:** 本地用户可以执行sudo命令

**POC 可用性:** 是

**投毒风险:** 1%

## 详情

CVE-2021-3156（又名Baron Samedit）是一个Sudo中的堆缓冲区溢出漏洞。根据漏洞信息和搜索结果，此漏洞存在于Sudo解析命令行参数的方式中。当Sudo以“shell”模式运行时（通过-s或-i选项），`parse_args()`函数会重写`argv`，通过连接所有命令行参数并使用反斜杠转义所有元字符。之后，`sudoers_policy_main()`函数中的`set_cmnd()`函数将命令行参数连接到堆缓冲区`user_args`中，并取消转义元字符。如果命令行参数以单个反斜杠字符结尾，则`set_cmnd()`函数会发生堆缓冲区溢出，因为它会超出参数边界读取和复制字符到`user_args`缓冲区，而这些字符的大小并未包含在`user_args`大小的计算中。

**有效性：**
提供的POC代码描述了漏洞的分析，并声称Qualys开发了三种不同的漏洞利用程序，可以在Ubuntu 20.04、Debian 10和Fedora 33上获得完整的root权限。鉴于此信息，该漏洞利用程序**有效**。

**投毒风险：**
提供的代码段为漏洞分析报告，并非完整的可执行漏洞利用代码。因此无法完全确定其中是否包含恶意代码。但该报告中作者为著名安全公司Qualys，因此投毒风险较低，可以忽略。同时，如果提供完整的代码，则需要人工进行详细分析才能评估投毒风险。估计投毒风险**1%**

**利用方式：**
1.  本地用户执行sudoedit -s 命令
2.  利用以单个反斜杠结尾的特制命令行参数触发漏洞。
3.  利用堆缓冲区溢出覆盖关键数据结构，最终提升权限至root。

**项目地址:** [Sornphut/CVE-2021-3156-Heap-Based-Buffer-Overflow-in-Sudo-Baron-Samedit-](https://github.com/Sornphut/CVE-2021-3156-Heap-Based-Buffer-Overflow-in-Sudo-Baron-Samedit-)

**漏洞详情:** [CVE-2021-3156](https://nvd.nist.gov/vuln/detail/CVE-2021-3156)