## CVE-2021-38163 - SAP NetWeaver Visual Composer Unrestricted File Upload

**漏洞编号:** CVE-2021-38163

**漏洞类型:** Unrestricted File Upload

**影响应用:** SAP NetWeaver Visual Composer 7.0 RT

**危害等级:** 高危，可导致远程代码执行、信息泄露、服务中断

**影响版本:** 7.30, 7.31, 7.40, 7.50

**利用条件:** 需要具备非管理员用户权限，目标系统存在漏洞组件，能够通过网络访问目标系统50000端口。

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2021-38163 存在于 SAP NetWeaver Visual Composer 7.0 RT 的多个版本中。该漏洞允许经过身份验证的非管理用户通过网络上传恶意文件，并触发其处理。由于没有文件类型限制，攻击者可以上传包含恶意代码的文件（例如JSP），并利用其在服务器上执行任意操作系统命令，权限与Java Server进程相同。攻击者可以读取或修改服务器上的任何信息，或者关闭服务器，导致服务不可用。

**利用方式：**

1.  **身份验证：** 首先，攻击者需要使用合法的非管理员用户凭据登录到 SAP NetWeaver 系统。
2.  **文件上传：**  利用漏洞，攻击者可以通过构造特定的 URL 上传恶意文件。根据POC代码，恶意文件上传的URL为`{target_url}:50000/irj/servlet/prt/portal/prtroot/com.sap.visualcomposer.VCParMigrator?parName=../../../../../../../../../../../../../../../../../../usr/sap/{sid}/{res}/j2ee/cluster/apps/sap.com/rtmfcommunicator/servlet_jsp/rtmfCommunicator/root/html/urgent.jsp`
    *   `target_url`：目标 SAP NetWeaver 服务器的 URL。
    *   `sid`：SAP 系统 ID。
    *   `res`：SAP Instance。
3.  **命令执行：** 上传的文件（urgent.jsp）包含JSP代码，可以执行通过`cve`参数传递的操作系统命令。使用 URL `{target_url}:50000/rtmfCommunicator/html/urgent.jsp?cve={command}`触发恶意文件。`command`是想要执行的操作系统命令。

**投毒风险分析：**

代码中包含一些Nmap扫描功能，用于发现SID和Instance，但这些功能本身不是投毒行为。`urgent.jsp`文件，这段代码是漏洞利用的核心，用于远程命令执行。该文件会被上传到目标服务器，并允许攻击者执行任意命令。虽然这段代码本身是恶意的，但它是漏洞利用的必要组成部分，不能简单地视为“投毒”。代码中存在代理设置`proxies = dict(http="http://127.0.0.1:8080")`，如果攻击者使用代理进行攻击，可能会将流量劫持到攻击者的服务器上。综合考虑，投毒风险较低，约为5%。主要是可能利用代理进行中间人攻击。

**有效性分析：**

该POC代码利用了未经授权的文件上传漏洞，并且通过上传JSP文件的方式实现了远程代码执行。此代码搜索结果表明，该漏洞已经被积极利用，并被CISA添加到已知被利用的漏洞目录中。该漏洞具有较高可能性被利用。

**项目地址:** [purpleteam-ru/CVE-2021-38163](https://github.com/purpleteam-ru/CVE-2021-38163)

**漏洞详情:** [CVE-2021-38163](https://nvd.nist.gov/vuln/detail/CVE-2021-38163)