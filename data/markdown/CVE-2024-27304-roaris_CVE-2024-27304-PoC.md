## CVE-2024-27304-pgx-SQL注入

**漏洞编号:** CVE-2024-27304

**漏洞类型:** SQL注入

**影响应用:** pgx

**危害等级:** 高危，可能导致数据泄露和远程代码执行

**影响版本:** < 4.18.2, >= 5.0.0, < 5.5.4

**利用条件:** 需要网络访问和PostgreSQL数据库端口开放

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-27304是pgx PostgreSQL驱动程序中的一个SQL注入漏洞，由于协议消息大小溢出导致。攻击者可以通过发送大于4GB的恶意SQL查询或绑定消息来触发整数溢出，进而将一个大的消息分割成多个消息，从而控制后续消息的内容，最终执行SQL注入。

**有效性评估：**
根据漏洞库信息和提供的PoC代码，该漏洞确实存在于pgx的特定版本中（< 4.18.2 和 >= 5.0.0, < 5.5.4）。PoC代码提供了三种利用方式的脚本：
  *   `Q_simple.py`: 适用于攻击者完全了解执行的查询的情况。
  *   `Q_nop_sled.py`: 通过NOP sled更容易利用，可以在一定尝试次数内成功。
  *   `B_simple.py`: 针对Bind消息的溢出，但利用难度较高，需要对查询有较深的了解。

根据PoC代码中的描述，该漏洞利用需要大量内存，并且可能导致目标系统拒绝服务(DoS)，因此利用时需谨慎。

**投毒风险评估：**
该代码仓库主要包含漏洞利用脚本和演示漏洞的webapp。webapp目录下包含Dockerfile, compose.yml, go.mod, go.sum, init.sql和main.go等文件，用于构建一个包含漏洞的web应用环境。漏洞利用代码包含多个python脚本，分别用于利用不同场景下的该漏洞。
从代码本身来看，没有明显的恶意代码或后门。compose.yml文件中指定了PostgreSQL的版本为17.6，init.sql 用于初始化数据库，main.go是应用程序的主入口。

但是，考虑到漏洞利用本身就具有很强的攻击性，并且`README.md`中也明确指出不要对第三方系统执行此漏洞利用，因此可以认为存在一定程度的风险，即使作者没有主动投毒，不当使用PoC代码也可能造成损害。虽然没有发现明显的投毒代码，但使用前务必进行仔细审查。

综合评估，投毒风险较低，约为10%。主要的风险在于不当使用漏洞利用代码造成的损害。

**利用方式：**
1.  **整数溢出：** 攻击者构造一个长度接近或超过4GB的SQL查询或绑定消息。
2.  **消息分割：** 由于整数溢出，pgx将该消息错误地分割成多个较小的消息。
3.  **SQL注入：** 攻击者控制分割后的消息内容，插入恶意的SQL代码。
4.  **执行恶意SQL：** PostgreSQL服务器执行攻击者注入的SQL代码，导致SQL注入漏洞。

利用方式主要依赖于控制PostgreSQL客户端和服务器之间的通信协议，通过构造畸形数据包来触发漏洞。

**总结：**
该漏洞利用的有效性较高，但有潜在的DoS风险。投毒风险较低，但需要注意PoC代码本身可能造成的损害。利用方式是通过整数溢出控制协议消息，最终实现SQL注入。

**项目地址:** [roaris/CVE-2024-27304-PoC](https://github.com/roaris/CVE-2024-27304-PoC)

**漏洞详情:** [CVE-2024-27304](https://nvd.nist.gov/vuln/detail/CVE-2024-27304)