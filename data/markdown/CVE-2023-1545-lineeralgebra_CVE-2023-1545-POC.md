## CVE-2023-1545-Teampass-SQL注入

**漏洞编号:** CVE-2023-1545

**漏洞类型:** SQL注入

**影响应用:** Teampass

**危害等级:** 高危，可能导致数据泄露

**影响版本:** < 3.0.0.23

**利用条件:** 需要目标Teampass实例启用API，且网络可访问

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2023-1545是Teampass 3.0.0.23之前版本中存在的SQL注入漏洞。根据漏洞库信息、搜索引擎结果和提供的PoC代码分析，该漏洞的利用方式如下：

1.  **漏洞原理：**  该漏洞由于Teampass在处理用户登录认证时，对输入参数（login）未进行充分的过滤和转义，导致攻击者可以在login字段中注入恶意的SQL代码。
2.  **利用步骤：**
    *   首先，攻击者需要确定目标Teampass实例是否启用了API功能。PoC代码通过访问`/api/index.php/authorize`来检测API是否可用。
    *   然后，攻击者构造包含SQL注入语句的login参数。PoC代码中使用了`UNION SELECT`语句，将攻击者的SQL查询结果与原始查询结果合并，从而获取数据库中的敏感信息。特别构造了login为 `none' UNION SELECT ...` 这样的 Payload，绕过了原有的login验证。密码随意填写，apikey也随意。
    *   通过发送POST请求到`/api/index.php/authorize`端点，将包含恶意SQL代码的JSON数据发送给Teampass服务器。
    *   服务器执行SQL查询后，会将查询结果包含在返回的token中。攻击者可以从token中提取`public_key`字段，该字段包含了SQL查询的结果。
3.  **PoC代码分析：**
    *   PoC代码首先检查目标API是否启用。
    *   `exec_sql`函数封装了SQL注入的过程，接收SQL查询语句作为参数，构造包含注入语句的JSON数据，发送POST请求，并从返回的token中提取查询结果。
    *   PoC代码首先使用`SELECT COUNT(*) FROM teampass_users WHERE pw != ''`语句获取用户数量，然后循环遍历用户，使用`SELECT login FROM teampass_users WHERE pw != '' ORDER BY login ASC LIMIT {i},1`和`SELECT pw FROM teampass_users WHERE pw != '' ORDER BY login ASC LIMIT {i},1`语句分别获取用户名和密码。
4.  **有效性：**  根据提供的搜索引擎结果，存在公开的漏洞利用exp，并且漏洞影响版本小于3.0.0.23，利用代码完整，参数明确，因此判断POC代码有效。
5.  **投毒风险：**  该代码主要实现了SQL注入利用，没有发现明显的恶意投毒代码。比如下载其他文件、执行系统命令等。代码中存在的风险点在于，可能会被滥用进行未授权的数据库信息窃取。但是作为POC本身，不属于投毒行为。细微投毒可能在于，PoC中使用的`arbitrary_hash`可能会误导使用者，认为攻击者可以通过该hash直接登录，实际上需要替换成目标用户的密码hash。故投毒风险较低, 估算为 5%。

**项目地址:** [lineeralgebra/CVE-2023-1545-POC](https://github.com/lineeralgebra/CVE-2023-1545-POC)

**漏洞详情:** [CVE-2023-1545](https://nvd.nist.gov/vuln/detail/CVE-2023-1545)