## CVE-2023-38646-Metabase-RCE

**漏洞编号:** CVE-2023-38646

**漏洞类型:** 远程代码执行(RCE)

**影响应用:** Metabase

**危害等级:** 高危，未授权远程代码执行

**影响版本:** < 0.46.6.1 和 Enterprise < 1.46.6.1

**利用条件:** 目标Metabase实例可访问，且版本在受影响范围内

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2023-38646 允许未经身份验证的攻击者在Metabase服务器上执行任意命令。漏洞存在于Metabase的setup流程中。

**利用方式：**

1.  **获取Setup Token:** 第一个POC脚本（`CVE-2023-38646-POC.py`）用于获取Metabase实例的Setup Token。它尝试通过HTTP和HTTPS连接到目标IP地址，并请求`/api/session/properties`端点，解析返回的JSON数据，从中提取`setup-token`。
2.  **利用Setup Token执行命令：** 第二个POC脚本（`CVE-2023-38646-Reverse-Shell.py`）利用获取到的Setup Token，向`/api/setup/validate`端点发送POST请求，其中包含恶意的数据库连接配置。该配置使用H2数据库引擎，并在数据库连接字符串中注入恶意代码。具体来说，它创建了一个触发器`pwnshell`，该触发器在`INFORMATION_SCHEMA.TABLES`表上执行`SELECT`操作之前触发，从而执行Base64编码的payload，payload解码后执行反向shell命令。

**有效性：**

从提供的漏洞信息、搜索结果和POC代码来看，该漏洞利用是有效的。搜索结果中包含了多个关于此漏洞的描述、利用方法以及POC代码的链接。

**投毒风险：**

*   第一个脚本`CVE-2023-38646-POC.py`只是用来获取setup token，本身不包含任何恶意代码。
*   第二个脚本`CVE-2023-38646-Reverse-Shell.py`包含反向shell的payload，这部分是漏洞利用的必要组成，不能算作投毒代码。可能的投毒风险在于：
    *   **Payload植入其他恶意行为：** 虽然当前Payload是反向shell，但攻击者可能修改Payload，植入其他恶意行为，比如数据窃取、勒索软件等。
    *   **依赖项风险：** 脚本依赖requests库，如果requests库本身被投毒，可能引入安全风险。

综合来看，投毒风险较低，约为10%。这个10%主要来自脚本本身，比如反向shell 的IP地址、端口被替换成攻击者控制的肉鸡从而进行跳板攻击，以及安装恶意依赖项的可能。

总之，该漏洞的利用方式是利用未授权的setup接口，通过注入恶意的数据库连接配置来执行任意命令。

**项目地址:** [securezeron/CVE-2023-38646](https://github.com/securezeron/CVE-2023-38646)

**漏洞详情:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)