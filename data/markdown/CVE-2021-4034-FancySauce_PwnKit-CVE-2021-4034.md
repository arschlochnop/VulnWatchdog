## CVE-2021-4034 - polkit pkexec 本地提权漏洞

**漏洞编号:** CVE-2021-4034

**漏洞类型:** 本地提权

**影响应用:** polkit

**危害等级:** 高危，可使低权限用户获得 root 权限

**影响版本:** 所有版本 (漏洞修复前)

**利用条件:** 需要本地用户访问

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2021-4034 (PwnKit) 是 polkit 中 pkexec 工具的一个本地提权漏洞。pkexec 是一个 setuid 工具，允许非特权用户按照预定义的策略以特权用户身份运行命令。漏洞的根本原因是 pkexec 在处理参数计数时存在错误，导致其尝试将环境变量作为命令执行。攻击者可以通过构造特定的环境变量来利用此漏洞，诱使 pkexec 执行任意代码，从而获得 root 权限。

**漏洞利用分析:**

1.  **漏洞原理:**  pkexec 没有正确处理传递给它的参数数量。 当参数数量不足时，它会尝试将环境变量作为程序执行。
2.  **利用方式:** 提供的 POC 代码利用了 `GCONV_PATH` 环境变量。`GCONV_PATH` 用于指定 gconv 模块的搜索路径，gconv 模块用于字符集转换。攻击者创建一个目录，并在该目录下创建一个名为 `gconv-modules` 的文件，该文件定义了一个恶意的 gconv 模块。然后，设置 `GCONV_PATH` 环境变量指向该目录，并触发 pkexec。pkexec 会加载恶意的 gconv 模块，该模块在 `gconv_init` 函数中执行 `setuid(0)`、`setgid(0)`、`setgroups(0)` 和 `execve("/bin/sh", NULL, NULL)`，从而获得 root shell。
3.  **POC代码分析:**
    *   `Makefile`: 用于编译恶意的共享库 `evil.so` 和利用程序 `exploit`。
    *   `evil-so.c`: 包含恶意代码，该代码在加载时会设置 uid、gid 和 groups 为 0，并执行 `/bin/sh`，创建一个 root shell。
    *   `exploit.c`: 创建必要的目录和文件结构，设置环境变量，并执行 `pkexec`。

**有效性:**

根据漏洞描述、搜索引擎结果和提供的 POC 代码，可以判断该 POC 代码是有效的。 漏洞利用代码构造了特定的环境，利用 pkexec 的漏洞执行恶意代码，从而实现提权。

**投毒风险:**

代码中没有明显的投毒行为。`evil-so.c`的目的就是提权，这符合漏洞利用的需求。没有发现任何在提权之外执行其他恶意操作的代码。 风险评估为 0%。


**项目地址:** [FancySauce/PwnKit-CVE-2021-4034](https://github.com/FancySauce/PwnKit-CVE-2021-4034)

**漏洞详情:** [CVE-2021-4034](https://nvd.nist.gov/vuln/detail/CVE-2021-4034)