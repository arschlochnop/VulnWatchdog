## CVE-2021-1675 - Windows Print Spooler Remote Code Execution

**漏洞编号:** CVE-2021-1675

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Windows Print Spooler Service

**危害等级:** 高危，允许未经授权的用户获取SYSTEM权限并执行任意代码。

**影响版本:** 受影响的版本包括Windows 7, Windows 8.1, Windows 10, Windows Server 2008, Windows Server 2012, Windows Server 2016, Windows Server 2019, Windows Server 2004, Windows Server version 20H2等, 具体版本号参考漏洞库信息。

**利用条件:** 需要目标系统开启Print Spooler服务, 攻击者需要具有一定的网络访问能力和SMB共享权限。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-1675，又名PrintNightmare，是一个Windows Print Spooler服务中的远程代码执行漏洞。攻击者可以通过`RpcAddPrinterDriverEx`函数上传恶意的DLL文件到目标系统，并利用Print Spooler服务加载执行，从而获取SYSTEM权限。 

**有效性评估：**
根据搜索引擎结果，CVE-2021-1675漏洞的PoC代码是公开可用的，并且该漏洞已经被广泛利用。提供的Python脚本`CVE-2021-1675.py`利用了`RpcAddPrinterDriverEx`函数来添加恶意驱动，从而实现远程代码执行。因此，可以判定该PoC代码是有效的。

**投毒风险分析：**
分析提供的Python脚本，主要操作包括连接到目标系统的Print Spooler服务，构建`DRIVER_CONTAINER`结构，并调用`RpcAddPrinterDriverEx`函数。PoC中包含一个阶段性的提权过程,如果不是相关漏洞研究人员,可能会误判为恶意代码,添加了针对 winhttp.dll kernelbase.dll等程序的调用。 投毒风险主要体现在：

1.  **pDriverPath 参数：** 此参数指定了要上传的恶意DLL文件的路径。如果攻击者提供的共享路径本身包含恶意代码，则可能导致投毒。
2.  **pConfigFile 参数：** 此参数指定了配置文件路径，脚本尝试使用不同的DLL文件路径（包括系统目录下的DLL）来利用漏洞，恶意作者可以在这里精心构造恶意利用链，从而达到植入后门的目的。

整体而言，代码的结构和逻辑更偏向于漏洞利用，而非恶意投毒，但如果攻击者对PoC代码进行修改，例如修改`pConfigFile`的值指向包含恶意代码的DLL，或者在上传的DLL文件中包含恶意逻辑，则可能存在投毒风险。根据我对PoC代码的分析，认为存在一定风险，百分比大约为10%。

**漏洞利用方式：**

1.  **攻击者准备一个恶意的DLL文件。**
2.  **攻击者需要获得目标系统的网络访问权限，并且需要知道一个可访问的SMB共享路径。**
3.  **攻击者运行PoC脚本，指定目标系统的IP地址、用户名、密码（或NTLM hash）和恶意DLL文件的SMB共享路径。**
4.  **脚本会连接到目标系统的Print Spooler服务，并使用`RpcAddPrinterDriverEx`函数将恶意DLL文件上传到目标系统。**
5.  **Print Spooler服务会加载并执行恶意DLL文件，从而导致远程代码执行，攻击者获得SYSTEM权限。**

**注意事项：**
*   攻击者需要具有有效的Windows用户凭据才能利用此漏洞。
*   目标系统需要开启Print Spooler服务。
*   攻击者需要确保恶意DLL文件与目标系统的体系结构（x86或x64）匹配。
*   成功利用此漏洞可能导致目标系统完全受控，因此应该尽快安装补丁或采取其他缓解措施。

**项目地址:** [DLL00P/CVE-2021-1675](https://github.com/DLL00P/CVE-2021-1675)

**漏洞详情:** [CVE-2021-1675](https://nvd.nist.gov/vuln/detail/CVE-2021-1675)