## CVE-2020-11978-Apache Airflow-远程代码执行

**漏洞编号:** CVE-2020-11978

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Apache Airflow

**危害等级:** 高危，允许经过身份验证的用户以运行 Airflow worker/scheduler 的用户身份执行任意命令

**影响版本:** <= 1.10.10

**利用条件:** 需要启用了示例 DAG，且用户需要具有访问 Airflow 实验性 API 的权限（在存在 CVE-2020-13927的情况下可能无需身份验证）

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

该漏洞存在于 Apache Airflow 1.10.10 及以下版本附带的示例 DAG `example_trigger_target_dag` 中。如果启用了示例 DAG（`load_examples=True`），则经过身份验证的用户可以通过向该 DAG 传递恶意配置来注入和执行任意操作系统命令。提供的 Python 脚本通过 Airflow 的实验性 API 触发 `example_trigger_target_dag`，并将命令注入到 DAG 的配置中，从而导致远程代码执行。脚本首先检查实验性 API 是否可访问，并检查目标 DAG 是否存在且未被打补丁。`CVE-2020-13927`允许未经身份验证的访问实验性API. 经过分析，提供的两个POC代码片段均旨在利用该漏洞，没有发现任何隐藏或恶意的投毒代码，因此投毒风险为0%。

**利用方式：**

1.  **检查环境:** 检查Airflow的版本是否小于等于1.10.10，并且启用了示例DAG（`load_examples=True`）。
2.  **验证API访问:** 利用实验性API，确认`/api/experimental/test`可以访问。
3.  **检查DAG是否存在且未打补丁:** 使用提供的脚本检查`example_trigger_target_dag.bash_task`是否存在且未被修复(通过检查`dag_run`是否在`check_task.json()['env']`中)。
4.  **执行命令:** 运行PoC脚本，指定Airflow的基本URL和要执行的命令。脚本会通过实验性API创建一个新的DAG运行，并将命令注入到`message`配置中。该命令将以运行Airflow worker/scheduler的用户身份执行。
5.  **监控执行:** 脚本会等待scheduler运行DAG，并打印 bash task 的状态。

**项目地址:** [pberba/CVE-2020-11978](https://github.com/pberba/CVE-2020-11978)

**漏洞详情:** [CVE-2020-11978](https://nvd.nist.gov/vuln/detail/CVE-2020-11978)