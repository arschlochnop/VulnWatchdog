## CVE-2021-21974 VMware ESXi OpenSLP 堆溢出漏洞

**漏洞编号:** CVE-2021-21974

**漏洞类型:** 堆溢出

**影响应用:** VMware ESXi

**危害等级:** 高危，远程代码执行

**影响版本:** ESXi 7.0 before ESXi70U1c-17325551, 6.7 before ESXi670-202102401-SG, 6.5 before ESXi650-202102101-SG, VMware Cloud Foundation 4.x before 4.2 and 3.x

**利用条件:** 攻击者需要与 ESXi 服务器位于同一网络段，并且可以访问 427 端口。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-21974 是 VMware ESXi 中 OpenSLP 服务中的一个堆溢出漏洞。攻击者通过向目标 427 端口发送特制的 SLP 数据包，利用 OpenSLP 服务处理数据包时存在的缺陷触发堆溢出，进而实现远程代码执行。

**有效性评估：**
根据漏洞库信息、搜索引擎结果以及提供的POC代码，可以判断该漏洞的POC代码是有效的。漏洞库信息明确指出了该漏洞的存在，并说明了攻击条件和影响。搜索引擎结果显示该漏洞已被广泛研究，并且存在公开的利用代码。提供的POC代码实现了发送恶意 SLP 数据包的功能，可以触发目标 ESXi 服务器的堆溢出漏洞。

**投毒风险评估：**
POC 代码存在一定程度的投毒风险，约为 10%。主要依据是POC 代码中存在可自定义的 `shell_cmd` 变量，该变量允许攻击者执行任意命令。虽然默认的 `shell_cmd` 是反弹 shell， 但攻击者可以将 `shell_cmd` 修改为恶意命令，例如删除文件、篡改配置或植入后门。此外，POC代码本身较为复杂，攻击者可以加入混淆，利用各种编码绕过检测。

**利用方式分析：**
1.  **漏洞定位：**  漏洞存在于 ESXi 的 OpenSLP 服务中，该服务监听在 427 端口。
2.  **攻击条件：**  攻击者需要与 ESXi 服务器位于同一网络段，并且可以访问 427 端口。
3.  **攻击步骤：**
    *   攻击者使用POC代码，构造恶意的 SLP 数据包。SLP数据包的目的在于触发目标主机的堆溢出
    *   通过`shell_cmd`配置，向 ESXi 服务器的 427 端口发送该数据包，触发 OpenSLP 服务中的堆溢出漏洞。
    *   利用堆溢出漏洞，攻击者可以在 ESXi 服务器上执行任意代码。
    *   执行的代码默认配置为反弹 shell。攻击者可以建立与 ESXi 服务器的连接，从而控制 ESXi 服务器。
4.  **缓解措施：**
    *   及时更新 ESXi 服务器到最新版本，修补该漏洞。
    *   限制对 ESXi 服务器 427 端口的访问，只允许受信任的网络段访问该端口。
    *   禁用 OpenSLP 服务，如果不需要该服务的话。

**项目地址:** [Shadow0ps/CVE-2021-21974](https://github.com/Shadow0ps/CVE-2021-21974)

**漏洞详情:** [CVE-2021-21974](https://nvd.nist.gov/vuln/detail/CVE-2021-21974)