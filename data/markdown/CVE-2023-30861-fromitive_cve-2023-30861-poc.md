## CVE-2023-30861-Flask-会话Cookie泄露

**漏洞编号:** CVE-2023-30861

**漏洞类型:** 会话Cookie泄露

**影响应用:** Flask

**危害等级:** 高危，可能导致用户会话劫持

**影响版本:** < 2.2.5, >= 2.3.0, < 2.3.2

**利用条件:** 应用程序部署在缓存代理后，代理不剥离Cookie且不忽略带有Cookie的响应，应用程序设置了`session.permanent = True`，应用程序在请求期间未访问或修改会话，`SESSION_REFRESH_EACH_REQUEST`启用（默认），且应用程序未设置`Cache-Control`标头。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

该漏洞是由于Flask在满足特定条件时，不会在响应中设置`Vary: Cookie`标头，导致缓存代理缓存了包含会话Cookie的响应。后续请求可能会从缓存中返回其他用户的会话Cookie，从而导致会话劫持。

**有效性分析：**

根据漏洞信息和提供的PoC代码，该漏洞利用是有效的。PoC代码通过以下方式重现该漏洞：

1.  使用存在漏洞的Flask版本 (2.0.0, Werkzeug==2.2.2)。
2.  设置`session.permanent = True`。
3.  默认开启`SESSION_REFRESH_EACH_REQUEST` 。
4.  使用了Nginx作为缓存代理，并且配置了`proxy_ignore_headers Set-Cookie;` 这导致nginx 缓存服务器在缓存响应的时候，不会受到 `Set-Cookie` 头的影响。
5.  `/login` 接口在POST请求成功登录后设置cookie，随后的GET请求会刷新会话cookie而不会显式访问或者修改，符合漏洞触发条件。

**投毒风险分析：**

代码库中存在一定投毒风险。风险点主要在于：

1.  **README的警告信息：** 强调不要在公共环境中运行，说明作者明确知道此PoC的潜在危害。
2.  **Nginx配置：** `proxy_ignore_headers Set-Cookie;` 这个配置是核心，但注释为“dangerous”，说明作者知道其危险性，但是否是投毒不好判断。
3. **IP地址替换提示** `test.http`文件中存在`[ip_here]` 替换提醒.该提醒可能诱导使用者不小心将PoC暴露在公网环境。

 尽管存在上述风险点，这些更多是由于PoC本身的性质所致，而非刻意的恶意代码植入。因此，整体投毒风险较低，预估为10%。

**利用方式：**

1.  用户A访问应用程序并登录，服务器设置`session.permanent = True`，并且cookie被设置。
2.  服务器返回的响应（包含会话Cookie）被缓存代理缓存。
3.  用户B访问相同的页面（或触发缓存代理返回缓存的响应），缓存代理返回包含用户A会话Cookie的缓存响应。
4.  用户B现在拥有用户A的会话Cookie，可以冒充用户A执行操作。

**项目地址:** [fromitive/cve-2023-30861-poc](https://github.com/fromitive/cve-2023-30861-poc)

**漏洞详情:** [CVE-2023-30861](https://nvd.nist.gov/vuln/detail/CVE-2023-30861)