## CVE-2024-43425-Moodle-远程代码执行

**漏洞编号:** CVE-2024-43425

**漏洞类型:** 远程代码执行

**影响应用:** Moodle

**危害等级:** 高危，可完全控制服务器，窃取信息，安装勒索软件等

**影响版本:** 4.1.x < 4.1.12, 4.2.x < 4.2.9, 4.3.x < 4.3.6, 4.4.x < 4.4.2

**利用条件:** 需要攻击者拥有教师或管理员权限，能够编辑quiz。需要知道cmid(quiz模块ID) 和 courseid。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-43425 存在于 Moodle 的 calculated question 类型中。攻击者可以通过构造包含恶意代码的 calculated question，利用 dataset wizard 功能执行任意代码。

**有效性:** 根据rapid7的漏洞利用模块描述和提供的POC代码，该漏洞利用是有效的，通过上传一个精心构造的计算问题，包含一个系统命令执行的payload，然后通过Dataset Wizard触发该Payload，从而执行任意命令。

**投毒风险:**  README.md中说明了payload，`answer[0] = "(1)->{system($_GET[chr(97)])}"` ，`chr(97)`是`a`的ASCII码。该payload会将接收到的a参数的内容当做系统命令执行。查看`exploit.py`脚本，并未发现有其他恶意代码。但是脚本的编写风格和变量命名稍显粗糙，存在一定风险，作者可能会通过微妙的修改，例如在请求头中添加恶意header等手段进行投毒。因此，该POC代码存在一定的投毒风险，预估为10%。使用时务必进行代码审计。

**利用方式:**
1.  获取登录token。
2.  使用用户名和密码登录Moodle系统，建立有效的MoodleSession。
3.  从quiz编辑页面提取sesskey, ctxid, 和 category。
4.  上传一个精心构造的包含RCE payload的calculated question。
5.  通过dataset wizard页面触发payload，执行任意系统命令。

**项目地址:** [aninfosec/CVE-2024-43425-Poc](https://github.com/aninfosec/CVE-2024-43425-Poc)

**漏洞详情:** [CVE-2024-43425](https://nvd.nist.gov/vuln/detail/CVE-2024-43425)