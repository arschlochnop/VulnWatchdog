## CVE-2021-21974 VMware ESXi OpenSLP 堆溢出

**漏洞编号:** CVE-2021-21974

**漏洞类型:** 堆溢出

**影响应用:** VMware ESXi

**危害等级:** 高危，可能导致远程代码执行

**影响版本:** ESXi 7.0 before ESXi70U1c-17325551, 6.7 before ESXi670-202102401-SG, 6.5 before ESXi650-202102101-SG, VMware Cloud Foundation 4.x before 4.2 and 3.x

**利用条件:** 攻击者需与ESXi主机处于同一网络段，并能够访问427端口

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2021-21974是VMware ESXi中OpenSLP服务存在的一个堆溢出漏洞。攻击者如果与存在漏洞的ESXi主机处于同一网络段，并且能够访问其427端口，就可以利用此漏洞在目标系统上执行任意代码。根据搜索引擎结果，该漏洞在2023年初被ESXiArgs勒索软件利用，导致大量ESXi服务器被攻击。提供的漏洞利用代码 (`ESXi_ransomware_scanner`) 并非直接利用该堆溢出漏洞，而是用于扫描目标IP是否存在 ESXiArgs 勒索软件留下的勒索信息网页。该脚本通过HTTP请求访问目标IP，解析返回的HTML内容，并搜索特定的勒索信息字符串（"We hacked your company successfully" 和 "How to Restore Your Files"）来判断目标是否被感染。因此，该代码本身是漏洞检测工具，而非漏洞利用工具。

**有效性：**
该代码作为勒索软件检测器是有效的，但不能用于直接利用 CVE-2021-21974 漏洞。

**投毒风险：**
分析提供的Python脚本 `main.py` 和 `README.md`，没有发现明显的恶意代码或后门。该脚本的功能是扫描指定IP或IP列表，判断是否存在ESXi勒索软件攻击后的勒索信息页面。脚本的功能比较简单，只涉及HTTP请求和字符串匹配，因此投毒风险较低。

**利用方式：**
1.  攻击者需要与目标ESXi服务器处于同一网络段。
2.  攻击者需要能够访问目标ESXi服务器的427端口。
3.  攻击者构造恶意的SLP请求，触发OpenSLP服务的堆溢出漏洞。
4.  攻击者通过溢出覆盖内存，实现任意代码执行。

该漏洞的利用方式需要对OpenSLP协议和堆溢出技术有深入的了解。虽然提供的代码不是直接的利用，但明确了相关的网络条件，也指出了通过文件进行批量扫描的方式。

**项目地址:** [CYBERTHREATANALYSIS/ESXi-Ransomware-Scanner-mi](https://github.com/CYBERTHREATANALYSIS/ESXi-Ransomware-Scanner-mi)

**漏洞详情:** [CVE-2021-21974](https://nvd.nist.gov/vuln/detail/CVE-2021-21974)