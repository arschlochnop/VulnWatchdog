## CVE-2024-50379-Apache Tomcat TOCTOU RCE

**漏洞编号:** CVE-2024-50379

**漏洞类型:** 竞争条件导致的远程代码执行

**影响应用:** Apache Tomcat

**危害等级:** 高危，可远程执行任意代码

**影响版本:** 11.0.0-M1 <= version <= 11.0.1, 10.1.0-M1 <= version <= 10.1.33, 9.0.0.M1 <= version <= 9.0.97

**利用条件:** 默认Servlet允许写入 (非默认配置), 文件系统大小写不敏感

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2024-50379 是 Apache Tomcat 中 JSP 编译时的一个 Time-of-Check Time-of-Use (TOCTOU) 竞争条件漏洞。当默认 servlet 启用了写入功能（非默认配置）且文件系统大小写不敏感时，攻击者可以利用此漏洞远程执行代码。

**利用方式：**

1.  攻击者首先需要能够向Tomcat webapps目录下写入文件，这通常需要default servlet的readonly参数设置为false。
2.  POC代码利用竞争条件，并发地发送PUT和GET请求到服务器。PUT请求用于上传恶意JSP文件 (例如 aa.Jsp, bb.Jsp)，其中包含执行系统命令的代码。
3.  JSP文件名的大小写存在差异(aa.Jsp vs aa.jsp)，利用文件系统不区分大小写的特性和TOCTOU漏洞的窗口期。
4.  在Tomcat编译JSP文件时，存在一个时间窗口，在这个窗口期内，攻击者通过竞争条件修改文件内容或者文件名。当Tomcat检查文件和实际编译文件之间出现差异时，就会导致漏洞。
5.  POC上传的JSP payload 执行了 `echo tomcat-cve-2024-50379-demo > ..\\webapps\\ROOT\\poc.jsp` 命令，在ROOT目录下创建了一个 `poc.jsp`文件，内容为`tomcat-cve-2024-50379-demo`.

**有效性：**

根据搜索引擎结果和POC代码，该漏洞利用是有效的，可以在满足特定配置条件下实现远程代码执行。

**投毒风险：**

提供的POC代码主要利用竞争条件执行预期的RCE命令，没有发现明显的恶意代码或者后门，因此投毒风险评估为 0%。代码的功能集中于验证和利用漏洞本身，而没有尝试安装持久性后门或者收集敏感信息。

**项目地址:** [ph0ebus/Tomcat-CVE-2024-50379-Poc](https://github.com/ph0ebus/Tomcat-CVE-2024-50379-Poc)

**漏洞详情:** [CVE-2024-50379](https://nvd.nist.gov/vuln/detail/CVE-2024-50379)