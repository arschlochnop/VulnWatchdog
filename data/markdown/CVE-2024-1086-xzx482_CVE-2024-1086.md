## CVE-2024-1086 - Linux Kernel Use-After-Free

**漏洞编号:** CVE-2024-1086

**漏洞类型:** Use-After-Free

**影响应用:** Linux Kernel (netfilter: nf_tables)

**危害等级:** 高危，本地权限提升

**影响版本:** 3.15 <= version < 6.8 (部分打了补丁的分支除外，具体见描述)

**利用条件:** 需要用户命名空间(CONFIG_USER_NS=y)，且用户命名空间是非特权的(sysctl kernel.unprivileged_userns_clone = 1)，以及nf_tables启用(CONFIG_NF_TABLES=y)。 此外，x64/amd64架构。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-1086 是 Linux 内核 netfilter 组件 nf_tables 中的一个 use-after-free 漏洞。攻击者可以利用此漏洞实现本地权限提升。根据漏洞库信息，`nft_verdict_init()`函数允许将正值作为 hook verdict 中的 drop error。因此，当使用类似于 NF_ACCEPT 的 drop error 发出 NF_DROP 时，`nf_hook_slow()`函数可能导致 double free 漏洞。

**有效性：** 根据搜索结果，该漏洞存在公开可用的PoC利用代码，并且已被积极利用。提供的漏洞利用代码仓库包含`src/main.c`, `src/env.c`, `src/net.c`, `src/nftnl.c`, `src/file.c` 等源文件，以及编译脚本 `Makefile`，说明这是一个完整的 PoC 代码，并且README中说明了成功率。

**投毒风险：** 漏洞利用代码本身是为了利用漏洞，存在一定的风险。但是通过代码审计，并没有发现明显的恶意代码或者后门，考虑到作者公开了全部源代码，并且该漏洞本身是为了本地提权，攻击者需要首先在目标机器上运行代码，因此投毒意义不大。 但是存在通过修改利用代码，造成拒绝服务等情况。因此，投毒风险评估为 10%。

**利用方式：**

1.  **触发漏洞：** 通过创建特定的 nf_tables 规则，并设置特定的 drop error，触发 use-after-free 漏洞。
2.  **利用use-after-free：**  利用该漏洞，覆盖或修改内核内存中的数据。
3.  **权限提升：**  最终目的是将普通用户的权限提升为 root 权限。

**项目地址:** [xzx482/CVE-2024-1086](https://github.com/xzx482/CVE-2024-1086)

**漏洞详情:** [CVE-2024-1086](https://nvd.nist.gov/vuln/detail/CVE-2024-1086)