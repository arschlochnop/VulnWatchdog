## CVE-2021-4034 - Polkit pkexec 本地提权

**漏洞编号:** CVE-2021-4034

**漏洞类型:** 本地提权

**影响应用:** polkit

**危害等级:** 高危，允许低权限用户获取 root 权限

**影响版本:** all

**利用条件:** 目标系统存在 polkit 且 pkexec 可执行

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-4034 是 polkit 的 pkexec 工具中的一个本地权限提升漏洞。pkexec 是一个 setuid 程序，允许授权用户以其他用户身份执行命令。漏洞的根源在于 pkexec 在处理命令行参数时存在缺陷，导致它可以将环境变量作为命令执行。攻击者可以通过构造特定的环境变量，诱导 pkexec 执行任意代码，从而获得 root 权限。

**有效性：**
提供的 POC 代码利用了这一漏洞。`cve-2021-4034.c` 程序设置了一些特定的环境变量，比如 `pwnkit.so:.`、`PATH=GCONV_PATH=.`、`SHELL=/lol/i/do/not/exists`、`CHARSET=PWNKIT` 和 `GIO_USE_VFS=`，并调用 `execve` 执行 `/usr/bin/pkexec`。这些环境变量的设计是为了利用 glibc 的 gconv 机制来加载和执行 `pwnkit.so` 共享库。
`pwnkit.c` 定义了 `gconv` 和 `gconv_init` 函数。`gconv_init` 函数在被加载时，会设置 uid 和 gid 为 0，然后执行 `/bin/sh`，从而获得 root shell。

**投毒风险：**
虽然代码主要功能是漏洞利用，但仍然存在一定的投毒风险。`pwnkit.c` 可以被修改为执行恶意操作，例如植入后门、窃取数据等。当前的 `pwnkit.c` 功能比较清晰明确，只是提权到root执行shell。投毒代码主要存在于编译的so库里面,或者修改后的c代码里面,这里判定为10%投毒风险。

**利用方式：**
1.  编译 `pwnkit.c` 为共享库 `pwnkit.so`：
    ```bash
    gcc -shared -fPIC pwnkit.c -o pwnkit.so
    ```
2.  编译 `cve-2021-4034.c`：
    ```bash
    gcc cve-2021-4034.c -o exploit
    ```
3.  运行 `exploit` 程序：
    ```bash
    ./exploit
    ```
    这将触发漏洞，执行 `pwnkit.so` 中的 `gconv_init` 函数，从而获得 root shell。

此漏洞利用方式依赖于 pkexec 的错误参数处理和 glibc 的 gconv 机制。攻击者构造特殊的环境变量来欺骗 pkexec，最终加载并执行恶意代码，实现本地权限提升。

**项目地址:** [AsierEgana/cve-2021-4034](https://github.com/AsierEgana/cve-2021-4034)

**漏洞详情:** [CVE-2021-4034](https://nvd.nist.gov/vuln/detail/CVE-2021-4034)