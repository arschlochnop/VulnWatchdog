## CVE-2023-32233-Linux Kernel-Netfilter nf_tables UAF

**漏洞编号:** CVE-2023-32233

**漏洞类型:** Use-After-Free

**影响应用:** Linux Kernel (Netfilter nf_tables)

**危害等级:** 高危，可导致权限提升

**影响版本:** <= 6.3.1

**利用条件:** 本地用户

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2023-32233 是 Linux 内核 Netfilter nf_tables 组件中的一个使用后释放漏洞。当处理批量请求时，删除规则和规则中的集合元素会导致use-after-free。攻击者可以利用此漏洞在内核内存中执行任意读写操作，从而获得 root 权限。

**漏洞利用方式：**

1.  漏洞存在于 `net/netfilter/nf_tables_api.c` 文件中。
2.  攻击者发送包含两个基本操作的批量请求：
    *   `NFT_MSG_DELRULE`：删除包含匿名 `nft_set` 的 `nft_rule`，这将隐式删除 `lookup` 表达式和匿名 `nft_set`。
    *   `NFT_MSG_DELSETELEM`：删除已删除的匿名 `nft_set` 中的元素。
3.  内核接受批量请求，调用 `nf_tables_commit_release()` 将释放的资源添加到 `nf_tables_destroy_list`。
4.  `nf_tables_trans_destroy_work()` 处理 `nf_tables_destroy_list`，首先通过调用 `nft_commit_release()` -> `nf_tables_rule_destroy()` -> `nf_tables_expr_destroy()` -> `expr->ops->destroy()` (指向 `nft_lookup_destroy()`) -> `nf_tables_destroy_set()` -> `nft_set_destroy()` -> `kvfree()` 释放 `nft_set` 占用的内存。
5.  之后，在处理 `NFT_MSG_DELSETELEM` 操作时，通过 `nft_commit_release()` -> `nf_tables_set_elem_destroy()` -> `nft_set_elem_ext()` 访问已释放的 `nft_set` 内存，导致使用后释放。
6.  `nft_set_elem_ext` 宏尝试访问释放的 `nft_set` 结构中的 `ops->elemsize` 字段，如果该字段被篡改，可能导致访问任意内存地址。
7.  通过竞争 `nf_tables_trans_destroy_work()`，可以尝试在释放的内存被重用之前修改 `nft_set` 的内容。
8.  PoC 通过增加销毁大量元素的 `nft_set` 操作来增加worker线程延迟，并使其他CPU核心繁忙，来增加竞争成功的几率。

**有效性：**

根据漏洞库信息和搜索引擎结果，该漏洞允许本地用户提权，并且存在公开的 PoC 代码。PoC 代码描述了利用 use-after-free 漏洞的技术，包括竞争条件和内存操作。因此，提供的 PoC 代码看起来是有效的。

**投毒风险：**

尽管PoC看起来旨在重现漏洞利用, 但仍然存在一些风险: 
* 仓库名称过于简单，缺乏实质内容, 增加了潜在的风险。
* 描述中存在一些拼写错误（例如：dea），可能是故意为之，以掩盖潜在的恶意代码。
*  通过延迟worker线程方式，增加了不确定性。 
综上所述，作者可能在PoC中加入了一些难以察觉的恶意代码，比如后门或信息收集功能。尽管PoC主要目的是演示漏洞利用，但也不能排除作者恶意投毒的可能性。因此，保守估计投毒风险为10%。建议在使用前进行代码审计。

**项目地址:** [oferchen/POC-CVE-2023-32233](https://github.com/oferchen/POC-CVE-2023-32233)

**漏洞详情:** [CVE-2023-32233](https://nvd.nist.gov/vuln/detail/CVE-2023-32233)