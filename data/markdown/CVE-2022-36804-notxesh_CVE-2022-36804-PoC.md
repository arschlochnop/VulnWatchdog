## CVE-2022-36804-Bitbucket-命令注入

**漏洞编号:** CVE-2022-36804

**漏洞类型:** 命令注入

**影响应用:** Atlassian Bitbucket Server 和 Data Center

**危害等级:** 高危，可导致远程代码执行

**影响版本:** 7.0.0 <= version < 7.6.17, 7.7.0 <= version < 7.17.10, 7.18.0 <= version < 7.21.4, 8.0.0 <= version < 8.0.3, 8.1.0 <= version < 8.1.3, 8.2.0 <= version < 8.2.2, 8.3.0 <= version < 8.3.1

**利用条件:** 需要对公开仓库具有访问权限，或对私有仓库具有读取权限

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2022-36804 是 Atlassian Bitbucket Server 和 Data Center 中的一个命令注入漏洞。攻击者可以通过发送恶意 HTTP 请求，利用多个 API 端点执行任意代码。根据漏洞库信息，攻击者需要对公共仓库具有访问权限，或对私有仓库具有读取权限。搜索引擎结果证实了该漏洞的存在和利用方式，并提供了相关的分析文章和 PoC 代码的 GitHub 链接。提供的 PoC 代码 `CVE-2022-36804.py` 包含用于检查漏洞、执行 SSRF 和远程代码执行的功能。该脚本通过修改 `git archive` 命令的参数 `--remote` 和 `--exec` 来实现这些功能。具体来说，利用方式是向受影响的 Bitbucket 实例发送包含恶意 `--exec` 参数的特制 HTTP 请求，该参数允许执行任意 shell 命令。

**有效性：**
PoC 代码有效，因为它实现了漏洞描述中提到的利用方式，即通过修改 `git archive` 命令的参数来执行任意代码。

**投毒风险：**
PoC 代码主要用于漏洞验证和利用，但也存在潜在的投毒风险。PoC 利用了`--exec` 参数直接执行命令，攻击者可能会在 `PAYLOAD` 变量中插入恶意代码。此外，虽然代码中包含了一些安全措施，例如 User-Agent 设置和 SSL 证书验证禁用，但仍然存在以下潜在风险：

*   **恶意依赖：**  PoC 脚本依赖于多个 Python 库，攻击者可能通过篡改这些库来注入恶意代码。
*   **后门植入：**  攻击者可能在 PoC 脚本中添加后门代码，以便在目标系统上执行持久化攻击。
*   **信息泄露：**  PoC 脚本可能会泄露敏感信息，例如 API 密钥、数据库密码等。

由于脚本主要是利用已知的漏洞，所以投毒的风险较低，但无法完全排除，预估为 10%。该比例基于代码的复杂性和可能被利用进行恶意修改的程度评估得出。主要是因为代码有远程连接，执行命令等操作，可能存在被篡改的风险。

**利用方式：**
1.  **漏洞检测：** 使用 PoC 代码的 `check` 功能，通过发送包含 `%00--help%00--%00` 的恶意请求，检查目标 Bitbucket 实例是否存在漏洞。
2.  **SSRF：** 使用 PoC 代码的 `ssrf` 功能，通过修改 `--remote` 参数，使目标 Bitbucket 实例向指定的 DNS 域名发起请求，验证 SSRF 漏洞。
3.  **远程代码执行 (RCE)：** 使用 PoC 代码的 `rce` 功能，通过修改 `--exec` 参数，在目标 Bitbucket 实例上执行任意 shell 命令。PoC 代码支持使用 `reverse_shell` 功能，在目标系统上启动反向 shell。
4.  **文件下载:** 可以指定远程的文件，将远程文件下载到本地。

利用过程中需要注意的是，由于 Bitbucket 实例可能存在安全防护措施，因此攻击者需要根据实际情况调整 PoC 代码，例如绕过 WAF、身份验证等。


**项目地址:** [notxesh/CVE-2022-36804-PoC](https://github.com/notxesh/CVE-2022-36804-PoC)

**漏洞详情:** [CVE-2022-36804](https://nvd.nist.gov/vuln/detail/CVE-2022-36804)