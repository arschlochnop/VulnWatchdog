## CVE-2024-4577-PHP-CGI参数注入

**漏洞编号:** CVE-2024-4577

**漏洞类型:** 远程代码执行

**影响应用:** PHP

**危害等级:** 严重，可能导致远程代码执行

**影响版本:** PHP 8.1.* < 8.1.29, 8.2.* < 8.2.20, 8.3.* < 8.3.8

**利用条件:** Windows系统，PHP以CGI模式运行，并且系统启用了使用“Best Fit”策略的代码页。

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2024-4577是一个PHP-CGI中的参数注入漏洞，当PHP在Windows系统上以CGI模式运行时，如果系统配置了特定的代码页，Windows可能会使用“Best-Fit”行为来替换命令行中的字符。PHP CGI模块可能会错误地将这些字符解释为PHP选项，从而允许恶意用户将选项传递给正在运行的PHP二进制文件，进而可能泄露脚本源代码、在服务器上运行任意PHP代码等。

**有效性：**
根据漏洞信息和搜索结果，以及利用代码，该漏洞利用的有效性很高。多个来源表明该漏洞已被积极利用，并且存在公开可用的PoC代码。

**投毒风险：**
分析提供的PoC代码 `CVE-2024-4577.py`，未发现明显的恶意投毒代码。PoC主要功能是检测目标是否存在漏洞，并提供一个交互式shell来执行命令。代码中包含了一些编码转换和请求发送，但没有发现植入后门的迹象。但是，任何下载和执行来自不可信来源的脚本都存在风险，需要进行代码审计。

根据经验判断，投毒风险约为5%。

**利用方式：**
1.  **漏洞触发：** 攻击者需要向目标服务器发送特制的HTTP请求，请求中包含经过特殊编码的恶意PHP选项作为查询字符串参数。这些参数会被传递给php-cgi.exe。
2.  **参数注入：**  利用Windows系统的“Best-Fit”字符转换特性，构造出PHP可以识别的参数。PoC代码中使用了`%AD`代替`-`，`%3D`代替`=`，`+`代替空格。
3.  **远程代码执行：**  通过注入`-d allow_url_include=1 -d auto_prepend_file=php://input`等参数，允许包含远程文件，并将POST请求的内容作为PHP代码执行，从而实现远程代码执行。
4.  **信息泄露：** 攻击者可以通过参数注入来读取服务器上的任意文件。
5.  **交互式Shell：** 通过循环发送请求，模拟一个交互式Shell，允许攻击者执行任意命令。

**项目地址:** [K3ysTr0K3R/CVE-2024-4577-EXPLOIT](https://github.com/K3ysTr0K3R/CVE-2024-4577-EXPLOIT)

**漏洞详情:** [CVE-2024-4577](https://nvd.nist.gov/vuln/detail/CVE-2024-4577)