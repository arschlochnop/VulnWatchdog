## CVE-2022-24112 - Apache APISIX 远程代码执行

**漏洞编号:** CVE-2022-24112

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Apache APISIX

**危害等级:** 高危，可导致服务器完全控制

**影响版本:** 1.3 – 2.12.1

**利用条件:** 目标服务器启用了 batch-requests 插件，且管理员API使用了默认密钥或未更改IP访问限制

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2022-24112 漏洞存在于 Apache APISIX 的 batch-requests 插件中。攻击者可以利用此漏洞绕过 Admin API 的 IP 限制，并使用默认 API 密钥执行远程代码。提供的PoC代码首先构造一个包含恶意 Lua 代码的 PUT 请求，该 Lua 代码用于执行反弹shell。该请求通过 batch-requests 插件发送到 Admin API 的 /apisix/admin/routes/index 路由，用于创建一个新的路由。当访问该新路由时（/rms/fzxewh），将触发之前注入的恶意Lua代码，反弹shell到攻击者指定的IP和端口。

**有效性评估:**
根据漏洞信息和PoC代码，该漏洞在满足特定条件（启用了batch-requests插件，默认API密钥或IP限制绕过）下是可利用的。

**投毒风险分析:**
提供的代码主要用于利用该漏洞实现RCE，功能较为直接。检查发现，代码中存在如下潜在风险：
1.  **硬编码的API密钥:** PoC 中使用了默认的 API 密钥 `edd1c9f034335f136f87ad84b625c8f1`。如果用户直接使用该PoC，且目标系统仍然使用该默认密钥，则可能造成安全风险。这虽然不是作者主动投毒，但是属于编写上的不严谨，提高了漏洞利用的成功率，也可能被恶意利用。
2.  **反弹shell目标地址篡改:** 用户在使用该PoC时，如果未修改 `lhost` 和 `lport` 参数，可能导致shell反弹到非预期目标。
3. **潜在的Lua代码注入风险:** 虽然PoC中使用的反弹shell Lua代码相对简单，但如果恶意攻击者修改了注入的Lua代码，则可能进行更高级的攻击，例如植入持久性后门或窃取敏感信息。该风险的概率较低。
4.  **依赖性风险:** 该PoC依赖 `requests` 库，如果该库本身存在漏洞，则可能引入新的安全风险。

综合以上因素，该 PoC 存在一定的安全风险，因此判定投毒风险为5%。主要风险集中在使用默认密钥和Lua代码的恶意篡改上。

**利用方式总结:**
1.  利用 batch-requests 插件绕过 Admin API 的 IP 限制。
2.  使用默认 API 密钥或绕过身份验证。
3.  通过构造包含恶意 Lua 代码的 PUT 请求，向Admin API的路由管理接口注入恶意代码。
4.  触发包含恶意代码的路由，执行远程代码。

**项目地址:** [Acczdy/CVE-2022-24112_POC](https://github.com/Acczdy/CVE-2022-24112_POC)

**漏洞详情:** [CVE-2022-24112](https://nvd.nist.gov/vuln/detail/CVE-2022-24112)