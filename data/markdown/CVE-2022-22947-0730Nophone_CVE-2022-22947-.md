## CVE-2022-22947-Spring Cloud Gateway-代码注入

**漏洞编号:** CVE-2022-22947

**漏洞类型:** 代码注入

**影响应用:** Spring Cloud Gateway

**危害等级:** 高危，可导致远程代码执行

**影响版本:** Spring cloud gateway versions 3.1.x prior to 3.1.1+, 3.0.x prior to 3.0.7+ and all old and unsupported versions

**利用条件:** Gateway Actuator endpoint is enabled, exposed and unsecured

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2022-22947 是 Spring Cloud Gateway 中的一个代码注入漏洞。根据漏洞信息和搜索结果，当 Gateway Actuator 端点启用、公开且未受保护时，攻击者可以利用 SpEL 表达式注入执行任意代码。

**有效性：**
提供的 POC 代码使用 `AddResponseHeader` 过滤器，通过 SpEL 表达式调用 `org.springframework.cglib.core.ReflectUtils.defineClass` 方法来动态定义一个名为 `ms.GMemShell` 的类，该类是一个哥斯拉内存马。然后，将该类注入到目标 JVM 中，从而实现远程代码执行。根据漏洞描述和相关资料，此方法是有效的。PoC 通过发送恶意构造的请求到 Gateway Actuator 端点来触发漏洞。

**投毒风险：**
虽然主要目的是注入内存马，但代码中存在一定的潜在投毒风险。内存马本身就是一种恶意行为，因为它允许攻击者在不修改磁盘文件的情况下执行任意代码。该内存马具体实现未完整提供，但从github链接可以知道是一个哥斯拉内存马，因此假设其功能为接收 base64 编码的恶意代码并执行。风险点分析：

*   **内存马本身：** 注入内存马已经具有极高的风险。
*   **未清除路由：**  README提到代码没有清除路由部分，如果攻击者不清除路由，可能会留下后门，方便后续访问。
*   **默认密钥：** 哥斯拉内存马默认存在密钥，攻击者使用默认密钥能够轻易控制目标系统。

虽然POC的主要目的是为了验证漏洞，但是内存马本身具有极高的危害性，因此判定存在一定投毒风险。

**利用方式：**

1.  **前提条件：**  目标 Spring Cloud Gateway 实例的 Gateway Actuator 端点已启用、公开且未受保护。
2.  **发送恶意请求：**  攻击者构造包含恶意 SpEL 表达式的 HTTP 请求，并将其发送到 Gateway Actuator 端点。该表达式利用 `org.springframework.cglib.core.ReflectUtils.defineClass` 方法动态定义一个哥斯拉内存马类 `ms.GMemShell`，该类会将恶意代码注入到服务器的内存中。
3.  **内存马激活：** 内存马被注入后，攻击者可以使用哥斯拉客户端与注入的内存马进行交互，发送指令。
4.  **远程代码执行：** 攻击者可以通过哥斯拉客户端执行任意代码，从而控制目标服务器。

**项目地址:** [0730Nophone/CVE-2022-22947-](https://github.com/0730Nophone/CVE-2022-22947-)

**漏洞详情:** [CVE-2022-22947](https://nvd.nist.gov/vuln/detail/CVE-2022-22947)