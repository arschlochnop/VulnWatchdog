## CVE-2023-51385-OpenSSH命令注入

**漏洞编号:** CVE-2023-51385

**漏洞类型:** 命令注入

**影响应用:** OpenSSH

**危害等级:** 高危，可能导致远程代码执行

**影响版本:** < 9.6

**利用条件:** 用户名或主机名包含shell元字符，且在特定情况下被扩展令牌引用。需要配置ProxyCommand。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2023-51385是OpenSSH中的一个命令注入漏洞，存在于9.6版本之前。漏洞的根本原因是当用户名或主机名包含shell元字符时，如果这些名称在某些情况下被扩展令牌引用，可能导致操作系统命令注入。

**有效性：**

根据漏洞描述和提供的POC代码，该漏洞是有效的。POC代码演示了当ProxyCommand配置为`/usr/bin/nc -X connect -x 127.0.0.1:7890 %h %p`时，通过克隆包含恶意子模块（子模块的用户名或主机名包含shell元字符）的Git仓库，可以触发命令注入。

**投毒风险：**

提供的POC代码非常简洁，主要是通过`git clone`命令触发漏洞。直接在提供的`README.md`和命令中发现明显投毒代码的可能性较低。 但`git clone --recurse-submodules`本身会执行子模块中定义的操作，因此子模块本身的内容可能会包含恶意代码，但这不是漏洞利用代码本身的问题，而是Git子模块机制带来的风险。因此，判定投毒风险为10%，主要考虑子模块可能包含恶意代码的可能性。

**利用方式：**

1.  **配置ProxyCommand：** 首先，用户需要在`~/.ssh/config`文件中配置`ProxyCommand`，例如：

    ```
    Host *.com
      ProxyCommand /usr/bin/nc -X connect -x 127.0.0.1:7890 %h %p
    ```

2.  **克隆恶意Git仓库：** 攻击者创建一个包含恶意子模块的Git仓库。恶意子模块的URL包含shell元字符，例如，用户名或主机名包含反引号、美元符号等。

3.  **触发命令注入：** 当用户使用`git clone --recurse-submodules`克隆该恶意仓库时，Git会自动初始化和更新子模块。在处理恶意子模块的URL时，OpenSSH会对其进行不正确的转义，导致shell元字符被解释执行，从而实现命令注入。

**总结：**

此漏洞的利用依赖于特定的OpenSSH配置（`ProxyCommand`）和恶意的Git仓库。攻击者通过控制Git仓库中的子模块URL，可以注入任意命令。修复此漏洞的方法是升级到OpenSSH 9.6或更高版本，或者避免在用户名或主机名中使用shell元字符。

**项目地址:** [Le1a/CVE-2023-51385](https://github.com/Le1a/CVE-2023-51385)

**漏洞详情:** [CVE-2023-51385](https://nvd.nist.gov/vuln/detail/CVE-2023-51385)