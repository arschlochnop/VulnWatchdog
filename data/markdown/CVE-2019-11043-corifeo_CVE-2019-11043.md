## CVE-2019-11043-PHP-FPM远程代码执行

**漏洞编号:** CVE-2019-11043

**漏洞类型:** 远程代码执行

**影响应用:** PHP-FPM

**危害等级:** 高危，可能导致远程代码执行

**影响版本:** 7.1.x (< 7.1.33), 7.2.x (< 7.2.24), 7.3.x (< 7.3.11)

**利用条件:** 需要PHP-FPM以特定配置运行在Nginx服务器上，且Nginx配置不正确，未检查文件是否存在就传递给PHP-FPM。

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2019-11043是一个PHP-FPM中的缓冲区下溢漏洞，当PHP-FPM以特定配置运行在Nginx服务器上时，可能导致远程代码执行。漏洞的根本原因在于`env_path_info`的处理。如果Nginx配置不正确，未对请求的文件进行存在性检查就传递给PHP-FPM，攻击者可以利用该漏洞覆盖FCGI协议数据，从而实现RCE。提供的POC代码通过构造特殊的URL和Header，尝试触发缓冲区下溢，并利用`session.auto_start`来执行PHP代码。 

**有效性：** 根据漏洞信息和搜索结果，提供的POC代码（`CVE-2019-11043.py`）是有效的，可以利用该漏洞在满足特定条件的环境中实现远程代码执行。多个搜索结果提到了该漏洞的严重性，并提供了利用分析和缓解措施。

**投毒风险：** 分析了提供的POC代码（`CVE-2019-11043.py`和`README.md`），没有发现作者隐藏的恶意或投毒代码。代码的目的是利用漏洞进行远程代码执行测试。因此投毒风险为0%。

**利用方式：**

1.  **确定目标环境：** 目标服务器必须运行PHP-FPM，并且使用Nginx作为Web服务器。
2.  **Nginx配置检查：** 检查Nginx的配置，确认是否会将不存在的文件传递给PHP-FPM处理，这是漏洞利用的前提。
3.  **查找合适的URL长度：** POC代码首先会探测可能存在漏洞的URL长度，通过发送带有特定长度`Q`参数的请求，判断服务器的响应状态。
4.  **覆盖FCGI协议数据：**  利用缓冲区下溢漏洞，覆盖FCGI协议数据，尤其是控制`PHP_VALUE`参数。
5.  **设置`session.auto_start`：** 通过`PHP_VALUE`设置`session.auto_start=1`，使PHP自动启动session，并执行session数据中的PHP代码。
6.  **发送恶意请求：** 发送包含恶意PHP代码的请求，例如写入Web Shell或执行系统命令。
7.  **执行RCE：**  成功利用后，攻击者可以在服务器上执行任意代码。

**项目地址:** [corifeo/CVE-2019-11043](https://github.com/corifeo/CVE-2019-11043)

**漏洞详情:** [CVE-2019-11043](https://nvd.nist.gov/vuln/detail/CVE-2019-11043)