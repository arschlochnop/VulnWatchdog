## CVE-2021-22911-Rocket.Chat-NoSQL注入导致RCE

**漏洞编号:** CVE-2021-22911

**漏洞类型:** NoSQL注入

**影响应用:** Rocket.Chat

**危害等级:** 高危，未授权RCE

**影响版本:** 3.11, 3.12 & 3.13

**利用条件:** 目标服务器运行存在漏洞的Rocket.Chat版本，且网络可达。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-22911是Rocket.Chat服务器中存在的一个不当输入清理漏洞。此漏洞存在于3.11、3.12和3.13版本中，可能导致未经身份验证的NoSQL注入，从而可能导致远程代码执行（RCE）。

**有效性：**

提供的PoC代码尝试利用NoSQL注入来获得管理员权限，然后更改密码以进行RCE。根据漏洞描述、搜索引擎结果（特别是Exploit-DB和GitHub上的PoC）以及PoC代码本身来看，该PoC**有效**。PoC通过NoSQL注入获取管理员的重置令牌，然后利用此令牌重置管理员密码，从而控制管理员帐户。

**投毒风险：**

PoC代码主要包含以下几个步骤：

1.  向管理员邮箱发送密码重置邮件。
2.  利用NoSQL注入漏洞，通过`getPasswordPolicy`方法泄露密码重置token.
3.  使用泄露的token重置管理员密码。
4.  如果目标启用了2FA，则通过另外的NoSQL注入尝试获取2FA secret.
5.  如果成功获取2FA secret，则使用该secret和重置后的密码登录管理员账户。

代码本身没有明显的恶意行为，例如直接执行系统命令，或者安装后门。代码的目的是利用漏洞获取管理员权限，然后修改密码。
投毒风险评估：**10%**。

风险主要在于以下几个方面：
*   **依赖性风险** 该PoC依赖于第三方库，比如requests, hashlib, json, oathtool，篡改依赖库可能引入恶意代码。
*   **滥用风险**：PoC的公开可能导致漏洞被大规模利用，对Rocket.Chat服务器造成损害。
*   **信息泄露风险**：如果在测试或使用PoC时，不小心泄露了管理员邮箱、密码或其他敏感信息，可能会导致安全问题。

**利用方式：**

1.  **目标确定：** 确定运行着受影响Rocket.Chat版本的服务器。
2.  **发送重置邮件：** 使用`sendForgotPasswordEmail`方法向管理员账户发送密码重置邮件。
3.  **NoSQL注入获取重置token：** 通过构造恶意的NoSQL查询，利用`getPasswordPolicy`方法，提取管理员密码重置token。
4.  **密码重置：** 使用获取的重置token和攻击者指定的密码，通过`resetPassword`方法重置管理员密码。
5.  **（如果需要）获取2FA Secret**: 如果管理员账号启用了两步验证，通过NoSQL注入尝试拿到两步验证的secret，进一步生成验证码进行登录。
6.  **登录管理员账户：** 使用新设置的密码（和两步验证码），登录管理员账户，从而控制整个Rocket.Chat服务器。
7.  **远程代码执行：**  获得管理员权限后，可以通过Rocket.Chat的管理界面或者API执行恶意操作，例如安装恶意插件或修改配置，从而实现远程代码执行。

**项目地址:** [octodi/CVE-2021-22911](https://github.com/octodi/CVE-2021-22911)

**漏洞详情:** [CVE-2021-22911](https://nvd.nist.gov/vuln/detail/CVE-2021-22911)