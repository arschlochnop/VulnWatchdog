## CVE-2020-11651 SaltStack 身份验证绕过漏洞

**漏洞编号:** CVE-2020-11651

**漏洞类型:** 身份验证绕过

**影响应用:** SaltStack Salt

**危害等级:** 高危，可导致远程代码执行

**影响版本:** < 2019.2.4, < 3000.2

**利用条件:** 目标Salt Master服务器开放4506端口

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2020-11651 存在于 SaltStack Salt 的 salt-master 进程的 ClearFuncs 类中，由于其未正确验证方法调用，导致未经身份验证的远程用户可以访问某些方法。

**有效性：**
根据漏洞库信息、搜索引擎结果和提供的 POC 代码，该漏洞利用有效。漏洞库和搜索引擎结果均表明该漏洞允许未经身份验证的远程代码执行。提供的 POC 代码旨在利用此漏洞，通过绕过身份验证，从 Salt Master 获取 root key，并在 Salt Minion 上执行任意命令或在 Salt Master 上获得 shell。

**投毒风险：**
提供的 POC 代码主要功能是利用漏洞，风险较低。代码逻辑较为清晰，未发现明显的恶意代码。但仍存在极小的风险：

*   **依赖风险：** 代码依赖 `salt` 库，如果该库本身被投毒，可能间接影响此 POC 的安全性。
*   **命令执行风险：**  `send_command_to_minions` 和 `master_shell` 函数允许执行任意命令，如果攻击者使用此 POC 执行恶意命令，可能对目标系统造成损害。使用者如果不对命令进行严格的审查，会存在风险。
*   **潜在后门：** 理论上，攻击者可以在 `master_shell` 中植入持久性的后门，例如修改系统文件或添加计划任务，但当前代码并未包含此类功能，需要攻击者自行添加。

综合分析，该 POC 的投毒风险较低，约为 5%。风险主要来自于使用者对命令的控制和对依赖库的信任。

**利用方式：**

1.  **漏洞定位：**  攻击者识别运行存在漏洞版本的 SaltStack Master 的目标系统。
2.  **身份验证绕过：**  利用 CVE-2020-11651 绕过 Salt Master 的身份验证。
3.  **获取 Root Key：**  通过未经授权的 ClearFuncs 方法调用，从 Salt Master 获取 Root Key。
4.  **远程代码执行：**
    *   **Minion 执行：**  使用 Root Key，通过 `_send_pub` 函数向所有 Salt Minion 发送命令，实现远程代码执行。
    *   **Master 执行：**  使用 Root Key，创建 `runner` 并调用 `cmd.exec_code` 函数，在 Salt Master 上执行任意 Python 代码，从而获得 Shell。

总而言之，该漏洞允许未经授权的攻击者在 Salt Master 和 Minion 上执行任意命令，具有极高的危害性。

**项目地址:** [dozernz/cve-2020-11651](https://github.com/dozernz/cve-2020-11651)

**漏洞详情:** [CVE-2020-11651](https://nvd.nist.gov/vuln/detail/CVE-2020-11651)