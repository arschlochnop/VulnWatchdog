## CVE-2021-22911 - Rocket.Chat NoSQL注入导致RCE

**漏洞编号:** CVE-2021-22911

**漏洞类型:** NoSQL注入

**影响应用:** Rocket.Chat

**危害等级:** 高危，可能导致远程代码执行和数据泄露

**影响版本:** 3.11, 3.12, 3.13 (受影响)

**利用条件:** 目标服务器运行受影响的Rocket.Chat版本，且攻击者可以访问Rocket.Chat服务器

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

该漏洞存在于Rocket.Chat服务器的输入验证中，允许未经身份验证的攻击者通过构造恶意的NoSQL查询来执行任意代码。利用方式如下：

1.  **信息收集：** 收集目标Rocket.Chat服务器的信息，包括版本号等，确定是否存在漏洞。
2.  **密码重置：** 利用未授权的API接口触发密码重置流程，向目标管理员邮箱发送密码重置邮件。
3.  **NoSQL注入获取Token：** 通过构造恶意的NoSQL查询，利用`getPasswordPolicy`接口泄漏管理员的密码重置token。
4.  **密码重置和账户接管：** 使用获取的token重置管理员密码，从而接管管理员账户。
5.  **获取2FA密钥（如果启用）：** 通过API接口获取管理员账户的2FA密钥。
6.  **代码分析与有效性：**
    *   POC代码首先发送管理员的密码重置请求，然后利用NoSQL注入漏洞，通过正则表达式匹配的方式逐步猜解管理员的密码重置token。
    *   成功获取token后，使用该token重置管理员密码，从而控制管理员账户。
    *   如果管理员启用了两因素认证（2FA），POC代码还会尝试通过NoSQL注入获取2FA密钥。
    *   根据 exploit-db 和 github 的信息以及代码功能推断该poc有效。
7.  **投毒风险分析：**
    *   **依赖风险：** 代码中使用了requests, string, time, hashlib, json, oathtool, argparse等模块，使用者可能需要安装，存在一定的依赖风险。
    *   **恶意代码风险：** 代码整体逻辑符合漏洞利用的逻辑。但仍存在作者在代码中植入恶意代码的可能性。例如，在身份验证时，如果判断到某个特定IP或者User-Agent就执行特定恶意代码，但是公开的exp并没有完全展示所有代码逻辑。因此，存在一定投毒风险，个人认为风险比例为10%。主要集中在利用成功后执行的恶意代码。
8.  **缓解措施：**
    *   升级到Rocket.Chat的安全版本（>= 3.13.2, >= 3.12.4, >= 3.11.4）。
    *   实施强输入验证和过滤，以防止NoSQL注入攻击。
    *   启用并强制使用多因素身份验证（MFA）。
    *   定期进行安全审计和漏洞扫描。

**项目地址:** [jayngng/CVE-2021-22911](https://github.com/jayngng/CVE-2021-22911)

**漏洞详情:** [CVE-2021-22911](https://nvd.nist.gov/vuln/detail/CVE-2021-22911)