## CVE-2022-0944-sqlpad-TemplateInjection-RCE

**漏洞编号:** CVE-2022-0944

**漏洞类型:** 模板注入

**影响应用:** sqlpad

**危害等级:** 高危，可导致远程代码执行

**影响版本:** < 6.10.1

**利用条件:** 需要目标sqlpad实例的网络访问，以及具有创建连接权限的高权限用户。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2022-0944是sqlpad中存在的一个模板注入漏洞，存在于连接测试端点。攻击者可以通过构造恶意的模板注入payload，在目标服务器上执行任意代码，从而完全控制服务器。 

**漏洞利用方式：**

1.  **身份验证：** 首先，攻击者需要拥有 sqlpad 实例中具有创建连接权限的用户身份，一般是管理员权限。
2.  **构造Payload：** 攻击者构造包含恶意代码的模板注入Payload。该Payload利用了Node.js的`child_process.exec`函数来执行系统命令。从提供的漏洞利用代码中可以看到，payload的形式为`{{ process.mainModule.require('child_process').exec('COMMAND') }}`，其中COMMAND是要执行的命令。
3.  **发送请求：**  攻击者通过POST请求将包含Payload的JSON数据发送到`/api/connections`端点，创建一个新的数据库连接配置。关键在于`data.database`字段，该字段会被模板引擎解析，导致代码执行。
4.  **触发漏洞：**  创建连接后，攻击者通过GET请求访问`/api/connections/{id}/schema`端点，触发连接测试，从而执行Payload。
5.  **反弹shell (可选)：**  为了方便利用，攻击者通常使用Payload执行反弹shell命令，从而获得对目标服务器的控制权。
6.  **利用代码分析:**
    * `exploit.py`是一个Python脚本，实现了CVE-2022-0944漏洞的自动化利用。
    * 脚本接受目标URL、攻击者IP等参数。
    * 脚本首先创建一个随机字符串，作为连接名称。
    * 脚本构造包含恶意代码的JSON数据，并将其发送到`/api/connections`端点。
    * 脚本通过GET请求访问`/api/connections/{id}/schema`端点，触发漏洞，从而执行Payload。
    * 脚本可以监听指定端口，接收命令执行结果（通过base64编码）。

**投毒风险评估：**

该代码主要实现了漏洞利用功能，但仍存在一定的投毒风险，评估为10%。理由如下：

*   **潜在的恶意命令注入：** 攻击者可以通过`-c`参数指定要执行的命令。如果脚本没有对该参数进行充分的验证和过滤，攻击者可能会注入恶意命令，例如下载和执行额外的恶意程序。
*   **后门植入：** 攻击者可能修改脚本，在成功利用漏洞后，在目标服务器上植入后门，以便长期控制目标系统。
*   **信息收集：** 脚本可以收集目标服务器的信息，例如操作系统版本、已安装的软件等。这些信息可能会被泄露给攻击者，用于进一步的攻击。

因此，在使用该脚本时，需要仔细检查代码，确保没有恶意代码被注入，并采取必要的安全措施，例如限制脚本的执行权限、监控脚本的网络活动等。

**项目地址:** [Philip-Otter/CVE-2022-0944_RCE_Automation](https://github.com/Philip-Otter/CVE-2022-0944_RCE_Automation)

**漏洞详情:** [CVE-2022-0944](https://nvd.nist.gov/vuln/detail/CVE-2022-0944)