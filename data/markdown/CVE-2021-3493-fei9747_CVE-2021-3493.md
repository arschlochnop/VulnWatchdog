## CVE-2021-3493 Ubuntu OverlayFS 本地提权

**漏洞编号:** CVE-2021-3493

**漏洞类型:** 本地提权

**影响应用:** Linux Kernel (Ubuntu)

**危害等级:** 高危，攻击者可利用此漏洞获取 root 权限

**影响版本:** Ubuntu kernel versions: < 5.8.0-50.56, < 5.4.0-72.80, < 4.15.0-142.146, < 4.4.0-209.241

**利用条件:** 需要在存在漏洞的 Ubuntu 系统上本地执行

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2021-3493 是一个存在于 Ubuntu Linux 内核 overlayfs 实现中的本地提权漏洞。该漏洞源于 overlayfs 未能正确验证用户命名空间中底层文件系统上文件 capabilities 的设置。结合未授权用户命名空间以及 Ubuntu 内核中允许未授权 overlay mount 的补丁，攻击者可以利用此漏洞提升权限。

**漏洞利用方式：**

1.  **环境准备：** 创建必要的目录结构，包括lowerdir，upperdir，workdir和mergedir。
2.  **创建命名空间：** 使用 `unshare` 系统调用创建新的用户命名空间和挂载命名空间。
3.  **设置用户和组ID映射：** 将当前用户的 UID 和 GID 映射到新的用户命名空间中，以便在新的命名空间中拥有权限。
4.  **挂载 OverlayFS：** 使用 `mount` 系统调用，将 overlayfs 挂载到 mergedir，并将 lowerdir，upperdir 和 workdir 指定为相应的目录。
5.  **设置 Capabilities：** 复制当前执行的程序到 mergedir，并使用 `setxattr` 设置该文件的 capabilities，使其具有 root 权限。 这步是漏洞利用的关键。
6.  **执行Payload：** 执行upper目录中的文件，因为设置了Capabilities，可以获得root权限。

**有效性：**

根据漏洞库信息和POC代码描述，该漏洞在特定版本的 Ubuntu 内核上是可利用的。提供的POC代码展示了利用该漏洞提升权限的完整过程。

**投毒风险：**

代码中存在潜在的投毒风险，但是风险较低。主要集中在编译和运行exploit时。攻击者可能通过修改 exploit.c 文件，例如添加恶意代码或后门，从而在目标系统上执行恶意操作。但是根据提供的POC代码来看, 风险系数较低.

**风险评估：**

该漏洞利用的成功取决于目标系统是否满足以下条件：

*   运行受影响的 Ubuntu 内核版本。
*   启用了未授权用户命名空间和 overlayfs mount。
*   目标系统上存在 `gcc` 编译器, 能够编译exploit。

如果目标系统满足这些条件，攻击者可以使用提供的 POC 代码成功利用该漏洞，从而获得 root 权限。


**项目地址:** [fei9747/CVE-2021-3493](https://github.com/fei9747/CVE-2021-3493)

**漏洞详情:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)