## CVE-2024-4577-PHP-CGI Argument Injection

**漏洞编号:** CVE-2024-4577

**漏洞类型:** 远程代码执行

**影响应用:** PHP

**危害等级:** 高危，可能导致远程代码执行，服务器完全控制

**影响版本:** PHP 8.1.* before 8.1.29, 8.2.* before 8.2.20, 8.3.* before 8.3.8

**利用条件:** Windows系统，运行在CGI模式下，并且开启了使用"Best Fit"策略的代码页。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-4577是PHP在Windows系统上以CGI模式运行时的一个参数注入漏洞。当系统配置使用某些代码页时，Windows可能会使用"Best-Fit"行为来替换命令行中的字符。PHP CGI模块可能会错误地将这些字符解释为PHP选项，从而允许恶意用户将选项传递给PHP二进制文件，导致泄露源代码，执行任意PHP代码等。

**有效性:**
提供的POC代码通过发送包含特定查询参数（如`%ADd+allow_url_include=1`和`%ADd+auto_prepend_file=php://input`）的POST请求到`/php-cgi/php-cgi.exe`端点来利用此漏洞。如果目标服务器存在漏洞，则`php://input`流的内容（在本例中为`<?php phpinfo(); ?>`）将被执行，并且服务器将返回包含"PHP Version"的响应。此方法已被多个来源证实有效。

**投毒风险:**
虽然提供的`exploit.py`脚本看起来相对直接，但仍然存在一定的投毒风险。例如，该脚本禁用了SSL验证(`verify=False`)，这可能导致中间人攻击的风险。此外，任何下载和执行的第三方代码都存在风险，例如将恶意payload注入到请求中。考虑到代码的复杂性相对较低，并且其主要目的是利用已知漏洞，因此投毒风险较低，估计为10%。主要风险在于用户没有仔细审查脚本，直接执行，而忽略了`verify=False`带来的安全隐患。 另外脚本也存在可以加入恶意host的风险。

**利用方式:**
1.  攻击者首先需要确定目标服务器是否运行在满足漏洞条件的PHP CGI模式下。
2.  攻击者构造一个包含恶意PHP选项的HTTP请求，例如，设置`allow_url_include`为1和`auto_prepend_file`为`php://input`。
3.  攻击者将该请求发送到`/php-cgi/php-cgi.exe`端点，并在POST数据中包含要执行的PHP代码。
4.  如果服务器存在漏洞，PHP将执行POST数据中的代码，从而允许攻击者在服务器上执行任意命令。

**项目地址:** [bughuntar/CVE-2024-4577](https://github.com/bughuntar/CVE-2024-4577)

**漏洞详情:** [CVE-2024-4577](https://nvd.nist.gov/vuln/detail/CVE-2024-4577)