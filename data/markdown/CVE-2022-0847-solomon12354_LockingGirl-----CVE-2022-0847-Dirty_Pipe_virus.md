## CVE-2022-0847 Dirty Pipe 本地提权漏洞

**漏洞编号:** CVE-2022-0847

**漏洞类型:** 本地权限提升

**影响应用:** Linux Kernel

**危害等级:** 高危，可使普通用户获得root权限

**影响版本:** Linux Kernel 5.17 rc6 及之前版本（具体受影响范围需进一步确认）

**利用条件:** 需要本地用户权限

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2022-0847（Dirty Pipe）是一个Linux内核中的本地权限提升漏洞。漏洞原因是由于在copy_page_to_iter_pipe和push_pipe函数中，新的管道缓冲区结构的“flags”成员缺少适当的初始化，可能包含陈旧的值。未经授权的本地用户可以利用此漏洞写入由只读文件支持的页面缓存中的页面，从而提升他们在系统上的权限。

**漏洞利用方式：**

1.  **利用pipe机制:** 漏洞利用涉及利用Unix pipe的机制。具体来说，利用了在内核处理pipe缓冲区时对某些标志位初始化不当的缺陷。
2.  **覆盖只读文件:** 攻击者通过pipe向只读文件写入数据。
3.  **权限提升:**  通过覆盖特定的系统文件（例如`/etc/passwd`）的内容，攻击者可以修改用户密码或添加具有root权限的新用户，从而获得系统root权限。

**代码分析:**

提供的代码`exploit-1.c`是一个利用CVE-2022-0847漏洞的PoC。它通过以下步骤工作：

*   **备份`/etc/passwd`:** 首先备份`/etc/passwd`文件到`/tmp/passwd.bak`，以便稍后恢复。
*   **打开只读文件:** 然后以只读模式打开目标文件（`/etc/passwd`）。
*   **准备pipe:** 创建并填充一个pipe，然后清空它，这会设置pipe缓冲区的标志位，为漏洞利用做准备。
*   **覆盖数据:** 利用漏洞，将恶意数据（修改后的root密码）写入`/etc/passwd`文件的特定偏移量处。
*   **修改root密码:** 代码中替换root密码的逻辑是漏洞利用的核心，展示了如何利用此漏洞修改系统配置。

**有效性：**

根据漏洞库信息和搜索引擎结果，CVE-2022-0847漏洞已被广泛研究，存在公开可用的PoC代码，并且被CISA列入已知被利用的漏洞目录，所以该漏洞是有效的。

**投毒风险：**

分析`README.md`，虽然作者声明此代码仅用于演示目的，但其明确表示“We use it to delete all files on your Ubuntu.”。`exploit-1.c` 虽然进行了备份,但存在其他风险,因为漏洞利用的本质就是修改`/etc/passwd`。整体来看，投毒风险较低,约5%。主要集中在作者的免责声明和利用代码的破坏性用途说明。虽然 PoC 的主要功能是演示权限提升，但如果未经授权使用可能会造成系统损坏或其他非法活动。

**总结：**

该漏洞允许本地用户覆盖只读文件，通常用于提升权限。提供的 PoC 代码演示了如何利用此漏洞修改 `/etc/passwd` 文件，从而更改 root 用户的密码，实现提权。利用方式简单有效，但潜在的投毒风险需要引起注意。由于作者明确表示删除文件的操作，请务必小心使用此代码。

**项目地址:** [solomon12354/LockingGirl-----CVE-2022-0847-Dirty_Pipe_virus](https://github.com/solomon12354/LockingGirl-----CVE-2022-0847-Dirty_Pipe_virus)

**漏洞详情:** [CVE-2022-0847](https://nvd.nist.gov/vuln/detail/CVE-2022-0847)