## CVE-2021-34527 - PrintNightmare

**漏洞编号:** CVE-2021-34527

**漏洞类型:** 远程代码执行

**影响应用:** Windows Print Spooler

**危害等级:** 高危，允许攻击者以 SYSTEM 权限执行任意代码

**影响版本:** 受影响的 Windows 版本包括但不限于 Windows 10, Windows Server 2019, Windows 11 等 (参考漏洞库信息)

**利用条件:** 需要目标系统开启 Print Spooler 服务，并且攻击者需要具备一定的身份验证权限 (参考搜索引擎结果)

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-34527（PrintNightmare）是一个 Windows Print Spooler 服务中的远程代码执行漏洞。攻击者可以通过 `RpcAddPrinterDriverEx` 函数不正确地执行特权文件操作来利用此漏洞，从而以 SYSTEM 权限运行任意代码。

**有效性：**

根据提供的漏洞库信息、搜索引擎结果和漏洞利用代码，此漏洞的POC代码是有效的。多个来源确认了该漏洞的存在和可利用性。

**投毒风险：**

POC代码存在潜在的投毒风险，但概率较低（10%）。

*   **风险点：** 代码中存在多个硬编码的文件路径（如 `C:\Windows\System32\winhttp.dll` 和 `C:\Windows\System32\kernelbase.dll`），以及对共享目录的依赖。攻击者可能通过修改这些路径，引导受害者加载恶意的 DLL 文件，从而实现远程代码执行。
*   **缓解：** 代码需要根据目标环境进行调整，硬编码路径在实际使用中会存在适配问题。经验丰富的渗透测试人员会检查并修改这些路径，降低了直接运行恶意代码的风险。
*   **其他：** 虽然代码本身的功能是利用漏洞执行代码，但精心构造的恶意 DLL 仍然是攻击的核心，不能因为存在后门 DLL 就判定为投毒。

**利用方式：**

1.  **连接目标：** 使用 `impacket` 库建立与目标 Print Spooler 服务的 RPC 连接。
2.  **构建 Payload：** 构造 `DRIVER_CONTAINER` 结构，包含指向恶意 DLL 的路径（通过共享目录提供）。
3.  **触发漏洞：** 调用 `hRpcAddPrinterDriverEx` 函数，将恶意的驱动程序信息添加到 Print Spooler 服务。
4.  **权限提升：** Print Spooler 服务尝试加载指定的 DLL 文件，由于权限提升漏洞，加载过程以 SYSTEM 权限执行，从而实现任意代码执行。
5.  **尝试路径** 通过循环尝试 `C:\Windows\System32\spool\drivers\x64\3\old\{0}\{1}`目录下的DLL。

**项目地址:** [nemo-wq/PrintNightmare-CVE-2021-34527](https://github.com/nemo-wq/PrintNightmare-CVE-2021-34527)

**漏洞详情:** [CVE-2021-34527](https://nvd.nist.gov/vuln/detail/CVE-2021-34527)