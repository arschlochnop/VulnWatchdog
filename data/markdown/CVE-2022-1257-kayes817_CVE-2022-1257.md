## CVE-2022-1257-McAfee Agent-敏感信息泄露

**漏洞编号:** CVE-2022-1257

**漏洞类型:** 敏感信息泄露

**影响应用:** McAfee Agent

**危害等级:** 中危，可能导致敏感信息泄露，权限提升

**影响版本:** < 5.7.6

**利用条件:** 本地用户权限

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2022-1257 漏洞存在于 McAfee Agent 5.7.6 之前的版本中。该漏洞是由于 McAfee Agent 将敏感信息以不安全的方式存储在 ma.db 数据库文件中导致的。本地用户可以通过访问该数据库文件来获取敏感信息，如用户名和密码。提供的 PowerShell 脚本 CVE-2022-1257.ps1 旨在利用此漏洞，通过以下步骤实现：

1.  **加载WinSQLite3.dll**: 脚本首先加载 winsqlite3.dll 以便操作 SQLite 数据库。
2.  **连接到数据库**: 将 `ma.db` 复制到临时目录，然后使用 SQLite 函数打开数据库。
3.  **执行SQL查询**: 执行 SQL 查询以检索 `AGENT_REPOSITORIES` 表中 `AUTH_USER` 和 `AUTH_PASSWD` 列的值，即用户名和加密的密码。
4.  **解密密码**: 使用 `Invoke-McAfeeDecrypt` 函数解密检索到的加密密码。该函数首先对 Base64 编码的密码进行解码，然后使用固定的 XOR 掩码和 TripleDES 算法进行解密，还原出原始密码。
5.  **输出结果**: 将用户名和解密后的密码以 CSV 格式输出。

**有效性：**根据漏洞描述和提供的POC代码，可以判断该POC有效。POC 能够读取并解密存储在ma.db中的凭据。

**投毒风险：**该POC代码的主要功能是读取和解密数据库中的密码。仔细分析代码，发现可能存在以下投毒风险：

*   **加载外部 DLL:** 脚本需要加载 winsqlite3.dll 才能工作。如果 winsqlite3.dll 被替换为恶意 DLL，则可能执行任意代码。这部分的风险为 5%。

**利用方式：**

1.  攻击者需要具有目标系统上的本地用户权限。
2.  攻击者运行 PowerShell 脚本 CVE-2022-1257.ps1。
3.  脚本复制 `ma.db` 数据库文件到临时目录。
4.  脚本使用 SQLite 函数连接到数据库并执行查询。
5.  脚本使用硬编码的密钥解密密码。
6.  脚本将用户名和解密的密码以 CSV 格式输出。

根据rapid7的描述，该漏洞可以被利用于特权提升或横向移动，因此危害较大。

**项目地址:** [kayes817/CVE-2022-1257](https://github.com/kayes817/CVE-2022-1257)

**漏洞详情:** [CVE-2022-1257](https://nvd.nist.gov/vuln/detail/CVE-2022-1257)