## CVE-2023-41892 - Craft CMS Remote Code Execution

**漏洞编号:** CVE-2023-41892

**漏洞类型:** Remote Code Execution

**影响应用:** Craft CMS

**危害等级:** Critical，可能导致完全控制服务器

**影响版本:** >= 4.0.0-RC1, <= 4.4.14

**利用条件:** 目标Craft CMS实例版本在受影响范围内，且可以通过网络访问。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

根据漏洞库信息和搜索结果，CVE-2023-41892是Craft CMS中的一个远程代码执行漏洞。该漏洞允许未经身份验证的攻击者在目标服务器上执行任意代码。POC代码的利用方式如下：

1.  **获取临时上传目录和Document Root：** POC首先尝试通过发送一个包含恶意配置的请求来获取`upload_tmp_dir`和`DOCUMENT_ROOT`。该请求利用了`craft\elements\conditions\ElementCondition`类和`\GuzzleHttp\Psr7\FnStream`类来触发`phpinfo()`函数，然后使用正则表达式从响应中提取所需的信息。
2.  **写入Payload到临时文件：** POC将一个包含PHP代码的MSL（Magick Scripting Language）文件上传到服务器。该MSL文件包含一个PHP Webshell，允许通过`cmd`参数执行系统命令。payload会被写入 DOCUMENTROOT/cpresources/shell.php。
3.  **触发Imagick处理MSL文件：** POC再次发送一个包含恶意配置的请求，这次使用`Imagick`类来处理先前上传的MSL文件。这个步骤利用了Imagick的`msl:`协议来读取MSL文件，并执行其中的恶意代码，从而将webshell写入目标服务器。
4.  **执行任意命令：** 一旦Webshell写入成功，攻击者就可以通过访问`DOCUMENTROOT/cpresources/shell.php`并提供`cmd`参数来执行任意系统命令。

**有效性：**

根据提供的漏洞信息，搜索引擎结果以及POC代码，该漏洞利用很可能有效。多个来源证实了漏洞的存在和严重性，并且POC代码提供了可执行的漏洞利用方法。

**投毒风险：**

POC代码本身主要目标是演示漏洞的利用。评估投毒风险，主要考虑作者是否在代码中隐藏了恶意功能，例如：

*   **额外的网络请求：**  代码中没有发现向外部服务器发送信息的行为。
*   **后门：**  Webshell本身是利用目标，并非作者投毒。
*   **资源消耗：**  代码没有明显的资源消耗型操作。

因此，虽然存在远程代码执行漏洞，但是**POC代码的投毒风险较低, 估计为10%**。这部分风险来自以下因素：

*   **依赖第三方库的风险：**  POC使用了`requests`库，如果该库本身被投毒，可能会影响POC。
*   **webshell的用途：** Webshell可能被恶意利用，但这是漏洞利用本身的性质，而非POC代码额外引入的风险。

总的来说，POC的主要目的是演示漏洞，而不是植入恶意代码。但仍然需要谨慎使用，并在安全的环境中进行测试。

**项目地址:** [acesoyeo/CVE-2023-41892](https://github.com/acesoyeo/CVE-2023-41892)

**漏洞详情:** [CVE-2023-41892](https://nvd.nist.gov/vuln/detail/CVE-2023-41892)