## CVE-2024-36401-GeoServer-远程代码执行

**漏洞编号:** CVE-2024-36401

**漏洞类型:** 远程代码执行

**影响应用:** GeoServer

**危害等级:** 高危，可能导致服务器完全控制

**影响版本:** 2.22.0 < version < 2.22.6
2.23.0 <= version < 2.23.6
2.24.0 <= version < 2.24.4
2.25.0 <= version < 2.25.2

**利用条件:** 需要网络访问，目标服务器运行存在漏洞的 GeoServer 版本

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-36401 是 GeoServer 中的一个远程代码执行漏洞，源于 GeoTools 库 API 不安全地将属性名传递给 commons-jxpath 库，导致在评估 XPath 表达式时可以执行任意代码。漏洞存在于所有 GeoServer 实例中，可以通过 WFS GetFeature, WFS GetPropertyValue, WMS GetMap, WMS GetFeatureInfo, WMS GetLegendGraphic 和 WPS Execute 请求触发。

**POC 有效性分析：**

提供的 POC 代码看起来是有效的。它包含以下关键功能：

*   使用 `requests` 库发送 HTTP 请求。
*   使用 `lxml` 库解析 XML 响应，提取 `Typenames`，并自动化的爬取所有Typenames信息，并循环测试可以利用的Typenames，修复Nuclei POC中由于Typenames写死，造成漏洞验证失败的问题。
*   支持 `-c` 参数执行命令，或使用 DNSLog 进行验证。
*   支持批量 URL 检测。

这些功能对应了漏洞的利用方式，即通过构造特定的 OGC 请求，利用 XPath 表达式注入执行任意命令。

**投毒风险分析：**

代码中存在轻微的投毒风险。风险点在于：

*   作者在代码中留下了版权声明，虽然这是正常的，但也增加了作者控制代码的风险。
*   虽然脚本本身的功能是漏洞利用，但如果作者恶意地修改了脚本，例如，在执行命令后添加额外的恶意操作，或者收集目标服务器的信息并发送给攻击者，那么就存在投毒风险。

综合考虑，投毒风险较低，约为 10%。此风险主要来自于作者是否会利用更新或维护代码的机会植入后门。

**利用方式总结：**

1.  **确定目标 GeoServer 版本：** 确认目标服务器运行的 GeoServer 版本在受影响范围内。
2.  **获取 Typenames：** 通过 WFS GetCapabilities 请求或其他方式获取目标 GeoServer 实例的 Typenames 信息。
3.  **构造恶意请求：** 构造包含恶意 XPath 表达式的 WFS/WMS/WPS 请求，将命令注入到 property/attribute name 中。
4.  **发送请求：** 将构造好的请求发送到目标 GeoServer 服务器。
5.  **验证漏洞：** 通过 DNSLog 或者检查命令执行结果验证漏洞是否存在。

例如，可以使用类似以下的 URL 构造恶意请求：

```
/geoserver/wfs?service=WFS&version=1.0.0&request=GetFeature&typeName=<typeName>&propertyName=fes:ResourceId&Filter=<%20fes:Filter%20xmlns:fes=%22http://www.opengis.net/fes/2.0%22%20xmlns:gml=%22http://www.opengis.net/gml/3.1.1%22%20xmlns:ogc=%22http://www.opengis.net/ogc%22><ogc:Function%20name=%22script:js%22><ogc:Literal><![CDATA[java.lang.Runtime.getRuntime().exec('touch /tmp/pwned');]]></ogc:Literal></ogc:Function></fes:Filter>
```

**项目地址:** [amoy6228/CVE-2024-36401_Geoserver_RCE_POC](https://github.com/amoy6228/CVE-2024-36401_Geoserver_RCE_POC)

**漏洞详情:** [CVE-2024-36401](https://nvd.nist.gov/vuln/detail/CVE-2024-36401)