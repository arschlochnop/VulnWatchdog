## CVE-2022-46169-Cacti-命令注入

**漏洞编号:** CVE-2022-46169

**漏洞类型:** 命令注入

**影响应用:** Cacti

**危害等级:** 高危，允许未经身份验证的攻击者执行任意代码

**影响版本:** < 1.2.23

**利用条件:** 需要目标Cacti版本低于1.2.23且存在action类型为POLLER_ACTION_SCRIPT_PHP (2) 的 poller_item 配置

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2022-46169 是 Cacti 1.2.23 之前版本中的一个未经身份验证的命令注入漏洞。攻击者可以通过操纵 `remote_agent.php` 文件中的请求参数来执行任意操作系统命令。漏洞利用涉及以下步骤：

1.  **身份验证绕过：** 攻击者通过设置 `X-Forwarded-For` 等 HTTP Header 欺骗 `get_client_addr` 函数，使其返回 Cacti 服务器自身的 IP 地址，从而绕过身份验证检查。
2.  **`polldata` 操作触发：**  身份验证绕过后，攻击者可以调用 `remote_agent.php` 中的 `polldata` 操作。
3.  **命令注入：** 通过构造恶意的 `poller_id` 参数，将命令注入到传递给 `proc_open` 函数的字符串中，从而执行任意命令。
4.  **利用条件：** 成功利用需要存在一个 `poller_item`，其 `action` 字段值为 `POLLER_ACTION_SCRIPT_PHP`（值为2）。`host_id` 和 `local_data_ids` 可以通过暴力破解找到。

提供的POC代码 (`CVE-2022-46169.py`) 实现了上述攻击过程，包含以下步骤：

*   检查目标是否易受攻击 (`checkVuln` 函数)。
*   通过暴力破解查找有效的 `host_id` 和 `local_data_ids` (`bruteForcing` 函数)。
*   构造包含反向shell payload 的恶意请求，并将其发送到 `remote_agent.php` (`Reverse_shell` 函数)。

**关于投毒风险：**

对提供的POC代码进行分析，并未发现明显的恶意投毒代码，例如删除文件、上传恶意文件等行为。POC代码的主要功能是利用漏洞进行反向Shell连接。但依然存在一定的潜在风险：

*   **依赖风险：** 虽然代码本身看起来没有恶意，但它依赖于 `requests` 和 `urllib` 库。如果这些库本身被篡改，可能会引入风险。
*   **命令执行风险：**  该漏洞本身允许执行任意命令，攻击者可以利用这一点执行恶意操作。但这不属于代码投毒，而是漏洞的 inherent risk。

因此，将投毒风险评估为 5%。

**项目地址:** [FredBrave/CVE-2022-46169-CACTI-1.2.22](https://github.com/FredBrave/CVE-2022-46169-CACTI-1.2.22)

**漏洞详情:** [CVE-2022-46169](https://nvd.nist.gov/vuln/detail/CVE-2022-46169)