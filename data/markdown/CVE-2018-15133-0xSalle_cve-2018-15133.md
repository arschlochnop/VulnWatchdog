## CVE-2018-15133 Laravel Framework 反序列化远程代码执行

**漏洞编号:** CVE-2018-15133

**漏洞类型:** 反序列化远程代码执行

**影响应用:** Laravel Framework

**危害等级:** 高危，可能导致远程代码执行和服务器被完全控制

**影响版本:** 5.5.40 及之前版本，5.6.x 版本直至 5.6.29

**利用条件:** 需要知道 Laravel 应用的 APP_KEY，通常情况下无法获取，但如果攻击者之前拥有过特权访问权限或成功完成了之前的攻击，则可能获取到。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2018-15133 漏洞存在于 Laravel Framework 中，攻击者可以通过在 X-XSRF-TOKEN 值上进行未授权的反序列化操作，导致远程代码执行。漏洞存在于 Illuminate/Encryption/Encrypter.php 的 decrypt 方法和 phpggc 的 gadgetchains/Laravel/RCE/3/chain.php 中。利用该漏洞需要知道 Laravel 应用的 APP_KEY，并通过精心构造的序列化数据，触发特定的 PHP 对象链（gadget chain）执行任意代码。

**有效性：**
提供的 POC 代码看起来是有效的，因为它实现了以下功能：
1.  生成恶意 payload：根据指定的命令、API 密钥和 payload 方法，生成反序列化 payload。
2.  加密 payload：使用 Laravel 应用的 APP_KEY 对 payload 进行 AES 加密，并生成相应的 IV 和 MAC 值。
3.  发送 payload：将加密后的 payload 设置到 X-XSRF-TOKEN cookie 中，并发送请求到 Laravel 应用。

**投毒风险：**
该代码仓库中存在一定的投毒风险，大约为10%。风险主要体现在以下几个方面：
1.  **潜在的后门代码：** 即使表面上代码实现了漏洞利用的功能，但攻击者可能在代码中隐藏一些恶意的后门，例如：
    *   在生成 payload 的过程中，插入额外的恶意代码。
    *   在请求发送过程中，记录或泄露敏感信息。
    *   利用漏洞在目标服务器上部署持久化后门。
2.  **依赖风险：** 该 POC 代码可能依赖于一些外部库或模块，这些库或模块本身可能存在安全漏洞或恶意代码。
3.  **不完善的错误处理：** 代码中的错误处理可能不够完善，导致程序在特定情况下崩溃或产生其他安全问题。

**利用方式：**
利用方式如下：
1.  **获取 APP_KEY：** 首先需要获取 Laravel 应用的 APP_KEY。这通常是最困难的一步，可能需要通过其他漏洞或社会工程学手段获取。
2.  **生成 Payload：** 使用 POC 代码生成包含恶意命令的 payload。POC 允许选择不同的 payload 方法（Laravel RCE1, RCE2, RCE3, RCE4），选择合适的 payload 方法可能取决于目标环境的配置。
3.  **加密 Payload：** 使用 APP_KEY 对生成的 payload 进行加密，并计算 MAC 值。
4.  **发送请求：** 将加密后的 payload 作为 X-XSRF-TOKEN cookie 的值发送到目标 Laravel 应用。
5.  **触发反序列化：** Laravel 应用在处理请求时，会尝试解密并反序列化 X-XSRF-TOKEN 的值，从而触发漏洞，执行恶意代码。

**项目地址:** [0xSalle/cve-2018-15133](https://github.com/0xSalle/cve-2018-15133)

**漏洞详情:** [CVE-2018-15133](https://nvd.nist.gov/vuln/detail/CVE-2018-15133)