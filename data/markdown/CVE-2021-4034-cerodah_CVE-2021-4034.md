## CVE-2021-4034 - polkit pkexec 本地提权漏洞

**漏洞编号:** CVE-2021-4034

**漏洞类型:** 本地权限提升

**影响应用:** polkit

**危害等级:** 高危，允许低权限用户获取 root 权限

**影响版本:** all (受影响版本直至修复)

**利用条件:** 本地用户访问

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2021-4034（PwnKit）是 polkit 的 pkexec 实用程序中的本地权限提升漏洞。pkexec 是一个 setuid 工具，旨在允许非特权用户根据预定义的策略以特权用户身份运行命令。该漏洞是由于 pkexec 没有正确处理调用参数计数，从而导致尝试将环境变量作为命令执行。攻击者可以通过精心构造环境变量，诱使 pkexec 执行任意代码，从而获得 root 权限。

**有效性分析：**

根据漏洞库信息、搜索引擎结果（尤其是 Qualys 的博客文章）和提供的 PoC 代码，该漏洞是有效的，并且已被积极利用。

**投毒风险分析：**

PoC 代码分析：

*   `README.md`：包含漏洞的简要描述、polkit 的作用、漏洞的缓解措施，未发现恶意代码。
*   `cve-2021-4034-poc.c`：这是 PoC 代码的核心部分。它利用 `GCONV_PATH` 环境变量来加载恶意共享库。该库中的 `gconv_init` 函数被设计为在执行时设置 uid 和 gid 为 0，并执行 `/bin/sh`，从而创建一个 root shell。代码本身并未发现作者隐藏的恶意代码。

综合来看，该仓库的 PoC 代码目的明确，即利用 CVE-2021-4034 漏洞实现本地提权。代码结构清晰，主要通过设置环境变量和加载恶意共享库来触发漏洞。没有发现任何迹象表明作者在代码中加入了额外的、与漏洞利用无关的恶意功能或后门。因此，投毒风险较低，大约为 0%。

**利用方式分析：**

1.  **创建 GCONV_PATH 目录和触发文件：** PoC 代码首先创建 `GCONV_PATH=.` 目录，并创建一个名为 `pwnkit` 的文件，并赋予执行权限，用来欺骗 pkexec。
2.  **创建 gconv-modules 文件：** 在 `pwnkit` 目录下，创建一个 `gconv-modules` 文件，声明一个字符集转换模块，指定了恶意共享库的路径。
3.  **创建恶意共享库：** PoC 代码创建一个 C 源代码文件 `pwnkit/pwnkit.c`，其中包含 `gconv` 和 `gconv_init` 函数。`gconv_init` 函数被设计为设置进程的 uid 和 gid 为 0，并执行 `/bin/sh` 命令，从而获得 root shell。
4.  **编译恶意共享库：** 使用 `gcc` 将 `pwnkit/pwnkit.c` 编译成共享库 `pwnkit/pwnkit.so`。
5.  **执行 pkexec：** 使用 `execve` 函数执行 `/usr/bin/pkexec`，同时设置环境变量 `pwnkit`、`PATH=GCONV_PATH=.`、`CHARSET=PWNKIT` 和 `SHELL=pwnkit`。这些环境变量的设置会触发 pkexec 中的漏洞，导致加载恶意共享库并执行其中的代码，从而获得 root 权限。

**项目地址:** [cerodah/CVE-2021-4034](https://github.com/cerodah/CVE-2021-4034)

**漏洞详情:** [CVE-2021-4034](https://nvd.nist.gov/vuln/detail/CVE-2021-4034)