## CVE-2024-54498-macOS Sandbox Escape

**漏洞编号:** CVE-2024-54498

**漏洞类型:** 沙箱逃逸

**影响应用:** macOS

**危害等级:** 高危，允许应用程序突破沙箱限制

**影响版本:** < 15.2 (Sequoia), < 13.7.2 (Ventura), < 14.7.2 (Sonoma)

**利用条件:** 本地用户权限，应用程序需要先被安装在受害者机器上

**POC 可用性:** 是

**投毒风险:** 20%

## 详情

CVE-2024-54498 是 macOS 中的一个路径处理漏洞，允许恶意应用程序突破其沙箱限制。该漏洞的核心在于 `sharedfilelistd` 组件对路径验证不充分，攻击者可以通过操纵文件路径来访问沙箱外的资源。 

**有效性评估：**

根据搜索结果（特别是 gbhackers.com 的文章），漏洞利用 PoC 已经发布，这意味着漏洞是可以被利用的。提供的代码仓库也支持这一判断，包含 Objective-C 代码和 entitlements 文件，表明它是一个可以编译运行的 macOS 应用程序，旨在演示如何利用此漏洞。

**投毒风险评估：**

从代码分析来看，存在一定投毒风险。主要集中在以下几个方面：

1.  **`dobby.h` 引入：** `dobby.h` 是一个 Hook 框架，虽然本身不是恶意代码，但可以用来注入恶意功能，比如劫持系统调用，修改程序行为等，增加了潜在的风险。
2.  **`sandbox_extension_consume` Hook：** PoC代码中Hook了`sandbox_extension_consume` 函数，这是一个与沙箱扩展相关的函数。虽然Hook的目的是为了捕获 extension token 并打印相关信息，但这个Hook点也可能被用于执行恶意操作，具体恶意行为取决于 Hook 函数内部实现，当前代码中的实现相对简单，风险较低，但是可能存在变种。
3.  **添加根目录到 Favorites：**`add_root_dir_to_favorites` 函数试图将根目录添加到 Finder 的 Favorites 列表中。尽管代码中注释了`XXX CVE-2024-54524?`，但添加根目录到 Favorites 本身可能触发其他未知的安全问题。
4.  **代码风格和作者：** 作者使用了`seo`作为用户名，并且代码注释和命名风格略显随意，这可能增加代码被篡改或添加后门的风险。

总的来说，这个仓库的投毒风险为 **20%**。Hook框架和对沙箱相关函数的Hook是潜在的风险点，但当前代码并未发现明显的恶意行为，风险可控。更重要的是，如果该POC被恶意修改，Hook点就可以用来注入恶意代码，所以需要谨慎使用。

**利用方式分析：**

1.  **沙箱逃逸：** 漏洞利用的核心是通过操纵文件路径，绕过沙箱的路径验证机制，从而访问或修改沙箱外的文件或资源。
2.  **`sharedfilelistd` 组件：** 该漏洞与 `sharedfilelistd` 组件相关，这个组件负责处理共享文件列表，攻击者可能通过精心构造共享文件列表来触发漏洞。
3.  **Hook `sandbox_extension_consume`：** PoC 代码通过 Hook `sandbox_extension_consume` 函数来捕获沙箱扩展 token。虽然当前 PoC 只是简单地打印 token，但理论上可以利用捕获的 token 来执行更复杂的操作，例如获取对沙箱外资源的访问权限。
4.  **添加根目录到收藏夹 (潜在风险)：**  `add_root_dir_to_favorites` 函数可能与另一个漏洞 (CVE-2024-54524?) 相关联，或者通过将根目录添加到收藏夹来触发未知的行为，但这部分利用方式的细节尚不清楚。

**总结：**

CVE-2024-54498 是一个高危的 macOS 沙箱逃逸漏洞，攻击者可以利用该漏洞突破应用程序的沙箱限制。PoC 代码的存在表明该漏洞是可以被利用的。在使用 PoC 代码时，需要注意潜在的投毒风险，特别是 Hook 框架和对沙箱相关函数的 Hook，以及添加根目录到收藏夹的功能。利用方式主要是通过操纵文件路径，绕过沙箱的路径验证机制。由于POC中存在hook沙箱函数和使用hook框架，因此判断POC作者可能存在投毒意图。POC利用代码投毒分析要慎重。务必不要把POC验证的后门代码判定为投毒代码。

**项目地址:** [wh1te4ever/CVE-2024-54498-PoC](https://github.com/wh1te4ever/CVE-2024-54498-PoC)

**漏洞详情:** [CVE-2024-54498](https://nvd.nist.gov/vuln/detail/CVE-2024-54498)