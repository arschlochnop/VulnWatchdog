## CVE-2022-29464 - WSO2 任意文件上传导致远程代码执行

**漏洞编号:** CVE-2022-29464

**漏洞类型:** 任意文件上传

**影响应用:** WSO2 API Manager, Identity Server, Enterprise Integrator, Open Banking AM/KM 等

**危害等级:** 高危，未经授权的远程代码执行

**影响版本:** WSO2 API Manager 2.2.0 up to 4.0.0, WSO2 Identity Server 5.2.0 up to 5.11.0, WSO2 Identity Server Analytics 5.4.0, 5.4.1, 5.5.0 and 5.6.0, WSO2 Identity Server as Key Manager 5.3.0 up to 5.11.0, WSO2 Enterprise Integrator 6.2.0 up to 6.6.0, WSO2 Open Banking AM 1.4.0 up to 2.0.0 and WSO2 Open Banking KM 1.4.0, up to 2.0.0.

**利用条件:** 目标服务器存在漏洞并且可以通过网络访问 /fileupload 接口。

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2022-29464 漏洞允许攻击者通过 `/fileupload` 接口上传任意文件，通过目录穿越将文件写入到webapps目录下，从而导致远程代码执行。

**有效性分析：**

提供的POC代码利用了该漏洞。代码通过构造一个包含恶意JSP代码的文件，并使用目录穿越的方式将其上传到目标服务器的 `repository/deployment/server/webapps/authenticationendpoint/` 目录下。上传成功后，攻击者可以通过访问上传的JSP文件来执行任意命令。
根据搜索结果显示，该漏洞已经被广泛利用，证明POC的有效性。

**投毒风险分析：**

代码本身的功能是实现漏洞利用，上传并执行JSP后门。其中恶意行为是利用漏洞本身，而非代码作者额外添加的恶意功能。代码的危害在于利用漏洞，代码本身较为直白。
尽管如此，仍然存在微小的投毒风险，例如作者可能在代码中加入隐蔽的回连等恶意功能，但可能性较低，评估为5%。

**利用方式：**

1.  **确定目标：** 确定存在CVE-2022-29464漏洞的WSO2产品实例。
2.  **构造恶意JSP文件：** POC代码中已经包含了一个简单的JSP Shell，可以执行命令。攻击者可以根据需要修改JSP代码，实现更复杂的功能。
3.  **利用POC上传文件：** 使用POC代码，指定目标服务器地址和JSP文件名，将恶意JSP文件上传到目标服务器。
    *   `-f`：指定包含目标列表的文件。每一行包含一个目标地址，格式为 `HOST:PORT` 或 `IP:PORT`。
    *   `-t`：指定单个目标地址，格式同上。
    *   `-j`：指定要上传的JSP文件名。
4.  **执行命令：** 访问上传的JSP文件，通过URL参数传递要执行的命令。

例如，如果JSP文件名为 `shell.jsp`，则可以通过访问 `https://target/authenticationendpoint/shell.jsp?cmd=whoami` 来执行 `whoami` 命令。


**项目地址:** [c1ph3rbyt3/CVE-2022-29464](https://github.com/c1ph3rbyt3/CVE-2022-29464)

**漏洞详情:** [CVE-2022-29464](https://nvd.nist.gov/vuln/detail/CVE-2022-29464)