## CVE-2021-21239-pysaml2-签名绕过

**漏洞编号:** CVE-2021-21239

**漏洞类型:** 签名绕过

**影响应用:** pysaml2

**危害等级:** 高危，可能导致用户伪造和权限提升

**影响版本:** < 6.5.0

**利用条件:** 使用默认 CryptoBackendXmlSec1 后端，且需要验证签名的 SAML 文档

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-21239 是 pysaml2 库中的一个签名验证绕过漏洞，影响版本低于 6.5.0。该漏洞源于 pysaml2 使用 xmlsec1 验证 SAML 签名时，默认允许使用嵌入在 SAML 响应中的公钥，而没有强制使用配置的 IdP 证书。攻击者可以构造一个包含恶意公钥的 SAML 响应，并使用相应的私钥对其进行签名。由于 xmlsec1 允许使用嵌入的公钥，因此伪造的签名将被验证通过，从而允许攻击者冒充任何用户，并提升权限。

**有效性：**
提供的 POC 代码（来自技术报告）解释了如何利用此漏洞，包括生成密钥对、构造包含恶意公钥的 SAML 响应、修改用户属性（如电子邮件）以冒充管理员，并使用生成的私钥对响应进行签名。报告中还提供了通过 Docker Compose 设置易受攻击的 Redash 实例，配置 SAML SSO，以及使用 Ngrok 将本地 Redash 实例暴露给 Google 的 IdP 进行测试的步骤。 pentesterlab 提供的练习也佐证了该漏洞的可利用性。 因此，可以判定该POC有效。

**投毒风险：**
该代码仓库主要包含 LICENSE，README.md, 描述了漏洞原理和利用方式。检查代码未发现明显的恶意行为，但由于代码仓库的作者可以随时修改代码，存在一定的潜在风险，例如在构建过程中插入恶意代码，或者在某些特定条件下触发恶意行为。考虑到LICENSE文件以及README描述文件的内容，可以判定存在10%的投毒风险。

**利用方式：**
1.  攻击者生成一个 RSA 密钥对。
2.  攻击者构造一个恶意的 SAML 响应，将生成的公钥嵌入到 `<ds:RSAKeyValue>` 元素中。
3.  攻击者修改 SAML 响应中的用户属性（例如，将电子邮件地址更改为管理员的电子邮件地址）。
4.  攻击者使用生成的私钥对 SAML 响应进行签名。
5.  攻击者将伪造的 SAML 响应发送给易受攻击的 pysaml2 应用程序。
6.  pysaml2 应用程序使用 xmlsec1 验证签名，由于 xmlsec1 允许使用嵌入的公钥，因此伪造的签名将被验证通过。
7.  攻击者成功冒充目标用户（例如，管理员），并获得相应的权限。

**项目地址:** [illera88/CVE-2021-21239](https://github.com/illera88/CVE-2021-21239)

**漏洞详情:** [CVE-2021-21239](https://nvd.nist.gov/vuln/detail/CVE-2021-21239)