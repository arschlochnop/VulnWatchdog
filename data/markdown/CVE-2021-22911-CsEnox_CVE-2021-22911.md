## CVE-2021-22911-Rocket.Chat-NoSQL注入

**漏洞编号:** CVE-2021-22911

**漏洞类型:** NoSQL注入

**影响应用:** Rocket.Chat

**危害等级:** 高危，可能导致远程代码执行

**影响版本:** 3.11, 3.12, 3.13 (Fixed in: 3.13.2, 3.12.4, 3.11.4)

**利用条件:** 需要目标Rocket.Chat服务器可访问，无需身份验证即可利用部分漏洞

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-22911是Rocket.Chat 3.11、3.12和3.13版本中存在的NoSQL注入漏洞。此漏洞由于不正确的输入验证导致，允许未经身份验证的攻击者注入恶意NoSQL查询，最终可能导致远程代码执行(RCE)。

**漏洞利用方式：**

1.  **账户劫持 (未授权):** `getPasswordPolicy` 端点中的 `token` 参数存在NoSQL注入，允许使用 `$regex` 操作符进行盲注来获取重置令牌。
2.  **权限提升至管理员 (已授权):**  `users.list` API 端点的 `query` 参数也存在NoSQL注入。通过构造特定的 `$where` 子句并抛出异常，可以检索管理员用户的敏感信息，例如 2FA secret 或密码重置令牌。
3.  **远程代码执行 (已授权 - 管理员):** 利用Rocket.Chat的Integrations功能，创建带有恶意脚本的webhook，当webhook被触发时，脚本会被执行，从而实现RCE。

**POC代码分析：**

POC代码提供了完整的漏洞利用流程，包括：

*   发送密码重置邮件
*   盲注获取重置令牌
*   使用重置令牌更改密码
*   利用`users.list`接口通过NoSQL注入获取管理员的2FA密钥或者reset token。
*   创建包含恶意代码的Integration Webhook，执行任意命令。

**有效性评估：**

根据漏洞库信息、搜索引擎结果以及提供的POC代码，此漏洞利用是有效的。 Exploit-DB 和 GitHub 上都存在相关的利用代码。

**投毒风险评估：**

POC代码主要目的是利用漏洞，但存在一定潜在的投毒风险。例如：

*   在创建Integration Webhook时，如果将执行命令部分替换为恶意代码，可能会对目标服务器造成破坏。
*   利用脚本对服务器进行持续性的扫描行为，尝试控制其他服务器。

评估结果： 投毒风险为10%。风险主要存在于使用者利用该POC进行恶意操作的可能性，而非代码本身存在明显的后门。

**利用条件：**

*   目标Rocket.Chat服务器运行在受影响的版本。
*   服务器可以访问。
*   如果管理员启用了2FA，则需要通过NoSQL注入泄露2FA密钥或者重置token。


**项目地址:** [CsEnox/CVE-2021-22911](https://github.com/CsEnox/CVE-2021-22911)

**漏洞详情:** [CVE-2021-22911](https://nvd.nist.gov/vuln/detail/CVE-2021-22911)