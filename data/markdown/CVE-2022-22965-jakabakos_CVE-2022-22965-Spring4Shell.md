## CVE-2022-22965 Spring4Shell RCE

**漏洞编号:** CVE-2022-22965

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Spring Framework

**危害等级:** 高危，可能导致服务器完全控制

**影响版本:** Spring Framework versions 5.3.X prior to 5.3.18+, 5.2.x prior to 5.2.20+ and all old and unsupported versions on JDK 9+ with Tomcat as WAR deployment.

**利用条件:** 需要目标应用使用存在漏洞的Spring Framework版本，运行在JDK 9+，部署为WAR包到Tomcat服务器，并且使用了受影响的Spring MVC或Spring WebFlux。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2022-22965，又名Spring4Shell，是一个Spring Framework中的远程代码执行漏洞。该漏洞允许未经身份验证的远程攻击者通过数据绑定利用某些特性来执行任意代码。根据漏洞库信息和搜索引擎结果，该漏洞影响运行在JDK 9+上的Spring MVC或Spring WebFlux应用程序，并且这些应用程序必须以WAR包形式部署在Tomcat服务器上。如果应用部署为Spring Boot可执行jar，则不受影响。漏洞利用代码通过以下步骤实现RCE：

1.  **重置日志变量:** 通过修改`fileDateFormat`参数来初始化。
2.  **修改Tomcat日志配置:** 攻击者通过精心构造的请求，修改Tomcat的日志配置，将日志输出格式设置为包含可以执行命令的JSP代码。
3.  **写入 Webshell:**  通过header头传递包含Runtime的参数和命令执行的逻辑，通过修改过的日志配置写入webshell到服务器的webapps目录下。
4.  **命令执行:** 攻击者可以通过访问写入的webshell，传递`cmd`参数来执行任意命令。
5.  **清理日志变量:** 清理之前修改的日志变量，防止恶意写入。

**有效性:** 根据漏洞库信息、搜索引擎结果以及提供的漏洞利用代码，可以判断该POC代码是有效的，利用了不安全的配置修改来写入 Webshell.

**投毒风险评估:** 此仓库的投毒风险较低，约10%。Dockerfile中使用lunasec/tomcat-9.0.59-jdk11作为基础镜像，这本身具备一定的安全性，maven构建流程相对标准，没有发现明显的恶意代码注入行为，最主要的风险点在于`vulnerable-app`目录下的源代码，如果该目录下的源代码包含恶意代码，则可能存在投毒风险。

**利用方式总结:** 该漏洞的利用方式是先修改Tomcat的日志配置，将日志输出重定向到Web目录，并设置日志内容为可执行的JSP代码。然后，发送包含恶意代码的请求，使Tomcat将JSP代码写入日志文件，从而在Web目录中创建一个webshell。攻击者可以通过访问webshell执行任意命令，实现远程代码执行。

**项目地址:** [jakabakos/CVE-2022-22965-Spring4Shell](https://github.com/jakabakos/CVE-2022-22965-Spring4Shell)

**漏洞详情:** [CVE-2022-22965](https://nvd.nist.gov/vuln/detail/CVE-2022-22965)