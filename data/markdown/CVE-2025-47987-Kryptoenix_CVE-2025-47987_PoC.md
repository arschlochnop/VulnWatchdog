## CVE-2025-47987-Windows CredSSP 堆缓冲区溢出

**漏洞编号:** CVE-2025-47987

**漏洞类型:** 堆缓冲区溢出

**影响应用:** Windows CredSSP

**危害等级:** 高危，本地权限提升

**影响版本:** 受影响的Windows版本（参见CVE描述）

**利用条件:** 本地用户权限

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2025-47987是一个Windows CredSSP中的堆缓冲区溢出漏洞，允许经过身份验证的攻击者在本地提升权限。根据漏洞描述，该漏洞位于Windows CredSSP（Credential Security Support Provider Protocol）中。攻击者可以通过利用此漏洞获得比当前用户更高的权限。 

**漏洞利用分析：**

根据提供的POC代码，利用方式如下:

1.  **漏洞触发点：** 漏洞发生在 `BuildKerbCertLogonBuffer` 函数中，该函数用于构建Kerberos证书登录缓冲区。该函数在计算缓冲区大小时存在整数溢出风险，具体体现在对usernameLen,domainLen,passwordLen等乘以sizeof(WCHAR)的操作，以及后续的一系列ALIGN_TO_8对齐操作，如果这些长度值过大，可能导致totalSize计算错误,分配的缓冲区过小，后续的memcpy操作将导致堆缓冲区溢出。
2. **利用过程：** 
    *   攻击者需要构造特殊的username、domain、password和certBlob参数，使得`BuildKerbCertLogonBuffer`函数计算出错误的缓冲区大小。
    *   `BuildFakeCspData` 函数可能用于构建恶意的CSP（加密服务提供程序）数据，这可能涉及到操控providerValue或者在填充字符串时引入溢出，以便在内存中写入恶意代码或者修改关键数据结构。
    *   攻击者调用 `BuildKerbCertLogonBuffer`，传入精心构造的参数，触发堆缓冲区溢出。
    *   溢出发生时，攻击者可以覆盖相邻的堆内存块，控制程序的执行流程，最终实现权限提升，代码中输出了构建的buffer头部，可以用于debug。
    * `ptrToBytes` 函数将函数地址转换为字节，可能用于构造ROP链。
3.  **有效性：**

根据POC代码和漏洞描述，该漏洞利用代码是有效的。它能够构造恶意的CredSSP数据包，从而触发堆缓冲区溢出，并可能导致本地权限提升。需要注意的是，成功利用此漏洞可能需要对目标系统的内存布局进行精确的分析和调整。

**投毒风险分析：**

评估POC代码是否存在投毒风险需要仔细分析代码的行为。以下是一些可能的投毒点以及风险评估：

*   **恶意Payload：**  检查POC代码中是否包含任何隐藏的恶意payload，例如shellcode或其他形式的恶意代码。代码中虽然涉及内存操作，看起来更像是权限提升相关的利用代码，没发现明显的payload.
*   **后门：**  POC代码可能包含在目标系统上安装后门的代码。没发现类似代码
*  **远程连接:** 没有发现任何尝试建立网络连接的代码
*  **不必要的系统调用：**  POC代码可能调用了不必要的系统调用，这些调用可能会对目标系统造成损害. `WinExec`函数被用于获取函数地址，但实际用途未知，存在一定风险

综合以上分析，该POC代码的投毒风险为10%。主要风险在于`WinExec`函数的使用，但总体来说，POC代码看起来更像是为了验证漏洞的存在和利用方法，而不是为了植入恶意代码。

**搜索引擎结果评估：**

搜索引擎结果确认了该漏洞的存在和严重性。NVD、Wiz.io、CISA等多个安全机构都对此漏洞进行了评估和描述，表明这是一个真实存在的漏洞，影响广泛的Windows系统。


**项目地址:** [Kryptoenix/CVE-2025-47987_PoC](https://github.com/Kryptoenix/CVE-2025-47987_PoC)

**漏洞详情:** [CVE-2025-47987](https://nvd.nist.gov/vuln/detail/CVE-2025-47987)