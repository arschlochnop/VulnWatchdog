## CVE-2022-46169-Cacti-命令注入

**漏洞编号:** CVE-2022-46169

**漏洞类型:** 命令注入

**影响应用:** Cacti

**危害等级:** 高危，允许未授权用户执行任意命令

**影响版本:** < 1.2.23

**利用条件:** 需要目标Cacti版本低于1.2.23，并且存在action类型为POLLER_ACTION_SCRIPT_PHP的poller_item。

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2022-46169 是 Cacti 中的一个命令注入漏洞。未经身份验证的攻击者可以通过操纵`remote_agent.php`文件中的输入，利用`poller_id`参数执行任意操作系统命令。攻击流程如下：

1.  **身份验证绕过：** 攻击者通过设置`X-Forwarded-For`头绕过身份验证。这是因为`get_client_addr`函数信任`HTTP_`开头的`$_SERVER`变量，允许攻击者伪造客户端IP地址，从而通过`poller`表中的主机名检查。
2.  **触发命令注入：** 绕过身份验证后，攻击者可以调用`remote_agent.php`的`polldata`动作。`poll_for_data`函数检索请求参数并加载相应的`poller_item`条目。如果`poller_item`的`action`等于`POLLER_ACTION_SCRIPT_PHP`，则使用`proc_open`执行PHP脚本。`poller_id`参数在传递给`proc_open`之前未经过充分过滤，从而导致命令注入。
3.  **漏洞利用代码分析：**  `poc.sh` 脚本首先解析用户提供的参数（目标URL、本地IP和端口），然后构造反向shell的payload，并对其进行URL编码。脚本通过发送带有`X-Forwarded-For`头的HTTP请求来检查目标是否易受攻击。该脚本通过暴力破解`host_id`和`local_data_ids`来枚举有效的URL。最后，它使用构造的payload向目标发送一个请求，从而触发反向shell。
4.  **投毒风险评估：**  该POC的主要目的是利用漏洞实现反向Shell。检查`poc.sh`脚本，发现脚本本身主要功能是生成Payload、URL编码、发送HTTP请求。虽然存在修改反向连接IP和端口的可能性，但没有发现明显的恶意代码或后门。`README.md`中建议访问的GitHub仓库 (`https://github.com/m3ssap0/cacti-rce-cve-2022-46169-vulnerable-application`)，用于搭建漏洞环境，**存在一定风险，应该注意**。总体而言，脚本投毒风险较低，初步评估为5%。风险主要来自于下载其他来源的poc，或者使用poc访问陌生的网址。
5.  **有效性评估:** 该POC的有效性较高，因为它可以自动化漏洞利用过程，从身份验证绕过到命令执行。多个搜索引擎结果表明该漏洞已被积极利用。
6.  **利用方式总结：** 通过伪造HTTP头绕过身份验证，然后利用未过滤的`poller_id`参数在`remote_agent.php`中注入命令，最终实现远程代码执行。

**项目地址:** [RdBBB3/SHELL-POC-CVE-2022-46169](https://github.com/RdBBB3/SHELL-POC-CVE-2022-46169)

**漏洞详情:** [CVE-2022-46169](https://nvd.nist.gov/vuln/detail/CVE-2022-46169)