## CVE-2016-6662 - MySQL 本地权限提升/远程代码执行

**漏洞编号:** CVE-2016-6662

**漏洞类型:** 权限提升/远程代码执行

**影响应用:** MySQL, MariaDB, Percona Server

**危害等级:** 高危，可能导致完全控制数据库服务器

**影响版本:** MySQL (<= 5.5.52, <= 5.6.33, <= 5.7.15), MariaDB (< 5.5.51, < 10.0.27, < 10.1.17), Percona Server (< 5.5.51-38.1, < 5.6.32-78.0, < 5.7.14-7)

**利用条件:** 本地用户或具有数据库连接权限的远程用户

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2016-6662 允许本地用户通过设置 `general_log_file` 到一个恶意的 `my.cnf` 配置文件来创建任意配置，并绕过某些保护机制。这可以被利用来以 root 权限执行任意代码，通过设置 `malloc_lib`。利用方式如下：

1.  **利用前提：** 具有 MySQL 用户权限（即使权限很低）。
2.  **修改配置文件：** 攻击者可以尝试修改 MySQL 的配置文件（my.cnf），或者通过 SQL 语句设置 `general_log_file` 参数指向一个由攻击者控制的文件。
3.  **写入恶意配置：** 将恶意的配置写入到 `general_log_file` 指定的文件中，例如设置 `malloc_lib` 指向恶意动态链接库。
4.  **重启 MySQL 服务：**  重启 MySQL 服务，使恶意配置生效。
5.  **代码执行：**  恶意动态链接库被加载，攻击者控制的代码以 root 权限执行。

**有效性评估：** 根据漏洞库信息和搜索结果，该漏洞的POC是有效的。已经存在公开的利用代码，并且该漏洞已经被广泛讨论和利用。

**投毒风险评估：** 提供的代码片段主要是 Ansible 配置文件，用于配置 scapegoat.test 和 attacker.test 两台虚拟机环境，包括安装 MySQL，配置用户，以及一些常用的软件。代码本身用于搭建漏洞利用的环境，可能包含测试漏洞利用的后门代码。但是，从提供的代码片段来看，没有明显的恶意代码注入，但考虑到自动化部署的复杂性，仍存在一定的风险，主要是自动化脚本可能被植入恶意代码，安装不需要软件。风险评估为5%。

**利用方式总结：**

该漏洞的核心在于利用 MySQL 的 `general_log_file` 配置项，允许低权限用户覆盖配置文件，进而通过 `malloc_lib` 设置加载恶意动态链接库，最终实现以 root 权限执行任意代码。攻击者需要有权限连接到数据库，然后才能修改配置或执行 SQL 语句来触发漏洞。


**项目地址:** [KosukeShimofuji/CVE-2016-6662](https://github.com/KosukeShimofuji/CVE-2016-6662)

**漏洞详情:** [CVE-2016-6662](https://nvd.nist.gov/vuln/detail/CVE-2016-6662)