## CVE-2023-32233-Linux Kernel-Netfilter Use-After-Free

**漏洞编号:** CVE-2023-32233

**漏洞类型:** Use-After-Free

**影响应用:** Linux Kernel Netfilter nf_tables

**危害等级:** 高危，本地用户可提升至root权限

**影响版本:** <= 6.3.1

**利用条件:** 本地用户权限，需要nf_tables配置

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2023-32233 漏洞存在于Linux内核的Netfilter nf_tables子系统中，当处理批量请求以更新nf_tables配置时，会发生use-after-free漏洞。

**漏洞利用有效性:**
根据漏洞库信息、搜索引擎结果以及提供的POC代码，可以判断此漏洞利用是有效的。POC代码描述了利用此漏洞的详细步骤，包括如何触发use-after-free，以及如何赢得与内核后台工作线程的竞争，从而实现可靠的利用。搜索引擎结果中也提到了公开的PoC。

**投毒风险:**
POC代码的目的是演示漏洞利用，并不能完全排除作者隐藏投毒代码的风险。代码中存在一定的复杂性，难以保证完全没有恶意代码。但从代码的功能和目的来看，作为漏洞利用，投毒的可能性较低。对已提供的POC代码进行初步分析，发现并无明显恶意代码，但仍需进一步审查。因此，将投毒风险评估为10%。

**利用方式:**
利用方式如下：
1.  **漏洞触发:** 通过构造恶意的nf_tables批量请求，其中包含删除规则（`NFT_MSG_DELRULE`）和删除集合元素（`NFT_MSG_DELSETELEM`）的操作。
2.  **Use-After-Free:** 删除规则操作会释放匿名集合（`nft_set`）的内存。之后，删除集合元素的操作会尝试访问已释放的内存，从而触发use-after-free漏洞。
3.  **竞争条件:** 攻击者需要与内核后台工作线程`nf_tables_trans_destroy_work()`竞争。为了增加成功率，POC代码会增加延迟，并使其他CPU核心繁忙，从而增加在特定CPU核心上重用已释放内存的机会。
4.  **内存重用:** 攻击者尝试分配新的`nft_set`或其他内核对象来重用已释放的内存。通过精心构造的数据，可以修改`nft_set`中的`ops->elemsize`等关键字段。
5.  **任意读写:**  修改`ops->elemsize`会导致`nft_set_elem_ext`计算出错误的内存地址，最终允许攻击者执行任意内核内存读写操作。
6.  **权限提升:** 攻击者可以使用任意内核内存读写操作来修改进程的凭据（credentials），从而获得root权限。

**项目地址:** [PIDAN-HEIDASHUAI/CVE-2023-32233](https://github.com/PIDAN-HEIDASHUAI/CVE-2023-32233)

**漏洞详情:** [CVE-2023-32233](https://nvd.nist.gov/vuln/detail/CVE-2023-32233)