## CVE-2016-5195 Dirty COW

**漏洞编号:** CVE-2016-5195

**漏洞类型:** 权限提升

**影响应用:** Linux Kernel

**危害等级:** 高危，本地用户可获得root权限

**影响版本:** Linux kernel 2.x through 4.x before 4.8.3

**利用条件:** 本地用户权限，目标系统kernel版本在受影响范围内

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2016-5195，又名Dirty COW，是Linux内核中mm/gup.c文件存在的一个竞争条件漏洞。该漏洞允许本地用户利用写时复制（COW）功能的错误处理，写入只读存储器映射，从而获得提升的权限。

**有效性：**

根据漏洞库信息和搜索引擎结果，该漏洞在野外已被利用，并且存在多个公开的POC代码。提供的C代码是一个相对完整的POC，其目标是通过利用copy-on-write机制的race condition来修改vdso的内存区域，从而执行payload，达到权限提升的目的。因此，提供的POC代码具有有效性。

**投毒风险：**

分析提供的C代码，主要功能是：

1.  获取vdso地址。
2.  保存原始vdso内容用于恢复。
3.  构建patch，将恶意payload写入vdso。
4.  利用ptrace修改vdso内存。
5.  通过多线程race condition触发漏洞。
6.  恢复原始vdso内容。

代码中存在调用外部payload.h的行为，但具体`payload.h`内容未知. `payload.h`若包含恶意代码，会带来投毒风险。
代码中memcpy函数，strncpy函数的错误使用,会导致内存错误。
假设`payload.h`文件是可靠的，此代码仓库本身存在的投毒概率较低，但仍需人工审计。
投毒风险评估：10%。

**利用方式：**

1.  **查找vdso：**  利用`getauxval(AT_SYSINFO_EHDR)`函数查找vdso的地址。
2.  **构建Payload：**  构造用于替换vdso中clock_gettime函数的恶意payload。Payload会被patch进IP地址和端口，用于反弹shell或者执行其他恶意操作。
3.  **Patch Payload：**  使用payload替换掉vdso中clock_gettime函数起始的若干字节。这通常需要修改机器码。
4.  **制造竞争条件：**  通过mmap创建一个只读的内存映射，然后使用多线程并发地对该内存映射执行`madvise(MADV_DONTNEED)`和`pwrite`操作。`madvise(MADV_DONTNEED)`会触发写时复制，而`pwrite`则尝试写入只读内存。
5.  **利用Race Condition：**  如果`pwrite`操作在写时复制完成之前执行，那么就可以绕过只读保护，直接修改物理内存页。由于多个进程共享同一个vdso，因此修改vdso会影响到所有进程。
6.  **权限提升：**  当其他进程调用`clock_gettime`函数时，会执行被替换的payload，从而获得更高的权限。

总结：攻击者首先需要编译和执行POC代码，该代码利用多线程竞争条件，尝试修改只读内存区域（通常是`/etc/passwd`文件或者VDSO）。成功利用后，攻击者可以通过修改系统文件或劫持函数调用来提升权限。

**项目地址:** [scumjr/dirtycow-vdso](https://github.com/scumjr/dirtycow-vdso)

**漏洞详情:** [CVE-2016-5195](https://nvd.nist.gov/vuln/detail/CVE-2016-5195)