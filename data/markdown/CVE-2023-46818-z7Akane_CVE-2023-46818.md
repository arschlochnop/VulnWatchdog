## CVE-2023-46818 - ISPConfig PHP 代码注入

**漏洞编号:** CVE-2023-46818

**漏洞类型:** PHP 代码注入

**影响应用:** ISPConfig

**危害等级:** 高危，可能导致远程代码执行

**影响版本:** <= 3.2.11

**利用条件:** 需要管理员权限，`admin_allow_langedit` 必须启用

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2023-46818 存在于 ISPConfig 3.2.11p1 之前的版本中。如果管理员启用了 `admin_allow_langedit` 选项，则攻击者（具有管理员权限）可以通过语言文件编辑器注入 PHP 代码。 

**漏洞利用方式：**

1.  **身份验证：** 首先，攻击者需要使用有效的管理员凭据登录 ISPConfig 控制面板。
2.  **CSRF 令牌获取：** 利用 `language_edit.php` 页面，获取 CSRF ID 和 Key。POC脚本模拟了此过程，构造包含`lang`，`module`，`lang_file`参数的POST请求。`lang_file`参数是随机生成的，目的是创建一个新的语言文件。
3.  **代码注入：** 攻击者通过修改语言文件，将恶意的 PHP 代码注入到 `records[\]` 参数中。POC脚本中，注入的代码会将一个简单的webshell写入到 `/admin/sh.php`。
4.  **Webshell 访问：** 成功注入代码后，攻击者可以通过访问 `/admin/sh.php` 文件来执行任意命令。POC脚本通过GET请求，将需要执行的命令base64编码后放在HTTP Header `C`中传递给webshell。webshell执行命令，并将结果返回。脚本通过正则表达式提取命令执行结果。
5. **有效性：**根据漏洞库信息和搜索引擎结果，该漏洞存在且已公开。提供的POC代码也验证了该漏洞的可利用性。

**投毒风险分析：**

代码中存在投毒的风险较低，约5%。主要考虑以下几点：

*   **Base64 编码的 Payload：** Payload 使用 Base64 编码，方便审计人员进行检查。虽然攻击者可以替换Payload为恶意的代码，但是这种修改很容易被发现。
*  **对ISPConfig目录的写入操作:** 代码在`/admin/` 目录下写入webshell文件`sh.php`。该行为属于攻击行为，会触发安全警报。
*  **公开的利用方式：** 漏洞利用方式比较直接，与其他搜索结果和漏洞描述一致。没有发现隐藏的、非预期的行为。

虽然存在一些微小的风险，但综合来看，该 POC 的主要目的是验证漏洞，而不是进行恶意投毒。攻击者可以修改利用脚本来包含恶意载荷，但这不属于原始代码的投毒行为。

**项目地址:** [z7Akane/CVE-2023-46818](https://github.com/z7Akane/CVE-2023-46818)

**漏洞详情:** [CVE-2023-46818](https://nvd.nist.gov/vuln/detail/CVE-2023-46818)