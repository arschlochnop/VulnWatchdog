## CVE-2024-4577 PHP-CGI Argument Injection

**漏洞编号:** CVE-2024-4577

**漏洞类型:** 远程代码执行

**影响应用:** PHP

**危害等级:** 高危，允许未经身份验证的攻击者在Windows服务器上执行任意代码

**影响版本:** < 8.1.29, < 8.2.20, < 8.3.8 (在Windows上运行，并启用Best-Fit策略的code page的CGI模式)

**利用条件:** PHP以CGI模式在Windows上运行，并且启用了使用"Best Fit"策略的代码页。需要网络访问。

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2024-4577是一个存在于PHP中的远程代码执行漏洞。当PHP在Windows上以CGI模式运行时，如果系统配置为使用某些代码页，Windows可能会使用“Best-Fit”行为来替换传递给Win32 API函数的命令行中的字符。PHP CGI模块可能会将这些字符错误地解释为PHP选项，这可能允许恶意用户将选项传递给正在运行的PHP二进制文件，从而泄露脚本源代码或执行服务器上的任意PHP代码。

**利用方式：**

1.  攻击者发送特制的HTTP请求，其中包含恶意构造的查询字符串。该查询字符串包含被Windows "Best-Fit"代码页转换解释为PHP配置选项的字符。
2.  服务器接收到请求后，会将查询字符串传递给PHP CGI解释器。
3.  PHP CGI解释器错误地将恶意构造的字符串解析为PHP选项，如`allow_url_include`和`auto_prepend_file`。
4.  通过设置这些选项，攻击者可以包含远程文件，从而执行任意PHP代码。

**POC分析：**

提供的Python脚本`cve-2024-4577.py`实现了利用此漏洞的POC。脚本接受目标URL和可选的自定义payload作为参数。

*   如果未提供自定义payload，脚本将尝试执行`phpinfo()`函数以验证漏洞是否存在。
*   如果提供了自定义payload，脚本将使用该payload来执行任意PHP代码。Readme文件提供了使用示例。
*   脚本通过构造包含特殊字符的URL，并向其发送POST请求来利用漏洞。特殊字符会被Windows的Best-Fit机制转换成PHP可识别的配置指令，最终执行攻击者注入的PHP代码。

**投毒风险分析：**

通过对提供的POC代码进行分析，没有发现作者隐藏的恶意代码或后门。该脚本的功能是按照预期执行漏洞利用，没有额外的、未声明的行为。因此，投毒风险评估为0%。

**项目地址:** [aaddmin1122345/cve-2024-4577](https://github.com/aaddmin1122345/cve-2024-4577)

**漏洞详情:** [CVE-2024-4577](https://nvd.nist.gov/vuln/detail/CVE-2024-4577)