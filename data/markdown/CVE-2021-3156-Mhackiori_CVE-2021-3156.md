## CVE-2021-3156 (Baron Samedit)

**漏洞编号:** CVE-2021-3156

**漏洞类型:** 堆缓冲区溢出

**影响应用:** Sudo

**危害等级:** 高危，本地权限提升至root

**影响版本:** < 1.9.5p2

**利用条件:** 本地用户可执行sudo命令（即使没有sudo权限）

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-3156 (Baron Samedit) 是Sudo 1.9.5p2之前版本中的一个堆缓冲区溢出漏洞。该漏洞允许任何本地用户利用'sudoedit -s'命令以及以单个反斜杠字符结尾的命令行参数，将权限提升为root。

**有效性：**
提供的PoC代码库包含利用此漏洞所需的必要文件，包括Makefile和expolit.c，以及描述利用方法的README.md。它使用环境变量进行内存填充，以便进行堆风水，覆盖`service_user`对象的名称，从而执行恶意代码。因此，提供的PoC**有效**。

**投毒风险：**
该代码库结构清晰，主要包含漏洞利用相关的代码。其中 `libnss_XXX/XXX.c` 和 `libnss_XXX/XXX.so.2` 存在潜在的风险。恶意作者可能在此处嵌入后门代码，例如反向shell等。尽管主要的利用逻辑是利用堆溢出，但共享库的编译和加载过程存在植入恶意代码的机会。因此，我给出一个较低的投毒风险评估，约为10%。

**利用方式：**
1.  利用`sudoedit -s` 以及一个以单个反斜杠结尾的命令行参数触发漏洞。
2.  该漏洞是一个堆缓冲区溢出，允许攻击者覆盖堆上的内存。
3.  PoC通过环境变量填充内存，进行堆风水（Heap Feng Shui），精心布局堆内存。
4.  利用溢出覆盖`service_user`结构体的`name`字段，该字段用于加载NSS(Name Service Switch)库。
5.  通过覆盖`name`字段，将NSS库的加载路径修改为攻击者控制的恶意库。
6.  当sudo尝试加载NSS库时，实际上加载的是恶意库，恶意库中的代码被执行。
7.  恶意库中的代码通常包含一个提权的shell或者其他恶意操作，从而实现权限提升。

**项目地址:** [Mhackiori/CVE-2021-3156](https://github.com/Mhackiori/CVE-2021-3156)

**漏洞详情:** [CVE-2021-3156](https://nvd.nist.gov/vuln/detail/CVE-2021-3156)