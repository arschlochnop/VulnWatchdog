## CVE-2022-46169-Cacti-命令注入

**漏洞编号:** CVE-2022-46169

**漏洞类型:** 命令注入

**影响应用:** Cacti

**危害等级:** 高危，允许未经身份验证的攻击者执行任意命令

**影响版本:** < 1.2.23

**利用条件:** 需要Cacti实例运行，并且存在`poller_item`记录，其`action`类型为`POLLER_ACTION_SCRIPT_PHP` (2)

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2022-46169 是 Cacti 1.2.23 之前版本中的一个未经身份验证的命令注入漏洞。该漏洞位于 `remote_agent.php` 文件中。攻击者可以通过设置 `X-Forwarded-For` HTTP 头绕过身份验证，然后利用 `polldata` 操作，将恶意命令注入到 `poller_id` 参数中，导致服务器执行任意命令。  

**有效性评估：**

根据漏洞库信息、搜索引擎结果和提供的漏洞利用代码，此漏洞利用的**有效性高**。漏洞库和搜索引擎结果都确认了该漏洞的存在和严重性，并且已经有公开的漏洞利用代码可用。提供的 Python 脚本 `CVE-2022-46169.py` 实现了漏洞利用过程，包括绕过身份验证和注入命令。  

**投毒风险分析：**

对提供的 Python 脚本进行分析，该脚本的主要功能是利用 CVE-2022-46169 漏洞，不存在明显的恶意代码或后门。但是，任何利用代码都存在被修改的风险，攻击者可能会在代码中添加恶意功能。考虑到代码量较少，逻辑清晰，用户可以容易地进行审查，因此，**投毒风险较低，估计为5%**。这个风险主要来自使用者没有进行代码审计就直接使用，例如添加反弹shell等恶意操作。

**利用方式：**

1.  **身份验证绕过：** 攻击者发送带有 `X-Forwarded-For` 头的 HTTP 请求到 `remote_agent.php`，伪造客户端 IP 地址，绕过身份验证。
2.  **命令注入：** 攻击者构造包含恶意命令的 `poller_id` 参数，通过 `polldata` 操作传递给 `remote_agent.php`。
3.  **命令执行：** Cacti 服务器在处理 `polldata` 操作时，会将 `poller_id` 参数中的恶意命令注入到 `proc_open` 函数中，导致服务器执行任意命令。

**POC利用方式详细过程:**

1.  运行 `CVE-2022-46169.py` 脚本，指定目标 Cacti 实例的 URL 和要执行的命令。
2.  脚本会遍历一系列 `host_id`，并为每个 `host_id` 构建一个包含恶意 `poller_id` 参数的 HTTP GET 请求。
3.  脚本设置 `X-Forwarded-For` 头，伪造客户端 IP 地址，绕过身份验证。
4.  脚本发送 HTTP 请求到 `remote_agent.php`。
5.  如果目标 Cacti 实例存在具有 `POLLER_ACTION_SCRIPT_PHP` 操作类型的 `poller_item`，并且成功绕过身份验证，则服务器将执行 `poller_id` 参数中的恶意命令。
6.  脚本会检查响应中是否包含 "proc" 字符串，以确认命令是否已成功执行。
7.  如果命令执行成功，脚本将输出成功的消息，并显示成功利用的 `host_id`。

**项目地址:** [antisecc/CVE-2022-46169](https://github.com/antisecc/CVE-2022-46169)

**漏洞详情:** [CVE-2022-46169](https://nvd.nist.gov/vuln/detail/CVE-2022-46169)