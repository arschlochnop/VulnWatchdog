## CVE-2024-27398-Linux Kernel Bluetooth sco_sock_timeout UAF

**漏洞编号:** CVE-2024-27398

**漏洞类型:** Use-After-Free

**影响应用:** Linux Kernel

**危害等级:** 高危，可能导致内核崩溃或任意代码执行

**影响版本:** Linux kernel versions prior to 6.9 are susceptible, specifically those containing the vulnerable code in net/bluetooth/sco.c

**利用条件:** 目标系统需开启蓝牙功能，且运行受影响的内核版本。

**POC 可用性:** 是

**投毒风险:** 99%

## 详情

CVE-2024-27398 是 Linux 内核蓝牙子系统中 sco_sock_timeout 函数中的一个 use-after-free 漏洞。

**1. 有效性评估：**

根据提供的漏洞信息、搜索结果和漏洞利用代码，可以判断该POC代码是有效的。漏洞库信息中的KASAN报告明确指出了在sco_sock_timeout函数中发生了slab-use-after-free的错误，并提供了详细的调用栈信息。POC代码的README.md文件也包含了GDB调试断点信息和导致崩溃的汇编代码片段以及dmesg输出，确认了漏洞的存在。primitive-test-poc.c 中的代码尝试利用竞态条件来触发UAF。通过socket创建,mmap,pthread多线程来触发UAF.

**2. 投毒风险评估：**

POC代码存在很高的投毒风险（99%）。主要原因是：

*   **利用内核漏洞：** 任何能够触发内核崩溃或任意代码执行的漏洞都具有潜在的投毒风险。攻击者可以修改POC代码，使其在目标系统上执行恶意操作，例如植入后门、窃取敏感数据或进行提权。
*   **替换目标地址：** primitive-test-poc.c 允许替换`TARGET_ADDR`，如果该地址被替换为攻击者控制的地址，存在劫持控制流的风险，从而导致恶意代码执行
*   **竞态条件：**  POC利用竞态条件，使得利用结果具有不确定性。恶意攻击者可能精心构造数据，从而达到提权或者其它目的。

**3. 利用方式分析：**

该漏洞的利用方式涉及到以下几个步骤：

1.  **建立SCO连接：** 攻击者首先需要通过蓝牙协议建立SCO连接。
2.  **触发定时器：** 在SCO连接建立后，会设置一个定时器，用于判断SCO连接是否超时。
3.  **释放socket：** 在定时器运行期间，释放SCO socket。由于定时器回调函数sco_sock_timeout仍然会尝试访问已释放的socket，从而导致use-after-free。
4. **Mmap:** 使用mmap映射一个区域，用于后续的利用
5. **线程竞争:** 创建多个线程，线程1使用setsockopt尝试修改socket选项，线程2和线程3尝试建立SCO连接。利用线程竞争在sock被释放后仍然可以访问.
6.  **利用UAF：** 攻击者可以通过控制释放后的内存内容，例如通过slab着色，将内存重新分配给其他对象，从而实现在sco_sock_timeout函数中访问到恶意构造的数据，最终实现任意代码执行。
    
4. **优先级排序:** 搜索引擎结果验证漏洞的存在,漏洞利用代码验证了漏洞的可行性，并展示了利用的初步方法，漏洞库信息从原理上解释漏洞




**项目地址:** [secunnix/CVE-2024-27398](https://github.com/secunnix/CVE-2024-27398)

**漏洞详情:** [CVE-2024-27398](https://nvd.nist.gov/vuln/detail/CVE-2024-27398)