## CVE-2019-5736-runc容器逃逸

**漏洞编号:** CVE-2019-5736

**漏洞类型:** 容器逃逸

**影响应用:** runc

**危害等级:** 高危，可获取主机root权限

**影响版本:** <= 1.0-rc6

**利用条件:** 需要能够以root身份在受影响的容器内执行命令，或者能够写入现有容器的文件系统

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2019-5736 漏洞允许攻击者通过利用文件描述符处理不当的问题，覆盖主机上的 runc 二进制文件，从而获得主机 root 访问权限。漏洞利用过程如下：

1.  攻击者需要在一个存在漏洞的 Docker 环境中运行一个恶意的容器，或者已经具有对现有容器的写权限。
2.  Dockerfile 首先更新并安装构建 libseccomp 所需的依赖项，然后下载 libseccomp 的源代码。
3.  Dockerfile 修改了 libseccomp-2.3.1/src/api.c 文件，附加了 run_at_link.c 中的代码，然后重新构建 libseccomp。
4.  Dockerfile 添加了 overwrite_runc.c 文件，并将其编译为 /overwrite_runc 二进制文件。
5.  Dockerfile 添加了 new_runc 文件，该文件用于替换宿主机上的 runc 二进制文件，其中包含运行挖矿程序的恶意代码。
6.  Dockerfile 创建了一个指向 /proc/self/exe 的符号链接 /entrypoint，并将其设置为容器的入口点。
7.  当容器启动时，/entrypoint（即 /proc/self/exe，也就是 runc 进程）会被调用。
8.  在容器内部执行的 overwrite_runc 程序利用 /proc/self/exe 访问 runc 二进制文件，并用恶意脚本 new_runc 的内容覆盖它。
9.  当 Docker 容器关闭时，被覆盖的 runc 二进制文件会被执行，从而启动一个后台的 bitcoin 挖矿进程。

**有效性评估：** 根据漏洞描述和公开的PoC代码，该漏洞利用的有效性较高，因为已经有公开可用的exp，并且被多个安全厂商证实。

**投毒风险分析：** 代码主要目的是利用漏洞在宿主机上运行挖矿程序。虽然核心是利用该漏洞进行提权，但随后执行了挖矿脚本，使得被攻击主机的资源被消耗。`new_runc`脚本中，包含python挖矿程序，有投毒嫌疑，占比10%，因为攻击利用该漏洞进行加密货币挖掘。

**利用方式总结：**

*   攻击者首先获得在受影响的 Docker 环境中创建容器的能力。
*   然后，攻击者构建一个包含恶意代码的 Docker 镜像。
*   当创建的容器启动时，它会覆盖主机上的 runc 二进制文件。
*   当下一次运行任何容器时，将以 root 权限执行攻击者的恶意代码。

**项目地址:** [epsteina16/Docker-Escape-Miner](https://github.com/epsteina16/Docker-Escape-Miner)

**漏洞详情:** [CVE-2019-5736](https://nvd.nist.gov/vuln/detail/CVE-2019-5736)