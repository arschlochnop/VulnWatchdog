## CVE-2024-4040 CrushFTP SSTI & LFI

**漏洞编号:** CVE-2024-4040

**漏洞类型:** 服务器端模板注入 (SSTI) 和本地文件包含 (LFI)

**影响应用:** CrushFTP

**危害等级:** 高危，未经身份验证的远程攻击者可以读取文件系统中的文件、绕过身份验证以获得管理权限，并在服务器上执行远程代码。

**影响版本:** 所有版本 < 10.7.1 和 11.0 <= 版本 < 11.1.0

**利用条件:** 目标系统运行受影响版本的CrushFTP，且攻击者可以访问WebInterface。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-4040 是 CrushFTP 中一个严重的安全漏洞，它允许未经身份验证的远程攻击者通过服务器端模板注入 (SSTI) 和本地文件包含 (LFI) 漏洞读取文件系统中的文件，绕过身份验证以获得管理权限，并在服务器上执行远程代码。 

**有效性:**

根据漏洞库信息、搜索引擎结果和提供的漏洞利用代码（POC），该漏洞的利用是有效的。漏洞库信息明确指出该漏洞允许未经身份验证的远程攻击者执行文件读取、权限提升和远程代码执行。搜索引擎结果显示，该漏洞已在野外被利用，并提供了检测和缓解措施的相关信息。提供的POC代码包含利用该漏洞的步骤，例如生成匿名会话令牌、利用这些令牌执行SSTI以创建入口点，以及调用SSTI端点以请求目标机器上的本地资源。

**投毒风险:**

分析 POC 代码后，存在轻微的投毒风险。POC 主要功能是利用已知的漏洞，展示了如何进行 LFI 并提取会话信息。代码中可能存在一些隐蔽的风险点，例如：
1.  **未经验证的依赖项:** 代码中可能会引入未经验证的第三方库，这些库可能包含恶意代码或安全漏洞。
2.  **异常处理不当:** 代码中可能存在异常处理不当的情况，导致程序崩溃或执行意外的操作。
3.  **后门或植入:** 作者可能会在代码中植入后门，以便在将来进行恶意活动。或者，在 LFI 过程中，可能会尝试写入恶意文件到目标服务器，从而构成持久性威胁。

因此，我们认为此POC存在10%的投毒风险，主要来自潜在的隐蔽后门或者恶意代码植入，但在本次提供的代码中未发现后门。

**利用方式:**

该漏洞的利用方式可以概括为以下几个步骤：

1.  **匿名会话令牌生成:** 攻击者首先生成匿名会话令牌，以便与目标 CrushFTP 服务器建立连接。
2.  **SSTI 入口点创建:** 攻击者利用生成的会话令牌执行 SSTI，从而在服务器上创建自己的入口点。WebInterface的“zip”功能存在漏洞。
3.  **LFI 利用:** 攻击者通过调用 SSTI 入口点，可以逃逸出模板引擎的上下文，并请求目标机器上的任意本地资源。攻击者可以使用 LFI 读取敏感文件，例如 /etc/passwd 或服务器的会话文件 (sessions.obj)。
4.  **会话劫持:** 如果攻击者成功读取了会话文件 (sessions.obj)，则可以提取其他用户的会话令牌，并使用这些令牌来劫持他们的会话，从而获得更高的权限。
5.  **RCE:** 通过文件读取，获取到目标服务器的配置信息，结合 CrushFTP 已知的其他利用链，最终可以实现远程代码执行。

利用过程中可以尝试读取以下文件：
* sessions.obj (用于窃取用户会话)
* 配置文件 (用于获取敏感信息)

**修复建议:**

尽快升级到 CrushFTP 10.7.1 或 11.1.0 及更高版本。

**项目地址:** [Stuub/CVE-2024-4040-SSTI-LFI-PoC](https://github.com/Stuub/CVE-2024-4040-SSTI-LFI-PoC)

**漏洞详情:** [CVE-2024-4040](https://nvd.nist.gov/vuln/detail/CVE-2024-4040)