## CVE-2021-31956 Windows NTFS 特权提升漏洞

**漏洞编号:** CVE-2021-31956

**漏洞类型:** 特权提升

**影响应用:** Windows NTFS

**危害等级:** 高危，可导致本地提权

**影响版本:** 受影响的Windows版本详见漏洞库信息

**利用条件:** 需要在本地系统上运行恶意代码

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

根据提供的漏洞信息、搜索结果和漏洞利用代码，对CVE-2021-31956 Windows NTFS特权提升漏洞进行评估如下：

**1. 有效性：**

*   根据漏洞库信息，该漏洞影响多个Windows版本，且存在公开的POC。
*   搜索结果中包含多个关于该漏洞的分析文章，例如NCC Group的文章，以及Arctic Wolf提到该漏洞被用于Magnitude Exploit Kit。
*   提供的POC代码似乎利用了NTFS的扩展属性（EA）的某些机制，结合WNF（Windows Notification Facility），来触发内核内存破坏，从而实现提权。具体来说，代码中`NtSetEaFile`函数被用来设置恶意构造的EA，然后`NtQueryEaFile`函数被用来触发漏洞。代码中使用了堆喷射，通过创建大量的WNF状态名，在内存中占据特定区域，提高漏洞利用的成功率。`OVER_STATEDATA_LENGTH`、`OVER_EA_VALUE_LENGTH`等变量控制了溢出的长度，`TIGGER_EA_NAME`和`OVER_EA_NAME`定义了EA的名称，这些参数需要根据目标环境进行调整。

**因此，综合判断，提供的POC代码具有较高的有效性，可以利用该漏洞实现本地提权。**

**2. 投毒风险：**

*   查看POC代码，`ConsoleApplication11.cpp`。代码主要由`initNtDll()`(加载需要的ntdll函数), `tiggerLeak()`(触发漏洞)和`HeapSpray()`(进行堆喷)三个函数组成。
*   `HeapSpray()` 函数中存在可疑的 `upData` 数组, 其中的值没有被初始化, 可能会导致一些不期望的结果, 但不能确定为恶意投毒代码, 因为其行为是进行堆喷操作. `RtlFillMemory(up`这一行可能存在截断，查看完整代码。
*   总体来说，代码逻辑相对清晰，主要集中在利用NTFS EA和WNF机制触发内核漏洞。**初步评估投毒风险较低，约为10%。** 潜在的投毒方式可能存在于精心构造的溢出数据中，例如，将shellcode隐藏在看起来无害的数据中，或者利用一些不常见的API调用执行恶意操作。

**3. 利用方式：**

该漏洞的利用方式大致如下：

1.  **准备环境：** 在目标Windows系统上创建或选择一个存在的文件。
2.  **构造恶意EA：** 使用`NtSetEaFile`函数设置精心构造的NTFS扩展属性。该EA包含溢出数据，用于破坏内核内存。
3.  **触发漏洞：** 使用`NtQueryEaFile`函数查询该文件的EA，触发内核内存破坏。
4.  **堆喷射：** 使用WNF（Windows Notification Facility） API(`NtCreateWnfStateName`, `NtUpdateWnfStateData`)进行堆喷，在内存中创建大量WNF状态名，从而控制内存布局，提高漏洞利用的成功率。
5.  **提权：** 覆盖内核数据结构，将当前进程的权限提升到SYSTEM。
6.  **执行恶意代码：** 利用提升后的权限执行任意代码。

**漏洞利用的关键在于精确控制内存布局，以及构造合适的溢出数据，以便覆盖关键的内核数据结构。**

**项目地址:** [aazhuliang/CVE-2021-31956-EXP](https://github.com/aazhuliang/CVE-2021-31956-EXP)

**漏洞详情:** [CVE-2021-31956](https://nvd.nist.gov/vuln/detail/CVE-2021-31956)