## CVE-2024-3094-xz-utils供应链后门

**漏洞编号:** CVE-2024-3094

**漏洞类型:** 供应链后门

**影响应用:** xz-utils

**危害等级:** 高危，可导致未经授权的远程SSH访问

**影响版本:** 5.6.0, 5.6.1

**利用条件:** 受影响的系统需要链接到被污染的liblzma库，并且sshd使用systemd进行服务管理（在某些发行版中）。x86_64架构上更容易受到攻击。

**POC 可用性:** 是，但提供的代码是检测工具而非利用代码

**投毒风险:** 10%

## 详情

CVE-2024-3094 描述的是 xz-utils 工具中的一个供应链后门。恶意代码被嵌入到上游的 xz tarballs 中，起始于 5.6.0 版本。该后门通过复杂的混淆手段，在 liblzma 的构建过程中从伪装的测试文件中提取预构建的目标文件，并用于修改 liblzma 代码中的特定函数。这导致任何链接到该库的软件都可能受到影响。关键的利用点在于修改后的 liblzma 库可以拦截并修改与该库的数据交互。

**有效性分析：**
提供的Go代码并不是一个利用此漏洞的POC，而是一个检测工具，用于检查系统是否存在CVE-2024-3094漏洞。它主要通过检查`liblzma`库中是否存在特定的函数签名来判断是否已被感染。

**投毒风险分析：**
此代码本身是一个检测工具，主要功能是检测系统是否存在后门。代码中包含`strings.Contains(string(sigCheck), "f30f1efa554889f54c89ce5389fb81e7000000804883ec28488954241848894c2410")`用于检测是否存在恶意代码的特征码，相对安全。代码虽然会执行外部命令，例如`whereis`、`ldd`和`hexdump`，但这些命令的使用方式相对标准，注入恶意参数的风险较低。尽管如此，仍然存在一定的风险：
1.  **依赖外部命令:** 代码依赖于系统中的`whereis`、`ldd`和`hexdump`命令。如果这些命令被恶意替换，可能导致代码执行恶意操作。
2.  **路径处理:** 代码使用`strings.Fields`和`strings.Split`函数处理命令的输出，提取`liblzma`的路径。如果输出格式不符合预期，可能导致路径提取错误，甚至可能导致代码执行意外的操作。
3.  **依赖检测特征码:** 代码依赖`f30f1efa554889f54c89ce5389fb81e7000000804883ec28488954241848894c2410`特征码。如果后门代码的特征码发生变化，此检测工具将失效。

因此，综合考虑，此仓库中存在作者隐藏的投毒代码的风险较低，估计为10%。

**利用方式：**
1.  **供应链攻击：** 攻击者向 xz-utils 的源代码中注入恶意代码。
2.  **构建过程劫持：** 恶意代码在构建过程中被激活，修改 liblzma 库。
3.  **SSH后门：** 修改后的 liblzma 库在 SSH 守护进程（sshd）加载时，通过 systemd 机制劫持 SSH 身份验证过程，允许攻击者在未经授权的情况下远程访问系统。

**总而言之:** 该漏洞的核心在于通过复杂的构建过程篡改 liblzma 库，进而影响依赖该库的应用程序，特别是 SSH 服务。利用成功后，攻击者可以绕过 SSH 身份验证，实现远程代码执行。

**项目地址:** [gustavorobertux/CVE-2024-3094](https://github.com/gustavorobertux/CVE-2024-3094)

**漏洞详情:** [CVE-2024-3094](https://nvd.nist.gov/vuln/detail/CVE-2024-3094)