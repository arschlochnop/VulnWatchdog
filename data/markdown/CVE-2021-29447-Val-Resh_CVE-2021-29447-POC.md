## CVE-2021-29447 - WordPress XXE

**漏洞编号:** CVE-2021-29447

**漏洞类型:** XML 外部实体注入 (XXE)

**影响应用:** WordPress

**危害等级:** 高危，可能导致敏感文件泄露、服务器端请求伪造 (SSRF)

**影响版本:** >= 5.6.0, < 5.7.1 (PHP 8)

**利用条件:** 需要 WordPress 版本在 5.6.0 到 5.7.1 之间，运行在 PHP 8 环境下，且攻击者具有上传文件的权限（如 Author 角色）。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-29447 是一个 WordPress 的 XXE 漏洞，存在于 Media Library 的 XML 解析过程中。攻击者（需要具有上传文件的权限，如 Author 角色）可以上传包含恶意 XML 代码的文件（如修改后的 WAV 文件），利用 WordPress 使用的 ID3 库中的漏洞，触发 XXE 攻击，读取服务器上的敏感文件，或者进行服务器端请求伪造 (SSRF)。此漏洞需要 WordPress 运行在 PHP 8 环境下才会生效。

**利用方式：**
1.  **身份验证：** 使用具有上传权限的用户的用户名和密码登录 WordPress 后台。
2.  **获取 Nonce：** 从 `wp-admin/upload.php` 页面获取上传文件的 nonce 值。
3.  **生成恶意 WAV 文件：** 构造包含恶意 XML 实体声明的 WAV 文件，该 XML 实体指向攻击者控制的服务器上的 DTD 文件。DTD 文件中定义了读取本地文件的实体。
4.  **上传恶意 WAV 文件：** 将生成的恶意 WAV 文件上传到 WordPress Media Library。
5.  **服务器端 DTD：** 攻击者需要搭建一个 HTTP 服务器，用于托管 DTD 文件。
6.  **触发漏洞：**  WordPress 解析上传的 WAV 文件时，会尝试从攻击者控制的服务器加载 DTD 文件，并执行其中的 XML 实体声明，从而读取服务器上的敏感文件。
7.  **数据提取：**  读取到的数据将通过 URL 参数传递到攻击者的服务器上。

**有效性：**
提供的 POC 代码是有效的。该代码实现了上述利用流程，包括身份验证、获取 nonce、生成恶意 WAV 文件、上传文件以及搭建简易 HTTP 服务器接收数据。代码中包含了必要的步骤和参数，可以成功触发 XXE 漏洞。

**投毒风险：**
POC代码中存在一定的投毒风险。风险点在于：
1.  **网络请求：** POC代码会向指定URL发起POST和GET请求，虽然目的是利用漏洞，但如果作者在代码中加入了其他的URL地址，则可能在用户不知情的情况下，将一些敏感信息发送到作者的服务器。
2.  **文件操作：** POC代码会生成临时的payload文件，如果作者在payload生成过程中插入恶意代码，可能会在目标服务器上执行恶意操作。
3.  **DTD文件：** 攻击者需要自己搭建服务器来托管 DTD 文件，如果这个 DTD 文件被替换成了恶意文件，可能导致服务器被攻击。代码本身创建 DTD，风险相对小，但仍然存在服务器被攻击者控制的风险。

综合来看，投毒风险大约在 10% 左右。主要是脚本需要用户提供服务器IP，并且脚本本身会创建一个DTD文件，减少了恶意利用的可能性。但在服务器部署和流量劫持场景下，攻击者仍然可能利用该代码进行恶意攻击。

**项目地址:** [Val-Resh/CVE-2021-29447-POC](https://github.com/Val-Resh/CVE-2021-29447-POC)

**漏洞详情:** [CVE-2021-29447](https://nvd.nist.gov/vuln/detail/CVE-2021-29447)