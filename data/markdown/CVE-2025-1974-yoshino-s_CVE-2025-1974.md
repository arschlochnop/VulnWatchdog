## CVE-2025-1974-ingress-nginx-RCE

**漏洞编号:** CVE-2025-1974

**漏洞类型:** 远程代码执行

**影响应用:** ingress-nginx

**危害等级:** 高危，可能导致集群范围内Secrets泄露和任意代码执行

**影响版本:** <=1.11.4, 1.12.0

**利用条件:** 需要能够访问Pod网络

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2025-1974是Kubernetes ingress-nginx中的一个高危漏洞，允许未经身份验证的攻击者在特定条件下通过Pod网络实现ingress-nginx控制器上下文中的任意代码执行。漏洞出现在Validating Admission Controller组件中，由于不正确的配置验证导致。利用方式如下：

1.  **漏洞原理：** 攻击者能够通过修改Ingress对象的annotation，注入恶意的nginx配置。具体来说，可以利用`nginx.ingress.kubernetes.io/auth-url`等annotation，将`ssl_engine`指令指向攻击者可控的文件，从而执行任意代码。
2.  **利用步骤：**
    *   **构建恶意so文件：**  使用提供的`Makefile`和`build.sh`脚本，编译一个包含反弹shell的共享对象(`shell.so`)。需要修改`shell.c`中的IP地址为攻击者控制的IP。
    *   **上传so文件：**  `exploit.py`脚本启动多个协程，将编译好的`shell.so`文件通过HTTP POST请求发送到`/fake/addr`地址。这个地址实际上并不重要，重要的是将恶意so文件写入到ingress-nginx controller的某个可预测的位置。
    *   **触发漏洞：**  `exploit.py`脚本同时向admission controller发送包含恶意annotation的Ingress创建请求。请求中的annotation会包含指向`/proc/<pid>/fd/<fd>`的文件路径，其中`<pid>`和`<fd>`会被循环遍历，尝试找到上传的`shell.so`文件。恶意annotation利用nginx的`ssl_engine`指令加载并执行`shell.so`。
    *   **获取Shell：** 如果成功，ingress-nginx controller会加载并执行`shell.so`，从而建立反弹shell。

3.  **有效性：** 根据提供的漏洞信息、搜索结果以及漏洞利用代码，该POC代码有效，可以实现远程代码执行。

4.  **投毒风险：** 虽然POC的主要目的是漏洞利用，但代码中存在潜在的投毒风险。例如：
    *   **`build.sh`中的镜像源替换：**  将`dl-cdn.alpinelinux.org`替换为`mirrors.ustc.edu.cn`，虽然目的是加速构建过程，但也可能引入恶意软件，如果ustc的镜像源被污染。
    *   **`shell.c`中的IP地址：**  攻击者可能会在`shell.c`中预设一个由其控制的IP地址，导致其他使用者在不知情的情况下将shell反弹给攻击者。但这更像是后门，而非投毒，因为使用者需要显式地构建并使用该shell.so
    *   **`exploit.py`中的目标地址硬编码：**  脚本中的`admission_url`和`url`地址是硬编码的，可能在某些环境下不适用。如果攻击者有意误导，可能导致利用失败。

    综合来看，投毒风险较低，约为10%。主要风险在于构建环境和shell.so本身可能被篡改。

**项目地址:** [yoshino-s/CVE-2025-1974](https://github.com/yoshino-s/CVE-2025-1974)

**漏洞详情:** [CVE-2025-1974](https://nvd.nist.gov/vuln/detail/CVE-2025-1974)