## CVE-2023-41892 - Craft CMS Remote Code Execution

**漏洞编号:** CVE-2023-41892

**漏洞类型:** Remote Code Execution (RCE)

**影响应用:** Craft CMS

**危害等级:** Critical，未经身份验证的远程代码执行，可能导致完全控制服务器

**影响版本:** 4.0.0-RC1 to 4.4.14

**利用条件:** 目标 Craft CMS 版本在受影响范围内，且可通过 HTTP/HTTPS 访问。

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2023-41892 允许未经身份验证的攻击者在 Craft CMS 服务器上执行任意代码。利用方式涉及：

1.  **信息收集 (phpinfo)：** 首先，利用`/index.php?action=conditions/render`端点和特制的`config`参数，执行`phpinfo()`来获取服务器的配置信息，特别是`upload_tmp_dir`（临时目录）和`$_SERVER['DOCUMENT_ROOT']`（文档根目录）。`FnStream`类被利用来执行`phpinfo()`函数。
2.  **Webshell 上传 (MSL + Imagick)：** 接着，攻击者创建一个包含 PHP 代码的 MSL（Magick Scripting Language）文件，该文件会将 PHP 代码写入 webshell (`shell.php`)。此 webshell 包含执行命令的代码。该文件通过POST请求上传到`/index.php?action=conditions/render` 端点。`Imagick`类被利用来读取和写入文件。
3.  **Webshell 移动 (Imagick)：** 使用`Imagick`类移动 webshell 到 web 根目录。这个操作同样通过发送 POST 请求到 `/index.php?action=conditions/render`端点完成。
4.  **远程代码执行：** 一旦 webshell 被成功部署，攻击者就可以通过发送带有 `cmd` 参数的 HTTP 请求到 `shell.php` 来执行任意命令。
5.  **交互式 Shell：** POC 代码包含一个简单的交互式 shell，允许攻击者输入命令并查看结果。

**投毒风险分析：**

该 POC 脚本的主要功能是利用漏洞在目标服务器上创建并使用 Webshell。虽然脚本本身不包含明显的恶意或隐藏代码，但存在以下潜在的投毒风险：

*   **依赖项风险：** 脚本依赖于 `requests` 库。如果攻击者提供了一个包含恶意依赖项的 requirements.txt 文件，或者诱导用户从非官方源安装 `requests`，则可能引入恶意代码。
*   **Webshell 利用风险：** 即使脚本本身没有投毒，攻击者也可能在成功部署 Webshell 后，通过 Webshell 上传和执行其他恶意脚本，例如后门、恶意软件等。
*   **配置信息泄露：**脚本尝试通过phpinfo函数获取配置信息，有概率会泄露服务器的敏感信息，可能被攻击者利用。
*  **代码可读性较差:** 代码风格和错误处理较为简单，缺少代码注释，可能隐藏恶意逻辑。

综上所述，该 POC 脚本的投毒风险较低，但不能完全排除。风险主要来自依赖项和 Webshell 的潜在滥用。


**项目地址:** [0xfalafel/CraftCMS_CVE-2023-41892](https://github.com/0xfalafel/CraftCMS_CVE-2023-41892)

**漏洞详情:** [CVE-2023-41892](https://nvd.nist.gov/vuln/detail/CVE-2023-41892)