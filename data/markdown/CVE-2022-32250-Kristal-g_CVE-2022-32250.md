## CVE-2022-32250 - Linux Kernel Use-After-Free in Netfilter

**漏洞编号:** CVE-2022-32250

**漏洞类型:** Use-After-Free

**影响应用:** Linux Kernel

**危害等级:** 高危，本地提权至root

**影响版本:** <= 5.18.1

**利用条件:** 需要创建 user/net namespaces 的能力。非容器化的 Red Hat Enterprise Linux 8 受影响。

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2022-32250 存在于 Linux kernel 的 net/netfilter/nf_tables_api.c 文件中。该漏洞是一个 Use-After-Free 漏洞，由于不正确的 NFT_STATEFUL_EXPR 检查导致。本地用户如果能够创建 user/net 命名空间，则可以利用此漏洞将权限提升到 root。

**利用方式：**

1.  漏洞利用代码（exploit.c）使用 libmnl 和 libnftnl 库与 Netfilter 子系统交互，构建和发送 Netlink 消息。
2.  该漏洞利用代码包含了一些必要的头文件，如 linux/netlink.h、linux/netfilter.h 和 libmnl/libmnl.h 等。
3.  利用代码定义了一些常量，比如内存分配相关的 KMALLOC_64_OBJS_PER_SLAB 和 KMALLOC_96_OBJS_PER_SLAB，以及内核地址偏移，用于在特定版本的内核上进行利用。
4.  该漏洞利用程序使用一系列 Netfilter 操作来触发 Use-After-Free 漏洞，并随后利用该漏洞获得 root 权限。
5.  漏洞利用可能涉及创建 nf_tables 的 table, set, rule, chain 等对象，然后通过特定的操作序列触发 UAF。

**有效性：**

根据漏洞描述和搜索结果，以及漏洞利用代码的存在，可以判断提供的 POC 代码是有效的。理论上，该 POC 可以在受影响的 Linux 内核版本上实现本地提权。

**投毒风险：**

从提供的代码来看，大部分代码是用于漏洞利用，但由于是二进制安全漏洞，攻击者可以精心构造内核地址，有通过修改内核地址的方式植入后门代码的可能性。因此，判断存在5%的投毒风险。主要风险点包括：

*   内核地址硬编码：利用代码包含内核地址偏移 (offset_*)，如果这些偏移量被恶意修改指向其他内核函数或数据，则可能导致意外的内核行为。
*   利用流程篡改：如果构建 Netfilter 规则和操作的顺序被修改，可能会触发其他漏洞或导致系统崩溃。
*   ROP链篡改: 可能会替换ROP链中的指令,以实现恶意目的

尽管存在这些风险，但从代码整体来看，主要是利用已知的 UAF 漏洞，而非故意引入新的恶意代码。因此，投毒风险较低。

**项目地址:** [Kristal-g/CVE-2022-32250](https://github.com/Kristal-g/CVE-2022-32250)

**漏洞详情:** [CVE-2022-32250](https://nvd.nist.gov/vuln/detail/CVE-2022-32250)