## CVE-2019-10149 - Exim deliver_message() Remote Command Execution

**漏洞编号:** CVE-2019-10149

**漏洞类型:** 远程代码执行

**影响应用:** Exim

**危害等级:** 高危，可导致远程代码执行和系统完全控制

**影响版本:** 4.87 to 4.91 (inclusive)

**利用条件:** 目标系统运行受影响版本的Exim，且攻击者能够通过网络连接到SMTP端口（通常是25端口）。配置不当，如允许任意relay，会降低利用难度。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2019-10149是Exim邮件传输代理（MTA）中的一个远程命令执行漏洞。该漏洞源于`deliver_message()`函数中对接收者地址的不正确验证。攻击者可以通过构造包含恶意命令的特殊邮件，利用该漏洞在目标服务器上执行任意代码。

**有效性分析：**

根据漏洞信息、搜索结果和提供的漏洞利用代码，该漏洞利用是有效的。漏洞库信息和搜索结果都表明这是一个已知的、被广泛讨论和利用的漏洞。漏洞利用代码提供了详细的利用步骤，包括：

1.  安装受影响版本的Exim（4.87-4.91）。
2.  修改Exim配置以允许relay（简化利用，否则需要等待7天）。
3.  使用netcat (nc) 连接到目标Exim服务器的25端口。
4.  通过SMTP协议发送特制的邮件，其中接收者地址包含要执行的命令（hex编码）。
5.  发送DATA命令和后续数据，触发漏洞。

**投毒风险分析：**

提供的漏洞利用代码中存在一定的投毒风险，但风险较低（约10%）。

主要风险点在于`RemoteConnection.sh`脚本。该脚本的功能是建立一个反向shell，将目标服务器上的`/tmp/1`文件的内容通过`nc`命令发送到攻击者的IP地址和端口。潜在的投毒方式可能包括：

*   **替换`/tmp/1`的内容：** 攻击者可以将恶意代码写入`/tmp/1`文件，并通过反向shell在攻击者机器上执行。
*   **`RemoteConnection.sh`本身的恶意代码：** 脚本可能包含一些隐藏的后门或恶意操作，例如收集系统信息、安装rootkit等。但这个可能性较低，因为脚本相对简单且功能明确。
*   **依赖攻击者服务器的风险：** 脚本依赖于从攻击者的服务器下载`RemoteConnection.sh`，如果攻击者控制的服务器被攻陷，或者攻击者修改了`RemoteConnection.sh`脚本的内容，可能会导致受害者执行恶意代码。

漏洞利用仓库中安装的Exim版本以及对`/usr/exim/configure`文件的修改，是为了简化利用流程，使其更容易被利用。这些修改本身不是投毒代码，但降低了利用门槛，可能导致漏洞被更广泛地利用。

**利用方式总结：**

1.  **目标环境准备：** 确保目标服务器运行着受影响版本的Exim（4.87-4.91）。
2.  **网络连接：** 攻击者需要能够通过网络连接到目标服务器的25端口。
3.  **Payload构造：** 攻击者需要将要执行的命令转换为十六进制编码，并将其嵌入到SMTP `RCPT TO` 命令的接收者地址中，格式为 `<${run{hex_encoded_command}}@localhost>`。
4.  **SMTP交互：** 攻击者使用SMTP协议与目标服务器进行交互，发送`HELO`、`MAIL FROM`、`RCPT TO` 和 `DATA` 等命令，触发漏洞。
5.  **代码执行：** 漏洞触发后，Exim会执行嵌入在接收者地址中的命令，攻击者从而获得对目标服务器的控制权。

**项目地址:** [hyim0810/CVE-2019-10149](https://github.com/hyim0810/CVE-2019-10149)

**漏洞详情:** [CVE-2019-10149](https://nvd.nist.gov/vuln/detail/CVE-2019-10149)