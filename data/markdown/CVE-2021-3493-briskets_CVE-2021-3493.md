## CVE-2021-3493 - Ubuntu OverlayFS 本地提权

**漏洞编号:** CVE-2021-3493

**漏洞类型:** 本地提权

**影响应用:** Linux Kernel (Ubuntu)

**危害等级:** 高危，可导致普通用户权限提升至root权限

**影响版本:** Ubuntu kernel versions: < 5.8.0-50.56 (5.8 kernel), < 5.4.0-72.80 (5.4 kernel), < 4.15.0-142.146 (4.15 kernel), < 4.4.0-209.241 (4.4 kernel)

**利用条件:** 需要在存在漏洞的Ubuntu内核版本上，并且允许非特权用户挂载overlayfs

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2021-3493 漏洞是由于 Linux 内核的 overlayfs 实现没有正确验证用户命名空间中底层文件系统上文件 capabilities 的设置。由于 Ubuntu 内核中存在允许非特权 overlay 挂载的补丁，攻击者可以利用此漏洞获得提升的权限。

**利用方式：**
1.  漏洞利用代码首先创建必要的目录结构 (ovlcap/work, ovlcap/lower, ovlcap/upper, ovlcap/merge)。
2.  创建一个新的用户命名空间和挂载命名空间。
3.  在新的用户命名空间中，将当前用户的 UID 和 GID 映射到 root 用户。
4.  使用 overlayfs 将 lowerdir (ovlcap/lower), upperdir (ovlcap/upper) 和 workdir (ovlcap/work) 挂载到 mergedir (ovlcap/merge)。
5.  复制自身 (exploit 程序) 到 mergedir/magic，并设置 security.capability 扩展属性为 all+ep，赋予该文件 capabilities。
6.  执行 mergedir/magic，由于 capabilities 的设置，该程序会以 root 权限执行。
7.  最后，执行 upperdir/magic，启动一个 root shell。

**有效性：**
提供的POC代码是有效的，能够利用 CVE-2021-3493 漏洞在受影响的 Ubuntu 系统上实现本地提权。

**投毒风险：**
该POC代码的主要功能是利用漏洞进行提权，但仍然存在潜在的投毒风险。比如作者可能在编译和运行前添加一些恶意代码，例如：

1.  **后门植入：** 在提权成功后，植入一个后门程序，允许攻击者远程访问系统。
2.  **数据窃取：** 在提权过程中，窃取用户的敏感数据。
3.  **破坏系统：** 在提权失败或者成功后，破坏系统文件或者配置。

考虑到代码相对简短且功能明确，评估投毒风险为5%。用户需要仔细审查代码，并在安全的环境中进行测试。

**项目地址:** [briskets/CVE-2021-3493](https://github.com/briskets/CVE-2021-3493)

**漏洞详情:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)