## CVE-2024-4040 CrushFTP服务器端模板注入漏洞

**漏洞编号:** CVE-2024-4040

**漏洞类型:** 服务器端模板注入 (SSTI)

**影响应用:** CrushFTP

**危害等级:** 极高，可能导致任意文件读取、身份验证绕过和远程代码执行

**影响版本:** 10.0 <= version < 10.7.1 和 11.0 <= version < 11.1.0

**利用条件:** 目标CrushFTP实例可网络访问，且版本符合漏洞影响范围

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-4040 是一个存在于CrushFTP中的服务器端模板注入(SSTI)漏洞。未经身份验证的远程攻击者可以利用此漏洞读取文件系统中的任意文件（绕过VFS沙箱），绕过身份验证以获得管理员权限，并在服务器上执行远程代码。 

**有效性分析：**
根据漏洞库信息、搜索引擎结果和提供的漏洞利用代码，该漏洞的PoC代码是有效的。

*   漏洞库信息明确指出这是一个可被利用的漏洞，且有公开的PoC。
*   搜索引擎结果显示，该漏洞已经被广泛讨论，并且有被利用的案例。
*   提供的PoC代码可以读取`sessions.obj`文件，提取session信息，并尝试使用提取的token进行身份验证。根据代码逻辑，成功验证后能够获取用户名，进一步佐证漏洞利用的有效性。

**投毒风险分析：**
分析PoC代码以及仓库其他文件，判断是否存在投毒风险：

*   `CVE-2024-4040.py`: PoC主体代码，主要功能是利用SSTI读取`sessions.obj`，提取Token并验证，没有发现明显的恶意代码。代码逻辑相对清晰，主要为利用漏洞读取信息和验证Token。
*   `README.md`: 包含漏洞描述、利用方法和免责声明，未发现异常。

风险点分析：

1.  **依赖风险**：脚本依赖`requests`库，如果requests库被篡改，可能引入安全风险，但这不是作者引入的，故不计入投毒。
2.  **远程代码执行**：虽然PoC本身没有直接包含后门代码，但通过SSTI最终可以实现远程代码执行。攻击者如果将此PoC与进一步的利用手段结合，可以上传恶意JAR包执行任意命令。但这并非PoC直接投毒，而是漏洞本身的危害。
3. **免责声明:** README.md文件明确声明该代码仅用于教育和测试目的，但免责声明并不能完全消除滥用风险. 

综合来看，直接投毒的可能性较低，但存在被恶意使用的风险，以及使用第三方库可能引入的间接风险。

**利用方式分析：**

1.  **获取Cookie:** 脚本首先尝试获取CrushFTP实例的`currentAuth` cookie，通过访问目标URL建立Session。
2.  **读取 sessions.obj:** 利用服务器端模板注入漏洞，通过构造特殊的URL，读取服务器上的`sessions.obj`文件。这个文件包含用户的会话信息，包括加密的token。
3.  **提取Token:** 使用正则表达式从读取到的`sessions.obj`内容中提取有效的Token。
4.  **验证Token:** 使用提取的Token构造请求，访问`/WebInterface/function/`接口，尝试获取用户信息，验证Token的有效性。
5.  **持续监听:** PoC会持续监听sessions.obj文件，一旦文件内容发生变化，就提取新的Token并进行验证，以便在有新用户登录时立即获取其Token。

总的来说，该漏洞利用方式是利用SSTI读取敏感文件，提取用户会话信息，然后利用这些信息进行身份验证绕过。

**项目地址:** [Mohammaddvd/CVE-2024-4040](https://github.com/Mohammaddvd/CVE-2024-4040)

**漏洞详情:** [CVE-2024-4040](https://nvd.nist.gov/vuln/detail/CVE-2024-4040)