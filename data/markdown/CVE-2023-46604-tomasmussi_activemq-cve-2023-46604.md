## CVE-2023-46604-Apache ActiveMQ-远程代码执行

**漏洞编号:** CVE-2023-46604

**漏洞类型:** 远程代码执行

**影响应用:** Apache ActiveMQ

**危害等级:** 高危，可能导致完全控制 ActiveMQ Broker 或 Client

**影响版本:** 5.15.16 之前版本, 5.16.7 之前版本, 5.17.6 之前版本, 5.18.3 之前版本

**利用条件:** 需要网络访问 ActiveMQ Broker 或 Client 的 OpenWire 协议端口 (默认 61616)

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2023-46604 是 Apache ActiveMQ 中 Java OpenWire 协议编组器中的一个远程代码执行漏洞。该漏洞允许具有网络访问权限的远程攻击者通过操纵 OpenWire 协议中的序列化类类型来运行任意 shell 命令，从而导致客户端或 Broker 实例化 classpath 上的任何类。

**漏洞利用方式：**

该漏洞利用 OpenWire 协议在反序列化对象时存在缺陷。攻击者可以发送特制的 OpenWire 消息，其中包含恶意的序列化对象，该对象会指示 ActiveMQ 实例（Broker 或 Client）实例化 classpath 上的任意类。通过实例化 `org.springframework.context.support.ClassPathXmlApplicationContext` 类，并提供一个 URL 作为构造函数参数，可以加载恶意的 Spring Bean 定义 XML 文件，从而执行任意代码。

**POC 代码分析：**

提供的 POC 代码包含两个部分：

1.  **Python 脚本 (`client_exploit.py`):**  此脚本模拟 ActiveMQ 客户端，连接到恶意的 ActiveMQ Broker。它构造并发送包含恶意序列化数据的 OpenWire 消息，以触发反序列化漏洞。
2.  **Java 代码 (`activemq-exploit`):**  此代码包含两个线程：
    *   模拟恶意 ActiveMQ Broker 的 HTTP 服务器，用于托管恶意的 Spring Bean 定义 XML 文件 (`poc.xml`)。
    *   一个 ActiveMQ 客户端，作为 Client Exploit。

恶意 XML 文件包含 `java.lang.ProcessBuilder` 的 Spring Bean 定义，该 Bean 将执行任意 shell 命令。

**有效性：**

根据漏洞信息和 POC 代码的描述，此漏洞利用方式有效，可以实现远程代码执行。

**投毒风险：**

代码存在一定的投毒风险，主要集中在恶意XML文件的内容上。虽然提供的代码展示了利用 `java.lang.ProcessBuilder` 执行任意命令的方式，但实际部署时，攻击者可以将恶意XML文件替换为包含恶意代码，例如反弹shell、下载恶意软件等，从而实现更隐蔽或更具破坏性的攻击。Java代码编译后可能存在后门，但从当前信息无法判断，Python代码相对透明。

**风险评估：**

综合来看，该漏洞的威胁程度很高，利用难度相对较低，攻击者可以利用此漏洞完全控制受影响的 ActiveMQ Broker 或 Client。由于ActiveMQ 应用广泛，建议尽快升级到安全版本。

**项目地址:** [tomasmussi/activemq-cve-2023-46604](https://github.com/tomasmussi/activemq-cve-2023-46604)

**漏洞详情:** [CVE-2023-46604](https://nvd.nist.gov/vuln/detail/CVE-2023-46604)