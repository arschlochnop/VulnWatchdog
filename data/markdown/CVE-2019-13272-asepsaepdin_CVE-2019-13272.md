## CVE-2019-13272 - Linux Kernel PTRACE_TRACEME 本地提权漏洞

**漏洞编号:** CVE-2019-13272

**漏洞类型:** 本地提权

**影响应用:** Linux Kernel

**危害等级:** 高危，允许本地用户获取 root 权限

**影响版本:** < 5.1.17

**利用条件:** 需要本地用户权限，目标系统内核版本低于 5.1.17，并且没有应用 SELinux deny_ptrace 策略。

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2019-13272 漏洞存在于 Linux 内核 5.1.17 之前的版本中，具体是 `kernel/ptrace.c` 文件中的 `ptrace_link` 函数在处理进程创建 ptrace 关系时，对凭据的记录存在缺陷。此漏洞允许本地用户利用父子进程关系，通过 `PTRACE_TRACEME` 绕过权限检查，从而获得 root 权限。

**漏洞利用方式：**

1.  **父子进程关系：** 利用需要创建一个具有父子关系的进程。父进程会降低权限，然后调用 execve，这可能允许攻击者控制子进程。
2.  **PTRACE_TRACEME：**  漏洞利用的关键是使用 `PTRACE_TRACEME`，这使得子进程可以被父进程追踪。通过利用 `pkexec` 等辅助程序，可以触发漏洞。
3.  **利用pkexec：**  `pkexec` 是一个 SUID 程序，攻击者可以利用它来执行具有 root 权限的操作。由于 `ptrace_link` 函数的缺陷，可以利用父进程对子进程的追踪关系，错误地将父进程的凭据授予子进程，从而导致提权。
4.  **竞争条件：**  利用过程中可能涉及到竞争条件，攻击者需要快速执行某些操作，以便在父进程完成权限设置之前，子进程能够获得 root 权限。

**POC 代码分析：**

提供的 POC 代码通过以下步骤利用漏洞：

1.  **创建子进程：** 父进程 fork 出一个子进程。
2.  **设置 PTRACE_TRACEME：** 子进程调用 `ptrace(PTRACE_TRACEME, ...)`，允许父进程追踪它。
3.  **竞争条件触发：**  子进程尝试在父进程调用 `pkexec` 的过程中，利用 `PTRACE_TRACEME` 建立追踪关系。
4.  **利用SUID程序：** 利用 `pkexec` 这个 SUID 程序。
5.  **执行 shell：**  成功利用漏洞后，将获得 root 权限，并执行 shell。

**有效性评估：**

根据漏洞描述、搜索引擎结果和提供的 POC 代码，此漏洞的利用是有效的。POC 代码能够成功提权，表明该漏洞存在并且可以被利用。

**投毒风险评估：**

虽然POC代码功能明确，但依然存在潜在投毒风险。主要体现在以下几个方面:

1.  **依赖外部资源：** POC 代码依赖于特定的系统工具（如 `pkexec`），如果这些工具被篡改，可能会导致漏洞利用失败或执行恶意代码。
2.  **隐藏恶意代码：** 攻击者可能在 POC 代码中添加难以察觉的恶意代码，例如后门或信息收集功能。由于代码较长，人工审计可能存在疏漏。
3.  **编译过程注入：** 攻击者可能通过修改 Makefile 或其他编译脚本，在编译过程中注入恶意代码。

综合考虑，该仓库存在潜在投毒风险，但可能性较低(5%)。使用者应仔细审查代码，并在受控环境中进行测试，以降低风险。

**项目地址:** [asepsaepdin/CVE-2019-13272](https://github.com/asepsaepdin/CVE-2019-13272)

**漏洞详情:** [CVE-2019-13272](https://nvd.nist.gov/vuln/detail/CVE-2019-13272)