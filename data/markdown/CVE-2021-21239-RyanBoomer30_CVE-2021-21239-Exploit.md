## CVE-2021-21239-pysaml2-签名绕过

**漏洞编号:** CVE-2021-21239

**漏洞类型:** 签名绕过

**影响应用:** pysaml2

**危害等级:** 中危，可能导致身份伪造和权限提升

**影响版本:** < 6.5.0

**利用条件:** 依赖于pysaml2的SAML认证流程，且使用默认的CryptoBackendXmlSec1后端

**POC 可用性:** 是

**投毒风险:** 2%

## 详情

CVE-2021-21239是pysaml2库中存在的一个签名绕过漏洞。该漏洞源于pysaml2在版本6.5.0之前的版本中，使用默认的CryptoBackendXmlSec1后端时，对SAML文档的签名验证不严格。具体来说，`xmlsec1`工具默认接受多种类型的密钥，而没有强制要求必须是X.509证书。攻击者可以利用这一点，在SAML文档中使用非X.509证书的密钥进行签名，从而绕过签名验证，冒充任意用户。

**有效性：**
提供的POC代码尝试通过以下步骤利用此漏洞：
1.  解析截获的SAML XML文档。
2.  替换文档中的用户名和邮箱信息。
3.  使用一个空的签名块替换原始签名块.
4.  使用 `openssl` 生成新的密钥和证书，然后使用 `xmlsec1` 对修改后的SAML文档进行签名。
由于漏洞在于对密钥类型的验证不足，利用者通过修改SAML文档内容，并使用新的密钥重新签名，可能使pysaml2在旧版本中绕过验证，从而使攻击者成功伪造身份。此POC **有效**。

**投毒风险：**
检查POC代码后，并未发现明显的恶意投毒代码。代码主要集中在XML解析、字符串替换和签名操作。生成密钥对和使用xmlsec1签名是漏洞利用的正常步骤。

但是以下几点需要注意：

*   `subprocess.run(xmlsec_command, shell=True)`: 使用 `shell=True` 存在命令注入的风险。虽然在这个上下文中，命令是由脚本自身构造的，但如果输入的文件名或者用户输入包含恶意字符，仍然可能被利用。但这个风险很小，因为它依赖于攻击者首先控制输入文件或用户输入。

综合评估，投毒风险较低，约为2%。

**利用方式：**
1.  **截获SAML请求：** 攻击者首先需要截获目标用户发送的SAML认证请求。
2.  **修改SAML断言：** 使用提供的POC代码，攻击者可以修改SAML断言中的用户信息（例如用户名、邮箱等）。
3.  **替换签名：**  利用漏洞，移除原始签名，插入一个空的签名快。
4.  **重新签名SAML断言：** 生成新的密钥对，并使用`xmlsec1`工具使用新的密钥对修改后的SAML断言进行签名。
5.  **发送伪造的SAML请求：** 攻击者将重新签名后的SAML请求发送给服务提供商。
6.  **绕过验证，身份伪造：** 由于服务提供商使用的pysaml2版本存在漏洞，且没有强制验证密钥类型，攻击者可以成功绕过签名验证，冒充被篡改用户信息的对应用户。


**项目地址:** [RyanBoomer30/CVE-2021-21239-Exploit](https://github.com/RyanBoomer30/CVE-2021-21239-Exploit)

**漏洞详情:** [CVE-2021-21239](https://nvd.nist.gov/vuln/detail/CVE-2021-21239)