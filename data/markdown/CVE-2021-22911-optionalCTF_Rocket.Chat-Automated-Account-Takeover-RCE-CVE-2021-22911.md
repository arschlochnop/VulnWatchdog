## CVE-2021-22911 - Rocket.Chat NoSQL 注入导致 RCE

**漏洞编号:** CVE-2021-22911

**漏洞类型:** NoSQL 注入

**影响应用:** Rocket.Chat

**危害等级:** 高危，可能导致账户接管和远程代码执行

**影响版本:** <= 3.13.1 (Fixed in: 3.13.2, 3.12.4, 3.11.4)

**利用条件:** 目标 Rocket.Chat 服务器版本在受影响范围内，且允许未授权访问 API 端点

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-22911 是 Rocket.Chat 服务器中存在的一个由于不正确的输入清理而导致的 NoSQL 注入漏洞。攻击者可以利用此漏洞在未经身份验证的情况下执行 NoSQL 注入，进而可能导致远程代码执行 (RCE) 和账户接管。

**有效性评估：**

根据漏洞库信息、搜索引擎结果以及提供的漏洞利用代码，此漏洞的 PoC 代码是有效的。存在多个公开的 PoC 证明了该漏洞的可利用性。

**投毒风险评估：**

评估提供的 PoC 代码，发现以下潜在的投毒风险点：

*   **依赖第三方库：** PoC 代码依赖 `requests`，`string`, `time`, `hashlib`, `json`, `oathtool` 和 `argparse`。虽然这些都是常见的 Python 库，但如果攻击者修改 PoC 代码，使其依赖恶意版本的库，可能会引入额外的安全风险。
*   **远程代码执行：** 该漏洞本身就允许 RCE，因此攻击者可能会在成功利用漏洞后，植入恶意代码。
*   **逻辑复杂性：** 账户接管的逻辑较为复杂，攻击者可能在其中添加不易察觉的后门。
*   **2FA绕过承诺：**作者提及会增加2FA绕过功能，这可能导致更严重的安全问题，也增加了代码复杂性。

总体而言，PoC 代码本身看起来相对直接，主要集中在利用 NoSQL 注入实现账户接管。**投毒风险评估约为10%。** 主要风险在于代码的维护者可能引入恶意依赖或添加后门。

**利用方式分析：**

1.  **注册用户（如果不存在）：** 脚本首先尝试使用提供的电子邮件地址注册一个低权限用户。如果用户已经存在，则尝试使用提供的密码进行身份验证。
2.  **密码重置流程：** 如果无法使用提供的密码进行身份验证，脚本会启动密码重置流程。
    *   发送密码重置邮件。
    *   利用 NoSQL 注入漏洞，暴力破解密码重置令牌（token）。
    *   使用破解的令牌更改目标账户的密码。
3.  **登录账户：** 使用新密码登录目标账户。
4.  **远程代码执行 (RCE):** 成功登录后，可以利用NoSQL注入漏洞执行任意代码。
5.  **2FA绕过（如果目标账户启用了双因素身份验证）：** 脚本可能包含绕过双因素身份验证的逻辑。由于此部分代码未提供，具体绕过方式未知，但可能涉及 NoSQL 注入或其它漏洞利用技术。

**总结：**

CVE-2021-22911 是一个高危漏洞，攻击者可以利用该漏洞在未经身份验证的情况下接管 Rocket.Chat 账户并执行任意代码。建议用户尽快升级到安全版本。

**项目地址:** [optionalCTF/Rocket.Chat-Automated-Account-Takeover-RCE-CVE-2021-22911](https://github.com/optionalCTF/Rocket.Chat-Automated-Account-Takeover-RCE-CVE-2021-22911)

**漏洞详情:** [CVE-2021-22911](https://nvd.nist.gov/vuln/detail/CVE-2021-22911)