## CVE-2025-49844 - Redis Lua Use-After-Free

**漏洞编号:** CVE-2025-49844

**漏洞类型:** Use-After-Free

**影响应用:** Redis

**危害等级:** 高危，远程代码执行

**影响版本:** < 8.2.2

**利用条件:** Lua scripting enabled and accessible to the attacker

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2025-49844 是 Redis 中 Lua 脚本引擎存在的一个使用后释放漏洞。该漏洞源于 `luaY_parser` 函数在调用词法分析器之前没有将 chunk name 字符串固定在 Lua 堆栈上。攻击者可以构造一个特殊的 Lua 脚本，在解析器仍然引用已释放的字符串时触发垃圾回收，从而导致 UAF 并可能导致远程代码执行。

**有效性：**

提供的 POC 代码利用了垃圾回收机制的竞争条件来触发 UAF。它通过以下方式实现：

1.  创建一个大的 Lua 脚本，其中包含大量的局部变量和注释，目的是在解析过程中消耗大量的内存。
2.  使用 `newproxy` 创建一个具有自定义 `__gc` 元方法的代理对象。`__gc` 方法在垃圾回收时被调用。
3.  在 `__gc` 方法中，再次调用 `collectgarbage('collect')`，这会重新进入垃圾回收器。
4.  通过反复调用 `loadstring` 并使用具有 `__gc` 元方法的代理对象作为 chunk name，来触发漏洞。高频率的垃圾回收和 `loadstring` 函数调用增加了 UAF 的可能性。

根据漏洞库信息、搜索引擎结果（Wiz 研究、ZeroPath 博客、安全公告等）和提供的 POC 代码，可以得出结论：该 POC 代码是有效的，可以触发 Redis 服务器崩溃或断开连接，证明了远程代码执行的可能性。

**投毒风险：**

分析了提供的 Lua 脚本和 README 文件，未发现任何明显的投毒代码。脚本的目的是利用已知的 UAF 漏洞，而不是引入新的恶意功能或后门。该仓库的目的是验证漏洞是否存在，并提供缓解措施。

**利用方式：**

1.  攻击者需要能够向 Redis 服务器发送 EVAL 或 EVALSHA 命令，即需要一定的权限（根据CVSS:3.1/AV:N/AC:L/PR:L 需要低权限）。
2.  攻击者构造包含恶意代码的 Lua 脚本，并通过 EVAL 命令发送给 Redis 服务器。
3.  恶意脚本利用 `make_chunk_name` 和 `build_payload` 函数创建和执行利用代码。
4.  Redis 服务器在解析和执行脚本时，由于 UAF 漏洞，可能崩溃或允许攻击者执行任意代码。

**项目地址:** [dwisiswant0/CVE-2025-49844](https://github.com/dwisiswant0/CVE-2025-49844)

**漏洞详情:** [CVE-2025-49844](https://nvd.nist.gov/vuln/detail/CVE-2025-49844)