## CVE-2021-3560 - Polkit 本地提权漏洞

**漏洞编号:** CVE-2021-3560

**漏洞类型:** 本地提权

**影响应用:** Polkit

**危害等级:** 高危，可能导致任意用户提升至root权限

**影响版本:** polkit 0.119 (可能包括其他版本，需进一步验证)

**利用条件:** 本地用户权限

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-3560 漏洞允许未经授权的本地攻击者通过操纵 D-Bus 请求绕过 Polkit 的凭据检查，从而获得 root 权限。提供的漏洞利用代码（polkit.py）通过以下步骤利用该漏洞：

1.  **检查环境:** 首先检查是否存在SSH连接，避免身份验证提示，同时检查polkit版本，确认是否为易受攻击的版本。
2.  **创建用户:** 脚本尝试通过 `dbus-send` 命令调用 `org.freedesktop.Accounts.CreateUser` 方法，快速重复创建用户，利用Polkit的竞争条件漏洞，绕过权限验证。
3.  **设置密码:** 成功创建用户后，脚本尝试使用 `org.freedesktop.Accounts.User.SetPassword` 方法为用户设置密码，同样利用竞争条件漏洞。

**有效性评估：**

根据漏洞信息和搜索结果，以及提供的POC代码，可以判断此漏洞利用是有效的。许多文章都提及了该漏洞的利用方式，并提供了POC代码。该漏洞已存在于 CISA 的已知可利用漏洞目录中，表明其已被广泛利用。

**投毒风险评估：**

代码中存在一定的投毒风险，但可能性较低(10%)。投毒代码可能存在于以下几个方面：

*   **随机数范围：** `random.uniform(0.006, 0.009)` 用于模拟竞争条件，如果这个范围被精心设计，可能会降低利用成功率或造成系统不稳定。
*   **循环次数：** 创建用户和设置密码的循环次数 (2000 和 200) 可能被修改为消耗大量资源或造成拒绝服务。
*   **错误处理：** 代码中的错误处理部分可能被修改为在特定条件下执行恶意代码。
*  **依赖注入:** 该脚本依赖于`dbus-send`工具和`apt`包管理器, 运行环境必须存在这些工具, 如果在没有这些工具的环境运行,脚本将直接退出.

总的来说，代码主要利用竞争条件，相对简单，隐藏恶意代码的空间有限，但仍需谨慎评估，在测试前进行代码审查。

**利用方式总结：**

该漏洞利用的核心在于通过竞争条件绕过 Polkit 的身份验证机制，从而执行需要 root 权限的操作。攻击者通过高频率地发送 D-Bus 请求，利用 Polkit 处理请求时的漏洞窗口，在未通过正确身份验证的情况下成功创建用户并设置密码，最终达到提权的目的。

**项目地址:** [MandipJoshi/CVE-2021-3560](https://github.com/MandipJoshi/CVE-2021-3560)

**漏洞详情:** [CVE-2021-3560](https://nvd.nist.gov/vuln/detail/CVE-2021-3560)