## CVE-2019-13272-Linux Kernel PTRACE_TRACEME 本地提权

**漏洞编号:** CVE-2019-13272

**漏洞类型:** 本地提权

**影响应用:** Linux Kernel

**危害等级:** 高危，允许低权限本地用户获得root权限

**影响版本:** < 5.1.17

**利用条件:** 需要本地用户权限，目标系统运行易受攻击的内核版本, 并且需要存在可被利用的pkexec helper。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2019-13272 漏洞存在于 Linux kernel 的 ptrace_link 函数中，该函数没有正确处理进程创建 ptrace 关系时的凭证记录。攻击者可以利用具有父子进程关系的特定场景，其中父进程放弃权限并调用 execve （可能允许攻击者控制），从而获得 root 权限。漏洞利用涉及使用 PTRACE_TRACEME 功能以及 Polkit 的 pkexec helper。 

**利用方式：**

1.  **父进程放弃权限：** 攻击者需要控制一个父进程，该进程会放弃权限（例如，通过设置用户ID）。
2.  **调用 execve：** 父进程在放弃权限后，需要调用 execve 来执行另一个程序，这个程序可能是攻击者可控的。
3.  **PTRACE_TRACEME：** 子进程使用`PTRACE_TRACEME`，表示它希望被追踪。
4.  **pkexec Helper：** 该漏洞可以与 Polkit 的 `pkexec` helper 结合使用，由于凭证处理不当，导致提权。
5.  **利用链：** 利用链包括进程间通信，ptrace机制调用，以及execve函数调用，导致权限提升。

**POC代码分析：**

*   代码首先检查环境，确保存在 `pkexec` 和至少一个已知的 helper 程序。
*   然后，它创建一个父子进程关系，其中父进程在子进程执行 `pkexec` 之前放弃权限。
*   子进程使用 `PTRACE_TRACEME` 尝试追踪父进程。
*   父进程利用 `pkexec` 及其 helper 程序中的漏洞来提升权限。
*   最终，攻击者获得 root 权限并生成 shell。

**有效性：**

根据漏洞描述和提供的利用代码，该POC**可能有效**。代码试图利用`ptrace_link`中的缺陷绕过权限检查，并结合`pkexec`来获得root权限。公开资料也显示该漏洞有可利用的POC。

**投毒风险分析：**

POC代码中存在一定投毒风险。主要存在以下几点：

*   **依赖已知helper程序：** 代码依赖于系统上存在的特定的helper程序（例如： `/usr/lib/gnome-settings-daemon/gsd-backlight-helper`）。如果目标系统上不存在这些程序，利用将会失败，但恶意作者可能添加Payload在利用失败的情况下执行，比如删除某些文件，或者修改某些配置。
*   **`force_exec_and_wait` 函数：** 该函数使用 `ptrace` 修改子进程的寄存器，如果使用不当，可能会导致子进程崩溃或执行意外代码。 恶意作者可以利用这个特性执行其他恶意代码，具有一定的风险。
*   **条件判断和异常处理：** 代码中的条件判断和异常处理相对简单。恶意作者可能会故意省略某些检查，从而在特定条件下触发漏洞或导致拒绝服务。

考虑到这些因素，**投毒风险评估为10%**。大多数代码看起来是为了利用漏洞，但仍然存在一些潜在的注入恶意代码的机会。

**项目地址:** [josemlwdf/CVE-2019-13272](https://github.com/josemlwdf/CVE-2019-13272)

**漏洞详情:** [CVE-2019-13272](https://nvd.nist.gov/vuln/detail/CVE-2019-13272)