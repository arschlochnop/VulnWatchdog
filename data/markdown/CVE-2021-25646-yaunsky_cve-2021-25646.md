## CVE-2021-25646-Apache Druid 远程代码执行

**漏洞编号:** CVE-2021-25646

**漏洞类型:** 远程代码执行

**影响应用:** Apache Druid

**危害等级:** 高危，允许经过身份验证的用户执行任意代码

**影响版本:** <= 0.20.0

**利用条件:** 需要目标服务器运行着Apache Druid 0.20.0或更早版本，并且攻击者具有已认证用户的权限(根据漏洞库信息)。根据一些搜索结果，未经身份验证也可利用

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-25646 存在于 Apache Druid 中，允许经过身份验证的用户（某些情况下，未经验证的用户）通过发送特制的请求来执行任意 JavaScript 代码。该漏洞源于 Druid 允许在请求中嵌入用户提供的 JavaScript 代码，即使服务器配置禁用了此功能。攻击者可以通过构造包含恶意 JavaScript 代码的 JSON 数据，利用 /druid/indexer/v1/sampler 端点，绕过安全限制，最终在目标服务器上执行任意命令。提供的 PoC 通过构造包含恶意 JavaScript 代码的 POST 请求，其中 JavaScript 代码会执行 `ping t6gx5w.dnslog.cn` 命令，从而通过 DNS 查询来验证漏洞是否存在。

**有效性：**
PoC 代码看起来是有效的。它利用了 Druid 的 /druid/indexer/v1/sampler 端点，并通过构造恶意的 JSON payload 绕过配置限制来执行 JavaScript 代码。通过 DNSLog 平台进行验证，如果收到 ping 请求，则表明漏洞存在。

**投毒风险：**
PoC 代码本身主要包含漏洞利用的逻辑，直接执行恶意命令。虽然任何代码都存在潜在的投毒风险，但此仓库中的PoC代码的目的是利用已知的漏洞，而不是植入后门。因此，投毒风险较低。风险主要来自于使用者是否会滥用此PoC进行未经授权的渗透测试。该脚本中第52行可以被修改为执行任意命令, 具有一定的风险。

**利用方式：**
1.  攻击者需要确定目标系统上运行的 Apache Druid 版本是否小于等于 0.20.0。
2.  （可能需要）获取目标 Druid 实例的有效用户凭据。
3.  攻击者构造一个包含恶意 JavaScript 代码的 JSON payload。此 payload 被设计为在 Druid 服务器上执行任意命令。JavaScript代码嵌入在`transformSpec`中的`filter`中。
4.  攻击者将构造的 payload 通过 POST 请求发送到 /druid/indexer/v1/sampler 端点。
5.  如果漏洞利用成功，Druid 服务器将执行 payload 中的 JavaScript 代码，从而允许攻击者在服务器上执行任意命令。

**项目地址:** [yaunsky/cve-2021-25646](https://github.com/yaunsky/cve-2021-25646)

**漏洞详情:** [CVE-2021-25646](https://nvd.nist.gov/vuln/detail/CVE-2021-25646)