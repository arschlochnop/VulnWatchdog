## CVE-2007-2447-Samba-远程命令注入

**漏洞编号:** CVE-2007-2447

**漏洞类型:** 远程命令注入

**影响应用:** Samba

**危害等级:** 高危，可能导致远程代码执行

**影响版本:** 3.0.0 through 3.0.25rc3

**利用条件:** 需要开启"username map script" smb.conf选项，或者攻击其他MS-RPC函数（远程打印机、文件共享管理），部分情况需要认证

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2007-2447 存在于 Samba 3.0.0 到 3.0.25rc3 版本中。攻击者可以利用 MS-RPC 功能中的漏洞，通过 shell 元字符执行任意命令。主要利用方式有三种：

1.  **SamrChangePassword 函数 + "username map script"：** 当 smb.conf 配置文件中启用了 `username map script` 选项时，未经授权的攻击者可以通过 SamrChangePassword 函数注入 shell 元字符执行任意命令。
2.  **远程打印机管理：** 经过身份验证的用户可以利用远程打印机管理相关的 MS-RPC 函数，注入 shell 元字符执行任意命令。
3.  **文件共享管理：** 经过身份验证的用户可以利用文件共享管理相关的 MS-RPC 函数，注入 shell 元字符执行任意命令。

提供的 POC 代码 `CVE-2007-2447.py` 旨在利用 `username map script` 选项。该脚本通过 `SMBConnection` 类连接到目标 Samba 服务器，并发送包含反弹 shell 命令的 payload 作为用户名。如果服务器存在漏洞并启用了 `username map script`，则会执行该 payload，攻击者的 nc 监听器将收到 shell。

**有效性：** 根据漏洞描述和 POC 代码，可以判断 POC 代码有效，但需要目标服务器满足特定条件，即运行受影响的 Samba 版本，并启用了 `username map script` 选项。

**投毒风险：** 查看POC代码后发现，该脚本功能单一，主要实现了发送恶意payload利用漏洞，并通过netcat反弹shell。该仓库只包含一个python脚本和一个简单的readme文件，**没有**发现任何作者隐藏的投毒代码。

**利用方式：**

1.  配置 Samba 服务器的 `smb.conf` 文件，确保启用了 `username map script` 选项。
2.  运行提供的 POC 代码，指定目标 Samba 服务器的 IP 地址和用于接收反弹 shell 的本地 IP 地址和端口。
3.  在本地监听指定的端口，等待目标服务器反弹 shell。

需要注意的是，此漏洞已经比较老旧，多数系统应该已经修复。攻击成功的前提是目标系统未打补丁且配置符合漏洞利用条件。

**项目地址:** [HerculesRD/PyUsernameMapScriptRCE](https://github.com/HerculesRD/PyUsernameMapScriptRCE)

**漏洞详情:** [CVE-2007-2447](https://nvd.nist.gov/vuln/detail/CVE-2007-2447)