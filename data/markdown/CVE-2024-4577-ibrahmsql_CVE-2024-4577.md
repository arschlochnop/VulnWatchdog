## CVE-2024-4577-PHP-CGI远程代码执行

**漏洞编号:** CVE-2024-4577

**漏洞类型:** 远程代码执行

**影响应用:** PHP

**危害等级:** 高危，可能导致服务器完全控制

**影响版本:** < 8.3.8, < 8.2.20, < 8.1.29

**利用条件:** Windows系统，Apache服务器，PHP以CGI模式运行，开启Best-Fit代码页转换

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2024-4577是一个PHP CGI中的远程代码执行漏洞。该漏洞的利用方式是利用Windows系统在特定代码页设置下，对传递给Win32 API的命令行参数进行"Best-Fit"转换的特性。攻击者通过构造特殊字符，使得PHP CGI在解析命令行参数时，将这些字符错误地解析为PHP选项，从而可以注入恶意PHP代码或执行系统命令。

**有效性：**

提供的POC代码看起来是有效的。它尝试通过在URL中注入PHP选项来利用漏洞，例如 `cgi.force_redirect=0` 和 `auto_prepend_file=php://input`。 `auto_prepend_file=php://input` 允许攻击者将POST请求的内容作为PHP代码执行。搜索引擎结果也表明该漏洞已被积极利用。

**投毒风险：**

该POC代码没有明显的投毒迹象。虽然可以利用此漏洞执行任意代码，但是POC本身没有包含任何试图在目标机器上安装后门或执行恶意操作的代码。代码只是构建并发送利用请求，执行指定的命令。 因此，投毒风险评估为0%。

**利用方式：**

1.  **确定目标环境：**  目标服务器必须是Windows系统，并且PHP以CGI模式运行。需要确认目标服务器上PHP的版本是否在受影响的范围内（< 8.3.8, < 8.2.20, < 8.1.29）。同时确认服务器是否开启了Best-Fit代码页转换。
2.  **构造恶意URL：**  构建包含恶意PHP选项的URL。关键是使用"Best-Fit"转换可能发生的字符来代替标准PHP选项分隔符。`%AD` (软连字符)是一个常用的选择。
3.  **发送请求：**  使用POST方法向目标服务器发送包含恶意URL和PHP代码的请求。PHP代码会被`auto_prepend_file=php://input`选项包含并执行。
4.  **执行任意代码：**  成功利用后，攻击者可以在目标服务器上执行任意PHP代码或系统命令。

**缓解措施：**

*   升级PHP到不受影响的版本(>= 8.3.8, >= 8.2.20, >= 8.1.29)。
*   禁用CGI模式的PHP，如果可能的话，使用其他方式运行PHP，例如FastCGI或PHP-FPM。
*   配置Web服务器，确保不允许未授权的PHP文件执行。

**项目地址:** [ibrahmsql/CVE-2024-4577](https://github.com/ibrahmsql/CVE-2024-4577)

**漏洞详情:** [CVE-2024-4577](https://nvd.nist.gov/vuln/detail/CVE-2024-4577)