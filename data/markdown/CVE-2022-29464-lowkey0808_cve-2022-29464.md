## CVE-2022-29464 - WSO2 Unrestricted File Upload

**漏洞编号:** CVE-2022-29464

**漏洞类型:** 任意文件上传

**影响应用:** WSO2 API Manager, Identity Server, Enterprise Integrator, Open Banking AM/KM

**危害等级:** 高危，可导致远程代码执行

**影响版本:** WSO2 API Manager 2.2.0 up to 4.0.0, WSO2 Identity Server 5.2.0 up to 5.11.0, WSO2 Identity Server Analytics 5.4.0, 5.4.1, 5.5.0 and 5.6.0, WSO2 Identity Server as Key Manager 5.3.0 up to 5.11.0, WSO2 Enterprise Integrator 6.2.0 up to 6.6.0, WSO2 Open Banking AM 1.4.0 up to 2.0.0 and WSO2 Open Banking KM 1.4.0, up to 2.0.0

**利用条件:** 目标系统存在/fileupload endpoint且未进行严格的文件类型和路径校验

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2022-29464 漏洞允许攻击者通过 /fileupload 接口上传任意文件，最终导致远程代码执行。攻击者利用 Content-Disposition 头中的目录遍历序列将恶意文件（如 JSP shell）上传到 Web 根目录下的可执行位置，例如 ../../../../repository/deployment/server/webapps 目录。  

**POC分析:**

提供的POC代码是一个Python脚本，它执行以下操作：

1.  **构建Payload:**  脚本允许上传用户自定义的webshell，默认情况下，如果用户没有提供webshell文件,它将上传一个内置的简单的JSP webshell，该webshell接受`cmd`参数并在服务器上执行系统命令。代码中变量`xloq`定义了内置的shell内容。
2.  **发送恶意请求:** 脚本使用`requests`库向目标URL的`/fileupload/toolsAny` endpoint发送POST请求，其中包含精心构造的`files`参数，利用目录遍历将webshell上传到`/repository/deployment/server/webapps/authenticationendpoint/`目录下，文件名为`shell.jsp`或者用户指定的文件名。
3.  **利用上传的webshell:** 如果上传成功，默认的webshell将通过构造URL（如`/authenticationendpoint/shell.jsp?cmd=whoami`）来执行命令，并打印命令执行结果。用户自定义上传的webshell将会直接返回webshell的URL地址,方便使用.

**有效性:**

根据漏洞库信息、搜索结果和提供的POC代码，可以判断该POC代码是有效的。 多个搜索结果表明该漏洞已被积极利用。

**投毒风险:**

仔细审查了POC代码，该代码主要功能是利用漏洞上传webshell并执行命令。没有发现作者隐藏的恶意代码或者后门。因此，认为投毒风险为0%。

**利用方式:**

1.  确定目标WSO2产品存在CVE-2022-29464漏洞。
2.  使用POC脚本，指定目标URL。
3.  POC脚本利用`/fileupload/toolsAny`接口，通过构造包含目录遍历的`Content-Disposition`头部的POST请求，将webshell上传到服务器的`/repository/deployment/server/webapps/authenticationendpoint/`目录下。
4.  通过访问上传的webshell（例如 `/authenticationendpoint/shell.jsp?cmd=command`）执行任意命令。

**项目地址:** [lowkey0808/cve-2022-29464](https://github.com/lowkey0808/cve-2022-29464)

**漏洞详情:** [CVE-2022-29464](https://nvd.nist.gov/vuln/detail/CVE-2022-29464)