## CVE-2007-4559 Python tarfile 目录穿越漏洞

**漏洞编号:** CVE-2007-4559

**漏洞类型:** 目录穿越

**影响应用:** Python tarfile 模块

**危害等级:** 高危，允许攻击者覆盖任意文件

**影响版本:** 受影响版本：Python tarfile module

**利用条件:** 用户需要解压恶意构造的 TAR 压缩包

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2007-4559 是 Python `tarfile` 模块中的一个目录穿越漏洞。`extract` 和 `extractall` 函数在处理 TAR 压缩包时，如果没有进行充分的路径验证，攻击者可以在 TAR 包中构造包含 `..` (dot dot) 序列的文件名，从而将文件解压到任意目录，覆盖或创建文件。根据搜索结果，该漏洞影响大量开源项目，修复不当可能导致绕过。

提供的 POC 代码旨在演示对 Trellix 补丁的绕过，该补丁尝试通过 `is_within_directory` 函数来防止目录穿越。POC 通过创建一个包含符号链接的 TAR 包，绕过 `is_within_directory` 的检查，因为该检查只验证了解压路径是否在目标目录内，而没有考虑到符号链接可能指向外部目录。

利用方式：
1.  攻击者构造包含恶意文件（文件名包含 `..` 序列或符号链接）的 TAR 压缩包。
2.  受害者使用存在漏洞的 `tarfile.extract` 或 `tarfile.extractall` 函数解压该压缩包。
3.  恶意文件被解压到攻击者指定的任意位置，可能覆盖系统文件或执行恶意代码。

有效性：提供的 POC 代码（`poc.py`）和相关文件（`Dockerfile`, `README.md`）旨在演示该漏洞的利用。`poc.py` 代码定义了一个 `safe_extract` 函数，该函数旨在防止目录穿越，但会被包含符号链接的 TAR 文件绕过。`Dockerfile` 用于构建一个包含 Python 环境的 Docker 镜像，方便运行 POC 代码。

投毒风险：`poc.py` 本身是为了验证漏洞，没有明显的后门代码。`Dockerfile` 使用官方 Python 镜像，风险较低。但 `README.md` 中提及了 Trellix 的修复方案存在绕过可能，并提供了验证步骤，可能存在诱导用户在生产环境中测试的可能性。尽管没有直接的恶意代码，存在潜在的误用风险，因此投毒风险评估为10%。因为攻击者可以修改 `poc.py`，在其中添加恶意代码，或者构造包含恶意文件的 TAR 包，该文件在解压后执行恶意操作。但提供的样本仓库本身的目的不是投毒，因此比例较低。

**项目地址:** [luigigubello/trellix-tarslip-patch-bypass](https://github.com/luigigubello/trellix-tarslip-patch-bypass)

**漏洞详情:** [CVE-2007-4559](https://nvd.nist.gov/vuln/detail/CVE-2007-4559)