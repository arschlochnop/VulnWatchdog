## CVE-2021-25646-Apache Druid-RCE

**漏洞编号:** CVE-2021-25646

**漏洞类型:** 远程代码执行

**影响应用:** Apache Druid

**危害等级:** 高危，允许未经授权的远程代码执行

**影响版本:** <= 0.20.0

**利用条件:** 需要目标Druid服务版本低于0.20.1，且攻击者需要具备一定程度的身份验证（即使是低权限用户）

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2021-25646是Apache Druid中的一个远程代码执行漏洞。根据漏洞库信息和搜索结果，该漏洞允许经过身份验证的用户通过构造特制的请求来执行任意JavaScript代码，从而在Druid服务器上以服务器进程的权限执行代码。即使服务器配置禁用了JavaScript执行，攻击者仍然可以通过此漏洞绕过限制。

**有效性：**
提供的PoC代码看起来是有效的。它利用了Druid的sampler接口，通过构造包含恶意JavaScript代码的JSON payload，尝试在目标系统上执行命令。代码中包含了命令转义，增加了成功利用的可能性。

**投毒风险：**
PoC代码中存在少量投毒风险。代码逻辑主要是构造payload，风险主要在于以下几点：

1.  **依赖安装风险：**`requirements.txt`文件如果包含恶意依赖，则存在投毒风险，但该PoC未使用`requirements.txt`而是直接提示安装`requests`库，风险较低。
2.  **请求库风险：**代码使用了`requests`库发送HTTP请求。如果该库被篡改，可能导致信息泄露或者其他安全问题，但这种情况发生的概率较低。
3.  **代码逻辑风险：** 代码中命令执行部分使用了`java.lang.Runtime.getRuntime().exec()`，如果攻击者修改了PoC，可能会尝试执行更危险的命令，但代码本身目标是执行用户指定的命令。

因此，综合来看，PoC本身包含的恶意代码概率较低，但如果被篡改，则可能存在风险，投毒风险评估为5%。

**利用方式：**
1.  攻击者需要知道目标Druid服务的URL。
2.  攻击者需要发送一个POST请求到`/druid/indexer/v1/sampler`端点。
3.  请求体需要是包含恶意JavaScript代码的JSON payload。这个payload会覆盖服务器配置，强制执行JavaScript代码。
4.  恶意JavaScript代码使用`java.lang.Runtime.getRuntime().exec()`来执行系统命令。
5.  服务器返回命令执行结果。

**项目地址:** [ShadowLance2/Apache-Druid-CVE-2021-25646-Exploit](https://github.com/ShadowLance2/Apache-Druid-CVE-2021-25646-Exploit)

**漏洞详情:** [CVE-2021-25646](https://nvd.nist.gov/vuln/detail/CVE-2021-25646)