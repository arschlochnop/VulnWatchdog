## CVE-2016-5195 Dirty COW

**漏洞编号:** CVE-2016-5195

**漏洞类型:** 权限提升

**影响应用:** Linux Kernel

**危害等级:** 高危，可导致本地用户获取root权限

**影响版本:** Linux kernel 2.x through 4.x before 4.8.3

**利用条件:** 本地用户，目标系统内核版本在受影响范围内

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

Dirty COW (CVE-2016-5195) 是Linux内核中的一个竞争条件漏洞，存在于 `mm/gup.c` 文件中。该漏洞允许本地用户利用copy-on-write (COW)机制中的错误处理，写入到只读内存映射，从而获得权限提升。 

**有效性：**
根据提供的漏洞信息和搜索结果，以及漏洞利用代码，该POC代码是有效的。该漏洞在2016年被广泛利用，并且有公开的PoC代码。

**投毒风险：**
提供的 `dirtycow.c` 代码，主要包含以下几个部分：

*   **`main` 函数：**  处理命令行参数，打开目标文件，使用 `mmap` 将文件映射到内存中，创建两个线程，并等待线程结束。
*   **`writeToMem` 函数：**  打开 `/proc/self/mem`，并在循环中通过 `lseek` 和 `write` 系统调用，向内存映射区域写入数据。 这个函数是利用漏洞的关键，通过直接修改进程内存来修改只读内存区域。
*   **`throwVirtMap` 函数:**  使用 `madvise` 系统调用，提示内核释放或重新获取虚拟内存区域。 这是触发竞争条件的关键，用于增大漏洞利用成功的概率。

**分析 `dirtycow.c` 代码后，未发现明显的投毒代码。** 该代码的功能明确，即利用 Dirty COW 漏洞覆盖只读文件内容。 代码中没有任何连接外部网络，执行其他程序，或者删除文件的操作， 因此投毒风险极低，可以评估为0%。

**利用方式：**
1.  **漏洞原理：**  Dirty COW 漏洞利用了Linux内核中copy-on-write (COW) 机制的竞争条件。当一个进程尝试写入一个只读的内存映射区域时，COW 会创建一个该内存页面的副本，并将写入操作应用到副本上。然而，在某些情况下，由于竞争条件，写入操作可能会直接应用到原始的只读内存页面上。
2.  **利用步骤：**
    *   使用 `mmap` 将目标文件以只读方式映射到内存中。
    *   创建一个线程，该线程打开 `/proc/self/mem` 文件，并通过 `lseek` 和 `write` 系统调用，向内存映射区域写入恶意数据。
    *   创建另一个线程，该线程使用 `madvise` 系统调用，提示内核释放或重新获取虚拟内存区域，以触发竞争条件。
    *   等待两个线程结束。
3.  **权限提升：** 通过修改具有SUID权限的可执行文件(例如 `/etc/passwd`)，普通用户可以修改文件内容，从而添加具有root权限的用户，最终提升权限。  也可以直接修改其他配置信息，达到提权的目的。

总而言之， 该漏洞利用代码目的是在特定的Linux内核版本上，实现本地权限提升，通过竞争条件，绕过只读保护，写入文件内容。 经分析，该代码本身不包含额外的恶意代码或后门，但利用该漏洞本身可以修改系统文件，从而实现提权或其他恶意目的。

**项目地址:** [th3-5had0w/DirtyCOW-PoC](https://github.com/th3-5had0w/DirtyCOW-PoC)

**漏洞详情:** [CVE-2016-5195](https://nvd.nist.gov/vuln/detail/CVE-2016-5195)