## CVE-2024-3400 PAN-OS GlobalProtect 命令注入漏洞

**漏洞编号:** CVE-2024-3400

**漏洞类型:** 命令注入

**影响应用:** PAN-OS GlobalProtect

**危害等级:** 高危，允许未经验证的攻击者以 root 权限在防火墙上执行任意代码

**影响版本:** PAN-OS 10.2.0 <= version < 10.2.9-h1, PAN-OS 11.0.0 <= version < 11.0.4-h1, PAN-OS 11.1.0 <= version < 11.1.2-h3

**利用条件:** 需要目标系统配置了 GlobalProtect 网关或门户。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-3400 是 Palo Alto Networks PAN-OS 软件 GlobalProtect 功能中的一个命令注入漏洞。由于任意文件创建漏洞的存在，未经身份验证的攻击者可以通过利用此漏洞在防火墙上以 root 权限执行任意代码。漏洞存在于 PAN-OS 10.2、PAN-OS 11.0 和 PAN-OS 11.1 版本，且必须配置 GlobalProtect 网关或门户。\n\n**漏洞利用方式：**\n1.  攻击者向`/ssl-vpn/hipreport.esp` endpoint 发送 POST 请求。\n2.  POST 请求中包含特制的 Cookie，其中 SESSID 参数被设置为指向恶意文件路径`/../../../var/appweb/sslvpndocs/global-protect/portal/images/sxy.txt`。\n3.  攻击者随后向`/global-protect/portal/images/sxy.txt` 发送 GET 请求，如果服务器返回 403 错误，则表明漏洞存在，且攻击者可以通过构造恶意请求执行任意代码。\n\n**POC代码有效性：**提供的POC代码旨在检测目标是否存在漏洞，通过发送特定的POST和GET请求，验证是否能够访问通常被禁止访问的文件。如果GET请求返回403状态码，则表明目标可能存在漏洞。\n\n**投毒风险分析：**\nPOC代码中存在潜在的投毒风险，主要体现在注释掉的 interactsh 相关代码部分。这段代码的目的是使用 `curl` 命令将目标系统的 `whoami` 命令的输出发送到攻击者的 interactsh 服务器。虽然这段代码当前是被注释掉的，但如果攻击者修改代码，取消注释，并运行，则可能存在以下风险：\n*   **信息泄露:** 将 `whoami` 命令的输出发送到外部服务器可能泄露目标系统的用户名信息。\n*   **命令执行:** 通过 interactsh 反连，可能执行更复杂的恶意命令。\n\n因此，尽管当前代码是检测漏洞，但潜在的风险仍然存在，尤其是对于不熟悉代码的用户，可能在不知情的情况下运行包含恶意代码的变体。所以，我将投毒风险评定为 10%。
此外，代码会尝试获取目标的 SSL 证书信息，这本身不是恶意行为，但可能被攻击者用于指纹识别和进一步攻击。

**缓解措施：**\n*   立即升级到已修复的 PAN-OS 版本，如 PAN-OS 10.2.9-h1, PAN-OS 11.0.4-h1, PAN-OS 11.1.2-h3 或更高版本。\n*   应用威胁防御签名（Threat IDs 95187, 95189, 和 95191）。\n*   确保 GlobalProtect 接口已应用漏洞保护。

**项目地址:** [sxyrxyy/CVE-2024-3400-Check](https://github.com/sxyrxyy/CVE-2024-3400-Check)

**漏洞详情:** [CVE-2024-3400](https://nvd.nist.gov/vuln/detail/CVE-2024-3400)