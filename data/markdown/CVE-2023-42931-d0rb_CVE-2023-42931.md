## CVE-2023-42931 - macOS Privilege Escalation

**漏洞编号:** CVE-2023-42931

**漏洞类型:** 权限提升

**影响应用:** macOS

**危害等级:** 高危，可获取Root权限

**影响版本:** macOS Monterey < 12.7.2, macOS Ventura < 13.6.3, macOS Sonoma < 14.2

**利用条件:** 本地访问权限

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2023-42931 允许低权限用户提升至 root 权限。根据搜索引擎结果（webpage 1, 4, 9），此漏洞与 'diskutil' 命令有关，允许利用不正确的权限处理来提升权限。漏洞利用代码（PoC.py）证实了这一点，通过以下步骤实现权限提升：

1.  **创建 Setuid Shell:**  创建一个具有 setuid 权限的 shell 程序，当执行该 shell 时，将以文件所有者的权限（即 root）运行。
2.  **挂载文件系统 (noowners):** 使用 `diskutil mount -mountOptions noowners /dev/disk3s4` 命令以 `noowners` 标志挂载文件系统。`noowners` 标志使得文件所有权的检查被忽略。
3.  **修改 .file 权限:**  将根目录下的 `.file` 文件的权限修改为 777，使其可读写可执行，从而允许任何用户修改该文件。
4.  **拷贝 Payload:** 将编译好的 setuid shell 程序拷贝到 `.file`。
5.  **设置 .file 权限:**  将 `.file` 的权限设置为 +sx，使其具有 setuid 权限。
6.  **重新挂载文件系统 (owners, suid):** 使用 `diskutil mount -mountOptions owners,suid /dev/disk3s4` 命令，以 `owners` 和 `suid` 标志重新挂载文件系统。这样，setuid 权限才能生效。
7.  **执行 Payload:**  执行位于根目录下的 `.file` 文件，由于该文件是 setuid 程序，因此会以 root 权限运行，从而获得 root shell。

**有效性：** 根据漏洞库信息和搜索引擎结果，该漏洞是真实存在的，并且存在可用的PoC利用代码。提供的PoC代码的逻辑与漏洞描述相符，因此判断该PoC代码有效。

**投毒风险：**

*   `README.md`文件中包含指向`bringthemhomenow.net`的链接，这是一个政治声明，虽然不直接构成投毒，但表明作者具有一定的政治倾向，不排除在代码中加入恶意行为的可能性。
*   PoC的代码比较直接，目的是利用漏洞提升权限，没有发现明显的恶意行为。但是，该脚本直接使用 `os.system` 函数执行系统命令，这本身就存在一定的风险，如果作者有意为之，可以通过构造恶意的命令来执行任意代码。
*   此外，PoC 需要编译 C 代码，并将编译后的二进制文件复制到系统目录，这个过程也存在被篡改的风险。

综合考虑，虽然目前代码本身看起来没有明显的投毒行为，但是考虑到作者的政治倾向、`os.system` 的使用以及编译过程的潜在风险，认为存在10%的投毒风险。

**利用方式：** 该漏洞的利用方式是利用 'diskutil' 命令的权限管理缺陷，通过修改文件系统挂载选项，使得攻击者能够创建一个 setuid 程序，并以 root 权限执行。

**项目地址:** [d0rb/CVE-2023-42931](https://github.com/d0rb/CVE-2023-42931)

**漏洞详情:** [CVE-2023-42931](https://nvd.nist.gov/vuln/detail/CVE-2023-42931)