## CVE-2021-22204-ExifTool-DjVu模块代码注入

**漏洞编号:** CVE-2021-22204

**漏洞类型:** 代码注入

**影响应用:** ExifTool

**危害等级:** 高危，可能导致远程代码执行

**影响版本:** >=7.44, <12.24

**利用条件:** 需要用户使用受影响版本的ExifTool处理特制的DjVu或包含嵌入DjVu数据的图片文件（如JPEG）

**POC 可用性:** 是

**投毒风险:** 1%

## 详情

该漏洞存在于ExifTool的DjVu模块中，由于未能正确处理DjVu文件中的用户数据，导致了代码注入漏洞。攻击者可以通过构造恶意的DjVu文件，当ExifTool解析该文件时，执行任意代码。POC利用方式如下：

1.  **Dockerfile**: 用于构建包含易受攻击的ExifTool和所需依赖项的Docker镜像。
2.  **README.md**: 描述了漏洞和利用步骤，包括如何生成恶意`image.jpg`文件。
3.  **configfile**:  ExifTool的配置文件，定义了一个用户自定义的Exif标签，用于将恶意DjVu数据写入图像文件。
4.  **docker-compose.yml**:  定义了Docker容器的服务配置，方便启动漏洞环境。
5.  **exploit.py**:  Python脚本，用于生成包含反弹shell的恶意DjVu文件，并使用ExifTool将该DjVu数据嵌入到`image.jpg`文件中。脚本首先使用base64编码的perl代码创建一个反弹shell，然后将其注入到DjVu文件中，最后将DjVu数据嵌入到image.jpg中。

**利用方式：**

1.  配置`exploit.py`中的反弹shell IP地址和端口。
2.  运行`docker compose up`启动漏洞环境。
3.  进入Docker容器的shell，执行`/root/exploit.py`生成包含恶意代码的`image.jpg`文件。
4.  目标用户使用存在漏洞的ExifTool版本处理`image.jpg`时，会触发代码执行，攻击者获得反弹shell。

**有效性：**

该PoC代码利用了CVE-2021-22204漏洞，通过DjVu文件嵌入恶意Perl代码，当ExifTool处理包含该DjVu数据的图片时，Perl代码会被执行，从而实现远程代码执行，该PoC有效。

**投毒风险：**

虽然该仓库中包含Dockerfile，可以快速构建一个漏洞环境。但是经过代码审计，其中`exploit.py`中的payload执行的是反弹shell，并没有发现其他恶意代码，且作者有提供参考链接，可以判定投毒风险较低，只有1%。



**项目地址:** [Roronoawjd/CVE-2021-22204](https://github.com/Roronoawjd/CVE-2021-22204)

**漏洞详情:** [CVE-2021-22204](https://nvd.nist.gov/vuln/detail/CVE-2021-22204)