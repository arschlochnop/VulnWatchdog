## CVE-2021-22204 - ExifTool DjVu 任意代码执行

**漏洞编号:** CVE-2021-22204

**漏洞类型:** 代码执行

**影响应用:** ExifTool

**危害等级:** 高危，允许攻击者执行任意代码

**影响版本:** >=7.44, <12.24

**利用条件:** 需要目标系统安装ExifTool，且版本在受影响范围内，用户需要使用ExifTool处理恶意的DjVu文件。

**POC 可用性:** 是

**投毒风险:** 1%

## 详情

CVE-2021-22204是ExifTool中的一个代码执行漏洞，存在于DjVu文件处理模块。该漏洞是由于ExifTool未能正确地过滤DjVu文件中的用户输入数据，导致攻击者可以通过在DjVu文件中嵌入恶意代码，当ExifTool解析该文件时，嵌入的恶意代码会被执行，从而导致任意代码执行。

**有效性：**
提供的POC代码通过生成包含恶意payload的DjVu文件，并利用ExifTool处理该文件来触发漏洞，从而执行任意命令。POC代码包含以下步骤：
1.  构建payload：创建一个包含要执行的命令的payload字符串。
2.  创建payload文件：将payload写入名为"payload"的文件。
3.  压缩payload：使用`bzz`命令压缩payload文件为payload.bzz。
4.  生成恶意DjVu文件：使用`djvumake`命令创建一个恶意的DjVu文件（malicious.djvu），其中包含对payload.bzz的引用。
5.  触发漏洞：使用`exiftool`命令，并指定自定义的配置文件`configfile`，读取恶意的DjVu文件，利用`-HasselbladExif<=malicious.djvu`选项，将DjVu文件内容写入HasselbladExif标签，触发漏洞执行。

**投毒风险：**
该仓库投毒风险较低（约1%）。主要理由如下：
*   代码逻辑相对简单，目的是利用已知的漏洞。
*   代码执行的命令依赖于用户提供的`-C`参数，即用户指定的命令。
*   虽然存在配置文件，但该配置文件只是为了将HasselbladExif标签添加到IFD0，并不会主动执行任何恶意操作。

但是，用户仍然需要谨慎，因为：
*   POC代码本身会执行用户指定的命令，如果用户指定了恶意命令，则可能对系统造成损害。
*   `configfile`的内容需要检查，确保没有隐藏的恶意配置。

**利用方式：**
1.  攻击者构造包含恶意代码的DjVu文件。
2.  受害者使用ExifTool（版本7.44到12.23）处理该DjVu文件。
3.  ExifTool在解析DjVu文件时，由于对用户输入数据过滤不当，执行了DjVu文件中的恶意代码。
4.  攻击者成功在受害者系统上执行任意代码。

**项目地址:** [cc3305/CVE-2021-22204](https://github.com/cc3305/CVE-2021-22204)

**漏洞详情:** [CVE-2021-22204](https://nvd.nist.gov/vuln/detail/CVE-2021-22204)