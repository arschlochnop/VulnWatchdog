## CVE-2025-30216: CryptoLib Heap Overflow in Crypto_TM_ProcessSecurity

**漏洞编号:** CVE-2025-30216

**漏洞类型:** 堆溢出

**影响应用:** CryptoLib

**危害等级:** 高危，可能导致任意代码执行或系统不稳定

**影响版本:** <= 1.3.3

**利用条件:** 需要能够发送特制的TM协议数据包到运行CryptoLib的系统。

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2025-30216是CryptoLib库中Crypto_TM_ProcessSecurity函数中存在的堆溢出漏洞。漏洞发生在处理TM协议数据包的二级头部长度时。如果二级头部长度超过数据包的实际长度，在将数据包数据复制到动态分配的p_new_dec_frame缓冲区期间，会触发堆溢出。这使得攻击者能够覆盖相邻的堆内存，潜在地导致任意代码执行或系统不稳定。

**有效性评估：**

提供的PoC代码看起来是有效的。它提供了一个Python脚本，可以生成恶意TM数据包并检查数据包是否存在漏洞指示。该脚本允许指定溢出量，并且包含检测逻辑来验证`Secondary Header Length`是否大于可用空间，这是触发漏洞的必要条件。

**投毒风险评估：**

分析了PoC脚本，发现存在轻微的投毒风险，约为5%。虽然脚本主要用于生成和检查漏洞，但如果使用不当，例如在生产环境中未经授权的使用，可能会造成实际的损害。脚本本身并没有隐藏的恶意代码，但是利用该脚本进行攻击行为本身就是一种恶意行为。

**利用方式：**

1.  **生成恶意TM数据包：** 使用提供的`poc.py`脚本生成一个包含特制二级头部长度的TM数据包，该长度大于数据包的剩余长度。
2.  **发送数据包：** 将生成的恶意数据包发送到运行易受攻击的CryptoLib版本的系统。
3.  **触发溢出：** 当CryptoLib处理恶意数据包时，`Crypto_TM_ProcessSecurity`函数中的memcpy操作将尝试复制比缓冲区容量更多的数据，从而导致堆溢出。
4.  **利用溢出：** 成功触发溢出后，攻击者可以覆盖相邻的堆内存，并可能通过精心构造的数据覆盖执行任意代码或导致系统崩溃。

**缓解措施：**

*   升级到已修复此漏洞的CryptoLib版本。
*   实施输入验证，以确保二级头部长度不超过数据包的剩余长度。

**项目地址:** [oliviaisntcringe/CVE-2025-30216-PoC](https://github.com/oliviaisntcringe/CVE-2025-30216-PoC)

**漏洞详情:** [CVE-2025-30216](https://nvd.nist.gov/vuln/detail/CVE-2025-30216)