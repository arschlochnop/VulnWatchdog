## CVE-2023-6933 - WordPress Better Search Replace Plugin PHP对象注入

**漏洞编号:** CVE-2023-6933

**漏洞类型:** PHP对象注入

**影响应用:** WordPress Better Search Replace Plugin

**危害等级:** 高危，可能导致任意文件删除、敏感数据泄露或远程代码执行

**影响版本:** <= 1.4.4

**利用条件:** 目标系统需要安装受影响的Better Search Replace插件，并且存在其他含有POP链的插件或主题。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2023-6933存在于WordPress的Better Search Replace插件中，版本低于或等于1.4.4。该漏洞允许未经身份验证的攻击者通过反序列化不可信的输入来注入PHP对象。 

**有效性：**
该漏洞利用的有效性取决于目标系统上是否存在POP链。 Better Search Replace插件本身不包含POP链。如果目标系统上安装了另一个包含POP链的插件或主题，那么利用这个漏洞是可行的。提供的PoC展示了利用WordPress 6.4.0中 `WP_HTML_Token` 类，通过 `call_user_func` 函数实现代码执行的方法。这个方法依赖于可控的 `on_destroy` 属性指向恶意函数。

**投毒风险：**
在提供的漏洞利用代码中，投毒风险较低，估计为10%。主要风险在于：
1.  **恶意代码执行：** PoC的核心是利用`call_user_func`来执行代码，如果`on_destroy`被设置为指向恶意函数，就可能导致远程代码执行。
2.  **依赖外部环境：** 该PoC依赖于目标站点安装的其他插件或主题来提供POP链。如果目标站点不具备这个条件，那么该PoC无法直接利用成功。但潜在的风险是，攻击者可能会诱导用户安装存在POP链的插件，从而为攻击创造条件。
该代码看起来主要用于演示和验证漏洞，并没有明显的恶意行为，比如上传后门或窃取信息，但通过精心构造的`on_destroy`,可以写入恶意代码。

**利用方式：**
1.  **找到可利用的注入点：** 通过Better Search Replace插件的搜索替换功能，将序列化的PHP对象注入到数据库中。  根据PoC，可以通过插件的搜索和替换功能将序列化的对象注入到数据库表中。
2.  **构造恶意的PHP对象：** 构造包含POP链的PHP对象。 该PHP对象需要利用目标系统上已存在的类，并最终调用`call_user_func`或类似函数，执行任意代码。
3.  **触发反序列化：** 当插件处理包含恶意序列化对象的数据库记录时，PHP会尝试反序列化该对象，从而触发POP链，最终导致任意代码执行。
4. **利用WP_HTML_Token类** WordPress 6.4.0 中引入的`WP_HTML_Token`类可以被用于构造POP链，控制`on_destroy`属性指向恶意函数，从而实现代码执行。

**项目地址:** [w2xim3/CVE-2023-6933](https://github.com/w2xim3/CVE-2023-6933)

**漏洞详情:** [CVE-2023-6933](https://nvd.nist.gov/vuln/detail/CVE-2023-6933)