## CVE-2024-4577-PHP-CGI参数注入

**漏洞编号:** CVE-2024-4577

**漏洞类型:** OS命令注入

**影响应用:** PHP

**危害等级:** 高危，可导致远程代码执行

**影响版本:** PHP 8.1.* < 8.1.29, 8.2.* < 8.2.20, 8.3.* < 8.3.8, 且运行在Windows的CGI模式下，开启了Best Fit策略的系统

**利用条件:** 服务器运行在Windows系统，使用Apache和PHP-CGI，系统启用了Best-Fit代码页转换

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2024-4577 漏洞是一个PHP-CGI参数注入漏洞，当PHP以CGI模式在Windows服务器上运行时，如果启用了'Best Fit'代码页转换，攻击者可以通过构造特殊的URL，向PHP二进制文件传递恶意参数，从而导致任意代码执行。

**有效性：**
根据漏洞描述和利用代码，该漏洞的PoC代码是有效的。PoC通过在URL中注入`?%ADd+allow_url_include%3d1+%ADd+auto_prepend_file%3dphp://input`，并POST一段PHP代码，利用`allow_url_include`和`auto_prepend_file`的特性，实现远程代码执行。

**投毒风险：**
提供的PoC代码本身不包含明显的恶意代码或后门。脚本的功能是发送带有特定参数的HTTP POST请求以测试目标服务器是否存在漏洞。它使用 `phpinfo()` 函数来验证漏洞的存在，而没有尝试执行任何其他恶意操作. 因此，投毒风险为0%。

**利用方式：**
1.  **漏洞触发条件：**  目标服务器必须是运行在Windows系统上的PHP，并且是以CGI模式运行。另外，还需要开启了Best-Fit代码页转换。
2.  **攻击向量：**  通过构造恶意的HTTP请求，主要是GET参数，利用Windows系统的Best-Fit特性将某些字符转换为PHP可识别的选项参数。
3.  **利用方式：**  攻击者通过在URL中注入特定的参数，例如`?%ADd+allow_url_include%3d1+%ADd+auto_prepend_file%3dphp://input`。`allow_url_include=1` 允许包含远程文件，`auto_prepend_file=php://input` 允许执行POST数据中的PHP代码。
4.  **RCE：** 构造包含PHP代码的POST请求体，例如`<?php system($_GET['cmd']); ?>`，配合URL中的参数，即可在目标服务器上执行任意命令。也可以直接利用`<?php phpinfo(); ?>`来探测漏洞存在.

该漏洞利用的关键在于Windows系统的字符编码转换和PHP-CGI对参数的处理方式。

**项目地址:** [gmh5225/CVE-2024-4577-PHP-RCE](https://github.com/gmh5225/CVE-2024-4577-PHP-RCE)

**漏洞详情:** [CVE-2024-4577](https://nvd.nist.gov/vuln/detail/CVE-2024-4577)