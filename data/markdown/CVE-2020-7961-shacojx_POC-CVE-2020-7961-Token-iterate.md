## CVE-2020-7961 Liferay Portal 反序列化RCE

**漏洞编号:** CVE-2020-7961

**漏洞类型:** 反序列化RCE

**影响应用:** Liferay Portal

**危害等级:** 高危，允许远程攻击者执行任意代码

**影响版本:** 7.2.1 CE GA2之前版本

**利用条件:** 需要目标Liferay Portal实例开启JSON Web Services (JSONWS)

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2020-7961 存在于 Liferay Portal 7.2.1 CE GA2 之前的版本中，是一个反序列化漏洞。攻击者可以通过 JSON Web Services (JSONWS) 接口，发送特制的请求，其中包含恶意序列化的 Java 对象，导致服务器端执行任意代码。

**漏洞利用有效性：**
根据漏洞库信息、搜索引擎结果和提供的PoC代码，此漏洞的利用是有效的。多个来源都提到了该漏洞，并且存在公开的PoC。

**投毒风险分析：**
提供的PoC代码（poc.py）的主要功能是：
1.  获取`p_auth` token，如果获取失败则使用默认值。 
2.  构造包含恶意序列化对象的POST请求，利用`com.mchange.v2.c3p0.WrapperConnectionPoolDataSource` 类来执行任意命令。

检查`poc.py`发现了设置cmd的地方是`cmd2`和`defaultData:com.mchange.v2.c3p0.WrapperConnectionPoolDataSource`,其中`cmd2`应该没什么用,重点关注`defaultData`部分的反序列化攻击.

代码中使用了硬编码的URL `'https://site-demo.com/api/jsonws/invoke'`，如果未修改就使用此PoC，可能导致攻击无效。`POC-CVE-2020-7961-Token-iterate`这个名字来看，原始作者应该是尝试了迭代token的方式，但是最终的PoC来看，只是简单获取token，或者使用写死的token，所以存在一定的局限性。

因此，PoC **可能存在的投毒风险**在于：
*   **硬编码的URL：** 如果攻击者不修改URL，攻击将无效，但这不是恶意投毒，而可能是疏忽。
*   **依赖外部服务：** 如果`site-demo.com`被攻击者控制，可能导致PoC执行恶意代码，但此风险较低。
*  **反序列化对象本身可能隐藏更深层次的后门** 这部分需要更深入的分析，这里仅作推测。

综合评估，投毒的概率较低，大约为10%。 主要的风险在于使用者没有修改目标URL导致无法攻击。

**漏洞利用方式：**
1.  攻击者首先需要访问Liferay Portal的JSONWS接口(`/api/jsonws/invoke`)。
2.  攻击者从网页中提取或使用默认的`p_auth` token。
3.  攻击者构造一个包含恶意序列化数据的POST请求，通常利用`com.mchange.v2.c3p0.WrapperConnectionPoolDataSource`或其他易受攻击的类，来执行任意命令。
4.  服务器反序列化该对象时，将执行攻击者指定的恶意代码，从而导致远程代码执行。

**项目地址:** [shacojx/POC-CVE-2020-7961-Token-iterate](https://github.com/shacojx/POC-CVE-2020-7961-Token-iterate)

**漏洞详情:** [CVE-2020-7961](https://nvd.nist.gov/vuln/detail/CVE-2020-7961)