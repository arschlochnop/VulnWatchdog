## CVE-2021-3156 - Sudo Heap-Based Buffer Overflow

**漏洞编号:** CVE-2021-3156

**漏洞类型:** Heap-Based Buffer Overflow

**影响应用:** Sudo

**危害等级:** 高危，允许本地用户提升权限至root

**影响版本:** Sudo before 1.9.5p2

**利用条件:** 本地用户能够执行sudoedit -s

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-3156（Baron Samedit）是一个Sudo中的堆缓冲区溢出漏洞。此漏洞存在于sudo解析命令行参数的方式中，特别是当使用'sudoedit -s'命令并且命令行参数以单个反斜杠字符结尾时。攻击者可以利用此漏洞通过本地用户提升权限到root。

**有效性:**
根据提供的漏洞库信息、搜索引擎结果和漏洞利用代码，此漏洞利用代码是有效的。搜索结果中多个链接表明该漏洞已被积极利用，并且存在公开可用的PoC。

**投毒风险:**
分析PoC代码后，存在轻微的投毒风险。具体来说，`shellcode.c` 文件中的shellcode执行了`setuid(0)` 和 `setgid(0)`来提升权限，然后执行 `/bin/sh`。虽然看起来很直接，但存在将 `/bin/sh`替换为恶意程序或向shellcode中添加恶意功能的可能。Makefile看起来相对简单，但如果添加了额外的编译步骤来注入恶意代码，也存在一定的风险。总体而言，投毒风险较低，因为PoC本身的目标就是提权，替换/bin/sh可能会影响POC的可用性，但添加额外操作还是有可能的。

**利用方式:**
1.  漏洞利用代码首先构造一个包含大量 'Y' 字符并以反斜杠结尾的缓冲区 (`buf`)。此缓冲区用于触发堆缓冲区溢出。
2.  设置环境变量，如 `LC_MESSAGES`、`LC_TELEPHONE` 和 `LC_MEASUREMENT`，用于进行堆排布（heap feng shui），以将目标 `service_user` 结构放置在可预测的内存位置。`overflow`环境变量用于填充堆，并包含足够多的 'X' 字符，以覆盖到目标 `service_user` 结构。
3.  `execve` 函数调用 `sudoedit`，并传递构造的 `argv` (包含 `-s` 和溢出缓冲区) 和 `envp` (包含用于堆排布的环境变量)。
4.  通过溢出缓冲区，覆盖 `service_user` 结构中的 `files` 字段的 `name` 指针，使其指向 `libnss_x/x.so.2`的路径。
5.  `libnss_x/x.so.2` 是一个共享库，其中包含在 `_init` 函数中定义的 shellcode。由于 `name` 指针已被覆盖，当 `sudoedit` 尝试使用 `files` 字段时，它实际上会加载并执行此共享库中的 shellcode。
6.  Shellcode 执行 `setuid(0)` 和 `setgid(0)`，从而将有效用户 ID 和组 ID 设置为 root，然后执行 `/bin/sh`，从而产生一个 root shell。

总体而言，该漏洞利用通过堆缓冲区溢出覆盖了 `sudoedit` 中使用的内存结构，允许攻击者执行任意代码并获得 root 权限。

**项目地址:** [asepsaepdin/CVE-2021-3156](https://github.com/asepsaepdin/CVE-2021-3156)

**漏洞详情:** [CVE-2021-3156](https://nvd.nist.gov/vuln/detail/CVE-2021-3156)