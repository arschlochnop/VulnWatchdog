## CVE-2019-5736-runc容器逃逸

**漏洞编号:** CVE-2019-5736

**漏洞类型:** 容器逃逸

**影响应用:** runc (Docker等)

**危害等级:** 高危，可获取宿主机root权限

**影响版本:** <= 1.0-rc6 (Docker < 18.09.2)

**利用条件:** 攻击者需要控制容器内的root权限，或者能够通过docker exec进入容器。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2019-5736漏洞允许恶意容器覆盖宿主机上的runc二进制文件，从而获得宿主机的root权限。该漏洞的利用方式是：

1.  **攻击准备：** 攻击者需要有一个可以执行命令的容器环境，这个容器可以是新创建的（攻击者控制镜像），也可以是已存在的（攻击者之前拥有写权限，可以通过`docker exec`进入）。
2.  **漏洞触发：** 在容器内，攻击者运行恶意程序（如`evil.c`编译后的`/evil`）。
3.  **文件描述符劫持：** 恶意程序利用`/proc/self/fd/3`文件描述符，该描述符指向runc的二进制文件。
4.  **覆盖runc二进制文件：** 恶意程序将预先准备好的payload（如`/payload`）写入`/proc/self/fd/3`，从而覆盖宿主机上的runc二进制文件。
5.  **权限提升：** 下次运行runc时（例如启动新的容器），宿主机将会执行被覆盖的payload，从而获得宿主机的root权限。

**有效性：** 提供的POC代码是有效的，它演示了如何利用该漏洞覆盖宿主机上的runc二进制文件。

**投毒风险：** 提供的代码中，`evil.c`负责覆盖runc二进制文件，`payload`负责在runc被覆盖后执行恶意命令。`/payload` 文件非常简单，只包含一行`echo "YOU HAVE BEEN PWNED"`。投毒风险主要在于：

*   **`evil.c`**: 潜在的风险在于，攻击者可能在`evil.c`中添加额外的恶意代码，例如反弹shell、安装后门等。虽然提供的代码只是简单地将`/payload`写入runc，但攻击者可以修改该程序以执行更复杂的操作。如果对编译后的`evil`二进制文件进行反编译，可能会发现隐藏的恶意行为。
*   **`/payload`**: 攻击者可以修改 `/payload` 的内容，从而在宿主机上执行任意命令。`/payload` 的内容决定了容器逃逸后在宿主机上执行的操作。
*  **Dockerfile**: Dockerfile存在通过替换glibc来引入其他恶意代码的风险。虽然提供的Dockerfile似乎是为了编译和安装`evil.c`，存在加入其他恶意代码的可能。

由于以上风险分析，投毒风险比例判断为 10%。主要是作者可能修改了提供的代码，以添加更隐蔽的恶意行为。

**利用方式总结：** 该漏洞利用了runc处理文件描述符的缺陷，允许容器内的进程修改宿主机上的runc二进制文件。通过覆盖runc，攻击者可以在下次runc被调用时执行任意代码，从而实现容器逃逸并获得宿主机的root权限。

**项目地址:** [milloni/cve-2019-5736-exp](https://github.com/milloni/cve-2019-5736-exp)

**漏洞详情:** [CVE-2019-5736](https://nvd.nist.gov/vuln/detail/CVE-2019-5736)