## CVE-2018-6789 Exim base64d 缓冲区溢出远程代码执行漏洞

**漏洞编号:** CVE-2018-6789

**漏洞类型:** 缓冲区溢出

**影响应用:** Exim

**危害等级:** 高危，可能导致远程代码执行

**影响版本:** < 4.90.1

**利用条件:** 目标Exim服务开启且可网络访问

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2018-6789 是 Exim 邮件服务器中 base64d 函数存在的一个缓冲区溢出漏洞。攻击者可以通过发送特制的 SMTP 消息利用此漏洞实现远程代码执行。根据漏洞描述和提供的利用代码，该漏洞利用方式如下：

1.  **漏洞原理：** `base64d` 函数在解码 base64 编码的数据时，没有正确检查输入长度，导致缓冲区溢出。
2.  **利用方式：** 攻击者通过构造特殊的 base64 编码字符串，发送给 Exim 服务器。这个字符串会触发 `base64d` 函数的缓冲区溢出，覆盖内存中的数据，包括函数返回地址等关键信息。
3.  **POC 代码分析：** 提供的 Python 脚本 `exim.py` 实现了利用该漏洞的 POC。脚本通过以下步骤利用漏洞：
    *   **连接目标：** 连接到目标 Exim 服务器的 SMTP 端口（默认为 25）。
    *   **堆喷：** 通过发送 `EHLO` 命令，在堆上创建特定大小的空闲块。
    *   **单字节覆盖：** 通过精心构造的 base64 编码数据，实现单字节覆盖，扩展目标 chunk 的大小。
    *   **伪造 Chunk Header：** 覆盖堆上的 chunk header，以便能够释放扩展后的 chunk。
    *   **释放扩展 Chunk：** 释放扩展后的 chunk，造成堆的空洞。
    *   **再次填充堆：** 再次在堆上分配内存，并覆盖 chunk header，以便分配到 ACL store block。
    *   **覆盖 ACL Store Block 地址：** 覆盖 'next' 指针为ACL store block 地址
    *   **覆盖 `acl_smtp_rcpt`：** 覆盖 `acl_smtp_rcpt` 变量的值，该变量在处理 `RCPT TO` 命令时会被调用。脚本将该变量覆盖为 shell 命令，例如反弹 shell 命令。
    *   **触发漏洞：** 发送 `RCPT TO` 命令，触发 `acl_smtp_rcpt` 变量的执行，从而执行攻击者注入的 shell 命令，实现远程代码执行。

4.  **有效性：** 根据漏洞描述、搜索结果以及提供的 POC 代码，可以判定该漏洞是有效的，并且存在公开的利用代码。
5.  **投毒风险：** 检查了提供的利用代码，没有发现明显的恶意代码或者后门。虽然代码本身是为了利用漏洞，但没有发现额外的、与漏洞利用无关的恶意行为。因此，投毒风险评估为0%。该脚本的目的是验证和利用漏洞，而不是植入后门或执行其他恶意操作。

**项目地址:** [thistehneisen/CVE-2018-6789-Python3](https://github.com/thistehneisen/CVE-2018-6789-Python3)

**漏洞详情:** [CVE-2018-6789](https://nvd.nist.gov/vuln/detail/CVE-2018-6789)