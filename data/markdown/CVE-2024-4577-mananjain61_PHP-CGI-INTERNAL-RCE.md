## CVE-2024-4577 PHP-CGI 参数注入导致 RCE

**漏洞编号:** CVE-2024-4577

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** PHP (Windows, CGI 模式)

**危害等级:** 严重，未经身份验证的攻击者可以在受影响的服务器上执行任意代码。

**影响版本:** PHP 8.1.* < 8.1.29, 8.2.* < 8.2.20, 8.3.* < 8.3.8，并且运行在Windows的CGI模式下

**利用条件:** 需要在Windows上运行的PHP，并配置为CGI模式，且开启了使用 "Best Fit" 策略的代码页

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-4577 是一个 PHP-CGI 参数注入漏洞，存在于 Windows 版本的 PHP 中，当 PHP 以 CGI 模式运行时，如果系统配置为使用某些代码页，Windows 可能会使用 "Best-Fit" 行为来替换传递给 Win32 API 函数的命令行中的字符。PHP CGI 模块可能会错误地将这些字符解释为 PHP 选项，从而允许恶意用户将选项传递给正在运行的 PHP 二进制文件，从而泄露脚本源代码或在服务器上执行任意 PHP 代码。

**有效性：**

从漏洞库信息和搜索引擎结果来看，该漏洞已被广泛证实有效，且存在公开可用的PoC代码。Akamai 等安全公司已经观察到针对该漏洞的利用尝试。

提供的PoC代码通过 DNS rebinding 技术，允许攻击者绕过同源策略 (SOP)，从而访问内部网络基础设施上运行的 PHP-CGI 实例。攻击者可以通过修改`client.html`中的`payload`变量来定制要执行的 PHP 代码。

**投毒风险：**

PoC 代码主要目的是利用 DNS rebinding 攻击内部网络，并执行指定的 PHP 代码。虽然代码本身用于验证漏洞和进行渗透测试，但存在以下潜在风险：

1.  **DNS rebinding 的风险：** DNS rebinding 攻击可能导致受害者浏览器访问攻击者控制的恶意站点，从而造成信息泄露或其他安全问题。
2.  **后门代码：** 检查代码发现，代码中存在硬编码的IP地址，攻击者可以通过修改这些IP地址进行恶意活动，或者在`client.html`中插入恶意代码，诱导用户执行。
3.  **依赖第三方服务：** 代码依赖 DuckDNS，若 DuckDNS 服务被攻破，可能导致利用代码被篡改。

综合评估，代码本身存在一定的风险，但恶意投毒的可能性较低，主要风险集中在使用者对PoC代码的修改和DNS rebinding攻击本身带来的风险。因此，投毒风险评估为 10%。

**利用方式：**

1.  **配置 DuckDNS：** 攻击者需要在 DuckDNS 注册一个域名，并获取 token。
2.  **配置 PoC 代码：** 攻击者需要修改`server.py` 中的 `PUBLIC_IP`、`DUCKDNS_DOMAIN` 和 `DUCKDNS_TOKEN`，以及 `client.html` 中的 `PAYLOAD_TARGETS` 来指定要攻击的目标 IP 地址。同时，修改`client.html`中的`payload`变量，来指定要执行的php代码。
3.  **运行 server.py：** 攻击者运行 `server.py` 脚本，该脚本负责更新 DuckDNS 的 DNS 记录。
4.  **诱骗受害者访问 client.html：** 攻击者诱骗受害者（内部网络用户）使用浏览器访问 `client.html` 页面。`client.html` 会执行 DNS rebinding 攻击，将域名解析到内部网络的 IP 地址，然后向目标 PHP-CGI 服务器发送包含恶意 PHP 代码的请求。
5.  **执行任意代码：** 如果目标服务器存在 CVE-2024-4577 漏洞，恶意 PHP 代码将被执行，攻击者从而获得服务器的控制权。

**项目地址:** [mananjain61/PHP-CGI-INTERNAL-RCE](https://github.com/mananjain61/PHP-CGI-INTERNAL-RCE)

**漏洞详情:** [CVE-2024-4577](https://nvd.nist.gov/vuln/detail/CVE-2024-4577)