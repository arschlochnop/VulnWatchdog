## CVE-2024-4577-PHP-CGI Argument Injection

**漏洞编号:** CVE-2024-4577

**漏洞类型:** OS Command Injection

**影响应用:** PHP

**危害等级:** 高危，可能导致远程代码执行

**影响版本:** PHP 8.1.* before 8.1.29, 8.2.* before 8.2.20, 8.3.* before 8.3.8 (Windows with CGI)

**利用条件:** PHP running in CGI mode on Windows with a codepage using "Best Fit" strategy enabled. 需要网络访问。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-4577 漏洞是 PHP 在 Windows 系统上以 CGI 模式运行时出现的一个参数注入漏洞。由于 Windows 系统使用了 "Best Fit" 策略的代码页，恶意用户可以通过构造特殊字符，使得 PHP CGI 模块错误地将这些字符解析为 PHP 选项。这允许攻击者向 PHP 解释器传递恶意参数，从而执行任意 PHP 代码或者泄露源代码。

**利用方式：**

1.  **攻击向量：** 通过 HTTP 请求的 URL query string 传递恶意参数。
2.  **漏洞原理：**  Windows 的 "Best Fit" 代码页转换功能可能会将某些字符转换为其他字符，导致 PHP CGI 错误解析命令行参数。
3.  **攻击步骤：**
    *   构造包含恶意 PHP 选项的 URL，例如 `-d allow_url_include=1 -d auto_prepend_file=php://input`，允许包含远程文件。
    *   发送包含 PHP 代码的 POST 请求。
    *   利用 `php://input` 或 `data://` 等 wrapper 执行恶意代码。

**POC 代码分析：**

POC 代码 (`CVE-2024-4577.py`) 主要功能如下：

*   **Base64 编码：** 提供 Base64 编码函数，用于绕过某些过滤。
*   **服务器监听：** 包含一个简单的 TCP 服务器，可能用于接收反弹 shell（但代码中没有明确实现反弹 shell 功能）。
*   **SSL 检查：** 检查目标 URL 是否支持 SSL/TLS。
*   **WAF 检测：** 尝试绕过 Web 应用防火墙 (WAF)。 通过修改lfi参数和重新组合绕过waf。
*   **语法检查：** 通过发送包含特定 Flag 的 PHP 代码，检查目标是否容易受到Payload的影响并判断哪种方式可行。
*   **RCE 执行：** 利用 `php://input` 或 `data://` wrapper 执行任意 PHP 代码。

**投毒风险分析：**

该 POC 代码存在一定的投毒风险，约为 10%。主要风险点在于代码中的一些函数，例如服务器监听函数，可能被用于植入后门或执行其他恶意操作。虽然代码中没有明显的恶意行为，但攻击者可以修改代码以实现持久化控制或窃取敏感信息。代码中包含尝试绕过waf的操作,虽然出发点是尝试漏洞利用, 但也可能隐藏其他利用。

**有效性：**

根据漏洞库信息和搜索结果，该漏洞已经得到广泛证实，并且存在实际的利用案例。POC 代码的有效性较高，可以成功利用该漏洞在目标系统上执行任意 PHP 代码。

**总结：**

CVE-2024-4577 是一个严重的安全漏洞，攻击者可以利用该漏洞在受影响的 Windows 服务器上执行任意代码。建议尽快升级 PHP 版本，或者采取其他缓解措施。

**项目地址:** [BTtea/CVE-2024-4577-RCE-PoC](https://github.com/BTtea/CVE-2024-4577-RCE-PoC)

**漏洞详情:** [CVE-2024-4577](https://nvd.nist.gov/vuln/detail/CVE-2024-4577)