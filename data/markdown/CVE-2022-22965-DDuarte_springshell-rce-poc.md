## CVE-2022-22965-Spring4Shell-RCE

**漏洞编号:** CVE-2022-22965

**漏洞类型:** 远程代码执行（RCE）

**影响应用:** Spring Framework

**危害等级:** 高危，可能导致服务器完全控制

**影响版本:** Spring Framework versions 5.3.X prior to 5.3.18+, 5.2.x prior to 5.2.20+ and all old and unsupported versions

**利用条件:** JDK 9+, Tomcat with WAR deployment, vulnerable Spring version, no blocklist on WebDataBinder/InitBinder, parameter bind with POJOs directly, writeable file system

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2022-22965，又名Spring4Shell，是一个Spring Framework中的远程代码执行漏洞。漏洞利用源于在JDK 9+环境中，当应用程序部署为WAR包在Tomcat上运行时，攻击者可以通过操纵类加载器来修改Tomcat的访问日志配置，进而写入恶意的JSP webshell，最终实现远程代码执行。提供的POC代码通过发送包含恶意参数的POST请求到易受攻击的应用程序的index端点。这些参数用于修改Tomcat的日志记录管道，特别是配置一个logger，将JSP代码写入到webapps/ROOT目录下的一个文件中（tomcatwar.jsp）。然后，POC尝试访问这个JSP文件，如果成功访问并返回500错误，则表示webshell已成功部署，可以通过传递cmd参数执行任意命令。Dockerfile构建了一个易受攻击的Spring应用，并将其部署到Tomcat服务器上，为漏洞利用提供环境。

**有效性：**根据漏洞描述和提供的POC代码，该POC在满足特定条件下（如JDK版本、Tomcat部署方式、Spring版本等）应该是有效的。

**投毒风险：** 评估投毒风险为10%。
*   Dockerfile中的构建过程相对透明，主要依赖于官方Maven和Tomcat镜像。虽存在供应链投毒风险，但概率较低。
*   pom.xml文件指定了依赖项，存在引入恶意依赖的风险，但当前依赖项均为常见的Spring组件，直接投毒的可能性较低。
*   poc.py脚本主要用于漏洞利用，虽然本身是攻击代码，但与投毒无关。
*   总体而言，仓库的投毒风险较低，主要集中在供应链攻击层面，例如Maven中央仓库的依赖包被篡改。但考虑到公开的漏洞利用仓库通常会接受安全社区的审查，恶意投毒的概率相对较低。

**利用方式：**
1.  **发送恶意请求：** 攻击者发送一个包含特殊构造的参数的HTTP请求到Spring MVC或Spring WebFlux应用程序。
2.  **修改Tomcat日志配置：** 这些参数用于修改Tomcat服务器的访问日志配置。
3.  **写入Webshell：** 通过修改日志配置，将一个恶意的JSP webshell写入到Tomcat的webapps目录。
4.  **远程代码执行：** 攻击者通过访问写入的JSP webshell，传递命令参数，实现在服务器上执行任意代码。

**项目地址:** [DDuarte/springshell-rce-poc](https://github.com/DDuarte/springshell-rce-poc)

**漏洞详情:** [CVE-2022-22965](https://nvd.nist.gov/vuln/detail/CVE-2022-22965)