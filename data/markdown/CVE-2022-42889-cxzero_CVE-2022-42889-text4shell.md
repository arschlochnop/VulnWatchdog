## CVE-2022-42889 - Apache Commons Text RCE (Text4Shell)

**漏洞编号:** CVE-2022-42889

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Apache Commons Text

**危害等级:** 高危，可能导致服务器完全控制

**影响版本:** 1.5 <= 版本 <= 1.9

**利用条件:** 应用程序使用受影响版本的 Apache Commons Text，并且允许用户控制的输入传递给 StringSubstitutor.replace() 或 StringSubstitutor.replaceIn() 方法进行插值。

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2022-42889，也被称为 Text4Shell，是一个存在于 Apache Commons Text 库中的高危漏洞。该漏洞源于库中 StringSubstitutor 类的变量插值功能。如果应用程序使用受影响版本（1.5 到 1.9）的 Apache Commons Text，并且允许用户控制的输入用于字符串插值，那么攻击者可以通过构造恶意输入来执行任意代码。

**利用方式：**

攻击者可以利用 `${prefix:name}` 格式的字符串，其中 `prefix` 指定了用于查找 `StringLookup` 实例的前缀。漏洞存在于以下几个 lookup 中：

*   **script:** 允许使用 JVM 脚本执行引擎（javax.script）执行表达式。例如，在 JDK 15 之前，可以使用 Nashorn 引擎执行 JavaScript 代码，从而执行任意命令：`${script:javascript:java.lang.Runtime.getRuntime().exec('touch /tmp/foo')}`。在 JDK 15 及更高版本中，如果应用程序包含 JEXL 等第三方依赖，仍然可能通过类似方式执行代码。
*   **dns:** 允许解析 DNS 记录。虽然不能直接执行代码，但可以用于信息收集或发起拒绝服务攻击：`${dns:address|commons.apache.org}`。
*   **url:** 允许从指定的 URL 加载值，包括远程服务器。这可以用来读取敏感信息或通过 SSRF 发起攻击：`${url:UTF-8:https://nvd.nist.gov/vuln/detail/CVE-2022-42889}`。

**POC 分析：**

提供的 Dockerfile 和 README 文件提供了一个可用于测试和验证此漏洞的 POC 环境。Dockerfile 设置了所需的 Java 环境，并编译和运行包含漏洞的应用程序。README 提供了不同利用方式的示例，包括使用 `script`、`dns` 和 `url` lookup 的 payload。

**投毒风险分析：**

根据提供的文件内容，该仓库的主要目的是为了重现和演示 CVE-2022-42889 漏洞。评估投毒风险较低。Dockerfile虽然安装了一些如netcat，wget，curl等工具，可以辅助漏洞验证。但根据POC利用的常规方式，以及参考互联网上已公开的POC和EXP来看，这些工具都是常规操作。

**总结：**

CVE-2022-42889 是一个严重的安全漏洞，允许攻击者远程执行代码。应用程序应尽快升级到 Apache Commons Text 1.10.0 或更高版本，以禁用有问题的 interpolator，并仔细审查代码，确保用户提供的输入不会用于字符串插值。提供的 POC 代码对于理解和验证漏洞非常有用，但应谨慎使用，并采取适当的安全措施。

**项目地址:** [cxzero/CVE-2022-42889-text4shell](https://github.com/cxzero/CVE-2022-42889-text4shell)

**漏洞详情:** [CVE-2022-42889](https://nvd.nist.gov/vuln/detail/CVE-2022-42889)