## CVE-2019-3396 - Atlassian Confluence Widget Connector Server-Side Template Injection

**漏洞编号:** CVE-2019-3396

**漏洞类型:** 服务器端模板注入 (Server-Side Template Injection)

**影响应用:** Atlassian Confluence Server

**危害等级:** 高危，允许远程攻击者在Confluence Server或Data Center实例上实现路径遍历和远程代码执行。

**影响版本:** 受影响版本：Confluence Server 6.6.12之前，6.7.0至6.12.3之前，6.13.0至6.13.3之前，6.14.0至6.14.2之前。

**利用条件:** 需要 Confluence 实例启用了 Widget Connector 宏，并且攻击者可以访问包含该宏的页面。

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2019-3396 是 Atlassian Confluence Server 中的一个服务器端模板注入漏洞，存在于 Widget Connector 宏中。 远程攻击者可以通过构造恶意的 Velocity 模板代码，利用该宏执行任意代码。根据漏洞库信息、搜索引擎结果和提供的漏洞利用代码，此漏洞利用是有效的。提供的POC代码包含两个文件：`calc.vm` 和 `os.vm`。

*   `calc.vm`: 该文件使用 Velocity 模板语言执行命令 `calc`（在Windows系统中会打开计算器）。这表明该漏洞能够执行任意命令。
*   `os.vm`: 该文件使用 Velocity 模板语言获取系统属性 `user.dir` (用户工作目录) 和 `user.name` (用户名)。这表明该漏洞可以读取服务器上的敏感信息。

利用方式：

1.  攻击者找到或创建一个包含 Widget Connector 宏的 Confluence 页面。
2.  攻击者在 Widget Connector 宏中插入恶意的 Velocity 模板代码，例如 `calc.vm` 或 `os.vm` 中的代码。
3.  当 Confluence 服务器渲染该页面时，会执行 Velocity 模板代码，从而导致远程代码执行或信息泄露。

关于投毒风险：

提供的POC代码没有明显的投毒代码。`calc.vm` 只是为了验证远程代码执行，`os.vm` 只是读取系统属性。此处的“投毒”指的是在POC中包含一些恶意代码，使得在测试漏洞时不经意间执行了恶意操作，或者留下后门。 提供的代码没有这种行为，因此投毒风险评估为0%。搜索引擎的结果也显示该漏洞在野外被利用来传播恶意软件，如加密货币矿工和勒索软件，表明该漏洞的真实风险很高。


**项目地址:** [pyn3rd/CVE-2019-3396](https://github.com/pyn3rd/CVE-2019-3396)

**漏洞详情:** [CVE-2019-3396](https://nvd.nist.gov/vuln/detail/CVE-2019-3396)