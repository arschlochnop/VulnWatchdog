## CVE-2019-3396-Atlassian Confluence-服务器端模板注入

**漏洞编号:** CVE-2019-3396

**漏洞类型:** 服务器端模板注入 (SSTI)

**影响应用:** Atlassian Confluence

**危害等级:** 高危，可能导致远程代码执行 (RCE) 和敏感信息泄露

**影响版本:** Confluence Server before 6.6.12, from 6.7.0 before 6.12.3, from 6.13.0 before 6.13.3, and from 6.14.0 before 6.14.2

**利用条件:** 需要能够向 Confluence Server 发送 HTTP 请求,并且 Widget Connector 宏可用。

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2019-3396 是 Atlassian Confluence 中 Widget Connector 宏存在的一个服务器端模板注入漏洞。攻击者可以通过构造恶意的 Velocity 模板代码，利用 Widget Connector 宏的参数，在服务器端执行任意代码。

**有效性评估:**
根据漏洞库信息、搜索结果以及提供的漏洞利用代码，该漏洞的POC代码是有效的。Exploit-DB 上的 46731 提供了利用该漏洞的 PoC。搜索引擎结果中也提到多个 PoC 的分析和实际攻击事件。

**投毒风险分析:**
提供的代码包含以下文件：
*   `README.md`: 描述了漏洞 CVE-2019-3396
*   `cmd.vm`: Velocity 模板，用于执行命令。该文件通过 Java 反射调用 `java.lang.Runtime` 来执行系统命令，其中 `$cmd` 变量应该是由攻击者控制的参数。
*   `evil.dtd`: 用于 XXE (XML External Entity) 攻击，尝试通过外部实体引入远程文件。此文件配置为访问 `http://phpshexxe.abcdef.5o1.in/?%file;` 看起来是一个尝试进行数据外泄的 URL
*   `os.vm`: Velocity 模板，用于获取服务器的操作系统信息和用户目录。它使用 Java 反射调用 `java.lang.System` 来获取系统属性。

`evil.dtd` 中的外部连接可能存在一定的风险，可能将服务器的文件内容发送到 `phpshexxe.abcdef.5o1.in`。这是一种潜在的数据泄露尝试。如果攻击者控制了该域名，他们就可以接收到 Confluence 服务器的文件内容。`phpshexxe.abcdef.5o1.in` 这个域名很可疑，具有进行恶意数据收集或攻击的可能性。但此行为更像是payload的一部分而非投毒。所以，投毒的概率相对较低，约为 5%。

**利用方式:**
利用方式主要包括以下步骤：

1.  **构造恶意 Velocity 模板:** 攻击者构造包含恶意代码的 Velocity 模板，例如 `cmd.vm` 中利用 Java 反射执行系统命令的代码。
2.  **利用 Widget Connector 宏:** 攻击者利用 Confluence 的 Widget Connector 宏，将构造好的恶意 Velocity 模板作为宏的参数传递给服务器。
3.  **服务器端执行:** Confluence 服务器解析 Widget Connector 宏时，会执行恶意 Velocity 模板中的代码，从而实现远程代码执行。
4. **XXE攻击:** `evil.dtd`文件可以配合其他payload尝试读取服务器文件，但依赖于服务器是否允许外部实体的解析。

总而言之，该漏洞的利用方式是典型的服务器端模板注入攻击，攻击者通过控制模板内容来执行任意代码。

**项目地址:** [s1xg0d/CVE-2019-3396](https://github.com/s1xg0d/CVE-2019-3396)

**漏洞详情:** [CVE-2019-3396](https://nvd.nist.gov/vuln/detail/CVE-2019-3396)