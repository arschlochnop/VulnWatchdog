## CVE-2025-37899 - Linux Kernel ksmbd use-after-free

**漏洞编号:** CVE-2025-37899

**漏洞类型:** Use-After-Free

**影响应用:** Linux Kernel ksmbd

**危害等级:** 高危，可能导致拒绝服务或代码执行

**影响版本:** 5.15 <= version < 6.12.28, 5.15 <= version < 6.14.6, 5.15 <= version < 6.15-rc5

**利用条件:** 需要启用ksmbd服务，并通过SMB协议与目标系统建立连接。

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2025-37899是Linux内核ksmbd服务中发现的use-after-free漏洞，存在于会话注销过程中。

**漏洞分析：**
根据漏洞库信息，漏洞位于`fs/smb/server/smb2pdu.c`文件中。当会话注销时，`sess->user`对象可能被其他线程使用，例如另一个连接发送了会话设置请求并绑定到正在释放的会话。如果该连接的处理程序在`smb2_sess_setup`函数中，则可能会使用`sess->user`，导致use-after-free。

根据提供的PoC代码，攻击者利用krb5认证流程中的一个竞争条件。在`krb5_authenticate`函数中，如果会话有效，`sess->user`会被提前释放，然后尝试进行krb5认证。如果krb5认证失败，`sess->user`将保持释放状态，但会话仍然存在，留下悬挂指针，导致后续访问该指针时触发use-after-free漏洞。

**利用方式：**
1.  利用PoC中的krb5认证方法，构造恶意的SMB请求数据包，触发`krb5_authenticate`函数中的漏洞代码。
2.  发送SMB2会话建立请求，进行krb5认证。
3.  在`ksmbd_krb5_authenticate`函数中，通过特定的输入触发认证失败，例如提供无效的SPNEGO令牌或krb5票据。
4.  认证失败后，`sess->user`保持释放状态，后续访问触发use-after-free。
5.  利用use-after-free漏洞，控制程序执行流程或造成拒绝服务。

**有效性：**
根据分析和PoC代码，该漏洞利用是有效的，PoC代码验证了此漏洞存在。

**投毒风险：**
该代码仓库主要包含漏洞分析文档，audit请求和利用代码，未发现明显的恶意代码，但作者可能隐藏了未公开的利用方式。由于该PoC的目的是展示漏洞发现的过程，所以存在一定低风险的投毒可能，但概率较低。 评估投毒风险为5%。


**项目地址:** [SeanHeelan/o3_finds_cve-2025-37899](https://github.com/SeanHeelan/o3_finds_cve-2025-37899)

**漏洞详情:** [CVE-2025-37899](https://nvd.nist.gov/vuln/detail/CVE-2025-37899)