## CVE-2017-9822 DotNetNuke Cookie Deserialization RCE

**漏洞编号:** CVE-2017-9822

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** DotNetNuke (DNN)

**危害等级:** 高危，可能导致服务器被完全控制

**影响版本:** 5.0.0 - 9.1.0 (Fixed in 9.1.1)

**利用条件:** 目标DNN站点使用默认的404错误页面配置（或任何会触发用户profile加载的情况），攻击者需要能够设置cookie。

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2017-9822 是一个 DotNetNuke (DNN) CMS 的远程代码执行漏洞。该漏洞源于 DNN 使用 `DNNPersonalization` cookie 来存储匿名用户的个性化设置。当 DNN 被配置为使用其内置的错误页面来处理 404 错误时（默认配置），应用程序会尝试加载当前用户的配置文件数据，从而触发对该 cookie 的反序列化。

`DNN Platform/Library/Common/Utilities/XmlUtils.cs` 中的 `DeSerializeHashtable` 函数存在不安全的反序列化。

**利用方式：**

1.  **构造恶意 Cookie：**  攻击者利用 YSoSerial.net 等工具生成包含恶意序列化对象的 XML 数据，并将其设置为 `DNNPersonalization` cookie 的值。其中 type 属性可以控制反序列化的类型。
2.  **触发反序列化：**  攻击者访问一个不存在的页面，触发 DNN 的 404 错误处理机制。
3.  **执行任意代码：**  由于不安全的反序列化，恶意对象被还原，导致服务器执行攻击者预设的任意代码。

**PoC 代码分析：**

提供的 PoC 代码使用了 `System.Data.Services.Internal.ExpandedWrapper` 和 `System.Windows.Data.ObjectDataProvider` 类来执行任意代码。`MethodName` 设置为 `WriteFile`，`MethodParameters` 设置为要写入的文件名。`ObjectInstance` 为 `FileSystemUtils`。

PoC 代码的目的是读取 `C:\Windows\win.ini` 文件，如果成功，服务器会将该文件的内容返回在响应体中。

**投毒风险评估：**

在提供的 PoC 代码中，没有发现明显的投毒代码。该代码的目的是验证漏洞的存在，而不是植入恶意后门。

综合来看，POC代码是安全的，但使用者需要明白其目的。

**项目地址:** [murataydemir/CVE-2017-9822](https://github.com/murataydemir/CVE-2017-9822)

**漏洞详情:** [CVE-2017-9822](https://nvd.nist.gov/vuln/detail/CVE-2017-9822)