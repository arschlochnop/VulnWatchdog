## CVE-2024-36401 - GeoServer远程代码执行

**漏洞编号:** CVE-2024-36401

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** GeoServer

**危害等级:** 严重，未授权的远程代码执行

**影响版本:** 受影响版本包括 2.23.0 到 2.23.6，2.24.0 到 2.24.4，2.25.0 到 2.25.2，以及低于 2.22.6 的版本。

**利用条件:** 默认 GeoServer 安装，网络可访问。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-36401 是 GeoServer 中的一个远程代码执行漏洞，由于 GeoTools 库 API 不安全地将属性名称作为 XPath 表达式传递给 commons-jxpath 库，导致攻击者可以通过构造特定的 OGC 请求（如 WFS GetFeature、WFS GetPropertyValue、WMS GetMap、WMS GetFeatureInfo、WMS GetLegendGraphic 和 WPS Execute）来执行任意代码。漏洞利用通过修改property/attribute，使之成为恶意的xpath表达式，触发commons-jxpath执行代码。提供的 PoC 代码 `GeoExplorer` 旨在扫描 GeoServer 实例并利用此漏洞。 

**有效性：**

根据漏洞库信息、搜索结果以及提供的 PoC 代码，此漏洞是有效的并且已被积极利用。搜索结果中多个链接表明该漏洞已被公开披露，并且有威胁情报报告指出该漏洞已被恶意利用。

**投毒风险：**

分析提供的 PoC 代码，主要的投毒风险在于：

1.  **Catcher URL:** `client/main.py` 脚本中使用了 `-c` 参数指定 catcher URL，用于接收被利用的服务器的回调。攻击者可以控制这个 URL，将受害者重定向到恶意站点或者收集敏感信息。虽然默认值指向本地地址，但用户如果配置不当，则存在风险。
2.  **wget Payload:**  PoC 使用 `wget` 作为 payload，这本身存在一定风险。虽然 `wget` 通常用于下载文件，但恶意用户可能会利用它执行其他恶意操作。例如，下载并执行一个 shell 脚本。
3. **依赖风险:** 该POC依赖requests, argparse, urllib3等第三方库，如果作者上传了包含恶意代码的软件包到Pypi，存在一定的供应链风险.

综合分析，PoC 代码本身主要用于漏洞验证和利用，但如果使用者不小心配置或被中间人攻击替换catcher URL，则可能存在一定投毒风险。假设用户会检查和修改 catcher URL，并从官方源安装依赖，因此评估投毒风险为10%。

**利用方式：**

1.  **扫描目标：** 使用 PoC 客户端扫描存在漏洞的 GeoServer 实例。
2.  **发现FeatureType：** 利用`ListStoredQueries` request on WFS 获取feature type
3.  **构造恶意请求：** PoC 通过构造包含恶意 XPath 表达式的 OGC 请求，例如 WFS GetFeature 请求，来触发漏洞。XPath 表达式注入到 property/attribute name 中。
4.  **远程代码执行：** GeoServer 解析请求时，`commons-jxpath` 库会执行恶意 XPath 表达式，从而导致远程代码执行。
5.  **回调：**  被利用的服务器通过 `wget` 向指定的 catcher URL 发送请求，表明漏洞利用成功。

**项目地址:** [justin-p/geoexplorer](https://github.com/justin-p/geoexplorer)

**漏洞详情:** [CVE-2024-36401](https://nvd.nist.gov/vuln/detail/CVE-2024-36401)