## CVE-2022-29464 - WSO2 Unrestricted File Upload and RCE

**漏洞编号:** CVE-2022-29464

**漏洞类型:** 文件上传/远程代码执行

**影响应用:** WSO2 API Manager, Identity Server, Enterprise Integrator, Open Banking AM/KM

**危害等级:** 高危，可导致远程代码执行，完全控制服务器

**影响版本:** WSO2 API Manager 2.2.0 up to 4.0.0, WSO2 Identity Server 5.2.0 up to 5.11.0, WSO2 Identity Server Analytics 5.4.0, 5.4.1, 5.5.0 and 5.6.0, WSO2 Identity Server as Key Manager 5.3.0 up to 5.11.0, WSO2 Enterprise Integrator 6.2.0 up to 6.6.0, WSO2 Open Banking AM 1.4.0 up to 2.0.0 and WSO2 Open Banking KM 1.4.0, up to 2.0.0

**利用条件:** 需要网络访问，目标服务器运行受影响的WSO2产品

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2022-29464是一个存在于多个WSO2产品中的高危漏洞，它允许未经授权的文件上传，最终导致远程代码执行。攻击者利用`/fileupload`端点，并通过`Content-Disposition`头部的目录遍历序列，将恶意JSP文件上传到web根目录下的可访问位置，例如`../../../../repository/deployment/server/webapps/authenticationendpoint/`。一旦上传成功，攻击者就可以通过访问该JSP文件来执行任意命令。\n\n**有效性：**\n提供的POC代码看起来有效。它使用requests库发送一个POST请求到`/fileupload/toolsAny`端点，并在files参数中构造包含目录遍历的文件上传请求。状态码判断上传是否成功，并输出shell的访问路径。根据搜索引擎结果，该漏洞被积极利用，说明POC的有效性较高。\n\n**投毒风险：**\n分析提供的POC代码，未发现明显的投毒代码。`main.py` 脚本的功能是上传用户指定的JSP文件。`shell.jsp` 包含一个简单的表单，允许用户执行shell命令，并将输出和错误信息显示在网页上。该JSP Shell功能较为完善，考虑到了stdout和stderr的捕获,并使用了BufferedReader读取过程的输出流和错误流。脚本的README.md中明确声明免责声明和警告，建议在测试环境中使用。因此，判定投毒风险为0%。\n\n**利用方式：**\n1.  攻击者构造包含目录遍历的恶意文件上传请求。\n2.  将该请求发送到WSO2服务器的`/fileupload`端点。\n3.  WSO2服务器未对上传的文件类型和路径进行充分验证，允许攻击者将JSP文件上传到web根目录下的`authenticationendpoint`目录。\n4.  攻击者通过浏览器访问上传的JSP文件，触发JSP代码执行，从而在服务器上执行任意命令。\n5.  通过执行任意命令获取服务器权限，读取敏感信息，例如数据库凭据。\n6.  利用数据库凭据访问数据库，获取更多敏感信息。

**项目地址:** [jimidk/Better-CVE-2022-29464](https://github.com/jimidk/Better-CVE-2022-29464)

**漏洞详情:** [CVE-2022-29464](https://nvd.nist.gov/vuln/detail/CVE-2022-29464)