## CVE-2024-39840 - Factorio RCE

**漏洞编号:** CVE-2024-39840

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Factorio

**危害等级:** 高危，允许远程代码执行

**影响版本:** < 1.1.101

**利用条件:** 需要服务器运行恶意地图，并由客户端连接

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-39840 存在于 Factorio 1.1.101 之前的版本中。攻击者可以构造恶意服务器，诱骗客户端连接，通过特制的地图文件，利用 Lua 脚本的漏洞，执行任意代码。

**有效性:**
从提供的漏洞信息和 POC 代码来看，该漏洞利用是有效的。漏洞库信息中明确指出利用自定义地图和特定的 Lua 函数功能可以执行任意代码，memorycorruption.net 的文章详细解释了该漏洞的原理。POC 代码实现了内存地址泄漏和任意读写功能，是构成 RCE 的基础。

**投毒风险:**
POC 代码本身相对复杂，主要涉及 Lua 脚本的字节码操作和内存布局，存在一定的隐藏恶意代码的可能性。但总体来说，代码主要围绕漏洞利用展开，没有发现明显的后门或恶意行为。因此，评估投毒风险为 10%。风险主要存在于作者是否在某些细节上做了手脚，比如隐藏了某些特定的指令或触发条件。

**利用方式:**
1.  **漏洞原理:** Factorio 客户端在加载服务器提供的自定义地图时，会执行地图中包含的 Lua 脚本。该漏洞利用了 Factorio 中 Lua 脚本引擎的一些特性，结合 double 类型数据的精度问题进行地址泄漏。
2.  **地址泄漏:** POC 代码首先通过 `double_to_number_trio` 函数将 double 类型转换为 number 类型来泄漏内存地址。`asnum` 函数和 `string.dump` 的组合用于获取指定变量的地址。
3.  **构建 Fake Object:** 使用 `make_fake_obj` 函数创建伪造的 Lua 对象。关键在于构造 `fakeProto` 和 `fakeClosure`，通过精心设计的内存布局，让 Lua 引擎将攻击者控制的数据当做对象来处理。
4.  **任意读写:** 构造 `read_primitive` 和 `write_primitive` 函数，实现对任意内存地址的读取和写入。这两个函数都利用了 Lua 的闭包 (closure) 和 upvalue 机制，结合 `string.dump` 产生的字节码，来实现内存读写。
5.  **RCE:** 在实现任意读写后，攻击者可以修改函数指针、代码段等，从而执行任意代码。具体的 RCE 实现需要进一步的漏洞利用，比如修改已加载的库函数的地址，或者在可执行内存中写入 shellcode。

**项目地址:** [writegsqword/CVE-2024-39840-POC](https://github.com/writegsqword/CVE-2024-39840-POC)

**漏洞详情:** [CVE-2024-39840](https://nvd.nist.gov/vuln/detail/CVE-2024-39840)