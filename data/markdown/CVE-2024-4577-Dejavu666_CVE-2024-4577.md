## CVE-2024-4577 PHP-CGI Argument Injection

**漏洞编号:** CVE-2024-4577

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** PHP

**危害等级:** 严重，允许未经身份验证的攻击者在目标服务器上执行任意代码。

**影响版本:** PHP 8.1.* < 8.1.29, 8.2.* < 8.2.20, 8.3.* < 8.3.8 (Windows, CGI mode, specific codepage settings)

**利用条件:** Windows系统，PHP运行于CGI模式，且系统配置了使用"Best Fit"策略的特定代码页。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-4577是一个影响Windows上PHP的远程代码执行漏洞，当PHP以CGI模式运行时，特定的代码页配置可能导致参数注入。Windows系统会使用“Best-Fit”策略替换命令行中的某些字符，这可能被PHP CGI模块错误地解释为PHP选项。攻击者可以通过发送特制的HTTP请求，将恶意PHP选项传递给PHP二进制文件，从而导致任意代码执行。提供的POC代码包含两个脚本：`cek.py` 用于执行命令，`cuk.py` 用于下载shell。`cek.py`通过构造包含`allow_url_include`和`auto_prepend_file`选项的请求，利用`php://input`流执行PHP代码。`cuk.py`脚本尝试从github下载一个ini.php文件到/tmp目录，存在一定的投毒风险。

**有效性评估：**
根据漏洞描述和已公开的利用信息，该漏洞利用的有效性较高，存在公开可用的POC代码，并且已经观察到在野利用。

**投毒风险评估：**
`cek.py`脚本直接执行用户指定的命令，不存在明显的投毒代码。`cuk.py`脚本从`https://github.com/Dejavu666/kng/raw/refs/heads/main/ini.php`下载文件到`/tmp/ini.php`，这意味着如果该URL指向的文件被恶意修改，攻击者可以控制目标服务器。这种行为引入了投毒风险，但需要攻击者能够控制该Github仓库中的文件。因此，投毒风险并非100%，考虑到其需要依赖于外部资源的可控性，风险评估为10%。

**利用方式：**
1.  攻击者发送包含恶意PHP选项的HTTP请求。
2.  Windows系统使用“Best-Fit”策略转换请求中的字符。
3.  PHP CGI模块错误地将转换后的字符解释为PHP选项。
4.  通过`allow_url_include`和`auto_prepend_file`选项包含并执行`php://input`流中的PHP代码，实现任意代码执行。
5. 可以使用`cek.py`执行系统命令，或者使用`cuk.py`下载恶意文件到服务器上执行。

**项目地址:** [Dejavu666/CVE-2024-4577](https://github.com/Dejavu666/CVE-2024-4577)

**漏洞详情:** [CVE-2024-4577](https://nvd.nist.gov/vuln/detail/CVE-2024-4577)