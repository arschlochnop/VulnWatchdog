## CVE-2024-4577-PHP-CGI参数注入

**漏洞编号:** CVE-2024-4577

**漏洞类型:** PHP-CGI参数注入

**影响应用:** PHP

**危害等级:** 高危，允许远程代码执行

**影响版本:** 8.1.* before 8.1.29, 8.2.* before 8.2.20, 8.3.* before 8.3.8

**利用条件:** Windows系统，Apache服务器，PHP以CGI模式运行，启用了使用 "Best Fit" 策略的代码页。

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2024-4577是一个存在于PHP的Windows版本中的漏洞，当PHP以CGI模式运行时，如果系统配置为使用某些代码页，Windows可能会使用 "Best-Fit" 行为来替换命令行中的字符。PHP CGI模块可能会将这些字符误解为PHP选项，从而允许恶意用户将选项传递给正在运行的PHP二进制文件，从而泄露脚本的源代码或在服务器上运行任意PHP代码。

**有效性：**

根据漏洞库信息和搜索结果，该漏洞已被广泛利用。提供的PoC代码利用了`allow_url_include`和`auto_prepend_file`这两个PHP配置选项，通过URL参数注入来包含并执行恶意代码。PoC代码的构造方式与Devcore博客中的描述一致，因此判断PoC代码有效。

**投毒风险：**

分析PoC代码后，可以发现代码相对简洁，主要功能是构造恶意请求，利用PHP的参数注入漏洞执行命令。该PoC不包含任何可疑的或隐藏的恶意代码，没有发现执行额外操作或回连外部服务器的行为。因此，判定此仓库中不存在作者隐藏的投毒代码的可能性为0%。

**利用方式：**

1.  **漏洞触发条件：**
    *   PHP运行在Windows系统上。
    *   使用Apache等Web服务器，并且PHP配置为CGI模式。
    *   系统启用了使用 "Best Fit" 策略的代码页。
2.  **攻击步骤：**
    *   攻击者构造包含恶意PHP选项的URL，例如`?%ADd+allow_url_include%3d1+-d+auto_prepend_file%3dphp://input`。
    *   `%AD`是为了绕过某些安全检查，`allow_url_include=1`允许包含远程文件，`auto_prepend_file=php://input`会将POST请求的内容作为PHP代码执行。
    *   通过POST请求发送包含恶意PHP代码的内容，例如`<?php system('calc')?>`。
3.  **攻击效果：**
    *   服务器执行恶意PHP代码，攻击者可以实现远程代码执行（RCE）。
    *   攻击者可以读取服务器上的敏感文件，甚至完全控制服务器。

**项目地址:** [sug4r-wr41th/CVE-2024-4577](https://github.com/sug4r-wr41th/CVE-2024-4577)

**漏洞详情:** [CVE-2024-4577](https://nvd.nist.gov/vuln/detail/CVE-2024-4577)