## CVE-2024-4577-PHP-CGI参数注入

**漏洞编号:** CVE-2024-4577

**漏洞类型:** 参数注入/远程代码执行

**影响应用:** PHP

**危害等级:** 高危，可导致远程代码执行

**影响版本:** PHP 8.1.* before 8.1.29, 8.2.* before 8.2.20, 8.3.* before 8.3.8

**利用条件:** Windows系统，运行在CGI模式下，并且启用了使用"Best Fit"策略的代码页。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-4577 是一个存在于 PHP (在 Windows 上，使用 Apache 和 PHP-CGI) 的漏洞，如果系统设置为使用某些代码页，Windows 可能会使用 "Best-Fit" 行为来替换命令行中的字符。PHP CGI 模块可能会错误地将这些字符解释为 PHP 选项，从而允许恶意用户将选项传递给正在运行的 PHP 二进制文件，从而泄露脚本的源代码、在服务器上运行任意 PHP 代码等。

**有效性分析：**

根据漏洞描述和提供的PoC代码，该PoC利用了PHP-CGI在Windows系统下处理请求参数时，由于字符编码转换问题，导致攻击者可以注入恶意的PHP配置参数，例如 `allow_url_include` 和 `auto_prepend_file`，最终执行任意PHP代码。

PoC的实现方式是通过构造一个包含恶意参数的HTTP请求，利用`allow_url_include=1`开启远程文件包含，然后通过`auto_prepend_file=php://input`指定要包含的文件为请求体的内容。请求体中包含要执行的PHP代码。

**投毒风险分析：**

查看提供的PoC代码，没有明显的恶意代码，其作用是为了验证漏洞，将恶意代码注入到服务器端执行。`echo 'PWNED!'; die;` 只是一个验证是否成功利用的标志。但是不排除仓库维护者或者贡献者在后期提交恶意代码的可能性，特别是利用场景为生产环境时，存在一定的风险。

因此，投毒风险评估为10%。

**利用方式：**

1.  目标系统必须是Windows，并且PHP运行在CGI模式下。
2.  目标系统需要设置代码页，并启用"Best Fit"策略。
3.  攻击者构造包含恶意参数的HTTP请求。
4.  恶意参数利用字符编码转换漏洞，注入`allow_url_include`和`auto_prepend_file`等配置项。
5.  `allow_url_include=1` 允许包含远程文件。
6.  `auto_prepend_file=php://input` 将请求体作为要包含的文件。
7.  请求体包含要执行的PHP代码，例如`<?php system('calc')?>`，从而实现远程代码执行。

**优先级排序参考搜索引擎结果：**

搜索引擎结果表明此漏洞已经被广泛利用，并且有多种利用方法，需要及时修复。

*   [webpage 0] CVE-2024-4577 Exploits in the Wild One Day After ...说明该漏洞披露后不久就出现了在野利用。 *   [webpage 1] CVE-2024-4577 Detail - NVD 描述了漏洞允许恶意用户传递选项到 PHP 二进制文件。 *   [webpage 4, 9] 指出存在大规模利用。 总而言之，该漏洞的威胁程度高，利用简单，在野利用广泛，需要高度重视。

**项目地址:** [sug4r-wr41th/CVE-2024-4577](https://github.com/sug4r-wr41th/CVE-2024-4577)

**漏洞详情:** [CVE-2024-4577](https://nvd.nist.gov/vuln/detail/CVE-2024-4577)