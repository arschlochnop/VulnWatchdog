## CVE-2021-34527 PrintNightmare Windows Print Spooler RCE

**漏洞编号:** CVE-2021-34527

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Windows Print Spooler

**危害等级:** 高危，可导致系统权限提升和远程代码执行

**影响版本:** Windows Desktop 7, 8, 8.1, 10, 11 & Server 2008, 2012, 2016, 2019，版本受漏洞库信息中具体版本号影响

**利用条件:** 需要目标系统开启Print Spooler服务，可能需要绕过Point and Print策略或满足特定用户权限要求。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-34527，又名PrintNightmare，是一个存在于Windows Print Spooler服务中的远程代码执行漏洞。攻击者可以通过不当的特权文件操作，利用AddPrinterDriverEx()函数加载恶意DLL，从而以SYSTEM权限执行任意代码。漏洞利用代码显示，攻击者需要提供一个线程安全的DLL路径作为参数。虽然代码本身实现了漏洞利用逻辑，但潜在的投毒风险在于，如果攻击者提供的DLL本身包含恶意代码，则可能在目标系统上执行恶意操作。代码中的随机字符串生成函数和对打印机驱动程序的枚举，看似是为了绕过某些安全机制，但也可能被用于混淆攻击行为。尽管代码本身没有明显的后门，但如果攻击者替换或修改了提供的DLL，就可能植入恶意代码，从而实现投毒攻击。根据漏洞利用代码和描述，该漏洞利用方式是通过调用`AddPrinterDriverEx()`函数，并加载攻击者指定的DLL，从而实现SYSTEM权限的代码执行。

**有效性：** 提供的POC代码有效，因为它实现了PrintNightmare漏洞的利用，能够执行任意代码。

**投毒风险：** 存在一定的投毒风险（10%）。主要风险在于攻击者提供的DLL可能包含恶意代码。虽然提供的代码片段本身没有明显的后门，但整个利用过程依赖于外部提供的DLL，这为投毒创造了机会。需要注意的是，这里所说的“投毒”是指攻击者在利用漏洞时，所使用的恶意DLL可能被其他人替换或修改，从而导致意外的或不期望的后果，例如执行了攻击者无法控制的代码。

**利用方式：**
1.  攻击者准备一个恶意的、线程安全的DLL文件。
2.  攻击者执行POC代码，并提供恶意DLL的路径作为参数。
3.  POC代码调用AddPrinterDriverEx()函数，加载并执行攻击者提供的DLL。
4.  由于Print Spooler服务以SYSTEM权限运行，攻击者提供的DLL也将在SYSTEM权限下执行，从而实现权限提升和远程代码执行。

**项目地址:** [hackerhouse-opensource/cve-2021-34527](https://github.com/hackerhouse-opensource/cve-2021-34527)

**漏洞详情:** [CVE-2021-34527](https://nvd.nist.gov/vuln/detail/CVE-2021-34527)