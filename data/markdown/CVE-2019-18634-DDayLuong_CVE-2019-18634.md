## CVE-2019-18634 - Sudo pwfeedback 缓冲区溢出

**漏洞编号:** CVE-2019-18634

**漏洞类型:** 缓冲区溢出

**影响应用:** Sudo

**危害等级:** 高危，可导致权限提升

**影响版本:** < 1.8.26

**利用条件:** pwfeedback 在 /etc/sudoers 中被启用

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2019-18634 是 Sudo 1.8.26 之前版本中存在的缓冲区溢出漏洞。如果 /etc/sudoers 文件中启用了 pwfeedback 选项，则用户可以触发特权 sudo 进程中的基于栈的缓冲区溢出。

**有效性：** 根据漏洞库信息和搜索结果，该漏洞是真实存在的，并且有可用的PoC利用代码。github上plazmaz的POC也验证了漏洞的存在。提供的PoC代码包含一个 Perl 脚本 (xpl.pl) 用于生成溢出字符串，一个 C 程序 (exec.c) 用于在利用成功后执行提权操作，以及一个 Shell 脚本 (self-contained.sh 或 src/run.sh) 来自动化利用过程。

**利用方式：**

1.  **条件检查：** 漏洞利用依赖于 /etc/sudoers 中 pwfeedback 选项的启用。如果未启用，则漏洞不可利用。
2.  **利用步骤：**
    *   `socat` 创建一个伪终端（pty），将输入/输出连接到执行 Perl 脚本的进程。
    *   Perl 脚本 (xpl.pl) 生成一个精心构造的字符串，该字符串会溢出 `tgetpass.c` 中的 `getln()` 函数的缓冲区。这个payload覆盖了栈上的返回地址和其他关键数据，以便控制程序执行流程。
    *   `export SUDO_ASKPASS=/tmp/pipe` 设置 `SUDO_ASKPASS` 环境变量，告诉 `sudo` 命令使用 `/tmp/pipe` 作为密码输入程序。
    *   `sudo -k -S id < /tmp/pty` 执行 `sudo` 命令，`-k` 选项清除缓存的密码，`-S` 选项强制从标准输入读取密码。输入重定向自伪终端 `/tmp/pty`，这意味着 Perl 脚本生成的溢出字符串会被作为密码传递给 `sudo`。
    *   溢出发生后，程序执行流程被重定向到预先编译的可执行文件 `/tmp/pipe`。
    *   C 程序 (exec.c) 首先检查自身是否以 root 权限运行。如果不是，它会尝试使用 `fchown` 和 `fchmod` 来更改其所有者和权限，设置 SUID 位。如果已经是 root 权限，则会直接使用 `setuid(0)` 设置用户 ID 为 0（root），然后执行 `/bin/bash`，从而获得 root shell。

**投毒风险：**

虽然PoC似乎是功能性的，但其中存在潜在的投毒风险。风险分析如下：

*   **exec.c 中的权限修改：** C代码首先通过open，fstat获取当前可执行文件的uid，gid和权限，如果当前用户不是root权限，则通过fchown将当前文件的uid修改为0(root)，然后通过fchmod添加suid权限。如果编译后的可执行文件`/tmp/pipe`已经被root权限运行，添加suid权限，会导致一些安全问题。所以poc存在一定的风险。
*   **依赖外部程序：** 脚本依赖 `socat`，如果 `socat` 源被篡改，可能会引入恶意代码。但是脚本会首先检测本地是否存在socat，不存在的情况下，从github的raw链接下载，github具有一定的代码审计能力，降低了被投毒的风险。
*   **Perl 脚本：** Perl 脚本生成溢出字符串，虽然脚本本身相对简单，但如果脚本逻辑被篡改，可能会导致拒绝服务或意外行为。

综合考虑，投毒风险主要集中在 `exec.c` 赋予可执行文件不必要的权限上，以及对 `socat` 的依赖上。假设作者故意植入后门，最可能的手段是篡改 `exec.c`，但可能性较低，因为提权方式比较明显。因此，投毒风险估计为 10%。

**项目地址:** [DDayLuong/CVE-2019-18634](https://github.com/DDayLuong/CVE-2019-18634)

**漏洞详情:** [CVE-2019-18634](https://nvd.nist.gov/vuln/detail/CVE-2019-18634)