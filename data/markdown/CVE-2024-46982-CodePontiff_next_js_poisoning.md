## CVE-2024-46982 - Next.js 缓存投毒

**漏洞编号:** CVE-2024-46982

**漏洞类型:** 缓存投毒

**影响应用:** Next.js

**危害等级:** 高危，可能导致恶意内容被缓存并提供给用户，造成钓鱼、信息篡改等风险，最终可能导致拒绝服务。

**影响版本:** 13.5.1 - 13.5.7, 14.0.0 - 14.2.9

**利用条件:** 1. Next.js 版本在 13.5.1 到 13.5.7 或 14.0.0 到 14.2.9 之间; 2. 使用 Pages Router; 3. 使用非动态 Server-Side Rendered 路由

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-46982 是 Next.js 中的一个缓存投毒漏洞。攻击者可以通过发送精心构造的 HTTP 请求，污染非动态服务器端渲染路由的缓存。POC代码利用`_next/image` API的`url`参数，允许攻击者加载并缓存恶意图片。尽管此漏洞主要用于展示缓存投毒，但仍存在细微的投毒风险。例如，攻击者可能尝试通过更改请求中的其他参数来影响缓存键，或者尝试通过上传大量恶意图片来占用服务器资源，从而达到拒绝服务的目的。代码中虽然有延迟和删除本地文件的操作，但这些操作主要是为了绕过某些安全限制和清理攻击痕迹，降低被追踪的可能性，并非直接的投毒行为。

**利用方式:**

1.  **目标确认:** 确定目标 Next.js 应用程序符合漏洞影响的版本范围，且使用了 Pages Router 和非动态 SSR 路由。
2.  **恶意图片准备:** 攻击者需要准备恶意图片，例如包含恶意脚本或链接的图片。攻击者通过Ngrok等工具搭建HTTP服务暴露图片服务.
3.  **构造恶意 URL:** 攻击者构造包含恶意图片 URL 的 `_next/image` 请求。`_next/image?url=<attacker_controlled_url>&w=256&q=100`
4.  **发送请求:** 攻击者向目标服务器发送构造好的请求。如果服务器存在漏洞，并且缓存了该请求的响应，那么所有后续访问相同路由的用户都会收到包含恶意图片的响应。
5.  **缓存污染:** 由于 Next.js 缓存机制的问题，恶意图片可能会被缓存到 CDN 中，扩大了攻击范围和影响。

**投毒风险分析：**

*   该POC的主要目的是演示缓存投毒，即用攻击者控制的内容替换掉服务器上的正常内容，并非传统意义上的植入后门。
*   代码中引入了延迟(`time.sleep(60)`)，这可能是为了绕过服务器端的频率限制或检测机制，但本身不是直接的投毒行为。
*   脚本执行后会删除本地创建的图片文件(`os.remove(new_image_name)`)，这更多是为了清理痕迹，降低被追踪的风险。
*   将投毒风险定为10%，主要是考虑到攻击者可能会利用此漏洞进行拒绝服务攻击，例如通过大量请求来占用服务器资源。

**项目地址:** [CodePontiff/next_js_poisoning](https://github.com/CodePontiff/next_js_poisoning)

**漏洞详情:** [CVE-2024-46982](https://nvd.nist.gov/vuln/detail/CVE-2024-46982)