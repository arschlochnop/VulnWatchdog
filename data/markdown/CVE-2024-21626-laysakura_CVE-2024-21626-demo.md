## CVE-2024-21626-runc容器逃逸

**漏洞编号:** CVE-2024-21626

**漏洞类型:** 容器逃逸

**影响应用:** runc

**危害等级:** 高危，允许攻击者逃逸容器并在主机上执行任意代码

**影响版本:** < 1.1.12

**利用条件:** 需要受影响的runc版本，以及执行容器构建或运行的权限（可能通过恶意镜像）

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-21626 是 runc 中的一个漏洞，源于文件描述符泄漏。该漏洞允许攻击者利用泄露的文件描述符，使得容器进程的工作目录指向主机文件系统命名空间。漏洞利用方式如下：

1.  **攻击场景1（恶意镜像）：** 用户运行了一个恶意的 Docker 镜像。该镜像在启动时，利用该漏洞将容器的工作目录设置为宿主机上的某个目录。
2.  **攻击场景2（runc exec）：** 使用 `runc exec` 在容器内执行新进程，新进程的工作目录错误地设置为主机的文件系统命名空间。
3.  **利用过程：** 在容器内，通过相对路径（如`../../../root/.ssh/authorized_keys`）操作文件，实际上是在操作宿主机上的文件。
4.  **POC代码分析：** 提供的 POC 代码展示了攻击者如何创建一个恶意的 Dockerfile，该 Dockerfile 将工作目录设置为 `/proc/self/fd/8`，这是一个泄露的文件描述符。然后，它复制一个恶意脚本 `inject-ssh-key.sh` 到容器中并执行。这个脚本会将攻击者的 SSH 公钥写入宿主机的 `/root/.ssh/authorized_keys` 文件，从而允许攻击者通过 SSH 以 root 权限登录宿主机。

**有效性：** 提供的 POC 代码有效，可以用来演示和利用 CVE-2024-21626 漏洞实现容器逃逸。

**投毒风险：** 仓库中存在投毒代码的可能性较低（10%）。主要风险集中在 `inject-ssh-key.sh` 脚本，它直接修改宿主机的 authorized_keys 文件，属于明显的漏洞利用行为，并非隐藏的投毒。虽然作者可能在其他位置（例如构建脚本或 Dockerfile 中）添加其他恶意行为，但当前提供的代码片段并未发现明显的后门或隐藏恶意功能。

**利用方式总结：** 攻击者构建或分发包含恶意Dockerfile的容器镜像, 镜像中的脚本利用文件描述符泄露漏洞，将容器的工作目录设置为宿主机的文件系统，最终修改宿主机上的文件实现权限提升。

**项目地址:** [laysakura/CVE-2024-21626-demo](https://github.com/laysakura/CVE-2024-21626-demo)

**漏洞详情:** [CVE-2024-21626](https://nvd.nist.gov/vuln/detail/CVE-2024-21626)