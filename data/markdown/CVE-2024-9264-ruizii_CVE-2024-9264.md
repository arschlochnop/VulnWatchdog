## CVE-2024-9264-Grafana-RCE&LFI

**漏洞编号:** CVE-2024-9264

**漏洞类型:** 远程代码执行 (RCE) 和本地文件包含 (LFI)

**影响应用:** Grafana

**危害等级:** 高危，可能导致远程代码执行、敏感信息泄露和服务器控制

**影响版本:** 11.0.x, 11.1.x, 11.2.x (before fix versions)

**利用条件:** 需要启用 SQL Expressions 实验性功能，存在DuckDB可执行文件在Grafana的$PATH中，并且攻击者具有 Viewer 或更高的权限。

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2024-9264 允许经过身份验证的用户（Viewer 或更高权限）通过 SQL Expressions 功能执行远程代码。该功能允许执行 DuckDB 查询，但未对用户输入进行充分的安全过滤，导致命令注入和本地文件包含漏洞。

**利用方式：**

1.  攻击者首先需要登录 Grafana 实例，获取有效的 `grafana_session` cookie。
2.  攻击者利用 SQL Expressions 功能，构造恶意的 DuckDB 查询。对于 RCE，攻击者使用 `install shellfs from community; LOAD shellfs; SELECT * FROM read_csv("{command} > /tmp/output.txt 2>&1 |")` 注入操作系统命令，并将命令输出重定向到 `/tmp/output.txt`。 对于 LFI，使用 `SELECT content FROM read_blob("{filename}")` 读取任意文件。
3.  构造的查询通过 Grafana API `/api/ds/query` 发送。
4.  对于 RCE，攻击者随后使用 LFI 读取 `/tmp/output.txt` 文件，获取命令执行结果。
5.  对于 LFI，API返回指定文件内容。

**有效性：**

根据搜索结果和提供的漏洞利用代码，该漏洞利用 PoC 是有效的。多个来源（例如，GitHub 上的 PoC 代码，SonicWall 博客，以及 Certcube 博客）都证实了该漏洞的存在和可利用性。漏洞库信息也确认了该漏洞。

**投毒风险：**

提供的 PoC 代码比较直接，主要用于演示漏洞的利用。`CVE-2024-9264.py` 脚本包含登录、LFI 和 RCE 功能。 `README.md` 提供了如何使用该脚本的简单说明。对代码的检查没有发现明显的恶意代码或后门。

但是，任何从外部来源获取的代码都存在一定程度的风险。攻击者可能修改 PoC 代码，添加恶意功能，例如：

*   收集受害者信息并发送到外部服务器。
*   安装持久性后门。
*   进行其他恶意活动。

因此，尽管当前代码看起来没有明显的恶意行为，在生产环境中使用之前，仍然需要进行彻底的代码审查和安全测试。

综合考虑，投毒风险较低，估计在5%左右。主要风险在于使用者未进行充分的代码审查就直接使用。


**项目地址:** [ruizii/CVE-2024-9264](https://github.com/ruizii/CVE-2024-9264)

**漏洞详情:** [CVE-2024-9264](https://nvd.nist.gov/vuln/detail/CVE-2024-9264)