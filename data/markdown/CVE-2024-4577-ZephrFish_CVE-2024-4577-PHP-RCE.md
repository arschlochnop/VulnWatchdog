## CVE-2024-4577-PHP-CGI参数注入RCE

**漏洞编号:** CVE-2024-4577

**漏洞类型:** 远程代码执行

**影响应用:** PHP

**危害等级:** 高危，可导致远程代码执行

**影响版本:** PHP 8.1.* < 8.1.29, 8.2.* < 8.2.20, 8.3.* < 8.3.8，运行于Windows+Apache+PHP-CGI环境，且启用了Best-Fit策略的CodePage

**利用条件:** 目标服务器需满足特定PHP版本、Windows环境、Apache服务器、PHP-CGI模式，以及存在使用Best-Fit策略的CodePage设置。

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2024-4577是一个PHP-CGI中的参数注入漏洞，存在于Windows平台的特定PHP版本中。攻击者可以通过精心构造的URL，利用Windows系统的“Best Fit”字符转换特性，将恶意参数注入到PHP的执行命令中，最终实现远程代码执行。 

**有效性:**
提供的POC代码是有效的，通过发送包含`allow_url_include`和`auto_prepend_file`参数的POST请求，并包含PHP代码`<?php phpinfo(); ?>`，如果目标存在漏洞，则会执行该代码并返回`phpinfo()`的结果。

**投毒风险:**
提供的代码主要用于检测漏洞是否存在，功能较为直接，没有发现隐藏的恶意代码或后门。该仓库的`CODEOWNERS`文件中只包含`@zephrfish`，该用户有代码审核权，因此综合评估认为投毒的可能性较低。

**利用方式:**
1.  **环境确认:** 漏洞利用前需要确认目标服务器是否满足以下条件：
    *   Windows操作系统
    *   Apache服务器
    *   PHP以CGI模式运行
    *   PHP版本为受影响的范围（8.1.* < 8.1.29, 8.2.* < 8.2.20, 8.3.* < 8.3.8）
    *   系统启用了使用“Best-Fit”策略的CodePage
2.  **构造恶意URL:** 构造包含恶意参数的URL。关键在于使用`%25ADd`来代替`-d`，结合`allow_url_include`和`auto_prepend_file`选项，允许远程包含恶意PHP代码。
3.  **发送请求:** 使用POST方法发送包含PHP代码的请求，例如`<?php phpinfo(); ?>`或更具危害性的代码。
4.  **执行任意代码:** 成功利用漏洞后，可以在目标服务器上执行任意PHP代码，从而控制服务器。

**项目地址:** [ZephrFish/CVE-2024-4577-PHP-RCE](https://github.com/ZephrFish/CVE-2024-4577-PHP-RCE)

**漏洞详情:** [CVE-2024-4577](https://nvd.nist.gov/vuln/detail/CVE-2024-4577)