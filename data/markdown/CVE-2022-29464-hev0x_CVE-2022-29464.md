## CVE-2022-29464-WSO2-任意文件上传导致RCE

**漏洞编号:** CVE-2022-29464

**漏洞类型:** 任意文件上传导致远程代码执行

**影响应用:** WSO2 API Manager, Identity Server, Enterprise Integrator, Open Banking AM/KM

**危害等级:** 高危，可能导致服务器完全控制

**影响版本:** WSO2 API Manager 2.2.0 up to 4.0.0, WSO2 Identity Server 5.2.0 up to 5.11.0, WSO2 Identity Server Analytics 5.4.0, 5.4.1, 5.5.0 and 5.6.0, WSO2 Identity Server as Key Manager 5.3.0 up to 5.11.0, WSO2 Enterprise Integrator 6.2.0 up to 6.6.0, WSO2 Open Banking AM 1.4.0 up to 2.0.0 and WSO2 Open Banking KM 1.4.0, up to 2.0.0

**利用条件:** 需要网络访问，目标存在/fileupload端点

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2022-29464 是一个存在于多个 WSO2 产品中的任意文件上传漏洞，允许未经授权的攻击者上传恶意文件并执行远程代码。根据漏洞信息和搜索结果，此漏洞利用涉及利用 `/fileupload` 端点，并使用 `Content-Disposition` 头部中的目录遍历序列将文件上传到 Web 根目录下的可访问位置，例如 `../../../../repository/deployment/server/webapps` 目录。POC 代码的工作原理如下：

1.  **定位目标：** 脚本接收包含目标 URL 的文件作为输入。
2.  **构造恶意请求：** 脚本构造一个 POST 请求，使用 `/fileupload/toolsAny` 端点，并在 `files` 参数中包含一个指向恶意 JSP 文件的映射。JSP 文件的内容是一个简单的 WebShell，允许执行任意命令。
3.  **目录遍历：** 脚本使用目录遍历序列 (例如 `../../../../`) 将 JSP 文件上传到 `repository/deployment/server/webapps/authenticationendpoint/megas.jsp` 路径下。 `authenticationendpoint` 是一个常见的 Web 应用目录，`megas.jsp` 是上传的 webshell 文件名。
4.  **执行代码：** 脚本通过访问上传的 JSP WebShell (例如 `/authenticationendpoint/megas.jsp?cmd=id`) 来执行命令。脚本首先尝试执行 `id` 命令以验证漏洞是否成功利用。
5.  **验证与输出：** 如果 `id` 命令执行成功并且返回了 `uid` 信息，脚本会认为目标存在漏洞，并将结果输出到屏幕和文件中。

**投毒风险分析：**

我分析了提供的 POC 代码。该代码的主要功能是利用目录遍历和文件上传漏洞在目标系统上部署一个 webshell，然后通过 webshell 执行系统命令。代码没有发现任何隐藏的、与漏洞利用无关的功能，例如收集用户信息、传播恶意软件或篡改系统配置等。因此，该 POC 代码的投毒风险评估为 0%。

**总结：**

该漏洞利用代码有效，因为它能够利用文件上传漏洞在目标系统上部署和执行恶意代码，从而实现远程代码执行。利用方式清晰，无需身份验证。由于代码只包含漏洞利用逻辑，因此不存在投毒风险。

**项目地址:** [hev0x/CVE-2022-29464](https://github.com/hev0x/CVE-2022-29464)

**漏洞详情:** [CVE-2022-29464](https://nvd.nist.gov/vuln/detail/CVE-2022-29464)