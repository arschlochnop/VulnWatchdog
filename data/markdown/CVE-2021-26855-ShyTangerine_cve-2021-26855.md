## CVE-2021-26855 - Microsoft Exchange Server SSRF

**漏洞编号:** CVE-2021-26855

**漏洞类型:** 服务器端请求伪造 (SSRF)

**影响应用:** Microsoft Exchange Server

**危害等级:** 高危，可能导致远程代码执行

**影响版本:** 受影响版本包括 Microsoft Exchange Server 2013、2016 和 2019 的多个累积更新版本，详见漏洞库信息

**利用条件:** 需要能够访问 Exchange Server 的 ECP 接口

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-26855 是 Microsoft Exchange Server 中的一个服务器端请求伪造 (SSRF) 漏洞，属于 ProxyLogon 漏洞链的一部分。未授权的攻击者可以利用此漏洞发送任意 HTTP 请求并进行身份验证，绕过身份验证，最终导致远程代码执行。

**利用方式：**

根据提供的漏洞利用代码，利用过程大致如下：

1.  **初始请求：** 向 `/ecp/x.png` 发送 GET 请求，尝试获取 `X-BEResource` Cookie。
2.  **获取 DN 值：** 通过向 `/ecp/x.png` 发送包含特定 XML 内容的 POST 请求，利用 Autodiscover 服务获取用户的 DN (Distinguished Name)。
3.  **Mapi/Emsmdb 连接：** 使用获取的 DN 值，向 `/ecp/x.png` 发送包含 `X-BEResource`、`X-Clientinfo` 等头的 POST 请求，尝试建立 MAPI over HTTP 连接。
4.  **获取 Session 和 msExchEcpCanary：** 通过向 `/ecp/x.png` 发送包含特定 XML 内容的 POST 请求，利用 Negotiate 协议获取 ASP.NET Session ID 和 `msExchEcpCanary` 值。`msExchEcpCanary` 是一个安全令牌，用于防止跨站请求伪造 (CSRF) 攻击。
5.  **获取 OAB ID：** 发送包含`msExchEcpCanary` 和 Session ID 到`/ecp/x.png`，获取OAB id，为下一步写入恶意代码作准备

**有效性：**

根据漏洞库信息、搜索引擎结果和提供的 POC 代码，可以确认该漏洞确实存在且已被积极利用。该 POC 代码展示了漏洞利用的关键步骤，例如如何绕过身份验证、如何获取必要的凭据信息等。该漏洞利用的有效性较高。

**投毒风险：**

评估提供的 POC 代码，存在一定投毒风险，10%。 风险点主要在于：

*   **硬编码的 IP 地址和域名：** POC 代码中包含硬编码的 IP 地址 (例如 `10.255.200.20`, `192.168.170.134`) 和域名 (`EXCHANGE01.xihongdream.com`)。如果用户直接使用这些硬编码的值，可能会将攻击流量导向作者控制的服务器，从而暴露目标服务器的信息或被用于进一步的攻击。

*   **潜在的后门植入：** 虽然 POC 代码的主要目的是演示漏洞利用过程，但作者有可能在代码中插入后门，例如，在OAB操作中，写入恶意脚本到目标服务器，长期控制目标系统。

总的来说，该 POC 代码主要演示了 SSRF 的利用方式。用户在使用时应谨慎，务必修改代码中的硬编码值，避免潜在的投毒风险。

**项目地址:** [ShyTangerine/cve-2021-26855](https://github.com/ShyTangerine/cve-2021-26855)

**漏洞详情:** [CVE-2021-26855](https://nvd.nist.gov/vuln/detail/CVE-2021-26855)