## CVE-2023-7028-GitLab-账户接管

**漏洞编号:** CVE-2023-7028

**漏洞类型:** 弱密码恢复机制

**影响应用:** GitLab

**危害等级:** 高危，允许攻击者无需用户交互即可接管账户，包括管理员账户

**影响版本:** 16.1 直到 16.1.6, 16.2 直到 16.2.9, 16.3 直到 16.3.7, 16.4 直到 16.4.5, 16.5 直到 16.5.6, 16.6 直到 16.6.4, and 16.7 直到 16.7.2

**利用条件:** 需要目标GitLab实例存在受影响的版本，且攻击者能够发送邮件到目标用户邮箱。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2023-7028 漏洞是 GitLab CE/EE 版本 16.1 到 16.7.2 中存在的一个严重漏洞，该漏洞允许攻击者通过向用户的账户添加未验证的电子邮件地址来重置用户密码，从而无需任何用户交互即可接管账户。 

**有效性：**
提供的 POC 代码是一个包含`ResetPassword.eml`文件的邮件模板。该模板通过在`To:`字段中同时包含目标用户的邮箱地址和攻击者的邮箱地址，来利用漏洞，使得重置密码的链接同时发送到两个邮箱。攻击者收到包含`reset_password_token`的邮件后，即可利用该token重置目标用户的密码。

**投毒风险：**
POC 本身就是一个漏洞验证代码，不具备明显的恶意投毒代码。但是需要注意替换`{SENDER_EMAIL}`，`{ATTACKER_EMAIL}`，`{GITLAB_URL}`，`{GITLAB_LOG_PATH}`和`{HACKER_TOKEN}`这些变量。`{GITLAB_LOG_PATH}`如果设置不当，可能会导致信息泄露，但非恶意投毒。因此认为存在轻微的投毒风险，主要来自对参数替换的不当使用，约为 10%。

**利用方式：**
1.  攻击者构造包含两个邮箱地址（目标用户邮箱和攻击者邮箱）的密码重置请求。
2.  GitLab 存在漏洞的版本会将包含重置密码链接的邮件同时发送到这两个邮箱地址。
3.  攻击者从自己的邮箱中获取重置密码链接中的`reset_password_token`。
4.  攻击者利用该 token 访问密码重置页面，并设置目标用户的新密码。
5.  攻击者使用新密码登录目标用户的账户，完成账户接管。

利用的核心在于 GitLab 允许将密码重置邮件同时发送到多个邮箱，从而使得攻击者可以获取到重置密码的权限。

**项目地址:** [Esonhugh/gitlab_honeypot](https://github.com/Esonhugh/gitlab_honeypot)

**漏洞详情:** [CVE-2023-7028](https://nvd.nist.gov/vuln/detail/CVE-2023-7028)