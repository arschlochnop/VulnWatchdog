## CVE-2022-22965 - Spring4Shell RCE

**漏洞编号:** CVE-2022-22965

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Spring Framework

**危害等级:** 高危，可能导致服务器完全控制

**影响版本:** Spring Framework versions 5.3.X prior to 5.3.18+, 5.2.x prior to 5.2.20+ 和所有旧的和不支持的版本

**利用条件:** JDK 9+, Tomcat 作为 WAR 部署，Spring MVC 或 Spring WebFlux 应用

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

该漏洞是 Spring4Shell，允许未经身份验证的远程代码执行。利用方式是通过数据绑定，修改 Tomcat 的 AccessLogValve 组件属性，写入恶意 webshell 文件到 webapps 目录下。漏洞利用依赖于特定的环境配置，包括 JDK 9+，部署为 WAR 包的 Tomcat，以及使用了受影响版本的 Spring Framework。提供的 Python 和 Bash 脚本均旨在利用此漏洞。存在轻微投毒风险，主要体现在脚本可能包含下载其他恶意文件的代码或者修改服务器配置等，但主要功能是实现RCE，投毒风险较低。

**有效性分析:** 根据漏洞库信息、搜索引擎结果以及提供的漏洞利用代码，该漏洞是真实存在的，并且有积极的利用案例。POC 代码尝试修改 Tomcat 的日志配置以写入 Webshell，这是一种已知的利用方式，因此提供的POC代码**有效**。

**投毒风险分析:** 查看提供的脚本`spring4shell.py`和`spring4shell.sh`，脚本主要功能是利用漏洞上传webshell，没有明显的恶意行为比如删除文件，反向连接恶意服务器等。`README.md`中引用了外部链接，存在一定的跳转风险，但代码本身主要是为了演示漏洞利用，故投毒风险较低，判断为10%。

**利用方式:**

1.  **漏洞原理：**  攻击者通过操纵 class.module.classLoader.resources.context.parent.pipeline.first 的属性，修改 Tomcat AccessLogValve 的配置，特别是 pattern 属性。
2.  **攻击过程：**
    *   构造包含恶意代码的请求，通过 Spring 的数据绑定功能，修改 Tomcat 的 AccessLogValve 组件的 pattern 属性，将恶意代码写入日志文件中。
    *   由于 Tomcat 的日志文件通常位于 webapps 目录下，因此恶意代码实际上被写入了一个 JSP 文件（webshell）。
    *   攻击者通过访问该 JSP 文件，执行任意命令。
3.  **POC代码分析:**
    *   `spring4shell.py` 脚本使用 `requests` 库发送 POST 请求，包含构造的恶意数据，目标 URL 是存在漏洞的 Spring 应用。
    *   `spring4shell.sh` 脚本同样发送构造的 HTTP 请求，修改 Tomcat 的 AccessLogValve 组件属性。
    *   两个脚本都设置了webshell密码，上传目录，webshell文件名，攻击成功后通过webshell url进行命令执行。
4.  **先决条件：**
    *   目标应用运行在 JDK 9+ 上。
    *   目标应用部署为 WAR 包到 Tomcat 上。
    *   目标应用使用了受影响版本的 Spring Framework。
    *   需要目标服务器能够访问

**项目地址:** [osungjinwoo/CVE-2022-22965](https://github.com/osungjinwoo/CVE-2022-22965)

**漏洞详情:** [CVE-2022-22965](https://nvd.nist.gov/vuln/detail/CVE-2022-22965)