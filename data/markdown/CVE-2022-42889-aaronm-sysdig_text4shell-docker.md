## CVE-2022-42889-Apache Commons Text-RCE

**漏洞编号:** CVE-2022-42889

**漏洞类型:** 远程代码执行(RCE)

**影响应用:** Apache Commons Text

**危害等级:** 高危，可导致服务器被完全控制

**影响版本:** <= 1.9

**利用条件:** 应用程序使用Apache Commons Text <= 1.9，且允许用户可控的字符串进行变量插值

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2022-42889，又名Text4Shell，是Apache Commons Text库中的一个高危漏洞。该漏洞源于程序在处理用户提供的字符串时，使用了不安全的变量插值功能。攻击者可以通过构造包含恶意表达式的字符串，例如`${script:javascript:java.lang.Runtime.getRuntime().exec('touch /tmp/foo')}`，利用`script`、`dns`或`url`等lookup前缀，执行任意代码。 

**有效性：**

根据漏洞库信息、搜索引擎结果和提供的POC代码，该漏洞是有效的。漏洞利用代码中的Dockerfile-vuln和README.md文件清晰地展示了如何构建一个包含漏洞的应用程序，并使用特定的payload触发远程代码执行，例如创建`/tmp/foo`文件。

**投毒风险：**

该仓库的投毒风险较低，约为5%。 虽然不能完全排除作者隐藏恶意代码的可能性，但是从以下几点可以分析出，投毒的概率较低:

*   提供的代码主要是漏洞的演示和利用，重点在于复现漏洞本身。
*   Dockerfiles主要用于环境搭建，没有发现可疑的恶意命令。
*   pom-patched.xml修复了漏洞，pom-vuln.xml 包含漏洞，本身是用来复现漏洞的。
*   README.md 详细描述了利用步骤和验证方式，方便用户理解和测试。
*   azure-pipelines.yml 使用Sysdig进行安全扫描，表明作者可能关注安全性问题。

**可能的投毒方式（仅为假设）**:

*   在`src`目录下的Java代码中加入后门。
*   修改`pom.xml`，引入恶意的依赖项。
*   在Dockerfile中添加执行恶意命令的指令。

**利用方式：**

1.  应用程序使用Apache Commons Text 1.5到1.9之间的版本。
2.  应用程序允许用户提供字符串，这些字符串将被用于变量插值。
3.  攻击者构造包含恶意表达式的字符串，例如 `${script:javascript:java.lang.Runtime.getRuntime().exec('command')}`，其中 `command` 是攻击者想要执行的系统命令。
4.  应用程序解析并执行该字符串，导致远程代码执行。

**缓解措施：**

1.  升级到Apache Commons Text 1.10.0或更高版本，该版本默认禁用了存在风险的interpolator。
2.  如果无法升级，禁用或限制应用程序中使用的lookup，移除`script`、`dns`和`url`等lookup的默认配置。
3.  对用户提供的输入进行严格的验证和过滤，防止恶意表达式的注入。

**项目地址:** [aaronm-sysdig/text4shell-docker](https://github.com/aaronm-sysdig/text4shell-docker)

**漏洞详情:** [CVE-2022-42889](https://nvd.nist.gov/vuln/detail/CVE-2022-42889)