## CVE-2024-4577-PHP-CGI参数注入

**漏洞编号:** CVE-2024-4577

**漏洞类型:** PHP-CGI参数注入

**影响应用:** PHP

**危害等级:** 高危，可能导致远程代码执行

**影响版本:** PHP 8.1.* (before 8.1.29), 8.2.* (before 8.2.20), 8.3.* (before 8.3.8)

**利用条件:** Windows系统，运行在CGI模式下，并且系统启用了某些使用"Best Fit"策略的代码页。需要目标存在php-cgi/php-cgi.exe等CGI文件。

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2024-4577 是一个 PHP-CGI 参数注入漏洞，存在于Windows系统上运行在CGI模式下的PHP。当系统配置为使用某些代码页时，Windows可能会使用 "Best-Fit" 行为来替换传递给 Win32 API 函数的命令行参数中的字符。PHP CGI 模块可能会将这些字符错误地解释为 PHP 选项，从而允许恶意用户向 PHP 二进制文件传递选项，进而泄露脚本源码，或在服务器上执行任意 PHP 代码。 

**利用方式：**

1.  **构造恶意请求：** 攻击者构造包含特定字符（例如软连字符 0xAD）的 URL，这些字符在某些 Windows 代码页转换中会被错误地解释为短划线或其他控制字符。
2.  **参数注入：** 经过转换后的字符被 PHP-CGI 模块解析为命令行参数，从而允许攻击者控制传递给 PHP 解释器的参数。
3.  **远程代码执行：** 通过注入参数，攻击者可以利用`auto_prepend_file`等配置项包含远程文件或执行任意 PHP 代码，从而实现远程代码执行。

**POC有效性：**

提供的PoC代码 `scan.py` 旨在扫描目标是否存在 CVE-2024-4577 漏洞。它通过发送包含特殊构造的payload的HTTP请求，并检查响应中是否包含预期的输出来判断漏洞是否存在。PoC代码逻辑清晰，包含构建payload、发送请求、解析响应等步骤，因此是有效的。

**投毒风险：**

PoC代码本身功能为漏洞扫描，其主要功能在于验证目标是否存在漏洞，而非进行攻击。其中包含的payload是为了验证漏洞存在，而不是植入后门。但是，PoC代码中依赖了第三方库，如 `requests`， `urllib3`，`chardet`等。如果这些依赖包被恶意篡改，则可能存在投毒风险。 经过分析，认为此仓库中作者隐藏的投毒代码的可能性较低，概率约为5%。主要的风险在于第三方依赖库可能被投毒。


**项目地址:** [xAL6/cve-2024-4577-scanner](https://github.com/xAL6/cve-2024-4577-scanner)

**漏洞详情:** [CVE-2024-4577](https://nvd.nist.gov/vuln/detail/CVE-2024-4577)