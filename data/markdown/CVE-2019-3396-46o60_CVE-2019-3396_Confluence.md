## CVE-2019-3396_Confluence Widget Connector Macro SSTI

**漏洞编号:** CVE-2019-3396

**漏洞类型:** 服务器端模板注入 (SSTI)

**影响应用:** Atlassian Confluence Server

**危害等级:** 高危，允许远程攻击者实现路径遍历和远程代码执行

**影响版本:** 受影响版本包括 6.6.12 之前, 6.7.0 至 6.12.3 之前, 6.13.0 至 6.13.3 之前, 以及 6.14.0 至 6.14.2 之前

**利用条件:** 需要目标系统存在漏洞版本的Confluence服务器，如果是RCE，可能需要合法的用户session。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2019-3396是Atlassian Confluence服务器中Widget Connector宏的一个服务器端模板注入漏洞。攻击者可以利用此漏洞进行路径遍历和远程代码执行。漏洞利用方式有两种：

1. **路径遍历（文件读取）：** 攻击者可以利用`_template`参数，通过构造恶意的路径，读取服务器上的任意文件或目录。此方式无需认证。

2. **远程代码执行（RCE）：** 攻击者可以上传一个包含恶意Velocity模板的文件到服务器，然后利用该漏洞从本地文件系统加载该模板，从而执行任意代码。此方式需要一个有效的用户session。该POC代码首先尝试找到用户的个人空间，如果不存在则创建，然后上传包含payload的模板文件，最后利用漏洞执行命令。

**关于投毒风险：**虽然代码看起来是直接利用漏洞，但仍存在一定的投毒风险（约10%）。

*   **依赖性风险：** 该脚本依赖于外部库（例如 `requests`）。如果攻击者控制了这些库的源或使用了被污染的库，则可能引入恶意代码。
*   **Payload风险：** 上传的Velocity模板payload可能被修改以执行未经授权的操作，或者被用于在受害者系统上安装恶意软件。
*   **后门风险：** 虽然该POC的目的是利用漏洞，但如果代码被恶意修改，可以在上传的模板中包含后门，允许攻击者在漏洞修复后仍然可以访问系统。

因此，在使用该POC时，建议仔细审查代码，确保所使用的库是可信的，并对上传的payload进行严格的安全评估。此外，还应监控Confluence服务器的行为，以检测任何可疑活动。

**项目地址:** [46o60/CVE-2019-3396_Confluence](https://github.com/46o60/CVE-2019-3396_Confluence)

**漏洞详情:** [CVE-2019-3396](https://nvd.nist.gov/vuln/detail/CVE-2019-3396)