## CVE-2021-3156-Sudo-Heap-Based 缓冲区溢出

**漏洞编号:** CVE-2021-3156

**漏洞类型:** Heap-Based 缓冲区溢出

**影响应用:** Sudo

**危害等级:** 高危，允许本地用户提升权限至 root

**影响版本:** 1.8.2 to 1.8.31p2 和 1.9.0 to 1.9.5p1

**利用条件:** 需要本地用户权限，且目标系统存在漏洞版本的 sudo

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-3156（Baron Samedit）是一个存在于 Sudo 中的堆缓冲区溢出漏洞。此漏洞允许未经授权的本地用户通过 `sudoedit -s` 和以单个反斜杠字符结尾的命令行参数将权限提升到 root。该漏洞是由于 `sudo` 在解析命令行参数时存在的 off-by-one 错误导致的。

**有效性：**
根据漏洞库信息、搜索结果以及提供的PoC代码，该漏洞是有效的，并且存在可利用的PoC。

**投毒风险：**
该仓库存在一定的投毒风险，风险概率约为10%。

分析如下：
1.  **libnss_X目录和shell_tool.c**: Makefile 中存在编译动态链接库 `libnss_X/X.so.2` 的指令，使用 `shell_tool.c` 作为源文件。需要对 `shell_tool.c` 代码进行审计，确认是否存在恶意行为。例如，是否包含反弹shell，下载执行恶意代码等。
2. **create_privshell.sh错误处理:**  README.md中提到`create_privshell.sh` 脚本可能编译失败,存在可以被利用的风险。
3. **自动后渗透脚本**: 虽然`get_all_ssh_keys.sh`目的是为了提取ssh keys,但是如果利用不当或者被替换,也可能造成信息泄露。

虽然存在上述风险点，但总体来看，该POC的主要功能是利用漏洞提升权限，而非进行大范围的恶意传播或破坏。因此，投毒风险主要集中在代码细节和潜在的滥用可能上。

**利用方式：**

1.  **编译PoC：** 首先，使用 `make` 命令编译 `bufferof.c` 和 `shell_tool.c` 生成 exploit 文件和动态链接库。
2.  **执行Exploit：** 运行编译后的 `exploit` 文件。该 exploit 利用堆缓冲区溢出漏洞来提升权限。
3.  **权限提升：** 成功利用漏洞后，用户将获得 root 权限。根据 README.md，PoC还提供了自动化的后渗透脚本，例如提取 SSH 密钥和创建特权 shell，进一步巩固攻击成果。

**安全建议：**

*   及时将 Sudo 升级到 1.9.5p2 或更高版本。
*   在部署 PoC 或任何第三方代码之前，进行彻底的代码审计。
*   限制普通用户的 Sudo 权限，降低漏洞利用的风险。

**项目地址:** [PurpleOzone/PE_CVE-CVE-2021-3156](https://github.com/PurpleOzone/PE_CVE-CVE-2021-3156)

**漏洞详情:** [CVE-2021-3156](https://nvd.nist.gov/vuln/detail/CVE-2021-3156)