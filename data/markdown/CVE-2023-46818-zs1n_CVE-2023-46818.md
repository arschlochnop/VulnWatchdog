## CVE-2023-46818-ISPConfig-PHP代码注入

**漏洞编号:** CVE-2023-46818

**漏洞类型:** PHP代码注入

**影响应用:** ISPConfig

**危害等级:** 高危，可导致远程代码执行，完全控制服务器

**影响版本:** <= 3.2.11

**利用条件:** 需要管理员权限，且admin_allow_langedit配置项启用

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

该漏洞存在于ISPConfig 3.2.11p1之前的版本中。如果管理员启用了`admin_allow_langedit`配置项，则攻击者（需要管理员权限）可以通过语言文件编辑器注入PHP代码。具体利用方式如下：

1.  **身份验证：** 攻击者需要使用有效的管理员凭据登录ISPConfig控制面板。
2.  **获取CSRF Token：** 攻击者访问`admin/language_edit.php`页面，获取CSRF ID和CSRF Key，用于绕过CSRF保护。
3.  **代码注入：** 攻击者构造一个包含恶意PHP代码的请求，通过`records[]`参数发送到`admin/language_edit.php`。恶意代码会被写入服务器上的一个文件，通常是`shell.php`。
4.  **命令执行：** 攻击者通过访问`shell.php`，并设置HTTP Header `C`，该header内容为base64编码后的要执行的系统命令。服务器端`shell.php`接收该header的内容，base64解码后，使用`passthru`函数执行该命令，并将结果返回给攻击者。

**有效性评估：**

根据漏洞信息、搜索引擎结果和提供的POC代码，该漏洞的POC代码有效。POC代码实现了完整的漏洞利用流程，包括身份验证、CSRF Token获取、代码注入和命令执行。

**投毒风险评估：**

代码投毒的风险较低（5%）。

*   代码本身实现了漏洞利用的功能，没有发现明显的恶意代码。
*   虽然代码在`shell_injection`函数中使用了`base64`编码，但这是为了避免特殊字符干扰，属于正常的利用方式，而不是隐藏恶意行为。
*   `file_put_contents('shell.php', base64_decode('{payload}'))` 这段代码的功能是写入webshell，是漏洞利用的必要步骤，不是投毒行为。
*   唯一的风险在于，攻击者可以修改POC代码，在注入的shell.php中添加额外的后门代码。但这个风险是任何漏洞利用都存在的，不属于POC代码本身的投毒。

**总结：**

该漏洞的利用方式较为直接，POC代码有效。主要风险在于攻击者利用漏洞获取服务器控制权后可能进行的恶意行为。

**项目地址:** [zs1n/CVE-2023-46818](https://github.com/zs1n/CVE-2023-46818)

**漏洞详情:** [CVE-2023-46818](https://nvd.nist.gov/vuln/detail/CVE-2023-46818)