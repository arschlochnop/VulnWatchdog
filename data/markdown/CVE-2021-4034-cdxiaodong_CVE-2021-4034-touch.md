## CVE-2021-4034-Polkit pkexec 本地提权

**漏洞编号:** CVE-2021-4034

**漏洞类型:** 本地权限提升

**影响应用:** polkit

**危害等级:** 高危，允许本地普通用户获取root权限

**影响版本:** 所有版本

**利用条件:** 目标系统存在polkit的pkexec程序且未打补丁

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2021-4034 漏洞是 polkit pkexec 程序中的一个本地权限提升漏洞。pkexec 是一个 setuid 工具，允许非特权用户根据预定义的策略以特权用户身份运行命令。

**漏洞分析：**
该漏洞源于 pkexec 在处理调用参数计数时存在缺陷，导致程序尝试将环境变量作为命令执行。攻击者可以通过精心构造环境变量，诱使 pkexec 执行任意代码，从而实现本地权限提升。

**利用方式：**
1.  **编译 PoC 代码：** 首先，需要编译提供的 Makefile 文件，生成 `pwnkit.so`、`cve-2021-4034`、`gconv-modules` 和 `GCONV_PATH` 相关文件和目录。
2.  **构造环境变量：** 关键在于设置 `GCONV_PATH=.` 和 `CHARSET=PWNKIT` 以及修改 `gconv-modules` 文件，使得 `pkexec` 在执行过程中加载恶意共享库 `pwnkit.so`。
3.  **执行 cve-2021-4034：** 运行编译后的 `cve-2021-4034` 程序，该程序设置特定的环境变量并调用 `/usr/bin/pkexec`。
4.  **pwnkit.so执行：**  `pwnkit.so` 的 `gconv_init` 函数会被执行，该函数会获取环境变量`PWNKIT_ARG`的值，并使用`setuid(0)`和`setgid(0)`来将当前进程的用户ID和组ID设置为root用户,然后使用`execve`来执行`/bin/touch`命令，并将`PWNKIT_ARG`作为参数传递给`/bin/touch`命令，从而以root权限创建文件。注意：如果`PWNKIT_ARG`为空，则`/bin/touch`命令后面只有一个null参数，所以不会创建文件。

**有效性：**
提供的 PoC 代码是有效的。参考搜索结果中的相关文章和漏洞分析，该漏洞利用方式已被广泛验证和利用。

**投毒风险：**
经过对 PoC 代码的分析，该代码主要目的是利用 `pkexec` 的漏洞进行本地提权，没有发现作者隐藏的恶意代码或后门。代码逻辑清晰，没有明显的投毒迹象，因此，投毒风险为 0%。

**缓解措施：**
1.  及时更新 polkit 到最新版本，修复此漏洞。
2.  如果无法立即更新，可以暂时删除 pkexec 的 setuid 权限：`chmod 755 /usr/bin/pkexec` (但会影响 polkit 的正常功能)。

**项目地址:** [cdxiaodong/CVE-2021-4034-touch](https://github.com/cdxiaodong/CVE-2021-4034-touch)

**漏洞详情:** [CVE-2021-4034](https://nvd.nist.gov/vuln/detail/CVE-2021-4034)