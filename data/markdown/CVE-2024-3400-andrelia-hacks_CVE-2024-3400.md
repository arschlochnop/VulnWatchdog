## CVE-2024-3400 PAN-OS GlobalProtect 远程命令执行

**漏洞编号:** CVE-2024-3400

**漏洞类型:** 远程命令执行

**影响应用:** PAN-OS GlobalProtect

**危害等级:** 高危，未经身份验证的攻击者可以root权限执行任意代码。

**影响版本:** PAN-OS 10.2（低于10.2.9-h1），PAN-OS 11.0（低于11.0.4-h1），PAN-OS 11.1（低于11.1.2-h3）。仅影响配置了GlobalProtect网关或GlobalProtect门户的防火墙。

**利用条件:** 目标系统需启用GlobalProtect门户或网关功能，且为受影响的PAN-OS版本。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-3400是一个Palo Alto Networks PAN-OS中GlobalProtect功能存在的任意文件创建导致的操作系统命令注入漏洞。未经身份验证的攻击者可以通过构造恶意请求，在受影响的系统上以root权限执行任意代码。

**漏洞利用有效性：**

根据漏洞库信息、搜索结果和提供的PoC代码，可以判定此漏洞利用是有效的。漏洞库信息显示Palo Alto Networks已知存在利用此漏洞的攻击，并且第三方已公开PoC。搜索结果也证实了该漏洞已被积极利用。

**投毒风险分析：**

PoC代码主要包含以下几个文件：

*   `LICENSE`：MIT许可证，表明作者允许自由使用、复制、修改和分发代码。
*   `README.md`：包含漏洞的描述、使用方法、依赖说明和参考链接。使用说明指示如何扫描目标并提取配置文件。
*   `get_data.py`：该脚本从`confirmed_rce.log`文件中读取目标URL，然后使用多线程下载文件。下载的文件存储在`out/`目录下。
*   `run.py`：此脚本用于扫描目标，尝试利用该漏洞。它创建一个随机的文件名，并构造一个命令来打包`/opt/pancfg/mgmt/saved-configs/running-config.xml`文件，并将其保存在`/var/appweb/sslvpndocs/global-protect/portal/js/`目录下，这个目录是GlobalProtect Portal的js文件目录。

风险评估：

1.  **依赖安装：** `README.md`中要求安装`rich`库，这本身是相对安全的，但是从非官方源安装包则存在一定的风险。
2.  **目标文件获取：** `get_data.py`从`confirmed_rce.log`读取URL并下载文件。如果`confirmed_rce.log`被篡改，可能导致下载恶意文件。
3.  **命令构造：**  `run.py`构造的命令会将配置文件打包并放置到Web可访问目录，从而泄露敏感信息，例如管理员密码哈希等。攻击者可以利用这些信息进行进一步的攻击。

投毒风险：
代码本身看起来是合法的PoC，用于检测和利用CVE-2024-3400漏洞。但是，存在一些潜在的投毒风险，例如：
* 如果攻击者修改了`run.py`脚本，使其执行恶意命令，例如删除文件或安装后门，则可能造成更大的危害。但是目前看到的脚本仅仅是把配置文件导出来，风险较小。
*  如果依赖项`rich`被恶意版本替换，也可能导致代码执行过程中出现问题。

虽然存在上述风险，但考虑到PoC的主要功能是利用漏洞，而不是直接执行恶意操作，因此投毒的概率较低。此外，该PoC仅用于`get_data.py`下载文件，以及`run.py`产生exp，因此，这里的**投毒概率大概在10%**左右。

**漏洞利用方式：**

1.  **确定目标：** 攻击者首先需要确定存在漏洞的PAN-OS防火墙，这些防火墙启用了GlobalProtect门户或网关功能，并且运行着受影响的PAN-OS版本。
2.  **发送恶意请求：** 攻击者发送特制的HTTP请求，其中包含用于创建任意文件的命令注入代码。`run.py`文件展示了如何通过base64编码的命令，利用`tar`命令将敏感配置文件`/opt/pancfg/mgmt/saved-configs/running-config.xml`打包到Web可访问目录中。
3.  **执行任意代码：**  由于文件创建过程存在漏洞，攻击者可以将恶意代码注入到创建的文件中，或者利用文件创建来执行操作系统命令。通过将打包好的配置文件放置在web目录，攻击者可以下载这些文件。
4.  **权限提升：**  由于命令注入是以root权限执行的，攻击者可以完全控制受影响的系统，包括安装后门、窃取数据或破坏系统。
5.  **提取敏感信息：** 攻击者可以通过`get_data.py`下载配置文件，获取敏感信息。

总而言之，该漏洞的利用过程涉及发送恶意请求，利用任意文件创建漏洞执行命令注入，最终实现远程代码执行和权限提升。

**项目地址:** [andrelia-hacks/CVE-2024-3400](https://github.com/andrelia-hacks/CVE-2024-3400)

**漏洞详情:** [CVE-2024-3400](https://nvd.nist.gov/vuln/detail/CVE-2024-3400)