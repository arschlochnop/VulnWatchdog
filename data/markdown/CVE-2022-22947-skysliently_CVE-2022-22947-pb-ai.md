## CVE-2022-22947 Spring Cloud Gateway 代码注入

**漏洞编号:** CVE-2022-22947

**漏洞类型:** 代码注入

**影响应用:** Spring Cloud Gateway

**危害等级:** 高危，可能导致远程代码执行

**影响版本:** Spring Cloud Gateway 3.1.x < 3.1.1, 3.0.x < 3.0.7

**利用条件:** Gateway Actuator endpoint 启用、暴露且未进行安全保护

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2022-22947 是一个 Spring Cloud Gateway 中的远程代码执行漏洞。攻击者可以在 Gateway Actuator 端点启用、暴露且未进行安全保护的情况下，通过发送恶意构造的请求，利用 SpEL 表达式注入执行任意代码。

**有效性：**
提供的POC代码是有效的。它演示了如何利用该漏洞在启用了 Actuator 端点的 Spring Cloud Gateway 实例上执行任意代码。POC通过向 `/actuator/gateway/routes/{route_id}` 发送POST请求添加一个包含恶意SpEL表达式的路由，然后POST到 `/actuator/gateway/refresh` 来刷新路由，最后访问恶意路由来触发代码执行。

**投毒风险：**
经过对提供的POC代码进行分析，包括README.md，pom.xml，application.yml 和 src 目录下的文件。没有发现作者隐藏的恶意代码，该代码库目标为展示和验证漏洞利用，因此判定投毒风险为0%。

**利用方式：**
1.  **漏洞发现：** 确定目标 Spring Cloud Gateway 实例是否启用了 Actuator 端点，并且该端点是否暴露在未经身份验证的网络中。
2.  **构造恶意请求：** 构造一个包含恶意 SpEL 表达式的 JSON payload，该表达式用于执行任意代码。该表达式被嵌入到路由配置中，通常位于 `filters` 中的 `AddResponseHeader` 过滤器或类似的位置。
3.  **添加恶意路由：** 使用 POST 请求将包含恶意 SpEL 表达式的路由定义添加到 `/actuator/gateway/routes/{route_id}` 端点。
4.  **刷新路由：** 使用 POST 请求访问 `/actuator/gateway/refresh` 端点，强制 Spring Cloud Gateway 刷新路由配置。
5.  **触发恶意代码：** 访问与恶意路由关联的路径，触发 SpEL 表达式的执行，从而导致任意代码执行。
6.  **清理（可选）：** 利用漏洞执行恶意代码后，可能需要清理添加的恶意路由，以避免留下痕迹或影响正常服务。

**项目地址:** [skysliently/CVE-2022-22947-pb-ai](https://github.com/skysliently/CVE-2022-22947-pb-ai)

**漏洞详情:** [CVE-2022-22947](https://nvd.nist.gov/vuln/detail/CVE-2022-22947)