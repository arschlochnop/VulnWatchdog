## CVE-2019-3396 - Atlassian Confluence Widget Connector Server-Side Template Injection

**漏洞编号:** CVE-2019-3396

**漏洞类型:** Server-Side Template Injection (SSTI)

**影响应用:** Atlassian Confluence Server

**危害等级:** 高危，可能导致远程代码执行

**影响版本:** Affected versions: Before 6.6.12, 6.7.0 before 6.12.3, 6.13.0 before 6.13.3, and 6.14.0 before 6.14.2

**利用条件:** 需要Confluence Server实例，且安装了存在漏洞的Widget Connector宏。 某些版本可能需要Referer头部。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2019-3396 漏洞存在于 Atlassian Confluence Server 的 Widget Connector 宏中，是一个服务器端模板注入 (SSTI) 漏洞。攻击者可以通过构造恶意的请求，利用Velocity模板引擎执行任意代码，从而实现远程代码执行 (RCE)。

**漏洞利用方式:**

1.  攻击者向 `/rest/tinymce/1/macro/preview` 端点发送 POST 请求。
2.  请求体包含 JSON 数据，其中 `macro` 字段指定了 `widget` 宏，`params` 字段包含了漏洞利用的关键参数。
3.  `_template` 参数用于指定模板的位置，可以是本地文件 (例如 `file:///etc/passwd` 用于读取文件) 或远程 FTP 服务器上的文件 (例如 `ftp://10.10.20.166:8886/r.vm` 用于执行命令)。
4.  当 `_template` 参数指向 FTP 服务器上的 Velocity 模板文件时，可以使用 `command` 参数指定要执行的系统命令。
5.  服务器端会解析并渲染 Velocity 模板，执行 `command` 参数指定的命令，并将结果返回给攻击者。

**POC 代码分析:**

提供的 POC 代码展示了以下利用方式：

*   **文件读取:** 通过设置 `_template` 参数为 `file:///etc/passwd`，可以读取服务器上的 `/etc/passwd` 文件。
*   **命令执行:** 通过设置 `_template` 参数为 FTP 服务器上的 Velocity 模板文件，并使用 `command` 参数指定要执行的命令，可以执行任意系统命令。 POC代码中演示了使用`ifconfig` 命令获取服务器的网络配置信息.
*   **反弹 Shell:** POC代码中演示了如何利用python脚本反弹shell，通过设置 `_template` 参数为 FTP 服务器上的 Velocity 模板文件，将命令设置成执行python反弹shell脚本，从而获取shell权限。
*   **Payload编码绕过:**  展示了如何对命令进行base64编码，绕过某些安全策略

**投毒风险分析:**

虽然漏洞利用代码本身主要关注漏洞利用，但仍然存在一定的投毒风险。风险点在于 FTP 服务器上的 Velocity 模板文件 (`r.vm`)。攻击者可能会修改 `r.vm` 文件，在其中插入恶意代码，例如下载和执行恶意软件，从而感染受害者。

尽管提供的代码没有明显的恶意行为，例如植入后门或窃取信息。 但不排除作者隐藏了不易察觉的恶意代码的可能性。 相对来说，使用`ftp`协议从远程服务器拉取velocity模板文件执行代码，引入了更大的风险，恶意代码可以存在于远程服务器，且不容易被发现. 总体来说，POC代码本身投毒概率较低，风险主要集中在恶意使用者修改攻击代码，将`r.vm`替换成包含恶意代码的文件。

搜索引擎结果显示，CVE-2019-3396 已被广泛利用，攻击者使用此漏洞传播加密货币挖矿恶意软件和 GandCrab 勒索软件。表明该漏洞具有很高的实际威胁。

**结论:**

该漏洞利用的有效性很高，可以实现远程代码执行。 投毒风险主要集中在远程服务器上的Velocity模板文件内容上，实际投毒风险估计为10%。漏洞利用方式是通过构造恶意的 HTTP 请求，利用 Velocity 模板引擎执行任意代码。

**项目地址:** [jas502n/CVE-2019-3396](https://github.com/jas502n/CVE-2019-3396)

**漏洞详情:** [CVE-2019-3396](https://nvd.nist.gov/vuln/detail/CVE-2019-3396)