## CVE-2022-36804-Bitbucket 命令注入

**漏洞编号:** CVE-2022-36804

**漏洞类型:** 命令注入

**影响应用:** Atlassian Bitbucket Server and Data Center

**危害等级:** 高危，可导致远程代码执行

**影响版本:** < 8.3.1

**利用条件:** 需要对公共仓库或私有仓库具有读取权限，或拥有有效的session cookie

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2022-36804是Atlassian Bitbucket Server和Data Center中存在的一个命令注入漏洞。攻击者通过发送恶意的HTTP请求，利用多个API端点中的漏洞，可以在目标系统上执行任意代码。

**有效性：**

根据漏洞库信息和搜索结果，此漏洞已被公开披露，并且存在可用的PoC代码。Rapid7 和 AssetNote 的分析都表明该漏洞很容易被利用。

提供的PoC代码（BenHays142/CVE-2022-36804-PoC-Exploit）的README.md显示，该漏洞需要开启公共仓库，或使用有效的BITBUCKETSESSIONID cookie（如果目标仓库是私有的）。利用方式是发送特制的HTTP请求到受影响的API端点。

**投毒风险：**

代码中检测到自动查找repo的功能，以及命令执行的功能。虽然这些功能是漏洞利用的一部分，但是也增加了投毒风险，例如在自动查找repo时，如果恶意修改了repo的参数，可能会造成拒绝服务攻击。进一步分析 `main.py`，没有明显的恶意代码，该脚本主要功能是：

1.  检测是否存在可利用的repo（`detect_repo` 函数）。
2.  执行命令（`exec_stuff` 函数）。
3.  检查目标是否容易受到攻击（`check_vuln` 函数）。

虽然代码本身看起来没有明显的恶意行为，但是使用此PoC仍然存在风险，因为攻击者可能会修改PoC代码以包含恶意功能。因此，投毒风险评估为5%。

**利用方式：**

该漏洞的利用方式是通过构造恶意的HTTP请求，该请求利用了 `git archive` 命令中的 `--exec` 参数。具体来说，通过在URL中嵌入特殊的payload，攻击者可以在服务器上执行任意命令。

`main.py` 脚本利用 `archive` API，并使用特殊构造的 `prefix` 参数来执行命令：

```
/rest/api/latest/projects/{project}/repos/{repo}/archive?format=zip&path=aaa&prefix=test/%00--remote=/%00--exec=%60{cmd}%60%00--prefix=/
```

其中，`{cmd}` 是要执行的命令，`%00` 是 NULL 字节，用于截断字符串，从而使 `--exec` 参数生效。服务器在处理此请求时，由于未正确过滤或转义参数，导致命令注入漏洞。

**漏洞影响：**

成功利用此漏洞的攻击者可以在Bitbucket服务器上执行任意代码，这可能导致系统完全受损，数据泄露，服务中断等严重后果。

**项目地址:** [benjaminhays/CVE-2022-36804-PoC-Exploit](https://github.com/benjaminhays/CVE-2022-36804-PoC-Exploit)

**漏洞详情:** [CVE-2022-36804](https://nvd.nist.gov/vuln/detail/CVE-2022-36804)