## CVE-2023-3128-Grafana-账户接管/身份验证绕过

**漏洞编号:** CVE-2023-3128

**漏洞类型:** 账户接管/身份验证绕过

**影响应用:** Grafana

**危害等级:** 高危，可能导致账户接管、数据泄露、未授权访问

**影响版本:** < 9.5.4, < 9.4.13, < 9.3.16, < 9.2.20, < 8.5.27, >= 6.7.0

**利用条件:** 目标Grafana实例配置了Azure AD OAuth，且为多租户应用

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2023-3128 漏洞存在于 Grafana 中，当配置了 Azure AD OAuth 作为身份验证方式时，由于 Grafana 基于 email claim 验证 Azure AD 账户，而 Azure AD 中 profile email 字段不是唯一的且可以被修改，导致攻击者可以通过控制目标用户邮箱的 Azure AD 账户，绕过身份验证，接管 Grafana 账户。

**有效性评估：**
提供的 POC 代码首先检查目标 Grafana 实例是否配置了 Azure AD SSO。如果配置了，则认为可能存在漏洞。但是，POC **并未** 自动进行漏洞利用，而是提示需要手动创建一个 Azure AD 账户，该账户的邮箱与目标 Grafana 用户相同。因此，**POC 只能用于初步检测，漏洞利用部分需要手动操作，并且需要攻击者能够控制邮箱域**。POC 的有效性在于其能够确定目标系统是否满足漏洞利用的前提条件。

**投毒风险分析：**
提供的 Python 脚本代码较为简洁，主要用于检测 Azure AD SSO 配置，没有发现任何恶意代码或后门逻辑。代码中没有执行任何危险操作，例如文件写入、命令执行等。因此，可以认为该仓库中**不存在投毒代码，投毒风险为 0%**。

**漏洞利用方式：**
1.  **前提条件：** 目标 Grafana 实例启用了 Azure AD OAuth 认证，且为多租户应用。
2.  **攻击步骤：**
    *   攻击者首先确定目标 Grafana 用户的邮箱地址。
    *   攻击者在 Azure AD 中创建一个账户，使用与目标用户相同的邮箱地址。（**这是一个关键步骤，需要攻击者能够控制该邮箱，或者找到一种方法在未经授权的情况下使用该邮箱创建 Azure AD 账户**）
    *   攻击者使用新创建的 Azure AD 账户登录 Grafana。
    *   Grafana 错误地信任了 Azure AD 提供的 email claim，认为该账户属于目标用户，从而允许攻击者登录并接管目标用户的账户。

**搜索引擎信息补充：**
搜索引擎结果表明，该漏洞被评为严重级别，并可能导致攻击者完全控制用户账户。Qualys, Rapid7 等公司也发布了关于此漏洞的报告, 详细描述了漏洞的危害和利用方式。

**项目地址:** [spyata123/CVE-2023-3128](https://github.com/spyata123/CVE-2023-3128)

**漏洞详情:** [CVE-2023-3128](https://nvd.nist.gov/vuln/detail/CVE-2023-3128)