## CVE-2019-7214 - SmarterMail Deserialization RCE

**漏洞编号:** CVE-2019-7214

**漏洞类型:** .NET Deserialization Remote Code Execution

**影响应用:** SmarterMail

**危害等级:** 高危，可导致远程代码执行

**影响版本:** < Build 6985

**利用条件:** 目标服务器运行SmarterMail 16.x，且17001端口对外开放（默认build 6985后已关闭）。攻击者需要能够向17001端口发送请求。

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2019-7214 漏洞存在于 SmarterTools SmarterMail 16.x build 6985 之前的版本中。这是一个 .NET 反序列化漏洞，未经身份验证的攻击者可以通过 17001 端口向服务器发送恶意构造的序列化数据，从而在服务器上执行任意代码。 

**有效性：**
根据漏洞描述和提供的漏洞利用代码，该漏洞利用的有效性较高。多个来源确认了该漏洞的存在，并且 exploit-db 上也存在相关的利用代码。

**投毒风险：**
提供的 Python 代码 `cve-2019-7214.py` 的主要功能是：

1.  构造一个包含嵌入式 PowerShell 命令的 .NET 反序列化 payload。
2.  PowerShell 命令的作用是创建一个 TCP 反向 shell 连接到攻击者指定的 LHOST 和 LPORT。
3.  将 payload 发送到目标 SmarterMail 服务器的 17001 端口。

代码中包含的 PowerShell 脚本会连接到攻击者指定的 IP 地址和端口，执行接收到的命令，并将结果返回。理论上攻击者可以在反向shell执行任何操作，危害极大。

尽管如此，该漏洞本身就是执行任意代码，因此，如果使用者明确知道正在利用反序列化漏洞执行命令，将反向shell连接到自己的服务器，那么它就不是后门或投毒代码。
README.md 提示用户某些 POC 可能需要修改，也属于正常情况。

但依旧存在一定的投毒风险，例如：

*   **隐藏的远程包含：** 代码中可能存在远程包含恶意代码的语句，但从提供的代码片段中未发现。
*   **微妙的参数篡改：** 攻击者可能在不知情的情况下修改了 LHOST/LPORT，导致 shell 连接到攻击者的服务器。

因此，综合来看，投毒风险较低，约为 5%。

**利用方式：**

1.  **确定目标版本：** 确认目标服务器运行的 SmarterMail 版本低于 build 6985。
2.  **检查端口可达性：** 确保可以访问目标服务器的 17001 端口。
3.  **配置攻击机：** 设置攻击机的监听端口（LPORT）和 IP 地址（LHOST）。
4.  **修改并运行Exploit** 修改exp中的HOST,LHOST,PORT,LPORT,生成Payload并且进行发送.
5.  **执行 PowerShell 命令：** 成功利用漏洞后，可以在目标服务器上执行任意 PowerShell 命令。

**项目地址:** [devzspy/CVE-2019-7214](https://github.com/devzspy/CVE-2019-7214)

**漏洞详情:** [CVE-2019-7214](https://nvd.nist.gov/vuln/detail/CVE-2019-7214)