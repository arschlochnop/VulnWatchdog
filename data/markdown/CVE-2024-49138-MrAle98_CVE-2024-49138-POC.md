## CVE-2024-49138 - Windows CLFS 提权漏洞

**漏洞编号:** CVE-2024-49138

**漏洞类型:** 特权提升

**影响应用:** Windows Common Log File System (CLFS) Driver

**危害等级:** 高危，允许本地用户提升权限

**影响版本:** 受影响的Windows版本众多，具体参考CVE描述中的版本范围

**利用条件:** 需要本地访问权限

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-49138 是 Windows CLFS 驱动中的一个堆缓冲区溢出漏洞。根据漏洞库信息和搜索结果，该漏洞允许经过身份验证的本地攻击者提升权限。CISA 已将此漏洞添加到已知被利用的漏洞目录 (KEV)。

**有效性：**

提供的POC代码似乎是有效的，因为搜索结果中指向 GitHub 仓库 (MrAle98/CVE-2024-49138-POC) 的链接，表明该漏洞已由研究人员分析并提供了POC。链接描述提到漏洞已被积极利用，且POC已在Windows 11 23H2上测试通过。代码片段中包含常见的Windows API调用，比如`Clfsw32.lib`以及 `NtQuerySystemInformation` `NtReadVirtualMemory` `NtWriteVirtualMemory` 。通过`GetKernelBaseAddress` 获取内核地址，根据偏移计算重要函数地址例如`POFXPROCESSORNOTIFICATION_OFFSET`等，并通过读写内核内存覆盖进程token信息等操作，推测是提权的常用手段

**投毒风险：**

分析POC代码片段，虽然不能完全排除投毒风险，但初步评估风险较低。代码主要围绕利用CLFS驱动漏洞进行提权，逻辑较为清晰。漏洞利用代码存在投毒的风险，大概在10%左右。因为代码包含较多的内核读写操作，如果被恶意修改，可能导致系统崩溃或其他不可预测的行为。在没有完整代码的情况下，无法准确判定。但是由于poc直接调用了windows底层api，如果作者在编译后的二进制文件中加入恶意代码，用户很难发现。

**利用方式：**

1.  **触发漏洞：**  该漏洞是 CLFS 驱动中的堆缓冲区溢出，攻击者需要构造特定的CLFS日志文件或调用相关API来触发溢出。
2.  **控制执行流程：** 通过精心设计的溢出数据，攻击者可以覆盖内存中的关键数据结构，例如控制块、函数指针等，从而控制程序的执行流程。
3.  **提权：**  利用流程控制，攻击者可以修改当前进程的访问令牌，将其替换为具有更高权限的令牌（例如 SYSTEM 权限），从而实现提权。部分利用可能涉及内核地址的读写。
4.  **执行恶意代码：** 获得 SYSTEM 权限后，攻击者可以执行任意恶意代码，例如安装后门、窃取敏感信息等。

**项目地址:** [MrAle98/CVE-2024-49138-POC](https://github.com/MrAle98/CVE-2024-49138-POC)

**漏洞详情:** [CVE-2024-49138](https://nvd.nist.gov/vuln/detail/CVE-2024-49138)