## CVE-2024-9264-Grafana-远程代码执行

**漏洞编号:** CVE-2024-9264

**漏洞类型:** 远程代码执行

**影响应用:** Grafana

**危害等级:** 严重，可能导致完全系统控制和数据泄露

**影响版本:** >= 11.0.0 且 < 11.0.5, >= 11.0.6, >= 11.1.0 且 < 11.1.6, >= 11.1.7, >= 11.2.0 且 < 11.2.1, >= 11.2.2

**利用条件:** 需要Grafana实例启用SQL Expressions实验性功能，且用户具有Viewer或更高权限，以及DuckDB二进制文件存在于Grafana的$PATH中。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-9264是Grafana中SQL Expressions功能中的一个远程代码执行漏洞。攻击者利用此漏洞可以通过构造恶意的duckdb查询，在服务器上执行任意shell命令。漏洞利用依赖于`duckdb`二进制文件存在于Grafana的`$PATH`中。提供的POC代码包含一个Dockerfile，用于构建包含漏洞环境的Grafana实例，并安装了DuckDB。`poc.py`脚本可以模拟漏洞利用过程，需要提供Grafana实例URL、用户名、密码以及反向shell的IP地址和端口。利用步骤如下：

1.  **身份验证：** 使用提供的用户名和密码登录Grafana实例。
2.  **构造Payload：** 创建一个包含恶意SQL表达式的查询，该表达式将使用`shellfs`扩展执行命令，例如建立反向shell连接。
3.  **发送请求：** 将构造的Payload发送到Grafana API端点，以执行恶意查询。
4.  **命令执行：** 如果成功，Grafana服务器将执行指定的命令，并建立与攻击者的反向shell连接。

**投毒风险分析：**

代码中存在微小的投毒风险，主要体现在`poc.py`脚本中。 虽然代码本身旨在演示漏洞利用，但攻击者可能会修改Payload以包含更隐蔽的后门或恶意代码。 此外，Dockerfile中下载和安装DuckDB的步骤也可能被利用，如果下载源被篡改，则可能引入恶意二进制文件。

 考虑到POC的目的主要是演示漏洞，并且代码相对简单直接，作者隐藏的恶意代码风险较低，约占10%。 但是，用户在使用时务必谨慎，并审查代码。

该漏洞的缓解措施包括升级到已修复的版本，禁用SQL Expressions功能，以及确保DuckDB二进制文件来自可信来源。

**项目地址:** [z3k0sec/CVE-2024-9264-RCE-Exploit](https://github.com/z3k0sec/CVE-2024-9264-RCE-Exploit)

**漏洞详情:** [CVE-2024-9264](https://nvd.nist.gov/vuln/detail/CVE-2024-9264)