## CVE-2023-46604-Apache ActiveMQ-远程代码执行

**漏洞编号:** CVE-2023-46604

**漏洞类型:** 反序列化漏洞

**影响应用:** Apache ActiveMQ

**危害等级:** 高危，可导致远程代码执行

**影响版本:** 5.15.16之前, 5.16.7之前, 5.17.6之前, 5.18.3之前

**利用条件:** 需要网络访问ActiveMQ broker的61616端口

**POC 可用性:** 是

**投毒风险:** 1%

## 详情

CVE-2023-46604 是 Apache ActiveMQ 中存在的一个远程代码执行漏洞。该漏洞是由于 Java OpenWire 协议 marshaller 在处理序列化数据时存在缺陷，允许远程攻击者通过操纵 OpenWire 协议中的序列化类类型，使客户端或 broker 实例化 classpath 上的任何类，从而执行任意 shell 命令。

**漏洞利用方式：**

1.  **目标确定：** 使用 Shodan 等搜索引擎查找暴露在公网上的 ActiveMQ 服务，端口为 61616。
2.  **Payload 构造：** 构造恶意的 OpenWire 协议数据包，其中包含指向恶意 Spring XML 配置文件的引用。恶意 XML 文件中定义了一个 bean，该 bean 使用 `java.lang.ProcessBuilder` 执行任意命令。
3.  **攻击执行：** 将构造的恶意数据包发送到 ActiveMQ broker 的 61616 端口。
4.  **代码执行：** ActiveMQ broker 反序列化数据，加载恶意的 Spring XML 配置文件，从而执行攻击者指定的任意命令。

**POC 代码分析：**

提供的 POC 代码包含以下文件：

*   `README.md`: 描述漏洞和工具的使用方法。
*   `exploit.py`: Python 脚本，用于发送恶意 OpenWire 协议数据包到目标 ActiveMQ 服务。
*   `poc.xml`: 恶意的 Spring XML 配置文件，用于执行任意命令，例如反弹 shell。

`exploit.py` 脚本接受目标 IP 地址和恶意 XML 配置文件的 URL 作为参数。它首先构造恶意的 OpenWire 协议数据包，然后将其发送到目标 ActiveMQ 服务的 61616 端口。如果成功，ActiveMQ broker 将加载 `poc.xml` 文件，从而执行攻击者指定的任意命令。

**投毒风险分析：**

虽然`exploit.py`中没有明显的恶意代码，但是其核心功能是执行任意`poc.xml`，所以风险完全来自于所使用的`poc.xml`。默认的`poc.xml`文件会尝试反弹shell, 如果该`poc.xml`被替换为更恶意的操作，比如删除关键文件、上传木马等等，则可能造成更大的危害。经过分析，作者隐藏投毒代码的可能性较低，约为1%。

综上所述，提供的 POC 代码有效，可以用于利用 CVE-2023-46604 漏洞实现远程代码执行。然而，使用者需要注意 `poc.xml` 文件的内容，确保其安全性，避免被用于执行恶意操作。

**项目地址:** [mrpentst/CVE-2023-46604](https://github.com/mrpentst/CVE-2023-46604)

**漏洞详情:** [CVE-2023-46604](https://nvd.nist.gov/vuln/detail/CVE-2023-46604)