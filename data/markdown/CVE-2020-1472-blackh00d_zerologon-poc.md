## CVE-2020-1472 Zerologon Netlogon 特权提升漏洞

**漏洞编号:** CVE-2020-1472

**漏洞类型:** 特权提升

**影响应用:** Windows Server

**危害等级:** 高危，允许未经身份验证的攻击者获取域管理员权限，完全控制域环境

**影响版本:** 受影响的Windows Server版本包括2008 R2 SP1, 2012, 2012 R2, 2016, 2019, 2004, 1903, 1909, 20H2

**利用条件:** 攻击者需要与域控制器建立网络连接。

**POC 可用性:** 是

**投毒风险:** 1%

## 详情

CVE-2020-1472，也被称为Zerologon，是一个严重的Windows Netlogon协议中的特权提升漏洞。攻击者可以通过向域控制器发送一系列特制的Netlogon消息来利用此漏洞，从而将域控制器的机器账户密码置为空。一旦密码被置为空，攻击者可以使用该空密码通过Netlogon协议对域控制器进行身份验证，并执行诸如更改域管理员密码、DCSync等恶意操作，从而完全控制整个域。

**有效性：**

根据漏洞信息和搜索结果，提供的PoC代码是有效的。许多安全研究人员和组织已经发布了该漏洞的利用代码，并成功利用该漏洞获取域管理员权限。

**投毒风险：**

分析PoC代码，该代码主要功能是：

1.  通过`try_zero_authenticate` 函数尝试将域控制器的Netlogon密码置零，通过多次认证尝试，利用加密算法缺陷达到目的。
2.  如果成功，则使用`exploit`函数将机器帐户密码实际设置为空字符串。
3.  可选地，使用`dcsync`函数从域控制器同步密码哈希。
4.  提供`restore_password`函数用于恢复原始密码。

从代码分析来看，主要风险在于利用成功后，攻击者可以完全控制域，而非PoC本身携带恶意代码。但用户使用未经审核的第三方代码始终存在风险，例如作者可能在代码中埋藏后门，收集用户信息等。因此，我们认为存在非常低的投毒风险，概率约为1%。

**利用方式：**

1.  **漏洞发现：** CVE-2020-1472 存在于 Netlogon 远程协议 (MS-NRPC) 中，该协议用于用户和机器对域控制器的身份验证。该漏洞源于 AES-CFB8 加密算法的实现缺陷，允许攻击者使用全零初始化向量。
2.  **攻击步骤：**
    *   攻击者首先需要与目标域控制器建立网络连接。
    *   利用PoC代码，通过`try_zero_authenticate`函数不断尝试使用全零凭据对域控制器进行身份验证。由于加密算法的缺陷，经过多次尝试后，域控制器可能会错误地接受全零凭据。
    *   一旦身份验证成功，攻击者使用`exploit`函数通过Netlogon协议将域控制器的机器账户密码设置为空字符串。
    *   现在，攻击者可以使用空密码通过Netlogon协议对域控制器进行身份验证。
    *   利用获取的域控制器权限，攻击者可以执行DCSync操作，获取域中所有用户的密码哈希，或者直接创建一个新的域管理员帐户。
3.  **缓解措施：**
    *   尽快安装 Microsoft 发布的针对 CVE-2020-1472 的安全更新。
    *   监控域控制器上的事件日志，查找与 Netlogon 相关的异常活动。
    *   强制执行 Netlogon 安全通道的签名和加密。

**项目地址:** [blackh00d/zerologon-poc](https://github.com/blackh00d/zerologon-poc)

**漏洞详情:** [CVE-2020-1472](https://nvd.nist.gov/vuln/detail/CVE-2020-1472)