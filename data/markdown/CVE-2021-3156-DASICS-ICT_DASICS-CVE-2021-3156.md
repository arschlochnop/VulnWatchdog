## CVE-2021-3156 - Sudo Heap-Based Buffer Overflow

**漏洞编号:** CVE-2021-3156

**漏洞类型:** Heap-Based Buffer Overflow

**影响应用:** Sudo

**危害等级:** 高危，可导致本地权限提升至root

**影响版本:** Sudo before 1.9.5p2

**利用条件:** 本地用户能够执行sudo命令

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-3156 (Baron Samedit) 是 Sudo 1.9.5p2 之前版本中的一个堆缓冲区溢出漏洞。此漏洞允许本地用户通过 `sudoedit -s` 和以单个反斜杠字符结尾的命令行参数将权限提升至 root。 

**有效性：**
根据提供的漏洞信息、搜索结果和漏洞利用代码，可以确认该漏洞利用是有效的。搜索结果中多个链接（如 Qualys 博客、NCC Group 博客、Red Hat 页面等）都证实了该漏洞的存在和严重性，以及可被利用的事实。提供的漏洞利用代码包含 Makefile 和 README，指示了编译和使用漏洞利用程序的方法，并提供了效果演示，进一步表明了其有效性。

**投毒风险：**
该仓库中存在投毒代码的风险较低，约为 10%。主要考虑因素如下：
*   **Makefile编译：** 该POC的编译流程包含了sudo的编译，可能在编译过程中修改sudo源代码，加入恶意代码。
*   **busybox镜像：** POC需要特定的环境，包括busybox系统镜像rootfs.img，镜像本身可能包含恶意代码。
*   **nss库：** POC需要libnss_x-x.so.2库，恶意作者可能会在库中植入后门，但这种可能性较低，因为可以通过分析源代码来检测。
鉴于需要特定的环境和编译步骤，存在一些潜在的恶意代码植入点，但公开的POC通常会经过社区审查，因此风险相对较低。需要注意的是，为了重现漏洞，必须使用提供的环境配置，这在一定程度上增加了安全风险。

**利用方式：**
该漏洞的利用方式如下：
1.  **漏洞触发：** 通过 `sudoedit -s` 命令，并构造一个以单个反斜杠字符结尾的命令行参数，触发 off-by-one 错误，导致堆缓冲区溢出。
2.  **权限提升：** 利用堆缓冲区溢出覆盖关键数据，从而获得 root 权限。
3.  **POC利用：** 提供的 POC 代码包含一个利用程序 (`exploit`) 和一个定制的 nss 库 (`libnss_x-x.so.2`)。该利用程序通过溢出修改 sudo 的行为，而 nss 库可能包含用于执行任意代码的 shellcode 或其他恶意逻辑。
4.  **利用步骤:**
    *   编译`sudo`和`exploit`。
    *   使用提供的`rootfs.img`启动`linux`，并进入`busybox`命令行界面。
    *   切换用户到`wanghan`。
    *   运行`./exploit`。
    *   验证当前用户是否为root。
利用的成功取决于目标系统上 Sudo 版本和 glibc 版本的兼容性。根据 README，该 POC 针对的是 `sudo` 1.8.31 和 `glibc` 2.31 在 `Linux` 4.18 或 5.10.167-gee203559bc0b-dirty 上。

**项目地址:** [DASICS-ICT/DASICS-CVE-2021-3156](https://github.com/DASICS-ICT/DASICS-CVE-2021-3156)

**漏洞详情:** [CVE-2021-3156](https://nvd.nist.gov/vuln/detail/CVE-2021-3156)