## CVE-2023-38646-Metabase-RCE

**漏洞编号:** CVE-2023-38646

**漏洞类型:** 远程代码执行(RCE)

**影响应用:** Metabase

**危害等级:** 高危，未经身份验证的远程代码执行

**影响版本:** Metabase open source < 0.46.6.1 和 Metabase Enterprise < 1.46.6.1

**利用条件:** 目标Metabase实例网络可达

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2023-38646 漏洞允许未经身份验证的攻击者在 Metabase 服务器上执行任意命令。根据漏洞库信息和搜索结果，该漏洞影响 Metabase 开源版本低于 0.46.6.1 和 Metabase 企业版本低于 1.46.6.1 的实例。多个资源确认了该漏洞的存在和严重性。

提供的 PoC 代码 `exploit.py` 尝试利用此漏洞。它首先获取 Metabase 实例的 `setup-token`，然后构造一个包含恶意 H2 数据库连接字符串的 JSON payload。该连接字符串利用 H2 数据库的特性，在连接时执行任意 Java 代码，从而实现远程代码执行。Payload使用base64编码反弹shell命令。

**利用方式：**

1.  **获取 Setup Token：**  PoC 脚本首先向目标 Metabase 实例的 `/api/session/properties` 端点发送 GET 请求，解析返回的 JSON 数据以提取 `setup-token`。此 token 用于后续的漏洞利用。
2.  **构造恶意 Payload：**  该脚本构造一个 JSON payload，其中包含一个恶意的 H2 数据库连接字符串。该字符串利用 `TRACE_LEVEL_SYSTEM_OUT=1` 和 `CREATE TRIGGER` 等 H2 特性，在数据库连接时执行任意 Java 代码。
3.  **发送 Payload：**  脚本将构造好的 payload 发送到 `/api/setup/validate` 端点，触发漏洞。成功利用后，服务器将执行 payload 中的命令，反弹 shell 到攻击者的机器。

**投毒风险分析：**

PoC 代码主要功能是利用漏洞，并无明显的恶意投毒代码，但是仍存在一定的风险, 因为PoC 最终目的是执行任意代码，攻击者可以替换反弹shell的payload为恶意payload,例如删除服务器数据，因此投毒风险存在，预估比例为5%。此评估基于代码本身，不包括代码托管平台可能存在的风险，如账号被盗等。

**项目地址:** [nickswink/CVE-2023-38646](https://github.com/nickswink/CVE-2023-38646)

**漏洞详情:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)