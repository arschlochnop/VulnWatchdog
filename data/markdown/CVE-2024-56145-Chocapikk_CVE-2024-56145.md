## CVE-2024-56145 - Craft CMS RCE

**漏洞编号:** CVE-2024-56145

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Craft CMS

**危害等级:** 严重，可能导致完全系统控制

**影响版本:** 3.0.0 < 3.9.14, 4.0.0-RC1 < 4.13.2, 5.0.0-RC1 < 5.5.2，且php.ini中register_argc_argv配置开启

**利用条件:** 目标Craft CMS版本受影响，PHP配置开启`register_argc_argv`，攻击者可网络访问。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-56145是一个Craft CMS中的远程代码执行漏洞。该漏洞出现在`register_argc_argv` PHP配置选项启用时。 攻击者可以通过精心构造的payload利用此漏洞执行任意代码。利用方式如下：

1.  **漏洞原理:** 当`register_argc_argv`启用时，PHP会将GET, POST, COOKIE等数据填充到`argv`全局变量中。未经过滤的`argv`变量会被Craft CMS用于模板路径的解析，从而造成命令注入。

2.  **利用步骤 (基于提供的POC代码):**
    *   **设置环境:** 首先，需要在目标系统或本地搭建一个受影响版本的Craft CMS，并确保`register_argc_argv`配置项已开启。POC 代码提供了使用 `ddev` 的自动化环境配置脚本。
    *   **FTP Server:** 该漏洞利用工具会启动一个 FTP 服务，用于存放恶意 payload，并通过 FTP 协议提供给 Craft CMS 应用。
    *   **Payload生成:**  攻击者需要构造一个恶意的模板路径Payload，通过特定的参数传递给Craft CMS，Craft CMS会解析该模板路径，从而执行payload中包含的恶意代码。
    *   **漏洞触发:** 构造包含恶意模板路径的请求发送到目标 Craft CMS 应用。如果目标存在漏洞，且FTP服务配置正确，则恶意代码会被执行。
    *   **反弹shell:** POC代码可以生成多种反弹shell的payload（bash, nc, mkfifo），从而允许攻击者控制目标系统。

3.  **投毒风险:**  POC代码使用了一个FTP server来传输恶意代码，如果代码编写者在FTP服务器上放置了其它恶意文件，可能会在不知情的情况下被目标系统下载和执行，从而导致投毒。此外，该POC工具使用`pygyat`库，这是一个用于编写python命令行工具的库，本身并无明显的投毒风险。POC代码主要功能是漏洞利用，较为直接，但依然存在一定的投毒的可能性，例如在payload生成环节植入恶意代码。

4.  **缓解措施:**
    *   升级到Craft CMS的最新版本（>= 3.9.14, >= 4.13.2, >= 5.5.2）。
    *   禁用`register_argc_argv`配置选项。


**项目地址:** [Chocapikk/CVE-2024-56145](https://github.com/Chocapikk/CVE-2024-56145)

**漏洞详情:** [CVE-2024-56145](https://nvd.nist.gov/vuln/detail/CVE-2024-56145)