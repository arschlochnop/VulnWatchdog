## CVE-2019-3396-Confluence-Widget-Connector-SSTI

**漏洞编号:** CVE-2019-3396

**漏洞类型:** 服务器端模板注入(SSTI)

**影响应用:** Atlassian Confluence Server

**危害等级:** 高危，可导致远程代码执行

**影响版本:** before 6.6.12, from 6.7.0 before 6.12.3, from 6.13.0 before 6.13.3, and from 6.14.0 before 6.14.2

**利用条件:** 需要Confluence Server实例存在Widget Connector宏，且版本在受影响范围内。无需身份验证。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

该漏洞存在于Atlassian Confluence Server的Widget Connector宏中，由于对用户输入过滤不严格，导致攻击者可以通过构造恶意的Velocity模板代码，实现服务器端模板注入(SSTI)，进而执行任意代码。

**有效性分析：**

根据漏洞库信息和搜索结果，CVE-2019-3396是一个已知的且被广泛利用的漏洞。漏洞利用代码中提供了多个`.vm`文件，这些是Velocity模板文件，用于执行任意命令或获取服务器信息。`cmd.vm`和`cmd2.vm`用于执行命令，而`test.vm`用于获取系统属性。

根据提供的漏洞利用代码，`cmd.vm` 和 `cmd2.vm` 这两个文件利用 `java.lang.Runtime.getRuntime().exec()` 执行任意命令。`test.vm` 获取系统属性。这些代码与公开的漏洞利用信息相符，表明提供的POC代码有效。

**投毒风险分析：**

提供的漏洞利用代码主要包含Velocity模板文件(`.vm`)，以及一些jspx和aspx文件。Velocity模板文件用于服务器端模板注入，主要目的是执行命令或获取系统信息，本身不具备明显的投毒特征。
*   `cmd.vm` 和 `cmd2.vm`: 用于远程命令执行，直接利用了漏洞，不包含投毒代码。
*   `test.vm`: 用于获取系统属性，例如用户目录，操作系统等，不包含投毒代码。
*   `test.aspx` (C#): 通过Session传递密钥，然后使用RijndaelManaged算法进行解密，加载并执行，这段代码有作为webshell的潜力，但是它需要一个配合的加密后的payload才能生效，因此它的风险在于后续的payload。投毒风险较低。
*   `test.jspx`: 通过Session传递密钥，然后使用AES算法进行解密，加载并执行，这段代码有作为webshell的潜力，需要配合加密后的payload，因此它的风险在于后续的payload。投毒风险较低。

总体来看，投毒风险主要来源于`test.aspx`和`test.jspx` 潜在的后门风险，需要配合加密的payload才能触发。如果后续使用了被篡改的Payload可能会存在投毒行为,因此总体投毒风险评估为10%。

**利用方式：**

1.  **漏洞入口：**  利用Confluence Server中Widget Connector宏。
2.  **构造恶意Velocity模板：**  构造包含恶意代码的Velocity模板，例如利用`java.lang.Runtime.getRuntime().exec()`执行任意命令。
3.  **发送Payload：**  将构造好的恶意Velocity模板代码作为Widget Connector宏的参数发送给Confluence Server。
4.  **远程代码执行：**  Confluence Server解析Velocity模板时，执行其中的恶意代码，实现远程代码执行。

**项目地址:** [W2Ning/CVE-2019-3396](https://github.com/W2Ning/CVE-2019-3396)

**漏洞详情:** [CVE-2019-3396](https://nvd.nist.gov/vuln/detail/CVE-2019-3396)