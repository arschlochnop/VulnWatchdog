## CVE-2021-3493-Ubuntu OverlayFS 本地提权

**漏洞编号:** CVE-2021-3493

**漏洞类型:** 本地提权

**影响应用:** Ubuntu Linux Kernel

**危害等级:** 高危，本地用户可提升至 root 权限

**影响版本:** 4.4 <= kernel < 4.4.0-209.241, 4.15 <= kernel < 4.15.0-142.146, 5.4 <= kernel < 5.4.0-72.80, 5.8 <= kernel < 5.8.0-50.56

**利用条件:** Ubuntu 内核开启了 unprivileged user namespaces 和 unprivileged overlay mounts

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

该漏洞存在于 Ubuntu Linux 内核的 OverlayFS 实现中，由于 overlayfs 对底层文件系统中文件 capabilities 的设置验证不当，结合未授权用户命名空间和 Ubuntu 内核中允许未授权 overlay 挂载的补丁，攻击者可利用此漏洞提升权限。

**利用方式：**

1.  **环境准备：** 首先，确保目标系统满足漏洞利用的条件，即 Ubuntu 内核版本在受影响范围内，并且启用了 unprivileged user namespaces 和 unprivileged overlay mounts。漏洞库信息中给出了受影响的版本范围。
2.  **创建目录结构：** 创建 overlayfs 所需的目录结构，包括 lowerdir（底层目录）、upperdir（上层目录）、workdir（工作目录）和 mergedir（合并目录）。
3.  **创建用户命名空间：** 使用 `unshare` 命令创建一个新的用户命名空间，这允许在非特权用户下执行一些特权操作。
4.  **设置 UID/GID 映射：** 在用户命名空间中，将当前用户的 UID 和 GID 映射到 root 用户 (UID 0) 和 root 组 (GID 0)，这样在 overlayfs 中创建的文件将属于 root 用户。
5.  **挂载 OverlayFS：** 使用 `mount` 命令将 overlayfs 挂载到 mergedir，指定 lowerdir、upperdir 和 workdir。
6.  **复制并设置 Capabilities：** 将 exploit 程序自身复制到 mergedir 中，并使用 `setxattr` 命令设置其 security.capability 扩展属性，赋予其 CAP_SETUID 和 CAP_SETGID capabilities。这个capabilities允许程序在没有root权限的情况下设置uid和gid。
7.  **触发提权：** 运行 mergedir 中的 exploit 程序，由于已设置 capabilities，程序将以 root 权限运行，从而执行特权操作。

**代码分析：**

*   `exploit.c` 是利用代码，它创建必要的目录结构，建立用户命名空间，挂载 overlayfs，然后将自身复制到 overlayfs 中，并设置 capabilities。最后，执行复制到 upperdir 中的程序，该程序会将当前进程提权为 root。
*   代码中使用了 `setxattr` 函数来设置文件 capabilities，这是利用漏洞的关键步骤。
*   main函数首先fork一个子进程执行exploit函数，在exploit函数执行完毕后，父进程执行BIN_UPPER中的magic程序，如果带有shell参数，magic程序会设置uid和gid为0，并且运行一个bash shell。

**投毒风险分析：**

仔细检查了 POC 代码，没有发现明显的投毒代码。代码逻辑清晰，主要用于创建 overlayfs 环境并设置文件 capabilities 以进行提权。作者并没有尝试在代码中隐藏恶意行为，例如：

*   连接外部服务器
*   修改系统文件
*   安装后门
*   收集用户信息

因此，投毒风险较低 (0%)。

**项目地址:** [derek-turing/CVE-2021-3493](https://github.com/derek-turing/CVE-2021-3493)

**漏洞详情:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)