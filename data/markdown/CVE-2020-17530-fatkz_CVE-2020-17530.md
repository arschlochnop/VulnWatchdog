## CVE-2020-17530-Apache Struts2-OGNL注入

**漏洞编号:** CVE-2020-17530

**漏洞类型:** OGNL注入

**影响应用:** Apache Struts2

**危害等级:** 高危，可能导致远程代码执行

**影响版本:** Struts 2.0.0 - Struts 2.5.25

**利用条件:** 目标系统使用存在漏洞的Apache Struts2版本，且存在可POST的表单或可控的tag属性。

**POC 可用性:** 是

**投毒风险:** 1%

## 详情

CVE-2020-17530 是一个 Apache Struts2 的 OGNL 注入漏洞。攻击者可以通过构造恶意的 OGNL 表达式，当 Struts2 框架对用户输入（如 tag attributes）进行二次解析时，触发远程代码执行。

**有效性分析：**

根据漏洞信息、搜索结果以及提供的漏洞利用代码，可以判定该POC代码**有效**。漏洞库信息明确指出漏洞存在于 Apache Struts 2.0.0 - Struts 2.5.25 版本，搜索引擎结果也验证了该漏洞的存在和利用方式，POC代码则提供了一个可执行的利用示例。

**投毒风险分析：**

检查提供的 `exploit.py` 脚本，该脚本通过构造 OGNL payload 来执行命令。Payload 的主要逻辑是绕过 Struts2 的安全机制，获取 `InstanceManager`，并利用反射创建对象，调用 `Execute` 类执行命令。脚本结构清晰，主要功能是发送payload到目标URL，没有发现明显的恶意代码或者后门，但是仍然存在风险，即payload本身可以执行任意指令，可能被滥用。存在极小的风险，该风险来自于托管的服务器或者网络中间人篡改。
因此，投毒风险评估为 **1%**。

**利用方式分析：**

1.  **漏洞原理：** Struts2 框架在处理某些标签属性时，会对用户输入的 OGNL 表达式进行二次解析，导致攻击者可以通过构造恶意的 OGNL 表达式来执行任意代码。
2.  **利用步骤：**
    *   攻击者构造包含恶意 OGNL 表达式的 HTTP 请求，通常通过 POST 请求发送。
    *   恶意 OGNL 表达式被作为参数值传递给 Struts2 框架。
    *   Struts2 框架对该表达式进行二次解析，执行 OGNL 表达式中的命令。
3.  **POC 代码分析：** 提供的 `exploit.py` 脚本通过 POST 请求发送包含恶意 OGNL 表达式的 payload。Payload 的核心是使用 Tomcat 的 `InstanceManager` 创建对象，并使用反射调用 `freemarker.template.utility.Execute` 类的 `exec` 方法来执行命令。利用commons-collections的BeanMap的setBean和get方法来获取context和memberAccess进而设置excludedClasses和excludedPackageNames为空，绕过安全限制。最终达到执行任意命令的效果。

**项目地址:** [fatkz/CVE-2020-17530](https://github.com/fatkz/CVE-2020-17530)

**漏洞详情:** [CVE-2020-17530](https://nvd.nist.gov/vuln/detail/CVE-2020-17530)