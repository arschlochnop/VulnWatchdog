## CVE-2024-4577-PHP-CGI参数注入

**漏洞编号:** CVE-2024-4577

**漏洞类型:** PHP-CGI参数注入

**影响应用:** PHP

**危害等级:** 高危，可能导致远程代码执行、源码泄露

**影响版本:** PHP 8.1.x < 8.1.29, 8.2.x < 8.2.20, 8.3.x < 8.3.8（Windows环境，CGI模式，开启Best Fit策略的CodePage）

**利用条件:** Windows系统，PHP以CGI模式运行，启用了使用"Best Fit"策略的CodePage。目标服务器未安装补丁。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-4577是一个PHP CGI参数注入漏洞，存在于PHP的Windows版本中，当PHP以CGI模式运行时，如果系统设置为使用某些代码页，Windows可能会使用“Best-Fit”行为来替换传递给Win32 API函数的命令行参数中的字符。PHP CGI模块可能会将这些字符错误地解释为PHP选项，从而允许恶意用户将选项传递给正在运行的PHP二进制文件，进而泄露脚本的源代码，或者在服务器上执行任意PHP代码。

**有效性：**
根据漏洞描述和搜索结果，该漏洞影响特定版本的PHP，并且有公开的PoC代码，证明该漏洞是有效的。多个安全厂商和研究人员已经确认了该漏洞的存在并发布了相关的分析和利用方法。

**投毒风险：**
提供的CTF_WALKTHROUGH.md文件本身是漏洞利用的教程，其中包含的攻击脚本用于测试、文件读取、命令执行、容器逃逸、AWS权限提升以及持久化等攻击步骤。这些脚本可以被用于恶意目的，但教程本身是中立的，风险点在于用户是否清楚脚本的功能，是否存在其他关联的，具有恶意目的的脚本或配置，因此投毒风险为10%。因为没有发现明显的恶意代码，所以投毒风险较低。

**利用方式：**
1.  **漏洞触发：** 攻击者通过构造恶意的HTTP请求，在URL的`PATH_INFO`部分注入特殊字符（如`%0a`，换行符），使得PHP CGI在解析命令行参数时出现错误。
2.  **参数注入：** 注入的换行符将URL分割成多个参数，攻击者可以利用此特性注入PHP的命令行选项，例如`-d`选项用于设置PHP配置指令。
3.  **执行任意代码/读取文件：** 攻击者可以设置`allow_url_include=1`以允许包含远程文件，然后设置`auto_prepend_file`或者`auto_append_file`为包含恶意PHP代码的文件或者`/flag.txt`等敏感文件，从而执行任意PHP代码或者读取文件。
4.  **其他攻击：** 进一步的，攻击者可以尝试容器逃逸，访问AWS资源，甚至创建后门实现持久化控制。

**项目地址:** [a1ex-var1amov/ctf-cve-2024-4577](https://github.com/a1ex-var1amov/ctf-cve-2024-4577)

**漏洞详情:** [CVE-2024-4577](https://nvd.nist.gov/vuln/detail/CVE-2024-4577)