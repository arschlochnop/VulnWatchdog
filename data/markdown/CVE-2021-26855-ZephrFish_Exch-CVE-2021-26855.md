## CVE-2021-26855 - Microsoft Exchange Server SSRF to RCE (ProxyLogon)

**漏洞编号:** CVE-2021-26855

**漏洞类型:** SSRF (Server-Side Request Forgery) -> RCE (Remote Code Execution)

**影响应用:** Microsoft Exchange Server

**危害等级:** 高危，允许未经身份验证的远程攻击者执行任意代码

**影响版本:** Microsoft Exchange Server 2013 Cumulative Update 21, 2013 Cumulative Update 22, 2013 Cumulative Update 23, 2016 Cumulative Update 8, 2016 Cumulative Update 9, 2016 Cumulative Update 10, 2016 Cumulative Update 11, 2016 Cumulative Update 12, 2016 Cumulative Update 13, 2016 Cumulative Update 14, 2016 Cumulative Update 15, 2016 Cumulative Update 16, 2016 Cumulative Update 17, 2016 Cumulative Update 18, 2016 Cumulative Update 19, 2019 Cumulative Update 1, 2019 Cumulative Update 2, 2019 Cumulative Update 3, 2019 Cumulative Update 4, 2019 Cumulative Update 5, 2019 Cumulative Update 6, 2019 Cumulative Update 7, 2019 Cumulative Update 8

**利用条件:** 需要目标Exchange服务器可以从攻击者控制的网络访问。

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2021-26855 存在于 Microsoft Exchange Server 中，是一个服务器端请求伪造 (SSRF) 漏洞，属于 ProxyLogon 漏洞链的一部分。未经身份验证的远程攻击者可以通过发送特制的 HTTP 请求利用此漏洞。

**利用方式：**

1.  **SSRF：** 攻击者利用SSRF漏洞，通过构造恶意的 HTTP 请求，绕过身份验证。
2.  **获取 LegacyDN：** 利用 SSRF 漏洞，向 Exchange 服务器的 autodiscover 端点发送请求，获取目标用户的 LegacyDN。
3.  **MAPI 连接：** 使用获得的 LegacyDN 建立 MAPI 连接。
4.  **获取 SID：** 从 MAPI 响应中提取用户的 SID。
5.  **ProxyLogon：** 利用 SID 伪造身份，通过 proxyLogon.ecp 端点进行身份验证绕过。
6.  **写入 Webshell：** 成功绕过身份验证后，攻击者可以将恶意的 webshell 写入到 Exchange 服务器的 OWA 目录中。
7.  **远程代码执行：** 攻击者通过访问写入的 webshell，执行任意代码。

**有效性评估：**

提供的 POC 代码 `ExchangeSheller.py` 实现了上述利用流程，能够自动化利用 CVE-2021-26855 漏洞，因此是有效的。

**投毒风险分析：**

代码本身执行的是漏洞利用流程，主要功能为利用 SSRF 漏洞并最终写入 Webshell。但需要注意以下几点：

*   **代码来源：** 代码来自 GitHub，需要验证其作者的信誉和代码的完整性。
*   **Webshell 内容：** Webshell 的内容可控，攻击者可以修改 webshell 的内容，使其执行恶意操作，如植入后门、窃取数据等。
*   **隐藏指令：** 理论上，eval 函数中可以嵌入隐蔽的恶意代码，但这需要仔细分析 `ExchangeSheller.py` 文件，当前判断该风险较低。

**结论：**

该漏洞利用的有效性高。存在一定的投毒风险，主要体现在攻击者可能会修改webshell的内容，但总体来说代码的结构和逻辑清晰，投毒风险较低，估计在5%。务必在隔离环境下进行测试，并对生成的 webshell 进行安全审计。

**项目地址:** [ZephrFish/Exch-CVE-2021-26855](https://github.com/ZephrFish/Exch-CVE-2021-26855)

**漏洞详情:** [CVE-2021-26855](https://nvd.nist.gov/vuln/detail/CVE-2021-26855)