## CVE-2022-22947 - Spring Cloud Gateway 代码注入

**漏洞编号:** CVE-2022-22947

**漏洞类型:** 代码注入

**影响应用:** Spring Cloud Gateway

**危害等级:** 高危，可导致远程代码执行

**影响版本:** Spring Cloud Gateway 3.1.x < 3.1.1+, 3.0.x < 3.0.7+

**利用条件:** Gateway Actuator endpoint 启用、暴露且未做安全保护

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2022-22947 存在于 Spring Cloud Gateway 中，当 Actuator 端点启用且未授权时，攻击者可以通过构造恶意的 SpEL 表达式，利用`Path`路由断言中的 SpEL 注入漏洞执行任意代码。提供的 POC 代码旨在通过动态定义Java类的方式注入哥斯拉内存马。 

**有效性：**
根据漏洞库信息和搜索结果，该漏洞已被证实存在，且有在野利用。提供的 POC 代码实现了利用该漏洞注入哥斯拉内存马，因此该 POC 有效。

**投毒风险分析：**
分析给出的POC代码，主要功能是利用漏洞注入哥斯拉内存马，实现远程代码执行。虽然POC本身是为了利用漏洞，但如果用户直接使用此POC而不了解其行为，可能会被利用来植入恶意后门。

*   代码主要功能：该代码使用Go语言编写，利用 Spring Cloud Gateway 的 SpEL 表达式注入漏洞。它构造一个包含恶意 SpEL 表达式的请求，该表达式用于在目标服务器上动态定义一个 Java 类（哥斯拉内存马），从而实现远程代码执行。
*   投毒可能性：
    *   **高：** 代码直接注入内存马，如果目标系统部署了恶意程序，攻击者也可以构造其他的恶意代码注入到内存中，比如替换关键组件、窃取数据等。
    *   **低：** 由于代码的目的是利用漏洞注入内存马，从这个角度看，本身就是一种攻击行为，很难区分是“正常”利用还是“投毒”。因此，认为该仓库存在一定投毒风险，风险等级较低。

基于以上分析，判定投毒风险为10%。

**利用方式：**
1.  **前提条件：** 目标 Spring Cloud Gateway 实例启用了 Actuator 端点，且未进行安全保护（例如，未进行身份验证）。
2.  **构造恶意请求：** 攻击者构造一个包含恶意 SpEL 表达式的 HTTP POST 请求，该表达式利用 `T(org.springframework.cglib.core.ReflectUtils).defineClass` 动态定义一个 Java 类（通常是一个 Webshell 或内存马）。
3.  **利用 Path 路由断言：**  该恶意 SpEL 表达式被嵌入到 Spring Cloud Gateway 的 `Path` 路由断言的参数中。
4.  **发送请求：** 将构造的恶意请求发送到 `/actuator/gateway/routes` 端点。
5.  **代码执行：** Spring Cloud Gateway 在处理路由断言时，会解析并执行 SpEL 表达式，从而在目标服务器上执行攻击者注入的恶意代码。
6.  **内存马驻留：** 注入的哥斯拉内存马会驻留在服务器内存中，允许攻击者通过特定的 HTTP 请求与服务器交互，执行任意命令或上传文件。

**项目地址:** [Zh0um1/CVE-2022-22947](https://github.com/Zh0um1/CVE-2022-22947)

**漏洞详情:** [CVE-2022-22947](https://nvd.nist.gov/vuln/detail/CVE-2022-22947)