## CVE-2022-24112-Apache APISIX-RCE

**漏洞编号:** CVE-2022-24112

**漏洞类型:** 远程代码执行

**影响应用:** Apache APISIX

**危害等级:** 高危，可能导致服务器完全控制

**影响版本:** < 2.12.1, < 2.10.4, 1.3

**利用条件:** 需要开启batch-requests插件，默认API Key或者未修改的管理API端口

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

该漏洞存在于Apache APISIX的batch-requests插件中，攻击者可以通过构造特殊的请求，绕过Admin API的IP限制，如果使用默认API Key，则可以直接利用Admin API执行任意命令。POC代码提供了两种利用方式：poc.py和poc2.py，都可以实现远程代码执行并获取反弹shell。

**有效性：**

根据漏洞库信息和搜索引擎结果，该漏洞是真实存在的，并且有公开的POC代码。提供的POC代码中，两个脚本（poc.py和poc2.py）都提供了RCE的利用方式，并有成功获取反弹shell的示例。因此，提供的POC代码是有效的。

**投毒风险：**

代码仓库包含Dockerfile，docker-compose.yml等文件，相对完整，模拟复现步骤，更容易让使用者运行，存在一定风险，考虑到代码仓库中的poc.py和poc2.py主要功能为漏洞利用，本身不包含恶意功能，投毒风险较低。

*   **README.md**: 描述了如何使用Docker Compose搭建存在漏洞的APISIX环境，以及如何使用提供的POC脚本进行漏洞利用，属于正常的漏洞利用说明文档。
*   **poc.py & poc2.py**: 这两个脚本是漏洞利用的核心，用于发送恶意请求并执行命令。从代码分析来看，主要功能是构造payload，利用漏洞获取shell，没有发现额外恶意代码，但使用者通过修改命令，可以植入后门。  

综合分析，仓库存在微小投毒风险的可能性，主要是使用者可能会被引导执行恶意命令。所以判定投毒风险为10%。

**利用方式：**

1.  **环境搭建：** 首先需要搭建一个存在漏洞的Apache APISIX环境，版本低于2.12.1，且开启了batch-requests插件。可以使用提供的docker-compose.yml快速搭建。
2.  **漏洞触发：** 利用batch-requests插件的缺陷，通过构造包含`X-REAL-IP` header的恶意请求，绕过Admin API的IP限制。
3.  **代码执行：** 绕过IP限制后，如果Admin API使用了默认的API Key，或者攻击者已知有效的API Key，就可以通过Admin API创建路由或执行其他管理操作，从而执行任意命令。
4.  **反弹Shell：** POC代码中通常会利用命令执行功能反弹一个shell到攻击者的机器上，从而获取对服务器的控制权。

**总结：**

CVE-2022-24112是一个高危漏洞，利用门槛较低，且存在公开的POC代码。攻击者可以利用该漏洞绕过IP限制，执行任意命令，从而完全控制服务器。建议受影响的用户尽快升级到安全版本，或者禁用batch-requests插件。

**项目地址:** [twseptian/cve-2022-24112](https://github.com/twseptian/cve-2022-24112)

**漏洞详情:** [CVE-2022-24112](https://nvd.nist.gov/vuln/detail/CVE-2022-24112)