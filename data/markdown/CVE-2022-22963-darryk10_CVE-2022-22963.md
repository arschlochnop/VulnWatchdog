## CVE-2022-22963 - Spring Cloud Function SpEL 远程代码执行

**漏洞编号:** CVE-2022-22963

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Spring Cloud Function

**危害等级:** 高危，无需身份验证即可远程执行代码，完全控制服务器

**影响版本:** Spring Cloud Function 3.1.6, 3.2.2 及所有旧版本

**利用条件:** 目标应用程序使用了 Spring Cloud Function 并且开启了路由功能，对外暴露了 `/functionRouter` 端点

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2022-22963 是 Spring Cloud Function 中的一个远程代码执行漏洞。当使用路由功能时，攻击者可以提供特制的 SpEL 表达式作为路由表达式，导致远程代码执行。根据漏洞描述和提供的POC代码，攻击者通过向 `/functionRouter` 端点发送POST请求，并在 `spring.cloud.function.routing-expression` 头中注入恶意的SpEL表达式来实现远程代码执行。

**有效性分析：**
提供的Dockerfile文件构建了一个包含漏洞版本的Spring Cloud Function应用。README.md中给出的curl命令可以直接利用该漏洞，验证了其有效性。该命令通过设置`spring.cloud.function.routing-expression`头来注入SpEL表达式，执行`touch /tmp/test`命令，成功后会在目标服务器上创建/tmp/test文件。

**投毒风险分析：**
虽然POC本身旨在展示漏洞利用，但仔细分析Dockerfile和利用代码，投毒的风险较低。Dockerfile主要用于构建易受攻击的应用程序，其中没有发现任何恶意代码。攻击代码仅通过SpEL表达式注入命令，并且该命令是标准shell命令。存在的少量风险可能来自以下几个方面：
1.  镜像作者可能在基础镜像（`FROM ubuntu`）中植入恶意代码（风险极低）。
2.  Maven构建过程中，某些依赖项可能包含恶意代码(通过mvn package自动下载的依赖，该场景风险较低).
3. 配置文件中存在恶意后门webshell（未提供配置文件，此处风险为0）。
因此,综合考虑，投毒风险评估为 **5%**。

**利用方式：**
1.  攻击者向目标应用程序的 `/functionRouter` 端点发送POST请求。
2.  在请求头中设置 `spring.cloud.function.routing-expression`，并注入包含恶意代码的SpEL表达式。
3.  服务器解析SpEL表达式，执行攻击者注入的恶意代码，实现远程代码执行。
4.  攻击者可以执行任意系统命令，例如创建文件、反弹shell等，从而完全控制服务器。

**项目地址:** [darryk10/CVE-2022-22963](https://github.com/darryk10/CVE-2022-22963)

**漏洞详情:** [CVE-2022-22963](https://nvd.nist.gov/vuln/detail/CVE-2022-22963)