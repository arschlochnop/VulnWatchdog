## CVE-2017-12629 - Apache Solr XXE/RCE

**漏洞编号:** CVE-2017-12629

**漏洞类型:** XML 外部实体注入 (XXE) / 远程代码执行 (RCE)

**影响应用:** Apache Solr

**危害等级:** 高危，可能导致敏感信息泄露和远程代码执行

**影响版本:** < 7.1

**利用条件:** 目标系统运行受影响版本的Apache Solr，并且可以访问Config API和XML Query Parser。

**POC 可用性:** 是

**投毒风险:** 1%

## 详情

该漏洞存在于Apache Solr 7.1之前的版本中。攻击者可以利用XML外部实体注入(XXE)漏洞，结合Config API的add-listener命令，触发RunExecutableListener类，从而实现远程代码执行。

**利用方式：**

1.  **XXE 注入：** 漏洞利用首先通过 XML 外部实体注入，利用 Solr 的 XML Query Parser (deftype=xmlparser)。
2.  **创建 Collection (SSRF)：** 使用 XXE，利用受害服务器向其自身发送请求，创建一个新的 collection。由于使用了未经身份验证的 URL，这实际上是一个服务器端请求伪造 (SSRF)。
3.  **添加 RunExecutableListener：** 再次利用 XXE 和 SSRF，向新创建的 collection 的 config API 添加一个新的监听器 `RunExecutableListener`。这个监听器允许在特定事件（例如 `postCommit`）发生时执行任意命令。
4.  **触发监听器：** 通过更新 collection 来触发 `RunExecutableListener`，从而执行攻击者指定的命令。
5. **数据外泄:** POC通过curl/wget/ftp等方式将命令执行结果外泄到攻击者指定的服务器.

**关于投毒风险：**

该POC中主要利用XXE执行远程命令，将命令执行结果外泄。该代码本身的功能是利用漏洞，没有发现明显的恶意代码（例如持续性的后门植入）。
文件`/tmp/0a170f3f8e91aa521c08fbc1d484659b/rce.py`主要是完成漏洞利用, README.md 主要是介绍漏洞原理和使用方法.

考虑到代码需要使用者自行配置外联URL，并在目标执行命令，存在一定风险，比如攻击者可能会利用该POC攻击目标系统，进行恶意操作。但是，从代码本身来看，其主要目的是验证漏洞，而非植入恶意后门。

因此，评估投毒风险较低，大约为1%。

**项目地址:** [captain-woof/cve-2017-12629](https://github.com/captain-woof/cve-2017-12629)

**漏洞详情:** [CVE-2017-12629](https://nvd.nist.gov/vuln/detail/CVE-2017-12629)