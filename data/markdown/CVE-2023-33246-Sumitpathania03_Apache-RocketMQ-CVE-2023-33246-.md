## CVE-2023-33246 Apache RocketMQ 远程代码执行

**漏洞编号:** CVE-2023-33246

**漏洞类型:** 远程代码执行

**影响应用:** Apache RocketMQ

**危害等级:** 高危，允许未经身份验证的攻击者执行任意命令。

**影响版本:** <= 5.1.0

**利用条件:** RocketMQ的NameServer、Broker或Controller组件暴露在公网，且未进行权限验证。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2023-33246 存在于 Apache RocketMQ 5.1.0 及以下版本中。由于多个组件（包括 NameServer、Broker 和 Controller）暴露在外部网络且缺乏权限验证，攻击者可以通过更新配置功能以运行 RocketMQ 的系统用户身份执行命令。或者，攻击者可以通过伪造 RocketMQ 协议内容达到相同的效果。

**有效性：**

提供的 POC 代码 `CVE-2023-33246_RocketMQ_RCE_EXPLOIT.py` 看起来是有效的。从 `README.md` 文件中可以看到使用示例和相关截图，证明其可以利用该漏洞执行任意命令。代码通过构造特定的请求数据包，利用 `UpdateBrokerConfig()` 函数执行命令。

**投毒风险：**

虽然 POC 代码的主要功能是利用漏洞执行命令，但仍然存在一定的投毒风险。分析代码发现，它使用了一个固定的 payload 前缀和后缀，中间拼接用户提供的命令。理论上，作者可以在 payload 的前缀或后缀中添加恶意代码，例如下载并执行恶意脚本，或者修改系统文件等。虽然这种风险较低，但仍然需要注意。

从代码逻辑和仓库内容来看，投毒风险评估为 10%。 风险主要来自以下几个方面：

*   代码中存在硬编码的 payload 部分，攻击者可能在这些部分植入恶意代码。
*   虽然 POC 主要功能是执行命令，但其行为仍然可能被滥用，用于进行恶意活动。

**利用方式：**

1.  **漏洞定位：** 漏洞位于 RocketMQ 的配置更新功能中，具体是 `UpdateBrokerConfig()` 函数。
2.  **攻击条件：** 需要 RocketMQ 的 NameServer、Broker 或 Controller 组件暴露在公网上，且未配置适当的权限验证。
3.  **攻击步骤：**
    a.  构造恶意的请求数据包，设置请求代码为 '25'，触发 `UpdateBrokerConfig()` 函数。
    b.  在请求数据包中包含要执行的命令，利用 `rocketmqHome` 配置项或其他可利用的配置项执行命令。
    c.  发送数据包到目标 RocketMQ 组件。
4.  **利用结果：** 成功利用漏洞后，攻击者可以以 RocketMQ 进程运行的用户身份执行任意系统命令。

**缓解措施：**

*   升级到 RocketMQ 5.1.1 或更高版本，或者 RocketMQ 4.9.6 或更高版本。
*   对 RocketMQ 组件进行适当的权限验证，避免未经授权的访问。
*   限制 RocketMQ 组件的网络暴露，避免直接暴露在公网上。
*   监控 RocketMQ 服务的异常行为，及时发现并响应潜在的攻击。

**项目地址:** [Sumitpathania03/Apache-RocketMQ-CVE-2023-33246-](https://github.com/Sumitpathania03/Apache-RocketMQ-CVE-2023-33246-)

**漏洞详情:** [CVE-2023-33246](https://nvd.nist.gov/vuln/detail/CVE-2023-33246)