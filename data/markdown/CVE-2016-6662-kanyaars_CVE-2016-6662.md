## CVE-2016-6662 - MySQL 本地权限提升/远程代码执行

**漏洞编号:** CVE-2016-6662

**漏洞类型:** 权限提升/远程代码执行

**影响应用:** MySQL, MariaDB, Percona Server

**危害等级:** 高危，可能导致完全系统控制

**影响版本:** MySQL <= 5.5.52, 5.6.x <= 5.6.33, 5.7.x <= 5.7.15; MariaDB < 5.5.51, 10.0.x < 10.0.27, 10.1.x < 10.1.17; Percona Server < 5.5.51-38.1, 5.6.x < 5.6.32-78.0, 5.7.x < 5.7.14-7

**利用条件:** 本地用户或具有FILE权限的远程用户

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2016-6662 允许本地用户（或具有FILE权限的远程用户）通过设置 `general_log_file` 到 `my.cnf` 配置来创建任意配置和绕过某些保护机制。更严重的是，这可以被利用通过设置 `malloc_lib` 来执行具有 root 权限的任意代码。

**利用方式：**

1.  **写入恶意配置：** 攻击者利用数据库的FILE权限，将`general_log_file`指向一个攻击者可控的文件。这个文件会被解析为MySQL的配置文件。
2.  **设置malloc_lib：** 在该配置文件中，攻击者设置`malloc_lib`指向一个恶意的动态链接库（.so文件）。
3.  **重启MySQL服务：** 当MySQL服务重启时，会加载`malloc_lib`指定的恶意动态链接库，从而执行攻击者预设的恶意代码，获得服务器的root权限。

**POC分析：**
提供的POC代码包含两个文件：一个C语言编写的动态链接库 (`911KanyaLab_lib.c`) 和一个 Python 脚本 (`Exploit_Old_MySQL_Kay_ver.py`)。

*   **`911KanyaLab_lib.c`：** 这个C代码会被编译成`.so`文件。它定义了一个`execvp` hook函数，用于在MySQL启动时执行恶意代码。恶意代码的功能是创建一个反向Shell，连接到攻击者的IP地址和端口。
*   **`Exploit_Old_MySQL_Kay_ver.py`：** 这个Python脚本负责连接到目标MySQL服务器，上传并配置恶意的`.so`文件，并触发MySQL重启。

**投毒风险分析：**
代码主要逻辑是创建反向shell，连接攻击者的机器。存在投毒的可能。分析得出存在以下潜在的投毒风险:
*   C代码中IP地址和端口是硬编码的，如果攻击者篡改这些值，可能会将shell连接到其他恶意服务器。但是从代码逻辑来判断是为了完成漏洞验证的必要后门代码。
*   Python脚本需要指定MySQL用户名、密码、数据库名和`my.cnf`路径，这些信息可能被记录或泄露。
*   `config_cleanup()`函数的功能是清除注入的配置，但如果实现不正确，可能留下痕迹。

整体代码质量不高，存在一些硬编码，但主要功能符合漏洞描述，总体上是可信的。 但是依然存在作者隐藏的投毒代码的可能，但是可能性较低。

**项目地址:** [kanyaars/CVE-2016-6662](https://github.com/kanyaars/CVE-2016-6662)

**漏洞详情:** [CVE-2016-6662](https://nvd.nist.gov/vuln/detail/CVE-2016-6662)