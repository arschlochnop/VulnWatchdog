## CVE-2024-4577 PHP CGI Remote Code Execution

**漏洞编号:** CVE-2024-4577

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** PHP (Windows CGI)

**危害等级:** 高危，可导致完全控制受影响服务器

**影响版本:** PHP 8.1.* (< 8.1.29), 8.2.* (< 8.2.20), 8.3.* (< 8.3.8)

**利用条件:** 运行在Windows上的PHP，以CGI模式运行，系统启用了使用 "Best Fit" 策略的代码页。

**POC 可用性:** 是

**投毒风险:** 1%

## 详情

CVE-2024-4577 是一个存在于 PHP（特别是基于 Windows 的 PHP，以 CGI 模式使用时）中的操作系统命令注入漏洞。当 PHP 在 CGI 模式下使用时，由于字符编码转换处理不当而导致。Windows 系统可能使用 "Best-Fit" 行为来替换传递给 Win32 API 函数的命令行中的字符。PHP CGI 模块可能会错误地将这些字符解释为 PHP 选项，从而允许恶意用户将选项传递给正在运行的 PHP 二进制文件，进而泄露脚本源代码、在服务器上运行任意 PHP 代码等。

**有效性：**

根据漏洞库信息和搜索引擎结果，该漏洞的PoC已经公开，并且在野外被积极利用。提供的漏洞利用代码看起来是一个针对该漏洞的C语言实现，包含了构建说明和使用示例，因此PoC有效。

**投毒风险：**

分析提供的C代码，主要功能是利用curl发送HTTP请求，其中请求的URL和执行的命令通过命令行参数传递。代码包含日志记录功能，记录攻击活动。检查代码，没有发现明显的恶意行为，例如反向shell以外的持久化后门，或者未经授权的数据传输。但不能完全排除隐蔽的投毒行为，例如在日志记录中插入恶意代码的可能性（虽然可能性极低）。考虑到作者声明和代码功能，投毒风险较低，估计为1%。

**利用方式：**

1.  **环境准备：** 目标服务器需要是运行在Windows上的PHP，并且以CGI模式运行。
2.  **代码编译：** 使用提供的编译命令，使用gcc或其他兼容的C编译器编译`exploit.c`和`argparse.c`。
3.  **漏洞利用：** 运行编译后的可执行文件，并指定目标URL和要执行的命令。例如：`CVE-2024-4577.exe -u http://target/cgi-bin/php-cgi.exe "system(whoami)"`。
4.  **代码分析:**
    * 漏洞利用代码利用了PHP在CGI模式下，由于对命令行参数处理不当，导致攻击者可以通过构造特殊的URL来执行任意系统命令。
    * 该利用通过curl库发起HTTP POST请求，在请求中构造恶意的PHP选项参数，导致PHP执行指定的命令。
    * argparse.c 文件是为了解析命令行的参数
    * reverse shell 也可以通过命令执行后门获得
    * 攻击的关键在于目标服务器启用了使用 "Best Fit" 策略的代码页，允许某些字符被替换为其他字符，从而绕过PHP的参数过滤。


**项目地址:** [byteReaper77/CVE-2024-4577](https://github.com/byteReaper77/CVE-2024-4577)

**漏洞详情:** [CVE-2024-4577](https://nvd.nist.gov/vuln/detail/CVE-2024-4577)