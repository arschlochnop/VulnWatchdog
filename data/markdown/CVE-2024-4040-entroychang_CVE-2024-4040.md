## CVE-2024-4040-CrushFTP-服务器端模板注入

**漏洞编号:** CVE-2024-4040

**漏洞类型:** 服务器端模板注入 (SSTI)

**影响应用:** CrushFTP

**危害等级:** 极高危，可能导致任意文件读取、认证绕过和远程代码执行

**影响版本:** 10.0 <= version < 10.7.1, 11.0 <= version < 11.1.0

**利用条件:** 目标 CrushFTP 服务版本在受影响范围内，且攻击者可发起网络请求。

**POC 可用性:** 是

**投毒风险:** 80%

## 详情

CVE-2024-4040是CrushFTP中的一个严重的服务器端模板注入漏洞。未经验证的远程攻击者可以利用此漏洞读取文件系统中的文件（绕过VFS沙箱），绕过身份验证以获得管理权限，并在服务器上执行远程代码。

**有效性分析：**

根据提供的漏洞信息和搜索结果，该漏洞已被广泛报道并被积极利用。CISA已将其添加到已知被利用的漏洞目录中。提供的漏洞利用代码 `NonRegisteringDriver.java` 尝试模拟一个 JDBC 驱动，但实际上，它并没有进行数据库连接，而是利用 `user` 属性的值（经过Base64解码后）作为操作系统命令执行。这表明该PoC专注于远程代码执行，而非传统的数据库利用。

**投毒风险分析：**

提供的代码存在很高的投毒风险 (80%)。攻击者可能通过以下方式进行投毒：

1.  **非预期代码执行：** 该代码的核心功能是将Base64编码的用户名字段作为命令执行。如果攻击者可以控制提供给 CrushFTP 的配置，他们就可以通过这个“JDBC 驱动”执行任意系统命令。
2.  **依赖注入：** 攻击者可能通过篡改或替换 `NonRegisteringDriver.java` 文件，在其中添加恶意代码，例如反向 shell 或数据窃取程序。
3.  **供应链攻击：** 如果该代码被包含在第三方库或模块中，攻击者可以通过更新这些库或模块来传播恶意代码。
4.  **后门：** 该代码本身就有可能被用作后门，允许攻击者在目标系统上保持持久存在。

该代码的目的是利用 JDBC 驱动加载机制，将恶意的 Java 代码注入到 CrushFTP 服务器中，从而实现远程代码执行，窃取敏感信息，或者植入后门。

**利用方式：**

1.  **构造恶意请求：** 攻击者构造包含恶意模板注入的 HTTP 请求，触发 CrushFTP 服务器处理恶意模板。
2.  **利用 SSTI 执行代码：** 恶意模板利用服务器端模板引擎的漏洞执行任意代码，例如，读取文件、执行系统命令。
3.  **上传恶意 JDBC 驱动：** 攻击者上传包含恶意代码的 JDBC 驱动程序（如提供的 `NonRegisteringDriver.java`），并配置 CrushFTP 使用该驱动程序。
4.  **触发恶意驱动加载：** 当 CrushFTP 尝试连接数据库时，会加载并执行恶意 JDBC 驱动程序中的代码。
5.  **远程代码执行：** 恶意驱动程序中的代码被执行，攻击者从而控制 CrushFTP 服务器。

**项目地址:** [entroychang/CVE-2024-4040](https://github.com/entroychang/CVE-2024-4040)

**漏洞详情:** [CVE-2024-4040](https://nvd.nist.gov/vuln/detail/CVE-2024-4040)