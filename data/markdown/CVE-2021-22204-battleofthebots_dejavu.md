## CVE-2021-22204 ExifTool DjVu 远程代码执行

**漏洞编号:** CVE-2021-22204

**漏洞类型:** 远程代码执行

**影响应用:** ExifTool

**危害等级:** 高危，可导致服务器被完全控制

**影响版本:** >=7.44, <12.24

**利用条件:** 目标系统安装了存在漏洞版本的ExifTool，攻击者需要能够上传或使目标系统处理恶意的DjVu文件。

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2021-22204 漏洞存在于 ExifTool 的 DjVu 文件解析模块中。该漏洞是由于对 DjVu 文件中的用户数据未进行充分的净化处理，导致在解析恶意图像时可能执行任意代码，攻击者可以通过构造恶意的DjVu文件，将恶意代码注入到ANTa 或 ANtz chunk中, 从而实现远程代码执行。

**有效性：**
根据漏洞信息和漏洞利用代码，该漏洞是有效的。漏洞库信息表明存在一个代码注入漏洞，漏洞利用代码 `DjVu.pm` 表明，通过修改 DjVu 文件的特定区域，例如注释块 (ANTa 或 ANtz)，可以注入恶意代码。当 ExifTool 处理这个被篡改的文件时，就会触发代码执行。

**投毒风险：**
提供的代码片段 `DjVu.pm` 看起来是 ExifTool 中 DjVu 模块的修改版本。虽然无法从这一个文件片段确定最终影响和攻击效果，但是**直接**查看此仓库的代码片段本身，无法判断仓库作者是否存在隐藏的恶意代码以达到投毒的目的，因此，当前判断投毒的可能性为0%。但是，使用者依然需要仔细检查完整代码，以及进一步验证此利用的安全性。尤其需要注意`ProcessAnt` 和 `ProcessMeta` 函数，因为这些函数负责处理 DjVu 注释数据。此外需要关注整个利用过程，特别是恶意文件上传等环节，需要严格过滤和验证。

**利用方式：**
1.  **构造恶意DjVu文件：** 攻击者首先需要创建一个恶意的DjVu文件。这个文件需要包含被篡改的ANTa或ANTz chunk，其中包含恶意代码，这些代码会被 ExifTool 的 DjVu 解析模块执行。
2.  **上传或使目标系统处理恶意文件：** 攻击者需要找到一种方法，让目标系统使用存在漏洞的 ExifTool 版本来处理这个恶意 DjVu 文件。这可能涉及到文件上传功能（如在 GitLab 的场景中），或者通过其他方式将文件提供给 ExifTool 进行处理。
3.  **触发代码执行：** 当 ExifTool 解析恶意 DjVu 文件时，ANTa或ANTz chunk中的恶意代码会被执行，从而导致远程代码执行。攻击者可以利用这个漏洞执行任意系统命令，例如安装后门、窃取敏感信息等。

**项目地址:** [battleofthebots/dejavu](https://github.com/battleofthebots/dejavu)

**漏洞详情:** [CVE-2021-22204](https://nvd.nist.gov/vuln/detail/CVE-2021-22204)