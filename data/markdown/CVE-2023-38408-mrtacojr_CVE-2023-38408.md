## CVE-2023-38408-OpenSSH-远程代码执行

**漏洞编号:** CVE-2023-38408

**漏洞类型:** 远程代码执行

**影响应用:** OpenSSH

**危害等级:** 高危，可能导致远程代码执行

**影响版本:** < 9.3p2

**利用条件:** 需要开启ssh-agent forwarding，且连接到受攻击者控制的系统。

**POC 可用性:** 是

**投毒风险:** 80%

## 详情

CVE-2023-38408 是 OpenSSH 9.3p2 之前版本中 ssh-agent 的 PKCS#11 功能中存在的一个漏洞，由于搜索路径不安全，导致远程代码执行。如果 ssh-agent 被转发到受攻击者控制的系统，攻击者可以利用该漏洞执行任意代码。

**有效性：** 根据漏洞描述和搜索结果，该漏洞真实存在且影响OpenSSH 9.3p2之前的版本。虽然提供的POC不是直接的exp，但其功能为重新编译安装OpenSSH，如果攻击者在编译过程中注入恶意代码，则可能达到远程代码执行的目的。因此，从间接角度来看，此POC具有一定的有效性，可以作为漏洞利用的一部分。

**投毒风险：** POC代码的主要功能是下载、编译和安装OpenSSH。以下是对投毒风险的分析：
*   **下载源文件：** 从`https://launchpad.net/ubuntu/+archive/primary/+sourcefiles/openssh/1:9.6p1-3ubuntu13.4/openssh_9.6p1.orig.tar.gz` 下载 OpenSSH 9.6p1 版本的源代码。理论上，这应该是一个可信的来源，但是攻击者可能篡改下载链接，指向包含后门的恶意代码。
*   **编译过程：** 在 `./configure` 和 `make` 步骤中，攻击者可以注入恶意代码。例如，修改Makefile以插入恶意指令，或者修改源代码本身。这是最主要的投毒风险点。
*   **systemd 服务文件：** 脚本创建了一个systemd服务文件。虽然文件本身看起来无害，但攻击者可以在`ExecStart`指令中插入恶意命令，在sshd启动时执行。

综合以上分析，此脚本存在很高的投毒风险。如果攻击者控制了脚本的执行，可以在多个环节注入恶意代码。因此，投毒风险估计为80%。

**利用方式：**
1.  **攻击者控制的服务器：** 攻击者需要搭建一个可以控制的服务器。
2.  **诱导连接：** 诱导用户使用开启agent forwarding的SSH客户端连接到该服务器（`ssh -A user@attacker.com`）。
3.  **篡改环境：** 攻击者在受害者连接的服务器上，通过篡改`LD_LIBRARY_PATH`或其它环境变量，劫持ssh-agent加载恶意PKCS#11模块。
4.  **远程代码执行：**  当ssh-agent尝试加载恶意模块时，执行攻击者预先设定的恶意代码。

**项目地址:** [mrtacojr/CVE-2023-38408](https://github.com/mrtacojr/CVE-2023-38408)

**漏洞详情:** [CVE-2023-38408](https://nvd.nist.gov/vuln/detail/CVE-2023-38408)