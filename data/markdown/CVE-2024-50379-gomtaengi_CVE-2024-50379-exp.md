## CVE-2024-50379 - Apache Tomcat TOCTOU 竞争条件 RCE

**漏洞编号:** CVE-2024-50379

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Apache Tomcat

**危害等级:** 高危，允许未经身份验证的攻击者执行任意代码。

**影响版本:** 9.0.0.M1 - 9.0.97, 10.1.0-M1 - 10.1.33, 11.0.0-M1 - 11.0.1

**利用条件:** 默认 servlet 启用写入 (非默认配置)且运行在大小写不敏感的文件系统上。

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2024-50379 是 Apache Tomcat 中 JSP 编译期间发生的 Time-of-check Time-of-use (TOCTOU) 竞争条件漏洞。当默认 servlet 启用写入时，攻击者可以通过上传包含恶意 JSP 代码的文件并利用竞争条件来触发 Tomcat 解析和执行它，从而实现远程代码执行。

**利用方式：**

1.  **上传恶意 JSP 文件：** 攻击者首先上传一个名为 `test01_{random_suffix}.txt` 的文件，其中包含JSP Footer代码，该代码的功能是接收通过请求头传递的base64编码的payload，然后通过AES解密后加载到内存中执行。
2.  **利用竞争条件：** 攻击者利用竞争条件，尝试在 Tomcat 将上传的 `.txt` 文件识别为普通文本文件之前，将其重命名为 `.jsp` 文件。这需要同时发送大量的请求。
3.  **JSP 编译和执行：** 如果竞争成功，Tomcat 将尝试编译并执行该 `.jsp` 文件，从而允许攻击者执行任意代码。

**POC代码分析：**

提供的 Python POC 脚本旨在自动化利用此漏洞。脚本执行以下步骤：

1.  **生成随机字符串和哈希：** 生成随机后缀和 MD5 哈希值，用于生成唯一的临时文件名和最终的 JSP 文件名。
2.  **生成 JSP 内容：** 生成包含将源文件复制到目标文件的 JSP 代码。
3.  **发送 PUT 请求：** 使用生成的随机文件名将恶意 JSP 内容上传到服务器。 通过PUT上传t1{random_suffix}.Txt和t2{random_suffix}.Txt为JSP Footer内容，t1{random_suffix}.Jsp和t2{random_suffix}.Jsp为JSP Header内容。
4.  **发送 GET 请求：** 发送GET请求, 检查目标JSP是否存在.
5.  **多线程并发：** 使用多线程并发来增加竞争条件成功的可能性。
6.  **停止机制:**  一旦发现漏洞则停止扫描.

**投毒风险分析：**

代码中存在一定的投毒风险，主要集中在以下几个方面：

1.  **JSP Footer 的自定义内容：** 脚本允许用户通过 `-f` 或 `--footer` 参数指定自定义的 JSP footer 内容。 如果攻击者指定了恶意的 JSP 代码，则可能导致被攻击的服务器受到进一步的损害。 但这是参数问题，不是代码本身的问题。
2.  **Payload 执行：** JSP Footer 中的恶意代码功能是通过请求头传递加密的payload，并将其加载到内存中执行。攻击者可以通过控制请求头来执行任意代码。尽管这本身就是漏洞利用的一部分，但如果攻击者能够注入额外的恶意代码，则可能导致更严重的后果。

**总结：**

该漏洞利用的有效性较高，但也依赖于特定的配置（默认 servlet 启用写入）和文件系统类型（大小写不敏感）。POC 代码可以有效利用此漏洞，但存在一定的投毒风险，用户需要谨慎使用，尤其是在指定自定义 JSP 内容时。Payload的加载和执行是漏洞利用的关键步骤。

**项目地址:** [gomtaengi/CVE-2024-50379-exp](https://github.com/gomtaengi/CVE-2024-50379-exp)

**漏洞详情:** [CVE-2024-50379](https://nvd.nist.gov/vuln/detail/CVE-2024-50379)