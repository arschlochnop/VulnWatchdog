## CVE-2021-31166 - HTTP Protocol Stack Remote Code Execution

**漏洞编号:** CVE-2021-31166

**漏洞类型:** 远程代码执行 (RCE)/拒绝服务 (DoS)

**影响应用:** Microsoft Windows HTTP Protocol Stack

**危害等级:** 高危，可导致远程代码执行或拒绝服务

**影响版本:** Windows 10 Version 2004, Windows Server version 2004, Windows 10 Version 20H2, Windows Server version 20H2 (受影响版本小于 10.0.19041.982 或 10.0.19042.982)

**利用条件:** 目标系统需要运行受影响版本的 Windows 并且启用了 HTTP 服务

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2021-31166 是一个 HTTP 协议栈的远程代码执行漏洞。根据漏洞库信息，该漏洞的 CVSS 3.1 评分为 9.8，属于严重级别。CISA 已将其添加到已知被利用漏洞目录中，表明该漏洞在野外已被积极利用。

提供的 PowerShell 和 Ruby 脚本均旨在利用此漏洞进行拒绝服务 (DoS) 攻击，导致蓝屏死机 (BSOD)。它们通过发送特制的 HTTP 请求，其中包含包含大量随机字符串的 `Accept-Encoding` 标头来触发漏洞。该标头会造成 HTTP 协议栈处理异常，最终导致崩溃。

**有效性:**
根据提供的漏洞利用代码，该漏洞的利用方法是通过发送畸形的 HTTP 请求，特别是 `Accept-Encoding` 字段，来触发 Windows HTTP 协议栈的异常，导致拒绝服务攻击，使系统蓝屏。鉴于CISA已经将其加入到已知被利用漏洞库，可以认为该漏洞是有效的，并且在野外已经被利用。

**投毒风险:**
分析提供的 PowerShell 和 Ruby 脚本，未发现明显的恶意代码或后门。这些脚本主要用于生成包含大量随机字符串的 `Accept-Encoding` 标头，以触发漏洞。脚本的目的是导致目标系统崩溃，而不是植入后门或执行其他恶意操作。因此，投毒风险较低。但需要注意的是，由于脚本运行后会导致系统崩溃，所以存在一定的误报风险，在使用过程中务必谨慎。

**利用方式:**

1.  **选择目标:** 确定运行受影响版本的 Windows 系统的目标服务器。
2.  **准备攻击环境:**  准备一台能够发送 HTTP 请求的机器，并安装 PowerShell 或 Ruby 环境。
3.  **配置脚本:** 修改提供的 PowerShell 或 Ruby 脚本，设置目标服务器的 IP 地址或域名。
4.  **发送恶意请求:**  运行脚本，向目标服务器发送包含特制 `Accept-Encoding` 标头的 HTTP 请求。
5.  **触发漏洞:**  目标服务器的 HTTP 协议栈在处理恶意请求时发生异常，导致系统崩溃并蓝屏。

该漏洞主要影响的是Windows HTTP 协议栈的稳定性，攻击者可以利用该漏洞发起拒绝服务攻击，使得服务器无法正常提供服务。虽然提供的 PoC 主要展示了 DoS 攻击，但是根据漏洞描述，也存在远程代码执行的风险，需要及时修复。

**项目地址:** [mauricelambert/CVE-2021-31166](https://github.com/mauricelambert/CVE-2021-31166)

**漏洞详情:** [CVE-2021-31166](https://nvd.nist.gov/vuln/detail/CVE-2021-31166)