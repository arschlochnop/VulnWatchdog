## CVE-2024-20674 Windows Kerberos 安全功能绕过漏洞

**漏洞编号:** CVE-2024-20674

**漏洞类型:** 安全功能绕过

**影响应用:** Windows Kerberos

**危害等级:** 高危，可能导致身份伪造、权限提升以及控制受影响的机器

**影响版本:** 受影响的Windows版本众多，详见CVE信息

**利用条件:** 需要中间人攻击（MITM）能力，且目标客户端需要与攻击者位于同一网络，或者攻击者可以劫持网络流量。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-20674 允许攻击者绕过 Kerberos 相互身份验证。该漏洞的利用方式是，攻击者通过中间人攻击，伪造域控服务器（DC），并利用客户端对Kerberos U2U (User-to-User) TGT-REP的处理逻辑缺陷，返回一个伪造的TGT-REQ的错误响应，诱导客户端错误地认为相互认证已成功完成。攻击者可以利用该漏洞，例如，提供恶意的组策略对象（GPO），从而控制受害机器。

**漏洞利用方式：**

1.  **中间人攻击（MITM）：** 攻击者需要能够拦截目标客户端和 Kerberos 服务器（域控制器）之间的网络流量。
2.  **伪造域控服务器：** 攻击者需要模拟域控服务器，监听 Kerberos (88端口)和 SMB (445端口)等关键端口。
3.  **欺骗TGT-REQ：** 当客户端发起 Kerberos 认证请求时，攻击者返回一个精心构造的KRB_ERROR消息，模拟U2U场景，让客户端误以为认证成功。
4.  **控制客户端：** 成功绕过认证后，攻击者可以利用例如组策略等机制控制客户端。

**投毒风险评估：**

提供的POC代码主要是利用scapy库实现Kerberos协议的交互和SMB服务器的模拟。代码中包含了用于拦截和篡改网络流量的iptables命令，以及模拟Kerberos错误响应的逻辑。虽然从代码功能来看，其目的是为了验证和利用该漏洞，但是存在一定的投毒风险，例如作者可能在GPO中植入恶意代码，或者修改scapy数据包，添加恶意行为。考虑到GPO明确提示会破坏客户端配置，存在一定的风险，故判定投毒风险为10%。

**项目地址:** [gpotter2/CVE-2024-20674](https://github.com/gpotter2/CVE-2024-20674)

**漏洞详情:** [CVE-2024-20674](https://nvd.nist.gov/vuln/detail/CVE-2024-20674)