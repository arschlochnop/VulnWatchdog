## CVE-2022-46169-Cacti-命令注入

**漏洞编号:** CVE-2022-46169

**漏洞类型:** 命令注入

**影响应用:** Cacti

**危害等级:** 高危，未经身份验证的远程代码执行

**影响版本:** < 1.2.23

**利用条件:** 目标系统安装Cacti，且存在类型为`POLLER_ACTION_SCRIPT_PHP`的`poller_item`。

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2022-46169是Cacti中一个未经身份验证的命令注入漏洞。漏洞存在于`remote_agent.php`文件中，攻击者可以通过`X-Forwarded-For`头绕过身份验证，然后通过构造恶意的`poller_id`参数，在`poll_for_data`函数中使用`proc_open`执行任意命令。

**有效性：**
提供的PoC代码有效。它首先检查目标是否易受攻击，然后进行暴力破解以查找`host_id`和`local_data_id`，最后构造包含恶意payload的URL来执行命令。

**投毒风险：**
PoC代码本身看起来相对干净，主要功能是利用漏洞。但任何时候都存在一定的风险。漏洞利用代码中存在一定的风险，例如，要求用户输入IP地址和端口，然后构造反向shell的payload。虽然这是漏洞利用的一部分，但用户在复制粘贴代码时可能没有意识到这一点。由于代码的目的是演示漏洞，因此将此定义为恶意投毒是不准确的。风险评估如下：
  * 代码逻辑的直接目的并不是植入后门或执行恶意操作，而是为了演示漏洞利用，大部分操作都需要用户交互。
  * 潜在风险较低，主要体现在用户不理解反向shell的含义，直接运行可能导致自身暴露。
总的来说，投毒风险较低，预估为5%。

**利用方式：**
1.  **身份验证绕过：** 攻击者设置`X-Forwarded-For`头为Cacti服务器的IP地址，绕过`remote_agent.php`的身份验证。
2.  **查找有效ID：** 攻击者暴力破解`host_id`和`local_data_id`，找到`poller_item`表中`action`类型为`POLLER_ACTION_SCRIPT_PHP`的条目。
3.  **命令注入：** 攻击者构造包含恶意命令的`poller_id`参数，发送到`remote_agent.php`，服务器执行该命令。

**结论：** 此漏洞利用风险极高，因为无需身份验证即可远程执行代码。提供的PoC可以有效利用此漏洞，需要及时修补。

**项目地址:** [dawnl3ss/CVE-2022-46169](https://github.com/dawnl3ss/CVE-2022-46169)

**漏洞详情:** [CVE-2022-46169](https://nvd.nist.gov/vuln/detail/CVE-2022-46169)