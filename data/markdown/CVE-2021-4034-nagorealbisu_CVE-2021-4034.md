## CVE-2021-4034-Polkit-pkexec本地提权

**漏洞编号:** CVE-2021-4034

**漏洞类型:** 本地提权

**影响应用:** Polkit

**危害等级:** 高危，允许低权限用户获取root权限

**影响版本:** all (受影响版本)

**利用条件:** 需要本地用户权限

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2021-4034是Polkit的pkexec实用程序中的一个本地权限提升漏洞。pkexec是一个setuid工具，允许非特权用户根据预定义的策略以特权用户身份运行命令。该漏洞是由于pkexec没有正确处理调用参数的计数，导致它尝试将环境变量作为命令执行。攻击者可以精心构造环境变量，诱使pkexec执行任意代码，从而使非特权用户获得目标机器的管理权限。

**利用方式：**

1.  **编译exploit:** 首先，使用提供的Makefile编译`pwnkit.c`生成动态链接库`pwnkit.so`，并编译`cve-2021-4034.c`生成可执行文件`cve-2021-4034`。
2.  **创建GCONV_PATH目录：** 创建`GCONV_PATH=.`目录，并将`true`命令复制到该目录下，重命名为`pwnkit.so:.`。
3.  **构造环境变量：** 设置以下环境变量：
    *   `pwnkit.so:.` (利用glibc的gconv机制)
    *   `PATH=GCONV_PATH=.`
    *   `SHELL=/bin/bash`
    *   `CHARSET=PWNKIT`
    *   `GIO_USE_VFS=`
4.  **执行exploit：** 运行编译好的`cve-2021-4034`可执行文件。该程序会调用`/usr/bin/pkexec`，并传递构造好的环境变量。
5.  **权限提升：** `pkexec`由于漏洞，会加载恶意的`pwnkit.so`动态链接库。`pwnkit.so`中的`gconv_init`函数会被执行，该函数设置uid和gid为0，然后执行`/bin/sh`，从而获得root权限的shell。

**有效性：**

根据漏洞信息和POC代码，该POC代码有效。漏洞库信息和搜索引擎结果均表明CVE-2021-4034是一个可被利用的本地权限提升漏洞，并且POC代码已经公开。

**投毒风险：**

提供的POC代码中未发现明显的恶意代码或后门。该代码的目的是利用pkexec的漏洞提升权限，没有进行任何未经授权的数据收集、修改或远程控制操作。`pwnkit.c` 的作用是劫持程序流程并启动一个root shell，属于漏洞利用的一部分，并非投毒代码。因此，投毒风险较低。

**项目地址:** [nagorealbisu/CVE-2021-4034](https://github.com/nagorealbisu/CVE-2021-4034)

**漏洞详情:** [CVE-2021-4034](https://nvd.nist.gov/vuln/detail/CVE-2021-4034)