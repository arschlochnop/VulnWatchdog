## CVE-2021-4034 - Polkit pkexec 本地提权

**漏洞编号:** CVE-2021-4034

**漏洞类型:** 本地权限提升

**影响应用:** Polkit pkexec

**危害等级:** 高危，本地用户可获取 root 权限

**影响版本:** all (受影响)

**利用条件:** 本地用户可以访问目标机器，且 pkexec 未打补丁

**POC 可用性:** 是

**投毒风险:** 1%

## 详情

CVE-2021-4034（PwnKit）是 polkit 的 pkexec 工具中的一个本地提权漏洞。由于 pkexec 未正确处理参数计数，攻击者可以通过构造特定的环境变量来执行任意代码，从而获得 root 权限。

**有效性：**
根据漏洞库信息、搜索引擎结果和提供的漏洞利用代码，该漏洞利用是有效的。漏洞利用代码中展示了完整的利用步骤，包括编译恶意 payload，设置环境变量，然后运行 pkexec。搜索引擎结果也表明该漏洞在野外被广泛利用。

**投毒风险：**
提供的漏洞利用代码主要包含以下几个部分：
1.  **C 源代码 (payload.c)：** 用于生成共享对象 (payload.so)，该共享对象包含恶意代码。
2.  **Shell 命令：** 设置环境变量并运行 pkexec。

风险分析：
*   **payload.c 的内容：** 没有提供 `payload.c` 文件的具体内容，因此无法直接判断 payload 的行为。但是，从利用方式来看，该 payload 旨在利用 pkexec 的漏洞来执行恶意代码。
*   **环境变量设置：** 环境变量 `GCONV_PATH`、`CHARSET`、`LD_PRELOAD` 和 `PATH` 是利用该漏洞的关键。`GCONV_PATH` 和 `CHARSET` 用于加载恶意的 gconv 模块，`LD_PRELOAD` 用于预加载恶意的共享对象，`PATH` 用于确保恶意的 gconv 模块优先被加载。

虽然POC中涉及`payload.c` ,如果没有对源码进行恶意篡改和添加恶意代码, 本身是不存在投毒风险的,但是`payload.c`文件未给出,无法完全验证,存在潜在投毒风险，但是概率极低。

**利用方式：**
1.  **编译 Payload：** 首先，使用 GCC 编译 C 源代码 (payload.c) 生成共享对象 (payload.so)。编译时需要使用 `-shared` 和 `-fPIC` 选项。
2.  **创建 exploit 目录：** 创建一个名为 exploit 的目录，并将 payload.so 移动到该目录中。
3.  **创建 gconv-modules 文件：** 在 exploit 目录中创建一个名为 gconv-modules 的文件，该文件用于配置 gconv 模块。内容一般是 `module UTF-8// POC// payload 2`。
4.  **设置环境变量：** 设置以下环境变量：
    *   `GIO_USE_VFS=local`
    *   `PATH=./exploit:$PATH`
    *   `LD_PRELOAD=./exploit/payload.so`
    *   `GCONV_PATH=./exploit`
    *   `CHARSET=POC`
5.  **运行 pkexec：** 运行 pkexec 命令，这将触发漏洞并执行 payload.so 中的恶意代码，从而提升权限。

**项目地址:** [BugVex/Poison-HTB-Report](https://github.com/BugVex/Poison-HTB-Report)

**漏洞详情:** [CVE-2021-4034](https://nvd.nist.gov/vuln/detail/CVE-2021-4034)