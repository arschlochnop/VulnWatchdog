## CVE-2021-34527 - PrintNightmare

**漏洞编号:** CVE-2021-34527

**漏洞类型:** 远程代码执行

**影响应用:** Windows Print Spooler

**危害等级:** 高危，可导致SYSTEM权限的远程代码执行

**影响版本:** 受影响的Windows版本及补丁版本之前

**利用条件:** 攻击者需要能够与目标系统的打印服务通信（通常是445端口，但可能配置为其他端口），并需要用户权限（尽管存在本地提权变种）

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-34527 (PrintNightmare) 是一个 Windows Print Spooler 服务中的远程代码执行漏洞。攻击者可以利用此漏洞以 SYSTEM 权限执行任意代码。根据漏洞库信息，多个 Windows 版本都受到影响，直到相应的安全更新发布。搜索结果也表明该漏洞是一个严重的安全问题，并被称为"PrintNightmare"。

**有效性分析：**

提供的 PowerShell 脚本 (CVE-2021-34527.PS1) 旨在利用 PrintNightmare 漏洞。该脚本允许攻击者添加一个新的本地管理员用户，或执行自定义 DLL 代码作为 NT AUTHORITY\SYSTEM。脚本通过 `AddPrinterDriverEx` 函数加载恶意的打印机驱动程序来实现代码执行。

**投毒风险分析：**

虽然脚本的主要功能是利用 PrintNightmare 漏洞，但存在少量投毒风险。

1.  **默认凭据：** 脚本默认创建一个用户名为 `adm1n`，密码为 `P@ssw0rd` 的管理员帐户。如果攻击者直接使用默认配置，可能使得目标系统容易被其他攻击者利用。
2.  **DLL来源：** 脚本允许指定自定义的 DLL。如果攻击者从不可信的来源下载 DLL，则可能执行恶意代码，反过来感染攻击者的系统。
3.  **编码方式：** 使用 `UnicodeEncoding` 可能会引入一些问题，因为有些系统可能使用不同的编码方式。尽管这不是直接的投毒，但可能导致利用失败。
4.  **依赖性：** 脚本依赖于特定的 Windows API 和 DLL 文件。如果这些 API 或 DLL 不可用或行为发生变化，脚本可能无法正常工作。

**利用方式分析：**

利用方式主要步骤如下：

1.  **准备恶意DLL：** 攻击者需要准备一个包含恶意代码的 DLL 文件。提供的脚本可以生成一个默认的 DLL，该 DLL 将创建一个新的本地管理员用户。或者，攻击者可以提供自己的 DLL。
2.  **执行PowerShell脚本：** 攻击者需要在目标系统上执行提供的 PowerShell 脚本。需要具有一定的用户权限才能执行该脚本。
3.  **加载恶意驱动：** 脚本使用 `AddPrinterDriverEx` 函数将恶意 DLL 加载为打印机驱动程序。由于 Print Spooler 服务以 SYSTEM 权限运行，因此 DLL 中的代码也将以 SYSTEM 权限执行。
4.  **代码执行：** 恶意 DLL 中的代码被执行，从而允许攻击者控制目标系统。

**结论：**
提供的 POC 代码有效，但存在少量投毒风险（大约 10%）。攻击者需要注意使用安全的 DLL 来源，并避免使用默认凭据。

**项目地址:** [Amaranese/CVE-2021-34527](https://github.com/Amaranese/CVE-2021-34527)

**漏洞详情:** [CVE-2021-34527](https://nvd.nist.gov/vuln/detail/CVE-2021-34527)