## CVE-2021-34527 PrintNightmare RCE

**漏洞编号:** CVE-2021-34527

**漏洞类型:** 远程代码执行

**影响应用:** Windows Print Spooler

**危害等级:** 高危，允许攻击者以SYSTEM权限执行任意代码

**影响版本:** 受影响的Windows版本，包括但不限于Windows 10, Windows Server 2019, Windows 11

**利用条件:** 需要Active Directory域凭据进行身份验证

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-34527 (PrintNightmare) 是一个Windows Print Spooler服务中的远程代码执行漏洞。从搜索引擎结果和漏洞库信息来看，该漏洞影响多个Windows版本，并允许经过身份验证的攻击者以SYSTEM权限执行任意代码。提供的漏洞利用代码是一个Python扫描器，用于检测目标子网是否存在PrintNightmare RCE漏洞，它通过模拟攻击者使用的RPC调用来判断主机是否脆弱。

**有效性：**
提供的POC代码本身是一个扫描器，而不是直接的漏洞利用程序。它模拟了攻击中使用的RPC调用，以此来判断目标主机是否存在漏洞。因此，可以认为它在漏洞检测方面是有效的。

**投毒风险：**
虽然POC的主要功能是扫描，但考虑到它包含从github下载的exp,存在一定的风险，需要仔细审查exp代码。此外，Dockerfile包含curl和git命令，存在下载恶意脚本的可能性，但代码本身主要是进行漏洞扫描，没有发现明显的恶意代码或后门。考虑到网络下载依赖，投毒风险评估为10%。

**利用方式：**
1.  **身份验证：**  攻击者需要具有Active Directory域的有效凭据才能利用此漏洞。
2.  **RPC调用：**  攻击者使用MS-PAR和MS-RPRN协议中存在的漏洞函数，向Print Spooler服务发送特制的RPC请求。
3.  **DLL注入：**  攻击者通过`AddPrinterDriverEx`函数安装恶意的打印机驱动程序，该驱动程序实际上是一个DLL文件，会被Print Spooler服务加载。
4.  **代码执行：**  当Print Spooler服务加载恶意的DLL驱动程序时，其中的代码将以SYSTEM权限执行，从而允许攻击者完全控制受影响的系统。

该漏洞利用的核心在于滥用`AddPrinterDriverEx`函数，在没有适当权限验证的情况下安装恶意的打印机驱动程序。


**项目地址:** [byt3bl33d3r/ItWasAllADream](https://github.com/byt3bl33d3r/ItWasAllADream)

**漏洞详情:** [CVE-2021-34527](https://nvd.nist.gov/vuln/detail/CVE-2021-34527)