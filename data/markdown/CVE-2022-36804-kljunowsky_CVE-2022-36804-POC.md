## CVE-2022-36804-Bitbucket-命令注入

**漏洞编号:** CVE-2022-36804

**漏洞类型:** 命令注入

**影响应用:** Atlassian Bitbucket Server 和 Data Center

**危害等级:** 高危，可能导致远程代码执行

**影响版本:** 7.0.0 <= version < 7.6.17, 7.7.0 <= version < 7.17.10, 7.18.0 <= version < 7.21.4, 8.0.0 <= version < 8.0.3, 8.1.0 <= version < 8.1.3, 8.2.0 <= version < 8.2.2, 8.3.0 <= version < 8.3.1

**利用条件:** 需要对公开仓库具有访问权限，或者对私有 Bitbucket 仓库具有读取权限。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

根据漏洞信息和搜索结果，CVE-2022-36804 允许远程攻击者通过发送恶意 HTTP 请求，在存在漏洞的 Bitbucket Server 和 Data Center 实例上执行任意代码。该漏洞是由于多个 API 端点中存在命令注入漏洞导致的，攻击者可以利用 `git --exec` 参数执行恶意命令。

**有效性：**
提供的 POC 代码尝试利用该漏洞。它首先使用 `httpx` 查找公开的 Bitbucket 仓库，然后构造一个包含恶意 `--exec` 参数的 URL，该参数会导致服务器执行任意命令。`id` 命令被用作 PoC，用于验证是否成功执行命令。

**投毒风险：**
该仓库的投毒风险较低，大约为 10%。 代码逻辑相对简单，主要是发现Bitbucket仓库并构造利用URL。投毒的风险可能存在于以下方面：

1.  **依赖库风险:** 脚本依赖于外部库，如 `requests` 和命令行工具如`httpx`, 这些依赖项可能存在潜在的供应链安全风险，虽然不太可能，但需要考虑。
2.  **命令执行风险:** 脚本使用了 `os.system` 执行命令，虽然用于调用 `httpx`，但如果攻击者能够控制 targets 文件内容，可能会导致额外的命令注入风险。这部分的风险较低，取决于 `targets` 文件的可控程度。
3.  **URL 构造风险:** 脚本构造 URL 的逻辑存在一定的复杂性，如果服务器对 URL 的处理方式与预期不符，可能会导致意外的命令执行或其他安全问题。

**利用方式：**
1.  **查找公开仓库：** 攻击者首先需要找到公开可访问的 Bitbucket 仓库或具有读取权限的私有仓库。
2.  **构造恶意 URL：** 攻击者构造一个包含恶意 `--exec` 参数的 URL。该 URL 的格式如下：
    `/rest/api/latest/projects/{project-path}/archive?filename=kiE0h&at=kiE0h&path=kiE0h&prefix=ax%00--exec=%60<command>%60%00--remote=origin`
    其中，`<command>` 是要执行的命令。
3.  **发送 HTTP 请求：** 攻击者向 Bitbucket 服务器发送包含恶意 URL 的 HTTP 请求。
4.  **执行任意代码：** 如果服务器存在漏洞，则会执行 URL 中指定的命令。

**项目地址:** [kljunowsky/CVE-2022-36804-POC](https://github.com/kljunowsky/CVE-2022-36804-POC)

**漏洞详情:** [CVE-2022-36804](https://nvd.nist.gov/vuln/detail/CVE-2022-36804)