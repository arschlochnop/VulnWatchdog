## CVE-2020-7247-OpenSMTPD-RCE

**漏洞编号:** CVE-2020-7247

**漏洞类型:** 远程代码执行

**影响应用:** OpenSMTPD

**危害等级:** 高危，可能导致系统完全控制

**影响版本:** 6.6

**利用条件:** OpenSMTPD 6.6默认配置，未打补丁

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2020-7247是一个存在于OpenSMTPD 6.6的远程代码执行漏洞。该漏洞位于`smtp_session.c`中的`smtp_mailaddr`函数，由于输入验证不当，允许远程攻击者通过精心构造的SMTP会话，在`MAIL FROM`字段中注入shell元字符，从而以root权限执行任意命令。默认配置下，OpenSMTPD会错误地处理包含shell元字符的`MAIL FROM`地址。攻击者利用点在于`MAIL FROM`参数，通过注入恶意的shell命令，造成远程代码执行。

**有效性评估：**

提供的漏洞利用代码似乎有效。`exploit.py`脚本通过socket连接到目标OpenSMTPD服务器，发送HELO、MAIL FROM、RCPT TO和DATA等SMTP命令，在`MAIL FROM`命令中包含了payload，该payload试图执行反弹shell。Docker文件用于搭建存在漏洞的OpenSMTPD环境，便于验证。

**投毒风险评估：**

经过分析，此仓库中存在作者隐藏的投毒代码可能性较低，约占10%。主要依据如下：
1. `exploit.py`明确地展示了利用payload进行反弹shell，行为明确。
2. Dockerfile 拉取了指定的debian版本，降低了被投毒的可能，同时Dockerfile指定快照源，降低了通过依赖引入投毒的风险。
3. Nix 文件 只是dockerfile的另外一种描述方式，目的是为了构建docker镜像，与投毒无关。

但仍然存在一定的投毒可能：
1. 在`exploit.py`的payload中，攻击者可能会通过某种方式尝试上传或修改服务器上的其他文件，或者运行一些隐蔽的恶意命令，这种行为没有在POC里清晰展示。
2. 其他配置文件中可能存在隐藏的后门或者配置缺陷，不过可能性较低。

**利用方式：**

1.  攻击者首先需要与目标OpenSMTPD服务器建立SMTP连接（端口25）。
2.  发送`HELO`命令进行握手。
3.  关键步骤：发送`MAIL FROM`命令，并在邮件地址中插入shell元字符和恶意命令。例如：`MAIL FROM:<;恶意命令;>`
4.  发送`RCPT TO`命令指定收件人。
5.  发送`DATA`命令，并发送邮件内容（可以为空）。
6.  服务器在处理`MAIL FROM`地址时，由于漏洞，会执行注入的shell命令。
7.  攻击者通过监听指定端口，接收反弹shell，从而获得目标服务器的root权限。

总结：该漏洞利用难度较低，只需要构造特定的SMTP会话，即可触发远程代码执行。

**项目地址:** [minhluannguyen/CVE-2020-7247-reproducer](https://github.com/minhluannguyen/CVE-2020-7247-reproducer)

**漏洞详情:** [CVE-2020-7247](https://nvd.nist.gov/vuln/detail/CVE-2020-7247)