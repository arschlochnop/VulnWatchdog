## CVE-2022-46169-Cacti-命令注入

**漏洞编号:** CVE-2022-46169

**漏洞类型:** 命令注入

**影响应用:** Cacti

**危害等级:** 高危，未经身份验证的远程代码执行

**影响版本:** < 1.2.23

**利用条件:** 需要Cacti服务可网络访问, 并且存在action类型为POLLER_ACTION_SCRIPT_PHP的poller_item。

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2022-46169是Cacti 1.2.23之前的版本中存在的一个未经身份验证的命令注入漏洞。攻击者可以通过`remote_agent.php`文件，绕过身份验证，然后利用`polldata`动作，通过构造恶意的`poller_id`参数，执行任意操作系统命令。漏洞利用的关键在于：

1.  **身份验证绕过：** 通过设置`X-Forwarded-For`头，伪造客户端IP地址，绕过`remote_agent.php`的身份验证检查。这是因为`get_client_addr`函数会信任`HTTP_`开头的`$_SERVER`变量，导致可以伪造IP地址。
2.  **命令注入：** 一旦通过身份验证，攻击者可以向`remote_agent.php`发送带有`action=polldata`的请求，其中`poller_id`参数可以被注入恶意命令。程序会将这个参数传递给`proc_open`函数，从而执行攻击者提供的命令。
3.  **利用方式：**  提供的Python脚本首先检查目标是否易受攻击，然后使用提供的LHOST和LPORT生成反向shell有效负载。 脚本通过暴力破解`host_id`和`local_data_ids[]`，构造恶意的URL，发送到目标`remote_agent.php`，从而执行反向shell，从而在目标系统上获得shell访问权限。

**投毒风险分析：**

代码本身主要功能是实现漏洞利用，但仍然存在一定低概率的投毒风险：

*   **潜在的后门：** 虽然代码的主要目的是利用漏洞，但作者可能在payload构建过程中插入了额外的恶意代码，例如，在反向shell payload中添加了额外的命令，用于收集敏感信息或执行其他恶意操作。但是从代码来看，payload是根据用户输入的IP和端口构建的，自定义程度较高，因此payload中存在后门的概率较低。
*   **依赖风险：** 该脚本依赖于`requests`和`urllib`库。虽然这些都是常用的库，但如果这些库本身存在漏洞，或者作者使用了不安全的库函数，可能会引入安全风险。

总体而言，该POC代码的投毒风险较低，约为5%。主要风险在于payload构建过程中可能存在的隐蔽后门，以及对第三方库的依赖。

**项目地址:** [alv-david/CVE-2022-46169-Cacti-1.2.22](https://github.com/alv-david/CVE-2022-46169-Cacti-1.2.22)

**漏洞详情:** [CVE-2022-46169](https://nvd.nist.gov/vuln/detail/CVE-2022-46169)