## CVE-2024-4040 - CrushFTP Authentication Bypass and Remote Code Execution

**漏洞编号:** CVE-2024-4040

**漏洞类型:** 服务器端模板注入 (SSTI)

**影响应用:** CrushFTP

**危害等级:** 严重，未授权远程攻击者可以读取文件系统，绕过身份验证以获得管理权限，并在服务器上执行远程代码。

**影响版本:** 10.0 (低于 10.7.1) 和 11.0 (低于 11.1.0)

**利用条件:** 目标 CrushFTP 服务器运行受影响版本，且可以通过网络访问。

**POC 可用性:** 是

**投毒风险:** 1%

## 详情

CVE-2024-4040 是 CrushFTP 中一个严重的服务器端模板注入漏洞。未经身份验证的远程攻击者可以利用此漏洞读取文件系统，绕过身份验证以获得管理权限，并在服务器上执行远程代码。

**有效性:**

根据提供的漏洞信息、搜索引擎结果以及漏洞利用代码，该漏洞利用的有效性较高。漏洞库信息明确指出该漏洞允许未经身份验证的远程攻击者执行任意文件读取和远程代码执行。搜索引擎结果也证实了该漏洞已被公开利用。提供的 Python 脚本 `CVE-2024-4040.py` 旨在利用身份验证绕过漏洞。

**投毒风险:**

检查提供的 Python 脚本。脚本的主要功能是模拟 CrushFTP 的身份验证流程，通过生成伪造的 `CrushAuth` cookie 和 AWS 风格的 `Authorization` 标头来绕过身份验证。脚本的 `exploit()` 函数构造一个带有伪造身份验证信息的 HTTP POST 请求，并发送到目标服务器。根据代码逻辑，脚本似乎没有明显的恶意代码或后门。因此，投毒风险较低, 但是不排除作者在其它位置植入后门的可能性，谨慎使用。投毒风险概率为1%。

**利用方式:**

利用方式主要分为以下几个步骤：

1.  **身份验证绕过：** 攻击者通过生成伪造的 `CrushAuth` cookie 和 AWS 风格的 `Authorization` 标头，绕过 CrushFTP 的身份验证机制。脚本中使用 `generate_auth_cookie()` 函数生成伪造的 `CrushAuth` cookie，并使用 `Authorization` 标头传递用户名。
2.  **发送恶意请求：** 攻击者构造一个带有伪造身份验证信息的 HTTP POST 请求，并发送到目标服务器的 `/WebInterface/function/` 端点。请求中包含要执行的命令，例如 `getUserName`。
3.  **远程代码执行:** 利用服务器端模板注入，执行任意代码。

利用此漏洞，攻击者可以：

*   **读取任意文件：** 攻击者可以读取服务器上的任意文件，包括敏感配置文件和用户数据。
*   **绕过身份验证：** 攻击者可以绕过身份验证，获得管理权限。
*   **执行远程代码：** 攻击者可以在服务器上执行任意代码，从而完全控制服务器。

**缓解措施:**

*   升级到 CrushFTP 10.7.1 或 11.1.0 或更高版本。


**项目地址:** [ill-deed/CrushFTP-CVE-2024-4040-illdeed](https://github.com/ill-deed/CrushFTP-CVE-2024-4040-illdeed)

**漏洞详情:** [CVE-2024-4040](https://nvd.nist.gov/vuln/detail/CVE-2024-4040)