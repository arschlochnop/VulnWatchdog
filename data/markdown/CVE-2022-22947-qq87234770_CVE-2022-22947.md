## CVE-2022-22947 - Spring Cloud Gateway Code Injection

**漏洞编号:** CVE-2022-22947

**漏洞类型:** 代码注入

**影响应用:** Spring Cloud Gateway

**危害等级:** 高危，可远程代码执行

**影响版本:** Spring cloud gateway versions 3.1.x prior to 3.1.1+, 3.0.x prior to 3.0.7+ and all old and unsupported versions

**利用条件:** Gateway Actuator endpoint 启用，暴露且未授权

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2022-22947 是 Spring Cloud Gateway 中的一个代码注入漏洞。当 Gateway Actuator 端点启用、暴露且未授权时，远程攻击者可以发送恶意构造的请求，从而在远程主机上执行任意代码。

**有效性：**

提供的 Python POC 代码利用了 Spring Expression Language (SpEL) 注入漏洞。该脚本允许执行任意命令，或通过反弹 shell 获取服务器的控制权。因此，该 POC 代码是有效的。

**投毒风险：**

查看POC代码，该代码的主要功能是利用漏洞进行命令执行或反弹shell。代码中包含以下几个部分，
* 定义请求头和payload结构
* 通过`actuator/gateway/routes/hacktest`创建一个恶意的路由配置，利用SpEL表达式执行命令
* 刷新gateway配置`actuator/gateway/refresh`
* 访问创建的路由`actuator/gateway/routes/hacktest`，触发命令执行。
* 包含执行命令和反弹shell两种模式。

该代码结构清晰，功能明确，主要目的是为了验证和利用漏洞。主要风险集中于漏洞利用本身，而非作者植入的恶意代码。**但是**，任何漏洞利用代码都具有潜在的风险，因为它们可以被用于恶意目的。例如，攻击者可能会修改此 POC 代码以自动化大规模攻击，或将其与其他漏洞利用结合使用。另外代码中的代理设置，如果被恶意修改，可能会导致流量劫持，这里判断投毒风险为10%。

**利用方式：**

1.  **检查前提条件：** 确保目标 Spring Cloud Gateway 实例的 Actuator 端点已启用、暴露且未授权。
2.  **发送恶意请求：** 使用提供的 Python 脚本，通过构造包含 SpEL 表达式的恶意请求到 `actuator/gateway/routes/hacktest` 端点来创建自定义路由。
3.  **刷新 Gateway 配置：** 访问 `actuator/gateway/refresh` 端点以刷新 Gateway 配置，使恶意路由生效。
4.  **触发命令执行：** 访问 `actuator/gateway/routes/hacktest`，触发 SpEL 表达式的计算，从而在服务器上执行任意命令。可以选择直接执行命令，或者反弹 shell 以获取更持久的访问。
5.  **清理：**  通过 DELETE 请求删除创建的恶意路由（通过脚本实现）。

**总结：**

该漏洞利用方式简单有效，攻击者可以利用此漏洞轻松地在未授权的 Spring Cloud Gateway 实例上执行任意代码。需要注意的是，利用的前提是 Actuator 端点未进行适当的安全配置。尽管代码本身投毒可能性较低，但利用此漏洞可能造成严重的安全风险。

**项目地址:** [qq87234770/CVE-2022-22947](https://github.com/qq87234770/CVE-2022-22947)

**漏洞详情:** [CVE-2022-22947](https://nvd.nist.gov/vuln/detail/CVE-2022-22947)