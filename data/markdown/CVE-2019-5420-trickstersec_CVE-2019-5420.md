## CVE-2019-5420-Rails-远程代码执行

**漏洞编号:** CVE-2019-5420

**漏洞类型:** 远程代码执行

**影响应用:** Rails

**危害等级:** 高危，可能导致服务器完全控制

**影响版本:** <5.2.2.1, <6.0.0.beta3 (development mode)

**利用条件:** Rails应用运行在开发模式下，且攻击者可以访问应用

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2019-5420 漏洞是Rails在开发模式下存在的一个远程代码执行漏洞。攻击者可以通过猜测自动生成的开发模式密钥令牌（secret token），然后结合其他Rails内部机制，提升权限并执行任意代码。

**有效性分析：**
根据漏洞信息和搜索结果，此漏洞在特定条件下是有效的。提供的POC代码`exploit.rb` 旨在利用此漏洞。代码通过以下步骤工作：
1.  **解密Cookie：** 使用已知的或猜测的密钥解密Rails会话cookie。
2.  **篡改数据：** 在解密后的会话数据中，修改`user_id`等敏感信息，以达到权限提升的目的。
3.  **重新加密Cookie：** 使用相同的密钥和算法重新加密篡改后的会话数据，生成新的cookie。
4.  **URL编码：** 将新生成的cookie进行URL编码，以便在HTTP请求中使用。

通过替换用户的cookie，攻击者可以冒充其他用户（例如管理员）。

**投毒风险分析：**
POC代码本身的主要功能是利用已知的漏洞进行攻击，并非恶意代码。但代码中存在一些小的风险点：
1.  **硬编码的密钥推导：** 代码假设应用名为“PentesterLab::Application”，这是一种简化。如果实际应用名称不同，利用将会失败。但这并不构成投毒，而是一种对特定环境的依赖。
2.  **对特定库的依赖:** 代码依赖于`openssl`、`uri`、`base64`等库，如果这些库存在漏洞，可能会引入额外的风险。
3.  **缺乏输入验证：** 代码没有对输入数据进行严格的验证，如果攻击者能够控制输入，可能会导致其他问题。

总体来说，此仓库的投毒风险较低，约为10%。 主要风险来自于使用者在不了解代码的情况下，直接运行可能存在风险。 需要注意的是，在生产环境中使用此类POC代码进行测试可能会带来风险，建议在隔离环境中进行。

**利用方式：**
1.  **目标识别：** 确定运行在开发模式下的Rails应用，且版本在受影响范围内。
2.  **密钥猜测或获取：** 尝试猜测或通过其他方式获取开发模式下的secret token。在一些情况下，可以通过访问公开的仓库或者配置文件获取。
3.  **Cookie解密与篡改：** 使用POC代码解密现有的cookie，篡改其中的用户ID或其他敏感信息。
4.  **Cookie重新加密与替换：** 使用相同的密钥重新加密cookie，并替换用户浏览器中的cookie。
5.  **权限提升：** 通过篡改后的cookie，以其他用户的身份访问应用，实现权限提升或未授权访问。

**项目地址:** [trickstersec/CVE-2019-5420](https://github.com/trickstersec/CVE-2019-5420)

**漏洞详情:** [CVE-2019-5420](https://nvd.nist.gov/vuln/detail/CVE-2019-5420)