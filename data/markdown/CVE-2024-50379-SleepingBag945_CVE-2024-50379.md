## CVE-2024-50379 - Apache Tomcat TOCTOU 竞争条件 RCE

**漏洞编号:** CVE-2024-50379

**漏洞类型:** 竞争条件导致的远程代码执行

**影响应用:** Apache Tomcat

**危害等级:** 高危，可远程执行任意代码

**影响版本:** 9.0.0.M1 <= version <= 9.0.97, 10.1.0-M1 <= version <= 10.1.33, 11.0.0-M1 <= version <= 11.0.1

**利用条件:** 1. Apache Tomcat 存在漏洞版本;2. 运行在大小写不敏感的文件系统上; 3. 默认 Servlet 启用了写入功能 (非默认配置)

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-50379 是 Apache Tomcat 中的一个 Time-of-check Time-of-use (TOCTOU) 竞争条件漏洞，存在于 JSP 编译过程中。当 Tomcat 运行在大小写不敏感的文件系统上，且默认 Servlet 启用写入功能时（这是一个非默认配置），攻击者可以通过竞争条件绕过安全检查，上传恶意 JSP 文件并执行，从而实现远程代码执行(RCE)。

**漏洞利用方式：**

1.  攻击者利用竞争条件，在 Tomcat 检查文件类型之后、编译之前，修改已上传文件的内容。
2.  由于 Tomcat 存在 TOCTOU 漏洞，因此可以绕过安全检查，导致恶意 JSP 代码被执行。
3.  漏洞利用代码（PoC）`main.go`是一个Go程序，它通过并发发送请求来触发竞争条件，上传一个包含恶意代码的JSP文件。它使用`fasthttp`库发送HTTP请求，利用`ants/v2`库管理并发连接池。

**投毒风险分析：**

代码整体结构较为清晰，主要功能是利用漏洞，并未发现明显的恶意代码。可能的投毒风险在于作者使用的第三方库是否安全，或者作者是否在不显眼的地方添加了恶意代码。风险评估：

*   **第三方库风险：** 代码依赖`github.com/valyala/fasthttp`和`github.com/panjf2000/ants/v2`两个库。需要检查这些库是否存在已知的安全问题。作者替换了`fasthttp`库，需要仔细检查替换的`fasthttp`代码是否存在恶意代码。
*   **代码逻辑风险：** 代码逻辑相对简单，主要就是发送请求，没有发现明显的植入后门的地方。

因此，综合来看，投毒的可能性较低，风险值设定为10%。主要风险还是在于对作者修改过的`fasthttp`库的审核，需要人工进行安全审计。

**项目地址:** [SleepingBag945/CVE-2024-50379](https://github.com/SleepingBag945/CVE-2024-50379)

**漏洞详情:** [CVE-2024-50379](https://nvd.nist.gov/vuln/detail/CVE-2024-50379)