## CVE-2019-13272-Linux Kernel PTRACE_TRACEME权限提升

**漏洞编号:** CVE-2019-13272

**漏洞类型:** 权限提升

**影响应用:** Linux Kernel

**危害等级:** 高危，允许本地用户获得root权限

**影响版本:** < 5.1.17

**利用条件:** 需要本地用户权限，目标系统内核版本低于5.1.17，并且未应用相关补丁或缓解措施（如SELinux的deny_ptrace）。部分利用可能需要gdb。

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2019-13272 漏洞存在于 Linux 内核的 ptrace_link 函数中，该函数处理 PTRACE_TRACEME 功能时，错误地记录了进程的凭据。攻击者可以通过利用父子进程关系（父进程降权后调用 execve，使得攻击者有可能控制子进程），并结合 Polkit 的 pkexec 等辅助程序，通过 PTRACE_TRACEME 机制来获得 root 权限。

**漏洞利用方式：**

1.  攻击者需要一个可以被ptrace的进程。该进程通常是一个权限较低的进程。
2.  利用 `PTRACE_TRACEME` 建立父子进程的ptrace关系
3.  父进程放弃权限，并执行`execve`。如果攻击者可以控制`execve`执行的程序，就可以利用权限凭据记录错误，提升权限。
4.  一种常见的利用方式是利用 Polkit 的 pkexec 辅助程序，结合 `PTRACE_TRACEME` 进行提权。

**POC有效性：**

提供的 PoC 代码是一个 shell 脚本，旨在利用此漏洞。它通过以下步骤尝试利用该漏洞：

1.  查找当前用户正在运行的 shell 进程的 PID。
2.  使用 gdb 附加到这些 shell 进程。
3.  在 gdb 中，执行 `system()` 函数来运行命令，尝试使用 sudo 复制和设置 /tmp/bash 的 setuid 位，从而创建一个具有 root 权限的 shell。
4.  如果 /tmp/bash 创建成功，则执行它以获得 root shell，并清除测试文件。

此 PoC 依赖于 gdb 和 sudo，并且可能需要目标系统上的特定配置才能成功利用。

**投毒风险分析：**

该脚本中存在一些潜在的投毒风险：

*   **依赖外部命令：** 脚本依赖于 `cat`、`tr`、`awk`、`pgrep`、`sed`、`gdb`、`sudo` 等外部命令。如果这些命令被恶意替换，脚本的行为可能会被篡改。
*   **sudo 密码：** 脚本使用 `echo | sudo -S`，这意味着它期望无需密码即可执行 sudo 命令。如果目标系统需要密码，则脚本将失败。更危险的是，如果攻击者能够修改脚本，可能会插入恶意命令，并通过 `sudo` 执行。
*   **临时文件清理：** 脚本尝试删除 /tmp/bash 文件，但如果删除失败，可能会留下一个具有 setuid root 权限的文件，构成安全风险。
*   **脚本来源:** 该脚本声称是 s4vitar 脚本的改进版本，但并没有提供原始链接，也没有详细解释其改进之处。这使得判断脚本的真实意图变得困难。

**投毒可能性评估：**

基于以上分析，该脚本存在一定的投毒风险，但风险较低，大约为5%。主要原因是脚本的逻辑相对简单，并且依赖于标准的系统工具。但是，用户在执行此类脚本时仍应保持警惕，仔细检查脚本内容，并确保在安全的环境中运行。


**项目地址:** [MDS1GNAL/ptrace_scope-CVE-2019-13272-privilege-escalation](https://github.com/MDS1GNAL/ptrace_scope-CVE-2019-13272-privilege-escalation)

**漏洞详情:** [CVE-2019-13272](https://nvd.nist.gov/vuln/detail/CVE-2019-13272)