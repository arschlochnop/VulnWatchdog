## CVE-2019-11043-PHP-FPM远程代码执行

**漏洞编号:** CVE-2019-11043

**漏洞类型:** 远程代码执行

**影响应用:** PHP-FPM (与 Nginx 结合)

**危害等级:** 高危，可能导致服务器被完全控制

**影响版本:** PHP 7.1.x (< 7.1.33), 7.2.x (< 7.2.24), 7.3.x (< 7.3.11)

**利用条件:** 需要 Nginx 作为前端，且配置不当，将请求传递给 PHP-FPM。nginx配置不当，没有检查文件是否存在

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2019-11043 漏洞是 PHP-FPM 在特定配置下（通常与 Nginx 一起使用）由于 env_path_info 处理不当造成的缓冲区下溢漏洞。当 Nginx 没有正确配置以检查文件是否存在的情况下，攻击者可以通过构造特定的 URL，利用该漏洞向 PHP-FPM 发送恶意的 query string length（QSL）值和 D-Pisos header。这些值导致缓冲区下溢，允许攻击者覆盖 FCGI 协议数据，进而执行任意代码。

**有效性：**
根据漏洞库信息、搜索结果和提供的 PoC 代码，该漏洞利用是有效的。搜索结果中多个链接（例如，Trend Micro, NVD, Qualys, Tenable, Orange Tsai 的博客）都确认了该漏洞的存在和可利用性。提供的 PoC 代码似乎旨在自动化利用此漏洞的过程，包括查找正确的 QSL 和 pisos 值，然后发送恶意请求。

**投毒风险：**
该仓库可能存在轻微的投毒风险，概率估计为 10%。风险主要来自以下几个方面：
1.  **依赖关系：** PoC 使用了`pocsuite`框架，这本身需要安装额外的依赖。 虽然pocsuite本身是一个漏洞利用框架，降低了其被投毒的可能性。但是，不排除引入的依赖项可能存在潜在的恶意代码或后门。
2.  **复杂性：** 该漏洞的利用过程较为复杂，涉及多个步骤，包括探测、参数调整和攻击执行。攻击者可能在这些步骤中插入难以察觉的恶意代码。
3.  **模糊处理：** 虽然代码本身相对清晰，但一些变量名（例如 `D-Pisos`）和注释可能包含不明显的恶意行为。

需要注意的是，这里指的是代码本身被植入恶意代码的可能性。PoC 本身的目的就是为了利用漏洞，因此它必然会包含一些“恶意”的操作，但这些操作是为了验证漏洞，而不是为了进行投毒。

**利用方式：**
1.  **探测目标环境：** PoC 首先尝试确定目标 PHP-FPM 服务的状态码，建立基线。
2.  **查找合适的 QSL 值：** 通过发送带有不同长度 query string 的请求，PoC 尝试找到导致状态码改变的 QSL 值。这些值是潜在的攻击参数。
3.  **Sanity Check:** PoC 通过发送大量请求来验证目标是否容易被攻击，以此来保证后续利用的成功率
4.  **确定 pisos 值：** 通过 socket 连接，PoC 发送构造的 HTTP 请求，该请求包含精心设计的 `D-Pisos` header。不同的 pisos 值会导致不同的内存覆盖效果。PoC 尝试不同的 pisos 值，直到成功设置 `session.auto_start` 并获取 PHPSESSID。
5.  **远程代码执行：** 一旦找到正确的 QSL 和 pisos 值，攻击者就可以利用缓冲区下溢覆盖 FCGI 协议数据，设置 `session.auto_start=1` 或者其他php配置，进而执行任意代码。


**项目地址:** [fairyming/CVE-2019-11043](https://github.com/fairyming/CVE-2019-11043)

**漏洞详情:** [CVE-2019-11043](https://nvd.nist.gov/vuln/detail/CVE-2019-11043)