## CVE-2021-3493-Ubuntu OverlayFS 本地提权

**漏洞编号:** CVE-2021-3493

**漏洞类型:** 本地提权

**影响应用:** Linux Kernel (OverlayFS)

**危害等级:** 高危，可从普通用户提权至root

**影响版本:** Ubuntu kernels: 5.8.0-50.56 (5.8 kernel), 5.4.0-72.80 (5.4 kernel), 4.15.0-142.146 (4.15 kernel), 4.4.0-209.241 (4.4 kernel)

**利用条件:** 需要运行在存在漏洞的Ubuntu内核版本上，启用非特权用户命名空间和允许非特权 overlay mounts。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-3493是Ubuntu内核OverlayFS实现中的一个权限提升漏洞。由于overlayfs在用户命名空间中没有正确验证底层文件系统中文件功能设置，攻击者可以利用非特权用户命名空间和Ubuntu内核中的非特权overlay挂载补丁，获取提升的权限。

**漏洞利用方式：**

1.  **环境准备：** 在存在漏洞的Ubuntu内核上，确保启用非特权用户命名空间。漏洞库信息提到禁用非特权用户命名空间可以作为缓解措施，所以要确保启用。
2.  **创建OverlayFS结构：** PoC代码首先创建必要的目录结构（lower, upper, work, merge）用于 overlayfs 文件系统。
3.  **创建用户命名空间：** 使用`unshare`系统调用创建一个新的用户命名空间。这允许在新的命名空间中拥有不同的用户ID和组ID映射。
4.  **设置UID/GID映射：** 将当前用户的UID和GID映射到新命名空间中的root用户 (UID 0 和 GID 0)。
5.  **挂载OverlayFS：** 使用`mount`系统调用将 overlayfs 文件系统挂载到 merge 目录。指定 lowerdir, upperdir 和 workdir。
6.  **复制自身并设置Capabilities：** 将自身可执行文件复制到 overlayfs 的 merge 目录，然后使用`setxattr`设置`security.capability`扩展属性，赋予该文件 root 权限。
7.  **执行提权后的程序：** 通过执行 upper 目录下的可执行文件（之前复制并设置了 capabilities 的文件）来获取 root 权限。这个程序会检查是否有"shell"参数，如果没有，则会重新执行自身，但这次会带有`shell`参数，从而触发`setuid(0)`和`setgid(0)`，最终执行`/bin/bash`，获得 root shell。

**投毒风险分析：**

代码中存在一定的投毒风险，虽然主要逻辑是利用漏洞进行提权，但存在修改`/bin/bash`的可能性，但是经过代码分析以及漏洞原理，判断漏洞利用过程中没有修改`/bin/bash`操作,代码中风险主要存在于以下几点:

1.  **依赖外部二进制文件：** 该漏洞利用依赖于系统上的`/bin/bash`。如果攻击者替换或篡改了目标系统上的`/bin/bash`，可能会导致意外的行为或安全问题。
2.  **清理操作风险：** 代码开始时使用`system(buf)`执行`rm -rf '%s/'`，如果`DIR_BASE`被恶意修改，可能导致意外的文件删除。
3.  **不完善的错误处理：** 虽然 PoC 代码包含了一些错误处理，但在某些情况下，如果错误处理不当，可能会导致拒绝服务或未定义的行为。

总体而言，该 PoC 代码的投毒风险较低，主要风险在于依赖外部二进制文件和潜在的清理操作风险。代码本身主要是为了演示漏洞利用，并未发现明显的恶意代码。 评估投毒风险为10%。


**项目地址:** [cyberx-1/OverlayFS-CVE-2021-3493](https://github.com/cyberx-1/OverlayFS-CVE-2021-3493)

**漏洞详情:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)