## CVE-2025-24016 - Wazuh Server RCE

**漏洞编号:** CVE-2025-24016

**漏洞类型:** 远程代码执行

**影响应用:** Wazuh

**危害等级:** 高危，可能导致服务器完全控制

**影响版本:** >= 4.4.0, < 4.9.1

**利用条件:** 需要API访问权限 (可能通过弱口令，集群内部攻击或受损的agent)

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

该漏洞是由于Wazuh服务器在处理DistributedAPI请求时，使用了不安全的JSON反序列化`as_wazuh_object`函数，导致攻击者可以注入恶意Python代码。攻击者通过构造包含`__unhandled_exc__`字段的恶意JSON数据，该字段指向`os.system`类，从而执行任意系统命令。POC代码通过构造这样的payload，利用bash反弹shell到攻击者指定的IP地址和端口。 

**利用方式：**

1.  攻击者需要拥有Wazuh API的访问权限。 这可能通过多种方式实现：
    *   爆破或利用默认弱口令
    *   如果Wazuh服务器在集群环境中，攻击者可能控制了集群中的其他服务器，并通过集群内部网络进行攻击。
    *   攻击者可能通过入侵Wazuh Agent，并使用Agent连接到服务器。
2.  攻击者构造包含恶意`__unhandled_exc__`的JSON数据，并将其作为DAPI请求发送到Wazuh服务器的API端点（例如`/security/user/authenticate/run_as`）。
3.  服务器在反序列化JSON数据时，会调用`os.system`执行攻击者提供的bash命令，反弹shell到攻击者。

**投毒风险分析：**

代码存在一定投毒风险，主要是因为以下几点：

1.  **自定义Header:** POC中存在`X-Header-Name: Custom-Header`，虽然目前没有实际危害，但可能被用于后续投毒利用，例如配合中间人攻击。
2.  **Proxy配置:** 存在使用代理的选项，可能诱导用户配置恶意代理，从而窃取凭据或者植入恶意代码。
3.  **配置文件读取:**  虽然POC里没有使用config-file，但如果允许用户自定义配置文件，可能存在读取恶意配置文件的风险。
4.  **代码结构复杂性:** 代码为了增加易读性和可配置性，引入了一些函数和参数，这会增加代码的复杂性，可能隐藏恶意逻辑。

总的来说，POC主要目的是演示漏洞，但存在一些可以被利用进行恶意行为的潜在风险，但相对较低。风险点主要集中在用户配置和自定义header上。


**项目地址:** [guinea-offensive-security/Wazuh-RCE](https://github.com/guinea-offensive-security/Wazuh-RCE)

**漏洞详情:** [CVE-2025-24016](https://nvd.nist.gov/vuln/detail/CVE-2025-24016)