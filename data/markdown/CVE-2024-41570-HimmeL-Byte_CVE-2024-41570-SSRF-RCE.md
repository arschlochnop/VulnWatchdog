## CVE-2024-41570-Havoc-C2-SSRF

**漏洞编号:** CVE-2024-41570

**漏洞类型:** 服务器端请求伪造 (SSRF)

**影响应用:** Havoc C2

**危害等级:** 高危，允许未授权的攻击者从团队服务器发送任意网络流量，可能导致内网信息泄露、远程代码执行等。

**影响版本:** 0.7

**利用条件:** Havoc C2 团队服务器监听端口对外开放

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-41570 是 Havoc C2 0.7 版本中存在的一个未经身份验证的服务器端请求伪造（SSRF）漏洞。攻击者可以利用此漏洞，通过精心构造的请求，使 Havoc C2 团队服务器向任意目标发起请求。\n\n**利用方式：**\n
1.  **Agent 注册 (绕过身份验证)**：攻击者通过发送恶意的 agent 注册请求，模拟一个 demon 代理。该注册流程可以绕过原有的身份验证机制。\n2.  **Socket 操作 (SSRF 触发)**：注册成功后，攻击者可以利用该“代理”发起 socket 操作，例如打开 socket，写入数据，从 socket 读取数据。攻击者通过控制目标地址和端口，使团队服务器向指定目标（如内网服务）发起连接。\n3.  **数据交互**:  可以通过 socket 写入任意数据，实现对内网服务的攻击，读取 socket 可以获得请求的结果，实现内网信息收集等功能。\n
**POC 分析：**\n
提供的 POC 代码 (`exploit.py`) 主要包含以下功能：\n
*   **加密/解密：** 使用 AES 加密算法与团队服务器进行通信。\n*   **Agent 注册：** 伪造 agent 注册信息，绕过身份验证。\n*   **Socket 操作：**  实现打开 socket (`open_socket`)、写入 socket (`write_socket`)、读取 socket (`read_socket`) 等操作。\n*   **利用流程：**脚本首先注册一个恶意的 agent，然后使用 `open_socket` 函数在 teamserver 上打开一个socket，并使用`write_socket`函数向该socket写入数据，从而触发 SSRF 漏洞\n\n**投毒风险分析：**\n
查看 `README.md` 文件, 脚本给出的payload执行方式为`python3 exploit.py --target https://10.10.11.49/ -i 127.0.0.1 -p 40056`, 其中 `-i` 指定了目标机器的ip地址，`-p` 指定了目标机器的端口号，可以向该ip发送任意请求\n
`exploit.py` 脚本中存在以下潜在的投毒风险：\n
*   **硬编码/可控参数：** 脚本中包含多个硬编码的参数，如 agent_id，command等，这些参数如果被恶意修改，可能会导致利用失败或其他未知问题。不过脚本提供`-i`和`-p`参数，可以修改攻击的目标ip和端口，实现恶意的攻击。\n*   **依赖库：**  脚本依赖 `requests` 和 `pycryptodome` 库。如果这些库被恶意篡改，可能会导致安全问题。\n*  **后门代码:**  未发现明显的后门代码，但考虑到代码逻辑的复杂性，以及可能存在的隐藏漏洞，仍然存在一定的投毒风险。`print(agent_header + header_data)`暴露请求，有助于分析流量，但是也可能在调试时泄露信息。  `urllib3.disable_warnings()` 会忽略SSL证书验证，若目标存在中间人攻击，可能存在风险。\n
综合考虑，此POC代码存在一定的投毒风险，但主要集中在参数可控，以及依赖库的安全性上。实际使用时，需要仔细审查代码，并确保依赖库的来源可信。

**项目地址:** [HimmeL-Byte/CVE-2024-41570-SSRF-RCE](https://github.com/HimmeL-Byte/CVE-2024-41570-SSRF-RCE)

**漏洞详情:** [CVE-2024-41570](https://nvd.nist.gov/vuln/detail/CVE-2024-41570)