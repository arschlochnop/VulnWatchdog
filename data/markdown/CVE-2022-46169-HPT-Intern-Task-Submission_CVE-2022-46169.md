## CVE-2022-46169 - Cacti 未授权远程代码执行

**漏洞编号:** CVE-2022-46169

**漏洞类型:** 命令注入

**影响应用:** Cacti

**危害等级:** 严重，未经身份验证的远程代码执行

**影响版本:** < 1.2.23

**利用条件:** 目标Cacti实例必须存在action类型为POLLER_ACTION_SCRIPT_PHP (2)的 poller_item配置。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2022-46169是Cacti 1.2.23之前版本中存在的一个未经身份验证的远程代码执行漏洞。该漏洞利用链包括身份验证绕过和命令注入两部分。

**利用方式：**

1.  **身份验证绕过：**  攻击者通过构造包含`Forwarded-For: <TARGETIP>`头的HTTP请求，其中`<TARGETIP>`为Cacti服务器的IP地址。`get_client_addr()` 函数会读取 `Forwarded-For` 头部，导致服务器错误地将攻击者识别为自身。因为Cacti默认会在poller表中添加自身hostname, 因此导致认证绕过。
2.  **命令注入：**  绕过身份验证后，攻击者可以调用`remote_agent.php`的`polldata`动作。该动作调用 `poll_for_data` 函数，该函数从请求参数中获取 `$poller_id`，此参数未经过滤直接拼接到 `proc_open` 函数的参数中，导致命令注入。攻击者需要提供一个`host_id`和`local_data_id`，并且对应poller_item的action必须是`POLLER_ACTION_SCRIPT_PHP`(值为2)才能触发命令注入.

**有效性：**

提供的POC代码（docker-compose.yaml）用于搭建存在漏洞的Cacti环境，方便漏洞分析和复现。漏洞原理描述清晰，利用方式明确。综合漏洞描述和搜索引擎结果，该漏洞利用的有效性高。

**投毒风险：**

虽然POC的主要目的是演示和分析漏洞，但存在一定的投毒风险。docker-compose.yaml 文件中使用了镜像 `smcline06/cacti`，如果该镜像被篡改，可能包含恶意代码。此外，提供的教程包含大量图片链接，这些链接如果指向恶意网站，也可能存在风险。综合考虑，评估投毒风险为10%。

**项目地址:** [HPT-Intern-Task-Submission/CVE-2022-46169](https://github.com/HPT-Intern-Task-Submission/CVE-2022-46169)

**漏洞详情:** [CVE-2022-46169](https://nvd.nist.gov/vuln/detail/CVE-2022-46169)