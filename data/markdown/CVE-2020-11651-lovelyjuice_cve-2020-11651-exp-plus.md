## CVE-2020-11651/CVE-2020-11652 SaltStack 身份验证绕过和任意文件读取/写入漏洞

**漏洞编号:** CVE-2020-11651

**漏洞类型:** 身份验证绕过/任意文件读取/写入

**影响应用:** SaltStack Salt

**危害等级:** 高危，可导致服务器完全控制

**影响版本:** < 2019.2.4, < 3000.2

**利用条件:** 需要网络访问Salt Master的4505/4506端口

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2020-11651 允许未经身份验证的攻击者调用 `ClearFuncs` 类中的某些方法，利用这些方法可以检索用户令牌或者在Salt Minion上执行任意命令。提供的POC代码通过 `_prep_auth_info` 方法尝试绕过身份验证，并获取 root 用户的 key，此key在后续的CVE-2020-11652利用中会被使用。

CVE-2020-11652 允许使用通过CVE-2020-11651获得的root key读取和写入Salt Master服务器上的任意文件。提供的POC代码尝试利用 `file_roots.read` 读取敏感文件，例如token文件。同时，POC也尝试使用 `file_roots.write` 写入文件到 `/tmp` 目录，验证写入权限。

**利用方式：**

1.  **身份验证绕过：**  利用CVE-2020-11651绕过Salt Master的身份验证。
2.  **获取Root Key：**  通过未授权的 `_prep_auth_info` 方法获取Root Key。
3.  **任意文件读取：**  使用Root Key和 `file_roots.read` 方法读取Salt Master上的敏感文件。
4.  **任意文件写入：**  使用Root Key和 `file_roots.write` 方法在Salt Master上写入任意文件，实现远程代码执行。

**投毒风险分析：**

该POC代码主要用于漏洞验证，但存在一定的投毒风险。例如，代码中删除了原始的版本检查逻辑，可能导致用户在已修复的系统上误判为存在漏洞，从而执行不必要的操作。另外，虽然代码本身没有明显的恶意行为，但攻击者可以修改POC，在成功利用漏洞后植入后门或执行其他恶意操作。

**投毒风险评估：**

*   **可能性：**  POC代码修改自现有脚本，作者可能在修改过程中引入恶意代码或逻辑。虽然表面上是为了方便使用，但存在潜在风险。
*   **影响：**  如果POC被修改为包含恶意代码，可能导致目标系统被植入后门，长期受控于攻击者。

**建议：**

*   使用POC时，务必从可信来源获取，并仔细审查代码，确保没有恶意行为。
*   在非生产环境中进行POC验证，避免对生产系统造成影响。
*   及时更新SaltStack到最新版本，修复漏洞。

**项目地址:** [lovelyjuice/cve-2020-11651-exp-plus](https://github.com/lovelyjuice/cve-2020-11651-exp-plus)

**漏洞详情:** [CVE-2020-11651](https://nvd.nist.gov/vuln/detail/CVE-2020-11651)