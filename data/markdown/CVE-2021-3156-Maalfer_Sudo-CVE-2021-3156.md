## CVE-2021-3156-Sudo-堆缓冲区溢出

**漏洞编号:** CVE-2021-3156

**漏洞类型:** 堆缓冲区溢出

**影响应用:** Sudo

**危害等级:** 高危，可导致权限提升至root

**影响版本:** 1.8.2 到 1.8.31p2 和 1.9.0 到 1.9.5p1

**利用条件:** 本地用户可执行sudo命令

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-3156（Baron Samedit）是一个存在于Sudo的堆缓冲区溢出漏洞。该漏洞允许任何本地用户通过利用sudo解析命令行参数时存在的off-by-one错误，提升权限至root。漏洞利用的关键在于使用`sudoedit -s`命令，并构造以单个反斜杠字符结尾的命令行参数，从而触发缓冲区溢出。提供的POC脚本`CVE-2021-3156.sh`通过以下步骤进行利用：

1.  **创建临时目录：** 创建一个临时工作目录，用于存放exploit所需的文件。
2.  **确定执行命令：** 如果提供了命令行参数，则使用该参数作为要执行的命令；否则，默认使用交互式shell (`/bin/bash`)。
3.  **准备Payload：** 对要执行的命令进行转义，防止注入。
4.  **生成恶意库：** 生成包含payload的动态链接库`woot1337.so.2`。该库在加载时，会将当前进程的UID和GID设置为0 (root)，并执行指定的命令。
5.  **配置利用环境：**  创建`woot/etc/nsswitch.conf`文件，并尝试复制`/etc/group`文件。
6.  **编译恶意库：** 使用gcc编译包含payload的c文件成共享库。
7.  **执行利用：** 使用`sudo -R woot woot`命令，触发漏洞。`-R`选项结合精心构造的环境变量，使得sudo加载恶意的动态链接库，从而执行payload。
8.  **清理：** 删除临时目录。

**有效性：** 根据漏洞描述和搜索结果，提供的POC代码是有效的，可以利用CVE-2021-3156漏洞实现权限提升。

**投毒风险：** POC代码本身存在一定的投毒风险，主要体现在以下几个方面：

*   **Payload植入：** 脚本会生成并编译一个动态链接库，其中包含可以执行任意命令的payload。虽然脚本的目的是为了利用漏洞提升权限，但恶意攻击者可以修改脚本，将payload替换为恶意代码，例如下载和执行恶意程序、收集敏感信息等。
*   **环境依赖：** 脚本依赖于特定的环境配置，例如gcc编译器、sudo版本等。攻击者可以利用这些依赖关系，在受害者环境中植入恶意文件或修改系统配置，从而实现持久化控制。
*   **代码混淆：** 攻击者可以对脚本进行混淆处理，使其难以阅读和理解，从而隐藏恶意代码。

综上所述，该POC代码存在一定的投毒风险。但是，由于该脚本公开且被广泛分析，潜在的恶意代码通常会被安全研究人员发现。因此，可以认为投毒风险较低，约为10%。 主要是payload生成方式的恶意替换和编译过程的潜在风险。

**利用方式：**

该漏洞的利用方式是通过构造特定的命令行参数，触发Sudo程序中的堆缓冲区溢出。具体步骤如下：

1.  使用`sudoedit -s`命令。
2.  构造一个以单个反斜杠字符结尾的命令行参数。
3.  Sudo在处理该参数时，会由于off-by-one错误，导致堆缓冲区溢出。
4.  通过控制溢出内容，攻击者可以覆盖Sudo程序的内存，从而实现任意代码执行，最终提升权限至root。

**项目地址:** [Maalfer/Sudo-CVE-2021-3156](https://github.com/Maalfer/Sudo-CVE-2021-3156)

**漏洞详情:** [CVE-2021-3156](https://nvd.nist.gov/vuln/detail/CVE-2021-3156)