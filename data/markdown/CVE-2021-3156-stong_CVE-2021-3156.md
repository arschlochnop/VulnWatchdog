## CVE-2021-3156 - Sudo Heap-Based Buffer Overflow

**漏洞编号:** CVE-2021-3156

**漏洞类型:** Heap-Based Buffer Overflow

**影响应用:** Sudo

**危害等级:** 高危，允许本地用户提升权限至 root

**影响版本:** < 1.9.5p2

**利用条件:** 本地用户能够执行 sudo 命令

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2021-3156，又名 Baron Samedit，是一个存在于 Sudo 1.9.5p2 之前版本的堆缓冲区溢出漏洞。该漏洞允许未经授权的本地用户通过 `sudoedit -s` 命令以及一个以单反斜杠字符结尾的命令行参数来提升权限至 root。

**漏洞利用有效性：**

根据漏洞库信息和搜索结果，该漏洞是真实存在的，并且已经有公开的利用代码（POC）。搜索结果中的多个链接都指向了漏洞分析、利用方法和检测手段。根据提供的POC代码，该漏洞利用是有效的。POC代码已经被成功测试在Ubuntu 18.04和20.04上。

**投毒风险分析：**

分析提供的POC代码，投毒风险较低，约为5%。原因如下：

*   **代码功能明确：**  `exploit.c` 的代码目的是利用堆缓冲区溢出漏洞，通过覆盖内存来修改 `/etc/passwd` 文件，从而将当前用户的 UID 修改为 0，实现权限提升。虽然修改`/etc/passwd`具有破坏性，但是符合漏洞利用预期。
*   **依赖文件：**  该利用需要提供一个`fakepasswd`文件，这要求攻击者必须首先复制`/etc/passwd`并修改其中的用户ID。该步骤相对来说风险可控.
*   **RACE_SLEEP_TIME:**  代码中存在 `RACE_SLEEP_TIME` 参数，表明利用过程可能存在竞争条件，需要在不同系统上进行调整，这增加了利用的复杂性。
*   **免责声明：**  `LICENSE` 文件包含了明确的免责声明，表明作者不承担任何责任。虽然这不能完全排除投毒风险，但一定程度上说明作者的意图。

尽管风险较低，仍然需要注意：

*   **依赖性：**  POC 依赖特定的环境配置和文件，如果环境不匹配，可能导致利用失败或系统不稳定。
*   **潜在破坏：**  即使没有恶意代码，成功的利用本身也会修改系统文件，造成潜在的破坏。

**漏洞利用方式：**

1.  **准备工作：**
    *   复制 `/etc/passwd` 文件并命名为 `fakepasswd`。
    *   修改 `fakepasswd` 文件，将目标用户的 UID 修改为 0。
    *   编译 `exploit.c` 文件：`gcc exploit.c`
2.  **执行利用：**
    *   执行编译后的程序，并传入目标文件（通常是 `/etc/passwd`）和修改后的 `fakepasswd` 文件作为参数：`./a.out /etc/passwd fakepasswd`
    *   可能需要调整 `RACE_SLEEP_TIME` 参数以适应不同的系统。
3.  **权限提升：**
    *   成功利用后，重新登录或使用 `su` 命令切换到目标用户，即可获得 root 权限。

**总结：**

该漏洞是高危漏洞，利用方式相对简单，POC 可用。虽然投毒风险较低，但仍然需要谨慎使用，并在测试环境中进行验证。利用成功后可获得 root 权限。

**项目地址:** [stong/CVE-2021-3156](https://github.com/stong/CVE-2021-3156)

**漏洞详情:** [CVE-2021-3156](https://nvd.nist.gov/vuln/detail/CVE-2021-3156)