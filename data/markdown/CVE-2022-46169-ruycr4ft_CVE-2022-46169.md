## CVE-2022-46169-Cacti-命令注入

**漏洞编号:** CVE-2022-46169

**漏洞类型:** 命令注入

**影响应用:** Cacti

**危害等级:** 高危，允许未经身份验证的远程代码执行

**影响版本:** < 1.2.23

**利用条件:** 需要目标系统上存在具有`POLLER_ACTION_SCRIPT_PHP` action类型的poller_item配置，并且能够通过伪造HTTP头绕过身份验证。

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2022-46169是一个存在于Cacti 1.2.23之前版本中的未经身份验证的命令注入漏洞。该漏洞存在于`remote_agent.php`文件中。攻击者可以通过伪造`X-Forwarded-For`等HTTP头来绕过身份验证，利用`get_client_addr`函数的缺陷，使其返回运行Cacti服务器的IP地址。然后，通过`polldata` action，攻击者可以控制`poller_id`参数，由于该参数未经过滤就被传递给`proc_open`函数执行，从而导致命令注入。PoC代码首先检查目标是否易受攻击，然后通过暴力破解`host_id`和`local_data_ids`来找到具有`POLLER_ACTION_SCRIPT_PHP` action的`poller_item`。 找到有效的`host_id`和`local_data_ids`后，将构造包含恶意payload的URL并发送到目标系统。攻击者可以利用此漏洞在目标服务器上执行任意命令，例如下载恶意软件或窃取敏感数据。

**投毒风险分析：**

PoC代码主要功能是利用漏洞，但存在轻微的投毒风险：

1.  **Payload来源：** PoC代码要求用户输入IP地址和端口，然后生成反向shell的payload。如果用户不小心输入了错误的IP地址或端口，可能会导致连接到错误的服务器，或者暴露自己的IP地址。
2.  **依赖外部资源：** PoC依赖于`requests`和`urllib.parse`库，这些库可能存在安全问题或被篡改，但可能性较低。
3.  **Payload执行环境：** 生成的payload在目标服务器上执行，如果目标服务器的安全配置不当，可能会被恶意利用。
4.  **代码可读性：** 代码相对清晰，没有明显的恶意行为，但仍然需要仔细审查。

总体来说，PoC代码的投毒风险较低，主要是由于用户输入和执行环境带来的风险。如果代码是从可信来源获取，并且用户仔细审查过代码，那么风险可以忽略不计。

**项目地址:** [ruycr4ft/CVE-2022-46169](https://github.com/ruycr4ft/CVE-2022-46169)

**漏洞详情:** [CVE-2022-46169](https://nvd.nist.gov/vuln/detail/CVE-2022-46169)