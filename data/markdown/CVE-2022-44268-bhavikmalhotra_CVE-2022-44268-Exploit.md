## CVE-2022-44268-ImageMagick-任意文件读取

**漏洞编号:** CVE-2022-44268

**漏洞类型:** 任意文件读取

**影响应用:** ImageMagick

**危害等级:** 高危，可能导致敏感信息泄露

**影响版本:** <= 7.1.0-49

**利用条件:** 需要目标系统安装存在漏洞的ImageMagick版本，并且ImageMagick进程具有读取目标文件的权限

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2022-44268是ImageMagick中的一个信息泄露漏洞。当ImageMagick解析PNG图像时（例如，为了调整大小），生成的图像可能会嵌入任意文件的内容（如果magick二进制文件具有读取该文件的权限）。

**有效性：** 提供的PoC代码是有效的。从搜索引擎结果来看，多个安全厂商和漏洞库都确认了此漏洞的存在，并且提供了相关的漏洞描述和修复建议。PoC代码利用`pngcrush`命令将目标文件的内容嵌入到PNG图像的文本块中，然后上传到服务器。服务器使用存在漏洞的ImageMagick版本处理该图像，导致目标文件的内容被提取出来。最后，PoC代码从ImageMagick的输出中提取嵌入的内容，并进行解码以显示读取的文件内容。

**投毒风险：** 此仓库存在一定的投毒风险，约10%。

*   **README.md:**  该文件包含有关漏洞利用的信息，并建议用户编辑`mal_file`变量。虽然这是一个标准做法，但如果用户不小心使用了错误的`mal_file`值，可能会导致意外的文件读取。虽然这是用户错误,但是可能被利用. *   **lfi.py:**  该脚本包含一些需要用户修改的变量（例如，`mal_file`和`cmd`变量）。虽然这些变量是合法的，但恶意攻击者可能会修改这些变量，然后将其发送给不知情的用户。如果用户执行被篡改的脚本，可能会导致意外的文件读取或命令执行。同时上传文件的URL是写死的，有可能会被不法分子劫持。

尽管存在上述风险，但总体而言，该仓库中的代码相对简单且易于理解，因此，隐藏恶意代码的可能性较低。因此判断投毒风险为10%.

**利用方式：**

1.  **构造恶意PNG图像：** 使用`pngcrush`工具，将要读取的目标文件内容嵌入到PNG图像的文本块中。PoC代码中使用了`-text a 'profile' {args.file} {args.image}`命令来实现这一点。
2.  **上传恶意PNG图像：** 将构造好的PNG图像上传到目标服务器。目标服务器需要使用存在漏洞的ImageMagick版本来处理上传的图像。PoC代码使用`requests.post`方法来上传图像。
3.  **触发漏洞：** 当ImageMagick处理恶意PNG图像时，它会将嵌入的文件内容提取出来，并将其包含在图像的元数据中。
4.  **提取文件内容：** PoC代码使用`magick identify -verbose image.png`命令来获取图像的元数据。然后，它从元数据中提取嵌入的文件内容，并进行解码以显示读取的文件内容。

**项目地址:** [bhavikmalhotra/CVE-2022-44268-Exploit](https://github.com/bhavikmalhotra/CVE-2022-44268-Exploit)

**漏洞详情:** [CVE-2022-44268](https://nvd.nist.gov/vuln/detail/CVE-2022-44268)