## CVE-2023-46604 Apache ActiveMQ RCE

**漏洞编号:** CVE-2023-46604

**漏洞类型:** 远程代码执行

**影响应用:** Apache ActiveMQ

**危害等级:** 高危，可导致完全控制服务器

**影响版本:** < 5.18.3, < 5.17.6, < 5.16.7, < 5.15.16

**利用条件:** 需要网络访问ActiveMQ broker或者client

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2023-46604 是 Apache ActiveMQ 中 Java OpenWire 协议marshaller的一个远程代码执行漏洞。攻击者可以通过操纵 OpenWire 协议中的序列化类类型，使客户端或broker实例化classpath上的任何类，从而执行任意shell命令。

**有效性：**
根据漏洞库信息和搜索引擎结果，此漏洞已被广泛利用，有实际的攻击案例，例如被Kinsing恶意软件利用。提供的POC代码（ActiveMQ-Exploit）声称支持不出网利用和自定义字节码执行，以及目标版本自动判断，且在网上存在多个相似的exp, 因此该POC代码很可能有效。

**投毒风险：**
分析提供的POC代码，主要包含以下文件：
*   README.md 和 README.zh-CN.md: 描述了漏洞和工具的使用方法。
*   pom.xml: Maven 依赖文件，包含 activemq-client, spring-context, activemq-broker, javassist, permit-reflect, activemq-shiro, commons-beanutils 等依赖项。
*   Exp.java: 包含一个名为 xml 的字符串，该字符串看起来像一个 Spring Bean 定义，可能用于触发反序列化漏洞。

由于POM依赖中包含`javassist`用于动态字节码修改, `permit-reflect` 用于绕过反射限制, `spring-context`则提供了`exp.xml`文件,  作者可以通过字节码修改来执行恶意代码，或者通过修改exp.xml的内容植入恶意bean，从而实现攻击。但提供的代码片段不足以完全确定是否存在投毒行为, 因此存在一定的投毒风险，估计为10%。需要注意的是，POC本身就可能包含恶意代码，但这不属于“投毒”，而是POC的正常组成部分。

**利用方式：**
1.  攻击者利用OpenWire协议，发送特制的序列化数据。
2.  ActiveMQ broker或者client在反序列化这些数据时，由于存在漏洞，会尝试实例化攻击者指定的类。
3.  如果攻击者指定的类存在于classpath中，并且能够执行恶意代码（例如，通过静态代码块或者构造函数），那么攻击者就可以实现远程代码执行。
4. POC工具利用Shiro框架的特性或Spring框架的XML配置漏洞等方式，在不出网的情况下实现命令执行回显，或者直接加载恶意字节码执行。

**总结：**
CVE-2023-46604是一个严重的安全漏洞，利用门槛较低，影响范围较广。建议尽快升级到安全版本。

**项目地址:** [Arlenhiack/ActiveMQ-RCE-Exploit](https://github.com/Arlenhiack/ActiveMQ-RCE-Exploit)

**漏洞详情:** [CVE-2023-46604](https://nvd.nist.gov/vuln/detail/CVE-2023-46604)