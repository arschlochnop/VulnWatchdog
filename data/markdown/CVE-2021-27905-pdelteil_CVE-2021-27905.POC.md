## CVE-2021-27905 Apache Solr SSRF漏洞

**漏洞编号:** CVE-2021-27905

**漏洞类型:** SSRF (Server-Side Request Forgery)

**影响应用:** Apache Solr

**危害等级:** 高危，可能导致敏感信息泄露、内网探测、甚至远程代码执行（取决于目标内网环境）

**影响版本:** < 8.8.2

**利用条件:** 需要Solr实例开启ReplicationHandler且可被外部访问，并存在可利用的协议（例如 file://, http://等）

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-27905是Apache Solr的一个SSRF漏洞，存在于ReplicationHandler组件中。该组件允许通过`masterUrl`或`leaderUrl`参数指定另一个Solr核心进行索引数据复制。漏洞原因是Solr未对这些参数进行充分的SSRF防护检查，导致攻击者可以控制这些URL，发起服务器端请求。

**有效性评估：**

根据提供的POC代码，该代码通过`traverse.sh`脚本利用`file://`协议读取服务器上的文件。脚本首先构造一个包含`stream.url=file://$START`的请求，发送到Solr的`/replication`端点（或其他配置的ReplicationHandler端点）。然后，脚本解析Solr的响应，根据响应状态码判断是否成功读取文件。如果状态码为0，脚本继续解析响应内容，根据`stream`参数中空格的数量判断是文件内容还是目录列表。如果是目录列表，脚本会递归地调用`callCurl`函数，继续读取子目录下的文件。

**投毒风险评估：**

`traverse.sh`脚本本身的功能是读取文件内容，并没有发现直接执行恶意代码或者篡改数据的行为。但存在以下风险：

1.  **依赖域名变量:** 脚本依赖于变量`DOMAIN`，如果攻击者能控制该变量，可能会导致脚本尝试连接到恶意的Solr服务器，从而受到攻击。
2.  **信息泄露:**  遍历服务器文件系统，可能导致敏感信息（例如配置文件、密钥等）泄露。脚本本身会将文件内容输出到控制台。
3.  **资源消耗:**  递归地读取目录可能导致大量的HTTP请求，消耗服务器资源。

基于以上分析，认为该POC代码存在一定的投毒风险，主要体现在利用方式上可能导致信息泄露和资源消耗，以及通过`DOMAIN`变量引入的潜在风险。但是并没有发现恶意后门代码，因此投毒风险较低，评估为10%。

**利用方式总结：**

1.  **确定目标Solr版本小于8.8.2。**
2.  **找到ReplicationHandler端点。** 默认情况下是`/replication`，但可能被配置为其他值。
3.  **使用`masterUrl`或`leaderUrl`参数，构造包含恶意URL的请求。** 例如`masterUrl=file:///etc/passwd`。
4.  **发送请求到ReplicationHandler端点。**
5.  **如果成功，Solr服务器将尝试读取`/etc/passwd`文件，并将内容包含在响应中。** 攻击者可以分析响应，提取文件内容。
6.  **利用`traverse.sh`脚本可以递归遍历整个文件系统，从而进一步扩大攻击面。**
7.  **利用file协议读取文件内容，或者利用http(s)协议探测内网服务。**

**项目地址:** [pdelteil/CVE-2021-27905.POC](https://github.com/pdelteil/CVE-2021-27905.POC)

**漏洞详情:** [CVE-2021-27905](https://nvd.nist.gov/vuln/detail/CVE-2021-27905)