## CVE-2021-43798 Grafana 目录遍历漏洞

**漏洞编号:** CVE-2021-43798

**漏洞类型:** 目录遍历

**影响应用:** Grafana

**危害等级:** 高危，可能导致敏感信息泄露

**影响版本:** >= 8.0.0, < 8.0.7; >= 8.1.0, < 8.1.8; >= 8.2.0, < 8.2.7; = 8.3.0

**利用条件:** 需要Grafana服务可访问，且版本在受影响范围内。

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2021-43798 是 Grafana 8.0.0-beta1 到 8.3.0 版本（不包括已修复的版本）中的一个目录遍历漏洞。该漏洞允许未经身份验证的攻击者通过 `public/plugins/<plugin_id>/` 路径读取服务器上的任意文件。根据漏洞库信息和搜索结果，该漏洞影响多个 Grafana 版本，并且存在公开的 PoC 代码。

**有效性：**
提供的 PoC 代码 `grafanaExp` 看起来功能完善，包括自动检测漏洞、枚举插件、提取密钥以及解密数据库文件等功能。它支持通过 HTTP(S) 协议进行攻击，并能绕过一些 Nginx 配置。该 PoC 代码的存在证明了该漏洞的可利用性。

**投毒风险：**
在评估投毒风险时，需要考虑以下几点：
*   **代码功能：** 该 PoC 代码主要用于读取文件和提取配置信息。虽然具有一定的攻击性，但主要集中在信息泄露方面，没有直接执行恶意代码的功能。
*   **作者声明：** 代码包含“本程序应仅用于授权的安全测试与研究目的”的声明，这表明作者可能不希望该代码被用于恶意目的。
*   **潜在风险：** 攻击者可能会利用该 PoC 代码读取敏感信息（如数据库凭据）并进一步攻击系统。因此，使用该 PoC 代码需要谨慎，并确保在授权环境下进行。

综合来看，该 PoC 代码的投毒风险较低，但仍然存在被滥用的可能性。主要集中在信息泄露，进而导致更严重的安全问题。我给出的投毒风险概率为5%，主要是考虑到被用于非授权环境的可能性。

**利用方式：**
1.  **确定目标 Grafana 版本：** 通过访问 Grafana 实例或查看其版本信息，确定其是否在受影响的范围内。
2.  **枚举插件：** 使用 PoC 代码或手动构造 URL (`<grafana_host_url>/public/plugins/<plugin_id>/`)，尝试访问不同的插件目录，以确认哪些插件已安装。
3.  **读取任意文件：** 利用目录遍历漏洞，构造包含 `../` 的 URL，读取服务器上的任意文件。例如，读取 `/etc/passwd` 或 Grafana 的配置文件。
4.  **提取密钥：** 从 Grafana 的配置文件中提取 `secret_key`，用于解密数据库。
5.  **解密数据库：** 使用提取的 `secret_key` 和 PoC 代码，解密 Grafana 的数据库文件，获取数据源信息（如数据库连接字符串）。
6.  **横向渗透：** 利用获取的数据库连接信息，尝试访问其他系统或数据库，进行横向渗透。

总而言之，该漏洞利用简单，危害较大。建议受影响的用户尽快升级到安全版本。

**项目地址:** [A-D-Team/grafanaExp](https://github.com/A-D-Team/grafanaExp)

**漏洞详情:** [CVE-2021-43798](https://nvd.nist.gov/vuln/detail/CVE-2021-43798)