## CVE-2021-26855 Microsoft Exchange Server 远程代码执行漏洞 (ProxyLogon)

**漏洞编号:** CVE-2021-26855

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Microsoft Exchange Server

**危害等级:** 严重，未经验证的远程攻击者可以利用此漏洞在受影响的系统上执行任意代码

**影响版本:** 受影响版本包括 Exchange Server 2013 Cumulative Update 22 和 23, Exchange Server 2016 Cumulative Update 12-19, Exchange Server 2019 Cumulative Update 1-8

**利用条件:** 目标系统存在未修补的 Exchange Server 实例，攻击者需要能够通过网络访问 Exchange 服务器。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-26855 是 Microsoft Exchange Server 中的一个服务器端请求伪造 (SSRF) 漏洞。攻击者可以利用此漏洞发送任意 HTTP 请求并伪装成 Exchange 服务器进行身份验证，为后续利用其他漏洞（例如 CVE-2021-26857）创造条件。漏洞利用链通常涉及以下步骤：

1.  **SSRF (CVE-2021-26855):** 利用 SSRF 漏洞绕过身份验证，获取 Exchange 服务器的权限。
2.  **不安全的反序列化:** 通过 SSRF 漏洞获取的权限，进一步利用不安全的反序列化漏洞（例如 CVE-2021-26854, CVE-2021-26857, CVE-2021-27065）执行任意代码。

提供的 PoC 代码是一个修改后的 ProxyLogon 漏洞利用脚本，它利用 CVE-2021-26855 绕过身份验证，然后在服务器上创建一个后门 Web shell。具体流程如下：

1.  **自动发现 (Autodiscover):** 使用 Autodiscover 协议获取 LegacyDN。
2.  **MAPI 连接:** 使用获取的 LegacyDN 建立 MAPI 连接，模拟管理员权限。
3.  **Web Shell 写入:**  将包含反向 shell 代码的 aspx Web shell 写入到服务器的 `Program Files\Microsoft\Exchange Server\V15\FrontEnd\HttpProxy\owa\auth\test11.aspx` 路径。
4.  **执行 Web Shell:** 攻击者可以通过访问该 Web shell 执行任意命令。该 Web shell 执行 Powershell 命令，建立一个反向 TCP 连接到攻击者的指定 IP 地址和端口。 

**有效性：** 该 PoC 代码有效，因为它实现了 ProxyLogon 漏洞利用，并成功创建反向 shell，证明了远程代码执行。

**投毒风险：** 存在一定的投毒风险。作者在原始PoC基础上修改了代码，增加了创建用户和反向shell的功能，该行为可能被攻击者利用，如果攻击者修改了反向shell中的IP地址和端口，则使用者在不知情的情况下连接到攻击者的服务器，所以存在投毒风险。 风险大约在10%。

**利用方式：** 攻击者首先利用 CVE-2021-26855 漏洞绕过身份验证，获取 Exchange 服务器的权限，然后通过写入 Web shell 执行任意代码。这个 Web shell 会连接到攻击者控制的服务器，从而允许攻击者完全控制受感染的 Exchange 服务器。

**项目地址:** [glen-pearson/ProxyLogon-CVE-2021-26855](https://github.com/glen-pearson/ProxyLogon-CVE-2021-26855)

**漏洞详情:** [CVE-2021-26855](https://nvd.nist.gov/vuln/detail/CVE-2021-26855)