## CVE-2017-5638 - Apache Struts2 S2-045

**漏洞编号:** CVE-2017-5638

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Apache Struts2

**危害等级:** 高危，可导致远程代码执行，服务器完全控制

**影响版本:** 2.3.x before 2.3.32, 2.5.x before 2.5.10.1

**利用条件:** 目标系统运行存在漏洞的Apache Struts2版本，且允许外部访问。

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2017-5638（也称为S2-045）是Apache Struts 2中的一个远程代码执行漏洞。该漏洞源于Jakarta Multipart parser在处理文件上传时的异常处理和错误消息生成不当。攻击者可以通过构造恶意的Content-Type、Content-Disposition或Content-Length HTTP头来执行任意命令。

**有效性：**
根据漏洞库信息、搜索结果以及提供的PoC代码，此漏洞是有效的。搜索结果中包含了大量关于CVE-2017-5638的分析、利用和修复信息，表明这是一个真实且影响广泛的漏洞。PoC代码的存在进一步证实了其可利用性。

**投毒风险：**
提供的PoC代码本身就是利用该漏洞的脚本。要确定是否存在投毒风险，需要检查代码中是否存在恶意行为，例如下载和执行其他文件、篡改系统配置等。检查了给定的struts2_S2-045.py代码，它主要功能是构造payload执行命令，并没有发现明显的恶意投毒代码。虽然该代码可以用来执行任意命令，但这本身就是漏洞利用的目的，而不是额外添加的恶意功能。考虑到README.md文件极其简单，整个仓库并没有其他可疑文件，因此投毒风险较低，给出的估计值为5%。

**利用方式：**
1.  **漏洞触发：** 漏洞存在于Jakarta Multipart parser处理HTTP请求头时。具体来说，当Struts2应用程序尝试解析包含恶意表达式的Content-Type头时，会导致OGNL表达式执行。
2.  **Payload构造：** 攻击者构造包含OGNL表达式的Content-Type头。该表达式利用Struts2的OGNL机制来绕过安全限制，并执行任意命令。
3.  **命令执行：** OGNL表达式首先获取对`OgnlContext`的引用，然后绕过默认的成员访问限制。接着，它使用`java.lang.ProcessBuilder`类来执行指定的命令。PoC中包含了针对Windows和Linux系统的不同命令执行方式。
4.  **结果返回：** 执行命令的结果通过`ServletActionContext.getResponse().getOutputStream()`获取输出流，并将命令执行的结果写入到HTTP响应中，返回给攻击者。

简单来说，利用方式就是通过精心构造的HTTP请求头，向存在漏洞的Struts2应用程序发送恶意payload，从而在服务器上执行任意命令。

**项目地址:** [colorblindpentester/CVE-2017-5638](https://github.com/colorblindpentester/CVE-2017-5638)

**漏洞详情:** [CVE-2017-5638](https://nvd.nist.gov/vuln/detail/CVE-2017-5638)