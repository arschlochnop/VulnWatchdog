## CVE-2020-11651 SaltStack 认证绕过及远程代码执行

**漏洞编号:** CVE-2020-11651

**漏洞类型:** 认证绕过/远程代码执行

**影响应用:** SaltStack Salt

**危害等级:** 极高，可导致完全控制 Salt Master 和 Minion

**影响版本:** 2019.2.4 之前和 3000.2 之前的版本

**利用条件:** 攻击者能够连接到 Salt Master 的请求服务器端口 (默认 4506)

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2020-11651 漏洞存在于 SaltStack Salt 中，由于 salt-master 进程的 ClearFuncs 类没有正确验证方法调用，导致未经身份验证的远程用户可以访问某些方法。利用此漏洞，攻击者可以从 Salt Master 检索用户令牌，并在 Salt Minion 上执行任意命令。根据漏洞描述、搜索结果以及提供的漏洞利用代码，可以得出以下结论：

**有效性：**
提供的 POC 代码 (`jasperla/CVE-2020-11651-poc` 和 `AppCheck` 提供的工具) 旨在利用 CVE-2020-11651 和 CVE-2020-11652。搜索引擎结果中也有许多提及该漏洞和 PoC 的信息，包括 Rapid7 的漏洞数据库条目，以及针对 Cisco 产品的安全公告。这些信息表明，该漏洞是真实存在的，并且存在可用的 PoC 代码，因此，提供的 POC 代码很可能是有效的。

**投毒风险：**
分析提供的漏洞利用代码（AppCheck 的 `salt_rce_scanner.py` 相关文件）：

*   代码包含一个 MIT 许可证，表明作者声明了代码的版权和使用条款。
*   `README.txt` 文件详细描述了该工具的功能、安装和使用方法。
*   该工具包含两种检测方法：令牌泄露和远程代码执行（通过 DNS 查询进行带外验证）。
*   `README.txt` 中提到了 AppCheck Sentinel，用于带外检测远程代码执行。

代码中存在通过DNS查询AppCheck Sentinel服务器来验证命令执行的功能,这意味着AppCheck可以获取目标服务器的信息。虽然这不是传统意义上的“投毒”，但存在一定的安全和隐私风险，因为目标服务器的信息可能会被泄露给AppCheck。假设投毒是指作者故意在POC中隐藏恶意代码，此POC的投毒风险为10%，主要风险点在于收集目标信息。

**利用方式：**
根据漏洞信息和 PoC 代码描述，利用方式如下：

1.  攻击者连接到 Salt Master 的 4506 端口。
2.  攻击者利用 ClearFuncs 类中缺少身份验证的漏洞，调用未经授权的方法。
3.  攻击者可以通过未授权的方法检索 Salt Master 上的用户令牌。
4.  攻击者可以使用检索到的令牌在 Salt Minion 上执行任意命令。

AppCheck 提供的 POC 代码提供了两种利用方式：

*   **令牌泄露：** 尝试读取 Salt root 令牌。
*   **远程代码执行：** 通过执行 `nslookup` 命令触发 DNS 查询，来验证远程代码执行是否成功。

**项目地址:** [appcheck-ng/salt-rce-scanner-CVE-2020-11651-CVE-2020-11652](https://github.com/appcheck-ng/salt-rce-scanner-CVE-2020-11651-CVE-2020-11652)

**漏洞详情:** [CVE-2020-11651](https://nvd.nist.gov/vuln/detail/CVE-2020-11651)