## CVE-2016-5195 - Dirty COW

**漏洞编号:** CVE-2016-5195

**漏洞类型:** 权限提升

**影响应用:** Linux Kernel

**危害等级:** 高危，本地用户可以提升权限至root

**影响版本:** 2.x through 4.x before 4.8.3

**利用条件:** 本地用户权限，目标系统内核版本在受影响范围内

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2016-5195，也被称为Dirty COW，是一个Linux内核中的竞争条件漏洞。漏洞存在于`mm/gup.c`中，由于内核在处理写时复制（COW）时存在缺陷，允许本地用户利用此漏洞获得提升的权限，即使只具有只读内存映射的权限。 

**利用方式：**

1.  **利用mmap创建只读内存映射:** 攻击者首先需要找到或创建一个只读映射的文件。
2.  **使用pthread并发执行:** 攻击者会并发地使用`madvise`系统调用尝试释放映射的内存页，同时使用`proc/self/mem`接口写入这些内存页。
3.  **竞争条件:**  由于并发执行，`madvise`尝试释放内存页和`proc/self/mem`写入之间会产生竞争条件。如果`madvise`成功释放了内存页，而`proc/self/mem`仍然尝试写入，那么写入操作将绕过只读保护。
4.  **权限提升:** 通过覆盖只读内存区域，攻击者可以修改如`/etc/passwd`或`/etc/group`等系统文件，从而添加用户到`sudo`组或直接修改root用户的密码，以此获得root权限。

**POC有效性：**

提供的POC代码通过Vagrant和Docker创建了一个易受攻击的环境，并演示了如何利用Dirty COW漏洞将用户添加到sudo组。

**投毒风险分析：**

尽管POC代码旨在演示漏洞，但仍然存在潜在的投毒风险。以下是一些考虑因素：

*   **`nginx-docker` AppArmor配置:** 这个配置试图限制docker容器的权限.看似是在增加安全性,但是规则过于复杂,可能会存在绕过的风险,如果利用,存在一定的风险.
*   **`servers.yaml`中的shell命令：** 在`servers.yaml`中，存在执行任意shell命令的配置。攻击者可能会在这些命令中插入恶意代码，例如下载并执行恶意脚本、植入后门等。

总体来说，该仓库的投毒风险较低，主要集中在`servers.yaml` 中的shell命令，以及看似增加安全性,但是规则过于复杂的`nginx-docker` AppArmor配置，因为它们允许执行任意代码或绕过沙箱。

**项目地址:** [zakariamaaraki/Dirty-COW-CVE-2016-5195-](https://github.com/zakariamaaraki/Dirty-COW-CVE-2016-5195-)

**漏洞详情:** [CVE-2016-5195](https://nvd.nist.gov/vuln/detail/CVE-2016-5195)