## CVE-2023-27372 SPIP RCE

**漏洞编号:** CVE-2023-27372

**漏洞类型:** 远程代码执行

**影响应用:** SPIP

**危害等级:** 高危，可完全控制服务器

**影响版本:** < 4.2.1 (受影响版本包括3.2.18之前, 4.0.10之前, 4.1.8之前)

**利用条件:** 目标SPIP站点存在且可访问spip_pass页面，不需要任何权限

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2023-27372 漏洞存在于 SPIP 4.2.1 之前的版本，允许未经身份验证的远程攻击者通过 `spip.php?page=spip_pass` 页面的 form values 执行任意代码。该漏洞源于 `ecrire/balise/formulaire_.php` 文件中 `protege_champ` 函数对序列化数据处理不当，未进行充分的输入验证，导致反序列化漏洞。

**有效性：**
根据提供的漏洞信息、搜索引擎结果和漏洞利用代码，该漏洞是有效的。Packet Storm Security 和 GitHub (Chocapikk/CVE-2023-27372) 都提供了漏洞利用代码或扫描器，证明该漏洞是可以被利用的。POC 代码通过构造恶意的序列化字符串，并将其作为 `oubli` 参数的值发送到 `spip.php?page=spip_pass` 页面，从而触发反序列化漏洞。

**投毒风险：**
分析提供的 PoC 代码 (`cve-2023-27372.py`)，未发现明显的投毒代码。该脚本的主要功能是：

1.  获取 CSRF token (如果存在)。
2.  构造包含恶意 PHP 代码的序列化 payload，该代码使用 `exec` 函数执行命令。
3.  将 payload 发送到目标 SPIP 站点。
4.  解析响应，提取命令执行结果。

脚本本身没有执行任何与目标系统无关的操作，例如上传恶意文件、修改系统配置或连接到外部服务器。因此，投毒风险较低。

**利用方式：**

1.  **定位目标:**  确定存在漏洞的 SPIP 站点，版本低于 4.2.1，且允许公共访问 `spip.php?page=spip_pass` 页面。
2.  **获取 CSRF Token (如果需要):** 访问 `spip.php?page=spip_pass` 页面，提取 CSRF token (`formulaire_action_args`)。有些情况下，可能不需要 CSRF token。
3.  **构造 Payload:**  构造包含恶意 PHP 代码的序列化字符串，用于执行任意命令。例如，使用 `<?php system($_GET['cmd']); ?>` 来执行 GET 请求中的 `cmd` 参数指定的命令。
4.  **发送 Payload:**  将构造的 Payload 作为 `oubli` 参数的值，通过 POST 请求发送到 `spip.php?page=spip_pass` 页面，同时附带 CSRF token (如果需要)。
5.  **执行命令:**  如果 Payload 成功执行，则可以通过构造特定的 HTTP 请求来执行任意命令。例如，访问 `spip.php?page=spip_pass&cmd=whoami` 来执行 `whoami` 命令，获取当前用户。
6.  **交互式 Shell (POC代码)**: PoC中尝试使用`whoami`检测是否RCE成功，如果失败，PoC会尝试生成一个交互式shell。这部分代码可能存在问题，需要用户多次输入命令。

**缓解措施：**
升级到 SPIP 4.2.1 或更高版本，或者应用补丁以修复反序列化漏洞。


**项目地址:** [redboltsec/CVE-2023-27372-PoC](https://github.com/redboltsec/CVE-2023-27372-PoC)

**漏洞详情:** [CVE-2023-27372](https://nvd.nist.gov/vuln/detail/CVE-2023-27372)