## CVE-2023-38831-WinRAR代码执行

**漏洞编号:** CVE-2023-38831

**漏洞类型:** 代码执行

**影响应用:** WinRAR

**危害等级:** 高危，可导致远程代码执行

**影响版本:** < 6.23

**利用条件:** 用户需要使用存在漏洞的WinRAR版本打开特制的RAR压缩包

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2023-38831是WinRAR 6.23之前版本中的一个代码执行漏洞。该漏洞的利用方式如下：

1.  攻击者创建一个恶意的ZIP压缩包（伪装成RAR格式，后缀名为.rar）。
2.  该压缩包包含一个良性的文件（例如，document.pdf），以及一个与该良性文件同名的文件夹（例如，document.pdf）。
3.  同名文件夹中包含恶意payload（例如，一个.bat或.exe文件），命名为`document.pdfA.cmd`。
4.  用户使用存在漏洞的WinRAR版本打开该压缩包，并尝试打开良性文件（document.pdf）。
5.  由于WinRAR处理文件名的缺陷，实际上执行的是同名文件夹中的恶意payload。

**有效性：**

根据漏洞库信息、搜索引擎结果以及提供的PoC代码，可以判断该漏洞PoC有效。搜索引擎结果中多个链接表明该漏洞已被广泛利用，并且Google的威胁分析小组也分析了利用该漏洞进行的攻击活动。提供的PoC代码实现了生成恶意RAR压缩包的逻辑，进一步验证了该漏洞的可利用性。

**投毒风险：**

PoC代码本身的主要功能是生成利用CVE-2023-38831漏洞的恶意压缩包。然而，我们仍然需要评估该代码是否存在潜在的投毒风险。以下是对代码的分析：

*   **代码功能明确：** PoC代码的功能是生成特定的文件结构和内容，以触发WinRAR漏洞。代码逻辑相对简单，易于理解。
*   **输入/输出控制：** PoC代码接受三个输入参数：良性文件、Payload文件和输出文件名。这三个参数都由用户指定，PoC本身没有主动下载或执行任何其他代码的功能。
*   **潜在风险点：** `exploit.py` 脚本使用 `shutil.copyfile` 函数来复制 payload 文件到临时目录，如果payload 文件本身就是恶意的，那么这也会造成风险。此外，尽管脚本尝试确保输出文件以 `.rar` 结尾，但恶意用户可能修改此行为。
*   **间接风险：** 如果攻击者修改了提供的 `exploit.py` 脚本，添加额外的恶意功能（例如，在生成恶意压缩包后，自动上传到恶意服务器），则可能存在投毒风险。但是，这并非原始PoC代码本身的问题。

综合来看，原始PoC代码本身存在直接投毒的风险较低，我估计的投毒风险概率为 **10%**。这主要是因为恶意 payload 本身会带来风险，但 PoC 代码并没有主动引入恶意行为。

**利用方式：**

1.  准备一个良性的文件（例如，document.pdf）和一个恶意payload（例如，script.bat或malware.exe）。
2.  运行PoC脚本，指定良性文件、payload文件和输出文件名。
3.  PoC脚本生成一个恶意的RAR压缩包（实际上是ZIP格式，但后缀名为.rar）。
4.  将该恶意RAR压缩包发送给目标用户。
5.  目标用户使用存在漏洞的WinRAR版本打开该压缩包，并尝试打开良性文件。
6.  WinRAR执行同名文件夹中的恶意payload，从而实现代码执行。


**项目地址:** [kuyrathdaro/winrar-cve-2023-38831](https://github.com/kuyrathdaro/winrar-cve-2023-38831)

**漏洞详情:** [CVE-2023-38831](https://nvd.nist.gov/vuln/detail/CVE-2023-38831)