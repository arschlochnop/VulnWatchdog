## CVE-2023-21554-Microsoft Message Queuing (MSMQ) 远程代码执行漏洞

**漏洞编号:** CVE-2023-21554

**漏洞类型:** 远程代码执行

**影响应用:** Microsoft Message Queuing (MSMQ)

**危害等级:** 高危，可导致远程代码执行

**影响版本:** 受影响的Windows版本，具体版本范围参考CVE描述

**利用条件:** 目标系统开启MSMQ服务 (端口1801)，攻击者需要能够与目标端口建立TCP连接。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

根据提供的漏洞信息，CVE-2023-21554是Microsoft Message Queuing (MSMQ)服务中的一个远程代码执行漏洞。攻击者可以通过发送特制的恶意消息到MSMQ服务，从而在目标系统上执行任意代码。

**有效性评估：**
提供的POC代码的README描述，PoC成功运行的标志是`mqsvc.exe`进程崩溃。 代码通过python脚本，向目标MSMQ服务器的1801端口发送一系列数据包，包括建立连接的数据包(`establish_connection.bin`)、连接参数数据包(`connection_parameters.bin`) 和用户消息数据包(`user_message.bin`)。 根据描述以及代码逻辑，可以初步判断POC的目的是触发`mqsvc.exe` 服务的崩溃，验证漏洞的存在。

**投毒风险评估：**
代码从本地文件读取payload，并发送给目标，因此如果攻击者修改`.\data\`下的二进制文件，就可以修改payload。`poc.py`中`data[0x5e] = i`和`data[0x5f] = 0xff`被注释掉了，这表明原作者可能尝试过修改`user_message.bin`中的特定字节，但最终没有采用。投毒的风险在于，攻击者可以修改这些二进制文件来执行恶意代码，但目前看来，此仓库的投毒风险较小。因为POC本身依赖于特定二进制文件的内容来触发漏洞，如果攻击者随意修改这些文件，可能导致POC失效而不是植入后门。但是Payload文件是二进制，存在被植入后门的风险，故风险值设定为10%。

**利用方式：**
1.  攻击者扫描目标系统，发现开启了MSMQ服务(1801端口)。
2.  攻击者运行POC脚本`poc.py`，输入目标系统的IP地址。
3.  POC脚本会按照预定的顺序，将一系列二进制数据包（`establish_connection.bin`、`connection_parameters.bin`、`user_message.bin`）发送到目标系统的1801端口。
4.  如果目标系统存在CVE-2023-21554漏洞，并且payload构造得当，则MSMQ服务进程`mqsvc.exe`会崩溃。成功利用该漏洞可以执行任意代码，从而完全控制目标系统。

**项目地址:** [3tternp/CVE-2023-21554](https://github.com/3tternp/CVE-2023-21554)

**漏洞详情:** [CVE-2023-21554](https://nvd.nist.gov/vuln/detail/CVE-2023-21554)