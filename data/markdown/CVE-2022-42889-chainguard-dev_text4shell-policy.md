## CVE-2022-42889 Apache Commons Text Text4Shell RCE

**漏洞编号:** CVE-2022-42889

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Apache Commons Text

**危害等级:** 高危，允许未经授权的攻击者执行任意代码

**影响版本:** <= 1.9

**利用条件:** 应用程序使用受影响版本的 Apache Commons Text 且允许用户控制的输入传递给插值功能。

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2022-42889，又名Text4Shell，是Apache Commons Text库中的一个漏洞，该漏洞允许攻击者通过变量插值执行任意代码。当应用程序使用受影响版本（1.5 到 1.9）的库，并且允许不可信的输入传递给执行插值的函数时，就存在风险。 

**有效性分析：**

根据漏洞库信息和搜索结果，该漏洞是真实存在的，并且危害等级高，可以远程执行代码。提供的 Dockerfile 展示了如何使用包含漏洞的 commons-text-1.0.0-SNAPSHOT.jar 包构建镜像，并通过 java -jar 命令运行，这意味着该 POC 能够重现漏洞，证明其有效性。

**投毒风险分析：**

提供的代码包括一个 Dockerfile 和一个 LICENSE 文件。Dockerfile 用于构建一个包含易受攻击的Apache Commons Text库的Java应用程序镜像。LICENSE文件是标准的Apache 2.0许可协议，本身不包含恶意代码。由于Dockerfile只是部署了漏洞利用所需的易受攻击的jar包，并没有其他可疑操作，因此该仓库直接包含投毒代码的可能性较低，但存在一定的供应链风险，即如果依赖的jar包本身就被投毒，那么部署的应用也就会被投毒。综合判断，投毒的可能性评估为5%。

**利用方式：**

该漏洞的利用方式是构造包含恶意表达式的字符串，利用 Apache Commons Text 的字符串插值功能执行任意代码。具体步骤如下：

1.  确定应用程序中使用了 Apache Commons Text 库，并且版本在 1.5 到 1.9 之间。
2.  找到应用程序中允许用户控制的输入点，该输入会被传递给 Apache Commons Text 的字符串插值功能。
3.  构造包含恶意表达式的输入字符串，例如 `${script:javascript:java.lang.Runtime.getRuntime().exec('evil command')}`。其中，`script` 前缀指示使用 javax.script 引擎执行代码。其他的利用方式还包括使用 `dns` 和 `url` 前缀。
4.  将构造的恶意字符串发送给应用程序。
5.  应用程序使用 Apache Commons Text 进行字符串插值时，会执行恶意表达式，从而导致远程代码执行。

**修复建议：**

升级到 Apache Commons Text 1.10.0 或更高版本。该版本默认禁用了有风险的插值器。

**项目地址:** [chainguard-dev/text4shell-policy](https://github.com/chainguard-dev/text4shell-policy)

**漏洞详情:** [CVE-2022-42889](https://nvd.nist.gov/vuln/detail/CVE-2022-42889)