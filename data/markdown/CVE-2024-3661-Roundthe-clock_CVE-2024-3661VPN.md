## CVE-2024-3661 TunnelVision VPN绕过

**漏洞编号:** CVE-2024-3661

**漏洞类型:** VPN绕过

**影响应用:** DHCP客户端

**危害等级:** 高危，可能导致VPN保护失效，流量泄露，数据被窃取或篡改

**影响版本:** 受影响的DHCP客户端

**利用条件:** 攻击者需与目标客户端处于同一局域网，能够发送伪造的DHCP消息。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-3661，又名TunnelVision，是一个利用DHCP协议的漏洞，允许攻击者在与目标VPN客户端相同的本地网络上，通过发送特制的DHCP响应来绕过VPN隧道。攻击者利用DHCP的classless static route选项（Option 121）向客户端注入恶意路由，将客户端本应通过VPN传输的流量重定向到攻击者控制的网络。 

**有效性：**
提供的POC代码 `dhcp_middle_attack.py` 看起来是有效的。它通过以下方式利用此漏洞：
1.  **NetfilterQueue拦截：** 使用NetfilterQueue库拦截DHCP服务器发送给目标客户端的DHCP响应数据包。
2.  **DHCP解析与修改：** 解析拦截到的DHCP数据包，检测其类型（Offer或ACK），并检查是否已经包含攻击者注入的Option 121路由。如果未包含，则构造包含恶意路由的Option 121选项，并将其添加到DHCP响应中。
3.  **数据包转发：**  修改后的DHCP响应数据包被发送给目标客户端，而原始数据包被丢弃。客户端收到包含恶意路由的DHCP响应后，会将该路由添加到其路由表中，从而导致流量泄露。

**投毒风险：**
代码中存在一些潜在的投毒风险，虽然可能性较低，但需要关注。
*   **外部依赖：** 代码依赖于`NetfilterQueue`和`scapy`库，这些库本身可能存在安全问题，如果被植入恶意代码，可能导致攻击者执行任意代码。
*   **编码的复杂性**`encode_option121` 函数存在一定的复杂性,可能存在隐藏的逻辑错误或后门,导致意外的行为.但是,该函数的功能相对明确,降低了隐藏恶意代码的可能性.
*   **自定义路由：** 攻击者可以自定义要注入的路由，这本身就是一种能力，但是如果路由设置不当，可能导致客户端网络连接中断或访问恶意网站。
*   **依赖外部条件：** 脚本需要先设置`IP转发`，设置`iptables规则`和运行`ARP欺骗`，如果这些步骤存在问题，可能会导致安全风险。同时运行这些步骤也增大了操作的复杂性,降低了普通用户使用的可能性。
*   **总体评估：** 投毒风险约为10%。

**利用方式：**
1.  **环境准备：** 攻击者需要在与目标客户端相同的局域网内，并设置好攻击环境（IP转发、iptables规则、ARP欺骗）。
2.  **运行攻击脚本：** 运行`dhcp_middle_attack.py`脚本，指定目标客户端IP地址、DHCP服务器IP地址、攻击者IP地址等参数，以及要注入的恶意路由。
3.  **流量重定向：**  当目标客户端重新获取IP地址或更新DHCP租约时，会收到包含恶意路由的DHCP响应，并将该路由添加到其路由表中。此时，客户端访问特定目标网络的流量将被重定向到攻击者控制的网络。
4.  **数据窃取/篡改：** 攻击者可以在其控制的网络上监听、截取和篡改被重定向的流量。

**项目地址:** [Roundthe-clock/CVE-2024-3661VPN](https://github.com/Roundthe-clock/CVE-2024-3661VPN)

**漏洞详情:** [CVE-2024-3661](https://nvd.nist.gov/vuln/detail/CVE-2024-3661)