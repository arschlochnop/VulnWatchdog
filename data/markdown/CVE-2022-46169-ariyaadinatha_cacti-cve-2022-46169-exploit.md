## CVE-2022-46169-Cacti-命令注入

**漏洞编号:** CVE-2022-46169

**漏洞类型:** 命令注入

**影响应用:** Cacti

**危害等级:** 高危，未经身份验证的远程命令执行

**影响版本:** < 1.2.23

**利用条件:** 需要目标Cacti实例配置了 action 类型为 POLLER_ACTION_SCRIPT_PHP (2) 的 poller_item，并且需要网络可达。

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2022-46169是Cacti 1.2.23之前的版本中的一个命令注入漏洞。该漏洞允许未经身份验证的攻击者在运行Cacti的服务器上执行任意代码。漏洞存在于`remote_agent.php`文件中，该文件可以通过发送特制的HTTP请求进行访问。攻击者可以通过操纵`X-Forwarded-For` header 绕过身份验证,然后通过 `poller_id`参数执行命令注入。PoC代码利用了这一漏洞，首先验证目标是否存在漏洞，然后暴力破解 `host_id`和 `local_data_id`。 一旦这些ID被找到，攻击者就可以构造包含恶意payload的请求，从而在服务器上执行任意命令。

**有效性:**  提供的PoC代码有效，能够成功利用漏洞实现未经身份验证的远程命令执行。

**投毒风险:**  PoC代码主要功能是漏洞利用，并没有发现明显的恶意投毒代码，例如植入后门、篡改数据等。`cacti.py`脚本的主要功能是：
1.  检测目标是否存在漏洞。
2.  爆破 `host_id` 和 `local_data_id`。
3.  执行命令注入。
代码中唯一的潜在风险点是执行命令注入的payload。如果用户在不知情的情况下使用了危险的payload，可能会对系统造成损害，但是这种风险是用户自身行为造成的，并非代码本身存在恶意。

**利用方式:**
1.  攻击者发送包含`X-Forwarded-For` header的HTTP请求到`remote_agent.php`，绕过身份验证。
2.  攻击者通过暴力破解或其它方式获取可用的 `host_id` 和 `local_data_id`，这些ID对应于`poller_item`表中 `action` 字段为 `POLLER_ACTION_SCRIPT_PHP` (2) 的记录。
3.  攻击者构造包含恶意payload的HTTP请求，通过`poller_id`参数进行命令注入，从而在服务器上执行任意命令。

**项目地址:** [ariyaadinatha/cacti-cve-2022-46169-exploit](https://github.com/ariyaadinatha/cacti-cve-2022-46169-exploit)

**漏洞详情:** [CVE-2022-46169](https://nvd.nist.gov/vuln/detail/CVE-2022-46169)