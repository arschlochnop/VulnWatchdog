## CVE-2023-38646-Metabase-RCE

**漏洞编号:** CVE-2023-38646

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Metabase

**危害等级:** 高危，无需身份验证即可远程执行任意代码

**影响版本:** < 0.46.6.1 和 < 1.46.6.1

**利用条件:** Metabase服务需要可访问，无需认证

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2023-38646 允许未经身份验证的攻击者在 Metabase 服务器上以服务器权限级别执行任意命令。漏洞存在于Metabase的setup流程中，攻击者可以利用H2数据库的特性，通过构造恶意的JDBC URL来执行任意代码。

**有效性:**
提供的POC代码看起来有效。它包含以下几个步骤：
1.  获取setup-token：POC首先尝试从`/api/session/properties`获取setup-token。这是利用漏洞的前提。从漏洞信息来看，这个接口不需要身份验证。
2.  构造Payload：POC构造一个包含恶意JDBC URL的JSON payload。该URL利用H2数据库的`CREATE TRIGGER`功能来执行任意命令。命令的执行是通过调用`java.lang.Runtime.getRuntime().exec()`实现的。POC中默认执行`touch /tmp/success`，这是一个无害的命令，用于验证漏洞的存在。
3.  发送Payload：POC将构造的payload发送到`/api/setup/validate`端点。如果服务器返回包含"Error creating or initializing trigger"的响应，则表明漏洞利用成功。

**投毒风险:**
虽然POC的主要功能是利用漏洞，但存在一些潜在的投毒风险。以下是分析：
1. **`custom_base64_encode`函数:** 这个函数存在被滥用的可能。虽然其目的是对命令进行编码，但如果用于编码恶意脚本并执行，则会产生安全问题。
2. **命令执行:** POC中使用`java.lang.Runtime.getRuntime().exec()`执行命令。这本身就很危险，因为攻击者可以执行任何命令，包括下载和执行恶意脚本。
3. **默认命令:** 虽然POC默认执行的是`touch /tmp/success`，但攻击者可以很容易地修改`-c`参数来执行任何其他命令。如果POC被分发并被缺乏经验的用户使用，他们可能会直接执行攻击者提供的恶意命令。

综合来看，投毒风险主要在于使用者可能受到恶意命令的影响。`custom_base64_encode`函数和命令执行机制也为潜在的恶意行为提供了可能性。风险评估为 10%，主要来源于使用者没有安全意识，直接执行了恶意命令，或者代码库的下载源被替换。

**利用方式:**
1.  攻击者首先向`/api/session/properties`发送GET请求以获取setup-token。
2.  然后，攻击者构造一个包含恶意JDBC URL的JSON payload。恶意JDBC URL利用H2数据库的`CREATE TRIGGER`功能来执行任意命令。具体来说，它创建一个在`INFORMATION_SCHEMA.TABLES`上触发的trigger，并在触发时执行Java代码。Java代码调用`java.lang.Runtime.getRuntime().exec()`来执行任意命令。
3.  攻击者将构造的payload发送到`/api/setup/validate`端点。
4.  如果服务器成功创建了trigger，则攻击成功，攻击者执行的命令将在服务器上执行。

**项目地址:** [CN016/Metabase-H2-CVE-2023-38646-](https://github.com/CN016/Metabase-H2-CVE-2023-38646-)

**漏洞详情:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)