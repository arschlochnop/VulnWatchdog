## CVE-2021-4034 - Polkit pkexec 本地提权

**漏洞编号:** CVE-2021-4034

**漏洞类型:** 本地提权

**影响应用:** Polkit pkexec

**危害等级:** 高危，允许普通用户获得 root 权限

**影响版本:** all (受影响版本)

**利用条件:** 目标系统存在存在漏洞的pkexec程序，且用户能够在本地执行该程序

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-4034 漏洞是 Polkit pkexec 程序中的一个本地提权漏洞。pkexec 是一个 setuid 工具，旨在允许非特权用户按照预定义的策略以特权用户身份运行命令。漏洞的根本原因是 pkexec 在处理调用参数计数时存在错误，导致其尝试将环境变量作为命令执行。

**有效性：**

提供的 POC 代码有效。漏洞库信息和搜索结果表明该漏洞已被广泛研究并存在可用的利用代码。POC 利用代码利用了 pkexec 的参数处理错误，通过构造特定的环境变量来执行恶意代码，从而实现提权。

**投毒风险：**

虽然直接的后门代码没有发现，但仍然存在一定的投毒风险。风险点在于以下几点：

*   `cve-2021-4034.sh` 脚本从远程 URL 下载利用代码。如果该 URL 被攻击者控制，则可以提供恶意代码。
*   `Makefile` 构建过程中可能存在隐蔽的恶意代码注入，尽管当前的 Makefile 看起来比较简单。
*   `pwnkit.c` 中 `execve` 执行 `/bin/sh`，如果目标系统的 `/bin/sh` 被篡改，可能导致执行恶意代码。虽然利用本身的目标是提权到 root，但如果结合其他漏洞或配置错误，也可能导致意想不到的后果。

综合评估，投毒风险为10%。

**利用方式：**

1.  **下载利用代码：** 首先，从给定的 URL 下载 `cve-2021-4034.c`, `pwnkit.c` 和 `Makefile` 文件。
2.  **编译利用代码：** 使用 `make` 命令编译 `pwnkit.c` 为动态链接库 `pwnkit.so`，并编译 `cve-2021-4034.c` 为可执行文件 `cve-2021-4034`。
3.  **构造环境变量：**  `cve-2021-4034.c` 设置特定的环境变量，包括:
    *   `pwnkit.so:.`  指定 GCONV 模块的路径。
    *   `PATH=GCONV_PATH=.`  设置 PATH 环境变量，欺骗 pkexec 从当前目录加载 GCONV 模块。
    *   `SHELL=/lol/i/do/not/exists`  设置一个不存在的 SHELL，这可能触发一些错误处理逻辑。
    *   `CHARSET=PWNKIT`  设置字符集为 PWNKIT，触发加载指定的 GCONV 模块。
    *   `GIO_USE_VFS=`  可能用于绕过某些安全限制。
4.  **执行 pkexec：**  `cve-2021-4034.c`  使用 `execve` 执行 `/usr/bin/pkexec`。 由于环境变量设置不当，pkexec 将会尝试加载恶意 GCONV 模块 `pwnkit.so`。
5.  **GCONV 模块执行：** `pwnkit.so` 中的 `gconv_init` 函数被调用，该函数设置用户 ID 和组 ID 为 0 (root)，然后执行 `/bin/sh`，从而获得 root 权限。

总之，该利用利用了 pkexec 的参数处理缺陷和 GCONV 机制，通过构造恶意环境变量来加载恶意代码，最终实现提权。

**项目地址:** [TheSermux/CVE-2021-4034](https://github.com/TheSermux/CVE-2021-4034)

**漏洞详情:** [CVE-2021-4034](https://nvd.nist.gov/vuln/detail/CVE-2021-4034)