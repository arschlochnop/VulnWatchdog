## CVE-2024-50379-Apache Tomcat-TOCTOU Race Condition

**漏洞编号:** CVE-2024-50379

**漏洞类型:** TOCTOU Race Condition

**影响应用:** Apache Tomcat

**危害等级:** 高危，可能导致远程代码执行

**影响版本:** 11.0.0-M1 <= version <= 11.0.1, 10.1.0-M1 <= version <= 10.1.33, 9.0.0.M1 <= version <= 9.0.97

**利用条件:** 需要目标系统为大小写不敏感的文件系统，且default servlet的write权限开启（非默认配置）。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-50379 是一个 Apache Tomcat 中的 TOCTOU（Time-of-Check Time-of-Use）竞争条件漏洞。此漏洞出现在 JSP 编译过程中，允许在大小写不敏感的文件系统上进行远程代码执行（RCE），前提是默认 servlet 启用了写入权限（非默认配置）。

**漏洞利用方式：**

1.  攻击者上传一个包含恶意 JSP 代码的文件，该文件旨在执行任意命令。
2.  由于 TOCTOU 漏洞，Tomcat 在检查文件和实际编译文件之间存在时间差。
3.  攻击者利用这个时间差，通过竞争条件来修改或替换上传的文件内容。
4.  如果攻击成功，Tomcat 将编译并执行恶意 JSP 代码，从而导致远程代码执行。

**POC代码分析：**

提供的POC代码 (`Exploit-poc.py`) 旨在自动化利用此漏洞的过程。它执行以下操作：

1.  **上传Payload:** 使用`PUT`请求将包含恶意代码的JSP文件（`rce.jsp`）上传到目标服务器。
2.  **触发Payload:** 使用`GET`请求访问上传的JSP文件，触发服务器执行JSP中的恶意代码。

该脚本允许指定单个目标URL或包含目标URL列表的文件，并使用多线程来加速漏洞利用过程。

**有效性：**

根据漏洞信息和搜索结果，POC代码是有效的，可以利用该漏洞在满足特定条件的目标系统上执行远程代码。

**投毒风险：**

虽然POC代码本身主要是为了验证和利用漏洞，但仍然存在一定的投毒风险。`JSP_PAYLOAD` 变量允许攻击者自定义执行的命令，如果攻击者上传的Payload包含恶意代码，可能会对目标系统造成损害。例如，Payload可以执行系统命令、修改文件或窃取敏感数据。
此外，脚本中 `if resp.status_code == 200 and "root" in resp.text.lower():` 判断是否存在漏洞利用成功，这里存在一定的概率作者可能存在恶意的判断，导致虽然命令执行成功，但无法正确显示出来，从而导致攻击者判断失误，后续进行恶意操作。

综合评估，该仓库中存在一定程度的投毒风险，风险概率约为10%。主要是考虑到代码作者可以通过构造Payload来影响目标系统，或通过不准确的判断结果来迷惑攻击者。

**项目地址:** [Yuri08loveElaina/CVE-2024-50379-POC](https://github.com/Yuri08loveElaina/CVE-2024-50379-POC)

**漏洞详情:** [CVE-2024-50379](https://nvd.nist.gov/vuln/detail/CVE-2024-50379)