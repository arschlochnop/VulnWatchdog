## CVE-2023-32233-Linux Kernel-Netfilter nf_tables Use-After-Free

**漏洞编号:** CVE-2023-32233

**漏洞类型:** Use-After-Free

**影响应用:** Linux Kernel Netfilter nf_tables

**危害等级:** 高危，本地用户可获取root权限

**影响版本:** <= 6.3.1

**利用条件:** 需要本地用户权限，目标内核版本在受影响范围内

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2023-32233 是 Linux kernel 中 Netfilter nf_tables 组件的 Use-After-Free 漏洞。该漏洞发生在处理批量请求更新 nf_tables 配置时，由于匿名集合处理不当导致。攻击者可以利用此漏洞在内核内存上执行任意读写操作，从而获得 root 权限。 

**漏洞利用有效性：**
根据漏洞库信息、搜索结果以及漏洞利用代码，该漏洞利用的有效性较高。搜索引擎结果表明，存在公开的 PoC 代码，并且已被成功利用以实现权限提升。漏洞描述中也明确指出，未授权的本地用户可以利用此漏洞获取 root 权限。

**投毒风险：**
阅读提供的漏洞利用代码片段，主要关注了利用 UAF 漏洞的原理和方法，例如通过竞争条件和内存布局来修改已释放的 `nft_set` 结构体的内容。虽然PoC代码中添加了延时操作和CPU亲和性来增加漏洞触发的概率，但这属于正常的漏洞利用手段，不属于恶意投毒。
投毒风险评估：10%。PoC的主要目的是演示漏洞的可利用性，而非植入后门或执行其他恶意操作。但是，任何未经审核的代码都存在潜在风险，建议在受控环境中测试。

**漏洞利用方式：**
1.  **构造恶意的批量请求：**  攻击者构造包含`NFT_MSG_DELRULE` (删除规则) 和 `NFT_MSG_DELSETELEM` (删除集合元素) 操作的 Netfilter nf_tables 批量请求。
2.  **触发Use-After-Free：**  `NFT_MSG_DELRULE` 操作会释放匿名 `nft_set` 结构体，而随后的 `NFT_MSG_DELSETELEM` 操作会尝试访问已释放的 `nft_set` 结构体，导致 Use-After-Free。
3.  **内存操作：**  攻击者在 `nft_set` 释放后，但在访问之前，尝试重新分配内存并写入特定值，通常是覆盖`set->ops->elemsize`。当后续代码尝试使用已释放的 `nft_set` 结构体时，例如计算偏移量，就会使用被篡改的值，导致访问到错误的内存位置。
4.  **权限提升：**  通过控制内存读写，攻击者可以覆盖内核中的关键数据结构，例如进程的权限信息，从而获得 root 权限。

**项目地址:** [Liuk3r/CVE-2023-32233](https://github.com/Liuk3r/CVE-2023-32233)

**漏洞详情:** [CVE-2023-32233](https://nvd.nist.gov/vuln/detail/CVE-2023-32233)