## CVE-2024-48990-needrestart-权限提升

**漏洞编号:** CVE-2024-48990

**漏洞类型:** 权限提升

**影响应用:** needrestart

**危害等级:** 高危，允许本地用户以root权限执行任意代码

**影响版本:** < 3.8

**利用条件:** 需要本地用户权限，目标系统安装了存在漏洞版本的needrestart

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-48990 允许本地攻击者利用 `needrestart` 在运行过程中使用攻击者控制的 `PYTHONPATH` 环境变量，导致 `needrestart` 运行恶意的 Python 代码，从而以 root 权限执行任意命令。

**漏洞利用方式：**
1.  **创建恶意 Python 环境：** 攻击者创建一个包含恶意 `__init__.so` 文件的目录，该文件在加载时会执行预定的恶意操作（例如，设置 SUID 位到 /tmp/poc，使其可以root权限执行）。
2.  **设置 PYTHONPATH：** 攻击者设置 `PYTHONPATH` 环境变量，使其指向包含恶意 `__init__.so` 文件的目录。
3.  **触发 needrestart：**  当 `needrestart` 运行时，它会扫描需要重启的服务，由于 `PYTHONPATH` 已被设置，Python 解释器会首先在恶意目录中查找模块，加载并执行恶意的 `__init__.so` 文件，从而导致以 root 权限执行任意代码。
4. **POC 代码分析:**
    *   POC代码首先编译一个C代码文件`lib.c`，该文件包含一个构造函数`init()`。当这个动态链接库被加载时，`init()`函数会被执行。如果当前进程的有效用户ID是0（即root用户），`init()`函数会将`/bin/bash`复制到`/tmp/poc`，并且设置`/tmp/poc`的SUID位。这意味着任何用户执行`/tmp/poc`都会以root权限执行。
    *   POC代码设置一个HTTP服务器，用于将编译好的恶意动态链接库`__init__.so`提供给目标机器下载。
    *   POC代码通过SSH连接到目标机器，然后执行一系列命令。
    *   首先，它创建一个目录`/tmp/malicious/importlib`，然后将下载的`__init__.so`文件放置到该目录下。
    *   然后，它创建一个Python脚本`e.py`，该脚本尝试导入`importlib`模块，并且检查`/tmp/poc`文件是否存在。如果存在，就执行它。
    *   然后，它设置`PYTHONPATH`环境变量指向`/tmp/malicious`，然后运行`e.py`脚本。
    *   然后，它运行`needrestart`命令。由于`PYTHONPATH`环境变量被设置，`needrestart`会加载恶意的`__init__.so`文件，从而导致`/tmp/poc`文件被创建。
    *   最后，它检查`/tmp/poc`文件是否存在。如果存在，就执行它，从而获得一个root shell。

**有效性：** 根据漏洞描述和提供的利用代码，该PoC应该是有效的，利用了 needrestart 对 Python 模块加载的疏忽，成功提权。

**投毒风险：**
 *  **风险分析:** 该仓库存在一定的投毒风险，虽然主要代码是为了利用漏洞，但可能包含隐藏的、未明确说明的后门。 可能性较低，因为代码做了高亮注释，代码量不大，容易审计，风险比较低。
*   **百分比评估:** 10%。 这个百分比表明存在一些隐患，但经过代码审计，发现大部分代码是漏洞利用相关，没有发现明显的恶意逻辑。


**项目地址:** [Serner77/CVE-2024-48990-Automatic-Exploit](https://github.com/Serner77/CVE-2024-48990-Automatic-Exploit)

**漏洞详情:** [CVE-2024-48990](https://nvd.nist.gov/vuln/detail/CVE-2024-48990)