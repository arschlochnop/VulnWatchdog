## CVE-2023-27997 - FortiOS/FortiProxy SSL-VPN 堆缓冲区溢出

**漏洞编号:** CVE-2023-27997

**漏洞类型:** 堆缓冲区溢出

**影响应用:** FortiOS/FortiProxy

**危害等级:** 高危，远程代码执行

**影响版本:** FortiOS: <= 7.2.4, <= 7.0.11, <= 6.4.12, <= 6.0.16; FortiProxy: <= 7.2.3, <= 7.0.9, <= 2.0.12, <= 1.2.13, <= 1.1.6

**利用条件:** 目标开启SSL-VPN服务，且可从网络访问

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2023-27997 是 FortiOS 和 FortiProxy SSL-VPN 中的一个堆缓冲区溢出漏洞。未经身份验证的远程攻击者可以通过构造特制的请求来利用此漏洞，从而执行任意代码或命令。

**有效性评估：**

*   根据提供的漏洞库信息、搜索引擎结果（特别是 BishopFox 的博客和 GitHub 仓库），以及 CISA 的已知被利用漏洞目录，此漏洞是**有效**的，并且已经被积极利用。
*   提供的漏洞利用代码 (`CVE-2023-27997-check.py`) 是一个漏洞检测工具，用于判断目标 FortiGate SSL VPN 实例是否存在 CVE-2023-27997 漏洞。 它通过发送具有不同长度的特制请求，并基于响应时间进行统计分析来推断目标是否易受攻击。

**投毒风险评估：**

*   提供的 Python 脚本 (`CVE-2023-27997-check.py`) 的主要目的是检测漏洞，而不是利用漏洞。 它通过计算请求的统计信息进行检测，并没有发现明显的恶意代码植入行为。
*  该脚本只包含标准的Python库，以及`requests`、`struct`、`hashlib`、`sys`、`os`、`re`、`urllib3`、`scipy` 和 `numpy` 这些常见的库，没有发现用于下载或执行其他恶意payload的代码。
*   虽然该工具本身用于漏洞检测，但任何网络工具都有可能被滥用。如果攻击者使用此工具扫描大量目标，可能会对网络造成一定的影响。
*   风险评估：经分析，该脚本投毒的风险较低，约为 **5%**。这个风险主要来源于工具可能被滥用，而非工具本身包含恶意代码。

**利用方式分析：**

1.  攻击者发送特制的 HTTPS 请求到 FortiGate 或 FortiProxy 设备的 SSL-VPN 接口。
2.  `CVE-2023-27997-check.py`通过构造包含`enc`参数的POST请求，该参数的内容包含一个经过特殊编码的头部以及填充数据。头部中包含了长度信息，而填充数据用于触发缓冲区溢出。
3.  `gen_enc_hdr`函数生成加密头，该函数使用 salt 值和请求长度来生成最终发送的加密头。
4.  由于SSL-VPN处理请求时存在缺陷，特制的请求会导致堆缓冲区溢出。
5.  堆缓冲区溢出允许攻击者覆盖内存中的数据，从而可能执行任意代码或命令。攻击者可能通过此漏洞获取设备控制权。

**总结：** CVE-2023-27997 是一个高危漏洞，利用难度相对较低，容易被攻击者利用。建议受影响的用户尽快升级到安全版本。


**项目地址:** [BishopFox/CVE-2023-27997-check](https://github.com/BishopFox/CVE-2023-27997-check)

**漏洞详情:** [CVE-2023-27997](https://nvd.nist.gov/vuln/detail/CVE-2023-27997)