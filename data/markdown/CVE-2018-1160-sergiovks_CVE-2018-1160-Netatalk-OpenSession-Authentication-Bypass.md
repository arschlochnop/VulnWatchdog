## CVE-2018-1160-Netatalk-OpenSession-远程代码执行

**漏洞编号:** CVE-2018-1160

**漏洞类型:** 越界写入 (Out-of-bounds Write)

**影响应用:** Netatalk

**危害等级:** 高危，允许未授权的远程攻击者执行任意代码

**影响版本:** Before 3.1.12

**利用条件:** 目标系统运行Netatalk服务，且版本低于3.1.12。攻击者需要能够与Netatalk服务建立网络连接（通常是548端口）。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2018-1160 是 Netatalk 3.1.12 之前版本中 `dsi_opensess.c` 文件存在的一个越界写入漏洞。该漏洞是由于对攻击者可控的数据缺乏边界检查导致的。远程未经验证的攻击者可以利用此漏洞来执行任意代码。

**漏洞利用分析：**

1.  **漏洞原理：**  漏洞存在于DSI OpenSession命令的处理过程中。由于Netatalk没有对会话参数进行充分的验证，攻击者可以发送特制的DSI OpenSession请求来覆盖内存中的`preauth_switch`指针。
2.  **利用方式：**
    *   攻击者首先发送一个恶意的DSI OpenSession请求，其中包含精心构造的数据，覆盖`preauth_switch`指针，使其指向攻击者控制的内存区域。
    *   `preauth_switch` 是一个函数指针表，用于在执行身份验证之前处理各种AFP (Apple Filing Protocol) 命令。覆盖这个表后，攻击者后续发送的AFP命令将执行攻击者指定的代码。
    *   根据提供的PoC，利用方式是先通过覆盖`preauth_switch`，然后通过特定AFP命令（例如`AFP_GETSRVRPARMS`，`AFP_OPENVOL`等）执行相应的操作。PoC代码展示了如何列出卷、读取文件、写入文件、删除文件等操作，这些操作本身并没有直接执行恶意代码，而是作为利用此漏洞进行进一步攻击的手段。
3.  **PoC代码有效性：**  提供的PoC代码是用Python3编写的，旨在利用CVE-2018-1160漏洞绕过Netatalk的身份验证，并执行文件系统的各种操作。从代码结构和功能来看，PoC代码实现了漏洞利用的基本流程，包括发送恶意DSI OpenSession请求覆盖`preauth_switch`指针，以及利用覆盖后的函数表执行AFP命令。PoC代码是有效的，但可能需要根据目标环境进行调整才能成功利用。
4.  **投毒风险：** 评估投毒风险需要仔细检查PoC代码是否存在恶意行为，例如植入后门、窃取信息等。PoC代码主要集中在利用越界写漏洞来修改Netatalk服务器的内存，从而绕过身份验证并执行文件系统操作。但是仍然存在一定风险。
    *   **高危函数调用：**  虽然PoC展示了文件操作，但如果通过修改`preauth_switch`指向的函数，攻击者完全可以执行任意系统命令，存在被植入后门的风险。
    *   **代码混淆或隐藏：**  PoC中是否存在不易察觉的恶意代码，例如通过base64编码或加密隐藏的shellcode。
    *   **依赖项风险：**  PoC所依赖的第三方库或模块是否存在安全漏洞或恶意代码。
    
    综合考量，PoC本身的功能是绕过认证进行文件操作，直接植入后门的代码可能性较低。如果检查后未发现明显后门代码，投毒风险较低，这里给出10%的投毒概率。需要人工进行代码审计才能更准确判断是否存在投毒行为。

**总结：**
CVE-2018-1160是一个高危漏洞，允许未经身份验证的远程攻击者在受影响的Netatalk服务器上执行任意代码。提供的PoC代码演示了如何利用此漏洞绕过身份验证并执行文件系统操作。虽然PoC的主要目的是绕过身份验证和执行文件操作，但攻击者可以进一步利用此漏洞植入后门或执行其他恶意操作。


**项目地址:** [sergiovks/CVE-2018-1160-Netatalk-OpenSession-Authentication-Bypass](https://github.com/sergiovks/CVE-2018-1160-Netatalk-OpenSession-Authentication-Bypass)

**漏洞详情:** [CVE-2018-1160](https://nvd.nist.gov/vuln/detail/CVE-2018-1160)