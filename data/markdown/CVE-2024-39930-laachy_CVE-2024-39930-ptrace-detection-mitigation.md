## CVE-2024-39930-Gogs-SSH参数注入导致远程代码执行

**漏洞编号:** CVE-2024-39930

**漏洞类型:** SSH参数注入

**影响应用:** Gogs

**危害等级:** 高危，允许认证后的攻击者远程执行代码

**影响版本:** <= 0.13.0

**利用条件:** 需要开启Gogs的内置SSH服务器，并拥有有效的Gogs用户认证。

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2024-39930 存在于Gogs 0.13.0及更早版本的内置 SSH 服务器中。攻击者可以通过打开SSH连接并发送一个恶意的 `--split-string` env 请求来利用此漏洞，从而导致远程代码执行。Windows安装不受影响。

**漏洞利用方式：**

1.  攻击者需要拥有一个有效的 Gogs 用户账号，能够通过 SSH 协议进行身份验证。
2.  通过 SSH 连接到 Gogs 服务器。
3.  在 SSH 会话中，攻击者发送一个包含恶意 `--split-string` 参数的环境变量请求。
4.  Gogs 的 SSH 服务器在处理该请求时，由于未正确过滤参数，导致参数注入。
5.  攻击者通过注入的参数执行任意代码。

**POC有效性：**

提供的代码似乎是一个 ptrace 工具，用于监控目标进程（Gogs）的 `execve` 系统调用，并在 `execve` 调用执行 `/env` 时，检查参数中是否包含 `--split-string` 或 `-S`，如果存在，则阻止执行，从而达到缓解此漏洞的目的。该代码本身并不能直接利用漏洞，而是用于动态分析或缓解。
因此，这段代码本身并不能直接验证漏洞是否存在，但可以辅助验证，或者起到一定的防御作用。

**投毒风险：**

该仓库中存在投毒代码的可能性较低，约为 5%。虽然代码使用了 ptrace，可能存在安全风险（例如，ptrace 本身如果使用不当，可能造成目标进程不稳定），但整体代码看起来是为了监控和阻止特定参数的执行。风险主要在于：
*   **潜在的拒绝服务风险：** 由于使用了ptrace，如果trace的代码本身存在缺陷可能会导致被trace的进程出现不稳定的情况。如果trace代码有死循环或其他异常情况，会导致目标进程挂起。
*   **日志泄露：** 日志文件如果配置不当，可能导致敏感信息泄露。

总而言之，代码的目的是为了缓解漏洞，但由于 ptrace 的特殊性，仍存在极低的风险。


**项目地址:** [laachy/CVE-2024-39930-ptrace-detection-mitigation](https://github.com/laachy/CVE-2024-39930-ptrace-detection-mitigation)

**漏洞详情:** [CVE-2024-39930](https://nvd.nist.gov/vuln/detail/CVE-2024-39930)