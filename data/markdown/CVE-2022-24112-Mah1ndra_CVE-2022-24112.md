## CVE-2022-24112: Apache APISIX 远程代码执行漏洞

**漏洞编号:** CVE-2022-24112

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Apache APISIX

**危害等级:** 高危，可导致服务器完全控制

**影响版本:** Apache APISIX 2.12.1之前版本，Apache APISIX 2.10.4之前版本，Apache APISIX 1.3及更早版本

**利用条件:** 默认配置的Apache APISIX（带有默认API密钥）且batch-requests插件已启用。更改了admin key或admin api端口到与数据面板不同的端口，风险会降低。

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2022-24112 漏洞是 Apache APISIX 中的一个远程代码执行漏洞。攻击者可以利用 batch-requests 插件绕过 Admin API 的 IP 限制，从而执行恶意代码。

**漏洞利用方式：**

1.  **利用 batch-requests 插件绕过 IP 限制：** batch-requests 插件存在缺陷，允许攻击者覆盖 X-REAL-IP header，从而绕过 Admin API 的 IP 访问限制。
2.  **使用默认 API 密钥：** 如果 Apache APISIX 使用默认的 API 密钥，攻击者可以直接使用该密钥访问 Admin API。
3.  **注册恶意路由：** 攻击者可以构造包含恶意 Lua 脚本的路由，并将其注册到 Apache APISIX 中。该 Lua 脚本可以执行任意命令。

**POC 分析：**

提供的 POC 代码 `apisix-exploit.go` 实现了以下步骤：

1.  **生成请求体：** `genReqBody` 函数生成包含恶意 Lua 脚本的请求体。该 Lua 脚本使用 `io.open` 函数读取指定文件（由 `-c` 参数指定，代表要执行的命令）的内容，并通过 `ngx.say` 函数输出到响应中。
2.  **注册路由：** `registerRoute` 函数使用 batch-requests 插件将恶意路由注册到 Apache APISIX 中。它通过 POST 请求发送构造的请求体到 `/apisix/batch-requests` 接口。
3.  **竞争条件（Race Condition）：** `race` 函数通过循环调用 `registerRoute` 函数，尝试注册路由。如果返回的 ContentLength 大于 500，则认为路由注册成功。这是为了应对某些情况下的注册失败，增加利用的成功率。
4.  **执行命令：** `invokeRoute` 函数调用已注册的路由，从而执行恶意 Lua 脚本。它通过 GET 请求访问之前通过 `-p` 参数指定的路径。

**投毒风险分析：**

该 POC 代码的主要功能是利用漏洞执行命令。仔细检查代码，没有发现明显的投毒行为。代码逻辑清晰，目的是为了利用漏洞进行远程命令执行。 因此，投毒风险为 0%。该工具只是为了验证漏洞，利用成功后可以通过`-c`执行恶意指令。务必在授权情况下使用。


**项目地址:** [Mah1ndra/CVE-2022-24112](https://github.com/Mah1ndra/CVE-2022-24112)

**漏洞详情:** [CVE-2022-24112](https://nvd.nist.gov/vuln/detail/CVE-2022-24112)