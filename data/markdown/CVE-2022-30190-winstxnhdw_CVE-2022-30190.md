## CVE-2022-30190 (Follina) MSDT 远程代码执行漏洞

**漏洞编号:** CVE-2022-30190

**漏洞类型:** 远程代码执行

**影响应用:** Microsoft Windows Support Diagnostic Tool (MSDT)

**危害等级:** 高危，允许攻击者在受害者系统上执行任意代码

**影响版本:** 受影响的Windows版本包括Windows 7到Windows 11以及多个Windows Server版本，具体版本范围参考漏洞库信息。

**利用条件:** 需要用户打开包含恶意代码的文档（如Word文档），或者访问包含恶意链接的网页。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2022-30190（Follina）是一个存在于Microsoft Windows Support Diagnostic Tool (MSDT) 中的远程代码执行漏洞。攻击者可以利用此漏洞，通过构造恶意的Word文档或其他方式，诱使用户打开，从而在用户系统上执行任意代码。 

**有效性评估：**

根据漏洞库信息和搜索结果，此漏洞在野外被广泛利用，POC代码的存在进一步证明了其有效性。提供的PoC代码描述了如何生成一个包含恶意链接的Word文档，当用户打开此文档时，MSDT会被调用，执行攻击者预先设定的恶意代码。

**投毒风险评估：**

分析提供的PoC代码，投毒风险较低，约为10%。主要风险点可能存在于以下几个方面：

1.  **init.py:** 该脚本用于构建恶意Word文档和初始化攻击者服务器。代码本身没有明显的恶意行为，但如果`build_payload`函数中的powershell命令被替换为更具破坏性的命令，则可能导致更严重的后果。
2.  **config.xml:** 该配置文件定义了攻击者服务器的主机名和端口。如果攻击者将此值更改为指向恶意服务器，则可能导致受害者下载和执行恶意软件。
3.  **build/href.txt:** 该文件包含用于触发漏洞的HTML代码。攻击者可能会修改此文件，以执行其他恶意操作。

但是，总体而言，提供的PoC代码主要用于演示漏洞，而不是用于传播恶意软件。 `destroy_all.bat`脚本的存在也一定程度上降低了风险，因为该脚本可以帮助用户删除所有相关文件。

**利用方式分析：**

1.  攻击者首先编辑`config.xml`，设置攻击者服务器的hostname和port。
2.  运行`dotnet publish LocalEXF`编译payload。
3.  运行`init.py`脚本，该脚本会：
    *   构建包含恶意链接的Word文档（trojan.docx）。
    *   在攻击者服务器上托管一个包含恶意Payload的HTML文件。
    *   base64 编码 PowerShell 命令。
4.  攻击者将此Word文档发送给受害者。
5.  受害者打开Word文档，MSDT会被调用，执行攻击者服务器上托管的Payload，从而在受害者系统上执行任意代码。

需要注意的是，要成功利用此漏洞，受害者需要卸载安全更新KB5016616，并且命令运行时间要短，否则会出现故障排除程序。


**项目地址:** [winstxnhdw/CVE-2022-30190](https://github.com/winstxnhdw/CVE-2022-30190)

**漏洞详情:** [CVE-2022-30190](https://nvd.nist.gov/vuln/detail/CVE-2022-30190)