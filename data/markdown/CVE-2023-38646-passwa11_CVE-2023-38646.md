## CVE-2023-38646-Metabase-远程代码执行

**漏洞编号:** CVE-2023-38646

**漏洞类型:** 远程代码执行

**影响应用:** Metabase

**危害等级:** 高危，允许未授权的攻击者在服务器上执行任意命令

**影响版本:** < 0.46.6.1, < 1.46.6.1 (及其他修复版本见漏洞库信息)

**利用条件:** 目标Metabase实例可网络访问

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2023-38646 允许未经身份验证的攻击者在 Metabase 服务器上执行任意命令。根据漏洞库信息和搜索结果，该漏洞存在于 Metabase 开源版本 0.46.6.1 之前和 Metabase 企业版本 1.46.6.1 之前的版本中。修复版本包括 0.45.4.1, 1.45.4.1, 0.44.7.1, 1.44.7.1, 0.43.7.2, 和 1.43.7.2。

**漏洞利用方式：**

1.  **获取 Setup Token：** 攻击者首先通过访问 `/api/session/properties` 端点获取 setup-token。
2.  **构造恶意 Payload：** 攻击者构造一个包含恶意命令的 JSON payload。该 payload 利用 H2 数据库的一个特性，通过创建触发器在查询 `INFORMATION_SCHEMA.TABLES` 时执行 JavaScript 代码。该 JavaScript 代码会执行 bash 命令，从而实现远程代码执行。
3.  **发送 Payload：** 攻击者将构造的 payload 发送到 `/api/setup/validate` 端点。利用代码中使用了base64编码，绕过检测。

**POC 代码有效性：**

提供的 POC 代码似乎有效，因为它实现了上述利用过程。它首先获取 setup token，然后创建一个包含反向 shell 命令的 payload，并将其发送到目标 Metabase 实例。

**投毒风险分析：**

该存储库的主要代码文件是 `exploit.py`。仔细检查此文件，没有发现明显的恶意代码或后门。该脚本的功能是利用 CVE-2023-38646 漏洞，允许远程代码执行。 但是由于该漏洞本身就可以执行恶意代码，作者如果将反弹shell的IP或者端口写死，就有可能被作者控制。
`README.md` 文件仅包含有关漏洞和使用脚本的说明。它还包含对原始漏洞发现和相关漏洞利用的 credit 链接，这表明作者没有试图隐藏脚本的目的。综合考虑，投毒的概率较低，大约为 10%。

**项目地址:** [passwa11/CVE-2023-38646](https://github.com/passwa11/CVE-2023-38646)

**漏洞详情:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)