## CVE-2023-27372-SPIP-远程代码执行

**漏洞编号:** CVE-2023-27372

**漏洞类型:** 远程代码执行

**影响应用:** SPIP

**危害等级:** 高危，可能导致服务器完全控制

**影响版本:** < 4.2.1

**利用条件:** 需要能够访问SPIP的登录页面或存在`spip_pass`页面的公开访问权限

**POC 可用性:** 是

**投毒风险:** 1%

## 详情

CVE-2023-27372是SPIP 4.2.1之前的版本中的一个远程代码执行漏洞，原因是程序在处理表单值中的序列化数据时存在缺陷。攻击者可以通过在公共区域提交包含恶意序列化数据的表单，从而执行任意代码。PoC代码显示，它首先获取一个Anti-CSRF token，然后构造一个包含PHP代码的payload，该代码会执行指定的系统命令。这个漏洞的利用方式是，攻击者先访问登录页面 (`spip.php?page=spip_pass`)，获取`formulaire_action_args`的值 (Anti-CSRF token)。然后，攻击者构造一个POST请求，其中包含`page=spip_pass`， `formulaire_action=oubli`, `formulaire_action_args`为之前获取的CSRF token的值，并且`oubli`参数的值为精心构造的PHP序列化字符串，这个序列化字符串包含要执行的PHP代码 (使用 `system()`函数执行命令)。由于SPIP在反序列化这个`oubli`参数时存在漏洞，这会导致恶意代码执行。 

**有效性:** PoC代码有效，成功利用该漏洞能够在目标服务器上执行任意命令。

**投毒风险:** 经过检查`CVE-2023-27372.py`，`CVE-2023-27372.yaml`，`Dockerfile`和`README.md`文件。没有发现明显的恶意代码或者后门。`Dockerfile`用于构建一个包含易受攻击版本SPIP的环境，用于测试和演示漏洞。`CVE-2023-27372.yaml`是一个nuclei模板，用于检测目标是否存在此漏洞，该模板尝试执行phpinfo()，证明可以执行恶意代码。`README.md`提供有关漏洞的信息。

**利用方式:**

1.  **获取Anti-CSRF Token:**  访问受影响的SPIP站点的登录页面（`spip.php?page=spip_pass`），提取`formulaire_action_args`字段的值，即Anti-CSRF token。
2.  **构造Payload:**  构造一个包含恶意PHP代码的序列化字符串，例如`s:28:"<?php system('whoami'); ?>";`。这个字符串的长度需要根据实际的PHP代码长度进行调整。
3.  **发送Payload:**  通过POST请求将构造的Payload发送到`spip.php?page=spip_pass`，同时包含Anti-CSRF token和必要的表单参数。
4.  **执行代码:**  服务器在处理请求时，由于反序列化漏洞，会执行Payload中的PHP代码，从而实现远程代码执行。

**项目地址:** [nuts7/CVE-2023-27372](https://github.com/nuts7/CVE-2023-27372)

**漏洞详情:** [CVE-2023-27372](https://nvd.nist.gov/vuln/detail/CVE-2023-27372)