## CVE-2021-1675 PrintNightmare Windows Print Spooler RCE

**漏洞编号:** CVE-2021-1675

**漏洞类型:** 远程代码执行

**影响应用:** Windows Print Spooler

**危害等级:** 高危，可导致远程代码执行，权限提升至SYSTEM

**影响版本:** 受影响的Windows版本详见漏洞库信息

**利用条件:** 需要目标系统开启Print Spooler服务，攻击者需要具有网络访问能力，可能需要经过身份验证(取决于具体利用方式)

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-1675 (PrintNightmare) 是一个Windows Print Spooler服务中的远程代码执行漏洞。根据漏洞库信息和搜索引擎结果，该漏洞影响多个Windows版本。攻击者可以通过利用`AddPrinterDriverEx`函数，上传恶意DLL文件到目标系统，从而实现远程代码执行，获得SYSTEM权限。 

**有效性:**
提供的PoC代码`CVE-2021-1675.py` 实现了利用`AddPrinterDriverEx`函数上传恶意DLL。它首先连接到目标系统的Print Spooler服务，然后构造一个`DRIVER_CONTAINER`结构，其中包含指向攻击者控制的共享目录中恶意DLL文件的路径。该PoC通过循环尝试不同的目录，增加成功利用的机会。根据搜索引擎结果和漏洞库信息，该漏洞和利用方式是被广泛证实的，该PoC代码很可能有效。

**投毒风险:**
对提供的PoC代码进行了分析，发现潜在的投毒风险较低，约为10%。主要风险在于：

*   **`pConfigFile` 字段的修改:** 代码中对 `container_info['DriverInfo']['Level2']['pConfigFile']` 的修改，可能被用于尝试加载系统关键 DLL，虽然初衷可能是绕过某些安全检查或利用已知 DLL 加载顺序，但如果利用不当或被恶意修改，可能导致系统不稳定甚至崩溃。
*   **循环尝试不同目录:** 循环尝试不同的目录可能使得攻击行为更加隐蔽。如果攻击者能够精心构造恶意DLL，并在多个目录中放置，则可能会增加攻击成功的几率，同时也增加了检测和分析的难度。
*   **依赖共享目录:**  PoC依赖于攻击者可控的共享目录，如果攻击者在共享目录中放置恶意DLL，可能会对访问该共享目录的其他用户造成威胁。此外，PoC需要在受害者机器上尝试创建一些目录，如果创建失败可能抛出异常，但是该异常被try except捕获了,不会影响PoC的执行。

上述风险相对可控，主要体现在攻击者难以在未经授权的情况下修改系统 DLL 或在受害者机器上创建任意目录。代码主体逻辑仍然是漏洞利用，而非明显的恶意行为。

**利用方式:**
1.  攻击者首先需要搭建一个SMB共享，用于存放恶意DLL文件。
2.  攻击者运行PoC脚本，指定目标系统、共享路径和（可选的）驱动程序路径。
3.  PoC脚本连接到目标系统的Print Spooler服务。
4.  PoC脚本构造一个`DRIVER_CONTAINER`结构，并将共享路径指向攻击者的SMB共享中的恶意DLL。
5.  PoC脚本调用`AddPrinterDriverEx`函数，尝试在目标系统上安装驱动程序。由于存在漏洞，目标系统会尝试从攻击者的SMB共享加载DLL文件。
6.  如果成功加载DLL，攻击者即可在目标系统上执行任意代码，获得SYSTEM权限。

**项目地址:** [edsonjt81/CVE-2021-1675](https://github.com/edsonjt81/CVE-2021-1675)

**漏洞详情:** [CVE-2021-1675](https://nvd.nist.gov/vuln/detail/CVE-2021-1675)