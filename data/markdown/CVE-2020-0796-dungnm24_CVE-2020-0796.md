## CVE-2020-0796 SMBGhost RCE

**漏洞编号:** CVE-2020-0796

**漏洞类型:** 远程代码执行

**影响应用:** Microsoft Windows SMBv3

**危害等级:** 高危，允许未经身份验证的攻击者在目标服务器上执行任意代码

**影响版本:** Windows 10 Version 1903/1909, Windows Server version 1903/1909

**利用条件:** 目标系统未打CVE-2020-0796补丁，开放445端口(SMB)

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2020-0796，又名SMBGhost，是Microsoft SMBv3协议处理特定请求时存在远程代码执行漏洞。漏洞存在于Windows 10版本1903和1909以及Windows Server版本1903和1909中。由于CVSS评分为10.0，被认为是高危漏洞，具备“蠕虫”特性，能够在网络中自我复制和传播。

**有效性评估：**
根据搜索结果和漏洞库信息，该漏洞存在可利用的POC代码，并已被CISA列入已知被利用漏洞目录中，证明其有效性。

**投毒风险分析：**
提供的POC代码主要包含以下几个部分：

1.  **SMB协商：**  `sendNegotiate`函数发送SMB协商数据包，用于建立SMB连接。
2.  **漏洞触发：** `TriggerCrash`函数构造恶意的SMB压缩数据包，通过设置错误的压缩大小来触发缓冲区溢出。
3. **提权部分:** 尝试获得 winlogon.exe 的进程控制柄， 并注入shellcode。

代码中存在一定的投毒风险，虽然主要逻辑是利用缓冲区溢出，但是注入的 shellcode 执行了打开winlogon.exe的行为。 考虑到winlogon.exe的权限，可以间接实现提升权限,恶意攻击者可能替换shellcode以实现更隐蔽或更具破坏性的行为。 该提权行为存在被替换的风险。 故存在10% 的投毒风险。

**利用方式：**

1.  **建立SMB连接：**  首先，攻击者需要与目标系统建立SMB连接，通过`sendNegotiate`函数发送SMB协商数据包。
2.  **构造恶意数据包：**  攻击者构造包含恶意压缩信息的SMBv3数据包，其中包含精心设计的`OriginalSize`和`Offset`字段，以触发缓冲区溢出。
3.  **发送恶意数据包：**  将构造好的恶意数据包发送到目标系统，触发漏洞。
4.  **代码执行：**  成功触发漏洞后，可以执行任意代码，例如下载并执行恶意程序，控制目标系统。

总而言之，该漏洞利用涉及构造畸形的SMB数据包，利用SMBv3压缩功能中的漏洞触发缓冲区溢出，并最终实现远程代码执行。虽然提供的POC具有一定风险，但主要功能是验证漏洞存在。

**项目地址:** [dungnm24/CVE-2020-0796](https://github.com/dungnm24/CVE-2020-0796)

**漏洞详情:** [CVE-2020-0796](https://nvd.nist.gov/vuln/detail/CVE-2020-0796)