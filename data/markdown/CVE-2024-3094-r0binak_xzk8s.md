## CVE-2024-3094 - XZ Utils供应链后门

**漏洞编号:** CVE-2024-3094

**漏洞类型:** 供应链后门

**影响应用:** XZ Utils

**危害等级:** 极危，可导致未授权远程SSH访问

**影响版本:** 5.6.0, 5.6.1

**利用条件:** 目标系统使用了受感染的XZ Utils版本，并且sshd服务链接了liblzma库。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-3094是XZ Utils中发现的供应链后门漏洞。攻击者通过复杂的混淆手段，将恶意代码注入到liblzma库的构建过程中。该恶意代码修改了liblzma库中的特定函数，允许攻击者绕过SSH身份验证，实现未经授权的远程访问。

**有效性：**

根据提供的Dockerfile和README.md，该PoC通过以下步骤尝试重现该漏洞：

1.  使用包含受影响XZ Utils版本的Debian镜像作为基础镜像。
2.  安装openssh-server并进行配置，允许root用户使用密码登录。
3.  复制一个打过补丁的`liblzma.so.5.6.0.patch`库到容器中。**注意：** 这里的“patched”指的是将恶意代码中的硬编码公钥替换成了其他公钥，方便漏洞验证，并非修复漏洞本身。原始漏洞中，恶意代码会尝试使用预设的密钥进行身份验证。由于原始密钥未知，因此需要使用替换后的“patched”库。
4.  通过`LD_PRELOAD`环境变量加载修改后的`liblzma.so`库。
5.  启动sshd服务。

通过使用`xzbot`等工具，攻击者可以利用该后门绕过SSH身份验证，从而获得对目标系统的未授权访问。因此，该PoC在概念上是有效的。

**投毒风险：**

该仓库中存在一定投毒风险。虽然该PoC旨在重现和验证CVE-2024-3094漏洞，但其中包含以下潜在风险：

*   **恶意补丁库：** `liblzma.so.5.6.0.patch`本身就是一个被修改过的库，虽然作者声明替换了公钥，但仍然可能包含其他的恶意代码或行为。这部分是投毒风险的主要来源。需要对这个patch文件进行详细分析才能确定是否还隐藏了其他恶意行为。
*   **Dockerfile命令执行：** Dockerfile中的`RUN`命令可以执行任意命令，存在被利用执行恶意代码的可能。
*   **镜像分发：** 如果构建的镜像被上传到公共镜像仓库，可能会被其他用户下载和使用，从而扩大了影响范围。
*   **`sed` 命令潜在风险:** 虽然Dockerfile 中的 `sed` 命令较为常见，但也需要确认是否包含任何意外的shell注入或其他恶意行为。

综合考虑，该仓库的投毒风险约为10%。大部分代码是为了复现漏洞，但`liblzma.so.5.6.0.patch`库需要谨慎分析，这是主要的风险点。

**利用方式：**

利用方式如下：

1.  目标系统运行了受影响版本的XZ Utils (5.6.0 或 5.6.1)。
2.  sshd服务链接了被篡改的liblzma库。当sshd尝试使用liblzma库进行数据压缩时，恶意代码会被激活。
3.  攻击者使用特定的SSH客户端，并在连接时发送包含特定数据的payload。该payload会被liblzma库截获并处理。
4.  恶意代码会尝试使用硬编码的密钥进行身份验证。如果验证成功，攻击者就可以绕过常规的SSH身份验证机制，以目标用户的身份登录系统，通常是root用户。

简单来说，该漏洞允许攻击者在未经授权的情况下，通过SSH远程控制受害主机。

**项目地址:** [r0binak/xzk8s](https://github.com/r0binak/xzk8s)

**漏洞详情:** [CVE-2024-3094](https://nvd.nist.gov/vuln/detail/CVE-2024-3094)