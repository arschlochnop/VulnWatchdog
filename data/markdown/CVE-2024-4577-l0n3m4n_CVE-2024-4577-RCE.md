## CVE-2024-4577 PHP CGI Argument Injection

**漏洞编号:** CVE-2024-4577

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** PHP (Windows, CGI模式)

**危害等级:** 高危，可导致远程代码执行，服务器完全控制

**影响版本:** PHP 8.1.* (< 8.1.29), 8.2.* (< 8.2.20), 8.3.* (< 8.3.8)

**利用条件:** Windows系统，PHP运行于CGI模式，系统启用了使用 "Best Fit" 策略的编码页。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-4577 是一个 PHP CGI 参数注入漏洞，存在于 Windows 平台运行于 CGI 模式下的 PHP 版本中。当系统配置为使用某些代码页时，Windows 的 "Best-Fit" 行为可能会替换传递给 Win32 API 函数的命令行参数中的字符。PHP CGI 模块错误地将这些字符解释为 PHP 选项，允许恶意用户将选项传递给 PHP 解释器，从而导致泄露源代码、执行任意 PHP 代码等。

**有效性：**
提供的PoC代码看起来有效。它通过向目标URL发送特制的请求，利用`allow_url_include`和`auto_prepend_file`这两个PHP配置项来实现远程代码执行。扫描函数检测目标是否存在漏洞，利用函数通过POST请求发送包含恶意PHP代码的文件来执行命令。

**投毒风险：**
此仓库中可能存在的投毒代码的风险较低，约为 10%。主要基于以下几点考虑：

*   **代码简洁性：** PoC 代码相对简单，易于审查，降低了隐藏恶意代码的可能性。
*   **明确的目的：** 代码的目的明确，即利用已知的漏洞，没有发现额外的、不必要的功能。
*   **作者信誉（待评估）：** 作者的信誉需要进一步验证，但从代码本身来看，没有明显的恶意行为。

尽管风险较低，仍然需要保持警惕。潜在的投毒方式可能包括：

*   **混淆代码：** 在 PHP payload 中插入难以察觉的恶意代码。
*   **依赖项：** 引入包含恶意代码的第三方库（虽然当前 PoC 没有依赖项）。

**利用方式：**
1.  攻击者首先需要确定目标系统是否满足漏洞利用的先决条件：Windows + CGI + 受影响的 PHP 版本 + 启用了 Best-Fit 编码页。
2.  攻击者构造一个包含特殊字符的 URL，该 URL 中的字符会被 Windows 的 Best-Fit 算法转换成 PHP 选项。
3.  攻击者利用 `-d allow_url_include=1 -d auto_prepend_file=php://input` 选项，允许包含远程文件，并将 POST 请求的内容作为 PHP 代码执行。
4.  攻击者通过 POST 请求发送包含恶意 PHP 代码的 payload，例如执行系统命令、读取文件等。
5.  服务器执行攻击者提供的 PHP 代码，攻击者从而获得对服务器的控制权。

**项目地址:** [l0n3m4n/CVE-2024-4577-RCE](https://github.com/l0n3m4n/CVE-2024-4577-RCE)

**漏洞详情:** [CVE-2024-4577](https://nvd.nist.gov/vuln/detail/CVE-2024-4577)