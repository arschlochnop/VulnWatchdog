## CVE-2020-0796-SMBGhost-远程代码执行

**漏洞编号:** CVE-2020-0796

**漏洞类型:** 远程代码执行

**影响应用:** Microsoft Windows SMBv3

**危害等级:** 高危，可能导致远程代码执行和系统完全控制

**影响版本:** Windows 10 Version 1903/1909 和 Windows Server, version 1903/1909 (Server Core installation)

**利用条件:** 目标系统启用SMBv3协议，且未安装安全补丁

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2020-0796，又名SMBGhost，是Microsoft SMBv3协议处理特定请求时存在远程代码执行漏洞。漏洞存在于SMBv3压缩功能中，未经身份验证的攻击者可以通过向目标SMBv3服务器发送特制的压缩数据包来触发此漏洞，造成缓冲区溢出，从而在目标系统上执行任意代码。 

**有效性评估：**
提供的POC代码（cve-2020-0796.py）通过构造恶意的SMBv3协商请求和压缩数据包，利用`Smb2CompressedTransformHeader`类中的`offset`字段溢出漏洞。
从搜索引擎的结果来看，存在多个公开可用的POC，CISA也明确指出存在可利用的POC，表明该漏洞具有较高的可利用性。

**投毒风险评估：**
该POC代码主要由以下几个类构成：
*   `Smb2Header`: 构造SMBv2协议头。
*   `Smb2NegotiateRequest`: 构造SMBv2协商请求，包含多种SMB协议版本和压缩算法上下文。
*   `NetBIOSWrapper`: 封装NetBIOS会话服务数据包。
*   `Smb2CompressedTransformHeader`: 构造恶意的SMBv3压缩转换头，关键在于`offset`字段被设置为`\xff\xff\xff\xff`，用于触发溢出。
代码逻辑相对清晰，主要用于发送特制的SMB数据包来触发漏洞。潜在的投毒风险主要在于：
1.  **隐藏的后门代码：** 代码中可能存在恶意代码，例如反弹shell或者执行其他恶意操作，但当前提供的代码片段没有发现明显的后门行为。
2.  **参数篡改：** 攻击者可能会修改目标IP等参数，将漏洞利用转向其他目标，但这并非代码本身的投毒行为。

综合来看，该POC代码的投毒风险较低，大约5%。

**利用方式：**
1.  攻击者首先向目标SMB服务器发送SMBv2协商请求，与服务器协商SMB协议版本和功能。
2.  攻击者构造一个包含恶意压缩转换头的SMB数据包，其中`Smb2CompressedTransformHeader`类的`offset`字段被设置为一个很大的负数，导致在解压缩过程中发生缓冲区溢出。
3.  攻击者将该恶意数据包发送给目标服务器，触发漏洞，导致远程代码执行。

**项目地址:** [Kaizzzo1/CVE-2020-0796](https://github.com/Kaizzzo1/CVE-2020-0796)

**漏洞详情:** [CVE-2020-0796](https://nvd.nist.gov/vuln/detail/CVE-2020-0796)