## CVE-2019-3396 - Atlassian Confluence Widget Connector 远程代码执行

**漏洞编号:** CVE-2019-3396

**漏洞类型:** 服务器端模板注入 (Server-Side Template Injection)

**影响应用:** Atlassian Confluence Server/Data Center

**危害等级:** 高危，允许未授权的远程代码执行

**影响版本:** 受影响版本：Confluence Server 6.6.12 之前的所有 6.6.x 版本；6.7.0 到 6.12.3 之前的所有 6.12.x 版本；6.13.0 到 6.13.3 之前的所有 6.13.x 版本；6.14.0 到 6.14.2 之前的所有 6.14.x 版本

**利用条件:** 需要目标Confluence实例存在Widget Connector宏且版本在受影响范围内，且允许用户编辑页面。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2019-3396 漏洞存在于 Atlassian Confluence Server 和 Data Center 的 Widget Connector 宏中，允许未经身份验证的远程攻击者通过服务器端模板注入执行任意代码。攻击者可以通过构造包含恶意 Velocity 模板代码的请求，利用 Widget Connector 宏中的漏洞执行操作系统命令。根据漏洞库信息和搜索结果，该漏洞已被广泛利用，存在多种PoC。提供的漏洞利用代码是一个用于调试和分析漏洞的开发环境搭建指南，没有直接提供可用于攻击的有效payload，但可以辅助理解漏洞原理和构建利用代码。

**有效性评估：** 漏洞有效性高，因为漏洞库信息和搜索结果均表明该漏洞已被公开披露并被广泛利用。

**投毒风险评估：** 代码仓库的主要目的是提供一个本地调试和分析漏洞的环境，而不是直接提供一个用于攻击的利用脚本。虽然不能完全排除作者在构建环境中隐藏恶意代码的可能性，但考虑到代码仓库的内容主要是配置和调试指南，直接投毒的可能性较低。因此，投毒风险估计为 10%。风险主要来自于用户在搭建调试环境的过程中可能引入的外部依赖或配置不当。

**利用方式分析：**

1.  **定位 Widget Connector 宏：** 在 Confluence 页面中插入一个 Widget Connector 宏。
2.  **构造恶意请求：**  构造包含恶意 Velocity 模板代码的请求，例如 `${Runtime.getRuntime().exec("command")}`，该代码会被服务器解析并执行。
3.  **发送请求：** 将构造好的请求发送到 Confluence 服务器。请求可能包含在 Widget Connector 宏的 URL 参数或其他相关字段中。
4.  **执行代码：** Confluence 服务器在处理包含恶意模板代码的 Widget Connector 宏时，会执行其中的代码，导致远程代码执行。

从搜索结果来看，攻击者利用该漏洞传播恶意软件（如加密货币矿工和勒索软件）的情况较为普遍。

**项目地址:** [PetrusViet/cve-2019-3396](https://github.com/PetrusViet/cve-2019-3396)

**漏洞详情:** [CVE-2019-3396](https://nvd.nist.gov/vuln/detail/CVE-2019-3396)