## CVE-2022-25845-Fastjson-反序列化漏洞

**漏洞编号:** CVE-2022-25845

**漏洞类型:** 反序列化漏洞

**影响应用:** com.alibaba:fastjson

**危害等级:** 高危，可能导致远程代码执行

**影响版本:** < 1.2.83

**利用条件:** 目标应用使用了存在漏洞的Fastjson版本，且未启用safeMode。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2022-25845 是 Alibaba Fastjson 在 1.2.83 版本之前存在的一个反序列化漏洞。攻击者可以通过绕过 AutoTypeCheck 机制，发送恶意构造的 JSON 数据，从而在目标服务器上执行任意代码。\n\n**有效性：**\n根据漏洞库信息、搜索引擎结果和提供的POC代码，该漏洞利用的有效性较高。搜索引擎结果中多篇文章表明该漏洞可以实现远程代码执行(RCE)。POC代码提供了一个完整的利用链，包含多个步骤，表明利用过程相对复杂，但可行。\n\n**投毒风险：**\n提供的POC代码主要包含以下几个部分：\n1.  `exp.py`:  主利用脚本，负责发送 payload 并协调整个攻击流程。\n2.  `payload/step1.json`, `payload/step2.json`, `payload/step3.json`, `payload/step4.json`:  不同的 JSON payload，分别用于不同的攻击阶段。\n3.  `payload/PocException.class`:  恶意 Java class 文件，用于在目标服务器上执行代码。\n查看了`LICENSE`文件，为`MIT License`较为宽松的开源协议，存在恶意投毒的概率较低。\n虽然脚本本身主要功能是漏洞利用，但在 `payload/PocException.class`中替换恶意class文件，有一定几率存在投毒风险，该恶意class文件会被上传至服务器执行，所以风险判断为10%。\n\n**利用方式：**\n该漏洞的利用方式是：\n1.  **添加 inputStream 到 fastjson 缓存:**  通过`step1.json`，将inputStream添加到缓存。\n2.  **读取目标服务器的 tomcat docbase 路径:** 通过`step2.json`利用布尔盲注的方式读取临时目录名，其中payload使用file协议读取目标服务器上的文件。\n3.  **将恶意的 class 文件写入 tomcat docbase 路径:** 通过`step3.json`，逐步写入恶意的 Java class 文件 (PocException.class) 到目标服务器的 tomcat docbase 路径下。\n4.  **恶意 class 加载:** 通过`step4.json`，触发恶意类的加载，从而执行恶意代码，导致远程代码执行。

**项目地址:** [ph0ebus/CVE-2022-25845-In-Spring](https://github.com/ph0ebus/CVE-2022-25845-In-Spring)

**漏洞详情:** [CVE-2022-25845](https://nvd.nist.gov/vuln/detail/CVE-2022-25845)