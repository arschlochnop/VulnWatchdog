## CVE-2022-46169-Cacti-命令注入

**漏洞编号:** CVE-2022-46169

**漏洞类型:** 命令注入

**影响应用:** Cacti

**危害等级:** 高危，允许未授权的远程代码执行

**影响版本:** < 1.2.23

**利用条件:** 需要目标Cacti服务器存在启用了 POLLER_ACTION_SCRIPT_PHP 的 poller_item

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2022-46169 是 Cacti 1.2.23 之前版本中的一个命令注入漏洞。未经身份验证的攻击者可以通过操纵 HTTP Header (例如 X-Forwarded-For) 绕过身份验证，并向 remote_agent.php 发送特制的请求，注入恶意命令。漏洞的根本原因是 remote_agent.php 文件中的 polldata 操作在处理 poller_id 参数时，没有进行充分的过滤，导致攻击者可以在 proc_open 函数中执行任意命令。提供的漏洞利用代码 (PricklyPwn) 使用 Go 编写，通过爆破 host_id 和 local_data_ids，构造包含恶意命令的 URL，利用该漏洞获取反向 shell。

**有效性分析：**
漏洞利用代码通过 X-Forwarded-For 头绕过认证, 并爆破`host_id`和`local_data_ids`参数，构造恶意 URL 触发命令注入。根据漏洞信息，利用代码应该是有效的。

**投毒风险分析：**
该仓库包含一个Go编写的漏洞利用程序和一个自述文件。漏洞利用程序的功能是利用 CVE-2022-46169 在 Cacti 上执行命令。Readme文件提供了有关如何使用该漏洞利用程序的信息。虽然代码本身旨在利用已知漏洞，但需要审查是否存在任何隐藏的恶意代码。
*   **main.go:** 代码逻辑清晰，主要功能是构造 Payload 并发送请求以利用漏洞。其中未发现明显的恶意代码。然而，不能完全排除代码中存在细微的后门或漏洞的可能性，例如不正确的错误处理可能导致拒绝服务。
*   **readme.md:** 自述文件只包含有关漏洞利用程序的信息，没有发现任何可疑内容。

考虑到代码主要功能是漏洞利用，但存在一定潜在风险，因此投毒风险评估为10%。

**利用方式：**
1.  攻击者首先需要找到一个存在漏洞的 Cacti 实例 (版本低于 1.2.23)。
2.  攻击者设置`X-Forwarded-For`头为 Cacti 服务器的 IP 地址来绕过身份验证。
3.  攻击者通过爆破`host_id`和`local_data_ids`参数，寻找action类型设置为`POLLER_ACTION_SCRIPT_PHP`的`poller_item`。
4.  构造包含恶意命令的 URL，将其作为 poller_id 参数的值传递给 remote_agent.php。
5.  Cacti 服务器执行恶意命令，例如启动反向 shell 连接到攻击者控制的服务器。

**项目地址:** [copyleftdev/PricklyPwn](https://github.com/copyleftdev/PricklyPwn)

**漏洞详情:** [CVE-2022-46169](https://nvd.nist.gov/vuln/detail/CVE-2022-46169)