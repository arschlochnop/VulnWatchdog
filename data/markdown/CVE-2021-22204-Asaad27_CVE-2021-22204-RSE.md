## CVE-2021-22204-ExifTool-DjVu代码执行

**漏洞编号:** CVE-2021-22204

**漏洞类型:** 代码执行

**影响应用:** ExifTool

**危害等级:** 高危，可导致远程代码执行

**影响版本:** >=7.44, <12.24

**利用条件:** 目标机器需要安装ExifTool，且使用ExifTool处理恶意DjVu文件

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-22204是ExifTool中DjVu文件解析模块的Eval注入漏洞。攻击者可以通过构造恶意的DjVu文件，将恶意代码嵌入到文件的metadata中。当ExifTool解析该文件时，会执行其中的恶意代码，从而导致远程代码执行。

**有效性分析：**
提供的POC代码包含以下文件：
* `mkdira.djvu`：用于创建目录的恶意DjVu文件。
* `reverseshell.dsed`：用于创建反向shell的metadata文件。
* `testshellcommand.dsed`：用于测试命令执行的metadata文件。
* `test.dsed`：用于执行id命令的metadata文件。
* `src/dockerfile`：用于构建包含漏洞ExifTool版本的Docker镜像，并执行POC，验证漏洞。

`dockerfile` 展示了漏洞利用的过程：先安装包含漏洞版本的 ExifTool，然后使用 `djvumake` 命令将恶意 metadata 信息嵌入到 DjVu 文件中。当 ExifTool 处理这些 DjVu 文件时， metadata 中的代码会被执行，从而实现任意命令执行。

因此，提供的POC代码是有效的。

**投毒风险分析：**
检查仓库中的文件，尤其是 `dockerfile` 和几个 `.dsed` 文件，发现 `dockerfile` 下载了官方的Exiftool源码,并无任何修改，而是正常编译安装。`mkdira.djvu`、`reverseshell.dsed` 、`testshellcommand.dsed`和`test.dsed` 这几个文件仅仅是为了验证漏洞的，`.dsed` 脚本利用了 Perl 注入，在 DjVu 文件被处理时执行。因此，该仓库主要用于演示漏洞利用，而非传播恶意软件。可能存在的投毒风险是：攻击者可能会修改`reverseshell.dsed` 脚本，将反向连接地址指向攻击者控制的服务器，当其他用户使用该POC时，可能会不小心将权限授予攻击者。考虑到这种可能性，投毒风险评定为10%。

**利用方式：**
1.  构建一个包含恶意metadata的DjVu文件。
2.  该metadata中包含Perl代码，利用`qx{}`或`${}`来执行系统命令。
3.  目标机器使用存在漏洞的ExifTool版本打开/处理该DjVu文件。
4.  ExifTool解析DjVu文件时，执行metadata中的Perl代码，从而实现任意命令执行。

由于ExifTool通常用于处理图像文件的元数据，因此攻击者可以将恶意DjVu文件伪装成图像文件，诱骗用户使用ExifTool处理，从而触发漏洞。

**项目地址:** [Asaad27/CVE-2021-22204-RSE](https://github.com/Asaad27/CVE-2021-22204-RSE)

**漏洞详情:** [CVE-2021-22204](https://nvd.nist.gov/vuln/detail/CVE-2021-22204)