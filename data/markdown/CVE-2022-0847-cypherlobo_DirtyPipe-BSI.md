## CVE-2022-0847 - Dirty Pipe 本地提权漏洞

**漏洞编号:** CVE-2022-0847

**漏洞类型:** 本地提权

**影响应用:** Linux Kernel

**危害等级:** 高危，可能导致本地权限提升至root

**影响版本:** Linux Kernel 5.8 及以后版本，修复版本之前

**利用条件:** 需要本地用户权限

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2022-0847，也被称为Dirty Pipe，是一个Linux内核中的本地权限提升漏洞。该漏洞源于pipe buffer结构中的"flags"成员未被正确初始化，可能包含过时的值。非特权本地用户可以利用此漏洞写入由只读文件支持的页面缓存中的页面，从而提升系统权限。

**有效性分析：**

提供的POC代码修改自Max Kellermann的Dirty Pipe PoC，专注于覆写`/etc/passwd`文件中的root密码字段，并在获得root shell后恢复该文件。根据漏洞库信息和搜索结果，此漏洞的PoC是有效的，并且已经被积极利用。

**投毒风险分析：**

阅读提供的代码后，没有发现明显的恶意代码，所有操作都与漏洞利用的目的相关。该代码备份`/etc/passwd`文件，修改root密码，利用漏洞提权，最后提供了恢复`/etc/passwd`的方法。因此，投毒风险评估为0%。作者说明这个PoC只是一个小修改，旨在快速方便地利用。

**漏洞利用方式：**

1.  **利用pipe机制：**  利用`pipe()`函数创建管道。
2.  **填充和清空管道：**  通过写入和读取管道来设置pipe buffer的flags。
3.  **利用未初始化的flags：**  通过在pipe buffer中添加新的buffer而不初始化其flags，来利用未初始化的flags。
4.  **打开只读文件：**  以只读方式打开目标文件（`/etc/passwd`）。
5.  **利用`splice()`或`tee()`系统调用：**  利用`copy_page_to_iter_pipe`或`push_pipe`函数，结合管道机制，将精心构造的数据写入目标文件的page cache中。
6.  **覆写文件内容：**  通过写入page cache，间接地覆写了磁盘上的文件内容，即使该文件是只读的。
7.  **权限提升：**  通过修改`/etc/passwd`文件中的root密码，攻击者可以获得root权限。
8.  **恢复文件：**  在提权后，PoC尝试恢复`/etc/passwd`，降低了攻击的可见性。

**总结：**  该漏洞利用的关键在于利用了Linux内核管道处理中的一个疏忽，允许攻击者写入只读文件支持的页面缓存，从而修改文件内容并提升权限。提供的PoC通过修改root密码实现了提权，并且提供了恢复机制，使其更加隐蔽。

**项目地址:** [cypherlobo/DirtyPipe-BSI](https://github.com/cypherlobo/DirtyPipe-BSI)

**漏洞详情:** [CVE-2022-0847](https://nvd.nist.gov/vuln/detail/CVE-2022-0847)