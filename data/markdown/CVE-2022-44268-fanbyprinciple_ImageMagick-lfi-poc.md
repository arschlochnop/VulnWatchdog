## CVE-2022-44268-ImageMagick-任意文件读取

**漏洞编号:** CVE-2022-44268

**漏洞类型:** 任意文件读取

**影响应用:** ImageMagick

**危害等级:** 高危，可能导致敏感信息泄露

**影响版本:** <= 7.1.0-49

**利用条件:** 目标服务器运行存在漏洞的ImageMagick版本，且ImageMagick进程有权读取目标文件

**POC 可用性:** 是

**投毒风险:** 1%

## 详情

CVE-2022-44268 是 ImageMagick 7.1.0-49 及之前版本中的一个信息泄露漏洞。当 ImageMagick 解析 PNG 图像（例如，为了调整大小）时，生成的图像可能会嵌入任意文件的内容（如果 ImageMagick 二进制文件具有读取该文件的权限）。

**漏洞利用方式：**

1.  **生成恶意 PNG 文件：**  使用 `magick_exploit.py` 脚本生成一个包含恶意 profile 的 PNG 文件。该脚本将目标文件的路径嵌入到 PNG 文件的文本 chunk 中。
2.  **上传恶意 PNG 文件：**  将生成的 PNG 文件上传到目标服务器。服务器需要使用存在漏洞的 ImageMagick 版本来处理该图像，例如进行缩放或其他图像处理操作。
3.  **下载处理后的图像：**  从目标服务器下载经过 ImageMagick 处理后的 PNG 文件。
4.  **提取文件内容：**  使用 `decode_profile.py` 脚本从下载的 PNG 文件中提取嵌入的文件内容。该脚本读取 PNG 文件的 verbose 信息，解析 Raw profile type字段，提取十六进制数据，并尝试将其解码为 UTF-8 字符串。如果解码失败，则将其作为二进制数据保存到文件中。

**投毒风险分析：**

该POC的主要功能是利用ImageMagick的漏洞读取文件，`magick_exploit.py`的功能是生成含有文件路径的PNG图片，`decode_profile.py`的功能是从处理后的图片中提取信息。代码逻辑相对简单，主要依赖于pillow和subprocess模块，没有发现明显的恶意代码或后门。

但是，仍然存在一些潜在的投毒风险：

*   **依赖项风险：**  `pip install pillow`可能存在依赖项被替换的风险，攻击者可能会通过篡改 pillow 包来植入恶意代码。
*   **subprocess 风险：** `magick_exploit.py`脚本使用了`subprocess.check_output`来执行`identify`命令。如果攻击者能够控制输入的文件名（`input_file`），则有可能通过命令注入执行任意代码。但是在这个POC中，`input_file`是下载下来的文件名，一般情况下文件名不会被攻击者直接控制。风险较低。
*   **decode_profile.py:** 如果目标文件不是UTF-8编码，脚本会尝试以二进制方式读取，并将数据保存到`extracted`文件。如果攻击者能够控制读取的文件路径，可能会覆盖服务器上的其他文件。
*   **脚本作者的风险:** 脚本作者可以在代码中加入不易察觉的恶意代码，例如收集用户信息或执行其他恶意操作。但是从代码结构和逻辑来看，这种可能性较低。

综合来看，该POC的投毒风险较低，但仍然需要保持警惕，特别是对于pillow这个依赖项。


**项目地址:** [fanbyprinciple/ImageMagick-lfi-poc](https://github.com/fanbyprinciple/ImageMagick-lfi-poc)

**漏洞详情:** [CVE-2022-44268](https://nvd.nist.gov/vuln/detail/CVE-2022-44268)