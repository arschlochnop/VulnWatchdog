## CVE-2022-29464-WSO2-Unrestricted File Upload

**漏洞编号:** CVE-2022-29464

**漏洞类型:** Unrestricted File Upload/Remote Code Execution

**影响应用:** WSO2 API Manager, Identity Server, Enterprise Integrator, Open Banking AM/KM

**危害等级:** 高危，未经授权的文件上传导致远程代码执行

**影响版本:** WSO2 API Manager 2.2.0 to 4.0.0, WSO2 Identity Server 5.2.0 to 5.11.0, WSO2 Enterprise Integrator 6.2.0 to 6.6.0, WSO2 Open Banking AM/KM 1.4.0 to 2.0.0

**利用条件:** 目标服务器存在fileupload endpoint，且版本在受影响范围内

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2022-29464 允许未经授权的文件上传，导致远程代码执行。攻击者利用 `/fileupload` 端点，通过 `Content-Disposition` 目录遍历序列，将恶意JSP文件上传至Web根目录下的 `repository/deployment/server/webapps` 目录，从而实现RCE。

**有效性：**

根据漏洞库信息、搜索引擎结果和提供的漏洞利用代码，可以确定该漏洞是有效的。搜索结果中多个来源确认了该漏洞的存在和利用，并给出了相应的修复建议。漏洞利用代码通过上传JSP webshell来实现远程代码执行。

**投毒风险：**

POC代码中存在一定的投毒风险的可能性，可能性估计为10%。

*   **反弹shell配置：** `reverse_jsp` 中包含硬编码的反弹shell服务器 `8.tcp.ngrok.io:12508`。虽然这可能是为了方便测试，但也可能被用于跟踪或控制利用者的行为。此IP和端口并不一定是恶意的，但是需要使用者额外注意。
*   **公钥上传：**代码中存在上传公钥的部分，用途不明，存在潜在风险。
*   **代码审查：** 漏洞利用代码本身的行为是上传JSP文件，并在目标系统上执行命令。审查发现此代码中无明显恶意逻辑，但是使用者需要进行仔细的代码审查,确认符合预期行为。

**利用方式：**

1.  **确定目标：** 找到运行受影响版本 WSO2 产品的服务器。
2.  **上传恶意文件：** 利用 `/fileupload` 端点，通过构造包含目录遍历的 `Content-Disposition` 请求，上传包含恶意代码的 JSP 文件到服务器的 `/repository/deployment/server/webapps` 目录，例如上传到 `authenticationendpoint` 目录下。
3.  **触发恶意代码：** 访问上传的 JSP 文件，触发恶意代码的执行，从而实现远程代码执行。POC代码中上传了webshell `balgo.jsp` 和反弹shell `balgorev.jsp`。
4.  **反弹shell接收:** 如果成功利用了反弹shell,需要在相应ip和端口监听,接收反弹shell连接

**项目地址:** [Chocapikk/CVE-2022-29464](https://github.com/Chocapikk/CVE-2022-29464)

**漏洞详情:** [CVE-2022-29464](https://nvd.nist.gov/vuln/detail/CVE-2022-29464)