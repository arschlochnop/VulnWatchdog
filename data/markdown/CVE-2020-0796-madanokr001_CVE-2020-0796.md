## CVE-2020-0796 SMBGhost 远程代码执行漏洞

**漏洞编号:** CVE-2020-0796

**漏洞类型:** 远程代码执行

**影响应用:** Microsoft Windows SMBv3

**危害等级:** 高危，可能导致远程代码执行

**影响版本:** Windows 10 Version 1903/1909, Windows Server version 1903/1909

**利用条件:** 目标系统开启SMBv3服务，且未安装相关补丁

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2020-0796（SMBGhost）是 Microsoft SMBv3 协议处理特定请求时存在远程代码执行漏洞。攻击者可以向易受攻击的 SMBv3 服务器发送特制的数据包来利用此漏洞。PoC代码通过构造畸形的 SMBv3 压缩请求，触发整数溢出漏洞。漏洞位于压缩数据处理过程中，特制的`OriginalCompressedSegmentSize`字段会导致后续的内存分配错误，进而可能导致缓冲区溢出，最终实现远程代码执行。

**有效性：** 根据漏洞信息和搜索结果，此漏洞的PoC代码是有效的。CISA已发布警报，表明存在可利用此漏洞的功能性PoC代码。GitHub上的PoC仓库也表明此漏洞可被成功利用。

**投毒风险：** PoC代码本身主要用于演示漏洞利用过程，用于教育和测试目的。通过阅读提供的Python代码，发现代码主要实现了SMBv2协商请求报文的构建，并利用精心构造的数据包触发漏洞。代码中没有发现明显的恶意代码或后门。README.md中包含Windows 1903的ISO下载链接，如果用户下载并安装了非官方的ISO镜像，可能存在投毒风险。此外，该利用代码可能依赖于某些特定的系统环境或库，恶意修改这些依赖可能导致拒绝服务或恶意代码执行。 因此，综合评估，认为存在10%的投毒风险，主要来自于可能存在的依赖和用户误用非官方资源。

**利用方式：**
1.  攻击者向目标系统发送特制的SMBv3协商请求，其中包含恶意的压缩信息。
2.  `OriginalCompressedSegmentSize`字段被设置为一个超大值，导致整数溢出。
3.  目标系统在处理压缩数据时，由于整数溢出，会分配一个很小的缓冲区。
4.  当实际的解压缩数据写入这个小缓冲区时，会发生缓冲区溢出，覆盖相邻的内存区域。
5.  攻击者可以通过控制溢出的数据来执行任意代码，从而获得对目标系统的控制权。

**项目地址:** [madanokr001/CVE-2020-0796](https://github.com/madanokr001/CVE-2020-0796)

**漏洞详情:** [CVE-2020-0796](https://nvd.nist.gov/vuln/detail/CVE-2020-0796)