## CVE-2021-34527 PrintNightmare

**漏洞编号:** CVE-2021-34527

**漏洞类型:** 远程代码执行

**影响应用:** Windows Print Spooler

**危害等级:** 高危，允许攻击者以SYSTEM权限执行任意代码

**影响版本:** 受影响版本见漏洞库信息

**利用条件:** 需要网络访问，且目标系统存在漏洞版本的Print Spooler服务

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-34527（PrintNightmare）是Windows Print Spooler服务中的一个远程代码执行漏洞。攻击者可以利用此漏洞在目标系统上以SYSTEM权限执行任意代码。根据漏洞库信息和搜索引擎结果，该漏洞影响多个Windows版本。提供的POC代码旨在缓解该漏洞，主要通过禁用Print Spooler服务以及拒绝驱动程序安装来实现。漏洞利用方式通常涉及向Print Spooler服务发送特制的打印请求，导致服务加载并执行恶意的DLL文件。 

**有效性：** 提供的POC代码并非漏洞利用代码，而是缓解措施，用于禁用Print Spooler服务并阻止恶意驱动程序的安装。因此，它不能用于验证漏洞的存在，而是用于降低漏洞带来的风险。

**投毒风险：** 提供的代码主要包含PowerShell脚本和CMD脚本，用于禁用Print Spooler服务和配置驱动程序安装权限。初步分析表明，代码本身没有明显的恶意行为，但存在以下潜在风险：

1.  **误用/滥用：** 如果攻击者能够控制这些脚本的执行，他们可能选择性地禁用或启用某些安全措施，从而为进一步的攻击打开方便之门。
2.  **依赖外部文件 (serverlist.txt)：** `disable-spooler.cmd`脚本依赖于`serverlist.txt`文件，如果该文件被篡改，可能导致意外的服务器被禁用Print Spooler服务，从而影响业务连续性。
3.  **权限提升：** 虽然脚本本身没有直接提权操作，但如果运行脚本的用户权限不足，可能会导致脚本执行失败，留下安全隐患。

因此，综合考虑，投毒风险较低，估计在10%左右。 主要的风险在于脚本被恶意修改或被利用进行拒绝服务攻击（禁用打印服务）。

**利用方式：**  PrintNightmare漏洞的利用方式通常涉及以下步骤：

1.  **利用未经授权的打印机驱动程序安装：** 攻击者可以使用`AddPrinterDriverEx`函数，上传并安装恶意的打印机驱动程序。
2.  **DLL注入：** 恶意的驱动程序实际上是一个DLL文件，当Print Spooler服务加载该驱动程序时，DLL中的代码会被执行，从而实现远程代码执行。
3.  **SYSTEM权限获取：** 由于Print Spooler服务以SYSTEM权限运行，因此注入的DLL代码也会以SYSTEM权限执行。

需要注意的是，微软已经发布了针对此漏洞的补丁。建议用户及时安装补丁，并采取其他缓解措施，例如禁用Print Spooler服务（如果不需要打印功能）或限制驱动程序安装权限。

**项目地址:** [Eutectico/Printnightmare](https://github.com/Eutectico/Printnightmare)

**漏洞详情:** [CVE-2021-34527](https://nvd.nist.gov/vuln/detail/CVE-2021-34527)