## CVE-2022-0492-Linux Kernel cgroup_release_agent 特权提升/容器逃逸

**漏洞编号:** CVE-2022-0492

**漏洞类型:** 特权提升/容器逃逸

**影响应用:** Linux Kernel

**危害等级:** 高危，可导致容器逃逸，控制宿主机

**影响版本:** kernel 5.17 rc3 (受影响范围可能更广，需要检查)

**利用条件:** 容器需要CAP_SYS_ADMIN capabilities 或者存在可利用的user namespaces配置

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2022-0492 漏洞存在于 Linux kernel 的 `cgroup_release_agent_write` 函数中。攻击者可以利用此漏洞，通过操纵 cgroups v1 的 `release_agent` 特性，实现权限提升和绕过命名空间隔离，最终实现容器逃逸，控制宿主机。

**漏洞利用有效性:**

根据漏洞信息和搜索结果，此漏洞是真实存在的，并且有公开的PoC代码可供利用。从提供的PoC脚本 `CVE-2022-0492.sh` 来看，脚本首先检查容器是否具有 `CAP_SYS_ADMIN` 权限，或者是否可以利用 user namespaces。如果满足其中一个条件，则脚本会尝试利用该漏洞。脚本通过挂载 cgroup 文件系统，设置 `release_agent` 路径指向一个恶意脚本，并在 cgroup 被释放时执行该脚本，从而在宿主机上执行任意命令。

**投毒风险分析:**

分析提供的PoC代码，存在一定投毒风险，占比约为10%。风险主要集中在以下几点：

*   **`payload` 变量的灵活性:**  脚本允许用户通过 `-c` 或 `--command` 参数自定义 `payload`，这使得攻击者可以方便地执行任意命令。虽然这本身是漏洞利用的一部分，但也可能被滥用，例如植入恶意后门、挖矿程序等。
*   **`exploit` 函数中的命令执行:** 脚本会生成 `/tmp/exploit.sh` 文件并执行，这个过程中，脚本会对宿主机的文件系统进行修改，存在潜在的风险。虽然脚本的目的是为了利用漏洞，但也可能被修改为执行恶意操作。
*   **检查方式的绕过:** PoC脚本只检查了 CAP_SYS_ADMIN 和 User Namespace，实际利用过程中可能存在其他方式可以触发漏洞，导致PoC成功执行，但宿主机实际上并没有受到保护。容易给使用者带来不安全感。

**利用方式:**

1.  **环境准备:** 首先，需要在存在漏洞的 Linux kernel 的容器环境中运行 PoC 脚本。
2.  **权限检查:** 脚本会检查容器是否具有 `CAP_SYS_ADMIN` 权限，或者是否可以创建和挂载 user namespaces。
3.  **漏洞利用:** 如果满足条件，脚本会创建 cgroup，设置 `release_agent` 指向一个可执行文件（`cmd`）。该可执行文件包含攻击者希望在宿主机上执行的命令（通过 `-c` 或 `--command` 指定）。
4.  **触发漏洞:** 通过向 cgroup 中写入进程 ID，然后释放 cgroup，可以触发 `release_agent` 的执行，从而在宿主机上执行任意命令，实现容器逃逸。
5.  **命令执行:** 成功利用漏洞后，攻击者可以在宿主机上执行任意命令，例如获取 root 权限，读取敏感信息，或进行其他恶意操作。

**项目地址:** [T1erno/CVE-2022-0492-Docker-Breakout-Checker-and-PoC](https://github.com/T1erno/CVE-2022-0492-Docker-Breakout-Checker-and-PoC)

**漏洞详情:** [CVE-2022-0492](https://nvd.nist.gov/vuln/detail/CVE-2022-0492)