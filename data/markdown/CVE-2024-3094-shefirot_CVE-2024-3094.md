## CVE-2024-3094-XZ Utils供应链后门

**漏洞编号:** CVE-2024-3094

**漏洞类型:** 供应链后门

**影响应用:** XZ Utils

**危害等级:** 极危，可能导致远程代码执行和系统完全控制

**影响版本:** 5.6.0, 5.6.1

**利用条件:** 系统使用了受感染的XZ Utils版本，并且SSH服务被配置为使用liblzma。

**POC 可用性:** 是

**投毒风险:** 20%

## 详情

CVE-2024-3094是XZ Utils中发现的一个供应链后门漏洞。攻击者通过一系列复杂的混淆，在liblzma的构建过程中，从伪装的测试文件中提取预构建的目标文件，用于修改liblzma代码中的特定函数。这导致任何链接到该库的软件都可能被篡改数据交互。\n\n**有效性：**\n根据漏洞库信息和搜索结果，该漏洞是真实存在的，并且危害极大。提供的POC代码尝试在Kubernetes集群中利用此漏洞。由于该POC利用了已知的漏洞原理，并且提供了部署受影响版本的容器以及利用工具的步骤，因此**有效性较高**。POC代码的目的是在受影响的容器内执行命令，甚至关闭主机，这与漏洞描述相符。\n\n**投毒风险：**\n分析提供的POC代码后，存在一定的投毒风险，但风险较低：\n*   **明确声明：** README.md中明确声明了免责声明，提示仅用于教育目的，作者不对使用造成的任何损害负责，这降低了一定的投毒可能。\n*   **依赖外部资源：** Dockerfile引用了外部的fedora镜像，存在一定的依赖风险。\n*   **利用方式较为直接：** 该POC的目的是在受影响的容器内部署一个包含漏洞版本的XZ Utils，并通过`xzbot`工具进行利用，利用步骤较为明确，恶意行为相对容易被检测。\n*   **Dockerfile中引入patch文件:** dockerfile中引入了`liblzma.so.5.6.0.patch` 这个文件， 该文件是POC是否能够成功的关键，如果该文件被篡改，则可能导致无法复现，或者执行其他恶意操作。\n\n综合考虑，虽然该POC存在潜在的投毒风险，但整体风险较低。 \n\n**利用方式：**\n1.  **部署受影响的XZ Utils版本：** 使用提供的Dockerfile构建包含受漏洞影响的XZ Utils（5.6.0或5.6.1）版本的容器镜像。\n2.  **在Kubernetes集群中部署容器：** 使用提供的deploy_cve-2024-3094.yml或daemonset_cve-2024-3094.yml文件，将包含漏洞版本的容器部署到Kubernetes集群中。daemonset可以部署到所有节点，模拟更广泛的攻击面。\n3.  **端口转发：** 通过kubectl port-forward命令将容器的22端口（SSH）转发到本地端口，例如2225。\n4.  **利用xzbot工具：** 使用amlweems/xzbot工具连接到转发的端口，利用漏洞执行任意命令。可以通过`-cmd`参数指定要执行的命令，例如修改/etc/passwd文件或触发系统关机。\n5.  **攻击集群节点：** 通过在DaemonSet中运行受影响的容器，攻击者能够利用所有集群节点上的漏洞。

**项目地址:** [shefirot/CVE-2024-3094](https://github.com/shefirot/CVE-2024-3094)

**漏洞详情:** [CVE-2024-3094](https://nvd.nist.gov/vuln/detail/CVE-2024-3094)