## CVE-2022-44268-ImageMagick-任意文件读取

**漏洞编号:** CVE-2022-44268

**漏洞类型:** 任意文件读取

**影响应用:** ImageMagick

**危害等级:** 高危，可能导致敏感信息泄露

**影响版本:** 7.1.0-49

**利用条件:** ImageMagick 需要具有读取目标文件的权限

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2022-44268 是 ImageMagick 7.1.0-49 版本中的一个信息泄露漏洞。当 ImageMagick 解析 PNG 图像时（例如，进行缩放），如果 ImageMagick 进程有权读取任意文件，则可以将该文件的内容嵌入到生成的图像中。 

**利用方式：**

1.  **构造恶意 PNG：**  利用 `pngcrush` 工具，将想要读取的文件内容嵌入到 PNG 图像的 `profile` 文本块中。POC代码中使用了 `pngcrush -text a profile {目标文件} image.png` 命令。  
2.  **上传恶意 PNG：**  通过网站上传功能（本例中模拟 TryHackMe 上的 DockMagic 靶机环境），将包含文件内容的 PNG 图像作为头像上传。  POC 代码中模拟了对 `http://site.empman.thm/users` 的上传过程，包括获取 CSRF token，构造 POST 请求，并设置 `files` 参数。 
3.  **下载并解析图像：**  从服务器下载上传后的图像。由于 ImageMagick 处理 PNG 图像时会提取并处理嵌入的 `profile`，恶意文件会被读取并编码到图片中。 
4.  **提取文件内容：**  使用 `identify -verbose` 命令获取图像的详细信息，提取 Raw profile type 下面的十六进制数据，这部分是嵌入的文件内容。POC代码通过正则表达式 `r'Raw profile type:.*

(.*?)(?=
{2})'` 匹配并提取十六进制数据，然后解码得到文件内容。 
5.  **输出文件内容：**  将解码后的文件内容打印到控制台。 

**有效性：**

根据提供的漏洞库信息、搜索结果和漏洞利用代码，该漏洞是有效的。搜索结果中包含了多个关于此漏洞的描述和分析，漏洞利用代码也提供了一个可行的 PoC。

**投毒风险：**

分析POC代码，虽然主要功能是利用漏洞读取文件，但存在少量潜在的投毒风险。  
*   POC脚本中包含了自动安装 `graphicsmagick-imagemagick-compat` 和 `pngcrush` 的代码。在某些情况下，如果用户不小心运行了此脚本，可能会安装恶意版本的软件源或被篡改的软件包。虽然可能性不大，但存在这种风险。
*   POC脚本针对特定的 TryHackMe 靶机环境 (`http://site.empman.thm`)，如果用户直接在生产环境中使用此脚本，可能会导致意想不到的问题。  
*   脚本中从URL下载图片到本地，存在被中间人篡改图片的风险，存在执行恶意代码的可能性，但是概率较低。

因此，评估投毒风险为 10%。 主要基于以上分析。


**项目地址:** [PanAdamski/CVE-2022-44268-automated](https://github.com/PanAdamski/CVE-2022-44268-automated)

**漏洞详情:** [CVE-2022-44268](https://nvd.nist.gov/vuln/detail/CVE-2022-44268)