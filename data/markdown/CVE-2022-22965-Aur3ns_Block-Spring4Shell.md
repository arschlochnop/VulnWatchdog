## CVE-2022-22965 Spring4Shell

**漏洞编号:** CVE-2022-22965

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Spring Framework

**危害等级:** 高危，可能导致服务器完全控制

**影响版本:** Spring Framework 5.3.X (prior to 5.3.18+), 5.2.x (prior to 5.2.20+) 和所有旧版本

**利用条件:** JDK 9+, Tomcat WAR部署，Spring MVC或Spring WebFlux应用

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2022-22965（Spring4Shell）是一个Spring框架中的远程代码执行漏洞。攻击者可以通过操纵类加载器等属性来执行任意代码。

**有效性评估：**

根据漏洞库信息和搜索引擎结果，该漏洞是一个真实存在且已被积极利用的漏洞。提供的POC代码是一个防火墙服务器，旨在检测和阻止针对此漏洞的攻击，而不是利用漏洞。因此，POC代码本身的有效性在于其防御能力，而非攻击能力。

**投毒风险评估：**

分析提供的 frs.py 脚本，这个脚本模拟了一个简单的防火墙，用来检测特定的payload和header。虽然代码本身实现了防御 Spring4Shell 攻击的功能，但潜在的风险点在于：
*   **绕过规则：** 精明的攻击者可以研究这些规则，设计绕过这些规则的payload。如果规则过于简单，很容易被绕过。
*   **性能问题：** 复杂的规则可能会影响服务器性能，特别是在高流量情况下。
*   **误报风险：** 过于宽泛的规则可能会导致误报，阻止合法的请求。

检查代码，未发现明显的恶意代码，该项目更像是提供防御措施而非主动攻击，但作者可能在其他地方添加恶意程序，建议谨慎。
因此，投毒风险较低，估计为5%。主要的风险在于规则的有效性和完整性，而不是直接包含恶意代码。

**利用方式分析：**

1.  **目标：** 攻击运行在JDK 9+上的Spring MVC或Spring WebFlux应用程序，并且部署在Tomcat中作为WAR包。
2.  **机制：** 利用Spring的数据绑定功能，通过恶意构造的请求参数，修改`class.module.classLoader.resources.context.parent.pipeline.first`等属性，从而控制Tomcat的日志配置和Web shell路径。
3.  **步骤：**
    *   发送包含恶意参数的HTTP请求，例如修改Tomcat访问日志的目录为Web目录。
    *   然后，通过修改日志文件的后缀，使其成为可执行的JSP文件。
    *   最后，写入恶意代码到这个JSP文件，实现远程代码执行。

**总结：**

CVE-2022-22965是一个严重的安全漏洞，允许未经身份验证的攻击者远程执行代码。该漏洞利用的有效性取决于目标应用程序的配置和补丁状态。该项目提供的代码旨在防御这种攻击，但需要注意规则的有效性和潜在的绕过风险。

**项目地址:** [Aur3ns/Block-Spring4Shell](https://github.com/Aur3ns/Block-Spring4Shell)

**漏洞详情:** [CVE-2022-22965](https://nvd.nist.gov/vuln/detail/CVE-2022-22965)