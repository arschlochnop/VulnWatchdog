## CVE-2021-1675 PrintNightmare

**漏洞编号:** CVE-2021-1675

**漏洞类型:** 远程代码执行

**影响应用:** Windows Print Spooler

**危害等级:** 高危，可导致系统权限提升和远程代码执行

**影响版本:** 受影响的Windows版本包括Windows 7、8.1、10、Server 2008、2012、2016、2019、2004、20H2、21H1等，具体版本号参考漏洞库信息。

**利用条件:** 需要目标系统开启Print Spooler服务，攻击者需要具有一定的网络访问能力。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-1675，又名PrintNightmare，是一个Windows Print Spooler服务中的远程代码执行漏洞。攻击者可以利用此漏洞在目标系统上以SYSTEM权限执行任意代码。

**有效性：**
根据漏洞库信息、搜索引擎结果（特别是Rapid7的博客文章以及CISA的已知被利用漏洞目录），以及提供的PoC代码，可以确认该漏洞是真实存在的，并且存在公开的PoC利用代码。PoC代码的有效性取决于目标系统是否已安装相应的安全补丁。

**投毒风险：**
分析提供的PoC代码，没有发现明显的恶意或投毒代码。代码主要功能是利用`hRpcAddPrinterDriverEx`函数上传恶意的驱动文件，从而实现远程代码执行。投毒风险较低，约为10%。主要风险在于攻击者可能会修改PoC代码，嵌入恶意Payload，或者将该漏洞与其他漏洞结合利用，扩大攻击范围。

**利用方式：**
1.  **连接目标：** 使用Impacket库中的`DCERPCTransportFactory`连接到目标系统的Print Spooler服务（通过`ncacn_np`协议）。
2.  **身份验证：** 如果需要，使用提供的用户名、密码、域名等信息进行身份验证。
3.  **查找驱动路径：** 调用`hRpcEnumPrinterDrivers`函数枚举驱动程序，找到包含“filerepository”的驱动路径，用于后续利用。
4.  **构造DRIVER_CONTAINER：** 构造一个`DRIVER_CONTAINER`结构，其中包含恶意驱动程序的信息，例如驱动路径(`pDriverPath`)、数据文件(`pDataFile`)和配置文件(`pConfigFile`)。其中`pConfigFile`指向恶意DLL文件
5.  **利用hRpcAddPrinterDriverEx：** 调用`hRpcAddPrinterDriverEx`函数，将恶意驱动程序添加到目标系统。通过修改`dwFileCopyFlags`参数，可以控制文件的复制行为。攻击者通过此函数将恶意DLL上传到目标机器。
6.  **提权执行：** 通过特定的目录结构和文件命名方式，使Print Spooler服务加载并执行上传的恶意DLL，从而获得SYSTEM权限。

综上，该漏洞利用的有效性较高，但需要一定的技术知识和实验环境。在实际利用中，需要注意目标系统的安全配置和补丁情况，以及潜在的投毒风险。

**项目地址:** [TheJoyOfHacking/cube0x0-CVE-2021-1675](https://github.com/TheJoyOfHacking/cube0x0-CVE-2021-1675)

**漏洞详情:** [CVE-2021-1675](https://nvd.nist.gov/vuln/detail/CVE-2021-1675)