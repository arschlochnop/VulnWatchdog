## CVE-2022-22965 Spring4Shell RCE

**漏洞编号:** CVE-2022-22965

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Spring Framework

**危害等级:** 高危，可能导致服务器完全控制

**影响版本:** Spring Framework versions 5.3.X prior to 5.3.18+, 5.2.x prior to 5.2.20+ and all old and unsupported versions

**利用条件:** JDK 9+, Tomcat 作为 WAR 部署, 依赖 spring-webmvc 和/或 spring-webflux

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2022-22965 (Spring4Shell) 是一个 Spring Framework 中的远程代码执行漏洞。利用方式如下：

1.  **漏洞原理：** 利用了 Spring Framework 在 JDK 9+ 版本中，使用数据绑定功能时，由于类加载器机制的改变，攻击者可以通过修改 `class.module.classLoader.resources.context.parent.pipeline.first` 的属性，来修改 Tomcat 的 access log valve 的配置，从而写入恶意 JSP 文件。

2.  **利用条件：**
    *   JDK 9+
    *   受影响的 Spring Framework 版本
    *   Tomcat 作为 WAR 部署
    *   依赖 spring-webmvc 和/或 spring-webflux

3.  **利用步骤：**
    *   攻击者发送包含恶意参数的 HTTP 请求到目标服务器。
    *   这些恶意参数修改 Tomcat 的 access log valve 配置，将 pattern 设置为包含恶意代码的 JSP。
    *   Tomcat 将恶意代码写入到 webapps/ROOT 目录下，形成一个 JSP shell 文件。
    *   攻击者通过访问 JSP shell 文件执行任意代码。

4.  **POC 代码分析：** 提供的 `exploit.py` 脚本实现了上述攻击流程。
    *   脚本构造了包含恶意参数的 POST 请求，这些参数用于修改 Tomcat 的 access log valve 配置。
    *   `headers` 字典定义了请求头，`data` 变量定义了 POST 请求的数据，包含了修改 access log valve 的 payload。
    *   脚本发送 POST 请求到目标 URL，然后尝试访问生成的 JSP shell 文件。
    *   如果 JSP shell 文件成功生成并可以访问，脚本会输出 shell 的 URL。

5.  **有效性：** 根据漏洞信息和搜索引擎结果，该POC代码是有效的，可以成功利用该漏洞在满足条件的服务器上执行任意代码。

6.  **投毒风险：** 该POC代码的功能是利用漏洞在目标服务器上部署一个 JSP shell， 允许远程执行命令。脚本本身并没有发现任何隐藏的、超出此范围的恶意行为，即没有发现任何投毒代码。因此，投毒风险评估为0%。该脚本的功能与漏洞利用本身相关，旨在验证和利用漏洞，而不是植入恶意后门。

简而言之，该漏洞利用方式是通过操纵Tomcat的日志配置来写入恶意JSP文件，从而实现远程代码执行。提供的POC代码能够有效地实现这一攻击，且没有明显的投毒迹象。

**项目地址:** [sohamsharma966/Spring4Shell-CVE-2022-22965](https://github.com/sohamsharma966/Spring4Shell-CVE-2022-22965)

**漏洞详情:** [CVE-2022-22965](https://nvd.nist.gov/vuln/detail/CVE-2022-22965)