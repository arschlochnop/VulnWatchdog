## CVE-2022-42889-Apache Commons Text-RCE

**漏洞编号:** CVE-2022-42889

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Apache Commons Text

**危害等级:** 高危，可能导致服务器完全控制

**影响版本:** 1.5 <= version <= 1.9

**利用条件:** 应用程序使用受影响版本的Apache Commons Text，且允许用户控制的输入传递给`StringSubstitutor.replace()`方法。

**POC 可用性:** 是

**投毒风险:** 1%

## 详情

CVE-2022-42889 (Text4Shell) 漏洞存在于 Apache Commons Text 1.5 到 1.9 版本。该漏洞源于库中不安全的插值默认设置，当应用程序使用这些默认设置且允许用户控制输入时，攻击者可以利用 `${prefix:name}` 格式的字符串，其中 `prefix` 指示要使用的 `StringLookup` 实例。受影响的版本默认包含 `script`、`dns` 和 `url` 这几个 lookup，利用 `script` 可以执行任意 JVM 脚本，利用 `dns` 可以解析 DNS 记录，利用 `url` 可以从远程服务器加载值。攻击者可以构造恶意输入，例如 `${script:javascript:java.lang.Runtime.getRuntime().exec('command')}`，来执行任意命令。提供的漏洞利用代码是一个 Burp Suite 插件，用于检测是否存在此漏洞，它并没有直接执行恶意代码，只是辅助进行漏洞验证。从代码本身来看，没有明显的恶意行为，但考虑到Burp插件的功能强大，理论上作者可以暗中收集用户的使用数据或者篡改请求包，但这种可能性较低，约1%。

**利用方式：**

1.  **确定目标应用程序是否使用了受影响版本的 Apache Commons Text。**
2.  **确定应用程序是否允许用户控制的输入传递给 `StringSubstitutor.replace()` 方法。**
3.  **构造包含恶意插值表达式的输入。** 例如,`${script:javascript:java.lang.Runtime.getRuntime().exec('command')}`。
4.  **将恶意输入发送到目标应用程序。**
5.  **如果应用程序存在漏洞，则恶意命令将在服务器上执行。**

**缓解措施：**

*   升级到 Apache Commons Text 1.10.0 或更高版本，该版本默认禁用有问题的插值器。
*   如果无法升级，则可以禁用应用程序中的 `script`、`dns` 和 `url` 插值器。

**项目地址:** [f0ng/text4shellburpscanner](https://github.com/f0ng/text4shellburpscanner)

**漏洞详情:** [CVE-2022-42889](https://nvd.nist.gov/vuln/detail/CVE-2022-42889)