## CVE-2024-4577 PHP-CGI Argument Injection

**漏洞编号:** CVE-2024-4577

**漏洞类型:** 远程代码执行

**影响应用:** PHP

**危害等级:** 高危，允许未经身份验证的攻击者执行任意代码

**影响版本:** PHP 8.1.x (< 8.1.29), 8.2.x (< 8.2.20), 8.3.x (< 8.3.8)，运行在Windows下的CGI模式

**利用条件:** PHP运行在Windows服务器上，使用CGI模式，并且系统启用了某些代码页，允许“Best Fit”转换。

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2024-4577是一个PHP-CGI中的参数注入漏洞，影响在Windows上运行的PHP。当PHP以CGI模式运行时，如果系统配置为使用某些代码页，Windows可能会使用“Best-Fit”行为来替换命令行中的字符。PHP CGI模块可能会错误地将这些字符解释为PHP选项，从而允许恶意用户将选项传递给正在运行的PHP二进制文件，导致泄露源代码或执行任意PHP代码。 

**有效性:**

提供的PoC代码（CVE-2024-4577.py）尝试通过构造包含特殊字符的URL来利用此漏洞，将`allow_url_include`设置为1，并设置`auto_prepend_file`为`php://input`，然后通过POST请求发送包含要执行的PHP代码的数据。如果目标存在漏洞，这段PHP代码将被执行。

根据搜索引擎的结果和漏洞库信息，该漏洞已经存在在野利用，并且有公开可用的PoC，表明该PoC是有效的。

**投毒风险:**

查看提供的python脚本，脚本本身的功能是发送payload到目标地址，检测目标是否存在漏洞，检测的依据是返回内容中是否包含gotr00t字符串。脚本本身没有发现明显的恶意代码，但是考虑到以下情况，仍然存在一定投毒风险：

1.  **域名欺骗:**  `domains.txt` 如果被替换为包含恶意域名的文件，那么脚本会尝试连接这些恶意域名。但这不是脚本本身的投毒，而是依赖外部文件。
2.  **命令注入:**  虽然脚本本身没有直接执行系统命令，但是 `-c/--command`  参数允许用户指定要执行的PHP代码。如果用户不小心执行了恶意PHP代码，可能导致服务器受损。但这不是脚本作者的投毒，而是用户使用不当。
3.  **依赖包:**  `requirements.txt` 文件中列出了依赖包。如果这些依赖包被替换为恶意版本，可能会导致安全问题。但这通常属于供应链攻击，不是脚本作者直接投毒。

考虑到以上因素，认为脚本本身被作者投毒的可能性较低，大约在5%左右，主要风险在于使用者利用该脚本执行恶意命令或使用了被篡改的依赖包。

**利用方式:**

1.  攻击者需要找到一个运行在Windows服务器上，并且使用CGI模式的PHP应用，同时确认目标系统启用了具有“Best Fit”行为的代码页。
2.  构造包含特殊字符的恶意URL。这些特殊字符会被Windows的“Best Fit”转换机制转换为PHP选项。
3.  通过设置`allow_url_include`为1，并设置`auto_prepend_file`为`php://input`，将要执行的PHP代码通过POST请求发送到目标服务器。
4.  服务器执行恶意PHP代码，攻击者从而控制服务器。

**项目地址:** [Didarul342/CVE-2024-4577](https://github.com/Didarul342/CVE-2024-4577)

**漏洞详情:** [CVE-2024-4577](https://nvd.nist.gov/vuln/detail/CVE-2024-4577)