## CVE-2022-0847 (Dirty Pipe)

**漏洞编号:** CVE-2022-0847

**漏洞类型:** 本地权限提升

**影响应用:** Linux Kernel

**危害等级:** 高危，允许非特权本地用户覆盖只读文件并提升权限。

**影响版本:** Linux Kernel 5.17 rc6 (受影响)，其他受影响版本请参考相关漏洞公告。

**利用条件:** 需要本地访问权限，受影响的内核版本。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2022-0847，又名Dirty Pipe，是一个Linux内核中的本地权限提升漏洞。该漏洞源于内核在处理管道缓冲区时未正确初始化flags成员，导致未授权的本地用户可以利用此漏洞写入原本只读的文件，从而提升权限。漏洞利用方式通常涉及以下步骤：

1.  **利用splice()系统调用创建存在漏洞的pipe:**  攻击者会使用`splice()`系统调用创建一个特殊的pipe，这个pipe会触发漏洞。
2.  **覆盖只读文件：** 通过精心构造的数据，攻击者可以将恶意数据写入到page cache中由只读文件映射的内存页上，从而修改只读文件的内容。
3.  **权限提升：**  如果被覆盖的文件是SUID程序，攻击者就可以通过执行该程序来获取root权限。

提供的eBPF代码试图通过监控`splice()`系统调用来检测和防御针对CVE-2022-0847的攻击。具体来说：

*   **eBPF程序：** 监控`splice()`系统调用，检查pipe的输出fd以及pipe buffer的flags是否被设置为`PIPE_BUF_FLAG_CAN_MERGE`。如果是，则触发事件。
*   **用户空间程序：** 接收eBPF程序触发的事件，杀死对应的进程，并尝试清除page cache。

**有效性评估：**
根据漏洞信息和搜索结果，CVE-2022-0847是一个已知的、被广泛利用的漏洞，存在公开可用的exp。提供的eBPF代码不是exp, 而是防御措施，用于检测和阻止利用。

**投毒风险评估：**
代码中存在潜在投毒风险。用户空间的程序在检测到`splice()` 调用后会杀死进程并尝试清理缓存。虽然目的是防御，但可能存在以下问题：

*   **误杀：** 如果误报，可能导致正常进程被意外终止。
*   **拒绝服务：** 频繁的缓存清理操作可能导致系统性能下降。
*   **条件竞争：** 清理缓存的操作可能无法完全阻止攻击，攻击者可能利用条件竞争窗口完成攻击。

因此，将Poison风险评估为10%, 主要基于以下因素:
* 代码意图是防御性的而非攻击性
* 防御代码本身存在潜在的副作用 (误杀, DoS) 可以被恶意利用, 但是利用难度相对较高,不如直接编写攻击exp更容易. 

**利用方式总结：**
攻击者利用`splice()`调用和pipe buffer的未初始化状态，将恶意数据注入到page cache，从而修改只读文件内容，最终达到权限提升的目的。该漏洞影响广泛，危害巨大，需要及时修补。

**项目地址:** [h4ckm310n/CVE-2022-0847-eBPF](https://github.com/h4ckm310n/CVE-2022-0847-eBPF)

**漏洞详情:** [CVE-2022-0847](https://nvd.nist.gov/vuln/detail/CVE-2022-0847)