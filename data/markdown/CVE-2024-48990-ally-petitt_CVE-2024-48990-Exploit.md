## CVE-2024-48990-needrestart-PYTHONPATH提权

**漏洞编号:** CVE-2024-48990

**漏洞类型:** 权限提升

**影响应用:** needrestart

**危害等级:** 高危，本地攻击者可以利用该漏洞以root权限执行任意代码

**影响版本:** < 3.8

**利用条件:** 需要本地访问权限，目标系统安装了受影响版本的needrestart，并且存在触发needrestart执行的事件（例如，`sudo apt install`）。

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2024-48990 允许本地攻击者通过设置 `PYTHONPATH` 环境变量来欺骗 `needrestart` 运行恶意Python代码，从而以 root 权限执行任意代码。该漏洞存在于 `needrestart` 3.8 之前的版本。利用方式如下：

1.  攻击者在一个可控目录下创建一个包含恶意代码的Python模块（例如，名为 `importlib` 的目录，并在其中创建一个 `__init__.py` 文件）。
2.  攻击者设置 `PYTHONPATH` 环境变量指向该目录。
3.  当 `needrestart` 被触发时（例如，通过 `sudo apt install` 命令），它会尝试导入Python模块。
4.  由于 `PYTHONPATH` 指向攻击者控制的目录，`needrestart` 会导入攻击者的恶意Python模块，并以 root 权限执行其中的代码。

**POC代码分析：**

提供的POC代码包含了以下文件：

*   `LICENSE`: MIT许可证。
*   `README.md`: 说明如何利用该漏洞，包括将仓库克隆到攻击者控制的目录，设置 `PYTHONPATH` 环境变量，并运行 `main.py`。
*   `main.py`: 一个无限循环，用于保持程序运行。
*   `importlib/__init__.py`: 包含实际的恶意代码，用于创建一个反向shell连接到攻击者的机器。它使用 `socket` 和 `pty` 模块来建立连接并生成一个 shell。

**有效性评估：**

根据漏洞描述和提供的POC代码，该漏洞利用是有效的。攻击者通过设置 `PYTHONPATH` 环境变量来劫持Python模块的导入，从而执行任意代码。POC中的`importlib/__init__.py`会在目标机器上建立一个反向shell，证明了漏洞利用的有效性。

**投毒风险评估：**

目前分析来看，此仓库中的代码没有发现明显的投毒代码。`main.py`的无限循环和`importlib/__init__.py`的反向shell，都是为了验证POC本身的利用效果，并非为了进行其他恶意行为。因此，判断投毒风险为0%。

**利用方式总结：**

1.  **准备环境：**  克隆POC代码到攻击者可控的目录。
2.  **设置环境变量：**  设置 `PYTHONPATH` 环境变量指向攻击者控制的目录。
3.  **触发漏洞：**  等待或触发 `needrestart` 的运行（例如，通过执行 `sudo apt install`）。
4.  **获取权限：**  当 `needrestart` 运行并导入恶意Python模块时，攻击者将获得一个 root shell。

**项目地址:** [ally-petitt/CVE-2024-48990-Exploit](https://github.com/ally-petitt/CVE-2024-48990-Exploit)

**漏洞详情:** [CVE-2024-48990](https://nvd.nist.gov/vuln/detail/CVE-2024-48990)