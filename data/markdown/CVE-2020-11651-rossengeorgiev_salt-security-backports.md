## CVE-2020-11651 SaltStack 认证绕过和远程代码执行

**漏洞编号:** CVE-2020-11651

**漏洞类型:** 认证绕过/远程代码执行

**影响应用:** SaltStack

**危害等级:** 高危，可能导致敏感信息泄露和远程代码执行

**影响版本:** < 2019.2.4, < 3000.2

**利用条件:** 目标系统运行存在漏洞版本的 Salt Master，攻击者需要能够与 Salt Master 建立网络连接（通常是4505和4506端口）。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2020-11651 漏洞存在于 SaltStack Salt 的 salt-master 进程中，由于 ClearFuncs 类未正确验证方法调用，导致未经身份验证的远程用户可以访问某些方法。这些方法可用于从 salt master 检索用户令牌，或者在 salt minions 上执行任意命令。

**有效性：**
根据漏洞描述和搜索结果，以及POC代码，可以判断该漏洞利用代码有效。该漏洞在野外被积极利用。

**投毒风险：**
提供的代码是用于修补漏洞的patch文件，并非可以直接运行的利用代码。其中一个patch文件（2016.11.10_CVE-2020-11651.patch）修改了 salt/master.py 文件，通过引入 `TransportMethods` 类和 `get_method` 方法，并对 `ClearFuncs` 和 `AESFuncs` 类中允许远程调用的方法进行了显式定义，从而修复了认证绕过漏洞。 另一个patch(2016.11.10_CVE-2020-11652.patch)修复了路径遍历漏洞，可以防止token泄露。

虽然直接的投毒风险不高，但是也不能排除作者在提交历史或其它相关文件中隐藏恶意代码的可能性。此处评估的投毒风险为10%，主要考虑是需要检查整个代码仓库，才能完全排除风险。

**利用方式：**
攻击者可以利用未经身份验证的连接，调用 ClearFuncs 或 AESFuncs 中暴露的方法，实现以下目的：
1.  **获取 Minion 密钥：** 通过调用某些方法，攻击者可以获取已连接的 Minion 的密钥，从而冒充 Minion 与 Master 通信。
2.  **远程代码执行：** 获取 Minion 密钥后，攻击者可以向 Minion 发送任意命令，实现远程代码执行。

总而言之，此漏洞允许未经身份验证的攻击者在 Salt Master 和 Minion 上执行任意代码，风险极高。需要尽快升级到安全版本。

**项目地址:** [rossengeorgiev/salt-security-backports](https://github.com/rossengeorgiev/salt-security-backports)

**漏洞详情:** [CVE-2020-11651](https://nvd.nist.gov/vuln/detail/CVE-2020-11651)