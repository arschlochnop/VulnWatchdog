## CVE-2020-1472 Zerologon

**漏洞编号:** CVE-2020-1472

**漏洞类型:** 权限提升

**影响应用:** Microsoft Windows Server

**危害等级:** 高危，可导致域控被完全控制

**影响版本:** 受影响的Windows Server版本包括2008 R2 SP1, 2012, 2012 R2, 2016, 2019, 版本1903, 版本1909, 版本2004, 版本20H2

**利用条件:** 需要与域控制器建立网络连接

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2020-1472（Zerologon）是一个Netlogon权限提升漏洞，允许未经身份验证的攻击者通过MS-NRPC协议与域控制器建立脆弱的安全通道连接，将域控制器的机器帐户密码置零，从而获得域管理员权限。攻击利用方式如下：

1.  **漏洞原理：** 该漏洞源于Netlogon远程协议（MS-NRPC）在处理身份验证时的加密实现缺陷，特别是AES-CFB8的使用。
2.  **攻击步骤：**
    *   攻击者使用提供的Python脚本（`zerologon.py`）与目标域控制器建立连接。
    *   脚本尝试将域控制器的机器帐户密码置零。这会暂时中断域控制器的正常功能，但脚本会在攻击完成后尝试恢复原始密码。
    *   如果`-exploit`选项被使用，脚本会执行以下操作：
        *   将域控制器的系统密码置零。
        *   使用secretsdump工具的DRSUAPI功能，通过置零的密码获取NTDS哈希。
        *   解析转储的数据，获取域管理员帐户（RID为500）的信息，并再次调用secretsdump获取LSA Secrets。
        *   解析第二次转储的数据，获取`plain_password_hex`值。
        *   调用restore脚本，使用hex值将域控制器的系统密码恢复到原始值。
3.  **利用有效性：**  根据漏洞库信息和搜索结果，该漏洞利用的POC是公开可用的，并且已经被广泛利用。因此，该漏洞利用是有效的，如果目标系统未打补丁，则攻击很可能成功。
4.  **投毒风险：** 代码仓库中存在投毒代码的可能性较低。虽然脚本具有修改域控密码的功能，可能造成短期影响，但是从代码本身来看，目的是为了演示漏洞和提取哈希，而不是进行恶意破坏或植入后门。作者添加恶意代码，让攻击者承担法律风险的收益较低。代码投毒风险估计为10%。主要风险点在于使用者对脚本的修改和使用方式不当。代码有恢复密码的逻辑。
5.  **缓解措施：**
    *   及时安装Microsoft提供的安全更新。
    *   监控事件日志，查找与CVE-2020-1472相关的事件，例如事件ID 4661、4723和4738。
    *   遵循Microsoft的指南，管理Netlogon安全通道连接的更改。

**项目地址:** [sho-luv/zerologon](https://github.com/sho-luv/zerologon)

**漏洞详情:** [CVE-2020-1472](https://nvd.nist.gov/vuln/detail/CVE-2020-1472)