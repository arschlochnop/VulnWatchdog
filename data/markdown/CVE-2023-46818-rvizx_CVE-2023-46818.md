## CVE-2023-46818-ISPConfig-PHP代码注入

**漏洞编号:** CVE-2023-46818

**漏洞类型:** PHP代码注入

**影响应用:** ISPConfig

**危害等级:** 高危，可能导致远程代码执行

**影响版本:** <= 3.2.11

**利用条件:** 需要管理员权限并启用admin_allow_langedit

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2023-46818是ISPConfig 3.2.11版本及之前版本中存在的一个PHP代码注入漏洞。该漏洞允许具有管理员权限的用户，在启用了`admin_allow_langedit`设置的情况下，通过`language_edit.php`页面的`records[]`参数注入恶意的PHP代码，从而实现远程代码执行。

**有效性：**
根据漏洞信息和搜索引擎结果，该漏洞是真实存在的，并且已经有公开的PoC利用代码可用。该PoC的`exploit.sh`脚本通过以下步骤利用漏洞：
1.  使用提供的用户名和密码登录ISPConfig管理界面。
2.  获取CSRF令牌（`_csrf_id`和`_csrf_key`）。
3.  构造包含PHP webshell的payload，该webshell允许执行任意命令，并将其base64编码。
4.  将编码后的payload注入到`language_edit.php`的`records[]`参数中，利用PHP代码注入漏洞将webshell写入到服务器的`/admin/`目录下，命名为`sh.php`。
5.  通过访问`/admin/sh.php`，攻击者可以执行任意系统命令。

**投毒风险：**
分析`exploit.sh`脚本，存在轻微的投毒风险。该脚本在部署webshell后，会创建一个交互式shell，允许攻击者持续执行命令。虽然PoC本身的目的在于验证漏洞，但这种交互式shell如果被恶意使用，可能造成更大的危害，例如持续监视或数据窃取。另外，作者可能在脚本中嵌入隐蔽的后门代码，但经过检查，在给定的脚本中没有明显发现这样的代码。但是仍然存在一定几率payload被替换成其他的恶意代码. 风险比例估计为5%。

**利用方式：**
1.  攻击者需要拥有ISPConfig的管理权限。
2.  需要启用`admin_allow_langedit`设置。
3.  攻击者使用`exploit.sh`脚本提供的URL、用户名和密码来利用漏洞，在目标服务器上部署webshell。
4.  攻击者通过访问webshell，执行任意系统命令。

**项目地址:** [rvizx/CVE-2023-46818](https://github.com/rvizx/CVE-2023-46818)

**漏洞详情:** [CVE-2023-46818](https://nvd.nist.gov/vuln/detail/CVE-2023-46818)