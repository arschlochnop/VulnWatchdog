## CVE-2021-34371-Neo4j-RMI反序列化远程代码执行

**漏洞编号:** CVE-2021-34371

**漏洞类型:** RMI反序列化漏洞

**影响应用:** Neo4j

**危害等级:** 高危，可能导致远程代码执行

**影响版本:** <= 3.4.18

**利用条件:** 需要Neo4j shell server启用，且目标存在于攻击者可访问的网络

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2021-34371 是 Neo4j 3.4.18 及更早版本中的一个 RMI 反序列化漏洞。当 Neo4j 的 shell server 启用时，攻击者可以利用 RMI 服务中不安全的反序列化操作来执行任意代码。漏洞利用方式如下：

1.  **漏洞描述：** Neo4j 通过 RMI 服务暴露了一个接口，该接口允许远程调用 `setSessionVariable` 方法。由于没有对传入的 Java 对象进行充分的验证，攻击者可以发送恶意的序列化对象，导致反序列化漏洞。
2.  **漏洞原理：** Java 反序列化漏洞的根源在于程序没有对序列化数据进行严格的校验，导致攻击者可以构造特定的序列化数据，利用已知的 gadget chain (例如，ysoserial 中提供的 gadget) 在目标系统上执行任意代码。
3.  **POC分析：** 提供的 Python POC 代码 `exploit.py` 演示了如何利用该漏洞。该脚本执行以下步骤：
    *   启动 JVM 并加载所需的 JAR 文件 (neo4j-shell-3.4.18.jar 和 ysoserial-all.jar)。
    *   检查目标 RMI 注册表中是否存在名为 "shell" 的绑定，确认 shell server 已启用。
    *   使用 `ysoserial` 生成一个恶意的序列化 payload，该 payload 包含执行指定命令（默认为 `touch /tmp/test.txt`）的 gadget chain。
    *   通过 `setSessionVariable` 方法将恶意 payload 发送到 Neo4j 服务器。
    *   Neo4j 服务器反序列化该 payload，触发 gadget chain，导致远程代码执行。

根据代码分析，该POC没有发现任何投毒代码，它的作用是验证漏洞并且执行指定的命令。

**有效性：** 根据提供的漏洞信息、搜索结果以及 POC 代码，可以判断该漏洞利用代码是有效的。搜索引擎结果中多个链接都确认了 CVE-2021-34371 的存在和高危风险。提供的 POC 代码也比较完整，描述了利用该漏洞的详细步骤。

**投毒风险：** 经分析，POC代码中没有明显的投毒行为。代码的主要功能是利用已知的 RMI 反序列化漏洞执行命令。`COMMAND` 变量允许用户指定要执行的命令，但本身不包含恶意逻辑。

**利用方式：**

1.  **前提条件：** Neo4j 3.4.18 或更早版本，且 shell server 已启用。
2.  **攻击步骤：**
    *   准备：确保安装了 jpype，并且拥有 neo4j-shell-3.4.18.jar 和 ysoserial-all.jar (需要包含 Rhino gadget)。
    *   配置：修改 `exploit.py` 中的 `COMMAND`、`TARGET` 和 `TARGET_BINDING` 变量，以匹配目标环境。
    *   执行：运行 `exploit.py` 脚本，利用 RMI 反序列化漏洞在目标系统上执行任意命令。

**总结：** CVE-2021-34371 是一个严重的安全漏洞，允许未经授权的攻击者在 Neo4j 服务器上执行任意代码。建议受影响的用户尽快升级到最新版本或禁用 shell server。

**项目地址:** [tavgar/CVE-2021-34371](https://github.com/tavgar/CVE-2021-34371)

**漏洞详情:** [CVE-2021-34371](https://nvd.nist.gov/vuln/detail/CVE-2021-34371)