## CVE-2023-6401-NotePad++-DLL劫持

**漏洞编号:** CVE-2023-6401

**漏洞类型:** DLL劫持

**影响应用:** NotePad++

**危害等级:** 中危，本地权限下可执行任意代码

**影响版本:** <= 8.1

**利用条件:** 需要本地文件写入权限到NotePad++安装目录

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2023-6401是NotePad++ 8.1及之前版本中的一个DLL劫持漏洞。该漏洞源于程序在加载dbghelp.dll时，没有对加载路径进行充分控制，导致攻击者可以通过在NotePad++的安装目录下放置恶意的dbghelp.dll文件，从而在NotePad++启动时执行任意代码。

**有效性：**

提供的POC代码是有效的。它演示了如何通过创建一个恶意的dbghelp.dll文件并将其放置在NotePad++的安装目录下，来劫持NotePad++的启动过程，从而执行任意代码。POC代码中给出了编译和部署恶意DLL的详细步骤，以及预期的执行结果（弹出计算器和消息框）。

**投毒风险：**

该POC的投毒风险较低，约为5%。风险点主要在于：

*   **`realImageNtHeader = (pImageNtHeader)GetProcAddress(realDbghelp, "ImageNtHeader");`:** 这行代码尝试从真实的dbghelp.dll中获取`ImageNtHeader`函数的地址。如果恶意DLL无法正确加载或转发所有必要的API调用，可能会导致NotePad++功能异常或崩溃。攻击者可能利用这一点，故意使恶意DLL不完整，从而破坏NotePad++的功能，以此达到某种破坏目的（例如，使其成为卸载、删除文件的工具）。
*   **依赖编译器：** README中要求使用MinGW编译，如果用户使用其它编译器，恶意dll可能无法正常运行，从而使得真实dll也无法正常加载，导致软件崩溃。

总体来说，POC本身专注于演示DLL劫持，而没有明显的恶意代码。但仍然需要注意，实际攻击中，攻击者可能会在恶意DLL中加入更具破坏性的代码。

**利用方式：**

1.  **查找目标：** 找到安装了NotePad++ 8.1或更早版本的Windows系统。
2.  **写入权限：** 确保攻击者拥有NotePad++安装目录的写入权限。通常情况下，这需要具有本地用户权限。
3.  **编译恶意DLL：** 使用提供的dbghelp.c代码编译生成恶意的dbghelp.dll文件。恶意代码通常在DllMain函数中。
4.  **放置DLL：** 将编译好的dbghelp.dll文件复制到NotePad++的安装目录下，替换或覆盖原有的dbghelp.dll（如果存在）。
5.  **触发漏洞：** 启动NotePad++。此时，恶意DLL会被加载，DllMain函数中的恶意代码会被执行。
6.  **清理（可选）：** 删除安装目录下的恶意dbghelp.dll，恢复系统功能。如果未实现API转发，可能需要重装Notepad++。

成功利用此漏洞后，攻击者可以在目标系统上执行任意代码，例如安装后门、窃取敏感信息或进行其他恶意活动。由于需要本地权限才能写入NotePad++的安装目录，因此此漏洞通常与社会工程学攻击或其他本地权限提升漏洞结合使用。

**项目地址:** [mekitoci/CVE-2023-6401](https://github.com/mekitoci/CVE-2023-6401)

**漏洞详情:** [CVE-2023-6401](https://nvd.nist.gov/vuln/detail/CVE-2023-6401)