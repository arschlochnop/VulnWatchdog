## CVE-2022-29464 - WSO2 任意文件上传导致远程代码执行

**漏洞编号:** CVE-2022-29464

**漏洞类型:** 任意文件上传

**影响应用:** WSO2 产品

**危害等级:** 高危，允许未经身份验证的远程代码执行

**影响版本:** WSO2 API Manager 2.2.0 到 4.0.0, WSO2 Identity Server 5.2.0 到 5.11.0, WSO2 Identity Server Analytics 5.4.0, 5.4.1, 5.5.0 和 5.6.0, WSO2 Identity Server as Key Manager 5.3.0 到 5.11.0, WSO2 Enterprise Integrator 6.2.0 到 6.6.0, WSO2 Open Banking AM 1.4.0 到 2.0.0 和 WSO2 Open Banking KM 1.4.0, 到 2.0.0

**利用条件:** 需要网络访问目标 WSO2 实例，利用 /fileupload 端点

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2022-29464 是一个存在于多个 WSO2 产品中的严重漏洞，允许未经身份验证的攻击者上传任意文件，进而实现远程代码执行。该漏洞的核心在于 `/fileupload` 端点未进行严格的身份验证和文件类型限制。根据提供的漏洞利用代码，该漏洞利用方式如下：

1.  **漏洞原理：**  WSO2 产品中的 `/fileupload` 端点允许未经身份验证的文件上传。`FileUploadServlet` 处理该请求，并根据 `carbon.xml` 配置文件加载的文件上传执行器处理上传的文件。由于未进行充分的验证，攻击者可以上传恶意文件。
2.  **利用步骤：**
    *   攻击者发送包含恶意 JSP 代码的 HTTP POST 请求到 `/fileupload` 端点。
    *   请求的 `Content-Disposition` 头包含目录遍历序列 (例如 `../../../../repository/deployment/server/webapps`)，用于将文件上传到 Web 根目录下的可执行目录。
    *   上传的 JSP 文件会被 WSO2 服务器执行，从而允许攻击者执行任意代码。
3.  **有效性评估：** 漏洞库信息、搜索引擎结果和提供的漏洞利用代码均表明该漏洞是可利用的，并且已经有公开的 PoC 代码存在。
4.  **投毒风险评估：**  漏洞利用代码的仓库中可能存在投毒的风险。虽然主要的利用方式是利用已知的漏洞，但仓库中可能会包含一些隐藏的、不明显的功能或代码，这些代码可能用于收集信息、植入后门或执行其他恶意活动。因此，对代码的审计是必要的，且投毒风险存在，约为 10%。风险主要来自于：
    *   **非必要的辅助脚本：** 仓库中可能包含一些非漏洞利用必需的脚本，例如用于扫描或配置的脚本，这些脚本可能包含恶意代码。
    *   **混淆的代码：**  某些代码可能经过混淆，使得难以分析其真实行为。
    *   **供应链攻击：**  仓库可能依赖于外部的库或组件，这些库或组件可能被恶意篡改。
    *   **社会工程：**  攻击者可能通过提交看似无害的 Pull Request 来引入恶意代码。
5.  **缓解措施：**
    *   升级到已修复漏洞的 WSO2 产品版本。
    *   实施严格的文件上传验证机制，包括身份验证、文件类型检查和大小限制。
    *   使用 Web 应用防火墙 (WAF) 过滤恶意请求。
    *   定期进行安全审计和漏洞扫描。

**项目地址:** [amit-pathak009/CVE-2022-29464](https://github.com/amit-pathak009/CVE-2022-29464)

**漏洞详情:** [CVE-2022-29464](https://nvd.nist.gov/vuln/detail/CVE-2022-29464)