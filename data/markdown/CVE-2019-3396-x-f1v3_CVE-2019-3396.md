## CVE-2019-3396-Atlassian Confluence Server-服务器端模板注入

**漏洞编号:** CVE-2019-3396

**漏洞类型:** 服务器端模板注入 (Server-Side Template Injection)

**影响应用:** Atlassian Confluence Server

**危害等级:** 高危，可能导致远程代码执行

**影响版本:** 版本低于 6.6.12，6.7.0 到 6.12.3 之间，6.13.0 到 6.13.3 之间，6.14.0 到 6.14.2 之间

**利用条件:** 需要网络访问到Confluence服务器

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2019-3396 是 Atlassian Confluence Server 中的一个服务器端模板注入漏洞，存在于 Widget Connector 宏中。攻击者可以通过构造恶意的请求，利用 Velocity 模板引擎执行任意代码，从而实现远程代码执行。

**有效性：**

提供的POC代码是有效的。它演示了两种利用方式：

*   **远程代码执行（RCE）：** 通过修改`_template`参数，指向包含恶意 Velocity 模板的远程文件（1.vm）。该模板使用`java.lang.Runtime`类执行`ping your.dns.log`命令，可以验证RCE是否成功，同时可以替换成其他的恶意命令。
*   **本地文件包含（LFI）：** 通过修改`_template`参数，指向服务器上的敏感文件，如`../web.xml`，从而读取服务器上的文件内容。

**投毒风险：**

该存储库被投毒的风险较低，约为10%。判断依据如下：

*   仓库本身较为简单，只有一个RCE的vm文件和readme。从代码本身来看，恶意代码的可能性较低。
*   代码片段是直接命令ping，没有很强的迷惑性，因此投毒概率低。
*   参考搜索结果，此漏洞已经被广泛利用，出现恶意利用的情况，但POC本身相对直接。

**利用方式：**

1.  确定目标 Confluence Server 存在 CVE-2019-3396 漏洞。
2.  构造包含恶意 Velocity 模板的 HTTP POST 请求，发送到`/rest/tinymce/1/macro/preview`端点。
3.  在请求体中，设置`macro.params._template`参数为恶意 Velocity 模板的 URL 或目标服务器上的文件路径。
4.  发送请求后，如果漏洞存在，Confluence Server 将执行恶意 Velocity 模板中的代码，导致 RCE 或 LFI。

**示例：**

利用 RCE POC，攻击者可以通过修改 Velocity 模板中的命令，执行任意系统命令，例如上传 webshell、添加用户等。

利用 LFI POC，攻击者可以读取 Confluence Server 上的敏感配置文件，例如数据库连接信息、管理员密码等。

**注意：**

利用此漏洞进行攻击是非法的，仅供安全研究和渗透测试使用。

**项目地址:** [x-f1v3/CVE-2019-3396](https://github.com/x-f1v3/CVE-2019-3396)

**漏洞详情:** [CVE-2019-3396](https://nvd.nist.gov/vuln/detail/CVE-2019-3396)