## CVE-2023-21554-MSMQ远程代码执行

**漏洞编号:** CVE-2023-21554

**漏洞类型:** 远程代码执行

**影响应用:** Microsoft Message Queuing (MSMQ)

**危害等级:** 高危，可被未经身份验证的攻击者利用

**影响版本:** 受影响的Windows版本范围广泛，具体请参考CVE信息

**利用条件:** 目标系统需要运行MSMQ服务，且攻击者需要能够访问MSMQ的端口（通常是1801）。

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2023-21554 是 Microsoft Message Queuing (MSMQ) 中的一个远程代码执行漏洞。未经身份验证的攻击者可以通过网络发送特制的恶意消息到 MSMQ 服务器，从而在目标系统上执行任意代码。  

**漏洞利用分析：**

提供的 Python 脚本 (poc_check.py) 并非直接利用该漏洞执行代码，而是一个辅助工具，用于测试攻击流程的各个阶段，帮助分析和调试漏洞利用过程。该脚本分阶段发送预定义的数据包（"establish_connection.bin"、"connection_parameters.bin"、"user_message.bin"）到目标 MSMQ 服务器，并捕获服务器的响应。

*   **连接建立阶段 (establish_connection.bin)：**  建立与目标 MSMQ 服务器的 TCP 连接。
*   **连接参数协商阶段 (connection_parameters.bin)：**  发送连接参数，这可能包含触发漏洞的关键数据。
*   **用户消息发送阶段 (user_message.bin)：**  发送包含恶意负载的用户消息。

该脚本会打印服务器的响应、连接状态以及任何异常情况，这有助于确定漏洞利用是否成功。

**有效性：**

该脚本的目的是验证漏洞的存在，而不是完整的漏洞利用，如果配合正确的二进制payload文件，脚本可以成功触发漏洞。

**投毒风险：**

从提供的代码来看，投毒风险较低。脚本本身没有明显的恶意行为，只是一个测试工具。主要的风险在于以下几点：

*   **依赖的二进制文件：** `establish_connection.bin`、`connection_parameters.bin`、`user_message.bin` 这些二进制文件的内容是未知的，如果这些文件被篡改，包含恶意代码，则可能存在投毒风险。但是这个风险较低，因为漏洞利用脚本需要配合漏洞本身的利用链，如果随意投毒，导致利用链断裂，就无法达到攻击的目的，所以这个仓库中投毒的可能性较低。

*   **服务器端漏洞利用：**  最终的远程代码执行依赖于服务器端 MSMQ 服务的漏洞。如果攻击者修改服务器端的 MSMQ 服务代码，使其包含后门，则可能存在投毒风险，但这与此代码仓库无关。

所以，综合来看，此代码仓库本身存在投毒的概率较低，估算为 5%。

**利用方式：**

1.  使用 poc_check.py 脚本，按顺序发送 establish_connection.bin, connection_parameters.bin, user_message.bin 这三个文件。
2.  脚本可以诊断每个阶段的连接状态，发送的数据，以及服务器的响应信息，可以协助漏洞研究人员分析漏洞成因，构造合适的利用数据，最终实现远程代码执行。

根据漏洞库信息，利用该漏洞需要精心构造 MSMQ 消息，利用不当的输入验证缺陷来执行恶意代码。具体利用方式可能涉及缓冲区溢出、类型混淆或其他内存破坏技术。


**项目地址:** [shootweb/CVE-2023-21554](https://github.com/shootweb/CVE-2023-21554)

**漏洞详情:** [CVE-2023-21554](https://nvd.nist.gov/vuln/detail/CVE-2023-21554)