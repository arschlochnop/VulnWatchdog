## CVE-2022-24834 - Redis Lua cjson 库堆溢出

**漏洞编号:** CVE-2022-24834

**漏洞类型:** 堆溢出

**影响应用:** Redis

**危害等级:** 高危，可能导致堆破坏和远程代码执行

**影响版本:** Redis 6.0.0 ~ 6.0.19, 6.2.0 ~ 6.2.12, 7.0.0 ~ 7.0.11

**利用条件:** 需要 Redis 实例开启 Lua 脚本支持，且攻击者需要通过认证和授权才能执行 Lua 脚本。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2022-24834 是 Redis 中 Lua cjson 库的一个堆溢出漏洞。攻击者可以利用该漏洞执行任意代码。

**漏洞利用方式：**

1.  **漏洞成因：** 通过精心构造的 Lua 脚本，在调用 cjson 库处理 JSON 数据时，触发整数溢出，导致堆缓冲区溢出。
2.  **利用步骤：**
    *   攻击者需要连接到 Redis 实例，并通过认证。
    *   攻击者需要发送恶意的 Lua 脚本到 Redis 服务器执行。
    *   Lua 脚本利用 cjson 库的漏洞，实现堆溢出，覆盖内存。
    *   通过内存覆盖，攻击者可以修改程序执行流程，或者执行任意代码。
3.  **POC 分析：**
    *   提供的 POC 代码旨在绕过硬编码的偏移量，使其更通用。
    *   使用超大字符串以便于读取任意内存地址。
    *   使用 Lua 协程泄漏栈和 libc 地址。
    *   包含符号解析函数和自动 gadget 查找器。
    *   修改了原始 exploit.py 以使用 pwntools 并添加了反向 shell 处理程序。
    *   其中包含内存地址泄露，堆喷射等常见漏洞利用技巧。

**有效性：**

提供的 POC 代码已经过验证，可在多个 Redis 版本和环境中成功利用（Redis 7.0.11 和 6.2.12 在 Ubuntu 20.04 上通过 docker image 测试成功）。

**投毒风险：**

该漏洞利用代码具备一定的投毒风险。虽然 POC 的主要目的是利用漏洞，但仍然存在以下可能性：

*   **后门植入：** 攻击者可能修改 POC 代码，在成功利用漏洞后，在目标系统上植入后门，以便长期控制系统。
*   **拒绝服务：** 攻击者可能故意编写不稳定的 POC 代码，导致 Redis 服务器崩溃或拒绝服务。
*   **数据篡改：** 攻击者可能修改 POC 代码，在利用漏洞的过程中，篡改 Redis 数据库中的数据。

考虑到该 POC 代码包含从内存中dump信息的代码，并且修改了原始的利用代码，添加了一些额外的功能，因此，存在潜在的投毒风险的可能性。为了降低风险，使用前务必进行详细的安全审计。

**项目地址:** [convisolabs/CVE-2022-24834](https://github.com/convisolabs/CVE-2022-24834)

**漏洞详情:** [CVE-2022-24834](https://nvd.nist.gov/vuln/detail/CVE-2022-24834)