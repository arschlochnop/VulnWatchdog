## CVE-2019-11043 PHP-FPM 远程代码执行

**漏洞编号:** CVE-2019-11043

**漏洞类型:** 缓冲区溢出

**影响应用:** PHP-FPM

**危害等级:** 高危，可能导致远程代码执行

**影响版本:** PHP 7.1.x (< 7.1.33), 7.2.x (< 7.2.24), 7.3.x (< 7.3.11)

**利用条件:** Nginx + PHP-FPM 配置，且 Nginx 配置中存在 fastcgi_split_path_info 指令，未对文件存在性进行校验。

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2019-11043 漏洞是 PHP-FPM 在特定 Nginx 配置下由于 env_path_info 处理不当导致的缓冲区下溢漏洞，可以造成远程代码执行。

**漏洞有效性：**
根据漏洞库信息、搜索引擎结果和提供的漏洞利用代码，可以确认此漏洞的POC代码是有效的。漏洞库信息明确指出该漏洞存在远程代码执行的可能，并链接到了 `https://github.com/neex/phuip-fpizdam`，该链接指向的正是可以利用此漏洞的exploit。
搜索引擎结果也显示了该漏洞可以导致远程代码执行，并且在野利用已经存在。
提供的漏洞利用代码包含 Docker 镜像配置（nginx@latest, php-fpm@7.2.10）和 Python 脚本，并且提供了详细的利用方法和分析，进一步证实了该漏洞利用代码的有效性。

**投毒风险：**
分析POC代码，发现投毒的风险较低，约为 5%。主要考虑以下几点：
1.  **代码功能明确：**  Python 脚本的主要功能是发送特制的 HTTP 请求，利用 PHP-FPM 的漏洞执行代码。虽然执行恶意代码是既定的，但脚本本身没有明显的隐藏恶意行为。
2.  **公开的利用方式：**  该漏洞的利用方法和原理已经被广泛公开，如果代码中存在隐藏的恶意行为，很容易被发现。
3.  **依赖 Docker 环境：**  POC 需要在特定的 Docker 环境下运行，这增加了攻击者修改 Dockerfile 或其他配置以进行投毒的难度。
4. 少量风险来源于依赖的docker镜像，理论上存在被投毒的可能性。

**利用方式：**
1.  **触发缓冲区下溢：**  攻击者通过构造包含换行符（`%0A`）的 URL，绕过 `fastcgi_split_path_info` 指令的正则匹配，导致 `PATH_INFO` 为空。
2.  **控制 `path_info` 指针：** 通过精心构造 URL 的长度，攻击者可以使 `path_info` 指针指向 `_fcgi_data_seg` 结构体的起始位置。
3.  **覆盖 FCGI 变量：**  通过向 `path_info` 写入数据，覆盖 `_fcgi_data_seg` 结构体，包括其他 FastCGI 变量。
4.  **伪造 `PHP_VALUE`：**  攻击者可以伪造 `PHP_VALUE` FCGI 变量，设置恶意的 PHP 配置选项。
5.  **远程代码执行：** 通过设置 `PHP_VALUE` 中的配置选项，如 `allow_url_include` 和 `auto_prepend_file`，攻击者可以包含远程文件，最终实现远程代码执行。

简单来说, Nginx将请求传递给PHP-FPM, 由于Nginx配置不当, 允许攻击者通过特定格式的URL触发PHP-FPM的缓冲区溢出, 覆盖内存中的数据, 从而执行任意代码.

**项目地址:** [kriskhub/CVE-2019-11043](https://github.com/kriskhub/CVE-2019-11043)

**漏洞详情:** [CVE-2019-11043](https://nvd.nist.gov/vuln/detail/CVE-2019-11043)