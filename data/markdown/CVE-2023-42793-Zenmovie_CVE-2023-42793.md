## CVE-2023-42793 - JetBrains TeamCity 身份验证绕过导致RCE

**漏洞编号:** CVE-2023-42793

**漏洞类型:** 身份验证绕过导致RCE

**影响应用:** JetBrains TeamCity

**危害等级:** 严重，未经身份验证的攻击者可以执行任意代码。

**影响版本:** < 2023.05.4

**利用条件:** 目标TeamCity实例需要开启网络访问，且版本低于2023.05.4。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2023-42793是JetBrains TeamCity中的一个严重漏洞，允许未经身份验证的远程攻击者绕过身份验证，并在服务器上执行任意代码。根据漏洞库信息，CVSS评分为9.8（严重）。

**利用方式：**

1.  **身份验证绕过：** 攻击者利用未经身份验证的REST API端点`/app/rest/users/id:1/tokens/RPC2`来获取一个有效的Bearer Token。这个Token最初的设计目的是允许用户通过API管理自己的Token。
2.  **修改内部属性：** 使用获取的Token，通过POST请求访问`/admin/dataDir.html?action=edit&fileName=config/internal.properties&content=rest.debug.processes.enable=true`修改内部属性，启用`rest.debug.processes.enable`，此步骤为后续RCE做准备。
3.  **远程代码执行：**  利用被启用的REST API端点`/app/rest/debug/processes?exePath=${COMMAND}`，通过`exePath`参数执行任意命令。该端点在正常情况下只允许经过身份验证的管理员访问，但由于身份验证绕过，未经授权的攻击者可以利用它。

**POC有效性：**

提供的POC代码包含两个脚本：`CVE-2023-42793_admin.sh`和`CVE-2023-42793_rce.sh`。

*   `CVE-2023-42793_admin.sh`脚本利用漏洞创建一个新的管理员用户（Zenmovie/Zenmovie），方便后续访问TeamCity。
*   `CVE-2023-42793_rce.sh`脚本利用漏洞执行指定的命令，并返回命令输出。

从提供的README.md中的截图以及漏洞原理来看，POC代码是有效的，可以成功利用该漏洞。

**投毒风险：**

评估投毒风险，需考虑作者是否有意在代码中添加恶意功能。

1.  **代码混淆/隐藏：** 代码没有进行明显的混淆。虽然使用了`grep`和`awk`提取Token和命令输出，但是属于正常利用。
2.  **恶意依赖：** 代码没有引入外部依赖。
3.  **后门代码：** 代码的主要功能是利用漏洞，创建管理员账户或执行命令。没有发现明显与漏洞利用无关的恶意代码，例如反弹shell、上传文件等。
4.  **隐蔽指令：**  检查代码中是否存在不易察觉的指令，例如通过环境变量、时间等触发的恶意行为。没有发现此类指令。

尽管POC的主要功能是漏洞利用，仍存在一定的投毒风险。例如，攻击者可能修改`CVE-2023-42793_rce.sh`脚本，在执行目标命令之前，先执行一些恶意操作，例如下载并执行恶意程序，添加后门账户等。这种风险很难通过静态分析完全排除，需要进行动态分析，实际运行poc代码进行监控。

因此，综合考虑，投毒风险评估为10%。这个风险主要来源于用户下载和使用POC时，可能会下载到被篡改过的恶意版本。

**结论：**

CVE-2023-42793是一个高危漏洞，利用简单，影响范围广。建议受影响的用户尽快升级到最新版本。在使用公开的POC代码时，务必谨慎，进行代码审计，并确保从可信来源下载。

**项目地址:** [Zenmovie/CVE-2023-42793](https://github.com/Zenmovie/CVE-2023-42793)

**漏洞详情:** [CVE-2023-42793](https://nvd.nist.gov/vuln/detail/CVE-2023-42793)