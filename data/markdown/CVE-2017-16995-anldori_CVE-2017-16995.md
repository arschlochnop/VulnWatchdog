## CVE-2017-16995-Linux Kernel-BPF 权限提升

**漏洞编号:** CVE-2017-16995

**漏洞类型:** 权限提升

**影响应用:** Linux Kernel

**危害等级:** 高危，本地用户可提升为root权限

**影响版本:** through 4.4

**利用条件:** 需要本地用户权限，开启了BPF syscall

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2017-16995 存在于 Linux kernel 的 `kernel/bpf/verifier.c` 文件中的 `check_alu_op` 函数中。由于不正确的符号扩展，本地用户可以利用此漏洞导致拒绝服务（内存损坏）或可能造成未指定的其他影响。

**有效性：**
根据提供的漏洞信息、搜索结果和漏洞利用代码，该漏洞的POC代码是有效的。搜索结果中多个网页都提到了此漏洞，并且在Exploit-DB上有相应的漏洞利用程序(45010)。提供的POC代码显示了成功利用该漏洞提升权限的过程。

**投毒风险：**
在提供的POC代码中，风险很低。代码主要用于创建BPF map, 将一段恶意的BPF程序加载到内核，然后利用这个程序来修改内核数据结构`cred`，以实现权限提升。从代码逻辑来看，目的是利用漏洞，而不是植入后门。其中值得注意的是，代码中检测了是否是真实的grsecurity内核，如果是，则放弃利用，这部分可以理解为作者的一种安全意识。但是不排除在其他地方存在作者隐藏的后门,所以风险给出评估值。

**利用方式：**
1.  **创建BPF map：**  程序首先创建一个BPF map，用于存储数据。
2.  **加载恶意BPF程序：**  然后，它将一段特制的BPF程序加载到内核中。这个BPF程序包含了利用符号扩展漏洞的代码，目的是在验证器中绕过安全检查。
3.  **创建socketpair()：** 程序使用socketpair创建一个双向的socket。
4.  **绑定BPF到socket：** 将BPF程序附加到socket上，使得BPF程序可以访问socket缓冲区（skbuff）。
5.  **信息泄漏：** BPF程序用于泄漏sock结构的信息，特别是`sk_rcvtimeo`的地址。
6.  **查找cred结构：** 利用泄漏的`sk_rcvtimeo`地址，进一步计算出当前进程的`cred`结构体的地址。cred 结构体保存着进程的用户ID、组ID等安全上下文信息。
7.  **修改cred结构：**  最后，程序利用BPF程序修改`cred`结构体中的UID和GID为0，从而将当前进程的权限提升为root。
8.  **执行shell：**  权限提升后，程序会执行一个shell，此时该shell拥有root权限。

**项目地址:** [anldori/CVE-2017-16995](https://github.com/anldori/CVE-2017-16995)

**漏洞详情:** [CVE-2017-16995](https://nvd.nist.gov/vuln/detail/CVE-2017-16995)