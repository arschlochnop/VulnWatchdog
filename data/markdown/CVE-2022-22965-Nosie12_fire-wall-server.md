## CVE-2022-22965 Spring4Shell

**漏洞编号:** CVE-2022-22965

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Spring Framework

**危害等级:** 高危，可导致服务器被完全控制

**影响版本:** Spring Framework versions 5.3.X prior to 5.3.18+, 5.2.x prior to 5.2.20+ and all old and unsupported versions

**利用条件:** JDK 9+，Tomcat 作为 WAR 部署，Spring MVC 或 Spring WebFlux 应用

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2022-22965 (Spring4Shell) 是一个高危的远程代码执行漏洞，影响运行在 JDK 9+ 上的 Spring MVC 或 Spring WebFlux 应用，并且需要部署在 Tomcat 中，以 WAR 包的形式部署。漏洞利用方式是通过数据绑定，允许攻击者传入恶意构造的请求参数，修改 Tomcat 的 AccessLogValve 组件，从而写入 webshell 或执行任意代码。

**有效性：**
根据漏洞信息和搜索结果，该漏洞利用确实存在并且被广泛讨论和利用。提供的Python代码实际上是一个防火墙脚本，用于检测和阻止利用 Spring4Shell 漏洞的恶意请求，而不是漏洞利用代码本身。它通过检测请求路径和请求体中是否存在已知的恶意模式来工作。因此，提供的 Python 代码并不能直接验证漏洞的有效性，但是可以作为防御措施。

**投毒风险：**
对提供的 Python 代码 `firewall_server.py` 进行了分析，该脚本的功能是检测和阻止包含特定恶意模式的HTTP请求。脚本中定义了 `BLOCKED_PATTERNS` 列表，其中包含了诸如 `/tomcatwar.jsp`，`class.module.classLoader.resources.context.parent.pipeline` 和一些编码后的字符串等模式。脚本会检查传入的请求路径和请求体，如果发现任何匹配的模式，它将返回一个 `403 Forbidden` 响应。因此，从代码的功能和内容来看，该脚本本身不包含任何投毒代码。可以认为投毒风险为 0%。

**利用方式：**
根据漏洞信息，Spring4Shell 的利用方式如下：
1.  攻击者发送一个包含恶意构造的请求，该请求的目标是 Spring MVC 或 Spring WebFlux 应用。
2.  恶意请求中的参数会利用 Spring 的数据绑定机制，尝试修改 Tomcat 的 AccessLogValve 组件的属性。
3.  通过修改 AccessLogValve 的属性，攻击者可以控制日志文件的位置和格式，从而写入任意代码（例如，一个 webshell）。
4.  一旦 webshell 被写入，攻击者就可以通过它来执行任意命令，从而控制服务器。

**项目地址:** [Nosie12/fire-wall-server](https://github.com/Nosie12/fire-wall-server)

**漏洞详情:** [CVE-2022-22965](https://nvd.nist.gov/vuln/detail/CVE-2022-22965)