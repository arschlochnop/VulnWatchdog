## CVE-2007-2447 - Samba usermap 远程命令注入

**漏洞编号:** CVE-2007-2447

**漏洞类型:** 远程命令注入

**影响应用:** Samba

**危害等级:** 高危，可能导致远程代码执行

**影响版本:** 3.0.0 through 3.0.25rc3

**利用条件:** 需要目标Samba服务器启用 'username map script' 配置，或者利用其他 MS-RPC 函数（远程打印机/文件共享管理）的漏洞

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

该漏洞存在于Samba的MS-RPC功能中，允许远程攻击者通过shell元字符执行任意命令。

**有效性：**
提供的POC代码尝试利用 `username map script` 配置。 它通过构造包含反引号和恶意命令的用户名来触发漏洞。  连接到目标服务器时，Samba 将执行此命令，从而允许攻击者获得远程代码执行权限。 根据漏洞描述和搜索结果（尤其是cvedetails.com），此方法是有效的。

**投毒风险：**
代码本身比较简洁，主要功能是构造payload并通过SMB协议发送。投毒风险较低，初步判断风险在10%左右。可能的投毒方式包括：

*   **Payload修改：** 攻击者可能修改`payload`变量，使其执行恶意操作，例如下载并执行其他恶意软件，或者植入后门。当前payload只是反弹shell，相对容易发现。
*   **依赖项：** `requirements.txt` 中指定了`pysmb`依赖。 虽然目前`pysmb`本身没有已知漏洞，但恶意攻击者可能通过MITM或者篡改PyPI索引投毒。

**利用方式：**
1.  攻击者需要找到运行Samba 3.0.0 到 3.0.25rc3 版本的服务器，并且该服务器需要启用`username map script`。
2.  攻击者运行提供的Python脚本，指定目标服务器的IP地址和端口（通常是139），以及攻击者监听连接的IP地址和端口。
3.  脚本构造包含恶意命令的用户名，并尝试连接到目标服务器。
4.  如果目标服务器存在漏洞，Samba 将执行恶意命令，并将shell反弹回攻击者。
5.  攻击者即可在目标服务器上执行任意命令。

**项目地址:** [Nosferatuvjr/Samba-Usermap-exploit](https://github.com/Nosferatuvjr/Samba-Usermap-exploit)

**漏洞详情:** [CVE-2007-2447](https://nvd.nist.gov/vuln/detail/CVE-2007-2447)