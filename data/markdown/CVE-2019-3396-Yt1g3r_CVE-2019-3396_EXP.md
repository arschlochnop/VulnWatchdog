## CVE-2019-3396 - Atlassian Confluence Widget Connector Macro SSTI RCE

**漏洞编号:** CVE-2019-3396

**漏洞类型:** 服务器端模板注入（SSTI）导致远程代码执行（RCE）

**影响应用:** Atlassian Confluence Server

**危害等级:** 高危，可导致完全控制Confluence服务器

**影响版本:** 受影响版本包括：6.6.0-6.6.11, 6.7.0-6.12.2, 6.13.0-6.13.2, 6.14.0-6.14.1

**利用条件:** 需要能够向Confluence服务器发送HTTP请求

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2019-3396是Atlassian Confluence Server中Widget Connector宏存在的一个服务器端模板注入漏洞。攻击者可以通过构造恶意的请求，利用Velocity模板引擎执行任意代码，从而完全控制Confluence服务器。 

**有效性:** 提供的POC代码有效。参考Rapid7和Exploit-DB的链接，都有公开的利用代码。POC代码 `RCE_exp.py` 使用 `requests` 库发送恶意构造的POST请求到 `/rest/tinymce/1/macro/preview` 接口，通过修改 `_template` 参数，注入Velocity模板代码，从而执行任意命令。

**投毒风险:**  代码仓库中的 `RCE_exp.py` 和 `cmd.vm` 看起来是标准的漏洞利用代码。`cmd.vm` 文件是Velocity模板代码，负责执行命令。`RCE_exp.py` 负责构造和发送HTTP请求，以及从响应中提取结果。没有发现明显的恶意代码或者后门，投毒的可能性较低。

**利用方式:**

1.  **漏洞原理：** Widget Connector宏允许用户在Confluence页面中嵌入来自外部源的内容。由于对用户提供的URL参数过滤不足，攻击者可以通过构造恶意的URL，触发服务器端模板注入。
2.  **利用步骤：**
    a.  准备一个包含恶意Velocity模板代码的文件（`cmd.vm`）。该文件包含执行命令的代码。
    b.  将 `cmd.vm` 文件放置在一个可以通过FTP或者HTTPS协议访问的服务器上。
    c.  修改 `RCE_exp.py` 脚本中的 `filename` 变量，指向 `cmd.vm` 文件的URL。
    d.  运行 `RCE_exp.py` 脚本，指定Confluence服务器的URL和要执行的命令。
    e.  脚本会发送包含恶意URL的POST请求到Confluence服务器。
    f.  Confluence服务器解析恶意URL，执行Velocity模板代码，从而执行攻击者指定的命令。
3.  **影响：** 成功利用此漏洞可以导致远程代码执行，攻击者可以获取Confluence服务器的完全控制权限，从而窃取敏感数据、篡改页面内容或者进行其他恶意活动。

**结论:**
此漏洞的POC代码有效，且利用方式相对简单，可以通过公开的POC代码进行验证。虽然搜索结果显示存在投毒的情况，但提供的代码中未发现明显的投毒迹象。此漏洞危害严重，需要及时修复。

**项目地址:** [Yt1g3r/CVE-2019-3396_EXP](https://github.com/Yt1g3r/CVE-2019-3396_EXP)

**漏洞详情:** [CVE-2019-3396](https://nvd.nist.gov/vuln/detail/CVE-2019-3396)