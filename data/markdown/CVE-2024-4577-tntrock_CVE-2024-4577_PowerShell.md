## CVE-2024-4577 - PHP-CGI Argument Injection

**漏洞编号:** CVE-2024-4577

**漏洞类型:** OS Command Injection/Remote Code Execution

**影响应用:** PHP (Windows CGI)

**危害等级:** 高危，允许远程代码执行

**影响版本:** PHP 8.1 < 8.1.29, PHP 8.2 < 8.2.20, PHP 8.3 < 8.3.8 (Windows, CGI mode with specific codepage settings)

**利用条件:** Windows服务器，运行PHP CGI模式，并开启了特定的使用"Best Fit"策略的CodePage

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2024-4577 是一个PHP-CGI参数注入漏洞，存在于Windows版本的PHP中，当使用Apache和PHP-CGI时，如果系统设置使用某些代码页，Windows可能会使用"Best-Fit"行为来替换命令行中的字符。PHP CGI模块可能会将这些字符错误地解释为PHP选项，从而允许恶意用户将选项传递给正在运行的PHP二进制文件，从而泄露脚本源代码、在服务器上运行任意PHP代码等。

**有效性：**
根据漏洞库信息和搜索结果，此漏洞是一个严重的安全问题，允许攻击者远程执行代码。提供的PoC代码尝试通过构造特殊的URL，利用`allow_url_include`和`auto_prepend_file`选项包含远程文件，从而执行任意命令。PoC代码针对Windows服务器，运行PHP CGI模式的场景。因此，如果目标满足漏洞利用的条件（Windows服务器，PHP CGI，受影响版本，特定代码页），则PoC代码很可能是有效的。

**投毒风险：**
分析提供的PoC代码仓库，其中包含的 `cve_2024_4577.ps1` 脚本主要功能是针对给定的IP地址范围，尝试利用CVE-2024-4577漏洞。脚本通过构建包含恶意PHP配置指令的URL，并发送POST请求，如果目标存在漏洞，则会执行`whoami`命令。`Invoke-RequestForIP` 函数也包括了错误处理，如果请求失败会返回错误信息，降低了误判的可能性。脚本本身看起来比较直接，投毒风险较低。主要风险点可能在于利用成功后的服务器被控制，但PoC本身的功能仅限于利用漏洞，并未发现其他恶意行为。因此，将该仓库判定为存在投毒代码的可能性较低。当然，这并不排除作者在其他未公开的代码中包含恶意行为的可能性。

**利用方式：**
1.  **环境准备：** 目标系统必须是Windows服务器，运行受影响版本的PHP，并以CGI模式运行。
2.  **确定目标IP和协议：**  扫描目标IP地址，确定哪些服务器启用了PHP CGI服务，并支持HTTP或HTTPS协议。
3.  **构造恶意URL：**  构造包含特殊参数的URL，例如：`http://target/php-cgi/php-cgi.exe?%add+allow_url_include%3Don+-d+auto_prepend_file%3Dphp%3A//input+-d+cgi.force_redirect%3D0`
4.  **发送POST请求：**  向构造的URL发送POST请求，请求体包含需要执行的PHP代码，例如：`<?php system('whoami'); die(); ?>`
5.  **执行命令：**  如果目标存在漏洞，PHP CGI将执行POST请求体中的PHP代码，攻击者即可在服务器上执行任意命令。

**总结：**
CVE-2024-4577是一个高危漏洞，利用条件较为苛刻，需要特定的Windows + PHP + CGI配置。提供的PoC代码有效性较高，可以用于验证漏洞是否存在。仓库中投毒风险较低，但仍需保持警惕。

**项目地址:** [tntrock/CVE-2024-4577_PowerShell](https://github.com/tntrock/CVE-2024-4577_PowerShell)

**漏洞详情:** [CVE-2024-4577](https://nvd.nist.gov/vuln/detail/CVE-2024-4577)