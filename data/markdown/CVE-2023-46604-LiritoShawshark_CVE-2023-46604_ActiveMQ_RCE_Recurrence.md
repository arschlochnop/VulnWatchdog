## CVE-2023-46604-Apache ActiveMQ-远程代码执行

**漏洞编号:** CVE-2023-46604

**漏洞类型:** 远程代码执行

**影响应用:** Apache ActiveMQ

**危害等级:** 高危，允许未经身份验证的远程攻击者执行任意代码

**影响版本:** < 5.15.16, < 5.16.7, < 5.17.6, < 5.18.3

**利用条件:** 需要网络访问ActiveMQ broker或client的61616端口(默认)

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2023-46604 是 Apache ActiveMQ 中的一个反序列化漏洞，位于 Java OpenWire 协议 marshaller 中。攻击者可以通过操纵 OpenWire 协议中的序列化类类型，使 broker 或 client 实例化 classpath 上的任何类，从而执行任意 shell 命令。

**有效性:** 根据漏洞库信息和搜索结果，此漏洞已经被广泛利用，并且有公开的PoC，因此提供的PoC代码应该是有效的。

**投毒风险:**  PoC代码的仓库中存在一定的投毒风险，大约为10%。主要依据是：

*   `readme.md` 提及“交第一版的时候把自己真名提交了，于是把仓库删了重新交一版”，存在作者对首次提交的安全性顾虑，表明作者可能存在安全意识薄弱。
*   虽然`poc.xml` 中的 payload 简单 (启动计算器 `calc`)，但真正的威胁在于该漏洞本身允许加载任意远程资源。因此，`poc.xml` 的简单性不能完全排除投毒可能性。作者可能上传了包含后门的`poc.xml`。
*   java代码中的`ClassPathXmlApplicationContext` 被替换为自定义的Exception，虽然这看起来是为了利用反序列化漏洞，但可能存在其他未知风险。

**利用方式:**

1.  **环境准备:** 搭建一个存在漏洞的Apache ActiveMQ环境 (版本 < 5.15.16, < 5.16.7, < 5.17.6, < 5.18.3)。 根据`readme.md`中的信息，需要确保 ActiveMQ 服务正常运行，并且端口 (默认为61616) 没有被占用。
2.  **恶意XML文件:**  创建一个恶意的Spring XML配置文件 (`poc.xml`)，其中包含要执行的命令。提供的 `poc.xml` 示例是启动计算器 (`calc`)，实际利用中可以替换为更具危害性的命令，例如下载和执行恶意payload。
3.  **HTTP服务:** 搭建一个HTTP服务器，用于托管恶意XML文件 (`poc.xml`)。
4.  **发送Payload:** 使用提供的 Java 代码 (`ExceptionResponseExploit.java`)，构造一个包含恶意XML文件URL的 `ExceptionResponse` 对象，并通过 OpenWire 协议将其发送到 ActiveMQ broker。该代码利用了 ActiveMQ 在处理异常响应时的反序列化漏洞。
5.  **远程代码执行:**  ActiveMQ broker 反序列化 `ExceptionResponse` 对象，加载并解析恶意XML文件，最终执行其中的命令，导致远程代码执行。

**项目地址:** [LiritoShawshark/CVE-2023-46604_ActiveMQ_RCE_Recurrence](https://github.com/LiritoShawshark/CVE-2023-46604_ActiveMQ_RCE_Recurrence)

**漏洞详情:** [CVE-2023-46604](https://nvd.nist.gov/vuln/detail/CVE-2023-46604)