## CVE-2019-3396-Confluence-服务器端模板注入

**漏洞编号:** CVE-2019-3396

**漏洞类型:** 服务器端模板注入

**影响应用:** Atlassian Confluence Server

**危害等级:** 高危，可能导致远程代码执行

**影响版本:** 受影响版本: 6.6.12之前 (6.6.x修复版本); 6.7.0 到 6.12.3之前 (6.12.x修复版本); 6.13.0 到 6.13.3之前 (6.13.x修复版本); 6.14.0 到 6.14.2之前 (6.14.x修复版本)

**利用条件:** 需要目标Confluence Server存在Widget Connector宏且未打补丁，攻击者需要能够访问Confluence Server的网络。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2019-3396是Atlassian Confluence Server中Widget Connector宏存在的一个服务器端模板注入漏洞。攻击者可以通过构造恶意的请求，利用Velocity模板引擎执行任意代码，从而实现远程代码执行。根据提供的漏洞利用代码，利用方式如下：

1.  **漏洞利用代码分析：**
    *   `cmd.vm`：包含一个Velocity模板，该模板利用java.lang.Runtime类执行系统命令。变量`$cmd`需要预先设置，然后注入到Velocity模板中。
    *   `nc.py`：一个Python脚本，用于建立反向连接shell。该脚本尝试连接到攻击者指定的IP地址和端口，然后将标准输入、输出和错误重定向到socket，最后使用pty.spawn启动一个shell。
    *   `README.md`：仅包含漏洞ID，无实际利用功能。

2.  **利用方式：**
    攻击者首先需要确定目标Confluence Server存在该漏洞。然后，攻击者需要构造一个包含恶意Velocity模板的请求，将`cmd.vm`中的模板内容嵌入到Widget Connector宏中，并设置`$cmd`变量为需要执行的命令。如果需要反向连接，则`$cmd`变量设置为执行`nc.py`脚本。攻击者需要在自己的服务器上监听指定的端口。当Confluence Server解析该恶意请求时，会执行其中的Velocity模板代码，从而执行攻击者指定的系统命令或反向连接。

3.  **有效性：**
    根据漏洞库信息和搜索结果，该漏洞利用POC是有效的。搜索结果中存在多个分析和利用示例，以及利用该漏洞传播恶意软件的案例。提供的`cmd.vm`代码是典型的Velocity模板注入payload，可以执行任意命令。

4.  **投毒风险：**
    `nc.py`脚本尝试清除和禁用历史记录，这可能是为了隐藏攻击痕迹。此外，需要手动设定IP地址与端口，存在一定的部署成本，不太利于大规模传播。因此，该仓库的整体投毒风险较低，大约为10%。这种投毒风险主要来自于攻击者可以修改nc.py或者cmd.vm文件，嵌入后门代码，一旦成功执行，会直接暴露服务器，但是这种添加的成本较高,收益相对较低。

**项目地址:** [am6539/CVE-2019-3396](https://github.com/am6539/CVE-2019-3396)

**漏洞详情:** [CVE-2019-3396](https://nvd.nist.gov/vuln/detail/CVE-2019-3396)