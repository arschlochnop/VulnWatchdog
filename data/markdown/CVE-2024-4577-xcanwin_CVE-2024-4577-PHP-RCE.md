## CVE-2024-4577 PHP-CGI RCE

**漏洞编号:** CVE-2024-4577

**漏洞类型:** 远程代码执行

**影响应用:** PHP (Windows)

**危害等级:** 高危，允许未经身份验证的攻击者在受影响的服务器上执行任意代码

**影响版本:** PHP 8.1.* before 8.1.29, 8.2.* before 8.2.20, 8.3.* before 8.3.8 (Windows with CGI)

**利用条件:** Windows 系统, PHP 以 CGI 模式运行, 且系统配置为使用某些代码页并开启“Best Fit”策略。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-4577 是一个 PHP-CGI 远程代码执行漏洞，存在于 Windows 版本的 PHP 中，当 PHP 以 CGI 模式运行时，由于 Windows 的“Best-Fit”代码页转换行为，攻击者可以通过构造特殊字符，使得传递给 PHP 二进制文件的命令行参数被错误解析，从而注入恶意 PHP 配置项，最终实现远程代码执行。

**有效性：**

根据漏洞库信息、搜索结果和提供的漏洞利用代码，此漏洞利用是有效的。漏洞库信息将其标记为“CRITICAL”，并且CISA的已知漏洞利用目录 (KEV) 中也包含了此漏洞，表明该漏洞已被积极利用。搜索结果也证实了这一点，众多安全厂商都观察到了该漏洞的利用尝试。

**投毒风险：**

虽然提供的 Python 脚本 `CVE-2024-4577-PHP-RCE.py` 看起来主要用于漏洞利用，但仍存在一些潜在的投毒风险，可能性评估为10%。

1.  **依赖风险：** 该脚本依赖 `requests` 和 `socket` 库，如果运行脚本的环境中这些库被篡改，则可能导致恶意代码执行。但这种风险属于环境依赖，而非代码本身包含恶意逻辑。
2.  **隐蔽性：** EXP1建立fastcgi端口监听，可能被攻击者利用进行持久性控制，如果被恶意攻击者修改，会导致服务端被持续控制。
3.  **脚本功能：** 脚本本身包含两个EXP，EXP1可用于绕过WAF和默认环境的利用, EXP2可用于SSRF和默认场景。

总体来说，这个PoC的投毒风险较低，主要集中在依赖库和脚本被篡改的可能性上。如果直接从作者提供的git仓库中下载, 投毒风险会更低,因为代码经过更多人的review.

**利用方式：**

该漏洞的利用方式涉及以下几个步骤：

1.  **触发代码页转换：** 攻击者构造包含特定多字节字符的 URL 或请求，这些字符会被 Windows 的“Best-Fit”策略转换为其他字符。
2.  **注入 PHP 配置项：** 转换后的字符被 PHP-CGI 模块错误地解析为 PHP 配置项，例如 `allow_url_include` 和 `auto_prepend_file`。
3.  **包含远程文件或执行代码：** 通过设置 `allow_url_include` 为 `on` 并结合 `auto_prepend_file`，攻击者可以包含远程文件或直接执行 PHP 代码。例如，可以使用 `data://` 协议注入恶意 PHP 代码。

提供的 POC 代码 `CVE-2024-4577-PHP-RCE.py` 包含两种利用方式:

*   **EXP1:**  通过建立 FastCGI 服务端，并发送构造好的 FastCGI 协议数据，实现绕过 WAF 的 RCE。
*   **EXP2:** 模拟HTTP请求，通过`?%adb{}:{}` 在请求中注入特定的字符。这种方法模拟了攻击者通过发送畸形请求来触发漏洞的行为。

总而言之，该漏洞利用需要在特定的 Windows + PHP-CGI 环境下，通过构造特殊的请求来注入恶意 PHP 配置项，最终实现远程代码执行。

**项目地址:** [xcanwin/CVE-2024-4577-PHP-RCE](https://github.com/xcanwin/CVE-2024-4577-PHP-RCE)

**漏洞详情:** [CVE-2024-4577](https://nvd.nist.gov/vuln/detail/CVE-2024-4577)