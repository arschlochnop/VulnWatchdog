## CVE-2019-5420 - Rails Development Mode 远程代码执行

**漏洞编号:** CVE-2019-5420

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Rails

**危害等级:** 高危，可能导致服务器完全控制

**影响版本:** < 5.2.2.1, < 6.0.0.beta3

**利用条件:** Rails 应用运行在开发模式下，并且攻击者能够访问该应用。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

该漏洞存在于 Rails 开发模式下，当 Rails 版本低于 5.2.2.1 或 6.0.0.beta3 时，攻击者可以猜测自动生成的开发模式 secret token。这个 secret token 可以与 Rails 内部机制结合，从而实现远程代码执行。

**漏洞利用方式：**

1.  **获取 Secret Key Base：** 攻击者需要首先获取到 Rails 应用的 `secret_key_base`。在开发模式下，这个密钥通常是基于应用名称生成的，因此相对容易猜测。PoC 代码中通过 `Digest::MD5.hexdigest(VerifierRce::Application.name)` 演示了如何计算 `secret_key_base`。
2.  **生成 ActiveStorage 密钥：** 使用 `secret_key_base` 和 `ActiveSupport::KeyGenerator` 生成用于 `ActiveStorage` 的密钥。
3.  **构建恶意 Payload：** 攻击者需要构建一个恶意 Ruby 对象，该对象在反序列化时会执行任意命令。PoC 中展示了利用 `system` 函数执行 shell 命令的方式。
4.  **利用 ActiveSupport::MessageVerifier 或 ActiveSupport::MessageEncryptor：** 使用生成的密钥，通过 `ActiveSupport::MessageVerifier` 或者 `ActiveSupport::MessageEncryptor` 对恶意对象进行签名，然后将签名后的数据作为参数传递给存在漏洞的路由（例如 `/rails/active_storage/disk/:encoded_key`）。
5.  **触发反序列化：** 当 Rails 应用接收到包含恶意签名的请求时，会使用 `Marshal.load` 对签名进行反序列化，从而执行攻击者注入的命令。

**投毒风险分析：**

PoC 代码主要用于演示漏洞的利用过程，本身并没有明显的恶意代码。风险点在于 Docker 镜像 `knqyf263/cve-2019-5420` 是否包含后门。该镜像由第三方提供，存在一定风险，建议在使用前进行安全审计。

`https://github.com/PenTestical/CVE-2019-5420` 这个仓库本身看起来是用于记录漏洞信息的，readme.md 中包含下载第三方docker镜像，存在第三方镜像投毒的风险。

**风险评估：**

*   POC的有效性高，因为漏洞原理清晰，且有相应的验证方法。
*   投毒风险评估为10%， 主要来自 docker 镜像，作者本身可能为了快速验证漏洞选择使用现成的镜像，这导致了存在一定的投毒风险。 另外一种风险是仓库中存在一些链接，这些链接可能存在风险。 实际投毒风险评估取决于对镜像的详细审计以及链接指向的安全性。

**项目地址:** [laffray/ruby-RCE-CVE-2019-5420-](https://github.com/laffray/ruby-RCE-CVE-2019-5420-)

**漏洞详情:** [CVE-2019-5420](https://nvd.nist.gov/vuln/detail/CVE-2019-5420)