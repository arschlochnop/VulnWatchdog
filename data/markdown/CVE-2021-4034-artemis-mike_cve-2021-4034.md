## CVE-2021-4034-polkit-pkexec本地提权

**漏洞编号:** CVE-2021-4034

**漏洞类型:** 本地权限提升

**影响应用:** polkit

**危害等级:** 高危，允许低权限用户获得root权限

**影响版本:** all

**利用条件:** 需要本地用户权限

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-4034 (PwnKit) 是 polkit 的 pkexec 工具中的一个本地权限提升漏洞。pkexec 是一个 setuid 工具，允许非特权用户根据预定义的策略以特权用户身份运行命令。漏洞在于 pkexec 未能正确处理调用参数计数，导致尝试将环境变量作为命令执行。攻击者可以通过精心设计的环境变量来诱使 pkexec 执行任意代码，从而获得 root 权限。

**有效性：**
提供的 PoC 代码利用了上述漏洞，通过构造特定的环境变量 `GCONV_PATH=.` 和 `LC_MESSAGES=en_US.UTF-8` ，使得 pkexec 尝试加载当前目录下的 Gconv 模块。这个 Gconv 模块实际上是一个恶意共享对象 (payload.so)，包含提权代码。 编译后的c文件, 通过设置uid，guid为0，即root权限, 再执行 `whoami`命令。

**投毒风险：**
此仓库可能存在轻微的投毒风险，几点考虑如下：

1.  **外部依赖：** Playbook使用了 `asses_CVE-2021-4034.yml`，需要用户手动修改`hosts` 变量,执行`ansible-playbook` 命令。 如果playbook内容被篡改可能会造成非预期结果。
2.  **代码可读性：**  代码可读性一般，存在少量注释。虽然作者声明仅用于教育目的，并且提示用户对执行的代码负责，但仍然可能存在潜在的风险。
3. **payload.c潜在风险:** `payload.c` 中虽然执行的是 `whoami`, 但如果被修改成其他恶意命令，可能会造成破坏。
4. 提供的YAML文件尝试删除利用过程中创建的临时文件，但不能保证所有文件都被完全清理。如果清理不彻底，可能会留下潜在的安全隐患。

**总体而言，投毒风险较低，大概为 10%。主要是playbook执行的不可控因素，以及payload.c被篡改的风险。**

**利用方式：**
1.  **编译PoC：** 使用 `gcc -Wall cve-2021-4034.c -o cve-2021-4034-exploit` 命令编译 C 语言 PoC 代码。
2.  **修改Playbook:**  修改 `asses_CVE-2021-4034.yml` 中的 `hosts` 变量，指定目标主机。
3.  **执行Playbook：** 使用 `ansible-playbook -i </path/to/inventory.yml> </path/to/playbooks/>asses_CVE-2021-4034.yml` 命令执行 Ansible playbook。
4.  **验证结果：** 检查 playbook 的执行结果。如果 `Check result of privilege escalation` 任务失败，则表示提权成功。

实际上，该 exploit 的核心思路是通过创建 GCONV_PATH 目录和 LC_MESSAGES 环境变量，使得 pkexec 尝试加载恶意共享对象，从而执行共享对象中的提权代码。该代码首先将当前进程的 UID 和 GID 设置为 0 (root)，然后再执行 whoami 命令。如果执行成功, `whoami` 的结果将是 root，表示提权成功。

**项目地址:** [artemis-mike/cve-2021-4034](https://github.com/artemis-mike/cve-2021-4034)

**漏洞详情:** [CVE-2021-4034](https://nvd.nist.gov/vuln/detail/CVE-2021-4034)