## CVE-2022-0847 (Dirty Pipe)

**漏洞编号:** CVE-2022-0847

**漏洞类型:** 本地权限提升

**影响应用:** Linux Kernel

**危害等级:** 高危，可导致普通用户提升至root权限

**影响版本:** Linux Kernel 5.17 rc6 (及部分其他版本，需根据具体补丁情况判断)

**利用条件:** 需要本地用户权限

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2022-0847，又名Dirty Pipe，是一个Linux内核中的权限提升漏洞。漏洞原因是`copy_page_to_iter_pipe`和`push_pipe`函数中新的管道缓冲区结构的"flags"成员缺乏适当的初始化，可能包含陈旧的值。未经授权的本地用户可以利用此漏洞写入由只读文件支持的页面缓存中的页面，从而提升他们在系统上的权限。

**漏洞利用方式：**
1.  利用`pipe()`创建管道。
2.  打开一个只读文件进行读取操作，填充管道缓冲区。
3.  通过`splice()`或类似机制将文件内容复制到管道。
4.  利用漏洞，未初始化或错误的flags允许写入只读页面。
5.  使用`write()`向管道写入恶意数据，覆盖只读文件内容。
6.  如果覆盖的是SUID程序，则可以执行该程序以提升权限。示例代码中，通过修改`/etc/passwd`文件，添加一个已知密码的root用户，从而获取root权限。
7.  该POC代码提供了一个 `--root`选项，简化了利用过程，将攻击代码模块化，方便修改和使用。

**投毒风险评估：**
该仓库中存在一定的投毒风险。虽然大部分代码看起来是标准的Dirty Pipe漏洞利用，但其中修改`/etc/passwd`的方式本身就是一个潜在的后门。此外，代码中硬编码了用于获取root权限的密码`el3ph@nt!`，如果攻击者直接使用该代码，可能会暴露其攻击行为。存在植入其他恶意代码的可能性，例如：篡改其他重要系统文件，添加定时任务等。尽管该POC的目的是简化漏洞利用过程，但这种简化也可能被恶意利用。

综上，投毒风险约为10%，主要集中在利用代码被修改或用于超出漏洞利用范围的恶意行为上。


**项目地址:** [n3rada/DirtyPipe](https://github.com/n3rada/DirtyPipe)

**漏洞详情:** [CVE-2022-0847](https://nvd.nist.gov/vuln/detail/CVE-2022-0847)