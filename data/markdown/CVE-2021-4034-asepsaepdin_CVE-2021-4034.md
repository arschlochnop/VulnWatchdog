## CVE-2021-4034 (PwnKit)

**漏洞编号:** CVE-2021-4034

**漏洞类型:** 本地权限提升

**影响应用:** Polkit pkexec

**危害等级:** 高危，允许非特权用户获得root权限

**影响版本:** 所有受影响版本

**利用条件:** 目标系统存在 Polkit pkexec 且未修复

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2021-4034 (PwnKit) 是 Polkit pkexec 实用程序中的一个本地权限提升漏洞。pkexec 是一个 setuid 工具，旨在允许非特权用户根据预定义的策略以特权用户身份运行命令。该漏洞是由于 pkexec 没有正确处理调用参数计数，最终导致尝试将环境变量作为命令执行。攻击者可以通过精心制作环境变量，诱使 pkexec 执行任意代码，从而获得 root 权限。

**有效性：**

根据漏洞描述、搜索结果和提供的 PoC 代码，可以判定该漏洞是有效的。多个来源（包括 NVD、Qualys、Red Hat 等）都确认了此漏洞，并且存在公开可用的 PoC 代码。该 PoC 代码通过创建特定的目录结构和环境变量来利用此漏洞，从而导致 pkexec 执行攻击者控制的代码，最终提升到 root 权限。

**投毒风险：**

分析提供的 PoC 代码 `cve-2021-4034-poc.c`。代码首先创建 `GCONV_PATH=.` 目录和 `pwnkit` 目录，然后将恶意 shellcode 写入 `pwnkit/pwnkit.c`，编译成动态链接库 `pwnkit/pwnkit.so`。最后，通过设置环境变量 `pwnkit`, `PATH`, `CHARSET` 和 `SHELL` 并调用 `execve("/usr/bin/pkexec", (char*[]){NULL}, env)` 来触发漏洞。其中 `pwnkit/pwnkit.c` 中包含的代码负责提升权限并执行 `/bin/sh`。

代码本身利用了漏洞，没有发现明显的恶意后门或植入代码，判断投毒风险为 0%。

**利用方式：**

1.  **环境准备：** 创建 `GCONV_PATH=.` 目录，并创建一个名为 `GCONV_PATH=./pwnkit` 的文件（用于欺骗 pkexec）。创建一个 `pwnkit` 目录，其中包含 `gconv-modules` 文件，指定使用自定义的 gconv 模块。
2.  **恶意 GConv 模块：** 创建一个恶意的 gconv 模块（`pwnkit/pwnkit.c`），该模块包含在加载时提升权限并执行 shell 的代码。
3.  **编译：** 将该 C 代码编译成共享对象（`.so` 文件），作为 gconv 模块。
4.  **环境变量：** 设置特定的环境变量，例如 `GCONV_PATH=.`、`CHARSET=PWNKIT` 和 `SHELL=pwnkit`，以便 pkexec 加载恶意的 gconv 模块。
5.  **触发：** 运行 pkexec，由于参数处理不当，pkexec 将加载并执行恶意的 gconv 模块，从而提升权限并执行 shell。

**项目地址:** [asepsaepdin/CVE-2021-4034](https://github.com/asepsaepdin/CVE-2021-4034)

**漏洞详情:** [CVE-2021-4034](https://nvd.nist.gov/vuln/detail/CVE-2021-4034)