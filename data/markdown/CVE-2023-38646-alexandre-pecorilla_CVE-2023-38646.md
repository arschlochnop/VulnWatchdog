## CVE-2023-38646-Metabase-RCE

**漏洞编号:** CVE-2023-38646

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Metabase

**危害等级:** 高危，未经身份验证的远程代码执行

**影响版本:** < 0.46.6.1 (开源版), < 1.46.6.1 (企业版)

**利用条件:** Metabase实例对外开放，且版本低于安全版本。

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2023-38646 允许未经身份验证的攻击者在 Metabase 服务器上执行任意命令。根据漏洞库信息、搜索结果以及提供的漏洞利用代码，可以做出以下判断：

**有效性：**
提供的POC代码有效。代码利用了 Metabase 在设置过程中的一个漏洞，攻击者可以利用该漏洞通过构造恶意的数据库连接字符串来执行任意命令。

**投毒风险：**
查看提供的POC代码，并未发现明显的投毒代码。该POC脚本的功能是利用漏洞执行反弹shell，将目标机器的shell反弹到攻击者指定的IP和端口。主要逻辑都在构造payload上，没有发现作者隐藏的恶意代码。

**利用方式：**
1.  攻击者首先需要获取 Metabase 实例的 `setup-token`。这个token可以通过访问 `/api/session/properties` 接口获得，该接口无需身份验证。
2.  攻击者构造一个恶意的 `payload`，其中包含恶意的数据库连接字符串。该字符串利用 H2 数据库的特性，在连接时执行任意 Java 代码。
3.  攻击者将构造的 `payload` 发送到 `/api/setup/validate` 接口。
4.  Metabase 尝试连接恶意数据库，从而触发漏洞，执行攻击者指定的命令，实现远程代码执行。具体是通过创建一个触发器，在查询 `INFORMATION_SCHEMA.TABLES` 表之前执行一段 JavaScript 代码，这段代码会调用 `java.lang.Runtime.getRuntime().exec()` 来执行系统命令。
5.  POC代码中，利用 `bash -c` 和 `base64` 命令组合，执行 base64 编码后的反弹 shell 命令，实现反弹 shell。

**项目地址:** [alexandre-pecorilla/CVE-2023-38646](https://github.com/alexandre-pecorilla/CVE-2023-38646)

**漏洞详情:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)