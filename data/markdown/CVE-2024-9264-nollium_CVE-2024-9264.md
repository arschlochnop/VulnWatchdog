## CVE-2024-9264-Grafana-命令注入和文件包含

**漏洞编号:** CVE-2024-9264

**漏洞类型:** 命令注入和文件包含

**影响应用:** Grafana

**危害等级:** 严重，可导致远程代码执行和敏感信息泄露

**影响版本:** 11.0.x, 11.1.x, 11.2.x (小于 11.0.5, 11.1.6, 11.2.1, 11.0.6, 11.1.7, 11.2.2 +security-01)

**利用条件:** 需要Grafana SQL Expressions实验性功能启用，且攻击者需要具有Viewer或更高权限。目标系统需要安装DuckDB且位于系统PATH中。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-9264 存在于 Grafana 的 SQL Expressions 功能中。攻击者可以利用此漏洞执行命令注入和本地文件包含攻击。漏洞的利用方式是，Grafana 对用户提供的 duckdb 查询输入没有进行充分的过滤，导致攻击者可以通过构造恶意的 SQL 语句，执行任意命令或读取本地文件。

**有效性：**
根据漏洞信息、搜索结果和提供的 PoC 代码，该漏洞利用是有效的。PoC 代码已经提供了读取任意文件(`/etc/passwd`)和执行命令的功能，并且搜索结果中也表明存在公开的 PoC。

**投毒风险：**
PoC 代码本身具有一定的风险，可能被用于非法目的。此外，从代码分析来看，存在一定的投毒风险，因为代码的功能包括执行任意命令，这意味着攻击者可以下载并执行其他恶意脚本，从而控制受害者系统。但是当前提供的POC代码只包含文件读取和命令执行功能，未发现明显的后门或恶意代码。因此我倾向于认为投毒风险为10%。

**利用方式：**
1.  攻击者需要拥有 Grafana 的 Viewer 或更高权限。
2.  Grafana 必须启用 SQL Expressions 实验性功能。
3.  目标系统必须安装 DuckDB，并且位于系统 PATH 中。
4.  攻击者通过构造恶意的 duckdb 查询语句，利用 `read_blob` 函数读取任意文件，或者利用 shellfs 执行命令。
    *   读取文件示例：`SELECT content FROM read_blob('/etc/passwd')`
    *   执行命令示例：`SELECT * FROM read_csv('whoami > /tmp/output.txt 2>&1 |')`，然后读取 `/tmp/output.txt` 来获取命令执行结果。

**排序优先级理由：**
搜索引擎结果优先级最高，因为可以直接获取到该漏洞的概要信息，利用条件，利用方式等。其次是漏洞利用代码，利用代码验证了漏洞是真实可用的。最后是漏洞库信息，是对漏洞最基础的描述。

**项目地址:** [nollium/CVE-2024-9264](https://github.com/nollium/CVE-2024-9264)

**漏洞详情:** [CVE-2024-9264](https://nvd.nist.gov/vuln/detail/CVE-2024-9264)