## CVE-2021-26855 Microsoft Exchange Server Remote Code Execution Vulnerability (ProxyLogon)

**漏洞编号:** CVE-2021-26855

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Microsoft Exchange Server

**危害等级:** 高危，未经身份验证的远程攻击者可以执行任意代码

**影响版本:** 受影响的版本包括：Microsoft Exchange Server 2013 Cumulative Update 21, 2013 Cumulative Update 22, 2013 Cumulative Update 23, 2016 Cumulative Update 8, 2016 Cumulative Update 9, 2016 Cumulative Update 10, 2016 Cumulative Update 11, 2016 Cumulative Update 12, 2016 Cumulative Update 13, 2016 Cumulative Update 14, 2016 Cumulative Update 15, 2016 Cumulative Update 16, 2016 Cumulative Update 17, 2016 Cumulative Update 18, 2016 Cumulative Update 19, 2019 Cumulative Update 1, 2019 Cumulative Update 2, 2019 Cumulative Update 3, 2019 Cumulative Update 4, 2019 Cumulative Update 5, 2019 Cumulative Update 6, 2019 Cumulative Update 7, 2019 Cumulative Update 8

**利用条件:** 需要目标Exchange Server开放443端口，且未安装相关安全补丁

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2021-26855 (ProxyLogon) 是一种存在于 Microsoft Exchange Server 中的服务器端请求伪造 (SSRF) 漏洞。未经身份验证的远程攻击者可以通过发送精心构造的 HTTP 请求来利用此漏洞，从而能够伪造身份并执行其他恶意操作。从搜索结果来看，该漏洞被广泛利用。提供的PoC代码展示了利用该漏洞获取远程代码执行权限的过程。

**漏洞利用方式：**

1.  **SSRF (CVE-2021-26855):** 首先，利用SSRF漏洞发送任意HTTP请求，目的是绕过身份验证，获取有效的LegacyDN。
2.  **获取 LegacyDN:** 通过构造Autodiscover请求，获取目标用户的 LegacyDN。
3.  **MAPI 连接:** 使用获取的LegacyDN建立一个MAPI会话。
4.  **获取 SID:** 从MAPI响应中提取用户的安全标识符 (SID)。
5.  **ProxyLogon:** 利用ProxyLogon机制，将用户SID修改为管理员SID，从而提升权限。
6.  **写入 Webshell:** 利用提升的权限，向服务器写入webshell，实现远程代码执行。

**投毒风险分析：**

代码中存在以下潜在的投毒风险：

*   **硬编码的路径和文件名：** `shell_path`和`shell_absolute_path`以及`ahihi7.aspx`是硬编码的，这使得webshell容易被检测和移除，但如果攻击者修改了这些值，可能会将webshell写入到更隐蔽的位置。
*   **webshell 内容：** `shell_content`包含执行 `whoami` 命令的JavaScript代码，这是一个简单的测试命令。攻击者可以修改`shell_content`以执行更具破坏性的操作。虽然当前代码只是执行`whoami`，但不能排除攻击者将恶意代码注入`shell_content`的可能性。这一部分存在被恶意修改进行投毒的可能性。
*   **代理URI (`msExchProxyUri`)**: PoC代码中 `msExchProxyUri` 设置为`http://127.0.0.1:8080/`，这意味着攻击者可能尝试通过本地代理进行其他攻击，或者将流量转发到恶意服务器。虽然现在指向本地，但存在被修改指向恶意地址的可能性。

虽然这些风险存在，但整体代码看起来是为了验证漏洞，主要的目的是为了RCE，没有明显的隐藏后门或者其他恶意行为。因此，投毒风险较低, 约5%。

**项目地址:** [thau0x01/poc_proxylogon](https://github.com/thau0x01/poc_proxylogon)

**漏洞详情:** [CVE-2021-26855](https://nvd.nist.gov/vuln/detail/CVE-2021-26855)