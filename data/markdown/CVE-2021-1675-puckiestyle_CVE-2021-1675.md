## CVE-2021-1675 PrintNightmare

**漏洞编号:** CVE-2021-1675

**漏洞类型:** 远程代码执行

**影响应用:** Windows Print Spooler

**危害等级:** 高危，可导致 SYSTEM 权限的远程代码执行

**影响版本:** 受影响的Windows版本和版本号请参考漏洞库信息

**利用条件:** 目标系统开启Print Spooler服务, 攻击者需要有权限连接到目标系统的Print Spooler服务。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-1675 (PrintNightmare) 是一个 Windows Print Spooler 服务中的远程代码执行漏洞。攻击者可以利用此漏洞在目标系统上以 SYSTEM 权限执行任意代码。根据漏洞库信息和搜索引擎结果，此漏洞影响多个 Windows 版本。提供的 PowerShell 脚本 `CVE-2021-1675.ps1` 是一个利用此漏洞的 PoC 代码，它通过添加恶意的打印机驱动程序来执行代码。

**有效性：**
根据搜索结果和漏洞利用代码分析，该漏洞是有效的。多个安全厂商和研究人员已经发布了关于此漏洞的分析和利用方法。PoC 代码通过调用 `AddPrinterDriverEx` 函数来添加恶意的打印机驱动程序，从而实现代码执行。

**投毒风险：**
PoC 代码本身具有一定的投毒风险，因为它可以被修改为执行任意恶意代码。例如，攻击者可以将 `Invoke-Nightmare` 函数中的 `$DLL` 参数指向一个包含恶意代码的 DLL 文件。此外，即使使用默认的 DLL，该 DLL 的目的是创建具有已知密码的管理员帐户，这也可能被视为一种后门或投毒行为。代码中，`get_nightmare_dll` 函数返回的字节数组就是payload，此payload用于创建一个新的本地管理员用户,并添加到本地管理员组。如果攻击者在未授权的情况下使用此代码，则可以利用此漏洞来控制目标系统。`$delete_me` 变量用于决定是否删除生成的DLL文件，可以被修改为不删除DLL，方便后续利用。

**利用方式：**
1.  攻击者需要拥有目标系统的访问权限，至少需要能够连接到Print Spooler服务。
2.  攻击者运行 `CVE-2021-1675.ps1` 脚本，指定恶意 DLL 文件的路径，或者使用内置的payload创建管理员账号。
3.  脚本通过调用 `AddPrinterDriverEx` 函数来添加恶意的打印机驱动程序。
4.  当打印机驱动程序被加载时，其中的恶意代码将以 SYSTEM 权限执行。
5.  通过创建的管理员帐户或直接执行的payload，攻击者可以完全控制目标系统。

**项目地址:** [puckiestyle/CVE-2021-1675](https://github.com/puckiestyle/CVE-2021-1675)

**漏洞详情:** [CVE-2021-1675](https://nvd.nist.gov/vuln/detail/CVE-2021-1675)