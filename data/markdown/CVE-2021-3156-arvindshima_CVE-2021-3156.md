## CVE-2021-3156 - Sudo Baron Samedit

**漏洞编号:** CVE-2021-3156

**漏洞类型:** Heap-based Buffer Overflow

**影响应用:** Sudo

**危害等级:** 高危，允许本地用户提升权限至root

**影响版本:** < 1.9.5p2

**利用条件:** 本地用户能够执行 sudo 命令

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2021-3156（Baron Samedit）是一个存在于 Sudo 1.9.5p2 之前的版本中的堆缓冲区溢出漏洞。该漏洞允许任何本地用户利用 `sudoedit -s` 命令和一个以单个反斜杠字符结尾的命令行参数来提升权限至 root。

**有效性：**

根据提供的漏洞信息、搜索引擎结果以及漏洞利用代码，可以判断此漏洞的POC代码有效。多个来源（Qualys blog, NCC Group blog, RedHat, BeyondTrust等）均表明此漏洞是可利用的，且利用后可获得root权限。提供的代码包含Dockerfile，Makefile，exploit.c，shellcode.c和README.md，构建和运行均有详尽说明，且漏洞利用代码中已包含详细的注释信息，表明其利用方式是可行的。

**投毒风险：**

分析提供的 POC 代码，投毒风险较低。理由如下：

*   **公开的漏洞：** 该漏洞（CVE-2021-3156）是公开且被广泛研究的漏洞，由Qualys等安全公司发现并公布了细节。
*   **代码可读性：** 提供的C代码（`exploit.c`和`shellcode.c`）相对简单，功能清晰，没有明显的恶意行为。
*   **Docker环境：** Dockerfile创建了一个隔离的测试环境，限制了潜在的恶意行为。
*   **Shellcode功能：** `shellcode.c` 中的 shellcode 主要功能是 setuid(0), setgid(0) 和 execve("/bin/sh")，这是一个典型的提权 shellcode，用于获得 root shell，是漏洞利用的正常组成部分，而不是后门程序。

但是，仍然存在很低的投毒风险，概率约为 5%。虽然 shellcode 的主要功能是提权并执行 /bin/sh，但攻击者仍然可以在 shellcode 中添加一些额外的恶意代码，例如：
    *   **信息收集：** 收集系统信息并发送到远程服务器。
    *   **持久化后门：** 在系统中植入后门，以便长期控制。

尽管如此，考虑到漏洞本身的性质（本地提权）和代码的整体可读性，直接植入恶意后门的风险相对较低。

**利用方式：**

1.  **缓冲区溢出：**  漏洞利用的核心是 `sudoedit -s` 命令处理参数时存在的 off-by-one 错误，这导致了堆缓冲区溢出。
2.  **堆 Feng-Shui：**  通过设置 `LC_*` 环境变量，在堆上布置特定的内存结构，以便溢出能够覆盖关键数据结构，特别是 `service_user` 结构体。
3.  **覆盖 service_user 结构：**  利用溢出，用指向 shellcode 库（`libnss_x/x.so.2`）的路径覆盖 `service_user` 结构体中的 `files` 字段。
4.  **执行 Shellcode：**  当 sudo 尝试使用被覆盖的 `files` 字段加载库时，实际上加载并执行了包含提权 shellcode 的库。
5.  **Root Shell：**  Shellcode 执行 `setuid(0)` 和 `setgid(0)` 将用户 ID 和组 ID 设置为 root，然后执行 `/bin/sh`，从而获得 root shell。

**项目地址:** [arvindshima/CVE-2021-3156](https://github.com/arvindshima/CVE-2021-3156)

**漏洞详情:** [CVE-2021-3156](https://nvd.nist.gov/vuln/detail/CVE-2021-3156)