## CVE-2021-31630 - OpenPLC Webserver v3 远程代码执行

**漏洞编号:** CVE-2021-31630

**漏洞类型:** 命令注入

**影响应用:** OpenPLC Webserver

**危害等级:** 高危，允许未经授权的远程代码执行

**影响版本:** v3

**利用条件:** 需要目标系统运行OpenPLC Webserver v3，并且攻击者能够访问/hardware页面，并具有有效用户凭据。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

根据漏洞库信息和搜索结果，CVE-2021-31630 允许远程攻击者通过 "Hardware Layer Code Box" 组件在 "/hardware" 页面执行任意代码。提供的漏洞利用代码是一个 Python 脚本，它利用了 OpenPLC Webserver v3 中的命令注入漏洞。

**有效性：**

根据漏洞利用代码和描述，该 PoC 脚本的有效性较高。它首先尝试登录到 OpenPLC Webserver，然后利用硬件层代码框中的漏洞执行命令。该脚本修改自其他公开的 PoC，修复了 cookie 获取的问题，表明之前的 PoC 可能存在问题，而该脚本尝试解决这些问题，增加了其有效性。从 github 仓库描述得知，此脚本作者可能已经验证过其有效性。

**投毒风险：**

分析 PoC 代码，投毒风险较低，约为 10%。主要风险点在于：

*   **`LHOST` 和 `LPORT` 变量：** 脚本使用 `LHOST` 和 `LPORT` 变量指定反向 shell 的地址和端口。攻击者可能将这些值设置为指向恶意服务器，诱使用户执行恶意代码。但这种风险较低，因为用户通常会根据自己的环境修改这些值。
*   **依赖安装风险:** 用户在执行`pip3 install requests`时，可能会因为网络问题或者拼写错误安装了恶意包。但是这种风险较低，因为 `requests` 是一个非常常见的 Python 库。


总体来说，PoC 本身实现的逻辑是为了执行反弹shell， 属于漏洞利用的正常行为。恶意代码通常不会直接嵌入到这种类型的 PoC 中，因为这会降低其可用性和可信度。风险主要存在于用户对脚本的配置，用户在没有充分了解的情况下更改了LHOST和LPORT等信息，或者安装了恶意依赖项的情况。

**利用方式：**

1.  **身份验证：** 首先，攻击者需要使用有效的用户名和密码登录到 OpenPLC Webserver v3。
2.  **获取 Cookie：** 登录成功后，脚本会从响应头中提取 session cookie。这是利用漏洞的关键，因为后续请求需要使用该 cookie 进行身份验证。
3.  **上传恶意代码：** 脚本构造包含恶意命令的 payload，并将其发送到 "Hardware Layer Code Box" 组件。该 payload 利用命令注入漏洞执行任意代码。
4.  **执行命令：** 注入的命令通常用于建立反向 shell，从而允许攻击者远程控制受感染的系统。脚本中的代码包含建立反向 shell 的代码。
5.  **反向 Shell:** 上传的恶意代码会在目标主机上执行，并反弹shell到攻击者的LHOST和LPORT指定的地址。

该漏洞的成功利用，将导致远程代码执行，从而允许攻击者完全控制受影响的 OpenPLC Webserver 系统。

**项目地址:** [manuelsantosiglesias/CVE-2021-31630](https://github.com/manuelsantosiglesias/CVE-2021-31630)

**漏洞详情:** [CVE-2021-31630](https://nvd.nist.gov/vuln/detail/CVE-2021-31630)