## CVE-2022-30190 - Microsoft MSDT RCE (Follina)

**漏洞编号:** CVE-2022-30190

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Microsoft Windows Support Diagnostic Tool (MSDT)

**危害等级:** 高危，允许攻击者以调用应用程序的权限执行任意代码

**影响版本:** 受影响的Windows版本包括Windows 7 SP1到Windows 11 21H2，具体版本范围见漏洞库信息。

**利用条件:** 用户需要打开恶意的Word文档。攻击者需要能够托管一个HTTP服务器。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

该漏洞 (CVE-2022-30190)，又名Follina，是由于MSDT处理URL协议不当造成的远程代码执行漏洞。攻击者可以构造一个恶意的Word文档，其中包含指向远程HTTP服务器的链接。当用户打开文档时，Word会使用MSDT通过URL协议去请求远程HTML文件。这个HTML文件包含恶意的JavaScript代码，用于执行任意命令。

**有效性：** 提供的POC代码是有效的。该代码通过以下步骤利用漏洞：

1.  创建一个恶意的Word文档，其中包含指向攻击者控制的HTTP服务器的链接。
2.  托管一个HTTP服务器，该服务器提供包含恶意JavaScript代码的HTML文件。
3.  当受害者打开Word文档时，MSDT会尝试连接到攻击者的服务器并执行恶意代码。

**投毒风险：** 存在一定的投毒风险 (10%)。

*   `folina.py`脚本本身看起来是合法的漏洞利用代码，但需要仔细检查其依赖项和网络行为。
*   虽然主要功能集中在生成漏洞利用文件和搭建HTTP服务，但仍需审查脚本中是否存在任何潜在的恶意行为，例如未记录的数据传输或额外的文件操作。
*  脚本中从github下载`nc64.exe`，如果github上的文件被替换为恶意程序，则存在被投毒风险。

**利用方式：**

1.  攻击者创建一个恶意的Word文档 (`follina.doc`)，其中包含指向远程服务器上托管的HTML文件的链接。
2.  攻击者搭建一个HTTP服务器，托管包含恶意JavaScript代码的HTML文件 (`index.html`)。这个HTML文件使用`ms-msdt:`协议触发MSDT，并执行payload。
3.  攻击者诱骗受害者打开恶意的Word文档。
4.  Word文档加载远程HTML文件，触发MSDT，从而在受害者系统上执行任意代码。

POC代码使用python编写，主要步骤如下：

*   **环境准备:**
    *   搭建Windows虚拟机(推荐Win10 21H2)，并安装Microsoft Word 2013及Python 3.8.10。
    *   关闭Windows的病毒和威胁防护。
    *   使用`pip install netifaces`安装依赖。
*   **漏洞利用：**
    *   运行`folina.py`脚本，指定监听IP地址和端口。示例：`py folina.py -i <ip-address>`
    *   脚本会生成一个恶意的Word文档 (follina.doc)，并在指定的IP地址和端口上启动一个HTTP服务器。
    *   诱骗目标用户打开该Word文档，即可触发漏洞，执行计算器程序或反弹shell。

**项目地址:** [hycheng15/CVE-2022-30190](https://github.com/hycheng15/CVE-2022-30190)

**漏洞详情:** [CVE-2022-30190](https://nvd.nist.gov/vuln/detail/CVE-2022-30190)