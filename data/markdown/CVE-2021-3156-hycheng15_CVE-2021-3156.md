## CVE-2021-3156 Sudo Baron Samedit 权限提升漏洞

**漏洞编号:** CVE-2021-3156

**漏洞类型:** 堆溢出

**影响应用:** Sudo

**危害等级:** 高危，本地权限提升至root

**影响版本:** Sudo < 1.9.5p2

**利用条件:** 本地用户可以执行sudo命令

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-3156（Baron Samedit）是Sudo 1.9.5p2之前版本中的一个堆缓冲区溢出漏洞。该漏洞位于sudo解析命令行参数的过程中。攻击者可以利用`sudoedit -s`命令和一个以单个反斜杠字符结尾的命令行参数来触发此漏洞，从而将权限提升至root。

**有效性：**
提供的POC代码是有效的。搜索结果中的多个网页（例如，Qualys博客、NCC Group博客、RedHat安全页面）都确认了该漏洞的存在，并提供了利用方法。POC代码通过构造特定的命令行参数和环境变量，触发堆溢出，覆盖`service_user`结构，最终执行shellcode以获得root权限。

**投毒风险：**
该仓库中存在轻微的投毒风险（10%）。虽然代码本身实现了漏洞利用，但可能存在以下情况：
*   **Shellcode修改：** 作者可能在shellcode中添加了不明显的后门逻辑，例如，在获得root shell之前执行某些恶意操作。虽然提供的shellcode比较简单，但作者完全可以替换成更复杂的payload。
*   **编译选项：** Makefile中使用的编译选项，可能会被修改，例如关闭某些安全特性，虽然目前只是`-O3`优化。

**利用方式：**
1.  **漏洞触发：** 通过`sudoedit -s` 命令，并提供一个以反斜杠结尾的超长参数。
2.  **堆溢出：** 利用超长参数覆盖堆上相邻的`service_user`结构。
3.  **控制`service_user`：** 覆盖`service_user`结构中的`name`字段，指向包含shellcode的恶意动态链接库（`libnss_x/x.so.2`）的路径。
4.  **加载恶意库：** Sudo在后续操作中尝试加载`service_user`的`name`字段指定的库，从而执行shellcode。
5.  **权限提升：** shellcode设置UID和GID为0，然后执行`/bin/sh`，获得root shell。

**项目地址:** [hycheng15/CVE-2021-3156](https://github.com/hycheng15/CVE-2021-3156)

**漏洞详情:** [CVE-2021-3156](https://nvd.nist.gov/vuln/detail/CVE-2021-3156)