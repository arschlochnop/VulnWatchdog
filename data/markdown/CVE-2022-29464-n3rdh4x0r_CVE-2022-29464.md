## CVE-2022-29464 - WSO2 任意文件上传导致远程代码执行

**漏洞编号:** CVE-2022-29464

**漏洞类型:** 任意文件上传/远程代码执行

**影响应用:** WSO2 API Manager, Identity Server, Enterprise Integrator, Open Banking AM/KM

**危害等级:** 高危，可能导致服务器完全控制

**影响版本:** WSO2 API Manager 2.2.0 up to 4.0.0, WSO2 Identity Server 5.2.0 up to 5.11.0, WSO2 Identity Server Analytics 5.4.0, 5.4.1, 5.5.0 and 5.6.0, WSO2 Identity Server as Key Manager 5.3.0 up to 5.11.0, WSO2 Enterprise Integrator 6.2.0 up to 6.6.0, WSO2 Open Banking AM 1.4.0 up to 2.0.0 and WSO2 Open Banking KM 1.4.0, up to 2.0.0.

**利用条件:** 需要网络访问目标WSO2服务器的/fileupload endpoint，目标服务器存在漏洞。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2022-29464 是 WSO2 产品中的一个严重漏洞，允许未经授权的攻击者通过 `/fileupload` 端点上传任意文件，从而导致远程代码执行。漏洞利用的关键在于使用 `Content-Disposition` 头中的目录遍历序列，将恶意文件上传到 Web 根目录下的可执行路径，例如 `../../../../repository/deployment/server/webapps`。 

**漏洞利用方式：**

1.  攻击者构造包含恶意代码（如 JSP webshell）的文件。
2.  攻击者利用 `/fileupload` 端点上传该恶意文件，并在 `Content-Disposition` 头中包含目录遍历序列，例如 `../../../../repository/deployment/server/webapps/authenticationendpoint/shell.jsp`，其中 `shell.jsp` 为攻击者上传的恶意文件。
3.  服务器将文件上传到指定路径。
4.  攻击者通过访问上传的文件（例如 `https://host/authenticationendpoint/shell.jsp`）来执行恶意代码。

**POC 代码分析：**

提供的 Python 脚本 `exploit.py` 实现了上述利用过程。

*   脚本接受 WSO2 服务器地址和 webshell 文件名作为参数。
*   脚本构造一个包含 JSP webshell 内容的字典 `files`。  JSP webshell允许通过GET请求的`cmd`参数执行任意命令. 这是一个功能后门，而非投毒代码.
*   脚本使用 `requests.post` 函数向 `/fileupload/toolsAny` 端点发送 POST 请求，上传 webshell 文件，并通过目录遍历将其放置到 `authenticationendpoint` 目录下。
*   脚本输出 webshell 的访问 URL。

**有效性评估：**

根据漏洞描述和 POC 代码，此漏洞利用方法是有效的。多个来源证实了此漏洞的存在和可利用性（如 Trend Micro, Rapid7, Arctic Wolf 等）。

**投毒风险评估：**

代码本身主要是一个漏洞利用工具，用于上传和执行 webshell。**投毒风险较低，约为 10%**。尽管如此，仍需要注意以下潜在风险：

*   **代码托管平台的安全性：**如果该代码是从非官方、信誉差的平台下载，可能存在被篡改的风险。
*   **依赖项风险：**该脚本依赖于 `requests` 和 `urllib3` 库。如果这些库本身存在安全漏洞或被恶意篡改，可能会引入安全风险。
*   **作者意图：**虽然代码的主要功能是漏洞利用，但作者可能在代码中隐藏其他恶意功能，例如收集目标系统信息或安装后门。虽然当前代码未发现明显投毒行为, 但不能完全排除.

**结论：**

此漏洞的利用方法是有效的，可以导致远程代码执行。在使用此 POC 代码时，应注意潜在的投毒风险，并从可信来源获取代码。

**项目地址:** [n3rdh4x0r/CVE-2022-29464](https://github.com/n3rdh4x0r/CVE-2022-29464)

**漏洞详情:** [CVE-2022-29464](https://nvd.nist.gov/vuln/detail/CVE-2022-29464)