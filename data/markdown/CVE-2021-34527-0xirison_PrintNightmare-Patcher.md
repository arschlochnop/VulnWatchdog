## CVE-2021-34527 PrintNightmare

**漏洞编号:** CVE-2021-34527

**漏洞类型:** 远程代码执行

**影响应用:** Windows Print Spooler

**危害等级:** 高危，允许未经授权的用户以SYSTEM权限执行任意代码

**影响版本:** 受影响的Windows版本及更新低于安全公告中指定的版本

**利用条件:** Print Spooler服务运行，且未安装相应的安全更新

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-34527 (PrintNightmare) 是 Windows Print Spooler 服务中的一个远程代码执行漏洞。攻击者可以利用此漏洞在受影响的系统上以 SYSTEM 权限运行任意代码。根据漏洞库信息和搜索结果，该漏洞影响多个 Windows 版本。利用方式通常涉及滥用 `RpcAddPrinterDriverEx()` 函数来加载恶意驱动程序。提供的漏洞利用代码 `printnightmare-patcher.py` 并非漏洞利用程序，而是一个补丁程序，用于检测系统是否存在漏洞，并尝试安装补丁或修改注册表设置以缓解风险。此工具会检查是否存在 KB5004954 补丁，如果未安装，则尝试使用 PowerShell 安装。 它还检查 PointAndPrint 注册表项。 由于此脚本目的是缓解漏洞而不是利用漏洞，因此它本身不包含任何显式的“投毒”代码。 但是，任何修改系统设置的脚本都有潜在风险。 在这种情况下，如果此脚本安装了错误的更新（可能性很小，除非用户篡改脚本），或者意外禁用了打印后台处理程序，则可能会导致系统不稳定或打印功能中断。因此，存在一定的投毒风险，估计为10%。

漏洞利用方式如下：

1.  **远程代码执行:** 攻击者利用Print Spooler服务中的漏洞，通过网络发送恶意请求，实现在目标系统上执行任意代码。
2.  **SYSTEM权限:** 成功利用漏洞后，攻击者获得的权限是SYSTEM，这是Windows系统中最高的权限。
3.  **DLL注入:** 漏洞通常涉及将恶意的DLL文件注入到Print Spooler服务进程中。
4.  **绕过安全措施:** 某些已知的利用方法可以绕过Point and Print的限制，即使这些限制已经配置。

**项目地址:** [0xirison/PrintNightmare-Patcher](https://github.com/0xirison/PrintNightmare-Patcher)

**漏洞详情:** [CVE-2021-34527](https://nvd.nist.gov/vuln/detail/CVE-2021-34527)