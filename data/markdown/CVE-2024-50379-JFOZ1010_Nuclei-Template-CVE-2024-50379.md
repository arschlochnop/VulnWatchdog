## CVE-2024-50379-Apache Tomcat TOCTOU RCE

**漏洞编号:** CVE-2024-50379

**漏洞类型:** TOCTOU Race Condition 导致的远程代码执行

**影响应用:** Apache Tomcat

**危害等级:** 高危，可能导致远程代码执行

**影响版本:** <= 11.0.1, <= 10.1.33, <= 9.0.97

**利用条件:** 默认Servlet的readonly参数设置为false，且文件系统大小写不敏感

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-50379是一个Apache Tomcat中的TOCTOU（Time-of-Check Time-of-Use）竞争条件漏洞。当Tomcat的默认Servlet的`readonly`参数设置为`false`时（非默认配置），攻击者可以通过上传一个JSP文件，并在Tomcat编译该JSP文件时，通过竞争条件替换该文件为恶意JSP文件，从而实现远程代码执行。

**漏洞利用方式：**

1.  **条件满足：**  确保目标Tomcat实例的默认Servlet的`readonly`参数已设置为`false`。这意味着允许通过默认Servlet上传文件。
2.  **上传JSP文件：**  首先上传一个良性的JSP文件，例如`hello.jsp`，其中包含一些基本代码，比如打印"Hello, World!"。
3.  **竞争条件：**  在Tomcat编译`hello.jsp`文件时，攻击者迅速上传一个恶意的JSP文件，比如`HELLO.JSP`（注意大小写差异，利用文件系统大小写不敏感的特性），其中包含执行任意命令的代码（例如，启动计算器）。
4.  **远程代码执行：**  如果竞争成功，Tomcat会编译并执行恶意的`HELLO.JSP`文件，从而导致远程代码执行。

**POC分析：**

提供的Nuclei模板`CVE-2024-50379.yaml` 旨在自动化此漏洞的检测。它通过以下步骤工作：

1.  上传一个包含 "Hello, World!" 的良性JSP文件 (`hello.jsp`) 到 `/upload.jsp` 。
2.  快速上传一个包含恶意代码的JSP文件 (`HELLO.JSP`) 到 `/uploads/upload.jsp` 。这个恶意JSP包含执行计算器的代码片段 `Runtime.getRuntime().exec("calc.exe");`。
3.  尝试访问上传的文件 (`/uploads/hello.jsp`) ，并检查响应是否包含预期的输出或错误信息。

**投毒风险分析：**

虽然提供的POC代码本身旨在利用漏洞，而非植入后门，但仍然存在一些潜在的投毒风险：

*   **文件名大小写混淆:**  利用了大小写不敏感的文件系统, 可能存在编码问题或文件系统差异导致POC失效, 但不属于后门或投毒代码
*   **自定义恶意JSP：**  用户在使用POC时，可能会修改恶意JSP文件中的代码，以执行其他恶意操作，例如上传webshell或执行更隐蔽的命令。这取决于用户自身行为，不属于POC作者投毒。
*   **依赖外部资源：**  虽然当前的POC没有直接依赖外部资源，但如果用户修改POC并添加对外部资源的依赖（例如，下载恶意脚本），则可能引入投毒风险。
*   **README.md中的免责声明：** README明确说明了使用该模板的伦理责任，并强调只能在授权环境下使用。这在一定程度上降低了作者恶意使用的可能性。

综合考虑，尽管存在一些潜在的风险，但该仓库中直接包含作者有意植入的投毒代码的可能性较低。投毒风险主要来自于用户对POC的修改和使用方式。 因此，我给出的投毒风险概率是10%。

**项目地址:** [JFOZ1010/Nuclei-Template-CVE-2024-50379](https://github.com/JFOZ1010/Nuclei-Template-CVE-2024-50379)

**漏洞详情:** [CVE-2024-50379](https://nvd.nist.gov/vuln/detail/CVE-2024-50379)