## CVE-2021-4034-Polkit-pkexec本地提权

**漏洞编号:** CVE-2021-4034

**漏洞类型:** 本地提权

**影响应用:** Polkit

**危害等级:** 高危，允许低权限用户获得root权限

**影响版本:** 受影响版本广泛，具体取决于Polkit版本

**利用条件:** 本地用户，pkexec具有SUID权限

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-4034 (PwnKit) 是 Polkit pkexec 工具中的一个本地提权漏洞。pkexec 是一个 setuid 工具，旨在允许非特权用户按照预定义的策略以特权用户身份运行命令。漏洞存在于 pkexec 处理参数计数的方式，导致它可以将环境变量作为命令执行。攻击者可以通过精心构造环境变量来诱使 pkexec 执行任意代码，从而获得 root 权限。

**有效性：**

根据漏洞库信息、搜索引擎结果以及提供的漏洞利用代码，该漏洞的 POC 代码是有效的。搜索引擎结果显示多个安全厂商已经确认并提供了利用方法。提供的代码包含 Makefile、C 源代码以及利用说明，表明这是一个可工作的 Exploit。

**投毒风险：**

分析提供的 POC 代码内容，投毒风险评估为10%。

*   `LICENSE` 文件：标准的 MIT 许可证，表明代码是开源的，增加了透明度。
*   `Makefile` 文件：用于编译 exploit，没有发现可疑操作。
*   `README.md` 文件：提供漏洞说明、利用方法和缓解措施，描述清晰。
*   `pwnkit.c` 文件：实现了利用 GCONV_PATH 环境变量进行提权的关键逻辑。需要进一步审计，但是表面上没有发现恶意行为。
*   `cve-2021-4034.c` 文件：主程序，负责设置环境变量并执行 pkexec。同样需要进一步审计。
    `gconv-modules`: 指定了要使用的gconv模块,用于触发漏洞

虽然没有明显的恶意代码，但是仍然存在风险。例如，`pwnkit.c` 和 `cve-2021-4034.c` 中可能存在隐藏的后门或触发条件，这些后门只有在特定环境下才会激活。此外，该代码可能依赖于某些特定的系统配置或库版本，如果目标系统不满足这些条件，exploit 可能会失败，或者产生未知的副作用。

因此，在使用此 POC 之前，务必进行代码审计，并在隔离环境中进行测试。

**利用方式：**

利用方式主要通过以下步骤：

1.  **编译：** 使用 `make` 命令编译 `pwnkit.so` (共享库) 和 `cve-2021-4034` (主程序)。同时创建 `gconv-modules` 文件，内容指定了要加载的gconv模块以及创建相关的目录结构。
2.  **环境变量设置：** Exploit 通过设置 `GCONV_PATH` 和 `GCONV_MODULES` 环境变量来利用该漏洞。
3.  **触发漏洞：** 运行编译后的 `cve-2021-4034` 程序，它会调用 `pkexec`，由于环境变量的设置，`pkexec` 会尝试加载恶意的 `pwnkit.so` 共享库。
4.  **代码执行：** `pwnkit.so` 共享库中的代码会被执行，从而获得 root 权限。
5.  **提权：** 在 `pwnkit.so` 中，通过调用 `setuid(0)` 和 `setgid(0)` 将进程的 UID 和 GID 设置为 0 (root)，从而获得 root 权限。最后，执行 shell 命令，允许攻击者在目标系统上执行任意操作。

**项目地址:** [Typical0day/CVE-2021-4034](https://github.com/Typical0day/CVE-2021-4034)

**漏洞详情:** [CVE-2021-4034](https://nvd.nist.gov/vuln/detail/CVE-2021-4034)