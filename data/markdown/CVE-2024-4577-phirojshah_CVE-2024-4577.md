## CVE-2024-4577 PHP-CGI 参数注入远程代码执行漏洞

**漏洞编号:** CVE-2024-4577

**漏洞类型:** 远程代码执行

**影响应用:** PHP

**危害等级:** 高危，可能导致服务器被完全控制

**影响版本:** PHP 8.1.* < 8.1.29, 8.2.* < 8.2.20, 8.3.* < 8.3.8 (Windows, CGI 模式)

**利用条件:** Windows 系统，PHP 以 CGI 模式运行，启用了使用 "Best Fit" 策略的代码页。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-4577 是一个影响 Windows 系统上 PHP-CGI 的远程代码执行漏洞。当 PHP 在 CGI 模式下运行时，如果系统配置为使用某些代码页，Windows 可能会使用 "Best-Fit" 行为来替换传递给 Win32 API 函数的命令行中的字符。PHP CGI 模块可能会错误地将这些字符解释为 PHP 选项，从而允许恶意用户将选项传递给正在运行的 PHP 二进制文件，进而泄露脚本源代码或在服务器上执行任意 PHP 代码。

**有效性：**
根据漏洞库信息和搜索结果，该漏洞是真实存在的，并且有公开的利用代码。Akamai 的研究表明，漏洞披露后一天内就出现了大量的利用尝试。CISA 也已将此漏洞添加到已知被利用的漏洞列表中，表明该漏洞在野外已被积极利用。提供的 POC 代码通过发送包含特制参数的 HTTP POST 请求来利用此漏洞，如果目标服务器存在漏洞，则可以执行任意 PHP 代码。因此, POC代码是有效的。

**投毒风险：**
检查提供的 Python 脚本 `CVE-2024-4577.py` 和 `README.md` 文件，没有发现明显的恶意代码。该脚本的功能主要是扫描目标 URL 是否存在漏洞，如果存在则利用该漏洞执行指定的 PHP 代码。`README.md` 文件只包含漏洞的描述、安装和使用说明。但是，任何下载和使用的第三方代码都存在一定风险。用户需要仔细审查代码，确保其行为符合预期，并且来自可信的来源。

投毒风险评估: 10% 。 这个评估是因为代码本身看起来没有恶意行为，但是任何第三方脚本都存在潜在风险，例如：

*   **依赖项风险：** 脚本依赖于 `requests` 和 `colorama` 库。这些依赖项可能包含未知的漏洞，如果被攻击者利用，可能会影响脚本的安全性。
*   **Payload 风险：** 脚本允许用户指定要执行的 PHP payload 文件。如果用户不小心使用了恶意的 payload 文件，可能会导致服务器受到攻击。
*   **作者恶意：** 脚本作者可能在未来的版本中引入恶意代码。

**利用方式：**

1.  **确定目标系统：** 首先需要确定目标系统是否满足漏洞利用的条件，即：Windows 系统，PHP 以 CGI 模式运行，并且启用了使用 "Best Fit" 策略的代码页。
2.  **发送特制的 HTTP 请求：** 攻击者需要构造一个包含特制参数的 HTTP 请求，例如 `?%ADd+allow_url_include%3d1+%ADd+auto_prepend_file%3dphp://input`。这个参数会传递给 PHP CGI 模块，使其错误地解释为 PHP 选项。
3.  **执行任意 PHP 代码：** 通过 POST 请求发送包含要执行的 PHP 代码的 payload。由于 `auto_prepend_file` 参数被设置为 `php://input`，PHP 会将 POST 请求的内容作为 PHP 代码执行。因此,通过修改和控制POST的内容,即可控制目标服务器。

此漏洞的严重性在于，未经身份验证的攻击者可以利用此漏洞在受影响的服务器上执行任意代码，从而完全控制服务器。

**项目地址:** [phirojshah/CVE-2024-4577](https://github.com/phirojshah/CVE-2024-4577)

**漏洞详情:** [CVE-2024-4577](https://nvd.nist.gov/vuln/detail/CVE-2024-4577)