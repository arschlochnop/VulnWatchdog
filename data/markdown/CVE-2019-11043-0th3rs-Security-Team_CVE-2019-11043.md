## CVE-2019-11043 PHP-FPM 远程代码执行

**漏洞编号:** CVE-2019-11043

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** PHP-FPM

**危害等级:** 高危，可能导致服务器完全控制

**影响版本:** PHP 7.1.x (< 7.1.33), 7.2.x (< 7.2.24), 7.3.x (< 7.3.11)

**利用条件:** Nginx 作为前端服务器，配置不当，将请求传递给 PHP-FPM。配置中需要包含 `fastcgi_split_path_info` 和不恰当的 `PATH_INFO` / `PATH_TRANSLATED` 参数。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2019-11043 是一个 PHP-FPM 的远程代码执行漏洞，起因是 PHP-FPM 在处理 `PATH_INFO` 环境变量时存在缺陷，如果 Nginx 配置不当，攻击者可以利用这个漏洞执行任意代码。

**漏洞利用方式：**

1.  攻击者需要找到一个启用了 PHP-FPM 并且 Nginx 配置存在漏洞的服务器。 关键配置是 `fastcgi_split_path_info`，它用于分割 URL，将一部分作为文件名，另一部分作为 `PATH_INFO`。
2.  利用 `cve_2019_11043.py` 脚本，首先判断目标是否存在漏洞。脚本通过修改 HTTP Header `D-Gisos` 和构造特定的 URL，爆破 query长度和Header头字段长度,检查 `session.auto_start` 是否被设置。如果目标存在漏洞，服务器会返回 `Set-Cookie` 头。
3.  然后脚本会确定目标 PHP worker 进程的数量，从而实现全 worker 进程污染，增强漏洞利用的稳定性。
4.  脚本通过构造特定的 `PHP_VALUE` 参数来修改 PHP 的配置。关键配置包括 `error_reporting`，`short_open_tag`，`html_errors`，`log_errors`，`error_log`，`include_path`， `output_handler`，`extension_dir`， 和 `extension`。
5.  `extension=$_GET[a]`允许执行任意代码，通过GET参数传递命令。

**有效性：**

根据漏洞库信息和搜索结果，提供的 POC 代码是有效的。该漏洞已经被广泛研究，并且存在公开可用的利用代码。

**投毒风险：**

该 POC 代码存在一定的投毒风险。`cve_2019_11043.py` 脚本中的利用链 (orange_chain) ，通过修改 PHP 配置，最终目的是允许通过 GET 参数执行任意代码。理论上，可以修改配置，写入恶意代码到服务器的文件中，比如木马文件。虽然当前脚本中的利用链看起来是为了执行命令，但攻击者可以修改利用链，达到植入后门的目的。

`print('Example: {}?a=%0asleep+5%0a'.format(target))`  这行代码提供了如何执行命令的示例。攻击者可以利用这个机制执行更隐蔽的恶意操作。

考虑到可能通过修改利用链进行投毒，投毒风险大约为 10%。大部分代码是用于漏洞利用，少部分存在恶意利用的可能性。

**项目地址:** [0th3rs-Security-Team/CVE-2019-11043](https://github.com/0th3rs-Security-Team/CVE-2019-11043)

**漏洞详情:** [CVE-2019-11043](https://nvd.nist.gov/vuln/detail/CVE-2019-11043)