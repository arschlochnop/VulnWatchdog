## CVE-2022-0847 - Dirty Pipe 本地提权漏洞

**漏洞编号:** CVE-2022-0847

**漏洞类型:** 本地提权

**影响应用:** Linux Kernel

**危害等级:** 高危，允许本地用户覆盖只读文件，从而提升权限。

**影响版本:** Linux Kernel 5.8 及更高版本，在 5.17 rc6 之前被修复

**利用条件:** 需要本地用户权限

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2022-0847 (Dirty Pipe) 是一个 Linux 内核中的本地提权漏洞。漏洞的根本原因是 `copy_page_to_iter_pipe` 和 `push_pipe` 函数中新的管道缓冲区结构的 `flags` 成员缺乏适当的初始化，可能包含陈旧的值。攻击者可以利用此漏洞覆盖 page cache 中只读文件 backing 的页面，从而提升系统上的权限。

**有效性：**

根据漏洞描述和搜索结果，以及提供的POC代码，可以判断该漏洞是有效的。网上已经有大量的利用代码和分析文章。

**投毒风险：**

分析提供的 `Exploit.sh` 脚本：

1.  创建并编译利用代码 `exp.c`，这是一个标准的 Dirty Pipe 漏洞利用程序，用于覆盖任意文件内容。
2.  备份 `/etc/passwd` 到 `/tmp/passwd`。
3.  如果备份成功，则使用编译后的 `exp` 程序尝试覆盖 `/etc/passwd` 文件，将 `root:x` 修改为 `oot:`。注意此处的目的是为了尝试修改root密码的hash值，如果成功，会导致root用户无法登录，但后续脚本立刻通过`su root`尝试恢复，由于密码错误，会进入交互模式，从而暴露了修改`/etc/passwd`的行为。
4.  脚本尝试使用 `su root` 命令切换到 root 用户。如果`/etc/passwd`被成功修改,这步会失败。
5.  在脚本最后，尝试恢复 `/etc/passwd`。如果`/etc/passwd`被修改,即使恢复了，但是攻击者已经获得了root权限.

此POC的风险在于：
*   修改 `/etc/passwd` 文件存在风险，如果操作不当可能导致系统无法登录。备份操作降低了部分风险，但仍然存在隐患。
*   攻击者通过修改 `/etc/passwd` 并使用 `su root` 提升权限，然后恢复`/etc/passwd`，这是一种经典的利用方式
*   脚本中备份和恢复 `/etc/passwd` 的行为属于正常的漏洞利用流程,目的是减少对系统的损害.

因此，我认为此脚本的投毒风险为 10%。主要风险来自脚本本身对目标文件的修改，而不是隐藏的恶意代码。

**利用方式：**

1.  **漏洞触发:** 漏洞利用的核心在于创建具有 `PIPE_BUF_FLAG_CAN_MERGE` 标志的 pipe buffer，然后利用此标志允许写入到只读文件 backing 的 page cache 中。
2.  **覆盖文件内容:**  通过 `splice` 函数将目标文件的一个字节（在目标偏移量之前）放入 pipe 中，然后使用 `write` 函数将恶意数据写入 pipe，由于 `PIPE_BUF_FLAG_CAN_MERGE` 标志，数据实际上被写入了 page cache，覆盖了目标文件的内容。
3.  **提权 (本例):** 本脚本尝试修改 `/etc/passwd` 文件，通过修改 root 用户的密码哈希，来尝试获取 root 权限，或者导致拒绝服务。

**总结:**

提供的 POC 利用代码利用 Dirty Pipe 漏洞覆盖 `/etc/passwd` 文件，以尝试提升权限。尽管脚本尝试进行备份和恢复操作，但仍存在一定的风险。脚本的投毒风险较低，主要是脚本本身对`/etc/passwd`的修改存在潜在的风险。

**项目地址:** [mithunmadhukuttan/Dirty-Pipe-Exploit](https://github.com/mithunmadhukuttan/Dirty-Pipe-Exploit)

**漏洞详情:** [CVE-2022-0847](https://nvd.nist.gov/vuln/detail/CVE-2022-0847)