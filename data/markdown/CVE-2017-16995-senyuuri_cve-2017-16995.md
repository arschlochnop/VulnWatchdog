## CVE-2017-16995

**漏洞编号:** CVE-2017-16995

**漏洞类型:** 本地权限提升

**影响应用:** Linux Kernel

**危害等级:** 高危，可导致本地用户获取root权限

**影响版本:** <= 4.4

**利用条件:** 需要本地用户权限，目标系统内核版本在4.4及以下且未修复该漏洞

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2017-16995是Linux内核BPF验证器中`check_alu_op`函数存在的一个整数符号扩展错误。该漏洞允许本地用户利用不正确的符号扩展导致拒绝服务（内存损坏）或者可能造成未指定的其他影响，最终实现本地权限提升。

**有效性：**

根据漏洞信息和搜索引擎结果，存在多个公开的漏洞利用代码（Exploit-DB上的44298、45010、45058，以及GitHub上的senyuuri/cve-2017-16995）。提供的漏洞利用代码`exploit.c` 针对Ubuntu 16.04.4 kernel，明确指定了目标内核版本 `4.4.0-116-generic`，并通过调整`CRED_OFFSET`来适应不同的内核。

**利用方式：**

该漏洞的利用方式通常涉及以下步骤：

1.  **创建BPF map：** 利用`bpf_create_map`创建BPF map。
2.  **加载BPF程序：** 利用`bpf_prog_load`加载特制的BPF程序。该程序旨在触发`check_alu_op`函数中的整数符号扩展错误。
3.  **socketpair & setsockopt：** 创建socketpair，并通过`setsockopt`将BPF程序附加到socket上，从而触发BPF程序的执行。
4.  **内存篡改：** 漏洞利用的核心是通过BPF程序修改当前进程的`cred`结构，将UID、GID等权限相关的字段设置为0，从而获得root权限。
5.  **writemsg & bpf_update_elem:** 通过socket发送消息，触发BPF程序执行，更新map的值，最终达到提权目的

**投毒风险：**

虽然漏洞利用代码本身是针对CVE-2017-16995的利用，但仍然存在一定的投毒风险。以下是风险分析：

*   **Cred Offset不正确:** 提供的代码中`CRED_OFFSET`的值针对特定的内核版本。如果目标系统的内核版本不同，则`CRED_OFFSET`的值需要调整，否则可能导致提权失败或系统崩溃。攻击者可能会故意提供错误的`CRED_OFFSET`值，导致利用失败，但同时破坏系统稳定性。
*   **依赖特定环境：** 该漏洞利用代码依赖特定的操作系统和内核版本。攻击者可能会提供只在特定环境下才能成功执行的代码，而其他环境下可能会导致不可预测的错误。
*   **后门代码：** 仔细检查代码未发现明显的后门代码，但是要完全排除需要对汇编代码进行逆向分析。

考虑到以上风险，评估投毒风险为10%。主要风险在于Cred Offset不正确, 依赖特定环境，可能会导致提权失败或者系统崩溃，增加利用的复杂度或制造不稳定因素，但从整体代码分析，未发现明显的恶意后门代码。

**项目地址:** [senyuuri/cve-2017-16995](https://github.com/senyuuri/cve-2017-16995)

**漏洞详情:** [CVE-2017-16995](https://nvd.nist.gov/vuln/detail/CVE-2017-16995)