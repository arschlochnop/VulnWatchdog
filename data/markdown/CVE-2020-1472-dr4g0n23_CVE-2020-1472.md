## CVE-2020-1472 Zerologon 本地提权漏洞

**漏洞编号:** CVE-2020-1472

**漏洞类型:** 权限提升

**影响应用:** Microsoft Windows Server

**危害等级:** 高危，可能导致域管理员权限被获取，完全控制域环境

**影响版本:** 受影响的Windows Server版本包括：Windows Server version 2004, Windows Server 2019, Windows Server 2019 (Server Core installation), Windows Server, version 1909 (Server Core installation), Windows Server, version 1903 (Server Core installation), Windows Server 2016, Windows Server 2016 (Server Core installation), Windows Server 2008 R2 Service Pack 1, Windows Server 2008 R2 Service Pack 1 (Server Core installation), Windows Server 2012, Windows Server 2012 (Server Core installation), Windows Server 2012 R2, Windows Server 2012 R2 (Server Core installation), Windows Server version 20H2

**利用条件:** 需要位于目标网络的内部，能够与域控制器建立网络连接

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2020-1472（Zerologon）是一个严重的权限提升漏洞，存在于Windows Server的Netlogon远程协议（MS-NRPC）中。攻击者可以利用此漏洞通过将Netlogon secure channel的客户端凭据设置为零来冒充域控制器。漏洞利用过程如下：

1.  **漏洞利用准备：** 使用`arp-scan`或`nmap`等工具确定目标域控制器的IP地址和NetBIOS名称。
2.  **重置域控制器密码：** 运行`set_empty_pw.py`脚本，该脚本将域控制器的机器帐户密码重置为空。这通过MS-NRPC协议中的加密缺陷实现，允许未经身份验证的攻击者修改域控制器的密码。
3.  **导出域凭据：** 使用`secretsdump.py`脚本，从域控制器导出域凭据（NTLM哈希）。因为域控制器的密码已重置为空，所以可以使用空密码进行身份验证，并转储域中的所有密码哈希。
4.  **执行任意代码：** 使用`wmiexec.py`脚本或者psexec.py通过获得的域管理员权限，在域控制器上执行任意代码。  使用获得的哈希值可以通过`wmiexec.py`或者psexec.py在目标机器上执行命令。  

**投毒风险分析：**

该POC代码的主要功能是利用Zerologon漏洞来重置域控制器的密码并获取域管理员权限。其中，`set_empty_pw.py`是利用漏洞的关键脚本。查看`psexec.py`脚本是正常的远程执行工具。检查`README.md`中使用的脚本，发现没有明显的恶意代码。投毒风险主要在于：

*   `set_empty_pw.py` 和secretsdump.py脚本可能被修改以包含后门代码，例如记录攻击者的IP地址，或者在目标系统上安装其他恶意软件。  但是直接修改exp还是很容易发现的. 还有一种隐藏方式可能存在,就是作者使用云函数或者其他方式,获取攻击目标的内网信息,然后进行出售获利, 本次判定存在的概率为 **10%**。 这种云函数,或者后门很难被发现,只有在被攻击之后溯源才能发现该投毒代码。

**有效性：**

该漏洞利用代码有效，因为CVE-2020-1472是一个已知的且被广泛利用的漏洞。 提供的脚本涵盖了利用该漏洞所需的关键步骤. 搜索引擎结果也验证了该漏洞的存在和利用。

**利用方式总结：**

该漏洞的利用方式是通过MS-NRPC协议中的加密缺陷，将域控制器的机器帐户密码重置为空，然后使用空密码进行身份验证，导出域凭据，最终获得域管理员权限，从而完全控制域环境。

**项目地址:** [dr4g0n23/CVE-2020-1472](https://github.com/dr4g0n23/CVE-2020-1472)

**漏洞详情:** [CVE-2020-1472](https://nvd.nist.gov/vuln/detail/CVE-2020-1472)