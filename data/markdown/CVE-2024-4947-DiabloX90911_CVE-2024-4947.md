## CVE-2024-4947 - Google Chrome V8 类型混淆漏洞

**漏洞编号:** CVE-2024-4947

**漏洞类型:** 类型混淆

**影响应用:** Google Chrome

**危害等级:** 高危，远程代码执行

**影响版本:** < 125.0.6422.60

**利用条件:** 需要用户访问恶意构造的HTML页面

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-4947 是 Google Chrome V8 引擎中的一个类型混淆漏洞。根据漏洞库信息、搜索结果以及提供的漏洞利用代码，此漏洞允许远程攻击者通过构造的 HTML 页面在沙箱内执行任意代码。

**有效性：**
提供的 PoC 代码是有效的。它利用了 V8 引擎中 JSModuleNamespace 对象处理上的类型混淆缺陷，通过精心构造的 JavaScript 代码，可以改变对象的类型，从而达到越界读写等目的，最终实现代码执行。

**投毒风险：**
代码仓库中存在潜在的投毒风险，大约为 10%。
1.  `README.md`文件包含了下载漏洞利用的链接，存在被替换为恶意链接的风险，引导用户下载包含恶意代码的 PoC。
2.  PoC 代码本身比较复杂，存在隐藏恶意代码的可能性，例如，在回调函数或优化流程中植入后门。 虽然提供的 PoC 代码的主要目的是演示漏洞，但仔细审查确保没有隐藏的恶意行为是必要的。

**利用方式：**
1.  **类型混淆：** 该漏洞的核心在于 V8 引擎中 JSModuleNamespace 对象的 `properties_or_hash` 属性的类型混淆。正常情况下，这个属性应该是指向 `PropertyArray` 或 `NameDictionary`，但攻击者通过特定操作可以将其修改为其他类型，例如 `BigInt` 伪造的 `Map` 对象。
2.  **Object Hash Reassign：**  通过类型混淆，可以控制对象的哈希值存储位置。攻击者可以修改哈希值，使其指向内存中的其他位置。
3.  **沙箱逃逸和代码执行：** 通过修改哈希值等内存数据，攻击者可以绕过 V8 引擎的沙箱保护，最终实现任意代码执行。
4.  **利用流程：**
    *   导入模块 `Module.mjs`，此时 `m.properties_or_hash` 为 `PropertyArray`。
    *   创建一个数组 `y`，其长度 `1234` 将会成为 `m` 的哈希值。
    *   伪造一个 `Map` 对象，通过 `BigInt` 构造具有 `NAME_DICTIONARY_TYPE` 类型的 `Map`。
    *   通过 `try-catch` 语句尝试将伪造的 `Map` 对象赋值给 `m.p0`，触发类型混淆。
    *   使用 `FinalizationRegistry` 创建回调函数，并在其中注册目标对象。
    *   多次调用 `bar()` 函数，利用 Maglev 优化触发类型混淆。
    *   进行垃圾回收，触发 `FinalizationRegistry` 的回调函数。
    *   此时 `properties_or_hash` 变为 `PropertyDictionary`，哈希值存储位置发生改变，攻击者可以利用该改变进行后续操作。

**项目地址:** [DiabloX90911/CVE-2024-4947](https://github.com/DiabloX90911/CVE-2024-4947)

**漏洞详情:** [CVE-2024-4947](https://nvd.nist.gov/vuln/detail/CVE-2024-4947)