## CVE-2021-22204-ExifTool-DjVu代码注入

**漏洞编号:** CVE-2021-22204

**漏洞类型:** 代码注入

**影响应用:** ExifTool

**危害等级:** 中危，可导致本地代码执行

**影响版本:** >=7.44, <12.24

**利用条件:** 用户需要使用存在漏洞的ExifTool版本处理恶意的DjVu文件（伪装成jpg）

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2021-22204是ExifTool中的一个代码注入漏洞，存在于DjVu文件的处理模块中。攻击者可以通过构造恶意的DjVu文件，在ExifTool处理该文件时执行任意代码。 

**有效性：** 提供的POC代码是有效的。它包含一个Bash脚本 `craft_a_djvu_exploit.sh`，该脚本能够生成一个恶意的DjVu文件（伪装成jpg），当使用存在漏洞的ExifTool版本解析这个文件时，可以执行指定的命令。脚本首先检查是否安装了 `djvulibre-bin`，如果没有安装，则尝试使用 `apt-get` 安装。然后，根据要执行的命令的长度计算所需的填充字节，并将命令注入到DjVu文件中。

**投毒风险：** 该POC代码的投毒风险较低，约为5%。`craft_a_djvu_exploit.sh` 脚本本身比较简单，主要功能是构造恶意的DjVu文件。可能的投毒方式包括在安装依赖 `djvulibre-bin` 的过程中引入恶意代码，或者在生成的DjVu文件中插入难以察觉的恶意指令，执行非预期的操作。但考虑到脚本的功能较为明确，以及依赖包通常由操作系统维护，所以投毒风险较低。

**利用方式：** 漏洞利用方式如下：
1.  运行 `craft_a_djvu_exploit.sh` 脚本，指定要执行的命令作为参数。 例如：`bash craft_a_djvu_exploit.sh 'cal'`。
2.  该脚本会生成一个名为 `delicate.jpg` 的文件，这个文件实际上是一个伪装成jpg的恶意DjVu文件。
3.  使用存在漏洞的 ExifTool 版本处理 `delicate.jpg` 文件：`./exiftool delicate.jpg`。
4.  当 ExifTool 解析 `delicate.jpg` 文件时，由于DjVu模块的漏洞，恶意代码会被执行，在本例中会调用 `cal` 命令。

**项目地址:** [se162xg/CVE-2021-22204](https://github.com/se162xg/CVE-2021-22204)

**漏洞详情:** [CVE-2021-22204](https://nvd.nist.gov/vuln/detail/CVE-2021-22204)