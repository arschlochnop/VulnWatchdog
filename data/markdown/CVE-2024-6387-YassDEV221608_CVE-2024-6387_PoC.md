## CVE-2024-6387 OpenSSH regreSSHion 漏洞

**漏洞编号:** CVE-2024-6387

**漏洞类型:** 竞争条件漏洞

**影响应用:** OpenSSH

**危害等级:** 高危，可能导致远程代码执行

**影响版本:** <= 9.7p1 (影响 8.5p1 到 9.7p1)

**利用条件:** 需要目标系统运行受影响版本的OpenSSH，并且是基于glibc的Linux系统。攻击者需要能够建立到SSH服务的网络连接，并能够快速发起大量连接请求。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-6387（regreSSHion）是OpenSSH服务器中发现的一个安全回归漏洞，存在于glibc的Linux系统中。该漏洞是由于OpenSSH服务器（sshd）中的信号处理存在竞争条件。未经身份验证的远程攻击者可以通过在设定的时间内未能通过身份验证来触发此漏洞。成功利用此漏洞可能导致以 root 身份远程执行代码。

**有效性：**
根据漏洞库信息、搜索结果以及漏洞利用代码，该漏洞是有效的。漏洞库信息明确指出该漏洞的存在，并提供了受影响的版本范围。搜索引擎结果也确认了该漏洞的存在，并描述了其可能导致远程代码执行的风险。漏洞利用代码的存在也进一步证实了漏洞的有效性，代码尝试利用竞争条件来执行任意代码。

**投毒风险：**
代码存在一定的投毒风险的可能性。虽然代码本身看起来是在尝试利用该漏洞，但以下因素需要考虑：

1.  **Shellcode占位符：** 代码中包含一个shellcode占位符`unsigned char shellcode[] = "\x90\x90\x90\x90";`，明确指示需要替换成实际的shellcode。如果用户没有意识到这一点，或者使用了恶意shellcode，可能会造成损害。这里的投毒风险在于，攻击者可能发布包含恶意shellcode的exp，诱导用户使用。 
2.  **GLIBC_BASES：** 代码中定义了`GLIBC_BASES[]`，用于绕过ASLR。如果这些地址不正确，利用将失败。更糟糕的是，如果攻击者故意提供错误的地址，可能会导致程序崩溃或其他不可预测的行为。
3.  **Timing parameters和 Heap layout 需要调整：** 代码注释中强调了定时参数和堆布局需要根据目标系统进行调整。如果这些参数设置不正确，可能会导致利用失败或目标系统不稳定。
4.  **文件结构偏移量：** 代码提到需要验证特定glibc版本的文件结构偏移量。使用错误的偏移量可能导致内存损坏或其他不可预测的行为。

总体来看，该POC的复杂性和对系统内部结构的依赖性，投毒者可以通过提供不正确的配置参数，或者引导用户使用错误的shellcode，达到破坏目标系统的目的。因此存在10%的投毒风险。

**利用方式：**
该漏洞的利用方式主要包括以下几个步骤：

1.  **建立连接：** 攻击者首先需要与目标OpenSSH服务器建立TCP连接。
2.  **SSH握手：** 攻击者需要完成初始的SSH握手过程，包括协议版本交换和密钥交换初始化（KEX）。
3.  **堆准备：** 攻击者利用SSH协议发送数据包，在内存堆上布置精心构造的数据结构，为后续的漏洞利用做准备。
4.  **触发竞争条件：** 攻击者发送一个特制的SSH数据包，该数据包的设计是为了触发sshd中的竞争条件。具体来说，它利用了在身份验证失败的情况下，信号处理程序中的不安全操作。
5.  **RCE：** 成功触发竞争条件后，攻击者可以将恶意代码注入到sshd进程中，从而实现远程代码执行。具体是通过内存操作覆盖某个函数指针，使其指向攻击者提供的shellcode。
6.  **提权（Root）：** 由于sshd通常以root权限运行，因此攻击者执行的shellcode也将以root权限运行，从而完全控制目标系统。

**项目地址:** [YassDEV221608/CVE-2024-6387_PoC](https://github.com/YassDEV221608/CVE-2024-6387_PoC)

**漏洞详情:** [CVE-2024-6387](https://nvd.nist.gov/vuln/detail/CVE-2024-6387)