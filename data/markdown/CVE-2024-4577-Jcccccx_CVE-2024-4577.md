## CVE-2024-4577 PHP-CGI Argument Injection RCE

**漏洞编号:** CVE-2024-4577

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** PHP

**危害等级:** 严重，可能导致完全控制受影响的Windows服务器

**影响版本:** PHP 8.1 < 8.1.29, PHP 8.2 < 8.2.20, PHP 8.3 < 8.3.8

**利用条件:** Windows服务器，Apache，PHP-CGI模式，系统使用特定的代码页并启用了"Best Fit"策略

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2024-4577 漏洞允许未经身份验证的攻击者在易受攻击的Windows PHP服务器上执行任意代码。该漏洞源于PHP-CGI在Windows环境下的参数处理缺陷，当系统配置为使用具有“Best-Fit”行为的代码页时，传递给Win32 API函数的命令行参数中的某些字符可能会被错误地解释为PHP选项。攻击者可以通过构造特殊的URL，向PHP二进制文件传递恶意选项，从而导致远程代码执行。

**利用方式：**

1.  **目标确认：** 确认目标服务器运行在Windows系统上，并且使用Apache和PHP-CGI模式。
2.  **代码页检测：** 确认目标系统的代码页配置允许"Best Fit"转换。
3.  **构造恶意URI：** 构造包含恶意PHP选项的URI，例如，使用`cgi.force_redirect=0`绕过重定向限制，使用`allow_url_include=1`允许包含远程文件，使用`auto_prepend_file=php://input`将POST数据作为PHP代码执行。
4.  **发送POST请求：**  发送POST请求到构造的URI，并将包含恶意代码的PHP代码作为请求体发送。
5.  **命令执行：** 服务器执行恶意PHP代码，攻击者可以执行任意系统命令。

**POC 分析：**

提供的POC代码 `CVE_2024_4577_test.py` 主要用于检测漏洞是否存在，它通过构造特定的URI和PHP代码，发送POST请求到目标服务器，并检查响应中是否包含预期的输出，以验证漏洞是否可利用。 `CVE_2024_4577_exp.py` 是用于执行命令的EXP。

**投毒风险分析：**

仔细检查了提供的POC代码，未发现任何明显的投毒迹象。代码逻辑清晰，主要功能是发送精心构造的HTTP请求，并检查响应以确认漏洞的存在。使用的PHP代码也是为了执行预定的测试命令，没有发现任何试图在目标系统上安装后门或执行恶意操作的代码。

**搜索引擎结果：**

搜索结果表明CVE-2024-4577是一个严重的、广泛利用的漏洞。多个安全厂商和研究人员都发布了相关的分析和警告。该漏洞已被添加到CISA的已知被利用漏洞目录（KEV），表明该漏洞在野外被积极利用。


**项目地址:** [Jcccccx/CVE-2024-4577](https://github.com/Jcccccx/CVE-2024-4577)

**漏洞详情:** [CVE-2024-4577](https://nvd.nist.gov/vuln/detail/CVE-2024-4577)