## CVE-2022-22947 Spring Cloud Gateway代码注入

**漏洞编号:** CVE-2022-22947

**漏洞类型:** 代码注入

**影响应用:** Spring Cloud Gateway

**危害等级:** 高危，可导致远程代码执行

**影响版本:** Spring cloud gateway versions 3.1.x prior to 3.1.1+, 3.0.x prior to 3.0.7+ and all old and unsupported versions

**利用条件:** Gateway Actuator endpoint is enabled, exposed and unsecured

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2022-22947 是 Spring Cloud Gateway 中的一个代码注入漏洞。当 Gateway Actuator 端点启用、暴露且未受保护时，远程攻击者可以发送恶意构造的请求，从而在远程主机上执行任意远程代码。该漏洞的利用方式如下：

1.  **漏洞原理：** 漏洞根源在于 SpEL 表达式的错误处理，攻击者可以通过 SpEL 表达式注入恶意代码。
2.  **利用步骤：**
    *   攻击者首先发送包含恶意 SpEL 表达式的请求到 `/actuator/gateway/routes/` 端点，添加一个新的路由，其中 `filter` 使用 `AddResponseHeader` 过滤器，`value` 包含恶意的 SpEL 表达式，SpEL表达式会被base64编码，保证其可以正常传输
    *   然后，攻击者通过访问 `/actuator/gateway/refresh` 端点，强制网关刷新路由配置，从而触发 SpEL 表达式的执行。
    *   最后，攻击者可以通过访问之前创建的路由(`/actuator/gateway/routes/66Sec`)，触发 SpEL 表达式的执行，并将执行结果通过请求返回。
3.  **POC 代码分析：**
    *   `CVE-2022-22947.py` 脚本首先定义了几个关键变量，包括 URL 路径（`payload1`, `payload2`, `payload3`）和请求头（`headers`）。
    *   `data` 变量包含经过 Base64 编码的恶意路由配置信息。该配置信息设置了一个名为 `WeianSec` 的路由，该路由使用 `AddResponseHeader` 过滤器，并将 SpEL 表达式注入到 `value` 属性中。
    *   脚本使用 `requests` 库发送 POST 请求到 `/actuator/gateway/routes/66Sec` 端点，添加恶意路由。
    *   然后，脚本发送 POST 请求到 `/actuator/gateway/refresh` 端点，刷新路由配置。
    *   最后，脚本发送 GET 请求到 `/actuator/gateway/routes/66Sec` 端点，提取执行结果。
    *   脚本中的 cmd变量，允许用户自定义执行的命令，增加了灵活性。
4.  **有效性：** 根据漏洞库信息、搜索结果和提供的 POC 代码，该 POC 代码是有效的，可以实现远程代码执行。
5.  **投毒风险：** 仓库中存在小概率的投毒风险（10%）。风险点在于，虽然主脚本 `CVE-2022-22947.py` 看似直接利用漏洞，但攻击者可以通过修改 `cmd` 变量来执行任意命令，并且README.md文件中提供的图片是经过处理的，不排除作者后期修改代码，添加恶意后门的可能。

**项目地址:** [SecNN/CVE-2022-22947_Rce_Exp](https://github.com/SecNN/CVE-2022-22947_Rce_Exp)

**漏洞详情:** [CVE-2022-22947](https://nvd.nist.gov/vuln/detail/CVE-2022-22947)