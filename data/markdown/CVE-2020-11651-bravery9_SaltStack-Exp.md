## CVE-2020-11651 SaltStack 认证绕过与远程代码执行

**漏洞编号:** CVE-2020-11651

**漏洞类型:** 认证绕过/远程代码执行

**影响应用:** SaltStack Salt

**危害等级:** 高危，可导致服务器完全控制

**影响版本:** < 2019.2.4 和 3000 < 3000.2

**利用条件:** 需要能够与Salt Master的4505/4506端口建立网络连接

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2020-11651漏洞存在于SaltStack Salt的salt-master进程中，由于ClearFuncs类未正确验证方法调用，未经身份验证的远程用户可以访问某些方法，从而可以从Salt Master检索用户令牌，或者在Salt Minion上执行任意命令。

**有效性：**
提供的POC代码利用了未经身份验证的访问来执行多种操作，包括读取文件、上传文件、执行命令，甚至获取反向shell。根据漏洞库信息和搜索结果，该漏洞利用的有效性很高。

**投毒风险：**
* 代码主要分为几个功能模块：连接Salt Master，检查漏洞版本，读取文件，上传文件，反弹shell，执行命令
* 代码中包含从GitHub仓库引用的代码，但经过代码阅读确认，引入的是正常的POC代码。
* 代码中存在远程连接功能，可能存在被利用执行恶意操作的风险。例如，攻击者可能修改代码，将反向shell的目标IP地址和端口更改为攻击者控制的服务器，从而实现恶意控制。
* 存在少量投毒风险，例如利用`cmd.exec_code`执行恶意代码。总体来看, 投毒风险预估为10%。大部分代码还是漏洞利用相关。

**利用方式：**
1.  **版本检测：**  POC首先检测Salt Master的版本，确认目标是否在受影响的范围内。
2.  **连接建立：**  POC会尝试与Salt Master建立连接，利用clear类型的连接方式绕过认证。
3.  **读取root key：**  通过_prep_auth_info方法在未授权的情况下读取root key.
4.  **文件读取/写入：**  利用读取到的root key, 可以读取Salt Master服务器上的任意文件。同理也可以上传文件。
5.  **命令执行：**  利用root key，通过`cmd.exec_code`在Salt Master或者Minion上执行任意命令。
6.  **反向Shell：**  利用root key, 可以执行反向shell代码，从而获得Salt Master的shell控制权限。
总体来说，该漏洞的利用方式是利用未经授权的访问权限，结合SaltStack的内部机制，最终实现远程代码执行。

**项目地址:** [bravery9/SaltStack-Exp](https://github.com/bravery9/SaltStack-Exp)

**漏洞详情:** [CVE-2020-11651](https://nvd.nist.gov/vuln/detail/CVE-2020-11651)