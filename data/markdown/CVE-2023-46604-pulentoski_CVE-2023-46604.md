## CVE-2023-46604 - Apache ActiveMQ OpenWire 反序列化 RCE

**漏洞编号:** CVE-2023-46604

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Apache ActiveMQ

**危害等级:** 高危，可能导致完全控制受影响的系统

**影响版本:** Apache ActiveMQ 5.15.15 及之前版本， 5.16.0 到 5.16.6, 5.17.0 到 5.17.5, 5.18.0 到 5.18.2

**利用条件:** 需要网络访问ActiveMQ Broker的OpenWire端口（通常为61616），且目标classpath包含`org.springframework.context.support.ClassPathXmlApplicationContext`或其他可利用的类。

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2023-46604 是 Apache ActiveMQ 中 OpenWire 协议反序列化漏洞，允许未经身份验证的远程攻击者通过操纵 OpenWire 协议中的序列化类类型来执行任意代码。漏洞利用的核心在于向 ActiveMQ Broker 发送特制的 OpenWire 消息，该消息包含一个指向恶意 XML 文件的 URL。该 XML 文件利用 Spring 的 `ClassPathXmlApplicationContext` 类来实例化并执行恶意代码。 

**有效性分析：**

*   根据漏洞描述，该漏洞允许远程代码执行，CVSS 评分为 10，属于严重漏洞。
*   搜索结果显示该漏洞已被野外利用，被用于传播 Kinsing 恶意软件和勒索软件，表明其具有较高的实际威胁。
*   提供的 POC 代码利用了 `org.springframework.context.support.ClassPathXmlApplicationContext` 类从远程 URL 加载并执行恶意 XML，这与漏洞描述相符。
*   POC 中包含的 `poc.xml` 文件展示了如何使用 Spring bean 定义来执行 bash 命令，进一步验证了 RCE 的可能性。
*   多个来源 (CISA KEV, Rapid7, Trend Micro等) 均确认了该漏洞的有效性以及被利用的事实.

**投毒风险分析：**

*   查看了 Python 脚本和 XML 文件，未发现任何明显的投毒代码。
*   Python 脚本的功能相对简单，主要用于构造 OpenWire 消息并发送到 ActiveMQ Broker。脚本的目的就是去访问 `-u` 参数的URL。
*   `poc.xml` 文件也只是定义了一个执行反向 shell 的 Spring bean。
*   综上，该 POC 仓库中作者隐藏投毒代码的风险极低，几乎可以排除。

**利用方式：**

1.  **准备恶意 XML 文件：**  创建一个包含恶意 Spring bean 定义的 XML 文件（例如 `poc.xml`），该 bean 能够执行任意代码。常见的做法是利用 `java.lang.ProcessBuilder` 执行反向 shell 或其他恶意命令。
2.  **部署 XML 文件：** 将恶意 XML 文件部署到一个可通过 HTTP 或其他协议访问的 URL。确保 ActiveMQ Broker 可以访问该 URL。
3.  **构造 OpenWire 消息：** 使用提供的 Python 脚本或其他工具，构造一个包含恶意 XML 文件 URL 的 OpenWire 消息。消息中指定使用 `org.springframework.context.support.ClassPathXmlApplicationContext` 类来加载 XML 文件。
4.  **发送 OpenWire 消息：** 将构造好的 OpenWire 消息发送到 ActiveMQ Broker 的 OpenWire 端口（默认为 61616）。
5.  **触发 RCE：** ActiveMQ Broker 接收到消息后，会尝试反序列化消息内容，并根据 XML 文件中的定义执行恶意代码。例如，如果 XML 文件中定义了反向 shell，攻击者将在攻击机上收到 shell 连接。

**项目地址:** [pulentoski/CVE-2023-46604](https://github.com/pulentoski/CVE-2023-46604)

**漏洞详情:** [CVE-2023-46604](https://nvd.nist.gov/vuln/detail/CVE-2023-46604)