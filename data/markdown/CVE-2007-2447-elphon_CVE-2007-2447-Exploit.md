## CVE-2007-2447-Samba-远程命令注入

**漏洞编号:** CVE-2007-2447

**漏洞类型:** 远程命令注入

**影响应用:** Samba

**危害等级:** 高危，可能导致远程代码执行

**影响版本:** 3.0.0 to 3.0.25rc3

**利用条件:** 需要开启'username map script' smb.conf选项或利用其他 MS-RPC 函数（远程打印和文件共享管理），以及可访问Samba服务的网络

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2007-2447是Samba smbd中的一个远程命令注入漏洞。该漏洞源于MS-RPC功能在处理某些请求时，未正确过滤shell元字符，使得攻击者可以通过(1) SamrChangePassword函数（当启用“username map script” smb.conf选项时），以及 (2)远程打印机和(3)文件共享管理中的其他 MS-RPC 函数，执行任意命令。

**有效性评估：**

提供的C++和Python POC代码都旨在利用此漏洞。C++代码通过`smbclient`工具，构造包含恶意shell命令的用户名，尝试连接到目标Samba服务器的`tmp`共享。Python代码使用`smb.SMBConnection`库构造包含恶意shell命令的用户名尝试连接目标Samba服务器的445端口，如果配置允许，这段命令将在服务器端被执行，从而建立反向shell。

搜索引擎结果也确认了该漏洞的存在，并指出该漏洞允许远程攻击者执行任意命令。

综合来看，提供的POC代码具有较高的有效性，能够利用该漏洞。

**投毒风险评估：**

虽然提供的代码主要是为了复现漏洞，但也存在一定的投毒风险。C++代码尝试安装`smbclient`，如果用户不小心执行，可能安装恶意版本的`smbclient`。Python代码虽然依赖于`smb`库，但执行的shell命令从代码可读性上无法判断其是否包含恶意行为，除非详细审查其网络连接行为。此外，攻击者可能通过修改payload中的命令，植入后门或进行其他恶意活动。投毒风险评定为10%。

**利用方式分析：**

1.  **漏洞触发：** 攻击者通过向目标Samba服务器发送特制的MS-RPC请求，在用户名或密码等参数中嵌入shell元字符。
2.  **命令注入：** 由于Samba在处理这些请求时没有正确过滤shell元字符，导致嵌入的恶意命令被执行。
3.  **代码执行：** 成功注入的命令在目标服务器上以Samba进程的权限执行，攻击者可以利用此权限执行任意操作，例如建立反向shell、安装后门、窃取数据等。
4.  **利用条件：** 成功利用此漏洞需要目标服务器运行受影响的Samba版本，并且满足触发漏洞的特定配置要求（例如启用“username map script”）。此外，攻击者需要能够访问目标Samba服务器的网络端口。

**项目地址:** [elphon/CVE-2007-2447-Exploit](https://github.com/elphon/CVE-2007-2447-Exploit)

**漏洞详情:** [CVE-2007-2447](https://nvd.nist.gov/vuln/detail/CVE-2007-2447)