## CVE-2019-13272 - Linux Kernel PTRACE_TRACEME Local Root

**漏洞编号:** CVE-2019-13272

**漏洞类型:** 权限提升

**影响应用:** Linux Kernel

**危害等级:** 高危，本地用户可获取root权限

**影响版本:** Linux kernel < 5.1.17

**利用条件:** 本地用户权限，目标系统内核版本低于5.1.17，需要存在可利用的helper程序如pkexec

**POC 可用性:** 是

**投毒风险:** 1%

## 详情

CVE-2019-13272 漏洞存在于 Linux 内核的 ptrace_link 函数中，该函数在处理 PTRACE_TRACEME 功能时，未正确记录进程凭据。攻击者可以利用具有父子进程关系的特定场景，在父进程降权并调用 execve 时，通过控制子进程来获得 root 权限。该漏洞可以借助 Polkit 的 pkexec helper 来触发。 

**有效性分析：**

提供的 POC 代码 `CVE-2019-13272.c` 旨在利用此漏洞。代码通过以下步骤尝试利用漏洞：

1.  **环境检查：** 检查运行环境是否满足漏洞利用条件。
2.  **查找 Helper：** 搜索已知的 helper 程序 (如 `mate-power-backlight-helper`)，这些程序在执行过程中会调用 pkexec，从而触发漏洞。
3.  **Spawn SUID Process：** 创建一个 SUID 进程 (`pkexec`)。
4.  **Tracing：** 使用 `ptrace` 系统调用跟踪子进程。
5.  **提权：** 在父进程执行 `pkexec` 的过程中，利用漏洞修改进程凭据，从而获得 root 权限。

从代码和漏洞描述来看，提供的 POC 代码是有效的，可以成功利用该漏洞提升权限。

**投毒风险分析：**

代码总体结构清晰，主要功能是利用已知的漏洞。以下是一些需要考虑的潜在风险点，但整体风险较低：

*   **Helper 路径：** 代码包含一个已知 helper 路径的列表。虽然作者添加了搜索 suitable helpers 功能，但攻击者可能会修改此列表以包含恶意程序，尽管这需要攻击者拥有修改源码的能力。这种可能性非常小，因此投毒风险极低。
*   **依赖外部程序：** 代码依赖于 `pkexec` 和其他 helper 程序。如果这些程序被替换为恶意版本，则可能导致系统被攻击，但这不是此漏洞本身的投毒风险，而是系统环境安全问题。
*   **后门代码:** 经验证代码不存在后门代码。

综合来看，此代码中存在作者隐藏的恶意代码的可能性非常低，估算投毒风险为 1%。

**利用方式总结：**

1.  **编译 POC 代码：** 使用 GCC 等编译器编译提供的 `CVE-2019-13272.c` 文件。
2.  **运行 POC 代码：** 在目标系统上以普通用户身份运行编译后的可执行文件。
3.  **代码利用流程:**  POC 首先会fork出一个子进程，子进程会使用ptrace_traceme attach到父进程，利用父进程执行pkexec的权限验证期间的cred结构体竞争漏洞，提权到root。
4.  **获得 Root 权限：** 如果漏洞利用成功，将会获得一个 root shell。

**缓解措施：**

*   升级 Linux 内核到 5.1.17 或更高版本。
*   应用相关的安全补丁。
*   使用 SELinux 或 AppArmor 等安全模块限制 pkexec 的行为。
*   设置 `sysctl kernel.deny_ptrace=1` 禁用非特权进程的 `ptrace` 功能，但这可能会影响某些应用程序的正常运行。

**项目地址:** [oneoy/CVE-2019-13272](https://github.com/oneoy/CVE-2019-13272)

**漏洞详情:** [CVE-2019-13272](https://nvd.nist.gov/vuln/detail/CVE-2019-13272)