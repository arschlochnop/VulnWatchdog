## CVE-2021-22911-Rocket.Chat-NoSQL注入

**漏洞编号:** CVE-2021-22911

**漏洞类型:** NoSQL注入

**影响应用:** Rocket.Chat

**危害等级:** 高危，可能导致账户接管和远程代码执行

**影响版本:** 3.11, 3.12, 3.13

**利用条件:** 需要目标Rocket.Chat服务器版本为受影响版本，且未进行漏洞修复

**POC 可用性:** 是

**投毒风险:** 1%

## 详情

该漏洞存在于Rocket.Chat服务器中，由于未正确过滤输入，攻击者可以通过构造恶意的NoSQL查询语句，利用getPasswordPolicy接口进行未授权的NoSQL注入。攻击者可以利用此漏洞获取用户的密码重置令牌，甚至管理员的2FA密钥，进而接管账户。接管管理员账户后，可以通过创建恶意集成（Integration）并执行任意命令，实现远程代码执行。

**漏洞利用方式：**

1.  **未授权账户接管：** 利用getPasswordPolicy接口的NoSQL注入点，通过盲注的方式获取用户的密码重置token。
2.  **权限提升（管理员账户接管）：**
    *   如果管理员没有启用2FA，则直接重置管理员密码。
    *   如果管理员启用了2FA，则通过users.list接口的NoSQL注入点，获取管理员的2FA密钥，然后重置密码并使用获取的2FA密钥登录。
    *   (可选)可以通过与2fa密钥相同的方式获取重置令牌。
3.  **远程代码执行：** 接管管理员账户后，创建一个新的集成（Integration），并在集成中设置一个包含恶意代码的webhook，触发webhook即可执行任意命令。

**关于投毒风险：**

提供的漏洞利用代码主要是利用NoSQL注入漏洞，没有发现明显的恶意代码。代码逻辑是逐步利用漏洞，从密码重置到获取2FA密钥，最后到RCE。投毒风险较低，约为1%。

**项目地址:** [MrDottt/CVE-2021-22911](https://github.com/MrDottt/CVE-2021-22911)

**漏洞详情:** [CVE-2021-22911](https://nvd.nist.gov/vuln/detail/CVE-2021-22911)