## CVE-2016-5195 - Dirty COW

**漏洞编号:** CVE-2016-5195

**漏洞类型:** 权限提升

**影响应用:** Linux Kernel

**危害等级:** 高危，本地用户可获取root权限

**影响版本:** Linux kernel 2.x through 4.x before 4.8.3

**利用条件:** 目标系统内核版本在受影响范围内

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2016-5195，又名Dirty COW，是Linux内核中mm/gup.c文件中的一个竞争条件漏洞。该漏洞允许本地用户利用写时复制(COW)功能的不正确处理，写入只读内存映射，从而获得特权。

**有效性：**

提供的POC代码（基于ADB的Android环境利用）旨在利用Dirty COW漏洞。从提供的输出来看，该POC成功地修改了`/system/bin/run-as`，并获得了root权限的shell。因此，该POC在存在漏洞的Android设备上是有效的。此代码包含Makefile和Android.mk文件，表示它被设计为在Android平台上编译和运行，利用Android NDK构建工具。dirtycow.c和dcow.c包含漏洞利用的主体,使用madvise和/proc/self/mem等技术触发竞争条件并覆盖只读内存。

**投毒风险：**

分析POC代码，存在一定的投毒风险，主要体现在以下几个方面：
1.  **二进制替换的潜在风险：** 该利用方法涉及替换系统文件（例如`/system/bin/run-as`），如果替换过程失败或目标文件被恶意修改，可能会导致系统不稳定或功能异常。虽然POC旨在利用漏洞提升权限，但如果被篡改，可能被用于植入后门或恶意软件。
2.  **依赖外部工具：** 该POC依赖ADB和Android NDK等工具，这些工具本身如果被篡改或来自不可信的来源，可能会引入安全风险。
3.  **代码复杂性：** 尽管提供的代码片段看起来直接，但真正的漏洞利用代码可能更复杂，包含混淆或隐藏的恶意功能。
4. **run-as文件:** 该漏洞利用会将/system/bin/run-as替换为攻击者的二进制文件，如果攻击者的二进制文件包含恶意代码，则可能存在投毒风险.
5. **Makefile文件:** 该文件中包含ndk-build命令，该命令会从互联网上下载依赖，这存在投毒风险.

综上，虽然该POC主要是为了验证漏洞的存在和利用，但其操作的敏感性以及对外部工具的依赖，使得投毒风险不可忽视。估计投毒风险的概率为10%。

**利用方式：**

1.  **查找目标文件：** 漏洞利用首先确定要修改的目标文件，这里是`/system/bin/run-as`。
2.  **内存映射：** 使用`mmap()`将目标文件映射到进程的内存空间，并获得其大小。
3.  **触发竞争条件：** 通过`madvise()`触发写时复制(COW)机制，并通过`/proc/self/mem`文件并发写入内存，从而绕过只读保护。
4.  **修改文件内容：** 成功触发竞争条件后，利用代码修改内存中映射的文件内容，从而修改了实际的磁盘文件。
5.  **执行被修改的文件：** 最后，执行被修改的文件，由于文件内容已被替换为具有root权限的shell，因此可以获得root权限。

**项目地址:** [timwr/CVE-2016-5195](https://github.com/timwr/CVE-2016-5195)

**漏洞详情:** [CVE-2016-5195](https://nvd.nist.gov/vuln/detail/CVE-2016-5195)