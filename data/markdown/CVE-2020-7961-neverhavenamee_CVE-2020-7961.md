## CVE-2020-7961: Liferay Portal 反序列化导致远程代码执行

**漏洞编号:** CVE-2020-7961

**漏洞类型:** 反序列化漏洞

**影响应用:** Liferay Portal

**危害等级:** 高危，远程代码执行

**影响版本:** < 7.2.1 CE GA2

**利用条件:** 需要能够访问Liferay Portal的JSONWS接口

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2020-7961 存在于 Liferay Portal 7.2.1 CE GA2 之前的版本中，是一个反序列化漏洞。攻击者可以通过 JSON Web Services (JSONWS) 接口，特别是 `/api/jsonws/invoke` 端点，发送恶意构造的序列化数据，从而导致远程代码执行。

**有效性：**

提供的PoC代码描述了漏洞的利用方法，通过构造包含恶意序列化数据的 `defaultData` 参数，可以触发反序列化漏洞。多个搜索结果（例如Rapid7, Synacktiv, Wiz.io, 0xweb01.medium.com)确认了该漏洞的存在以及利用方式，因此PoC代码被认为是有效的。

**投毒风险：**

PoC代码本身只是描述了漏洞的利用过程，主要是通过构造恶意的HTTP POST请求。从代码内容来看，主要的风险在于利用该漏洞进行攻击，而不是代码本身包含恶意payload。该文档更侧重于原理分析和利用方法讲解。投毒风险较低，但不能完全排除（例如在实际利用时，攻击者可能会使用混淆的payload）。评估投毒风险为5%，主要考虑到以下几点：

*   PoC 代码主要展示了漏洞利用的原理和方法，而非直接可执行的后门代码。
*   实际的攻击 payload 需要根据目标环境进行定制。
*   代码仓库中提供的更多是漏洞分析文档，而不是直接运行的攻击脚本。
*   仍然需要安全人员 review 所有代码，避免代码被植入恶意逻辑。

**利用方式：**

1.  **确定目标：** 找到运行 Liferay Portal 且版本低于 7.2.1 CE GA2 的实例。
2.  **身份验证：** 理论上此漏洞可以未经身份验证利用，但某些情况下可能需要有效的 `p_auth` token。
3.  **构造请求：** 构造一个 HTTP POST 请求到 `/api/jsonws/invoke` 端点。
4.  **设置参数：** 在请求体中设置以下参数：
    *   `cmd`: 包含要调用的 JSONWS 方法，例如 `{"/expandocolumn/update-column":{}}`。
    *   `p_auth` (如果需要): 有效的身份验证 token。
    *   `formDate`: 当前时间戳。
    *   `columnId`, `name`, `type`: 这些参数是 `/expandocolumn/update-column` 方法需要的，需要设置。
    *   `defaultData`: 这是一个关键参数，需要设置为包含恶意序列化数据的对象。例如，可以使用 `com.mchange.v2.c3p0.WrapperConnectionPoolDataSource` 类，并设置其 `userOverridesAsString` 属性为恶意的序列化数据。
5.  **发送请求：** 发送构造好的 HTTP POST 请求。
6.  **执行代码：** 如果漏洞利用成功，恶意序列化数据将被反序列化，从而在服务器上执行任意代码。

总而言之，CVE-2020-7961 是一个严重的反序列化漏洞，允许未经授权的攻击者在 Liferay Portal 服务器上执行任意代码。应该尽快升级到受影响版本之后的版本。

**项目地址:** [neverhavenamee/CVE-2020-7961](https://github.com/neverhavenamee/CVE-2020-7961)

**漏洞详情:** [CVE-2020-7961](https://nvd.nist.gov/vuln/detail/CVE-2020-7961)