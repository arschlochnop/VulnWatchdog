## CVE-2023-41992 - iOS/macOS 本地权限提升

**漏洞编号:** CVE-2023-41992

**漏洞类型:** 本地权限提升 (LPE)

**影响应用:** XNU Kernel

**危害等级:** 高危，允许本地攻击者提升权限

**影响版本:** macOS Monterey < 12.7, iOS and iPadOS < 16.7, macOS Ventura < 13.6

**利用条件:** 需要本地访问权限

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2023-41992是一个存在于XNU内核中的本地权限提升漏洞。Apple已知该漏洞在iOS 16.7之前的版本中被积极利用。漏洞修复方案包括改进的检查机制，已在macOS Monterey 12.7、iOS/iPadOS 16.7以及macOS Ventura 13.6中修复。

**漏洞利用方式：**

1.  漏洞的根源在于`ipc_right_destroy`函数中，当销毁IPC权限时，如果存在“early-return”路径（例如，端口被pinned），会导致`ie_bits`中的类型信息被擦除。
2.  当调用`mach_thread_self()`时，内核会进入`thread_self_trap`，最终调用`ipc_right_copyout`。
3.  在`ipc_right_copyout`函数中，如果`msgt_name`为`MACH_MSG_TYPE_PORT_SEND`，则会检查entry类型。如果entry类型为空，则代码`entry->ie_bits = (bits | MACH_PORT_TYPE_SEND) + 1;`可能导致整数溢出。
4.  如果`urefs`达到0xffff且`ie_bits`中没有类型信息，则溢出可能导致entry类型变为`MACH_PORT_RIGHT_RECEIVE`。
5. PoC代码通过创建特定条件，触发内核crash，以此证明漏洞存在。

**有效性：**

根据漏洞描述和PoC代码，该漏洞是有效的，并且已被在野利用。PoC代码展示了一种触发内核崩溃的方法，虽然不直接提供权限提升，但证实了漏洞的存在。

**投毒风险：**

PoC代码主要由README.md和Objective-C代码组成。README.md描述了漏洞原理和利用思路。Objective-C代码实现了一个简单的应用，旨在触发内核漏洞。代码中没有发现明显的恶意行为或后门代码。但仍然存在一定风险：PoC代码的作者在文档中提到，希望有人可以成功利用此漏洞，作者对漏洞本身的利用表示不确定，暗示可能存在某些未知的利用细节或限制。 考虑到PoC依赖于内核级别的操作，误用或不完全理解可能导致设备不稳定甚至无法启动。因此，仍不能排除潜在的风险。

风险评估：虽然代码本身没有发现恶意行为，但由于内核利用的复杂性和潜在的破坏性，仍然存在一定的投毒风险，占比约为10%。这主要是因为利用代码的编写者可能隐藏了未公开的细节，或者PoC本身可能存在其他未知的副作用，导致利用过程中发生意外情况。

**项目地址:** [karzanWang/CVE-2023-41992](https://github.com/karzanWang/CVE-2023-41992)

**漏洞详情:** [CVE-2023-41992](https://nvd.nist.gov/vuln/detail/CVE-2023-41992)