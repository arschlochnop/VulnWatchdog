## CVE-2023-46604 Apache ActiveMQ RCE

**漏洞编号:** CVE-2023-46604

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Apache ActiveMQ

**危害等级:** 高危，可能导致完全控制受影响系统

**影响版本:** 5.18.0 <= version < 5.18.3, 5.17.0 <= version < 5.17.6, 5.16.0 <= version < 5.16.7, version < 5.15.16

**利用条件:** 需要网络访问 ActiveMQ broker 或 client 的 OpenWire 端口 (默认 61616)

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2023-46604 是一个 Apache ActiveMQ 中的远程代码执行漏洞。该漏洞源于 Java OpenWire 协议 marshaller 在处理不可信数据时存在反序列化漏洞。攻击者可以通过操纵 OpenWire 协议中的序列化类类型，使客户端或代理（broker）实例化 classpath 上的任何类，从而执行任意 shell 命令。

**有效性：**
根据漏洞库信息、搜索结果和提供的 PoC 代码，可以判断该漏洞的 PoC 代码有效。搜索结果中包含多个关于该漏洞被积极利用的报告，包括被 Kinsing 恶意软件和勒索软件利用。

**投毒风险：**
PoC 代码本身看起来比较直接，主要是构造恶意的 OpenWire 消息来触发反序列化漏洞。但是XML URL需要外联, 存在被替换的可能,因此投毒风险无法排除. 存在细微的投毒风险,主要体现在以下几点：

1.  **XML Payload:** 该PoC依赖于外部XML文件，如果攻击者能够篡改XML文件的内容，可以在XML中植入恶意代码，例如反弹shell、下载恶意软件等。虽然PoC代码本身没有恶意，但是XML文件可以成为投毒的载体。
2.  **网络连接:** 该PoC需要建立网络连接才能发送恶意payload，如果攻击者能够截获PoC发送的payload并进行修改，可以改变PoC的行为。

综上所述，该PoC存在一定的投毒风险，主要来自于XML Payload和网络连接环节。用户在使用该PoC时需要仔细检查XML文件内容和网络连接的安全性。

**利用方式：**
1.  **确定目标：** 找到运行着存在漏洞的 Apache ActiveMQ 版本的服务器。
2.  **构造恶意 XML：** 构造包含恶意代码的 XML 文件，该文件利用 `org.springframework.context.support.ClassPathXmlApplicationContext` 来执行命令。
3.  **利用 PoC 发送恶意请求：** 使用 PoC 脚本，指定目标 ActiveMQ 服务器的 IP 地址、端口和恶意 XML 文件的 URL。PoC 脚本会将构造好的 OpenWire 消息发送到目标服务器。
4.  **执行任意代码：** 如果漏洞利用成功，目标服务器会解析恶意 XML 文件，并执行其中的代码，从而允许攻击者在服务器上执行任意命令。

**项目地址:** [NKeshawarz/CVE-2023-46604-RCE](https://github.com/NKeshawarz/CVE-2023-46604-RCE)

**漏洞详情:** [CVE-2023-46604](https://nvd.nist.gov/vuln/detail/CVE-2023-46604)