## CVE-2021-44142-Samba vfs_fruit 模块堆溢出

**漏洞编号:** CVE-2021-44142

**漏洞类型:** 堆溢出（Out-of-bounds Read/Write）

**影响应用:** Samba

**危害等级:** 高危，远程攻击者可能以 smbd 进程（通常为 root 权限）执行任意代码

**影响版本:** < 4.13.17, < 4.14.12, < 4.15.5

**利用条件:** 需要 Samba 服务器配置了 vfs_fruit 模块，并且攻击者具有对扩展文件属性（EA, xattr）的写入权限

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-44142 漏洞存在于 Samba 的 vfs_fruit 模块中。该模块旨在提供与 Apple SMB 客户端的兼容性以及与 Netatalk 3 AFP 文件服务器的互操作性。

**漏洞利用方式：**
攻击者通过精心构造的扩展文件属性（EA, xattr）触发漏洞。具体来说，当 `vfs_fruit` 模块处理这些特制属性时，会导致越界堆读取和写入操作。由于攻击者拥有扩展属性的写入权限，他们可以控制写入的内容，从而可能覆盖内存中的关键数据结构，最终导致远程代码执行，权限提升至 `smbd` 进程的权限，通常是 root。

**POC 代码分析：**
提供的 Dockerfile 构建了一个易受攻击的 Samba 环境，并包含对 `source3/modules/vfs_fruit.c` 文件的修改，通过修改后的代码，尝试进行内存地址泄露。具体而言，它修改了 `fruit_pread_meta_stream` 和 `fruit_pread_meta_adouble` 函数，在特定条件下将伪造的 cookie 和指针复制到数据缓冲区中。此修改的目的是允许进一步利用该漏洞，从而进行代码执行。

**投毒风险分析：**
此仓库中存在作者隐藏的投毒代码的可能性较低，大约为10%。

主要原因:
*   **代码修改目的：** Dockerfile 对 `vfs_fruit.c` 的修改主要集中于添加内存泄露的逻辑，而不是直接执行恶意代码。这些修改旨在为进一步的漏洞利用奠定基础。
*   **公开的漏洞信息：**  CVE-2021-44142 是一个公开披露的漏洞，包含博客文章，该漏洞可实现远程代码执行。
*   **Docker环境：** 该docker环境主要是为了模拟漏洞环境提供方便，降低利用难度。

然而，仍然存在一定的投毒风险，因为攻击者可能:

*   **构建依赖：** 构建过程中，可能依赖不安全的构建源，例如被篡改的第三方lib，导致最终构建的镜像中存在后门。
*   **其他配置缺陷：** Dockerfile和相关配置文件可能存在其他安全缺陷，例如不安全的默认配置、弱密码等，可被用于进一步的攻击。

**项目地址:** [WinDyAlphA/CVE-2021-44142-vulnerable-lab](https://github.com/WinDyAlphA/CVE-2021-44142-vulnerable-lab)

**漏洞详情:** [CVE-2021-44142](https://nvd.nist.gov/vuln/detail/CVE-2021-44142)