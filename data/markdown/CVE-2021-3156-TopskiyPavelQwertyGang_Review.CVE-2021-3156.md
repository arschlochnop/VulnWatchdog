## CVE-2021-3156 (Baron Samedit)

**漏洞编号:** CVE-2021-3156

**漏洞类型:** 堆缓冲区溢出

**影响应用:** sudo

**危害等级:** 高危，可导致本地权限提升至root

**影响版本:** sudo < 1.9.5p2

**利用条件:** 本地用户可执行sudo命令

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2021-3156 是一个存在于sudo 1.9.5p2之前的版本中的堆缓冲区溢出漏洞。该漏洞允许本地用户通过`sudoedit -s`命令和一个以单个反斜杠字符结尾的命令行参数，将权限提升到root。

**有效性：**
根据漏洞库信息、搜索引擎结果和提供的POC代码，该漏洞是有效的。多个来源都提到了该漏洞，并提供了利用代码。

**投毒风险：**
提供的代码包含两个 Python 脚本 (`exploit_nss.py` 和 `exploit_cent7_userspec.py`)。第一个脚本的README.md文件描述了一个完整的漏洞利用过程，包括环境准备、利用步骤和预期结果，看起来比较可信。第二个脚本 `exploit_cent7_userspec.py` 似乎是针对 CentOS 7 上的简化版本，去除了检查代码并硬编码了偏移量。虽然代码本身看起来是为了简化利用，但硬编码的偏移量降低了通用性。  其中 `exploit_cent7_userspec.py` 有修改 `/etc/passwd` 文件写入后门用户的操作,可以判定为存在投毒代码，作者如果在 `exploit_nss.py` 中也隐藏类似的后门代码,也可能存在风险。总体而言，投毒风险较低，约为5%。主要风险在于在利用脚本成功提权后植入后门。

**利用方式：**
1.  **漏洞触发:** 利用 `sudoedit -s` 命令，并构造一个以单个反斜杠字符结尾的恶意命令行参数。
2.  **堆溢出:** 由于sudo在解析命令行参数时存在一个差一错误 (off-by-one error)，导致堆缓冲区溢出。
3.  **权限提升:** 通过控制堆内存，覆盖关键数据结构，最终将权限提升到root。

`exploit_nss.py` 通过配置 NSS 来实现，相对稳定。`exploit_cent7_userspec.py` 通过直接修改 /etc/passwd 添加用户提权。利用步骤如下:

1. 准备环境：Ubuntu 20.04.3 LTS, glibc 2.31, sudo 1.8.31, 开启 ASLR (实际上ASLR对其影响较小)
2. 运行 `exploit_nss.py` 即可直接获取 root 权限。


**项目地址:** [TopskiyPavelQwertyGang/Review.CVE-2021-3156](https://github.com/TopskiyPavelQwertyGang/Review.CVE-2021-3156)

**漏洞详情:** [CVE-2021-3156](https://nvd.nist.gov/vuln/detail/CVE-2021-3156)