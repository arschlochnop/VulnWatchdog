## CVE-2007-2447-Samba-远程命令注入

**漏洞编号:** CVE-2007-2447

**漏洞类型:** 远程命令注入

**影响应用:** Samba

**危害等级:** 高危，可能导致远程代码执行

**影响版本:** 3.0.0 through 3.0.25rc3

**利用条件:** 目标Samba服务器开启了MS-RPC服务，并且启用了"username map script"配置（对于SamrChangePassword函数利用），或者存在其他MS-RPC函数利用（远程打印和文件共享管理），需要网络可达。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2007-2447 漏洞存在于Samba的`smbd`服务中，受影响版本为3.0.0到3.0.25rc3。该漏洞允许远程攻击者通过MS-RPC功能执行任意命令。漏洞利用方式主要有两种：

1.  **SamrChangePassword函数 + username map script：** 当Samba配置文件(`smb.conf`)中启用了`username map script`选项时，攻击者可以利用`SamrChangePassword`函数，通过在用户名中注入shell元字符，执行任意命令。
2.  **其他MS-RPC函数（远程打印和文件共享管理）：** 即使没有启用`username map script`，远程认证用户也可以利用其他的MS-RPC函数（如远程打印和文件共享管理相关的函数），通过注入shell元字符执行命令。

提供的PoC代码`CVE-2007-2447.py`针对第一种利用方式，它通过构造包含反弹shell命令的恶意用户名，尝试连接目标SMB服务器。如果目标服务器存在漏洞，并且满足`username map script`的条件，则会执行该命令，从而在攻击者机器上建立反弹shell。

**有效性：**

提供的PoC代码有效，可以用于验证和利用该漏洞。

**投毒风险：**

PoC代码本身直接执行了用户提供的lhost和lport参数，形成反弹shell，这个行为本身就是漏洞利用的目的，所以不是后门代码。但是，仍然存在一定的投毒风险(大约10%)，主要体现在以下几个方面：

*   **参数处理不严谨：**PoC代码没有对`lhost`和`lport`参数进行严格的输入验证，如果攻击者在运行PoC时传入了包含恶意代码的`lhost`或`lport`，则可能被执行。虽然payload是明文的，但是仍不能排除。

*   **依赖库风险：**PoC代码依赖`pysmb`库，如果该库被篡改，可能会引入额外的安全风险。

总的来说，该PoC代码的投毒风险较低，但仍然需要保持警惕，确保从可信来源下载和使用。

**利用方式：**

1.  确保目标Samba服务器的版本在3.0.0到3.0.25rc3之间。
2.  确认目标服务器是否启用了`username map script`配置（对于SamrChangePassword函数利用）。或者确认可以利用远程打印和文件共享管理的相关功能。
3.  使用PoC代码，替换`--rhost`、`--lhost`和`--lport`参数为目标服务器IP、攻击者IP和端口。
4.  在攻击者机器上使用`nc -lvnp <lport>`监听指定端口。
5.  运行PoC代码。
6.  如果漏洞利用成功，攻击者将在监听端口上收到反弹shell。

**项目地址:** [0xKn/CVE-2007-2447](https://github.com/0xKn/CVE-2007-2447)

**漏洞详情:** [CVE-2007-2447](https://nvd.nist.gov/vuln/detail/CVE-2007-2447)