## CVE-2022-22965 Spring4Shell RCE

**漏洞编号:** CVE-2022-22965

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Spring Framework

**危害等级:** 高危，可导致完全控制受影响的服务器

**影响版本:** Spring Framework 5.3.X prior to 5.3.18+, 5.2.x prior to 5.2.20+ 以及所有旧的、不受支持的版本，运行在JDK 9+且部署为WAR包到Tomcat服务器上

**利用条件:** 目标应用必须满足：使用Spring MVC或Spring WebFlux，运行在JDK 9+，部署为WAR包到Tomcat服务器上

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2022-22965（Spring4Shell）是一个Spring Framework的远程代码执行漏洞，通过数据绑定利用。漏洞利用方式如下：

1.  **漏洞原理：** 攻击者通过修改`class.module.classLoader.resources.context.parent.pipeline.first`相关的属性（如`directory`, `prefix`, `suffix`, `pattern`等），来控制Tomcat的日志记录行为，最终写入一个恶意JSP webshell。
2.  **利用步骤：**
    *   首先，利用POST请求重置`fileDateFormat`属性。
    *   然后，通过POST请求设置Tomcat日志配置，包括日志目录、文件名前缀、后缀和包含恶意代码的日志模式，这些参数被编码在URL中。
    *   发送一个GET请求，触发日志记录，并将恶意JSP webshell写入到目标服务器上。
    *   webshell地址为`http://目标/前缀.jsp?cmd=命令`。
3.  **有效性：** 提供的POC代码是有效的，根据README的说明，可以成功在满足漏洞条件的服务器上执行任意命令。
4.  **投毒风险：**  虽然主要代码是为了利用漏洞，但仍存在一定的投毒风险。例如，`exploit-core.py`脚本中，恶意代码的写入目标（JSP webshell）是硬编码的。攻击者可能通过修改这些参数，在服务器上植入更隐蔽或更具破坏性的后门。Dockerfile中的lunasec/tomcat-9.0.59-jdk11镜像来源未经验证，有可能包含恶意代码，但是此仓库的重点在于spring漏洞利用。假设Dockerfile中的基础镜像没有问题，投毒风险比例约为10%。
5.  **总结：** 此漏洞的利用需要精心构造的HTTP请求，利用Spring的数据绑定机制，动态地修改Tomcat服务器的日志配置，最终达到远程代码执行的目的。这个过程对目标服务器的环境有一定要求，需要特定的Spring版本、JDK版本和部署方式。POC代码的有效性已经确认，但使用时需要注意潜在的投毒风险。

**项目地址:** [sunnyvale-it/CVE-2022-22965-PoC](https://github.com/sunnyvale-it/CVE-2022-22965-PoC)

**漏洞详情:** [CVE-2022-22965](https://nvd.nist.gov/vuln/detail/CVE-2022-22965)