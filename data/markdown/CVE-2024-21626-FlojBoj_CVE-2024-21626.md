## CVE-2024-21626-runc-容器逃逸

**漏洞编号:** CVE-2024-21626

**漏洞类型:** 容器逃逸

**影响应用:** runc

**危害等级:** 高危，可能导致主机文件系统访问和控制

**影响版本:** >=v1.0.0-rc93, < 1.1.12

**利用条件:** 需要runc版本在受影响范围内，并且允许容器执行`runc exec`或恶意镜像执行`runc run`

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2024-21626 存在于 runc 1.1.11 及更早版本中。由于文件描述符泄露，攻击者可以使新启动的容器进程（通过 runc exec）的工作目录位于主机文件系统命名空间中，从而允许通过访问主机文件系统来逃逸容器。该漏洞也可能被恶意镜像利用，通过 runc run 使得容器进程获得对主机文件系统的访问权限。更严重的是，攻击者可以覆盖半任意的主机二进制文件，从而完全逃逸容器。 

**有效性：**

根据漏洞描述和提供的POC代码，此POC代码有效。POC 代码提供了两种利用方式：一种是通过`-w /proc/self/fd/8`参数直接指定容器的工作目录到主机文件系统，另一种是通过在容器内部创建符号链接，然后使用`docker exec -w`命令将工作目录切换到主机文件系统。

**投毒风险：**

提供的漏洞利用代码仓库仅包含一个README.md文件，其中描述了漏洞的利用方法和受影响的版本。 代码中没有发现任何可疑的或恶意的代码。 仓库作者的目的是演示如何利用该漏洞，而不是植入后门或恶意代码。 但是如果攻击者拿到此代码,二次修改后进行传播，则存在一定的风险。因此投毒风险非常低,估计为5%。

**利用方式：**

此漏洞主要通过以下两种方式利用：

1.  **通过`docker run -w`参数：** 启动容器时，使用`-w /proc/self/fd/8`参数将容器的工作目录设置为主机文件系统上的某个目录。由于文件描述符泄露，`/proc/self/fd/8`指向的是主机文件系统，因此容器内的操作实际上是在主机文件系统上执行。
2.  **通过符号链接和`docker exec -w`参数：** 首先，在容器内部创建指向`/proc/self/fd/7/`和`/proc/self/fd/8/`的符号链接。然后，使用`docker exec -w`命令将容器的工作目录设置为这些符号链接指向的目录。同样，由于文件描述符泄露，这些符号链接实际上指向的是主机文件系统，从而允许容器访问和修改主机文件系统。

总而言之，该漏洞允许容器逃逸，攻击者可以利用它来访问和控制主机文件系统，从而造成严重的安全风险。

**项目地址:** [FlojBoj/CVE-2024-21626](https://github.com/FlojBoj/CVE-2024-21626)

**漏洞详情:** [CVE-2024-21626](https://nvd.nist.gov/vuln/detail/CVE-2024-21626)