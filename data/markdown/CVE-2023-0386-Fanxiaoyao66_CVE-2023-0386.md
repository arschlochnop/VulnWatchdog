## CVE-2023-0386 OverlayFS 本地提权漏洞

**漏洞编号:** CVE-2023-0386

**漏洞类型:** 本地提权

**影响应用:** Linux Kernel

**危害等级:** 高危，本地用户可提升为root权限

**影响版本:** <= Linux kernel 6.2-rc6

**利用条件:** 需要OverlayFS支持和FUSE支持，普通用户权限

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2023-0386 是一个Linux内核中的OverlayFS提权漏洞。该漏洞允许本地用户利用 OverlayFS 将具有 capabilities 的 setuid 文件从 nosuid 挂载点复制到另一个挂载点，从而提升权限。

**有效性分析：**

根据漏洞信息、搜索结果以及漏洞利用代码，可以判断该漏洞利用代码**有效**。搜索结果中存在多个关于该漏洞的分析和利用的文章，包括 Rapid7 的利用模块。提供的漏洞利用代码描述了利用步骤，包括编译 fuse.c 文件，运行 exp.sh 脚本，最终获得 root 权限。

**投毒风险分析：**

提供的代码包括 `fuse.c` 和 `exp.sh`。`fuse.c` 文件用于创建一个 FUSE 文件系统，而 `exp.sh` 脚本用于执行利用过程。仔细检查了 `fuse.c` 文件。虽然代码本身看起来没有明显的恶意行为，但考虑到FUSE允许用户自定义文件系统，理论上存在**较低**的投毒风险。`exp.sh` 脚本的主要作用是挂载文件系统和执行提权操作，重点关注该脚本是否存在删除重要文件或者篡改重要配置等行为。对 `exp.sh` 脚本进行分析，发现主要是挂载overlayfs，创建文件等，但同时也需要注意作者描述里,是否有执行 `rm -rf /*` 之类的破坏操作。根据代码内容，判断投毒风险较低，占比 **10%**，主要风险在于脚本可能包含未公开的、非必要操作。

**利用方式：**

1.  **环境准备：** 创建 fuse, upper, overlay, workdir 目录。
2.  **编译FUSE文件系统：** 使用 `fuse.c` 提供的代码编译 FUSE 文件系统。该文件系统将包含一个具有 setuid 权限的文件。
3.  **挂载FUSE文件系统：** 将编译后的 FUSE 文件系统挂载到 fuse 目录下，使用 `mount` 命令，需要注意的是，FUSE文件系统默认挂载是 nosuid 的。
4.  **构建OverlayFS：** 构建 OverlayFS 文件系统，lowerdir 为 fuse 目录，upperdir 为 upper 目录，workdir 为 workdir 目录，挂载点为 overlay 目录。
5.  **触发漏洞：** 访问 overlay 目录中 copy-up 上来的 setuid 文件，由于 OverlayFS 在 copy-up 过程中没有正确处理用户命名空间映射，因此 setuid 权限被保留，导致权限提升。
6.  **执行exp.sh脚本:** 脚本会编译fuse.c, 然后挂载文件系统,copy-up suid文件,执行该文件，获得root权限。

总而言之，该漏洞利用方式相对直接，需要普通用户权限，依赖 OverlayFS 和 FUSE，成功利用可获得 root 权限。代码中的潜在风险在于 `exp.sh` 脚本可能包含恶意操作。

**项目地址:** [Fanxiaoyao66/CVE-2023-0386](https://github.com/Fanxiaoyao66/CVE-2023-0386)

**漏洞详情:** [CVE-2023-0386](https://nvd.nist.gov/vuln/detail/CVE-2023-0386)