## CVE-2021-3156 - Sudo Heap-Based Buffer Overflow (Baron Samedit)

**漏洞编号:** CVE-2021-3156

**漏洞类型:** Heap-Based Buffer Overflow

**影响应用:** Sudo

**危害等级:** 高危，允许本地普通用户提升权限至root

**影响版本:** < 1.9.5p2 (受影响版本)

**利用条件:** 需要本地用户权限，目标系统sudo版本低于1.9.5p2且满足漏洞触发条件。

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2021-3156 (Baron Samedit) 是 Sudo 1.9.5p2 之前版本中的一个堆缓冲区溢出漏洞。此漏洞允许本地用户通过 `sudoedit -s` 和以单个反斜杠字符结尾的命令行参数将权限提升为 root。

**有效性:**

提供的 PoC 代码是有效的。Dockerfile 用于构建一个包含易受攻击的 Sudo 版本的环境 (Ubuntu 20.04 with Sudo 1.8.31-1ubuntu1)。 exploit.c 包含利用代码， shellcode.c 包含执行 shell 的 shellcode，Makefile 用于编译。

搜索结果也证实了该漏洞的存在和严重性，以及利用该漏洞的公开信息。

**投毒风险:**

分析提供的 PoC 代码，该代码利用了已知的 CVE-2021-3156 漏洞，没有明显的投毒迹象。 Shellcode只是简单的提升权限执行/bin/bash，没有恶意行为。代码目的是为了演示漏洞，快速获取root权限。

**利用方式:**

利用方式如下：

1.  **触发漏洞:** 通过 `sudoedit -s` 命令以及精心构造的、以单个反斜杠结尾的命令行参数，触发堆缓冲区溢出。
2.  **堆喷射 (Heap Feng-Shui):** 使用 `LC_*` 环境变量进行堆喷射，以便在内存中布置目标 `service_user` 结构体。
3.  **溢出覆盖:**  通过缓冲区溢出覆盖目标 `service_user` 结构体的 `files` 字段，将其指向包含 shellcode 的库的路径 (`/home/exploit/libnss_x/x.so.2`)。
4.  **执行 Shellcode:** 当 Sudo 尝试使用被覆盖的 `files` 字段时，会加载并执行我们的 shellcode。 Shellcode 提升权限并执行 `/bin/bash`，从而提供一个 root shell。

总而言之，提供的代码利用了 CVE-2021-3156 的堆缓冲区溢出漏洞，通过覆盖关键的 Sudo 结构体指针，允许未经授权的用户获得 root 权限。

**项目地址:** [q77190858/CVE-2021-3156](https://github.com/q77190858/CVE-2021-3156)

**漏洞详情:** [CVE-2021-3156](https://nvd.nist.gov/vuln/detail/CVE-2021-3156)