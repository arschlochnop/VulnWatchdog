## CVE-2021-3560-Polkit权限提升

**漏洞编号:** CVE-2021-3560

**漏洞类型:** 权限提升

**影响应用:** Polkit

**危害等级:** 高危，可导致本地用户获取root权限，影响数据保密性、完整性和系统可用性

**影响版本:** polkit 0.119 (受影响版本)

**利用条件:** 需要本地访问

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-3560 允许未经授权的本地用户通过利用 Polkit 中的缺陷绕过 D-Bus 请求的凭证检查，从而提升至 root 权限。漏洞利用代码通过发送精心构造的 D-Bus 消息，诱导 Polkit 产生竞争条件，从而错误地发出授权消息，绕过正常的身份验证过程。该漏洞利用依赖于精确的时间控制和多次尝试。 

**利用方式：**

1.  **竞争条件：** 利用 `dbus-send` 命令向 `org.freedesktop.Accounts` 发送 `CreateUser` 方法调用，同时使用 `sleep` 和 `kill` 命令模拟中断，创建竞争条件。
2.  **用户创建：** 通过重复发送带有中断的 `CreateUser` 请求，尝试在 Polkit 内部状态不一致时创建用户。
3.  **密码设置：** 成功创建用户后，使用 `openssl passwd` 生成密码哈希，并通过类似的竞争条件方式，利用 `dbus-send` 和 `SetPassword` 方法设置新用户的密码。
4.  **权限切换：** 使用 `su` 命令切换到新创建的用户，并使用 `sudo` 命令验证权限提升。

**有效性：**

提供的漏洞利用代码基于时间竞争，因此需要多次尝试才能成功。考虑到CISA的KEV条目以及大量公开可用的利用程序和漏洞分析，该PoC代码被认为是有效的。

**投毒风险：**

风险评估是基于以下因素：

1.  **代码复杂性：**  脚本相对简单，主要依赖于标准的 `dbus-send` 命令和 shell 脚本。
2.  **作者意图：**  作者提供了构建和运行容器的说明，这似乎是为了方便漏洞测试，而不是隐藏恶意代码。
3.  **可疑行为：**  在 `README.md` 中有执行时间的提示以及需要多次执行的步骤，这符合竞争条件漏洞利用的特征。
4. **潜在的投毒点:** PoC的有效性依赖于`sleep`命令的参数，即X.XXX的取值。如果该值被篡改为非常大的值，可能导致拒绝服务攻击。但是，这更像是可用性问题，而不是后门或者提权。另一种可能的攻击是替换`openssl passwd`为恶意程序。最后，构建容器的Dockerfile可能包含后门（例如，安装恶意软件包）。

基于以上分析，虽然存在一定的投毒风险（例如，替换 `openssl passwd` 命令），但主要风险在于利用过程的复杂性和对环境的依赖性。假设容器构建过程可信，没有发现明显的恶意代码。因此，投毒风险被评估为 10%。

**项目地址:** [markyu0401/CVE-2021-3560-Polkit-Privilege-Escalation](https://github.com/markyu0401/CVE-2021-3560-Polkit-Privilege-Escalation)

**漏洞详情:** [CVE-2021-3560](https://nvd.nist.gov/vuln/detail/CVE-2021-3560)