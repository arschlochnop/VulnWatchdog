## CVE-2019-3396-Atlassian Confluence-Server-Side Template Injection

**漏洞编号:** CVE-2019-3396

**漏洞类型:** Server-Side Template Injection (SSTI)

**影响应用:** Atlassian Confluence Server

**危害等级:** 高危，可导致远程代码执行

**影响版本:** before 6.6.12, 6.7.0 before 6.12.3, 6.13.0 before 6.13.3, 6.14.0 before 6.14.2

**利用条件:** 需要Confluence Widget Connector宏开启且目标版本存在漏洞。

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2019-3396 存在于 Atlassian Confluence Server 的 Widget Connector 宏中，由于服务端模板注入漏洞，攻击者可以通过构造恶意的 Velocity 模板代码，在 Confluence 服务器上执行任意命令。从提供的POC代码来看, `test.vm` 和 `test2.vm` 文件包含了利用 Velocity 模板引擎执行命令的代码。它们通过 `java.lang.Runtime` 类来执行系统命令，并读取命令执行结果。利用方式是，构造包含恶意Velocity代码的请求发送给Confluence服务器，服务器在渲染包含Widget Connector宏的页面时，会执行恶意代码，从而实现远程代码执行。根据搜索结果,该漏洞被广泛利用, 存在多种PoC和exp.

 **有效性:**  POC代码有效,因为它使用了Velocity模板语言来执行命令.通过getRuntime方法可以执行任意命令。

**投毒风险:** 仓库中主要包含用于漏洞验证和利用的Velocity模板代码，没有发现明显的恶意或后门代码，因此投毒风险较低。

**利用方式:**

1.  **定位漏洞点:** 确定目标Confluence服务器版本在受影响范围内，且启用了Widget Connector宏。
2.  **构造恶意请求:**  构建包含恶意Velocity模板代码的HTTP请求，该代码利用 `java.lang.Runtime` 执行系统命令。
3.  **发送请求:**  将构造好的请求发送给Confluence服务器。攻击者需要找到一个页面或接口，该页面或接口允许通过Widget Connector宏插入并渲染Velocity模板。
4.  **执行命令:** Confluence服务器解析并执行Velocity模板代码，从而在服务器上执行攻击者指定的命令。
5.  **获取结果:**  攻击者可以通过读取命令执行的输出来获取敏感信息，或者执行其他恶意操作。

**项目地址:** [JonathanZhou348/CVE-2019-3396TEST](https://github.com/JonathanZhou348/CVE-2019-3396TEST)

**漏洞详情:** [CVE-2019-3396](https://nvd.nist.gov/vuln/detail/CVE-2019-3396)