## CVE-2019-3396-Atlassian Confluence Widget Connector Server-Side Template Injection

**漏洞编号:** CVE-2019-3396

**漏洞类型:** Server-Side Template Injection (SSTI)

**影响应用:** Atlassian Confluence Server

**危害等级:** 高危，可导致远程代码执行

**影响版本:** before 6.6.12, 6.7.0 before 6.12.3, 6.13.0 before 6.13.3, 6.14.0 before 6.14.2

**利用条件:** 需要Confluence服务器存在Widget Connector宏，并且允许用户插入宏内容

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2019-3396是Atlassian Confluence服务器中Widget Connector宏的一个服务器端模板注入漏洞。攻击者可以通过构造恶意宏内容，实现任意代码执行。 

**有效性：**
根据漏洞库信息、搜索引擎结果和提供的POC代码，可以判断此漏洞的POC是有效的。漏洞库信息明确指出该漏洞允许远程攻击者在Confluence服务器或数据中心实例上实现路径遍历和远程代码执行。搜索引擎结果中也提及了该漏洞被用于传播恶意软件，例如加密货币挖矿程序和Gandcrab勒索软件。提供的Java代码是一个典型的Java内存马，通过ServletRequestListener注入，劫持请求，从而实现RCE。

**投毒风险：**
该POC代码本身就是一个用于植入内存马的恶意代码。投毒风险的评估主要是判断作者是否在内存马本身之外，还加入了其他的恶意行为。在给定的代码片段中，我们可以看到有尝试写入错误信息到`/tmp/success-error-2`的逻辑，如果攻击者能够控制写入的文件路径，那么这将是一个潜在的投毒点。但是总体而言，这段代码的主要功能是内存马注入，额外的恶意行为并不明显。因此，初步判断投毒风险较低。如果代码仓库中有其他编译后的类或者配置文件，可能会包含更多的投毒行为，但是仅凭这段代码，投毒的可能性为10%。

**利用方式：**
1.  **利用入口：** 利用Confluence的Widget Connector宏插入恶意Velocity模板代码。
2.  **SSTI Payload：** 构造包含恶意代码的Velocity模板Payload。常见的Payload用于执行系统命令，例如：`{code}${#req = facotry.getObject().getClass().forName('javax.servlet.http.HttpServletRequest').getMethod('getRuntime',null).invoke(null,null).exec('whoami')}`
3.  **内存马注入 (POC)：**
    *   该POC代码的目的是将一个恶意的ServletRequestListener注册到Confluence的Servlet容器中。
    *   它首先尝试找到Confluence应用使用的ClassLoader，这通常需要遍历线程，找到包含特定名称的线程（如`hz.confluence.scheduled.thread`）。
    *   然后，它利用反射获取StandardContext，这是Servlet容器的核心组件。
    *   接着，它创建一个实现了ServletRequestListener接口的动态代理，并将其实例注册到StandardContext中。
    *   当有新的HTTP请求到达时，代理的invoke方法会被调用，执行`backDoor`方法（在给定的代码片段中未完整给出）。`backDoor`方法很可能会从请求中提取命令并执行，从而实现远程代码执行。

总而言之，该漏洞利用方式是先通过SSTI漏洞注入恶意代码，然后通过植入内存马的方式维持控制。


**项目地址:** [Avento/CVE-2019-3396-Memshell-for-Behinder](https://github.com/Avento/CVE-2019-3396-Memshell-for-Behinder)

**漏洞详情:** [CVE-2019-3396](https://nvd.nist.gov/vuln/detail/CVE-2019-3396)