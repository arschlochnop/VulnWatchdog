## CVE-2024-4577 PHP-CGI 参数注入导致远程代码执行

**漏洞编号:** CVE-2024-4577

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** PHP

**危害等级:** 高危，允许未经身份验证的攻击者在受影响的Windows服务器上执行任意代码

**影响版本:** PHP 8.1.* before 8.1.29, 8.2.* before 8.2.20, 8.3.* before 8.3.8 (Windows, CGI模式)

**利用条件:** Windows服务器，PHP以CGI模式运行，启用了使用 "Best Fit" 策略的代码页。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-4577 是一个影响在Windows上运行的PHP的严重漏洞。当PHP以CGI模式运行时，如果系统配置为使用某些代码页，Windows可能会使用“Best-Fit”行为来替换传递给Win32 API函数的命令行中的字符。PHP CGI模块可能会错误地将这些字符解释为PHP选项，从而允许恶意用户将选项传递给正在运行的PHP二进制文件，从而泄露脚本源代码，在服务器上运行任意PHP代码等。

**利用方式：**

1.  **利用点：** CGI模式下，Windows系统的字符编码转换。
2.  **攻击向量：** 通过构造特殊的URL，利用`?%ADd+allow_url_include%3d1+%ADd+auto_prepend_file%3dphp://input`将恶意PHP代码注入到`php://input`流中。
3.  **漏洞验证：** 通过发送包含`<?php phpinfo();`的POST请求，观察服务器是否返回PHP信息页面。
4.  **远程代码执行：** 上传并执行恶意脚本，例如反向shell或勒索软件。

**投毒风险分析：**

提供的POC代码主要包含以下文件：

*   `README.md`: 漏洞描述和利用步骤。
*   `encoded.ps1`: 用于解码被加密的zip文件，用于解密勒索软件加密的文件。
*   `ransomware.ps1`: 勒索软件脚本，用于加密文件和上传zip文件。

`ransomware.ps1` 脚本尝试将文件压缩为 ZIP 文件，然后将其上传到 `http://192.168.176.130:5000/upload`。如果上传成功，则使用 Base64 对 ZIP 文件进行编码，并保存到 `C:\Users\ahmet\Desktop\battalbelgeler_encoded.txt`。

`encoded.ps1` 脚本从 `C:\Users\ahmet\Desktop\battalbelgeler_encoded.txt` 读取 Base64 编码的数据，对其进行解码，并将解码后的数据写入 `C:\Users\ahmet\Desktop\battalbelgeler_decoded.zip`。

主要风险在于，攻击者可能会在`ransomware.ps1`中隐藏恶意代码，例如：

*   **后门：** 在上传的文件中植入后门，以便后续访问受感染的系统。
*   **数据窃取：** 在上传过程中窃取敏感数据。
*   **反向shell**: 在机器上执行后门代码，获得shell控制权限

虽然这个仓库的主要目的是演示漏洞，但由于涉及到勒索软件的部署和文件的上传，存在一定的风险，**作者可能在脚本中植入了额外的恶意功能**。考虑到`ransomware.ps1`需要上传文件到一个外部地址，并且可能包含一些未知的恶意行为，因此初步评估投毒风险为10%。

**项目地址:** [ahmetramazank/CVE-2024-4577](https://github.com/ahmetramazank/CVE-2024-4577)

**漏洞详情:** [CVE-2024-4577](https://nvd.nist.gov/vuln/detail/CVE-2024-4577)