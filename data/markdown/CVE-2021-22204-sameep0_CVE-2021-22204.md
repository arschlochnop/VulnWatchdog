## CVE-2021-22204-ExifTool-代码执行

**漏洞编号:** CVE-2021-22204

**漏洞类型:** 代码执行

**影响应用:** ExifTool

**危害等级:** 高危，允许攻击者执行任意代码

**影响版本:** >=7.44, <12.24

**利用条件:** 目标系统安装了受影响版本的ExifTool，且允许处理恶意DjVu文件。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-22204 是 ExifTool 中的一个代码执行漏洞，存在于 DjVu 文件格式的处理中。攻击者可以通过构造恶意的 DjVu 文件，利用 ExifTool 在解析文件时执行任意代码。

**有效性：**
提供的 PoC 代码看起来是有效的。它利用了 DjVu 文件的 ANTz 字段中的漏洞，通过 eval 注入执行 Perl 代码。代码首先生成一个包含恶意 Perl 代码的 payload，然后使用 `bzz` 压缩该 payload，并使用 `djvumake` 将其嵌入到 DjVu 文件中。最后，它将该 DjVu 文件提供给 ExifTool 处理，触发漏洞。

**投毒风险：**
PoC 代码本身并未发现明显的恶意行为，例如反弹 shell 到未知主机或植入持久性后门。该代码主要目的是演示漏洞，利用文件操作和进程调用实现指令执行。但是，任何代码都存在潜在风险，因此评估投毒风险时，需要考虑以下几点：
* **来源可靠性：** 虽然该 PoC 来源于 Github，但需要验证作者的信誉和代码的安全性。代码的贡献历史和社区反馈可以提供一些线索。
* **代码审查：** 仔细审查代码逻辑，确认没有隐藏的恶意功能。需要特别关注任何可能执行系统命令、访问网络或修改文件的部分。
* **依赖项：** 确认所有依赖项（如 `djvulibre-bin`, `exiftool`）来自可信的源，并且没有被篡改。

综合考虑，该 PoC 代码的投毒风险较低，估计为 10%。但这并不意味着可以完全信任该代码。在实际使用之前，务必进行彻底的安全审查。

**利用方式：**
1.  **生成Payload:**  首先，脚本会生成一个包含恶意Perl代码的Payload，利用DjVu文件的ANTz字段，实现eval注入。
2.  **压缩Payload:** 使用bzz工具压缩该Payload。
3.  **创建DjVu文件:**  使用djvumake工具将压缩后的Payload嵌入到一个恶意的DjVu文件中。
4.  **触发漏洞:**  将该恶意的DjVu文件提供给存在漏洞的ExifTool版本进行解析，当ExifTool尝试解析DjVu文件中的恶意ANTz字段时，其中的Perl代码会被执行，从而实现任意代码执行。

总而言之，该漏洞利用的有效性高，但使用者仍需注意代码的来源，避免投毒行为。

**项目地址:** [sameep0/CVE-2021-22204](https://github.com/sameep0/CVE-2021-22204)

**漏洞详情:** [CVE-2021-22204](https://nvd.nist.gov/vuln/detail/CVE-2021-22204)