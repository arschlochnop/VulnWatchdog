## CVE-2020-11651-SaltStack-认证绕过和远程代码执行

**漏洞编号:** CVE-2020-11651

**漏洞类型:** 认证绕过/远程代码执行

**影响应用:** SaltStack

**危害等级:** 高危，可导致服务器完全控制

**影响版本:** < 2019.2.4, < 3000.2

**利用条件:** 目标Salt Master服务器的4506端口对外开放且未打补丁

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2020-11651 漏洞存在于 SaltStack Salt 2019.2.4 之前和 3000.2 之前的版本中。Salt-master 进程的 ClearFuncs 类没有正确验证方法调用，允许未经身份验证的远程用户访问某些方法。这些方法可用于从 Salt Master 检索用户令牌和/或在 Salt Minion 上运行任意命令。

**有效性分析：**
根据漏洞库信息和搜索结果，此漏洞被广泛利用，并且存在公开可用的PoC代码。提供的PoC代码 (poc.py) 实现了以下功能：
*   读取Root Key (`-k` 参数)：利用未授权访问漏洞，获取Salt Master的Root Key，为后续利用提供凭据。
*   在所有Minion上执行命令 (`-m` 参数)：允许攻击者在所有连接到Salt Master的Minion上执行任意命令。
*   读取Salt Master服务器上的任意文件 (`-r` 参数)：允许读取Salt Master服务器上的敏感信息，例如配置文件。
*   写入文件到Salt Master服务器 (`-w` 参数)：允许写入任意文件到Salt Master服务器，可以用来植入后门或修改配置文件。

**投毒风险分析：**
分析提供的PoC代码后，可以发现：
*   `poc.py` 主要功能是利用漏洞进行信息收集 (Root Key) 和命令执行。代码本身未发现明显的恶意行为，例如删除文件、上传恶意程序等。
*   `README.md` 和 `LICENSE` 文件都是标准的说明文档，未包含恶意代码。
*   **潜在风险：** 攻击者可能修改 `poc.py` 文件，添加恶意功能，例如在利用成功后，自动下载并执行恶意脚本。因此，使用未经验证的PoC代码存在一定的风险。
综合评估，此仓库中存在作者隐藏的投毒代码的可能性较低，但不能完全排除，风险评估为10%。

**利用方式总结：**
1.  **确定目标：** 找到运行着存在漏洞的SaltStack Master的服务器，通常是4506端口。
2.  **运行PoC：** 使用提供的PoC脚本 (`poc.py`)，可以执行以下操作：
    *   **获取Root Key：** 运行 `python3 poc.py -k <target_ip>` 获取Root Key。
    *   **远程命令执行：** 运行 `python3 poc.py -m -c '<command>' <target_ip>` 在所有Minion上执行命令。 例如, `python3 poc.py -m -c 'id' <target_ip>` 。
    *   **读取文件：** 运行 `python3 poc.py -r '<file_path>' <target_ip>` 读取Salt Master服务器上的文件。 例如, `python3 poc.py -r '/etc/shadow' <target_ip>` 。
    *   **写入文件：** 运行 `python3 poc.py -w '<file_path>' -f '<local_file>' <target_ip>` 写入文件到 Salt Master 服务器.
3.  **控制系统：** 通过远程命令执行或文件读写，最终获取对Salt Master服务器以及所有Minion的控制权。

**项目地址:** [RakhithJK/CVE-2020-11651](https://github.com/RakhithJK/CVE-2020-11651)

**漏洞详情:** [CVE-2020-11651](https://nvd.nist.gov/vuln/detail/CVE-2020-11651)