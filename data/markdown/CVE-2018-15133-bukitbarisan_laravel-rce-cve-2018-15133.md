## CVE-2018-15133 Laravel Framework 反序列化漏洞

**漏洞编号:** CVE-2018-15133

**漏洞类型:** 反序列化漏洞

**影响应用:** Laravel Framework

**危害等级:** 高危，可能导致远程代码执行

**影响版本:** <= 5.5.40 和 5.6.x <= 5.6.29

**利用条件:** 需要知道 APP_KEY，通常不易获取，除非之前已获得权限或成功进行过其他攻击。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2018-15133 存在于 Laravel Framework 直到 5.5.40 和 5.6.x 直到 5.6.29 版本中。由于对 X-XSRF-TOKEN 值进行不可信的反序列化调用，可能导致远程代码执行。涉及到 Illuminate/Encryption/Encrypter.php 中的 decrypt 方法和 phpggc 中 gadgetchains/Laravel/RCE/3/chain.php 。攻击者必须知道应用程序密钥（APP_KEY），这通常不会发生，但如果攻击者之前拥有特权访问权限或成功完成了之前的攻击，则可能会发生。

**利用方式：**

1.  **获取 APP_KEY：** 这是利用此漏洞的关键前提。攻击者需要设法获取 Laravel 应用的 APP_KEY，这可能通过源代码泄露、数据库访问或其他漏洞实现。
2.  **构造恶意 XSRF-TOKEN：** 使用 phpggc 工具生成包含恶意 PHP 对象的序列化字符串。该对象旨在利用 Laravel 框架中的反序列化漏洞执行任意代码。
3.  **加密 Payload：**  使用 APP_KEY 对序列化的 Payload 进行加密，生成有效的 XSRF-TOKEN。代码中的`cve.php`脚本完成了这个步骤，使用APP_KEY对phpggc生成的Payload加密，然后放入Cookie中。
4.  **发送包含恶意 XSRF-TOKEN 的请求：**  将构造的 XSRF-TOKEN 设置为 Cookie，并发送到目标 Laravel 应用。
5.  **触发反序列化：**  当 Laravel 应用尝试解密并反序列化 XSRF-TOKEN 时，恶意对象将被实例化，从而执行攻击者指定的代码。

**POC有效性：**

根据提供的漏洞信息、搜索结果以及漏洞利用代码，此POC有效。存在多个公开的漏洞利用代码，CISA也将此漏洞标记为已知被利用漏洞，增加了POC的有效性。

**投毒风险：**

虽然主利用脚本 `cve.php` 看起来是直接利用漏洞，但仍然存在一些潜在的投毒风险：

*   **依赖外部资源：** `cve.php` 依赖于 `phpggc` 工具，如果 `phpggc` 被篡改，可能会引入恶意代码。风险相对较低，因为 `phpggc` 是一个广泛使用的工具，被篡改的可能性较低。但是仍需确认。
*   **shell_exec函数滥用风险：** `cve.php` 中多次使用了 `shell_exec` 函数，包括执行 `phpggc` 命令和 `curl` 命令。如果攻击者可以控制这些命令的参数，就可能执行任意系统命令。由于 `cve.php` 需要用户提供 APP_KEY 和目标 URL，并且有 payload 参数，存在用户误用的情况，比如直接使用了恶意payload。
*   **README.md文件：**此文件是正常的说明文档，没有发现投毒内容。
*   **phpggc:** 本身作为一个payload生成器，其本身不应该作为投毒风险考虑，而是应该考虑其生成payload的安全性。

考虑到以上因素，评估此仓库的投毒风险为 10%。 风险主要集中在用户误用，或者`phpggc`工具被篡改的可能性。

**项目地址:** [bukitbarisan/laravel-rce-cve-2018-15133](https://github.com/bukitbarisan/laravel-rce-cve-2018-15133)

**漏洞详情:** [CVE-2018-15133](https://nvd.nist.gov/vuln/detail/CVE-2018-15133)