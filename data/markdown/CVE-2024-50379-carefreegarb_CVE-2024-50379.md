## CVE-2024-50379-Apache Tomcat-TOCTOU Race Condition RCE

**漏洞编号:** CVE-2024-50379

**漏洞类型:** TOCTOU Race Condition导致的远程代码执行

**影响应用:** Apache Tomcat

**危害等级:** 高危，可以导致远程代码执行

**影响版本:** 11.0.0-M1 <= version <= 11.0.1, 10.1.0-M1 <= version <= 10.1.33, 9.0.0.M1 <= version <= 9.0.97

**利用条件:** 1. 目标系统为大小写不敏感的文件系统。
2. Tomcat的default servlet的readonly参数设置为false（非默认配置，允许写入）。
3. 存在网络访问Tomcat服务器的权限。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-50379是Apache Tomcat中的一个Time-of-Check Time-of-Use (TOCTOU)竞争条件漏洞。当满足以下条件时，攻击者可以利用此漏洞在服务器上执行任意代码：

*   **环境要求:** 目标系统使用大小写不敏感的文件系统，并且default servlet的`readonly`参数设置为`false`。
*   **漏洞原理:** 在JSP编译期间，Tomcat存在一个竞争条件。攻击者可以在Tomcat检查文件是否存在和可写之后，但在实际编译之前，替换JSP文件。通过精心构造JSP文件，攻击者可以上传恶意代码，并在服务器上执行。
*   **利用方式:**  提供的POC代码是一个Go程序，它利用多线程并发上传恶意JSP文件，从而触发竞争条件。该POC接受目标URL、包含恶意代码的JSP文件路径以及目标服务器上保存的文件名/路径作为参数。
*   **有效性:** 根据搜索结果和POC代码，该漏洞利用是有效的，可以实现远程代码执行。
*   **投毒风险评估:** 提供的代码中存在一定的投毒风险。虽然主要功能是实现漏洞利用，但作者可能在代码中添加一些不明显的后门或者恶意行为。代码中包含`replace github.com/valyala/fasthttp v1.58.0 => ./fasthttp`。使用本地修改过的 `fasthttp` 库存在潜在风险，恶意作者可能在修改后的库中植入后门。因此，对于此类来源不明的代码，需要进行代码审计，才能确保其安全性。综合考虑，存在10%的投毒风险。

**项目地址:** [carefreegarb/CVE-2024-50379](https://github.com/carefreegarb/CVE-2024-50379)

**漏洞详情:** [CVE-2024-50379](https://nvd.nist.gov/vuln/detail/CVE-2024-50379)