## CVE-2021-3156 (Sudo Baron Samedit)

**漏洞编号:** CVE-2021-3156

**漏洞类型:** 堆缓冲区溢出

**影响应用:** Sudo

**危害等级:** 高危，任何本地用户都可利用此漏洞提升权限至root

**影响版本:** < 1.9.5p2

**利用条件:** 本地用户能够执行sudo命令

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-3156，又名Baron Samedit，是Sudo 1.9.5p2之前版本中的一个堆缓冲区溢出漏洞。该漏洞出现在sudo解析命令行参数的过程中。通过精心构造以单个反斜杠字符结尾的命令行参数，攻击者可以触发off-by-one错误，导致堆缓冲区溢出，最终允许任何本地用户将权限提升到root。

**有效性分析：**

*   根据漏洞库信息和搜索结果，此漏洞已被广泛证实存在，并有公开可用的利用代码。
*   提供的漏洞利用代码库包含多个针对不同glibc版本和Sudo配置的利用脚本，表明该漏洞具有较高的利用成功率。
*   搜索结果中的链接(如Qualys博客、NVD、NCC Group博客等)也证实了该漏洞的存在和危害。

**投毒风险分析：**

*   漏洞利用代码库包含LICENSE文件，表明作者声明了版权，并使用了较为宽松的BSD许可，这在一定程度上降低了作者故意投毒的可能性。
*   代码库包含多个利用脚本，针对不同的系统和sudo配置，代码量相对较大，人工审计难度较高。但从代码注释和说明文档来看，作者提供了较为清晰的漏洞利用思路。
*   `exploit_timestamp_race.c` 利用了竞争条件，可能存在不稳定性，也可能被恶意利用，但不能直接判定为恶意投毒。
*   `exploit_userspec.py` 直接修改`/etc/passwd`文件来提权，如果被篡改加入恶意用户，则存在一定的风险。
*  总体而言，代码库的投毒风险较低，约为10%，主要集中在代码复杂性带来的潜在风险和对`/etc/passwd`文件的修改上，建议在使用前进行详细的代码审计。

**利用方式：**

1.  漏洞利用始于一个off-by-one错误，发生在sudo在解析命令行参数时，特别是当参数以单个反斜杠结尾时。
2.  这个错误会导致堆缓冲区溢出。
3.  攻击者通过精心构造的参数，覆盖相邻的堆内存。
4.  根据不同的利用脚本，攻击者可以通过覆盖`defaults`结构体、`userspec`结构体或`service_user`结构体来达到提权的目的。
5.  更具体地说，一些脚本覆盖`defaults`结构体来修改mailer的路径，指向攻击者可控的恶意程序，从而以root权限执行该恶意程序。另一些脚本则覆盖`userspec`结构体来绕过认证，并在`/etc/passwd`文件中添加一个具有root权限的新用户。
6.  最后，`exploit_timestamp_race.c`通过竞争条件修改`/etc/passwd`文件。

**项目地址:** [duongdz96/CVE-2021-3156-main](https://github.com/duongdz96/CVE-2021-3156-main)

**漏洞详情:** [CVE-2021-3156](https://nvd.nist.gov/vuln/detail/CVE-2021-3156)