## CVE-2015-1328 - Overlayfs 本地提权

**漏洞编号:** CVE-2015-1328

**漏洞类型:** 本地提权

**影响应用:** Linux Kernel (Overlayfs)

**危害等级:** 高危，本地用户可提升至root权限

**影响版本:** Ubuntu Linux kernel package before 3.19.0-21.21 (Ubuntu through 15.04)

**利用条件:** 需要本地用户权限，Overlayfs 必须被允许在任意mount namespace使用

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

该漏洞存在于Linux内核的Overlayfs实现中，由于文件创建时的权限检查不当，允许本地用户通过利用Overlayfs挂载在任意mount namespace中的配置来获得root权限。

**有效性:**

提供的POC代码利用了CVE-2015-1328漏洞，该漏洞允许本地用户通过不正确的权限检查在overlayfs文件系统中获得root权限。POC代码首先创建一个新的用户命名空间，然后在该命名空间中执行一系列操作，包括挂载overlayfs文件系统，修改/etc/ld.so.preload文件，并最终使用`su`命令来提升权限。该漏洞利用代码在受影响的Ubuntu版本上是有效的，因为这些版本中的内核存在此漏洞。

**投毒风险:**

仔细检查提供的POC代码后，没有发现明显的投毒代码。代码的目的是利用Overlayfs漏洞来提升权限。虽然代码确实创建和修改了文件系统上的文件（例如`/etc/ld.so.preload`），但这完全是为了利用该漏洞，而不是执行任何恶意或隐藏的操作。因此，投毒风险评估为0%。

**利用方式:**

1.  **创建Namespace:** 使用`unshare(CLONE_NEWUSER)`创建一个新的用户命名空间。这是利用此漏洞的先决条件。
2.  **创建目录:** 创建利用过程中需要的目录结构：`/tmp/ns_sploit/work`、`/tmp/ns_sploit/upper`和`/tmp/ns_sploit/o`。
3.  **第一次挂载:** 挂载overlayfs文件系统，将`/proc/sys/kernel`（或者`/sys/kernel/security/apparmor`，取决于内核支持的功能）作为lowerdir，`/tmp/ns_sploit/upper`作为upperdir，`/tmp/ns_sploit/o`作为挂载点。这里利用了权限检查不当，将`ns_last_pid` (或 `.access`)重命名为 `ld.so.preload`。
4.  **卸载:** 卸载之前创建的overlayfs文件系统。
5.  **第二次挂载:** 再次挂载overlayfs，但这次将`/tmp/ns_sploit/upper`作为lowerdir，`/etc`作为upperdir，`/tmp/ns_sploit/o`作为挂载点。  这样就可以修改`/etc`目录下的文件。
6.  **修改`/etc/ld.so.preload`:** 在`/etc/ld.so.preload`文件中写入一个共享库的路径（`/tmp/ofs-lib.so`）。`ld.so.preload`是一个包含共享库列表的文件，这些共享库会在其他共享库之前加载。
7.  **创建共享库:**  创建一个恶意共享库(`/tmp/ofs-lib.so`)，该共享库中的`getuid`函数被hook，当调用`/bin/su`时，会调用`setresuid(0, 0, 0)`和`setresgid(0, 0, 0)`，从而提升权限到root，然后执行`/bin/sh`。
8.  **执行`/bin/su`:**  执行`/bin/su`命令。由于`/etc/ld.so.preload`的存在，恶意共享库会被加载，`getuid`函数被hook，从而获得root权限。

**项目地址:** [YastrebX/CVE-2015-1328](https://github.com/YastrebX/CVE-2015-1328)

**漏洞详情:** [CVE-2015-1328](https://nvd.nist.gov/vuln/detail/CVE-2015-1328)