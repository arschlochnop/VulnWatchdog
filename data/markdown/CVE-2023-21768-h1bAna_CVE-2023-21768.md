## CVE-2023-21768 Windows Ancillary Function Driver for WinSock Elevation of Privilege Vulnerability

**漏洞编号:** CVE-2023-21768

**漏洞类型:** 权限提升

**影响应用:** Windows Ancillary Function Driver (afd.sys)

**危害等级:** 高危，可导致本地权限提升

**影响版本:** Windows Server 2022 (versionStartIncluding: 10.0.20348.0, versionEndExcluding: 10.0.20348.1487), Windows 11 21H2 (versionStartIncluding: 10.0.0, versionEndExcluding: 10.0.22000.1455), Windows 11 22H2 (versionStartIncluding: 10.0.22621.0, versionEndExcluding: 10.0.22621.1105)

**利用条件:** 需要本地访问权限

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2023-21768 是 Windows Ancillary Function Driver for WinSock (afd.sys) 中的一个权限提升漏洞。根据漏洞信息和搜索结果，攻击者可以利用此漏洞在受影响的系统上获得更高的权限。漏洞的根本原因是 afd.sys 中的 `AfdNotifyRemoveIoCompletion` 函数在写入内存之前缺少对用户提供的指针的验证。利用方式如下：

1.  攻击者通过 `DeviceIoControl` 函数，使用 `IOCTL_AFD_NOTIFY_SOCK` 控制代码与 `afd.sys` 驱动程序交互。
2.  `AfdDispatchDeviceControl` 函数根据控制代码在 `AfdIoctlTable` 中查找相应的处理函数，即 `AfdNotifySock`。
3.  `AfdNotifySock` 函数调用 `AfdNotifyRemoveIoCompletion` 函数。
4.  在易受攻击的版本中，`AfdNotifyRemoveIoCompletion` 函数会将 `var_304` 的值写入到 `arg3_1->field_18` 指向的内核内存地址，而没有进行适当的验证，从而导致任意内核写入。
5.  攻击者可以精心构造 `arg3_1->field_18` 指向的地址，从而实现权限提升。

**有效性：**
提供的漏洞利用代码（readme.md）描述了漏洞原理、补丁差异分析，并提供了利用该漏洞的概念验证代码。搜索结果中[webpage 7 begin] [title] Malwareman007/CVE-2023-21768 [description] Complete exploit works on vulnerable Windows 11 22H2 systems.表明存在可用的完整漏洞利用代码。

**投毒风险：**
尽管提供了漏洞利用的详细信息，但是由于缺少实际的可执行代码，并且readme中的代码不完整，因此无法准确评估投毒风险。考虑到攻击者可能利用该漏洞进行恶意活动，存在一定的投毒风险，根据以往经验，以及代码的不完整性，主观评估投毒风险为10%。


**项目地址:** [h1bAna/CVE-2023-21768](https://github.com/h1bAna/CVE-2023-21768)

**漏洞详情:** [CVE-2023-21768](https://nvd.nist.gov/vuln/detail/CVE-2023-21768)