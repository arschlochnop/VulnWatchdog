## CVE-2021-23017-Nginx Resolver 内存覆盖

**漏洞编号:** CVE-2021-23017

**漏洞类型:** 内存覆盖

**影响应用:** Nginx

**危害等级:** 高危，可能导致worker进程崩溃或潜在的其他影响

**影响版本:** Nginx Web Server versions 0.6.18 thru 1.20.0 before 1.20.1, Nginx plus versions R13 thru R23 before R23 P1. Nginx plus version R24 before R24 P1

**利用条件:** 目标服务器开启resolver并且允许DNS请求

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2021-23017是Nginx resolver模块中的一个安全问题，允许攻击者通过伪造来自DNS服务器的UDP数据包，导致1字节的内存覆盖，可能导致worker进程崩溃或其他潜在影响。

**有效性：**
提供的PoC代码尝试利用此漏洞。它通过监听目标服务器的DNS请求，然后构造恶意的DNS响应数据包，包含内存覆盖的payload，并将其发送给目标服务器。如果目标服务器正在使用受影响版本的Nginx，并且resolver配置不当，则此PoC可能有效。

**投毒风险：**
PoC代码的分析表明，该代码主要用于漏洞验证和概念验证。虽然代码中包含ARP欺骗部分，用于劫持目标流量，但代码本身并**没有发现**明显的后门或恶意行为，也没有发现与外部C&C服务器通信的行为。

**利用方式：**
1.  **环境准备：** 攻击者需要能够监听到目标Nginx服务器发送的DNS请求，或者通过ARP欺骗等手段劫持DNS流量。
2.  **DNS请求监听：** PoC代码通过`sniff`函数监听目标服务器发出的DNS请求。
3.  **恶意DNS响应构造：** 当监听到目标服务器的DNS请求后，PoC代码会构造一个恶意的DNS响应包。关键部分在于`payload`的构造，它会在响应中插入精心设计的payload，目的是覆盖目标服务器内存中的某个字节。
4.  **发送恶意响应：** PoC代码使用`sendp`函数将构造好的恶意DNS响应包发送给目标服务器。由于是伪造的DNS响应，其源IP地址和端口伪造成合法的DNS服务器。
5.  **触发漏洞：** 如果构造的payload成功覆盖了目标服务器内存中的关键数据，则可能导致worker进程崩溃或其他攻击效果。

**PoC分析补充说明：**
* `device_setup()`函数尝试启用IP转发并阻止转发到53端口的UDP数据包。这可能是为了方便测试，但实际利用中可能不需要。
* `ARPP()`函数进行ARP欺骗，将目标服务器和DNS服务器的MAC地址指向攻击者，从而劫持流量。这部分是攻击成功的关键。需要注意的是ARP欺骗可能在某些网络环境下无效，或者容易被检测。
* `process_received_packet()`是核心函数，负责处理接收到的DNS请求并构造恶意响应。`null_pointer_index`变量的计算用于定位DNS请求中的域名结束位置，并在此之后插入恶意数据。
* `payload`的构造是利用成功的关键，需要根据目标Nginx服务器的具体环境和内存布局进行调整。

**项目地址:** [ShivamDey/CVE-2021-23017](https://github.com/ShivamDey/CVE-2021-23017)

**漏洞详情:** [CVE-2021-23017](https://nvd.nist.gov/vuln/detail/CVE-2021-23017)