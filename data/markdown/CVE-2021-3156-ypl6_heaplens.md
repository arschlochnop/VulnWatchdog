## CVE-2021-3156 - Sudo Heap-Based Buffer Overflow (Baron Samedit)

**漏洞编号:** CVE-2021-3156

**漏洞类型:** 堆缓冲区溢出

**影响应用:** Sudo

**危害等级:** 高危，可导致权限提升至 root

**影响版本:** < 1.9.5p2

**利用条件:** 本地用户能够执行 sudo

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-3156 (Baron Samedit) 是 Sudo 1.9.5p2 之前版本中存在的一个堆缓冲区溢出漏洞。该漏洞位于 `sudoers` 组件中，当 `sudo` 解析命令行参数时，存在一个 off-by-one 错误。通过 `sudoedit -s` 命令和以单个反斜杠字符结尾的命令行参数，任何本地用户都可以利用此漏洞将权限提升至 root。

**有效性：**
根据漏洞信息、搜索结果和提供的漏洞利用代码，该漏洞的 POC 代码是有效的。 搜索结果中多个链接（例如，Qualys 博客、NCC Group 博客、Red Hat 页面）确认了该漏洞的存在和可利用性。 提供的 `README.md` 文件包含一个测试命令，`sudoedit -s /`，表明 `sudo` 易受攻击。此外, `heaplens` 工具用于辅助漏洞分析与利用，也间接证明了漏洞的可行性。

**投毒风险：**
该代码库的主要功能是提供一个名为 `heaplens` 的 GDB 插件，用于分析和调试堆内存分配。这个插件本身并没有明显的恶意代码，它的目的是为了辅助安全研究人员进行漏洞分析。 仓库中可能存在的风险在于，如果该插件被恶意修改，可能会在调试过程中泄露敏感信息或者执行恶意操作，但从代码本身来看，直接的投毒风险较低。 评估的投毒风险为10%。

**利用方式：**
1.  **触发漏洞：** 利用 `sudoedit -s` 命令，并提供一个以单个反斜杠字符结尾的特殊构造的命令行参数。 这会触发 `sudo` 程序中的 off-by-one 错误，导致堆缓冲区溢出。
2.  **溢出利用：** 成功触发溢出后，覆盖堆上的数据结构，通常会覆盖函数指针或者其他关键数据，进而控制程序的执行流程。
3.  **权限提升：** 通过控制程序流程，攻击者可以执行任意代码，从而将当前用户的权限提升至 root。 一种常见的利用方式是修改 `sudoers` 策略，允许当前用户执行任意命令而无需密码。
4.  **具体利用流程:** 根据 `heaplens`  工具的描述，它通过hook `malloc`, `realloc`, `calloc`, `free` 函数，来记录内存分配情况，方便逆向工程人员调试和分析。给出的例子，使用了 `-b` 参数设置断点，从而在调试的时候，可以中断程序的执行，方便分析。

总而言之，利用方式是利用 `sudoedit -s` 命令的特殊参数，触发堆溢出，覆盖关键数据，最终获得 root 权限。

**项目地址:** [ypl6/heaplens](https://github.com/ypl6/heaplens)

**漏洞详情:** [CVE-2021-3156](https://nvd.nist.gov/vuln/detail/CVE-2021-3156)