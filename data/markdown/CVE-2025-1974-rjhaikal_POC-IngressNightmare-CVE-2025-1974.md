## CVE-2025-1974 Ingress-nginx 远程代码执行漏洞

**漏洞编号:** CVE-2025-1974

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** ingress-nginx

**危害等级:** 高危，可导致集群范围内的密钥泄露和完全控制

**影响版本:** <= 1.11.4, 1.12.0

**利用条件:** 需要能够访问Pod网络，且目标集群部署了受影响版本的ingress-nginx，并启用了Validating Admission Controller功能。

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2025-1974 漏洞是 Kubernetes ingress-nginx 中的一个严重安全问题，攻击者通过在 Ingress 对象的 annotations 中注入恶意配置，利用 Validating Admission Controller 的缺陷，可以在 ingress-nginx 控制器的上下文中执行任意代码。

**有效性：**

根据漏洞信息、搜索结果和提供的PoC代码，可以判断该漏洞利用是有效的。

*   漏洞库信息明确指出该漏洞允许未经身份验证的攻击者在满足特定条件下执行任意代码。
*   搜索结果中多个链接都将 CVE-2025-1974 描述为 critical 的远程代码执行漏洞，并给出了相关的缓解措施。
*   PoC代码提供了一个完整的利用链，包括编译shellcode、修改Ingress对象annotations，以及上传shellcode到目标 Pod。

**投毒风险：**

该仓库存在一定的投毒风险,虽然整体代码意图是为了验证漏洞，但也存在潜在的风险。

*   **Build脚本中的镜像源替换：**`build.sh`脚本将Alpine的默认镜像源替换为`mirrors.ustc.edu.cn`。虽然这通常是为了加速国内的构建过程，但如果镜像源被恶意篡改，可能引入恶意软件。但是这个镜像源为中科大的镜像源，风险较低。
*   **Shellcode上传的隐藏后门:** exploit.py通过upload函数持续向ingress-nginx-controller发送shellcode，并通过FakeIterator类中的asyncio.sleep函数维持连接。在真实利用场景中，攻击者可能会利用这个连接维持后门，或者植入更隐蔽的恶意代码。
*   **PoC的依赖风险：** PoC依赖 httpx 库。如果 httpx 库本身存在漏洞，或者恶意攻击者上传了同名的恶意库，那么在运行PoC时可能会受到攻击。
    
综合考虑，投毒风险较低，大约为5%。主要是镜像源和库的潜在风险。如果使用者对代码进行审查，可大幅降低投毒风险。

**利用方式：**

该漏洞的利用方式如下：

1.  **准备 shellcode：** 攻击者需要首先编译一个 shellcode，该 shellcode 用于在目标系统上执行恶意操作。PoC 代码提供了 `shell.c` 文件，用于生成 shellcode。
2.  **构造恶意 Ingress 对象：** 攻击者创建一个恶意的 Ingress 对象，并在其 annotations 中注入恶意配置。具体来说，攻击者会修改 `nginx.ingress.kubernetes.io/auth-url` annotation，使其包含指向 `/proc/{pid}/fd/{fd}` 的路径，从而触发文件包含漏洞。
3.  **触发 Validating Admission Controller：** 当攻击者尝试创建或更新包含恶意配置的 Ingress 对象时，Validating Admission Controller 会对其进行验证。
4.  **利用文件包含漏洞执行 shellcode：** 由于 Ingress 对象的 annotations 中包含了恶意配置，当 nginx-ingress-controller 加载该 Ingress 对象时，会触发文件包含漏洞，从而执行攻击者上传的 shellcode。
5.  **上传 Shellcode:** 攻击者同时会向 `ingress-nginx-controller` 的一个虚假地址 (`/fake/addr`) 发送 shellcode，通过遍历进程ID和文件描述符，尝试将 shellcode 写入到 nginx 的配置文件中，实现代码执行。

总结来说，攻击者通过精心构造的 Ingress 对象，结合文件包含漏洞，最终在 ingress-nginx 控制器的上下文中执行任意代码，从而控制整个 Kubernetes 集群。

**项目地址:** [rjhaikal/POC-IngressNightmare-CVE-2025-1974](https://github.com/rjhaikal/POC-IngressNightmare-CVE-2025-1974)

**漏洞详情:** [CVE-2025-1974](https://nvd.nist.gov/vuln/detail/CVE-2025-1974)