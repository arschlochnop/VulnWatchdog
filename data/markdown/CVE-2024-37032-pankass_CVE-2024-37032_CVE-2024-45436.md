## CVE-2024-37032 Ollama 路径遍历导致RCE

**漏洞编号:** CVE-2024-37032

**漏洞类型:** 路径遍历/远程代码执行

**影响应用:** Ollama

**危害等级:** 高危，可导致远程代码执行

**影响版本:** < 0.1.34

**利用条件:** 需要Ollama服务运行且攻击者能够发送HTTP请求到Ollama服务器

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

该漏洞存在于Ollama 0.1.34之前的版本中。由于Ollama没有充分验证模型路径中的摘要格式（sha256哈希值，应为64位十六进制数字），攻击者可以利用路径遍历漏洞，通过构造恶意的模型路径，上传包含恶意payload的zip文件到服务器的任意位置。该POC通过以下步骤实现RCE：

1.  **生成恶意动态链接库（hook.so）：**  使用gcc编译包含反弹shell命令的C代码，生成一个动态链接库文件。这段C代码使用`__attribute__((constructor))`来确保在库加载时执行。它会删除`/etc/ld.so.preload`和`/tmp/hook.so`，然后执行攻击者提供的反弹shell命令。
2.  **生成恶意ZIP文件（evil.zip）：**  创建一个ZIP文件，其中包含两个文件：
    *   `/etc/ld.so.preload`：包含`/tmp/hook.so`，用于预加载恶意动态链接库。
    *   `/tmp/hook.so`：包含编译后的恶意动态链接库。
    ZIP文件中的路径使用了`../../../../../../../../..`来进行路径遍历，目的是覆盖系统中的`/etc/ld.so.preload`文件，并将恶意的hook.so文件放置到`/tmp`目录下。
3.  **上传恶意BLOB：**  计算evil.zip文件的SHA256哈希值，并使用该哈希值作为文件名，将evil.zip文件上传到Ollama服务器的`/api/blobs`端点。
4.  **创建模型：**  使用之前上传的BLOB的哈希值，通过构造一个包含`FROM /root/.ollama/models/blobs/{blob_sha256}`的modelfile，向`/api/create`端点发送POST请求，创建一个新的模型。
5.  **触发执行：**  通过向`/api/embeddings`发送POST请求，并设置`model`为`all-minilm:22m`（或其他模型），触发Ollama加载该模型。由于`/etc/ld.so.preload`已被修改，系统在加载任何新的动态链接库时都会先加载`/tmp/hook.so`，从而执行恶意代码，反弹shell。

**投毒风险分析：**
代码功能明确，主要用于利用漏洞，没有发现额外的恶意行为，因此投毒风险评估为0%。

**项目地址:** [pankass/CVE-2024-37032_CVE-2024-45436](https://github.com/pankass/CVE-2024-37032_CVE-2024-45436)

**漏洞详情:** [CVE-2024-37032](https://nvd.nist.gov/vuln/detail/CVE-2024-37032)