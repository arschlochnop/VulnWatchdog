## CVE-2021-3560 - polkit 权限提升

**漏洞编号:** CVE-2021-3560

**漏洞类型:** 权限提升

**影响应用:** polkit

**危害等级:** 高危，可能导致本地用户获取root权限，造成数据泄露、完整性破坏和系统不可用

**影响版本:** polkit 0.113 及以后版本，部分Linux发行版（如RHEL 8, Ubuntu 20.04）

**利用条件:** 需要本地用户权限，目标系统运行存在漏洞的polkit版本，并且使用systemd和dbus

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-3560 漏洞允许未经授权的本地用户通过欺骗 polkit 绕过 D-Bus 请求的凭据检查，从而将请求者的权限提升到 root 用户。利用方式主要包括以下步骤：

1.  攻击者发送一个创建新用户或修改用户属性（例如，添加sudo权限）的D-Bus消息给 accounts-daemon。
2.  在 polkit 处理该消息之前，攻击者立即终止（kill）该 D-Bus 消息，销毁其唯一的 message ID。
3.  polkit 尝试从 dbus-daemon 获取发送消息的用户 ID，但由于 message ID 已被删除，dbus-daemon 返回错误。
4.  polkit 错误地将用户 ID 视为 0 (root 用户)，导致请求被以 root 权限执行。

**有效性：**

提供的 POC 代码描述了利用此漏洞的方法，通过手动发送 D-Bus 消息并在 polkit 验证之前终止消息，可以实现权限提升。漏洞库信息和搜索结果也证实了该漏洞的存在和利用方式，表明提供的 POC 代码具有有效性。

**投毒风险：**

虽然提供的 `README.md` 文件本身看起来是无害的，用于解释漏洞和提供利用示例，但是存在作者在其他地方（例如，在实际的攻击脚本中，如果存在）包含恶意代码的可能性。因为仅仅是一个描述文件，直接包含恶意代码可能性较低，但不能完全排除。因此，投毒风险评估为10%。如果存在配套的攻击脚本，则需要进一步审查，提高投毒风险评估。

**利用方式：**

该漏洞的利用方式是基于竞争条件，攻击者需要精确地控制 D-Bus 消息的发送和终止时机，才能成功欺骗 polkit。具体步骤如下：

1.  使用 `dbus-send` 命令构造一个需要 root 权限的操作请求（例如，创建新用户）。
2.  使用 `time` 命令测量该请求执行所需的时间。
3.  同时发送该请求和终止该请求的命令，并根据步骤2中测量的时间调整终止命令的延迟，以确保在 polkit 验证之前终止消息。
4.  如果利用成功，该操作将以 root 权限执行，从而实现权限提升。

**项目地址:** [LucasPDiniz/CVE-2021-3560](https://github.com/LucasPDiniz/CVE-2021-3560)

**漏洞详情:** [CVE-2021-3560](https://nvd.nist.gov/vuln/detail/CVE-2021-3560)