## CVE-2021-34527 PrintNightmare

**漏洞编号:** CVE-2021-34527

**漏洞类型:** 远程代码执行

**影响应用:** Windows Print Spooler

**危害等级:** 高危，允许攻击者以SYSTEM权限执行任意代码

**影响版本:** 受影响的Windows版本众多，详见漏洞库信息

**利用条件:** 需要网络可达，目标系统运行Print Spooler服务

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-34527（PrintNightmare）是Windows Print Spooler服务中的一个远程代码执行漏洞。根据漏洞库信息和搜索结果，该漏洞允许经过身份验证的攻击者通过不正确的文件操作，以SYSTEM权限在目标系统上执行任意代码。攻击者可以利用该漏洞安装程序、查看、更改或删除数据，或创建具有完全用户权限的新帐户。

**有效性：**
提供的POC代码实际上是缓解脚本，而非漏洞利用代码。这些PowerShell脚本通过修改`%windir%\System32\spool\drivers`目录的ACL，来阻止SYSTEM账户对该目录进行写入操作，从而缓解PrintNightmare漏洞。脚本`CVE-2021-34527_ACL_Mitigation.ps1`添加ACL规则，拒绝SYSTEM用户对该目录进行写入操作，而`CVE-2021-34527_ACL_Mitigation_Rollback.ps1`则移除这些ACL规则。

**投毒风险：**
虽然提供的脚本本身用于缓解漏洞，但仍存在一定的投毒风险。攻击者可能修改这些脚本，例如：
*   **添加恶意代码：** 在缓解脚本中插入额外的命令，在修改ACL的同时执行恶意操作，例如下载和执行恶意软件。
*   **创建后门：** 通过精心设计的ACL规则，允许特定账户（例如攻击者控制的账户）对`drivers`目录进行写入操作，从而创建一个后门。
鉴于以上风险，判断投毒风险为10%，主要风险在于脚本被篡改。

**利用方式：**
真正的漏洞利用方式（未提供具体exp，根据分析）涉及到滥用`AddPrinterDriverEx`函数，允许低权限用户加载任意驱动程序。攻击者可以上传包含恶意代码的驱动程序，并利用Print Spooler服务以SYSTEM权限加载该驱动，从而实现远程代码执行。ACL缓解脚本通过限制SYSTEM账户对`drivers`目录的写入权限，阻止了恶意驱动程序的上传和加载。


**项目地址:** [WidespreadPandemic/CVE-2021-34527_ACL_mitigation](https://github.com/WidespreadPandemic/CVE-2021-34527_ACL_mitigation)

**漏洞详情:** [CVE-2021-34527](https://nvd.nist.gov/vuln/detail/CVE-2021-34527)