## CVE-2022-44268-ImageMagick-任意文件读取

**漏洞编号:** CVE-2022-44268

**漏洞类型:** 任意文件读取

**影响应用:** ImageMagick

**危害等级:** 高危，可能导致敏感信息泄露

**影响版本:** <= 7.1.0-49

**利用条件:** 需要目标系统使用存在漏洞的ImageMagick版本，并允许上传图片文件且使用ImageMagick处理该图片

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2022-44268 是 ImageMagick 中的一个任意文件读取漏洞。当 ImageMagick 解析 PNG 图像（例如，为了调整大小）时，生成的图像可能会嵌入任意文件的内容（如果 magick 二进制文件具有读取该文件的权限）。

**有效性：**
根据漏洞库信息和搜索引擎结果，以及提供的PoC代码，该漏洞是有效的，并且存在公开的PoC。

**投毒风险：**
提供的PoC代码主要包含一个shell脚本 `auto-cve-2022-44268.sh`。该脚本的目的是自动化漏洞利用过程，它首先使用 `pngcrush` 将目标文件的内容嵌入到 PNG 图像的 "profile" EXIF 字段中，然后上传到存在漏洞的服务器，服务器处理后，下载处理后的图片，使用 `exiftool` 提取嵌入的文件内容，并将十六进制数据转换为 ASCII 文本。

代码中可能存在的投毒风险点很小，主要集中在使用 `pngcrush`, `exiftool`, `xxd` 命令，以及脚本的逻辑是否存在恶意修改。风险如下:
1.  **对下载链接的替换**：脚本通过 `wget` 命令下载其他资源。如果 `wget` 下载的链接被替换为包含恶意代码的脚本，则可能存在投毒风险。
2. **脚本本身被篡改**:  如果脚本本身被篡改，例如加入反弹shell或者恶意文件操作等。

总体来说，直接的、明显的恶意代码注入风险较低，风险比例约为 5%。 这个比例主要考虑了脚本中可能存在的细微的安全隐患以及依赖的外部命令潜在风险。

**利用方式：**
1.  **准备恶意PNG图像：** 使用 PoC 脚本（`auto-cve-2022-44268.sh`）和一个原始 PNG 图像（例如，`flag.png`），以及要读取的目标文件（例如，`/etc/passwd`）。脚本会将目标文件的内容嵌入到 PNG 图像的 “profile” EXIF 字段中。
2.  **上传恶意PNG图像：** 将生成的恶意 PNG 图像（`backdoored.png`）上传到运行存在漏洞的 ImageMagick 版本的服务器。
3.  **触发图像处理：** 触发服务器使用 ImageMagick 处理上传的图像。这可能涉及调整图像大小、转换格式或其他图像处理操作。
4.  **下载处理后的图像：** 下载服务器处理后的图像（假设名为 `final.png`）。
5.  **提取文件内容：** 使用 `exiftool` 从下载的图像中提取 “Raw Profile Type” 字段，该字段包含目标文件的十六进制编码内容。
6.  **解码文件内容：** 使用 `xxd` 或类似的工具将十六进制编码的内容解码为 ASCII 文本，从而获取目标文件的内容。

通过这种方式，攻击者可以读取服务器上的任意文件，前提是 ImageMagick 进程具有读取这些文件的权限。

**项目地址:** [narekkay/auto-cve-2022-44268.sh](https://github.com/narekkay/auto-cve-2022-44268.sh)

**漏洞详情:** [CVE-2022-44268](https://nvd.nist.gov/vuln/detail/CVE-2022-44268)