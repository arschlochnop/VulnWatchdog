## CVE-2023-38646-Metabase-RCE

**漏洞编号:** CVE-2023-38646

**漏洞类型:** 远程代码执行

**影响应用:** Metabase

**危害等级:** 高危，未经授权的远程代码执行

**影响版本:** Metabase open source < 0.46.6.1 和 Metabase Enterprise < 1.46.6.1

**利用条件:** 目标系统运行存在漏洞的Metabase版本，且攻击者可以访问Metabase服务。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2023-38646 允许未经身份验证的攻击者在 Metabase 服务器上执行任意命令，权限与服务器相同。漏洞存在于 Metabase 的设置流程中，攻击者可以利用 H2 数据库的特性，通过构造恶意的数据库连接字符串来执行任意代码。

**有效性：**
提供的POC代码是有效的。它通过以下步骤利用漏洞：
1.  获取 setup-token, 用于后续的利用。
2.  构造包含恶意 H2 数据库连接字符串的 POST 请求，发送到 /api/setup/validate 接口。该字符串包含一个 SQL 触发器，该触发器在访问 INFORMATION_SCHEMA.TABLES 时执行任意的 base64 编码的命令。
3.  执行的命令是反弹shell，将目标服务器的 shell 重定向到攻击者的 IP 地址和端口。

**投毒风险：**
仓库中可能存在投毒代码的风险较低，大约为 10%。主要风险来自于：
1.  `add_padding`函数：这个函数看似是为了消除 base64 编码后的等号，但恶意攻击者可能通过修改此函数来插入恶意代码，虽然当前的目的是为了绕过某些过滤机制，但存在被滥用的风险，通过修改payload构造过程植入恶意代码。
2.  反弹 Shell 的IP和端口是用户指定的，这意味着攻击者无法通过直接修改代码来植入后门。

**利用方式：**
1.  **漏洞定位：** 漏洞存在于Metabase的安装设置阶段，具体位于`api/setup/validate`接口。
2.  **获取Token：** 通过访问`/api/session/properties`获取`setup-token`，这是利用漏洞的前提。
3.  **构造Payload：**  核心在于构造恶意的H2数据库连接字符串。该字符串包含以下关键部分：
    *   `zip:/app/metabase.jar!/sample-database.db`：指定数据库文件的位置。
    *   `MODE=MSSQLServer`：设置数据库模式为MSSQLServer，这是触发漏洞的必要条件。
    *   `TRACE_LEVEL_SYSTEM_OUT=1`：启用系统输出跟踪。
    *   `CREATE TRIGGER pwnshell BEFORE SELECT ON INFORMATION_SCHEMA.TABLES AS $$//javascript\njava.lang.Runtime.getRuntime().exec('bash -c {{echo,{payload}}}|{{base64,-d}}|{{bash,-i}}')\n$$--=x`：创建一个名为`pwnshell`的触发器，在查询`INFORMATION_SCHEMA.TABLES`表之前执行。触发器使用 JavaScript 调用 `java.lang.Runtime.getRuntime().exec()` 执行反弹shell命令。`{payload}`会被替换为base64编码后的反弹shell命令，其中利用了bash的特性进行解码和执行。
4.  **发送请求：** 将构造好的包含payload的JSON数据，通过POST请求发送到`/api/setup/validate`接口。
5.  **执行命令：**  当Metabase尝试连接到恶意构造的数据库时，触发器被执行，从而在服务器上执行任意命令，实现远程代码执行。

**项目地址:** [j0yb0y0h/CVE-2023-38646](https://github.com/j0yb0y0h/CVE-2023-38646)

**漏洞详情:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)