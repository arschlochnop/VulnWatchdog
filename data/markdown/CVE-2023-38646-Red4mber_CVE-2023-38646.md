## CVE-2023-38646-Metabase-RCE

**漏洞编号:** CVE-2023-38646

**漏洞类型:** 远程代码执行(RCE)

**影响应用:** Metabase

**危害等级:** 高危，允许未经身份验证的攻击者在服务器上执行任意命令

**影响版本:** < 0.46.6.1 (开源版), < 1.46.6.1 (企业版)

**利用条件:** 目标Metabase实例版本在受影响范围内，且未进行相应补丁修复。

**POC 可用性:** 是

**投毒风险:** 1%

## 详情

CVE-2023-38646 是 Metabase 中的一个远程代码执行漏洞。未经身份验证的攻击者可以通过构造特殊的请求利用此漏洞在 Metabase 服务器上执行任意命令。

**利用方式：**

1.  **获取 Setup Token：** 攻击者首先向 `/api/session/properties` 端点发送 GET 请求，以获取 `setup-token`。这个token用于后续的利用。
2.  **构造恶意请求：** 攻击者构造一个包含恶意 SQL 注入的 JSON payload，并将其发送到 `/api/setup/validate` 端点。
    *   Payload 的 `details` 字段包含一个恶意的 H2 数据库连接字符串，其中 `TRACE_LEVEL_SYSTEM_OUT=1` 开启了跟踪，`CREATE TRIGGER` 用于创建一个触发器，在访问 `INFORMATION_SCHEMA.TABLES` 表时执行 JavaScript 代码。
    *   JavaScript 代码使用 `java.lang.Runtime.getRuntime().exec()` 执行经过 Base64 编码的命令。
3.  **执行命令：** 当 Metabase 尝试验证数据库连接时，恶意 SQL 注入会被触发，从而执行攻击者提供的命令。

**有效性评估：**

提供的PoC代码有效。代码通过发送恶意请求到 `/api/setup/validate` 接口来触发漏洞。代码首先通过`/api/session/properties`获取token，然后使用包含恶意SQL注入的JSON数据包通过POST方法发送到目标服务器。

**投毒风险评估：**

该POC代码主要功能是利用漏洞实现RCE，没有明显的投毒行为。
虽然存在执行任意命令的风险，但是payload是由使用者提供的。代码本身只负责构造和发送请求，风险是RCE本身带来的，而不是代码作者植入的后门。
存在极低的投毒风险 (大约1%)，该风险来自于作者可能会在代码逻辑上存在一些隐藏的后门，但是代码整体结构和逻辑都比较简单，隐藏后门的难度较高。


**项目地址:** [Red4mber/CVE-2023-38646](https://github.com/Red4mber/CVE-2023-38646)

**漏洞详情:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)