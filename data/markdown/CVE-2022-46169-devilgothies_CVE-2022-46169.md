## CVE-2022-46169-Cacti-命令注入

**漏洞编号:** CVE-2022-46169

**漏洞类型:** 命令注入

**影响应用:** Cacti

**危害等级:** 高危，允许未经身份验证的远程代码执行

**影响版本:** < 1.2.23

**利用条件:** 需要目标Cacti实例存在一个action类型为POLLER_ACTION_SCRIPT_PHP（值为2）的poller_item配置，并且可以通过HTTP访问remote_agent.php页面

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2022-46169 是 Cacti 1.2.23 之前版本中存在的一个未经身份验证的命令注入漏洞。该漏洞位于 `remote_agent.php` 文件中，攻击者可以通过构造特定的 HTTP 请求头来绕过身份验证，并通过 `poller_id` 参数注入恶意命令。漏洞利用过程如下：

1.  **身份验证绕过：** 攻击者通过设置 `X-Forwarded-For` 等 HTTP 头，伪造客户端 IP 地址，使其与 Cacti 服务器本身的 IP 地址匹配。由于 Cacti 验证客户端 IP 地址的方式存在缺陷，攻击者可以绕过身份验证。
2.  **命令注入：** 成功绕过身份验证后，攻击者可以向 `remote_agent.php` 发送带有 `action=polldata` 和恶意 `poller_id` 参数的请求。`poller_id` 参数中的值会被插入到 `proc_open` 函数的参数中，从而执行攻击者指定的命令。
3.  **利用代码分析：** 提供的PoC代码首先检查目标是否存在漏洞通过设置`X-Forwarded-For` http头。如果确认存在漏洞，则通过遍历`host_id`和`local_data_ids[]`来寻找配置正确的`poller_item`, 找到后，构造payload，执行反弹shell。
4. **投毒分析：** 检查PoC代码和README.md文件，未发现任何明显的恶意代码或后门。所有的代码都致力于利用此漏洞，没有发现有任何与预期功能不符的部分。因此，投毒风险评估为0%。

**总结：**
该漏洞允许未经身份验证的攻击者在目标系统上执行任意命令，风险极高。提供的PoC代码可以有效地利用该漏洞。该漏洞已被CISA列入已知被利用的漏洞目录（KEV）。

**项目地址:** [devilgothies/CVE-2022-46169](https://github.com/devilgothies/CVE-2022-46169)

**漏洞详情:** [CVE-2022-46169](https://nvd.nist.gov/vuln/detail/CVE-2022-46169)