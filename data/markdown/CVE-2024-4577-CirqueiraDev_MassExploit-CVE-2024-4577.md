## CVE-2024-4577 PHP-CGI 参数注入

**漏洞编号:** CVE-2024-4577

**漏洞类型:** 参数注入/远程代码执行

**影响应用:** PHP

**危害等级:** 高危，可能导致远程代码执行

**影响版本:** PHP 8.1.* before 8.1.29, 8.2.* before 8.2.20, 8.3.* before 8.3.8

**利用条件:** Windows系统，PHP运行在CGI模式下，开启了使用“Best Fit”策略的代码页

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-4577 是一个存在于 PHP 中的严重漏洞，当 PHP 在 Windows 上以 CGI 模式运行时，如果系统配置为使用某些代码页，则 Windows 可能会使用“Best-Fit”行为来替换传递给 Win32 API 函数的命令行中的字符。PHP CGI 模块可能会将这些字符错误地解释为 PHP 选项，从而允许恶意用户将选项传递给正在运行的 PHP 二进制文件，从而泄露脚本的源代码、在服务器上运行任意 PHP 代码等。

**漏洞利用分析：**

提供的 Python 脚本 `CVE-2024-4577.py` 旨在批量检测和利用此漏洞。

1.  **有效性：** 根据漏洞描述和漏洞利用代码，该PoC利用`auto_prepend_file`和`allow_url_include`选项来包含`php://input`，从而允许攻击者注入任意 PHP 代码。如果目标环境满足漏洞利用的先决条件（Windows，CGI模式，特定版本等），则该PoC应该是有效的。搜索结果也表明该漏洞已被积极利用。
2.  **投毒风险：**  代码总体来说比较简单，主要就是发送Payload，读取返回。但是作者有添加referer头的行为，如果作者有意投毒，可以在check_exploit方法中加入恶意代码，比如，如果探测目标存在漏洞，则发送漏洞域名，以及服务器相关信息到指定服务器。或者加入一些迷惑性代码，干扰分析人员分析。基于作者添加referer头的行为, 并且根据代码量判断，投毒风险较低，判断为10%。
3.  **利用方式：**
    *   攻击者通过构造包含恶意 PHP 代码的 HTTP 请求，并利用 Windows 代码页的“Best Fit”转换特性，将特殊字符转换为 PHP 选项。
    *   这些 PHP 选项会被 PHP CGI 模块错误解析，例如，`auto_prepend_file=php://input` 允许攻击者将 HTTP 请求体的内容作为 PHP 代码执行。
    *   攻击者可以通过这种方式在服务器上执行任意 PHP 代码，从而控制服务器。

**PoC代码分析：**

*   `clean_domain(domain)`: 清理域名，移除 `http://` 或 `https://` 前缀，并提取域名部分。
*   `check_exploit(domain)`:  对目标域名发送包含 PHP 代码的 HTTP POST 请求。Payload是 `<?php phpinfo(); ?>`。
    *   使用 `auto_prepend_file=php://input` 将 POST 请求的内容（payload）作为 PHP 代码执行。
    *   检查响应中是否包含 "PHP Version" 字符串，以判断漏洞是否成功利用。
    *   如果成功，将 URL 写入 `vulnerable.txt` 文件。
*   `start(file, threads)`: 从文件中读取域名列表，并使用多线程并发地执行 `check_exploit` 函数。
*   主程序：解析命令行参数，调用 `start` 函数开始漏洞检测。

**项目地址:** [CirqueiraDev/MassExploit-CVE-2024-4577](https://github.com/CirqueiraDev/MassExploit-CVE-2024-4577)

**漏洞详情:** [CVE-2024-4577](https://nvd.nist.gov/vuln/detail/CVE-2024-4577)