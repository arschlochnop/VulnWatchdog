## CVE-2019-3396 - Atlassian Confluence Widget Connector Macro Server-Side Template Injection

**漏洞编号:** CVE-2019-3396

**漏洞类型:** 服务器端模板注入 (Server-Side Template Injection)

**影响应用:** Atlassian Confluence Server

**危害等级:** 高危，可导致远程代码执行

**影响版本:** 受影响版本：Confluence Server 6.6.0 - 6.6.11, 6.7.0 - 6.12.2, 6.13.0 - 6.13.2, 6.14.0 - 6.14.1

**利用条件:** 需要能够访问存在漏洞的Confluence服务器，并能够在Confluence页面中插入或修改内容以利用 Widget Connector macro。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2019-3396 漏洞存在于 Atlassian Confluence Server 的 Widget Connector macro 中，允许未经身份验证的远程攻击者通过服务器端模板注入 (SSTI) 执行任意代码。攻击者可以通过构造恶意的 Velocity 模板，利用 Widget Connector macro 渲染该模板，从而在 Confluence 服务器上执行命令。

**有效性：**
根据提供的漏洞信息，搜索引擎结果和漏洞利用代码，可以判断此漏洞是有效的。漏洞库信息明确指出该漏洞允许远程攻击者实现路径遍历和远程代码执行，搜索引擎结果中的文章也表明此漏洞已被积极利用，甚至被用于传播恶意软件。

**投毒风险：**
提供的漏洞利用代码主要包含以下几个文件：
*   `README.md`: 描述文件
*   `cmd.vm`, `cmd1.vm`, `cmd3.vm`: 包含 Velocity 模板代码，用于执行命令。这三个文件除了注释略有不同，核心代码相同。

代码的主要功能是：
1.  获取 Java Runtime 实例。
2.  执行用户提供的命令 (`$cmd`)。
3.  获取命令执行的输出流。
4.  使用 Scanner 读取输出流。
5.  返回命令执行的结果。

投毒风险分析：
由于这些脚本主要是为了执行任意命令，存在被用于恶意目的的风险。例如，攻击者可能会修改这些脚本，使其在执行目标命令的同时，执行一些隐蔽的恶意操作，如安装后门、收集敏感信息等。如果未经授权的人修改或者发布这些脚本，投毒风险就会提升。 总体来说，这些PoC更多的是payload，本身是无害的，风险主要来源于使用它们的人。但作者也可能在代码中隐藏一些不易察觉的后门代码，比如添加一个额外的命令执行，或者上传收集到的信息到恶意服务器。因此，存在一定的投毒风险，估计为 10%。

**利用方式：**
1.  攻击者需要构造包含恶意 Velocity 模板的 Confluence 页面或修改现有页面。
2.  利用 Widget Connector macro 渲染该恶意模板。
3.  恶意模板中的代码会在 Confluence 服务器上执行，从而实现远程代码执行。
4.  `$cmd` 变量需要通过某种方式传递到 Velocity 模板中，例如通过构造特定的请求参数。

总而言之，此漏洞的利用方式是通过构造恶意的Velocity模板，利用Confluence的Widget Connector Macro组件进行渲染，从而达到远程代码执行的目的。

**项目地址:** [vntest11/confluence_CVE-2019-3396](https://github.com/vntest11/confluence_CVE-2019-3396)

**漏洞详情:** [CVE-2019-3396](https://nvd.nist.gov/vuln/detail/CVE-2019-3396)