## CVE-2022-42889-Apache Commons Text-RCE

**漏洞编号:** CVE-2022-42889

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Apache Commons Text

**危害等级:** 高危，可能导致远程代码执行

**影响版本:** <= 1.9

**利用条件:** 应用使用了受影响版本的Apache Commons Text，并且允许用户可控的字符串参与到`${}`表达式的解析过程中

**POC 可用性:** 是

**投毒风险:** 1%

## 详情

CVE-2022-42889，也被称为 Text4Shell，是 Apache Commons Text 1.5 到 1.9 版本中的一个远程代码执行漏洞。该漏洞源于库中使用的字符串插值功能。当应用程序使用这些版本的 Commons Text，并且将用户提供的、未经充分清理的数据传递给 StringSubstitutor.replace() 方法时，攻击者可以利用`${prefix:name}`格式的字符串注入恶意代码。

**有效性：**

提供的PoC 代码有效，它演示了如何利用该漏洞执行任意命令。PoC 代码包含了一个 Spring Boot 应用程序，该程序接受一个名为 `search` 的请求参数，并使用 `StringSubstitutor.replace()` 方法对其进行插值。通过构造包含`${script:javascript:java.lang.Runtime.getRuntime().exec('command')}` 的恶意 payload，攻击者可以在服务器上执行任意命令。

**投毒风险：**

该仓库中作者隐藏的投毒代码可能性极低。`Dockerfile`、`pom.xml`和java源代码没有发现任何恶意行为。虽然存在远程代码执行漏洞，但这本身不是投毒。1%的风险在于构建脚本可能依赖于外部资源（例如，Maven仓库），这些资源可能在构建时被篡改，或者受到供应链攻击。但是，就提供的代码本身而言，它似乎没有包含故意的恶意代码。

**利用方式：**

1.  攻击者需要找到一个应用程序，该程序使用了存在漏洞的 Apache Commons Text 版本（<= 1.9）。
2.  攻击者需要在该应用程序中找到一个输入点（例如，HTTP 请求参数、表单字段等），该输入点允许攻击者控制将传递给 `StringSubstitutor.replace()` 方法的字符串。
3.  攻击者构造包含恶意`${prefix:name}` 表达式的 payload。`prefix` 可以是 `script`、`dns` 或 `url`。例如，可以使用 `${script:javascript:java.lang.Runtime.getRuntime().exec('command')}` 执行任意命令，使用 `${dns:address}` 解析恶意域名，或使用 `${url:UTF-8:url}` 从远程服务器加载数据。
4.  攻击者将 payload 传递给应用程序。
5.  应用程序使用 `StringSubstitutor.replace()` 方法处理 payload，导致恶意代码被执行。

**项目地址:** [DimaMend/cve-2022-42889-text4shell](https://github.com/DimaMend/cve-2022-42889-text4shell)

**漏洞详情:** [CVE-2022-42889](https://nvd.nist.gov/vuln/detail/CVE-2022-42889)