## CVE-2007-2447-Samba-远程命令注入

**漏洞编号:** CVE-2007-2447

**漏洞类型:** 远程命令注入

**影响应用:** Samba

**危害等级:** 高危，可能导致远程代码执行

**影响版本:** 3.0.0 to 3.0.25rc3

**利用条件:** 目标系统运行受影响的Samba版本，且开启了username map script选项（对于SamrChangePassword函数）。 或者可以利用remote printer和file share management相关的MS-RPC函数。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2007-2447 存在于Samba 3.0.0 到 3.0.25rc3版本中。该漏洞允许远程攻击者通过 shell 元字符执行任意命令。根据漏洞描述，主要有三种利用方式：

1.  **SamrChangePassword 函数 + username map script:** 当 `smb.conf` 文件中启用了 `username map script` 选项时，通过向 `SamrChangePassword` 函数传递包含 shell 元字符的恶意用户名，可以执行任意命令。
2.  **Remote Printer MS-RPC 函数：** 远程身份验证用户可以通过涉及远程打印机管理的 MS-RPC 函数，利用 shell 元字符执行命令。
3.  **File Share Management MS-RPC 函数：** 远程身份验证用户可以通过涉及文件共享管理的 MS-RPC 函数，利用 shell 元字符执行命令。

**POC代码分析：**
提供的POC代码 `smbconnect.py` 尝试利用用户名参数中的shell命令注入来建立反向shell。代码首先导入必要的模块，然后设置攻击者和目标IP地址和端口。 核心的攻击载荷是在用户名变量中，包含反向shell命令。它使用 `nc` 命令将目标机器的 `/bin/bash` shell 反向连接到攻击者的IP地址和端口。

**有效性评估：**
根据漏洞描述和POC代码，如果目标Samba服务器存在漏洞且配置满足条件（特别是对于 `SamrChangePassword` 的利用，需要启用 `username map script`），则POC代码应该有效。 

**投毒风险评估：**
在提供的 `smbconnect.py` 代码中，包含恶意反向shell代码，但这是为了验证漏洞的有效性。考虑到作者可能会在代码的其他地方加入恶意代码（例如，在连接后执行某些恶意操作）， 存在一定的投毒风险，但风险较低，约 10%。因为总体逻辑简单清晰，容易审核。主要的风险在于，使用者可能不了解代码的实际作用，直接在生产环境中使用。

**利用方式总结：**
1.  配置Samba服务器的 `smb.conf` 文件，启用 `username map script` 选项。
2.  远程连接到目标Samba服务器。
3.  如果目标启用了 `username map script`，则调用 `SamrChangePassword` 函数，并构造包含恶意 shell 元字符的用户名。
4.  或者，尝试利用 remote printer 或者 file share management 相关的 MS-RPC 函数，构造包含恶意shell元字符的参数。
5.  利用注入的 shell 命令执行任意代码，例如建立反向 shell。

**项目地址:** [Juantos/cve-2007-2447](https://github.com/Juantos/cve-2007-2447)

**漏洞详情:** [CVE-2007-2447](https://nvd.nist.gov/vuln/detail/CVE-2007-2447)