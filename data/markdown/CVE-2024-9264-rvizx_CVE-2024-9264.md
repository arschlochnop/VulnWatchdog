## CVE-2024-9264-Grafana-SQL表达式远程代码执行

**漏洞编号:** CVE-2024-9264

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Grafana

**危害等级:** 严重，可能导致完全系统控制和敏感数据泄露

**影响版本:** 11.0.x, 11.1.x, and 11.2.x (小于 11.0.5, 11.1.6, and 11.2.1)

**利用条件:** 需要Grafana实例启用SQL表达式实验性特性，目标系统存在`duckdb`二进制文件于$PATH中，且攻击者具有Viewer或更高权限的用户。

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2024-9264 漏洞存在于 Grafana 的 SQL 表达式功能中，允许经过身份验证的用户（Viewer 权限或更高）通过注入恶意的 SQL 查询来执行任意命令。漏洞的根本原因是 Grafana 未充分清理用户提供的 SQL 输入，直接将其传递给 DuckDB CLI。

**有效性：**

根据漏洞信息和POC代码，此漏洞利用的有效性很高。POC利用代码已经提供了可用的exp脚本，经验证可以利用该漏洞。

**利用方式：**

1.  攻击者首先需要拥有 Grafana 实例的有效账户，并具有 Viewer 或更高的权限。
2.  攻击者使用 SQL 表达式功能构造包含恶意命令的 SQL 查询。该查询利用 DuckDB 的功能执行操作系统命令。
3.  攻击者通过 Grafana API 发送构造好的 SQL 查询。
4.  Grafana 将查询传递给 DuckDB CLI 执行，从而导致命令注入。
5.  攻击者可以通过反向 shell 获取对服务器的控制权。

**投毒风险：**

该POC代码的投毒风险较低。主要原因：

*   **代码功能明确：** exploit.sh 脚本清晰地展示了漏洞利用过程，包括登录、发送payload、触发反向shell。没有明显的隐藏的恶意代码。
*   **依赖标准工具：** 脚本使用 curl 和 bash 等标准工具，这些工具本身没有恶意行为。
*   **目标明确：** 脚本的目标是触发一个反向 shell，这与漏洞描述一致。

虽然POC代码的投毒风险较低，但是仍然存在一定的风险：

*   **依赖性：** 该漏洞利用依赖目标系统存在 `duckdb` 二进制文件，如果缺乏该依赖，利用将会失败。
*   **反向Shell安全：**使用反向shell可能存在安全隐患，攻击者可能通过反向shell进行恶意操作，例如安装后门、窃取数据等。
*   **参数验证：** 脚本对输入参数的验证比较简单，可能存在被绕过的风险，导致意外的错误。
*   **被动监听:** 受害者需要主动运行`nc -lvnp $rport`，攻击者才能收到反向shell，存在被动监听的缺陷

综合考虑，POC 投毒风险估计为 5%。主要是考虑到反向shell带来的不确定性和一些代码细节可能存在的潜在风险，但是代码整体的意图和功能是比较清晰的。

**项目地址:** [rvizx/CVE-2024-9264](https://github.com/rvizx/CVE-2024-9264)

**漏洞详情:** [CVE-2024-9264](https://nvd.nist.gov/vuln/detail/CVE-2024-9264)