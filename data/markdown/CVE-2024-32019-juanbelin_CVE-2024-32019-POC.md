## CVE-2024-32019-Netdata-本地提权

**漏洞编号:** CVE-2024-32019

**漏洞类型:** 本地提权

**影响应用:** Netdata

**危害等级:** 高危，允许本地用户获得root权限

**影响版本:** >= 1.45.0, < 1.45.3, >= 1.44.0-60, < 1.45.0-169

**利用条件:** 需要Netdata agent运行在受影响版本，且攻击者能够执行本地代码。

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2024-32019 漏洞存在于 Netdata 的 `ndsudo` 工具中。该工具拥有 SUID 权限，允许执行某些特权命令。漏洞的根源在于 `ndsudo` 使用不安全的 PATH 环境变量来查找要执行的命令，攻击者可以通过在 PATH 中插入恶意程序，让 `ndsudo` 执行攻击者控制的代码，从而提升权限到 root。

**利用方式：**

1.  **查找 `ndsudo` 路径：** 通常位于 `/opt/netdata/usr/libexec/netdata/plugins.d/ndsudo`，但需要通过 `find` 命令确认。
2.  **创建恶意程序：** 创建一个 C 程序，该程序调用 `setuid(0)` 和 `setgid(0)` 设置用户和组 ID 为 root，然后执行一个 shell (例如 `/bin/bash -p`)。需要使用 `gcc` 编译该程序，例如命名为 `arcconf`。
3.  **修改 PATH 环境变量：** 将包含恶意程序的目录添加到 PATH 环境变量的开头。例如，如果恶意程序位于 `/tmp` 目录下，则执行 `PATH=/tmp:$PATH`。
4.  **执行 `ndsudo` 命令：** 使用 `ndsudo` 执行它支持的命令，但该命令依赖于攻击者放置的恶意程序。例如，`/opt/netdata/usr/libexec/netdata/plugins.d/ndsudo arcconf-pd-info`。`ndsudo` 会尝试执行 `arcconf`，但由于 PATH 环境变量被修改，它会执行攻击者在 `/tmp` 目录下创建的恶意程序。
5.  **获得 root shell：** 如果一切顺利，攻击者将获得一个 root shell。

**投毒风险分析：**

提供的 POC 代码中，`arcconf.c` 的目的是创建一个提权的 shell，没有明显的投毒行为。 但从 github 下载预编译二进制文件 `arcconf` 时，存在一定的投毒风险。攻击者可能在预编译的二进制文件中植入恶意代码。考虑到从 github 上下载的二进制文件存在潜在风险，故投毒风险评估为5%。

**项目地址:** [juanbelin/CVE-2024-32019-POC](https://github.com/juanbelin/CVE-2024-32019-POC)

**漏洞详情:** [CVE-2024-32019](https://nvd.nist.gov/vuln/detail/CVE-2024-32019)