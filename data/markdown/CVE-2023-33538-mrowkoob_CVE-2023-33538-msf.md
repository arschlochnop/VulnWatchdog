## CVE-2023-33538 - TP-Link TL-WR940N/841N 命令注入

**漏洞编号:** CVE-2023-33538

**漏洞类型:** 命令注入

**影响应用:** TP-Link TL-WR940N/841N/740N 路由器

**危害等级:** 高危，允许未授权的命令执行

**影响版本:** TL-WR940N V2/V4, TL-WR841N V8/V10, TL-WR740N V1/V2

**利用条件:** 需要能够访问路由器Web界面，且需要已认证的会话（Authorization cookie和Session Path）

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2023-33538 存在于TP-Link TL-WR940N V2/V4, TL-WR841N V8/V10, 和 TL-WR740N V1/V2 路由器的`/userRpm/WlanNetworkRpm`组件中。这是一个命令注入漏洞，攻击者可以通过操纵`ssid1`参数来执行任意系统命令。

**有效性评估：**

提供的Metasploit auxiliary module似乎是有效的，因为它直接利用了 `ssid1` 参数中的命令注入漏洞。该模块发送精心构造的HTTP GET请求，将恶意命令注入到 `ssid1` 参数中。如果路由器没有正确地过滤或转义这个参数，那么攻击者就可以执行任意的系统命令。

根据搜索引擎结果，此漏洞已被CISA添加到已知被利用的漏洞目录中，并且已经观察到活跃攻击，表明该漏洞确实可以被利用。

**投毒风险评估：**

评估仓库中是否存在作者隐藏的投毒代码：

*   **Metasploit模块的结构：** 该模块是一个辅助模块，这意味着它不会试图自动获取shell。它依赖于用户提供的参数，例如 `AUTHCOOKIE`, `SESSIONPATH`, 和 `CMD`。这降低了直接投毒的风险，因为它的行为高度依赖于用户的输入。
*   **代码审查：** 检查了 `tplink_ssid1_rce.rb` 文件。该代码看起来相对简单，主要功能是构造带有恶意payload的HTTP请求并发送到目标路由器。其中 `payload_variants` 函数定义了payload的几种不同形式，以便提高漏洞利用的成功率。这些变体本身并不是恶意代码，只是为了适应不同的环境或过滤规则。
*   **潜在风险：** 仍然存在间接投毒的风险。如果攻击者使用此模块，并错误地配置了 `CMD` 参数，例如，执行了破坏性的命令，那么可以认为是一种形式的“投毒”，但这不是模块作者的直接责任。
*   **免责声明：** README中包含免责声明，明确指出该模块仅用于教育目的，禁止用于非法活动。
*   **依赖关系：** 该模块只依赖于Metasploit框架，没有引入额外的外部库或依赖项，降低了因依赖引入恶意代码的风险。

基于以上分析，可以认为该仓库中直接包含恶意投毒代码的风险较低，大约为10%。 主要风险在于用户可能不当使用该模块，导致设备损坏或其他负面后果，这不应归咎于模块作者。

**利用方式：**

1.  **身份验证：** 首先，攻击者需要通过某种方式获取到目标路由器的有效的 `Authorization` cookie和 `SESSIONPATH`。这可能涉及暴力破解密码、利用其他漏洞，或者通过社会工程学手段获取凭据。
2.  **配置Metasploit模块：** 攻击者将 `tplink_ssid1_rce.rb` 文件复制到Metasploit的模块目录中，并启动Metasploit控制台。
3.  **设置参数：** 攻击者需要设置以下参数：
    *   `RHOSTS`: 目标路由器的IP地址。
    *   `RPORT`: 目标路由器的端口 (默认为 80)。
    *   `AUTHCOOKIE`: 从浏览器获取的 `Authorization` cookie。
    *   `SESSIONPATH`: 从浏览器获取的会话URI前缀。
    *   `CMD`: 要执行的命令。
4.  **执行攻击：** 攻击者运行 `exploit` 命令。Metasploit模块将构造包含恶意命令的HTTP GET请求，并将其发送到目标路由器的 `/userRpm/WlanNetworkRpm.htm` 页面。
5.  **命令执行：** 如果漏洞利用成功，路由器将执行攻击者指定的命令。

攻击成功后，攻击者可以在路由器上执行任意命令，例如获取敏感信息、修改路由器配置或将路由器用作僵尸网络的一部分。

**项目地址:** [mrowkoob/CVE-2023-33538-msf](https://github.com/mrowkoob/CVE-2023-33538-msf)

**漏洞详情:** [CVE-2023-33538](https://nvd.nist.gov/vuln/detail/CVE-2023-33538)