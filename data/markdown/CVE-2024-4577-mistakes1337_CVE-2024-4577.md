## CVE-2024-4577-PHP-CGI参数注入RCE

**漏洞编号:** CVE-2024-4577

**漏洞类型:** 远程代码执行（RCE）

**影响应用:** PHP

**危害等级:** 高危，可能导致服务器被完全控制

**影响版本:** PHP 8.1.* before 8.1.29, 8.2.* before 8.2.20, 8.3.* before 8.3.8，仅影响在Windows上运行且使用CGI模式的PHP

**利用条件:** 目标系统为Windows，使用Apache和PHP-CGI，并且系统的代码页使用“Best Fit”策略。

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2024-4577是一个PHP-CGI的参数注入漏洞，影响在Windows上运行且使用CGI模式的PHP。当系统配置为使用某些代码页时，Windows可能会使用“Best Fit”行为来替换命令行中的字符。PHP CGI模块可能会错误地将这些字符解释为PHP选项，从而允许恶意用户将选项传递给正在运行的PHP二进制文件，进而泄露脚本源代码，在服务器上运行任意PHP代码，甚至执行操作系统命令。

**有效性评估：**
根据漏洞信息和搜索引擎结果，该漏洞已被广泛利用，并且有公开的POC代码。提供的Python POC代码通过构造特定的URL，利用Windows “Best Fit” 字符转换特性，向PHP-CGI传递恶意参数，从而达到远程代码执行的目的。该POC通过发送包含`allow_url_include`和`auto_prepend_file`选项的GET请求来包含远程文件或代码，从而达到RCE。

**投毒风险分析：**
提供的POC代码本身的功能是漏洞利用，没有明显的恶意行为。代码从URL或文件中读取目标URL，并发送构造好的HTTP请求，判断返回内容中是否包含“vulnerable”等关键词，以此判断是否存在漏洞。代码包含测试是否存在漏洞的回显，而不是直接执行恶意代码。但是，任何公开的漏洞利用代码都有可能被修改后用于恶意目的，比如修改payload执行恶意系统命令。所以存在一定的风险。但提供的文件`CVE-2024-4577.py` 和 `README.md` 内容简洁，没有发现隐藏的恶意代码。投毒风险评估为5%。

**利用方式：**
1.  **环境准备：** 攻击者需要找到运行在Windows服务器上，并且以CGI模式运行的PHP应用，同时该Windows服务器需要使用受影响的PHP版本，并且配置了存在“Best Fit”转换的代码页。
2.  **构造Payload：** 攻击者需要构造包含恶意PHP选项的URL。通常会使用`allow_url_include`和`auto_prepend_file`选项，配合`php://input`流，将恶意的PHP代码注入到目标服务器执行。
3.  **发送请求：**  攻击者通过发送GET或POST请求，将构造好的URL发送到目标服务器。
4.  **执行代码：**  如果漏洞存在，PHP-CGI会错误地解析URL中的恶意选项，从而执行攻击者注入的PHP代码，甚至操作系统命令。

**项目地址:** [mistakes1337/CVE-2024-4577](https://github.com/mistakes1337/CVE-2024-4577)

**漏洞详情:** [CVE-2024-4577](https://nvd.nist.gov/vuln/detail/CVE-2024-4577)