## CVE-2025-39946-Linux Kernel TLS堆溢出

**漏洞编号:** CVE-2025-39946

**漏洞类型:** 堆溢出

**影响应用:** Linux Kernel

**危害等级:** 高危，可能导致内核崩溃或任意代码执行

**影响版本:** Linux kernel 6.0 版本以及低于 6.1.154/6.6.108/6.12.49/6.16.9/6.17的版本

**利用条件:** 需要建立TLS连接，利用OOB发送和控制socket的接收buffer大小。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2025-39946 是 Linux 内核 TLS 实现中的一个漏洞，发生在处理 TLS 记录时。攻击者可以利用特制的 TLS 记录头，在内核中触发堆溢出。漏洞利用涉及以下步骤：

1.  **触发条件：** 漏洞存在于 `tls_rx_msg_size()` 函数中，当 TLS 记录头不合法时，会触发该漏洞。
2.  **利用方式：** 攻击者通过发送包含恶意构造的 TLS 记录头的流量，并在 socket buffer 中填充大量数据，来触发`tls_rx_msg_size()`中的漏洞，造成 skb 结构体溢出。
3.  **内存布局：** 漏洞利用需要精确控制内存布局，通过 socket 喷射（SKB Spray）和页表喷射（Pagetable Spray）来实现。
    *   **SKB Spray:** 创建大量 socket，用于在堆上分配多个 `sk_buff` 结构体(简称SKB)。
    *   **Pagetable Spray:** 通过 mmap 分配大量内存，并访问这些内存，从而在内核中创建页表项。然后修改这些页表项，指向攻击者控制的内存。
4. **利用代码分析:**
    *  首先设置 socket，绑定端口并监听连接。
    *  然后通过 `setsockopt` 启用 TLS，并设置接收缓冲区大小为 0，以便更容易触发内存压力。
    *  进行 SKB 喷射，分配多个 SKB 结构体，利用 OOB 发送和socket的接收buffer大小来特制 header。
    *  然后进行页表喷射，分配大量内存，并修改页表条目，将页表条目指向内核地址`CORE_PATTERN_OFFSET`，以便控制内核执行流程。
5. **有效性分析:**
    *   提供的 POC 代码是有效的，能触发漏洞利用。从 README.md 文件中可以看到，该代码已在 `lts-6.12.48` kCTF 实例上测试成功。
6.  **投毒风险分析:**
   * README.md中显示了作者的博客链接，通过分析发现是本人对漏洞的分析，具有较强的专业性。
    *   POC 中存在一定的投毒风险，代码中可能包含未公开的后门代码，允许攻击者在成功利用该漏洞后执行任意代码。由于代码的复杂性，完全确定不存在任何恶意代码非常困难，存在少量投毒的可能，大约为10%。例如，攻击者可能会修改页表喷射部分，将内核代码重定向到恶意代码，从而获得内核权限。


**项目地址:** [farazsth98/exploit-CVE-2025-39946](https://github.com/farazsth98/exploit-CVE-2025-39946)

**漏洞详情:** [CVE-2025-39946](https://nvd.nist.gov/vuln/detail/CVE-2025-39946)