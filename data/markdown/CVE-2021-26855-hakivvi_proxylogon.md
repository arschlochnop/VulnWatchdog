## CVE-2021-26855 - Microsoft Exchange Server Remote Code Execution

**漏洞编号:** CVE-2021-26855

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Microsoft Exchange Server

**危害等级:** 高危，可能导致完全控制受影响的Exchange服务器

**影响版本:** 受影响版本包括 Exchange Server 2013 Cumulative Update 21/22/23, Exchange Server 2016 Cumulative Update 8/9/10/11/12/13/14/15/16/17/18/19, Exchange Server 2019 Cumulative Update 1/2/3/4/5/6/7/8

**利用条件:** 需要能够访问Exchange服务器的网络，并且服务器存在漏洞

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-26855 是 Microsoft Exchange Server 中的一个服务器端请求伪造 (SSRF) 漏洞。结合其他漏洞（如CVE-2021-27065），未经身份验证的远程攻击者可以利用此漏洞发送任意 HTTP 请求并以管理员身份通过身份验证，最终实现远程代码执行。 

**利用方式：**

1.  **SSRF (CVE-2021-26855):** 攻击者首先利用 SSRF 漏洞伪造 HTTP 请求，绕过身份验证。
2.  **管理员权限获取:** 利用伪造的请求，攻击者可以获得 Exchange 服务器的管理员权限。
3.  **OAB虚拟目录操作:** 修改OAB (Offline Address Book)虚拟目录的ExternalUrl参数，将shell地址写入。
4.  **Shell 写入:** 通过修改的ExternalUrl，攻击者将一个 ASPX webshell 写入到 Exchange 服务器的 web 可访问目录（通常是`C:\inetpub\wwwroot\aspnet_client\`）。 
5.  **远程代码执行:** 攻击者可以通过访问 webshell 的 URL 并发送特定的请求参数来执行任意代码。

**代码分析与投毒风险评估：**

提供的POC代码 `proxylogon.py` 实现了上述的攻击流程。代码首先利用 SSRF 获取服务器的计算机名，然后利用 NTLM 认证绕过。之后，它利用获取的管理员权限，通过修改 OAB 虚拟目录来写入 webshell。最后，代码输出 webshell 的 URL，攻击者可以通过该 URL 执行任意命令。

**投毒风险分析:**  POC代码中存在一定的投毒风险，主要体现在以下几个方面：

*   **后门植入:** 虽然主要的目的是利用漏洞进行RCE，恶意攻击者可能会在脚本中添加额外的后门代码，例如，在写入的 webshell 中添加额外的功能，以便在将来保持对服务器的访问。
*   **信息收集:**  攻击者可以修改脚本来收集目标服务器上的敏感信息，例如，用户名、密码哈希、以及其他配置信息。
*   **恶意传播:**  如果攻击者控制了多个 Exchange 服务器，他们可以修改脚本来自动传播恶意软件到其他服务器。
*   **依赖库风险：**POC依赖Impacket库，如果Impacket库本身被篡改或包含恶意代码，那么使用此POC也会受到影响。

尽管存在这些风险，但就提供的代码片段本身而言，没有明显的恶意代码。风险主要在于该漏洞本身带来的权限和潜在的恶意修改行为。POC中生成随机字符串的部分(gen())是为了避免文件名冲突，本身不是恶意行为。利用OABVirtualDirectory修改ExternalUrl以及ResetOABVirtualDirectory修改FilePathName的行为是为了webshell的写入，这是漏洞利用的一部分。

**总结:** 该漏洞利用链的有效性较高，因为 CVE-2021-26855 是 ProxyLogon 攻击链的关键组成部分，被广泛利用。 投毒风险主要来自于利用此漏洞成功入侵后的恶意行为，而非POC代码本身。由于代码中包含webshell的部署，存在一定风险，但直接判定为投毒不严谨，结合分析结果，投毒风险预估为10%。

**项目地址:** [hakivvi/proxylogon](https://github.com/hakivvi/proxylogon)

**漏洞详情:** [CVE-2021-26855](https://nvd.nist.gov/vuln/detail/CVE-2021-26855)