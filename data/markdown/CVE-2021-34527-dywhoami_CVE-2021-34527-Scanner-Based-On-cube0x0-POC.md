## CVE-2021-34527 PrintNightmare

**漏洞编号:** CVE-2021-34527

**漏洞类型:** 远程代码执行

**影响应用:** Windows Print Spooler

**危害等级:** 高危，允许攻击者以SYSTEM权限执行任意代码

**影响版本:** 受影响的Windows版本见漏洞库信息

**利用条件:** 攻击者需要能够访问目标系统的Print Spooler服务

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-34527，又名PrintNightmare，是一个存在于Windows Print Spooler服务中的远程代码执行漏洞。攻击者可以通过不当的特权文件操作来利用此漏洞，从而以SYSTEM权限在目标系统上运行任意代码。

**有效性分析：**

根据漏洞库信息和搜索结果，此漏洞是一个已知的、被广泛利用的漏洞。漏洞利用代码 (POC) 通过 `impacket` 库与目标系统的Print Spooler服务建立连接，并尝试添加恶意的打印机驱动程序。如果成功，攻击者可以利用该驱动程序执行任意代码。

搜索结果显示，此漏洞已被积极利用，并且存在缓解措施和检测方法。

**投毒风险分析：**

POC代码主要目的是验证漏洞的存在，并非恶意软件，但依旧存在潜在的投毒风险，包括：

1.  **恶意Payload替换：** 攻击者可能修改POC代码，将原有的测试Payload替换为恶意代码，例如安装后门或窃取敏感数据。
2.  **依赖库篡改：** 攻击者可能通过篡改`impacket`等依赖库，在其中植入恶意代码。
3.  **诱导执行：** 攻击者可能诱导用户以高权限运行修改后的POC代码，从而提升恶意代码的执行权限。

基于以上分析，此POC代码存在10%的投毒风险。

**利用方式分析：**

该漏洞的利用方式主要涉及以下步骤：

1.  **连接Print Spooler服务：** 攻击者使用 `impacket` 库中的函数与目标系统的Print Spooler服务建立连接。
2.  **构建恶意驱动程序容器：** 攻击者构造包含恶意驱动程序路径的`DRIVER_CONTAINER` 结构。POC 中使用了 `C:\Windows\System32\winhttp.dll` 和 `C:\Windows\System32\kernelbase.dll` 作为初始配置，后续尝试 `C:\Windows\System32\spool\drivers\x64\3\old\{0}\{1}` 路径，用于绕过安全检查。
3.  **添加打印机驱动程序：** 攻击者调用 `rprn.hRpcAddPrinterDriverEx` 函数，尝试将恶意的驱动程序添加到目标系统。  通过多次尝试不同的文件路径，利用不当的文件复制操作触发漏洞。
4.  **执行任意代码：** 如果驱动程序添加成功，攻击者可以通过打印操作或其他方式加载该驱动程序，从而以SYSTEM权限执行任意代码。

**项目地址:** [dywhoami/CVE-2021-34527-Scanner-Based-On-cube0x0-POC](https://github.com/dywhoami/CVE-2021-34527-Scanner-Based-On-cube0x0-POC)

**漏洞详情:** [CVE-2021-34527](https://nvd.nist.gov/vuln/detail/CVE-2021-34527)