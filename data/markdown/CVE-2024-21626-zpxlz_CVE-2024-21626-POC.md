## CVE-2024-21626-runc容器逃逸

**漏洞编号:** CVE-2024-21626

**漏洞类型:** 容器逃逸

**影响应用:** runc

**危害等级:** 高危，可完全控制宿主机

**影响版本:** < 1.1.12

**利用条件:** 可以创建容器并指定执行命令，可以指定容器使用的镜像

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2024-21626 是 runc 中的一个容器逃逸漏洞，由于文件描述符泄露，导致容器进程的工作目录可能位于主机文件系统命名空间中。攻击者可以利用此漏洞，通过 `runc exec` 或恶意镜像（`runc run`），访问甚至覆盖主机上的文件，从而实现容器逃逸，完全控制宿主机。

**漏洞利用方式：**
1.  **文件描述符泄露：** runc 在执行 `runc exec` 时，未能正确地设置 CLOEXEC 标志，导致文件描述符泄露到新启动的容器进程中。
2.  **工作目录操纵：** 利用泄露的文件描述符，攻击者可以操纵容器进程的工作目录指向主机文件系统上的某个目录。
3.  **文件覆盖/执行：** 在主机文件系统上，攻击者可以读取敏感文件，或覆盖关键的可执行文件，例如 `bash`，以获得宿主机的控制权。

**POC分析：**
提供的POC代码展示了漏洞利用过程：
1.  **Dockerfile：** 创建一个Ubuntu容器，安装 netcat 工具，添加 `poc.sh` 脚本，并设置工作目录为 `/proc/self/fd/9`，这个目录对应于泄露的文件描述符。注意：实际环境可能需要根据文件描述符泄露情况调整这个目录。
2.  **poc.sh：** 脚本首先获取容器的IP地址，然后在`/proc/self/cwd/../../../bin/bash.copy`创建一个反弹shell的`bash`副本。`/proc/self/cwd` 表示当前工作目录（即主机文件系统），向上三级目录，尝试覆盖宿主机的 `/bin/bash.copy`文件。脚本随后使用 `nc` 监听指定端口，等待反弹shell连接。

**有效性：**
根据漏洞描述和POC代码，此POC具有较高的成功率，能够实现容器逃逸。但实际利用时，需要根据不同的 Docker/runc 版本，调整工作目录 `/proc/self/fd/9`， 找到泄露的正确的文件描述符。同时目标文件路径也需要根据环境进行调整。

**投毒风险：**
经过代码审计，该仓库中的POC代码未发现明显的投毒行为。作者的目的是演示漏洞的利用，而不是在用户不知情的情况下执行恶意操作。`poc.sh` 脚本中的反弹 shell 行为是漏洞利用的一部分，并非隐藏的恶意代码。所以投毒风险为0%。

**项目地址:** [zpxlz/CVE-2024-21626-POC](https://github.com/zpxlz/CVE-2024-21626-POC)

**漏洞详情:** [CVE-2024-21626](https://nvd.nist.gov/vuln/detail/CVE-2024-21626)