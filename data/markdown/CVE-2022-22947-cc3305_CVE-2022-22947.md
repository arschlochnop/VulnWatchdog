## CVE-2022-22947-Spring Cloud Gateway代码注入

**漏洞编号:** CVE-2022-22947

**漏洞类型:** 代码注入

**影响应用:** Spring Cloud Gateway

**危害等级:** 高危，可能导致远程代码执行

**影响版本:** 3.1.x prior to 3.1.1+, 3.0.x prior to 3.0.7+ and all old and unsupported versions

**利用条件:** Gateway Actuator endpoint必须启用、暴露且未进行安全保护

**POC 可用性:** 是

**投毒风险:** 1%

## 详情

CVE-2022-22947是Spring Cloud Gateway中的一个代码注入漏洞。当Gateway Actuator endpoint启用、暴露且未进行安全保护时，远程攻击者可以发送恶意构造的请求，从而在远程主机上执行任意代码。漏洞的根源在于`getValue`方法中不安全的SpEL表达式评估。利用过程为：

1.  攻击者构造包含恶意SpEL表达式的payload，该表达式可以执行任意命令。
2.  攻击者通过POST请求将payload发送到`/actuator/gateway/routes/{id}`端点，其中`{id}`是一个攻击者自定义的路由ID。
3.  Spring Cloud Gateway解析payload中的SpEL表达式，导致远程代码执行。
4.  攻击者可以通过`/actuator/gateway/refresh`端点刷新路由配置，使payload生效。

该POC代码通过向 `/actuator/gateway/routes/cc3305` 发送包含恶意SpEL表达式的JSON payload来利用此漏洞，SpEL表达式通过java.lang.Runtime执行任意命令。 代码首先检查目标是否易受攻击（虽然目前返回True）。然后，它准备要执行的命令，并将其嵌入到SpEL表达式中，该表达式会被注入到路由定义中。

关于投毒风险，该脚本主要功能是利用漏洞执行命令。 潜在的投毒风险在于，攻击者可能会修改脚本，使其在执行命令之前或之后执行其他恶意操作，例如下载和执行恶意软件。 但是，提供的代码没有明显的投毒迹象。 投毒的概率较低，大约为1%。 恶意行为者可能会分发修改后的版本。

**有效性评估:**根据漏洞库信息、搜索结果和提供的PoC代码，该漏洞利用是有效的，前提是满足漏洞利用条件。该PoC代码能够成功利用漏洞执行任意命令。


**项目地址:** [cc3305/CVE-2022-22947](https://github.com/cc3305/CVE-2022-22947)

**漏洞详情:** [CVE-2022-22947](https://nvd.nist.gov/vuln/detail/CVE-2022-22947)