## CVE-2024-50379-Apache Tomcat TOCTOU Race Condition RCE

**漏洞编号:** CVE-2024-50379

**漏洞类型:** TOCTOU Race Condition RCE

**影响应用:** Apache Tomcat

**危害等级:** 高危，可导致远程代码执行

**影响版本:** 11.0.0-M1 <= version <= 11.0.1, 10.1.0-M1 <= version <= 10.1.33, 9.0.0.M1 <= version <= 9.0.97

**利用条件:** 默认Servlet启用写入（非默认配置），文件系统大小写不敏感。

**POC 可用性:** 是

**投毒风险:** 1%

## 详情

CVE-2024-50379 是 Apache Tomcat 中的一个时序竞态条件漏洞，发生在 JSP 编译期间。当默认 Servlet 启用写入（非默认配置）且文件系统大小写不敏感时，攻击者可以通过竞态条件竞争，上传一个 JSP 文件，使得该文件被 Tomcat 当作 JSP 文件执行，从而导致远程代码执行（RCE）。

**有效性：**
根据漏洞描述，搜索引擎结果以及提供的POC代码，可以判定该POC代码有效。

**投毒风险：**
分析提供的 Python 脚本 `exploit.py`，脚本的功能是尝试上传一个 JSP shell 到目标服务器的 `/uploads` 目录，并提供一个简单的命令行界面来执行命令。脚本本身没有明显的恶意代码。代码逻辑比较清晰，主要涉及 URL 处理、HTTP 请求和响应处理。不过，由于脚本允许远程执行任意命令，攻击者可能利用此工具进行恶意活动。

投毒风险评估：
*   核心代码无明显恶意行为：脚本的主要功能是上传和执行命令，没有发现主动删除文件、窃取信息等恶意代码。
*   潜在的滥用风险：脚本本身就是为了方便 RCE 而设计的，如果被恶意用户使用，可能造成严重危害。
*   依赖风险：脚本使用了 `requests` 库，需要确保该库本身没有安全问题。

综合来看，此仓库中作者隐藏的投毒代码的可能性较低，约为1%。风险主要在于脚本的功能本身可能被滥用。

**利用方式：**
1.  **漏洞触发前提：** Tomcat 服务器需要满足以下条件才能被利用：
    *   默认 Servlet 启用写入（`readonly` 参数设置为 `false`）。
    *   文件系统大小写不敏感。
2.  **攻击步骤：**
    *   攻击者运行提供的 `exploit.py` 脚本。
    *   脚本会提示用户输入目标 Tomcat 服务器的 base URL。
    *   脚本会尝试上传一个 JSP shell 到 `/uploads/shell.jsp`。
    *   如果 `/uploads` 目录不存在或没有正确配置，脚本仍然会继续上传尝试。
    *   上传成功后，攻击者可以通过脚本提供的命令行界面，输入任意命令，在 Tomcat 服务器上执行。
3.  **漏洞原理：**
    该漏洞是一个 TOCTOU 竞态条件漏洞，在 JSP 编译过程中，Tomcat 会检查上传的文件。攻击者利用竞态条件，在 Tomcat 检查文件之后、编译文件之前，替换文件内容为恶意的 JSP 代码，从而绕过安全检查，实现 RCE。

**项目地址:** [pwnosec/CVE-2024-50379](https://github.com/pwnosec/CVE-2024-50379)

**漏洞详情:** [CVE-2024-50379](https://nvd.nist.gov/vuln/detail/CVE-2024-50379)