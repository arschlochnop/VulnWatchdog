## CVE-2021-3493 Ubuntu OverlayFS 本地提权

**漏洞编号:** CVE-2021-3493

**漏洞类型:** 本地提权

**影响应用:** Linux Kernel (Ubuntu)

**危害等级:** 高危，可导致普通用户提升为root权限

**影响版本:** Ubuntu 5.8 kernel < 5.8.0-50.56, 5.4 kernel < 5.4.0-72.80, 4.15 kernel < 4.15.0-142.146, 4.4 kernel < 4.4.0-209.241

**利用条件:** 需要目标系统运行受影响的Ubuntu内核，并且允许非特权用户挂载 overlayfs 文件系统和使用user namespace

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

该漏洞源于Ubuntu内核中overlayfs实现对用户命名空间中的文件能力验证不当。结合非特权用户命名空间和Ubuntu内核中的允许非特权 overlayfs 挂载的补丁，攻击者可以利用此漏洞获得提升的权限。

**有效性评估：**

提供的POC代码看起来是有效的。它利用了 overlayfs 和 user namespace 的组合来设置文件 capability，从而实现提权。代码首先创建必要的目录结构（lower, upper, work, merge），然后使用 `unshare` 创建一个新的 user namespace 和 mount namespace。接着，它写入 `/proc/self/setgroups`, `/proc/self/uid_map`, 和 `/proc/self/gid_map` 来设置用户和组的映射。然后，挂载 overlayfs 文件系统，拷贝自身可执行文件到 overlayfs 的 merge 目录，并使用 `setxattr` 设置 capabilities。最后，它执行位于 upper 目录的可执行文件，该文件会尝试以 root 权限执行 /bin/bash。

根据漏洞库信息，CISA 将此漏洞添加到已知被利用的漏洞列表中，进一步表明了该漏洞的有效性。

**投毒风险分析：**

检查提供的 exploit.c 代码，没有发现明显的恶意代码或后门。代码逻辑清晰，主要执行了 overlayfs 的挂载，文件复制，设置 xattr 和执行 shell 操作。代码的意图与漏洞描述一致，没有发现隐藏的、与漏洞利用无关的恶意行为。因此，投毒风险为 0%。

**漏洞利用方式：**

1.  **环境准备：**  在存在漏洞的Ubuntu系统上，创建必要的目录结构 (ovlcap/work, ovlcap/lower, ovlcap/upper, ovlcap/merge)。
2.  **User Namespace和Mount Namespace：** 使用 `unshare` 系统调用创建新的 user namespace 和 mount namespace。
3.  **ID映射：**  配置 `/proc/self/setgroups`，`/proc/self/uid_map` 和 `/proc/self/gid_map`，以便在 user namespace 中获得有效的用户 ID 和组 ID。
4.  **OverlayFS挂载：**  使用 `mount` 系统调用挂载 overlayfs 文件系统，将 lower, upper 和 work 目录关联起来。
5.  **文件拷贝与 Capability 设置：**  将 exploit 程序自身拷贝到 overlayfs 的 merge 目录，并使用 `setxattr` 设置 `security.capability` 属性，赋予其 CAP_SETUID 和 CAP_SETGID 等权限。
6.  **提权执行：** 执行位于 upper 目录的 exploit 程序的拷贝。由于该文件具有 capabilities，因此可以以 root 权限执行 shell。

**项目地址:** [Abdennour-py/CVE-2021-3493](https://github.com/Abdennour-py/CVE-2021-3493)

**漏洞详情:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)