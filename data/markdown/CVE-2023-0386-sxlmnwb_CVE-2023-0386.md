## CVE-2023-0386-Linux Kernel OverlayFS权限提升

**漏洞编号:** CVE-2023-0386

**漏洞类型:** 权限提升

**影响应用:** Linux Kernel

**危害等级:** 高危，本地用户可提升权限至root

**影响版本:** Linux kernel 6.2-rc6 (可能影响其他版本)

**利用条件:** 本地用户访问权限，目标系统使用OverlayFS

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2023-0386 是一个 Linux kernel OverlayFS 中的权限提升漏洞。该漏洞允许本地用户通过利用 OverlayFS 如何处理具有 capabilities 的 setuid 文件，从而获得提升的权限。 

**利用方式：**

1.  **环境准备:** 创建必要的目录结构，包括lowerdir, upperdir, workdir和mergedir，模拟OverlayFS环境。
2.  **挂载OverlayFS:** 使用`mount`命令挂载OverlayFS文件系统，指定lowerdir, upperdir和workdir。
3.  **创建带capability的文件 (在提供的代码中，这一步通过fuse.c模拟):** Fuse文件系统模拟lowerdir中存在具有setuid权限的文件。漏洞利用的关键在于OverlayFS对这个文件的处理不当。
4.  **触发漏洞:**  当用户尝试在OverlayFS挂载点访问或复制这个具有capabilities的setuid文件时，由于uid映射的缺陷，会导致权限提升。exp.c的代码模拟了这个过程。
5.  **执行提权后的文件:** 执行复制到upperdir的目标文件，获得root权限。

**代码分析：**

*   `fuse.c`： 使用FUSE (Filesystem in Userspace) 模拟一个 lower 层的文件系统。关键在于`getattr_callback`函数，该函数为`/file`设置了`S_IFREG | 04777` 权限，即设置了 setuid 位。
*   `exp.c`： 此文件实现了漏洞利用的核心逻辑。
    *   创建并挂载 OverlayFS 文件系统。
    *   通过`unshare`创建新的命名空间，模拟用户命名空间。
    *   利用OverlayFS的特性，尝试复制 lower 层中带 capability 的文件到 upper 层。
    *   最终尝试执行upper层的文件，期望获得提权。
*   `Makefile`： 用于编译各个源文件。
*   `README.md`： 提供漏洞利用的步骤。

**有效性评估：**

提供的POC代码看起来是有效的，它实现了漏洞利用所需的基本步骤。根据搜索结果，存在多个关于此漏洞的POC，表明漏洞利用的可行性较高。 Rapid7 也提供了相关的利用模块, 进一步证实了这一点.

**投毒风险评估：**

虽然代码主要用于权限提升，但仍存在一定的投毒风险。

*   风险点： `exp.c` 中的 `system(buf);` 调用。 如果 `buf` 的内容被恶意修改，可能执行任意命令。但是，目前的`buf`构建方式相对固定，直接被投毒的可能性较低.
*   风险占比： 5%。 风险主要来自于对`exp.c`中命令执行语句的潜在篡改, 例如在编译过程中注入恶意代码. 代码中使用 `system` 函数有潜在的风险，如果 `DIR_UPPER` 可控，则存在命令注入的可能。

总的来说，该POC的主要目的是演示权限提升，而非进行恶意攻击或投毒。直接的恶意代码注入的可能性较低，但仍然需要仔细审查代码，确保在编译和执行过程中没有被篡改。

**项目地址:** [sxlmnwb/CVE-2023-0386](https://github.com/sxlmnwb/CVE-2023-0386)

**漏洞详情:** [CVE-2023-0386](https://nvd.nist.gov/vuln/detail/CVE-2023-0386)