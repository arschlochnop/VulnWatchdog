## CVE-2024-48990-needrestart-PYTHONPATH提权

**漏洞编号:** CVE-2024-48990

**漏洞类型:** 权限提升

**影响应用:** needrestart

**危害等级:** 高危，本地攻击者可利用该漏洞以root权限执行任意代码

**影响版本:** < 3.8

**利用条件:** 需要本地用户权限以及needrestart以root权限运行（通常由apt-get触发）

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

该漏洞存在于needrestart版本小于3.8中。攻击者可以设置PYTHONPATH环境变量，使needrestart在执行Python脚本时加载恶意.so文件，从而获得root权限。

**有效性评估：**

提供的POC代码利用了CVE-2024-48990，该POC代码会：
1.  生成一个C语言源文件，编译后会设置uid和gid为0，并将/bin/bash复制到/tmp/ribbit并设置SUID位。
2.  创建一个名为`importlib`的目录。
3.  将生成的C代码编译成`importlib/__init__.so`。
4.  创建一个Python脚本，该脚本循环检查/tmp/ribbit是否存在，如果存在则执行该程序（SUID bash）。
5.  设置PYTHONPATH为当前目录，然后运行上述Python脚本。

当needrestart以root权限执行时，由于PYTHONPATH被设置为攻击者可控的目录，它会加载`importlib/__init__.so`，从而执行恶意代码，将bash复制到/tmp/ribbit并设置SUID位。之后，Python脚本检测到/tmp/ribbit存在，执行该文件，攻击者获得root shell。

**投毒风险评估：**

分析POC代码，没有发现作者隐藏的投毒代码。该脚本的功能是完全按照漏洞原理进行利用，目的是演示如何通过PYTHONPATH环境变量执行任意代码并提升权限。

**利用方式：**

1.  攻击者需要本地用户权限。
2.  攻击者需要创建包含恶意`__init__.so`文件的目录（例如，`importlib`）。
3.  攻击者设置PYTHONPATH环境变量指向该目录。
4.  攻击者触发needrestart以root权限运行，这通常由apt-get等软件包管理工具触发。
5.  needrestart执行Python脚本时，会加载恶意`__init__.so`文件，从而执行攻击者控制的代码。
6.  恶意代码将bash复制到指定位置并设置SUID位，攻击者可以通过执行该bash程序获得root shell。

**项目地址:** [Cyb3rFr0g/CVE-2024-48990-PoC](https://github.com/Cyb3rFr0g/CVE-2024-48990-PoC)

**漏洞详情:** [CVE-2024-48990](https://nvd.nist.gov/vuln/detail/CVE-2024-48990)