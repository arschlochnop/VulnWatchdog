## CVE-2019-5420-Rails-远程代码执行

**漏洞编号:** CVE-2019-5420

**漏洞类型:** 远程代码执行

**影响应用:** Rails

**危害等级:** 高危，可完全控制服务器

**影响版本:** < 5.2.2.1, < 6.0.0.beta3 (development mode)

**利用条件:** Rails 应用运行于开发模式，且攻击者可以访问该应用

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2019-5420 漏洞允许攻击者在 Rails 开发模式下执行远程代码。该漏洞的核心在于 Rails 在开发模式下自动生成的 secret_key_base 的随机性不足，使得攻击者可以通过爆破或已知模式猜测到该密钥。一旦 secret_key_base 被破解，攻击者就可以利用它来构造恶意 session cookie，从而利用 Marshal.load 反序列化漏洞执行任意代码。

**漏洞利用方式：**

1.  **密钥猜测/获取:**  由于开发模式下 secret_key_base 密钥生成方式不安全，尝试猜测或利用已知模式获取密钥。
2.  **构造恶意 Session:**  使用获取到的 secret_key_base，结合漏洞利用代码，生成包含恶意 Ruby 对象的序列化数据，然后对其进行加密和签名，形成恶意的 session cookie。
3.  **发送恶意 Cookie:**  将构造的恶意 session cookie 发送到 Rails 应用。
4.  **RCE:**  Rails 应用在处理恶意 cookie 时，会使用 Marshal.load 反序列化其中的 Ruby 对象，从而触发代码执行。

**POC 代码分析：**

提供的 Ruby 代码展示了漏洞利用的整个过程：

*   **getSessionKey:** 用于从credentials 文件中获取解密后的session key。credentials 文件包含了密钥相关的信息,如iv和tag等。
*   **cookie 解密:**  使用猜测或已知 secret_key_base 解密现有的 session cookie。
*   **构造 Payload:**  利用 `Gem::StubSpecification` 和 `Marshal.dump` 构造恶意 Ruby 对象，该对象在反序列化时会执行系统命令，POC中为`/usr/local/bin/score 1bde8715-5ddf-4f03-9c72-897348939e50 1>&2`。
*   **加密 Payload:**  使用 secret_key_base 重新加密包含恶意对象的 session cookie。
*   **替换 Cookie:**  将生成的恶意 cookie 发送给目标 Rails 应用。

**投毒风险分析：**

该代码中主要的风险在于通过 `stub_specification.instance_variable_set(:@loaded_from, "|/usr/local/bin/score 1bde8715-5ddf-4f03-9c72-897348939e50 1>&2")` 设置的命令执行。这部分代码的目的是利用漏洞执行任意命令。这部分代码有可能是开发者为了测试漏洞而添加，但也有可能是恶意代码。由于无法确定 `/usr/local/bin/score` 的功能，因此存在一定的投毒风险。

**风险评估：**

*   **漏洞利用有效性：**  有效，只要目标 Rails 应用运行在开发模式，且密钥可以被猜测/获取，该 POC 就可以成功执行远程代码。
*   **投毒风险：**  存在一定的投毒风险，集中在 `/usr/local/bin/score` 命令的执行上。如果该命令是恶意的，则该 POC 代码可以被认为存在投毒。

由于无法直接验证 `/usr/local/bin/score` 的功能，我们将投毒风险评定为 10% 。这部分代码的存在使得利用过程具有不确定性，因为如果攻击者直接使用该 POC，可能会执行未知的恶意命令。

**项目地址:** [mmeza-developer/CVE-2019-5420-RCE](https://github.com/mmeza-developer/CVE-2019-5420-RCE)

**漏洞详情:** [CVE-2019-5420](https://nvd.nist.gov/vuln/detail/CVE-2019-5420)