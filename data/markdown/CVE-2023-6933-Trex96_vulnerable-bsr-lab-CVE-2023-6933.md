## CVE-2023-6933 - WordPress Better Search Replace Plugin PHP 对象注入

**漏洞编号:** CVE-2023-6933

**漏洞类型:** PHP 对象注入

**影响应用:** WordPress Better Search Replace Plugin

**危害等级:** 高危，可能导致远程代码执行

**影响版本:** <= 1.4.4

**利用条件:** 目标WordPress站点安装了受影响版本的Better Search Replace插件，且存在可利用的POP链

**POC 可用性:** 是

**投毒风险:** 1%

## 详情

CVE-2023-6933 存在于 WordPress Better Search Replace 插件中，允许未经身份验证的攻击者通过反序列化不可信数据进行 PHP 对象注入。漏洞位于`class-bsr-db.php`文件的`recursive_unserialize_replace()`函数中，该函数直接将用户可控的`search_for`参数传递给 PHP 的 `unserialize()` 函数，而没有进行适当的验证或清理。 由于该插件本身不包含 POP 链，因此攻击者需要依赖其他插件或主题中存在的 POP 链才能实现远程代码执行。

**有效性分析：**

提供的 PoC 代码是有效的。它通过发送包含恶意序列化对象的 POST 请求到 `/wp-admin/admin-ajax.php`，利用 `search_replace_db` action 触发漏洞。PoC 使用 `dry_run=1` 参数以避免数据库修改，并使用 `stdClass` 对象作为 payload，以进行安全测试。 通过检查 HTTP 状态代码和响应内容，PoC 可以验证漏洞是否成功利用。

**投毒风险分析：**

该 PoC 旨在进行非侵入式测试，并且包含安全措施，例如 `dry_run=1` 和使用无害的 `stdClass` 对象。但是，任何代码都存在一定风险。这里假设投毒风险为1%, 主要来自于以下考虑:

1.  **人为错误：** 用户在使用或修改PoC时，可能会引入错误或恶意代码。
2.  **依赖项问题：** 虽然 PoC 本身看起来安全，但它可能依赖于其他库或组件，这些库或组件可能存在安全漏洞。
3.  **环境差异：** PoC 在不同环境下的行为可能有所不同，某些环境下可能会产生意想不到的副作用。

**利用方式：**

1.  **插件检测：** 首先，攻击者需要确认目标 WordPress 站点是否安装了受影响版本的 Better Search Replace 插件。可以通过访问 `/wp-content/plugins/better-search-replace/README.txt` 文件来获取插件版本信息。
2.  **Payload 构造：** 攻击者需要构造一个恶意的 PHP 序列化对象，该对象包含一个 POP 链，可以触发远程代码执行。POP 链通常涉及多个类的相互调用，最终执行恶意代码。
3.  **漏洞触发：** 攻击者发送包含恶意序列化对象的 POST 请求到 `/wp-admin/admin-ajax.php`，并将 `action` 参数设置为 `search_replace_db`，`search_for` 参数设置为构造的恶意序列化对象。其他参数包括 `replace_with`， `dry_run=1` 和 `select_tables[]`。
4.  **代码执行：** 如果目标站点存在可用的 POP 链，并且序列化对象成功反序列化，则会触发 POP 链，最终导致远程代码执行。


**项目地址:** [Trex96/vulnerable-bsr-lab-CVE-2023-6933](https://github.com/Trex96/vulnerable-bsr-lab-CVE-2023-6933)

**漏洞详情:** [CVE-2023-6933](https://nvd.nist.gov/vuln/detail/CVE-2023-6933)