## CVE-2024-34102 - Adobe Commerce XXE漏洞

**漏洞编号:** CVE-2024-34102

**漏洞类型:** XML外部实体注入 (XXE)

**影响应用:** Adobe Commerce (Magento)

**危害等级:** 高危，可能导致敏感信息泄露、远程代码执行

**影响版本:** <= 2.4.4-p8

**利用条件:** 目标系统存在未授权的XML处理接口，攻击者可以通过网络直接访问。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-34102 是 Adobe Commerce (Magento) 中的一个严重的 XXE 漏洞。攻击者可以通过发送特制的 XML 文档，该文档引用外部实体，从而利用此漏洞读取服务器上的敏感文件，甚至可能导致任意代码执行。

**有效性分析：**

根据漏洞库信息、搜索结果以及提供的漏洞利用代码，可以确认该漏洞的有效性。漏洞库信息明确指出该漏洞可能导致任意代码执行，CVSS 评分高达 9.8。搜索结果中也包含多个安全厂商对该漏洞的分析和描述，并将其定性为高危漏洞。提供的 Python 脚本（`cosmic_sting.py`）旨在自动化利用该漏洞，通过构造恶意 XML 请求来读取服务器上的文件。

**投毒风险分析：**

尽管该漏洞利用代码看起来是用于读取文件，但是仍然存在一定的投毒风险。

*   **依赖风险:**  脚本依赖 `requests`，`click`，和 `fake_useragent` 库。尽管这些库本身比较常用，但恶意作者仍然可能在 `requirements.txt` 文件中指定恶意版本，导致安装了包含后门的第三方库。
*   **Callback URL风险:**  脚本使用 `fars.ee`  来托管 DTD 文件,该操作存在一定的风险，因为攻击者无法控制该域名，可能被中间人攻击或者该服务提供商被恶意利用。
*   **SSRF API风险:** 脚本使用了 `api.cvssadvisor.com`这个SSRF API, 该服务可能会被滥用或停止服务.
*   **代码逻辑风险:** `cosmic_sting.py` 使用了`obtain_instance`函数,该函数调用了 `api.cvssadvisor.com` 的 SSRF API, 并使用了 User-Agent。 这有可能收集攻击者的User-Agent信息. 虽然看起来正常，但收集行为本身存在隐私风险。

综上，该仓库中存在投毒代码的可能性较低，估计为10%。 但是仍然需要人工审核代码，特别是检查所有依赖项和与外部服务交互的部分。

**利用方式分析：**

1.  **漏洞触发:** 攻击者发送包含恶意 XML 内容的 HTTP 请求到存在漏洞的 Adobe Commerce 服务器。该 XML 内容包含对外部实体的引用。
2.  **外部实体解析:**  Adobe Commerce 的 XML 解析器在处理 XML 请求时，会尝试解析外部实体。攻击者通过构造恶意的外部实体，使其指向攻击者控制的服务器。
3.  **信息泄露/代码执行:**  通过外部实体，攻击者可以读取服务器上的任意文件，例如 `/etc/passwd`、数据库配置文件等，从而获取敏感信息。 在更复杂的场景下，攻击者可以通过 XXE 漏洞结合其他漏洞，例如 SSRF 或代码注入，实现远程代码执行。

`cosmic_sting.py` 脚本简化了这一过程，它会自动生成包含恶意外部实体引用的 XML 数据，并将其发送到目标服务器。脚本还会启动一个简单的 HTTP 服务器，用于托管恶意的 DTD 文件，从而引导目标服务器解析攻击者控制的外部实体。具体而言，该脚本首先创建一个 callback URL 用于托管 DTD 文件。这个 DTD 文件包含从目标服务器读取任意文件的指令，然后将文件内容发送到攻击者的服务器上。利用方式的关键在于精心构造的 XML 和 DTD 文件，它们能够利用 XML 解析器的特性，实现对服务器资源的非法访问。

**项目地址:** [bughuntar/CVE-2024-34102-Python](https://github.com/bughuntar/CVE-2024-34102-Python)

**漏洞详情:** [CVE-2024-34102](https://nvd.nist.gov/vuln/detail/CVE-2024-34102)