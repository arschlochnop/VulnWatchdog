## CVE-2021-22204-ExifTool-代码执行

**漏洞编号:** CVE-2021-22204

**漏洞类型:** 代码执行

**影响应用:** ExifTool

**危害等级:** 高危，可能导致远程代码执行

**影响版本:** >=7.44, <12.24

**利用条件:** 需要目标系统安装ExifTool和DjVuLibre工具，且ExifTool版本在受影响范围内。

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2021-22204是ExifTool中DjVu文件格式处理不当导致的代码执行漏洞。攻击者可以构造恶意的DjVu文件，其中包含Perl代码，当ExifTool解析该文件时，会执行该Perl代码。

**利用方式：**

1.  **生成恶意DjVu文件：** exploit.py脚本首先通过base64编码将反弹shell的Perl payload嵌入到DjVu文件的元数据中。然后，脚本使用`djvumake`工具将payload插入到DjVu文件中。
2.  **将恶意DjVu文件嵌入到其他文件：** 使用`exiftool`工具，将生成的恶意DjVu文件（exploit.djvu）嵌入到`image.jpg`的`HasselbladExif`元数据标签中。这一步是利用了ExifTool的一个特性，允许将外部文件内容写入到元数据标签中。
3.  **触发漏洞：** 当受害者使用受影响版本的ExifTool处理包含恶意`HasselbladExif`元数据标签的`image.jpg`文件时，ExifTool会尝试解析DjVu文件，从而执行其中的恶意Perl代码。

**有效性：**

提供的PoC代码看起来是有效的。它利用了DjVu模块中的eval注入漏洞，允许攻击者执行任意Perl代码。脚本中包含了生成恶意DjVu文件并将其嵌入到图像文件中的步骤，以及一个反弹shell的示例payload。

**投毒风险：**

检查了提供的所有文件，包括exploit.py, configfile, lab目录下的Dockerfile, README.md, application.pl等，未发现任何明显的投毒代码。 exploit.py 的目的是生成漏洞利用程序，它创建恶意文件来触发 ExifTool 中的漏洞，而不是引入后门或恶意行为。配置文件的目的是定义ExifTool使用的自定义标签，而不是包含恶意代码。 lab 目录包含一个应用程序，用于说明 ExifTool 可能的使用方式，它不包含任何隐藏或恶意的代码.  因此，投毒风险较低。

**总结：**

该漏洞利用方式较为直接，利用了ExifTool在处理DjVu文件时存在的eval注入漏洞。攻击者构造包含恶意代码的DjVu文件，并借助ExifTool的特性将其嵌入到其他文件中，最终通过ExifTool解析文件触发漏洞，实现代码执行。提供的PoC代码看起来有效，并且未发现明显的投毒代码。

**项目地址:** [convisolabs/CVE-2021-22204-exiftool](https://github.com/convisolabs/CVE-2021-22204-exiftool)

**漏洞详情:** [CVE-2021-22204](https://nvd.nist.gov/vuln/detail/CVE-2021-22204)