## CVE-2016-6662 - MySQL 远程 Root 代码执行/权限提升

**漏洞编号:** CVE-2016-6662

**漏洞类型:** 权限提升/远程代码执行

**影响应用:** MySQL, MariaDB, Percona Server

**危害等级:** 高危，可能导致数据库完全控制和服务器接管

**影响版本:** MySQL <= 5.5.52, 5.6.x <= 5.6.33, 5.7.x <= 5.7.15; MariaDB < 5.5.51, 10.0.x < 10.0.27, 10.1.x < 10.1.17; Percona Server < 5.5.51-38.1, 5.6.x < 5.6.32-78.0, 5.7.x < 5.7.14-7

**利用条件:** 本地用户权限或 SQL 注入漏洞

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2016-6662 允许本地用户通过设置 general_log_file 选项到 my.cnf 配置文件来创建任意配置并绕过某些保护机制。这个漏洞可以被利用来以 root 权限执行任意代码，通过设置 malloc_lib 选项指向恶意 .so 文件。此利用方式依赖于可以写入 MySQL 配置文件，并重启 MySQL 服务。 

**有效性：** 提供的 Ansible 脚本旨在修复此漏洞，而非利用它。它通过修改 mysqld_safe 脚本，限制 .so 文件的加载路径到标准系统目录，并检查默认配置文件的存在性和权限来缓解风险，因此提供的代码是用于防御而不是利用的。

**投毒风险：**  该仓库本身包含的是修复漏洞的脚本，直接投毒的可能性较低。但是，仍然存在以下风险：

1.  **脚本本身可能存在缺陷：**  虽然脚本旨在修复漏洞，但如果脚本本身存在逻辑错误或未考虑到的情况，可能会导致 MySQL 服务不稳定或其他问题。 
2.  **供应链攻击：**  该仓库可能被黑客入侵，然后植入恶意代码。由于脚本需要修改系统文件和重启服务，一旦被植入恶意代码，危害非常大。 
3.  **依赖关系：**  该脚本可能依赖其他软件包或库，这些依赖项可能存在漏洞。  
综合考虑，投毒风险评估为 10%。 这个百分比是因为代码主要是防御性的，并且已经经过了相当数量的安装验证，降低了直接恶意代码的可能性。但供应链风险和脚本缺陷始终存在。

**利用方式：**

1.  **利用条件：**  需要拥有对 MySQL 服务器的本地用户权限或者能够通过 SQL 注入漏洞执行命令。
2.  **写入恶意配置：**  利用权限，将 `general_log_file` 设置为指向包含恶意配置的文件的路径。恶意配置中，设置 `malloc_lib` 指向恶意的 .so 文件。
3.  **重启 MySQL 服务：**  重启 MySQL 服务，使恶意 .so 文件被加载，从而执行任意代码。

搜索结果也表明，可以通过 SQL 注入来利用这个漏洞，意味着攻击者不需要本地账户，可以通过SQL注入写入配置，然后利用此漏洞提权至root。


**项目地址:** [meersjo/ansible-mysql-cve-2016-6662](https://github.com/meersjo/ansible-mysql-cve-2016-6662)

**漏洞详情:** [CVE-2016-6662](https://nvd.nist.gov/vuln/detail/CVE-2016-6662)