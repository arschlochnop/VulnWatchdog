## CVE-2007-2447-Samba-远程命令执行

**漏洞编号:** CVE-2007-2447

**漏洞类型:** 远程命令执行

**影响应用:** Samba

**危害等级:** 高危，可能导致完全控制受影响的系统

**影响版本:** 3.0.0 through 3.0.25rc3

**利用条件:** 目标Samba服务器运行受影响的版本，并且启用了"username map script"选项 (SamrChangePassword利用) 或者可访问 remote printer 和 file share management（其他MS-RPC函数利用）。 需要目标端口（通常是139或445）开放，攻击者需要能够与目标服务器建立SMB连接。

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2007-2447 是 Samba 中的一个远程命令执行漏洞。该漏洞存在于 smbd 的 MS-RPC 功能中。通过向受影响的 Samba 服务器发送特制的 MS-RPC 请求，远程攻击者可以执行任意命令。具体来说，漏洞存在于 (1) SamrChangePassword 函数，当启用 “username map script” smb.conf 选项时，以及 (2) remote printer 和 (3) file share management 中的其他 MS-RPC 函数。 漏洞利用方式主要通过注入 shell 元字符到相关参数中，导致服务器执行恶意命令。 

**有效性：**

提供的POC代码（new_exploit.py）利用了该漏洞。它通过 SMB 协议连接到目标服务器，并构造包含反向shell payload的用户名。这个payload利用了 “username map script”选项在处理用户名时未进行充分的转义，从而导致命令执行。

**投毒风险：**

该仓库中的投毒风险较低，大约为 5%。 主要理由如下：
*   代码体积小，易于人工审计。
*   代码逻辑清晰，主要功能是利用已知的漏洞。
*   payload 比较直接，没有隐藏恶意行为。
*   提示用户开启nc监听，行为合理

尽管如此，仍然存在很小的投毒风险，比如作者在代码中加入了一些不易察觉的混淆，或者利用了用户不熟悉的系统调用进行一些隐蔽的操作。

**利用方式：**

1.  **环境准备：** 攻击者需要一台可以连接到目标 Samba 服务器的机器，并且安装了 Python 和 `smb.SMBConnection` 模块。
2.  **配置监听器：** 攻击者需要在一个终端上启动一个 netcat 监听器 (`nc -lnvp <Lport>`)，等待反向 shell 连接。
3.  **运行Exploit：** 运行提供的 Python 脚本 `new_exploit.py`，并提供目标 IP 地址 (Thost)、目标端口 (Tport, 通常是 139)，以及攻击者机器的 IP 地址 (Lhost) 和监听端口 (Lport)。
4.  **触发漏洞：**  脚本会尝试连接到目标 Samba 服务器，并发送包含恶意 payload 的 MS-RPC 请求。如果漏洞利用成功，目标服务器会执行 payload，并反向连接到攻击者的 netcat 监听器。
5.  **获取Shell：** 攻击者就可以通过 netcat 监听器获得目标系统的 shell 访问权限。


**项目地址:** [MrRoma577/exploit_cve-2007-2447_again](https://github.com/MrRoma577/exploit_cve-2007-2447_again)

**漏洞详情:** [CVE-2007-2447](https://nvd.nist.gov/vuln/detail/CVE-2007-2447)