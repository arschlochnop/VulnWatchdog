## CVE-2022-22965 Spring4Shell RCE

**漏洞编号:** CVE-2022-22965

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Spring Framework

**危害等级:** 高危，可能导致服务器完全控制

**影响版本:** Spring Framework versions 5.3.X prior to 5.3.18+, 5.2.x prior to 5.2.20+ and all old and unsupported versions

**利用条件:** JDK 9+, Tomcat as WAR deployment, Spring MVC or Spring WebFlux

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2022-22965（Spring4Shell）是一个Spring框架中的远程代码执行漏洞。该漏洞的利用方式是，攻击者通过精心构造的请求，利用Spring的数据绑定功能，修改Tomcat服务器的日志配置，写入恶意JSP文件到服务器的webapps目录下，从而实现远程代码执行。

**有效性评估：**

从提供的漏洞库信息、搜索引擎结果以及漏洞利用代码来看，此漏洞利用的有效性较高。漏洞库信息明确指出存在RCE的可能，并提及了利用条件。搜索引擎结果中包含大量关于该漏洞的分析和利用文章，表明该漏洞已被广泛研究和利用。提供的POC代码实现了利用该漏洞上传webshell的功能，通过修改classloader等属性，将恶意代码写入到目标服务器。执行状态判断表明，POC 至少能够完成webshell的上传过程。

**投毒风险分析：**

仔细分析提供的 exploit1.py 和 exploit2.py 脚本，以及 README.md 文件，主要风险点在于：

*   **硬编码密码：** exploit1.py 中存在默认密码 `thm`，如果攻击者没有修改密码就直接使用，存在被其他恶意用户利用的风险。虽然这不算是代码层面的投毒，但属于配置不当可能导致的风险。
*   **文件名和目录：** 默认的文件名 `tomcatwar.jsp` 和目录 `ROOT` 可能会被监控系统检测到，但这更多是方便利用，而非隐藏的恶意行为。
*   **依赖项风险：** README.md 中提到了 Maven 编译和 Tomcat 依赖，如果使用的 Maven 仓库或 Tomcat 镜像被恶意篡改，可能会引入恶意代码。这属于供应链风险，而非代码本身投毒。
*    **代理服务器风险**: 在 exploit1.py 脚本中，支持通过代理服务器进行连接，虽然是方便进行HTTP消息拦截，但也存在代理服务器收集请求中的敏感信息。这不属于是POC投毒范畴，是属于使用者信息安全范畴。
*   **免责声明和学习目的：** README.md 中声明 PoC 仅用于学习目的，但无法保证使用者不会将其用于非法用途。

综合来看，代码本身没有明显的投毒行为，但存在一些配置风险和依赖项风险，可能被恶意利用。因此，投毒风险评估为 **10%**。这个百分比主要考虑使用者在使用默认配置可能带来的风险以及引入恶意依赖的潜在可能。

**漏洞利用方式：**

1.  **目标环境：** 目标应用运行在 JDK 9+，并且部署在 Tomcat 中，以 WAR 包形式部署。应用使用了 Spring MVC 或 Spring WebFlux 框架。
2.  **构造恶意请求：** 攻击者构造包含恶意参数的 HTTP POST 请求，利用 Spring 的数据绑定功能，修改 Tomcat 的 `AccessLogValve` 组件的属性。
3.  **修改日志配置：** 攻击者通过修改 `pattern` 属性，将恶意 JSP 代码写入到日志文件中。`directory`、`prefix`、`suffix` 和 `fileDateFormat` 属性用于控制日志文件的路径和名称，确保 JSP 代码能够写入到 webapps 目录下，并以 JSP 文件的形式存在。
4.  **上传 Webshell：**  成功修改日志配置后，Tomcat 会将恶意 JSP 代码写入到指定的 webapps 目录下，形成一个 Webshell。
5.  **远程代码执行：**  攻击者通过访问 Webshell 的 URL，执行任意代码，从而控制目标服务器。

**项目地址:** [cxzero/CVE-2022-22965-spring4shell](https://github.com/cxzero/CVE-2022-22965-spring4shell)

**漏洞详情:** [CVE-2022-22965](https://nvd.nist.gov/vuln/detail/CVE-2022-22965)