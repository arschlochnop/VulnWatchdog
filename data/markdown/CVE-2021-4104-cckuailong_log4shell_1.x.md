## CVE-2021-4104 - Apache Log4j 1.2 JMSAppender反序列化漏洞

**漏洞编号:** CVE-2021-4104

**漏洞类型:** 反序列化

**影响应用:** Apache Log4j 1.2

**危害等级:** 高危，可能导致远程代码执行

**影响版本:** Apache Log4j 1.2.x

**利用条件:** 1. 目标系统配置了JMS环境。
2. 攻击者可以写入Log4j配置文件。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-4104 是 Apache Log4j 1.2 中的一个反序列化漏洞。当 Log4j 1.2 配置为使用 JMSAppender 时，攻击者如果能够修改 Log4j 的配置文件 (log4j.properties)，就可以通过指定恶意的 `TopicBindingName` 和 `TopicConnectionFactoryBindingName`，利用 JNDI 注入执行远程代码。该 POC 代码提供了一个可利用的 Web 应用，其中 `log4j.properties` 包含恶意的 JNDI 配置，指向攻击者控制的 LDAP 服务器。当 Log4j 尝试通过 JNDI 获取 Topic 和 ConnectionFactory 时，会从 LDAP 服务器加载恶意的 Java 对象，导致反序列化漏洞，最终执行任意代码。

**有效性：** 提供的 POC 代码有效，但利用条件较为苛刻，需要目标系统已配置 JMSAppender 且攻击者具有 Log4j 配置文件的写入权限。

**投毒风险：**

此仓库主要展示了 CVE-2021-4104 漏洞的利用方式，从代码来看，没有明显的投毒代码。虽然利用成功后可以执行任意代码，但这是漏洞利用本身的结果，而非仓库作者有意植入的恶意代码。

不过，需要注意的是，任何下载和使用的开源代码都存在潜在风险。即使当前代码没有恶意行为，也不能完全排除未来被篡改的可能性。因此，在使用任何第三方代码之前，都应该进行仔细审查和安全评估。

**利用方式：**

1.  **目标系统需要运行 Log4j 1.2，且配置了 JMSAppender。**
2.  **攻击者需要获得目标系统的 Log4j 配置文件（log4j.properties）的写入权限。**
3.  **攻击者修改 `log4j.properties` 文件，设置恶意的 `TopicBindingName` 和 `TopicConnectionFactoryBindingName`，指向攻击者控制的 LDAP 服务器。**
4.  **攻击者在 LDAP 服务器上部署恶意 Java 对象，该对象包含要执行的恶意代码。**
5.  **当应用程序记录日志时，Log4j 会尝试连接 JMS 服务器，并通过 JNDI 从攻击者的 LDAP 服务器加载恶意 Java 对象，从而执行任意代码。**

总的来说，该漏洞利用的有效性依赖于特定的配置和攻击者对配置文件的控制能力。投毒风险较低，但仍建议进行代码审计。

**项目地址:** [cckuailong/log4shell_1.x](https://github.com/cckuailong/log4shell_1.x)

**漏洞详情:** [CVE-2021-4104](https://nvd.nist.gov/vuln/detail/CVE-2021-4104)