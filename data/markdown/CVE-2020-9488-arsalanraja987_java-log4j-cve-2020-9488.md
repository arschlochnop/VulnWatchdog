## CVE-2020-9488 - Apache Log4j SMTP Appender证书验证绕过

**漏洞编号:** CVE-2020-9488

**漏洞类型:** 中间人攻击 (Man-in-the-Middle)

**影响应用:** Apache Log4j

**危害等级:** 中危，可能导致日志信息泄露

**影响版本:** log4j-core < 2.12.3, log4j-core 2.13.0

**利用条件:** 目标系统使用Log4j的SMTP appender，并且配置了SMTPS，攻击者需要能够进行中间人攻击。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2020-9488 漏洞存在于Apache Log4j的SMTP appender中，由于其对主机名和证书的验证不严格，中间人攻击者可以通过伪造证书来拦截Log4j发送的日志信息。利用方式如下：

1.  **环境准备：** 攻击者需要能够拦截目标系统与SMTPS服务器之间的通信。
2.  **中间人攻击：** 攻击者设置中间人代理，拦截目标系统的SMTPS连接。
3.  **证书伪造：** 攻击者生成一个伪造的SMTPS服务器证书，并将其提供给目标系统。
4.  **数据窃取：** 由于Log4j不正确地验证证书，它会信任伪造的证书，并将日志信息发送给中间人攻击者，攻击者可以捕获这些信息。

**漏洞利用有效性：**

该漏洞的PoC（/tmp/40e3a64a125c8dcdb036cde1c7d7c41f/src/main/java/LogInjectionVulnerable.java）主要演示了日志注入，而非证书验证绕过。`/fix.sh` 文件和 `LogInjectionSafe.java` 演示了如何通过转义用户输入来修复日志注入漏洞。因此，提供的PoC代码**不能直接**验证证书验证绕过漏洞（CVE-2020-9488），而是展示了另一种与Log4j相关的漏洞（日志注入）的修复方法。  要验证CVE-2020-9488需要搭建一个模拟SMTPS服务器，使用存在漏洞的版本发送日志。

**投毒风险分析：**

仓库中的代码主要用于演示和修复Log4j的日志注入漏洞，而非SMTP Appender的证书验证问题。`fix.sh`脚本用于修复`LogInjectionVulnerable.java`中的日志注入问题。`LogInjectionSafe.java`也仅仅是对用户输入进行了转义，以防止日志注入。虽然主要功能是修复漏洞，但如果攻击者修改了`fix.sh`，例如在修复过程中添加下载恶意文件的命令，或者修改`LogInjectionSafe.java`在日志中记录敏感信息，则存在投毒的可能性。综合评估，该仓库存在一定的投毒风险，大约为10%，风险主要来自于修改修复脚本或日志内容的可能性。

**利用方式总结：**

CVE-2020-9488的利用方式是中间人攻击，攻击者需要能够拦截目标系统与SMTPS服务器之间的通信，并伪造SMTPS服务器证书，诱骗Log4j信任该证书，从而窃取日志信息。而提供的PoC代码侧重于防范另一种类型的漏洞：日志注入。

**项目地址:** [arsalanraja987/java-log4j-cve-2020-9488](https://github.com/arsalanraja987/java-log4j-cve-2020-9488)

**漏洞详情:** [CVE-2020-9488](https://nvd.nist.gov/vuln/detail/CVE-2020-9488)