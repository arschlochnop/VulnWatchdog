## CVE-2024-21626-runc容器逃逸

**漏洞编号:** CVE-2024-21626

**漏洞类型:** 容器逃逸

**影响应用:** runc

**危害等级:** 高危，可能导致主机被完全控制

**影响版本:** < 1.1.12

**利用条件:** 需要用户运行恶意镜像或执行恶意命令（runc exec）。需要存在漏洞版本的runc。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-21626 漏洞允许攻击者通过文件描述符泄漏导致容器进程的工作目录位于主机文件系统命名空间中，从而实现容器逃逸。 

**有效性分析：**
提供的 POC 代码利用了 `runc` 在处理工作目录时的文件描述符泄漏漏洞。通过 `docker run -w /proc/self/fd/$i` 命令，可以尝试将容器的工作目录设置为主机上的某个文件描述符，如果成功，就能访问主机文件系统。POC 首先使用 `verify.sh` 脚本找到可用的文件描述符，然后修改 Dockerfile 将工作目录设置为该文件描述符。`poc.sh` 脚本会在主机上创建一个具有反向 shell 功能的 `bash.copy` 文件，并赋予执行权限。执行 `bash.copy` 即可获得主机的 root 权限。

根据漏洞信息和搜索结果，POC 代码是有效的，可以实现容器逃逸。

**投毒风险分析：**
POC 代码的主要功能是利用漏洞进行逃逸并获取主机权限。以下是对代码中可能存在的投毒风险分析：
1.  **Dockerfile 修改:** 攻击者可能在 Dockerfile 中添加额外的恶意指令，例如安装后门程序、修改系统配置等。但是提供的代码没有发现。
2.  **poc.sh 脚本：** 该脚本创建 `bash.copy` 并设置反向 shell。 攻击者可能修改该脚本，添加其他恶意行为，例如上传敏感数据、删除关键文件等。由于代码非常简单，没有发现。
3.  **依赖项：** POC 依赖于 `ubuntu:20.04` 镜像，攻击者可能使用被篡改的镜像。但是提供的代码没有发现。
4.  **隐藏命令:** 攻击者可能会使用base64编码或其他编码方式来隐藏恶意代码，让用户难以发现,但是未发现此类代码。
综合来看，POC 代码本身实现的功能比较直接， 投毒风险主要在于攻击者可能修改脚本或Dockerfile，添加额外的恶意行为。 由于该POC比较简单，因此判断投毒风险较低，这里给出的投毒风险是10%。

**利用方式：**
1.  **攻击向量：** 用户运行恶意镜像或执行恶意命令（runc exec）。
2.  **前提条件：** 存在漏洞版本的 `runc`。
3.  **利用步骤：**
    *   运行 `verify.sh` 脚本找到可用的文件描述符。
    *   修改 Dockerfile，将工作目录设置为该文件描述符。
    *   构建 Docker 镜像。
    *   运行 Docker 镜像，执行 `poc.sh` 脚本。
    *   在主机上执行 `bash.copy` 脚本，获得主机的 root 权限。

**项目地址:** [KubernetesBachelor/CVE-2024-21626](https://github.com/KubernetesBachelor/CVE-2024-21626)

**漏洞详情:** [CVE-2024-21626](https://nvd.nist.gov/vuln/detail/CVE-2024-21626)