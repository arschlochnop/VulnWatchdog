## CVE-2024-6387-OpenSSH-竞争条件RCE/DoS

**漏洞编号:** CVE-2024-6387

**漏洞类型:** 竞争条件

**影响应用:** OpenSSH

**危害等级:** 高危，可能导致远程代码执行（RCE）和拒绝服务（DoS）

**影响版本:** <= 9.7p1

**利用条件:** 需要目标系统开启sshd服务，且受影响的OpenSSH版本存在漏洞。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-6387是一个存在于OpenSSH服务器（sshd）中的安全漏洞，具体来说是一个竞争条件漏洞。该漏洞源于OpenSSH处理信号的方式。未经身份验证的远程攻击者可以通过在设定的时间内未能通过身份验证来触发此漏洞，导致sshd以不安全的方式处理信号。这可能导致远程代码执行（RCE），攻击者获得root权限，或拒绝服务（DoS），使服务器不可用。

**有效性分析：**
从漏洞库信息、搜索结果和提供的PoC代码来看，该漏洞的PoC是存在的，并且被广泛讨论和利用。 搜索结果中提到“regreSSHion (CVE-2024-6387) is an unauthenticated RCE vulnerability in OpenSSH’s server, affecting glibc-based Linux systems. Full root access is granted.” 表明该漏洞有很高的潜在影响. PoC代码也试图绕过ASLR，并包含shellcode的占位符，表明攻击者可以注入恶意代码。

**投毒风险分析：**
提供的PoC代码具有一定的投毒风险，大约为10%。主要基于以下几点：
1.  **Shellcode占位符：** 代码中包含`unsigned char shellcode[] = "\x90\x90\x90\x90";`。虽然这只是一个占位符，需要用户替换为实际的shellcode，但攻击者可能发布包含恶意shellcode的版本，诱导用户使用。
2.  **GLIBC_BASES地址：**  代码中包含了`uint64_t GLIBC_BASES[] = { 0xb7200000, 0xb7400000 };`。这些地址是ASLR绕过的尝试，但如果攻击者故意提供错误的地址，可能导致利用失败或者其他未知的行为，但一般不会产生特别大的危害。
3.  **Timing参数：** 代码中需要根据目标系统响应调整Timing参数。攻击者可能提供不合适的参数，导致利用不稳定或者失败。
4.  **Heap Layout和文件结构偏移：**  代码注释中提到“Heap layout : Requires tweaking for different OpenSSH versions.” 和 “File structure offsets: Verify for the specific glibc version.”。攻击者可能故意提供错误的值，导致利用失败或者产生其他问题。

**利用方式：**
1.  **建立连接：** 攻击者首先需要与目标服务器的sshd服务建立TCP连接。
2.  **SSH握手：** 进行SSH握手，包括版本交换、密钥交换等步骤。PoC代码中的 `perform_ssh_handshake` 函数实现了这些步骤。
3.  **堆准备：** 通过发送特定的SSH数据包，在sshd进程的堆上分配内存，并控制堆的布局。`prepare_heap` 函数用于执行此操作。
4.  **时间计算：**  计算处理最终数据包所需的时间，用于后续的竞争条件利用。`time_final_packet` 函数用于执行此操作。
5.  **竞争条件利用：**  通过大量并发连接，触发sshd中的竞争条件漏洞。攻击者不断尝试进行身份验证，但故意失败，以触发SIGALRM信号处理程序。由于信号处理程序中使用了非异步信号安全的函数，可能导致内存损坏和代码执行。`attempt_race_condition` 函数用于执行此操作。
6.  **ASLR绕过：**  由于地址空间布局随机化（ASLR）的存在，攻击者需要知道glibc的基地址。PoC代码中包含了一组可能的基地址，并尝试逐个利用。
7.  **代码注入：** 成功利用竞争条件后，攻击者可以将恶意代码（shellcode）注入到sshd进程的内存中。占位符需要替换。
8.  **代码执行：**  执行注入的shellcode，从而获得服务器的root权限。

**项目地址:** [alex14324/ssh_poc2024](https://github.com/alex14324/ssh_poc2024)

**漏洞详情:** [CVE-2024-6387](https://nvd.nist.gov/vuln/detail/CVE-2024-6387)