## CVE-2021-4034 - polkit pkexec 本地提权

**漏洞编号:** CVE-2021-4034

**漏洞类型:** 本地提权

**影响应用:** polkit

**危害等级:** 高危，允许低权限用户获取root权限

**影响版本:** all (受影响版本)

**利用条件:** 本地用户能够执行 pkexec

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2021-4034 (PwnKit) 是 polkit 的 pkexec 工具中的一个本地提权漏洞。pkexec 是一个 setuid 工具，旨在允许非特权用户以特权用户身份运行命令，但需要预定义的策略。漏洞原因是 pkexec 没有正确处理调用参数的数量，最终试图将环境变量作为命令执行。攻击者可以通过构造特殊的环境变量，诱使 pkexec 执行任意代码，从而获得 root 权限。

**漏洞利用分析：**

提供的POC代码包含三个文件和一个目录：`ataque.c`、`vulner.c`、`GCONV_PATH=/config.txt` 和 `README.md`。

1.  **vulner.c:**  这个文件模拟了一个存在漏洞的程序。它接收命令行参数，尝试在 PATH 中查找它们，并使用 `g_printerr` 打印一个字符串。重要的是，它使用 `g_strdup` 和 `g_find_program_in_path` 函数，这些函数可能会受到环境变量的影响。
2.  **ataque.c:** 这个文件用于触发漏洞。它设置了几个环境变量（`PATH`，`CHARSET`，`SHELL`）并调用了 `vulner.out`（编译自 `vulner.c`）。关键的环境变量是 `PATH=GCONV_PATH=.` 和 `CHARSET=INTERNAL`。结合`GCONV_PATH=/config.txt`以及添加.在`GNCOV...` 目录后的步骤，攻击者利用 `GCONV_PATH` 指向当前目录，然后 polkit 会尝试使用当前目录中的 `gconv-modules` 文件加载字符编码转换器。攻击者可以将恶意代码放置在 `gconv-modules` 文件中，以便在加载时执行。
3.  **GCONV_PATH=/config.txt:** 这定义了一个环境变量，似乎旨在覆盖默认的 gconv 路径，但实际使用中 `/config.txt` 内容为空，利用点在 `ataque.c` 中定义 `PATH=GCONV_PATH=.`，结合README中提示的添加`.`步骤。攻击者通过设置`GCONV_PATH`为`.`,然后polkit在查找gconv module的时候会查找当前目录，然后执行恶意代码。
4.  **README.md:**  包含漏洞利用的简要说明, 添加`.`在`GNCOV...` 目录后是必要步骤。

**有效性：**
提供的代码利用了环境变量操作，结合漏洞描述和搜索结果，以及环境变量`GCONV_PATH`与`CHARSET`的设置，POC代码很可能是有效的。具体需要编译 `ataque.c` 和 `vulner.c`，并在易受攻击的系统上执行 `ataque.out`。

**投毒风险：**
  - 虽然这个POC的主要目的是展示CVE-2021-4034漏洞的利用，但是代码中存在潜在的投毒风险。例如，攻击者可以修改`vulner.c`或者`ataque.c`，在提权之前执行其他恶意操作，如安装后门、收集信息等。但是整体代码的功能还是以演示提权为主。
 - `GCONV_PATH=/config.txt` 中，`/config.txt`文件为空，攻击者可能在上传后通过某种方式向其中写入恶意代码,但这不属于本代码范畴。

因此，投毒的概率较低，大约是5%。投毒风险主要在于利用此漏洞进行提权时，攻击者可能会加入额外的恶意代码。

**利用方式总结：**

1.  利用`pkexec`的参数处理错误，通过设置特殊的环境变量来触发漏洞。
2.  `PATH=GCONV_PATH=.`和`CHARSET=INTERNAL`环境变量的组合至关重要。
3.  设置`GCONV_PATH`为`.`，然后放置恶意的`gconv-modules`文件，诱使pkexec加载并执行其中的代码，从而提升权限。

**项目地址:** [marcosChoucino/CVE-2021-4034](https://github.com/marcosChoucino/CVE-2021-4034)

**漏洞详情:** [CVE-2021-4034](https://nvd.nist.gov/vuln/detail/CVE-2021-4034)