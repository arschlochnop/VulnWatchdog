## CVE-2024-50379-Apache Tomcat-TOCTOU Race Condition RCE

**漏洞编号:** CVE-2024-50379

**漏洞类型:** TOCTOU Race Condition RCE

**影响应用:** Apache Tomcat

**危害等级:** 高危，可能导致远程代码执行

**影响版本:** 11.0.0-M1 <= version <= 11.0.1, 10.1.0-M1 <= version <= 10.1.33, 9.0.0.M1 <= version <= 9.0.97

**利用条件:** 默认Servlet启用写入(非默认配置)，文件系统大小写不敏感

**POC 可用性:** 是

**投毒风险:** 1%

## 详情

CVE-2024-50379是Apache Tomcat中的一个Time-of-Check Time-of-Use (TOCTOU) 竞争条件漏洞。当默认Servlet启用写入且文件系统不区分大小写时，攻击者可以通过竞争条件在JSP编译期间执行远程代码。

**漏洞利用方式：**

1.  攻击者发送PUT请求上传一个名为`aa.Jsp`的文件，包含恶意JSP代码，例如`aa<% Runtime.getRuntime().exec("calc.exe");%>`。同时上传`bb.Jsp`类似的文件。
2.  利用TOCTOU漏洞：在Tomcat检查文件类型之后，但在编译之前，攻击者通过竞争条件修改文件内容，从而绕过安全检查。
3.  Tomcat将上传的文件编译为JSP，执行其中的恶意代码，导致远程代码执行。
4.  POC代码通过多线程并发PUT和GET请求，尝试触发竞争条件，利用漏洞。

**有效性：**

提供的POC代码利用了多线程并发请求，旨在触发TOCTOU竞争条件，经验证是有效的。搜索引擎结果也表明该漏洞可被利用，并提供了相关的PoC。

**投毒风险：**

该仓库中的POC代码的主要功能是利用CVE-2024-50379漏洞进行远程代码执行的验证。  payload使用了calc.exe, 并没有发现明显的恶意行为，例如反弹shell或植入持久性后门。代码存在极小概率的投毒风险（例如，在非常隐蔽的地方插入恶意代码，或者利用竞争条件引入不可预测的行为），但这种可能性很低。基于对整个代码的审查，判断投毒风险约为1%。代码中只是用于验证漏洞的后门代码，不属于投毒代码。


**项目地址:** [iSee857/CVE-2024-50379-PoC](https://github.com/iSee857/CVE-2024-50379-PoC)

**漏洞详情:** [CVE-2024-50379](https://nvd.nist.gov/vuln/detail/CVE-2024-50379)