## CVE-2020-11651-SaltStack-Authentication Bypass and Remote Code Execution

**漏洞编号:** CVE-2020-11651

**漏洞类型:** Authentication Bypass and Remote Code Execution

**影响应用:** SaltStack

**危害等级:** 高危，可能导致服务器完全控制

**影响版本:** before 2019.2.4 and 3000 before 3000.2

**利用条件:** 需要网络访问Salt Master的4506端口

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2020-11651 存在于SaltStack Salt 2019.2.4之前和3000 3000.2之前的版本中。Salt-master进程的ClearFuncs类没有正确验证方法调用，允许未经身份验证的远程用户访问某些方法。这些方法可用于从salt master检索用户令牌，和/或在salt minions上运行任意命令。\n\n**漏洞利用方式：**\n1. **身份验证绕过：** 攻击者可以利用ClearFuncs类中未正确验证的方法，绕过身份验证。\n2. **信息泄露：** 绕过身份验证后，攻击者可以检索敏感信息，例如rootkey和用户token。\n3. **远程命令执行：** 攻击者可以使用检索到的令牌或利用其他未授权方法，在Salt Minion或者Master上执行任意命令。\n\n**POC代码分析：**\nPOC代码通过`salt.transport.client.ReqChannel`创建一个未加密的通信通道（`crypt="clear"`），绕过身份验证。然后，它使用此通道向Salt Master发送恶意构造的消息，利用未授权的方法执行命令。PoC中提供了ping，获取rootkey，在minion执行命令，在master执行命令，上传下载文件等功能。\n\n**投毒风险分析：**\nPoC代码本身主要功能是验证漏洞，但是存在一定的投毒风险。代码中使用了`pip`动态安装依赖库，这为潜在的供应链投毒打开了大门，虽然安装的是`salt`库。此外，`master`函数利用`cmd.exec_code`执行python代码，具有很高的权限，若攻击者修改代码，可以植入持久后门。经过分析，PoC中作者隐藏恶意代码的可能性为10%。主要依据是代码结构清晰，功能直接，虽然存在动态安装依赖，但安装的是salt官方库。主要风险在于使用者可能被其他恶意仓库替换，导致投毒。

**项目地址:** [0xc0d/CVE-2020-11651](https://github.com/0xc0d/CVE-2020-11651)

**漏洞详情:** [CVE-2020-11651](https://nvd.nist.gov/vuln/detail/CVE-2020-11651)