## CVE-2022-42889 - Apache Commons Text 远程代码执行

**漏洞编号:** CVE-2022-42889

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Apache Commons Text

**危害等级:** 高危，允许未经身份验证的攻击者执行任意命令。

**影响版本:** 1.5 <= version <= 1.9

**利用条件:** 应用程序使用受影响的Apache Commons Text版本，且允许用户可控的字符串传递给`StringSubstitutor`进行插值。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2022-42889，也被称为“Text4Shell”，是一个存在于Apache Commons Text库中的高危漏洞。该漏洞源于程序在处理用户提供的输入时，使用了不安全的默认插值器，允许攻击者利用`script`、`dns`和`url`等前缀执行任意代码或与远程服务器通信。

**有效性分析：**

提供的PoC代码看起来是有效的。它通过生成包含恶意payload的URL，来触发远程代码执行。payload利用了`script`、`url`、`dns`等lookup来执行命令。

**投毒风险分析：**

PoC代码存在轻微的投毒风险。主要风险点在于：

1.  **Payload下载地址：** 代码首先从`https://gist.githubusercontent.com/kljunowsky/97479082f50cd9219e80258f698c4d26/raw/7e600767bc59483653a34f17bd426340f28bf086/text4shell-payloads.txt` 下载payloads，如果该地址被篡改，可能会导致执行恶意代码。当然从payloads-final.txt的命名可以看出， payload还需要经过gau命令和grep命令过滤。风险降低。
2.  **外部命令执行：** 代码使用了`os.system` 来执行`wget`, `gau`, `qsreplace`, `ffuf` 命令。如果这些命令本身存在漏洞或者被替换为恶意程序，也可能导致攻击。
3. **Collaborator URL：** 此PoC会默认将流量导向id.burpcollaborator.com，若此域名被劫持，则存在一定的安全隐患。

综上，投毒风险约为10%。

**利用方式：**

1.  **确定目标：** 确定目标应用程序使用了受影响的Apache Commons Text版本（1.5 <= version <= 1.9），并且允许用户控制的字符串传递给`StringSubstitutor`进行插值处理。
2.  **构造Payload：** 使用`script`、`dns`或`url`等前缀构造恶意payload，例如：
    *   `${script:javascript:java.lang.Runtime.getRuntime().exec('command')}`
    *   `${url:UTF-8:java.lang.Runtime.getRuntime().exec('command')}`
    *   `${dns:address:java.lang.Runtime.getRuntime().exec('command')}`
3.  **传递Payload：** 将构造好的payload作为输入传递给目标应用程序。这可能通过URL参数、POST请求数据、或其他任何应用程序接受用户输入的地方。
4.  **触发执行：** 当应用程序使用`StringSubstitutor`对包含payload的字符串进行插值处理时，payload中的命令将被执行，从而实现远程代码执行。

**缓解措施：**

*   升级到Apache Commons Text 1.10.0或更高版本。
*   禁用或删除不安全的插值器（`script`、`dns`、`url`）。
*   对用户输入进行严格的验证和过滤。

**项目地址:** [kljunowsky/CVE-2022-42889-text4shell](https://github.com/kljunowsky/CVE-2022-42889-text4shell)

**漏洞详情:** [CVE-2022-42889](https://nvd.nist.gov/vuln/detail/CVE-2022-42889)