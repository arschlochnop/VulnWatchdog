## CVE-2020-0796 (SMBGhost) 远程代码执行漏洞

**漏洞编号:** CVE-2020-0796

**漏洞类型:** 远程代码执行

**影响应用:** Microsoft Windows SMBv3

**危害等级:** 高危，远程代码执行，蠕虫级

**影响版本:** Windows 10 Version 1903/1909, Windows Server Version 1903/1909

**利用条件:** 目标系统开启SMBv3服务，且未安装相关补丁

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2020-0796（SMBGhost）是一个存在于Microsoft Server Message Block 3.1.1 (SMBv3) 协议处理特定请求方式中的远程代码执行漏洞。由于SMBv3压缩功能中处理数据包时存在的整数溢出漏洞，未经身份验证的攻击者可以通过向目标SMBv3服务器发送特制的压缩数据包来触发此漏洞，导致远程代码执行。此漏洞是“wormable”的，意味着它具有自我传播的能力。提供的PoC代码包含利用此漏洞的Python脚本。 

**有效性：**
根据漏洞库信息和搜索结果，CVE-2020-0796是一个严重漏洞，并且存在公开可用的PoC利用代码。提供的PoC代码（`exploit.py`）旨在利用SMBGhost漏洞在目标系统上执行任意代码。Readme文件说明了该PoC的实验性质，提示其可能不稳定并可能导致蓝屏死机(BSOD)，建议仅用于教育目的。搜索引擎结果也表明存在可用的PoC，CISA警告称未打补丁的系统容易受到攻击。因此，提供的PoC代码在特定条件下（目标系统未打补丁且满足版本要求）被认为是有效的。

**投毒风险：**
分析`exploit.py`的代码，发现其中包含一段用于在内核中执行的Shellcode（`KERNEL_SHELLCODE`）。这段Shellcode是经过编码的，其具体功能需要进一步分析，但从代码结构上来看，它具有修改内核内存的能力。虽然代码注释说明USER_PAYLOAD可以替换，且最大600字节，这看起来像是给用户自定义的空间。但整个利用过程中存在利用内核漏洞执行任意shellcode的操作，因此存在潜在的风险。

*   `lznt1.py` 包含`compress` 和 `compress_evil` 函数，`compress_evil` 用于制造损坏的压缩数据，这是漏洞利用的关键，并非后门，而是触发漏洞的手段。 
*   Shellcode 部分，直接硬编码，存在被替换的可能，但替换成恶意shellcode的可能也存在，取决于使用者。 

总的来说，投毒风险较低，但使用者仍然需要仔细审查和理解代码，防止被恶意利用。考虑到PoC作者的警告和代码本身潜在的不稳定性，以及Shellcode可能被替换为恶意载荷的风险，我将投毒风险评估为10%。

**利用方式：**
利用方式主要包含以下几个步骤：

1.  **SMB协议协商：** 使用`smb_negotiate`函数与目标系统进行SMB协议协商，确定双方使用的协议版本和参数。
2.  **SMB压缩：** 使用`smb_compress` 函数构造恶意的压缩数据包，其中包含特制的头部信息和经过`lznt1.compress_evil`压缩的数据。`compress_evil`函数用于故意生成错误或损坏的压缩数据，以触发漏洞。
3.  **漏洞触发：** 将构造好的压缩数据包发送到目标系统的SMB服务，触发CVE-2020-0796漏洞，导致整数溢出，覆盖内核内存。
4.  **内存覆盖：** 利用漏洞覆盖`HalpInterruptController` 表中的 `HalpApicRequestInterrupt` 函数指针。将此指针替换为Shellcode的地址，使得中断发生时跳转到Shellcode执行。
5.  **Shellcode执行：** 预先准备好的Shellcode被执行，通常用于提权或执行其他恶意操作，例如反弹shell。脚本中修改了KUSER_SHARED_DATA PTE的NX位，使其可执行，然后将shellcode写入内存。


**项目地址:** [lisinan988/CVE-2020-0796-exp](https://github.com/lisinan988/CVE-2020-0796-exp)

**漏洞详情:** [CVE-2020-0796](https://nvd.nist.gov/vuln/detail/CVE-2020-0796)