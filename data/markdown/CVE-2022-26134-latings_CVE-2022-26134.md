## CVE-2022-26134-Atlassian Confluence OGNL 注入远程代码执行

**漏洞编号:** CVE-2022-26134

**漏洞类型:** 远程代码执行

**影响应用:** Atlassian Confluence Server 和 Data Center

**危害等级:** 高危，未经身份验证的攻击者可以执行任意代码。

**影响版本:** 1.3.0 < version < 7.4.17, 7.13.0 < version < 7.13.7, 7.14.0 < version < 7.14.3, 7.15.0 < version < 7.15.2, 7.16.0 < version < 7.16.4, 7.17.0 < version < 7.17.4, 7.18.0 < version < 7.18.1

**利用条件:** 需要目标Confluence服务器开放网络访问。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2022-26134 是一个存在于 Atlassian Confluence Server 和 Data Center 中的 OGNL 注入漏洞。根据漏洞库信息，未经身份验证的攻击者可以利用此漏洞在 Confluence 服务器或数据中心实例上执行任意代码。受影响的版本包括从 1.3.0 到 7.4.17，以及 7.13.0 到 7.18.1 之间的一些版本。

**有效性分析：**
根据搜索引擎结果，该漏洞存在活跃利用，且有多个安全厂商发布了关于此漏洞的分析和检测方法。提供的POC代码 `CVE-2022-26134.py` 通过构造包含恶意 OGNL 表达式的 URL，尝试在目标服务器上执行 `id` 命令，并通过 `X-Cmd-Response` header 返回执行结果。如果返回结果包含 `uid=`，则判断漏洞存在。这个POC代码可以有效验证漏洞的存在。

**投毒风险分析：**
检查提供的 POC 代码后，发现代码主要功能是发送包含 OGNL 表达式的 HTTP 请求来验证漏洞。`requests.get` 函数用于发送请求，并且设置了用户代理，header信息。虽然POC中发送的OGNL表达式可以执行任意命令，但是当前提供的代码是为了验证漏洞而执行`id`命令，其本身不具备长期驻留或者维持权限的能力。同时，该POC并没有发现明显的文件写入、修改等恶意操作，初步判断不存在直接的恶意投毒行为。但由于OGNL注入本身可以执行任意代码，如果被滥用，可能导致服务器被植入恶意软件。因此，认为存在较低的投毒风险，可能性为10%。

**利用方式：**
该漏洞的利用方式是通过构造恶意的HTTP请求，该请求包含OGNL表达式，目标Confluence服务器在处理请求时，由于未对OGNL表达式进行充分的过滤，导致OGNL表达式被执行，从而实现远程代码执行。具体来说，POC中使用了如下的payload:

```
/%24%7B%28%23a%3D%40org.apache.commons.io.IOUtils%40toString%28%40java.lang.Runtime%40getRuntime%28%29.exec%28%22id%22%29.getInputStream%28%29%2C%22utf-8%22%29%29.%28%40com.opensymphony.webwork.ServletActionContext%40getResponse%28%29.setHeader%28%22X-Cmd-Response%22%2C%23a%29%29%7D/
```
这个payload通过OGNL表达式执行`id`命令，并将结果写入HTTP Response Header中。攻击者可以修改`exec()`中的命令，执行任意代码。

**结论：**
该漏洞是一个严重的安全问题，允许未经身份验证的远程代码执行。提供的POC代码可以有效验证漏洞的存在，但潜在的投毒风险较低，主要风险在于攻击者可能利用该漏洞植入恶意软件。建议尽快升级Confluence版本到安全版本。

**项目地址:** [latings/CVE-2022-26134](https://github.com/latings/CVE-2022-26134)

**漏洞详情:** [CVE-2022-26134](https://nvd.nist.gov/vuln/detail/CVE-2022-26134)