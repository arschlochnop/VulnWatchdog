## CVE-2020-11651-SaltStack-身份验证绕过和远程代码执行

**漏洞编号:** CVE-2020-11651

**漏洞类型:** 身份验证绕过/远程代码执行

**影响应用:** SaltStack Salt

**危害等级:** 高危，可能导致数据泄露和远程代码执行，完全控制受影响的Salt Master和Minion

**影响版本:** < 2019.2.4, 3000 < 3000.2, 2017.*, 2018.*

**利用条件:** 需要网络访问Salt Master的4505和4506端口

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2020-11651 是 SaltStack Salt 中存在的一个身份验证绕过漏洞。Salt Master 进程中的 ClearFuncs 类未能正确验证方法调用，导致未经身份验证的远程用户可以访问某些方法。通过利用这些方法，攻击者可以从 Salt Master 检索用户令牌，以及/或者在 Salt Minion 上执行任意命令。

**有效性：**

根据漏洞描述和提供的 PoC 代码，可以确定该漏洞的 PoC 代码是有效的。漏洞库信息和搜索结果都表明该漏洞是可被利用的，并且存在公开可用的 PoC 代码。

**投毒风险：**

在提供的 PoC 代码中，投毒风险较低。 代码的主要目的是验证漏洞的存在，并执行一些简单的操作，例如读取文件和写入文件。尽管代码中包含文件读取和写入操作，但这些操作都是为了验证漏洞是否存在，而不是为了植入恶意代码。但是，在实际利用中，如果攻击者使用该 PoC 代码，可以修改代码来执行恶意操作，例如下载和执行恶意软件，或者修改系统配置。因此，在使用该 PoC 代码时，需要谨慎，并采取必要的安全措施。
仔细分析代码，发现其通过 `salt.transport.client.ReqChannel.factory` 创建了一个未加密的通信通道（`crypt='clear'`），这本身是漏洞利用的一部分，而非恶意投毒。`check_CVE_2020_11652_write1`函数试图写入 `/tmp/salt_CVE_2020_11652` 文件，并在成功写入后删除该文件。这部分代码是在测试写入权限，虽然存在潜在的利用可能，但主要目的仍然是漏洞验证。
总体来看，该PoC的主要目的是验证漏洞的存在，而非实施恶意攻击。但是，需要注意，任何漏洞利用代码都可能被恶意修改和利用。

**利用方式：**

1.  **未授权访问：** 攻击者利用 ClearFuncs 类中的身份验证绕过漏洞，无需身份验证即可与 Salt Master 进行通信。
2.  **信息泄露：** 攻击者可以利用未经授权的访问来检索敏感信息，例如用户令牌和 Salt Master 的配置信息。
3.  **任意文件读取：** 攻击者可以通过 `file_roots.read` wheel 函数读取 Salt Master 上的任意文件。
4.  **任意文件写入：** 攻击者可以通过 `file_roots.write` 或 `config.update_config` wheel 函数在 Salt Master 上写入任意文件。
5.  **远程代码执行：** 攻击者可以利用文件写入漏洞来执行任意代码。例如，攻击者可以写入恶意 Salt 状态文件，然后使用 Salt Master 将其应用到 Salt Minion，从而在 Salt Minion 上执行任意命令。

攻击者通常通过以下步骤利用此漏洞：

1.  建立与目标 Salt Master 的未授权连接。
2.  利用 CVE-2020-11651 绕过身份验证。
3.  利用 CVE-2020-11652 读取敏感文件（例如 Salt Master 的 root key）。
4.  使用 root key 执行任意 wheel 函数，例如 `file_roots.write` 来写入恶意文件，或 `config.update_config` 来修改 Salt Master 的配置。
5.  在 Salt Minion 上执行任意命令。

**项目地址:** [hardsoftsecurity/CVE-2020-11651-PoC](https://github.com/hardsoftsecurity/CVE-2020-11651-PoC)

**漏洞详情:** [CVE-2020-11651](https://nvd.nist.gov/vuln/detail/CVE-2020-11651)