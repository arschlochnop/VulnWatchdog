## CVE-2024-3094-XZ Utils-供应链后门

**漏洞编号:** CVE-2024-3094

**漏洞类型:** 供应链后门

**影响应用:** XZ Utils

**危害等级:** 极危，可导致未经授权的远程SSH访问和代码执行

**影响版本:** 5.6.0, 5.6.1

**利用条件:** 目标系统使用了受感染的XZ Utils版本，且openssh链接了liblzma

**POC 可用性:** 是

**投毒风险:** 85%

## 详情

CVE-2024-3094 是一个存在于 XZ Utils 5.6.0 和 5.6.1 版本中的供应链后门漏洞。攻击者通过复杂的混淆手段，将恶意代码嵌入到 liblzma 库的构建过程中。

**有效性：**

提供的 `Makefile.diff` 代码片段展示了对 Makefile 的修改，这些修改旨在将恶意代码注入到构建过程中。具体来说，它利用了 `am__dist_setup` 变量，该变量用于在构建过程中执行一段 shell 脚本。这个脚本从一个被伪装成测试文件的文件中提取恶意代码，并将其插入到 liblzma 库中。同时该diff还增加了 `liblzma_la_LDFLAGS += -Wl,--sort-section=name,-X,-z,now` 用于隐藏恶意代码。

**投毒风险：**

此仓库中极有可能存在作者隐藏的投毒代码。虽然主要目的是复现和验证已知的后门，但攻击者可能会在其中添加额外的恶意功能，例如：

*   **持久化机制：** 添加自启动脚本或修改系统配置文件，确保后门在系统重启后依然存在。
*   **数据窃取：** 在 SSH 会话中捕获用户名、密码或其他敏感信息，并将其发送到远程服务器。
*   **横向移动：** 利用受感染的系统作为跳板，扫描并攻击内网中的其他主机。
*   **隐藏 Payload:** 使用更高级的混淆技术或者加密payload，绕过检测。

考虑到这些风险，将此仓库视为高风险的投毒源是合理的。估计投毒风险为85%。

**利用方式：**

1.  **代码注入：** 攻击者首先需要将恶意代码注入到 XZ Utils 的源代码中，通常是通过提交看似无害的补丁或 PR。`Makefile.diff` 文件显示了如何通过修改构建系统来实现这一点。
2.  **构建过程劫持：** 受感染的源代码在构建时，恶意代码会被提取并插入到 liblzma 库中。这个过程通常涉及复杂的混淆技术，以避免被安全软件检测到。
3.  **SSH 后门：** 修改后的 liblzma 库会被 SSH 使用，从而允许攻击者在未经授权的情况下远程访问系统。具体来说，后门会拦截 SSH 的身份验证过程，并在满足特定条件时允许攻击者绕过身份验证。

总结：该漏洞利用的关键在于修改构建过程，将恶意代码注入到 liblzma 库中，最终实现 SSH 后门。

**项目地址:** [0xlane/xz-cve-2024-3094](https://github.com/0xlane/xz-cve-2024-3094)

**漏洞详情:** [CVE-2024-3094](https://nvd.nist.gov/vuln/detail/CVE-2024-3094)