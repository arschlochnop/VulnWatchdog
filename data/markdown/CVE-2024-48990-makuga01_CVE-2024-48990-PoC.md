## CVE-2024-48990-needrestart-权限提升

**漏洞编号:** CVE-2024-48990

**漏洞类型:** 权限提升

**影响应用:** needrestart

**危害等级:** 高危，本地用户可以提升到root权限

**影响版本:** < 3.8

**利用条件:** 本地用户可以执行命令，且目标系统安装了受影响版本的needrestart

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2024-48990 漏洞允许本地攻击者通过操纵 `PYTHONPATH` 环境变量，欺骗 `needrestart` 运行 Python 解释器，从而以 root 权限执行任意代码。  

**利用方式：**

1.  **创建恶意 Python 模块：** 创建一个包含恶意代码的 Python 模块 (例如，`importlib/__init__.so`，使用C编写，设置SUID权限复制shell到/tmp/poc).
2.  **设置 PYTHONPATH：** 将 `PYTHONPATH` 环境变量设置为指向包含恶意 Python 模块的目录。
3.  **触发 needrestart：** 触发 `needrestart` 命令的执行 (通常由系统更新或其他事件触发)。
4.  **代码执行：** 当 `needrestart` 执行 Python 解释器时，由于 `PYTHONPATH` 被篡改，恶意 Python 模块将被加载并执行，从而以 root 权限执行任意代码。

**POC 分析：**

*   `start.sh` 脚本首先创建 `importlib` 目录，然后编译 `lib.c` 到 `importlib/__init__.so`。这个C代码会被编译成动态链接库,且包含SUID权限提升的操作.
*   `lib.c` 文件包含 C 代码，其构造函数 `a()` 会设置 uid 和 gid 为 0 (root)，并复制 `/bin/sh` 到 `/tmp/poc`，并设置 SUID 位。这意味着任何用户运行 `/tmp/poc` 都会以 root 权限执行。
*   `e.py` 脚本只是一个等待脚本，循环检查 `/tmp/poc` 是否存在，一旦存在就执行它。
*   `start.sh` 脚本设置 `PYTHONPATH` 并运行 `e.py`，当 `needrestart` 运行时，它会加载 `importlib/__init__.so`，从而执行恶意代码。

**有效性：**

提供的 POC 代码有效，如果目标系统上运行的 `needrestart` 版本低于 3.8，并且攻击者能够控制 `PYTHONPATH` 环境变量，该 POC 能够成功提升权限。

**投毒风险：**

此仓库中没有发现隐藏的投毒代码。提供的代码目的是为了复现漏洞并提供利用方式。`lib.c` 的目的是创建SUID权限的shell，这是为了在利用成功后得到一个root shell。这些操作是漏洞利用的一部分，而不是隐藏的恶意行为。

**项目地址:** [makuga01/CVE-2024-48990-PoC](https://github.com/makuga01/CVE-2024-48990-PoC)

**漏洞详情:** [CVE-2024-48990](https://nvd.nist.gov/vuln/detail/CVE-2024-48990)