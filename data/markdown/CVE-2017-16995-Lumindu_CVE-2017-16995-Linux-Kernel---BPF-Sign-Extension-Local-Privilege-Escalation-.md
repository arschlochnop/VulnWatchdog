## CVE-2017-16995-Linux Kernel-BPF 整数溢出

**漏洞编号:** CVE-2017-16995

**漏洞类型:** 整数溢出

**影响应用:** Linux Kernel

**危害等级:** 高危，可能导致内存破坏和权限提升

**影响版本:** through 4.4

**利用条件:** 需要本地用户权限，开启 BPF_SYSCALL 配置

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2017-16995 存在于Linux kernel 4.4版本及以前的`kernel/bpf/verifier.c` 文件中的`check_alu_op` 函数中。该漏洞是由于不正确的符号扩展导致本地用户可以利用此漏洞导致拒绝服务（内存损坏）或可能产生未指定的其他影响。

**有效性：**
根据漏洞信息和搜索结果，此漏洞是真实存在的，并且有多个可用的利用程序(Exploit-DB)。提供的POC代码尝试利用此漏洞进行本地权限提升。代码通过BPF程序实现，通过socket进行触发，并利用内存读写原语修改当前进程的cred结构，从而获取root权限。总体来说，该POC代码的思路与已知的利用方式一致，因此可以判断该POC代码是有效的。

**投毒风险：**
从提供的POC代码来看，代码主要包含以下几个部分：

1.  **BPF 程序定义 (`__prog`)**: 这段代码定义了实际运行在内核中的 BPF 指令。指令序列设计用于触发漏洞并提供内存读写能力。
2.  **BPF 程序加载和 Map 创建 (`bpf_prog_load`, `bpf_create_map`)**: 这些函数用于将 BPF 程序加载到内核并创建 BPF map，map 用于内核和用户空间之间的数据交换。
3.  **内存读写原语 (`__read`, `__write`)**:  这些函数使用 BPF map 和加载的 BPF 程序来读取和写入任意内核内存。
4.  **权限提升 (`pwn`)**: 该函数利用内存读写原语定位并修改当前进程的 `cred` 结构，将其 UID、GID 等设置为 0，从而获取 root 权限。

分析代码逻辑，没有发现明显的恶意后门或隐藏的非预期行为。不过，由于 BPF 本身的复杂性，以及代码中涉及的内核地址硬编码 (如 `PHYS_OFFSET`, `CRED_OFFSET`, `UID_OFFSET`)，可能存在以下潜在风险：

*   **依赖特定内核版本和配置**:  硬编码的地址和偏移量可能只在特定内核版本和配置下有效。如果目标环境不匹配，利用可能失败，甚至导致内核崩溃。
*   **调试和错误处理不足**: 代码中的错误处理比较简单，如果利用过程中出现错误，可能无法提供足够的信息进行调试。
*   **安全风险**:  即使代码本身没有恶意行为，成功利用漏洞仍然会导致系统权限被提升，存在潜在的安全风险。

综合以上分析，该POC代码本身没有明显的投毒代码，但由于 BPF 利用的特殊性，存在一定的环境依赖性和潜在的安全风险。判定投毒风险为5%。

**利用方式：**
利用方式可以概括为以下步骤：

1.  **创建 BPF Map 和加载 BPF 程序**:  使用 `bpf_create_map` 创建一个 BPF map，用于用户空间和内核空间的数据交换。使用 `bpf_prog_load` 将精心构造的 BPF 程序加载到内核。
2.  **建立 Socket 连接**: 创建一个 socketpair，并将加载的 BPF 程序附加到 socket 上。这样，当 socket 收到数据时，BPF 程序就会被触发执行。
3.  **构造内存读写原语**: BPF 程序被设计成可以读取和写入任意内核内存。利用 BPF map 和 socket 通信，在用户空间构造出内存读写原语。
4.  **查找 Task_struct 和 Cred 结构**: 首先通过获得栈指针（SP）和帧指针（FP），然后通过在栈上读取数据，找到当前进程的 `task_struct` 结构。
5.  **修改 Cred 结构**: 利用内存写原语，找到 `task_struct` 中的 `cred` 字段，然后将 `cred` 结构中的 UID、GID 等权限相关的字段修改为 0，从而获取 root 权限。

总的来说，该漏洞利用的复杂性在于构造能够绕过 BPF 验证器的恶意程序，并利用该程序实现任意内核内存的读写，最终修改进程权限。

**项目地址:** [Lumindu/CVE-2017-16995-Linux-Kernel---BPF-Sign-Extension-Local-Privilege-Escalation-](https://github.com/Lumindu/CVE-2017-16995-Linux-Kernel---BPF-Sign-Extension-Local-Privilege-Escalation-)

**漏洞详情:** [CVE-2017-16995](https://nvd.nist.gov/vuln/detail/CVE-2017-16995)