## CVE-2024-4577-PHP-CGI参数注入

**漏洞编号:** CVE-2024-4577

**漏洞类型:** 远程代码执行

**影响应用:** PHP

**危害等级:** 高危，可能导致远程代码执行和服务器完全控制

**影响版本:** PHP 8.1.* before 8.1.29, 8.2.* before 8.2.20, 8.3.* before 8.3.8

**利用条件:** Windows 系统，PHP 以 CGI 模式运行，开启了使用 "Best Fit" 策略的代码页。

**POC 可用性:** 是

**投毒风险:** 50%

## 详情

CVE-2024-4577 是一个存在于 Windows 系统上 PHP-CGI 模式下的远程代码执行漏洞。当系统配置为使用某些代码页时，Windows 可能会使用 "Best-Fit" 行为来替换传递给 Win32 API 函数的命令行参数中的字符。PHP CGI 模块可能会错误地将这些字符解释为 PHP 选项，从而允许恶意用户将选项传递给正在运行的 PHP 二进制文件，进而导致泄露源代码、执行任意 PHP 代码，甚至执行系统命令。

**利用方式：**
攻击者通过构造包含恶意 PHP 选项的 URL，利用 Windows 的 "Best-Fit" 字符转换特性，将这些选项注入到 PHP-CGI 的命令行参数中。常见的利用方式包括：

*   `allow_url_include=1` 和 `auto_prepend_file=php://input`： 允许包含远程文件，并将 POST 数据作为 PHP 代码执行，实现 RCE。

**漏洞利用代码分析：**
提供的 Go 和 Python 代码均用于批量检测目标是否存在 CVE-2024-4577 漏洞。它们通过发送包含 `allow_url_include` 和 `auto_prepend_file` 选项的恶意 HTTP 请求，然后检查响应中是否包含 `PHP Version` 字符串来判断目标是否受到攻击影响。

**投毒风险分析：**
Go 代码中存在一个名为 `nFPfVl()` 的函数，该函数看起来像是混淆的代码。通过反混淆，可以发现它尝试执行一个下载并执行恶意脚本的命令。这段代码存在明显的投毒风险，因为它会在目标机器上执行未经授权的操作，成功率为50%。

**项目地址:** [fabulouscounc/CVE-2024-4577-PHP-RCE](https://github.com/fabulouscounc/CVE-2024-4577-PHP-RCE)

**漏洞详情:** [CVE-2024-4577](https://nvd.nist.gov/vuln/detail/CVE-2024-4577)