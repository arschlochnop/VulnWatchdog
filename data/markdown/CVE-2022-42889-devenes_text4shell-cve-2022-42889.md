## CVE-2022-42889-Apache Commons Text-RCE

**漏洞编号:** CVE-2022-42889

**漏洞类型:** 远程代码执行(RCE)

**影响应用:** Apache Commons Text

**危害等级:** 高危，可能导致服务器被完全控制

**影响版本:** 1.5 <= version <= 1.9

**利用条件:** 应用程序使用了受影响版本的Apache Commons Text，且允许用户可控的输入传递给使用了不安全插值默认值的文本处理函数。

**POC 可用性:** 是

**投毒风险:** 1%

## 详情

该漏洞存在于Apache Commons Text 1.5到1.9版本中，由于默认启用的StringLookup实例存在安全问题，允许攻击者在应用程序处理用户提供的字符串时执行任意代码。

**有效性：**

根据提供的漏洞信息、搜索结果和漏洞利用代码，该漏洞的利用是有效的。漏洞利用代码（Dockerfile、README.md、pom.xml）提供了一个可运行的示例，展示了如何利用该漏洞执行任意命令。

**投毒风险：**

该POC代码的主要目的是演示CVE-2022-42889漏洞的利用。Dockerfile构建了一个包含漏洞的Java应用程序，README.md提供了运行和测试该应用程序的说明，pom.xml则定义了Maven项目的依赖和构建配置。尽管POC代码本身是为了演示漏洞，潜在的投毒风险极低（约1%）。

**利用方式：**

1.  **漏洞原理：** Apache Commons Text 存在变量插值功能，允许动态评估和扩展属性。受影响版本中，默认启用的 `script`、`dns` 和 `url` 等 StringLookup 实例允许执行任意代码、解析 DNS 记录或加载 URL。如果应用程序允许用户控制输入，则可能遭受远程代码执行攻击。
2.  **攻击步骤：**
    a.  部署包含漏洞的应用程序。
    b.  向应用程序发送包含恶意payload的请求。Payload利用 `${prefix:name}` 格式，其中 `prefix` 是 `script`、`dns` 或 `url`，`name` 包含要执行的恶意代码。
    c.  服务器处理请求，执行payload，导致远程代码执行。
3.  **示例payload：**
    `${script:javascript:java.lang.Runtime.getRuntime().exec('touch /tmp/foo')}`

此payload使用 `script` 前缀执行 JavaScript 代码，调用 `java.lang.Runtime.getRuntime().exec()` 执行 `touch /tmp/foo` 命令，在目标服务器上创建 `/tmp/foo` 文件。

**缓解措施：**

*   升级到 Apache Commons Text 1.10.0 或更高版本，该版本默认禁用有问题的插值器。
*   禁用或限制应用程序中使用的不安全 StringLookup 实例。
*   对用户提供的输入进行严格的验证和清理，以防止恶意payload注入。

**项目地址:** [devenes/text4shell-cve-2022-42889](https://github.com/devenes/text4shell-cve-2022-42889)

**漏洞详情:** [CVE-2022-42889](https://nvd.nist.gov/vuln/detail/CVE-2022-42889)