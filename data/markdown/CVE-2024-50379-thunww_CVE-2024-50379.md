## CVE-2024-50379-Apache Tomcat-TOCTOU RCE

**漏洞编号:** CVE-2024-50379

**漏洞类型:** TOCTOU竞态条件导致的远程代码执行

**影响应用:** Apache Tomcat

**危害等级:** 高危，可能导致服务器完全控制

**影响版本:** 11.0.0-M1 <= version <= 11.0.1, 10.1.0-M1 <= version <= 10.1.33, 9.0.0.M1 <= version <= 9.0.97

**利用条件:** 默认Servlet配置为可写（非默认配置），运行在大小写不敏感的文件系统上。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-50379 是 Apache Tomcat 中的一个 TOCTOU（Time-of-check Time-of-use）竞态条件漏洞。此漏洞存在于 JSP 编译过程中，当 Tomcat 的默认 servlet 启用写入时（非默认配置），允许在大小写不敏感的文件系统上实现 RCE（远程代码执行）。

**漏洞利用方式：**

1.  **上传包含恶意JSP代码的文件：** 攻击者通过PUT请求上传一个以".Jsp"结尾的文件，该文件包含一个反向shell的JSP payload。注意这里的文件名是".Jsp"，首字母大写，是为了绕过某些检查。
2.  **竞态条件：** 攻击者利用并发PUT和GET请求，尝试在Tomcat检查文件扩展名和实际编译执行JSP代码之间的时间窗口内，触发竞态条件。
3.  **远程代码执行：** 如果竞态条件成功，Tomcat会将上传的文件作为JSP编译并执行，从而执行攻击者上传的恶意代码（反向shell）。

**POC代码分析：**

*   Python脚本使用`requests`库发送HTTP请求，使用`concurrent.futures`库创建线程池并发发送PUT和GET请求。
*   PUT请求上传包含恶意JSP代码的文件，目标URL为`{target_url}/{filename}.Jsp`。
*   GET请求尝试访问上传的文件，目标URL为`{target_url}/{filename}.jsp` (注意大小写)。
*   JSP payload建立与攻击者指定IP和端口的反向shell连接，从而允许攻击者远程控制服务器。

**投毒风险评估：**

此仓库中存在投毒代码的风险较低，约为10%。主要考虑因素如下：

*   **README.md中的免责声明：**  虽然README.md中声明代码仅用于研究和教育目的，但不能完全排除恶意意图。
*   **Payload的复杂性：** 虽然JSP payload本身就是一个恶意代码，但它明确指定了攻击者的IP地址和端口。这使得payload更容易被检测和分析，降低了隐藏恶意代码的可能性。
*   **仓库的活跃度：**  看起来这是一个个人项目，readme内容还未完成，作者可能会加入其他恶意代码的可能性无法排除。

**有效性：**

提供的PoC代码应该是有效的，因为它利用了已知的漏洞利用方法，并且利用了并发来增加竞态条件成功的机会。然而，成功利用此漏洞取决于目标Tomcat实例的配置（默认servlet是否可写）和文件系统的大小写敏感性。攻击者需要在运行POC前，将JSP Payload中的IP地址更换成自己的IP地址，并监听4444端口，才能成功拿到shell.

**项目地址:** [thunww/CVE-2024-50379](https://github.com/thunww/CVE-2024-50379)

**漏洞详情:** [CVE-2024-50379](https://nvd.nist.gov/vuln/detail/CVE-2024-50379)