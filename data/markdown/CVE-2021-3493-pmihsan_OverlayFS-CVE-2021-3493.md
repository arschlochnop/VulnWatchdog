## CVE-2021-3493-Ubuntu OverlayFS 本地提权

**漏洞编号:** CVE-2021-3493

**漏洞类型:** 本地提权

**影响应用:** Linux Kernel (Ubuntu)

**危害等级:** 高危，本地用户可提升至 root 权限

**影响版本:** Ubuntu kernel versions: < 5.8.0-50.56 (5.8 kernel), < 5.4.0-72.80 (5.4 kernel), < 4.15.0-142.146 (4.15 kernel), < 4.4.0-209.241 (4.4 kernel)

**利用条件:** 需要在存在漏洞的 Ubuntu 系统上执行，并且允许 unprivileged user namespaces 和 overlay mounts。

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2021-3493 漏洞存在于 Linux 内核的 overlayfs 实现中。由于对用户命名空间中底层文件系统文件 capabilities 的验证不足，攻击者可以通过创建恶意的 overlayfs 文件系统，利用 setxattr 设置文件 capabilities，从而获得提升的权限。

**利用方式：**

1.  **环境准备：** 创建 overlayfs 所需的目录结构 (lower, upper, work, merge)。
2.  **Namespace 创建：** 创建新的 user namespace 和 mount namespace，隔离权限。
3.  **权限设置：** 修改 uid_map 和 gid_map，使得在 user namespace 中拥有 root 权限。
4.  **Overlayfs Mount：** 使用 overlayfs mount 命令将 lowerdir, upperdir, workdir 挂载到 mergedir。
5.  **Capabilities 设置：** 复制自身程序到 merge 目录，并使用 `setxattr` 函数为复制后的程序设置 capabilities (CAP_SETUID, CAP_SETGID, CAP_DAC_OVERRIDE 等)。
6.  **权限提升：** 执行 merge 目录下的程序，此时程序将以 root 权限运行。

**有效性：**

提供的 POC 代码通过利用 overlayfs 漏洞，可以成功地提升权限。POC 代码首先创建必要的目录结构，然后创建一个新的 user namespace 和 mount namespace，接着挂载 overlayfs 文件系统，并使用 `setxattr` 函数为文件设置 capabilities。最后，执行该文件即可获得 root 权限。

**投毒风险：**

分析 POC 代码，没有发现明显的恶意代码，例如反弹 shell、安装后门等。代码逻辑主要集中在利用 overlayfs 漏洞提权，并没有额外的操作来植入恶意程序。因此，投毒风险较低，可以认为是 0%。参考的 vulnerability description 和 exploit 代码都着重于提权，而没有提到任何投毒行为。

**项目地址:** [pmihsan/OverlayFS-CVE-2021-3493](https://github.com/pmihsan/OverlayFS-CVE-2021-3493)

**漏洞详情:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)