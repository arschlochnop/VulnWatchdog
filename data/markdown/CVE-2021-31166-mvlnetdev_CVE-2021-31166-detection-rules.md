## CVE-2021-31166 HTTP Protocol Stack Remote Code Execution Vulnerability

**漏洞编号:** CVE-2021-31166

**漏洞类型:** 远程代码执行

**影响应用:** Windows HTTP.sys

**危害等级:** 高危，可导致远程代码执行，完全控制受影响系统

**影响版本:** Windows 10 Version 2004, Windows Server version 2004, Windows 10 Version 20H2, Windows Server version 20H2（受影响版本低于特定Build版本）

**利用条件:** 需要攻击者能够发送特制的HTTP请求到受影响的服务器，目标服务器开启了IIS、WinRM或WSDAPI服务。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-31166 是一个HTTP协议栈远程代码执行漏洞，存在于 Windows HTTP.sys 中。攻击者可以通过发送特制的 HTTP 请求利用此漏洞，成功利用此漏洞的攻击者可以在目标系统上执行任意代码。根据漏洞信息，受影响的组件包括IIS，WinRM，WSDAPI。从提供的漏洞利用代码来看，其目的是通过 Zeek (Bro) 网络安全监控工具检测 CVE-2021-31166 的利用行为。该代码本身是一段 Zeek 脚本，用于分析网络流量，并检测包含特定恶意模式（`/[^[:space:]]+,[[:space:]]{0,},$/`，在`ACCEPT-ENCODING`头中）的 HTTP 请求。当检测到匹配的请求时，脚本会记录一个通知。此外，该脚本还会监控受攻击主机是否出现TCP重传过多的情况，这可能表明目标主机崩溃或拒绝服务。因此该Zeek脚本本身不能用于直接攻击目标，而是用于检测攻击行为。

**有效性：**  提供的代码本身是检测规则，并不是直接利用漏洞的 PoC 代码。但是，它依赖于初始 PoC（参考了 `https://github.com/0vercl0k/CVE-2021-31166`），所以间接证明了漏洞的可利用性。

**投毒风险：**  由于该代码主要是检测规则，因此直接的投毒风险较低。潜在的风险可能在于，如果攻击者能够控制 Zeek 脚本的部署环境，他们可以修改脚本以忽略某些恶意流量，或者触发误报，从而干扰安全监控。但是，从代码本身来看，并没有明显的恶意代码或后门。因此，投毒风险较低，估算为10%。脚本中存在可配置项，例如 `learn_iis_webservers` 和 `iis_websubnets`，如果配置不当可能会导致检测范围错误，但这些属于配置问题，而非投毒。

**利用方式：**
1.  攻击者需要向目标服务器发送包含特制 `Accept-Encoding` 头的 HTTP 请求，该请求的 `Accept-Encoding` 头的格式需要匹配正则表达式 `/[^[:space:]]+,[[:space:]]{0,},$/`。
2.  成功利用该漏洞可能导致远程代码执行，攻击者可以在目标系统上执行任意代码。
3.  受影响的服务包括 IIS，WinRM，WSDAPI。
4. 提供的Zeek脚本用于检测利用漏洞的流量模式，但不能直接利用该漏洞。

**项目地址:** [mvlnetdev/CVE-2021-31166-detection-rules](https://github.com/mvlnetdev/CVE-2021-31166-detection-rules)

**漏洞详情:** [CVE-2021-31166](https://nvd.nist.gov/vuln/detail/CVE-2021-31166)