## CVE-2016-6662 - MySQL 本地权限提升/远程代码执行

**漏洞编号:** CVE-2016-6662

**漏洞类型:** 配置覆盖/本地权限提升/远程代码执行

**影响应用:** MySQL, MariaDB, Percona Server

**危害等级:** 高危，允许本地用户创建任意配置并绕过某些保护机制，最终导致以 root 权限执行任意代码

**影响版本:** MySQL through 5.5.52, 5.6.x through 5.6.33, and 5.7.x through 5.7.15; MariaDB before 5.5.51, 10.0.x before 10.0.27, and 10.1.x before 10.1.17; and Percona Server before 5.5.51-38.1, 5.6.x before 5.6.32-78.0, and 5.7.x before 5.7.14-7

**利用条件:** 需要具备对 MySQL 数据库一定的写入权限（如通过 SQL 注入）

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2016-6662 漏洞允许攻击者通过设置 `general_log_file` 到 `my.cnf` 配置文件来创建任意配置，从而绕过某些保护机制。更进一步，通过设置 `malloc_lib` 选项，可以加载恶意动态链接库，最终导致以 root 权限执行任意代码。

**利用方式：**

1.  **前提条件：** 攻击者需要通过某种方式（例如 SQL 注入）获取对 MySQL 数据库的写入权限。
2.  **写入恶意配置：**  攻击者利用 SQL 注入漏洞，将 `general_log_file` 设置为一个精心构造的 `my.cnf` 配置文件路径，该配置文件中包含恶意的 `malloc_lib` 选项。
3.  **上传恶意动态链接库：**  攻击者将包含恶意代码的动态链接库（`mysql_hookandroot_lib.so`）上传到服务器上的某个可写目录（如 `/var/lib/mysql/`）。
4.  **触发漏洞：**  攻击者通过触发 MySQL 的日志功能，使 MySQL 加载并解析恶意的 `my.cnf` 配置文件，从而加载恶意动态链接库。
5.  **代码执行：**  恶意动态链接库中的代码被执行，攻击者获得 root 权限。

**POC 代码分析：**

提供的 Python 脚本 `From SQL injection to root shell.py` 实现了上述利用流程：

*   `craft_payloads()` 函数生成用于利用漏洞的 SQL 注入 payload。
*   该函数首先创建恶意触发器，该触发器将恶意配置写入 `my.cnf` 文件。
*   然后，该函数将恶意动态链接库 `mysql_hookandroot_lib.so` 的内容写入服务器上的文件。
*   最后，该函数创建 `poctable` 表，并通过插入数据来触发恶意触发器，从而执行代码。

**有效性：**

根据漏洞描述和提供的 POC 代码，该漏洞利用方法是有效的，只要满足利用条件（例如可写权限和特定 MySQL 版本）。

**投毒风险：**

该 POC 代码的主要目的是利用漏洞，但存在一定的投毒风险。 虽然大部分代码是为了验证和利用漏洞，但攻击者可能会在 `mysql_hookandroot_lib.so` 中添加后门或其他恶意功能，从而在成功利用漏洞后保持对系统的长期访问。 这里的投毒风险评估为10%, 主要体现在`mysql_hookandroot_lib.so` 恶意动态链接库上，如果该链接库被替换成具有其他恶意功能的链接库，则可能造成危害。


**项目地址:** [MAYASEVEN/CVE-2016-6662](https://github.com/MAYASEVEN/CVE-2016-6662)

**漏洞详情:** [CVE-2016-6662](https://nvd.nist.gov/vuln/detail/CVE-2016-6662)