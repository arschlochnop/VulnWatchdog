## CVE-2022-0847 Dirty Pipe 本地提权漏洞

**漏洞编号:** CVE-2022-0847

**漏洞类型:** 本地提权

**影响应用:** Linux Kernel

**危害等级:** 高危，可导致普通用户提升为 root 权限

**影响版本:** Linux Kernel 5.8 及更高版本，直至修复版本

**利用条件:** 需要本地用户权限

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2022-0847，又名 Dirty Pipe，是一个 Linux 内核中的本地提权漏洞。该漏洞源于 pipe_buffer 结构中的 "flags" 成员变量未正确初始化。未授权的本地用户可以利用此漏洞写入由只读文件支持的页面缓存中的页面，从而提升他们在系统上的权限。

**漏洞利用方式：**

1.  **准备 Pipe：** 创建一个 pipe，其中 pipe_inode_info 环上的所有 "bufs" 都设置了 PIPE_BUF_FLAG_CAN_MERGE 标志。这是通过先完全填充 pipe，然后再清空它来实现的。
2.  **泄露页面缓存引用：** 通过 splice() 系统调用，从目标文件偏移量之前的一个字节处拼接一个字节到 pipe 中。这会向页面缓存添加一个引用，但 copy_page_to_iter_pipe() 不会初始化 "flags"，PIPE_BUF_FLAG_CAN_MERGE 标志仍然存在。
3.  **覆盖页面缓存：** 通过 write() 系统调用，将恶意数据写入 pipe。由于 PIPE_BUF_FLAG_CAN_MERGE 标志已设置，因此写入操作不会创建新的 pipe_buffer，而是会直接写入页面缓存，从而覆盖只读文件的内容。

**POC代码分析：**

提供的 Shell 脚本包含以下步骤：

1.  创建 exp.c，这是一个利用 Dirty Pipe 漏洞的 C 程序。
2.  编译 exp.c 以生成 exp 可执行文件。
3.  备份 /etc/passwd 文件到 /tmp/passwd。
4.  使用 ./exp 程序，通过 Dirty Pipe 漏洞修改 /etc/passwd 文件。修改的内容是将 "root:x" 替换为 "oot:"，这意味着删除了 root 账户的密码哈希值，从而允许无需密码即可切换到 root 账户。
5.  脚本尝试恢复原始的 /etc/passwd 文件。

**有效性评估：**

此 POC 代码利用了 Dirty Pipe 漏洞来修改 /etc/passwd 文件，从而实现本地提权。该方法在受影响的内核版本上是有效的。

**投毒风险评估：**

虽然该脚本主要目的是利用漏洞进行提权，但仍存在一些潜在的投毒风险：

1.  **覆盖重要文件：** 该脚本直接修改 /etc/passwd 文件，这是一个关键的系统文件。如果利用过程中出现任何错误，可能会导致系统不稳定或无法启动。
2.  **su root 后的操作不可控：** 脚本在提权后直接执行了 `su root`。这可能导致攻击者在获取 root 权限后执行任意恶意操作。 脚本尝试恢复原文件,但是恢复本身是否成功,以及恢复文件是否被替换都是一个未知数。
3.  **备份/恢复机制的潜在风险：** 虽然脚本尝试备份和恢复 /etc/passwd，但备份文件本身可能被篡改，或者恢复过程可能失败。导致未授权的root权限长期存在。
4.  **残留痕迹：** 即使脚本成功恢复了 /etc/passwd，攻击者也可能留下其他后门或痕迹，以便以后再次利用系统。
5.  **依赖关系：** 该脚本依赖于 gcc 等工具，如果目标系统缺少这些工具，则脚本将无法执行。

基于以上分析，认为存在5%的投毒风险，主要是由于脚本修改关键系统文件，su root 之后的操作不可控，并且依赖于备份/恢复机制，如果这些机制存在问题，则可能导致系统不稳定或被进一步利用。

**项目地址:** [xsxtw/CVE-2022-0847](https://github.com/xsxtw/CVE-2022-0847)

**漏洞详情:** [CVE-2022-0847](https://nvd.nist.gov/vuln/detail/CVE-2022-0847)