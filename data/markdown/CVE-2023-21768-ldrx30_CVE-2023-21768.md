## CVE-2023-21768-Windows Ancillary Function Driver for WinSock Elevation of Privilege

**漏洞编号:** CVE-2023-21768

**漏洞类型:** 权限提升

**影响应用:** Windows Ancillary Function Driver (AFD)

**危害等级:** 高危，允许本地用户以SYSTEM权限执行任意代码

**影响版本:** Windows Server 2022 (版本介于 10.0.20348.0 和 10.0.20348.1487 之间，不包括 10.0.20348.1487)；Windows 11 21H2 (版本介于 10.0.0 和 10.0.22000.1455 之间，不包括 10.0.22000.1455)；Windows 11 22H2 (版本介于 10.0.22621.0 和 10.0.22621.1105 之间，不包括 10.0.22621.1105)

**利用条件:** 需要本地访问权限。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2023-21768是一个Windows AFD（Ancillary Function Driver for WinSock）驱动中的权限提升漏洞。攻击者可以利用此漏洞在受影响的系统上以SYSTEM权限执行任意代码。

**有效性：**
根据搜索结果和漏洞利用代码，存在可用的POC，并且已经有利用代码在Github上公开（https://github.com/Malwareman007/CVE-2023-21768）。因此，该漏洞的利用是有效的。

**投毒风险：**
提供的漏洞利用代码（CVE-2023-21768.md）主要包含漏洞分析和补丁diff信息，并没有直接的恶意代码。 然而，由于该漏洞利用代码的最终目标是提升权限，具有极高的潜在危害性。从信息安全角度出发，虽然POC本身不包含明显的恶意代码，但是攻击者可能使用包含恶意代码的自定义POC来利用此漏洞，因此不能完全排除投毒风险。基于以上信息，仓库中直接包含投毒代码的概率较低，推测投毒风险为10%。

**利用方式：**
利用方式主要包括以下几个步骤：

1.  **漏洞定位：**  该漏洞存在于afd.sys驱动中，通过分析补丁可以发现漏洞修复的关键点是增加了一个`ProbeForWrite`的验证。
2.  **IOCTL调用：**  可以通过`DeviceIoControl`进行通信，也可以使用 `NtDeviceIoControlFile` 控制代码直接发送到指定的设备驱动程序。漏洞存在于`AfdFastIoDeviceControl` 和 `AfdDispatchDeviceControl`中，通过`AfdIoctlTable`表找到对应IOCTL。
3.  **触发漏洞：** 通过构造特定的IOCTL请求，绕过验证，导致内核中的指针解引用错误，从而实现任意地址写入。
4.  **权限提升：**  通过任意地址写入，攻击者可以修改内核数据结构，劫持控制流，最终提升权限到SYSTEM。

**项目地址:** [ldrx30/CVE-2023-21768](https://github.com/ldrx30/CVE-2023-21768)

**漏洞详情:** [CVE-2023-21768](https://nvd.nist.gov/vuln/detail/CVE-2023-21768)