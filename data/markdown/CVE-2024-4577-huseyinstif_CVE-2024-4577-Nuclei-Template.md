## CVE-2024-4577 PHP CGI Argument Injection

**漏洞编号:** CVE-2024-4577

**漏洞类型:** 远程代码执行

**影响应用:** PHP

**危害等级:** 高危，可能导致服务器被完全控制

**影响版本:** PHP 8.1.* before 8.1.29, 8.2.* before 8.2.20, 8.3.* before 8.3.8 (Windows, CGI mode)

**利用条件:** Windows服务器，以CGI模式运行PHP，并启用了使用"Best Fit"策略的代码页。

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2024-4577 是一个PHP CGI参数注入漏洞，存在于Windows上以CGI模式运行的PHP版本中。当系统配置为使用某些代码页时，Windows可能会使用"Best-Fit"行为来替换传递给Win32 API函数的命令行中的字符。PHP CGI模块可能会错误地将这些字符解释为PHP选项，从而允许恶意用户将选项传递给正在运行的PHP二进制文件，从而泄露脚本的源代码或在服务器上执行任意PHP代码。

**有效性：**
根据漏洞库信息、搜索引擎结果以及提供的Nuclei模板，该漏洞利用的有效性较高。搜索引擎结果显示，该漏洞在公开后不久就观察到了大量的利用尝试，并且有可用的PoC代码。

**投毒风险：**
Nuclei模板本身主要用于漏洞检测，其目的是验证目标是否存在CVE-2024-4577漏洞。模板中的Payload会尝试通过在URL中注入`allow_url_include`和`auto_prepend_file`参数来包含并执行PHP代码。这里利用`php://input`伪协议。模板会检查返回的内容是否包含`md5("CVE_2024_4577_TEST")`的结果来确认漏洞是否存在。代码本身并不包含明显的恶意代码，而是尝试去检测是否存在漏洞，判定投毒风险为5%主要是考虑到这个yaml文件会被攻击者利用.

**利用方式：**
1.  **环境准备：** 目标服务器需要是Windows系统，并且PHP以CGI模式运行。
2.  **发送恶意请求：** 攻击者构造包含恶意参数的HTTP请求。核心是利用URL中的特殊字符，结合Windows的Best-Fit字符转换特性，注入额外的PHP配置参数。
3.  **参数注入：** 注入`allow_url_include=1`和`auto_prepend_file=php://input`。`allow_url_include=1`允许包含远程文件，`auto_prepend_file=php://input`会将POST请求体的内容作为PHP代码执行。
4.  **执行任意代码：**  通过POST请求体传递要执行的PHP代码。

该漏洞利用的关键在于利用Windows系统的字符转换行为，以及PHP CGI对命令行参数解析的缺陷。攻击者通过构造特定的URL，可以将任意PHP代码注入到服务器并执行。

**项目地址:** [huseyinstif/CVE-2024-4577-Nuclei-Template](https://github.com/huseyinstif/CVE-2024-4577-Nuclei-Template)

**漏洞详情:** [CVE-2024-4577](https://nvd.nist.gov/vuln/detail/CVE-2024-4577)