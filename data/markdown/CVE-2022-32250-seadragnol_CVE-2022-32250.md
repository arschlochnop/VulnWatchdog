## CVE-2022-32250-Linux Kernel netfilter Use-After-Free

**漏洞编号:** CVE-2022-32250

**漏洞类型:** Use-After-Free

**影响应用:** Linux Kernel

**危害等级:** 高危，本地用户提权至root

**影响版本:** <= 5.18.1

**利用条件:** 需要创建user/net namespaces的能力

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2022-32250 是 Linux Kernel netfilter 子系统 nf_tables_api.c 中的一个 use-after-free 漏洞。漏洞存在于 5.18.1 之前的 Linux kernel 中。 具有创建 user/net 命名空间权限的本地用户可以利用此漏洞将权限提升为 root，因为不正确的 NFT_STATEFUL_EXPR 检查会导致 use-after-free。

**有效性：**
提供的漏洞利用代码是有效的，因为：
*   漏洞库信息和搜索引擎结果均表明该漏洞存在并且可以被利用。
*   存在公开的漏洞利用代码，并且有博客文章详细描述了利用过程。
*   README.md 文件中说明了测试内核版本 (5.13) 和成功率 (~70%)。

**投毒风险：**
存在一定的投毒风险。虽然代码的目的是利用 CVE-2022-32250，但仍然存在恶意修改代码的可能，以达到其他目的，如植入后门或进行拒绝服务攻击。`ex.sh`脚本复制一些未知文件（x, dummy）到/tmp 目录，虽然脚本中对它们进行了执行，但这些文件的具体内容和作用未知，存在潜在的风险。

Makefile 中使用了 `-static -no-pie` 选项, 虽然可以提高漏洞利用的稳定性，但也可能增加攻击者在编译时嵌入恶意代码的难度. exploit.c 中的`fuse_spray.h`，意味着使用了fuse喷射技术，利用了`fuse_spray.c`文件。而fuse喷射技术的可靠性与文件系统状态相关，也可能存在一定的失败概率. 代码中还包含`monke.c`，但未包含代码内容，也存在潜在的风险

基于上述分析，投毒风险评估为 10%。

**利用方式：**
1.  **环境准备：** 设置 user 和 network 命名空间，这通常需要 root 权限或者具有 CAP_SYS_ADMIN 能力。
2.  **漏洞触发：** 创建一个 netfilter 表、链和集合，并配置状态表达式。漏洞是由于 NFT_STATEFUL_EXPR 的不正确检查导致的，会造成 UAF。
3.  **堆喷射（Heap Spray）：** 利用 FUSE 进行堆喷射，将可控数据填充到释放的内存区域，以便在 UAF 发生时覆盖该内存，从而控制程序流程。
4.  **权限提升：** 覆盖的内存内容被构造为指向恶意代码或执行特定操作，最终将权限提升为 root。`ex.sh`中执行`monke`以及`dummy`有可能是触发提权的操作。其中`dummy`可能用来占据内存，`monke`是最终提权的payload。

总体而言，这是一个复杂的漏洞利用，需要对 Linux 内核、netfilter 和堆管理机制有深入的理解。

**项目地址:** [seadragnol/CVE-2022-32250](https://github.com/seadragnol/CVE-2022-32250)

**漏洞详情:** [CVE-2022-32250](https://nvd.nist.gov/vuln/detail/CVE-2022-32250)