## CVE-2021-31166 - HTTP Protocol Stack Remote Code Execution

**漏洞编号:** CVE-2021-31166

**漏洞类型:** 远程代码执行

**影响应用:** Windows HTTP.sys

**危害等级:** 高危，可能导致系统完全控制

**影响版本:** Windows 10 Version 2004, Windows Server version 2004, Windows 10 Version 20H2, Windows Server version 20H2，版本低于 10.0.19041.982 和 10.0.19042.982

**利用条件:** 需要目标服务器开启HTTP服务，且攻击者可以发送HTTP请求

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-31166 是一个 HTTP 协议栈远程代码执行漏洞，存在于 Windows 的 http.sys 组件中。攻击者可以通过发送特制的 HTTP 请求，触发 use-after-free 漏洞，从而在目标系统上执行任意代码。

**漏洞利用有效性：**

根据漏洞库信息和漏洞利用代码，该漏洞的利用是可行的。CISA已将此漏洞添加到已知被利用的漏洞目录中，表明该漏洞已经被攻击者利用。提供的漏洞利用代码是一个 Terraform 脚本，用于搭建一个包含易受攻击的 Windows 服务器的测试环境。攻击者可以利用该环境进行漏洞验证和利用。漏洞利用代码中使用了特定的 `Accept-Encoding` 头来触发漏洞。

**投毒风险：**

该仓库的投毒风险较低，约为10%。虽然 Terraform 脚本用于部署基础架构，但攻击向量主要集中在特定的HTTP请求头。以下几点降低了投毒风险：
* 代码主要用于自动化部署环境，方便复现漏洞。
* 攻击Payload 通过特殊的HTTP头部注入，较为明显,容易识别。
* 仓库目的是为了演示漏洞利用，并提供了 WAF 规则进行防御。

仍然存在一些小的风险：
* Terraform配置可能包含未知的配置错误，导致部署的环境存在额外的安全隐患。
* 在实际利用过程中，攻击者可能修改 Payload 来绕过检测。

**漏洞利用方式：**

1.  **环境搭建：** 使用 Terraform 脚本搭建包含易受攻击的 Windows Server 的测试环境。
2.  **发送恶意请求：** 向目标服务器发送包含特定 `Accept-Encoding` 头的 HTTP 请求，例如 `Accept-Encoding: doar-e, ftw, imo, ,`。
3.  **触发漏洞：** 恶意请求会触发 http.sys 中的 use-after-free 漏洞。
4.  **执行代码：** 成功触发漏洞后，攻击者可以在目标系统上执行任意代码，获得系统控制权。

**缓解措施：**

*   安装 Microsoft 提供的安全更新。
*   部署 WAF 规则来阻止包含恶意 `Accept-Encoding` 头的请求。
*   监控 HTTP 请求，检测异常的 `Accept-Encoding` 头。

**项目地址:** [bgsilvait/WIn-CVE-2021-31166](https://github.com/bgsilvait/WIn-CVE-2021-31166)

**漏洞详情:** [CVE-2021-31166](https://nvd.nist.gov/vuln/detail/CVE-2021-31166)