## CVE-2022-22947-Spring Cloud Gateway-代码注入

**漏洞编号:** CVE-2022-22947

**漏洞类型:** 代码注入

**影响应用:** Spring Cloud Gateway

**危害等级:** 高危，可能导致远程代码执行

**影响版本:** 3.1.x prior to 3.1.1+, 3.0.x prior to 3.0.7+ and all old and unsupported versions

**利用条件:** Gateway Actuator endpoint is enabled, exposed and unsecured

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2022-22947是Spring Cloud Gateway中的一个代码注入漏洞。当Gateway Actuator endpoint启用、公开且未进行安全保护时，攻击者可以通过构造恶意请求，在远程主机上执行任意代码。根据提供的漏洞利用代码，该PoC利用了SpEL表达式注入，通过向`/actuator/gateway/routes/check01`端点发送包含恶意SpEL表达式的POST请求，然后刷新路由并访问该路由，触发SpEL表达式执行。EXP具有单个目标验证、批量验证、反弹shell的功能。

**有效性：**
根据漏洞库信息、搜索结果和提供的漏洞利用代码，可以判断该漏洞的PoC代码是有效的。搜索结果中多个链接都表明该漏洞被广泛关注，且存在公开的利用代码。

**投毒风险：**
PoC代码本身主要通过SpEL表达式注入执行命令，没有发现明显的恶意植入行为。但PoC会向目标系统添加路由，并执行命令，存在一定的风险。例如：
*   **资源消耗：** 频繁的路由添加和删除可能导致资源消耗，影响服务性能。
*   **命令执行风险：** 虽然PoC本身是为了验证漏洞，但如果被恶意利用，可能执行恶意命令。
*   **依赖风险：** PoC可能依赖特定的环境或库，如果目标环境不满足要求，可能导致利用失败或产生其他问题。
PoC代码中存在投毒代码的可能性较低，大约10%。这个百分比是基于代码的分析以及PoC作者的动机推断得出的。

**利用方式：**
1.  **前提条件：** Spring Cloud Gateway的Actuator端点已启用、公开且未进行安全保护。
2.  **发送恶意请求：** 构造包含恶意SpEL表达式的JSON数据，并将其作为POST请求发送到`/actuator/gateway/routes/check01`端点。
3.  **刷新路由：** 向`/actuator/gateway/refresh`端点发送POST请求，刷新路由，使新增的路由生效。
4.  **触发表达式执行：** 访问新增的路由，触发SpEL表达式执行，从而执行任意代码。
5.  **清理路由：** 删除新增的路由，避免留下后门。（PoC代码中包含删除路由的步骤）

**项目地址:** [anansec/CVE-2022-22947_EXP](https://github.com/anansec/CVE-2022-22947_EXP)

**漏洞详情:** [CVE-2022-22947](https://nvd.nist.gov/vuln/detail/CVE-2022-22947)