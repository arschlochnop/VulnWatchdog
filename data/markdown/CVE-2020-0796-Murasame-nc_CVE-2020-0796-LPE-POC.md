## CVE-2020-0796 (SMBGhost) 本地提权漏洞

**漏洞编号:** CVE-2020-0796

**漏洞类型:** 本地提权

**影响应用:** Microsoft Windows SMBv3

**危害等级:** 高危，可能导致系统权限提升

**影响版本:** Windows 10 Version 1903/1909, Windows Server version 1903/1909

**利用条件:** 目标系统存在SMBGhost漏洞且攻击者已经获得本地权限

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

该漏洞(CVE-2020-0796，又名SMBGhost)是SMBv3协议在处理特定请求时存在远程代码执行漏洞。此提供的POC代码尝试利用此漏洞进行本地权限提升。从代码分析来看，它首先与目标系统进行SMB协议协商，然后利用特制的压缩数据包触发漏洞，最终尝试将当前进程的令牌替换为SYSTEM令牌，从而实现提权。投毒风险评估为10%，主要基于以下几点考虑：

1.  **缺少错误处理**: 代码中`inject`函数存在hProc未进行错误判断,存在进程注入失败的风险.
2.  **硬编码**: 代码中存在硬编码的地址 `0x1FF2FFFFBC`，这可能针对特定版本的Windows有效，如果目标系统版本不匹配，利用可能失败。 此外,winlogon.exe注入的shellcode代码缺失。
3.  **依赖性**: 代码依赖于特定的`ntos.h`文件，如果文件内容被篡改，可能导致意外行为。
4.  **功能不完整**: 提供的代码片段只包含了提权的部分逻辑，缺乏完整的攻击链，这意味着可能需要其他的辅助模块才能成功利用。

虽然存在上述风险，但代码的主要目标是实现本地提权，没有明显的恶意代码，因此投毒风险相对较低。

**利用方式:**

1.  **协议协商:**  首先，客户端与服务器建立SMB连接，协商SMB协议版本等参数，确保使用SMBv3协议。
2.  **构造恶意数据包:**  利用SMBv3压缩功能的漏洞，构造包含特定格式和大小的压缩数据包。`OriginalCompressedSegmentSize`字段会被设置为一个很大的值，导致后续解压过程中发生缓冲区溢出。
3.  **触发漏洞:**  将构造好的恶意数据包发送给目标服务器。
4.  **权限提升:** 漏洞触发后，通过覆盖内存中的关键数据，例如当前进程的访问令牌，将其替换为SYSTEM用户的令牌，从而获得SYSTEM权限。  本POC 通过 `get_handle_addr` 函数泄露内核地址，之后通过特定内存地址覆盖来替换当前进程的token从而达到提权的目的。
5.  **Winlogon注入（未完成）:** 代码尝试向winlogon.exe进程中注入shellcode。winlogon.exe是Windows系统的关键进程，负责用户登录和会话管理。但是，提供的代码片段并未给出shellcode的具体内容，因此无法确定具体功能，这部分代码可能存在潜在的风险。

**项目地址:** [Murasame-nc/CVE-2020-0796-LPE-POC](https://github.com/Murasame-nc/CVE-2020-0796-LPE-POC)

**漏洞详情:** [CVE-2020-0796](https://nvd.nist.gov/vuln/detail/CVE-2020-0796)