## CVE-2020-0796 SMBGhost 远程代码执行漏洞

**漏洞编号:** CVE-2020-0796

**漏洞类型:** 远程代码执行

**影响应用:** Microsoft Windows SMBv3

**危害等级:** 高危，可能导致远程代码执行和系统控制

**影响版本:** Windows 10 Version 1903, 1909, Windows Server, version 1903, 1909 (Server Core installation)

**利用条件:** 目标系统需要启用SMBv3协议并且未安装相应的安全补丁。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2020-0796，又名SMBGhost，是一个存在于Microsoft Server Message Block 3.1.1 (SMBv3) 协议处理特定请求方式中的远程代码执行漏洞。此漏洞影响Windows 10版本1903和1909以及Windows Server的相应版本。由于漏洞的“wormable”特性，它具有在网络中自我传播的潜力，危害极大。

**有效性评估：**
根据漏洞库信息和搜索结果，此漏洞是一个高危漏洞，并且存在公开可用的PoC代码。搜索结果中的链接指向了多个PoC利用代码，CISA也发布了警告，表明存在被利用的风险。提供的漏洞利用代码包含一个README文件，详细描述了如何使用该PoC，以及如何针对目标环境调整偏移量。总体来看，PoC的有效性较高，只要目标系统满足漏洞利用条件，就有可能被成功利用。

**投毒风险评估：**
提供的代码包括`calc_target_offsets.bat`、`smbghost_kshellcode_x64.asm`和`SMBleedingGhost.py` (未提供完整代码). `calc_target_offsets.bat`脚本用于在目标系统上计算偏移量，虽然需要在目标系统执行，但其目的是为了获取特定版本的内存地址偏移，这本身不是投毒行为。`smbghost_kshellcode_x64.asm`包含shellcode，负责在内核中执行恶意代码。虽然shellcode本身是攻击的一部分，但它是由攻击者控制的，不应视作作者投毒。 仓库中提供的`README.md`需要使用ncat建立反向shell。`SMBleedingGhost.py` 是主利用脚本，其行为受到参数控制，本身不会主动引入恶意代码。但是如果 `SMBleedingGhost.py` 被修改，例如在其中硬编码恶意payload，则存在投毒的可能。假设 `SMBleedingGhost.py` 是一个已经审核过的安全脚本，则投毒风险较低。

基于代码分析，虽然攻击本身带有恶意行为，但作者直接隐藏投毒代码的概率较低，故投毒风险估计为10%。

**利用方式分析：**
1.  **漏洞触发：** 攻击者通过构造特制的SMBv3协议请求，利用SMBv3压缩功能中的缓冲区溢出漏洞。具体而言，当SMBv3处理压缩数据时，如果解压后的数据大于分配的缓冲区，就会发生缓冲区溢出，覆盖相邻的内存区域。
2.  **信息泄露 (SMBleed):**  攻击者利用溢出读取相邻内存,泄露内核地址等重要信息,绕过地址空间布局随机化 (ASLR)。
3.  **代码执行：** 攻击者利用泄露的内核地址信息,将shellcode注入到内核中执行。提供的`smbghost_kshellcode_x64.asm`文件包含x64架构的shellcode，该shellcode负责执行提权操作。
4.  **反向Shell:** Shellcode的功能通常包括建立反向shell，从而允许攻击者远程控制目标系统。
5.  **偏移量计算：**由于内核地址的随机化，攻击者需要先计算目标系统上关键内核对象的偏移量。`calc_target_offsets.bat`脚本的作用就是自动化这个过程，它使用Windows调试工具(CDB)和DUMPBIN来分析`srvnet.sys`和`ntoskrnl.exe`，从而获得需要的偏移量。
6.  **PoC利用步骤：**
    *   在目标机器上运行`calc_target_offsets.bat`，获取偏移量。
    *   使用ncat监听特定端口，准备接收反向shell。
    *   运行`SMBleedingGhost.py`，指定目标IP地址、反向shell IP地址和端口。

**总结：**
CVE-2020-0796是一个严重的远程代码执行漏洞，利用难度较低，危害性高。攻击者可以利用此漏洞完全控制未打补丁的Windows系统。

**项目地址:** [orangmuda/CVE-2020-0796](https://github.com/orangmuda/CVE-2020-0796)

**漏洞详情:** [CVE-2020-0796](https://nvd.nist.gov/vuln/detail/CVE-2020-0796)