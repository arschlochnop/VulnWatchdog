## CVE-2023-1389 - TP-Link Archer AX21 Command Injection

**漏洞编号:** CVE-2023-1389

**漏洞类型:** 命令注入

**影响应用:** TP-Link Archer AX21 (AX1800)

**危害等级:** 高危，允许未经身份验证的远程代码执行

**影响版本:** 1.1.4 Build 20230219之前的固件版本

**利用条件:** 需要与目标路由器在同一网络或可路由的网络，目标路由器Web管理界面开放

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2023-1389 存在于TP-Link Archer AX21路由器的Web管理界面。该漏洞位于`/cgi-bin/luci/;stok=/locale`端点的country表单的write操作中。`country`参数没有经过充分的过滤，导致攻击者可以通过构造恶意的POST或GET请求，向popen()函数注入命令，这些命令将以root权限执行，无需身份验证。

**有效性：**

提供的POC代码(`archer-file-transfer.py` 和 `archer-rev-shell.py`)利用了该漏洞。根据代码和漏洞描述，POC能够成功执行任意命令。 搜索结果也表明该漏洞已被广泛利用。

**投毒风险：**

在`archer-file-transfer.py`文件中，存在利用`os.system` 执行 `nc` 命令的行为，如果攻击者的服务器被攻破，那么会导致路由请求的地址被劫持，执行恶意代码。因为这个库的流行性所以有被投毒的可能性，但代码本身并没有明显的投毒行为，因此投毒的风险较低，估计为5%。 风险主要来自其依赖的第三方服务器安全问题。

**利用方式：**

1.  攻击者发送特制的HTTP POST或GET请求到`/cgi-bin/luci/;stok=/locale`端点，其中`form`参数设置为`country`，`operation`设置为`write`，并且在`country`参数中注入恶意命令。
2.  由于`country`参数未经过滤，注入的命令会被传递给`popen()`函数执行，从而实现远程代码执行。
3.  `archer-file-transfer.py`通过将命令的输出重定向到`/tmp/out`文件，然后使用`nc`将文件内容传输到攻击者的机器。
4.  `archer-rev-shell.py` 建立一个反向shell 连接， 允许攻击者直接控制路由器。
5.  利用需要发送两次请求才能完成命令执行。

**总结：**

该漏洞的利用非常简单，只需要发送构造好的HTTP请求即可。由于该漏洞无需身份验证，且影响范围较广，因此风险极高。建议用户尽快升级到最新固件。

**项目地址:** [Voyag3r-Security/CVE-2023-1389](https://github.com/Voyag3r-Security/CVE-2023-1389)

**漏洞详情:** [CVE-2023-1389](https://nvd.nist.gov/vuln/detail/CVE-2023-1389)