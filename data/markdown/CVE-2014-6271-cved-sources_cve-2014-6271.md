## CVE-2014-6271-ShellShock

**漏洞编号:** CVE-2014-6271

**漏洞类型:** 远程代码执行

**影响应用:** Bash

**危害等级:** 高危，可能导致远程代码执行和系统控制

**影响版本:** <= 4.3

**利用条件:** 目标系统存在CGI脚本或使用OpenSSH的ForceCommand功能等

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2014-6271，又称ShellShock，是一个存在于GNU Bash中的远程代码执行漏洞。漏洞源于Bash在处理环境变量中函数定义后的trailing strings的方式存在缺陷，允许攻击者通过构造恶意的环境变量来执行任意代码。

**1. 有效性：**

提供的Dockerfile构建了一个存在ShellShock漏洞的环境。`test.cgi`脚本被放置在`/usr/local/apache2/cgi-bin/`目录下，并且赋予了执行权限。该脚本会输出`/usr/bin/env`的内容，攻击者可以通过构造包含恶意代码的环境变量，并发送HTTP请求访问该CGI脚本，从而触发漏洞并执行恶意代码。因此提供的POC代码是有效的。

**2. 投毒风险：**

分析Dockerfile和相关文件：

*   Dockerfile：用于构建Docker镜像，升级Bash到4.3，并应用patch。
*   README.md：包含关于漏洞的信息以及镜像的来源。
*   `build/test.cgi`：一个简单的CGI脚本，用于触发漏洞。这个脚本本身不包含任何恶意代码,只是用于展示环境变量。

虽然大部分代码用于搭建漏洞测试环境，但仍存在潜在的投毒风险。Dockerfile中使用了`wget`从外部源下载bash源码和patch。尽管URL看起来是官方的GNU源，但如果这些源被劫持，则可能被替换为包含恶意代码的版本。此外，即使源代码没有被篡改，应用patch的过程也可能引入意料之外的问题。

综合来看，投毒风险较低，大约为10%。主要风险在于对外部源的依赖，以及patch应用过程中的潜在问题。

**3. 利用方式：**

ShellShock漏洞的利用方式如下：

1.  **攻击者构造包含恶意代码的环境变量。** 恶意代码被嵌入到函数定义之后，例如：`(){ :; }; command`。
2.  **攻击者通过某种方式将该环境变量传递给Bash。** 常见的场景包括：
    *   **CGI脚本：** 攻击者可以通过HTTP请求头设置环境变量，当Web服务器调用CGI脚本时，会将这些环境变量传递给Bash解释器。
    *   **OpenSSH的ForceCommand功能：** 攻击者可以通过SSH连接，利用ForceCommand功能执行命令，并将恶意环境变量传递给Bash。
    *   **DHCP客户端：** 在某些情况下，DHCP客户端会执行脚本，并将DHCP服务器提供的环境变量传递给Bash。
3.  **Bash执行包含恶意代码的环境变量。** 当Bash遇到函数定义后的trailing strings时，会将其作为命令执行，从而导致远程代码执行。

例如，通过CGI脚本利用该漏洞的Payload可能如下所示：

```
GET /cgi-bin/test.cgi HTTP/1.1
User-Agent: () { :; }; /usr/bin/env
Host: target.com
```

该请求会将`User-Agent`头设置为包含恶意代码的环境变量，当Web服务器调用`test.cgi`脚本时，`/usr/bin/env`命令会被执行。

**项目地址:** [cved-sources/cve-2014-6271](https://github.com/cved-sources/cve-2014-6271)

**漏洞详情:** [CVE-2014-6271](https://nvd.nist.gov/vuln/detail/CVE-2014-6271)