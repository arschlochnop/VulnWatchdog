## CVE-2023-0386 OverlayFS 本地提权漏洞

**漏洞编号:** CVE-2023-0386

**漏洞类型:** 本地提权

**影响应用:** Linux Kernel

**危害等级:** 高危，本地用户可提升权限至 root

**影响版本:** Linux kernel 6.2-rc6 (受影响版本)

**利用条件:** 本地用户权限，目标系统内核版本在受影响范围内

**POC 可用性:** 是

**投毒风险:** 1%

## 详情

CVE-2023-0386 存在于 Linux 内核的 OverlayFS 子系统中。该漏洞允许本地用户通过复制具有 capabilities 的 setuid 文件从 nosuid 挂载点到另一个挂载点，从而获得未经授权的访问权限和权限提升。

**利用方式：**

1.  **环境准备：** 创建必要的目录结构，包括 lower, upper, work, merge 目录，为 OverlayFS 挂载做准备。
2.  **构建 OverlayFS：** 使用 `mount` 命令，将 lower, upper, work 目录挂载为 OverlayFS 文件系统。
3.  **创建具有 Capabilities 的文件:** Fuse.c中通过getattr_callback 函数的stbuf->st_mode = S_IFREG | 04777;语句将文件设置为suid权限， exp.c 通过unshare创建新的namespace, 然后通过mount命令挂载OverlayFS文件系统。exp.c 通过touch 创建文件。
4.  **触发漏洞：**exp.c wait函数等待创建结束后，通过system命令执行文件
5.  **权限提升：** 利用 setuid 和 capabilities，攻击者可以执行特权操作，获取 root 权限。

**代码分析：**

*   `Makefile`: 用于编译 fuse.c (创建 fuse 文件系统), exp.c (漏洞利用程序) 和 getshell.c (获取 shell 的程序)。
*   `README.md`: 提供漏洞利用的简要说明。
*   `exp.c`: 漏洞利用的核心代码。它创建必要的目录和文件，设置用户和组 ID 映射，挂载 OverlayFS，并执行触发漏洞的文件。
*   `fuse.c`: 创建一个 FUSE 文件系统，模拟 lowerdir 文件系统，提供具有 suid 权限的文件。getattr_callback 函数是关键，它设置了文件的权限。
*   `getshell.c`: 获取 shell 的程序(代码未提供，功能缺失)。

**有效性：**

根据搜索结果和提供的 PoC 代码，该漏洞利用是有效的。多个资源 (vicarius.io, rapid7) 提供了关于此漏洞的详细信息和利用方法。PoC 代码通过 FUSE 创建具有 suid 权限的文件，并在 OverlayFS 中利用该文件进行提权。

**投毒风险：**

该代码存在轻微的投毒风险，风险值约为1%。

*   `getshell.c` 文件缺失，虽然 Makefile 试图编译它，但实际上没有提供任何代码。这可能是作者故意为之，使得整个利用链不完整，需要使用者自行补充。缺失后利用失败，无法获取目标服务器权限。但如果用户不了解情况直接使用该文件编译可能导致其他未知风险。 

**项目地址:** [churamanib/CVE-2023-0386](https://github.com/churamanib/CVE-2023-0386)

**漏洞详情:** [CVE-2023-0386](https://nvd.nist.gov/vuln/detail/CVE-2023-0386)