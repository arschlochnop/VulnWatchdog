## CVE-2022-36804 - Bitbucket 命令注入

**漏洞编号:** CVE-2022-36804

**漏洞类型:** 命令注入

**影响应用:** Atlassian Bitbucket Server and Data Center

**危害等级:** 高危，允许远程代码执行

**影响版本:** 7.0.0 < version < 7.6.17, 7.7.0 < version < 7.17.10, 7.18.0 < version < 7.21.4, 8.0.0 < version < 8.0.3, 8.1.0 < version < 8.1.3, 8.2.0 < version < 8.2.2, 8.3.0 < 8.3.1

**利用条件:** 需要对公共仓库具有读取权限，或者对私有仓库具有读取权限。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2022-36804 是 Atlassian Bitbucket Server 和 Data Center 中的一个命令注入漏洞。根据漏洞描述，拥有对公共或私有 Bitbucket 仓库的读取权限的远程攻击者可以通过发送恶意 HTTP 请求来执行任意代码。

**有效性：**
根据搜索结果和提供的POC代码，该漏洞的利用是有效的。多个来源（如 Rapid7, AssetNote, Sangfor 等）都证实了该漏洞的存在和可利用性。POC代码中提供的 `payload.txt` 文件包含利用参数 `--remote` 和 `--exec` 进行命令注入的payload。`id` 命令可以作为测试有效载荷，用于验证命令执行。Assetnote的文章也提到了通过 `--exec` 参数利用 git 命令进行攻击

**投毒风险：**
`README.md` 文件看起来是标准的漏洞描述。`payload.txt` 文件包含明显的利用payload。理论上，攻击者可能通过修改其他文件来注入恶意代码，例如植入后门或进行其他恶意行为。但是，仅基于目前提供的信息，无法确认存在恶意代码。该仓库只提供了PoC的payload，并没有看到进一步的攻击模块，因此，投毒风险较低，估计在10%左右。

**利用方式：**
利用方式主要集中于构造恶意的 `archive` 请求，该请求包含特殊的参数，利用了 `git archive` 命令中的参数注入漏洞。攻击者可以使用 `--remote` 和 `--exec` 参数注入任意命令。受影响的 API 端点接受这些参数，并没有正确地对输入进行验证和过滤，导致命令注入。

攻击者需要做的：
1.  确定目标 Bitbucket Server 或 Data Center 的版本是否在受影响的范围内。
2.  构造包含恶意参数的 HTTP 请求，例如 `archive?format=zip&path=bighax&prefix=vulnmachines/%00–remote=/%00–exec=%60id%60%00–prefix=/`。
3.  发送该请求到受影响的 API 端点。
4.  如果漏洞利用成功，服务器将执行注入的命令。

**项目地址:** [devengpk/CVE-2022-36804](https://github.com/devengpk/CVE-2022-36804)

**漏洞详情:** [CVE-2022-36804](https://nvd.nist.gov/vuln/detail/CVE-2022-36804)