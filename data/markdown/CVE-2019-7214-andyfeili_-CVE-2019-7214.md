## CVE-2019-7214 - SmarterMail 反序列化远程代码执行

**漏洞编号:** CVE-2019-7214

**漏洞类型:** .NET 反序列化

**影响应用:** SmarterTools SmarterMail

**危害等级:** 高危，未经身份验证的远程代码执行

**影响版本:** 16.x before build 6985

**利用条件:** 目标服务器运行受影响的SmarterMail版本，且17001端口可访问（默认情况下在Build 6985补丁后不可远程访问）。

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2019-7214 存在于 SmarterTools SmarterMail 16.x build 6985 之前的版本中。该漏洞允许未经身份验证的攻击者通过反序列化不可信数据，在服务器上执行任意命令。根据漏洞库信息和搜索结果，攻击者可以利用 .NET remoting 端点（17001端口）发送恶意序列化对象，从而触发远程代码执行。

**有效性:** 提供的 POC 代码是一个 Python 脚本，它利用了 .NET 反序列化漏洞。脚本首先定义了目标主机、端口，攻击者的监听主机、端口，然后构造一个包含 PowerShell 反向 Shell 命令的 Payload。该 Payload 使用 `System.Collections.Generic.SortedSet` 对象，攻击者使用powershell执行恶意代码，并将其base64编码后插入Payload，利用方式较为直接，大概率有效。Exploit-DB上也有相关利用代码（[webpage 4]）。

**投毒风险:** 经分析，POC代码的主要功能是利用漏洞进行远程代码执行，实现反向shell。虽然代码中包含反向shell，但这是漏洞利用的必要组成部分，并非恶意投毒。Payload 使用 PowerShell 下载并执行指定 URL 上的脚本，这部分如果 URL 被篡改，则存在投毒风险，目前代码中URL参数由攻击者指定。脚本的整体结构和逻辑与已知的 CVE-2019-7214 利用方式一致。投毒风险主要存在于用户如果直接使用该脚本，而没有审查其中的反向Shell地址，可能会被其他人利用。综合考虑，投毒风险较低，约为5%。

**利用方式:**
1.  **确定目标:** 找到运行 SmarterMail 16.x build 6985 之前版本的服务器，并确认17001端口对外开放。
2.  **配置攻击机:** 准备一台攻击机，配置监听端口（LPORT）。
3.  **修改POC代码:** 修改POC代码中的 HOST (目标服务器IP地址), LHOST(攻击机IP), PORT(Smartermail的17001端口) 和 LPORT(攻击机监听端口) 的参数。
4.  **运行POC代码:** 执行Python脚本，将恶意序列化数据发送到目标服务器的17001端口。
5.  **获取Shell:** 如果漏洞利用成功，攻击机将收到一个反向Shell，攻击者即可在目标服务器上执行任意命令。

**项目地址:** [andyfeili/-CVE-2019-7214](https://github.com/andyfeili/-CVE-2019-7214)

**漏洞详情:** [CVE-2019-7214](https://nvd.nist.gov/vuln/detail/CVE-2019-7214)