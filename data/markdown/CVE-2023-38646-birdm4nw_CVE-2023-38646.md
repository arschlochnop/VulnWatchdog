## CVE-2023-38646 - Metabase RCE

**漏洞编号:** CVE-2023-38646

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Metabase

**危害等级:** 高危，允许未经身份验证的攻击者以服务器权限执行任意命令。

**影响版本:** < 0.46.6.1 (开源版), < 1.46.6.1 (企业版), 其他受影响版本包括 0.45.4.1, 1.45.4.1, 0.44.7.1, 1.44.7.1, 0.43.7.2, 和 1.43.7.2.

**利用条件:** 目标Metabase实例运行在受影响版本，且攻击者可以访问Metabase服务。

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2023-38646 是 Metabase 中的一个远程代码执行漏洞。未经身份验证的攻击者可以通过精心构造的请求在服务器上执行任意命令。利用方式如下：

1.  **获取setup-token:**  攻击者首先向 `/api/session/properties` 发送 GET 请求，提取 `setup-token`。
2.  **构造恶意payload:**  构造包含恶意H2数据库连接字符串的 JSON payload。该连接字符串利用 `TRACE_LEVEL_SYSTEM_OUT` 参数和 `CREATE TRIGGER` 语句，在H2数据库中创建一个触发器，该触发器在每次从 `INFORMATION_SCHEMA.TABLES` 表中选择数据之前执行。触发器中包含的 Javascript 代码使用 `java.lang.Runtime.getRuntime().exec()` 执行系统命令。
3.  **发送payload:**  将构造好的 payload 发送到 `/api/setup/validate` 接口。
4.  **执行命令:**  Metabase 尝试使用提供的数据库连接，触发恶意的 H2 触发器，从而执行攻击者注入的命令。

该漏洞利用代码首先获取Metabase的`setup-token`，然后构造一个恶意的H2数据库连接字符串，通过`TRACE_LEVEL_SYSTEM_OUT`和`CREATE TRIGGER`机制执行任意命令。代码中使用了base64编码来绕过一些过滤，并在payload中随机生成字符串来避免缓存等问题。

**投毒风险分析：**

查看漏洞利用代码，并没有发现明显的恶意代码。代码的功能是利用漏洞进行反弹shell，虽然反弹shell本身具有一定的风险，但这是漏洞利用的正常行为，不应视为投毒。`README.md`文件也没有任何可疑之处。可以判断此仓库中作者隐藏投毒代码的可能性很低，概率为0%。

**项目地址:** [birdm4nw/CVE-2023-38646](https://github.com/birdm4nw/CVE-2023-38646)

**漏洞详情:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)