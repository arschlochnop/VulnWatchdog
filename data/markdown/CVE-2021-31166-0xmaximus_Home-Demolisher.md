## CVE-2021-31166 HTTP Protocol Stack Remote Code Execution Vulnerability

**漏洞编号:** CVE-2021-31166

**漏洞类型:** 远程代码执行

**影响应用:** Windows HTTP.sys

**危害等级:** 高危，远程代码执行

**影响版本:** Windows 10 Version 2004, Windows Server version 2004, Windows 10 Version 20H2, Windows Server version 20H2 (版本低于指定Build版本)

**利用条件:** 目标系统需要运行受影响版本的Windows，并开启HTTP服务(通常是IIS)

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2021-31166 是一个 HTTP 协议栈远程代码执行漏洞，存在于 Windows 的 HTTP.sys 组件中。攻击者可以通过发送特制的 HTTP 请求到服务器来触发此漏洞，从而实现远程代码执行。根据漏洞库信息，该漏洞的CVSS评分为9.8，属于严重级别。CISA也将其列入已知被利用漏洞目录。提供的python脚本（CVE-2021-31166.py）尝试利用此漏洞。脚本通过发送包含特定 'Accept-Encoding' 头的 HTTP 请求来触发漏洞。脚本的实现方式是通过发送特制的HTTP请求，如果服务器在发送请求后停止运行，则认为服务器存在漏洞。

**有效性：**  POC代码（CVE-2021-31166.py）的有效性取决于目标系统是否满足漏洞存在的条件，即运行的是受影响版本的Windows，并且没有安装相应的安全更新。提供的代码通过修改HTTP头部中的`Accept-Encoding`来尝试触发漏洞。如果服务器在发送特制请求后无法正常工作，则可能存在漏洞。如果目标IIS服务崩溃，则说明POC可能有效。实际环境中利用的成功率还受到网络环境等多种因素的影响。

**投毒风险：**  分析提供的Python脚本（CVE-2021-31166.py和CVE-2022-21907.py）后，未发现明显的恶意代码或后门。脚本的主要功能是发送特制的HTTP请求，并根据服务器的响应来判断是否存在漏洞。 脚本会检查服务器是否仍在运行。代码看起来是合法的漏洞利用尝试，风险为0%。

**利用方式：**  漏洞的利用方式是发送特制的 HTTP 请求。关键在于`Accept-Encoding` 头部。 脚本（CVE-2021-31166.py）中使用的`Accept-Encoding`头是`'Accept-Encoding': 'doar-e, ftw, imo, ,'`，而CVE-2022-21907.py 使用的是 `'Accept-Encoding': 'AAAAAAAAAAAAAAAAAAAAAAAA,AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&AA&**AAAAAAAAAAAAAAAAAAAA**A,AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA,AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA,AAAAAAAAAAAAAAAAAAAAAAAAAAA,****************************AAAAAA, *, ,'`。通过构造畸形的HTTP头部，可以触发服务器端的内存错误，导致拒绝服务甚至远程代码执行。利用此漏洞，攻击者可以在未经授权的情况下，在服务器上执行任意代码，从而完全控制服务器。

**项目地址:** [0xmaximus/Home-Demolisher](https://github.com/0xmaximus/Home-Demolisher)

**漏洞详情:** [CVE-2021-31166](https://nvd.nist.gov/vuln/detail/CVE-2021-31166)