## CVE-2024-3400-PAN-OS-命令注入

**漏洞编号:** CVE-2024-3400

**漏洞类型:** 命令注入

**影响应用:** PAN-OS GlobalProtect

**危害等级:** 高危，允许未授权的攻击者以root权限执行任意代码

**影响版本:** PAN-OS 10.2, 11.0, 和 11.1（特定版本）

**利用条件:** 需要目标系统配置了GlobalProtect网关或门户

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-3400 是 Palo Alto Networks PAN-OS GlobalProtect 功能中的一个命令注入漏洞。该漏洞源于任意文件创建，允许未经身份验证的攻击者在防火墙上以 root 权限执行任意代码。该漏洞影响配置了 GlobalProtect 网关或门户的特定 PAN-OS 版本（10.2.0 < 10.2.9-h1, 11.0.0 < 11.0.4-h1, 11.1.0 < 11.1.2-h3）。

**有效性：**

根据漏洞库信息和搜索结果，该漏洞已在野外被利用，并且存在公开的PoC代码，因此提供的PoC代码很可能有效。

**利用方式：**

1.  **利用入口：** 漏洞存在于PAN-OS的GlobalProtect功能中，需要目标开启GlobalProtect网关或者GlobalProtect门户。
2.  **漏洞触发：** 通过构造包含恶意命令的特殊Cookie，利用`/ssl-vpn/hipreport.esp`接口触发漏洞。
3.  **命令注入：** Cookie中的命令经过base64编码，然后在服务器端解码并执行。
4.  **任意文件创建：** 攻击者可以利用命令注入创建任意文件，例如，将敏感信息（如running-config.xml）写入到Web可访问的目录。
5.  **远程代码执行：** 成功利用漏洞后，攻击者可以以 root 权限在防火墙上执行任意代码。

**PoC代码分析：**

PoC代码的工作流程如下：

1.  **生成随机字符串：** 用于创建唯一的文件名。
2.  **构造恶意Cookie：**  Cookie中包含一个经过Base64编码的命令，该命令使用`tar`命令将`/opt/pancfg/mgmt/saved-configs/running-config.xml`文件压缩到`/var/appweb/sslvpndocs/global-protect/portal/js/jquery.{filename}.js`。利用`SESSID=/../../../opt/panlogs/tmp/device_telemetry/minute/`来进行目录穿越，从而达到任意文件创建的目的。
3.  **发送POST请求：** 向`/ssl-vpn/hipreport.esp`发送包含恶意Cookie的POST请求。
4.  **验证利用结果：** 检查是否可以访问`/global-protect/portal/js/jquery.{filename}.js`，如果可以访问，则表明漏洞利用成功。

**投毒风险分析：**

PoC代码的主要功能是验证漏洞是否存在，并将running-config.xml文件复制到Web可访问的目录。由于PoC需要在目标系统上执行命令，因此存在一定的投毒风险。例如，作者可能在编码的命令中添加恶意代码，导致执行`rm -rf /`或者反弹shell等恶意行为，当然，这部分命令是直接可见的，可以审计出来。

**投毒风险评估：**

代码中存在创建文件，读取配置文件的操作，这些操作本身可能被利用于进行恶意活动，比如替换文件内容、窃取配置文件中的密钥等敏感信息。但是，代码中利用的命令注入点以及创建和读取的行为都是漏洞利用本身所需要的，因此不能完全确定是作者有意为之的投毒行为。投毒风险评估为10%。

**项目地址:** [W01fh4cker/CVE-2024-3400-RCE-Scan](https://github.com/W01fh4cker/CVE-2024-3400-RCE-Scan)

**漏洞详情:** [CVE-2024-3400](https://nvd.nist.gov/vuln/detail/CVE-2024-3400)