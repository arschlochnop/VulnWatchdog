## CVE-2022-29464-WSO2-任意文件上传导致远程代码执行

**漏洞编号:** CVE-2022-29464

**漏洞类型:** 任意文件上传

**影响应用:** WSO2 API Manager, Identity Server, Enterprise Integrator, Open Banking AM/KM

**危害等级:** 高危，导致远程代码执行

**影响版本:** WSO2 API Manager 2.2.0 up to 4.0.0, WSO2 Identity Server 5.2.0 up to 5.11.0, WSO2 Identity Server Analytics 5.4.0, 5.4.1, 5.5.0 and 5.6.0, WSO2 Identity Server as Key Manager 5.3.0 up to 5.11.0, WSO2 Enterprise Integrator 6.2.0 up to 6.6.0, WSO2 Open Banking AM 1.4.0 up to 2.0.0 and WSO2 Open Banking KM 1.4.0, up to 2.0.0.

**利用条件:** 需要目标服务器开放web端口且服务未打补丁

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2022-29464是WSO2产品中的一个严重漏洞，允许未经授权的文件上传，从而导致远程代码执行。攻击者通过向 `/fileupload` 端点发送包含目录遍历序列 `../../../../repository/deployment/server/webapps` 的 `Content-Disposition` 头部的恶意请求，绕过文件上传限制，将恶意JSP文件上传到web根目录下。  

**漏洞利用方式：**

1.  **构造恶意请求：** 攻击者构造一个`multipart/form-data`类型的POST请求，其中包含恶意JSP代码。请求的`Content-Disposition`头部使用目录遍历，将文件上传到目标web应用的`/repository/deployment/server/webapps`目录下的一个可访问的路径，如`authenticationendpoint`。
2.  **绕过上传限制：** 由于漏洞存在于文件上传的路径验证环节，攻击者可以利用目录遍历绕过服务器的文件类型和大小限制。
3.  **远程代码执行：** 成功上传JSP文件后，攻击者可以通过访问该JSP文件，执行任意系统命令。
4.  **POC代码分析：**  提供的Python POC脚本模拟了上述攻击流程。脚本首先尝试访问目标URL，然后发送包含JSP后门的`multipart/form-data`请求到`/fileupload/toolsAny`，通过目录遍历将JSP文件上传到`authenticationendpoint`目录下。最后，脚本通过访问上传的JSP文件，执行`whoami`命令来验证漏洞是否存在。脚本中使用了两个不同的请求头`headers1`和`headers2`，针对目标进行尝试，提高了漏洞利用成功率。

**有效性评估：**

根据漏洞描述和POC代码，此漏洞利用方法有效，因为成功上传JSP文件即可执行任意命令。

**投毒风险评估：**

POC代码本身包含了一个用于远程代码执行的JSP后门，但这不是作者植入的恶意代码，而是漏洞利用的必要组成部分。代码中存在轻微的投毒风险（约10%），因为用户在复制和粘贴POC代码时，可能会无意中引入其他潜在的恶意代码或依赖项，但主要的风险在于漏洞本身，而不是POC代码的作者植入恶意代码。

**项目地址:** [axin2019/CVE-2022-29464](https://github.com/axin2019/CVE-2022-29464)

**漏洞详情:** [CVE-2022-29464](https://nvd.nist.gov/vuln/detail/CVE-2022-29464)