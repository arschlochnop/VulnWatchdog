## CVE-2019-18634-Sudo-Stack-Based Buffer Overflow

**漏洞编号:** CVE-2019-18634

**漏洞类型:** Stack-Based Buffer Overflow

**影响应用:** Sudo

**危害等级:** 高危，可导致权限提升

**影响版本:** < 1.8.26

**利用条件:** pwfeedback 在 /etc/sudoers 中启用

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2019-18634 是 Sudo 1.8.26 之前版本中的一个栈缓冲区溢出漏洞。当 /etc/sudoers 中启用了 pwfeedback 选项时，未经授权的用户可以通过向 `tgetpass.c` 中的 `getln()` 函数的 stdin 发送一个长字符串来触发 `sudo` 进程中的缓冲区溢出，从而可能导致权限提升。

**有效性：** 根据漏洞描述和搜索结果，提供的 POC 代码很可能有效。GitHub 上的链接（[https://github.com/Plazmaz/CVE-2019-18634](https://github.com/Plazmaz/CVE-2019-18634)） 表明存在功能性漏洞利用代码，可以导致权限提升。

**投毒风险：** 代码审查表明，该漏洞利用旨在通过溢出缓冲区来控制程序流程。虽然代码中包含了一些架构特定的偏移量（例如，`TGP_OFFSET_UBUNTU`，`TGP_OFFSET_ARCHLINUX`），以适应不同的 Sudo 版本和操作系统，但是并没有发现明显的后门或恶意代码。`execlp("sh", "sh", NULL)` 这行代码的目的在于利用成功溢出后启动一个 shell，这属于漏洞利用的一部分，并非恶意投毒。 但不排除未来作者更新加入恶意代码,因此,投毒风险为5%.

**利用方式：**

1.  **前提条件：** `pwfeedback` 必须在 `/etc/sudoers` 文件中启用。该选项允许 sudo 在输入密码时提供反馈（例如，显示星号）。
2.  **伪终端分配：** 漏洞利用代码首先分配一个伪终端 (pty)，以确保 `sudo_term_kill` 不为 0，这是成功利用该漏洞的必要条件。如果 stdin 不是终端，Sudo 将设置 `sudo_term_kill = 0`，从而阻止溢出。
3.  **终端设置：** 配置伪终端的属性，例如，禁用原始模式下的输入预处理，并将 VEOF 字符更改为不与 TGP_ASKPASS 冲突的值。
4.  **缓冲区溢出：** 向 Sudo 发送一个精心构造的超长字符串，该字符串会溢出 `getln()` 函数中的缓冲区。溢出旨在覆盖栈上的返回地址，以及可能的其他敏感数据。
5.  **权限提升：** 成功溢出后，控制流被重定向到一个 shell，从而允许攻击者以 root 权限执行命令。利用程序首先取消设置环境变量 `SUDO_ASKPASS`，然后恢复标准输入和标准输出，再执行 `sh`。

**项目地址:** [edsonjt81/sudo-cve-2019-18634](https://github.com/edsonjt81/sudo-cve-2019-18634)

**漏洞详情:** [CVE-2019-18634](https://nvd.nist.gov/vuln/detail/CVE-2019-18634)