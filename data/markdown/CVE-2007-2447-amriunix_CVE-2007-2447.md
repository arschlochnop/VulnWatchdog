## CVE-2007-2447-Samba-远程命令注入

**漏洞编号:** CVE-2007-2447

**漏洞类型:** 远程命令注入

**影响应用:** Samba

**危害等级:** 高危，允许远程攻击者执行任意命令

**影响版本:** 3.0.0 through 3.0.25rc3

**利用条件:** 需要目标系统开启Samba服务，并且开启了 'username map script' 配置项 (对于SamrChangePassword 攻击方式) 或者利用其他 MS-RPC 函数（如远程打印和文件共享管理）

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2007-2447 存在于 Samba 的 MS-RPC 功能中。攻击者可以利用 shell 元字符在 SamrChangePassword 函数（当启用了 "username map script" 选项时）或者在其他 MS-RPC 函数（比如远程打印和文件共享管理）中执行任意命令。

**有效性分析：**

提供的 Python 脚本 `usermap_script.py` 旨在利用此漏洞。它使用 `pysmb` 库连接到目标 Samba 服务器，并构造一个包含恶意 payload 的用户名。Payload 包含一个反向shell，当 Samba 服务器处理这个恶意用户名时，会执行其中的命令，从而允许攻击者连接到目标系统。

根据漏洞库信息、搜索引擎结果和漏洞利用代码，可以判定此 POC 代码的有效性较高。

**投毒风险分析：**

仔细审查了 `usermap_script.py` 脚本和 `README.md` 文件。脚本本身实现了漏洞利用逻辑，创建反向 shell。`README.md` 文件只包含漏洞描述，用法和安装说明。未发现明显的恶意代码。

但存在以下几点潜在风险：

1.  **依赖项风险：** 该脚本依赖 `pysmb` 库。虽然 `pysmb` 是一个常用的库，但仍存在被供应链攻击的风险。攻击者可能通过篡改 `pysmb` 库来植入恶意代码。
2.  **网络依赖：** 该脚本需要通过网络连接到目标 Samba 服务器。如果攻击者控制了受害者网络，他们可能会篡改脚本或拦截连接，从而实现中间人攻击或植入恶意代码。
3.  **远程仓库风险：** 从远程仓库下载并执行代码始终存在风险。虽然该仓库看起来是合法的，但仍存在被恶意篡改的可能。

综合以上几点分析，判定此仓库存在 10% 的投毒风险。

**利用方式总结：**

1.  **配置要求：** 目标 Samba 服务器需要运行在受影响的版本范围内 (3.0.0 到 3.0.25rc3)。并且需要开启了 'username map script' 配置项 (对于SamrChangePassword 攻击方式)。
2.  **攻击步骤：**
    *   攻击者运行 `usermap_script.py` 脚本，提供目标 IP 地址、端口和攻击者监听的 IP 地址和端口。
    *   脚本连接到目标 Samba 服务器，并发送包含恶意 payload 的用户名。
    *   目标 Samba 服务器执行 payload 中的命令，建立一个反向 shell 连接到攻击者的机器。
    *   攻击者通过反向 shell 控制目标系统。

**项目地址:** [amriunix/CVE-2007-2447](https://github.com/amriunix/CVE-2007-2447)

**漏洞详情:** [CVE-2007-2447](https://nvd.nist.gov/vuln/detail/CVE-2007-2447)