## CVE-2024-6387 - OpenSSH regreSSHion 远程代码执行

**漏洞编号:** CVE-2024-6387

**漏洞类型:** 远程代码执行

**影响应用:** OpenSSH

**危害等级:** 高危，可导致完全控制受影响系统

**影响版本:** 8.5p1 <= OpenSSH <= 9.7p1 (glibc-based Linux systems)

**利用条件:** 目标系统需要运行受影响版本的OpenSSH，且基于glibc。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-6387，也被称为"regreSSHion"，是OpenSSH服务器（sshd）中的一个安全漏洞，是CVE-2006-5051的一个回归。它是由信号处理中的竞争条件引起的。未经身份验证的远程攻击者可以通过在设定的时间内未能成功进行身份验证来触发此漏洞，可能导致以root权限执行任意代码。该漏洞影响基于glibc的Linux系统上的OpenSSH 8.5p1到9.7p1版本。

**有效性：**
根据漏洞库信息、搜索结果（特别是来自Qualys和offsec的分析），以及POC代码的存在，可以判断该漏洞是有效的，并且存在可利用的POC。

**投毒风险：**
POC代码中存在一定的投毒风险。虽然代码的目的是利用该漏洞，但攻击者可能会修改shellcode以进行恶意活动，或者在代码中加入额外的后门。例如，`shellcode`变量中包含占位符，需要替换为实际的shellcode。如果用户从不可信来源下载POC，并使用了包含恶意shellcode的POC，则可能存在投毒风险。代码中定义了多个glibc地址用于绕过ASLR，攻击者可以伪造错误的地址，来扰乱攻击。

**利用方式：**
利用方式涉及以下几个步骤：

1.  **建立连接：** 攻击者首先与目标OpenSSH服务器建立TCP连接。
2.  **SSH握手：** 执行初步的SSH握手过程，包括版本交换和密钥交换的初始化。
3.  **堆准备：** 发送特定的SSH数据包，以在sshd进程的堆上创建特定的内存布局，为利用创造条件。
4.  **触发竞争条件：** 攻击者触发一个竞争条件，该条件涉及OpenSSH处理信号的方式，利用SIGALRM信号处理程序中的不安全函数调用。
5.  **地址绕过：** 通过尝试多个可能的glibc基址，绕过地址空间布局随机化 (ASLR)。
6.  **执行代码：** 成功触发竞争条件后，将恶意shellcode注入到内存中并执行，从而获得远程代码执行权限（通常以root权限）。

**缓解措施包括：**
*   禁用`LoginGraceTime`参数，虽然不能完全阻止DoS，但可以防御RCE。
*   使用`fail2ban`等工具监控日志文件并管理连接。
*   及时更新到OpenSSH的修复版本。

**项目地址:** [prelearn-code/CVE-2024-6387](https://github.com/prelearn-code/CVE-2024-6387)

**漏洞详情:** [CVE-2024-6387](https://nvd.nist.gov/vuln/detail/CVE-2024-6387)