## CVE-2017-5941 - node-serialize 反序列化RCE

**漏洞编号:** CVE-2017-5941

**漏洞类型:** 反序列化漏洞

**影响应用:** node-serialize

**危害等级:** 高危，可导致远程代码执行

**影响版本:** <= 0.0.4

**利用条件:** 目标应用使用了存在漏洞的node-serialize版本，且允许用户可控数据传递到unserialize()函数

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2017-5941 漏洞存在于 node-serialize 包的 0.0.4 版本及更早版本中。当 `unserialize()` 函数接收到不可信数据时，可以通过构造包含立即执行函数表达式（IIFE）的 JavaScript 对象来执行任意代码。

**有效性评估：**

提供的 PoC 代码利用了 `node-serialize` 包的这个反序列化漏洞，通过构造包含恶意 JavaScript 代码的 JSON 数据，发送到目标服务器的 `/api/deserialize` 接口或通过 `profile` cookie，从而在服务器上执行任意命令。PoC代码包含了生成payload、发送POST请求和设置cookie的完整流程，并提供了 filedrop 和 revshell 两种利用模式，验证了漏洞的有效性。

**投毒风险评估：**

分析 PoC 代码，并未发现明显的投毒代码。PoC 的主要功能是演示漏洞利用，而非进行恶意行为。代码中使用的 `child_process.exec` 函数是为了在目标系统上执行命令，这是漏洞利用的常见手段。不过任何 PoC 都可能被滥用，因此存在潜在的风险。投毒风险评估为5%，主要考虑代码被修改后用于恶意目的。

**利用方式：**

1.  **确定目标：** 找到使用了 `node-serialize <= 0.0.4` 的 Node.js 应用，并且允许用户可控的数据传递到 `unserialize()` 函数。
2.  **构造 Payload：** 使用 PoC 代码或手动构造包含恶意 JavaScript 代码的 JSON payload。恶意代码使用 IIFE (Immediately Invoked Function Expression) 执行 shell 命令。
3.  **选择攻击入口：**  
    *   通过 POST 请求发送 JSON payload 到 `/api/deserialize` 接口 (如果应用将 POST body 的 `data` 字段直接传递给 `unserialize()` 函数)。
    *   将 JSON payload 进行 Base64 编码，然后设置到名为 `profile` 的 cookie 中，访问 `/profile` 页面 (如果应用先对 cookie 进行 Base64 解码，然后传递给 `unserialize()` 函数)。
4.  **执行代码：**  服务器接收到 payload 并调用 `unserialize()` 函数后，恶意的 JavaScript 代码将被执行，导致远程代码执行。
5.  **验证与利用：** 通过写入文件或反弹 shell 等方式验证代码是否成功执行，然后进行更深入的攻击。

**项目地址:** [kylew1004/cve-2017-5941-poc-docker-lab](https://github.com/kylew1004/cve-2017-5941-poc-docker-lab)

**漏洞详情:** [CVE-2017-5941](https://nvd.nist.gov/vuln/detail/CVE-2017-5941)