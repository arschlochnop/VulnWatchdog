## CVE-2022-46169-Cacti-命令注入

**漏洞编号:** CVE-2022-46169

**漏洞类型:** 命令注入

**影响应用:** Cacti

**危害等级:** 高危，允许未经身份验证的攻击者执行任意操作系统命令。

**影响版本:** < 1.2.23

**利用条件:** 需要目标系统运行Cacti并且存在具有POLLER_ACTION_SCRIPT_PHP（值为2）操作类型的 poller_item 配置项。

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2022-46169 是 Cacti 中存在的一个未经身份验证的命令注入漏洞。攻击者可以通过构造特制的 HTTP 请求，绕过身份验证，并在目标系统上执行任意操作系统命令。

**利用方式：**
1.  **身份验证绕过：** 攻击者通过设置 `X-Forwarded-For` HTTP 头来欺骗 `get_client_addr` 函数，使其返回 Cacti 服务器自身的 IP 地址。由于 poller 表中存在默认的服务器主机名条目，因此可以绕过身份验证。
2.  **命令注入：** 成功绕过身份验证后，攻击者可以调用 `remote_agent.php` 文件的 `polldata` 操作。`poll_for_data` 函数会检索请求参数并从数据库中加载相应的 `poller_item` 条目。如果 `poller_item` 的 `action` 字段等于 `POLLER_ACTION_SCRIPT_PHP`，则使用 `proc_open` 执行 PHP 脚本。攻击者可以控制 `$poller_id` 参数，该参数会被插入到传递给 `proc_open` 的字符串中，从而导致命令注入。
3.  **寻找合适的 poller_item：** 攻击者需要找到 `action` 类型为 `POLLER_ACTION_SCRIPT_PHP` 的 `poller_item`。脚本通过暴力破解`host_id`和`local_data_ids`，直到找到匹配的`poller_item`。预定义的模版比如 *Device - Uptime* 很容易满足条件.

**POC有效性：**
提供的POC代码尝试自动化利用此漏洞。它首先检查目标URL的`/remote_agent.php`或者`/cacti/remote_agent.php`路径是否存在。然后，它尝试通过设置`X-Forwarded-For`头来绕过身份验证。如果身份验证绕过成功，它会尝试暴力破解`host_id`和`local_data_ids`来发现适合利用的`poller_item`。最后，如果找到了合适的`poller_item`，可以注入命令。

**投毒风险：**
查看了给出的python脚本`CVE-2022-46169.py`和`README.md`文件，主要是漏洞验证和利用的脚本，仓库中没有发现明显的恶意代码，但是仍然存在一定的投毒风险。例如，脚本可能会被修改为：

1.  **下载和执行恶意代码：**  在成功利用漏洞后，脚本可以从远程服务器下载并执行恶意代码。
2.  **修改系统文件：**  脚本可以修改系统文件，例如 `/etc/hosts`，将用户重定向到恶意网站。
3.  **收集敏感信息：** 脚本可以收集系统敏感信息，例如用户名、密码和网络配置，并将信息发送到远程服务器。

给出的投毒风险百分比为5%，主要考虑的点为作者开源了exp脚本，其他人可以通过下载该脚本然后进行修改，加入恶意代码，再进行传播，从而达到投毒的目的。

**项目地址:** [miko550/CVE-2022-46169](https://github.com/miko550/CVE-2022-46169)

**漏洞详情:** [CVE-2022-46169](https://nvd.nist.gov/vuln/detail/CVE-2022-46169)