## CVE-2022-22947-Spring Cloud Gateway-代码注入

**漏洞编号:** CVE-2022-22947

**漏洞类型:** 代码注入

**影响应用:** Spring Cloud Gateway

**危害等级:** 高危，可能导致远程代码执行

**影响版本:** Spring cloud gateway versions 3.1.x prior to 3.1.1+, 3.0.x prior to 3.0.7+ and all old and unsupported versions

**利用条件:** Gateway Actuator endpoint is enabled, exposed and unsecured

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2022-22947 漏洞是 Spring Cloud Gateway 的一个代码注入漏洞，影响版本低于 3.1.1+ 和 3.0.7+ 的版本。根据漏洞库信息和搜索结果，当 Gateway Actuator 端点启用、暴露且未进行安全保护时，攻击者可以通过构造恶意请求在远程主机上执行任意代码。

**漏洞利用方式：**

1.  **寻找目标：** 找到运行存在漏洞的 Spring Cloud Gateway 实例，并且其 Actuator 端点对外开放且未授权。
2.  **构造恶意请求：** 利用 SpEL 表达式构造恶意的 HTTP 请求，该表达式会被 Gateway Actuator 解析执行。根据 exploit-db 的相关信息，该漏洞是远程代码执行。
3.  **执行任意代码：** 成功利用漏洞后，攻击者可以在目标服务器上执行任意代码，例如植入 Webshell、反弹 Shell 等。

**POC 代码分析：**

提供的 POC 代码 `GMemShell.java` 尝试在 Spring Cloud Gateway 中注入内存 Shell。具体流程如下：

1.  **定义内存 Shell 类：** `GMemShell` 类包含了一些必要的函数，例如 AES 加密/解密(`x`)、MD5 加密(`md5`)、Base64 编码/解码(`base64Encode`, `base64Decode`)等，这些函数被用于后续的 shellcode 加密和执行。
2.  **`doInject` 方法：** 该方法通过反射调用 `registerHandlerMethod` 方法，将 `GMemShell` 类的 `cmd` 方法注册为处理指定路径请求的 Handler。`registerHandlerMethod` 是 Spring 框架内部的方法，用于动态注册 Controller。
3.  **`cmd` 方法：** 该方法是实际执行命令的 Handler。它从请求中获取加密的 payload，然后进行解密、加载并执行。Payload 首先经过 Base64 解码，然后使用 AES 解密。
4.  **动态类加载：**  `defineClass`方法通过URLClassLoader和反射，实现在内存中加载byte数组并定义成class的功能
5.  **Payload 执行：** 解密后的 Payload 应当是一个 Java class 字节码，该字节码会被动态加载并执行。

**有效性评估：**

根据 POC 代码和漏洞描述，该 POC 能够有效利用 CVE-2022-22947 漏洞，实现在目标服务器上执行任意代码的目的，但前提是 actuator 端点开放。

**投毒风险评估：**

经过对 POC 代码的分析，并未发现明显的投毒代码。代码的主要功能是动态注入内存 Shell，并执行通过请求传递的 Payload。代码中包含的加密、解密等操作都是为了保护 Payload，避免被轻易发现。因此，该 POC 代码的投毒风险较低，接近 0%。 投毒代码是指作者在代码中故意加入的恶意代码，例如后门、病毒等。 本代码只是实现了漏洞利用，本身并没有额外的恶意功能，因此不属于投毒代码。


**项目地址:** [whwlsfb/cve-2022-22947-godzilla-memshell](https://github.com/whwlsfb/cve-2022-22947-godzilla-memshell)

**漏洞详情:** [CVE-2022-22947](https://nvd.nist.gov/vuln/detail/CVE-2022-22947)