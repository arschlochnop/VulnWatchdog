## CVE-2022-29464-WSO2-任意文件上传导致远程代码执行

**漏洞编号:** CVE-2022-29464

**漏洞类型:** 任意文件上传

**影响应用:** WSO2 API Manager, Identity Server, Enterprise Integrator, Open Banking AM/KM

**危害等级:** 高危，允许未授权用户上传恶意文件并执行任意代码。

**影响版本:** WSO2 API Manager 2.2.0 up to 4.0.0, WSO2 Identity Server 5.2.0 up to 5.11.0, WSO2 Identity Server Analytics 5.4.0, 5.4.1, 5.5.0 and 5.6.0, WSO2 Identity Server as Key Manager 5.3.0 up to 5.11.0, WSO2 Enterprise Integrator 6.2.0 up to 6.6.0, WSO2 Open Banking AM 1.4.0 up to 2.0.0 and WSO2 Open Banking KM 1.4.0, up to 2.0.0.

**利用条件:** 目标系统存在/fileupload接口，且未对上传的文件类型和路径进行严格限制。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2022-29464 漏洞存在于多个 WSO2 产品中，是一个严重的安全漏洞。攻击者可以利用`/fileupload`接口，通过目录遍历的方式将恶意 JSP 文件上传到 Web 应用的根目录下，例如 `../../../../repository/deployment/server/webapps/authenticationendpoint/shell.jsp`。上传的 JSP 文件随后可以被 Web 服务器执行，从而导致远程代码执行。

**有效性：**

根据漏洞库信息和搜索结果，此漏洞利用方式是有效的，并且已经被广泛利用。
提供的 PoC 代码尝试上传一个名为 `shell.jsp` 的 JSP 文件，该文件包含可以执行系统命令的恶意代码。如果上传成功，攻击者可以通过访问 `http(s)://目标地址/authenticationendpoint/shell.jsp` 来执行任意代码。

**投毒风险：**

PoC 代码中，`/tmp/e2105c9753cc00a9633b2cfd9b6fe351/cve.py` 主要功能是发送恶意请求，上传木马文件，整体代码没有明显的投毒行为。但是，以下几点需要注意：
*   `Files/shell.jsp`: 这是一个后门文件，如果未经审查直接使用，可能会引入未知风险。建议在使用前，仔细检查 `shell.jsp` 的内容，确保其只包含必要的功能，并且没有恶意代码。
*   对 `requirements.txt` 中引入的第三方库也需要进行审核，确保没有引入恶意的依赖。
*   README.md 感谢列表,作者SynixCyberCrimeMY & ?/h4zzzzzz.scc 未知。

因此，投毒风险较低，预估在10%左右。

**利用方式：**

1.  攻击者构造包含目录遍历的恶意请求，利用`/fileupload`接口上传恶意的 JSP 文件 (shell.jsp)。
2.  恶意 JSP 文件被上传到 Web 应用的根目录下。
3.  攻击者通过 Web 浏览器访问上传的 JSP 文件，执行其中的恶意代码。
4.  恶意代码在服务器上执行，允许攻击者执行任意系统命令，从而完全控制受影响的系统。

**防范措施：**

*   升级到 WSO2 官方修复后的版本。
*   实施文件上传白名单策略，仅允许上传必要的文件类型。
*   对上传的文件进行严格的路径验证，防止目录遍历攻击。
*   部署 Web 应用防火墙 (WAF)，检测和阻止恶意的文件上传请求。

**项目地址:** [SynixCyberCrimeMy/CVE-2022-29464](https://github.com/SynixCyberCrimeMy/CVE-2022-29464)

**漏洞详情:** [CVE-2022-29464](https://nvd.nist.gov/vuln/detail/CVE-2022-29464)