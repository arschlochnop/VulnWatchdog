## CVE-2020-1054 Win32k 权限提升漏洞

**漏洞编号:** CVE-2020-1054

**漏洞类型:** 权限提升

**影响应用:** Windows

**危害等级:** 高危，本地权限提升至SYSTEM

**影响版本:** 受影响的Windows版本包括但不限于Windows 7 SP1, Windows 8.1, Windows 10 (多个版本), Windows Server (多个版本)

**利用条件:** 需要在受影响的Windows系统上本地执行

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2020-1054是一个Windows Win32k组件中的权限提升漏洞。漏洞原因是Windows内核模式驱动程序未能正确处理内存中的对象。攻击者可以利用此漏洞在受影响的系统上以SYSTEM权限执行任意代码。根据搜索引擎结果和漏洞利用代码，可以确认此漏洞存在公开可用的POC。提供的C++代码利用`DrawIconEx`函数中的越界写入漏洞来实现权限提升。该POC首先获取当前进程和System进程的Token地址，然后通过构造特定的GDI对象，利用内存布局的缺陷，将当前进程的Token替换为System进程的Token，从而提升权限。shellcode部分执行反向shell，连接到指定IP地址和端口。 

**有效性：** 提供的POC代码在受影响的Windows系统上应该是有效的，可以成功利用该漏洞进行权限提升。

**投毒风险：** 代码中包含反向shell，连接到192.168.223.128:4444。虽然反向shell本身是漏洞利用的一部分，但如果这个IP地址属于恶意攻击者控制，则可能存在投毒风险，即用户运行该POC后，攻击者的服务器可以远程控制受害者系统。评估的投毒风险为10%，主要是因为反向shell的目标IP地址可能被用于恶意目的，但核心漏洞利用代码本身的意图是权限提升。

**利用方式：**
1.  利用`NtQuerySystemInformation`获取当前进程和System进程的内核对象地址。
2.  计算Token的偏移地址（0x208）。
3.  创建GDI对象（HDC和HBITMAP），并利用GDI共享句柄表获取HBITMAP对象的内核地址。
4.  通过精心构造的内存布局，利用`DrawIconEx`函数中的越界写入漏洞，将System进程的Token覆盖到当前进程的Token。
5.  执行shellcode，建立反向shell连接，获取SYSTEM权限。


**项目地址:** [Naman2701B/CVE-2020-1054](https://github.com/Naman2701B/CVE-2020-1054)

**漏洞详情:** [CVE-2020-1054](https://nvd.nist.gov/vuln/detail/CVE-2020-1054)