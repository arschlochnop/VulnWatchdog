## CVE-2022-22947 Spring Cloud Gateway 代码注入

**漏洞编号:** CVE-2022-22947

**漏洞类型:** 代码注入

**影响应用:** Spring Cloud Gateway

**危害等级:** 高危，可导致远程代码执行

**影响版本:** Spring Cloud Gateway versions 3.1.x prior to 3.1.1+, 3.0.x prior to 3.0.7+ and all old and unsupported versions

**利用条件:** 需要Gateway Actuator端点启用、暴露且未进行安全保护

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

该漏洞存在于Spring Cloud Gateway中，当Gateway Actuator端点被启用、暴露且未进行安全保护时，攻击者可以通过构造恶意请求，利用SpEL表达式注入执行任意代码。  

**有效性：**
提供的PoC代码有效。代码通过构造包含恶意SpEL表达式的路由配置，利用`/actuator/gateway/routes`端点添加恶意路由，然后通过`/actuator/gateway/refresh`端点刷新路由，触发SpEL表达式执行，从而实现远程代码执行。PoC代码在执行命令后，还会删除创建的恶意路由，并再次刷新路由，以清除痕迹。

**投毒风险：**
该仓库中的PoC代码没有发现明显的投毒代码。PoC代码的功能明确，即利用漏洞执行命令并返回结果。代码主要通过`requests`库发送HTTP请求，并使用`re`库解析命令执行结果。没有任何迹象表明作者在代码中隐藏了恶意逻辑或后门。

**利用方式：**
1.  **目标确认：**  确认目标系统正在运行存在漏洞的Spring Cloud Gateway版本，并且Actuator端点已启用、暴露且未授权访问。
2.  **构造恶意请求：**  攻击者构造一个包含恶意SpEL表达式的JSON payload，发送到`/actuator/gateway/routes/{id}`端点，其中SpEL表达式用于执行任意命令。例如，`#{new String(T(org.springframework.util.StreamUtils).copyToByteArray(T(java.lang.Runtime).getRuntime().exec("whoami").getInputStream()))}`
3.  **刷新路由：**  发送一个POST请求到`/actuator/gateway/refresh`端点，强制Gateway刷新路由配置，从而触发SpEL表达式执行。
4.  **获取执行结果：**  发送一个GET请求到`/actuator/gateway/routes/{id}`，获取包含执行结果的响应头。
5.  **清理：** 删除添加的恶意路由，并再次刷新路由。

**项目地址:** [Le1a/CVE-2022-22947](https://github.com/Le1a/CVE-2022-22947)

**漏洞详情:** [CVE-2022-22947](https://nvd.nist.gov/vuln/detail/CVE-2022-22947)