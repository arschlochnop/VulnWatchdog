## CVE-2023-22527-Atlassian Confluence-OGNL注入RCE

**漏洞编号:** CVE-2023-22527

**漏洞类型:** 远程代码执行(RCE)

**影响应用:** Atlassian Confluence Data Center and Server

**危害等级:** 高危，允许未授权的攻击者执行任意代码

**影响版本:** 8.0.0 <= version < 8.5.4

**利用条件:** Confluence服务可访问，且版本在受影响范围内

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2023-22527 是 Atlassian Confluence Data Center 和 Server 中存在的一个模板注入漏洞，允许未经身份验证的攻击者实现远程代码执行。该漏洞源于OGNL表达式注入。根据漏洞库信息和搜索结果，这是一个高危漏洞，已经被CISA添加到已知被利用的漏洞目录中。

**有效性：**

提供的POC代码利用了模板注入漏洞，通过构造恶意的OGNL表达式，可以在目标系统上执行任意命令。代码中包含直接执行命令和反弹shell两种方式，表明POC具有实际的利用价值。

**投毒风险：**

分析POC代码，主要的逻辑都是围绕构造payload进行RCE，进行简单的命令执行或者反弹shell。存在投毒的可能性较低。代码中的`truncate`函数用于分割url编码后的命令，并修复分割后可能出现的url编码问题，属于正常功能。`X-Forwarded-For`设置为固定IP，这是一种常见的绕过策略，不属于投毒行为。代码中存在连接外网的行为(反弹shell)，这是漏洞利用的正常行为，不算投毒。综合来看，投毒风险较低，约为5%。

**利用方式：**

1.  **漏洞定位：** 漏洞存在于 Confluence 的模板处理功能中，具体是 `text-inline.vm` 模板。
2.  **Payload构造：** 攻击者通过构造包含恶意 OGNL 表达式的 HTTP POST 请求，注入到 `label` 参数中。
3.  **OGNL注入：**  OGNL 表达式允许攻击者执行任意的 Java 代码，从而实现远程代码执行。`#request.get('.KEY_velocity.struts2.context').internalGet('ognl').findValue(#parameters.poc[0],{})`是OGNL注入的关键，可以获取OGNL上下文并执行表达式。
4.  **命令执行：**  POC 代码提供了两种执行命令的方式：
    *   直接执行命令：通过`freemarker.template.utility.Execute`类执行命令，并将结果写入HTTP Header `Cmd-Ret`中。
    *   反弹 Shell：通过将恶意代码写入临时文件，然后执行该文件，从而反弹 shell。代码将 url 编码后的命令分割为小块，并通过多次请求写入文件，最后执行。这是为了绕过某些长度限制。
5.  **绕过检测：** POC代码使用`X-Forwarded-For`头，可能用于绕过某些访问控制或安全检测。
6.  **版本限制:** 该漏洞只影响8.0.x 到 8.5.3版本。

**项目地址:** [thanhlam-attt/CVE-2023-22527](https://github.com/thanhlam-attt/CVE-2023-22527)

**漏洞详情:** [CVE-2023-22527](https://nvd.nist.gov/vuln/detail/CVE-2023-22527)