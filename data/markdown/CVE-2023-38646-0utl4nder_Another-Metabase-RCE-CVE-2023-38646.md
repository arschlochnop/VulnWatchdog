## CVE-2023-38646 - Metabase Pre-Auth RCE

**漏洞编号:** CVE-2023-38646

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Metabase

**危害等级:** 高危，未经身份验证的攻击者可以以服务器权限执行任意命令

**影响版本:** < 0.46.6.1 和 Enterprise < 1.46.6.1

**利用条件:** Metabase实例可公开访问或攻击者位于同一网络

**POC 可用性:** 是

**投毒风险:** 1%

## 详情

CVE-2023-38646 是 Metabase 中一个未经身份验证的远程代码执行漏洞。根据漏洞库信息和搜索结果，未经身份验证的攻击者可以利用此漏洞在服务器上执行任意命令，获得服务器权限。漏洞存在于 Metabase 0.46.6.1 之前的开源版本和 1.46.6.1 之前的企业版本。

**有效性分析：**
根据搜索结果，已经有公开的 PoC 代码可用 (例如，github.com/threatHNTR/CVE-2023-38646)。提供的漏洞利用代码基于 Assetnote 的一篇关于该漏洞分析的文章。它通过利用 H2 数据库的特性，在数据库连接配置中执行恶意代码。具体来说，它通过构造一个恶意的 H2 数据库连接 URL，在连接数据库时触发恶意代码的执行。

**利用方式：**
利用方式主要包括以下步骤：

1.  **构造恶意 JSON Payload:**  该 JSON payload 用于创建或修改 Metabase 中的数据库连接。 其中 `classname` 被设置为 `org.h2.Driver` , `subname` 包含恶意的 H2 连接字符串,字符串利用 H2 的 `CREATE TRIGGER` 特性，在INFORMATION_SCHEMA.TABLES上创建一个触发器, 该触发器会在每次查询该表时执行嵌入的 JavaScript 代码, JavaScript代码负责执行命令.
2.  **发送Payload:** 通过发送 POST 请求到 Metabase API 端点（通常是 /api/setup/validate 或其他相关端点），将构造的 JSON payload 发送给 Metabase 服务器。由于该漏洞是未经身份验证的，因此无需提供任何身份验证信息。
3.  **触发 RCE:** Metabase 服务器尝试使用提供的配置连接到 H2 数据库时，恶意的 H2 连接字符串会被解析和执行，从而导致远程代码执行。

**投毒风险分析：**
该 PoC 的主要目的是演示如何利用该漏洞。 分析代码，发现高风险的行为是执行 `java.lang.Runtime.getRuntime().exec('bash -c {echo,BASE64COMMAND}|{base64,-d}|{bash,-i}')`。这行代码允许执行任意的 bash 命令。投毒风险主要体现在以下几个方面：

*   **命令注入风险：**  虽然代码中使用了 Base64 编码，但攻击者仍然可能通过修改 Base64 编码的内容来注入恶意命令。
*   **权限提升风险：**  由于代码以 Metabase 服务器的权限运行，因此攻击者可以通过该漏洞提升权限。

基于以上分析，我认为该 PoC 代码存在轻微的投毒风险。风险主要来自于命令注入的可能性，但这取决于如何使用和修改 PoC。整体投毒可能性较低。

综上所述，我认为该 PoC 代码的投毒风险较低，约1%。因为作者已经说明了这是一个漏洞的扩展，意在解决一些特定情况下的利用问题，并且主要代码逻辑是利用已知漏洞，而不是引入新的、隐蔽的恶意代码。


**项目地址:** [0utl4nder/Another-Metabase-RCE-CVE-2023-38646](https://github.com/0utl4nder/Another-Metabase-RCE-CVE-2023-38646)

**漏洞详情:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)