## CVE-2023-38408-OpenSSH-Agent转发RCE

**漏洞编号:** CVE-2023-38408

**漏洞类型:** 远程代码执行

**影响应用:** OpenSSH

**危害等级:** 高危，可能导致远程代码执行，控制受害者机器

**影响版本:** 9.3p2之前的所有版本

**利用条件:** 需要开启ssh-agent转发，攻击者能够控制目标系统能够访问到的服务器

**POC 可用性:** 是

**投毒风险:** 1%

## 详情

CVE-2023-38408是OpenSSH中ssh-agent转发功能中的一个远程代码执行漏洞。由于OpenSSH的PKCS#11功能在ssh-agent中具有不够可信的搜索路径，导致如果agent被转发到攻击者控制的系统，可能导致远程代码执行。具体利用方式为攻击者诱使用户连接到恶意的服务器，该服务器会将恶意的PKCS#11模块注入到用户的ssh-agent中，当用户尝试使用ssh-agent进行身份验证时，恶意的模块将被加载并执行，从而实现远程代码执行。

**有效性：**
根据漏洞信息、搜索结果和提供的PoC代码，该漏洞是有效的。PoC代码利用了`ssh-add -s`命令允许加载PKCS#11模块的特性，通过精心构造的模块来执行恶意代码。

**投毒风险：**
PoC代码中，攻击者IP的获取方式提供了多种选择，包括用户输入、硬编码和自动获取。脚本首先清除`/tmp`目录下之前的ssh会话，然后将Alice的ssh公钥添加到root用户的`authorized_keys`中。然后等待攻击者通过SSH登录到Redqueen机器，并输入`echo ${attackerIP} > /tmp/ip.txt`。脚本会找到`SSH_AUTH_SOCK`环境变量，并使用`nc`命令向其发送shellcode，然后通过加载多个恶意的.so文件，触发segmentation fault，并最终执行注入的shellcode。

分析脚本内容，发现以下几点：

*   脚本依赖于特定的环境（TryHackMe Lab Environment），这限制了其通用性。
*   脚本中包含了一些硬编码的IP地址和密码，这可能被用于进行未经授权的访问。
*   脚本尝试向/root/.ssh/authorized_keys中写入数据，这可能会影响系统的安全性。

虽然存在上述风险，但整体来说，该PoC更像是一个为了演示漏洞原理而编写的脚本，主要的目的是为了在受害者机器上执行命令，而并非留下后门。风险在于使用者如果直接使用未修改的脚本，可能会将自己的IP地址暴露给攻击者，或者将自己的SSH密钥泄露给攻击者，但是这并非PoC作者的本意，而是使用者不当使用造成的。

因此，将投毒风险评估为1%。

**利用方式：**
1.  攻击者搭建一个恶意的SSH服务器。
2.  诱骗受害者开启ssh-agent转发并连接到该恶意服务器 (`ssh -A user@evil-server`)。
3.  恶意服务器利用`ssh-add -s`向受害者的ssh-agent中注入恶意PKCS#11模块。
4.  当受害者尝试使用ssh-agent进行身份验证时，恶意模块将被加载并执行，从而实现远程代码执行。

**项目地址:** [kali-mx/CVE-2023-38408](https://github.com/kali-mx/CVE-2023-38408)

**漏洞详情:** [CVE-2023-38408](https://nvd.nist.gov/vuln/detail/CVE-2023-38408)