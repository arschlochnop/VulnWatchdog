## CVE-2021-4104 - Apache Log4j 1.2 JMSAppender 反序列化漏洞

**漏洞编号:** CVE-2021-4104

**漏洞类型:** 反序列化漏洞

**影响应用:** Apache Log4j 1.2

**危害等级:** 高危，可导致远程代码执行

**影响版本:** 1.2.x

**利用条件:** 目标系统需使用Log4j 1.2，且配置了JMSAppender，攻击者需要具有修改log4j配置文件的权限，目标需要存在JMS环境

**POC 可用性:** 是

**投毒风险:** 1%

## 详情

CVE-2021-4104 存在于 Apache Log4j 1.2 中，当 JMSAppender 被配置使用时，攻击者可以通过修改 Log4j 配置文件，指定恶意的 TopicBindingName 和 TopicConnectionFactoryBindingName，利用 JNDI 注入，触发反序列化漏洞，从而实现远程代码执行。

**有效性分析：**
提供的POC代码看起来有效。包含了一个`Evil.java`，它会在构造函数中执行`calc`命令，模拟RCE。`log4j.properties` 配置文件指定了 JMSAppender，并设置了恶意的 JNDI URL (ldap://127.0.0.1:1389/any)。 结合`pom.xml`声明的`log4j`和`activemq-all`依赖，以及`README.md`中提及的利用条件，可以判断这是一个可行的漏洞利用链。

**投毒风险分析：**
检查POC代码，主要关注`Evil.java`和`log4j.properties`两个文件。`Evil.java` 中的 `Runtime.getRuntime().exec("calc")` 仅仅是一个演示payload，没有发现隐藏的恶意代码。虽然通过修改恶意 JNDI URL 可以指向攻击者控制的LDAP服务器，从而加载恶意的类进行RCE，但这个行为是漏洞利用的固有方式，不是作者植入的后门。代码层面投毒可能性较低，但依然需要人工审核确认。pom.xml中引入了ActiveMQ相关的依赖，如果存在ActiveMQ的历史漏洞，可能会被进一步利用，但这不属于代码投毒范畴。

**利用方式：**
1.  **前提条件:** 目标系统运行 Log4j 1.2，并且配置文件中使用了 `org.apache.log4j.net.JMSAppender`。
2.  **配置文件修改:** 攻击者需要获得修改 `log4j.properties` 文件的权限。
3.  **JNDI 注入:** 在 `log4j.properties` 中，修改 `TopicBindingName` 和 `TopicConnectionFactoryBindingName` 属性，将其指向攻击者控制的 LDAP 或 RMI 服务器。
4.  **恶意服务器:** 攻击者搭建一个恶意的 LDAP 或 RMI 服务器，当目标系统尝试从该服务器获取 JNDI 对象时，服务器返回一个包含恶意代码的 Java 对象。
5.  **反序列化执行:** 目标系统反序列化该 Java 对象，从而执行攻击者预设的恶意代码，实现远程代码执行。 

综上，此POC的有效性较高，但利用条件较为苛刻，需要满足特定的 Log4j 配置和具备修改配置文件的权限。 投毒风险极低。

**项目地址:** [cuijiung/log4j-CVE-2021-4104](https://github.com/cuijiung/log4j-CVE-2021-4104)

**漏洞详情:** [CVE-2021-4104](https://nvd.nist.gov/vuln/detail/CVE-2021-4104)