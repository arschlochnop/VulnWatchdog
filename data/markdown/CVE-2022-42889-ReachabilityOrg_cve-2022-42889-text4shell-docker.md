## CVE-2022-42889 - Apache Commons Text RCE (Text4Shell)

**漏洞编号:** CVE-2022-42889

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Apache Commons Text

**危害等级:** 高危，可能导致服务器完全控制

**影响版本:** <= 1.9, >= 1.5

**利用条件:** 应用程序使用受影响版本的Apache Commons Text，并且允许用户控制用于变量插值的输入。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2022-42889，又名Text4Shell，是一个存在于Apache Commons Text库中的远程代码执行漏洞。受影响的版本（1.5 到 1.9）中的默认插值器允许通过 `script`, `dns`, `url` 等前缀执行任意代码或与远程服务器建立连接。

**有效性：**

提供的POC代码是有效的，它展示了如何利用该漏洞。Dockerfile和pom.xml文件显示使用了易受攻击的Apache Commons Text 1.8版本。`README.md`文件提供了构建和运行POC应用程序的明确步骤，以及使用`${script:javascript:java.lang.Runtime.getRuntime().exec('touch /tmp/foo')}`有效负载触发RCE的示例。它尝试在/tmp/目录下创建一个文件来验证漏洞。

**投毒风险：**

该代码仓库中存在一些轻微的投毒风险的可能性。`whitesource.config`文件表明使用了 Whitesource，这是一种软件组合分析（SCA）工具。虽然这本身不是恶意行为，但可能表明作者试图隐藏某些依赖项或漏洞，或者他们正在使用自动化工具进行构建。代码结构较为简单，且RCE payload 明显，但仍需要对整个仓库进行细致的代码审计以完全确定是否还有其它隐藏的恶意代码，故判投毒比例为10%。

**利用方式：**

该漏洞的利用方式是通过构造包含恶意表达式的字符串，利用Apache Commons Text的字符串插值功能。攻击者可以将恶意表达式注入到应用程序使用的任何用户可控的输入中（例如，URL参数，POST数据等）。当应用程序使用`StringSubstitutor.createInterpolator()`并使用用户提供的输入执行插值时，恶意表达式将被执行。提供的POC使用`${script:javascript:java.lang.Runtime.getRuntime().exec('command')}` 形式的payload在目标机器上执行任意命令。其他的利用方式可以使用`dns`或`url`前缀来尝试联系恶意服务器或执行其他操作。

**项目地址:** [ReachabilityOrg/cve-2022-42889-text4shell-docker](https://github.com/ReachabilityOrg/cve-2022-42889-text4shell-docker)

**漏洞详情:** [CVE-2022-42889](https://nvd.nist.gov/vuln/detail/CVE-2022-42889)