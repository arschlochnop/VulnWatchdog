## CVE-2021-3493 - Ubuntu OverlayFS 本地提权漏洞

**漏洞编号:** CVE-2021-3493

**漏洞类型:** 本地提权

**影响应用:** Ubuntu Linux Kernel (OverlayFS)

**危害等级:** 高危，允许本地用户获得 root 权限

**影响版本:** Ubuntu kernels before 5.8.0-50.56, 5.4.0-72.80, 4.15.0-142.146, and 4.4.0-209.241

**利用条件:** 需要运行在存在漏洞的 Ubuntu 内核上，并且允许非特权用户挂载 overlayfs。

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

该漏洞存在于 Ubuntu Linux 内核的 overlayfs 实现中。由于 Ubuntu 对 overlayfs 挂载的特定修改，导致在用户命名空间内，对底层文件系统中的文件 capabilities 验证不充分，攻击者可以通过 overlayfs 挂载绕过 capabilities 检查，设置文件 capabilities 提升权限。

**漏洞利用方式：**

1.  创建一个目录结构，包括 lower, upper, work 和 merge 目录。
2.  使用 `unshare` 创建一个新的用户命名空间和挂载命名空间。
3.  配置 `/proc/self/setgroups`, `/proc/self/uid_map`, 和 `/proc/self/gid_map` 以映射用户 ID 和组 ID。
4.  使用 `mount` 命令挂载 overlayfs，将 lower, upper 和 work 目录与 merge 目录关联起来。
5.  在 upper 目录或 merge 目录下创建或复制一个可执行文件。
6.  使用 `setxattr` 设置可执行文件的 capabilities，赋予其 root 权限。
7.  执行该文件，即可获得 root 权限。

**有效性：**

提供的 POC 代码尝试利用 CVE-2021-3493 漏洞。该代码创建必要的目录结构，创建一个新的用户命名空间和挂载命名空间，并尝试挂载 overlayfs。然后，它应该设置 `magic` 二进制文件的 capabilities，从而获得 root 权限。根据漏洞描述，该 POC 应该能够有效利用该漏洞。

**投毒风险：**

检查提供的 exploit.c 文件，未发现明显的恶意或隐藏代码。代码逻辑主要集中于设置 overlayfs 挂载和文件 capabilities。但是，需要始终谨慎对待来自不受信任来源的代码。为了确保安全，建议在受控环境中仔细审查和测试代码。


**项目地址:** [Sornphut/OverlayFS---CVE-2021-3493](https://github.com/Sornphut/OverlayFS---CVE-2021-3493)

**漏洞详情:** [CVE-2021-3493](https://nvd.nist.gov/vuln/detail/CVE-2021-3493)