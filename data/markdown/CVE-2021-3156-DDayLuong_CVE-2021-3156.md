## CVE-2021-3156-Sudo-Heap缓冲区溢出

**漏洞编号:** CVE-2021-3156

**漏洞类型:** Heap缓冲区溢出

**影响应用:** Sudo

**危害等级:** 高危，可提升至root权限

**影响版本:** < 1.9.5p2

**利用条件:** 本地用户可执行sudo

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-3156，也被称为Baron Samedit，是Sudo 1.9.5p2之前版本中存在的一个堆缓冲区溢出漏洞。该漏洞是由于sudo在解析命令行参数时存在off-by-one错误造成的。攻击者可以通过`sudoedit -s`命令以及一个以单个反斜杠字符结尾的命令行参数来利用此漏洞，从而将权限提升到root。

**有效性分析：**

根据漏洞库信息、搜索引擎结果以及提供的漏洞利用代码，可以判断此POC代码是有效的。搜索引擎结果中大量文章都提到了CVE-2021-3156的利用可以实现root权限提升。POC代码中`hax.c`文件实现了漏洞利用的核心逻辑，通过构造特定的命令行参数和环境变量来触发堆缓冲区溢出，覆盖堆上的数据，最终劫持程序控制流，执行恶意代码。

**投毒风险分析：**

分析POC代码，主要关注`lib.c`文件，该文件编译成动态链接库，用于替换系统中的某些函数，以执行恶意操作。查看lib.c文件内容发现代码不完整，疑似被删除，但Makefile文件存在编译该lib.c文件的指令。如果lib.c文件包含恶意代码（例如反弹shell或者添加后门用户），则存在投毒风险。由于lib.c内容缺失，无法准确判断，保守估计存在10%的投毒风险，即代码可能被篡改以包含恶意功能，但缺乏明确的证据。

**利用方式：**

1.  **目标确认：**  首先，需要确定目标系统是否存在CVE-2021-3156漏洞，即Sudo版本是否在受影响范围内（小于1.9.5p2）。
2.  **编译：**  使用提供的Makefile编译`hax.c`和`lib.c`，生成可执行文件`sudo-hax-me-a-sandwich`和动态链接库`libnss_X/P0P_SH3LLZ_ .so.2`。
3.  **参数选择：** 根据目标系统选择合适的target，或者手动指定`smash_len_a`，`smash_len_b`，`null_stomp_len`和`lc_all_len`参数。
4.  **执行：**  运行`sudo-hax-me-a-sandwich <target>`或`sudo-hax-me-a-sandwich <smash_len_a> <smash_len_b> <null_stomp_len> <lc_all_len>`，利用漏洞提升权限。
5.  **利用原理：** POC利用了sudoedit在处理以反斜杠结尾的参数时存在的堆缓冲区溢出漏洞。通过构造特定长度的字符串和环境变量，覆盖堆上的数据，劫持程序执行流程，加载恶意的动态链接库，从而执行任意代码，最终获得root权限。

**项目地址:** [DDayLuong/CVE-2021-3156](https://github.com/DDayLuong/CVE-2021-3156)

**漏洞详情:** [CVE-2021-3156](https://nvd.nist.gov/vuln/detail/CVE-2021-3156)