## CVE-2024-9264-Grafana-远程代码执行

**漏洞编号:** CVE-2024-9264

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Grafana

**危害等级:** 高危，可能导致系统完全控制和敏感数据泄露

**影响版本:** 11.0.0 <= version < 11.0.5, 11.0.0 <= version < 11.0.6, 11.1.0 <= version < 11.1.6, 11.1.0 <= version < 11.1.7, 11.2.0 <= version < 11.2.1, 11.2.0 <= version < 11.2.2

**利用条件:** 需要开启SQL Expressions实验性功能, DuckDB二进制文件在Grafana的PATH中, 具有Viewer或更高权限的已认证Grafana用户。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-9264 是 Grafana 中 SQL Expressions 功能的一个远程代码执行漏洞。攻击者可以利用 DuckDB 查询中不足的输入验证，通过注入恶意命令，实现远程代码执行和本地文件包含。PoC 代码通过构造包含反向 shell 命令的 SQL 查询，然后通过 Grafana API 执行该查询。 该漏洞利用依赖于 `shellfs` 社区扩展，利用方式为安装并加载该扩展以执行命令。

**利用方式：**
1.  **身份验证：** 使用 Viewer 或更高权限的账户登录 Grafana。
2.  **构造恶意 SQL 查询：**  构造包含 shellfs 扩展安装和加载，以及反向 shell 命令的 SQL 查询语句。
3.  **发送 API 请求：**  通过 Grafana 的 API 发送包含恶意 SQL 查询的 POST 请求。
4.  **触发反向 Shell：**  执行已构造好的反向 shell 脚本，从而建立反向 shell 连接。

**投毒风险分析：**
PoC 代码本身旨在利用漏洞，没有明显的恶意行为，但是无法排除在真实攻击场景中攻击者添加额外的恶意代码的可能性。PoC代码中安装和加载`shellfs`扩展，并执行反向shell，这是一个完整的漏洞验证流程。如果作者在安装`shellfs`扩展之前或之后，插入额外的命令，可能会存在投毒行为，例如：安装后门，收集用户信息等。 此处判断投毒风险为10%的原因在于，用户可以自行检查代码并根据需要修改反向shell的命令，从而避免被作者投毒。

**有效性：**
该 PoC 代码有效，可以验证 CVE-2024-9264 漏洞的存在，并演示如何利用该漏洞实现远程代码执行。多个搜索结果表明此漏洞是一个严重的安全问题，并且存在可利用的 PoC。

**项目地址:** [Royall-Researchers/CVE-2024-9264](https://github.com/Royall-Researchers/CVE-2024-9264)

**漏洞详情:** [CVE-2024-9264](https://nvd.nist.gov/vuln/detail/CVE-2024-9264)