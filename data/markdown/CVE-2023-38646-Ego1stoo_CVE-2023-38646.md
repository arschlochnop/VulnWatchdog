## CVE-2023-38646 Metabase Pre-Auth RCE

**漏洞编号:** CVE-2023-38646

**漏洞类型:** 远程代码执行

**影响应用:** Metabase

**危害等级:** 高危，未经身份验证的远程代码执行

**影响版本:** Metabase open source before 0.46.6.1 和 Metabase Enterprise before 1.46.6.1

**利用条件:** 目标 Metabase 实例需要运行在受影响的版本范围内，并且攻击者能够通过网络访问到该实例。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2023-38646 允许未经身份验证的攻击者在 Metabase 服务器上执行任意命令。漏洞的利用方式如下：

1.  **漏洞原理：** Metabase 存在一个未授权的 `/api/setup/validate` 接口，该接口用于在 Metabase 首次设置时验证数据库连接。攻击者可以利用此接口，通过构造恶意的 H2 数据库连接字符串，在服务器上执行任意代码。
2.  **利用步骤：**
    *   首先，攻击者访问 Metabase 实例的根路径，获取 `setup-token`。这个token被嵌入在HTML响应的JavaScript代码中，用于后续的设置过程。
    *   然后，攻击者向 `/api/setup/validate` 接口发送 POST 请求，请求体包含一个恶意的 JSON 对象。这个 JSON 对象的 `details.details.db` 字段包含一个特制的 H2 数据库连接字符串。这个连接字符串中嵌入了恶意代码，利用 H2 数据库的 `TRACE_LEVEL_SYSTEM_OUT` 和 `CREATE TRIGGER` 功能来执行任意的 shell 命令。
    *   POC代码构造了一个反弹shell的payload，将目标机器上的输入输出重定向到攻击者控制的机器上，从而实现远程代码执行。
3.  **投毒风险分析：**
    虽然提供的代码主要是用于漏洞利用，但仍存在轻微的投毒风险。风险点主要存在于`CVE-2023-38646.py`脚本中的`payload`变量。当前的`payload`用于创建一个反向shell连接，虽然本身不是恶意代码，但可能被修改为执行更具破坏性的操作。另外，作者提供的github链接中的图片可能是经过修改的。
    总体而言，投毒风险较低，但需要仔细审查代码，确保其没有被篡改或添加恶意功能。


**项目地址:** [Ego1stoo/CVE-2023-38646](https://github.com/Ego1stoo/CVE-2023-38646)

**漏洞详情:** [CVE-2023-38646](https://nvd.nist.gov/vuln/detail/CVE-2023-38646)