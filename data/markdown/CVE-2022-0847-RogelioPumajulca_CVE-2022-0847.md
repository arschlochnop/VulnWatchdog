## CVE-2022-0847 (Dirty Pipe) 本地提权漏洞

**漏洞编号:** CVE-2022-0847

**漏洞类型:** 本地提权

**影响应用:** Linux Kernel

**危害等级:** 高危，可导致普通用户提升为root权限

**影响版本:** Linux kernel 5.8 或更高版本，修复于 5.16.11, 5.15.25, 5.10.102

**利用条件:** 需要本地用户权限

**POC 可用性:** 是

**投毒风险:** 1%

## 详情

CVE-2022-0847，也被称为 Dirty Pipe，是一个 Linux 内核中的本地提权漏洞。该漏洞源于pipe buffer结构中 "flags" 成员未正确初始化，导致其可能包含陈旧的值。未授权的本地用户可以利用此漏洞写入由只读文件支持的页面缓存中的页面，从而提升其在系统上的权限。

**有效性评估：**

根据漏洞库信息、搜索引擎结果（如 Rapid7 的博客、Arctic Wolf 的博客等）以及提供的漏洞利用代码，该漏洞利用的有效性很高。搜索引擎结果表明，存在可靠的利用代码，成功利用该漏洞可以在受影响的系统上获得 root 权限。

**投毒风险分析：**

查看提供的POC代码，该POC的利用方式较为直接，将攻击载荷写入指定文件，实现提权。代码中嵌入了一段Shellcode（`elfcode`）,功能是创建一个具有SUID权限的shell `/tmp/sh`。总体来看，代码逻辑简洁，没有发现明显的恶意行为或隐藏的后门代码。因此，投毒风险较低。

尽管如此，仍然需要谨慎对待任何下载或获取的代码。在实际使用前，建议仔细审查代码，确保其安全性。建议可以进行sandbox测试，确保代码如预期运行。

综合来看，此仓库存在投毒代码的可能性极低，判断为1%。

**漏洞利用方式：**

1.  **漏洞原理：** `copy_page_to_iter_pipe` 和 `push_pipe` 函数中，新的 pipe buffer 结构的 `flags` 成员缺乏正确的初始化，可能包含陈旧的值。
2.  **利用方式：**
    *   利用 `pipe()` 创建一个管道。
    *   利用 `splice()` 将目标文件的内容放入管道，触发漏洞。
    *   通过管道写入恶意内容覆盖目标文件在 page cache 中的内容。
    *   由于目标文件被修改，当执行该文件时，将执行恶意代码，从而提升权限。
3.  **POC代码分析：** 提供的 `exploit.c` 代码首先创建一个管道，然后利用 Dirty Pipe 漏洞覆盖一个 SUID 二进制文件（通常是 `passwd` 命令的副本）。攻击载荷是一个小的 ELF 文件，该文件会在 `/tmp` 目录下创建一个具有 SUID 权限的 shell（`/tmp/sh`），然后普通用户就可以执行该 shell 以 root 权限运行。expolit成功后,会设置`/bin/passwd`的副本,然后利用漏洞将攻击载荷注入到这个`/bin/passwd`的副本中.当用户执行被注入的`/bin/passwd`副本,则获取root权限

**项目地址:** [RogelioPumajulca/CVE-2022-0847](https://github.com/RogelioPumajulca/CVE-2022-0847)

**漏洞详情:** [CVE-2022-0847](https://nvd.nist.gov/vuln/detail/CVE-2022-0847)