## CVE-2021-4034-Polkit-pkexec本地提权

**漏洞编号:** CVE-2021-4034

**漏洞类型:** 本地权限提升

**影响应用:** Polkit

**危害等级:** 高危，未经授权的用户可以获得root权限

**影响版本:** 所有版本 (修复前)

**利用条件:** 本地用户访问pkexec

**POC 可用性:** 是

**投毒风险:** 1%

## 详情

CVE-2021-4034是Polkit的pkexec实用程序中的一个本地权限提升漏洞。pkexec是一个setuid工具，旨在允许非特权用户以特权用户身份运行命令，具体权限取决于预定义的策略。

**漏洞利用方式：**

1.  **漏洞原理：** pkexec未能正确处理调用参数的数量，导致其尝试将环境变量作为命令执行。通过精心构造环境变量，攻击者可以诱使pkexec执行任意代码。

2.  **利用代码分析：**
    *   `cve-2021-4034.c`:  该C代码负责设置特定的环境变量并执行`/usr/bin/pkexec`。关键的环境变量包括：
        *   `pwnkit.so:.`:  这指示动态链接器在当前目录中查找名为`pwnkit.so`的共享对象。
        *   `PATH=GCONV_PATH=.`:  这会将`PATH`环境变量设置为`GCONV_PATH=.`， 影响程序的路径查找方式.
        *   `CHARSET=PWNKIT`: 触发加载恶意gconv模块的关键。
        *   `GIO_USE_VFS=`: 清空`GIO_USE_VFS`环境变量，避免潜在的干扰。
    *   `pwnkit.c`:  该C代码定义了`gconv`和`gconv_init`函数。`gconv_init`函数是漏洞利用的核心，它被设计为在gconv模块加载时执行。此函数会设置uid和gid为0，然后执行`/bin/sh`，从而获得root shell。
    *   `gconv-modules`: 定义了一个gconv模块，将`PWNKIT`字符集映射到`pwnkit.so`库。
    *   `Makefile`:  用于编译漏洞利用代码，生成`pwnkit.so`共享对象和`cve-2021-4034`可执行文件。

3.  **利用步骤：**
    a.  编译`pwnkit.c`生成共享对象`pwnkit.so`。
    b.  创建一个`gconv-modules`文件，声明一个使用`pwnkit.so`的gconv模块。
    c.  执行`cve-2021-4034`，它会设置特定的环境变量并运行`pkexec`。`pkexec`会加载恶意的gconv模块，调用`gconv_init`函数，从而导致权限提升。

**有效性：**提供的PoC代码是有效的。它利用了pkexec中的参数处理漏洞，通过gconv模块机制执行预定义的shell，从而实现本地权限提升。

**投毒风险：** 此仓库存在极小的投毒风险。`dry-run`目录下的文件可以用来进行无害的测试。如果将 `dry-run-cve-2021-4034.c` 中的 `setuid(0)` 修改为恶意操作，则存在投毒可能。但原代码并未发现明显的恶意行为，判定投毒风险为1%。实际部署前需要进行代码审计。

**项目地址:** [EuJin03/CVE-2021-4034-PoC](https://github.com/EuJin03/CVE-2021-4034-PoC)

**漏洞详情:** [CVE-2021-4034](https://nvd.nist.gov/vuln/detail/CVE-2021-4034)