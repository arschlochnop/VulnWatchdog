## CVE-2017-0143

**漏洞编号:** CVE-2017-0143

**漏洞类型:** 远程代码执行

**影响应用:** Windows SMBv1服务器

**危害等级:** 高危，允许远程攻击者执行任意代码

**影响版本:** 受影响版本包括Windows Vista SP2、Windows Server 2008 SP2和R2 SP1、Windows 7 SP1、Windows 8.1、Windows Server 2012 Gold和R2、Windows RT 8.1以及Windows 10 Gold, 1511和1607

**利用条件:** 目标系统启用SMBv1服务，攻击者需要能够通过网络访问目标系统的445端口。

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2017-0143是一个Windows SMB远程代码执行漏洞。该漏洞存在于Microsoft Windows Vista SP2等多个版本的SMBv1服务器中。攻击者可以通过发送特制的SMB数据包利用此漏洞在目标系统上执行任意代码。

**有效性：**
提供的Python脚本 `exploit.py` 是一个针对 MS17-010 (CVE-2017-0143) 的漏洞利用程序。该脚本旨在利用SMBv1协议中的漏洞，允许未经身份验证的远程攻击者在目标系统上执行任意代码。漏洞库信息和搜索引擎结果均表明该漏洞是真实存在的，且有可用的利用代码。

**投毒风险：**
查看`exploit.py`的内容，发现代码结构复杂，包含SMB协议交互的实现，以及针对不同Windows版本的偏移量。虽然代码本身看起来是漏洞利用，但仍需注意潜在的投毒风险。例如，攻击者可能会在payload中嵌入恶意代码，或者修改代码的某些部分以在特定条件下执行恶意操作，这种风险较低，但不能完全排除. 因此,投毒风险评估为5%。

**利用方式：**
1.  **漏洞原理：** 该漏洞源于SMBv1协议处理恶意构造的数据包时，没有正确验证数据包的长度，导致缓冲区溢出，进而允许攻击者执行任意代码。
2.  **利用过程：**
    *   攻击者使用 `exploit.py` 脚本指定目标IP地址。
    *   脚本通过SMB协议与目标系统建立连接。
    *   脚本发送特制的SMB数据包，该数据包包含溢出payload。
    *   目标系统接收到恶意数据包后，SMBv1服务器处理数据包时发生缓冲区溢出。
    *   溢出payload覆盖内存中的关键区域，例如函数返回地址。
    *   当函数返回时，程序控制流被劫持到攻击者控制的区域，从而执行攻击者提供的恶意代码。
3. **利用细节:**
  * 该漏洞利用利用了与 EternalRomance 和 EternalSynergy 相同的漏洞，因此需要命名管道。
  *  该脚本通过覆盖 `SrvSecContext` 结构中的 `Token` 字段为 NULL，并将 `UsePsImpersonateClient` 字段设置为 true，从而允许运行的线程使用主令牌（SYSTEM）来执行所有 SMB 操作。对于 Windows 2003 及更早版本，该利用会修改 PCtxtHandle 中的令牌用户和组以获得 SYSTEM 权限，因为这些 Windows 版本中仅使用 `ImpersonateSecurityContext()`。

**总结：**
该漏洞利用的有效性较高，因为漏洞信息和公开的漏洞利用代码的存在，但需要仔细检查漏洞利用代码，确保其安全性，并在测试环境中使用，防止任何潜在的恶意行为。


**项目地址:** [h3x0v3rl0rd/MS17-010](https://github.com/h3x0v3rl0rd/MS17-010)

**漏洞详情:** [CVE-2017-0143](https://nvd.nist.gov/vuln/detail/CVE-2017-0143)