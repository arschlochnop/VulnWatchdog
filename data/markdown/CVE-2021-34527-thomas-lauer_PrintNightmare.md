## CVE-2021-34527 PrintNightmare

**漏洞编号:** CVE-2021-34527

**漏洞类型:** 远程代码执行

**影响应用:** Windows Print Spooler

**危害等级:** 高危，允许攻击者以SYSTEM权限执行任意代码

**影响版本:** 受影响的Windows版本详见漏洞库信息

**利用条件:** 需要Print Spooler服务运行，且用户具有一定权限（至少是域内用户或本地用户）

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-34527，也被称为PrintNightmare，是一个Windows Print Spooler服务中的远程代码执行漏洞。攻击者可以通过不当的文件操作获得SYSTEM权限，从而安装程序，查看、更改或删除数据，或创建具有完全用户权限的新帐户。

**有效性：**
根据漏洞库信息和搜索结果，此漏洞是真实存在的，并且存在公开的PoC。

**利用方式：**
利用方式主要围绕着对`C:\Windows\System32\spool\drivers`目录的ACL权限进行修改，上传恶意DLL，然后触发打印服务加载该DLL，从而以SYSTEM权限执行任意代码。

**PoC代码分析：**
提供的PoC代码主要分为以下几类：

1.  **备份/恢复ACL：**
    *   `BackupAclPrintSpooler.cmd`和`DattoRMMAclComponenteAngepasst.ps1`用于备份`C:\Windows\System32\spool\drivers`目录的ACL，以便在利用后恢复。
2.  **修改ACL：**
    *   `SetAclPrintSpooler.cmd`和`SetACL.ps1`用于设置ACL，通常是拒绝SYSTEM用户对`C:\Windows\System32\spool\drivers`目录的写入权限（Deny）。
    *  `RemoveAclPrintSpooler.cmd`和`RemoveACL.ps1`用于移除SYSTEM用户对`C:\Windows\System32\spool\drivers`目录的拒绝权限。
    *  `DattoRMMAclComponenteAngepasst.ps1` 脚本允许选择授予或拒绝SYSTEM账户对 spool\drivers 文件夹的访问权限，在不同的利用场景下进行权限控制。
3.  **监控策略：**
    *   `Monitoring Policy SYSMON_PrinterSpooler.pcy`是一个Sysmon策略，用于监控与打印服务相关的事件。
4.  **其他：**
    *   `RestrictDriverInstallationToAdministrators.cmd`通过修改注册表来限制只有管理员才能安装打印驱动程序，是一个缓解措施。
    * `StopUnusedPrinterserver.ps1`尝试停止域内不使用的打印服务，也是缓解措施。

**投毒风险：**
PoC代码本身的功能主要是修改ACL和备份ACL，属于防御性质的，但也可能被用于攻击的前置条件，有投毒风险。
其中`DattoRMMAclComponenteAngepasst.ps1`脚本，根据用户选择grant/deny权限，脚本中没有发现直接执行恶意代码的部分，主要作用还是配置ACL权限。因此，投毒风险较低，约10%。

总的来说，这些PoC代码本身不包含直接执行恶意代码的后门，但攻击者可以利用这些脚本作为攻击链的一部分，例如先修改ACL，上传恶意DLL，然后利用漏洞执行代码。因此，PoC代码本身存在一定的被恶意利用的风险。

**项目地址:** [thomas-lauer/PrintNightmare](https://github.com/thomas-lauer/PrintNightmare)

**漏洞详情:** [CVE-2021-34527](https://nvd.nist.gov/vuln/detail/CVE-2021-34527)