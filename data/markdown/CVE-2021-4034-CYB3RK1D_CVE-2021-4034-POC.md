## CVE-2021-4034-Polkit pkexec 本地提权漏洞

**漏洞编号:** CVE-2021-4034

**漏洞类型:** 本地权限提升

**影响应用:** Polkit pkexec

**危害等级:** 高危，允许低权限用户获得 root 权限

**影响版本:** all (受影响版本)

**利用条件:** 本地用户可执行 pkexec

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-4034（PwnKit）是 polkit pkexec 工具中的一个本地权限提升漏洞。pkexec 是一个 setuid 工具，允许非特权用户按照预定义的策略以特权用户身份运行命令。漏洞的根本原因是 pkexec 没有正确处理调用参数计数，导致程序尝试将环境变量作为命令执行。

**漏洞利用方式：**

1.  **利用 GCONV_PATH 和 CHARSET 环境变量：** 该漏洞利用通过精心构造 `GCONV_PATH` 和 `CHARSET` 环境变量，欺骗 `pkexec` 加载恶意的 gconv 模块。gconv 模块是用于字符集转换的动态链接库。
2.  **创建恶意 gconv 模块：** 攻击者创建一个包含恶意代码的 `.so` 文件（payload.so），并在 `gconv-modules` 文件中定义一个字符集转换规则，将特定的字符集（例如 `LPE`）映射到该恶意 `.so` 文件。
3.  **触发漏洞：** 当 `pkexec` 尝试执行字符集转换时，会加载并执行恶意 `.so` 文件中的代码，从而实现权限提升。
4.  **代码分析：** `pkexec_exploit.c` 首先创建必要的目录结构 (`GCONV_PATH=.`, `lpe`)，然后在 `lpe/payload.c` 中写入 shellcode，编译成动态链接库 `lpe/payload.so`。shellcode 的作用是设置 uid、gid 为 0，然后执行 `/bin/sh`。
5.   **投毒风险分析:** POC代码本身主要用于提权，但存在一定的投毒风险。例如，攻击者可能修改 `payload.c` 中的 shellcode，使其在提权后执行其他恶意操作，如安装后门程序、窃取用户数据等。虽然`pkexec_exploit.c`主要功能是利用漏洞进行权限提升，但其中的`payload.c`，可能包含潜在的恶意代码。payload.c中的恶意代码可能执行以下操作：下载并执行其他恶意程序、修改系统文件、创建具有root权限的后门帐户等。从防御的角度来看，所有来自外部的代码都应被视为潜在的威胁。

**有效性：**

根据漏洞描述、搜索引擎结果和提供的 POC 代码，可以判断该漏洞的利用是有效的。POC 代码已经公开，并且有大量的文章和视频演示了如何利用该漏洞。

**总结：**

这是一个严重的安全漏洞，允许未经授权的用户获得系统 root 权限。系统管理员应尽快应用补丁程序来修复此漏洞。

**项目地址:** [CYB3RK1D/CVE-2021-4034-POC](https://github.com/CYB3RK1D/CVE-2021-4034-POC)

**漏洞详情:** [CVE-2021-4034](https://nvd.nist.gov/vuln/detail/CVE-2021-4034)