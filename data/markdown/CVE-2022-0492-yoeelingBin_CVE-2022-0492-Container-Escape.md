## CVE-2022-0492-Linux内核cgroups v1 release_agent权限提升漏洞

**漏洞编号:** CVE-2022-0492

**漏洞类型:** 权限提升

**影响应用:** Linux Kernel

**危害等级:** 高危，可导致容器逃逸和主机权限提升

**影响版本:** kernel 5.17 rc3 (受影响版本可能更广泛，需具体环境测试)

**利用条件:** 需要开启cgroups v1功能，且容器内需要一定的权限，例如CAP_SYS_ADMIN或通过unshare命令获取

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2022-0492漏洞存在于Linux内核的cgroup v1实现中，具体位于`kernel/cgroup/cgroup-v1.c`文件的`cgroup_release_agent_write`函数。该漏洞允许攻击者利用`release_agent`特性来提升权限和绕过命名空间隔离。PoC代码通过以下步骤利用该漏洞：

1.  **创建cgroup目录:** 在`/tmp/cgrp`目录下创建一个新的cgroup目录。
2.  **启用release_agent:** 设置`notify_on_release`为1，启用`release_agent`功能。
3.  **查找容器在宿主机上的文件系统路径:** 通过读取`/etc/mtab`文件，找到容器的文件系统在宿主机上的路径。
4.  **写入release_agent:** 将一个指向宿主机文件系统上的脚本的路径写入`release_agent`文件中。这个脚本将在cgroup被释放时执行。
5.  **写入恶意脚本:** 将包含恶意命令的脚本写入到宿主机的文件系统上。
6.  **触发release_agent:** 将当前进程的PID写入`cgroup.procs`文件，然后触发cgroup释放，从而执行`release_agent`指向的脚本。
7. **权限检查与获取:** 如果当前进程没有`CAP_SYS_ADMIN`权限，PoC会尝试使用`unshare`命令创建一个新的用户、挂载和Cgroup命名空间，以获得必要的权限。

**有效性：** 根据漏洞描述和PoC代码分析，该漏洞利用方式是有效的，可以实现容器逃逸和权限提升。漏洞库信息、搜索引擎结果均指向该漏洞可被利用进行权限提升。

**投毒风险：** 评估为10%。该PoC代码的风险在于执行任意命令，本身不包含明显的恶意Payload，但用户可以自定义`cmd`参数，执行任意命令，存在一定的风险。例如，攻击者可能在传入的`cmd`参数中添加反弹shell、下载恶意文件等操作。代码虽然引用了外部链接，但是主要为参考链接，本身未发现混淆和隐藏的后门代码。

**利用方式总结：** 攻击者利用cgroup v1的`release_agent`特性，通过修改`release_agent`文件指向一个位于宿主机上的恶意脚本，当cgroup被释放时，该脚本将以root权限执行，从而实现容器逃逸和权限提升。该漏洞利用依赖于cgroup v1的启用和一定的容器权限。

**项目地址:** [yoeelingBin/CVE-2022-0492-Container-Escape](https://github.com/yoeelingBin/CVE-2022-0492-Container-Escape)

**漏洞详情:** [CVE-2022-0492](https://nvd.nist.gov/vuln/detail/CVE-2022-0492)