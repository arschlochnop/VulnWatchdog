## CVE-2021-4034-Polkit-pkexec本地提权漏洞

**漏洞编号:** CVE-2021-4034

**漏洞类型:** 本地提权

**影响应用:** Polkit

**危害等级:** 高危，允许低权限用户提升到root权限

**影响版本:** 所有版本

**利用条件:** 需要本地用户访问pkexec

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-4034是Polkit的pkexec实用程序中的一个本地权限提升漏洞。pkexec是一个setuid工具，允许非特权用户根据预定义的策略以特权用户身份运行命令。该漏洞是由于pkexec未正确处理调用参数计数，导致尝试将环境变量作为命令执行。攻击者可以通过精心构造环境变量来诱导pkexec执行任意代码，从而将非特权用户提升到目标机器上的管理员权限。

**漏洞利用方式：**

1.  **原理：** pkexec在处理参数时存在缺陷，错误地将环境变量当作程序路径执行。
2.  **利用：** 通过创建包含恶意代码的环境变量，并让pkexec执行，从而获得root权限。

**POC代码分析：**

提供的POC代码利用了`GCONV_PATH`环境变量。该变量用于指定gconv模块的路径，gconv模块用于字符集转换。攻击者通过以下步骤利用漏洞：

1.  创建`GCONV_PATH=.`目录，并创建一个名为`pwnkit`的文件，并修改其权限为可执行。
2.  在`pwnkit`目录下创建`gconv-modules`文件，指定一个自定义的gconv模块`PWNKIT`。
3.  创建`pwnkit/pwnkit.so`，其中包含恶意的shellcode。该shellcode会被`pkexec`执行，从而获得root权限。
4.  运行`fan`程序触发漏洞。

**有效性：**

根据漏洞描述和POC代码，可以判断该漏洞利用是有效的。搜索引擎结果也表明该漏洞已被广泛利用。

**投毒风险：**

该POC代码中存在一定的投毒风险。虽然主要目的是利用`pkexec`的漏洞进行提权，但恶意代码也可以被隐藏在`pwnkit/pwnkit.so` 文件里。例如，可以添加额外的逻辑来修改系统文件、安装后门或者发送敏感信息。但是，该风险较低。用户可以相对容易地检查 `pwnkit/pwnkit.so` 文件，通过反编译等手段来发现其中的恶意代码。并且利用此漏洞的目的就是提权, 增加投毒代码收益不高。因此，评估投毒风险为10%。该代码的作者可能会植入其他恶意代码的可能性较低。

**项目地址:** [supportingmx/cve-2021-4034](https://github.com/supportingmx/cve-2021-4034)

**漏洞详情:** [CVE-2021-4034](https://nvd.nist.gov/vuln/detail/CVE-2021-4034)