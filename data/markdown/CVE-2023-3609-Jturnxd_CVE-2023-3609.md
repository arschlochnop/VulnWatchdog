## CVE-2023-3609 - Linux Kernel cls_u32 Use-After-Free

**漏洞编号:** CVE-2023-3609

**漏洞类型:** Use-After-Free

**影响应用:** Linux Kernel

**危害等级:** 高危，本地权限提升

**影响版本:** < 6.4

**利用条件:** 需要本地用户权限和CAP_NET_ADMIN capability, 并且CONFIG_NET_SCHED 和 CONFIG_NET_CLS_U32需要开启

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2023-3609 是 Linux 内核 net/sched: cls_u32 组件中的一个 use-after-free 漏洞，攻击者可以利用此漏洞获得本地权限提升。

**有效性：**

根据提供的漏洞信息和漏洞利用代码，POC代码似乎是有效的。漏洞库信息显示该漏洞存在于Linux kernel 4.14 到 6.4版本。搜索引擎结果也确认了该漏洞的存在和危害。漏洞利用代码的metadata.json文件也包含了受影响的版本范围以及利用该漏洞所需的环境和配置。不过github issue 163 指出， CVE-2023-3609 的PoC可能存在mapping错误，可能实际利用的是CVE-2023-4208。

**投毒风险：**

分析POC代码内容，发现漏洞利用涉及复杂的内核对象操作，特别是网络调度相关的配置。虽然利用代码中包含了提权操作，例如修改 `/proc/sys/kernel/core_pattern` 来执行任意命令，但没有发现明显的恶意后门代码。

以下是对代码可能存在的投毒风险的分析：

*   **风险点：** 攻击者可能会在eBPF程序中植入恶意代码，或者在内存喷射阶段使用特定数据覆盖关键内核数据结构，从而在提权后执行恶意操作。
*   **缓解措施：** 仔细审查eBPF程序的内容，确保其功能与漏洞利用的描述一致。监控`/proc/sys/kernel/core_pattern`文件，防止被恶意修改。
*   **投毒风险百分比：**10%。因为代码主要集中在漏洞利用和提权方面，没有发现明显的恶意代码，但仍需谨慎评估，因为内核漏洞利用的复杂性很高，很难完全排除潜在的投毒风险。

**利用方式：**

1.  **触发漏洞：** 通过精心构造的网络数据包和流量控制规则，触发 `tcf_change_indev()` 失败，导致 `u32_set_parms()` 中的引用计数错误，从而释放了本不应该释放的 `qdisc class` 对象。
2.  **利用UAF：** 当数据包到达网络接口时，如果与包含已释放的 `qdisc class` 的过滤器匹配，则会尝试使用该对象，从而导致 use-after-free。
3.  **内存喷射：** 通过内存喷射（例如，使用 `sendmsg` 和 `ctl_buf`，或者 `ctnetlink_filter`）重新分配已释放的内存，并用恶意数据覆盖它。
4.  **控制RIP：** 通过控制 `cl->qdisc->enqueue` 函数指针，实现RIP控制，跳转到预先布置的 shellcode（通常位于 eBPF JIT 代码页）。
5.  **权限提升：** 在 shellcode 中，覆盖 `/proc/sys/kernel/core_pattern` 文件，以便在内核崩溃时执行任意命令，从而获得 root 权限。
6.  **KASLR绕过：**通过喷射大量的eBPF程序，利用`SO_ATTACH_FILTER` 泄露内核地址。

**项目地址:** [Jturnxd/CVE-2023-3609](https://github.com/Jturnxd/CVE-2023-3609)

**漏洞详情:** [CVE-2023-3609](https://nvd.nist.gov/vuln/detail/CVE-2023-3609)