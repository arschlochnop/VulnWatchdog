## CVE-2024-4577-PHP-CGI Argument Injection

**漏洞编号:** CVE-2024-4577

**漏洞类型:** 远程代码执行(RCE)

**影响应用:** PHP

**危害等级:** 严重，可导致远程代码执行，服务器完全控制

**影响版本:** PHP 8.1.* before 8.1.29, 8.2.* before 8.2.20, 8.3.* before 8.3.8 (Windows, CGI mode, Best Fit code page)

**利用条件:** Windows服务器，PHP以CGI模式运行，启用使用"Best Fit"策略的代码页

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2024-4577 漏洞存在于 Windows 环境下以 CGI 模式运行的 PHP 中。当系统配置为使用某些代码页时，Windows 可能会使用 “Best-Fit” 行为来替换传递给 Win32 API 函数的命令行中的字符。PHP CGI 模块可能会错误地将这些字符解释为 PHP 选项，从而允许恶意用户将选项传递给正在运行的 PHP 二进制文件，进而泄露脚本源码，或者在服务器上执行任意 PHP 代码。

**有效性分析：**
根据漏洞库信息、搜索引擎结果（如Akamai观察到漏洞利用尝试）和提供的漏洞利用代码（POC），可以判断该漏洞利用是有效的。POC代码通过构造包含恶意 PHP 选项的 URL，成功执行了系统命令（calc）。

**投毒风险分析：**
分析提供的POC代码，主要的风险点在于用户指定的`-c`参数，攻击者可通过该参数执行任意PHP代码。仓库本身存在投毒的可能性较低。大部分代码是用于构造payload和发送请求，直接利用该代码进行投毒的可能性较低。 风险评估为5%（极低，主要来自对外部payload的依赖和代码的可修改性）。

**利用方式：**
1.  **环境准备：** 目标服务器必须是 Windows 系统，并且 PHP 以 CGI 模式运行，同时配置了使用 “Best Fit” 策略的代码页。
2.  **构造 Payload：** 使用 POC 代码，通过 `-c` 参数指定要执行的 PHP 代码。例如，执行 `system('calc')` 打开计算器。
3.  **发送请求：** 将构造好的 Payload 附加到目标 URL 后面，通过 POST 请求发送到目标服务器。
4.  **利用原理：**  由于 “Best Fit” 行为，Windows 会对 URL 中的某些字符进行替换，使得 PHP CGI 模块错误地将这些字符解释为 PHP 选项。例如，`?%ADd+allow_url_include%3d1+-d+auto_prepend_file%3dphp://input`，这允许攻击者包含远程文件或者直接执行 POST 数据中的 PHP 代码。
5.  **RCE:** 成功利用漏洞后，服务器将执行攻击者指定的 PHP 代码，实现远程代码执行。

**项目地址:** [watchtowrlabs/CVE-2024-4577](https://github.com/watchtowrlabs/CVE-2024-4577)

**漏洞详情:** [CVE-2024-4577](https://nvd.nist.gov/vuln/detail/CVE-2024-4577)