## CVE-2016-5195 - Dirty COW 本地提权漏洞

**漏洞编号:** CVE-2016-5195

**漏洞类型:** 本地提权

**影响应用:** Linux Kernel

**危害等级:** 高危，可导致普通用户提升至root权限

**影响版本:** Linux kernel 2.x through 4.x before 4.8.3

**利用条件:** 本地用户权限，目标系统内核版本存在漏洞

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2016-5195（Dirty COW）是一个Linux内核中的竞争条件漏洞，存在于内存管理子系统 `mm/gup.c` 中。该漏洞允许恶意本地用户利用写时复制（COW）机制中的不当处理，从而写入只读内存映射，最终获得提升的权限。

**有效性分析：**

提供的PoC代码是一个Golang实现的Dirty COW漏洞利用程序。它通过以下步骤利用该漏洞：

1.  **备份目标文件：** 将 `/usr/bin/passwd` 备份到 `/tmp/bak` 目录，以便后续恢复。
2.  **打开目标文件：** 以只读方式打开 `/usr/bin/passwd`。
3.  **内存映射：** 使用 `mmap` 系统调用将 `/usr/bin/passwd` 映射到内存。
4.  **竞争条件：** 启动两个goroutine，一个使用 `madvise` 系统调用释放内存页，另一个使用 `lseek` 系统调用重置文件偏移量，从而触发竞争条件。
5.  **写入 Payload：**  在竞争条件发生时，覆盖只读内存映射中的内容，将 MSFV payload (一个shellcode)写入/usr/bin/passwd
6.  **执行Payload：** 覆盖完成后,执行/usr/bin/passwd获取root shell
7.  **恢复目标文件：** 覆盖完成后，执行/usr/bin/passwd时拥有了root权限

根据漏洞信息和搜索结果，该漏洞利用方法是有效的。多个漏洞库和安全公告都确认了该漏洞的存在和利用的广泛性。

**投毒风险分析：**

查看代码，发现代码存在一定的投毒风险。虽然代码主要实现了Dirty COW漏洞的利用，但存在以下潜在风险：

*   **Payload内容：** MSFV_payload 是ELF格式shellcode,其中包含反弹shell等恶意行为，如果利用该EXP,使用者可能会受到攻击. *   **权限问题：** 该EXP会修改/usr/bin/passwd,可能会影响部分业务的正常运行
 综合评估，该代码存在一定的投毒风险，建议使用者仔细审查代码后再使用。

**漏洞利用方式：**

1.  利用`mmap`系统调用将目标文件（如 `/usr/bin/passwd`）映射到内存，即使该文件是只读的。
2.  创建一个线程，该线程重复调用`madvise`系统调用，并使用`MADV_DONTNEED`标志，以释放内存页。
3.  创建一个线程，该线程重复调用`lseek`系统调用，并重置文件偏移量。
4.  在竞争条件发生时，覆盖只读内存映射中的内容，从而修改文件内容。
5.  通过修改后的文件内容，实现提权或其他恶意目的。

**项目地址:** [TotallyNotAHaxxer/CVE-2016-5195](https://github.com/TotallyNotAHaxxer/CVE-2016-5195)

**漏洞详情:** [CVE-2016-5195](https://nvd.nist.gov/vuln/detail/CVE-2016-5195)