## CVE-2019-5420-Rails-RCE

**漏洞编号:** CVE-2019-5420

**漏洞类型:** 远程代码执行

**影响应用:** Rails

**危害等级:** 高危，可能导致服务器完全控制

**影响版本:** <5.2.2.1, <6.0.0.beta3 (Development Mode)

**利用条件:** Rails应用运行于开发模式，且攻击者可以访问应用

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2019-5420是一个Rails框架在开发模式下的远程代码执行漏洞。攻击者可以猜测自动生成的开发模式secret token，并将其与其他Rails内部组件结合，从而提升权限至远程代码执行。

**有效性：**
提供的POC代码有效。它利用了ActiveSupport::MessageVerifier的反序列化漏洞，通过构造恶意的ERB对象，并将其包装在DeprecatedInstanceVariableProxy中，生成一个带有签名的payload。当易受攻击的Rails应用反序列化该payload时，会执行任意Ruby代码。

**投毒风险：**
该代码仓库主要包含漏洞利用的POC，旨在演示漏洞如何被利用。快速浏览LICENSE，README.md以及POC.rb文件，未发现存在恶意代码。POC代码逻辑合理，仅用于漏洞复现，风险较低。因此，投毒风险为0%。

**利用方式：**
1.  **获取目标应用的名称：**  POC脚本首先确定目标Rails应用的名称（`PentesterLab::Application`，可以修改）。
2.  **生成`secret_key_base`：**  使用目标应用名称的MD5哈希值作为`secret_key_base`。
3.  **派生`ActiveStorage`密钥：**  使用`ActiveSupport::KeyGenerator`从`secret_key_base`派生出`ActiveStorage`密钥。
4.  **创建`MessageVerifier`：**  使用派生的`ActiveStorage`密钥创建一个`ActiveSupport::MessageVerifier`实例。
5.  **构造恶意ERB对象：**  创建一个包含恶意Ruby代码的ERB对象。代码中执行了命令“`/usr/local/bin/score Pwned`”，可以替换为攻击者希望执行的任何命令。
6.  **包装ERB对象：**  将恶意的ERB对象包装在`ActiveSupport::Deprecation::DeprecatedInstanceVariableProxy`中，以绕过一些安全检查。
7.  **生成利用Token：**  使用`MessageVerifier`对包装后的对象进行签名，生成一个利用Token。
8.  **利用：**  将生成的Token发送到目标Rails应用。如果应用启用了开发模式，并且版本低于5.2.2.1或6.0.0.beta3，则在反序列化Token时将执行恶意代码。

**搜索引擎结果印证：** 搜索结果表明，该漏洞是真实存在的，并且已经被广泛研究。例如，PentesterLab提供了一个练习来学习如何利用该漏洞。


**项目地址:** [WildWestCyberSecurity/cve-2019-5420-POC](https://github.com/WildWestCyberSecurity/cve-2019-5420-POC)

**漏洞详情:** [CVE-2019-5420](https://nvd.nist.gov/vuln/detail/CVE-2019-5420)