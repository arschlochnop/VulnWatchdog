## CVE-2021-1675 PrintNightmare Windows Print Spooler RCE

**漏洞编号:** CVE-2021-1675

**漏洞类型:** 远程代码执行

**影响应用:** Windows Print Spooler

**危害等级:** 高危，可能导致远程代码执行，系统权限提升

**影响版本:** 受影响的Windows版本众多，详见漏洞库信息

**利用条件:** 目标系统启用Print Spooler服务，攻击者需要具有一定的访问权限（部分PoC可实现本地提权）。部分利用方式需要域环境。

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2021-1675（PrintNightmare）是一个Windows Print Spooler远程代码执行漏洞。利用方式主要通过AddPrinterDriverEx函数，允许攻击者加载恶意的DLL文件到Print Spooler服务中，从而以SYSTEM权限执行任意代码。

**有效性：**

提供的POC代码（Invoke-Nightmare.ps1）看起来是有效的。它通过调用AddPrinterDriverEx函数来添加恶意打印机驱动程序，并加载指定的DLL文件。代码包含创建新用户并将其添加到本地管理员组的功能，以及执行自定义DLL的功能。搜索引擎结果也表明该漏洞存在公开的PoC。

**投毒风险：**

该POC的投毒风险较低，约为5%。代码的主要功能是利用漏洞，但存在以下潜在的投毒点：

*   **默认DLL：** POC代码使用默认的内置DLL来创建用户。虽然代码中提供了自定义DLL的选项，但用户可能直接使用默认设置，导致所有被攻击的机器上都存在相同的用户名和密码，形成后门，攻击者可以利用该后门进一步攻击。
*   **随机用户名生成：** 虽然代码试图生成随机的用户名，但是如果随机数生成器的种子存在问题，或者攻击者可以预测生成的用户名，也可能被利用。
*   **网络共享DLL：** 如果DLL是通过网络共享加载的，则可能被替换成恶意的DLL。
*   **代码混淆：** 虽然提供的代码没有明显的混淆，但是攻击者可以对PoC进行修改，增加混淆或者添加其他恶意功能。

总体来看，代码本身是漏洞利用代码，并非有意设计的投毒代码，风险较低。

**利用方式：**

1.  **加载恶意DLL：** 攻击者可以使用Invoke-Nightmare.ps1脚本，指定一个恶意的DLL文件作为打印机驱动程序。
2.  **AddPrinterDriverEx函数：** 脚本会调用AddPrinterDriverEx函数，将恶意的DLL文件加载到Print Spooler服务中。
3.  **SYSTEM权限执行：** 由于Print Spooler服务以SYSTEM权限运行，因此加载的DLL文件也会以SYSTEM权限执行，攻击者从而获得对系统的完全控制。
4.  **本地提权/远程代码执行：** 如果攻击者已经具有一定的本地权限，可以通过该漏洞提升到SYSTEM权限。如果目标系统存在其他漏洞，攻击者也可以通过远程方式触发Print Spooler服务加载恶意DLL，实现远程代码执行。
5.  **创建后门用户：** POC默认行为是创建具有已知密码的本地管理员用户，用于持久化访问。

**项目地址:** [jj4152/cve-2021-1675](https://github.com/jj4152/cve-2021-1675)

**漏洞详情:** [CVE-2021-1675](https://nvd.nist.gov/vuln/detail/CVE-2021-1675)