## CVE-2021-30180 Apache Dubbo RCE via Condition route poisoning

**漏洞编号:** CVE-2021-30180

**漏洞类型:** 远程代码执行

**影响应用:** Apache Dubbo

**危害等级:** 高危，可能导致服务器完全控制

**影响版本:** < 2.7.9

**利用条件:** 需要Dubbo服务使用了存在漏洞的版本，并且开启了tag路由功能。攻击者需要能够影响路由规则的配置。

**POC 可用性:** 是

**投毒风险:** 1%

## 详情

CVE-2021-30180是Apache Dubbo中一个由于不安全地反序列化YAML数据而导致的远程代码执行漏洞。该漏洞存在于Dubbo的tag路由功能中，该功能允许根据请求的标签将请求路由到特定的服务器。攻击者可以通过构造恶意的YAML路由规则，将任意构造器加入其中，当Dubbo服务消费者解析这些规则时，触发不安全的反序列化过程，从而执行任意代码。根据漏洞库信息和搜索引擎结果，此漏洞存在于2.7.9之前的版本。

**有效性：**
漏洞利用代码中仅包含版本变更的文本信息，无法直接用于验证漏洞。需要结合漏洞原理，构造特定的YAML路由规则才能进行利用。因此，仅从提供的代码片段来看，无法确认漏洞的有效性，但漏洞原理本身是明确的，通过构造恶意的YAML可以实现RCE。

**投毒风险：**
提供的代码片段是一个版本变更日志，没有发现明显的恶意代码。但是，考虑到这是一个公共仓库，仍然存在作者在其他文件中添加恶意代码的可能性。谨慎起见，假设存在1%的投毒风险。实际评估时，应仔细检查仓库中的所有文件，特别是与路由规则配置、YAML解析相关的部分。

**利用方式：**
1.  **找到受影响的Dubbo服务：** 目标Dubbo服务使用的版本小于2.7.9，并且开启了Tag路由功能。
2.  **构造恶意的YAML路由规则：**  YAML路由规则包含可以执行任意代码的构造器。例如，可以使用`!!javax.script.ScriptEngineManager`来执行JavaScript代码，或者使用`!!com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl`来加载并执行恶意类。
3.  **将恶意的路由规则注入到Dubbo配置中：**  通过Dubbo的管理界面、配置文件、注册中心等方式，将构造的恶意YAML路由规则注入到Dubbo配置中。
4.  **触发路由规则解析：**  当Dubbo服务消费者接收到包含恶意YAML路由规则的配置时，会尝试解析这些规则，触发不安全的反序列化过程，执行攻击者注入的任意代码。

**项目地址:** [shoucheng3/apache__dubbo_CVE-2021-30180_2-7-9](https://github.com/shoucheng3/apache__dubbo_CVE-2021-30180_2-7-9)

**漏洞详情:** [CVE-2021-30180](https://nvd.nist.gov/vuln/detail/CVE-2021-30180)