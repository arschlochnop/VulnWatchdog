## CVE-2019-3396 - Atlassian Confluence Widget Connector Server-Side Template Injection

**漏洞编号:** CVE-2019-3396

**漏洞类型:** Server-Side Template Injection (SSTI)

**影响应用:** Atlassian Confluence Server

**危害等级:** 高危，可导致远程代码执行

**影响版本:** 受影响版本包括6.6.12之前, 6.7.0 - 6.12.3之前, 6.13.0 - 6.13.3之前, 6.14.0 - 6.14.2之前

**利用条件:** 需要Confluence服务器存在Widget Connector宏并且允许用户插入恶意模板。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2019-3396 是一个 Atlassian Confluence Server 中的服务器端模板注入漏洞。该漏洞存在于 Widget Connector 宏中。攻击者可以利用 Velocity 模板引擎执行任意代码。提供的POC代码使用Velocity模板语言，通过 `java.lang.Runtime` 类执行系统命令。此示例中，POC代码尝试启动 macOS 计算器应用程序。该POC的有效性取决于Confluence服务器上Velocity模板引擎的配置以及是否有安全策略阻止执行任意Java代码。根据搜索结果,此漏洞已被广泛利用,包括部署加密货币挖矿恶意软件和GandCrab勒索软件。

**利用方式：**
攻击者构造包含恶意Velocity模板代码的请求，Confluence服务器解析该模板时会执行攻击者注入的命令。通常是通过修改页面内容，添加包含恶意代码的Widget Connector宏来实现。

**投毒风险评估：**
提供的POC代码本身功能明确，即执行指定的系统命令。其中`/Applications/Calculator.app/Contents/MacOS/Calculator` 这个路径只是一个PoC，用于验证是否存在RCE，如果攻击者将这个路径改成下载恶意软件的命令,这可能会被识别为投毒。 除非攻击者能够找到方法在该POC中隐藏其他恶意行为（例如通过Base64编码或其他混淆技术隐藏反弹shell代码），否则直接的投毒风险较低。但是，攻击者可以修改这个PoC中的执行命令为任意命令，存在一定的投毒风险，所以风险比例为10%。

**项目地址:** [xiaoshuier/CVE-2019-3396](https://github.com/xiaoshuier/CVE-2019-3396)

**漏洞详情:** [CVE-2019-3396](https://nvd.nist.gov/vuln/detail/CVE-2019-3396)