## CVE-2019-11043-PHP-FPM远程代码执行

**漏洞编号:** CVE-2019-11043

**漏洞类型:** 远程代码执行

**影响应用:** PHP-FPM

**危害等级:** 高危，可能导致服务器完全控制

**影响版本:** PHP 7.1.x (< 7.1.33), 7.2.x (< 7.2.24), 7.3.x (< 7.3.11)

**利用条件:** PHP-FPM 使用 Nginx，且 Nginx 配置不当。攻击者需要能够发送特制的 HTTP 请求。

**POC 可用性:** 是

**投毒风险:** 20%

## 详情

CVE-2019-11043 是一个 PHP-FPM 的远程代码执行漏洞，它源于 PHP-FPM 在处理 `env_path_info` 时的 underflow 缺陷。该漏洞仅影响使用 Nginx 作为反向代理且配置不当的 PHP-FPM 环境。攻击者通过构造特定的 URL，可以导致 FPM 模块写入超出分配缓冲区的数据，覆盖 FCGI 协议数据，从而实现远程代码执行。

**利用方式：**

1.  攻击者首先需要确定目标服务器是否使用了 Nginx + PHP-FPM 架构，并且存在漏洞。
2.  通过发送包含特殊构造的 PATH_INFO 的 HTTP 请求，触发 PHP-FPM 的 underflow 漏洞。
3.  攻击者可以控制写入的数据，覆盖 FCGI 协议数据，进而执行任意 PHP 代码，最终控制服务器。

**POC 分析：**

提供的 POC 代码是一个 C++ 程序，用于自动化 CVE-2019-11043 的利用过程。该程序首先确定目标服务器的 QSL (Query String Length) 和 header length，然后发送一系列包含恶意 PHP 配置指令的 HTTP 请求，这些配置指令会将任意代码写入 error log 文件，然后通过 extension 加载执行 error log 的方式执行代码。

**投毒风险分析：**

尽管代码本身实现了漏洞利用，但是`php_hack.exe`是一个二进制文件，存在被替换成恶意文件的风险，如果原作者提供了其他恶意链接，存在比较大的投毒风险。代码中通过`extension=%22$_GET%5Ba%5D%60%3F%3E%22`设置，使得攻击者可以通过GET参数a执行任意代码，存在后门， 但是这是漏洞验证的必然步骤，不能算是仓库作者植入的投毒代码。基于此, 判定仓库中存在作者隐藏的投毒代码的可能性为20%。

**项目地址:** [jptr218/php_hack](https://github.com/jptr218/php_hack)

**漏洞详情:** [CVE-2019-11043](https://nvd.nist.gov/vuln/detail/CVE-2019-11043)