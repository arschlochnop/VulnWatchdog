## CVE-2022-0995-Linux kernel watch_queue OOB write

**漏洞编号:** CVE-2022-0995

**漏洞类型:** Out-of-bounds write

**影响应用:** Linux kernel

**危害等级:** 高危，可能导致权限提升或拒绝服务

**影响版本:** kernel 5.17 rc8, Ubuntu 21.10 (kernel 5.13.0-37-generic) 验证通过

**利用条件:** 本地用户权限

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2022-0995 是 Linux 内核 watch_queue 事件通知子系统中的一个越界 (OOB) 内存写入漏洞。此漏洞可能覆盖内核状态的部分内容，从而可能允许本地用户获得特权访问或导致系统拒绝服务。

**有效性：**

提供的 PoC 代码似乎有效。根据搜索结果，该漏洞已公开，并且存在可利用的 PoC 代码（来自 GitHub 链接）。PoC 代码针对 Ubuntu 21.10 (kernel 5.13.0-37-generic) 进行了测试，但可能需要多次运行才能成功。该漏洞利用通过 msg_msg 进行堆溢出，结合 skbuff 喷射稳定堆布局，最终覆盖内核态内存，从而实现权限提升。

**投毒风险：**

该 PoC 代码的投毒风险较低，约为 10%。原因如下：
*   代码结构清晰：代码主要由利用漏洞的逻辑组成，没有明显的恶意行为。
*   功能集中：代码功能集中在利用 watch_queue OOB 写入漏洞提权。
*   代码量较小：代码量不大，易于人工审计。
*   `util.c` 代码没有展示，存在一定风险，但是大概率是一些辅助函数比如 `make_queue`,`send_msg`,`get_msg`等，函数体大概率使用系统调用,所以投毒风险不大.

虽然风险较低，但仍需谨慎。`Makefile` 使用 `-static` 编译，这可能会增加最终可执行文件的大小，并可能包含不必要的静态链接库。此外，对 `util.c` 没有做code review,无法确认是否植入后门。

**利用方式：**

该漏洞的利用方式如下：

1.  **msg_msg 堆喷：** 使用 `msg_msg` 结构体进行堆喷，在内核堆上分配大量 `msg_msg` 结构体，目标是控制堆布局，为后续的 OOB 写入创造条件。
2.  **skbuff 堆喷：** 使用 `sk_buff` 结构体进行堆喷，用于在 kmalloc-1024 大小的 slab 上分配大量对象，稳定堆布局。
3.  **触发 OOB 写入：**  利用 watch_queue 子系统的漏洞，构造恶意的过滤器，触发 OOB 写入，覆盖相邻的内核对象，比如另一个 msg_msg 结构体。
4.  **覆盖目标：** 通过OOB 写入，覆盖其他 msg_msg 结构体中的元数据信息，例如`m_list_next`, `m_list_prev`。
5.  **权限提升：** 利用覆盖后的元数据，泄露内核地址，并构造ROP链，调用 `prepare_kernel_cred` 和 `commit_creds` 函数来获取 root 权限。
6.  **执行 shell：** 最后，恢复用户态上下文，执行 shell。

**项目地址:** [AndreevSemen/CVE-2022-0995](https://github.com/AndreevSemen/CVE-2022-0995)

**漏洞详情:** [CVE-2022-0995](https://nvd.nist.gov/vuln/detail/CVE-2022-0995)