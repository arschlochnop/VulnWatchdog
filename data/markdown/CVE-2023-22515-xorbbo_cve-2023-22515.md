## CVE-2023-22515 - Atlassian Confluence Broken Access Control

**漏洞编号:** CVE-2023-22515

**漏洞类型:** Broken Access Control

**影响应用:** Atlassian Confluence Data Center and Server

**危害等级:** 高危，允许未授权用户创建管理员账户，可能导致完全控制 Confluence 实例

**影响版本:** 8.0.0 <= version < 8.3.3, 8.4.0 <= version < 8.4.3, 8.5.0 <= version < 8.5.2

**利用条件:** Confluence 实例需要公开可访问，且未完成初始化配置（setupComplete = false）

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2023-22515 漏洞是一个严重的权限绕过漏洞，影响 Atlassian Confluence Data Center 和 Server 实例。未经身份验证的攻击者可以通过该漏洞创建未经授权的 Confluence 管理员帐户，从而完全控制 Confluence 实例。

**利用方式：**

1.  **重置设置状态：** 攻击者发送一个GET请求到`/server-info.action?bootstrapStatusProvider.applicationConfig.setupComplete=false`。 这个请求会将 Confluence 实例重置到设置模式，即使它已经被设置过。
2.  **创建管理员账户：** 攻击者然后发送一个POST请求到`/setup/setupadministrator.action`，其中包含新管理员帐户的用户名、密码和电子邮件信息。该请求中的`X-Atlassian-Token: no-check` header用于绕过CSRF保护。
3.  **完成设置:** 攻击者发送一个POST请求到 `/setup/finishsetup.action`来关闭 Confluence的配置完成提示。

**POC有效性：**

提供的 POC 代码（包括 Burp Suite 请求示例和 Nmap NSE 脚本）看起来有效。它包含了利用该漏洞所需的步骤：首先通过 `/server-info.action` 接口将 Confluence 置于未安装状态，然后利用 `/setup/setupadministrator.action` 接口创建管理员用户，最后利用`/setup/finishsetup.action`接口关闭提示信息。

**投毒风险：**

投毒风险较低 (5%)。 虽然任何第三方提供的代码都存在潜在风险，但此处的代码相对简单且直接地实现了漏洞利用。主要风险在于攻击者可能会修改 Nmap 脚本或 Burp Suite 请求以包含其他恶意操作，例如安装后门、上传 webshell 或收集敏感信息。 但从目前的代码来看，没有明显的恶意代码。

**缓解措施：**

*   尽快升级到不受影响的 Confluence 版本（8.3.3 及更高版本，8.4.3 及更高版本，8.5.2 及更高版本）。
*   如果无法立即升级，请参考 Atlassian 官方指南采取临时缓解措施。
*   监控 Confluence 实例中是否存在未经授权的管理员帐户。
*   限制对 Confluence 实例的网络访问。

**项目地址:** [xorbbo/cve-2023-22515](https://github.com/xorbbo/cve-2023-22515)

**漏洞详情:** [CVE-2023-22515](https://nvd.nist.gov/vuln/detail/CVE-2023-22515)