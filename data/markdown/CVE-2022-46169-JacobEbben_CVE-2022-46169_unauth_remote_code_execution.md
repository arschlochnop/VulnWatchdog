## CVE-2022-46169 - Cacti Unauthenticated Remote Code Execution

**漏洞编号:** CVE-2022-46169

**漏洞类型:** 命令注入

**影响应用:** Cacti

**危害等级:** 高危，允许未经身份验证的攻击者执行任意命令

**影响版本:** < 1.2.23 和 < 1.3.0

**利用条件:** 目标Cacti实例存在具有POLLER_ACTION_SCRIPT_PHP（值为2）动作类型的 poller_item，且未修复此漏洞。

**POC 可用性:** 是

**投毒风险:** 1%

## 详情

该漏洞存在于 Cacti 的 remote_agent.php 文件中。攻击者可以通过构造包含恶意命令的 poller_id 参数，绕过身份验证并执行任意代码。具体利用方式如下：

1.  **身份验证绕过：** 攻击者可以通过设置 HTTP 请求头（如 X-Forwarded-For）来伪造客户端 IP 地址。`get_client_addr` 函数会读取这些 HTTP 头来获取客户端 IP，而 `gethostbyaddr` 函数会根据伪造的 IP 地址解析主机名，从而绕过 poller 表的主机名检查。
2.  **命令注入：**  成功绕过身份验证后，攻击者可以向 remote_agent.php 发送包含 `action=polldata` 的请求。`poll_for_data` 函数会从数据库中加载与提供的 host_id 和 local_data_ids 对应的 poller_item 条目。如果 poller_item 的 action 等于 POLLER_ACTION_SCRIPT_PHP，则使用 `proc_open` 函数执行 PHP 脚本。攻击者可以通过控制 poller_id 参数，将恶意命令注入到 `proc_open` 函数的参数中，从而执行任意系统命令。

**有效性：**

根据漏洞描述、搜索引擎结果和提供的 POC 代码，该漏洞利用是有效的。漏洞库信息和搜索引擎结果都表明该漏洞已经被积极利用。

**投毒风险：**

该POC代码主要功能是漏洞利用，代码量较少，投毒的可能性较低。`LICENSE` 文件声明了 MIT 开源协议，作者有署名。 `README.md` 声明免责申明和风险, `exploit.py` 包含详细的注释，逻辑清晰。 但是不能完全排除人为投毒的可能，仍需要进一步的代码审计。综上所述，该POC代码的投毒风险较低。

**利用方式：**

1.  设置 HTTP 请求头（如 X-Forwarded-For）来伪造客户端 IP 地址，绕过身份验证。
2.  确定 host_id 和 local_data_id， 确保对应poller_item action类型为`POLLER_ACTION_SCRIPT_PHP`。
3.  构造包含 `action=polldata` 和恶意 poller_id 参数的 HTTP 请求，发送到 remote_agent.php。
4.  服务器执行恶意命令。

**项目地址:** [JacobEbben/CVE-2022-46169_unauth_remote_code_execution](https://github.com/JacobEbben/CVE-2022-46169_unauth_remote_code_execution)

**漏洞详情:** [CVE-2022-46169](https://nvd.nist.gov/vuln/detail/CVE-2022-46169)