## CVE-2023-46604-Apache ActiveMQ-远程代码执行

**漏洞编号:** CVE-2023-46604

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Apache ActiveMQ

**危害等级:** 高危，可能导致服务器完全控制

**影响版本:** < 5.15.16, < 5.16.7, < 5.17.6, < 5.18.3

**利用条件:** 需要网络访问ActiveMQ的OpenWire协议端口（默认为61616）

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2023-46604是Apache ActiveMQ中的一个远程代码执行漏洞。该漏洞源于Java OpenWire协议marshaller对不可信数据进行反序列化。攻击者可以通过操纵OpenWire协议中的序列化类类型，使客户端或broker（取决于攻击位置）实例化classpath上的任何类，从而执行任意shell命令。

**有效性分析：**
提供的Python POC代码通过构造恶意的OpenWire消息来利用此漏洞。它允许攻击者指定一个包含恶意配置的XML文件URL，该XML文件将被目标ActiveMQ服务器加载，导致任意代码执行。搜索引擎结果也表明该漏洞已被积极利用，例如与Kinsing恶意软件和勒索软件攻击有关。

**投毒风险分析：**
查看了attack.py的代码，其功能主要为：
1.  接收目标IP、恶意XML文件的URL以及端口号作为参数。
2.  将XML的URL和类名转换为十六进制字符串。
3.  构造包含类名和XML URL的OpenWire协议消息。
4.  将构造的消息发送到目标ActiveMQ服务器。

代码中没有发现任何可疑的或隐藏的功能，例如未经授权的文件操作、网络连接或恶意代码注入。代码的功能与漏洞利用的目的相符，因此，投毒风险较低，评估为0%。

**利用方式：**
1.  攻击者首先需要搭建一个Web服务器，并将包含恶意配置的XML文件放置在该服务器上。该XML文件通常会利用Spring Framework的特性来执行任意代码。
2.  攻击者使用POC代码，指定目标ActiveMQ服务器的IP地址和Web服务器上恶意XML文件的URL。
3.  POC代码会构造一个恶意的OpenWire消息，其中包含恶意XML文件的URL和用于触发反序列化漏洞的类名（`org.springframework.context.support.ClassPathXmlApplicationContext`）。
4.  该恶意消息被发送到目标ActiveMQ服务器。
5.  ActiveMQ服务器在处理该消息时，会反序列化恶意数据，并加载指定的XML文件。
6.  加载恶意XML文件会导致服务器执行XML文件中定义的恶意代码，从而实现远程代码执行。

**项目地址:** [justdoit-cai/CVE-2023-46604-Apache-ActiveMQ-RCE-exp](https://github.com/justdoit-cai/CVE-2023-46604-Apache-ActiveMQ-RCE-exp)

**漏洞详情:** [CVE-2023-46604](https://nvd.nist.gov/vuln/detail/CVE-2023-46604)