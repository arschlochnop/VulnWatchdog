## CVE-2021-3156 - Sudo Heap-Based Buffer Overflow

**漏洞编号:** CVE-2021-3156

**漏洞类型:** Heap-Based Buffer Overflow

**影响应用:** Sudo

**危害等级:** 高危，本地提权至 root

**影响版本:** 1.8.2 - 1.8.31sp12, 1.9.0 - 1.9.5sp1

**利用条件:** 本地用户，Sudo 具有 SUID 权限且可执行

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2021-3156 是一个 Sudo 中的堆缓冲区溢出漏洞，也被称为 "Baron Samedit"。该漏洞允许本地用户通过 `sudoedit -s` 和一个以单个反斜杠字符结尾的命令行参数来提升权限至 root。

**有效性：**

根据漏洞库信息和搜索结果，该漏洞是真实存在的，并且存在可用的PoC代码。提供的PoC代码利用了 `sudoedit -s` 命令以及精心构造的参数，可以触发堆缓冲区溢出，从而实现提权。多个安全博客和漏洞报告证实了该漏洞的可利用性。

**投毒风险：**

分析提供的漏洞利用代码仓库，其中包含Dockerfile和exp.c文件。Dockerfile文件用于构建漏洞环境，exp.c为C语言编写的漏洞利用程序。代码仓库中主要包含漏洞利用的必要文件，没有发现作者隐藏的恶意代码，例如后门程序、信息收集模块或任何其他与漏洞利用无关的功能。因此，该仓库的投毒风险较低。因此，评估投毒风险为0%。

**利用方式：**

1.  **触发条件：** 漏洞利用需要满足以下条件：
    *   本地用户身份
    *   目标系统上安装了受影响版本的 Sudo
    *   Sudo 程序具有 SUID 权限
2.  **利用步骤：**
    *   使用 `sudoedit -s` 命令，并构造一个以单个反斜杠字符结尾的命令行参数。参数的长度需要足够长，以便触发堆缓冲区溢出。
    *   利用缓冲区溢出，覆盖堆上的数据结构，最终劫持控制流，执行恶意代码。
    *   恶意代码通常会调用 `setuid(0)` 和 `setgid(0)`，从而将当前用户的有效用户 ID 和组 ID 设置为 root，实现提权。
3.  **漏洞原理：**
    *   漏洞根源在于 `set_cmnd` 函数中，在处理命令行参数时，对反斜杠字符的处理存在缺陷。
    *   当命令行参数以单个反斜杠字符结尾时，代码会错误地将反斜杠字符和紧随其后的空字符都复制到堆缓冲区中，导致缓冲区溢出。
    *   通过精心构造命令行参数，可以控制溢出的内容，从而覆盖堆上的数据结构，最终劫持控制流，执行恶意代码。

**项目地址:** [chenaotian/CVE-2021-3156](https://github.com/chenaotian/CVE-2021-3156)

**漏洞详情:** [CVE-2021-3156](https://nvd.nist.gov/vuln/detail/CVE-2021-3156)