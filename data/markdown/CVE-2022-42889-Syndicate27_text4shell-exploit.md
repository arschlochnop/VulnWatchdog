## CVE-2022-42889 - Apache Commons Text 远程代码执行

**漏洞编号:** CVE-2022-42889

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Apache Commons Text

**危害等级:** 高危，允许未经身份验证的攻击者执行任意命令

**影响版本:** < 1.10.0 (1.5 - 1.9)

**利用条件:** 应用程序使用受影响版本的 Apache Commons Text，且允许用户可控的输入参与 `${}` 格式的字符串插值。

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2022-42889，也被称为 Text4Shell，是一个影响 Apache Commons Text 1.5 到 1.9 版本的远程代码执行漏洞。该漏洞源于库中不安全的默认插值器，允许攻击者利用 'script'、'dns' 和 'url' 等前缀执行恶意代码。 

**有效性:**
根据漏洞库信息、搜索引擎结果和提供的 PoC 代码，此漏洞利用是有效的。PoC 代码展示了如何使用 `${script:javascript:java.lang.Runtime.getRuntime().exec(...)}` 构造恶意 payload，并通过 HTTP POST 请求发送到目标服务器，从而执行任意系统命令。

**投毒风险:**
分析 PoC 代码，未发现明显的投毒代码。该代码结构简单，主要功能是构造 payload 并发送 HTTP 请求。许可证和 README 文件也比较规范，没有可疑之处。因此，投毒风险评估为 0%。

**利用方式:**
1.  **确定目标应用:** 找到使用了存在漏洞的 Apache Commons Text 版本的 Java 应用程序，并且该应用允许用户控制的输入参与字符串插值。
2.  **构造 Payload:** 使用`${script:javascript:java.lang.Runtime.getRuntime().exec(...)}`或类似的方式构造恶意 payload，其中 `...` 部分包含要执行的系统命令，如反弹 shell 等。
3.  **URL 编码:** 对构造好的 payload 进行 URL 编码，以确保其能够正确地通过 HTTP 请求传输。
4.  **发送请求:**  将编码后的 payload 嵌入到 HTTP 请求的参数中（如 GET 请求的查询参数或 POST 请求的 body），发送到目标应用程序。
5.  **监听连接:**  如果 payload 是反弹 shell，需要在攻击者机器上监听相应的端口，等待目标机器连接。

**修复建议:**
升级到 Apache Commons Text 1.10.0 或更高版本，该版本默认禁用了有问题的插值器。如果无法升级，可以考虑禁用或限制应用程序中使用的插值器，或者对用户输入进行严格的验证和过滤。

**项目地址:** [Syndicate27/text4shell-exploit](https://github.com/Syndicate27/text4shell-exploit)

**漏洞详情:** [CVE-2022-42889](https://nvd.nist.gov/vuln/detail/CVE-2022-42889)