## CVE-2011-1249 - Windows AFD权限提升漏洞

**漏洞编号:** CVE-2011-1249

**漏洞类型:** 权限提升

**影响应用:** Microsoft Windows AFD.sys

**危害等级:** 高危，允许本地用户获取SYSTEM权限

**影响版本:** Windows XP SP2/SP3, Windows Server 2003 SP2, Windows Vista SP1/SP2, Windows Server 2008 Gold/SP2/R2/R2 SP1, Windows 7 Gold/SP1

**利用条件:** 需要本地用户权限，目标系统未安装KB2503665补丁

**POC 可用性:** 是

**投毒风险:** 1%

## 详情

CVE-2011-1249是一个Windows AFD (Ancillary Function Driver)中的权限提升漏洞。该漏洞存在于afd.sys驱动中，由于AFD未能正确验证来自用户模式的输入，导致本地用户可以通过精心构造的应用程序获得特权，即SYSTEM权限。根据漏洞利用代码的注释，利用该漏洞可在未打补丁的Windows XP SP3, Windows Server 2003 SP2, Windows Vista SP1/SP2, Windows Server 2008, Windows 7等系统上执行任意内核模式代码。利用过程一般需要用户拥有本地访问权限，并且目标系统没有安装相应的补丁（KB2503665）。漏洞利用代码相对完整，可以直接编译运行。

**有效性评估：**

从漏洞信息、搜索结果和漏洞利用代码来看，该漏洞是真实存在的，并且存在可用的PoC代码。该PoC代码在指定的未打补丁的操作系统版本上，能够成功提权。

**投毒风险评估：**

分析提供的C代码，该代码的意图明确，就是利用AFD驱动的漏洞来获取系统权限。虽然不能完全排除作者隐藏恶意代码的可能性，但从代码结构、注释以及已公开的信息来看，存在恶意投毒代码的可能性较低。因此投毒风险评定为1%属于较低的风险。

**利用方式分析：**

1.  **漏洞触发：** 利用程序通过精心构造的输入数据触发afd.sys中的漏洞。
2.  **内核代码执行：** 成功利用漏洞后，攻击者可以在内核模式下执行任意代码，通常通过覆盖或修改内核数据结构实现。
3.  **权限提升：** 在内核模式下执行恶意代码后，攻击者可以获得SYSTEM权限，从而完全控制系统。通常的做法是替换当前进程的Token为SYSTEM Token。
4.  **利用结果：** PoC代码通常会创建一个具有SYSTEM权限的shell，或者执行其他恶意操作。

**项目地址:** [h3x0v3rl0rd/CVE-2011-1249](https://github.com/h3x0v3rl0rd/CVE-2011-1249)

**漏洞详情:** [CVE-2011-1249](https://nvd.nist.gov/vuln/detail/CVE-2011-1249)