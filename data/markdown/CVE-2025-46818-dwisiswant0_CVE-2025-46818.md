## CVE-2025-46818 - Redis Lua 沙箱跨用户逃逸

**漏洞编号:** CVE-2025-46818

**漏洞类型:** 权限提升/代码注入

**影响应用:** Redis

**危害等级:** 中危，Authenticated users can execute LUA scripts as a different user

**影响版本:** < 8.2.2

**利用条件:** 需要 Redis 实例的本地网络访问以及已认证的用户权限，并且 Redis 服务器版本低于 8.2.2。

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2025-46818 允许经过身份验证的用户使用特制的 Lua 脚本来操纵不同的 LUA 对象，并可能在另一个用户的上下文中运行自己的代码。此问题存在于所有具有 LUA 脚本的 Redis 版本中。该漏洞的利用方式如下：

1.  **漏洞原理：** Redis 8.2.1 及更早版本未禁用已弃用的 Lua API（`getfenv`、`setfenv`、`newproxy`），并且未能锁定基本类型的元表。攻击者可以将方法注入到共享元表中，捕获特权环境，并以另一个用户的权限运行命令。
2.  **利用步骤：**
    *   攻击者使用 `redis-cli` 执行 `CVE-2025-46818.lua` 脚本。该脚本首先验证已弃用的内置函数是否存在，然后修改字符串元表，添加一个名为 `escalate` 的新方法。
    *   `escalate` 方法内部包含执行特权命令的代码。在提供的示例中，它调用 `redis.pcall('ACL', 'WHOAMI')`，但可以替换为任何其他特权命令，例如 `CONFIG GET` 等。
    *   其他用户（受害者）后续执行的任何字符串操作都会继承被注入的 `escalate` 方法。
    *   攻击者或受害者可以调用注入的 helper 函数，利用 `redis-cli` 执行 `EVAL "return ('test').escalate()" 0` 获取其他用户的权限，从而执行特权操作。

3.  **投毒风险分析：** 提供的 Lua 脚本主要用于验证漏洞的存在和利用方式。脚本的功能是修改字符串元表并注入一个名为 `escalate` 的方法，该方法可以执行特权命令。脚本本身并没有隐藏的恶意代码或者后门，因此投毒风险较低。

4.  **缓解措施：** 升级到 Redis 8.2.2 或更高版本，或者为不受信任的用户禁用 Lua 脚本，或者使用 `lua-enable-deprecated-api no` 运行。

根据搜索结果，漏洞利用的有效性较高，多个来源都证实了该漏洞的存在和可利用性。

**项目地址:** [dwisiswant0/CVE-2025-46818](https://github.com/dwisiswant0/CVE-2025-46818)

**漏洞详情:** [CVE-2025-46818](https://nvd.nist.gov/vuln/detail/CVE-2025-46818)