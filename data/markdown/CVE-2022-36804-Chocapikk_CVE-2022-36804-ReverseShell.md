## CVE-2022-36804-Bitbucket-命令注入

**漏洞编号:** CVE-2022-36804

**漏洞类型:** 命令注入

**影响应用:** Bitbucket Server/Data Center

**危害等级:** 高危，可远程代码执行

**影响版本:** < 8.3.1

**利用条件:** 需要对公开或私有Bitbucket仓库具有读取权限

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2022-36804 是 Atlassian Bitbucket Server 和 Data Center 中的一个命令注入漏洞。攻击者可以通过发送恶意 HTTP 请求，利用多个 API 端点中的漏洞执行任意代码。

**有效性：**

根据漏洞库信息、搜索引擎结果（特别是Rapid7的分析和AssetNote的研究）以及提供的PoC代码，可以判断该漏洞是有效的。PoC 代码提供了一种相对可靠的利用方式，特别是对于启用了公共仓库的实例。即使目标仓库是私有的，也可以使用有效的 'BITBUCKETSESSIONID' cookie 进行利用。

**投毒风险：**

PoC代码的主要功能是利用命令注入漏洞执行任意命令。代码中包含自动检测仓库的功能，以及通过命令行参数指定目标、执行命令、反弹shell等选项。潜在的投毒风险可能存在于以下几个方面：

1.  **恶意命令默认值：**  虽然`--command`参数默认为`whoami`，但攻击者可能会修改默认值，使其执行更具破坏性的操作。
2.  **反弹 Shell 功能：**  `--lhost` 和 `--lport` 参数用于设置反弹 shell，如果攻击者诱使用户运行此 PoC 并连接到攻击者控制的服务器，则可能导致受害者系统被完全控制。
3.  **批量扫描的潜在风险：**  `--file` 参数允许批量扫描目标，攻击者可能会利用此功能进行大规模攻击，或者在扫描过程中植入恶意代码。
4. **代码逻辑缺陷**: 代码中可能存在潜在的逻辑缺陷或未处理的异常，可能导致程序崩溃或执行意外的操作。

综合来看，虽然PoC代码主要目的是验证漏洞，但存在被滥用或修改以进行恶意攻击的风险。初步判断存在10%的投毒风险。

**利用方式：**

1.  **确定目标 Bitbucket Server/Data Center 版本：** 确认目标版本是否在受影响的范围内（< 8.3.1）。
2.  **获取仓库信息：** 如果启用了公共仓库，PoC代码可以自动检测可利用的仓库。如果目标仓库是私有的，则需要有效的 'BITBUCKETSESSIONID' cookie。
3.  **构造恶意 HTTP 请求：**  PoC代码会自动构造包含恶意命令的 HTTP 请求，发送到易受攻击的 API 端点。
4.  **执行任意代码：**  成功利用漏洞后，攻击者可以在目标服务器上执行任意代码，例如执行系统命令、反弹 shell 等。
5. **利用参数传递命令**: 通过 `--command` 参数或 `--file` 参数指定要执行的恶意命令,进行漏洞攻击.

**总结：**

CVE-2022-36804 是一个高危的命令注入漏洞，利用条件相对宽松（需要读取权限），且存在公开的PoC代码。攻击者可以利用该漏洞在 Bitbucket Server/Data Center 服务器上执行任意代码，造成严重的安全威胁。需要及时升级到安全版本。

**项目地址:** [Chocapikk/CVE-2022-36804-ReverseShell](https://github.com/Chocapikk/CVE-2022-36804-ReverseShell)

**漏洞详情:** [CVE-2022-36804](https://nvd.nist.gov/vuln/detail/CVE-2022-36804)