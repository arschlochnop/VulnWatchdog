## CVE-2024-48990-needrestart-权限提升

**漏洞编号:** CVE-2024-48990

**漏洞类型:** 权限提升

**影响应用:** needrestart

**危害等级:** 高危，本地用户可提升至root权限

**影响版本:** < 3.8

**利用条件:** 需要本地访问，并且目标系统需要安装存在漏洞的needrestart版本（低于3.8）

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

该漏洞允许本地攻击者通过操纵PYTHONPATH环境变量，使needrestart执行攻击者控制的Python代码，从而以root权限执行任意代码。

**利用方式:**

1.  **创建恶意Python库:** `evil.c` 文件编译成共享库 `/tmp/importlib/__init__.so`。该共享库包含一个构造函数 (`a()`)，该构造函数会在库加载时执行。构造函数首先设置UID和GID为0，然后复制 `/bin/sh` 到 `/tmp/nullbyte`，接着使用 `sudo mount -o remount,suid /tmp` 重新挂载 `/tmp` 目录，并启用 suid 位，最后使用 `chmod u+s /tmp/nullbyte` 为`/tmp/nullbyte`设置SUID权限。
2.  **利用PYTHONPATH:**  `sysadmin_F.sh` 脚本设置 `PYTHONPATH` 环境变量指向包含恶意库的目录 `/tmp`。
3.  **触发漏洞:**  当 `needrestart` 运行时，它会扫描Python解释器并加载`get_root.py`脚本。因为设置了PYTHONPATH，Python解释器会优先加载 `/tmp/importlib/__init__.so` 中的恶意代码。恶意代码被执行，会设置`/tmp/nullbyte`的SUID权限。
4.  **权限提升:** `get_root.py` 脚本会循环检查 `/tmp/nullbyte` 是否存在。一旦存在，它就会执行 `/tmp/nullbyte -p`，由于该文件设置了SUID权限，所以执行该文件可以获得root权限。

**有效性评估:**

根据漏洞库信息和提供的PoC代码，该漏洞利用方法理论上是有效的。前提是目标系统运行的是受影响的 `needrestart` 版本，并且攻击者具有本地访问权限。

**投毒风险评估:**

虽然PoC的主要目的是演示漏洞利用，但其中存在潜在的投毒风险。风险点在于`evil.c` 和 `get_root.py` 中的操作。如果攻击者修改 `evil.c`，可以执行任意的恶意操作，例如安装后门、窃取数据等。`get_root.py` 文件中的循环检查和延时操作也可能被利用于隐藏恶意行为。`sysadmin_F.sh` 中将整个 `/tmp/CVE-2024-48990/*` 移动到 `/tmp` 也可能引入其他潜在的风险。脚本中存在 `sudo mount` 命令，这可能导致系统不稳定或者数据损坏。因此，有一定的投毒风险。

**风险比例说明:**

*   5%：主要基于脚本中直接使用 `sudo mount` 命令带来的不确定性，虽然其本身是提权的一部分，但也可能对系统稳定性产生影响。

**安全建议:**

*   及时更新 `needrestart` 到最新版本。
*   按照官方的修复建议，禁用 `interpscan`。
*   限制本地用户的权限，降低攻击面。
*   在生产环境中谨慎使用未经验证的PoC代码。


**项目地址:** [NullByte-7w7/CVE-2024-48990](https://github.com/NullByte-7w7/CVE-2024-48990)

**漏洞详情:** [CVE-2024-48990](https://nvd.nist.gov/vuln/detail/CVE-2024-48990)