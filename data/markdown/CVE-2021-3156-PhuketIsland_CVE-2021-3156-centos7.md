## CVE-2021-3156-Sudo-堆缓冲区溢出

**漏洞编号:** CVE-2021-3156

**漏洞类型:** 堆缓冲区溢出

**影响应用:** Sudo

**危害等级:** 高危，允许本地普通用户提升权限至root

**影响版本:** < 1.9.5p2

**利用条件:** 本地用户可以执行sudo命令

**POC 可用性:** 是

**投毒风险:** 1%

## 详情

CVE-2021-3156，又名Baron Samedit，是Sudo 1.9.5p2之前版本中的一个堆缓冲区溢出漏洞。该漏洞位于sudo解析命令行参数的方式中。攻击者可以利用'sudoedit -s'命令和一个以单个反斜杠字符结尾的命令行参数来触发漏洞。通过精心构造的参数，可以覆盖堆内存，从而实现权限提升，允许本地普通用户获得root权限。

**漏洞利用方式：**

1.  **利用`sudoedit -s`触发：** 该漏洞的关键在于使用`sudoedit -s`命令，该命令用于以安全模式编辑文件。
2.  **构造恶意参数：**  攻击者需要提供一个以单个反斜杠(`\`)结尾的长命令行参数。这个反斜杠会触发转义错误，导致缓冲区溢出。
3.  **堆内存覆盖：** 通过精心控制的输入长度和内容，攻击者可以覆盖堆内存中的关键数据结构，例如`user_spec`结构体和`cmnd_spec`结构体。
4.  **权限提升：**  通过覆盖这些数据结构，攻击者可以修改sudo的行为，使其认为当前用户拥有root权限，从而执行任意命令。
5.  **POC代码分析：**
    *   POC使用python编写，利用ctypes直接调用libc函数，例如`execve`，实现进程的创建和执行。
    *   POC构造了恶意的argv和envp参数，利用`sudoedit -s`触发漏洞。
    *   POC通过设置环境变量`SUDO_EDITOR=/usr/bin/tee`将标准输入附加到`/etc/passwd`文件中，从而达到修改`/etc/passwd`的目的（这是一种利用方式，也可能替换成执行其他恶意代码）。
    *   POC通过大量的环境变量覆盖栈，并在栈上构造伪造的数据结构，用于利用堆溢出。
6.  **有效性：** 提供的PoC代码基本有效，根据漏洞描述和搜索结果，该PoC能够利用该漏洞实现本地权限提升。需要根据目标系统进行微调，例如地址偏移等。

**投毒风险：**

评估投毒风险较低，大约为1%。
    *   **原因：** 代码主要利用已知的堆溢出漏洞进行提权，尽管POC修改了/etc/passwd文件，添加了用户，但是可以很容易的进行排查，且行为可以控制。
    *   **风险点：** POC中的`/usr/bin/tee`命令被用于将输入附加到/etc/passwd，可能会添加恶意的用户账户，但这不是隐藏行为。理论上，作者可以在堆内存构造部分或环境变量设置中加入一些隐蔽的恶意代码，例如替换`execve`的参数，使其执行其他恶意程序，但当前代码中没有明显的此类行为。

总结：该漏洞利用方式相对直接，POC代码利用堆溢出覆盖关键数据结构，从而实现权限提升。投毒风险较低。

**项目地址:** [PhuketIsland/CVE-2021-3156-centos7](https://github.com/PhuketIsland/CVE-2021-3156-centos7)

**漏洞详情:** [CVE-2021-3156](https://nvd.nist.gov/vuln/detail/CVE-2021-3156)