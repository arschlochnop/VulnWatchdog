## CVE-2019-11043-PHP-FPM-RCE

**漏洞编号:** CVE-2019-11043

**漏洞类型:** 远程代码执行

**影响应用:** PHP-FPM

**危害等级:** 高危，可导致服务器被完全控制

**影响版本:** 7.1.x < 7.1.33, 7.2.x < 7.2.24, 7.3.x < 7.3.11

**利用条件:** Nginx + PHP-FPM 配置，且 Nginx 配置不正确 (PATH_INFO)

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2019-11043 是一个 PHP-FPM 远程代码执行漏洞，存在于特定版本的 PHP-FPM 中，当与 Nginx 配合使用时，如果 Nginx 配置不当，攻击者可以通过构造恶意的请求，利用 env_path_info 的 underflow 漏洞，覆盖 FPM 缓冲区，从而执行任意代码。

**有效性：**
提供的 POC 代码有效。该代码提供了一个 Docker 镜像，其中包含一个易受攻击的 PHP-FPM 版本和 Nginx。它还提供了使用 `phuip-fpizdam` 工具进行漏洞利用的示例。该工具可以自动检测漏洞并执行命令。

**投毒风险：**
该仓库中可能存在一定的投毒风险（大约10%）。
1.  Dockerfile 中的 `RUN /bin/bash`  虽然不是直接的投毒代码，但可能允许构建者在镜像中包含恶意软件或后门。不过，这里只是为了构建镜像，风险较低。
2.  starter.sh 脚本启动 php-fpm 和 nginx。虽然脚本本身没有明显的恶意代码，但如果 php-fpm 或 nginx 的配置被恶意修改，则可能导致安全问题。镜像中 `default.conf` 的内容就是关键，该文件定义了Nginx的配置，是否容易受到攻击取决于该配置。如果该配置本身就是为了复现漏洞而设计的，那么即使利用成功，也不能算作投毒。

总的来说，该镜像的投毒风险较低。作者主要提供了复现漏洞的环境，目的是为了方便漏洞研究和利用。

**利用方式：**
1.  攻击者需要向目标服务器发送特制的 HTTP 请求。
2.  该请求必须包含一个精心构造的 `PATH_INFO`，以触发 PHP-FPM 的缓冲区下溢。
3.  缓冲区下溢允许攻击者覆盖 FPM 进程内存中的 FCGI 协议数据。
4.  通过覆盖 FCGI 数据，攻击者可以控制 PHP-FPM 执行任意代码。通常，攻击者会执行系统命令，从而获得服务器的控制权。

**需要注意的是，该漏洞利用需要特定的 Nginx 配置才能成功。** Nginx 需要将请求传递给 PHP-FPM，并且需要正确地设置 `PATH_INFO` 参数。如果 Nginx 配置不当，例如没有正确地验证文件是否存在，则可能导致此漏洞。

**项目地址:** [akamajoris/CVE-2019-11043-Docker](https://github.com/akamajoris/CVE-2019-11043-Docker)

**漏洞详情:** [CVE-2019-11043](https://nvd.nist.gov/vuln/detail/CVE-2019-11043)