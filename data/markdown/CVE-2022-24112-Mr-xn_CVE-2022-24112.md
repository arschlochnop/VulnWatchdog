## CVE-2022-24112-Apache APISIX-RCE

**漏洞编号:** CVE-2022-24112

**漏洞类型:** 远程代码执行

**影响应用:** Apache APISIX

**危害等级:** 高危，可导致服务器完全控制

**影响版本:** < 2.12.1, < 2.10.4, 1.3

**利用条件:** APISIX默认配置，batch-requests插件启用，默认API密钥未更改，管理API端口为默认端口

**POC 可用性:** 是

**投毒风险:** 1%

## 详情

该漏洞存在于 Apache APISIX 的 batch-requests 插件中。攻击者可以利用此漏洞绕过 Admin API 的 IP 限制，从而通过Admin API执行恶意操作，最终可导致远程代码执行。漏洞利用需要以下条件：

1.  **batch-requests 插件已启用**： 这是利用此漏洞的前提条件。
2.  **默认 API 密钥未更改**： 如果管理员已更改默认API密钥，则漏洞利用难度会增加，但仍可能绕过数据面板的IP限制。
3.  **管理 API 端口为默认端口**： 如果管理API端口被更改为非数据面板端口，则漏洞利用的影响会降低。

**漏洞利用方式：**

1.  攻击者发送一个POST请求到`/apisix/batch-requests`端点。
2.  在请求体中，攻击者通过`X-Real-IP` header 伪造客户端IP地址，绕过Admin API的IP访问限制。
3.  攻击者构造一个PUT请求，通过Admin API创建一个新的路由，该路由包含恶意的`filter_func`。
4.  `filter_func` 使用 `os.execute` 函数执行任意命令，实现远程代码执行。
5.  攻击者发送GET请求触发路由，执行`filter_func`，导致RCE。

**关于投毒风险：**

提供的yaml文件包含LICENSE声明，为Apache License 2.0，较为正式，代码内容主要为漏洞验证代码，大概率是为了验证漏洞的存在或自动化利用。但仍不能完全排除作者出于某种目的，添加一些隐蔽的、不易被察觉的恶意代码，例如，修改执行的shell命令，添加反弹shell等，导致利用此POC的用户受到攻击，所以此处投毒风险给到1%。

**总结：**

此漏洞利用有效性高，风险极高，利用条件较为苛刻，需要默认配置。 POC代码通过构造特殊请求实现RCE，需要注意潜在的投毒风险。

**项目地址:** [Mr-xn/CVE-2022-24112](https://github.com/Mr-xn/CVE-2022-24112)

**漏洞详情:** [CVE-2022-24112](https://nvd.nist.gov/vuln/detail/CVE-2022-24112)