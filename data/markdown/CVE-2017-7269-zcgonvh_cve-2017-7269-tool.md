## CVE-2017-7269-Microsoft IIS 6.0 WebDAV Buffer Overflow

**漏洞编号:** CVE-2017-7269

**漏洞类型:** 缓冲区溢出

**影响应用:** Microsoft IIS 6.0

**危害等级:** 高危，可能导致远程代码执行

**影响版本:** IIS 6.0 on Windows Server 2003 R2

**利用条件:** 目标服务器运行存在漏洞的IIS 6.0，且WebDAV服务启用。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2017-7269 是 Microsoft IIS 6.0 中 WebDAV 服务 ScStoragePathFromUrl 函数存在的一个缓冲区溢出漏洞。攻击者可以通过发送包含过长 "If: <http://" 开头的 header 的 PROPFIND 请求，利用此漏洞在目标系统上执行任意代码。

**有效性评估：**

根据漏洞库信息、搜索引擎结果以及漏洞利用代码，可以判断此漏洞的POC代码是有效的。漏洞库信息明确指出此漏洞在野外被利用过，并且提供了多个Exploit-DB的链接，Rapid7的漏洞数据库也确认了此漏洞的存在。搜索引擎结果显示，该漏洞在2018年被大规模利用，用于挖矿等恶意活动。提供的C#代码实现了漏洞的利用，可以上传webshell或执行shellcode。

**投毒风险分析：**

检查提供的C# POC 代码，发现代码主要功能是：
1.  发送特制的HTTP PROPFIND请求，触发WebDAV服务的缓冲区溢出漏洞。
2.  允许用户指定Host, Port, Scheme等参数定制HTTP Header。
3.  支持上传Webshell到服务器，并指定webshell的路径。
4.  支持执行shellcode。

代码中包含`check_exit_process` 和 `check_exit_thread` 字符串，这些字符串是shellcode的一部分，用于检测漏洞利用是否成功，并在需要时退出进程或线程。这不属于投毒代码，而是漏洞利用过程中的一部分。

代码中没有发现明显的恶意行为或者后门代码，例如反弹shell、信息收集等。但是，由于代码本身就是用于远程代码执行的漏洞利用程序，所以如果被恶意使用者利用，上传恶意webshell或执行恶意shellcode，仍然存在被投毒的风险。因此，判定存在10%的投毒风险，主要来自使用者。

**利用方式：**

1.  攻击者构造一个恶意的HTTP PROPFIND请求，该请求的 "If: <http://" header 包含一个超长的字符串。
2.  当 IIS 6.0 处理该请求时，ScStoragePathFromUrl 函数会将该URL复制到缓冲区中，由于没有进行长度检查，导致缓冲区溢出。
3.  攻击者可以通过精心构造溢出数据，覆盖内存中的关键区域，例如函数返回地址。
4.  通过控制返回地址，攻击者可以劫持程序的执行流程，执行预先准备好的shellcode，从而在目标系统上执行任意代码。
5.  攻击者可以利用此漏洞安装webshell，以便长期控制目标服务器，或者执行挖矿程序等恶意活动。

**项目地址:** [zcgonvh/cve-2017-7269-tool](https://github.com/zcgonvh/cve-2017-7269-tool)

**漏洞详情:** [CVE-2017-7269](https://nvd.nist.gov/vuln/detail/CVE-2017-7269)