## CVE-2024-1086-Linux Kernel nf_tables Use-After-Free

**漏洞编号:** CVE-2024-1086

**漏洞类型:** Use-After-Free

**影响应用:** Linux Kernel

**危害等级:** 高危，本地权限提升

**影响版本:** v5.14 到 v6.6 (部分版本需要满足特定配置)

**利用条件:** 需要用户命名空间 (CONFIG_USER_NS=y)，用户命名空间非特权 (sysctl kernel.unprivileged_userns_clone = 1)，以及 nf_tables 启用 (CONFIG_NF_TABLES=y)。可能需要关闭WiFi。CONFIG_INIT_ON_ALLOC_DEFAULT_ON=n

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2024-1086 是 Linux 内核 netfilter: nf_tables 组件中的一个use-after-free漏洞，攻击者可以利用该漏洞实现本地权限提升。漏洞存在于`nft_verdict_init()`函数，该函数允许将正值作为 hook verdict 中的 drop 错误，因此当使用类似于 NF_ACCEPT 的 drop 错误发出 NF_DROP 时，`nf_hook_slow()`函数可能导致double free漏洞。

**有效性：**

根据漏洞信息和搜索结果，该漏洞存在已知的公开利用代码，并且已经被积极利用。提供的POC代码来自Notselwyn的GitHub仓库，该仓库提供了漏洞的详细信息、受影响版本以及使用说明。该POC被描述为通用本地权限提升exploit，适用于v5.14到v6.6的大多数Linux内核，包括Debian、Ubuntu和KernelCTF。作者声称在KernelCTF镜像中成功率高达99.4%。因此，提供的POC代码被认为是有效的。

**投毒风险：**

分析POC代码，发现作者在README.md中明确指出，利用该漏洞后会导致内核崩溃（system crash），并且刻意没有修复此问题，以防止恶意使用。这表明作者有一定安全意识，但并不能完全排除投毒风险。代码本身包含了Makefile、LICENSE、README.md和src目录，其中包含了C源代码。虽然这些代码看起来是用于漏洞利用，但仍然存在作者故意添加恶意代码的可能性。仔细检查代码，尤其是那些与提权相关的部分，没有发现明显的后门代码。投毒风险评估为5%，主要基于以下几点：

1.  作者明确表示存在故意未修复的内核崩溃问题，表明作者有一定的道德约束。
2.  代码结构清晰，功能明确，未发现隐藏的恶意逻辑。
3.  该漏洞本身已经足够强大，无需额外添加恶意代码来增强其危害。

**利用方式：**

1.  **触发漏洞：** 通过nf_tables配置，构造特定的netfilter规则，使得`nft_verdict_init()`函数使用正值作为drop错误，并且使用类似于NF_ACCEPT的drop错误发出NF_DROP。
2.  **Use-After-Free：** 这将导致`nf_hook_slow()`函数在释放已经释放的内存后再次释放，触发double free漏洞。
3.  **内存破坏：** Double free漏洞可以用来破坏内核内存的布局，例如，通过控制释放的内存，可以在内存中布置特定的数据结构。
4.  **权限提升：** 通过内存破坏，攻击者可以修改内核数据结构中的权限信息，例如，修改当前进程的cred结构，将UID和GID修改为0，从而获得root权限。
5.  **执行Shell：** 获得root权限后，攻击者可以执行任意命令，例如，启动一个root shell。

**项目地址:** [Notselwyn/CVE-2024-1086](https://github.com/Notselwyn/CVE-2024-1086)

**漏洞详情:** [CVE-2024-1086](https://nvd.nist.gov/vuln/detail/CVE-2024-1086)