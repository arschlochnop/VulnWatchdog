## CVE-2017-5638 - Apache Struts2 Jakarta Multipart parser RCE

**漏洞编号:** CVE-2017-5638

**漏洞类型:** 远程代码执行

**影响应用:** Apache Struts2

**危害等级:** 高危，可能导致服务器完全控制

**影响版本:** 2.3.x before 2.3.32, 2.5.x before 2.5.10.1

**利用条件:** 目标系统运行存在漏洞版本的Apache Struts2，且对外开放HTTP服务

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2017-5638 是一个存在于 Apache Struts2 Jakarta Multipart parser 中的远程代码执行漏洞。根据漏洞库信息和搜索结果，该漏洞是由于文件上传过程中，对Content-Type, Content-Disposition或Content-Length等HTTP头处理不当造成的。攻击者可以通过构造恶意的HTTP头，特别是Content-Type，包含 `#cmd=` 字符串，来执行任意命令。 

**利用方式：**

提供的`exploit-cd.sh`脚本利用了Content-Disposition header中的 filename 字段，通过插入 null byte (\x00) 来触发 `InvalidFileNameException`，并利用OGNL表达式执行命令。脚本首先设置 Content-Type 为 `multipart/form-data`，然后构造包含恶意 OGNL 表达式的 payload，并将其作为 filename 的值插入到 Content-Disposition 头中。最后，使用 curl 发送包含精心构造的 HTTP 头的 POST 请求到目标 URL。payload 中，首先清空了OgnlUtil的ExcludedPackageNames和ExcludedClasses，避免了沙箱限制，然后通过ProcessBuilder执行了命令。这个脚本的有效性较高，因为它直接针对了漏洞的利用点。 `reqnull.txt` 文件也是类似的利用，只不过是预先构造的包含payload的HTTP请求。

**投毒风险：**

分析了提供的`exploit-cd.sh` 脚本和 `reqnull.txt`文件，没有发现明显的投毒代码。脚本的功能是利用漏洞执行任意命令，这本身就是漏洞利用的目的。脚本中所有的操作都是为了构造 payload 并发送请求，没有发现任何隐藏的恶意行为。因此，评估投毒风险为0%。

**项目地址:** [jas502n/st2-046-poc](https://github.com/jas502n/st2-046-poc)

**漏洞详情:** [CVE-2017-5638](https://nvd.nist.gov/vuln/detail/CVE-2017-5638)