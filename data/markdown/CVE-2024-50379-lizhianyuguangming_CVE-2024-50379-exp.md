## CVE-2024-50379-Apache Tomcat-TOCTOU RCE

**漏洞编号:** CVE-2024-50379

**漏洞类型:** TOCTOU 竞态条件导致远程代码执行

**影响应用:** Apache Tomcat

**危害等级:** 高危，可能导致服务器被完全控制

**影响版本:** 11.0.0-M1 <= version <= 11.0.1, 10.1.0-M1 <= version <= 10.1.33, 9.0.0.M1 <= version <= 9.0.97

**利用条件:** 默认Servlet的readonly参数设置为false（非默认配置），运行在大小写不敏感的文件系统上，网络可达。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-50379 是一个 Apache Tomcat 中的 TOCTOU (Time-of-Check Time-of-Use) 竞态条件漏洞，发生在 JSP 编译期间。当 Tomcat 运行在大小写不敏感的文件系统上，并且默认 Servlet 的 `readonly` 参数设置为 `false` （这**不是默认配置**），攻击者可以通过竞态条件竞争，上传一个文件，并在 Tomcat 检查其类型之前，将其替换为恶意的 JSP 文件，从而导致远程代码执行。

**漏洞利用方式：**

1.  **先决条件：** 目标 Tomcat 实例必须配置为允许写入（`readonly=false`）。目标服务器的文件系统需要不区分大小写，如 Windows 服务器。
2.  **上传文件：** 攻击者上传一个文件，比如 `t1<random_suffix>.txt` 和 `t2<random_suffix>.txt`，包含部分 JSP 代码，为恶意JSP文件的前半部分和后半部分，用于后续组合。
3.  **竞争条件：** 攻击者发送并发请求，尝试利用 TOCTOU 漏洞。这些请求尝试在 Tomcat 检查文件类型之前，修改上传的文件。
4.  **替换文件：**  利用竞态条件，在 Tomcat 检查文件类型之后，但在实际编译之前，恶意 JSP 代码被写入到上传的文件中。
5.  **JSP 编译：** Tomcat 编译并执行恶意 JSP 代码，从而导致 RCE。

**POC 代码分析：**

提供的 POC 代码是一个 Python 脚本，用于自动化利用此漏洞。主要步骤如下：

1.  **加载目标 URL：** 从 `url.txt` 文件中读取目标 Tomcat 服务器的 URL 列表。
2.  **生成随机字符串和 MD5 哈希：** 用于生成临时文件名和进行一些操作。
3.  **生成 JSP 代码：**生成用于将文件重命名并执行的JSP Header和JSP Footer,其中JSP Footer包含冰蝎payload。
4.  **发送 GET 请求：**  向目标服务器发送 GET 请求，触发漏洞利用。构造特定的 URL，访问恶意文件，触发 JSP 编译，执行恶意代码。
5.  **并发执行：** 使用线程池并发发送请求，以增加利用成功的概率。

**投毒风险分析：**

该脚本的主要目的是利用 CVE-2024-50379 漏洞，实现远程代码执行。 但是，在 `generate_jsp_footer` 函数中，默认情况下包含一个冰蝎 payload。如果使用者不了解这段代码的作用，可能会在不知情的情况下植入后门。

-   **投毒代码：** `generate_jsp_footer` 函数中默认包含冰蝎 payload。
-   **风险评估：** 冰蝎是一个流行的 webshell 工具，攻击者可以使用它来远程管理服务器，执行任意命令，上传和下载文件等。

因此，该脚本存在一定的投毒风险，使用者需要仔细检查代码，确保自己了解每一部分代码的作用。特别是 `generate_jsp_footer` 函数，使用者可以自定义 `custom_content` 参数，替换默认的冰蝎 payload。

**投毒风险比例：** 10%（主要风险在于使用者不了解默认 payload 的作用，在不知情的情况下使用）。


**项目地址:** [lizhianyuguangming/CVE-2024-50379-exp](https://github.com/lizhianyuguangming/CVE-2024-50379-exp)

**漏洞详情:** [CVE-2024-50379](https://nvd.nist.gov/vuln/detail/CVE-2024-50379)