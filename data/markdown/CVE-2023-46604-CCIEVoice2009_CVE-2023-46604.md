## CVE-2023-46604-Apache ActiveMQ-远程代码执行

**漏洞编号:** CVE-2023-46604

**漏洞类型:** 远程代码执行

**影响应用:** Apache ActiveMQ

**危害等级:** 高危，允许未经身份验证的远程攻击者执行任意代码

**影响版本:** < 5.15.16, < 5.16.7, < 5.17.6, < 5.18.3

**利用条件:** 需要网络访问ActiveMQ broker的OpenWire端口（默认61616）

**POC 可用性:** 是

**投毒风险:** 1%

## 详情

CVE-2023-46604 是 Apache ActiveMQ 中的一个远程代码执行漏洞，存在于 OpenWire 协议 marshaller 中。未经身份验证的远程攻击者可以通过操纵 OpenWire 协议中的序列化类类型，使 broker 或 client 实例化 classpath 上的任何类，从而执行任意 shell 命令。

**利用方式：**

1.  **漏洞利用代码分析：** 提供的 `exploit.py` 脚本构造一个恶意的 OpenWire 消息，其中包含一个指向远程 XML 文件的类名。此XML 文件定义了Spring bean，用于在目标系统上执行命令。
2.  **POC 流程:** 攻击者首先搭建一个 HTTP 服务器，用于托管恶意的 `poc.xml` 文件。此文件包含一个 Spring Bean 定义，该定义利用 `java.lang.ProcessBuilder` 类执行任意命令。然后，攻击者使用 `exploit.py` 脚本将特制的 OpenWire 消息发送到目标 ActiveMQ broker。此消息包含 `poc.xml` 文件的 URL。
3.  **目标执行:** 当 ActiveMQ broker 接收到恶意消息时，它会尝试反序列化该消息。由于存在漏洞，反序列化过程会导致 broker 从攻击者的 HTTP 服务器下载 `poc.xml` 文件并解析它。`poc.xml` 文件中的 Spring Bean 定义随后被实例化，导致 `java.lang.ProcessBuilder` 类执行攻击者指定的命令。
4.  **反向 Shell:** 在提供的 `poc.xml` 示例中，该命令通过反向 shell 连接到攻击者的机器，攻击者可以通过监听4444端口从而控制目标机器

**投毒风险评估：**

通过分析给定的代码，投毒风险较低。`poc.xml` 中执行的命令只是一个创建反向 shell 的标准方法，并不会在目标机器上安装任何恶意软件或执行任何其他恶意活动。漏洞利用代码本身没有明显的恶意行为，例如下载其他可执行文件或修改系统文件。`rule_protect.txt` 旨在提供一种防御措施，而不是投毒。

dockerfile 中描述的环境更多的是为了方便复现漏洞，快速验证, 并不存在投毒代码。

**项目地址:** [CCIEVoice2009/CVE-2023-46604](https://github.com/CCIEVoice2009/CVE-2023-46604)

**漏洞详情:** [CVE-2023-46604](https://nvd.nist.gov/vuln/detail/CVE-2023-46604)