## CVE-2022-22963 - Spring Cloud Function SpEL 表达式注入导致远程代码执行

**漏洞编号:** CVE-2022-22963

**漏洞类型:** 远程代码执行

**影响应用:** Spring Cloud Function

**危害等级:** 高危，可能导致完全控制受影响的服务器

**影响版本:** Spring Cloud Function versions 3.1.6, 3.2.2 及所有旧的和不受支持的版本

**利用条件:** 目标应用程序必须使用了 Spring Cloud Function 的路由功能，并且允许用户提供 routing-expression。

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2022-22963 漏洞存在于 Spring Cloud Function 框架中，当使用路由功能时，攻击者可以提供特制的 SpEL (Spring Expression Language) 表达式作为 routing-expression，导致远程代码执行和访问本地资源。\n\n**有效性分析：**\n根据漏洞库信息和搜索引擎结果，此漏洞是真实存在的，并且具有较高的 CVSS 评分 (9.8)。多个安全厂商和机构已经发布了相关的安全公告和分析报告。提供的 `exploit.py` 代码尝试利用该漏洞，通过设置 `spring.cloud.function.routing-expression` HTTP Header 来注入恶意 SpEL 表达式，从而执行任意命令。`spring4shell.py`则利用了可能存在的spring4shell漏洞，但其目标最终也是在服务器上执行代码。所以提供的POC代码是有效的。\n\n**投毒风险分析：**\n`exploit.py` 代码相对简单，直接发送包含恶意 SpEL 表达式的 HTTP 请求，没有发现明显的恶意代码。`spring4shell.py` 看起来更复杂，但是代码本身的目标也是漏洞利用，而非恶意行为。潜在的风险在于：\n1.  **Reverse Shell Payload:** `spring4shell.py` 中包含一个 reverse shell payload，如果攻击者使用该 payload，则需要目标系统连接回攻击者的 IP 地址和端口。 如果攻击者的服务器被恶意控制，可能导致连接被劫持，并向目标系统投毒。但是reverse shell payload本身是漏洞验证中常用的手段，无法直接判定为投毒代码。\n2.  **依赖关系：** 代码依赖 `requests` 和 `urllib3` 库，如果这些库被篡改，可能引入恶意代码。\n总体来看，投毒的概率较低，主要风险在于攻击者利用 reverse shell 功能时可能引入的风险。因此判定投毒风险为 5%。\n\n**利用方式：**\n1.  攻击者首先需要确定目标应用程序使用了 Spring Cloud Function 的路由功能，并且允许用户提供 routing-expression。\n2.  攻击者构造包含恶意 SpEL 表达式的 HTTP 请求，例如使用 `spring.cloud.function.routing-expression` Header。\n3.  服务器解析 routing-expression 时，会将恶意 SpEL 表达式执行，导致远程代码执行。\n4.  攻击者可以执行任意命令，控制受影响的服务器。

**项目地址:** [G01d3nW01f/CVE-2022-22963](https://github.com/G01d3nW01f/CVE-2022-22963)

**漏洞详情:** [CVE-2022-22963](https://nvd.nist.gov/vuln/detail/CVE-2022-22963)