## CVE-2023-21768 Windows Ancillary Function Driver for WinSock Elevation of Privilege Vulnerability

**漏洞编号:** CVE-2023-21768

**漏洞类型:** 特权提升

**影响应用:** Microsoft Windows

**危害等级:** 高危，可使低权限用户提升至SYSTEM权限

**影响版本:** Windows Server 2022 (versionStartIncluding: 10.0.20348.0, versionEndExcluding: 10.0.20348.1487), Windows 11 21H2 (versionStartIncluding: 10.0.0, versionEndExcluding: 10.0.22000.1455), Windows 11 22H2 (versionStartIncluding: 10.0.22621.0, versionEndExcluding: 10.0.22621.1105)

**利用条件:** 本地访问权限

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2023-21768是一个Windows Ancillary Function Driver (AFD) for WinSock特权提升漏洞。根据漏洞库信息，该漏洞影响Windows Server 2022和Windows 11的特定版本。搜索引擎结果表明，该漏洞允许具有有效系统访问权限的攻击者以提升的权限执行任意代码，属于本地提权漏洞。提供的漏洞利用代码包含一个Visual Studio解决方案文件(WspSocket.sln)和一个C++源文件(ClientServerInit.cpp)。

**有效性：**
从提供的README.md来看, 此exp在Windows 22H2 22621.963上测试通过，表明该漏洞利用代码具有一定的有效性。github链接进一步佐证了POC的有效性。

**投毒风险：**
代码本身是一个简单的客户端-服务器通信示例，用于触发漏洞。其中`ClientServerInit.cpp`文件包含了创建客户端线程和服务器上下文的代码，以及socket通信的相关函数。虽然代码量不大，但仍然存在一定的投毒风险。比如: 替换`payload = 0xdeadbeef`为恶意代码, 或者通过修改`transmitCount` 放大攻击效果。

*   **评估结果：** 代码本身是合法的socket通信代码，但可能被篡改添加恶意行为，例如后门植入。总体投毒风险为10%，主要来自构建项目时的潜在恶意修改。

**利用方式：**
漏洞利用方式是通过AFD驱动程序中的未受信指针解引用漏洞实现的。攻击者利用该漏洞，可以通过构造特定的网络请求或操作，触发AFD驱动程序中的内存错误，从而获得SYSTEM权限。具体步骤可能包括：

1.  利用IO Rings创建 socket，触发漏洞所在函数。
2.  向存在漏洞的socket 发送恶意数据。
3.  利用内存破坏漏洞改写内核数据。
4.  最终实现本地提权。

**项目地址:** [IlanDudnik/CVE-2023-21768](https://github.com/IlanDudnik/CVE-2023-21768)

**漏洞详情:** [CVE-2023-21768](https://nvd.nist.gov/vuln/detail/CVE-2023-21768)