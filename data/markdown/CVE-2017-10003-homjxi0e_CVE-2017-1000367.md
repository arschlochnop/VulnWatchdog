## CVE-2017-1000367 - Sudo权限提升漏洞

**漏洞编号:** CVE-2017-10003

**漏洞类型:** 权限提升

**影响应用:** sudo

**危害等级:** 高危，可能导致本地用户获取root权限

**影响版本:** 受影响版本包括Red Hat Enterprise Linux 6/7, Oracle Enterprise Linux 6/7, CentOS Linux 6/7, Debian wheezy/jessie/stretch/sid, Ubuntu 17.04/16.10/16.04 LTS/14.04 LTS, SUSE Linux Enterprise Software Development Kit 12-SP2, SUSE Linux Enterprise Server for Raspberry Pi 12-SP2, SUSE Linux Enterprise Server 12-SP2, SUSE Linux Enterprise Desktop 12-SP2, OpenSuse, Slackware, and Gentoo Linux

**利用条件:** 需要本地用户权限, 并且系统开启了SELinux。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

该漏洞存在于sudo的get_process_ttyname()函数中。该函数读取/proc/[pid]/stat文件以获取tty设备号。由于comm字段（命令的文件名）可能包含空格，导致tty设备号解析错误。攻击者可以通过创建包含空格的符号链接来执行sudo，诱使get_process_ttyname()搜索错误的tty设备号。进一步利用/dev/shm的world-writable特性，攻击者可以伪造tty设备，结合竞争条件，将任意文件指定为tty。在SELinux启用的系统中，如果用户是sudoer，但命令不授予root权限，则可以利用relabel_tty()函数打开（O_RDWR | O_NONBLOCK）伪造的tty，并将其dup2()到命令的stdin、stdout和stderr，从而覆盖任意文件（包括root拥有的文件），最终获得root权限。

**有效性:**
提供的POC代码针对 CVE-2017-1000367，看起来是有效的。代码尝试利用 /dev/shm 目录下的竞争条件来劫持 tty 设备，并覆盖文件。

**投毒风险:**
代码的README.md包含漏洞描述和受影响的系统，以及修复方法。sudopwn.c包含漏洞利用代码，创建目录和符号链接，设置进程优先级，并使用inotify来监视文件系统的变化。在fork子进程后，通过exec执行sudo命令。父进程设置更高的优先级，并循环读取inotify事件，使用kill向子进程发送信号，实现竞争条件。虽然代码比较复杂，但没有明显的后门代码，例如植入恶意指令或进行反向shell连接。风险评估为10%。

**利用方式:**
1.  创建world-writable的/dev/shm/_tmp目录。
2.  创建符号链接，将/dev/pts/57链接到/dev/shm/_tmp/_tty，/usr/bin/sudo链接到/dev/shm/_tmp/     34873 。
3.  使用inotify监控/dev/shm/_tmp目录。
4.  Fork一个子进程。
5.  在子进程中，降低优先级，然后使用带特定参数的sudo执行/dev/shm/_tmp/     34873 。
6.  在父进程中，设置更高的优先级，并循环读取inotify事件。
7.  当inotify检测到/dev/shm/_tmp目录的IN_OPEN事件时，暂停子进程(kill(pid, SIGSTOP))。
8.  通过竞争条件和tty劫持，利用relabel_tty()函数覆盖文件，获取root权限。

**项目地址:** [homjxi0e/CVE-2017-1000367](https://github.com/homjxi0e/CVE-2017-1000367)

**漏洞详情:** [CVE-2017-10003](https://nvd.nist.gov/vuln/detail/CVE-2017-10003)