## CVE-2021-4034-Polkit-pkexec本地提权

**漏洞编号:** CVE-2021-4034

**漏洞类型:** 本地权限提升

**影响应用:** polkit

**危害等级:** 高危，未经授权的用户可以获得root权限

**影响版本:** all

**利用条件:** 需要本地用户权限

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2021-4034 存在于 polkit 的 pkexec 实用程序中。pkexec 应用程序是一个 setuid 工具，旨在允许非特权用户根据预定义的策略以特权用户身份运行命令。当前版本的 pkexec 未能正确处理调用参数计数，最终尝试将环境变量作为命令执行。攻击者可以通过构造环境变量来诱使 pkexec 执行任意代码来利用此漏洞。成功执行后，攻击会导致本地权限提升，从而使非特权用户获得目标计算机的管理权限。

**有效性评估：**
提供的PoC代码看起来有效。根据漏洞描述和搜索结果，该漏洞利用了 pkexec 对参数处理不当的缺陷，通过设置特定的环境变量来执行恶意代码，从而实现提权。

**投毒风险评估：**
对提供的代码进行分析，并未发现明显的投毒后门。代码的目的是创建一个利用 CVE-2021-4034 漏洞的利用程序。

*   `LICENSE` 和 `README.md` 提供了代码的版权信息和使用说明，没有可疑内容。
*   Python 脚本 `CVE-2021-4034.py` 旨在利用 pkexec 漏洞，它通过创建特定目录结构和文件，并编译一个 C 代码片段来实现提权。这段 C 代码的目的是设置用户ID和组ID为0（root），然后执行一个shell。虽然这段C代码本身具有提权的功能，但它与漏洞利用的上下文相符，不应被视为恶意后门，属于漏洞利用的必要组成部分。

代码片段 `os.system("export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin; rm -rf 'GCONV_PATH=.' 'pwnkit'; /bin/sh")` 意图清除可能存在的恶意目录，并通过 `/bin/sh` 启动一个 root shell。这是一个标准的利用步骤，不是恶意行为。

但是依旧存在通过修改C代码内容达到植入后门，或捆绑恶意程序，达到投毒目的。因此投毒风险占比5%。

**利用方式：**
1.  **环境准备：** 创建特定的目录结构 `GCONV_PATH=.` 和文件 `GCONV_PATH=./pwnkit`。
2.  **编译恶意代码：** 使用 C 语言编写的恶意代码（设置 setuid 等）编译为动态链接库或可执行文件。
3.  **环境变量注入：** 通过构造特定的环境变量（如 GCONV_PATH）诱使 pkexec 加载并执行恶意代码。
4.  **提权：** 成功执行后，当前用户获得 root 权限，可以执行任意系统命令。

**项目地址:** [battleoverflow/CVE-2021-4034](https://github.com/battleoverflow/CVE-2021-4034)

**漏洞详情:** [CVE-2021-4034](https://nvd.nist.gov/vuln/detail/CVE-2021-4034)