## CVE-2021-43798-Grafana-目录遍历

**漏洞编号:** CVE-2021-43798

**漏洞类型:** 目录遍历

**影响应用:** Grafana

**危害等级:** 高危，可能导致敏感信息泄露

**影响版本:** 8.0.0-beta1 to 8.3.0 (除已修补版本外)

**利用条件:** 需要能够访问Grafana实例的网络连接

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2021-43798是一个Grafana目录遍历漏洞。攻击者可以通过构造包含目录遍历序列的URL，例如`grafana_host_url/public/plugins/<plugin_id>/../../../../etc/passwd`，来读取服务器上的任意文件。漏洞存在于Grafana 8.0.0-beta1到8.3.0版本（除已修补版本外）。

**有效性评估：**

根据漏洞库信息和搜索结果，该漏洞确实存在，并且有公开的PoC代码。提供的Go代码不是直接利用目录遍历漏洞的代码，而是用于解密Grafana数据源密码的工具。但是这个代码依赖从Grafana配置文件中获取的key，这个key本身可能通过目录遍历漏洞获取，所以提供的代码可以被认为是漏洞利用链的一部分。如果能够利用目录遍历漏洞读取到Grafana的配置文件，就可以利用这个Go程序解密数据库密码等敏感信息。

**投毒风险评估：**

提供的Go代码主要包含AES解密/加密的相关函数，代码逻辑相对简单，主要包含以下函数：
* `deriveEncryptionAlgorithm`: 根据payload的前缀确定加密算法（AES-CFB或者AES-GCM）。
* `decryptGCM`: 使用AES-GCM算法解密数据。
* `encryptionKeyToBytes`: 使用PBKDF2算法从密钥和salt派生出加密密钥。
* `decryptCFB`: 使用AES-CFB算法解密数据。
* `Decrypt`: 解密payload，主解密函数，先确定算法，然后解密。
* `Encrypt`: 加密payload，已弃用。
* `GetRandomString`: 生成随机字符串。
* `main`: 主函数，演示如何使用`Decrypt`函数解密Grafana数据源密码。

阅读代码后，没有发现明显的恶意代码或者后门。代码的主要功能是解密Grafana的加密数据，虽然存在被滥用的风险，但其本身不包含投毒代码。

**利用方式：**

1.  利用CVE-2021-43798目录遍历漏洞，通过构造特殊的URL读取Grafana服务器上的配置文件，例如`grafana.ini`或类似的配置文件。这个文件通常包含数据库密码等敏感信息，但通常是加密存储的。
2.  从配置文件中获取加密密钥（例如，`secret_key`）。
3.  使用提供的Go代码，将从配置文件中获取的加密密钥以及加密后的数据库密码作为输入，解密数据库密码。
4.  使用解密后的数据库密码连接到Grafana所连接的数据库，从而获取更敏感的数据，甚至可以修改数据库中的数据。

总而言之，此Go代码本身不是投毒代码，但需要配合目录遍历漏洞使用才能发挥作用。没有发现该仓库存在作者隐藏的投毒代码。

**项目地址:** [jas502n/Grafana-CVE-2021-43798](https://github.com/jas502n/Grafana-CVE-2021-43798)

**漏洞详情:** [CVE-2021-43798](https://nvd.nist.gov/vuln/detail/CVE-2021-43798)