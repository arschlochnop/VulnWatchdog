## CVE-2004-2687-distcc-远程代码执行

**漏洞编号:** CVE-2004-2687

**漏洞类型:** 远程代码执行

**影响应用:** distcc

**危害等级:** 高危，可能导致服务器完全控制

**影响版本:** 2.x (未配置访问限制)

**利用条件:** 目标系统运行未配置访问限制的distcc服务，网络可达

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2004-2687 漏洞存在于 distcc 2.x 版本中，当 distcc 未配置为限制对服务器端口的访问时，远程攻击者可以通过编译任务执行任意命令。这些编译任务由服务器在没有授权检查的情况下执行。

**有效性分析：**

提供的 exploit.py 脚本尝试利用此漏洞。它通过创建 socket 连接到目标 distcc 服务器，然后构造一个包含恶意命令的 '编译任务' 请求发送给服务器。如果服务器没有进行适当的访问限制，就会执行该命令。

**投毒风险分析：**

代码主要功能是构造恶意请求并发送，没有发现明显的恶意代码。虽然`rand_text_alphanumeric`函数可能被滥用，但当前代码中只是为了生成一个随机tag，没有被用于执行恶意操作。`requirements.txt`文件声明了依赖`argparse`，没有添加其他可疑的依赖。

代码存在潜在投毒的微小风险：
1.  **`rand_text_alphanumeric`函数：**虽然目前用于生成随机字符串，理论上可以修改该函数植入后门，但现有代码没有这个现象。这种潜在的风险极低，但并非完全不存在。
2.  **依赖项风险：**虽然`argparse`是标准库，但如果作者发布到PyPI，理论上存在供应链投毒风险，但这里是从可信来源获取的，风险极低。 
3. **后门执行风险**：漏洞利用成功后，攻击者可以利用此漏洞在目标系统上执行任意命令，这本身就是一种“后门”植入。但这不是作者投毒代码，而是漏洞本身导致的。

因此，综合评估投毒风险较低，大约为10%。 主要风险来源于利用漏洞成功后，执行的命令可能包含恶意后门。

**利用方式：**

1.  **确定目标distcc服务器。** 通过端口扫描等方式找到运行 distcc 服务的机器，端口通常为 3632。
2.  **检查distcc配置。** 确认目标 distcc 服务器是否配置了访问限制。如果没有，则漏洞存在。
3.  **运行漏洞利用代码。** 使用提供的 exploit.py 脚本，指定目标 IP 地址和端口。
4.  **输入要执行的命令。** 脚本会提示输入要执行的命令。输入命令后，脚本会将其嵌入到 distcc 编译任务请求中，并发送给服务器。
5.  **服务器执行命令。** 如果漏洞利用成功，服务器将以 distcc 服务的权限执行命令，并将结果返回给攻击者。

**安全建议：**

*   配置 distcc 以限制对可信客户端的访问。使用防火墙或其他访问控制机制，只允许授权的机器连接 distcc 服务器。
*   升级 distcc 到最新版本，或者移除 distcc。

**项目地址:** [ss0wl/CVE-2004-2687_distcc_v1](https://github.com/ss0wl/CVE-2004-2687_distcc_v1)

**漏洞详情:** [CVE-2004-2687](https://nvd.nist.gov/vuln/detail/CVE-2004-2687)