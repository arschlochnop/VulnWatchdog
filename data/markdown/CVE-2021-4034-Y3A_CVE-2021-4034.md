## CVE-2021-4034-Polkit-pkexec本地提权

**漏洞编号:** CVE-2021-4034

**漏洞类型:** 本地提权

**影响应用:** Polkit

**危害等级:** 高危，允许本地用户获取root权限

**影响版本:** 所有版本 (在修复之前)

**利用条件:** 需要本地用户权限

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-4034 (PwnKit) 是 polkit pkexec 工具中的一个本地权限提升漏洞。pkexec 是一个 setuid 工具，允许非特权用户根据预定义的策略以特权用户身份运行命令。漏洞的根本原因是 pkexec 未能正确处理调用参数计数，导致它尝试将环境变量作为命令执行。攻击者可以通过构造特定的环境变量，诱使 pkexec 执行任意代码，从而获得 root 权限。

**漏洞利用方式：**

1.  **创建恶意 GCONV 模块:** POC 代码首先创建一个目录结构 `/tmp/GCONV_PATH=.` 和 `/tmp/getpwned`，并在其中创建一个名为 `gconv-modules` 的文件。此文件用于配置 iconv 字符集转换。
2.  **gconv-modules 文件的内容:** `gconv-modules` 文件定义了两个字符集转换规则，将 UTF-8 和 INTERNAL 字符集映射到位于 `/tmp/shell.so` 的恶意共享库。  路径中使用了相对路径跳转，这是为了绕过一些安全检查。
3.  **创建恶意共享库 (shell.so):**  POC 代码使用 `shell.c` 创建了一个共享库 `/tmp/shell.so`。此库包含一个 `gconv_init` 函数，该函数在加载时会被执行。`gconv_init` 函数设置用户的 UID 和 GID 为 0 (root)，然后执行 `/bin/sh`，从而产生一个 root shell。
4.  **创建利用程序 (hax):**  POC 代码使用 `hax.c` 创建一个利用程序 `/tmp/hax`。此程序使用 `execve` 函数执行 `/usr/bin/pkexec`，并传递一组精心构造的环境变量，包括 `PATH=GCONV_PATH=.`、`CHARSET=UTF-16` 和 `SHELL=yeahdoesntexist`。设置`CHARSET=UTF-16` 触发了iconv_open()的调用，利用了`GCONV_PATH=.`查找恶意共享库，而 `SHELL=yeahdoesntexist` 触发了 g_printerr()，都保证共享库能够被加载。
5.  **执行利用程序:**  POC 代码最后执行 `/tmp/hax`，这将触发 pkexec 的漏洞，加载恶意共享库，并生成一个 root shell。

**有效性：**

根据漏洞描述、搜索引擎结果和提供的 POC 代码，此漏洞利用代码是有效的。多个来源证实了该漏洞的存在和可利用性，并且 POC 代码实现了利用该漏洞的步骤。

**投毒风险：**

虽然此 POC 代码主要用于演示漏洞利用，但仍然存在一些潜在的投毒风险：

*   **依赖 /tmp 目录：**  代码大量使用 `/tmp` 目录。如果攻击者能够控制 /tmp 目录的创建或文件内容，可能会篡改 POC 代码，导致意外行为或其他恶意活动。
*   **后门植入:**  shell.c 中设置了 setuid(0) 等操作，如果被修改为连接到外部服务器，则会造成比较严重的后门。
*   **权限问题:**   POC 代码包含 `chmod +x` 命令，这可能会意外地修改文件权限，从而导致安全问题。
*   **代码复杂性：** 尽管 POC 代码相对简单，但它仍然包含 C 代码和 shell 脚本。攻击者可能会利用代码的复杂性来隐藏恶意代码。

综合考虑，投毒风险较低，估计为 10%。主要风险在于代码依赖 `/tmp` 目录，并且代码中共享库本身可以被作为后门来修改。


**项目地址:** [Y3A/CVE-2021-4034](https://github.com/Y3A/CVE-2021-4034)

**漏洞详情:** [CVE-2021-4034](https://nvd.nist.gov/vuln/detail/CVE-2021-4034)