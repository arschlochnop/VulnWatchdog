## CVE-2022-24112 Apache APISIX RCE

**漏洞编号:** CVE-2022-24112

**漏洞类型:** 远程代码执行

**影响应用:** Apache APISIX

**危害等级:** 高危，可完全控制服务器

**影响版本:** < 2.12.1, < 2.10.4, 1.3

**利用条件:** 默认配置，batch-requests插件启用，admin key为默认值或已知，或存在绕过IP限制的可能性。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

该漏洞存在于Apache APISIX的batch-requests插件中。攻击者可以利用该插件绕过Admin API的IP限制。如果使用了默认的API密钥，则可以直接利用RCE。即使更改了API密钥，仍然可能绕过数据面板的IP限制。利用方式是：

1.  攻击者构造包含恶意命令的payload。
2.  该payload被编码为base64字符串。
3.  攻击者发送一个POST请求到`/apisix/batch-requests`端点，其中包含base64编码的payload，并覆盖`X-REAL-IP`头以绕过IP限制。
4.  服务器解码payload并执行其中的恶意命令，例如创建一个新的路由，该路由的`filter_func`会执行任意代码。
5.  攻击者访问新创建的路由，触发恶意代码执行。

**投毒风险分析：**

该POC代码主要功能是利用漏洞执行命令。潜在的投毒风险可能存在于以下几个方面：

1.  **恶意命令注入：**  `cmd = input("Cmd:")` 允许用户输入命令，如果用户不小心执行了恶意命令，可能会对目标系统造成损害。然而，这并非作者主动投毒。
2.  **后门植入：** POC代码中，RCE后创建的路由具有`filter_func`，可能被修改为植入持久性后门。
3.  **依赖项风险：** 虽然代码本身只使用了requests和base64这两个标准库，但如果README.md中推荐的安装步骤包含安装其他的第三方库，则这些库可能存在恶意代码。

综合来看，作者主动投毒的概率较低，但使用者需要注意命令注入风险，以及RCE后被植入后门的风险。因此，评估的投毒风险为10%，主要来自于使用者在不理解代码的情况下，直接将poc应用在生产环境中，可能引入恶意命令，或RCE之后被恶意人员植入后门。

**项目地址:** [SecNN/CVE-2022-24112](https://github.com/SecNN/CVE-2022-24112)

**漏洞详情:** [CVE-2022-24112](https://nvd.nist.gov/vuln/detail/CVE-2022-24112)