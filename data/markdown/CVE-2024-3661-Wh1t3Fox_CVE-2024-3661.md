## CVE-2024-3661-VPN TunnelVision-DHCP路由劫持

**漏洞编号:** CVE-2024-3661

**漏洞类型:** DHCP路由劫持

**影响应用:** VPN客户端

**危害等级:** 高危，可能导致VPN流量泄露，数据窃取，中间人攻击

**影响版本:** 受影响的VPN客户端

**利用条件:** 与受害者处于同一局域网，能够发送DHCP消息

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2024-3661 (TunnelVision) 漏洞利用了DHCP协议允许服务器向客户端推送路由配置的特性。攻击者通过在局域网内架设恶意DHCP服务器，或者通过发送伪造的DHCP Offer消息，将指向特定目标（如DNS服务器、内网地址）的流量路由到攻击者控制的网关。如果VPN客户端依赖DHCP分配的路由进行流量转发，则可能导致本应通过VPN隧道传输的流量直接暴露在物理网络上，从而绕过VPN的保护。 

**漏洞利用方式：**

1.  **DHCP服务器欺骗/中间人攻击：** 攻击者架设一个恶意的DHCP服务器，当受害者连接到与该恶意服务器相同的网络时，受害者会收到恶意的DHCP Offer，其中包含指向攻击者控制的网关的路由。
2.  **DHCP Offer 注入：** 攻击者通过发送伪造的DHCP Offer数据包，诱使受害者客户端更新其路由表。这些数据包包含option 121（Classless Static Route Option），用于添加自定义路由规则。

**POC代码分析：**

*   `dhcp_server.py`:  该脚本模拟一个恶意的DHCP服务器，可以构造并发送包含恶意路由选项（Option 121）的DHCP Offer数据包。通过`create_dhcp_offer`函数创建DHCP Offer包，`construct_option_121_value`函数构造恶意的路由信息，并使用scapy库发送数据包。攻击者可指定目标MAC地址、IP地址、网关和恶意路由。该代码目的是发送包含特定路由信息的DHCP Offer包，诱导客户端修改路由表，达到流量劫持的目的。
*   `dhcp_starvation.py`:  该脚本旨在耗尽DHCP服务器的IP地址池，从而更容易发送包含恶意路由选项的DHCP Offer。它通过伪造大量不同的MAC地址，向DHCP服务器发送DHCP Discover请求，耗尽服务器的可用IP地址，为后续的中间人攻击创造条件。

**有效性：**

根据漏洞信息、搜索结果和提供的PoC代码，可以判断此漏洞是有效的。PoC代码演示了如何构造恶意的DHCP Offer数据包，并将其发送给目标客户端。攻击者可以通过修改Option 121来控制客户端的路由表，从而劫持流量。

**投毒风险：**

PoC代码中存在一定的投毒风险，但风险较低。`dhcp_server.py` 的目的是演示漏洞利用，没有明显的恶意代码。`dhcp_starvation.py` 本身是一种拒绝服务攻击手段，如果攻击者在耗尽IP地址后，再配合`dhcp_server.py`发送恶意DHCP Offer，可能导致更严重的后果。因此，可以将这种行为视为一种隐蔽的攻击链，存在一定的风险。总体判断投毒风险为5%，主要考量为代码逻辑是模拟攻击场景，而非植入后门。

**缓解措施：**

*   配置DHCP Snooping以防止未经授权的DHCP服务器。
*   配置VPN客户端忽略DHCP分配的路由。
*   使用静态路由配置，避免依赖DHCP分配路由。
*   监控网络中的异常DHCP流量。

**项目地址:** [Wh1t3Fox/CVE-2024-3661](https://github.com/Wh1t3Fox/CVE-2024-3661)

**漏洞详情:** [CVE-2024-3661](https://nvd.nist.gov/vuln/detail/CVE-2024-3661)