## CVE-2024-32019-Netdata-本地提权

**漏洞编号:** CVE-2024-32019

**漏洞类型:** 本地提权

**影响应用:** Netdata

**危害等级:** 高危，本地权限提升至root

**影响版本:** >= 1.45.0, < 1.45.3 和 >= 1.44.0-60, < 1.45.0-169

**利用条件:** 需要本地用户权限，且目标系统安装了受影响版本的Netdata

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-32019是Netdata ndsudo工具中的一个本地权限提升漏洞。ndsudo是一个SUID root的程序，但它使用了PATH环境变量来查找要执行的外部命令，攻击者可以通过修改PATH环境变量指向一个自己可控的目录，并在该目录下放置恶意程序，当ndsudo执行外部命令时，会执行攻击者放置的恶意程序，从而获得root权限。

**漏洞利用方式：**

1.  **漏洞检测：** 首先，检查目标系统上是否存在`/opt`目录下的`ndsudo`程序，并且确认该程序是否为root所有且设置了SUID权限。同时，使用`strings`命令检查`ndsudo`程序中是否存在对`nvme`、`smartctl`、`hdparm`或`sensors`等外部命令的调用，如果存在，则说明该程序可能受到PATH环境变量的影响。
2.  **恶意程序编译：** 编译一个C程序，该程序的功能是设置UID和GID为0，然后执行`/bin/bash`，从而获取root shell。
3.  **恶意程序上传：** 通过SFTP将编译好的恶意程序上传到目标系统上的一个攻击者可控的目录，例如`/tmp`。
4.  **环境变量修改：** 修改PATH环境变量，将攻击者可控的目录添加到PATH环境变量的最前面，确保`ndsudo`程序在执行外部命令时首先在该目录下查找。
5.  **漏洞触发：** 执行`ndsudo`程序，当它调用外部命令时，会执行攻击者上传的恶意程序，从而获取root权限。
6.  **交互式Shell：** 漏洞利用代码提供交互式shell。

**投毒风险分析：**

此POC代码本身主要目的是为了验证漏洞，实现本地提权。但是，该脚本包含以下潜在的投毒风险：

*   **编译和传输恶意代码：** 脚本会自动编译C代码生成二进制文件，并上传到目标机器。虽然C代码的内容是提权，但如果恶意攻击者修改了C代码，就可能包含其他恶意行为，例如植入后门、收集信息等。
*   **远程执行代码：**  脚本通过ssh执行远程命令，存在被篡改的风险，可能执行额外的恶意操作。
*   **残留文件：** 编译后的二进制文件和上传的恶意程序可能在目标系统上留下痕迹，如果这些文件被恶意利用，可能会导致进一步的安全问题。

尽管存在这些风险，但总体来说，该POC代码的风险仍然可控，主要风险集中在代码的篡改和恶意利用上。为了降低风险，建议从可信的来源获取POC代码，并仔细检查代码内容，确保其没有恶意行为。此外，在测试完成后，应及时清理目标系统上的残留文件。

投毒风险预估为10%，因为代码相对简洁，主要功能是漏洞验证和利用，但仍然存在被篡改和恶意利用的可能性。

**项目地址:** [dollarboysushil/CVE-2024-32019-Netdata-ndsudo-PATH-Vulnerability-Privilege-Escalation](https://github.com/dollarboysushil/CVE-2024-32019-Netdata-ndsudo-PATH-Vulnerability-Privilege-Escalation)

**漏洞详情:** [CVE-2024-32019](https://nvd.nist.gov/vuln/detail/CVE-2024-32019)