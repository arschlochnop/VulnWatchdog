## CVE-2015-1328 - OverlayFS 本地提权

**漏洞编号:** CVE-2015-1328

**漏洞类型:** 本地提权

**影响应用:** Linux Kernel (OverlayFS)

**危害等级:** 高危，允许本地用户获取root权限

**影响版本:** Ubuntu 12.04, 14.04, 14.10, 15.04 (内核版本 < 3.19.0-21.21)

**利用条件:** 需要在受影响的Ubuntu系统上，且overlayfs未被禁用，并且用户命名空间未被完全隔离。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2015-1328 漏洞存在于 Linux 内核的 overlayfs 实现中，由于权限检查不当，允许本地用户通过在任意挂载命名空间中使用 overlayfs 来获取 root 权限。 

**漏洞利用方式：**

1.  **创建命名空间：** 利用 `unshare(CLONE_NEWUSER)` 和 `clone(CLONE_NEWNS)` 系统调用创建新的用户和挂载命名空间。
2.  **OverlayFS 挂载：** 在新的命名空间中，攻击者通过两次挂载overlayfs文件系统来利用该漏洞。第一次挂载将`/proc/sys/kernel`（或者`/sys/kernel/security/apparmor`在一些内核上）作为下层目录，`/tmp/ns_sploit/upper`作为上层目录。 这允许攻击者在`/tmp/ns_sploit/upper`中创建文件，并在overlayfs中显示为`/proc/sys/kernel`的一部分。
3.  **覆盖 `/etc/ld.so.preload`：** 攻击者利用 overlayfs 的特性，将 `ns_last_pid` 或 `.access`重命名为 `ld.so.preload`，并将它放置在 overlayfs 的 upperdir 中，从而覆盖系统的 `/etc/ld.so.preload` 文件。`ld.so.preload`指定了动态链接器在加载其他共享库之前预加载的共享库，通常用于调试或者性能优化，但也可以被恶意利用。
4.  **创建恶意共享库：** 创建一个恶意共享库 `/tmp/ofs-lib.so`，其中包含在任何程序执行时都会运行的代码（本例中为提权到 root shell 的代码）。该恶意库会取消链接`/etc/ld.so.preload`和`/tmp/ofs-lib.so`，然后使用`setresuid(0, 0, 0)`和`setresgid(0, 0, 0)`提权到root，最后执行一个交互式的shell。
5.  **触发提权：** 通过执行 `/bin/su` 命令来触发动态链接器加载 `/etc/ld.so.preload` 中指定的恶意共享库。由于该库包含提权代码，因此执行 `/bin/su` 会导致攻击者获得 root 权限。

**有效性：**

根据漏洞库信息和搜索结果，提供的 POC 代码针对的是 CVE-2015-1328 漏洞，该漏洞影响 Ubuntu 15.04 及之前的版本，并且内核版本低于 3.19.0-21.21。提供的 POC 代码在特定版本的 Ubuntu 上有效。

**投毒风险：**

POC 代码主要目的是利用 overlayfs 的权限漏洞来实现提权。其中存在一定的投毒风险，因为：

*   **恶意共享库：** POC 创建了一个共享库 `/tmp/ofs-lib.so`，虽然其目的是提权，但恶意库可以被修改为执行其他恶意操作，例如安装后门、窃取数据或破坏系统。
*   **`/etc/ld.so.preload`劫持：** 劫持 `/etc/ld.so.preload` 可能会导致其他程序受到影响，因为所有程序都会加载该文件中指定的库。虽然POC在提权成功后会删除`/etc/ld.so.preload`和`/tmp/ofs-lib.so`，但如果提权失败，可能会留下一个被修改过的`/etc/ld.so.preload`，导致系统不稳定或者为后续攻击留下后门。
*   **概率：** 投毒风险的概率大约为10%，主要是考虑到恶意库可以被修改，以及`/etc/ld.so.preload`被劫持后可能带来的潜在影响。

**项目地址:** [1mgR00T/CVE-2015-1328](https://github.com/1mgR00T/CVE-2015-1328)

**漏洞详情:** [CVE-2015-1328](https://nvd.nist.gov/vuln/detail/CVE-2015-1328)