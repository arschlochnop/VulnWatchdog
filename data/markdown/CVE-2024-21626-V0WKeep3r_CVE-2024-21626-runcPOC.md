## CVE-2024-21626-runc容器逃逸

**漏洞编号:** CVE-2024-21626

**漏洞类型:** 容器逃逸

**影响应用:** runc

**危害等级:** 高危，可能导致容器逃逸，完全控制宿主机

**影响版本:** < 1.1.12

**利用条件:** 需要使用存在漏洞的runc版本，攻击者需要能够控制容器或使用恶意镜像创建容器

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-21626 漏洞允许攻击者通过文件描述符泄漏实现容器逃逸。当使用 `runc exec` 创建新容器进程时，由于未正确关闭文件描述符，宿主机的文件描述符可能会泄漏到容器环境中。攻击者可以利用这些泄漏的文件描述符访问和修改宿主机的文件系统，从而导致容器逃逸，完全控制宿主机。

**有效性:**

提供的POC代码有效，可以利用该漏洞实现容器逃逸。

*   `Dockerfile`: 用于构建包含漏洞利用脚本的恶意镜像。关键在于将工作目录设置为 `/proc/self/fd/8`，利用泄漏的文件描述符。
*   `poc.sh`: 漏洞利用脚本，用于修改宿主机上的 `/var/spool/cron/crontabs/root` 文件，添加反弹shell的定时任务，从而获取宿主机的shell。
*   `poc2.sh`: 漏洞利用脚本，用于覆盖宿主机上的 `/bin/bash.copy` 文件，实现反弹shell。
*   `verify.sh`: 用于查找当前机器环境中泄漏的文件描述符对应的具体值。
*   `README.md`: 提供了漏洞的简介、利用方法、原理分析和修复方案。

**投毒风险:**

代码中存在潜在的投毒风险，主要体现在 `poc.sh` 和 `poc2.sh` 脚本中。

*   `poc.sh` 通过修改 `/var/spool/cron/crontabs/root` 文件添加定时任务，该文件是宿主机上的系统文件。恶意修改该文件可能导致宿主机上的其他定时任务失效，或者执行恶意代码。但考虑到这是POC验证的一部分，该行为可以被理解。
*   `poc2.sh` 脚本尝试覆盖 `/bin/bash.copy` 文件。如果该文件不存在，脚本执行会失败。如果存在，则会覆盖该文件，可能导致系统不稳定，或者执行恶意代码。同样的，考虑到这是POC，该行为可以被理解。

总体来说，该仓库的投毒风险较低（10%），主要是一些可能影响宿主机的恶意修改操作。恶意修改定时任务文件和覆盖二进制文件可能对系统造成一定影响，但这些操作是漏洞验证的必要步骤。

**利用方式:**

1.  **构建恶意镜像:** 使用 `Dockerfile` 构建包含漏洞利用脚本的恶意镜像。
2.  **查找泄漏的文件描述符:** 运行 `verify.sh` 脚本，查找当前机器环境中泄漏的文件描述符对应的具体值。如果不是8，需要修改 Dockerfile 的 WORKDIR 或者在使用 `docker run` 时使用 `-w` 参数指定。
3.  **运行恶意镜像:** 运行构建好的恶意镜像，并执行漏洞利用脚本 `poc.sh` 或 `poc2.sh`。
4.  **利用泄漏的文件描述符:** 脚本利用泄漏的文件描述符，修改宿主机上的文件系统。
5.  **获取宿主机shell:** 通过修改定时任务文件或覆盖二进制文件的方式，获取宿主机的shell，实现容器逃逸。

攻击者需要能够控制容器，或者使用恶意镜像创建容器才能成功利用此漏洞。根据搜索结果，该漏洞影响很大，可能导致对底层宿主机的完整控制。

**项目地址:** [V0WKeep3r/CVE-2024-21626-runcPOC](https://github.com/V0WKeep3r/CVE-2024-21626-runcPOC)

**漏洞详情:** [CVE-2024-21626](https://nvd.nist.gov/vuln/detail/CVE-2024-21626)