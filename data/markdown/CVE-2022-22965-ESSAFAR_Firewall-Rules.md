## CVE-2022-22965-Spring4Shell-RCE

**漏洞编号:** CVE-2022-22965

**漏洞类型:** 远程代码执行

**影响应用:** Spring Framework

**危害等级:** 高危，可能导致服务器被完全控制

**影响版本:** Spring Framework versions 5.3.X prior to 5.3.18+, 5.2.x prior to 5.2.20+ and all old and unsupported versions

**利用条件:** JDK 9+，运行在Tomcat上，部署为WAR包，Spring MVC或Spring WebFlux应用

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2022-22965（Spring4Shell）是一个Spring Framework中的远程代码执行漏洞。攻击者可以利用数据绑定机制，通过构造恶意的请求，修改Tomcat的日志配置，例如修改日志文件的存放路径和文件后缀名为jsp，然后向日志文件写入webshell，从而获得服务器的控制权。

**有效性：**
根据漏洞库信息、搜索引擎结果和漏洞利用代码来看，此漏洞是有效的。漏洞库信息中提到该漏洞可能导致RCE，并被CISA收录到已知被利用的漏洞目录中。搜索引擎结果中也提及了该漏洞的利用和分析，并且存在公开的POC。
提供的漏洞利用代码是一个用于检测和阻止针对此漏洞的防火墙服务器脚本。它通过检测请求路径和HTTP头中包含的特定模式来识别可能的攻击请求。因此，代码本身并不是POC，而是防御工具，但是侧面验证了漏洞的存在和利用方式。

**投毒风险：**
提供的python脚本是一个简单的HTTP服务器，其主要功能是根据请求的路径和头部信息来判断是否拦截该请求。如果请求的路径包含`/tomcatwar.jsp`，或者HTTP头部包含特定的字符串（如`suffix=%>//`， `c1=Runtime`，`c2=<%`等），则该请求会被拦截。该脚本的目的是模拟一个防火墙，用于防御针对CVE-2022-22965的攻击，**并未发现任何投毒代码，因此投毒风险为0%**。

**利用方式：**
1.  **目标环境：** 目标应用程序必须满足以下条件：
    *   使用Spring MVC或Spring WebFlux框架。
    *   运行在JDK 9及以上版本。
    *   部署在Tomcat服务器上，并且是WAR包部署。
2.  **攻击方法：** 攻击者通过发送精心构造的HTTP请求，利用Spring的数据绑定功能，修改`class.module.classLoader.resources.context.parent.pipeline.first.pattern`的值为包含webshell的恶意代码,并且修改`class.module.classLoader.resources.context.parent.pipeline.first.suffix`的值为`.jsp`,以及`class.module.classLoader.resources.context.parent.pipeline.first.directory`设置为`webapps/[应用名]`，从而将webshell写入到可执行的JSP文件中。
3.  **RCE实现：** 写入webshell后，攻击者可以通过访问该JSP文件来执行任意代码，从而控制服务器。

**项目地址:** [ESSAFAR/Firewall-Rules](https://github.com/ESSAFAR/Firewall-Rules)

**漏洞详情:** [CVE-2022-22965](https://nvd.nist.gov/vuln/detail/CVE-2022-22965)