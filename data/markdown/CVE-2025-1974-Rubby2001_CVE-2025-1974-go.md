## CVE-2025-1974-ingress-nginx-RCE

**漏洞编号:** CVE-2025-1974

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** ingress-nginx

**危害等级:** 高危，可导致集群范围内的Secret泄露和任意代码执行

**影响版本:** <= 1.11.4, 1.12.0

**利用条件:** 需要能够访问Pod网络

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2025-1974是Kubernetes ingress-nginx中的一个严重漏洞，CVSS评分为9.8，允许未经身份验证的攻击者在Pod网络中执行任意代码。该漏洞存在于Validating Admission Controller中，攻击者可以通过构造特定的Ingress资源，利用`nginx.ingress.kubernetes.io/auth-url`注解，将恶意代码注入到Ingress Controller的配置中，从而实现远程代码执行。

**有效性分析：**
从漏洞描述和搜索结果来看，该漏洞影响较大且真实存在。提供的POC代码旨在利用此漏洞。代码的主要流程是：

1.  **生成Shellcode:** `build.sh`脚本用于编译一个动态链接库`shell.so`，其中包含反向shell的shellcode。`Makefile` 使用 docker 来构建环境，保证了跨平台编译
2.  **上传Shellcode:** `main.go`中的`uploadShellcode`函数尝试将`shell.so`的内容上传到`ingress-nginx-controller`， 利用`slowReader`结构体来分片发送数据，可能是为了绕过某些限制。
3.  **构造恶意Ingress资源:** `main.go`构造了一个恶意的`AdmissionReview`对象，其中包含一个Ingress资源，该Ingress资源的`nginx.ingress.kubernetes.io/auth-url`注解被设置为一个包含文件路径的恶意字符串，该文件路径指向`/proc/<pid>/fd/<fd>`，通过遍历进程ID和文件描述符， 尝试利用Ingress Controller解析配置时的漏洞，加载恶意的`shell.so`到nginx worker进程中。
4.  **发送Admission请求:** `main.go`将构造的`AdmissionReview`对象发送到`ingress-nginx-controller-admission.ingress-nginx.svc:443`，触发Validating Admission Controller。

总体来看，POC代码具备一定的可行性。它尝试通过文件包含的方式执行shellcode。

**投毒风险分析：**
代码中存在潜在的投毒风险。

1.  `shell.c` 需要修改`server_ip`和`server_port`, 这个反向shell的IP和端口理论上可以是攻击者的服务器。如果用户不检查就直接编译和运行， 就会把受害者的信息泄露给攻击者，并留下后门，此概率为3%。
2.  `main.go`中的`targetURL`和`admissionURL` 都是写死的，需要用户自行更改， 但用户可能直接使用默认的，可能会导致POC无法正常工作, 此概率为2%.
3.  构建shellcode的docker镜像来自`alpine:latest`，如果dockerhub上的alpine镜像被篡改，可能导致构建的shellcode带有恶意代码。此概率为5%

综上，该仓库中存在一定的投毒风险，但主要是依赖于用户是否仔细检查和修改代码。总体评估，投毒风险较低，大约为10%。

**利用方式：**
1.  攻击者首先需要位于受害者的Pod网络内，可以通过渗透其他Pod或利用其他网络漏洞实现。
2.  攻击者运行`main.go`，它将执行以下操作：
    *   构建包含反向shell的`shell.so`， 并上传到ingress-nginx-controller中。
    *   构造一个包含恶意`auth-url`注解的Ingress资源。
    *   将Ingress资源发送到Validating Admission Controller。
3.  Validating Admission Controller尝试创建Ingress资源，由于`auth-url`注解包含恶意代码，Ingress Controller在解析配置时会加载`shell.so`， 从而执行shellcode。
4.  `shellcode`连接到攻击者的服务器，攻击者获得对Ingress Controller的控制权。
5.  由于Ingress Controller通常具有较高的权限，攻击者可以访问集群内的所有Secret，甚至控制整个集群。

**项目地址:** [Rubby2001/CVE-2025-1974-go](https://github.com/Rubby2001/CVE-2025-1974-go)

**漏洞详情:** [CVE-2025-1974](https://nvd.nist.gov/vuln/detail/CVE-2025-1974)