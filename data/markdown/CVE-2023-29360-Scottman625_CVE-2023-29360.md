## CVE-2023-29360 Microsoft Streaming Service Elevation of Privilege Vulnerability

**漏洞编号:** CVE-2023-29360

**漏洞类型:** 特权提升

**影响应用:** Microsoft Streaming Service

**危害等级:** 高危，可导致本地权限提升

**影响版本:** 受影响的Windows版本请参考漏洞库信息

**利用条件:** 需要在受影响的Windows系统上本地执行。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

根据漏洞库信息，CVE-2023-29360是Microsoft Streaming Service的特权提升漏洞。该漏洞的CWE为CWE-822: Untrusted Pointer Dereference(不可信指针解引用)。CISA已将其添加到已知被利用的漏洞目录中。从提供的漏洞利用代码来看，利用方式如下：

1.  **句柄泄露：** 利用 `NtQuerySystemInformation` 获取系统句柄信息，从而找到目标进程的句柄。
2.  **设备交互：** 通过打开设备句柄（`DeviceH1`， `DeviceH2`， `DeviceH3`）与Microsoft Streaming Service进行交互。
3.  **上下文、流初始化与注册：** 调用 `FSInitializeContextRendezvous`， `FSInitializeStream`， `FSRegisterStream` 函数，初始化和注册流服务。
4.  **事务处理：** 利用 `PublishTx` 函数发布事务，目标地址为当前进程token的privilege地址（`privAddr = tokenAddress + OFFSET_OF_TOKEN_PRIVILEGES;`），然后利用 `ConsumeTx` 函数消费事务，实现任意地址映射。
5.  **权限修改：** 将Token权限的内存区域填充为0xFF，启用所有特权。
6.  **提权Shell：** 调用 `spawnShell()` 生成提权的cmd进程

**有效性评估：** 根据CISA KEV目录，该漏洞已被积极利用，提供的PoC代码很可能有效，可以在目标系统上实现本地提权。

**投毒风险分析：** 虽然PoC的主要目的是利用漏洞进行提权，但存在一些潜在的投毒风险：

*   **硬编码偏移量：** 代码中存在硬编码的 `OFFSET_OF_TOKEN_PRIVILEGES`，如果目标系统与PoC作者使用的系统版本不一致，偏移量可能不正确，导致提权失败甚至系统崩溃。恶意攻击者可能利用这一点，通过提供错误偏移量的PoC，导致目标系统不稳定。
*   **spawnShell 函数：** 检查 `spawnShell` 函数的具体实现。如果该函数包含任何下载或执行其他恶意代码的逻辑，则存在潜在的投毒风险。由于没有 `spawnShell` 函数的具体代码，这里只能推测。
*   **依赖库投毒：** `compile_c.sh` 脚本中使用了 `x86_64-w64-mingw32-g++` 编译器，该编译器可能被恶意替换或篡改，从而在编译后的可执行文件中注入恶意代码。但这种可能性较低，需要用户主动替换编译器。

总体来说，投毒风险主要集中在偏移量的错误、`spawnShell` 函数的恶意行为以及编译环境的潜在威胁。结合CISA利用信息和对代码的分析,PoC可用,但是存在一定的投毒风险, 概率为10%。

**项目地址:** [Scottman625/CVE-2023-29360](https://github.com/Scottman625/CVE-2023-29360)

**漏洞详情:** [CVE-2023-29360](https://nvd.nist.gov/vuln/detail/CVE-2023-29360)