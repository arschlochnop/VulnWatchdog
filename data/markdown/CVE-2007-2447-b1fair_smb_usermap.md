## CVE-2007-2447-Samba-远程命令执行

**漏洞编号:** CVE-2007-2447

**漏洞类型:** 远程命令执行

**影响应用:** Samba

**危害等级:** 高危，可能导致服务器完全控制

**影响版本:** 3.0.0 through 3.0.25rc3

**利用条件:** 需要目标Samba服务器启用"username map script"选项，或者利用其他MS-RPC函数（如打印机和文件共享管理）进行攻击。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2007-2447 漏洞存在于 Samba 3.0.0 到 3.0.25rc3 版本中，允许远程攻击者通过 MS-RPC 功能执行任意命令。漏洞的利用方式主要有两种：

1.  **username map script:** 当 `smb.conf` 文件中启用了 `username map script` 选项时，攻击者可以利用 `SamrChangePassword` 函数，通过构造包含 shell 元字符的用户名，实现远程命令执行。POC代码 `b1f_usermap.py` 展示了这种利用方式，它通过修改用户名`/=`来注入命令，并利用 `nohup` 使命令在后台运行。

2.  **其他 MS-RPC 函数:** 即使没有启用 `username map script`，攻击者也可以利用其他 MS-RPC 函数（如远程打印机和文件共享管理），通过注入 shell 元字符来执行命令。POC 代码中的 `smbclient` 命令也演示了一种简单的利用方式，虽然复杂命令可能因为特殊字符的转义而无法执行，但简单的命令如 `reboot` 可以成功利用。

**有效性：** 提供的POC代码有效，可以利用该漏洞在目标系统上执行任意命令。

**投毒风险：** 仓库中存在投毒代码的风险较低，约为10%。主要原因是：

*   `LICENSE` 和 `README.md` 文件内容正常，未发现恶意代码。
*   `b1f_usermap.py` 脚本虽然包含漏洞利用代码，但未发现作者故意添加的后门或恶意代码。脚本只是利用了已知的漏洞。
*    投毒风险主要来源于，攻击者可能会修改脚本，添加恶意代码，然后传播修改后的脚本。因此，在使用任何第三方提供的漏洞利用代码时，都需要进行仔细的安全审查。

**利用方式总结：** 攻击者通过构造包含 shell 元字符的恶意输入，利用 Samba 的 MS-RPC 功能中的命令注入漏洞，从而在目标系统上执行任意命令。利用途径包括 `SamrChangePassword` 函数（在启用 `username map script` 的情况下）以及其他 MS-RPC 函数（如远程打印机和文件共享管理）。

**项目地址:** [b1fair/smb_usermap](https://github.com/b1fair/smb_usermap)

**漏洞详情:** [CVE-2007-2447](https://nvd.nist.gov/vuln/detail/CVE-2007-2447)