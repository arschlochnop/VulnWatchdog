## CVE-2023-22527-Confluence-RCE

**漏洞编号:** CVE-2023-22527

**漏洞类型:** 远程代码执行

**影响应用:** Atlassian Confluence Data Center 和 Confluence Server

**危害等级:** 严重，未经身份验证的攻击者可以实现远程代码执行

**影响版本:** 8.0.0 <= version < 8.5.4

**利用条件:** 目标Confluence实例版本在受影响范围内，并且攻击者可以访问Confluence服务器的网络。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2023-22527 是 Atlassian Confluence Data Center 和 Confluence Server 中的一个模板注入漏洞。攻击者可以利用 Velocity 模板引擎，通过构造特定的请求，执行任意代码。 

**利用方式：**

1.  **漏洞点：** 漏洞存在于`/template/aui/text-inline.vm`文件，该文件允许用户控制 `label` 参数，从而导致模板注入。
2.  **OGNL 注入：** 攻击者可以使用 OGNL 表达式来执行任意 Java 代码。该漏洞是由于Confluence没有充分过滤OGNL表达式而造成的。
3.  **利用步骤：**
    *   攻击者发送一个包含恶意 OGNL 表达式的 POST 请求到 `/template/aui/text-inline.vm`。`label`参数的值经过精心构造，包含了 Velocity 模板引擎的指令，用于执行 OGNL 表达式。
    *   恶意 OGNL 表达式会调用 `freemarker.template.utility.Execute` 类的 `exec` 方法，该方法允许执行任意系统命令。
    *   服务器执行命令并将结果放在响应头`X-Cmd-Response`中返回给攻击者。

**POC有效性：**

提供的 POC 代码是一个 Python 脚本，它利用了上述漏洞。脚本接受目标 Confluence URL 和要执行的命令作为参数，并发送构造好的 POST 请求。如果漏洞存在，脚本会从响应头中提取命令执行的结果并打印出来，否则提示无响应。这个POC代码是可以有效利用的。

**投毒风险：**

查看提供的漏洞利用代码文件和 `README.md` 文件，主要作用是提供漏洞利用方式和说明，没有发现明显的恶意代码或后门。虽然POC代码本身用于远程代码执行，存在被恶意使用的可能，但这不属于投毒。 仓库中 Dockerfile 和调试端口的存在方便了漏洞复现，但也增加了攻击者利用的便利性。考虑到作者可能隐藏一些不易察觉的恶意代码，因此存在一定的投毒风险，风险比例估计为10%。主要是指一些隐蔽的命令植入，例如添加计划任务等。

**项目地址:** [Avento/CVE-2023-22527_Confluence_RCE](https://github.com/Avento/CVE-2023-22527_Confluence_RCE)

**漏洞详情:** [CVE-2023-22527](https://nvd.nist.gov/vuln/detail/CVE-2023-22527)