## CVE-2022-0492-Linux Kernel-cgroup release_agent 权限提升/容器逃逸

**漏洞编号:** CVE-2022-0492

**漏洞类型:** 权限提升/容器逃逸

**影响应用:** Linux Kernel

**危害等级:** 高危，可能导致容器逃逸和主机控制

**影响版本:** <= 5.17-rc3

**利用条件:** 容器需要以root权限运行，并且没有开启严格的安全措施（seccomp禁用unshare，apparmor开启cgroup只读，selinux开启）

**POC 可用性:** 是

**投毒风险:** 1%

## 详情

该漏洞存在于Linux内核的cgroup子系统的`cgroup_release_agent_write`函数中。由于访问控制缺失，攻击者可以修改cgroup的release_agent，导致在cgroup中最后一个进程退出时，执行攻击者指定的文件，从而实现权限提升或容器逃逸。

**利用方式：**

1.  **环境准备：** 准备一个存在漏洞的Linux内核版本的环境，例如使用Docker容器。
2.  **获取Root权限：** 确保在容器内拥有root权限。
3.  **检查安全措施：** 确认容器没有开启严格的安全措施，例如seccomp、apparmor和selinux。如果seccomp禁用了`unshare`，或者apparmor开启了cgroup只读，则需要绕过这些限制。
4.  **挂载cgroup文件系统：** 将cgroup文件系统挂载到一个目录，例如`/tmp/testcgroup`。
5.  **创建cgroup子节点：** 在挂载的cgroup目录下创建一个子目录，例如`/tmp/testcgroup/x`。
6.  **修改release_agent：** 修改`release_agent`文件，将其设置为一个攻击者可控的脚本路径，例如`/cmd`。该脚本将在容器逃逸时被执行。
7.  **设置notify_on_release：** 将`notify_on_release`设置为1，表示当cgroup中最后一个进程退出时，执行`release_agent`指定的脚本。
8.  **创建恶意脚本：** 创建一个恶意脚本，例如`/cmd`，该脚本将在宿主机上执行恶意操作，例如反弹shell或执行其他命令。
9.  **触发漏洞：** 退出cgroup中的所有进程，触发`release_agent`执行，从而实现容器逃逸。

**投毒风险分析：**

该POC代码主要包含环境搭建和漏洞利用的步骤，本身没有明显的投毒代码。

1.  README.md文件仅包含漏洞原理、利用条件和利用方式的描述。
2.  用于漏洞利用的脚本`/cmd`由用户手动创建，攻击者可以完全控制其内容。
3.  代码中没有发现任何隐藏的后门或恶意代码。

因此，可以认为此仓库中存在作者隐藏的投毒代码的风险较低，但是用户仍然应该仔细审查和理解代码，避免执行未知的操作。 总体投毒风险估计为1%。

**项目地址:** [chenaotian/CVE-2022-0492](https://github.com/chenaotian/CVE-2022-0492)

**漏洞详情:** [CVE-2022-0492](https://nvd.nist.gov/vuln/detail/CVE-2022-0492)