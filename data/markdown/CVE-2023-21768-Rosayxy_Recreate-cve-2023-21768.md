## CVE-2023-21768 Windows AFD Elevation of Privilege

**漏洞编号:** CVE-2023-21768

**漏洞类型:** 权限提升

**影响应用:** Windows AFD.sys

**危害等级:** 高危，可导致本地权限提升至SYSTEM

**影响版本:** Windows Server 2022 (versionStartIncluding: 10.0.20348.0, versionEndExcluding: 10.0.20348.1487), Windows 11 21H2 (versionStartIncluding: 10.0.0, versionEndExcluding: 10.0.22000.1455), Windows 11 22H2 (versionStartIncluding: 10.0.22621.0, versionEndExcluding: 10.0.22621.1105)

**利用条件:** 本地访问权限

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2023-21768 是 Windows Ancillary Function Driver (AFD.sys) 中的一个权限提升漏洞。攻击者可利用此漏洞在受影响的系统上以 SYSTEM 权限执行任意代码。

**有效性分析：**

根据搜索结果和漏洞利用代码，该漏洞的 POC 是有效的。搜索结果中的网页 7 指出 "Complete exploit works on vulnerable Windows 11 22H2 systems. Write primitive works on all vulnerable systems." 提供的代码也包含了完整的利用程序。

**投毒风险分析：**

漏洞利用代码主要通过以下方式实现提权：
1.  **利用 AFD.sys 漏洞：** 漏洞存在于 `AfdNotifyRemoveIOCompletion` 函数中，该函数在特定条件下会错误地使用用户提供的地址作为内核地址，从而允许任意内核写入。
2.  **利用 IORING：**  POC 使用 IORING 技术来实现任意内核读取和写入。这是通过首先获得一个任意内核写原语（Arbitrary Kernel Write）来实现的，然后利用 IORING 来获得完整的读/写能力。
3.  **绕过安全检查：**  POC 通过构造特定的 `AFD_NOTIFYSOCK_DATA` 结构来绕过 AFD.sys 驱动程序中的各种安全检查。

该漏洞利用代码没有明显的恶意行为或后门。风险主要在于利用复杂，需要对 Windows 内核机制有较深入的理解，因此手动添加恶意代码有一定的难度。`AFD_NOTIFYSOCK_DATA` 结构体中各个成员的赋值，是为了满足函数调用链中的各种检查。尽管代码可能存在未知的安全隐患，但基于目前的信息，投毒的概率较低，估计在 10% 左右。

**利用方式总结：**

1.  **查找 NT 函数：**  通过 `GetNtFunctions` 函数获取 `NtCreateFile`, `NtDeviceIoControlFile`, `NtCreateIoCompletion`, `NtSetIoCompletion`, `NtQuerySystemInformation` 等未公开的 NT 函数地址。
2.  **创建句柄：**  使用 `NtCreateIoCompletion` 创建一个 I/O 完成端口的句柄。
3.  **构造数据：**  构造 `AFD_NOTIFYSOCK_DATA` 结构，其中包含用于绕过安全检查的特定值以及要写入的内核地址。
4.  **触发漏洞：**  通过 `NtDeviceIoControlFile` 向 AFD.sys 驱动程序发送 `AFD_NOTIFYSOCK_IOCTL` 控制码，触发漏洞。
5.  **任意内核写入：**  利用漏洞实现任意内核写入，将精心构造的数据写入到目标内核地址。
6.  **利用 IORING提权：**  使用IORING技术,实现内核任意地址读写，最终实现权限提升。

**项目地址:** [Rosayxy/Recreate-cve-2023-21768](https://github.com/Rosayxy/Recreate-cve-2023-21768)

**漏洞详情:** [CVE-2023-21768](https://nvd.nist.gov/vuln/detail/CVE-2023-21768)