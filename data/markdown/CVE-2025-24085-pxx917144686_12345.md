## CVE-2025-24085 - XNU内核压缩内存子系统权限绕过漏洞

**漏洞编号:** CVE-2025-24085

**漏洞类型:** Use-After-Free (释放后使用)

**影响应用:** Apple iOS, iPadOS, macOS, tvOS, watchOS, visionOS (CoreMedia)

**危害等级:** 高危，权限提升

**影响版本:** iOS < 18.3 (actively exploited before 17.2), macOS < 15.3, tvOS < 18.3, watchOS < 11.3, visionOS < 2.3

**利用条件:** 本地应用，需要用户交互

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2025-24085 是一个 XNU 内核压缩内存子系统中的释放后使用漏洞，允许恶意应用程序提升权限。Apple 意识到该漏洞可能已被积极利用于 iOS 17.2 之前的版本。

**漏洞原理：**
该漏洞存在于 XNU 内核的压缩内存 (VM_COMPRESSOR) 子系统中。在特定条件下，当系统尝试压缩和解压缩页面时，内核未能正确维护内存页面的原始保护标志，导致可以在解压缩过程中修改只读内存页面的内容。

**利用方式：**
1.  映射目标只读文件。
2.  创建内存压力（通过分配大量内存强制系统压缩）。
3.  设置内存通知回调。
4.  触发内存压缩/解压缩循环。
5.  在解压缩时间窗口内修改只读页面内容。

**POC 分析：**
POC 代码尝试通过以下步骤利用该漏洞：
*   使用 `mmap` 将目标文件映射为只读。
*   创建一个 `memory_pressure_thread` 来模拟内存压力，促使系统压缩页面。
*   使用信号量 `g_exploit_semaphore` 和 `g_pressure_semaphore` 控制压缩和解压缩的时机。
*   `page_monitor_thread` 尝试在解压缩的时间窗口内写入目标页面。

**有效性评估：**
POC 代码提供了一个利用漏洞的基本框架。 根据漏洞信息显示，该漏洞已被野外利用，所以该PoC具有一定有效性，能够提权。但是，代码中的内存通知注册部分标记为 "概念验证"，表明需要使用真实的通知 API（例如 `host_register_mach_notification` 或类似机制）才能完整实现漏洞利用。

**投毒风险分析：**
代码中存在少量潜在的投毒风险，主要体现在以下几个方面：
*   `memory_pressure_thread` 中，循环分配内存并写入特定数据，理论上可以被篡改为恶意代码，但需要精巧的构造，可能性较低。
*    使用内联汇编直接写入内存。内联汇编提供了直接操作内存的能力，但是如果被恶意修改，可能导致意外的系统行为或崩溃。虽然代码里添加了注释说明是绕过编译器检查，但这仍然是一个潜在的风险点。
*   虽然代码本身主要关注提权，但也可能包含一些额外的、未公开的目的，例如收集系统信息或植入后门。不过，就现有代码来看，这种可能性较低，所以认定为10%。 总体评估投毒风险为10%。

**项目地址:** [pxx917144686/12345](https://github.com/pxx917144686/12345)

**漏洞详情:** [CVE-2025-24085](https://nvd.nist.gov/vuln/detail/CVE-2025-24085)