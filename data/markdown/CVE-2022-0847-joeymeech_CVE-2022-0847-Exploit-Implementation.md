## CVE-2022-0847 Dirty Pipe本地提权

**漏洞编号:** CVE-2022-0847

**漏洞类型:** 本地权限提升

**影响应用:** Linux Kernel

**危害等级:** 高危，可导致本地用户权限提升至root

**影响版本:** Linux Kernel 5.8 ~ 5.16.10, 5.15.0 ~ 5.15.24, 5.10.0 ~ 5.10.101

**利用条件:** 需要本地用户权限

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2022-0847 Dirty Pipe 漏洞是 Linux 内核中的一个本地权限提升漏洞。它允许未经授权的进程覆盖只读文件中的内容，从而提升权限。漏洞根源在于 pipe buffer 结构中的 "flags" 成员缺乏适当的初始化，导致可以使用过时的值。攻击者可以通过利用 splice 和 write 系统调用之间的竞争条件，将恶意数据写入只读文件支持的页面缓存中。 

**有效性：**
根据漏洞库信息、搜索引擎结果以及漏洞利用代码，可以判断提供的POC代码是有效的。搜索引擎结果中多次提到该漏洞存在可用的POC，且漏洞利用代码看起来完整并针对该漏洞。漏洞库信息也确认了该漏洞的存在和影响。

**投毒风险：**
POC代码主要修改了`/etc/pam.d/s` 文件，以及`/etc/passwd` 文件。`leapyear.c` 看起来是一个简单的闰年判断程序，但实际上它通过Dirty Pipe漏洞修改了系统的认证配置，允许无需密码即可获取root权限，并且尝试通过`socat`建立反向shell。虽然`socat`的使用是漏洞利用的一部分，用于建立连接，不属于投毒代码。代码中存在的潜在风险是：

*   修改`/etc/pam.d/s` 或者 `/etc/passwd`认证文件。这是为了绕过密码验证。攻击者通过`socat` 在目标机器上安装程序和建立反向shell连接到攻击者的机器。
投毒风险评估为10%，因为代码本身是漏洞利用的POC，但可能包含并非必要的操作。例如，可以避免修改`/etc/passwd`文件。

**利用方式：**
1.  **触发漏洞：** 利用splice系统调用将受影响的文件（例如，SUID程序或认证配置文件）的页面缓存加载到pipe中，并在offset处注入恶意代码。
2.  **覆盖内容：** 使用write系统调用，通过Dirty Pipe漏洞覆盖pipe buffer中的内容，从而覆盖受影响文件中页面缓存中的内容。
3.  **权限提升：** 覆盖SUID程序或认证配置文件后，攻击者可以获得更高的权限。例如，覆盖SUID程序使其执行恶意代码，或者通过修改认证配置绕过密码验证。

此漏洞的利用依赖于利用splice和write之间的竞争条件来覆盖只读文件支持的页面缓存。


**项目地址:** [joeymeech/CVE-2022-0847-Exploit-Implementation](https://github.com/joeymeech/CVE-2022-0847-Exploit-Implementation)

**漏洞详情:** [CVE-2022-0847](https://nvd.nist.gov/vuln/detail/CVE-2022-0847)