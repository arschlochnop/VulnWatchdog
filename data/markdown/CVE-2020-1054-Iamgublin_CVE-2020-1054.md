## CVE-2020-1054 - Win32k 权限提升漏洞

**漏洞编号:** CVE-2020-1054

**漏洞类型:** 权限提升

**影响应用:** Microsoft Windows

**危害等级:** 高危，可导致本地权限提升

**影响版本:** Windows 7 SP1, Windows 8.1, Windows 10 (多个版本), Windows Server (多个版本)

**利用条件:** 本地访问

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2020-1054 是一个 Windows Win32k 组件中的权限提升漏洞。根据漏洞描述，该漏洞是由于 Windows 内核模式驱动程序未能正确处理内存中的对象而引起的。攻击者可以利用此漏洞在受影响的系统上以提升的权限运行代码。

**漏洞利用有效性：**

根据搜索结果和漏洞利用代码，此漏洞利用的有效性较高。漏洞库信息显示受影响的系统版本范围广泛，并且CISA的已知被利用漏洞目录中也包含此漏洞,这意味着该漏洞已经被广泛利用. 搜索结果中也提供了POC代码的链接，GitHub仓库（0xeb-bp/cve-2020-1054）提供了针对Windows 7 x64的利用程序，说明该漏洞存在可行的利用方法。提供的代码`ConsoleApplication4.cpp` 也印证了这一点。

**投毒风险分析：**

提供的C++代码本身是漏洞利用的尝试，因此具有一定的潜在风险。虽然代码目的是提升权限，但如果代码编写不当，可能会导致系统崩溃或其他不可预测的行为。此外，代码中包含一些内存操作，例如读取和写入内核内存，这些操作具有很高的风险，如果操作不正确，可能会破坏系统。

*   **风险点：**
    *   **缓冲区溢出：** 在`SetBitmapBits`和`GetBitmapBits`的使用中，如果长度计算错误或目标地址不可控，可能导致缓冲区溢出。
    *   **内核内存破坏：** 直接读写内核内存的操作可能导致系统不稳定甚至崩溃。
    *   **权限提升失败：** 虽然目标是提升权限，但如果利用过程出现任何错误，都可能导致利用失败，并可能留下痕迹。

*   **代码分析：**

    代码通过`DrawIconEx`相关的函数利用`Win32k`组件漏洞，实现在内核中任意地址读取和写入的能力。它首先泄露当前进程的EPROCESS地址，并查找SYSTEM进程的EPROCESS地址。然后，它会将当前进程的安全令牌替换为SYSTEM进程的安全令牌，从而获得SYSTEM权限。

    代码中存在`backup`和`recovery`函数，这表明作者可能在利用过程中修改了一些数据，并在利用完成后尝试恢复。然而，如果恢复过程失败，可能会导致系统状态不一致。

   **投毒代码可能性：** 代码中直接操作内核内存的部分具有潜在的风险，可能被用于植入恶意代码或进行其他恶意操作。代码作者可能利用这些操作在系统中安装后门或者进行其他未经授权的更改。虽然代码的主要功能是权限提升，但是不排除其中包含其他恶意代码的可能性，因此，投毒风险评估为10%。

**漏洞利用方式：**

该漏洞的利用方式主要包括以下步骤：

1.  **信息泄露：** 通过`gSharedInfo` 获取内核地址, 通过窗口句柄获取内核中窗口对象(WND)的地址。
2.  **寻找EPROCESS：**通过`WND`结构体找到当前进程的`EPROCESS`结构体地址，从中获得当前进程的安全令牌地址。
3.  **寻找SYSTEM EPROCESS：** 遍历进程链表，找到PID为4（SYSTEM进程）的`EPROCESS`结构体地址，从中获得SYSTEM进程的安全令牌地址。
4.  **权限提升：** 将当前进程的安全令牌替换为SYSTEM进程的安全令牌，从而提升当前进程的权限。

**项目地址:** [Iamgublin/CVE-2020-1054](https://github.com/Iamgublin/CVE-2020-1054)

**漏洞详情:** [CVE-2020-1054](https://nvd.nist.gov/vuln/detail/CVE-2020-1054)