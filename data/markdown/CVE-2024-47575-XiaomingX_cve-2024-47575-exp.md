## CVE-2024-47575 - FortiManager 未授权远程命令执行

**漏洞编号:** CVE-2024-47575

**漏洞类型:** 未授权远程命令执行

**影响应用:** FortiManager

**危害等级:** 高危，可导致完全控制受影响的FortiManager系统

**影响版本:** FortiManager 7.6.0, 7.4.0-7.4.4, 7.2.0-7.2.7, 7.0.0-7.0.12, 6.4.0-6.4.14, 6.2.0-6.2.12

**利用条件:** 目标FortiManager实例暴露在网络中，且541端口可访问

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2024-47575 是 FortiManager 中的一个关键漏洞，由于 `fgfmsd` 守护进程中缺少身份验证，未经身份验证的远程攻击者可以通过特制的请求执行任意代码或命令。该漏洞利用涉及模拟 FortiManager 设备注册到管理服务器的过程，攻击者可以使用未经授权的 FortiManager 设备来发起攻击。

**漏洞利用方式：**

1.  **建立SSL连接：**  使用预先准备好的证书和密钥（`w00t_cert.bin`, `w00t_key.bin`）与目标FortiManager建立SSL连接。
2.  **发送`get ip`请求：**  发送一个用于获取IP地址的请求，该请求包含设备的序列号、管理ID和平台信息。
3.  **发送`get auth`请求：**  发送一个身份验证请求，同样包含序列号和管理ID。
4.  **发送`get file_exchange`请求：**  发送文件交换请求，从中提取 `remoteid`，用于后续的通道建立。
5.  **漏洞检测：** 通过验证响应中是否包含 `remoteid` 来确定目标是否存在漏洞。
6.  **发送包含恶意命令的`channel`请求：**  构建包含要执行的命令的 `channel` 请求。该请求利用了`um/som/export`接口，将命令嵌入到 `file` 参数中，通过反向shell连接到攻击者的机器。

**投毒风险分析：**

POC代码本身主要功能是利用漏洞，但有潜在的投毒风险:

*   **证书和密钥文件：**  POC使用了 `w00t_cert.bin` 和 `w00t_key.bin` 证书和密钥文件。这些文件可能是硬编码的，如果攻击者修改了POC并替换为恶意证书/密钥，可能导致中间人攻击或其他安全问题。
*   **反向Shell：**  利用代码通过反向shell将受害者的机器连接到攻击者的机器，存在一定的后门风险。如果恶意攻击者共享或修改这个脚本，那么可能会在不知情的情况下被植入后门。
*   **依赖第三方库:** 漏洞利用依赖 `ssl` 库，如果攻击者修改了POC，可能会引入恶意的第三方库。
*   **`eval`/`exec`风险：** 虽然POC代码没有使用 `eval`/`exec` 函数，但是动态构造请求的行为增加了代码注入的风险。如果用于构造请求的参数（例如 `lhost` 和 `lport`）受到攻击者的控制，则攻击者可能注入任意代码。

考虑到以上风险，评估投毒风险约为 5%。


**项目地址:** [XiaomingX/cve-2024-47575-exp](https://github.com/XiaomingX/cve-2024-47575-exp)

**漏洞详情:** [CVE-2024-47575](https://nvd.nist.gov/vuln/detail/CVE-2024-47575)