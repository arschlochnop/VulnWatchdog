## CVE-2021-31956 Windows NTFS 提权漏洞

**漏洞编号:** CVE-2021-31956

**漏洞类型:** 权限提升

**影响应用:** Windows NTFS

**危害等级:** 高危，可导致本地权限提升

**影响版本:** 受影响的Windows版本请参考漏洞库信息

**利用条件:** 本地用户权限

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-31956 是一个 Windows NTFS 权限提升漏洞。根据漏洞信息，攻击者可以利用此漏洞在受影响的系统上提升权限。

**有效性：**
提供的POC代码看起来相当完整和复杂，并且附带了 `README.md` 说明其在 Windows 10 20H2 上相对稳定。代码中包含了解析符号、堆喷射、堆碎片、溢出块、读取池和写入池等步骤，表明它试图精确地控制内存布局以实现提权。搜索结果中`nccgroup.com`的博客文章证实了该漏洞的存在，并讨论了成功利用和清理内存所需的步骤。`arcticwolf.com`的报告也提到该漏洞被恶意利用工具包利用。

**投毒风险：**
查看POC代码，可以发现代码中存在一些可疑的地方，但很难确定是否是恶意的后门或仅仅是调试代码。以下是一些潜在的风险点：
* `createfilea()`路径需要修改为一个实际可写的目录，如果攻击者提供恶意路径可能导致拒绝服务。
* 代码中涉及大量的内存操作，例如堆喷射、堆碎片和内存读写，如果操作不当可能导致系统崩溃。虽然代码本身是漏洞利用，但如果经过修改，可能会包含恶意行为。

综合评估，投毒风险较低，约为10%。 仓库可能被用于传播包含漏洞利用程序的代码，这些代码可能被修改以包含额外的恶意功能。用户应谨慎使用这些代码，并在受控环境中进行测试。

**利用方式：**
该漏洞利用涉及以下主要步骤：
1.  **符号解析：** 使用 `resolve_symbols()` 函数解析所需的 Windows API 函数地址。
2.  **获取EPROCESS：** 使用 `get_eproc()` 函数获取当前进程的 EPROCESS 结构地址。
3.  **堆喷射：** 使用 `spray_heap()` 函数进行堆喷射，创建多个 WNF 状态名称对象。
4.  **堆碎片：** 使用 `fragment_heap()` 函数对堆进行碎片化，为后续的溢出创造条件。
5.  **溢出块：** 使用 `overflow_chunk()` 函数进行堆溢出，覆盖相邻的 WNF 状态数据。
6.  **读取池：** 使用 `read_pool()` 函数读取被覆盖的 WNF 状态数据，用于后续的修改。
7.  **查找WNF_NAME_INSTANCE：**  在读取的数据中查找 `WNF_NAME_INSTANCE` 结构，该结构用于后续的任意写操作。
8.  **修改StateData：**  将找到的 `WNF_NAME_INSTANCE` 结构的 `StateData` 成员修改为目标地址（例如线程列表头）。
9.  **写入池：** 使用 `write_pool()` 函数将修改后的 WNF 状态数据写回内存。
10. **利用NtQueryWnfStateData：**  触发 `NtQueryWnfStateData` 函数，利用被修改的 `StateData` 指针进行任意地址读取或写入。
11. **查找KTHREAD：** 在内存中搜索 _KTHREAD 结构，以便进行进一步的提权操作。
12. **修改KTHREAD->PreviousMode：** 通过计算偏移量，将找到的 _KTHREAD 结构的 PreviousMode 成员修改为 KernelMode，从而实现权限提升。

总的来说，这是一个典型的利用堆溢出漏洞进行权限提升的案例。攻击者通过精确控制堆内存的布局，利用 WNF 机制实现任意地址读写，最终修改进程的 PreviousMode 标志位，从而获得系统权限。

**项目地址:** [Y3A/CVE-2021-31956](https://github.com/Y3A/CVE-2021-31956)

**漏洞详情:** [CVE-2021-31956](https://nvd.nist.gov/vuln/detail/CVE-2021-31956)