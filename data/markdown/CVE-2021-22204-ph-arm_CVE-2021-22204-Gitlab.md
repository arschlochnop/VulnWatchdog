## CVE-2021-22204-ExifTool-RCE

**漏洞编号:** CVE-2021-22204

**漏洞类型:** 远程代码执行

**影响应用:** ExifTool

**危害等级:** 高危，可能导致服务器被完全控制

**影响版本:** >=7.44, <12.24

**利用条件:** 目标系统安装了受影响版本的ExifTool，并且能够上传DjVu格式的图片

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-22204是ExifTool中DjVu文件解析模块的远程代码执行漏洞。该漏洞源于ExifTool在处理DjVu文件时，未能正确地过滤用户输入，导致攻击者可以在DjVu文件中嵌入恶意的Perl代码，当ExifTool解析该文件时，恶意代码会被执行，从而实现远程代码执行。该POC利用了`djvumake`工具生成包含恶意代码的DjVu文件，然后上传该文件触发漏洞。虽然POC中包含了从目标服务器获取CSRF Token的步骤，但是在实际利用中，如果ExifTool在未授权的情况下处理上传的文件，则攻击者无需进行身份验证即可触发漏洞。在投毒分析方面，代码尝试创建`/tmp/exploit`和`/tmp/exploit.jpg`文件，如果攻击者能够控制这些文件的内容，则可能可以实现进一步的攻击。例如，替换`/tmp/exploit`文件为包含恶意代码的文件，并在后续步骤中执行该文件。该风险较低，因为需要依赖用户已经下载并执行恶意文件。

**漏洞利用有效性：**
根据漏洞信息，利用代码和搜索引擎信息，可以判断该POC代码是有效的。漏洞库信息明确指出该漏洞的存在和影响版本，利用代码也提供了详细的利用方法。该漏洞被CISA添加到已知被利用漏洞目录中，证明该漏洞在野外已经被利用。

**漏洞利用方式：**
1.  **漏洞触发点：** DjVu文件解析模块。
2.  **攻击向量：** 上传包含恶意代码的DjVu文件。
3.  **利用步骤：**
    a.  生成包含恶意Perl代码的DjVu文件。利用`djvumake`工具，将恶意代码嵌入到DjVu文件的ANTa区域。
    b.  上传恶意DjVu文件。通过GitLab的文件上传功能，将生成的DjVu文件上传到服务器。
    c.  触发漏洞。当ExifTool解析上传的DjVu文件时，嵌入的恶意Perl代码会被执行，从而实现远程代码执行。

**投毒风险分析：**
该POC代码的主要功能是生成包含恶意代码的DjVu文件，并上传该文件。但是，在生成DjVu文件的过程中，可能会存在投毒风险。攻击者可能会在生成的DjVu文件中嵌入额外的恶意代码，或者在上传文件的过程中，篡改上传的文件内容。此外，该POC代码还使用了`os.system`函数执行系统命令，如果攻击者能够控制该函数执行的命令，则可能会实现进一步的攻击。

**风险评估：** 漏洞风险等级高，需要尽快修复。

**项目地址:** [ph-arm/CVE-2021-22204-Gitlab](https://github.com/ph-arm/CVE-2021-22204-Gitlab)

**漏洞详情:** [CVE-2021-22204](https://nvd.nist.gov/vuln/detail/CVE-2021-22204)