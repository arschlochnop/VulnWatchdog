## CVE-2017-5638 - Apache Struts2 远程代码执行

**漏洞编号:** CVE-2017-5638

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Apache Struts2

**危害等级:** 高危，可能导致服务器被完全控制

**影响版本:** 2.3.x (before 2.3.32) 和 2.5.x (before 2.5.10.1)

**利用条件:** 目标服务器运行存在漏洞版本的Apache Struts2，且允许POST请求。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2017-5638 漏洞是 Apache Struts2 框架中的一个远程代码执行漏洞。该漏洞源于 Jakarta Multipart parser 在处理文件上传请求时，由于错误处理和错误消息生成不当，导致攻击者可以通过构造恶意的 Content-Type, Content-Disposition, 或 Content-Length HTTP 头来执行任意命令。根据提供的漏洞库信息，漏洞的利用方式是通过在Content-Type头中包含 '#cmd=' 字符串来执行命令，并根据搜索结果确认该漏洞已被广泛利用。

**有效性：**
提供的`exploit.py`脚本通过构造包含OGNL表达式的Content-Type头来实现远程代码执行。该表达式利用OGNL绕过安全限制，执行指定的命令并将结果返回。该PoC代码的逻辑是正确的，并且与漏洞描述相符，因此有效。

**投毒风险：**
审查提供的 Dockerfile 和脚本，可以发现潜在的投毒风险。
*   `server-setup-script.sh`: 该脚本从华为云镜像下载了JDK 8u171，但是考虑到华为云镜像可能已经发生了变更（被投毒），因此存在一定的风险。此外，该脚本中没有检查下载的JDK的完整性，如果下载过程中被篡改，可能导致系统被植入后门。`pwn-page.jsp` 在服务器遭受攻击后会部署该页面。
* `exploit.py`，该脚本本身没有包含明显的恶意代码，但如果被攻击者修改，例如在执行命令之前添加下载和执行恶意文件的功能，也可能成为投毒的途径。`startup.sh` 这个脚本仅仅是用来启动 tomcat 服务。并且Dockerfile 最终启动的命令是 `CMD ["sh", "-c", "./startup.sh && bash"]`， 该命令会启动一个交互式的shell。

因此，综合评估投毒风险大约为10%。虽然没有发现直接的、明显的投毒代码，但是下载的外部资源以及执行流程存在被利用的潜在风险，需要谨慎对待。

**利用方式：**
1.  攻击者发送一个精心构造的HTTP POST请求到存在漏洞的Struts2服务器。
2.  该请求的Content-Type头包含一个恶意的OGNL表达式，该表达式利用Struts2的OGNL解析器执行任意命令。
3.  服务器执行该命令，并将结果返回给攻击者。

**总结：**
CVE-2017-5638 是一个严重的安全漏洞，利用简单，危害巨大。建议受影响的用户尽快升级到安全版本。

**项目地址:** [Xernary/CVE-2017-5638-POC](https://github.com/Xernary/CVE-2017-5638-POC)

**漏洞详情:** [CVE-2017-5638](https://nvd.nist.gov/vuln/detail/CVE-2017-5638)