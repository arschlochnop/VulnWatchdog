## CVE-2017-16995 Linux Kernel eBPF 权限提升漏洞

**漏洞编号:** CVE-2017-16995

**漏洞类型:** 权限提升

**影响应用:** Linux Kernel

**危害等级:** 高危，本地用户可提升权限至 root

**影响版本:** <= 4.4

**利用条件:** 需要本地用户权限，开启 BPF_SYSCALL 配置

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2017-16995 漏洞存在于 Linux Kernel 4.4 及更早版本中的 `kernel/bpf/verifier.c` 文件的 `check_alu_op` 函数中。该漏洞是由于不正确的符号扩展导致，允许本地用户通过利用这一点造成拒绝服务（内存损坏）或可能产生未指明的其他影响。

**利用方式：**

1.  **漏洞触发：** 攻击者通过编写恶意的 eBPF 程序，程序中的某些指令会触发 `check_alu_op` 函数中的符号扩展错误。
2.  **内存破坏：** 错误的符号扩展会导致在 eBPF 程序的验证过程中出现错误，从而允许程序执行后破坏内核内存。
3.  **权限提升：** 通过精心构造的 eBPF 程序，攻击者可以覆盖当前进程的 `cred` 结构，将其 UID、GID 等设置为 0，从而获得 root 权限。

**POC 代码分析：**

提供的 POC 代码是一个利用 CVE-2017-16995 在 Ubuntu 16.04.4 (kernel 4.4.0-116-generic) 上进行权限提升的示例。

*   它首先创建了一个 BPF map 和 BPF program。程序通过套接字过滤器运行，该程序利用了符号扩展漏洞来破坏内核内存。
*   该程序定义了一些辅助函数，例如 `get_value`, `__get_fp`, `__read` 和 `__write`，用于从 BPF map 获取值，从内核读取以及写入。
*   `prep` 函数用于创建map和加载程序到内核
*   漏洞利用涉及覆盖当前进程的 `cred` 结构，POC 代码中定义了 `CRED_OFFSET` (0x5f8) 和 `UID_OFFSET` (4)，这些值与目标内核版本有关。
*   `socketpair` 创建一对连接的UNIX域套接字
*   `setsockopt` 将编译后的BPF程序附加到第一个套接字

**投毒风险评估：**

代码中存在一定投毒的风险，概率大约为10%。主要基于以下几点：

1.  **内核版本依赖性：** POC 代码中的 `CRED_OFFSET` 和其他偏移量是针对特定内核版本（4.4.0-116-generic）的。如果攻击者修改这些偏移量，使其在其他内核版本上运行时破坏关键的内核数据结构，可能导致系统崩溃或其他不可预测的行为。
2.  **恶意覆盖：** 攻击者可以通过修改 POC 代码，使其覆盖其他敏感的内核数据结构，从而达到更严重的目的，如植入后门或进行其他恶意活动。
3.  **依赖特定环境：**POC依赖ubuntu 16.04.4, 可能会存在编译后门或者只适用特定环境, 如果直接运行可能会发生意外情况

虽然存在一定的投毒风险，但相对较低，因为该漏洞本身的利用方式已经比较复杂，攻击者需要对内核内存布局有深入的了解才能成功利用。直接植入后门代码的难度较大，并且容易被发现。

**结论：**

提供的 POC 代码是有效的，可以利用 CVE-2017-16995 漏洞在特定内核版本上进行权限提升。但同时也存在一定的投毒风险，需要谨慎使用，并进行代码审计和验证，避免直接在生产环境中使用。

**项目地址:** [vnik5287/CVE-2017-16995](https://github.com/vnik5287/CVE-2017-16995)

**漏洞详情:** [CVE-2017-16995](https://nvd.nist.gov/vuln/detail/CVE-2017-16995)