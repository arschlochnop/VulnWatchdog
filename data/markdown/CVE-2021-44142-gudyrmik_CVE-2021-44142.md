## CVE-2021-44142-Samba-vfs_fruit-堆溢出

**漏洞编号:** CVE-2021-44142

**漏洞类型:** 堆溢出（Out-of-bounds Read/Write）

**影响应用:** Samba vfs_fruit

**危害等级:** 高危，允许远程攻击者以smbd（通常是root）权限执行任意代码

**影响版本:** < 4.13.17, < 4.14.12, < 4.15.5

**利用条件:** 需要目标Samba服务器配置了vfs_fruit模块，并且攻击者需要具有对文件扩展属性的写入权限

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-44142 是 Samba vfs_fruit 模块中的一个堆溢出漏洞。该模块使用扩展文件属性（EA，xattr）来提供与 Apple SMB 客户端的增强兼容性。漏洞存在于处理特定构造的扩展文件属性时，允许远程攻击者利用该漏洞。攻击者需要对文件扩展属性具有写入权限。通过精心构造恶意的扩展文件属性，攻击者可以触发堆溢出，进而以 smbd 进程（通常以 root 权限运行）的身份执行任意代码。

提供的漏洞利用代码包含Dockerfile，用于构建存在漏洞的Samba环境，以及一个Jupyter Notebook（cve-2021-44142-poc.ipynb），其中包含利用漏洞的概念验证代码。Dockerfile安装了一个老版本存在漏洞的Samba(samba-4.5.16)，并配置了smb.conf启用了`vfs_fruit`，并允许guest账户访问`TimeMachineBackup`共享目录。这创造了漏洞可利用的环境。

Jupyter Notebook定义了AppleDouble文件的结构,可能通过构造恶意的AppleDouble文件内容，来触发堆溢出。

**利用方式：**

1.  攻击者首先需要能够访问启用了 `vfs_fruit` 的 Samba 共享，并且具有写入扩展属性的权限（通常可以通过配置允许）。
2.  攻击者构造一个包含恶意数据结构的扩展文件属性（可能涉及AppleDouble文件格式）。
3.  当 Samba 服务器尝试处理这个恶意的扩展文件属性时，`vfs_fruit` 模块中的漏洞会被触发，导致堆溢出。
4.  攻击者利用堆溢出覆盖内存，最终执行任意代码。由于 `smbd` 进程通常以 root 权限运行，攻击者也可以获得 root 权限。

**投毒风险分析:**

该代码库的主要目的是复现和验证 CVE-2021-44142 漏洞，因此包含恶意代码的可能性较低。但仍然存在一些风险：

*   **Dockerfile 修改：** 攻击者可能会修改 Dockerfile，添加额外的后门或恶意软件。例如，在构建过程中安装其他软件包或修改 Samba 的配置。
*   **漏洞利用代码修改：** 攻击者可能会修改 Jupyter Notebook 中的漏洞利用代码，使其在成功利用漏洞后执行额外的恶意操作。

因为此项目的主要目的是漏洞利用，存在修改Dockerfile，或者EXP执行恶意操作的可能性，因此判断投毒风险为10%。该数字并非绝对，是根据代码用途和可能的修改点做出的判断。

**项目地址:** [gudyrmik/CVE-2021-44142](https://github.com/gudyrmik/CVE-2021-44142)

**漏洞详情:** [CVE-2021-44142](https://nvd.nist.gov/vuln/detail/CVE-2021-44142)