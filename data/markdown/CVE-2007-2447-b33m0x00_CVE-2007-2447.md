## CVE-2007-2447-Samba-远程命令注入

**漏洞编号:** CVE-2007-2447

**漏洞类型:** 远程命令注入

**影响应用:** Samba

**危害等级:** 高危，可能导致远程代码执行

**影响版本:** 3.0.0 - 3.0.25rc3

**利用条件:** 目标Samba服务器运行在受影响版本，并且启用username map script (smb.conf)配置或存在可利用的MS-RPC功能。

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2007-2447 存在于 Samba 3.0.0 到 3.0.25rc3 版本中。该漏洞是由于 smbd 中的 MS-RPC 功能允许远程攻击者通过 shell 元字符执行任意命令。漏洞利用主要通过以下几种方式实现：

1.  **SamrChangePassword 函数和 username map script:** 当 `smb.conf` 文件中启用 "username map script" 选项时，攻击者可以通过 `SamrChangePassword` 函数注入包含 shell 元字符的用户名，从而执行任意命令。
2.  **其他 MS-RPC 函数:** 远程身份验证用户可以通过其他 MS-RPC 函数（如远程打印机和文件共享管理）中的 shell 元字符执行命令。

提供的 POC 代码 `main.py`  使用 `argparse` 解析命令行参数，包括远程主机地址 (`rhost`)、远程端口 (`rport`)、本地主机地址 (`lhost`) 和本地端口 (`lport`)。`CVE` 类定义了漏洞利用的核心逻辑，它创建一个反向 shell 的 payload，并将其嵌入到 SMB 连接的用户名中。`exploit` 方法尝试使用包含恶意用户名的 SMB 连接到目标主机。漏洞利用依赖于Samba服务器处理用户名时未正确转义shell元字符。

**有效性:**

根据漏洞描述和提供的代码，该POC代码利用了Samba用户名处理中的命令注入漏洞，如果目标系统满足漏洞利用的条件（存在漏洞版本，开启 username map script 或存在其他 MS-RPC 可利用点），则POC是有效的。

**投毒风险分析:**

检查代码后，发现`src/cve.py`文件中的payload存在风险。虽然主要的目的是创建一个反向shell，但是如果攻击者的`lhost`或者`lport`被替换为恶意服务器,例如收集目标服务器的信息或者执行其他恶意操作，就存在投毒的可能。

投毒的可能性评估为5%。主要是考虑到反向shell本身就需要指定IP和端口，更容易被使用者注意到。


**项目地址:** [b33m0x00/CVE-2007-2447](https://github.com/b33m0x00/CVE-2007-2447)

**漏洞详情:** [CVE-2007-2447](https://nvd.nist.gov/vuln/detail/CVE-2007-2447)