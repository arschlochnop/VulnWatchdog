## CVE-2024-21626-runc容器逃逸

**漏洞编号:** CVE-2024-21626

**漏洞类型:** 容器逃逸

**影响应用:** runc

**危害等级:** 高危，可导致容器逃逸，获取宿主机权限

**影响版本:** < 1.1.12

**利用条件:** 需要存在漏洞版本的runc环境，以及执行容器的权限

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-21626 是 runc 中的一个文件描述符泄漏漏洞。攻击者可以利用该漏洞使新生成的容器进程（来自 runc exec）在宿主机文件系统命名空间中拥有一个工作目录，从而允许通过访问宿主机文件系统进行容器逃逸。恶意镜像也可以使用相同的攻击，允许容器进程通过 runc run 获得对宿主机文件系统的访问权限。该漏洞的利用方式主要依赖于 runc 在处理 cgroup 时未正确关闭文件描述符，导致文件描述符泄漏。攻击者通过控制容器的 cwd (current working directory) 到 /proc/self/fd/7 这样的路径，使得容器内的进程可以访问到宿主机的文件系统。

**有效性评估：**

根据漏洞库信息、搜索引擎结果和提供的POC代码，可以判断此POC代码是有效的。搜索引擎结果中多个链接（如NVD、RedHat、Wiz.io、WithSecure、Snyk.io、nitroc.org）均确认了漏洞的存在以及通过文件描述符泄漏实现容器逃逸的可能性。POC代码 `poc-autoplay.sh` 脚本模拟了攻击流程，通过修改 `config.json` 文件，将容器的工作目录设置为宿主机上的文件描述符，从而实现逃逸。`README.md` 中也详细描述了漏洞原理和利用方法。

**投毒风险分析：**

分析POC代码，投毒风险较低，但不能完全排除。理由如下：

*   `poc-autoplay.sh` 的主要功能是安装和配置 Docker 环境，以及运行包含漏洞利用的 runc 容器。其中涉及到的 `apt-get install` 命令存在潜在的投毒风险，例如，如果软件源被篡改，则可能安装恶意软件包。但脚本本身没有发现直接的恶意代码。
*   脚本会下载 Docker 的 GPG 密钥，并添加到受信任的密钥列表中。如果 GPG 密钥被恶意替换，则可能导致安装被篡改的 Docker 软件包。
*   脚本还尝试获取安装前后软件包列表,以尝试进行对比, 这也存在一定的风险,可能会执行恶意代码。
*   总体来说，该POC主要侧重于漏洞利用，而非恶意代码传播。但由于涉及到外部资源的下载和安装，依然存在一定的投毒风险，大概在10%。

**漏洞利用方式：**

1.  **文件描述符泄漏：** runc 在创建容器时，会打开一些宿主机上的文件，例如 cgroup 文件。由于疏忽，这些文件描述符没有被正确关闭，而是泄漏到了容器内部的进程中。
2.  **控制容器工作目录：** 攻击者通过修改 runc 的配置文件 `config.json`，将容器的工作目录设置为泄漏的文件描述符对应的路径（例如 `/proc/self/fd/7`）。
3.  **容器逃逸：** 容器内的进程通过工作目录访问宿主机文件系统，从而实现容器逃逸。

具体来说，利用过程如下：

*   准备一个存在漏洞的 runc 环境。
*   创建一个容器镜像。
*   修改 runc 的配置文件 `config.json`，将容器的工作目录设置为 `/proc/self/fd/7`。
*   运行容器，容器内的进程就可以访问宿主机的文件系统了。
*   `make install` 会执行poc-autoplay.sh脚本自动化完成上述过程，并对比poc前后安装的软件包列表
*   `make uninstall` 会删除测试文件以及卸载安装的docker

**项目地址:** [R4mbb/CVE-2024-21626](https://github.com/R4mbb/CVE-2024-21626)

**漏洞详情:** [CVE-2024-21626](https://nvd.nist.gov/vuln/detail/CVE-2024-21626)