## CVE-2024-10220-Kubelet-命令执行

**漏洞编号:** CVE-2024-10220

**漏洞类型:** 命令执行

**影响应用:** Kubelet

**危害等级:** 高危，可能导致节点接管

**影响版本:** <= 1.28.11, 1.29.0 <= version <= 1.29.6, 1.30.0 <= version <= 1.30.2

**利用条件:** 攻击者需要具有创建Pod和关联gitRepo volume的权限

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-10220 漏洞允许攻击者通过恶意构造的 gitRepo volume 在 Kubernetes kubelet 组件上执行任意命令。攻击者需要具有创建 pod 和关联 gitRepo volume 的权限。漏洞利用方式如下：

1.  **漏洞原理：** kubelet 在使用 gitRepo volume 时，会执行 git clone 操作。攻击者可以通过在 git 仓库的 hooks 目录中放置恶意脚本，例如 `post-checkout` 脚本，来实现命令执行。
2.  **POC 代码分析：** 提供的 POC 代码包含以下文件：
    *   `HEAD`, `README.md`, `config`, `logs/HEAD`, `logs/refs/heads/master`, `refs/heads/master`: 标准 Git 仓库文件。
    *   `hooks/post-checkout`:  这是一个 shell 脚本，会在 git checkout 后执行。该脚本的内容是将 "Hello from container" 写入 `/tmp/CVE-2024-10220-OUTPUT` 文件。这表明当 kubelet 克隆包含此 hook 的仓库时，将在 kubelet 运行的节点上执行该命令。
    *   `manifest/gitrepo.yaml`:  这是一个 Kubernetes Pod 定义文件，其中定义了一个使用 gitRepo volume 的 Pod。`repository` 指向包含恶意 hook 的 Git 仓库，`revision` 指定了要检出的分支，`directory` 指定clone到容器的目录，此目录需要包含`.git`目录. 
3.  **利用流程：**
    *   攻击者创建一个包含恶意 `post-checkout` hook 的 Git 仓库。
    *   攻击者创建一个 Pod，并在 Pod 的 volume 中使用 gitRepo，指向攻击者创建的 Git 仓库。
    *   当 kubelet 创建 Pod 时，会克隆 Git 仓库。由于仓库中包含 `post-checkout` hook，kubelet 会执行该 hook 中的命令，从而在节点上执行任意代码。
4.  **有效性：** 根据漏洞描述和 POC 代码分析，可以判断该 POC 代码是有效的。它展示了如何通过 gitRepo volume 和恶意 hook 在 Kubernetes 节点上执行任意命令。
5. **投毒风险：** 仓库本身的文件内容没有明显的恶意行为。然而，`hooks/post-checkout` 的目的就是为了执行命令，虽然示例是写入文件，但可以修改为任何恶意操作。由于脚本本身就具有执行命令的能力，将其定义为投毒具有一定的主观性。但从利用的角度看，目前写入文件的行为是为了验证漏洞的存在，而不是为了投毒。作者后期可以修改为投毒脚本，存在潜在风险，暂且将其标记为10%的投毒风险.风险在于使用者不仔细检查脚本内容，直接应用到生产环境，存在潜在风险。

**项目地址:** [mochizuki875/CVE-2024-10220-githooks](https://github.com/mochizuki875/CVE-2024-10220-githooks)

**漏洞详情:** [CVE-2024-10220](https://nvd.nist.gov/vuln/detail/CVE-2024-10220)