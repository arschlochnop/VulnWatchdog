## CVE-2017-7269 Microsoft IIS WebDav ScStoragePathFromUrl Overflow

**漏洞编号:** CVE-2017-7269

**漏洞类型:** 缓冲区溢出

**影响应用:** Microsoft IIS 6.0

**危害等级:** 高危，可导致远程代码执行

**影响版本:** 6.0 (Windows Server 2003 R2)

**利用条件:** 目标服务器运行Windows Server 2003 R2，且IIS 6.0的WebDAV服务开启。

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2017-7269是Microsoft IIS 6.0 WebDAV服务中ScStoragePathFromUrl函数存在的一个缓冲区溢出漏洞。攻击者可以通过发送一个特制的PROPFIND请求，其中包含一个以 "If: <http://" 开头的超长header，来触发该漏洞。这个长header导致ScStoragePathFromUrl函数在处理URL时发生缓冲区溢出，从而允许攻击者执行任意代码。

**有效性评估：**

根据提供的漏洞信息、搜索结果和漏洞利用代码，可以判断该漏洞利用是有效的。漏洞库信息和搜索结果都确认了该漏洞的存在，并且已经被公开利用。提供的漏洞利用代码（Metasploit模块的Ruby代码）是一个可用的POC，可以用于验证和利用该漏洞。

**投毒风险评估：**

根据提供的代码片段，初步评估投毒风险较低，约为5%。该代码看起来是Metasploit模块的修改版本，主要修复了原始模块在某些情况下无法正常工作的问题，并添加了`PhysicalPathLength`和`HttpHost`两个选项，增加了漏洞利用的灵活性，以适应不同物理路径长度和主机绑定的情况。

代码中没有发现明显的恶意代码或后门，但仍需注意以下几点：

*   **EncoderType**设置的是`Msf::Encoder::Type::AlphanumUnicodeMixed`，这意味着payload会被编码成Unicode，可能会增加分析难度。
*   **EncoderOptions**中设置了`BufferRegister`为`ESI`，这指定了payload存储的寄存器，可能会影响漏洞利用的稳定性。
*  **PrependMigrateProc** 设置为`calc`, 这只是为了测试, 实际利用中需要更改.

**利用方式分析：**

1.  攻击者构造一个恶意的PROPFIND请求，并在请求头中包含一个以 "If: <http://" 开头的超长header。
2.  长header的长度超过ScStoragePathFromUrl函数的缓冲区大小，导致缓冲区溢出。
3.  溢出数据覆盖了关键的内存区域，包括返回地址等。
4.  攻击者通过控制溢出数据，将返回地址指向恶意代码（payload）的地址。
5.  当ScStoragePathFromUrl函数返回时，程序执行流程跳转到payload，从而执行攻击者预先设定的恶意代码，实现远程代码执行。
6. 通过设置`PhysicalPathLength`和`HttpHost`可以精确定位目标环境，提升利用成功率。

**总结：**

CVE-2017-7269是一个高危的远程代码执行漏洞，由于存在公开可用的POC，并且该漏洞已经被广泛利用，因此需要及时修复。评估的POC代码本身投毒风险较低，主要是在原有的POC基础上进行功能增强和适配性改进。但应加强安全审计。

**项目地址:** [zcgonvh/cve-2017-7269](https://github.com/zcgonvh/cve-2017-7269)

**漏洞详情:** [CVE-2017-7269](https://nvd.nist.gov/vuln/detail/CVE-2017-7269)