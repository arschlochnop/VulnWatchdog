## CVE-2020-0796 (SMBGhost)

**漏洞编号:** CVE-2020-0796

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Microsoft Windows SMBv3

**危害等级:** 高危，可能导致远程代码执行和系统崩溃

**影响版本:** Windows 10 Version 1903/1909, Windows Server, version 1903/1909 (Server Core installation)

**利用条件:** 目标系统必须启用SMBv3协议，且未安装相应的安全补丁。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2020-0796，又名SMBGhost，是一个存在于Microsoft Windows SMBv3协议处理特定请求方式中的远程代码执行漏洞。具体来说，漏洞存在于SMBv3压缩功能中，当客户端或服务器协商压缩功能时，可以通过发送特制的SMB数据包，利用`SMB2CompressionTransformHeader`中的`offset`字段的越界访问，导致缓冲区溢出，最终可能导致远程代码执行。

**有效性分析：**
根据漏洞库信息、搜索结果和提供的PoC代码，可以判断此漏洞的利用是有效的。搜索结果中提到存在公开可用的PoC代码，并且CISA也发布了相关的警报。PoC代码本身也描述了如何利用错误的偏移量来触发缓冲区溢出并导致目标崩溃。

**投毒风险分析：**
检查提供的PoC代码，主要关注以下几个方面：

*   **依赖项：** 检查`requirements-test.txt`和`setup.py`中是否存在恶意的依赖项或安装脚本。目前看来，这些依赖项都是常规的测试库，没有发现可疑之处。
*   **代码逻辑：** 分析`CVE-2020-0796.py`的代码，确认其功能与描述一致，即通过构造恶意的SMB压缩数据包来触发漏洞。代码相对简单，主要是设置错误的offset值，没有发现明显的后门或恶意代码。
*   **其他文件：** `README.md`、`LICENSE`、`setup.cfg`等文件是常规的文档和配置文件，没有发现隐藏的恶意代码。

尽管代码本身看起来是直接利用漏洞的PoC，但仍需注意以下潜在的投毒风险：

*   **修改过的smbprotocol库:** PoC提到了修改了`smbprotocol`库，增加了SMB 3.1.1压缩/解压缩的支持。虽然作者声明只修改了`smbprotocol/connection.py`并添加了lznt1压缩算法，但是无法保证修改后的库没有引入其他潜在的漏洞或后门。这是一个潜在的风险点。如果使用了未经验证的`smbprotocol`库，可能存在被植入后门的风险。

综合分析，认为此仓库存在10%的投毒风险，主要集中在修改过的`smbprotocol`库中。如果使用此PoC，建议仔细审查修改过的`smbprotocol`库的代码，或者使用已知安全的`smbprotocol`库。

**漏洞利用方式：**

1.  攻击者首先需要与目标系统建立SMB连接。
2.  在SMB会话协商期间，客户端和服务器都需要包含`SMB2_COMPRESSION_CAPABILITIES`，表明双方都支持压缩功能。
3.  攻击者构造一个恶意的SMB数据包，其中包含`SMB2CompressionTransformHeader`。在该header中，将`offset`字段设置为一个非常大的值（例如4294967295）。
4.  当目标系统尝试解压缩该数据包时，由于`offset`字段过大，会导致缓冲区溢出，从而使系统崩溃甚至允许执行任意代码。

PoC中通过`_compress`函数来构造恶意的压缩数据包，并将`offset`设置为4294967295，从而触发漏洞。

**项目地址:** [eerykitty/CVE-2020-0796-PoC](https://github.com/eerykitty/CVE-2020-0796-PoC)

**漏洞详情:** [CVE-2020-0796](https://nvd.nist.gov/vuln/detail/CVE-2020-0796)