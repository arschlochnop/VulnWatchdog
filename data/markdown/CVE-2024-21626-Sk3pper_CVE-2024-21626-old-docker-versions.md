## CVE-2024-21626 - runc 容器逃逸漏洞

**漏洞编号:** CVE-2024-21626

**漏洞类型:** 容器逃逸

**影响应用:** runc

**危害等级:** 高危，可能导致完全的容器逃逸，控制宿主机

**影响版本:** < 1.1.12

**利用条件:** 需要运行受影响版本的runc，并且容器需要具有执行某些操作的权限（例如，使用`docker exec`或者运行恶意镜像）。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-21626 漏洞源于 runc 中的文件描述符泄露。攻击者可以利用此漏洞，通过泄露的文件描述符，使得新启动的容器进程（通过 `runc exec`）的工作目录位于宿主机的文件系统命名空间中，从而获得对宿主机文件系统的访问权限，实现容器逃逸。漏洞利用主要有以下几种方式：

1. **攻击方式1（恶意镜像）：** 恶意镜像可以利用此漏洞，使得容器进程获得对宿主机文件系统的访问权限。
2. **攻击方式2（runc exec）：** 通过 `runc exec` 启动的容器进程可能具有宿主机文件系统中的工作目录，允许逃逸。
3. **攻击方式3a和3b（覆盖宿主机二进制文件）：** 可以利用该漏洞覆盖半任意的宿主机二进制文件，从而完全控制宿主机。

**利用方式：**

根据提供的漏洞利用代码，利用方式是首先确定目标环境是否易受攻击，并找到正确的文件描述符。`checkVulnerability.sh` 脚本通过在一定范围内循环，使用 `docker run` 命令尝试不同的文件描述符，如果能够读取到宿主机的 `/etc/passwd` 文件，则说明该文件描述符泄露，并且目标环境易受攻击。找到正确的文件描述符后，就可以利用该文件描述符进行容器逃逸，例如读取宿主机上的敏感文件或覆盖宿主机上的二进制文件。

**投毒风险分析：**

尽管该仓库提供了利用 CVE-2024-21626 漏洞的 PoC 代码，但仍然存在一定的投毒风险。仓库中的 `checkVulnerability.sh` 脚本可能包含恶意代码，例如，在检测到漏洞存在时，自动执行某些恶意操作（例如，下载和执行恶意脚本），或者在不知情的情况下修改宿主机上的文件。该仓库还提供了一个修改后的Docker版本，该版本本身可能被篡改，使得可以后门进入宿主机。该投毒风险比例评定为10%。

**注意事项：**

在测试该漏洞时，务必在隔离的环境中进行，以防止恶意代码感染宿主机。

**项目地址:** [Sk3pper/CVE-2024-21626-old-docker-versions](https://github.com/Sk3pper/CVE-2024-21626-old-docker-versions)

**漏洞详情:** [CVE-2024-21626](https://nvd.nist.gov/vuln/detail/CVE-2024-21626)