## CVE-2017-16995 Linux Kernel BPF 权限提升漏洞

**漏洞编号:** CVE-2017-16995

**漏洞类型:** 权限提升

**影响应用:** Linux Kernel

**危害等级:** 高危，允许本地用户获取root权限

**影响版本:** through 4.4

**利用条件:** 需要本地用户权限，且开启了 BPF_SYSCALL 功能

**POC 可用性:** 是

**投毒风险:** 1%

## 详情

CVE-2017-16995 漏洞存在于Linux内核的BPF验证器(verifier.c)中，具体是`check_alu_op`函数中的符号扩展错误。该漏洞允许本地用户通过构造恶意的BPF程序，利用符号扩展漏洞绕过验证器的检查，从而导致内存损坏甚至权限提升。漏洞利用代码 `exploit-poc-pentest.c` 提供了一个利用该漏洞的PoC，该PoC通过加载恶意的BPF程序，覆写当前进程的 `cred` 结构体，从而将当前用户的UID、GID等权限信息修改为root用户的权限，实现权限提升。PoC代码中定义了`CRED_OFFSET`，需要根据不同的kernel版本进行调整。通过搜索结果 `https://www.exploit-db.com/exploits/45010` 以及 `https://github.com/senyuuri/cve-2017-16995` 确认存在可用的exploit。 

**漏洞利用方式：**

1.  构造恶意的BPF程序，该程序包含利用符号扩展错误的指令序列。
2.  通过`bpf_prog_load`系统调用将恶意的BPF程序加载到内核。
3.  创建socket，并使用`setsockopt`将BPF程序附加到socket上。
4.  向socket发送数据触发BPF程序执行，利用该漏洞覆写当前进程的`cred`结构体，修改用户ID为0（root用户）。
5.  执行`getuid()`等函数，确认权限是否提升。
6.  执行`/bin/sh`等命令，获取root shell。

**投毒风险分析：**

代码主要通过BPF机制进行提权，逻辑较为清晰，没有发现明显的恶意代码或后门。`CRED_OFFSET`需要根据目标kernel版本调整，如果偏移量设置不正确，可能导致程序崩溃或产生未知的副作用，但这不是投毒行为。因此，投毒风险较低，但是由于github的特殊性,依旧存在极低的风险, 所以评定投毒风险为1%。

**项目地址:** [gugronnier/CVE-2017-16995](https://github.com/gugronnier/CVE-2017-16995)

**漏洞详情:** [CVE-2017-16995](https://nvd.nist.gov/vuln/detail/CVE-2017-16995)