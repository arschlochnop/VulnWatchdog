## CVE-2023-51385-OpenSSH-命令注入

**漏洞编号:** CVE-2023-51385

**漏洞类型:** 命令注入

**影响应用:** OpenSSH

**危害等级:** 高危，可能导致远程代码执行

**影响版本:** < 9.6

**利用条件:** 需要目标系统使用OpenSSH，且受害者需要clone包含恶意submodule的Git仓库或连接到包含恶意用户名/主机名的SSH服务器

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2023-51385 存在于OpenSSH 9.6之前的版本中。该漏洞允许攻击者通过在用户名或主机名中注入shell元字符来执行任意操作系统命令。当 OpenSSH 在某些情况下扩展令牌时，如果用户名或主机名包含shell元字符，则可能发生OS命令注入。

**有效性：** 提供的POC代码显示了一种利用`ProxyCommand`配置项中`%h`和`%p`等令牌的方式，当这些令牌引用的主机名或用户名包含shell元字符时，可能导致命令注入。POC通过一个包含恶意子模块的Git仓库进行演示，攻击者可以诱使用户clone该仓库，从而触发漏洞。

**投毒风险：**  POC仓库本身的主要目的是演示漏洞，但存在一定投毒风险。  风险点在于Submodule的地址可被篡改，从而指向包含更恶意代码的仓库。Readme中包含执行`git clone`的命令，引导用户执行恶意操作。虽然当前POC只是弹出一个计算器，但攻击者可以替换Submodule指向的仓库，加入其他恶意代码，例如植入后门、窃取信息等。风险评估为10%，主要考虑因素是POC的主要目的是演示漏洞，并非大规模恶意攻击，但存在被二次利用的风险。  

**利用方式：**

1.  **恶意Git仓库：** 攻击者创建一个包含恶意子模块的Git仓库。子模块的URL包含带有shell元字符的用户名或主机名。
2.  **诱导受害者：** 攻击者诱导受害者克隆该Git仓库，可以使用`git clone --recurse-submodules`命令。
3.  **触发漏洞：** 当git clone子模块时，OpenSSH会解析`.ssh/config` 文件，如果文件中存在`ProxyCommand`等配置项，并且使用了受影响的令牌（如 `%h`、`%p`），则会导致命令注入。
4.  **命令执行：** 注入的shell元字符会被执行，从而允许攻击者在受害者系统上执行任意命令。 

**缓解措施：**
*   升级到OpenSSH 9.6或更高版本。
*   避免在用户名或主机名中使用shell元字符。
*   仔细审查`.ssh/config`文件，特别是 `ProxyCommand` 配置项。
*   谨慎克隆来自不可信来源的Git仓库。

**项目地址:** [vin01/poc-proxycommand-vulnerable](https://github.com/vin01/poc-proxycommand-vulnerable)

**漏洞详情:** [CVE-2023-51385](https://nvd.nist.gov/vuln/detail/CVE-2023-51385)