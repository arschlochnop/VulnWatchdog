## CVE-2024-36401-GeoServer-远程代码执行

**漏洞编号:** CVE-2024-36401

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** GeoServer

**危害等级:** 高危，未经身份验证的攻击者可以通过精心构造的输入来执行任意代码。

**影响版本:** 受影响版本包括 2.22.6 之前的所有版本，以及 2.23.0 到 2.23.6，2.24.0 到 2.24.4，以及 2.25.0 到 2.25.2。

**利用条件:** 需要目标GeoServer实例存在于网络上并且可以访问 /geoserver/wfs 接口。

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2024-36401 是 GeoServer 中的一个远程代码执行 (RCE) 漏洞，源于 GeoTools 库 API 对属性名称的处理不当。攻击者可以通过向 GeoServer 的 WFS 接口发送特制的 OGC 请求，利用 XPath 表达式注入来执行任意代码。此漏洞影响默认 GeoServer 安装，无需身份验证。

**漏洞分析：**

根据漏洞库信息和搜索引擎结果，该漏洞允许未经身份验证的攻击者通过 WFS GetFeature, WFS GetPropertyValue, WMS GetMap, WMS GetFeatureInfo, WMS GetLegendGraphic 和 WPS Execute 请求执行任意代码。漏洞原因是 GeoServer 使用的 GeoTools 库不安全地将属性/属性名称传递给 commons-jxpath 库，从而允许执行任意 XPath 表达式。

**POC 代码分析：**

提供的 POC 代码是一个 Python 脚本，用于检测和利用 CVE-2024-36401 漏洞。该脚本包含以下功能：

*   `check_vuln(url)`: 发送一个包含恶意 payload 的 WFS GetPropertyValue 请求到目标 GeoServer 实例，如果返回状态码为 400 并且响应内容包含 'ClassCastException'，则认为目标存在漏洞。
*   `exploit_vuln(url, cmd)`:  发送一个包含恶意 payload 的 WFS GetPropertyValue 请求，其中 payload 包含要执行的命令。该函数通过 `java.lang.Runtime.getRuntime()` 来执行命令。同样，如果返回状态码为 400 并且响应内容包含 'ClassCastException'，则认为利用成功。
*   `multithreading(url_list, pools=5)`:  使用线程池对 URL 列表执行漏洞检测。
*   `init_config()`:  解析命令行参数，包括目标 URL、URL 列表和要执行的命令。

**有效性：**

POC 代码通过构造恶意的 WFS GetPropertyValue 请求，利用 XPath 表达式注入来执行任意代码。从漏洞库信息和搜索引擎结果来看，该漏洞已被广泛确认和利用，并且POC代码的逻辑正确，所以判断提供的 POC 代码有效。

**投毒风险：**

分析 POC 代码后，没有发现明显的恶意代码或后门。POC 代码的功能是发送包含恶意 payload 的 HTTP 请求，从而利用漏洞执行命令。脚本中的 `exec(java.lang.Runtime.getRuntime(),"...")` 部分是利用漏洞的关键，但它本身并不是恶意代码，而是漏洞利用的一部分。作者将执行命令的权限交给了使用者,是否需要投毒取决于使用者。

**利用方式：**

1.  使用 `check_vuln(url)` 函数检测目标 GeoServer 实例是否存在漏洞。
2.  如果目标存在漏洞，使用 `exploit_vuln(url, cmd)` 函数执行任意命令。命令通过命令行参数 `-c` 传递。
3.  可以使用 `-f` 参数指定一个包含多个 URL 的文件，并使用 `multithreading(url_list,10)` 函数进行批量检测。

总的来说，该 POC 代码是有效的，并且没有发现投毒风险。它允许攻击者远程执行任意代码，对 GeoServer 实例构成严重威胁。

**项目地址:** [Niuwoo/CVE-2024-36401](https://github.com/Niuwoo/CVE-2024-36401)

**漏洞详情:** [CVE-2024-36401](https://nvd.nist.gov/vuln/detail/CVE-2024-36401)