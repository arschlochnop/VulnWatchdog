## CVE-2021-43798 - Grafana 目录遍历和密码解密

**漏洞编号:** CVE-2021-43798

**漏洞类型:** 目录遍历/密码解密

**影响应用:** Grafana

**危害等级:** 高危，允许任意文件读取和敏感信息泄露

**影响版本:** >= 8.0.0, < 8.0.7; >= 8.1.0, < 8.1.8; >= 8.2.0, < 8.2.7; = 8.3.0

**利用条件:** 需要Grafana实例运行在受影响版本，且攻击者能访问Grafana的web服务。

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2021-43798 是一个 Grafana 目录遍历漏洞，攻击者可以通过 `grafana_host_url/public/plugins/<plugin ID>/` 路径，利用目录遍历读取服务器上的任意文件。提供的漏洞利用代码包含一个Python脚本，该脚本用于解密Grafana数据库密码。Grafana使用AES加密数据源密码，密钥存储在 `defaults.ini` 或 `grafana.ini` 配置文件中。脚本通过用户提供的密钥解密密码。虽然主要功能是密码解密，但考虑到作者可能在代码中添加恶意功能，因此存在较低的投毒风险。风险主要来自于安装的 cryptography 依赖项被供应链污染。目录遍历允许攻击者读取敏感配置文件，例如包含数据库凭据的文件。密码解密脚本允许攻击者获取数据库密码，从而进一步提升攻击影响。

**漏洞利用方式：**

1.  **目录遍历：** 利用 `grafana_host_url/public/plugins/<plugin ID>/` 路径，通过构造恶意payload，读取服务器上的任意文件。
2.  **密码解密：** 获取Grafana配置文件中的 `secret_key`，运行提供的Python脚本，解密数据库密码。

**投毒风险分析：**

提供的代码主要涉及密码的加密和解密，风险点在于对 `cryptography` 库的依赖。如果该库被恶意篡改，则可能存在投毒风险。此外，作者可能在代码中添加隐藏的恶意逻辑。但总体来看，该代码的投毒风险相对较低。

*   该POC的主要作用是解密密码，而不是执行任意代码，因此不太可能存在严重的投毒行为。
*   对用户输入进行了简单的处理，没有发现明显的漏洞。
*   依赖的 `cryptography` 库有被供应链攻击的风险。

综上，判定投毒风险为 5%。

**项目地址:** [0xSAZZAD/Grafana-CVE-2021-43798](https://github.com/0xSAZZAD/Grafana-CVE-2021-43798)

**漏洞详情:** [CVE-2021-43798](https://nvd.nist.gov/vuln/detail/CVE-2021-43798)