## CVE-2022-22947 - Spring Cloud Gateway 代码注入

**漏洞编号:** CVE-2022-22947

**漏洞类型:** 代码注入

**影响应用:** Spring Cloud Gateway

**危害等级:** 严重，可能导致远程代码执行

**影响版本:** 3.1.x prior to 3.1.1+, 3.0.x prior to 3.0.7+

**利用条件:** Gateway Actuator endpoint 启用、暴露且未授权

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2022-22947 允许远程攻击者在受影响的 Spring Cloud Gateway 实例上执行任意代码。漏洞的根本原因是 Gateway Actuator 端点在未授权的情况下被启用和暴露，攻击者可以通过构造恶意请求，利用 SpEL 表达式注入来执行任意命令。

**有效性：**
根据漏洞库信息和搜索结果，该漏洞已确认存在，并且有可用的PoC代码。

**投毒风险：**
提供的PoC代码主要用于环境搭建和漏洞利用演示。其中包含通过git下载环境代码，以及手动搭建环境两种方式。仓库本身包含环境搭建教程、截图等信息，主要风险点在于：
*   **恶意环境代码替换：**如果攻击者替换了 GitHub 仓库中的环境代码，可能引入恶意代码。用户在按照教程搭建环境时，会执行这些恶意代码，从而导致投毒。
*   **教程误导：**教程可能包含误导性信息，引导用户执行危险操作。

因此，存在一定的投毒风险，但主要取决于用户下载环境代码的来源，以及是否仔细审查教程中的步骤。这里给出的投毒风险评估为10%。

**利用方式：**
1.  **前提条件：** 目标 Spring Cloud Gateway 实例启用了 Actuator 端点，且该端点可以未授权访问。
2.  **漏洞触发：** 攻击者构造包含恶意 SpEL 表达式的请求，通过以下两种方式之一注入 SpEL 表达式:
    *   **Filter：** 创建或修改路由定义，在 Filter 的 `args` 属性中插入恶意 SpEL 表达式。利用分析中提到的可绕过`name`校验的参数。
    *   **Predicates：**  创建或修改路由定义，在 Predicates 属性中插入恶意 SPEL 表达式。同样需要绕过name校验
3.  **代码执行：** Spring Cloud Gateway 在处理路由时，会解析 SpEL 表达式，导致任意代码执行。
4.  **命令执行：** 成功利用漏洞后，攻击者可以在服务器上执行任意命令。

**缓解措施：**
1.  升级 Spring Cloud Gateway 到 3.1.1+ 或 3.0.7+。
2.  禁用或保护 Gateway Actuator 端点。
3.  限制对 Actuator 端点的访问，仅允许授权用户访问。
4.  使用网络防火墙或 Web 应用程序防火墙 (WAF) 过滤恶意请求。


**项目地址:** [4nNns/CVE-2022-22947](https://github.com/4nNns/CVE-2022-22947)

**漏洞详情:** [CVE-2022-22947](https://nvd.nist.gov/vuln/detail/CVE-2022-22947)