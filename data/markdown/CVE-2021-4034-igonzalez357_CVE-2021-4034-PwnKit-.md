## CVE-2021-4034 (PwnKit) Polkit pkexec 本地提权漏洞

**漏洞编号:** CVE-2021-4034

**漏洞类型:** 本地提权

**影响应用:** Polkit pkexec

**危害等级:** 高危，可使普通用户获得 root 权限

**影响版本:** 受影响版本：所有版本

**利用条件:** 本地用户，目标系统安装了 polkit 且 pkexec 可执行文件存在。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-4034 (PwnKit) 是 polkit 包中 pkexec 工具的一个本地提权漏洞。

**有效性：**
提供的 POC 代码是有效的。漏洞描述表明，当 `pkexec` 在没有参数的情况下被调用时，它会尝试访问 `argv[1]`，但由于 `argc` 为 0，它会读取 `envp[0]`。通过精心构造环境变量，攻击者可以强制 `pkexec` 加载一个恶意的动态链接库，并在 root 权限下执行任意代码。

`cve-2021-4034.c` 代码通过将 `args` 设置为 `{NULL}` 并构造包含恶意环境变量的 `environ` 数组来触发此漏洞。`pwnkit.c` 是一个动态链接库，它包含将在 root 权限下执行的代码，即打开一个 shell。

**投毒风险：**

*   仓库中存在作者隐藏的投毒代码的可能性较低，初步判断为 10%。
*   `pwnkit.c` 会执行 `execve(args[0], args, envp);` 启动一个shell. 虽然`setuid(0);setgid(0);` 是提权操作，但这是漏洞利用本身的一部分，不是投毒代码。如果`pwnkit.c`包含恶意后门代码，例如反弹shell或添加后门用户，则可能是投毒。
*    `cve-2021-4034.c`的代码的功能是触发漏洞，本身不包含恶意代码。

**利用方式：**

1.  **编译 exploit 和恶意库：** 使用提供的 `gcc` 命令编译 `cve-2021-4034.c` 和 `pwnkit.c`。
2.  **创建 GCONV_PATH 目录：**  创建一个名为 `GCONV_PATH=.` 的目录。
3.  **创建 gconv-modules 文件：**  创建一个 `gconv-modules` 文件，包含指示系统加载恶意库的配置。
4.  **复制 true 命令到 GCONV_PATH：** 将 `true` 命令复制到 `GCONV_PATH`，并设置 `GCONV_PATH` 环境变量。
5.  **运行 exploit：**  执行编译后的 `cve-2021-4034` 程序。这将利用 pkexec 中的漏洞，加载 `pwnkit.so` 库，从而以 root 权限打开一个 shell。


**项目地址:** [igonzalez357/CVE-2021-4034-PwnKit-](https://github.com/igonzalez357/CVE-2021-4034-PwnKit-)

**漏洞详情:** [CVE-2021-4034](https://nvd.nist.gov/vuln/detail/CVE-2021-4034)