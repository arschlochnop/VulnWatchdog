## CVE-2021-3156-Sudo-Heap-Based缓冲区溢出

**漏洞编号:** CVE-2021-3156

**漏洞类型:** Heap-Based缓冲区溢出

**影响应用:** Sudo

**危害等级:** 高危，允许本地用户提升权限至root

**影响版本:** < 1.9.5p2

**利用条件:** 本地用户能够执行sudo

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2021-3156，又名Baron Samedit，是一个存在于Sudo 1.9.5p2之前版本中的堆缓冲区溢出漏洞。该漏洞允许任何本地用户通过`sudoedit -s`以及一个以单个反斜杠字符结尾的命令行参数来提升权限至root。

**有效性：**
根据漏洞库信息、搜索结果和提供的PoC代码，该漏洞是有效的。搜索结果中大量的文章和分析，例如Qualys的研究博客、NCC Group的分析文章，以及Red Hat的CVE描述，都证实了漏洞的存在和严重性。PoC代码的`README.md`文件也说明了其在Ubuntu 20.04上的测试成功，并且提供了验证漏洞存在的命令`sudoedit -s Y`。

**投毒风险：**
该仓库中存在投毒代码的可能性较低，约为5%。理由如下：
*   PoC代码的目的是演示漏洞利用，结构清晰，注释完善，易于理解。
*   代码逻辑主要集中在构造特定的命令行参数和环境变量，以触发堆缓冲区溢出，并覆盖`service_user`结构体，从而执行shellcode。
*   `shellcode.c`文件中的代码功能单一，即执行`setuid(0)`、`setgid(0)`和`execve("/bin/sh")`，目的是获取root shell。虽然这段shellcode可以被替换为恶意代码，但是原始shellcode本身并不是恶意的，而是漏洞利用的一部分。
*   `Makefile`文件只包含编译和清理的命令，没有发现可疑操作。
*   `Dockerfile`用于构建包含漏洞版本的Sudo的环境，方便漏洞测试，本身不包含恶意代码。
*   作者在`README.md`文件中明确声明了研究成果归Qualys Research Team所有，并提供了其博客链接，表明了其非恶意意图。

虽然shellcode存在被替换的可能性，但整个代码库的结构和说明都表明其主要目的是为了演示和验证漏洞，而非进行恶意攻击，因此投毒的概率较低。

**利用方式：**
1.  利用 `sudoedit -s` 命令。
2.  构造一个以单个反斜杠字符结尾的命令行参数（`buf`变量），触发off-by-one错误，导致堆缓冲区溢出。
3.  通过精心设计的环境变量（`LC_MESSAGES`、`LC_TELEPHONE`、`LC_MEASUREMENT`）进行堆排布，将目标`service_user`结构体安排在溢出区域附近。
4.  通过另一个环境变量（`overflow`）填充内存，并最终覆盖`service_user`结构体的`name`字段，将其修改为shellcode库的路径。
5.  Sudo在后续操作中会加载被覆盖的`name`字段指向的shellcode库，从而执行shellcode，提升权限至root。
6.  Shellcode执行`setuid(0)`、`setgid(0)`和`execve("/bin/sh")`，获得root shell。

**项目地址:** [CptGibbon/CVE-2021-3156](https://github.com/CptGibbon/CVE-2021-3156)

**漏洞详情:** [CVE-2021-3156](https://nvd.nist.gov/vuln/detail/CVE-2021-3156)