## CVE-2022-0847 - Dirty Pipe 本地权限提升

**漏洞编号:** CVE-2022-0847

**漏洞类型:** 本地权限提升

**影响应用:** Linux Kernel

**危害等级:** 高危，可导致完全控制系统

**影响版本:** 5.8 < 5.16.11, Linux Kernel 5.17 rc6

**利用条件:** 需要本地用户权限

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2022-0847 (Dirty Pipe) 是 Linux Kernel 中的一个漏洞，允许未经授权的本地用户覆盖只读文件中的数据，从而提升权限。漏洞原因是 pipe buffer 结构中的 'flags' 成员未正确初始化，导致在 copy_page_to_iter_pipe 和 push_pipe 函数中可能包含陈旧值。利用方式是：

1.  **准备管道：** 创建一个管道，并确保管道中的所有 buffer 都设置了 `PIPE_BUF_FLAG_CAN_MERGE` 标志。
2.  **泄漏标志：** 通过部分填充和耗尽管道来泄漏未初始化的标志。
3.  **打开目标文件：** 以只读方式打开目标文件。
4.  **创建管道：**再次创建一个管道，并使用泄漏的标志。
5.  **写入数据：** 通过管道将恶意数据写入到目标文件的页面缓存中。
6.  **覆盖文件内容：** 将页面缓存中的更改同步到磁盘，从而覆盖文件内容。

提供的 POC 代码通过覆盖 /tmp/sh 文件来提权。它首先创建一个小型的 ELF 文件，该文件设置 UID 和 GID 为 0，然后执行 /bin/sh。漏洞利用程序使用 Dirty Pipe 漏洞将这个 ELF 文件写入到 /tmp/sh，然后将 /tmp/sh 设置为 SUID 可执行文件。 成功利用后，普通用户即可执行 /tmp/sh 并获得 root 权限。

**有效性：** 搜索引擎结果和漏洞库信息都表明该漏洞已被积极利用，POC 代码也表明利用是可行的且可靠。

**投毒风险：** POC 代码包含预期的漏洞利用逻辑。但是，由于任何代码都可能被篡改，因此存在轻微的投毒风险。在这里，投毒风险被评估为 10%。风险主要在于编译后的二进制文件可能包含恶意代码，而不是源代码本身明显的缺陷。作者可能会在编译过程中引入后门。

**利用方式总结：**

1.  利用未初始化的 pipe buffer flags。
2.  结合管道操作实现任意文件覆盖。
3.  覆盖 SUID 可执行文件或其他敏感文件，从而提升权限。

**项目地址:** [pashayogi/DirtyPipe](https://github.com/pashayogi/DirtyPipe)

**漏洞详情:** [CVE-2022-0847](https://nvd.nist.gov/vuln/detail/CVE-2022-0847)