## CVE-2019-7164-SQLAlchemy-SQL注入

**漏洞编号:** CVE-2019-7164

**漏洞类型:** SQL注入

**影响应用:** SQLAlchemy

**危害等级:** 高危，可能导致数据泄露和远程代码执行

**影响版本:** <= 1.2.17 和 1.3.x <= 1.3.0b2

**利用条件:** 应用程序使用受影响的SQLAlchemy版本，且`order_by`参数可被用户控制

**POC 可用性:** 是

**投毒风险:** 20%

## 详情

CVE-2019-7164 是 SQLAlchemy 框架中的一个 SQL 注入漏洞，存在于 `order_by` 参数中。如果应用程序允许用户控制传递给 `order_by` 的值，攻击者可以构造恶意的 SQL 语句，从而执行任意 SQL 命令，导致数据泄露、篡改甚至远程代码执行。

**有效性分析：**

从提供的 Dockerfile 可以看出，该代码尝试构建一个包含漏洞的 MLflow 环境。Dockerfile 克隆了一个名为 `mlflow-clone` 的 git 仓库，并在其环境中安装了 SQLAlchemy。Dockerfile中 `cve-2019-7164-vuln` 这个分支名，表明该代码的目的是复现这个漏洞。`run_pentest_task.py` 脚本调用了 `hud-python eval` 命令，可能通过 hud-python 执行包含了 SQL 注入 payload 的任务，从而验证漏洞的存在。综合分析，提供的 POC 代码具有一定的有效性，可以用来验证 CVE-2019-7164 漏洞。

**投毒风险分析：**

虽然 POC 旨在演示 CVE-2019-7164，但仍然需要警惕潜在的投毒风险。代码中存在以下几点需要注意：

1.  **`mlflow-clone` 仓库：** 代码从 `https://github.com/stuxbench/mlflow-clone.git` 克隆了一个仓库。如果该仓库被恶意修改，可能包含其他漏洞或后门代码。需要检查仓库的提交历史，确认代码的安全性。
2.  **`hud-python`：** 代码使用了 `hud-python` 进行评估。`hud-python` 作为一个第三方库，其自身可能存在安全风险。需要审查其代码，确认其行为是否符合预期。
3.  **`tasks.json` 和 `single_task.json`：**  这些 JSON 文件可能包含恶意的 payload 或配置，从而触发漏洞或执行恶意代码。
4.  **`src/controller/server` and `src/controller/env`:** 这些代码为自定义代码，可能包含恶意逻辑。

尽管存在一定的风险，但代码的主要目的是复现已知的 SQL 注入漏洞。相对其他风险，投毒风险较低，估计为 20%。

**利用方式分析：**

1.  **`order_by` 参数：** 漏洞的核心在于 `order_by` 参数。攻击者需要找到应用程序中使用了 SQLAlchemy，并且 `order_by` 参数的值可被用户控制的地方。
2.  **SQL 注入 Payload：** 攻击者需要构造恶意的 SQL 注入 payload，并将其作为 `order_by` 的值传递给应用程序。
3.  **执行任意 SQL 命令：** 如果应用程序没有对 `order_by` 参数进行充分的过滤，攻击者就可以利用 SQL 注入漏洞，执行任意的 SQL 命令。这些命令可以用来读取、修改或删除数据库中的数据，甚至可以用来执行操作系统命令。

总而言之，此漏洞的利用方式是寻找应用程序中使用 SQLAlchemy 并允许用户控制 `order_by` 参数的地方，然后注入恶意 SQL 语句。

**项目地址:** [stuxbench/mlflow-cve-2019-7164](https://github.com/stuxbench/mlflow-cve-2019-7164)

**漏洞详情:** [CVE-2019-7164](https://nvd.nist.gov/vuln/detail/CVE-2019-7164)