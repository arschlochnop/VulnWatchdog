## CVE-2022-29464 - WSO2 任意文件上传导致远程代码执行

**漏洞编号:** CVE-2022-29464

**漏洞类型:** 任意文件上传

**影响应用:** WSO2 API Manager, Identity Server, Enterprise Integrator, Open Banking AM/KM

**危害等级:** 高危，可能导致远程代码执行和服务器完全控制

**影响版本:** WSO2 API Manager 2.2.0 up to 4.0.0, WSO2 Identity Server 5.2.0 up to 5.11.0, WSO2 Identity Server Analytics 5.4.0, 5.4.1, 5.5.0 and 5.6.0, WSO2 Identity Server as Key Manager 5.3.0 up to 5.11.0, WSO2 Enterprise Integrator 6.2.0 up to 6.6.0, WSO2 Open Banking AM 1.4.0 up to 2.0.0 and WSO2 Open Banking KM 1.4.0, up to 2.0.0

**利用条件:** 目标系统存在/fileupload接口且未进行严格的文件类型和路径校验

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2022-29464 是一个存在于多个 WSO2 产品中的严重漏洞，它允许未经授权的攻击者上传任意文件，从而导致远程代码执行。

**漏洞分析：**

该漏洞的根本原因是 WSO2 产品中的 `/fileupload` 接口没有对上传的文件进行充分的验证。攻击者可以利用目录遍历漏洞，通过在 `Content-Disposition` 头中构造恶意路径，将恶意文件上传到 Web 根目录下的可执行位置，例如 `../../../../repository/deployment/server/webapps`。

**利用方式：**

1.  攻击者首先需要确定目标系统存在漏洞，即存在 `/fileupload` 接口且允许上传文件。
2.  攻击者构造一个包含恶意代码的 JSP 文件（或其他服务器支持的脚本文件）。
3.  攻击者构造一个包含目录遍历序列的 HTTP POST 请求，将恶意 JSP 文件上传到目标服务器的 Web 根目录下的 `repository/deployment/server/webapps/authenticationendpoint/` 目录中。文件名可以自定义，但通常以 `.jsp` 结尾，如 ShellDef变量所示。
4.  攻击者通过访问上传的 JSP 文件，即可执行其中的恶意代码，从而获得对服务器的控制权。

**POC 代码分析：**

提供的 POC 代码是一个 Python 脚本，用于自动化利用 CVE-2022-29464 漏洞。

*   它首先定义了一个 `exploit` 函数，该函数负责构造包含恶意 JSP 代码的 HTTP POST 请求，并将该请求发送到目标服务器的 `/fileupload` 接口。
*   JSP 代码创建一个简单的 Web shell，允许攻击者通过 Web 界面执行任意系统命令。
*  脚本尝试上传一个名为`404.jsp`的文件用以验证漏洞.如果上传成功,则上传webshell到`/authenticationendpoint`目录下。
*  脚本还允许从外部文件读取webshell的内容并上传,增强了灵活性

**投毒风险评估：**

该 POC 代码本身**没有明显的投毒行为**。代码只是尝试上传 webshell，以便进行远程代码执行。恶意行为完全取决于攻击者上传的 JSP 文件中的内容。因此，该代码的投毒风险较低,可以认为是0。

**有效性：**

根据漏洞描述和 POC 代码的实现，以及搜索引擎返回的结果，该 POC 代码能够有效地利用 CVE-2022-29464 漏洞，实现任意文件上传和远程代码执行。


**项目地址:** [LinJacck/CVE-2022-29464](https://github.com/LinJacck/CVE-2022-29464)

**漏洞详情:** [CVE-2022-29464](https://nvd.nist.gov/vuln/detail/CVE-2022-29464)