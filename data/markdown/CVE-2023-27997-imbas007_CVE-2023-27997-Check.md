## CVE-2023-27997-FortiOS/FortiProxy SSL-VPN 堆溢出

**漏洞编号:** CVE-2023-27997

**漏洞类型:** 堆溢出

**影响应用:** FortiOS/FortiProxy

**危害等级:** 高危，可导致远程代码执行

**影响版本:** FortiOS: <= 7.2.4, <= 7.0.11, <= 6.4.12, <= 6.0.16; FortiProxy: <= 7.2.3, <= 7.0.9, <= 2.0.12, <= 1.2.13, <= 1.1.6

**利用条件:** 需要目标开启SSL-VPN服务，并且可以通过网络访问

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2023-27997 是 FortiOS 和 FortiProxy SSL-VPN 中的一个堆溢出漏洞。 

**有效性：**
根据漏洞库信息、搜索结果以及提供的漏洞利用代码，可以判定此漏洞利用的**有效性较高**。
1.  漏洞库信息中，CVSS 评分高达 9.2，属于严重漏洞，并且已经被CISA列入已知被利用漏洞目录。
2.  搜索引擎结果显示，BishopFox 等安全公司已经对该漏洞进行了深入分析，并提供了漏洞验证工具和利用代码，证明了该漏洞的可利用性。
3.  提供的 Python 脚本 `CVE-2023-27997.py` 就是一个漏洞检测工具，通过发送特殊构造的请求，利用统计学方法（t 检验）判断目标是否存在漏洞。 该脚本本身就是POC。

**投毒风险：**
分析提供的 `CVE-2023-27997.py` 脚本，发现投毒的可能性**较低，大约为5%**。
代码主要功能是发送恶意请求并分析响应时间。 该脚本的主要功能是检测目标系统是否存在漏洞，并没有发现明显的恶意代码或后门。风险点在于使用统计学方式判断漏洞是否存在，攻击者可以精心构造服务器响应，使得检测脚本误判，进而攻击实际上已修复的系统。代码中包含以下安全相关的考虑：
*   禁用了urllib3 的 InsecureRequestWarning，这降低了对自签名证书等问题的警告等级，可能隐藏潜在的中间人攻击风险。
*  `reject_outliers` 函数旨在消除延迟中的异常值，从而提高检测的准确性。 然而，如果攻击者能够持续操纵响应时间，使其始终位于过滤范围之内，则可能绕过检测机制。
*   使用 `ttest_ind` 进行统计分析以区分易受攻击和已修补的系统。但是，统计结果的可靠性取决于数据质量和样本大小，攻击者可能会尝试通过噪声数据或干扰来影响这些结果。

**利用方式：**
该漏洞是由于在处理 SSL-VPN 请求时，对用户提供的长度没有进行充分的验证，导致可以写入超出堆缓冲区限制的数据。攻击者可以通过发送特制的请求，触发堆溢出，从而执行任意代码。
1.  攻击者首先需要确定目标 FortiOS/FortiProxy 设备的 SSL-VPN 服务是否开启，以及是否可以从网络上访问。
2.  通过`/remote/info`接口获取salt值。
3.  构造一个包含恶意 payload 的 HTTP POST 请求发送到`/remote/hostcheck_validate`接口，`enc`参数中包含溢出数据。
4.  溢出数据覆盖堆上的其他数据结构，最终导致任意代码执行。

总而言之，这是一个高危漏洞，利用难度相对较低，需要及时修复。

**项目地址:** [imbas007/CVE-2023-27997-Check](https://github.com/imbas007/CVE-2023-27997-Check)

**漏洞详情:** [CVE-2023-27997](https://nvd.nist.gov/vuln/detail/CVE-2023-27997)