## CVE-2023-27997 - FortiOS SSL-VPN 堆溢出漏洞

**漏洞编号:** CVE-2023-27997

**漏洞类型:** 堆溢出

**影响应用:** FortiOS/FortiProxy

**危害等级:** 高危，远程代码执行

**影响版本:** FortiOS: 7.2.0-7.2.4, 7.0.0-7.0.11, 6.4.0-6.4.12, 6.2.0-6.2.14, 6.0.0-6.0.16; FortiProxy: 7.2.0-7.2.3, 7.0.0-7.0.9, 2.0.0-2.0.12, 1.2.0-1.2.13, 1.1.0-1.1.6

**利用条件:** 需要网络访问目标FortiGate设备的SSL-VPN端口 (443或10443) 

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2023-27997 是 FortiOS 和 FortiProxy SSL-VPN 中的一个堆溢出漏洞。攻击者可以通过构造特制的请求，在无需身份验证的情况下远程执行任意代码或命令。

**有效性评估：**

根据漏洞库信息和搜索结果，此漏洞已经被广泛研究和利用。BishopFox 等机构已经发布了相关的分析报告和漏洞检测工具。漏洞利用代码的存在进一步证实了其有效性。搜索引擎结果表明，该漏洞被积极利用，并且被CISA列入已知被利用的漏洞目录。

**投毒风险分析：**

提供的漏洞利用代码（README.md）描述了一个使用 ROP 链的 PoC 脚本。脚本本身的主要功能是利用漏洞执行 `ping` 命令，用于验证漏洞的存在。代码详细描述了如何获取 salt 值、生成 XOR 密钥流、构建 payload 以及 ROP 链。  虽然代码看起来相对直接，但仍然存在潜在的投毒风险：

1.  **隐蔽的后门植入：** 攻击者可能会在 ROP 链中插入恶意代码，例如下载和执行 shellcode，从而在目标系统上植入后门。虽然提供的代码只是 ping 命令，但实际利用中完全可以替换为更具破坏性的操作。
2.  **依赖项投毒：**  虽然 README 提到 `requests` 和 `urllib3` 库，如果实际的利用脚本依赖其他不常见的第三方库，这些库可能被投毒。
3.  **命令注入：** 如果目标环境对命令执行的输入过滤不严格，`ping` 命令本身可能被注入恶意参数。 尽管代码说明了适用于测试环境，依然存在风险。从代码的描述和目的来看，主要的目的是验证漏洞，而不是植入后门，因此投毒的概率较低。基于以上分析，投毒风险约为 10%。

**利用方式：**

1.  **发送 GET /remote/info 请求获取 salt 值。**
2.  **组合 salt 值和 seed 值，使用 MD5 算法生成 XOR 密钥流。**
3.  **构造包含 ROP 链的恶意 payload，利用 XOR 密钥流进行加密。**
4.  **将加密后的 payload 作为 enc 参数，发送到 /remote/hostcheck_validate 接口。**
5.  **触发堆溢出，执行 ROP 链，从而实现远程代码执行。**

攻击的关键在于通过堆溢出覆盖返回地址，然后使用 ROP 链执行恶意代码，例如运行 `system` 函数来执行任意命令。

**项目地址:** [onurkerembozkurt/fgt-cve-2023-27997-exploit](https://github.com/onurkerembozkurt/fgt-cve-2023-27997-exploit)

**漏洞详情:** [CVE-2023-27997](https://nvd.nist.gov/vuln/detail/CVE-2023-27997)