## CVE-2019-5736-runc容器逃逸

**漏洞编号:** CVE-2019-5736

**漏洞类型:** 容器逃逸

**影响应用:** runc/Docker

**危害等级:** 高危，可获取主机root权限

**影响版本:** <= 1.0-rc6 (runc), Docker < 18.09.2

**利用条件:** 需要能够以root身份在受影响的容器中执行命令 (创建新容器或docker exec到一个具有写权限的已存在容器)

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2019-5736漏洞允许攻击者通过覆盖宿主机的runc二进制文件来获取宿主机的root访问权限。攻击者需要在容器内部以root身份运行代码，通过文件描述符的处理不当，利用`/proc/self/exe`来修改宿主机上的runc二进制文件。之后，当宿主机需要通过runc创建或者管理容器时，将会执行被篡改过的runc二进制文件，从而导致攻击者在宿主机上执行任意代码。

**漏洞利用方式：**

1.  **Dockerfile准备：**  Dockerfile用于构建包含漏洞利用代码的镜像。它安装必要的编译工具，并添加利用程序 `stage1.c`, `stage2.c`和执行脚本`run.sh`。
2.  **stage1.c：**  这个C程序在容器启动时执行，主要目的是打开`/proc/self/exe`文件，获取runc二进制文件的文件描述符，然后执行`stage2`程序，并将文件描述符传递给它。
3.  **stage2.c：**  这个C程序接收`stage1.c`传递过来的文件描述符，然后尝试打开该文件描述符对应的文件（即宿主机的runc二进制文件），并写入恶意代码。恶意代码通常是一个反向shell，用于连接攻击者的服务器。
4.  **run.sh：**  这个脚本编译`stage1.c` 和`stage2.c`，然后修改`/bin/bash`的内容，使得每次运行bash实际上是执行`/proc/self/exe`，也就是宿主机的runc二进制文件。
5.  **容器运行和利用：**  首先，备份宿主机上的runc二进制文件。然后，在Docker容器中运行利用脚本。当Docker需要再次调用runc时，就会执行被篡改的runc，从而在宿主机上执行恶意代码。

**有效性：**
根据提供的漏洞信息和利用代码，此POC代码是有效的。它可以利用文件描述符的漏洞来覆盖宿主机上的runc二进制文件，从而实现容器逃逸。

**投毒风险：**
分析提供的POC代码，没有发现明显的投毒代码。提供的代码主要是用于利用CVE-2019-5736漏洞来获得宿主机的root权限。当然，利用成功后，恶意用户可以进一步植入后门或者执行其他恶意操作。因此，投毒风险评估为0%。代码目的明确，就是为了验证和利用该漏洞，没有其他隐藏的恶意行为。

**项目地址:** [agppp/cve-2019-5736-poc](https://github.com/agppp/cve-2019-5736-poc)

**漏洞详情:** [CVE-2019-5736](https://nvd.nist.gov/vuln/detail/CVE-2019-5736)