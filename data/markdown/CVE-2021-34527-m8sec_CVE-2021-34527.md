## CVE-2021-34527 - PrintNightmare Windows Print Spooler RCE

**漏洞编号:** CVE-2021-34527

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Windows Print Spooler

**危害等级:** 高危，攻击者可以以 SYSTEM 权限执行任意代码。

**影响版本:** 受影响的Windows版本众多，具体参见漏洞库信息中的cpes。

**利用条件:** 攻击者需要能够访问目标系统的网络，并且Print Spooler服务处于运行状态。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

根据漏洞信息和搜索结果，CVE-2021-34527（PrintNightmare）是一个Windows Print Spooler服务中的远程代码执行漏洞。攻击者可以通过不当的特权文件操作来利用此漏洞，从而以SYSTEM权限执行任意代码。

**有效性：**

根据CISA的ADP记录，此漏洞已被积极利用，因此提供的POC代码很可能有效。搜索结果也表明存在可用的利用代码。

**投毒风险：**

提供的Python POC代码是一个相对完整的漏洞利用框架，包含SMB服务器搭建、目标解析、以及利用Print Spooler服务进行攻击的逻辑。虽然代码中没有明显的恶意功能，但存在以下潜在的投毒风险：

*   **DLL劫持：** 漏洞利用的核心在于上传恶意的DLL文件并在目标系统上加载执行。攻击者可能在上传的DLL文件中包含恶意代码，从而实现持久化控制或其他恶意目的。POC代码中虽然不包含恶意DLL，但是用户在使用时需要自行构建，可能存在风险。
*   **SMB服务器安全：** SMB服务器本身可能存在安全问题，如果配置不当，可能被用于攻击其他系统。POC代码中实现的SMB服务器是一个简易版本，安全性较低。建议在隔离环境中运行。
*   **参数篡改：** 用户在使用POC时，可能因为参数配置错误而导致利用失败，或者产生意料之外的结果。例如，错误的共享路径、IP地址等。

综合以上因素，我评估此仓库中存在10%的作者隐藏的投毒代码的可能性，主要集中在使用用户自行构建的恶意DLL文件和SMB服务器安全风险上。

**利用方式：**

1.  **搭建SMB服务器：** 攻击者首先需要搭建一个SMB服务器，用于托管恶意的DLL文件。
2.  **利用Print Spooler服务：** 攻击者利用Print Spooler服务的AddPrinterDriverEx函数，将恶意的DLL文件上传到目标系统。
3.  **DLL劫持：** Print Spooler服务在加载驱动时，会加载上传的DLL文件，从而执行其中的恶意代码，实现远程代码执行。攻击者可以利用此漏洞获取SYSTEM权限。
4.  **清理：** 清理攻击痕迹，例如删除上传的DLL文件。

**项目地址:** [m8sec/CVE-2021-34527](https://github.com/m8sec/CVE-2021-34527)

**漏洞详情:** [CVE-2021-34527](https://nvd.nist.gov/vuln/detail/CVE-2021-34527)