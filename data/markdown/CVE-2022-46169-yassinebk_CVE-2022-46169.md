## CVE-2022-46169-Cacti-命令注入

**漏洞编号:** CVE-2022-46169

**漏洞类型:** 命令注入

**影响应用:** Cacti

**危害等级:** 高危，允许未授权的远程代码执行

**影响版本:** < 1.2.23

**利用条件:** 需要Cacti服务运行且存在特定的数据源配置（poller_item具有POLLER_ACTION_SCRIPT_PHP action）

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2022-46169是Cacti 1.2.23之前版本中的一个未授权命令注入漏洞。攻击者可以利用`remote_agent.php`文件中的授权绕过缺陷，通过伪造HTTP头（例如`X-Forwarded-For`），绕过IP地址验证，并利用`polldata`操作中的`poller_id`参数进行命令注入。

**漏洞利用方式：**

1.  **授权绕过：** 通过设置`X-Forwarded-For` HTTP头，模拟Cacti服务器自身的IP地址，绕过`remote_agent.php`的授权检查。这是因为`get_client_addr`函数信任`HTTP_`开头的`$_SERVER`变量，攻击者可以控制这些变量。
2.  **ID爆破：** 爆破`host_id`和`local_data_id`参数，寻找一个`poller_item`记录，其`action`字段的值为`POLLER_ACTION_SCRIPT_PHP` (值为2)，表明该条目会执行PHP脚本。
3.  **命令注入：** 将恶意命令注入到`poller_id`参数中。由于`get_nfilter_request_var`函数没有充分过滤该参数，导致命令注入。
4.  **远程代码执行：** 通过`proc_open`函数执行注入的命令，从而实现远程代码执行。

**有效性分析：**

根据漏洞描述和提供的POC代码，该漏洞利用方式是有效的。POC代码首先检查目标是否存在漏洞，然后通过爆破`host_id`和`local_data_id`找到合适的`poller_item`记录，最后构造包含恶意命令的URL并发送请求，实现远程代码执行。

**投毒风险分析：**

分析提供的POC代码，没有发现明显的恶意代码或后门。脚本的功能集中于漏洞利用，没有其他可疑操作。因此，投毒风险评估为0%。

**项目地址:** [yassinebk/CVE-2022-46169](https://github.com/yassinebk/CVE-2022-46169)

**漏洞详情:** [CVE-2022-46169](https://nvd.nist.gov/vuln/detail/CVE-2022-46169)