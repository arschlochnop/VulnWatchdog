## CVE-2023-21768-Windows AFD驱动提权漏洞

**漏洞编号:** CVE-2023-21768

**漏洞类型:** 本地提权

**影响应用:** Windows Ancillary Function Driver for WinSock (AFD)

**危害等级:** 高危，允许低权限用户提升到SYSTEM权限

**影响版本:** Windows Server 2022 (版本低于 10.0.20348.1487), Windows 11 21H2 (版本低于 10.0.22000.1455), Windows 11 22H2 (版本低于 10.0.22621.1105)

**利用条件:** 需要本地访问权限

**POC 可用性:** 是

**投毒风险:** 30%

## 详情

CVE-2023-21768 是 Windows AFD 驱动中的一个本地提权漏洞。攻击者可以利用此漏洞执行任意代码并获得 SYSTEM 权限。

**有效性:**
根据搜索结果和提供的漏洞利用代码，该漏洞存在可利用的POC。`https://github.com/Malwareman007/CVE-2023-21768` 这个链接表明存在完整的漏洞利用代码，并且 `https://www.youtube.com/watch?v=qdAZ8mTsTrc` 提供了一个视频演示，佐证了POC的有效性。提供的代码片段展示了使用IoRing进行内存读写的操作, 以及通过修改CR4寄存器来绕过SMEP/SMAP，最终执行用户模式的驱动程序。

**投毒风险:**
代码中存在一些硬编码的偏移量，例如NtGdiGetEmbUFI的偏移量，以及CR4的值。如果这些硬编码值不适用于目标系统，则漏洞利用将失败。另外，作者提到手动映射的驱动程序会分配在ExAllocatePool中，容易被dump。如果攻击者不注意，可能会暴露恶意代码。综上所述，存在一定的投毒风险，为了降低这种风险，攻击者需要对目标系统进行充分的分析，得到正确的偏移量以及CR4的值。此外，作者使用修改CR4寄存器来绕过SMEP/SMAP，这可能导致系统不稳定，蓝屏等问题。攻击者应该使用更加稳定的利用手段。因此，评估仓库中作者隐藏的投毒代码的可能性为30%。

**利用方式:**
1.  **漏洞触发:** 利用AFD驱动中的漏洞，获得在内核中读写内存的能力，该漏洞的根本原因是`CWE-822: Untrusted Pointer Dereference`，也就是非法的指针解引用。
2.  **信息泄露/地址定位:** 泄露必要的内核地址，例如NtGdiGetEmbUFI的地址，以及CR4寄存器的值。
3.  **权限提升:** 禁用SMEP/SMAP(通过修改CR4寄存器)，或者使用其他手段绕过保护机制。
4.  **代码执行:** 将恶意的驱动程序映射到内核空间，并执行该驱动程序。
5.  **清理/隐藏:** 清理痕迹，防止被检测。

总而言之，该漏洞利用比较复杂，需要攻击者具备一定的内核调试和逆向分析能力。

**项目地址:** [SamuelTulach/nullmap](https://github.com/SamuelTulach/nullmap)

**漏洞详情:** [CVE-2023-21768](https://nvd.nist.gov/vuln/detail/CVE-2023-21768)